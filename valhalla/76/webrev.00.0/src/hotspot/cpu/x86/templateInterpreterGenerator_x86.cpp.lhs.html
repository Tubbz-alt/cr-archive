<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames src/hotspot/cpu/x86/templateInterpreterGenerator_x86.cpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
    <script type="text/javascript" src="../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>   1 /*
   2  * Copyright (c) 2003, 2020, Oracle and/or its affiliates. All rights reserved.
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.
   8  *
   9  * This code is distributed in the hope that it will be useful, but WITHOUT
  10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  *
  23  */
  24 
  25 #include &quot;precompiled.hpp&quot;
  26 #include &quot;asm/macroAssembler.hpp&quot;
  27 #include &quot;compiler/disassembler.hpp&quot;
  28 #include &quot;gc/shared/barrierSetAssembler.hpp&quot;
  29 #include &quot;interpreter/bytecodeHistogram.hpp&quot;
  30 #include &quot;interpreter/interp_masm.hpp&quot;
  31 #include &quot;interpreter/interpreter.hpp&quot;
  32 #include &quot;interpreter/interpreterRuntime.hpp&quot;
  33 #include &quot;interpreter/templateInterpreterGenerator.hpp&quot;
  34 #include &quot;interpreter/templateTable.hpp&quot;
  35 #include &quot;oops/arrayOop.hpp&quot;
  36 #include &quot;oops/methodData.hpp&quot;
  37 #include &quot;oops/method.hpp&quot;
  38 #include &quot;oops/oop.inline.hpp&quot;
  39 #include &quot;oops/valueKlass.hpp&quot;
  40 #include &quot;prims/jvmtiExport.hpp&quot;
  41 #include &quot;prims/jvmtiThreadState.hpp&quot;
  42 #include &quot;runtime/arguments.hpp&quot;
  43 #include &quot;runtime/deoptimization.hpp&quot;
  44 #include &quot;runtime/frame.inline.hpp&quot;
  45 #include &quot;runtime/sharedRuntime.hpp&quot;
  46 #include &quot;runtime/stubRoutines.hpp&quot;
  47 #include &quot;runtime/synchronizer.hpp&quot;
  48 #include &quot;runtime/timer.hpp&quot;
  49 #include &quot;runtime/vframeArray.hpp&quot;
  50 #include &quot;utilities/debug.hpp&quot;
  51 #include &quot;utilities/macros.hpp&quot;
  52 
  53 #define __ Disassembler::hook&lt;InterpreterMacroAssembler&gt;(__FILE__, __LINE__, _masm)-&gt;
  54 
  55 // Size of interpreter code.  Increase if too small.  Interpreter will
  56 // fail with a guarantee (&quot;not enough space for interpreter generation&quot;);
  57 // if too small.
  58 // Run with +PrintInterpreter to get the VM to print out the size.
  59 // Max size with JVMTI
  60 #ifdef AMD64
  61 int TemplateInterpreter::InterpreterCodeSize = JVMCI_ONLY(280) NOT_JVMCI(268) * 1024;
  62 #else
  63 int TemplateInterpreter::InterpreterCodeSize = 224 * 1024;
  64 #endif // AMD64
  65 
  66 // Global Register Names
  67 static const Register rbcp     = LP64_ONLY(r13) NOT_LP64(rsi);
  68 static const Register rlocals  = LP64_ONLY(r14) NOT_LP64(rdi);
  69 
  70 const int method_offset = frame::interpreter_frame_method_offset * wordSize;
  71 const int bcp_offset    = frame::interpreter_frame_bcp_offset    * wordSize;
  72 const int locals_offset = frame::interpreter_frame_locals_offset * wordSize;
  73 
  74 
  75 //-----------------------------------------------------------------------------
  76 
  77 address TemplateInterpreterGenerator::generate_StackOverflowError_handler() {
  78   address entry = __ pc();
  79 
  80 #ifdef ASSERT
  81   {
  82     Label L;
  83     __ lea(rax, Address(rbp,
  84                         frame::interpreter_frame_monitor_block_top_offset *
  85                         wordSize));
  86     __ cmpptr(rax, rsp); // rax = maximal rsp for current rbp (stack
  87                          // grows negative)
  88     __ jcc(Assembler::aboveEqual, L); // check if frame is complete
  89     __ stop (&quot;interpreter frame not set up&quot;);
  90     __ bind(L);
  91   }
  92 #endif // ASSERT
  93   // Restore bcp under the assumption that the current frame is still
  94   // interpreted
  95   __ restore_bcp();
  96 
  97   // expression stack must be empty before entering the VM if an
  98   // exception happened
  99   __ empty_expression_stack();
 100   // throw exception
 101   __ call_VM(noreg,
 102              CAST_FROM_FN_PTR(address,
 103                               InterpreterRuntime::throw_StackOverflowError));
 104   return entry;
 105 }
 106 
 107 address TemplateInterpreterGenerator::generate_ArrayIndexOutOfBounds_handler() {
 108   address entry = __ pc();
 109   // The expression stack must be empty before entering the VM if an
 110   // exception happened.
 111   __ empty_expression_stack();
 112 
 113   // Setup parameters.
 114   // ??? convention: expect aberrant index in register ebx/rbx.
 115   // Pass array to create more detailed exceptions.
 116   Register rarg = NOT_LP64(rax) LP64_ONLY(c_rarg1);
 117   __ call_VM(noreg,
 118              CAST_FROM_FN_PTR(address,
 119                               InterpreterRuntime::
 120                               throw_ArrayIndexOutOfBoundsException),
 121              rarg, rbx);
 122   return entry;
 123 }
 124 
 125 address TemplateInterpreterGenerator::generate_ClassCastException_handler() {
 126   address entry = __ pc();
 127 
 128   // object is at TOS
 129   Register rarg = NOT_LP64(rax) LP64_ONLY(c_rarg1);
 130   __ pop(rarg);
 131 
 132   // expression stack must be empty before entering the VM if an
 133   // exception happened
 134   __ empty_expression_stack();
 135 
 136   __ call_VM(noreg,
 137              CAST_FROM_FN_PTR(address,
 138                               InterpreterRuntime::
 139                               throw_ClassCastException),
 140              rarg);
 141   return entry;
 142 }
 143 
 144 address TemplateInterpreterGenerator::generate_exception_handler_common(
 145         const char* name, const char* message, bool pass_oop) {
 146   assert(!pass_oop || message == NULL, &quot;either oop or message but not both&quot;);
 147   address entry = __ pc();
 148 
 149   Register rarg = NOT_LP64(rax) LP64_ONLY(c_rarg1);
 150   Register rarg2 = NOT_LP64(rbx) LP64_ONLY(c_rarg2);
 151 
 152   if (pass_oop) {
 153     // object is at TOS
 154     __ pop(rarg2);
 155   }
 156   // expression stack must be empty before entering the VM if an
 157   // exception happened
 158   __ empty_expression_stack();
 159   // setup parameters
 160   __ lea(rarg, ExternalAddress((address)name));
 161   if (pass_oop) {
 162     __ call_VM(rax, CAST_FROM_FN_PTR(address,
 163                                      InterpreterRuntime::
 164                                      create_klass_exception),
 165                rarg, rarg2);
 166   } else {
 167     __ lea(rarg2, ExternalAddress((address)message));
 168     __ call_VM(rax,
 169                CAST_FROM_FN_PTR(address, InterpreterRuntime::create_exception),
 170                rarg, rarg2);
 171   }
 172   // throw exception
 173   __ jump(ExternalAddress(Interpreter::throw_exception_entry()));
 174   return entry;
 175 }
 176 
 177 address TemplateInterpreterGenerator::generate_return_entry_for(TosState state, int step, size_t index_size) {
 178   address entry = __ pc();
 179 
 180 #ifndef _LP64
 181 #ifdef COMPILER2
 182   // The FPU stack is clean if UseSSE &gt;= 2 but must be cleaned in other cases
 183   if ((state == ftos &amp;&amp; UseSSE &lt; 1) || (state == dtos &amp;&amp; UseSSE &lt; 2)) {
 184     for (int i = 1; i &lt; 8; i++) {
 185         __ ffree(i);
 186     }
 187   } else if (UseSSE &lt; 2) {
 188     __ empty_FPU_stack();
 189   }
 190 #endif // COMPILER2
 191   if ((state == ftos &amp;&amp; UseSSE &lt; 1) || (state == dtos &amp;&amp; UseSSE &lt; 2)) {
 192     __ MacroAssembler::verify_FPU(1, &quot;generate_return_entry_for compiled&quot;);
 193   } else {
 194     __ MacroAssembler::verify_FPU(0, &quot;generate_return_entry_for compiled&quot;);
 195   }
 196 
 197   if (state == ftos) {
 198     __ MacroAssembler::verify_FPU(UseSSE &gt;= 1 ? 0 : 1, &quot;generate_return_entry_for in interpreter&quot;);
 199   } else if (state == dtos) {
 200     __ MacroAssembler::verify_FPU(UseSSE &gt;= 2 ? 0 : 1, &quot;generate_return_entry_for in interpreter&quot;);
 201   }
 202 #endif // _LP64
 203 
 204   // Restore stack bottom in case i2c adjusted stack
 205   __ movptr(rsp, Address(rbp, frame::interpreter_frame_last_sp_offset * wordSize));
 206   // and NULL it as marker that esp is now tos until next java call
 207   __ movptr(Address(rbp, frame::interpreter_frame_last_sp_offset * wordSize), (int32_t)NULL_WORD);
 208 
 209   if (state == atos &amp;&amp; InlineTypeReturnedAsFields) {
 210     __ store_value_type_fields_to_buf(NULL);
 211   }
 212 
 213   __ restore_bcp();
 214   __ restore_locals();
 215 
 216   if (state == atos) {
 217     Register mdp = rbx;
 218     Register tmp = rcx;
 219     __ profile_return_type(mdp, rax, tmp);
 220   }
 221 
 222   const Register cache = rbx;
 223   const Register index = rcx;
 224   __ get_cache_and_index_at_bcp(cache, index, 1, index_size);
 225 
 226   const Register flags = cache;
 227   __ movl(flags, Address(cache, index, Address::times_ptr, ConstantPoolCache::base_offset() + ConstantPoolCacheEntry::flags_offset()));
 228   __ andl(flags, ConstantPoolCacheEntry::parameter_size_mask);
 229   __ lea(rsp, Address(rsp, flags, Interpreter::stackElementScale()));
 230 
 231    const Register java_thread = NOT_LP64(rcx) LP64_ONLY(r15_thread);
 232    if (JvmtiExport::can_pop_frame()) {
 233      NOT_LP64(__ get_thread(java_thread));
 234      __ check_and_handle_popframe(java_thread);
 235    }
 236    if (JvmtiExport::can_force_early_return()) {
 237      NOT_LP64(__ get_thread(java_thread));
 238      __ check_and_handle_earlyret(java_thread);
 239    }
 240 
 241   __ dispatch_next(state, step);
 242 
 243   return entry;
 244 }
 245 
 246 
 247 address TemplateInterpreterGenerator::generate_deopt_entry_for(TosState state, int step, address continuation) {
 248   address entry = __ pc();
 249 
 250 #ifndef _LP64
 251   if (state == ftos) {
 252     __ MacroAssembler::verify_FPU(UseSSE &gt;= 1 ? 0 : 1, &quot;generate_deopt_entry_for in interpreter&quot;);
 253   } else if (state == dtos) {
 254     __ MacroAssembler::verify_FPU(UseSSE &gt;= 2 ? 0 : 1, &quot;generate_deopt_entry_for in interpreter&quot;);
 255   }
 256 #endif // _LP64
 257 
 258   // NULL last_sp until next java call
 259   __ movptr(Address(rbp, frame::interpreter_frame_last_sp_offset * wordSize), (int32_t)NULL_WORD);
 260   __ restore_bcp();
 261   __ restore_locals();
 262   const Register thread = NOT_LP64(rcx) LP64_ONLY(r15_thread);
 263   NOT_LP64(__ get_thread(thread));
 264 #if INCLUDE_JVMCI
 265   // Check if we need to take lock at entry of synchronized method.  This can
 266   // only occur on method entry so emit it only for vtos with step 0.
 267   if ((EnableJVMCI || UseAOT) &amp;&amp; state == vtos &amp;&amp; step == 0) {
 268     Label L;
 269     __ cmpb(Address(thread, JavaThread::pending_monitorenter_offset()), 0);
 270     __ jcc(Assembler::zero, L);
 271     // Clear flag.
 272     __ movb(Address(thread, JavaThread::pending_monitorenter_offset()), 0);
 273     // Satisfy calling convention for lock_method().
 274     __ get_method(rbx);
 275     // Take lock.
 276     lock_method();
 277     __ bind(L);
 278   } else {
 279 #ifdef ASSERT
 280     if (EnableJVMCI) {
 281       Label L;
 282       __ cmpb(Address(r15_thread, JavaThread::pending_monitorenter_offset()), 0);
 283       __ jcc(Assembler::zero, L);
 284       __ stop(&quot;unexpected pending monitor in deopt entry&quot;);
 285       __ bind(L);
 286     }
 287 #endif
 288   }
 289 #endif
 290   // handle exceptions
 291   {
 292     Label L;
 293     __ cmpptr(Address(thread, Thread::pending_exception_offset()), (int32_t) NULL_WORD);
 294     __ jcc(Assembler::zero, L);
 295     __ call_VM(noreg,
 296                CAST_FROM_FN_PTR(address,
 297                                 InterpreterRuntime::throw_pending_exception));
 298     __ should_not_reach_here();
 299     __ bind(L);
 300   }
 301   if (continuation == NULL) {
 302     __ dispatch_next(state, step);
 303   } else {
 304     __ jump_to_entry(continuation);
 305   }
 306   return entry;
 307 }
 308 
 309 address TemplateInterpreterGenerator::generate_result_handler_for(
 310         BasicType type) {
 311   address entry = __ pc();
 312   switch (type) {
 313   case T_BOOLEAN: __ c2bool(rax);            break;
 314 #ifndef _LP64
 315   case T_CHAR   : __ andptr(rax, 0xFFFF);    break;
 316 #else
 317   case T_CHAR   : __ movzwl(rax, rax);       break;
 318 #endif // _LP64
 319   case T_BYTE   : __ sign_extend_byte(rax);  break;
 320   case T_SHORT  : __ sign_extend_short(rax); break;
 321   case T_INT    : /* nothing to do */        break;
 322   case T_LONG   : /* nothing to do */        break;
 323   case T_VOID   : /* nothing to do */        break;
 324 #ifndef _LP64
 325   case T_DOUBLE :
 326   case T_FLOAT  :
 327     { const Register t = InterpreterRuntime::SignatureHandlerGenerator::temp();
 328       __ pop(t);                            // remove return address first
 329       // Must return a result for interpreter or compiler. In SSE
 330       // mode, results are returned in xmm0 and the FPU stack must
 331       // be empty.
 332       if (type == T_FLOAT &amp;&amp; UseSSE &gt;= 1) {
 333         // Load ST0
 334         __ fld_d(Address(rsp, 0));
 335         // Store as float and empty fpu stack
 336         __ fstp_s(Address(rsp, 0));
 337         // and reload
 338         __ movflt(xmm0, Address(rsp, 0));
 339       } else if (type == T_DOUBLE &amp;&amp; UseSSE &gt;= 2 ) {
 340         __ movdbl(xmm0, Address(rsp, 0));
 341       } else {
 342         // restore ST0
 343         __ fld_d(Address(rsp, 0));
 344       }
 345       // and pop the temp
 346       __ addptr(rsp, 2 * wordSize);
 347       __ push(t);                           // restore return address
 348     }
 349     break;
 350 #else
 351   case T_FLOAT  : /* nothing to do */        break;
 352   case T_DOUBLE : /* nothing to do */        break;
 353 #endif // _LP64
 354 
 355   case T_VALUETYPE: // fall through (value types are handled with oops)
 356   case T_OBJECT :
 357     // retrieve result from frame
 358     __ movptr(rax, Address(rbp, frame::interpreter_frame_oop_temp_offset*wordSize));
 359     // and verify it
 360     __ verify_oop(rax);
 361     break;
 362   default       : ShouldNotReachHere();
 363   }
 364   __ ret(0);                                   // return from result handler
 365   return entry;
 366 }
 367 
 368 address TemplateInterpreterGenerator::generate_safept_entry_for(
 369         TosState state,
 370         address runtime_entry) {
 371   address entry = __ pc();
 372   __ push(state);
 373   __ call_VM(noreg, runtime_entry);
 374   __ dispatch_via(vtos, Interpreter::_normal_table.table_for(vtos));
 375   return entry;
 376 }
 377 
 378 
 379 
 380 // Helpers for commoning out cases in the various type of method entries.
 381 //
 382 
 383 
 384 // increment invocation count &amp; check for overflow
 385 //
 386 // Note: checking for negative value instead of overflow
 387 //       so we have a &#39;sticky&#39; overflow test
 388 //
 389 // rbx: method
 390 // rcx: invocation counter
 391 //
 392 void TemplateInterpreterGenerator::generate_counter_incr(
 393         Label* overflow,
 394         Label* profile_method,
 395         Label* profile_method_continue) {
 396   Label done;
 397   // Note: In tiered we increment either counters in Method* or in MDO depending if we&#39;re profiling or not.
 398   if (TieredCompilation) {
 399     int increment = InvocationCounter::count_increment;
 400     Label no_mdo;
 401     if (ProfileInterpreter) {
 402       // Are we profiling?
 403       __ movptr(rax, Address(rbx, Method::method_data_offset()));
 404       __ testptr(rax, rax);
 405       __ jccb(Assembler::zero, no_mdo);
 406       // Increment counter in the MDO
 407       const Address mdo_invocation_counter(rax, in_bytes(MethodData::invocation_counter_offset()) +
 408                                                 in_bytes(InvocationCounter::counter_offset()));
 409       const Address mask(rax, in_bytes(MethodData::invoke_mask_offset()));
 410       __ increment_mask_and_jump(mdo_invocation_counter, increment, mask, rcx, false, Assembler::zero, overflow);
 411       __ jmp(done);
 412     }
 413     __ bind(no_mdo);
 414     // Increment counter in MethodCounters
 415     const Address invocation_counter(rax,
 416                   MethodCounters::invocation_counter_offset() +
 417                   InvocationCounter::counter_offset());
 418     __ get_method_counters(rbx, rax, done);
 419     const Address mask(rax, in_bytes(MethodCounters::invoke_mask_offset()));
 420     __ increment_mask_and_jump(invocation_counter, increment, mask, rcx,
 421                                false, Assembler::zero, overflow);
 422     __ bind(done);
 423   } else { // not TieredCompilation
 424     const Address backedge_counter(rax,
 425                   MethodCounters::backedge_counter_offset() +
 426                   InvocationCounter::counter_offset());
 427     const Address invocation_counter(rax,
 428                   MethodCounters::invocation_counter_offset() +
 429                   InvocationCounter::counter_offset());
 430 
 431     __ get_method_counters(rbx, rax, done);
 432 
 433     if (ProfileInterpreter) {
 434       __ incrementl(Address(rax,
 435               MethodCounters::interpreter_invocation_counter_offset()));
 436     }
 437     // Update standard invocation counters
 438     __ movl(rcx, invocation_counter);
 439     __ incrementl(rcx, InvocationCounter::count_increment);
 440     __ movl(invocation_counter, rcx); // save invocation count
 441 
 442     __ movl(rax, backedge_counter);   // load backedge counter
 443     __ andl(rax, InvocationCounter::count_mask_value); // mask out the status bits
 444 
 445     __ addl(rcx, rax);                // add both counters
 446 
 447     // profile_method is non-null only for interpreted method so
 448     // profile_method != NULL == !native_call
 449 
 450     if (ProfileInterpreter &amp;&amp; profile_method != NULL) {
 451       // Test to see if we should create a method data oop
 452       __ movptr(rax, Address(rbx, Method::method_counters_offset()));
 453       __ cmp32(rcx, Address(rax, in_bytes(MethodCounters::interpreter_profile_limit_offset())));
 454       __ jcc(Assembler::less, *profile_method_continue);
 455 
 456       // if no method data exists, go to profile_method
 457       __ test_method_data_pointer(rax, *profile_method);
 458     }
 459 
 460     __ movptr(rax, Address(rbx, Method::method_counters_offset()));
 461     __ cmp32(rcx, Address(rax, in_bytes(MethodCounters::interpreter_invocation_limit_offset())));
 462     __ jcc(Assembler::aboveEqual, *overflow);
 463     __ bind(done);
 464   }
 465 }
 466 
 467 void TemplateInterpreterGenerator::generate_counter_overflow(Label&amp; do_continue) {
 468 
 469   // Asm interpreter on entry
 470   // r14/rdi - locals
 471   // r13/rsi - bcp
 472   // rbx - method
 473   // rdx - cpool --- DOES NOT APPEAR TO BE TRUE
 474   // rbp - interpreter frame
 475 
 476   // On return (i.e. jump to entry_point) [ back to invocation of interpreter ]
 477   // Everything as it was on entry
 478   // rdx is not restored. Doesn&#39;t appear to really be set.
 479 
 480   // InterpreterRuntime::frequency_counter_overflow takes two
 481   // arguments, the first (thread) is passed by call_VM, the second
 482   // indicates if the counter overflow occurs at a backwards branch
 483   // (NULL bcp).  We pass zero for it.  The call returns the address
 484   // of the verified entry point for the method or NULL if the
 485   // compilation did not complete (either went background or bailed
 486   // out).
 487   Register rarg = NOT_LP64(rax) LP64_ONLY(c_rarg1);
 488   __ movl(rarg, 0);
 489   __ call_VM(noreg,
 490              CAST_FROM_FN_PTR(address,
 491                               InterpreterRuntime::frequency_counter_overflow),
 492              rarg);
 493 
 494   __ movptr(rbx, Address(rbp, method_offset));   // restore Method*
 495   // Preserve invariant that r13/r14 contain bcp/locals of sender frame
 496   // and jump to the interpreted entry.
 497   __ jmp(do_continue, relocInfo::none);
 498 }
 499 
 500 // See if we&#39;ve got enough room on the stack for locals plus overhead below
 501 // JavaThread::stack_overflow_limit(). If not, throw a StackOverflowError
 502 // without going through the signal handler, i.e., reserved and yellow zones
 503 // will not be made usable. The shadow zone must suffice to handle the
 504 // overflow.
 505 // The expression stack grows down incrementally, so the normal guard
 506 // page mechanism will work for that.
 507 //
 508 // NOTE: Since the additional locals are also always pushed (wasn&#39;t
 509 // obvious in generate_fixed_frame) so the guard should work for them
 510 // too.
 511 //
 512 // Args:
 513 //      rdx: number of additional locals this frame needs (what we must check)
 514 //      rbx: Method*
 515 //
 516 // Kills:
 517 //      rax
 518 void TemplateInterpreterGenerator::generate_stack_overflow_check(void) {
 519 
 520   // monitor entry size: see picture of stack in frame_x86.hpp
 521   const int entry_size = frame::interpreter_frame_monitor_size() * wordSize;
 522 
 523   // total overhead size: entry_size + (saved rbp through expr stack
 524   // bottom).  be sure to change this if you add/subtract anything
 525   // to/from the overhead area
 526   const int overhead_size =
 527     -(frame::interpreter_frame_initial_sp_offset * wordSize) + entry_size;
 528 
 529   const int page_size = os::vm_page_size();
 530 
 531   Label after_frame_check;
 532 
 533   // see if the frame is greater than one page in size. If so,
 534   // then we need to verify there is enough stack space remaining
 535   // for the additional locals.
 536   __ cmpl(rdx, (page_size - overhead_size) / Interpreter::stackElementSize);
 537   __ jcc(Assembler::belowEqual, after_frame_check);
 538 
 539   // compute rsp as if this were going to be the last frame on
 540   // the stack before the red zone
 541 
 542   Label after_frame_check_pop;
 543   const Register thread = NOT_LP64(rsi) LP64_ONLY(r15_thread);
 544 #ifndef _LP64
 545   __ push(thread);
 546   __ get_thread(thread);
 547 #endif
 548 
 549   const Address stack_limit(thread, JavaThread::stack_overflow_limit_offset());
 550 
 551   // locals + overhead, in bytes
 552   __ mov(rax, rdx);
 553   __ shlptr(rax, Interpreter::logStackElementSize); // Convert parameter count to bytes.
 554   __ addptr(rax, overhead_size);
 555 
 556 #ifdef ASSERT
 557   Label limit_okay;
 558   // Verify that thread stack overflow limit is non-zero.
 559   __ cmpptr(stack_limit, (int32_t)NULL_WORD);
 560   __ jcc(Assembler::notEqual, limit_okay);
 561   __ stop(&quot;stack overflow limit is zero&quot;);
 562   __ bind(limit_okay);
 563 #endif
 564 
 565   // Add locals/frame size to stack limit.
 566   __ addptr(rax, stack_limit);
 567 
 568   // Check against the current stack bottom.
 569   __ cmpptr(rsp, rax);
 570 
 571   __ jcc(Assembler::above, after_frame_check_pop);
 572   NOT_LP64(__ pop(rsi));  // get saved bcp
 573 
 574   // Restore sender&#39;s sp as SP. This is necessary if the sender&#39;s
 575   // frame is an extended compiled frame (see gen_c2i_adapter())
 576   // and safer anyway in case of JSR292 adaptations.
 577 
 578   __ pop(rax); // return address must be moved if SP is changed
 579   __ mov(rsp, rbcp);
 580   __ push(rax);
 581 
 582   // Note: the restored frame is not necessarily interpreted.
 583   // Use the shared runtime version of the StackOverflowError.
 584   assert(StubRoutines::throw_StackOverflowError_entry() != NULL, &quot;stub not yet generated&quot;);
 585   __ jump(ExternalAddress(StubRoutines::throw_StackOverflowError_entry()));
 586   // all done with frame size check
 587   __ bind(after_frame_check_pop);
 588   NOT_LP64(__ pop(rsi));
 589 
 590   // all done with frame size check
 591   __ bind(after_frame_check);
 592 }
 593 
 594 // Allocate monitor and lock method (asm interpreter)
 595 //
 596 // Args:
 597 //      rbx: Method*
 598 //      r14/rdi: locals
 599 //
 600 // Kills:
 601 //      rax
 602 //      c_rarg0, c_rarg1, c_rarg2, c_rarg3, ...(param regs)
 603 //      rscratch1, rscratch2 (scratch regs)
 604 void TemplateInterpreterGenerator::lock_method() {
 605   // synchronize method
 606   const Address access_flags(rbx, Method::access_flags_offset());
 607   const Address monitor_block_top(
 608         rbp,
 609         frame::interpreter_frame_monitor_block_top_offset * wordSize);
 610   const int entry_size = frame::interpreter_frame_monitor_size() * wordSize;
 611 
 612 #ifdef ASSERT
 613   {
 614     Label L;
 615     __ movl(rax, access_flags);
 616     __ testl(rax, JVM_ACC_SYNCHRONIZED);
 617     __ jcc(Assembler::notZero, L);
 618     __ stop(&quot;method doesn&#39;t need synchronization&quot;);
 619     __ bind(L);
 620   }
 621 #endif // ASSERT
 622 
 623   // get synchronization object
 624   {
 625     Label done;
 626     __ movl(rax, access_flags);
 627     __ testl(rax, JVM_ACC_STATIC);
 628     // get receiver (assume this is frequent case)
 629     __ movptr(rax, Address(rlocals, Interpreter::local_offset_in_bytes(0)));
 630     __ jcc(Assembler::zero, done);
 631     __ load_mirror(rax, rbx);
 632 
 633 #ifdef ASSERT
 634     {
 635       Label L;
 636       __ testptr(rax, rax);
 637       __ jcc(Assembler::notZero, L);
 638       __ stop(&quot;synchronization object is NULL&quot;);
 639       __ bind(L);
 640     }
 641 #endif // ASSERT
 642 
 643     __ bind(done);
 644     __ resolve(IS_NOT_NULL, rax);
 645   }
 646 
 647   // add space for monitor &amp; lock
 648   __ subptr(rsp, entry_size); // add space for a monitor entry
 649   __ movptr(monitor_block_top, rsp);  // set new monitor block top
 650   // store object
 651   __ movptr(Address(rsp, BasicObjectLock::obj_offset_in_bytes()), rax);
 652   const Register lockreg = NOT_LP64(rdx) LP64_ONLY(c_rarg1);
 653   __ movptr(lockreg, rsp); // object address
 654   __ lock_object(lockreg);
 655 }
 656 
 657 // Generate a fixed interpreter frame. This is identical setup for
 658 // interpreted methods and for native methods hence the shared code.
 659 //
 660 // Args:
 661 //      rax: return address
 662 //      rbx: Method*
 663 //      r14/rdi: pointer to locals
 664 //      r13/rsi: sender sp
 665 //      rdx: cp cache
 666 void TemplateInterpreterGenerator::generate_fixed_frame(bool native_call) {
 667   // initialize fixed part of activation frame
 668   __ push(rax);        // save return address
 669   __ enter();          // save old &amp; set new rbp
 670   __ push(rbcp);        // set sender sp
 671   __ push((int)NULL_WORD); // leave last_sp as null
 672   __ movptr(rbcp, Address(rbx, Method::const_offset()));      // get ConstMethod*
 673   __ lea(rbcp, Address(rbcp, ConstMethod::codes_offset())); // get codebase
 674   __ push(rbx);        // save Method*
 675   // Get mirror and store it in the frame as GC root for this Method*
 676   __ load_mirror(rdx, rbx);
 677   __ push(rdx);
 678   if (ProfileInterpreter) {
 679     Label method_data_continue;
 680     __ movptr(rdx, Address(rbx, in_bytes(Method::method_data_offset())));
 681     __ testptr(rdx, rdx);
 682     __ jcc(Assembler::zero, method_data_continue);
 683     __ addptr(rdx, in_bytes(MethodData::data_offset()));
 684     __ bind(method_data_continue);
 685     __ push(rdx);      // set the mdp (method data pointer)
 686   } else {
 687     __ push(0);
 688   }
 689 
 690   __ movptr(rdx, Address(rbx, Method::const_offset()));
 691   __ movptr(rdx, Address(rdx, ConstMethod::constants_offset()));
 692   __ movptr(rdx, Address(rdx, ConstantPool::cache_offset_in_bytes()));
 693   __ push(rdx); // set constant pool cache
 694   __ push(rlocals); // set locals pointer
 695   if (native_call) {
 696     __ push(0); // no bcp
 697   } else {
 698     __ push(rbcp); // set bcp
 699   }
 700   __ push(0); // reserve word for pointer to expression stack bottom
 701   __ movptr(Address(rsp, 0), rsp); // set expression stack bottom
 702 }
 703 
 704 // End of helpers
 705 
 706 // Method entry for java.lang.ref.Reference.get.
 707 address TemplateInterpreterGenerator::generate_Reference_get_entry(void) {
 708   // Code: _aload_0, _getfield, _areturn
 709   // parameter size = 1
 710   //
 711   // The code that gets generated by this routine is split into 2 parts:
 712   //    1. The &quot;intrinsified&quot; code performing an ON_WEAK_OOP_REF load,
 713   //    2. The slow path - which is an expansion of the regular method entry.
 714   //
 715   // Notes:-
 716   // * An intrinsic is always executed, where an ON_WEAK_OOP_REF load is performed.
 717   // * We may jump to the slow path iff the receiver is null. If the
 718   //   Reference object is null then we no longer perform an ON_WEAK_OOP_REF load
 719   //   Thus we can use the regular method entry code to generate the NPE.
 720   //
 721   // rbx: Method*
 722 
 723   // r13: senderSP must preserve for slow path, set SP to it on fast path
 724 
 725   address entry = __ pc();
 726 
<a name="1" id="anc1"></a><span class="line-modified"> 727   const int referent_offset = java_lang_ref_Reference::referent_offset;</span>
<span class="line-removed"> 728   guarantee(referent_offset &gt; 0, &quot;referent offset not initialized&quot;);</span>
 729 
 730   Label slow_path;
 731   // rbx: method
 732 
 733   // Check if local 0 != NULL
 734   // If the receiver is null then it is OK to jump to the slow path.
 735   __ movptr(rax, Address(rsp, wordSize));
 736 
 737   __ testptr(rax, rax);
 738   __ jcc(Assembler::zero, slow_path);
 739 
 740   // rax: local 0
 741   // rbx: method (but can be used as scratch now)
 742   // rdx: scratch
 743   // rdi: scratch
 744 
 745   // Preserve the sender sp in case the load barrier
 746   // calls the runtime
 747   NOT_LP64(__ push(rsi));
 748 
 749   // Load the value of the referent field.
 750   const Address field_address(rax, referent_offset);
 751   __ load_heap_oop(rax, field_address, /*tmp1*/ rbx, /*tmp_thread*/ rdx, ON_WEAK_OOP_REF);
 752 
 753   // _areturn
 754   const Register sender_sp = NOT_LP64(rsi) LP64_ONLY(r13);
 755   NOT_LP64(__ pop(rsi));      // get sender sp
 756   __ pop(rdi);                // get return address
 757   __ mov(rsp, sender_sp);     // set sp to sender sp
 758   __ jmp(rdi);
 759   __ ret(0);
 760 
 761   // generate a vanilla interpreter entry as the slow path
 762   __ bind(slow_path);
 763   __ jump_to_entry(Interpreter::entry_for_kind(Interpreter::zerolocals));
 764   return entry;
 765 }
 766 
 767 void TemplateInterpreterGenerator::bang_stack_shadow_pages(bool native_call) {
 768   // Quick &amp; dirty stack overflow checking: bang the stack &amp; handle trap.
 769   // Note that we do the banging after the frame is setup, since the exception
 770   // handling code expects to find a valid interpreter frame on the stack.
 771   // Doing the banging earlier fails if the caller frame is not an interpreter
 772   // frame.
 773   // (Also, the exception throwing code expects to unlock any synchronized
 774   // method receiever, so do the banging after locking the receiver.)
 775 
 776   // Bang each page in the shadow zone. We can&#39;t assume it&#39;s been done for
 777   // an interpreter frame with greater than a page of locals, so each page
 778   // needs to be checked.  Only true for non-native.
 779   if (UseStackBanging) {
 780     const int page_size = os::vm_page_size();
 781     const int n_shadow_pages = ((int)JavaThread::stack_shadow_zone_size()) / page_size;
 782     const int start_page = native_call ? n_shadow_pages : 1;
 783     for (int pages = start_page; pages &lt;= n_shadow_pages; pages++) {
 784       __ bang_stack_with_offset(pages*page_size);
 785     }
 786   }
 787 }
 788 
 789 // Interpreter stub for calling a native method. (asm interpreter)
 790 // This sets up a somewhat different looking stack for calling the
 791 // native method than the typical interpreter frame setup.
 792 address TemplateInterpreterGenerator::generate_native_entry(bool synchronized) {
 793   // determine code generation flags
 794   bool inc_counter  = UseCompiler || CountCompiledCalls || LogTouchedMethods;
 795 
 796   // rbx: Method*
 797   // rbcp: sender sp
 798 
 799   address entry_point = __ pc();
 800 
 801   const Address constMethod       (rbx, Method::const_offset());
 802   const Address access_flags      (rbx, Method::access_flags_offset());
 803   const Address size_of_parameters(rcx, ConstMethod::
 804                                         size_of_parameters_offset());
 805 
 806 
 807   // get parameter size (always needed)
 808   __ movptr(rcx, constMethod);
 809   __ load_unsigned_short(rcx, size_of_parameters);
 810 
 811   // native calls don&#39;t need the stack size check since they have no
 812   // expression stack and the arguments are already on the stack and
 813   // we only add a handful of words to the stack
 814 
 815   // rbx: Method*
 816   // rcx: size of parameters
 817   // rbcp: sender sp
 818   __ pop(rax);                                       // get return address
 819 
 820   // for natives the size of locals is zero
 821 
 822   // compute beginning of parameters
 823   __ lea(rlocals, Address(rsp, rcx, Interpreter::stackElementScale(), -wordSize));
 824 
 825   // add 2 zero-initialized slots for native calls
 826   // initialize result_handler slot
 827   __ push((int) NULL_WORD);
 828   // slot for oop temp
 829   // (static native method holder mirror/jni oop result)
 830   __ push((int) NULL_WORD);
 831 
 832   // initialize fixed part of activation frame
 833   generate_fixed_frame(true);
 834 
 835   // make sure method is native &amp; not abstract
 836 #ifdef ASSERT
 837   __ movl(rax, access_flags);
 838   {
 839     Label L;
 840     __ testl(rax, JVM_ACC_NATIVE);
 841     __ jcc(Assembler::notZero, L);
 842     __ stop(&quot;tried to execute non-native method as native&quot;);
 843     __ bind(L);
 844   }
 845   {
 846     Label L;
 847     __ testl(rax, JVM_ACC_ABSTRACT);
 848     __ jcc(Assembler::zero, L);
 849     __ stop(&quot;tried to execute abstract method in interpreter&quot;);
 850     __ bind(L);
 851   }
 852 #endif
 853 
 854   // Since at this point in the method invocation the exception handler
 855   // would try to exit the monitor of synchronized methods which hasn&#39;t
 856   // been entered yet, we set the thread local variable
 857   // _do_not_unlock_if_synchronized to true. The remove_activation will
 858   // check this flag.
 859 
 860   const Register thread1 = NOT_LP64(rax) LP64_ONLY(r15_thread);
 861   NOT_LP64(__ get_thread(thread1));
 862   const Address do_not_unlock_if_synchronized(thread1,
 863         in_bytes(JavaThread::do_not_unlock_if_synchronized_offset()));
 864   __ movbool(do_not_unlock_if_synchronized, true);
 865 
 866   // increment invocation count &amp; check for overflow
 867   Label invocation_counter_overflow;
 868   if (inc_counter) {
 869     generate_counter_incr(&amp;invocation_counter_overflow, NULL, NULL);
 870   }
 871 
 872   Label continue_after_compile;
 873   __ bind(continue_after_compile);
 874 
 875   bang_stack_shadow_pages(true);
 876 
 877   // reset the _do_not_unlock_if_synchronized flag
 878   NOT_LP64(__ get_thread(thread1));
 879   __ movbool(do_not_unlock_if_synchronized, false);
 880 
 881   // check for synchronized methods
 882   // Must happen AFTER invocation_counter check and stack overflow check,
 883   // so method is not locked if overflows.
 884   if (synchronized) {
 885     lock_method();
 886   } else {
 887     // no synchronization necessary
 888 #ifdef ASSERT
 889     {
 890       Label L;
 891       __ movl(rax, access_flags);
 892       __ testl(rax, JVM_ACC_SYNCHRONIZED);
 893       __ jcc(Assembler::zero, L);
 894       __ stop(&quot;method needs synchronization&quot;);
 895       __ bind(L);
 896     }
 897 #endif
 898   }
 899 
 900   // start execution
 901 #ifdef ASSERT
 902   {
 903     Label L;
 904     const Address monitor_block_top(rbp,
 905                  frame::interpreter_frame_monitor_block_top_offset * wordSize);
 906     __ movptr(rax, monitor_block_top);
 907     __ cmpptr(rax, rsp);
 908     __ jcc(Assembler::equal, L);
 909     __ stop(&quot;broken stack frame setup in interpreter&quot;);
 910     __ bind(L);
 911   }
 912 #endif
 913 
 914   // jvmti support
 915   __ notify_method_entry();
 916 
 917   // work registers
 918   const Register method = rbx;
 919   const Register thread = NOT_LP64(rdi) LP64_ONLY(r15_thread);
 920   const Register t      = NOT_LP64(rcx) LP64_ONLY(r11);
 921 
 922   // allocate space for parameters
 923   __ get_method(method);
 924   __ movptr(t, Address(method, Method::const_offset()));
 925   __ load_unsigned_short(t, Address(t, ConstMethod::size_of_parameters_offset()));
 926 
 927 #ifndef _LP64
 928   __ shlptr(t, Interpreter::logStackElementSize); // Convert parameter count to bytes.
 929   __ addptr(t, 2*wordSize);     // allocate two more slots for JNIEnv and possible mirror
 930   __ subptr(rsp, t);
 931   __ andptr(rsp, -(StackAlignmentInBytes)); // gcc needs 16 byte aligned stacks to do XMM intrinsics
 932 #else
 933   __ shll(t, Interpreter::logStackElementSize);
 934 
 935   __ subptr(rsp, t);
 936   __ subptr(rsp, frame::arg_reg_save_area_bytes); // windows
 937   __ andptr(rsp, -16); // must be 16 byte boundary (see amd64 ABI)
 938 #endif // _LP64
 939 
 940   // get signature handler
 941   {
 942     Label L;
 943     __ movptr(t, Address(method, Method::signature_handler_offset()));
 944     __ testptr(t, t);
 945     __ jcc(Assembler::notZero, L);
 946     __ call_VM(noreg,
 947                CAST_FROM_FN_PTR(address,
 948                                 InterpreterRuntime::prepare_native_call),
 949                method);
 950     __ get_method(method);
 951     __ movptr(t, Address(method, Method::signature_handler_offset()));
 952     __ bind(L);
 953   }
 954 
 955   // call signature handler
 956   assert(InterpreterRuntime::SignatureHandlerGenerator::from() == rlocals,
 957          &quot;adjust this code&quot;);
 958   assert(InterpreterRuntime::SignatureHandlerGenerator::to() == rsp,
 959          &quot;adjust this code&quot;);
 960   assert(InterpreterRuntime::SignatureHandlerGenerator::temp() == NOT_LP64(t) LP64_ONLY(rscratch1),
 961          &quot;adjust this code&quot;);
 962 
 963   // The generated handlers do not touch RBX (the method oop).
 964   // However, large signatures cannot be cached and are generated
 965   // each time here.  The slow-path generator can do a GC on return,
 966   // so we must reload it after the call.
 967   __ call(t);
 968   __ get_method(method);        // slow path can do a GC, reload RBX
 969 
 970 
 971   // result handler is in rax
 972   // set result handler
 973   __ movptr(Address(rbp,
 974                     (frame::interpreter_frame_result_handler_offset) * wordSize),
 975             rax);
 976 
 977   // pass mirror handle if static call
 978   {
 979     Label L;
 980     __ movl(t, Address(method, Method::access_flags_offset()));
 981     __ testl(t, JVM_ACC_STATIC);
 982     __ jcc(Assembler::zero, L);
 983     // get mirror
 984     __ load_mirror(t, method, rax);
 985     // copy mirror into activation frame
 986     __ movptr(Address(rbp, frame::interpreter_frame_oop_temp_offset * wordSize),
 987             t);
 988     // pass handle to mirror
 989 #ifndef _LP64
 990     __ lea(t, Address(rbp, frame::interpreter_frame_oop_temp_offset * wordSize));
 991     __ movptr(Address(rsp, wordSize), t);
 992 #else
 993     __ lea(c_rarg1,
 994            Address(rbp, frame::interpreter_frame_oop_temp_offset * wordSize));
 995 #endif // _LP64
 996     __ bind(L);
 997   }
 998 
 999   // get native function entry point
1000   {
1001     Label L;
1002     __ movptr(rax, Address(method, Method::native_function_offset()));
1003     ExternalAddress unsatisfied(SharedRuntime::native_method_throw_unsatisfied_link_error_entry());
1004     __ cmpptr(rax, unsatisfied.addr());
1005     __ jcc(Assembler::notEqual, L);
1006     __ call_VM(noreg,
1007                CAST_FROM_FN_PTR(address,
1008                                 InterpreterRuntime::prepare_native_call),
1009                method);
1010     __ get_method(method);
1011     __ movptr(rax, Address(method, Method::native_function_offset()));
1012     __ bind(L);
1013   }
1014 
1015   // pass JNIEnv
1016 #ifndef _LP64
1017    __ get_thread(thread);
1018    __ lea(t, Address(thread, JavaThread::jni_environment_offset()));
1019    __ movptr(Address(rsp, 0), t);
1020 
1021    // set_last_Java_frame_before_call
1022    // It is enough that the pc()
1023    // points into the right code segment. It does not have to be the correct return pc.
1024    __ set_last_Java_frame(thread, noreg, rbp, __ pc());
1025 #else
1026    __ lea(c_rarg0, Address(r15_thread, JavaThread::jni_environment_offset()));
1027 
1028    // It is enough that the pc() points into the right code
1029    // segment. It does not have to be the correct return pc.
1030    __ set_last_Java_frame(rsp, rbp, (address) __ pc());
1031 #endif // _LP64
1032 
1033   // change thread state
1034 #ifdef ASSERT
1035   {
1036     Label L;
1037     __ movl(t, Address(thread, JavaThread::thread_state_offset()));
1038     __ cmpl(t, _thread_in_Java);
1039     __ jcc(Assembler::equal, L);
1040     __ stop(&quot;Wrong thread state in native stub&quot;);
1041     __ bind(L);
1042   }
1043 #endif
1044 
1045   // Change state to native
1046 
1047   __ movl(Address(thread, JavaThread::thread_state_offset()),
1048           _thread_in_native);
1049 
1050   // Call the native method.
1051   __ call(rax);
1052   // 32: result potentially in rdx:rax or ST0
1053   // 64: result potentially in rax or xmm0
1054 
1055   // Verify or restore cpu control state after JNI call
1056   __ restore_cpu_control_state_after_jni();
1057 
1058   // NOTE: The order of these pushes is known to frame::interpreter_frame_result
1059   // in order to extract the result of a method call. If the order of these
1060   // pushes change or anything else is added to the stack then the code in
1061   // interpreter_frame_result must also change.
1062 
1063 #ifndef _LP64
1064   // save potential result in ST(0) &amp; rdx:rax
1065   // (if result handler is the T_FLOAT or T_DOUBLE handler, result must be in ST0 -
1066   // the check is necessary to avoid potential Intel FPU overflow problems by saving/restoring &#39;empty&#39; FPU registers)
1067   // It is safe to do this push because state is _thread_in_native and return address will be found
1068   // via _last_native_pc and not via _last_jave_sp
1069 
1070   // NOTE: the order of theses push(es) is known to frame::interpreter_frame_result.
1071   // If the order changes or anything else is added to the stack the code in
1072   // interpreter_frame_result will have to be changed.
1073 
1074   { Label L;
1075     Label push_double;
1076     ExternalAddress float_handler(AbstractInterpreter::result_handler(T_FLOAT));
1077     ExternalAddress double_handler(AbstractInterpreter::result_handler(T_DOUBLE));
1078     __ cmpptr(Address(rbp, (frame::interpreter_frame_oop_temp_offset + 1)*wordSize),
1079               float_handler.addr());
1080     __ jcc(Assembler::equal, push_double);
1081     __ cmpptr(Address(rbp, (frame::interpreter_frame_oop_temp_offset + 1)*wordSize),
1082               double_handler.addr());
1083     __ jcc(Assembler::notEqual, L);
1084     __ bind(push_double);
1085     __ push_d(); // FP values are returned using the FPU, so push FPU contents (even if UseSSE &gt; 0).
1086     __ bind(L);
1087   }
1088 #else
1089   __ push(dtos);
1090 #endif // _LP64
1091 
1092   __ push(ltos);
1093 
1094   // change thread state
1095   NOT_LP64(__ get_thread(thread));
1096   __ movl(Address(thread, JavaThread::thread_state_offset()),
1097           _thread_in_native_trans);
1098 
1099   // Force this write out before the read below
1100   __ membar(Assembler::Membar_mask_bits(
1101               Assembler::LoadLoad | Assembler::LoadStore |
1102               Assembler::StoreLoad | Assembler::StoreStore));
1103 
1104 #ifndef _LP64
1105   if (AlwaysRestoreFPU) {
1106     //  Make sure the control word is correct.
1107     __ fldcw(ExternalAddress(StubRoutines::addr_fpu_cntrl_wrd_std()));
1108   }
1109 #endif // _LP64
1110 
1111   // check for safepoint operation in progress and/or pending suspend requests
1112   {
1113     Label Continue;
1114     Label slow_path;
1115 
1116 #ifndef _LP64
1117     __ safepoint_poll(slow_path, thread, noreg);
1118 #else
1119     __ safepoint_poll(slow_path, r15_thread, rscratch1);
1120 #endif
1121 
1122     __ cmpl(Address(thread, JavaThread::suspend_flags_offset()), 0);
1123     __ jcc(Assembler::equal, Continue);
1124     __ bind(slow_path);
1125 
1126     // Don&#39;t use call_VM as it will see a possible pending exception
1127     // and forward it and never return here preventing us from
1128     // clearing _last_native_pc down below.  Also can&#39;t use
1129     // call_VM_leaf either as it will check to see if r13 &amp; r14 are
1130     // preserved and correspond to the bcp/locals pointers. So we do a
1131     // runtime call by hand.
1132     //
1133 #ifndef _LP64
1134     __ push(thread);
1135     __ call(RuntimeAddress(CAST_FROM_FN_PTR(address,
1136                                             JavaThread::check_special_condition_for_native_trans)));
1137     __ increment(rsp, wordSize);
1138     __ get_thread(thread);
1139 #else
1140     __ mov(c_rarg0, r15_thread);
1141     __ mov(r12, rsp); // remember sp (can only use r12 if not using call_VM)
1142     __ subptr(rsp, frame::arg_reg_save_area_bytes); // windows
1143     __ andptr(rsp, -16); // align stack as required by ABI
1144     __ call(RuntimeAddress(CAST_FROM_FN_PTR(address, JavaThread::check_special_condition_for_native_trans)));
1145     __ mov(rsp, r12); // restore sp
1146     __ reinit_heapbase();
1147 #endif // _LP64
1148     __ bind(Continue);
1149   }
1150 
1151   // change thread state
1152   __ movl(Address(thread, JavaThread::thread_state_offset()), _thread_in_Java);
1153 
1154   // reset_last_Java_frame
1155   __ reset_last_Java_frame(thread, true);
1156 
1157   if (CheckJNICalls) {
1158     // clear_pending_jni_exception_check
1159     __ movptr(Address(thread, JavaThread::pending_jni_exception_check_fn_offset()), NULL_WORD);
1160   }
1161 
1162   // reset handle block
1163   __ movptr(t, Address(thread, JavaThread::active_handles_offset()));
1164   __ movl(Address(t, JNIHandleBlock::top_offset_in_bytes()), (int32_t)NULL_WORD);
1165 
1166   // If result is an oop unbox and store it in frame where gc will see it
1167   // and result handler will pick it up
1168 
1169   {
1170     Label no_oop;
1171     __ lea(t, ExternalAddress(AbstractInterpreter::result_handler(T_OBJECT)));
1172     __ cmpptr(t, Address(rbp, frame::interpreter_frame_result_handler_offset*wordSize));
1173     __ jcc(Assembler::notEqual, no_oop);
1174     // retrieve result
1175     __ pop(ltos);
1176     // Unbox oop result, e.g. JNIHandles::resolve value.
1177     __ resolve_jobject(rax /* value */,
1178                        thread /* thread */,
1179                        t /* tmp */);
1180     __ movptr(Address(rbp, frame::interpreter_frame_oop_temp_offset*wordSize), rax);
1181     // keep stack depth as expected by pushing oop which will eventually be discarded
1182     __ push(ltos);
1183     __ bind(no_oop);
1184   }
1185 
1186 
1187   {
1188     Label no_reguard;
1189     __ cmpl(Address(thread, JavaThread::stack_guard_state_offset()),
1190             JavaThread::stack_guard_yellow_reserved_disabled);
1191     __ jcc(Assembler::notEqual, no_reguard);
1192 
1193     __ pusha(); // XXX only save smashed registers
1194 #ifndef _LP64
1195     __ call(RuntimeAddress(CAST_FROM_FN_PTR(address, SharedRuntime::reguard_yellow_pages)));
1196     __ popa();
1197 #else
1198     __ mov(r12, rsp); // remember sp (can only use r12 if not using call_VM)
1199     __ subptr(rsp, frame::arg_reg_save_area_bytes); // windows
1200     __ andptr(rsp, -16); // align stack as required by ABI
1201     __ call(RuntimeAddress(CAST_FROM_FN_PTR(address, SharedRuntime::reguard_yellow_pages)));
1202     __ mov(rsp, r12); // restore sp
1203     __ popa(); // XXX only restore smashed registers
1204     __ reinit_heapbase();
1205 #endif // _LP64
1206 
1207     __ bind(no_reguard);
1208   }
1209 
1210 
1211   // The method register is junk from after the thread_in_native transition
1212   // until here.  Also can&#39;t call_VM until the bcp has been
1213   // restored.  Need bcp for throwing exception below so get it now.
1214   __ get_method(method);
1215 
1216   // restore to have legal interpreter frame, i.e., bci == 0 &lt;=&gt; code_base()
1217   __ movptr(rbcp, Address(method, Method::const_offset()));   // get ConstMethod*
1218   __ lea(rbcp, Address(rbcp, ConstMethod::codes_offset()));    // get codebase
1219 
1220   // handle exceptions (exception handling will handle unlocking!)
1221   {
1222     Label L;
1223     __ cmpptr(Address(thread, Thread::pending_exception_offset()), (int32_t) NULL_WORD);
1224     __ jcc(Assembler::zero, L);
1225     // Note: At some point we may want to unify this with the code
1226     // used in call_VM_base(); i.e., we should use the
1227     // StubRoutines::forward_exception code. For now this doesn&#39;t work
1228     // here because the rsp is not correctly set at this point.
1229     __ MacroAssembler::call_VM(noreg,
1230                                CAST_FROM_FN_PTR(address,
1231                                InterpreterRuntime::throw_pending_exception));
1232     __ should_not_reach_here();
1233     __ bind(L);
1234   }
1235 
1236   // do unlocking if necessary
1237   {
1238     Label L;
1239     __ movl(t, Address(method, Method::access_flags_offset()));
1240     __ testl(t, JVM_ACC_SYNCHRONIZED);
1241     __ jcc(Assembler::zero, L);
1242     // the code below should be shared with interpreter macro
1243     // assembler implementation
1244     {
1245       Label unlock;
1246       // BasicObjectLock will be first in list, since this is a
1247       // synchronized method. However, need to check that the object
1248       // has not been unlocked by an explicit monitorexit bytecode.
1249       const Address monitor(rbp,
1250                             (intptr_t)(frame::interpreter_frame_initial_sp_offset *
1251                                        wordSize - (int)sizeof(BasicObjectLock)));
1252 
1253       const Register regmon = NOT_LP64(rdx) LP64_ONLY(c_rarg1);
1254 
1255       // monitor expect in c_rarg1 for slow unlock path
1256       __ lea(regmon, monitor); // address of first monitor
1257 
1258       __ movptr(t, Address(regmon, BasicObjectLock::obj_offset_in_bytes()));
1259       __ testptr(t, t);
1260       __ jcc(Assembler::notZero, unlock);
1261 
1262       // Entry already unlocked, need to throw exception
1263       __ MacroAssembler::call_VM(noreg,
1264                                  CAST_FROM_FN_PTR(address,
1265                    InterpreterRuntime::throw_illegal_monitor_state_exception));
1266       __ should_not_reach_here();
1267 
1268       __ bind(unlock);
1269       __ unlock_object(regmon);
1270     }
1271     __ bind(L);
1272   }
1273 
1274   // jvmti support
1275   // Note: This must happen _after_ handling/throwing any exceptions since
1276   //       the exception handler code notifies the runtime of method exits
1277   //       too. If this happens before, method entry/exit notifications are
1278   //       not properly paired (was bug - gri 11/22/99).
1279   __ notify_method_exit(vtos, InterpreterMacroAssembler::NotifyJVMTI);
1280 
1281   // restore potential result in edx:eax, call result handler to
1282   // restore potential result in ST0 &amp; handle result
1283 
1284   __ pop(ltos);
1285   LP64_ONLY( __ pop(dtos));
1286 
1287   __ movptr(t, Address(rbp,
1288                        (frame::interpreter_frame_result_handler_offset) * wordSize));
1289   __ call(t);
1290 
1291   // remove activation
1292   __ movptr(t, Address(rbp,
1293                        frame::interpreter_frame_sender_sp_offset *
1294                        wordSize)); // get sender sp
1295   __ leave();                                // remove frame anchor
1296   __ pop(rdi);                               // get return address
1297   __ mov(rsp, t);                            // set sp to sender sp
1298   __ jmp(rdi);
1299 
1300   if (inc_counter) {
1301     // Handle overflow of counter and compile method
1302     __ bind(invocation_counter_overflow);
1303     generate_counter_overflow(continue_after_compile);
1304   }
1305 
1306   return entry_point;
1307 }
1308 
1309 // Abstract method entry
1310 // Attempt to execute abstract method. Throw exception
1311 address TemplateInterpreterGenerator::generate_abstract_entry(void) {
1312 
1313   address entry_point = __ pc();
1314 
1315   // abstract method entry
1316 
1317   //  pop return address, reset last_sp to NULL
1318   __ empty_expression_stack();
1319   __ restore_bcp();      // rsi must be correct for exception handler   (was destroyed)
1320   __ restore_locals();   // make sure locals pointer is correct as well (was destroyed)
1321 
1322   // throw exception
1323   __ call_VM(noreg, CAST_FROM_FN_PTR(address, InterpreterRuntime::throw_AbstractMethodErrorWithMethod), rbx);
1324   // the call_VM checks for exception, so we should never return here.
1325   __ should_not_reach_here();
1326 
1327   return entry_point;
1328 }
1329 
1330 //
1331 // Generic interpreted method entry to (asm) interpreter
1332 //
1333 address TemplateInterpreterGenerator::generate_normal_entry(bool synchronized) {
1334   // determine code generation flags
1335   bool inc_counter  = UseCompiler || CountCompiledCalls || LogTouchedMethods;
1336 
1337   // ebx: Method*
1338   // rbcp: sender sp
1339   address entry_point = __ pc();
1340 
1341   const Address constMethod(rbx, Method::const_offset());
1342   const Address access_flags(rbx, Method::access_flags_offset());
1343   const Address size_of_parameters(rdx,
1344                                    ConstMethod::size_of_parameters_offset());
1345   const Address size_of_locals(rdx, ConstMethod::size_of_locals_offset());
1346 
1347 
1348   // get parameter size (always needed)
1349   __ movptr(rdx, constMethod);
1350   __ load_unsigned_short(rcx, size_of_parameters);
1351 
1352   // rbx: Method*
1353   // rcx: size of parameters
1354   // rbcp: sender_sp (could differ from sp+wordSize if we were called via c2i )
1355 
1356   __ load_unsigned_short(rdx, size_of_locals); // get size of locals in words
1357   __ subl(rdx, rcx); // rdx = no. of additional locals
1358 
1359   // YYY
1360 //   __ incrementl(rdx);
1361 //   __ andl(rdx, -2);
1362 
1363   // see if we&#39;ve got enough room on the stack for locals plus overhead.
1364   generate_stack_overflow_check();
1365 
1366   // get return address
1367   __ pop(rax);
1368 
1369   // compute beginning of parameters
1370   __ lea(rlocals, Address(rsp, rcx, Interpreter::stackElementScale(), -wordSize));
1371 
1372   // rdx - # of additional locals
1373   // allocate space for locals
1374   // explicitly initialize locals
1375   {
1376     Label exit, loop;
1377     __ testl(rdx, rdx);
1378     __ jcc(Assembler::lessEqual, exit); // do nothing if rdx &lt;= 0
1379     __ bind(loop);
1380     __ push((int) NULL_WORD); // initialize local variables
1381     __ decrementl(rdx); // until everything initialized
1382     __ jcc(Assembler::greater, loop);
1383     __ bind(exit);
1384   }
1385 
1386   // initialize fixed part of activation frame
1387   generate_fixed_frame(false);
1388 
1389   // make sure method is not native &amp; not abstract
1390 #ifdef ASSERT
1391   __ movl(rax, access_flags);
1392   {
1393     Label L;
1394     __ testl(rax, JVM_ACC_NATIVE);
1395     __ jcc(Assembler::zero, L);
1396     __ stop(&quot;tried to execute native method as non-native&quot;);
1397     __ bind(L);
1398   }
1399   {
1400     Label L;
1401     __ testl(rax, JVM_ACC_ABSTRACT);
1402     __ jcc(Assembler::zero, L);
1403     __ stop(&quot;tried to execute abstract method in interpreter&quot;);
1404     __ bind(L);
1405   }
1406 #endif
1407 
1408   // Since at this point in the method invocation the exception
1409   // handler would try to exit the monitor of synchronized methods
1410   // which hasn&#39;t been entered yet, we set the thread local variable
1411   // _do_not_unlock_if_synchronized to true. The remove_activation
1412   // will check this flag.
1413 
1414   const Register thread = NOT_LP64(rax) LP64_ONLY(r15_thread);
1415   NOT_LP64(__ get_thread(thread));
1416   const Address do_not_unlock_if_synchronized(thread,
1417         in_bytes(JavaThread::do_not_unlock_if_synchronized_offset()));
1418   __ movbool(do_not_unlock_if_synchronized, true);
1419 
1420   __ profile_parameters_type(rax, rcx, rdx);
1421   // increment invocation count &amp; check for overflow
1422   Label invocation_counter_overflow;
1423   Label profile_method;
1424   Label profile_method_continue;
1425   if (inc_counter) {
1426     generate_counter_incr(&amp;invocation_counter_overflow,
1427                           &amp;profile_method,
1428                           &amp;profile_method_continue);
1429     if (ProfileInterpreter) {
1430       __ bind(profile_method_continue);
1431     }
1432   }
1433 
1434   Label continue_after_compile;
1435   __ bind(continue_after_compile);
1436 
1437   // check for synchronized interpreted methods
1438   bang_stack_shadow_pages(false);
1439 
1440   // reset the _do_not_unlock_if_synchronized flag
1441   NOT_LP64(__ get_thread(thread));
1442   __ movbool(do_not_unlock_if_synchronized, false);
1443 
1444   // check for synchronized methods
1445   // Must happen AFTER invocation_counter check and stack overflow check,
1446   // so method is not locked if overflows.
1447   if (synchronized) {
1448     // Allocate monitor and lock method
1449     lock_method();
1450   } else {
1451     // no synchronization necessary
1452 #ifdef ASSERT
1453     {
1454       Label L;
1455       __ movl(rax, access_flags);
1456       __ testl(rax, JVM_ACC_SYNCHRONIZED);
1457       __ jcc(Assembler::zero, L);
1458       __ stop(&quot;method needs synchronization&quot;);
1459       __ bind(L);
1460     }
1461 #endif
1462   }
1463 
1464   // start execution
1465 #ifdef ASSERT
1466   {
1467     Label L;
1468      const Address monitor_block_top (rbp,
1469                  frame::interpreter_frame_monitor_block_top_offset * wordSize);
1470     __ movptr(rax, monitor_block_top);
1471     __ cmpptr(rax, rsp);
1472     __ jcc(Assembler::equal, L);
1473     __ stop(&quot;broken stack frame setup in interpreter&quot;);
1474     __ bind(L);
1475   }
1476 #endif
1477 
1478   // jvmti support
1479   __ notify_method_entry();
1480 
1481   __ dispatch_next(vtos);
1482 
1483   // invocation counter overflow
1484   if (inc_counter) {
1485     if (ProfileInterpreter) {
1486       // We have decided to profile this method in the interpreter
1487       __ bind(profile_method);
1488       __ call_VM(noreg, CAST_FROM_FN_PTR(address, InterpreterRuntime::profile_method));
1489       __ set_method_data_pointer_for_bcp();
1490       __ get_method(rbx);
1491       __ jmp(profile_method_continue);
1492     }
1493     // Handle overflow of counter and compile method
1494     __ bind(invocation_counter_overflow);
1495     generate_counter_overflow(continue_after_compile);
1496   }
1497 
1498   return entry_point;
1499 }
1500 
1501 //-----------------------------------------------------------------------------
1502 // Exceptions
1503 
1504 void TemplateInterpreterGenerator::generate_throw_exception() {
1505   // Entry point in previous activation (i.e., if the caller was
1506   // interpreted)
1507   Interpreter::_rethrow_exception_entry = __ pc();
1508   // Restore sp to interpreter_frame_last_sp even though we are going
1509   // to empty the expression stack for the exception processing.
1510   __ movptr(Address(rbp, frame::interpreter_frame_last_sp_offset * wordSize), (int32_t)NULL_WORD);
1511   // rax: exception
1512   // rdx: return address/pc that threw exception
1513   __ restore_bcp();    // r13/rsi points to call/send
1514   __ restore_locals();
1515   LP64_ONLY(__ reinit_heapbase());  // restore r12 as heapbase.
1516   // Entry point for exceptions thrown within interpreter code
1517   Interpreter::_throw_exception_entry = __ pc();
1518   // expression stack is undefined here
1519   // rax: exception
1520   // r13/rsi: exception bcp
1521   __ verify_oop(rax);
1522   Register rarg = NOT_LP64(rax) LP64_ONLY(c_rarg1);
1523   LP64_ONLY(__ mov(c_rarg1, rax));
1524 
1525   // expression stack must be empty before entering the VM in case of
1526   // an exception
1527   __ empty_expression_stack();
1528   // find exception handler address and preserve exception oop
1529   __ call_VM(rdx,
1530              CAST_FROM_FN_PTR(address,
1531                           InterpreterRuntime::exception_handler_for_exception),
1532              rarg);
1533   // rax: exception handler entry point
1534   // rdx: preserved exception oop
1535   // r13/rsi: bcp for exception handler
1536   __ push_ptr(rdx); // push exception which is now the only value on the stack
1537   __ jmp(rax); // jump to exception handler (may be _remove_activation_entry!)
1538 
1539   // If the exception is not handled in the current frame the frame is
1540   // removed and the exception is rethrown (i.e. exception
1541   // continuation is _rethrow_exception).
1542   //
1543   // Note: At this point the bci is still the bxi for the instruction
1544   // which caused the exception and the expression stack is
1545   // empty. Thus, for any VM calls at this point, GC will find a legal
1546   // oop map (with empty expression stack).
1547 
1548   // In current activation
1549   // tos: exception
1550   // esi: exception bcp
1551 
1552   //
1553   // JVMTI PopFrame support
1554   //
1555 
1556   Interpreter::_remove_activation_preserving_args_entry = __ pc();
1557   __ empty_expression_stack();
1558   // Set the popframe_processing bit in pending_popframe_condition
1559   // indicating that we are currently handling popframe, so that
1560   // call_VMs that may happen later do not trigger new popframe
1561   // handling cycles.
1562   const Register thread = NOT_LP64(rcx) LP64_ONLY(r15_thread);
1563   NOT_LP64(__ get_thread(thread));
1564   __ movl(rdx, Address(thread, JavaThread::popframe_condition_offset()));
1565   __ orl(rdx, JavaThread::popframe_processing_bit);
1566   __ movl(Address(thread, JavaThread::popframe_condition_offset()), rdx);
1567 
1568   {
1569     // Check to see whether we are returning to a deoptimized frame.
1570     // (The PopFrame call ensures that the caller of the popped frame is
1571     // either interpreted or compiled and deoptimizes it if compiled.)
1572     // In this case, we can&#39;t call dispatch_next() after the frame is
1573     // popped, but instead must save the incoming arguments and restore
1574     // them after deoptimization has occurred.
1575     //
1576     // Note that we don&#39;t compare the return PC against the
1577     // deoptimization blob&#39;s unpack entry because of the presence of
1578     // adapter frames in C2.
1579     Label caller_not_deoptimized;
1580     Register rarg = NOT_LP64(rdx) LP64_ONLY(c_rarg1);
1581     __ movptr(rarg, Address(rbp, frame::return_addr_offset * wordSize));
1582     __ super_call_VM_leaf(CAST_FROM_FN_PTR(address,
1583                                InterpreterRuntime::interpreter_contains), rarg);
1584     __ testl(rax, rax);
1585     __ jcc(Assembler::notZero, caller_not_deoptimized);
1586 
1587     // Compute size of arguments for saving when returning to
1588     // deoptimized caller
1589     __ get_method(rax);
1590     __ movptr(rax, Address(rax, Method::const_offset()));
1591     __ load_unsigned_short(rax, Address(rax, in_bytes(ConstMethod::
1592                                                 size_of_parameters_offset())));
1593     __ shll(rax, Interpreter::logStackElementSize);
1594     __ restore_locals();
1595     __ subptr(rlocals, rax);
1596     __ addptr(rlocals, wordSize);
1597     // Save these arguments
1598     NOT_LP64(__ get_thread(thread));
1599     __ super_call_VM_leaf(CAST_FROM_FN_PTR(address,
1600                                            Deoptimization::
1601                                            popframe_preserve_args),
1602                           thread, rax, rlocals);
1603 
1604     __ remove_activation(vtos, rdx,
1605                          /* throw_monitor_exception */ false,
1606                          /* install_monitor_exception */ false,
1607                          /* notify_jvmdi */ false);
1608 
1609     // Inform deoptimization that it is responsible for restoring
1610     // these arguments
1611     NOT_LP64(__ get_thread(thread));
1612     __ movl(Address(thread, JavaThread::popframe_condition_offset()),
1613             JavaThread::popframe_force_deopt_reexecution_bit);
1614 
1615     // Continue in deoptimization handler
1616     __ jmp(rdx);
1617 
1618     __ bind(caller_not_deoptimized);
1619   }
1620 
1621   __ remove_activation(vtos, rdx, /* rdx result (retaddr) is not used */
1622                        /* throw_monitor_exception */ false,
1623                        /* install_monitor_exception */ false,
1624                        /* notify_jvmdi */ false);
1625 
1626   // Finish with popframe handling
1627   // A previous I2C followed by a deoptimization might have moved the
1628   // outgoing arguments further up the stack. PopFrame expects the
1629   // mutations to those outgoing arguments to be preserved and other
1630   // constraints basically require this frame to look exactly as
1631   // though it had previously invoked an interpreted activation with
1632   // no space between the top of the expression stack (current
1633   // last_sp) and the top of stack. Rather than force deopt to
1634   // maintain this kind of invariant all the time we call a small
1635   // fixup routine to move the mutated arguments onto the top of our
1636   // expression stack if necessary.
1637 #ifndef _LP64
1638   __ mov(rax, rsp);
1639   __ movptr(rbx, Address(rbp, frame::interpreter_frame_last_sp_offset * wordSize));
1640   __ get_thread(thread);
1641   // PC must point into interpreter here
1642   __ set_last_Java_frame(thread, noreg, rbp, __ pc());
1643   __ super_call_VM_leaf(CAST_FROM_FN_PTR(address, InterpreterRuntime::popframe_move_outgoing_args), thread, rax, rbx);
1644   __ get_thread(thread);
1645 #else
1646   __ mov(c_rarg1, rsp);
1647   __ movptr(c_rarg2, Address(rbp, frame::interpreter_frame_last_sp_offset * wordSize));
1648   // PC must point into interpreter here
1649   __ set_last_Java_frame(noreg, rbp, __ pc());
1650   __ super_call_VM_leaf(CAST_FROM_FN_PTR(address, InterpreterRuntime::popframe_move_outgoing_args), r15_thread, c_rarg1, c_rarg2);
1651 #endif
1652   __ reset_last_Java_frame(thread, true);
1653 
1654   // Restore the last_sp and null it out
1655   __ movptr(rsp, Address(rbp, frame::interpreter_frame_last_sp_offset * wordSize));
1656   __ movptr(Address(rbp, frame::interpreter_frame_last_sp_offset * wordSize), (int32_t)NULL_WORD);
1657 
1658   __ restore_bcp();
1659   __ restore_locals();
1660   // The method data pointer was incremented already during
1661   // call profiling. We have to restore the mdp for the current bcp.
1662   if (ProfileInterpreter) {
1663     __ set_method_data_pointer_for_bcp();
1664   }
1665 
1666   // Clear the popframe condition flag
1667   NOT_LP64(__ get_thread(thread));
1668   __ movl(Address(thread, JavaThread::popframe_condition_offset()),
1669           JavaThread::popframe_inactive);
1670 
1671 #if INCLUDE_JVMTI
1672   {
1673     Label L_done;
1674     const Register local0 = rlocals;
1675 
1676     __ cmpb(Address(rbcp, 0), Bytecodes::_invokestatic);
1677     __ jcc(Assembler::notEqual, L_done);
1678 
1679     // The member name argument must be restored if _invokestatic is re-executed after a PopFrame call.
1680     // Detect such a case in the InterpreterRuntime function and return the member name argument, or NULL.
1681 
1682     __ get_method(rdx);
1683     __ movptr(rax, Address(local0, 0));
1684     __ call_VM(rax, CAST_FROM_FN_PTR(address, InterpreterRuntime::member_name_arg_or_null), rax, rdx, rbcp);
1685 
1686     __ testptr(rax, rax);
1687     __ jcc(Assembler::zero, L_done);
1688 
1689     __ movptr(Address(rbx, 0), rax);
1690     __ bind(L_done);
1691   }
1692 #endif // INCLUDE_JVMTI
1693 
1694   __ dispatch_next(vtos);
1695   // end of PopFrame support
1696 
1697   Interpreter::_remove_activation_entry = __ pc();
1698 
1699   // preserve exception over this code sequence
1700   __ pop_ptr(rax);
1701   NOT_LP64(__ get_thread(thread));
1702   __ movptr(Address(thread, JavaThread::vm_result_offset()), rax);
1703   // remove the activation (without doing throws on illegalMonitorExceptions)
1704   __ remove_activation(vtos, rdx, false, true, false);
1705   // restore exception
1706   NOT_LP64(__ get_thread(thread));
1707   __ get_vm_result(rax, thread);
1708 
1709   // In between activations - previous activation type unknown yet
1710   // compute continuation point - the continuation point expects the
1711   // following registers set up:
1712   //
1713   // rax: exception
1714   // rdx: return address/pc that threw exception
1715   // rsp: expression stack of caller
1716   // rbp: ebp of caller
1717   __ push(rax);                                  // save exception
1718   __ push(rdx);                                  // save return address
1719   __ super_call_VM_leaf(CAST_FROM_FN_PTR(address,
1720                           SharedRuntime::exception_handler_for_return_address),
1721                         thread, rdx);
1722   __ mov(rbx, rax);                              // save exception handler
1723   __ pop(rdx);                                   // restore return address
1724   __ pop(rax);                                   // restore exception
1725   // Note that an &quot;issuing PC&quot; is actually the next PC after the call
1726   __ jmp(rbx);                                   // jump to exception
1727                                                  // handler of caller
1728 }
1729 
1730 
1731 //
1732 // JVMTI ForceEarlyReturn support
1733 //
1734 address TemplateInterpreterGenerator::generate_earlyret_entry_for(TosState state) {
1735   address entry = __ pc();
1736 
1737   __ restore_bcp();
1738   __ restore_locals();
1739   __ empty_expression_stack();
1740   __ load_earlyret_value(state);  // 32 bits returns value in rdx, so don&#39;t reuse
1741 
1742   const Register thread = NOT_LP64(rcx) LP64_ONLY(r15_thread);
1743   NOT_LP64(__ get_thread(thread));
1744   __ movptr(rcx, Address(thread, JavaThread::jvmti_thread_state_offset()));
1745   Address cond_addr(rcx, JvmtiThreadState::earlyret_state_offset());
1746 
1747   // Clear the earlyret state
1748   __ movl(cond_addr, JvmtiThreadState::earlyret_inactive);
1749 
1750   __ remove_activation(state, rsi,
1751                        false, /* throw_monitor_exception */
1752                        false, /* install_monitor_exception */
1753                        true); /* notify_jvmdi */
1754   __ jmp(rsi);
1755 
1756   return entry;
1757 } // end of ForceEarlyReturn support
1758 
1759 
1760 //-----------------------------------------------------------------------------
1761 // Helper for vtos entry point generation
1762 
1763 void TemplateInterpreterGenerator::set_vtos_entry_points(Template* t,
1764                                                          address&amp; bep,
1765                                                          address&amp; cep,
1766                                                          address&amp; sep,
1767                                                          address&amp; aep,
1768                                                          address&amp; iep,
1769                                                          address&amp; lep,
1770                                                          address&amp; fep,
1771                                                          address&amp; dep,
1772                                                          address&amp; vep) {
1773   assert(t-&gt;is_valid() &amp;&amp; t-&gt;tos_in() == vtos, &quot;illegal template&quot;);
1774   Label L;
1775   aep = __ pc();     // atos entry point
1776       __ push_ptr();
1777       __ jmp(L);
1778 #ifndef _LP64
1779   fep = __ pc();     // ftos entry point
1780       __ push(ftos);
1781       __ jmp(L);
1782   dep = __ pc();     // dtos entry point
1783       __ push(dtos);
1784       __ jmp(L);
1785 #else
1786   fep = __ pc();     // ftos entry point
1787       __ push_f(xmm0);
1788       __ jmp(L);
1789   dep = __ pc();     // dtos entry point
1790       __ push_d(xmm0);
1791       __ jmp(L);
1792 #endif // _LP64
1793   lep = __ pc();     // ltos entry point
1794       __ push_l();
1795       __ jmp(L);
1796   bep = cep = sep = iep = __ pc();      // [bcsi]tos entry point
1797       __ push_i();
1798   vep = __ pc();    // vtos entry point
1799   __ bind(L);
1800   generate_and_dispatch(t);
1801 }
1802 
1803 //-----------------------------------------------------------------------------
1804 
1805 // Non-product code
1806 #ifndef PRODUCT
1807 
1808 address TemplateInterpreterGenerator::generate_trace_code(TosState state) {
1809   address entry = __ pc();
1810 
1811 #ifndef _LP64
1812   // prepare expression stack
1813   __ pop(rcx);          // pop return address so expression stack is &#39;pure&#39;
1814   __ push(state);       // save tosca
1815 
1816   // pass tosca registers as arguments &amp; call tracer
1817   __ call_VM(noreg, CAST_FROM_FN_PTR(address, InterpreterRuntime::trace_bytecode), rcx, rax, rdx);
1818   __ mov(rcx, rax);     // make sure return address is not destroyed by pop(state)
1819   __ pop(state);        // restore tosca
1820 
1821   // return
1822   __ jmp(rcx);
1823 #else
1824   __ push(state);
1825   __ push(c_rarg0);
1826   __ push(c_rarg1);
1827   __ push(c_rarg2);
1828   __ push(c_rarg3);
1829   __ mov(c_rarg2, rax);  // Pass itos
1830 #ifdef _WIN64
1831   __ movflt(xmm3, xmm0); // Pass ftos
1832 #endif
1833   __ call_VM(noreg,
1834              CAST_FROM_FN_PTR(address, InterpreterRuntime::trace_bytecode),
1835              c_rarg1, c_rarg2, c_rarg3);
1836   __ pop(c_rarg3);
1837   __ pop(c_rarg2);
1838   __ pop(c_rarg1);
1839   __ pop(c_rarg0);
1840   __ pop(state);
1841   __ ret(0);                                   // return from result handler
1842 #endif // _LP64
1843 
1844   return entry;
1845 }
1846 
1847 void TemplateInterpreterGenerator::count_bytecode() {
1848   __ incrementl(ExternalAddress((address) &amp;BytecodeCounter::_counter_value));
1849 }
1850 
1851 void TemplateInterpreterGenerator::histogram_bytecode(Template* t) {
1852   __ incrementl(ExternalAddress((address) &amp;BytecodeHistogram::_counters[t-&gt;bytecode()]));
1853 }
1854 
1855 void TemplateInterpreterGenerator::histogram_bytecode_pair(Template* t) {
1856   __ mov32(rbx, ExternalAddress((address) &amp;BytecodePairHistogram::_index));
1857   __ shrl(rbx, BytecodePairHistogram::log2_number_of_codes);
1858   __ orl(rbx,
1859          ((int) t-&gt;bytecode()) &lt;&lt;
1860          BytecodePairHistogram::log2_number_of_codes);
1861   __ mov32(ExternalAddress((address) &amp;BytecodePairHistogram::_index), rbx);
1862   __ lea(rscratch1, ExternalAddress((address) BytecodePairHistogram::_counters));
1863   __ incrementl(Address(rscratch1, rbx, Address::times_4));
1864 }
1865 
1866 
1867 void TemplateInterpreterGenerator::trace_bytecode(Template* t) {
1868   // Call a little run-time stub to avoid blow-up for each bytecode.
1869   // The run-time runtime saves the right registers, depending on
1870   // the tosca in-state for the given template.
1871 
1872   assert(Interpreter::trace_code(t-&gt;tos_in()) != NULL,
1873          &quot;entry must have been generated&quot;);
1874 #ifndef _LP64
1875   __ call(RuntimeAddress(Interpreter::trace_code(t-&gt;tos_in())));
1876 #else
1877   __ mov(r12, rsp); // remember sp (can only use r12 if not using call_VM)
1878   __ andptr(rsp, -16); // align stack as required by ABI
1879   __ call(RuntimeAddress(Interpreter::trace_code(t-&gt;tos_in())));
1880   __ mov(rsp, r12); // restore sp
1881   __ reinit_heapbase();
1882 #endif // _LP64
1883 }
1884 
1885 
1886 void TemplateInterpreterGenerator::stop_interpreter_at() {
1887   Label L;
1888   __ cmp32(ExternalAddress((address) &amp;BytecodeCounter::_counter_value),
1889            StopInterpreterAt);
1890   __ jcc(Assembler::notEqual, L);
1891   __ int3();
1892   __ bind(L);
1893 }
1894 #endif // !PRODUCT
<a name="2" id="anc2"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="2" type="hidden" />
</body>
</html>