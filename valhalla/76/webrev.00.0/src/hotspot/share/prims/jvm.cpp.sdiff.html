<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/hotspot/share/prims/jvm.cpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
  </head>
<body>
<center><a href="../opto/type.cpp.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="jvmtiClassFileReconstituter.cpp.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/hotspot/share/prims/jvm.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  58 #include &quot;oops/valueArrayKlass.hpp&quot;
  59 #include &quot;prims/jvm_misc.hpp&quot;
  60 #include &quot;prims/jvmtiExport.hpp&quot;
  61 #include &quot;prims/jvmtiThreadState.hpp&quot;
  62 #include &quot;prims/nativeLookup.hpp&quot;
  63 #include &quot;prims/stackwalk.hpp&quot;
  64 #include &quot;runtime/arguments.hpp&quot;
  65 #include &quot;runtime/atomic.hpp&quot;
  66 #include &quot;runtime/handles.inline.hpp&quot;
  67 #include &quot;runtime/init.hpp&quot;
  68 #include &quot;runtime/interfaceSupport.inline.hpp&quot;
  69 #include &quot;runtime/deoptimization.hpp&quot;
  70 #include &quot;runtime/handshake.hpp&quot;
  71 #include &quot;runtime/java.hpp&quot;
  72 #include &quot;runtime/javaCalls.hpp&quot;
  73 #include &quot;runtime/jfieldIDWorkaround.hpp&quot;
  74 #include &quot;runtime/jniHandles.inline.hpp&quot;
  75 #include &quot;runtime/os.inline.hpp&quot;
  76 #include &quot;runtime/perfData.hpp&quot;
  77 #include &quot;runtime/reflection.hpp&quot;

  78 #include &quot;runtime/thread.inline.hpp&quot;
  79 #include &quot;runtime/threadSMR.hpp&quot;
  80 #include &quot;runtime/vframe.inline.hpp&quot;
  81 #include &quot;runtime/vmOperations.hpp&quot;
  82 #include &quot;runtime/vm_version.hpp&quot;
  83 #include &quot;services/attachListener.hpp&quot;
  84 #include &quot;services/management.hpp&quot;
  85 #include &quot;services/threadService.hpp&quot;
  86 #include &quot;utilities/copy.hpp&quot;
  87 #include &quot;utilities/defaultStream.hpp&quot;
  88 #include &quot;utilities/dtrace.hpp&quot;
  89 #include &quot;utilities/events.hpp&quot;
  90 #include &quot;utilities/histogram.hpp&quot;
  91 #include &quot;utilities/macros.hpp&quot;
  92 #include &quot;utilities/utf8.hpp&quot;
  93 #if INCLUDE_CDS
  94 #include &quot;classfile/systemDictionaryShared.hpp&quot;
  95 #endif
  96 
  97 #include &lt;errno.h&gt;
</pre>
<hr />
<pre>
 474   if (DynamicDumpSharedSpaces) {
 475     MetaspaceShared::link_and_cleanup_shared_classes(THREAD);
 476   }
 477   EventShutdown event;
 478   if (event.should_commit()) {
 479     event.set_reason(&quot;Shutdown requested from Java&quot;);
 480     event.commit();
 481   }
 482 JVM_END
 483 
 484 
 485 JVM_ENTRY_NO_ENV(void, JVM_Halt(jint code))
 486   before_exit(thread);
 487   vm_exit(code);
 488 JVM_END
 489 
 490 
 491 JVM_ENTRY_NO_ENV(void, JVM_GC(void))
 492   JVMWrapper(&quot;JVM_GC&quot;);
 493   if (!DisableExplicitGC) {





 494     Universe::heap()-&gt;collect(GCCause::_java_lang_system_gc);
 495   }
 496 JVM_END
 497 
 498 
 499 JVM_LEAF(jlong, JVM_MaxObjectInspectionAge(void))
 500   JVMWrapper(&quot;JVM_MaxObjectInspectionAge&quot;);
 501   return Universe::heap()-&gt;millis_since_last_gc();
 502 JVM_END
 503 
 504 
 505 static inline jlong convert_size_t_to_jlong(size_t val) {
 506   // In the 64-bit vm, a size_t can overflow a jlong (which is signed).
 507   NOT_LP64 (return (jlong)val;)
 508   LP64_ONLY(return (jlong)MIN2(val, (size_t)max_jlong);)
 509 }
 510 
 511 JVM_ENTRY_NO_ENV(jlong, JVM_TotalMemory(void))
 512   JVMWrapper(&quot;JVM_TotalMemory&quot;);
 513   size_t n = Universe::heap()-&gt;capacity();
</pre>
<hr />
<pre>
2101         log_trace(class, nestmates)(&quot; - compacting array from length %d to %d&quot;,
2102                                     length + 1, count + 1);
2103 
2104         objArrayOop r2 = oopFactory::new_objArray(SystemDictionary::Class_klass(),
2105                                                   count + 1, CHECK_NULL);
2106         objArrayHandle result2(THREAD, r2);
2107         for (int i = 0; i &lt; count + 1; i++) {
2108           result2-&gt;obj_at_put(i, result-&gt;obj_at(i));
2109         }
2110         return (jobjectArray)JNIHandles::make_local(THREAD, result2());
2111       }
2112     }
2113     else {
2114       assert(host == ck || ck-&gt;is_hidden(), &quot;must be singleton nest or dynamic nestmate&quot;);
2115     }
2116     return (jobjectArray)JNIHandles::make_local(THREAD, result());
2117   }
2118 }
2119 JVM_END
2120 



























2121 // Constant pool access //////////////////////////////////////////////////////////
2122 
2123 JVM_ENTRY(jobject, JVM_GetClassConstantPool(JNIEnv *env, jclass cls))
2124 {
2125   JVMWrapper(&quot;JVM_GetClassConstantPool&quot;);
2126   JvmtiVMObjectAllocEventCollector oam;
2127 
2128   // Return null for primitives and arrays
2129   if (!java_lang_Class::is_primitive(JNIHandles::resolve_non_null(cls))) {
2130     Klass* k = java_lang_Class::as_Klass(JNIHandles::resolve_non_null(cls));
2131     if (k-&gt;is_instance_klass()) {
2132       InstanceKlass* k_h = InstanceKlass::cast(k);
2133       Handle jcp = reflect_ConstantPool::create(CHECK_NULL);
2134       reflect_ConstantPool::set_cp(jcp(), k_h-&gt;constants());
2135       return JNIHandles::make_local(jcp());
2136     }
2137   }
2138   return NULL;
2139 }
2140 JVM_END
</pre>
</td>
<td>
<hr />
<pre>
  58 #include &quot;oops/valueArrayKlass.hpp&quot;
  59 #include &quot;prims/jvm_misc.hpp&quot;
  60 #include &quot;prims/jvmtiExport.hpp&quot;
  61 #include &quot;prims/jvmtiThreadState.hpp&quot;
  62 #include &quot;prims/nativeLookup.hpp&quot;
  63 #include &quot;prims/stackwalk.hpp&quot;
  64 #include &quot;runtime/arguments.hpp&quot;
  65 #include &quot;runtime/atomic.hpp&quot;
  66 #include &quot;runtime/handles.inline.hpp&quot;
  67 #include &quot;runtime/init.hpp&quot;
  68 #include &quot;runtime/interfaceSupport.inline.hpp&quot;
  69 #include &quot;runtime/deoptimization.hpp&quot;
  70 #include &quot;runtime/handshake.hpp&quot;
  71 #include &quot;runtime/java.hpp&quot;
  72 #include &quot;runtime/javaCalls.hpp&quot;
  73 #include &quot;runtime/jfieldIDWorkaround.hpp&quot;
  74 #include &quot;runtime/jniHandles.inline.hpp&quot;
  75 #include &quot;runtime/os.inline.hpp&quot;
  76 #include &quot;runtime/perfData.hpp&quot;
  77 #include &quot;runtime/reflection.hpp&quot;
<span class="line-added">  78 #include &quot;runtime/synchronizer.hpp&quot;</span>
  79 #include &quot;runtime/thread.inline.hpp&quot;
  80 #include &quot;runtime/threadSMR.hpp&quot;
  81 #include &quot;runtime/vframe.inline.hpp&quot;
  82 #include &quot;runtime/vmOperations.hpp&quot;
  83 #include &quot;runtime/vm_version.hpp&quot;
  84 #include &quot;services/attachListener.hpp&quot;
  85 #include &quot;services/management.hpp&quot;
  86 #include &quot;services/threadService.hpp&quot;
  87 #include &quot;utilities/copy.hpp&quot;
  88 #include &quot;utilities/defaultStream.hpp&quot;
  89 #include &quot;utilities/dtrace.hpp&quot;
  90 #include &quot;utilities/events.hpp&quot;
  91 #include &quot;utilities/histogram.hpp&quot;
  92 #include &quot;utilities/macros.hpp&quot;
  93 #include &quot;utilities/utf8.hpp&quot;
  94 #if INCLUDE_CDS
  95 #include &quot;classfile/systemDictionaryShared.hpp&quot;
  96 #endif
  97 
  98 #include &lt;errno.h&gt;
</pre>
<hr />
<pre>
 475   if (DynamicDumpSharedSpaces) {
 476     MetaspaceShared::link_and_cleanup_shared_classes(THREAD);
 477   }
 478   EventShutdown event;
 479   if (event.should_commit()) {
 480     event.set_reason(&quot;Shutdown requested from Java&quot;);
 481     event.commit();
 482   }
 483 JVM_END
 484 
 485 
 486 JVM_ENTRY_NO_ENV(void, JVM_Halt(jint code))
 487   before_exit(thread);
 488   vm_exit(code);
 489 JVM_END
 490 
 491 
 492 JVM_ENTRY_NO_ENV(void, JVM_GC(void))
 493   JVMWrapper(&quot;JVM_GC&quot;);
 494   if (!DisableExplicitGC) {
<span class="line-added"> 495     if (AsyncDeflateIdleMonitors) {</span>
<span class="line-added"> 496       // AsyncDeflateIdleMonitors needs to know when System.gc() is</span>
<span class="line-added"> 497       // called so any special deflation can be done at a safepoint.</span>
<span class="line-added"> 498       ObjectSynchronizer::set_is_special_deflation_requested(true);</span>
<span class="line-added"> 499     }</span>
 500     Universe::heap()-&gt;collect(GCCause::_java_lang_system_gc);
 501   }
 502 JVM_END
 503 
 504 
 505 JVM_LEAF(jlong, JVM_MaxObjectInspectionAge(void))
 506   JVMWrapper(&quot;JVM_MaxObjectInspectionAge&quot;);
 507   return Universe::heap()-&gt;millis_since_last_gc();
 508 JVM_END
 509 
 510 
 511 static inline jlong convert_size_t_to_jlong(size_t val) {
 512   // In the 64-bit vm, a size_t can overflow a jlong (which is signed).
 513   NOT_LP64 (return (jlong)val;)
 514   LP64_ONLY(return (jlong)MIN2(val, (size_t)max_jlong);)
 515 }
 516 
 517 JVM_ENTRY_NO_ENV(jlong, JVM_TotalMemory(void))
 518   JVMWrapper(&quot;JVM_TotalMemory&quot;);
 519   size_t n = Universe::heap()-&gt;capacity();
</pre>
<hr />
<pre>
2107         log_trace(class, nestmates)(&quot; - compacting array from length %d to %d&quot;,
2108                                     length + 1, count + 1);
2109 
2110         objArrayOop r2 = oopFactory::new_objArray(SystemDictionary::Class_klass(),
2111                                                   count + 1, CHECK_NULL);
2112         objArrayHandle result2(THREAD, r2);
2113         for (int i = 0; i &lt; count + 1; i++) {
2114           result2-&gt;obj_at_put(i, result-&gt;obj_at(i));
2115         }
2116         return (jobjectArray)JNIHandles::make_local(THREAD, result2());
2117       }
2118     }
2119     else {
2120       assert(host == ck || ck-&gt;is_hidden(), &quot;must be singleton nest or dynamic nestmate&quot;);
2121     }
2122     return (jobjectArray)JNIHandles::make_local(THREAD, result());
2123   }
2124 }
2125 JVM_END
2126 
<span class="line-added">2127 JVM_ENTRY(jobjectArray, JVM_GetPermittedSubclasses(JNIEnv* env, jclass current))</span>
<span class="line-added">2128 {</span>
<span class="line-added">2129   JVMWrapper(&quot;JVM_GetPermittedSubclasses&quot;);</span>
<span class="line-added">2130   assert(!java_lang_Class::is_primitive(JNIHandles::resolve_non_null(current)), &quot;should not be&quot;);</span>
<span class="line-added">2131   Klass* c = java_lang_Class::as_Klass(JNIHandles::resolve_non_null(current));</span>
<span class="line-added">2132   assert(c-&gt;is_instance_klass(), &quot;must be&quot;);</span>
<span class="line-added">2133   InstanceKlass* ik = InstanceKlass::cast(c);</span>
<span class="line-added">2134   {</span>
<span class="line-added">2135     JvmtiVMObjectAllocEventCollector oam;</span>
<span class="line-added">2136     Array&lt;u2&gt;* subclasses = ik-&gt;permitted_subclasses();</span>
<span class="line-added">2137     int length = subclasses == NULL ? 0 : subclasses-&gt;length();</span>
<span class="line-added">2138     objArrayOop r = oopFactory::new_objArray(SystemDictionary::String_klass(),</span>
<span class="line-added">2139                                              length, CHECK_NULL);</span>
<span class="line-added">2140     objArrayHandle result(THREAD, r);</span>
<span class="line-added">2141     for (int i = 0; i &lt; length; i++) {</span>
<span class="line-added">2142       int cp_index = subclasses-&gt;at(i);</span>
<span class="line-added">2143       // This returns &lt;package-name&gt;/&lt;class-name&gt;.</span>
<span class="line-added">2144       Symbol* klass_name = ik-&gt;constants()-&gt;klass_name_at(cp_index);</span>
<span class="line-added">2145       assert(klass_name != NULL, &quot;Unexpected null klass_name&quot;);</span>
<span class="line-added">2146       Handle perm_subtype_h = java_lang_String::create_from_symbol(klass_name, CHECK_NULL);</span>
<span class="line-added">2147       result-&gt;obj_at_put(i, perm_subtype_h());</span>
<span class="line-added">2148     }</span>
<span class="line-added">2149     return (jobjectArray)JNIHandles::make_local(THREAD, result());</span>
<span class="line-added">2150   }</span>
<span class="line-added">2151 }</span>
<span class="line-added">2152 JVM_END</span>
<span class="line-added">2153 </span>
2154 // Constant pool access //////////////////////////////////////////////////////////
2155 
2156 JVM_ENTRY(jobject, JVM_GetClassConstantPool(JNIEnv *env, jclass cls))
2157 {
2158   JVMWrapper(&quot;JVM_GetClassConstantPool&quot;);
2159   JvmtiVMObjectAllocEventCollector oam;
2160 
2161   // Return null for primitives and arrays
2162   if (!java_lang_Class::is_primitive(JNIHandles::resolve_non_null(cls))) {
2163     Klass* k = java_lang_Class::as_Klass(JNIHandles::resolve_non_null(cls));
2164     if (k-&gt;is_instance_klass()) {
2165       InstanceKlass* k_h = InstanceKlass::cast(k);
2166       Handle jcp = reflect_ConstantPool::create(CHECK_NULL);
2167       reflect_ConstantPool::set_cp(jcp(), k_h-&gt;constants());
2168       return JNIHandles::make_local(jcp());
2169     }
2170   }
2171   return NULL;
2172 }
2173 JVM_END
</pre>
</td>
</tr>
</table>
<center><a href="../opto/type.cpp.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="jvmtiClassFileReconstituter.cpp.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>