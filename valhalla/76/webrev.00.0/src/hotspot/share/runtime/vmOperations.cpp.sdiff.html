<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/hotspot/share/runtime/vmOperations.cpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
  </head>
<body>
<center><a href="thread.cpp.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="vmOperations.hpp.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/hotspot/share/runtime/vmOperations.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 1997, 2019, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  *
</pre>
<hr />
<pre>
 24 
 25 #include &quot;precompiled.hpp&quot;
 26 #include &quot;classfile/symbolTable.hpp&quot;
 27 #include &quot;classfile/vmSymbols.hpp&quot;
 28 #include &quot;code/codeCache.hpp&quot;
 29 #include &quot;compiler/compileBroker.hpp&quot;
 30 #include &quot;gc/shared/collectedHeap.hpp&quot;
 31 #include &quot;gc/shared/isGCActiveMark.hpp&quot;
 32 #include &quot;logging/log.hpp&quot;
 33 #include &quot;logging/logStream.hpp&quot;
 34 #include &quot;logging/logConfiguration.hpp&quot;
 35 #include &quot;memory/heapInspection.hpp&quot;
 36 #include &quot;memory/resourceArea.hpp&quot;
 37 #include &quot;memory/universe.hpp&quot;
 38 #include &quot;oops/symbol.hpp&quot;
 39 #include &quot;runtime/arguments.hpp&quot;
 40 #include &quot;runtime/deoptimization.hpp&quot;
 41 #include &quot;runtime/frame.inline.hpp&quot;
 42 #include &quot;runtime/interfaceSupport.inline.hpp&quot;
 43 #include &quot;runtime/sweeper.hpp&quot;

 44 #include &quot;runtime/thread.inline.hpp&quot;
 45 #include &quot;runtime/threadSMR.inline.hpp&quot;
 46 #include &quot;runtime/vmOperations.hpp&quot;
 47 #include &quot;services/threadService.hpp&quot;
 48 
 49 #define VM_OP_NAME_INITIALIZE(name) #name,
 50 
 51 const char* VM_Operation::_names[VM_Operation::VMOp_Terminating] = \
 52   { VM_OPS_DO(VM_OP_NAME_INITIALIZE) };
 53 
 54 void VM_Operation::set_calling_thread(Thread* thread) {
 55   _calling_thread = thread;
 56 }
 57 
 58 void VM_Operation::evaluate() {
 59   ResourceMark rm;
 60   LogTarget(Debug, vmoperation) lt;
 61   if (lt.is_enabled()) {
 62     LogStream ls(lt);
 63     ls.print(&quot;begin &quot;);
</pre>
<hr />
<pre>
 76 // Called by fatal error handler.
 77 void VM_Operation::print_on_error(outputStream* st) const {
 78   st-&gt;print(&quot;VM_Operation (&quot; PTR_FORMAT &quot;): &quot;, p2i(this));
 79   st-&gt;print(&quot;%s&quot;, name());
 80 
 81   st-&gt;print(&quot;, mode: %s&quot;, evaluate_at_safepoint() ? &quot;safepoint&quot; : &quot;no safepoint&quot;);
 82 
 83   if (calling_thread()) {
 84     st-&gt;print(&quot;, requested by thread &quot; PTR_FORMAT, p2i(calling_thread()));
 85   }
 86 }
 87 
 88 void VM_ClearICs::doit() {
 89   if (_preserve_static_stubs) {
 90     CodeCache::cleanup_inline_caches();
 91   } else {
 92     CodeCache::clear_inline_caches();
 93   }
 94 }
 95 
<span class="line-removed"> 96 void VM_MarkActiveNMethods::doit() {</span>
<span class="line-removed"> 97   NMethodSweeper::mark_active_nmethods();</span>
<span class="line-removed"> 98 }</span>
<span class="line-removed"> 99 </span>
100 VM_DeoptimizeFrame::VM_DeoptimizeFrame(JavaThread* thread, intptr_t* id, int reason) {
101   _thread = thread;
102   _id     = id;
103   _reason = reason;
104 }
105 
106 
107 void VM_DeoptimizeFrame::doit() {
108   assert(_reason &gt; Deoptimization::Reason_none &amp;&amp; _reason &lt; Deoptimization::Reason_LIMIT, &quot;invalid deopt reason&quot;);
109   Deoptimization::deoptimize_frame_internal(_thread, _id, (Deoptimization::DeoptReason)_reason);
110 }
111 
112 
113 #ifndef PRODUCT
114 
115 void VM_DeoptimizeAll::doit() {
116   DeoptimizationMarker dm;
117   JavaThreadIteratorWithHandle jtiwh;
118   // deoptimize all java threads in the system
119   if (DeoptimizeALot) {
</pre>
<hr />
<pre>
416 #endif
417         }
418       }
419     }
420 
421     if (num_active == 0) {
422        return 0;
423     } else if (attempts &gt; max_wait) {
424        return num_active;
425     } else if (num_active_compiler_thread == 0 &amp;&amp; attempts &gt; max_wait_user_thread) {
426        return num_active;
427     }
428 
429     attempts++;
430 
431     MonitorLocker ml(&amp;timer, Mutex::_no_safepoint_check_flag);
432     ml.wait(10);
433   }
434 }
435 











436 void VM_Exit::doit() {
437 
438   if (VerifyBeforeExit) {
439     HandleMark hm(VMThread::vm_thread());
440     // Among other things, this ensures that Eden top is correct.
441     Universe::heap()-&gt;prepare_for_verify();
442     // Silent verification so as not to pollute normal output,
443     // unless we really asked for it.
444     Universe::verify();
445   }
446 
447   CompileBroker::set_should_block();
448 
449   // Wait for a short period for threads in native to block. Any thread
450   // still executing native code after the wait will be stopped at
451   // native==&gt;Java/VM barriers.
452   // Among 16276 JCK tests, 94% of them come here without any threads still
453   // running in native; the other 6% are quiescent within 250ms (Ultra 80).
454   wait_for_threads_in_native_to_block();
455 
</pre>
</td>
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 1997, 2020, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  *
</pre>
<hr />
<pre>
 24 
 25 #include &quot;precompiled.hpp&quot;
 26 #include &quot;classfile/symbolTable.hpp&quot;
 27 #include &quot;classfile/vmSymbols.hpp&quot;
 28 #include &quot;code/codeCache.hpp&quot;
 29 #include &quot;compiler/compileBroker.hpp&quot;
 30 #include &quot;gc/shared/collectedHeap.hpp&quot;
 31 #include &quot;gc/shared/isGCActiveMark.hpp&quot;
 32 #include &quot;logging/log.hpp&quot;
 33 #include &quot;logging/logStream.hpp&quot;
 34 #include &quot;logging/logConfiguration.hpp&quot;
 35 #include &quot;memory/heapInspection.hpp&quot;
 36 #include &quot;memory/resourceArea.hpp&quot;
 37 #include &quot;memory/universe.hpp&quot;
 38 #include &quot;oops/symbol.hpp&quot;
 39 #include &quot;runtime/arguments.hpp&quot;
 40 #include &quot;runtime/deoptimization.hpp&quot;
 41 #include &quot;runtime/frame.inline.hpp&quot;
 42 #include &quot;runtime/interfaceSupport.inline.hpp&quot;
 43 #include &quot;runtime/sweeper.hpp&quot;
<span class="line-added"> 44 #include &quot;runtime/synchronizer.hpp&quot;</span>
 45 #include &quot;runtime/thread.inline.hpp&quot;
 46 #include &quot;runtime/threadSMR.inline.hpp&quot;
 47 #include &quot;runtime/vmOperations.hpp&quot;
 48 #include &quot;services/threadService.hpp&quot;
 49 
 50 #define VM_OP_NAME_INITIALIZE(name) #name,
 51 
 52 const char* VM_Operation::_names[VM_Operation::VMOp_Terminating] = \
 53   { VM_OPS_DO(VM_OP_NAME_INITIALIZE) };
 54 
 55 void VM_Operation::set_calling_thread(Thread* thread) {
 56   _calling_thread = thread;
 57 }
 58 
 59 void VM_Operation::evaluate() {
 60   ResourceMark rm;
 61   LogTarget(Debug, vmoperation) lt;
 62   if (lt.is_enabled()) {
 63     LogStream ls(lt);
 64     ls.print(&quot;begin &quot;);
</pre>
<hr />
<pre>
 77 // Called by fatal error handler.
 78 void VM_Operation::print_on_error(outputStream* st) const {
 79   st-&gt;print(&quot;VM_Operation (&quot; PTR_FORMAT &quot;): &quot;, p2i(this));
 80   st-&gt;print(&quot;%s&quot;, name());
 81 
 82   st-&gt;print(&quot;, mode: %s&quot;, evaluate_at_safepoint() ? &quot;safepoint&quot; : &quot;no safepoint&quot;);
 83 
 84   if (calling_thread()) {
 85     st-&gt;print(&quot;, requested by thread &quot; PTR_FORMAT, p2i(calling_thread()));
 86   }
 87 }
 88 
 89 void VM_ClearICs::doit() {
 90   if (_preserve_static_stubs) {
 91     CodeCache::cleanup_inline_caches();
 92   } else {
 93     CodeCache::clear_inline_caches();
 94   }
 95 }
 96 




 97 VM_DeoptimizeFrame::VM_DeoptimizeFrame(JavaThread* thread, intptr_t* id, int reason) {
 98   _thread = thread;
 99   _id     = id;
100   _reason = reason;
101 }
102 
103 
104 void VM_DeoptimizeFrame::doit() {
105   assert(_reason &gt; Deoptimization::Reason_none &amp;&amp; _reason &lt; Deoptimization::Reason_LIMIT, &quot;invalid deopt reason&quot;);
106   Deoptimization::deoptimize_frame_internal(_thread, _id, (Deoptimization::DeoptReason)_reason);
107 }
108 
109 
110 #ifndef PRODUCT
111 
112 void VM_DeoptimizeAll::doit() {
113   DeoptimizationMarker dm;
114   JavaThreadIteratorWithHandle jtiwh;
115   // deoptimize all java threads in the system
116   if (DeoptimizeALot) {
</pre>
<hr />
<pre>
413 #endif
414         }
415       }
416     }
417 
418     if (num_active == 0) {
419        return 0;
420     } else if (attempts &gt; max_wait) {
421        return num_active;
422     } else if (num_active_compiler_thread == 0 &amp;&amp; attempts &gt; max_wait_user_thread) {
423        return num_active;
424     }
425 
426     attempts++;
427 
428     MonitorLocker ml(&amp;timer, Mutex::_no_safepoint_check_flag);
429     ml.wait(10);
430   }
431 }
432 
<span class="line-added">433 bool VM_Exit::doit_prologue() {</span>
<span class="line-added">434   if (AsyncDeflateIdleMonitors &amp;&amp; log_is_enabled(Info, monitorinflation)) {</span>
<span class="line-added">435     // AsyncDeflateIdleMonitors does a special deflation at the VM_Exit</span>
<span class="line-added">436     // safepoint in order to reduce the in-use monitor population that</span>
<span class="line-added">437     // is reported by ObjectSynchronizer::log_in_use_monitor_details()</span>
<span class="line-added">438     // at VM exit.</span>
<span class="line-added">439     ObjectSynchronizer::set_is_special_deflation_requested(true);</span>
<span class="line-added">440   }</span>
<span class="line-added">441   return true;</span>
<span class="line-added">442 }</span>
<span class="line-added">443 </span>
444 void VM_Exit::doit() {
445 
446   if (VerifyBeforeExit) {
447     HandleMark hm(VMThread::vm_thread());
448     // Among other things, this ensures that Eden top is correct.
449     Universe::heap()-&gt;prepare_for_verify();
450     // Silent verification so as not to pollute normal output,
451     // unless we really asked for it.
452     Universe::verify();
453   }
454 
455   CompileBroker::set_should_block();
456 
457   // Wait for a short period for threads in native to block. Any thread
458   // still executing native code after the wait will be stopped at
459   // native==&gt;Java/VM barriers.
460   // Among 16276 JCK tests, 94% of them come here without any threads still
461   // running in native; the other 6% are quiescent within 250ms (Ultra 80).
462   wait_for_threads_in_native_to_block();
463 
</pre>
</td>
</tr>
</table>
<center><a href="thread.cpp.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="vmOperations.hpp.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>