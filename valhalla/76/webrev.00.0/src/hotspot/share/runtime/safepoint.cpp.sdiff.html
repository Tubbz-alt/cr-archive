<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/hotspot/share/runtime/safepoint.cpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
  </head>
<body>
<center><a href="init.cpp.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="sharedRuntime.cpp.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/hotspot/share/runtime/safepoint.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 474   _wait_barrier-&gt;disarm();
 475 }
 476 
 477 // Wake up all threads, so they are ready to resume execution after the safepoint
 478 // operation has been carried out
 479 void SafepointSynchronize::end() {
 480   assert(Threads_lock-&gt;owned_by_self(), &quot;must hold Threads_lock&quot;);
 481   EventSafepointEnd event;
 482   assert(Thread::current()-&gt;is_VM_thread(), &quot;Only VM thread can execute a safepoint&quot;);
 483 
 484   disarm_safepoint();
 485 
 486   Universe::heap()-&gt;safepoint_synchronize_end();
 487 
 488   SafepointTracing::end();
 489 
 490   post_safepoint_end_event(event, safepoint_id());
 491 }
 492 
 493 bool SafepointSynchronize::is_cleanup_needed() {
<span class="line-modified"> 494   // Need a safepoint if there are many monitors to deflate.</span>
<span class="line-modified"> 495   if (ObjectSynchronizer::is_cleanup_needed()) return true;</span>

 496   // Need a safepoint if some inline cache buffers is non-empty
 497   if (!InlineCacheBuffer::is_empty()) return true;
 498   if (StringTable::needs_rehashing()) return true;
 499   if (SymbolTable::needs_rehashing()) return true;
 500   return false;
 501 }
 502 
 503 class ParallelSPCleanupThreadClosure : public ThreadClosure {
 504 private:
 505   CodeBlobClosure* _nmethod_cl;
 506   DeflateMonitorCounters* _counters;
 507 
 508 public:
 509   ParallelSPCleanupThreadClosure(DeflateMonitorCounters* counters) :
 510     _nmethod_cl(UseCodeAging ? NMethodSweeper::prepare_reset_hotness_counters() : NULL),
 511     _counters(counters) {}
 512 
 513   void do_thread(Thread* thread) {




 514     ObjectSynchronizer::deflate_thread_local_monitors(thread, _counters);
 515     if (_nmethod_cl != NULL &amp;&amp; thread-&gt;is_Java_thread() &amp;&amp;
 516         ! thread-&gt;is_Code_cache_sweeper_thread()) {
 517       JavaThread* jt = (JavaThread*) thread;
 518       jt-&gt;nmethods_do(_nmethod_cl);
 519     }
 520   }
 521 };
 522 
 523 class ParallelSPCleanupTask : public AbstractGangTask {
 524 private:
 525   SubTasksDone _subtasks;
 526   ParallelSPCleanupThreadClosure _cleanup_threads_cl;
 527   uint _num_workers;
 528   DeflateMonitorCounters* _counters;
 529 public:
 530   ParallelSPCleanupTask(uint num_workers, DeflateMonitorCounters* counters) :
 531     AbstractGangTask(&quot;Parallel Safepoint Cleanup&quot;),
 532     _subtasks(SafepointSynchronize::SAFEPOINT_CLEANUP_NUM_TASKS),
 533     _cleanup_threads_cl(ParallelSPCleanupThreadClosure(counters)),
 534     _num_workers(num_workers),
 535     _counters(counters) {}
 536 
 537   void work(uint worker_id) {
 538     uint64_t safepoint_id = SafepointSynchronize::safepoint_id();
 539     // All threads deflate monitors and mark nmethods (if necessary).
 540     Threads::possibly_parallel_threads_do(true, &amp;_cleanup_threads_cl);
 541 
 542     if (_subtasks.try_claim_task(SafepointSynchronize::SAFEPOINT_CLEANUP_DEFLATE_MONITORS)) {
 543       const char* name = &quot;deflating global idle monitors&quot;;
 544       EventSafepointCleanupTask event;
 545       TraceTime timer(name, TRACETIME_LOG(Info, safepoint, cleanup));
<span class="line-modified"> 546       ObjectSynchronizer::deflate_idle_monitors(_counters);</span>




 547 
 548       post_safepoint_cleanup_task_event(event, safepoint_id, name);
 549     }
 550 
 551     if (_subtasks.try_claim_task(SafepointSynchronize::SAFEPOINT_CLEANUP_UPDATE_INLINE_CACHES)) {
 552       const char* name = &quot;updating inline caches&quot;;
 553       EventSafepointCleanupTask event;
 554       TraceTime timer(name, TRACETIME_LOG(Info, safepoint, cleanup));
 555       InlineCacheBuffer::update_inline_caches();
 556 
 557       post_safepoint_cleanup_task_event(event, safepoint_id, name);
 558     }
 559 
 560     if (_subtasks.try_claim_task(SafepointSynchronize::SAFEPOINT_CLEANUP_COMPILATION_POLICY)) {
 561       const char* name = &quot;compilation policy safepoint handler&quot;;
 562       EventSafepointCleanupTask event;
 563       TraceTime timer(name, TRACETIME_LOG(Info, safepoint, cleanup));
 564       CompilationPolicy::policy()-&gt;do_safepoint_work();
 565 
 566       post_safepoint_cleanup_task_event(event, safepoint_id, name);
</pre>
</td>
<td>
<hr />
<pre>
 474   _wait_barrier-&gt;disarm();
 475 }
 476 
 477 // Wake up all threads, so they are ready to resume execution after the safepoint
 478 // operation has been carried out
 479 void SafepointSynchronize::end() {
 480   assert(Threads_lock-&gt;owned_by_self(), &quot;must hold Threads_lock&quot;);
 481   EventSafepointEnd event;
 482   assert(Thread::current()-&gt;is_VM_thread(), &quot;Only VM thread can execute a safepoint&quot;);
 483 
 484   disarm_safepoint();
 485 
 486   Universe::heap()-&gt;safepoint_synchronize_end();
 487 
 488   SafepointTracing::end();
 489 
 490   post_safepoint_end_event(event, safepoint_id());
 491 }
 492 
 493 bool SafepointSynchronize::is_cleanup_needed() {
<span class="line-modified"> 494   // Need a cleanup safepoint if there are too many monitors in use</span>
<span class="line-modified"> 495   // and the monitor deflation needs to be done at a safepoint.</span>
<span class="line-added"> 496   if (ObjectSynchronizer::is_safepoint_deflation_needed()) return true;</span>
 497   // Need a safepoint if some inline cache buffers is non-empty
 498   if (!InlineCacheBuffer::is_empty()) return true;
 499   if (StringTable::needs_rehashing()) return true;
 500   if (SymbolTable::needs_rehashing()) return true;
 501   return false;
 502 }
 503 
 504 class ParallelSPCleanupThreadClosure : public ThreadClosure {
 505 private:
 506   CodeBlobClosure* _nmethod_cl;
 507   DeflateMonitorCounters* _counters;
 508 
 509 public:
 510   ParallelSPCleanupThreadClosure(DeflateMonitorCounters* counters) :
 511     _nmethod_cl(UseCodeAging ? NMethodSweeper::prepare_reset_hotness_counters() : NULL),
 512     _counters(counters) {}
 513 
 514   void do_thread(Thread* thread) {
<span class="line-added"> 515     // deflate_thread_local_monitors() handles or requests deflation of</span>
<span class="line-added"> 516     // this thread&#39;s idle monitors. If !AsyncDeflateIdleMonitors or if</span>
<span class="line-added"> 517     // there is a special cleanup request, deflation is handled now.</span>
<span class="line-added"> 518     // Otherwise, async deflation is requested via a flag.</span>
 519     ObjectSynchronizer::deflate_thread_local_monitors(thread, _counters);
 520     if (_nmethod_cl != NULL &amp;&amp; thread-&gt;is_Java_thread() &amp;&amp;
 521         ! thread-&gt;is_Code_cache_sweeper_thread()) {
 522       JavaThread* jt = (JavaThread*) thread;
 523       jt-&gt;nmethods_do(_nmethod_cl);
 524     }
 525   }
 526 };
 527 
 528 class ParallelSPCleanupTask : public AbstractGangTask {
 529 private:
 530   SubTasksDone _subtasks;
 531   ParallelSPCleanupThreadClosure _cleanup_threads_cl;
 532   uint _num_workers;
 533   DeflateMonitorCounters* _counters;
 534 public:
 535   ParallelSPCleanupTask(uint num_workers, DeflateMonitorCounters* counters) :
 536     AbstractGangTask(&quot;Parallel Safepoint Cleanup&quot;),
 537     _subtasks(SafepointSynchronize::SAFEPOINT_CLEANUP_NUM_TASKS),
 538     _cleanup_threads_cl(ParallelSPCleanupThreadClosure(counters)),
 539     _num_workers(num_workers),
 540     _counters(counters) {}
 541 
 542   void work(uint worker_id) {
 543     uint64_t safepoint_id = SafepointSynchronize::safepoint_id();
 544     // All threads deflate monitors and mark nmethods (if necessary).
 545     Threads::possibly_parallel_threads_do(true, &amp;_cleanup_threads_cl);
 546 
 547     if (_subtasks.try_claim_task(SafepointSynchronize::SAFEPOINT_CLEANUP_DEFLATE_MONITORS)) {
 548       const char* name = &quot;deflating global idle monitors&quot;;
 549       EventSafepointCleanupTask event;
 550       TraceTime timer(name, TRACETIME_LOG(Info, safepoint, cleanup));
<span class="line-modified"> 551       // AsyncDeflateIdleMonitors only uses DeflateMonitorCounters</span>
<span class="line-added"> 552       // when a special cleanup has been requested.</span>
<span class="line-added"> 553       // Note: This logging output will include global idle monitor</span>
<span class="line-added"> 554       // elapsed times, but not global idle monitor deflation count.</span>
<span class="line-added"> 555       ObjectSynchronizer::do_safepoint_work(_counters);</span>
 556 
 557       post_safepoint_cleanup_task_event(event, safepoint_id, name);
 558     }
 559 
 560     if (_subtasks.try_claim_task(SafepointSynchronize::SAFEPOINT_CLEANUP_UPDATE_INLINE_CACHES)) {
 561       const char* name = &quot;updating inline caches&quot;;
 562       EventSafepointCleanupTask event;
 563       TraceTime timer(name, TRACETIME_LOG(Info, safepoint, cleanup));
 564       InlineCacheBuffer::update_inline_caches();
 565 
 566       post_safepoint_cleanup_task_event(event, safepoint_id, name);
 567     }
 568 
 569     if (_subtasks.try_claim_task(SafepointSynchronize::SAFEPOINT_CLEANUP_COMPILATION_POLICY)) {
 570       const char* name = &quot;compilation policy safepoint handler&quot;;
 571       EventSafepointCleanupTask event;
 572       TraceTime timer(name, TRACETIME_LOG(Info, safepoint, cleanup));
 573       CompilationPolicy::policy()-&gt;do_safepoint_work();
 574 
 575       post_safepoint_cleanup_task_event(event, safepoint_id, name);
</pre>
</td>
</tr>
</table>
<center><a href="init.cpp.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="sharedRuntime.cpp.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>