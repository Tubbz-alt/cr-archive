<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/java.base/share/classes/java/lang/invoke/VarHandles.java</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
  </head>
<body>
<center><a href="MethodHandles.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="../../../jdk/internal/org/objectweb/asm/ClassReader.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/java.base/share/classes/java/lang/invoke/VarHandles.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
357 
358     private static VarHandle maybeAdapt(VarHandle target) {
359         if (!VAR_HANDLE_IDENTITY_ADAPT) return target;
360         target = filterValue(target,
361                         MethodHandles.identity(target.varType()), MethodHandles.identity(target.varType()));
362         MethodType mtype = target.accessModeType(VarHandle.AccessMode.GET).dropParameterTypes(0, 1);
363         for (int i = 0 ; i &lt; mtype.parameterCount() ; i++) {
364             target = filterCoordinates(target, i, MethodHandles.identity(mtype.parameterType(i)));
365         }
366         return target;
367     }
368 
369     public static VarHandle filterValue(VarHandle target, MethodHandle filterToTarget, MethodHandle filterFromTarget) {
370         Objects.nonNull(target);
371         Objects.nonNull(filterToTarget);
372         Objects.nonNull(filterFromTarget);
373         //check that from/to filters do not throw checked exceptions
374         noCheckedExceptions(filterToTarget);
375         noCheckedExceptions(filterFromTarget);
376 




377         //check that from/to filters have right signatures
<span class="line-modified">378         if (filterFromTarget.type().parameterCount() != 1) {</span>


379             throw newIllegalArgumentException(&quot;filterFromTarget filter type has wrong arity&quot;, filterFromTarget.type());
<span class="line-modified">380         } else if (filterToTarget.type().parameterCount() != 1) {</span>
381             throw newIllegalArgumentException(&quot;filterToTarget filter type has wrong arity&quot;, filterFromTarget.type());
<span class="line-modified">382         } else if (filterFromTarget.type().parameterType(0) != filterToTarget.type().returnType() ||</span>
<span class="line-modified">383                 filterToTarget.type().parameterType(0) != filterFromTarget.type().returnType()) {</span>
384             throw newIllegalArgumentException(&quot;filterFromTarget and filterToTarget filter types do not match&quot;, filterFromTarget.type(), filterToTarget.type());
<span class="line-modified">385         } else if (target.varType() != filterFromTarget.type().parameterType(0)) {</span>
386             throw newIllegalArgumentException(&quot;filterFromTarget filter type does not match target var handle type&quot;, filterFromTarget.type(), target.varType());
387         } else if (target.varType() != filterToTarget.type().returnType()) {
388             throw newIllegalArgumentException(&quot;filterFromTarget filter type does not match target var handle type&quot;, filterToTarget.type(), target.varType());









389         }
390 
<span class="line-modified">391         return new IndirectVarHandle(target, filterFromTarget.type().returnType(), target.coordinateTypes().toArray(new Class&lt;?&gt;[0]),</span>
392                 (mode, modeHandle) -&gt; {
393                     int lastParameterPos = modeHandle.type().parameterCount() - 1;
394                     return switch (mode.at) {
<span class="line-modified">395                         case GET -&gt; MethodHandles.filterReturnValue(modeHandle, filterFromTarget);</span>
<span class="line-modified">396                         case SET -&gt; MethodHandles.filterArgument(modeHandle, lastParameterPos, filterToTarget);</span>
397                         case GET_AND_UPDATE -&gt; {
<span class="line-modified">398                             MethodHandle adapter = MethodHandles.filterReturnValue(modeHandle, filterFromTarget);</span>
<span class="line-modified">399                             yield MethodHandles.filterArgument(adapter, lastParameterPos, filterToTarget);</span>






400                         }
401                         case COMPARE_AND_EXCHANGE -&gt; {
<span class="line-modified">402                             MethodHandle adapter = MethodHandles.filterReturnValue(modeHandle, filterFromTarget);</span>
<span class="line-modified">403                             adapter = MethodHandles.filterArgument(adapter, lastParameterPos, filterToTarget);</span>
<span class="line-modified">404                             yield MethodHandles.filterArgument(adapter, lastParameterPos - 1, filterToTarget);</span>











405                         }
406                         case COMPARE_AND_SET -&gt; {
<span class="line-modified">407                             MethodHandle adapter = MethodHandles.filterArgument(modeHandle, lastParameterPos, filterToTarget);</span>
<span class="line-modified">408                             yield MethodHandles.filterArgument(adapter, lastParameterPos - 1, filterToTarget);</span>






409                         }
410                     };
411                 });
412     }
413 
















414     public static VarHandle filterCoordinates(VarHandle target, int pos, MethodHandle... filters) {
415         Objects.nonNull(target);
416         Objects.nonNull(filters);
417 
418         List&lt;Class&lt;?&gt;&gt; targetCoordinates = target.coordinateTypes();
419         if (pos &lt; 0 || pos &gt;= targetCoordinates.size()) {
420             throw newIllegalArgumentException(&quot;Invalid position &quot; + pos + &quot; for coordinate types&quot;, targetCoordinates);
421         } else if (pos + filters.length &gt; targetCoordinates.size()) {
422             throw new IllegalArgumentException(&quot;Too many filters&quot;);
423         }
424 
425         if (filters.length == 0) return target;
426 
427         List&lt;Class&lt;?&gt;&gt; newCoordinates = new ArrayList&lt;&gt;(targetCoordinates);
428         for (int i = 0 ; i &lt; filters.length ; i++) {
429             noCheckedExceptions(filters[i]);
430             MethodType filterType = filters[i].type();
431             if (filterType.parameterCount() != 1) {
432                 throw newIllegalArgumentException(&quot;Invalid filter type &quot; + filterType);
433             } else if (newCoordinates.get(pos + i) != filterType.returnType()) {
</pre>
<hr />
<pre>
543         Objects.nonNull(target);
544         Objects.nonNull(valueTypes);
545 
546         List&lt;Class&lt;?&gt;&gt; targetCoordinates = target.coordinateTypes();
547         if (pos &lt; 0 || pos &gt; targetCoordinates.size()) {
548             throw newIllegalArgumentException(&quot;Invalid position &quot; + pos + &quot; for coordinate types&quot;, targetCoordinates);
549         }
550 
551         if (valueTypes.length == 0) return target;
552 
553         List&lt;Class&lt;?&gt;&gt; newCoordinates = new ArrayList&lt;&gt;(targetCoordinates);
554         newCoordinates.addAll(pos, List.of(valueTypes));
555 
556         return new IndirectVarHandle(target, target.varType(), newCoordinates.toArray(new Class&lt;?&gt;[0]),
557                 (mode, modeHandle) -&gt; MethodHandles.dropArguments(modeHandle, 1 + pos, valueTypes));
558     }
559 
560     private static void noCheckedExceptions(MethodHandle handle) {
561         if (handle instanceof DirectMethodHandle) {
562             DirectMethodHandle directHandle = (DirectMethodHandle)handle;
<span class="line-modified">563             MethodHandleInfo info = MethodHandles.Lookup.IMPL_LOOKUP.revealDirect(directHandle);</span>
<span class="line-modified">564             Class&lt;?&gt;[] exceptionTypes = switch (info.getReferenceKind()) {</span>
<span class="line-modified">565                 case MethodHandleInfo.REF_invokeInterface, MethodHandleInfo.REF_invokeSpecial,</span>
<span class="line-modified">566                         MethodHandleInfo.REF_invokeStatic, MethodHandleInfo.REF_invokeVirtual -&gt;</span>
<span class="line-modified">567                         info.reflectAs(Method.class, MethodHandles.Lookup.IMPL_LOOKUP).getExceptionTypes();</span>
<span class="line-modified">568                 case MethodHandleInfo.REF_newInvokeSpecial -&gt;</span>
<span class="line-modified">569                         info.reflectAs(Constructor.class, MethodHandles.Lookup.IMPL_LOOKUP).getExceptionTypes();</span>
<span class="line-modified">570                 case MethodHandleInfo.REF_getField, MethodHandleInfo.REF_getStatic,</span>
<span class="line-modified">571                         MethodHandleInfo.REF_putField, MethodHandleInfo.REF_putStatic -&gt; null;</span>
<span class="line-modified">572                 default -&gt; throw new AssertionError(&quot;Cannot get here&quot;);</span>
<span class="line-modified">573             };</span>






574             if (exceptionTypes != null) {
575                 if (Stream.of(exceptionTypes).anyMatch(VarHandles::isCheckedException)) {
576                     throw newIllegalArgumentException(&quot;Cannot adapt a var handle with a method handle which throws checked exceptions&quot;);
577                 }
578             }
579         } else if (handle instanceof DelegatingMethodHandle) {
580             noCheckedExceptions(((DelegatingMethodHandle)handle).getTarget());
581         } else {
582             //bound
583             BoundMethodHandle boundHandle = (BoundMethodHandle)handle;
584             for (int i = 0 ; i &lt; boundHandle.fieldCount() ; i++) {
585                 Object arg = boundHandle.arg(i);
586                 if (arg instanceof MethodHandle){
587                     noCheckedExceptions((MethodHandle) arg);
588                 }
589             }
590         }
591     }
592 
593     private static boolean isCheckedException(Class&lt;?&gt; clazz) {
</pre>
</td>
<td>
<hr />
<pre>
357 
358     private static VarHandle maybeAdapt(VarHandle target) {
359         if (!VAR_HANDLE_IDENTITY_ADAPT) return target;
360         target = filterValue(target,
361                         MethodHandles.identity(target.varType()), MethodHandles.identity(target.varType()));
362         MethodType mtype = target.accessModeType(VarHandle.AccessMode.GET).dropParameterTypes(0, 1);
363         for (int i = 0 ; i &lt; mtype.parameterCount() ; i++) {
364             target = filterCoordinates(target, i, MethodHandles.identity(mtype.parameterType(i)));
365         }
366         return target;
367     }
368 
369     public static VarHandle filterValue(VarHandle target, MethodHandle filterToTarget, MethodHandle filterFromTarget) {
370         Objects.nonNull(target);
371         Objects.nonNull(filterToTarget);
372         Objects.nonNull(filterFromTarget);
373         //check that from/to filters do not throw checked exceptions
374         noCheckedExceptions(filterToTarget);
375         noCheckedExceptions(filterFromTarget);
376 
<span class="line-added">377         List&lt;Class&lt;?&gt;&gt; newCoordinates = new ArrayList&lt;&gt;();</span>
<span class="line-added">378         List&lt;Class&lt;?&gt;&gt; additionalCoordinates = new ArrayList&lt;&gt;();</span>
<span class="line-added">379         newCoordinates.addAll(target.coordinateTypes());</span>
<span class="line-added">380 </span>
381         //check that from/to filters have right signatures
<span class="line-modified">382         if (filterFromTarget.type().parameterCount() != filterToTarget.type().parameterCount()) {</span>
<span class="line-added">383             throw newIllegalArgumentException(&quot;filterFromTarget and filterToTarget have different arity&quot;, filterFromTarget.type(), filterToTarget.type());</span>
<span class="line-added">384         } else if (filterFromTarget.type().parameterCount() &lt; 1) {</span>
385             throw newIllegalArgumentException(&quot;filterFromTarget filter type has wrong arity&quot;, filterFromTarget.type());
<span class="line-modified">386         } else if (filterToTarget.type().parameterCount() &lt; 1) {</span>
387             throw newIllegalArgumentException(&quot;filterToTarget filter type has wrong arity&quot;, filterFromTarget.type());
<span class="line-modified">388         } else if (filterFromTarget.type().lastParameterType() != filterToTarget.type().returnType() ||</span>
<span class="line-modified">389                 filterToTarget.type().lastParameterType() != filterFromTarget.type().returnType()) {</span>
390             throw newIllegalArgumentException(&quot;filterFromTarget and filterToTarget filter types do not match&quot;, filterFromTarget.type(), filterToTarget.type());
<span class="line-modified">391         } else if (target.varType() != filterFromTarget.type().lastParameterType()) {</span>
392             throw newIllegalArgumentException(&quot;filterFromTarget filter type does not match target var handle type&quot;, filterFromTarget.type(), target.varType());
393         } else if (target.varType() != filterToTarget.type().returnType()) {
394             throw newIllegalArgumentException(&quot;filterFromTarget filter type does not match target var handle type&quot;, filterToTarget.type(), target.varType());
<span class="line-added">395         } else if (filterFromTarget.type().parameterCount() &gt; 1) {</span>
<span class="line-added">396             for (int i = 0 ; i &lt; filterFromTarget.type().parameterCount() - 1 ; i++) {</span>
<span class="line-added">397                 if (filterFromTarget.type().parameterType(i) != filterToTarget.type().parameterType(i)) {</span>
<span class="line-added">398                     throw newIllegalArgumentException(&quot;filterFromTarget and filterToTarget filter types do not match&quot;, filterFromTarget.type(), filterToTarget.type());</span>
<span class="line-added">399                 } else {</span>
<span class="line-added">400                     newCoordinates.add(filterFromTarget.type().parameterType(i));</span>
<span class="line-added">401                     additionalCoordinates.add((filterFromTarget.type().parameterType(i)));</span>
<span class="line-added">402                 }</span>
<span class="line-added">403             }</span>
404         }
405 
<span class="line-modified">406         return new IndirectVarHandle(target, filterFromTarget.type().returnType(), newCoordinates.toArray(new Class&lt;?&gt;[0]),</span>
407                 (mode, modeHandle) -&gt; {
408                     int lastParameterPos = modeHandle.type().parameterCount() - 1;
409                     return switch (mode.at) {
<span class="line-modified">410                         case GET -&gt; MethodHandles.collectReturnValue(modeHandle, filterFromTarget);</span>
<span class="line-modified">411                         case SET -&gt; MethodHandles.collectArguments(modeHandle, lastParameterPos, filterToTarget);</span>
412                         case GET_AND_UPDATE -&gt; {
<span class="line-modified">413                             MethodHandle adapter = MethodHandles.collectReturnValue(modeHandle, filterFromTarget);</span>
<span class="line-modified">414                             MethodHandle res = MethodHandles.collectArguments(adapter, lastParameterPos, filterToTarget);</span>
<span class="line-added">415                             if (additionalCoordinates.size() &gt; 0) {</span>
<span class="line-added">416                                 res = joinDuplicateArgs(res, lastParameterPos,</span>
<span class="line-added">417                                         lastParameterPos + additionalCoordinates.size() + 1,</span>
<span class="line-added">418                                         additionalCoordinates.size());</span>
<span class="line-added">419                             }</span>
<span class="line-added">420                             yield res;</span>
421                         }
422                         case COMPARE_AND_EXCHANGE -&gt; {
<span class="line-modified">423                             MethodHandle adapter = MethodHandles.collectReturnValue(modeHandle, filterFromTarget);</span>
<span class="line-modified">424                             adapter = MethodHandles.collectArguments(adapter, lastParameterPos, filterToTarget);</span>
<span class="line-modified">425                             if (additionalCoordinates.size() &gt; 0) {</span>
<span class="line-added">426                                 adapter = joinDuplicateArgs(adapter, lastParameterPos,</span>
<span class="line-added">427                                         lastParameterPos + additionalCoordinates.size() + 1,</span>
<span class="line-added">428                                         additionalCoordinates.size());</span>
<span class="line-added">429                             }</span>
<span class="line-added">430                             MethodHandle res = MethodHandles.collectArguments(adapter, lastParameterPos - 1, filterToTarget);</span>
<span class="line-added">431                             if (additionalCoordinates.size() &gt; 0) {</span>
<span class="line-added">432                                 res = joinDuplicateArgs(res, lastParameterPos - 1,</span>
<span class="line-added">433                                         lastParameterPos + additionalCoordinates.size(),</span>
<span class="line-added">434                                         additionalCoordinates.size());</span>
<span class="line-added">435                             }</span>
<span class="line-added">436                             yield res;</span>
437                         }
438                         case COMPARE_AND_SET -&gt; {
<span class="line-modified">439                             MethodHandle adapter = MethodHandles.collectArguments(modeHandle, lastParameterPos, filterToTarget);</span>
<span class="line-modified">440                             MethodHandle res = MethodHandles.collectArguments(adapter, lastParameterPos - 1, filterToTarget);</span>
<span class="line-added">441                             if (additionalCoordinates.size() &gt; 0) {</span>
<span class="line-added">442                                 res = joinDuplicateArgs(res, lastParameterPos - 1,</span>
<span class="line-added">443                                         lastParameterPos + additionalCoordinates.size(),</span>
<span class="line-added">444                                         additionalCoordinates.size());</span>
<span class="line-added">445                             }</span>
<span class="line-added">446                             yield res;</span>
447                         }
448                     };
449                 });
450     }
451 
<span class="line-added">452     private static MethodHandle joinDuplicateArgs(MethodHandle handle, int originalStart, int dropStart, int length) {</span>
<span class="line-added">453         int[] perms = new int[handle.type().parameterCount()];</span>
<span class="line-added">454         for (int i = 0 ; i &lt; dropStart; i++) {</span>
<span class="line-added">455             perms[i] = i;</span>
<span class="line-added">456         }</span>
<span class="line-added">457         for (int i = 0 ; i &lt; length ; i++) {</span>
<span class="line-added">458             perms[dropStart + i] = originalStart + i;</span>
<span class="line-added">459         }</span>
<span class="line-added">460         for (int i = dropStart + length ; i &lt; perms.length ; i++) {</span>
<span class="line-added">461             perms[i] = i - length;</span>
<span class="line-added">462         }</span>
<span class="line-added">463         return MethodHandles.permuteArguments(handle,</span>
<span class="line-added">464                 handle.type().dropParameterTypes(dropStart, dropStart + length),</span>
<span class="line-added">465                 perms);</span>
<span class="line-added">466     }</span>
<span class="line-added">467 </span>
468     public static VarHandle filterCoordinates(VarHandle target, int pos, MethodHandle... filters) {
469         Objects.nonNull(target);
470         Objects.nonNull(filters);
471 
472         List&lt;Class&lt;?&gt;&gt; targetCoordinates = target.coordinateTypes();
473         if (pos &lt; 0 || pos &gt;= targetCoordinates.size()) {
474             throw newIllegalArgumentException(&quot;Invalid position &quot; + pos + &quot; for coordinate types&quot;, targetCoordinates);
475         } else if (pos + filters.length &gt; targetCoordinates.size()) {
476             throw new IllegalArgumentException(&quot;Too many filters&quot;);
477         }
478 
479         if (filters.length == 0) return target;
480 
481         List&lt;Class&lt;?&gt;&gt; newCoordinates = new ArrayList&lt;&gt;(targetCoordinates);
482         for (int i = 0 ; i &lt; filters.length ; i++) {
483             noCheckedExceptions(filters[i]);
484             MethodType filterType = filters[i].type();
485             if (filterType.parameterCount() != 1) {
486                 throw newIllegalArgumentException(&quot;Invalid filter type &quot; + filterType);
487             } else if (newCoordinates.get(pos + i) != filterType.returnType()) {
</pre>
<hr />
<pre>
597         Objects.nonNull(target);
598         Objects.nonNull(valueTypes);
599 
600         List&lt;Class&lt;?&gt;&gt; targetCoordinates = target.coordinateTypes();
601         if (pos &lt; 0 || pos &gt; targetCoordinates.size()) {
602             throw newIllegalArgumentException(&quot;Invalid position &quot; + pos + &quot; for coordinate types&quot;, targetCoordinates);
603         }
604 
605         if (valueTypes.length == 0) return target;
606 
607         List&lt;Class&lt;?&gt;&gt; newCoordinates = new ArrayList&lt;&gt;(targetCoordinates);
608         newCoordinates.addAll(pos, List.of(valueTypes));
609 
610         return new IndirectVarHandle(target, target.varType(), newCoordinates.toArray(new Class&lt;?&gt;[0]),
611                 (mode, modeHandle) -&gt; MethodHandles.dropArguments(modeHandle, 1 + pos, valueTypes));
612     }
613 
614     private static void noCheckedExceptions(MethodHandle handle) {
615         if (handle instanceof DirectMethodHandle) {
616             DirectMethodHandle directHandle = (DirectMethodHandle)handle;
<span class="line-modified">617             byte refKind = directHandle.member.getReferenceKind();</span>
<span class="line-modified">618             MethodHandleInfo info = new InfoFromMemberName(</span>
<span class="line-modified">619                     MethodHandles.Lookup.IMPL_LOOKUP,</span>
<span class="line-modified">620                     directHandle.member,</span>
<span class="line-modified">621                     refKind);</span>
<span class="line-modified">622             final Class&lt;?&gt;[] exceptionTypes;</span>
<span class="line-modified">623             if (MethodHandleNatives.refKindIsMethod(refKind)) {</span>
<span class="line-modified">624                 exceptionTypes = info.reflectAs(Method.class, MethodHandles.Lookup.IMPL_LOOKUP)</span>
<span class="line-modified">625                         .getExceptionTypes();</span>
<span class="line-modified">626             } else if (MethodHandleNatives.refKindIsField(refKind)) {</span>
<span class="line-modified">627                 exceptionTypes = null;</span>
<span class="line-added">628             } else if (MethodHandleNatives.refKindIsObjectConstructor(refKind)) {</span>
<span class="line-added">629                 exceptionTypes = info.reflectAs(Constructor.class, MethodHandles.Lookup.IMPL_LOOKUP)</span>
<span class="line-added">630                         .getExceptionTypes();</span>
<span class="line-added">631             } else {</span>
<span class="line-added">632                 throw new AssertionError(&quot;Cannot get here&quot;);</span>
<span class="line-added">633             }</span>
634             if (exceptionTypes != null) {
635                 if (Stream.of(exceptionTypes).anyMatch(VarHandles::isCheckedException)) {
636                     throw newIllegalArgumentException(&quot;Cannot adapt a var handle with a method handle which throws checked exceptions&quot;);
637                 }
638             }
639         } else if (handle instanceof DelegatingMethodHandle) {
640             noCheckedExceptions(((DelegatingMethodHandle)handle).getTarget());
641         } else {
642             //bound
643             BoundMethodHandle boundHandle = (BoundMethodHandle)handle;
644             for (int i = 0 ; i &lt; boundHandle.fieldCount() ; i++) {
645                 Object arg = boundHandle.arg(i);
646                 if (arg instanceof MethodHandle){
647                     noCheckedExceptions((MethodHandle) arg);
648                 }
649             }
650         }
651     }
652 
653     private static boolean isCheckedException(Class&lt;?&gt; clazz) {
</pre>
</td>
</tr>
</table>
<center><a href="MethodHandles.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="../../../jdk/internal/org/objectweb/asm/ClassReader.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>