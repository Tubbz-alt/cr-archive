<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames src/hotspot/share/runtime/synchronizer.cpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
    <script type="text/javascript" src="../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>   1 /*
   2  * Copyright (c) 1998, 2020, Oracle and/or its affiliates. All rights reserved.
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.
   8  *
   9  * This code is distributed in the hope that it will be useful, but WITHOUT
  10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  *
  23  */
  24 
  25 #include &quot;precompiled.hpp&quot;
  26 #include &quot;classfile/vmSymbols.hpp&quot;
  27 #include &quot;logging/log.hpp&quot;
  28 #include &quot;logging/logStream.hpp&quot;
  29 #include &quot;jfr/jfrEvents.hpp&quot;
  30 #include &quot;memory/allocation.inline.hpp&quot;
  31 #include &quot;memory/metaspaceShared.hpp&quot;
  32 #include &quot;memory/padded.hpp&quot;
  33 #include &quot;memory/resourceArea.hpp&quot;
  34 #include &quot;memory/universe.hpp&quot;
  35 #include &quot;oops/markWord.hpp&quot;
  36 #include &quot;oops/oop.inline.hpp&quot;
  37 #include &quot;runtime/atomic.hpp&quot;
  38 #include &quot;runtime/biasedLocking.hpp&quot;
  39 #include &quot;runtime/handles.inline.hpp&quot;
  40 #include &quot;runtime/handshake.hpp&quot;
  41 #include &quot;runtime/interfaceSupport.inline.hpp&quot;
  42 #include &quot;runtime/mutexLocker.hpp&quot;
  43 #include &quot;runtime/objectMonitor.hpp&quot;
  44 #include &quot;runtime/objectMonitor.inline.hpp&quot;
  45 #include &quot;runtime/osThread.hpp&quot;
  46 #include &quot;runtime/safepointMechanism.inline.hpp&quot;
  47 #include &quot;runtime/safepointVerifiers.hpp&quot;
  48 #include &quot;runtime/sharedRuntime.hpp&quot;
  49 #include &quot;runtime/stubRoutines.hpp&quot;
  50 #include &quot;runtime/synchronizer.hpp&quot;
  51 #include &quot;runtime/thread.inline.hpp&quot;
  52 #include &quot;runtime/timer.hpp&quot;
  53 #include &quot;runtime/vframe.hpp&quot;
  54 #include &quot;runtime/vmThread.hpp&quot;
  55 #include &quot;utilities/align.hpp&quot;
  56 #include &quot;utilities/dtrace.hpp&quot;
  57 #include &quot;utilities/events.hpp&quot;
  58 #include &quot;utilities/preserveException.hpp&quot;
  59 
  60 // The &quot;core&quot; versions of monitor enter and exit reside in this file.
  61 // The interpreter and compilers contain specialized transliterated
  62 // variants of the enter-exit fast-path operations.  See i486.ad fast_lock(),
  63 // for instance.  If you make changes here, make sure to modify the
  64 // interpreter, and both C1 and C2 fast-path inline locking code emission.
  65 //
  66 // -----------------------------------------------------------------------------
  67 
  68 #ifdef DTRACE_ENABLED
  69 
  70 // Only bother with this argument setup if dtrace is available
  71 // TODO-FIXME: probes should not fire when caller is _blocked.  assert() accordingly.
  72 
  73 #define DTRACE_MONITOR_PROBE_COMMON(obj, thread)                           \
  74   char* bytes = NULL;                                                      \
  75   int len = 0;                                                             \
  76   jlong jtid = SharedRuntime::get_java_tid(thread);                        \
  77   Symbol* klassname = ((oop)(obj))-&gt;klass()-&gt;name();                       \
  78   if (klassname != NULL) {                                                 \
  79     bytes = (char*)klassname-&gt;bytes();                                     \
  80     len = klassname-&gt;utf8_length();                                        \
  81   }
  82 
  83 #define DTRACE_MONITOR_WAIT_PROBE(monitor, obj, thread, millis)            \
  84   {                                                                        \
  85     if (DTraceMonitorProbes) {                                             \
  86       DTRACE_MONITOR_PROBE_COMMON(obj, thread);                            \
  87       HOTSPOT_MONITOR_WAIT(jtid,                                           \
  88                            (uintptr_t)(monitor), bytes, len, (millis));    \
  89     }                                                                      \
  90   }
  91 
  92 #define HOTSPOT_MONITOR_PROBE_notify HOTSPOT_MONITOR_NOTIFY
  93 #define HOTSPOT_MONITOR_PROBE_notifyAll HOTSPOT_MONITOR_NOTIFYALL
  94 #define HOTSPOT_MONITOR_PROBE_waited HOTSPOT_MONITOR_WAITED
  95 
  96 #define DTRACE_MONITOR_PROBE(probe, monitor, obj, thread)                  \
  97   {                                                                        \
  98     if (DTraceMonitorProbes) {                                             \
  99       DTRACE_MONITOR_PROBE_COMMON(obj, thread);                            \
 100       HOTSPOT_MONITOR_PROBE_##probe(jtid, /* probe = waited */             \
 101                                     (uintptr_t)(monitor), bytes, len);     \
 102     }                                                                      \
 103   }
 104 
 105 #else //  ndef DTRACE_ENABLED
 106 
 107 #define DTRACE_MONITOR_WAIT_PROBE(obj, thread, millis, mon)    {;}
 108 #define DTRACE_MONITOR_PROBE(probe, obj, thread, mon)          {;}
 109 
 110 #endif // ndef DTRACE_ENABLED
 111 
 112 // This exists only as a workaround of dtrace bug 6254741
 113 int dtrace_waited_probe(ObjectMonitor* monitor, Handle obj, Thread* thr) {
 114   DTRACE_MONITOR_PROBE(waited, monitor, obj(), thr);
 115   return 0;
 116 }
 117 
 118 #define NINFLATIONLOCKS 256
 119 static volatile intptr_t gInflationLocks[NINFLATIONLOCKS];
 120 
 121 // global list of blocks of monitors
 122 PaddedObjectMonitor* ObjectSynchronizer::g_block_list = NULL;
 123 bool volatile ObjectSynchronizer::_is_async_deflation_requested = false;
 124 bool volatile ObjectSynchronizer::_is_special_deflation_requested = false;
 125 jlong ObjectSynchronizer::_last_async_deflation_time_ns = 0;
 126 
 127 struct ObjectMonitorListGlobals {
 128   char         _pad_prefix[OM_CACHE_LINE_SIZE];
 129   // These are highly shared list related variables.
 130   // To avoid false-sharing they need to be the sole occupants of a cache line.
 131 
 132   // Global ObjectMonitor free list. Newly allocated and deflated
 133   // ObjectMonitors are prepended here.
 134   ObjectMonitor* _free_list;
 135   DEFINE_PAD_MINUS_SIZE(1, OM_CACHE_LINE_SIZE, sizeof(ObjectMonitor*));
 136 
 137   // Global ObjectMonitor in-use list. When a JavaThread is exiting,
 138   // ObjectMonitors on its per-thread in-use list are prepended here.
 139   ObjectMonitor* _in_use_list;
 140   DEFINE_PAD_MINUS_SIZE(2, OM_CACHE_LINE_SIZE, sizeof(ObjectMonitor*));
 141 
 142   // Global ObjectMonitor wait list. Deflated ObjectMonitors wait on
 143   // this list until after a handshake or a safepoint for platforms
 144   // that don&#39;t support handshakes. After the handshake or safepoint,
 145   // the deflated ObjectMonitors are prepended to free_list.
 146   ObjectMonitor* _wait_list;
 147   DEFINE_PAD_MINUS_SIZE(3, OM_CACHE_LINE_SIZE, sizeof(ObjectMonitor*));
 148 
 149   int _free_count;    // # on free_list
 150   DEFINE_PAD_MINUS_SIZE(4, OM_CACHE_LINE_SIZE, sizeof(int));
 151 
 152   int _in_use_count;  // # on in_use_list
 153   DEFINE_PAD_MINUS_SIZE(5, OM_CACHE_LINE_SIZE, sizeof(int));
 154 
 155   int _population;    // # Extant -- in circulation
 156   DEFINE_PAD_MINUS_SIZE(6, OM_CACHE_LINE_SIZE, sizeof(int));
 157 
 158   int _wait_count;    // # on wait_list
 159   DEFINE_PAD_MINUS_SIZE(7, OM_CACHE_LINE_SIZE, sizeof(int));
 160 };
 161 static ObjectMonitorListGlobals om_list_globals;
 162 
<a name="1" id="anc1"></a>












 163 #define CHAINMARKER (cast_to_oop&lt;intptr_t&gt;(-1))
 164 
 165 
 166 // =====================&gt; Spin-lock functions
 167 
 168 // ObjectMonitors are not lockable outside of this file. We use spin-locks
 169 // implemented using a bit in the _next_om field instead of the heavier
 170 // weight locking mechanisms for faster list management.
 171 
 172 #define OM_LOCK_BIT 0x1
 173 
 174 // Return true if the ObjectMonitor is locked.
 175 // Otherwise returns false.
 176 static bool is_locked(ObjectMonitor* om) {
 177   return ((intptr_t)om-&gt;next_om() &amp; OM_LOCK_BIT) == OM_LOCK_BIT;
 178 }
 179 
 180 // Mark an ObjectMonitor* with OM_LOCK_BIT and return it.
 181 static ObjectMonitor* mark_om_ptr(ObjectMonitor* om) {
 182   return (ObjectMonitor*)((intptr_t)om | OM_LOCK_BIT);
 183 }
 184 
 185 // Return the unmarked next field in an ObjectMonitor. Note: the next
 186 // field may or may not have been marked with OM_LOCK_BIT originally.
 187 static ObjectMonitor* unmarked_next(ObjectMonitor* om) {
 188   return (ObjectMonitor*)((intptr_t)om-&gt;next_om() &amp; ~OM_LOCK_BIT);
 189 }
 190 
 191 // Try to lock an ObjectMonitor. Returns true if locking was successful.
 192 // Otherwise returns false.
 193 static bool try_om_lock(ObjectMonitor* om) {
 194   // Get current next field without any OM_LOCK_BIT value.
 195   ObjectMonitor* next = unmarked_next(om);
 196   if (om-&gt;try_set_next_om(next, mark_om_ptr(next)) != next) {
 197     return false;  // Cannot lock the ObjectMonitor.
 198   }
 199   return true;
 200 }
 201 
 202 // Lock an ObjectMonitor.
 203 static void om_lock(ObjectMonitor* om) {
 204   while (true) {
 205     if (try_om_lock(om)) {
 206       return;
 207     }
 208   }
 209 }
 210 
 211 // Unlock an ObjectMonitor.
 212 static void om_unlock(ObjectMonitor* om) {
 213   ObjectMonitor* next = om-&gt;next_om();
 214   guarantee(((intptr_t)next &amp; OM_LOCK_BIT) == OM_LOCK_BIT, &quot;next=&quot; INTPTR_FORMAT
 215             &quot; must have OM_LOCK_BIT=%x set.&quot;, p2i(next), OM_LOCK_BIT);
 216 
 217   next = (ObjectMonitor*)((intptr_t)next &amp; ~OM_LOCK_BIT);  // Clear OM_LOCK_BIT.
 218   om-&gt;set_next_om(next);
 219 }
 220 
 221 // Get the list head after locking it. Returns the list head or NULL
 222 // if the list is empty.
 223 static ObjectMonitor* get_list_head_locked(ObjectMonitor** list_p) {
 224   while (true) {
 225     ObjectMonitor* mid = Atomic::load(list_p);
 226     if (mid == NULL) {
 227       return NULL;  // The list is empty.
 228     }
 229     if (try_om_lock(mid)) {
 230       if (Atomic::load(list_p) != mid) {
 231         // The list head changed before we could lock it so we have to retry.
 232         om_unlock(mid);
 233         continue;
 234       }
 235       return mid;
 236     }
 237   }
 238 }
 239 
 240 #undef OM_LOCK_BIT
 241 
 242 
 243 // =====================&gt; List Management functions
 244 
 245 // Prepend a list of ObjectMonitors to the specified *list_p. &#39;tail&#39; is
 246 // the last ObjectMonitor in the list and there are &#39;count&#39; on the list.
 247 // Also updates the specified *count_p.
 248 static void prepend_list_to_common(ObjectMonitor* list, ObjectMonitor* tail,
 249                                    int count, ObjectMonitor** list_p,
 250                                    int* count_p) {
 251   while (true) {
 252     ObjectMonitor* cur = Atomic::load(list_p);
 253     // Prepend list to *list_p.
 254     if (!try_om_lock(tail)) {
 255       // Failed to lock tail due to a list walker so try it all again.
 256       continue;
 257     }
 258     tail-&gt;set_next_om(cur);  // tail now points to cur (and unlocks tail)
 259     if (cur == NULL) {
 260       // No potential race with takers or other prependers since
 261       // *list_p is empty.
 262       if (Atomic::cmpxchg(list_p, cur, list) == cur) {
 263         // Successfully switched *list_p to the list value.
 264         Atomic::add(count_p, count);
 265         break;
 266       }
 267       // Implied else: try it all again
 268     } else {
 269       if (!try_om_lock(cur)) {
 270         continue;  // failed to lock cur so try it all again
 271       }
 272       // We locked cur so try to switch *list_p to the list value.
 273       if (Atomic::cmpxchg(list_p, cur, list) != cur) {
 274         // The list head has changed so unlock cur and try again:
 275         om_unlock(cur);
 276         continue;
 277       }
 278       Atomic::add(count_p, count);
 279       om_unlock(cur);
 280       break;
 281     }
 282   }
 283 }
 284 
 285 // Prepend a newly allocated block of ObjectMonitors to g_block_list and
 286 // om_list_globals._free_list. Also updates om_list_globals._population
 287 // and om_list_globals._free_count.
 288 void ObjectSynchronizer::prepend_block_to_lists(PaddedObjectMonitor* new_blk) {
 289   // First we handle g_block_list:
 290   while (true) {
 291     PaddedObjectMonitor* cur = Atomic::load(&amp;g_block_list);
 292     // Prepend new_blk to g_block_list. The first ObjectMonitor in
 293     // a block is reserved for use as linkage to the next block.
 294     new_blk[0].set_next_om(cur);
 295     if (Atomic::cmpxchg(&amp;g_block_list, cur, new_blk) == cur) {
 296       // Successfully switched g_block_list to the new_blk value.
 297       Atomic::add(&amp;om_list_globals._population, _BLOCKSIZE - 1);
 298       break;
 299     }
 300     // Implied else: try it all again
 301   }
 302 
 303   // Second we handle om_list_globals._free_list:
 304   prepend_list_to_common(new_blk + 1, &amp;new_blk[_BLOCKSIZE - 1], _BLOCKSIZE - 1,
 305                          &amp;om_list_globals._free_list, &amp;om_list_globals._free_count);
 306 }
 307 
 308 // Prepend a list of ObjectMonitors to om_list_globals._free_list.
 309 // &#39;tail&#39; is the last ObjectMonitor in the list and there are &#39;count&#39;
 310 // on the list. Also updates om_list_globals._free_count.
 311 static void prepend_list_to_global_free_list(ObjectMonitor* list,
 312                                              ObjectMonitor* tail, int count) {
 313   prepend_list_to_common(list, tail, count, &amp;om_list_globals._free_list,
 314                          &amp;om_list_globals._free_count);
 315 }
 316 
 317 // Prepend a list of ObjectMonitors to om_list_globals._wait_list.
 318 // &#39;tail&#39; is the last ObjectMonitor in the list and there are &#39;count&#39;
 319 // on the list. Also updates om_list_globals._wait_count.
 320 static void prepend_list_to_global_wait_list(ObjectMonitor* list,
 321                                              ObjectMonitor* tail, int count) {
 322   prepend_list_to_common(list, tail, count, &amp;om_list_globals._wait_list,
 323                          &amp;om_list_globals._wait_count);
 324 }
 325 
 326 // Prepend a list of ObjectMonitors to om_list_globals._in_use_list.
 327 // &#39;tail&#39; is the last ObjectMonitor in the list and there are &#39;count&#39;
 328 // on the list. Also updates om_list_globals._in_use_list.
 329 static void prepend_list_to_global_in_use_list(ObjectMonitor* list,
 330                                                ObjectMonitor* tail, int count) {
 331   prepend_list_to_common(list, tail, count, &amp;om_list_globals._in_use_list,
 332                          &amp;om_list_globals._in_use_count);
 333 }
 334 
 335 // Prepend an ObjectMonitor to the specified list. Also updates
 336 // the specified counter.
 337 static void prepend_to_common(ObjectMonitor* m, ObjectMonitor** list_p,
 338                               int* count_p) {
 339   while (true) {
 340     om_lock(m);  // Lock m so we can safely update its next field.
 341     ObjectMonitor* cur = NULL;
 342     // Lock the list head to guard against races with a list walker
 343     // or async deflater thread (which only races in om_in_use_list):
 344     if ((cur = get_list_head_locked(list_p)) != NULL) {
 345       // List head is now locked so we can safely switch it.
 346       m-&gt;set_next_om(cur);  // m now points to cur (and unlocks m)
 347       Atomic::store(list_p, m);  // Switch list head to unlocked m.
 348       om_unlock(cur);
 349       break;
 350     }
 351     // The list is empty so try to set the list head.
 352     assert(cur == NULL, &quot;cur must be NULL: cur=&quot; INTPTR_FORMAT, p2i(cur));
 353     m-&gt;set_next_om(cur);  // m now points to NULL (and unlocks m)
 354     if (Atomic::cmpxchg(list_p, cur, m) == cur) {
 355       // List head is now unlocked m.
 356       break;
 357     }
 358     // Implied else: try it all again
 359   }
 360   Atomic::inc(count_p);
 361 }
 362 
 363 // Prepend an ObjectMonitor to a per-thread om_free_list.
 364 // Also updates the per-thread om_free_count.
 365 static void prepend_to_om_free_list(Thread* self, ObjectMonitor* m) {
 366   prepend_to_common(m, &amp;self-&gt;om_free_list, &amp;self-&gt;om_free_count);
 367 }
 368 
 369 // Prepend an ObjectMonitor to a per-thread om_in_use_list.
 370 // Also updates the per-thread om_in_use_count.
 371 static void prepend_to_om_in_use_list(Thread* self, ObjectMonitor* m) {
 372   prepend_to_common(m, &amp;self-&gt;om_in_use_list, &amp;self-&gt;om_in_use_count);
 373 }
 374 
 375 // Take an ObjectMonitor from the start of the specified list. Also
 376 // decrements the specified counter. Returns NULL if none are available.
 377 static ObjectMonitor* take_from_start_of_common(ObjectMonitor** list_p,
 378                                                 int* count_p) {
 379   ObjectMonitor* take = NULL;
 380   // Lock the list head to guard against races with a list walker
 381   // or async deflater thread (which only races in om_list_globals._free_list):
 382   if ((take = get_list_head_locked(list_p)) == NULL) {
 383     return NULL;  // None are available.
 384   }
 385   ObjectMonitor* next = unmarked_next(take);
 386   // Switch locked list head to next (which unlocks the list head, but
 387   // leaves take locked):
 388   Atomic::store(list_p, next);
 389   Atomic::dec(count_p);
 390   // Unlock take, but leave the next value for any lagging list
 391   // walkers. It will get cleaned up when take is prepended to
 392   // the in-use list:
 393   om_unlock(take);
 394   return take;
 395 }
 396 
 397 // Take an ObjectMonitor from the start of the om_list_globals._free_list.
 398 // Also updates om_list_globals._free_count. Returns NULL if none are
 399 // available.
 400 static ObjectMonitor* take_from_start_of_global_free_list() {
 401   return take_from_start_of_common(&amp;om_list_globals._free_list,
 402                                    &amp;om_list_globals._free_count);
 403 }
 404 
 405 // Take an ObjectMonitor from the start of a per-thread free-list.
 406 // Also updates om_free_count. Returns NULL if none are available.
 407 static ObjectMonitor* take_from_start_of_om_free_list(Thread* self) {
 408   return take_from_start_of_common(&amp;self-&gt;om_free_list, &amp;self-&gt;om_free_count);
 409 }
 410 
 411 
 412 // =====================&gt; Quick functions
 413 
 414 // The quick_* forms are special fast-path variants used to improve
 415 // performance.  In the simplest case, a &quot;quick_*&quot; implementation could
 416 // simply return false, in which case the caller will perform the necessary
 417 // state transitions and call the slow-path form.
 418 // The fast-path is designed to handle frequently arising cases in an efficient
 419 // manner and is just a degenerate &quot;optimistic&quot; variant of the slow-path.
 420 // returns true  -- to indicate the call was satisfied.
 421 // returns false -- to indicate the call needs the services of the slow-path.
 422 // A no-loitering ordinance is in effect for code in the quick_* family
 423 // operators: safepoints or indefinite blocking (blocking that might span a
 424 // safepoint) are forbidden. Generally the thread_state() is _in_Java upon
 425 // entry.
 426 //
 427 // Consider: An interesting optimization is to have the JIT recognize the
 428 // following common idiom:
 429 //   synchronized (someobj) { .... ; notify(); }
 430 // That is, we find a notify() or notifyAll() call that immediately precedes
 431 // the monitorexit operation.  In that case the JIT could fuse the operations
 432 // into a single notifyAndExit() runtime primitive.
 433 
 434 bool ObjectSynchronizer::quick_notify(oopDesc* obj, Thread* self, bool all) {
 435   assert(!SafepointSynchronize::is_at_safepoint(), &quot;invariant&quot;);
 436   assert(self-&gt;is_Java_thread(), &quot;invariant&quot;);
 437   assert(((JavaThread *) self)-&gt;thread_state() == _thread_in_Java, &quot;invariant&quot;);
 438   NoSafepointVerifier nsv;
 439   if (obj == NULL) return false;  // slow-path for invalid obj
<a name="2" id="anc2"></a>
 440   const markWord mark = obj-&gt;mark();
 441 
 442   if (mark.has_locker() &amp;&amp; self-&gt;is_lock_owned((address)mark.locker())) {
 443     // Degenerate notify
 444     // stack-locked by caller so by definition the implied waitset is empty.
 445     return true;
 446   }
 447 
 448   if (mark.has_monitor()) {
 449     ObjectMonitor* const mon = mark.monitor();
 450     assert(mon-&gt;object() == obj, &quot;invariant&quot;);
 451     if (mon-&gt;owner() != self) return false;  // slow-path for IMS exception
 452 
 453     if (mon-&gt;first_waiter() != NULL) {
 454       // We have one or more waiters. Since this is an inflated monitor
 455       // that we own, we can transfer one or more threads from the waitset
 456       // to the entrylist here and now, avoiding the slow-path.
 457       if (all) {
 458         DTRACE_MONITOR_PROBE(notifyAll, mon, obj, self);
 459       } else {
 460         DTRACE_MONITOR_PROBE(notify, mon, obj, self);
 461       }
 462       int free_count = 0;
 463       do {
 464         mon-&gt;INotify(self);
 465         ++free_count;
 466       } while (mon-&gt;first_waiter() != NULL &amp;&amp; all);
 467       OM_PERFDATA_OP(Notifications, inc(free_count));
 468     }
 469     return true;
 470   }
 471 
 472   // biased locking and any other IMS exception states take the slow-path
 473   return false;
 474 }
 475 
 476 
 477 // The LockNode emitted directly at the synchronization site would have
 478 // been too big if it were to have included support for the cases of inflated
 479 // recursive enter and exit, so they go here instead.
 480 // Note that we can&#39;t safely call AsyncPrintJavaStack() from within
 481 // quick_enter() as our thread state remains _in_Java.
 482 
 483 bool ObjectSynchronizer::quick_enter(oop obj, Thread* self,
 484                                      BasicLock * lock) {
 485   assert(!SafepointSynchronize::is_at_safepoint(), &quot;invariant&quot;);
 486   assert(self-&gt;is_Java_thread(), &quot;invariant&quot;);
 487   assert(((JavaThread *) self)-&gt;thread_state() == _thread_in_Java, &quot;invariant&quot;);
 488   NoSafepointVerifier nsv;
 489   if (obj == NULL) return false;       // Need to throw NPE
<a name="3" id="anc3"></a><span class="line-modified"> 490 </span>
 491   const markWord mark = obj-&gt;mark();
 492 
 493   if (mark.has_monitor()) {
 494     ObjectMonitor* const m = mark.monitor();
 495     if (AsyncDeflateIdleMonitors) {
 496       // An async deflation can race us before we manage to make the
 497       // ObjectMonitor busy by setting the owner below. If we detect
 498       // that race we just bail out to the slow-path here.
 499       if (m-&gt;object() == NULL) {
 500         return false;
 501       }
 502     } else {
 503       assert(m-&gt;object() == obj, &quot;invariant&quot;);
 504     }
 505     Thread* const owner = (Thread *) m-&gt;_owner;
 506 
 507     // Lock contention and Transactional Lock Elision (TLE) diagnostics
 508     // and observability
 509     // Case: light contention possibly amenable to TLE
 510     // Case: TLE inimical operations such as nested/recursive synchronization
 511 
 512     if (owner == self) {
 513       m-&gt;_recursions++;
 514       return true;
 515     }
 516 
 517     // This Java Monitor is inflated so obj&#39;s header will never be
 518     // displaced to this thread&#39;s BasicLock. Make the displaced header
 519     // non-NULL so this BasicLock is not seen as recursive nor as
 520     // being locked. We do this unconditionally so that this thread&#39;s
 521     // BasicLock cannot be mis-interpreted by any stack walkers. For
 522     // performance reasons, stack walkers generally first check for
 523     // Biased Locking in the object&#39;s header, the second check is for
 524     // stack-locking in the object&#39;s header, the third check is for
 525     // recursive stack-locking in the displaced header in the BasicLock,
 526     // and last are the inflated Java Monitor (ObjectMonitor) checks.
 527     lock-&gt;set_displaced_header(markWord::unused_mark());
 528 
 529     if (owner == NULL &amp;&amp; m-&gt;try_set_owner_from(NULL, self) == NULL) {
 530       assert(m-&gt;_recursions == 0, &quot;invariant&quot;);
 531       return true;
 532     }
 533   }
 534 
 535   // Note that we could inflate in quick_enter.
 536   // This is likely a useful optimization
 537   // Critically, in quick_enter() we must not:
 538   // -- perform bias revocation, or
 539   // -- block indefinitely, or
 540   // -- reach a safepoint
 541 
 542   return false;        // revert to slow-path
 543 }
 544 
 545 // -----------------------------------------------------------------------------
 546 // Monitor Enter/Exit
 547 // The interpreter and compiler assembly code tries to lock using the fast path
 548 // of this algorithm. Make sure to update that code if the following function is
 549 // changed. The implementation is extremely sensitive to race condition. Be careful.
 550 
 551 void ObjectSynchronizer::enter(Handle obj, BasicLock* lock, TRAPS) {
<a name="4" id="anc4"></a>
 552   if (UseBiasedLocking) {
 553     if (!SafepointSynchronize::is_at_safepoint()) {
 554       BiasedLocking::revoke(obj, THREAD);
 555     } else {
 556       BiasedLocking::revoke_at_safepoint(obj);
 557     }
 558   }
 559 
 560   markWord mark = obj-&gt;mark();
 561   assert(!mark.has_bias_pattern(), &quot;should not see bias pattern here&quot;);
 562 
 563   if (mark.is_neutral()) {
 564     // Anticipate successful CAS -- the ST of the displaced mark must
 565     // be visible &lt;= the ST performed by the CAS.
 566     lock-&gt;set_displaced_header(mark);
 567     if (mark == obj()-&gt;cas_set_mark(markWord::from_pointer(lock), mark)) {
 568       return;
 569     }
 570     // Fall through to inflate() ...
 571   } else if (mark.has_locker() &amp;&amp;
 572              THREAD-&gt;is_lock_owned((address)mark.locker())) {
 573     assert(lock != mark.locker(), &quot;must not re-lock the same lock&quot;);
 574     assert(lock != (BasicLock*)obj-&gt;mark().value(), &quot;don&#39;t relock with same BasicLock&quot;);
 575     lock-&gt;set_displaced_header(markWord::from_pointer(NULL));
 576     return;
 577   }
 578 
 579   // The object header will never be displaced to this lock,
 580   // so it does not matter what the value is, except that it
 581   // must be non-zero to avoid looking like a re-entrant lock,
 582   // and must not look locked either.
 583   lock-&gt;set_displaced_header(markWord::unused_mark());
 584   // An async deflation can race after the inflate() call and before
 585   // enter() can make the ObjectMonitor busy. enter() returns false if
 586   // we have lost the race to async deflation and we simply try again.
 587   while (true) {
 588     ObjectMonitor* monitor = inflate(THREAD, obj(), inflate_cause_monitor_enter);
 589     if (monitor-&gt;enter(THREAD)) {
 590       return;
 591     }
 592   }
 593 }
 594 
 595 void ObjectSynchronizer::exit(oop object, BasicLock* lock, TRAPS) {
 596   markWord mark = object-&gt;mark();
<a name="5" id="anc5"></a>



 597   // We cannot check for Biased Locking if we are racing an inflation.
 598   assert(mark == markWord::INFLATING() ||
 599          !mark.has_bias_pattern(), &quot;should not see bias pattern here&quot;);
 600 
 601   markWord dhw = lock-&gt;displaced_header();
 602   if (dhw.value() == 0) {
 603     // If the displaced header is NULL, then this exit matches up with
 604     // a recursive enter. No real work to do here except for diagnostics.
 605 #ifndef PRODUCT
 606     if (mark != markWord::INFLATING()) {
 607       // Only do diagnostics if we are not racing an inflation. Simply
 608       // exiting a recursive enter of a Java Monitor that is being
 609       // inflated is safe; see the has_monitor() comment below.
 610       assert(!mark.is_neutral(), &quot;invariant&quot;);
 611       assert(!mark.has_locker() ||
 612              THREAD-&gt;is_lock_owned((address)mark.locker()), &quot;invariant&quot;);
 613       if (mark.has_monitor()) {
 614         // The BasicLock&#39;s displaced_header is marked as a recursive
 615         // enter and we have an inflated Java Monitor (ObjectMonitor).
 616         // This is a special case where the Java Monitor was inflated
 617         // after this thread entered the stack-lock recursively. When a
 618         // Java Monitor is inflated, we cannot safely walk the Java
 619         // Monitor owner&#39;s stack and update the BasicLocks because a
 620         // Java Monitor can be asynchronously inflated by a thread that
 621         // does not own the Java Monitor.
 622         ObjectMonitor* m = mark.monitor();
 623         assert(((oop)(m-&gt;object()))-&gt;mark() == mark, &quot;invariant&quot;);
 624         assert(m-&gt;is_entered(THREAD), &quot;invariant&quot;);
 625       }
 626     }
 627 #endif
 628     return;
 629   }
 630 
 631   if (mark == markWord::from_pointer(lock)) {
 632     // If the object is stack-locked by the current thread, try to
 633     // swing the displaced header from the BasicLock back to the mark.
 634     assert(dhw.is_neutral(), &quot;invariant&quot;);
 635     if (object-&gt;cas_set_mark(dhw, mark) == mark) {
 636       return;
 637     }
 638   }
 639 
 640   // We have to take the slow-path of possible inflation and then exit.
 641   // The ObjectMonitor* can&#39;t be async deflated until ownership is
 642   // dropped inside exit() and the ObjectMonitor* must be !is_busy().
 643   ObjectMonitor* monitor = inflate(THREAD, object, inflate_cause_vm_internal);
 644   monitor-&gt;exit(true, THREAD);
 645 }
 646 
 647 // -----------------------------------------------------------------------------
 648 // Class Loader  support to workaround deadlocks on the class loader lock objects
 649 // Also used by GC
 650 // complete_exit()/reenter() are used to wait on a nested lock
 651 // i.e. to give up an outer lock completely and then re-enter
 652 // Used when holding nested locks - lock acquisition order: lock1 then lock2
 653 //  1) complete_exit lock1 - saving recursion count
 654 //  2) wait on lock2
 655 //  3) when notified on lock2, unlock lock2
 656 //  4) reenter lock1 with original recursion count
 657 //  5) lock lock2
 658 // NOTE: must use heavy weight monitor to handle complete_exit/reenter()
 659 intx ObjectSynchronizer::complete_exit(Handle obj, TRAPS) {
<a name="6" id="anc6"></a>
 660   if (UseBiasedLocking) {
 661     BiasedLocking::revoke(obj, THREAD);
 662     assert(!obj-&gt;mark().has_bias_pattern(), &quot;biases should be revoked by now&quot;);
 663   }
 664 
 665   // The ObjectMonitor* can&#39;t be async deflated until ownership is
 666   // dropped inside exit() and the ObjectMonitor* must be !is_busy().
 667   ObjectMonitor* monitor = inflate(THREAD, obj(), inflate_cause_vm_internal);
 668   intptr_t ret_code = monitor-&gt;complete_exit(THREAD);
 669   return ret_code;
 670 }
 671 
 672 // NOTE: must use heavy weight monitor to handle complete_exit/reenter()
 673 void ObjectSynchronizer::reenter(Handle obj, intx recursions, TRAPS) {
<a name="7" id="anc7"></a>
 674   if (UseBiasedLocking) {
 675     BiasedLocking::revoke(obj, THREAD);
 676     assert(!obj-&gt;mark().has_bias_pattern(), &quot;biases should be revoked by now&quot;);
 677   }
 678 
 679   // An async deflation can race after the inflate() call and before
 680   // reenter() -&gt; enter() can make the ObjectMonitor busy. reenter() -&gt;
 681   // enter() returns false if we have lost the race to async deflation
 682   // and we simply try again.
 683   while (true) {
 684     ObjectMonitor* monitor = inflate(THREAD, obj(), inflate_cause_vm_internal);
 685     if (monitor-&gt;reenter(recursions, THREAD)) {
 686       return;
 687     }
 688   }
 689 }
 690 
 691 // -----------------------------------------------------------------------------
 692 // JNI locks on java objects
 693 // NOTE: must use heavy weight monitor to handle jni monitor enter
 694 void ObjectSynchronizer::jni_enter(Handle obj, TRAPS) {
 695   // the current locking is from JNI instead of Java code
<a name="8" id="anc8"></a>
 696   if (UseBiasedLocking) {
 697     BiasedLocking::revoke(obj, THREAD);
 698     assert(!obj-&gt;mark().has_bias_pattern(), &quot;biases should be revoked by now&quot;);
 699   }
 700   THREAD-&gt;set_current_pending_monitor_is_from_java(false);
 701   // An async deflation can race after the inflate() call and before
 702   // enter() can make the ObjectMonitor busy. enter() returns false if
 703   // we have lost the race to async deflation and we simply try again.
 704   while (true) {
 705     ObjectMonitor* monitor = inflate(THREAD, obj(), inflate_cause_jni_enter);
 706     if (monitor-&gt;enter(THREAD)) {
 707       break;
 708     }
 709   }
 710   THREAD-&gt;set_current_pending_monitor_is_from_java(true);
 711 }
 712 
 713 // NOTE: must use heavy weight monitor to handle jni monitor exit
 714 void ObjectSynchronizer::jni_exit(oop obj, Thread* THREAD) {
<a name="9" id="anc9"></a>
 715   if (UseBiasedLocking) {
 716     Handle h_obj(THREAD, obj);
 717     BiasedLocking::revoke(h_obj, THREAD);
 718     obj = h_obj();
 719   }
 720   assert(!obj-&gt;mark().has_bias_pattern(), &quot;biases should be revoked by now&quot;);
 721 
 722   // The ObjectMonitor* can&#39;t be async deflated until ownership is
 723   // dropped inside exit() and the ObjectMonitor* must be !is_busy().
 724   ObjectMonitor* monitor = inflate(THREAD, obj, inflate_cause_jni_exit);
 725   // If this thread has locked the object, exit the monitor. We
 726   // intentionally do not use CHECK here because we must exit the
 727   // monitor even if an exception is pending.
 728   if (monitor-&gt;check_owner(THREAD)) {
 729     monitor-&gt;exit(true, THREAD);
 730   }
 731 }
 732 
 733 // -----------------------------------------------------------------------------
 734 // Internal VM locks on java objects
 735 // standard constructor, allows locking failures
 736 ObjectLocker::ObjectLocker(Handle obj, Thread* thread, bool do_lock) {
 737   _dolock = do_lock;
 738   _thread = thread;
 739   _thread-&gt;check_for_valid_safepoint_state();
 740   _obj = obj;
 741 
 742   if (_dolock) {
 743     ObjectSynchronizer::enter(_obj, &amp;_lock, _thread);
 744   }
 745 }
 746 
 747 ObjectLocker::~ObjectLocker() {
 748   if (_dolock) {
 749     ObjectSynchronizer::exit(_obj(), &amp;_lock, _thread);
 750   }
 751 }
 752 
 753 
 754 // -----------------------------------------------------------------------------
 755 //  Wait/Notify/NotifyAll
 756 // NOTE: must use heavy weight monitor to handle wait()
 757 int ObjectSynchronizer::wait(Handle obj, jlong millis, TRAPS) {
<a name="10" id="anc10"></a>
 758   if (UseBiasedLocking) {
 759     BiasedLocking::revoke(obj, THREAD);
 760     assert(!obj-&gt;mark().has_bias_pattern(), &quot;biases should be revoked by now&quot;);
 761   }
 762   if (millis &lt; 0) {
 763     THROW_MSG_0(vmSymbols::java_lang_IllegalArgumentException(), &quot;timeout value is negative&quot;);
 764   }
 765   // The ObjectMonitor* can&#39;t be async deflated because the _waiters
 766   // field is incremented before ownership is dropped and decremented
 767   // after ownership is regained.
 768   ObjectMonitor* monitor = inflate(THREAD, obj(), inflate_cause_wait);
 769 
 770   DTRACE_MONITOR_WAIT_PROBE(monitor, obj(), THREAD, millis);
 771   monitor-&gt;wait(millis, true, THREAD);
 772 
 773   // This dummy call is in place to get around dtrace bug 6254741.  Once
 774   // that&#39;s fixed we can uncomment the following line, remove the call
 775   // and change this function back into a &quot;void&quot; func.
 776   // DTRACE_MONITOR_PROBE(waited, monitor, obj(), THREAD);
 777   int ret_code = dtrace_waited_probe(monitor, obj, THREAD);
 778   return ret_code;
 779 }
 780 
 781 void ObjectSynchronizer::wait_uninterruptibly(Handle obj, jlong millis, TRAPS) {
<a name="11" id="anc11"></a>
 782   if (UseBiasedLocking) {
 783     BiasedLocking::revoke(obj, THREAD);
 784     assert(!obj-&gt;mark().has_bias_pattern(), &quot;biases should be revoked by now&quot;);
 785   }
 786   if (millis &lt; 0) {
 787     THROW_MSG(vmSymbols::java_lang_IllegalArgumentException(), &quot;timeout value is negative&quot;);
 788   }
 789   // The ObjectMonitor* can&#39;t be async deflated because the _waiters
 790   // field is incremented before ownership is dropped and decremented
 791   // after ownership is regained.
 792   ObjectMonitor* monitor = inflate(THREAD, obj(), inflate_cause_wait);
 793   monitor-&gt;wait(millis, false, THREAD);
 794 }
 795 
 796 void ObjectSynchronizer::notify(Handle obj, TRAPS) {
<a name="12" id="anc12"></a>
 797   if (UseBiasedLocking) {
 798     BiasedLocking::revoke(obj, THREAD);
 799     assert(!obj-&gt;mark().has_bias_pattern(), &quot;biases should be revoked by now&quot;);
 800   }
 801 
 802   markWord mark = obj-&gt;mark();
 803   if (mark.has_locker() &amp;&amp; THREAD-&gt;is_lock_owned((address)mark.locker())) {
 804     return;
 805   }
 806   // The ObjectMonitor* can&#39;t be async deflated until ownership is
 807   // dropped by the calling thread.
 808   ObjectMonitor* monitor = inflate(THREAD, obj(), inflate_cause_notify);
 809   monitor-&gt;notify(THREAD);
 810 }
 811 
 812 // NOTE: see comment of notify()
 813 void ObjectSynchronizer::notifyall(Handle obj, TRAPS) {
<a name="13" id="anc13"></a>
 814   if (UseBiasedLocking) {
 815     BiasedLocking::revoke(obj, THREAD);
 816     assert(!obj-&gt;mark().has_bias_pattern(), &quot;biases should be revoked by now&quot;);
 817   }
 818 
 819   markWord mark = obj-&gt;mark();
 820   if (mark.has_locker() &amp;&amp; THREAD-&gt;is_lock_owned((address)mark.locker())) {
 821     return;
 822   }
 823   // The ObjectMonitor* can&#39;t be async deflated until ownership is
 824   // dropped by the calling thread.
 825   ObjectMonitor* monitor = inflate(THREAD, obj(), inflate_cause_notify);
 826   monitor-&gt;notifyAll(THREAD);
 827 }
 828 
 829 // -----------------------------------------------------------------------------
 830 // Hash Code handling
 831 //
 832 // Performance concern:
 833 // OrderAccess::storestore() calls release() which at one time stored 0
 834 // into the global volatile OrderAccess::dummy variable. This store was
 835 // unnecessary for correctness. Many threads storing into a common location
 836 // causes considerable cache migration or &quot;sloshing&quot; on large SMP systems.
 837 // As such, I avoided using OrderAccess::storestore(). In some cases
 838 // OrderAccess::fence() -- which incurs local latency on the executing
 839 // processor -- is a better choice as it scales on SMP systems.
 840 //
 841 // See http://blogs.oracle.com/dave/entry/biased_locking_in_hotspot for
 842 // a discussion of coherency costs. Note that all our current reference
 843 // platforms provide strong ST-ST order, so the issue is moot on IA32,
 844 // x64, and SPARC.
 845 //
 846 // As a general policy we use &quot;volatile&quot; to control compiler-based reordering
 847 // and explicit fences (barriers) to control for architectural reordering
 848 // performed by the CPU(s) or platform.
 849 
 850 struct SharedGlobals {
 851   char         _pad_prefix[OM_CACHE_LINE_SIZE];
 852   // These are highly shared mostly-read variables.
 853   // To avoid false-sharing they need to be the sole occupants of a cache line.
 854   volatile int stw_random;
 855   volatile int stw_cycle;
 856   DEFINE_PAD_MINUS_SIZE(1, OM_CACHE_LINE_SIZE, sizeof(volatile int) * 2);
 857   // Hot RW variable -- Sequester to avoid false-sharing
 858   volatile int hc_sequence;
 859   DEFINE_PAD_MINUS_SIZE(2, OM_CACHE_LINE_SIZE, sizeof(volatile int));
 860 };
 861 
 862 static SharedGlobals GVars;
 863 
 864 static markWord read_stable_mark(oop obj) {
 865   markWord mark = obj-&gt;mark();
 866   if (!mark.is_being_inflated()) {
 867     return mark;       // normal fast-path return
 868   }
 869 
 870   int its = 0;
 871   for (;;) {
 872     markWord mark = obj-&gt;mark();
 873     if (!mark.is_being_inflated()) {
 874       return mark;    // normal fast-path return
 875     }
 876 
 877     // The object is being inflated by some other thread.
 878     // The caller of read_stable_mark() must wait for inflation to complete.
 879     // Avoid live-lock
 880     // TODO: consider calling SafepointSynchronize::do_call_back() while
 881     // spinning to see if there&#39;s a safepoint pending.  If so, immediately
 882     // yielding or blocking would be appropriate.  Avoid spinning while
 883     // there is a safepoint pending.
 884     // TODO: add inflation contention performance counters.
 885     // TODO: restrict the aggregate number of spinners.
 886 
 887     ++its;
 888     if (its &gt; 10000 || !os::is_MP()) {
 889       if (its &amp; 1) {
 890         os::naked_yield();
 891       } else {
 892         // Note that the following code attenuates the livelock problem but is not
 893         // a complete remedy.  A more complete solution would require that the inflating
 894         // thread hold the associated inflation lock.  The following code simply restricts
 895         // the number of spinners to at most one.  We&#39;ll have N-2 threads blocked
 896         // on the inflationlock, 1 thread holding the inflation lock and using
 897         // a yield/park strategy, and 1 thread in the midst of inflation.
 898         // A more refined approach would be to change the encoding of INFLATING
 899         // to allow encapsulation of a native thread pointer.  Threads waiting for
 900         // inflation to complete would use CAS to push themselves onto a singly linked
 901         // list rooted at the markword.  Once enqueued, they&#39;d loop, checking a per-thread flag
 902         // and calling park().  When inflation was complete the thread that accomplished inflation
 903         // would detach the list and set the markword to inflated with a single CAS and
 904         // then for each thread on the list, set the flag and unpark() the thread.
 905         // This is conceptually similar to muxAcquire-muxRelease, except that muxRelease
 906         // wakes at most one thread whereas we need to wake the entire list.
 907         int ix = (cast_from_oop&lt;intptr_t&gt;(obj) &gt;&gt; 5) &amp; (NINFLATIONLOCKS-1);
 908         int YieldThenBlock = 0;
 909         assert(ix &gt;= 0 &amp;&amp; ix &lt; NINFLATIONLOCKS, &quot;invariant&quot;);
 910         assert((NINFLATIONLOCKS &amp; (NINFLATIONLOCKS-1)) == 0, &quot;invariant&quot;);
 911         Thread::muxAcquire(gInflationLocks + ix, &quot;gInflationLock&quot;);
 912         while (obj-&gt;mark() == markWord::INFLATING()) {
 913           // Beware: NakedYield() is advisory and has almost no effect on some platforms
 914           // so we periodically call self-&gt;_ParkEvent-&gt;park(1).
 915           // We use a mixed spin/yield/block mechanism.
 916           if ((YieldThenBlock++) &gt;= 16) {
 917             Thread::current()-&gt;_ParkEvent-&gt;park(1);
 918           } else {
 919             os::naked_yield();
 920           }
 921         }
 922         Thread::muxRelease(gInflationLocks + ix);
 923       }
 924     } else {
 925       SpinPause();       // SMP-polite spinning
 926     }
 927   }
 928 }
 929 
 930 // hashCode() generation :
 931 //
 932 // Possibilities:
 933 // * MD5Digest of {obj,stw_random}
 934 // * CRC32 of {obj,stw_random} or any linear-feedback shift register function.
 935 // * A DES- or AES-style SBox[] mechanism
 936 // * One of the Phi-based schemes, such as:
 937 //   2654435761 = 2^32 * Phi (golden ratio)
 938 //   HashCodeValue = ((uintptr_t(obj) &gt;&gt; 3) * 2654435761) ^ GVars.stw_random ;
 939 // * A variation of Marsaglia&#39;s shift-xor RNG scheme.
 940 // * (obj ^ stw_random) is appealing, but can result
 941 //   in undesirable regularity in the hashCode values of adjacent objects
 942 //   (objects allocated back-to-back, in particular).  This could potentially
 943 //   result in hashtable collisions and reduced hashtable efficiency.
 944 //   There are simple ways to &quot;diffuse&quot; the middle address bits over the
 945 //   generated hashCode values:
 946 
 947 static inline intptr_t get_next_hash(Thread* self, oop obj) {
 948   intptr_t value = 0;
 949   if (hashCode == 0) {
 950     // This form uses global Park-Miller RNG.
 951     // On MP system we&#39;ll have lots of RW access to a global, so the
 952     // mechanism induces lots of coherency traffic.
 953     value = os::random();
 954   } else if (hashCode == 1) {
 955     // This variation has the property of being stable (idempotent)
 956     // between STW operations.  This can be useful in some of the 1-0
 957     // synchronization schemes.
 958     intptr_t addr_bits = cast_from_oop&lt;intptr_t&gt;(obj) &gt;&gt; 3;
 959     value = addr_bits ^ (addr_bits &gt;&gt; 5) ^ GVars.stw_random;
 960   } else if (hashCode == 2) {
 961     value = 1;            // for sensitivity testing
 962   } else if (hashCode == 3) {
 963     value = ++GVars.hc_sequence;
 964   } else if (hashCode == 4) {
 965     value = cast_from_oop&lt;intptr_t&gt;(obj);
 966   } else {
 967     // Marsaglia&#39;s xor-shift scheme with thread-specific state
 968     // This is probably the best overall implementation -- we&#39;ll
 969     // likely make this the default in future releases.
 970     unsigned t = self-&gt;_hashStateX;
 971     t ^= (t &lt;&lt; 11);
 972     self-&gt;_hashStateX = self-&gt;_hashStateY;
 973     self-&gt;_hashStateY = self-&gt;_hashStateZ;
 974     self-&gt;_hashStateZ = self-&gt;_hashStateW;
 975     unsigned v = self-&gt;_hashStateW;
 976     v = (v ^ (v &gt;&gt; 19)) ^ (t ^ (t &gt;&gt; 8));
 977     self-&gt;_hashStateW = v;
 978     value = v;
 979   }
 980 
 981   value &amp;= markWord::hash_mask;
 982   if (value == 0) value = 0xBAD;
 983   assert(value != markWord::no_hash, &quot;invariant&quot;);
 984   return value;
 985 }
 986 
 987 intptr_t ObjectSynchronizer::FastHashCode(Thread* self, oop obj) {
<a name="14" id="anc14"></a>







 988   if (UseBiasedLocking) {
 989     // NOTE: many places throughout the JVM do not expect a safepoint
 990     // to be taken here, in particular most operations on perm gen
 991     // objects. However, we only ever bias Java instances and all of
 992     // the call sites of identity_hash that might revoke biases have
 993     // been checked to make sure they can handle a safepoint. The
 994     // added check of the bias pattern is to avoid useless calls to
 995     // thread-local storage.
 996     if (obj-&gt;mark().has_bias_pattern()) {
 997       // Handle for oop obj in case of STW safepoint
 998       Handle hobj(self, obj);
 999       // Relaxing assertion for bug 6320749.
1000       assert(Universe::verify_in_progress() ||
1001              !SafepointSynchronize::is_at_safepoint(),
1002              &quot;biases should not be seen by VM thread here&quot;);
1003       BiasedLocking::revoke(hobj, JavaThread::current());
1004       obj = hobj();
1005       assert(!obj-&gt;mark().has_bias_pattern(), &quot;biases should be revoked by now&quot;);
1006     }
1007   }
1008 
1009   // hashCode() is a heap mutator ...
1010   // Relaxing assertion for bug 6320749.
1011   assert(Universe::verify_in_progress() || DumpSharedSpaces ||
1012          !SafepointSynchronize::is_at_safepoint(), &quot;invariant&quot;);
1013   assert(Universe::verify_in_progress() || DumpSharedSpaces ||
1014          self-&gt;is_Java_thread() , &quot;invariant&quot;);
1015   assert(Universe::verify_in_progress() || DumpSharedSpaces ||
1016          ((JavaThread *)self)-&gt;thread_state() != _thread_blocked, &quot;invariant&quot;);
1017 
1018   while (true) {
1019     ObjectMonitor* monitor = NULL;
1020     markWord temp, test;
1021     intptr_t hash;
1022     markWord mark = read_stable_mark(obj);
1023 
1024     // object should remain ineligible for biased locking
1025     assert(!mark.has_bias_pattern(), &quot;invariant&quot;);
1026 
1027     if (mark.is_neutral()) {            // if this is a normal header
1028       hash = mark.hash();
1029       if (hash != 0) {                  // if it has a hash, just return it
1030         return hash;
1031       }
1032       hash = get_next_hash(self, obj);  // get a new hash
1033       temp = mark.copy_set_hash(hash);  // merge the hash into header
1034                                         // try to install the hash
1035       test = obj-&gt;cas_set_mark(temp, mark);
1036       if (test == mark) {               // if the hash was installed, return it
1037         return hash;
1038       }
1039       // Failed to install the hash. It could be that another thread
1040       // installed the hash just before our attempt or inflation has
1041       // occurred or... so we fall thru to inflate the monitor for
1042       // stability and then install the hash.
1043     } else if (mark.has_monitor()) {
1044       monitor = mark.monitor();
1045       temp = monitor-&gt;header();
1046       assert(temp.is_neutral(), &quot;invariant: header=&quot; INTPTR_FORMAT, temp.value());
1047       hash = temp.hash();
1048       if (hash != 0) {
1049         // It has a hash.
1050 
1051         // Separate load of dmw/header above from the loads in
1052         // is_being_async_deflated().
1053         if (support_IRIW_for_not_multiple_copy_atomic_cpu) {
1054           // A non-multiple copy atomic (nMCA) machine needs a bigger
1055           // hammer to separate the load above and the loads below.
1056           OrderAccess::fence();
1057         } else {
1058           OrderAccess::loadload();
1059         }
1060         if (monitor-&gt;is_being_async_deflated()) {
1061           // But we can&#39;t safely use the hash if we detect that async
1062           // deflation has occurred. So we attempt to restore the
1063           // header/dmw to the object&#39;s header so that we only retry
1064           // once if the deflater thread happens to be slow.
1065           monitor-&gt;install_displaced_markword_in_object(obj);
1066           continue;
1067         }
1068         return hash;
1069       }
1070       // Fall thru so we only have one place that installs the hash in
1071       // the ObjectMonitor.
1072     } else if (self-&gt;is_lock_owned((address)mark.locker())) {
1073       // This is a stack lock owned by the calling thread so fetch the
1074       // displaced markWord from the BasicLock on the stack.
1075       temp = mark.displaced_mark_helper();
1076       assert(temp.is_neutral(), &quot;invariant: header=&quot; INTPTR_FORMAT, temp.value());
1077       hash = temp.hash();
1078       if (hash != 0) {                  // if it has a hash, just return it
1079         return hash;
1080       }
1081       // WARNING:
1082       // The displaced header in the BasicLock on a thread&#39;s stack
1083       // is strictly immutable. It CANNOT be changed in ANY cases.
1084       // So we have to inflate the stack lock into an ObjectMonitor
1085       // even if the current thread owns the lock. The BasicLock on
1086       // a thread&#39;s stack can be asynchronously read by other threads
1087       // during an inflate() call so any change to that stack memory
1088       // may not propagate to other threads correctly.
1089     }
1090 
1091     // Inflate the monitor to set the hash.
1092 
1093     // An async deflation can race after the inflate() call and before we
1094     // can update the ObjectMonitor&#39;s header with the hash value below.
1095     monitor = inflate(self, obj, inflate_cause_hash_code);
1096     // Load ObjectMonitor&#39;s header/dmw field and see if it has a hash.
1097     mark = monitor-&gt;header();
1098     assert(mark.is_neutral(), &quot;invariant: header=&quot; INTPTR_FORMAT, mark.value());
1099     hash = mark.hash();
1100     if (hash == 0) {                    // if it does not have a hash
1101       hash = get_next_hash(self, obj);  // get a new hash
1102       temp = mark.copy_set_hash(hash);  // merge the hash into header
1103       assert(temp.is_neutral(), &quot;invariant: header=&quot; INTPTR_FORMAT, temp.value());
1104       uintptr_t v = Atomic::cmpxchg((volatile uintptr_t*)monitor-&gt;header_addr(), mark.value(), temp.value());
1105       test = markWord(v);
1106       if (test != mark) {
1107         // The attempt to update the ObjectMonitor&#39;s header/dmw field
1108         // did not work. This can happen if another thread managed to
1109         // merge in the hash just before our cmpxchg().
1110         // If we add any new usages of the header/dmw field, this code
1111         // will need to be updated.
1112         hash = test.hash();
1113         assert(test.is_neutral(), &quot;invariant: header=&quot; INTPTR_FORMAT, test.value());
1114         assert(hash != 0, &quot;should only have lost the race to a thread that set a non-zero hash&quot;);
1115       }
1116       if (monitor-&gt;is_being_async_deflated()) {
1117         // If we detect that async deflation has occurred, then we
1118         // attempt to restore the header/dmw to the object&#39;s header
1119         // so that we only retry once if the deflater thread happens
1120         // to be slow.
1121         monitor-&gt;install_displaced_markword_in_object(obj);
1122         continue;
1123       }
1124     }
1125     // We finally get the hash.
1126     return hash;
1127   }
1128 }
1129 
<a name="15" id="anc15"></a><span class="line-removed">1130 // Deprecated -- use FastHashCode() instead.</span>
<span class="line-removed">1131 </span>
<span class="line-removed">1132 intptr_t ObjectSynchronizer::identity_hash_value_for(Handle obj) {</span>
<span class="line-removed">1133   return FastHashCode(Thread::current(), obj());</span>
<span class="line-removed">1134 }</span>
<span class="line-removed">1135 </span>
1136 
1137 bool ObjectSynchronizer::current_thread_holds_lock(JavaThread* thread,
1138                                                    Handle h_obj) {
<a name="16" id="anc16"></a>


1139   if (UseBiasedLocking) {
1140     BiasedLocking::revoke(h_obj, thread);
1141     assert(!h_obj-&gt;mark().has_bias_pattern(), &quot;biases should be revoked by now&quot;);
1142   }
1143 
1144   assert(thread == JavaThread::current(), &quot;Can only be called on current thread&quot;);
1145   oop obj = h_obj();
1146 
1147   markWord mark = read_stable_mark(obj);
1148 
1149   // Uncontended case, header points to stack
1150   if (mark.has_locker()) {
1151     return thread-&gt;is_lock_owned((address)mark.locker());
1152   }
1153   // Contended case, header points to ObjectMonitor (tagged pointer)
1154   if (mark.has_monitor()) {
1155     // The first stage of async deflation does not affect any field
1156     // used by this comparison so the ObjectMonitor* is usable here.
1157     ObjectMonitor* monitor = mark.monitor();
1158     return monitor-&gt;is_entered(thread) != 0;
1159   }
1160   // Unlocked case, header in place
1161   assert(mark.is_neutral(), &quot;sanity check&quot;);
1162   return false;
1163 }
1164 
1165 // Be aware of this method could revoke bias of the lock object.
1166 // This method queries the ownership of the lock handle specified by &#39;h_obj&#39;.
1167 // If the current thread owns the lock, it returns owner_self. If no
1168 // thread owns the lock, it returns owner_none. Otherwise, it will return
1169 // owner_other.
1170 ObjectSynchronizer::LockOwnership ObjectSynchronizer::query_lock_ownership
1171 (JavaThread *self, Handle h_obj) {
1172   // The caller must beware this method can revoke bias, and
1173   // revocation can result in a safepoint.
1174   assert(!SafepointSynchronize::is_at_safepoint(), &quot;invariant&quot;);
1175   assert(self-&gt;thread_state() != _thread_blocked, &quot;invariant&quot;);
1176 
1177   // Possible mark states: neutral, biased, stack-locked, inflated
1178 
1179   if (UseBiasedLocking &amp;&amp; h_obj()-&gt;mark().has_bias_pattern()) {
1180     // CASE: biased
1181     BiasedLocking::revoke(h_obj, self);
1182     assert(!h_obj-&gt;mark().has_bias_pattern(),
1183            &quot;biases should be revoked by now&quot;);
1184   }
1185 
1186   assert(self == JavaThread::current(), &quot;Can only be called on current thread&quot;);
1187   oop obj = h_obj();
1188   markWord mark = read_stable_mark(obj);
1189 
1190   // CASE: stack-locked.  Mark points to a BasicLock on the owner&#39;s stack.
1191   if (mark.has_locker()) {
1192     return self-&gt;is_lock_owned((address)mark.locker()) ?
1193       owner_self : owner_other;
1194   }
1195 
1196   // CASE: inflated. Mark (tagged pointer) points to an ObjectMonitor.
1197   // The Object:ObjectMonitor relationship is stable as long as we&#39;re
1198   // not at a safepoint and AsyncDeflateIdleMonitors is false.
1199   if (mark.has_monitor()) {
1200     // The first stage of async deflation does not affect any field
1201     // used by this comparison so the ObjectMonitor* is usable here.
1202     ObjectMonitor* monitor = mark.monitor();
1203     void* owner = monitor-&gt;owner();
1204     if (owner == NULL) return owner_none;
1205     return (owner == self ||
1206             self-&gt;is_lock_owned((address)owner)) ? owner_self : owner_other;
1207   }
1208 
1209   // CASE: neutral
1210   assert(mark.is_neutral(), &quot;sanity check&quot;);
1211   return owner_none;           // it&#39;s unlocked
1212 }
1213 
1214 // FIXME: jvmti should call this
1215 JavaThread* ObjectSynchronizer::get_lock_owner(ThreadsList * t_list, Handle h_obj) {
1216   if (UseBiasedLocking) {
1217     if (SafepointSynchronize::is_at_safepoint()) {
1218       BiasedLocking::revoke_at_safepoint(h_obj);
1219     } else {
1220       BiasedLocking::revoke(h_obj, JavaThread::current());
1221     }
1222     assert(!h_obj-&gt;mark().has_bias_pattern(), &quot;biases should be revoked by now&quot;);
1223   }
1224 
1225   oop obj = h_obj();
1226   address owner = NULL;
1227 
1228   markWord mark = read_stable_mark(obj);
1229 
1230   // Uncontended case, header points to stack
1231   if (mark.has_locker()) {
1232     owner = (address) mark.locker();
1233   }
1234 
1235   // Contended case, header points to ObjectMonitor (tagged pointer)
1236   else if (mark.has_monitor()) {
1237     // The first stage of async deflation does not affect any field
1238     // used by this comparison so the ObjectMonitor* is usable here.
1239     ObjectMonitor* monitor = mark.monitor();
1240     assert(monitor != NULL, &quot;monitor should be non-null&quot;);
1241     owner = (address) monitor-&gt;owner();
1242   }
1243 
1244   if (owner != NULL) {
1245     // owning_thread_from_monitor_owner() may also return NULL here
1246     return Threads::owning_thread_from_monitor_owner(t_list, owner);
1247   }
1248 
1249   // Unlocked case, header in place
1250   // Cannot have assertion since this object may have been
1251   // locked by another thread when reaching here.
1252   // assert(mark.is_neutral(), &quot;sanity check&quot;);
1253 
1254   return NULL;
1255 }
1256 
1257 // Visitors ...
1258 
1259 void ObjectSynchronizer::monitors_iterate(MonitorClosure* closure) {
1260   PaddedObjectMonitor* block = Atomic::load(&amp;g_block_list);
1261   while (block != NULL) {
1262     assert(block-&gt;object() == CHAINMARKER, &quot;must be a block header&quot;);
1263     for (int i = _BLOCKSIZE - 1; i &gt; 0; i--) {
1264       ObjectMonitor* mid = (ObjectMonitor *)(block + i);
1265       if (mid-&gt;object() != NULL) {
1266         // Only process with closure if the object is set.
1267 
1268         // monitors_iterate() is only called at a safepoint or when the
1269         // target thread is suspended or when the target thread is
1270         // operating on itself. The current closures in use today are
1271         // only interested in an owned ObjectMonitor and ownership
1272         // cannot be dropped under the calling contexts so the
1273         // ObjectMonitor cannot be async deflated.
1274         closure-&gt;do_monitor(mid);
1275       }
1276     }
1277     // unmarked_next() is not needed with g_block_list (no locking
1278     // used with block linkage _next_om fields).
1279     block = (PaddedObjectMonitor*)block-&gt;next_om();
1280   }
1281 }
1282 
1283 static bool monitors_used_above_threshold() {
1284   int population = Atomic::load(&amp;om_list_globals._population);
1285   if (population == 0) {
1286     return false;
1287   }
1288   if (MonitorUsedDeflationThreshold &gt; 0) {
1289     int monitors_used = population - Atomic::load(&amp;om_list_globals._free_count) -
1290                         Atomic::load(&amp;om_list_globals._wait_count);
1291     int monitor_usage = (monitors_used * 100LL) / population;
1292     return monitor_usage &gt; MonitorUsedDeflationThreshold;
1293   }
1294   return false;
1295 }
1296 
1297 bool ObjectSynchronizer::is_async_deflation_needed() {
1298   if (!AsyncDeflateIdleMonitors) {
1299     return false;
1300   }
1301   if (is_async_deflation_requested()) {
1302     // Async deflation request.
1303     return true;
1304   }
1305   if (AsyncDeflationInterval &gt; 0 &amp;&amp;
1306       time_since_last_async_deflation_ms() &gt; AsyncDeflationInterval &amp;&amp;
1307       monitors_used_above_threshold()) {
1308     // It&#39;s been longer than our specified deflate interval and there
1309     // are too many monitors in use. We don&#39;t deflate more frequently
1310     // than AsyncDeflationInterval (unless is_async_deflation_requested)
1311     // in order to not swamp the ServiceThread.
1312     _last_async_deflation_time_ns = os::javaTimeNanos();
1313     return true;
1314   }
1315   return false;
1316 }
1317 
1318 bool ObjectSynchronizer::is_safepoint_deflation_needed() {
1319   if (!AsyncDeflateIdleMonitors) {
1320     if (monitors_used_above_threshold()) {
1321       // Too many monitors in use.
1322       return true;
1323     }
1324     return false;
1325   }
1326   if (is_special_deflation_requested()) {
1327     // For AsyncDeflateIdleMonitors only do a safepoint deflation
1328     // if there is a special deflation request.
1329     return true;
1330   }
1331   return false;
1332 }
1333 
1334 jlong ObjectSynchronizer::time_since_last_async_deflation_ms() {
1335   return (os::javaTimeNanos() - _last_async_deflation_time_ns) / (NANOUNITS / MILLIUNITS);
1336 }
1337 
1338 void ObjectSynchronizer::oops_do(OopClosure* f) {
1339   // We only scan the global used list here (for moribund threads), and
1340   // the thread-local monitors in Thread::oops_do().
1341   global_used_oops_do(f);
1342 }
1343 
1344 void ObjectSynchronizer::global_used_oops_do(OopClosure* f) {
1345   assert(SafepointSynchronize::is_at_safepoint(), &quot;must be at safepoint&quot;);
1346   list_oops_do(Atomic::load(&amp;om_list_globals._in_use_list), f);
1347 }
1348 
1349 void ObjectSynchronizer::thread_local_used_oops_do(Thread* thread, OopClosure* f) {
1350   assert(SafepointSynchronize::is_at_safepoint(), &quot;must be at safepoint&quot;);
1351   list_oops_do(thread-&gt;om_in_use_list, f);
1352 }
1353 
1354 void ObjectSynchronizer::list_oops_do(ObjectMonitor* list, OopClosure* f) {
1355   assert(SafepointSynchronize::is_at_safepoint(), &quot;must be at safepoint&quot;);
1356   // The oops_do() phase does not overlap with monitor deflation
1357   // so no need to lock ObjectMonitors for the list traversal.
1358   for (ObjectMonitor* mid = list; mid != NULL; mid = unmarked_next(mid)) {
1359     if (mid-&gt;object() != NULL) {
1360       f-&gt;do_oop((oop*)mid-&gt;object_addr());
1361     }
1362   }
1363 }
1364 
1365 
1366 // -----------------------------------------------------------------------------
1367 // ObjectMonitor Lifecycle
1368 // -----------------------
1369 // Inflation unlinks monitors from om_list_globals._free_list or a per-thread
1370 // free list and associates them with objects. Deflation -- which occurs at
1371 // STW-time or asynchronously -- disassociates idle monitors from objects.
1372 // Such scavenged monitors are returned to the om_list_globals._free_list.
1373 //
1374 // ObjectMonitors reside in type-stable memory (TSM) and are immortal.
1375 //
1376 // Lifecycle:
1377 // --   unassigned and on the om_list_globals._free_list
1378 // --   unassigned and on a per-thread free list
1379 // --   assigned to an object.  The object is inflated and the mark refers
1380 //      to the ObjectMonitor.
1381 
1382 ObjectMonitor* ObjectSynchronizer::om_alloc(Thread* self) {
1383   // A large MAXPRIVATE value reduces both list lock contention
1384   // and list coherency traffic, but also tends to increase the
1385   // number of ObjectMonitors in circulation as well as the STW
1386   // scavenge costs.  As usual, we lean toward time in space-time
1387   // tradeoffs.
1388   const int MAXPRIVATE = 1024;
1389   NoSafepointVerifier nsv;
1390 
1391   for (;;) {
1392     ObjectMonitor* m;
1393 
1394     // 1: try to allocate from the thread&#39;s local om_free_list.
1395     // Threads will attempt to allocate first from their local list, then
1396     // from the global list, and only after those attempts fail will the
1397     // thread attempt to instantiate new monitors. Thread-local free lists
1398     // improve allocation latency, as well as reducing coherency traffic
1399     // on the shared global list.
1400     m = take_from_start_of_om_free_list(self);
1401     if (m != NULL) {
1402       guarantee(m-&gt;object() == NULL, &quot;invariant&quot;);
1403       m-&gt;set_allocation_state(ObjectMonitor::New);
1404       prepend_to_om_in_use_list(self, m);
1405       return m;
1406     }
1407 
1408     // 2: try to allocate from the global om_list_globals._free_list
1409     // If we&#39;re using thread-local free lists then try
1410     // to reprovision the caller&#39;s free list.
1411     if (Atomic::load(&amp;om_list_globals._free_list) != NULL) {
1412       // Reprovision the thread&#39;s om_free_list.
1413       // Use bulk transfers to reduce the allocation rate and heat
1414       // on various locks.
1415       for (int i = self-&gt;om_free_provision; --i &gt;= 0;) {
1416         ObjectMonitor* take = take_from_start_of_global_free_list();
1417         if (take == NULL) {
1418           break;  // No more are available.
1419         }
1420         guarantee(take-&gt;object() == NULL, &quot;invariant&quot;);
1421         if (AsyncDeflateIdleMonitors) {
1422           // We allowed 3 field values to linger during async deflation.
1423           // Clear or restore them as appropriate.
1424           take-&gt;set_header(markWord::zero());
1425           // DEFLATER_MARKER is the only non-NULL value we should see here.
1426           take-&gt;try_set_owner_from(DEFLATER_MARKER, NULL);
1427           if (take-&gt;contentions() &lt; 0) {
1428             // Add back max_jint to restore the contentions field to its
1429             // proper value.
1430             take-&gt;add_to_contentions(max_jint);
1431 
1432 #ifdef ASSERT
1433             jint l_contentions = take-&gt;contentions();
1434 #endif
1435             assert(l_contentions &gt;= 0, &quot;must not be negative: l_contentions=%d, contentions=%d&quot;,
1436                    l_contentions, take-&gt;contentions());
1437           }
1438         }
1439         take-&gt;Recycle();
1440         // Since we&#39;re taking from the global free-list, take must be Free.
1441         // om_release() also sets the allocation state to Free because it
1442         // is called from other code paths.
1443         assert(take-&gt;is_free(), &quot;invariant&quot;);
1444         om_release(self, take, false);
1445       }
1446       self-&gt;om_free_provision += 1 + (self-&gt;om_free_provision / 2);
1447       if (self-&gt;om_free_provision &gt; MAXPRIVATE) self-&gt;om_free_provision = MAXPRIVATE;
1448       continue;
1449     }
1450 
1451     // 3: allocate a block of new ObjectMonitors
1452     // Both the local and global free lists are empty -- resort to malloc().
1453     // In the current implementation ObjectMonitors are TSM - immortal.
1454     // Ideally, we&#39;d write &quot;new ObjectMonitor[_BLOCKSIZE], but we want
1455     // each ObjectMonitor to start at the beginning of a cache line,
1456     // so we use align_up().
1457     // A better solution would be to use C++ placement-new.
1458     // BEWARE: As it stands currently, we don&#39;t run the ctors!
1459     assert(_BLOCKSIZE &gt; 1, &quot;invariant&quot;);
1460     size_t neededsize = sizeof(PaddedObjectMonitor) * _BLOCKSIZE;
1461     PaddedObjectMonitor* temp;
1462     size_t aligned_size = neededsize + (OM_CACHE_LINE_SIZE - 1);
1463     void* real_malloc_addr = NEW_C_HEAP_ARRAY(char, aligned_size, mtInternal);
1464     temp = (PaddedObjectMonitor*)align_up(real_malloc_addr, OM_CACHE_LINE_SIZE);
1465     (void)memset((void *) temp, 0, neededsize);
1466 
1467     // Format the block.
1468     // initialize the linked list, each monitor points to its next
1469     // forming the single linked free list, the very first monitor
1470     // will points to next block, which forms the block list.
1471     // The trick of using the 1st element in the block as g_block_list
1472     // linkage should be reconsidered.  A better implementation would
1473     // look like: class Block { Block * next; int N; ObjectMonitor Body [N] ; }
1474 
1475     for (int i = 1; i &lt; _BLOCKSIZE; i++) {
1476       temp[i].set_next_om((ObjectMonitor*)&amp;temp[i + 1]);
1477       assert(temp[i].is_free(), &quot;invariant&quot;);
1478     }
1479 
1480     // terminate the last monitor as the end of list
1481     temp[_BLOCKSIZE - 1].set_next_om((ObjectMonitor*)NULL);
1482 
1483     // Element [0] is reserved for global list linkage
1484     temp[0].set_object(CHAINMARKER);
1485 
1486     // Consider carving out this thread&#39;s current request from the
1487     // block in hand.  This avoids some lock traffic and redundant
1488     // list activity.
1489 
1490     prepend_block_to_lists(temp);
1491   }
1492 }
1493 
1494 // Place &quot;m&quot; on the caller&#39;s private per-thread om_free_list.
1495 // In practice there&#39;s no need to clamp or limit the number of
1496 // monitors on a thread&#39;s om_free_list as the only non-allocation time
1497 // we&#39;ll call om_release() is to return a monitor to the free list after
1498 // a CAS attempt failed. This doesn&#39;t allow unbounded #s of monitors to
1499 // accumulate on a thread&#39;s free list.
1500 //
1501 // Key constraint: all ObjectMonitors on a thread&#39;s free list and the global
1502 // free list must have their object field set to null. This prevents the
1503 // scavenger -- deflate_monitor_list() or deflate_monitor_list_using_JT()
1504 // -- from reclaiming them while we are trying to release them.
1505 
1506 void ObjectSynchronizer::om_release(Thread* self, ObjectMonitor* m,
1507                                     bool from_per_thread_alloc) {
1508   guarantee(m-&gt;header().value() == 0, &quot;invariant&quot;);
1509   guarantee(m-&gt;object() == NULL, &quot;invariant&quot;);
1510   NoSafepointVerifier nsv;
1511 
1512   if ((m-&gt;is_busy() | m-&gt;_recursions) != 0) {
1513     stringStream ss;
1514     fatal(&quot;freeing in-use monitor: %s, recursions=&quot; INTX_FORMAT,
1515           m-&gt;is_busy_to_string(&amp;ss), m-&gt;_recursions);
1516   }
1517   m-&gt;set_allocation_state(ObjectMonitor::Free);
1518   // _next_om is used for both per-thread in-use and free lists so
1519   // we have to remove &#39;m&#39; from the in-use list first (as needed).
1520   if (from_per_thread_alloc) {
1521     // Need to remove &#39;m&#39; from om_in_use_list.
1522     ObjectMonitor* mid = NULL;
1523     ObjectMonitor* next = NULL;
1524 
1525     // This list walk can race with another list walker or with async
1526     // deflation so we have to worry about an ObjectMonitor being
1527     // removed from this list while we are walking it.
1528 
1529     // Lock the list head to avoid racing with another list walker
1530     // or with async deflation.
1531     if ((mid = get_list_head_locked(&amp;self-&gt;om_in_use_list)) == NULL) {
1532       fatal(&quot;thread=&quot; INTPTR_FORMAT &quot; in-use list must not be empty.&quot;, p2i(self));
1533     }
1534     next = unmarked_next(mid);
1535     if (m == mid) {
1536       // First special case:
1537       // &#39;m&#39; matches mid, is the list head and is locked. Switch the list
1538       // head to next which unlocks the list head, but leaves the extracted
1539       // mid locked:
1540       Atomic::store(&amp;self-&gt;om_in_use_list, next);
1541     } else if (m == next) {
1542       // Second special case:
1543       // &#39;m&#39; matches next after the list head and we already have the list
1544       // head locked so set mid to what we are extracting:
1545       mid = next;
1546       // Lock mid to prevent races with a list walker or an async
1547       // deflater thread that&#39;s ahead of us. The locked list head
1548       // prevents races from behind us.
1549       om_lock(mid);
1550       // Update next to what follows mid (if anything):
1551       next = unmarked_next(mid);
1552       // Switch next after the list head to new next which unlocks the
1553       // list head, but leaves the extracted mid locked:
1554       self-&gt;om_in_use_list-&gt;set_next_om(next);
1555     } else {
1556       // We have to search the list to find &#39;m&#39;.
1557       guarantee(next != NULL, &quot;thread=&quot; INTPTR_FORMAT &quot;: om_in_use_list=&quot; INTPTR_FORMAT
1558                 &quot; is too short.&quot;, p2i(self), p2i(self-&gt;om_in_use_list));
1559       // Our starting anchor is next after the list head which is the
1560       // last ObjectMonitor we checked:
1561       ObjectMonitor* anchor = next;
1562       // Lock anchor to prevent races with a list walker or an async
1563       // deflater thread that&#39;s ahead of us. The locked list head
1564       // prevents races from behind us.
1565       om_lock(anchor);
1566       om_unlock(mid);  // Unlock the list head now that anchor is locked.
1567       while ((mid = unmarked_next(anchor)) != NULL) {
1568         if (m == mid) {
1569           // We found &#39;m&#39; on the per-thread in-use list so extract it.
1570           // Update next to what follows mid (if anything):
1571           next = unmarked_next(mid);
1572           // Switch next after the anchor to new next which unlocks the
1573           // anchor, but leaves the extracted mid locked:
1574           anchor-&gt;set_next_om(next);
1575           break;
1576         } else {
1577           // Lock the next anchor to prevent races with a list walker
1578           // or an async deflater thread that&#39;s ahead of us. The locked
1579           // current anchor prevents races from behind us.
1580           om_lock(mid);
1581           // Unlock current anchor now that next anchor is locked:
1582           om_unlock(anchor);
1583           anchor = mid;  // Advance to new anchor and try again.
1584         }
1585       }
1586     }
1587 
1588     if (mid == NULL) {
1589       // Reached end of the list and didn&#39;t find &#39;m&#39; so:
1590       fatal(&quot;thread=&quot; INTPTR_FORMAT &quot; must find m=&quot; INTPTR_FORMAT &quot;on om_in_use_list=&quot;
1591             INTPTR_FORMAT, p2i(self), p2i(m), p2i(self-&gt;om_in_use_list));
1592     }
1593 
1594     // At this point mid is disconnected from the in-use list so
1595     // its lock no longer has any effects on the in-use list.
1596     Atomic::dec(&amp;self-&gt;om_in_use_count);
1597     // Unlock mid, but leave the next value for any lagging list
1598     // walkers. It will get cleaned up when mid is prepended to
1599     // the thread&#39;s free list:
1600     om_unlock(mid);
1601   }
1602 
1603   prepend_to_om_free_list(self, m);
1604   guarantee(m-&gt;is_free(), &quot;invariant&quot;);
1605 }
1606 
1607 // Return ObjectMonitors on a moribund thread&#39;s free and in-use
1608 // lists to the appropriate global lists. The ObjectMonitors on the
1609 // per-thread in-use list may still be in use by other threads.
1610 //
1611 // We currently call om_flush() from Threads::remove() before the
1612 // thread has been excised from the thread list and is no longer a
1613 // mutator. This means that om_flush() cannot run concurrently with
1614 // a safepoint and interleave with deflate_idle_monitors(). In
1615 // particular, this ensures that the thread&#39;s in-use monitors are
1616 // scanned by a GC safepoint, either via Thread::oops_do() (before
1617 // om_flush() is called) or via ObjectSynchronizer::oops_do() (after
1618 // om_flush() is called).
1619 //
1620 // With AsyncDeflateIdleMonitors, deflate_global_idle_monitors_using_JT()
1621 // and deflate_per_thread_idle_monitors_using_JT() (in another thread) can
1622 // run at the same time as om_flush() so we have to follow a careful
1623 // protocol to prevent list corruption.
1624 
1625 void ObjectSynchronizer::om_flush(Thread* self) {
1626   // Process the per-thread in-use list first to be consistent.
1627   int in_use_count = 0;
1628   ObjectMonitor* in_use_list = NULL;
1629   ObjectMonitor* in_use_tail = NULL;
1630   NoSafepointVerifier nsv;
1631 
1632   // This function can race with a list walker or with an async
1633   // deflater thread so we lock the list head to prevent confusion.
1634   // An async deflater thread checks to see if the target thread
1635   // is exiting, but if it has made it past that check before we
1636   // started exiting, then it is racing to get to the in-use list.
1637   if ((in_use_list = get_list_head_locked(&amp;self-&gt;om_in_use_list)) != NULL) {
1638     // At this point, we have locked the in-use list head so a racing
1639     // thread cannot come in after us. However, a racing thread could
1640     // be ahead of us; we&#39;ll detect that and delay to let it finish.
1641     //
1642     // The thread is going away, however the ObjectMonitors on the
1643     // om_in_use_list may still be in-use by other threads. Link
1644     // them to in_use_tail, which will be linked into the global
1645     // in-use list (om_list_globals._in_use_list) below.
1646     //
1647     // Account for the in-use list head before the loop since it is
1648     // already locked (by this thread):
1649     in_use_tail = in_use_list;
1650     in_use_count++;
1651     for (ObjectMonitor* cur_om = unmarked_next(in_use_list); cur_om != NULL;) {
1652       if (is_locked(cur_om)) {
1653         // cur_om is locked so there must be a racing walker or async
1654         // deflater thread ahead of us so we&#39;ll give it a chance to finish.
1655         while (is_locked(cur_om)) {
1656           os::naked_short_sleep(1);
1657         }
1658         // Refetch the possibly changed next field and try again.
1659         cur_om = unmarked_next(in_use_tail);
1660         continue;
1661       }
1662       if (cur_om-&gt;object() == NULL) {
1663         // cur_om was deflated and the object ref was cleared while it
1664         // was locked. We happened to see it just after it was unlocked
1665         // (and added to the free list). Refetch the possibly changed
1666         // next field and try again.
1667         cur_om = unmarked_next(in_use_tail);
1668         continue;
1669       }
1670       in_use_tail = cur_om;
1671       in_use_count++;
1672       cur_om = unmarked_next(cur_om);
1673     }
1674     guarantee(in_use_tail != NULL, &quot;invariant&quot;);
1675     int l_om_in_use_count = Atomic::load(&amp;self-&gt;om_in_use_count);
1676     ADIM_guarantee(l_om_in_use_count == in_use_count, &quot;in-use counts don&#39;t match: &quot;
1677                    &quot;l_om_in_use_count=%d, in_use_count=%d&quot;, l_om_in_use_count, in_use_count);
1678     Atomic::store(&amp;self-&gt;om_in_use_count, 0);
1679     // Clear the in-use list head (which also unlocks it):
1680     Atomic::store(&amp;self-&gt;om_in_use_list, (ObjectMonitor*)NULL);
1681     om_unlock(in_use_list);
1682   }
1683 
1684   int free_count = 0;
1685   ObjectMonitor* free_list = NULL;
1686   ObjectMonitor* free_tail = NULL;
1687   // This function can race with a list walker thread so we lock the
1688   // list head to prevent confusion.
1689   if ((free_list = get_list_head_locked(&amp;self-&gt;om_free_list)) != NULL) {
1690     // At this point, we have locked the free list head so a racing
1691     // thread cannot come in after us. However, a racing thread could
1692     // be ahead of us; we&#39;ll detect that and delay to let it finish.
1693     //
1694     // The thread is going away. Set &#39;free_tail&#39; to the last per-thread free
1695     // monitor which will be linked to om_list_globals._free_list below.
1696     //
1697     // Account for the free list head before the loop since it is
1698     // already locked (by this thread):
1699     free_tail = free_list;
1700     free_count++;
1701     for (ObjectMonitor* s = unmarked_next(free_list); s != NULL; s = unmarked_next(s)) {
1702       if (is_locked(s)) {
1703         // s is locked so there must be a racing walker thread ahead
1704         // of us so we&#39;ll give it a chance to finish.
1705         while (is_locked(s)) {
1706           os::naked_short_sleep(1);
1707         }
1708       }
1709       free_tail = s;
1710       free_count++;
1711       guarantee(s-&gt;object() == NULL, &quot;invariant&quot;);
1712       if (s-&gt;is_busy()) {
1713         stringStream ss;
1714         fatal(&quot;must be !is_busy: %s&quot;, s-&gt;is_busy_to_string(&amp;ss));
1715       }
1716     }
1717     guarantee(free_tail != NULL, &quot;invariant&quot;);
1718     int l_om_free_count = Atomic::load(&amp;self-&gt;om_free_count);
1719     ADIM_guarantee(l_om_free_count == free_count, &quot;free counts don&#39;t match: &quot;
1720                    &quot;l_om_free_count=%d, free_count=%d&quot;, l_om_free_count, free_count);
1721     Atomic::store(&amp;self-&gt;om_free_count, 0);
1722     Atomic::store(&amp;self-&gt;om_free_list, (ObjectMonitor*)NULL);
1723     om_unlock(free_list);
1724   }
1725 
1726   if (free_tail != NULL) {
1727     prepend_list_to_global_free_list(free_list, free_tail, free_count);
1728   }
1729 
1730   if (in_use_tail != NULL) {
1731     prepend_list_to_global_in_use_list(in_use_list, in_use_tail, in_use_count);
1732   }
1733 
1734   LogStreamHandle(Debug, monitorinflation) lsh_debug;
1735   LogStreamHandle(Info, monitorinflation) lsh_info;
1736   LogStream* ls = NULL;
1737   if (log_is_enabled(Debug, monitorinflation)) {
1738     ls = &amp;lsh_debug;
1739   } else if ((free_count != 0 || in_use_count != 0) &amp;&amp;
1740              log_is_enabled(Info, monitorinflation)) {
1741     ls = &amp;lsh_info;
1742   }
1743   if (ls != NULL) {
1744     ls-&gt;print_cr(&quot;om_flush: jt=&quot; INTPTR_FORMAT &quot;, free_count=%d&quot;
1745                  &quot;, in_use_count=%d&quot; &quot;, om_free_provision=%d&quot;,
1746                  p2i(self), free_count, in_use_count, self-&gt;om_free_provision);
1747   }
1748 }
1749 
1750 static void post_monitor_inflate_event(EventJavaMonitorInflate* event,
1751                                        const oop obj,
1752                                        ObjectSynchronizer::InflateCause cause) {
1753   assert(event != NULL, &quot;invariant&quot;);
1754   assert(event-&gt;should_commit(), &quot;invariant&quot;);
1755   event-&gt;set_monitorClass(obj-&gt;klass());
1756   event-&gt;set_address((uintptr_t)(void*)obj);
1757   event-&gt;set_cause((u1)cause);
1758   event-&gt;commit();
1759 }
1760 
1761 // Fast path code shared by multiple functions
1762 void ObjectSynchronizer::inflate_helper(oop obj) {
1763   markWord mark = obj-&gt;mark();
1764   if (mark.has_monitor()) {
1765     ObjectMonitor* monitor = mark.monitor();
1766     assert(ObjectSynchronizer::verify_objmon_isinpool(monitor), &quot;monitor=&quot; INTPTR_FORMAT &quot; is invalid&quot;, p2i(monitor));
1767     markWord dmw = monitor-&gt;header();
1768     assert(dmw.is_neutral(), &quot;sanity check: header=&quot; INTPTR_FORMAT, dmw.value());
1769     return;
1770   }
1771   (void)inflate(Thread::current(), obj, inflate_cause_vm_internal);
1772 }
1773 
1774 ObjectMonitor* ObjectSynchronizer::inflate(Thread* self, oop object,
1775                                            const InflateCause cause) {
1776   // Inflate mutates the heap ...
1777   // Relaxing assertion for bug 6320749.
1778   assert(Universe::verify_in_progress() ||
1779          !SafepointSynchronize::is_at_safepoint(), &quot;invariant&quot;);
1780 
<a name="17" id="anc17"></a>



1781   EventJavaMonitorInflate event;
1782 
1783   for (;;) {
1784     const markWord mark = object-&gt;mark();
1785     assert(!mark.has_bias_pattern(), &quot;invariant&quot;);
1786 
1787     // The mark can be in one of the following states:
1788     // *  Inflated     - just return
1789     // *  Stack-locked - coerce it to inflated
1790     // *  INFLATING    - busy wait for conversion to complete
1791     // *  Neutral      - aggressively inflate the object.
1792     // *  BIASED       - Illegal.  We should never see this
1793 
1794     // CASE: inflated
1795     if (mark.has_monitor()) {
1796       ObjectMonitor* inf = mark.monitor();
1797       markWord dmw = inf-&gt;header();
1798       assert(dmw.is_neutral(), &quot;invariant: header=&quot; INTPTR_FORMAT, dmw.value());
1799       assert(AsyncDeflateIdleMonitors || inf-&gt;object() == object, &quot;invariant&quot;);
1800       assert(ObjectSynchronizer::verify_objmon_isinpool(inf), &quot;monitor is invalid&quot;);
1801       return inf;
1802     }
1803 
1804     // CASE: inflation in progress - inflating over a stack-lock.
1805     // Some other thread is converting from stack-locked to inflated.
1806     // Only that thread can complete inflation -- other threads must wait.
1807     // The INFLATING value is transient.
1808     // Currently, we spin/yield/park and poll the markword, waiting for inflation to finish.
1809     // We could always eliminate polling by parking the thread on some auxiliary list.
1810     if (mark == markWord::INFLATING()) {
1811       read_stable_mark(object);
1812       continue;
1813     }
1814 
1815     // CASE: stack-locked
1816     // Could be stack-locked either by this thread or by some other thread.
1817     //
1818     // Note that we allocate the objectmonitor speculatively, _before_ attempting
1819     // to install INFLATING into the mark word.  We originally installed INFLATING,
1820     // allocated the objectmonitor, and then finally STed the address of the
1821     // objectmonitor into the mark.  This was correct, but artificially lengthened
1822     // the interval in which INFLATED appeared in the mark, thus increasing
1823     // the odds of inflation contention.
1824     //
1825     // We now use per-thread private objectmonitor free lists.
1826     // These list are reprovisioned from the global free list outside the
1827     // critical INFLATING...ST interval.  A thread can transfer
1828     // multiple objectmonitors en-mass from the global free list to its local free list.
1829     // This reduces coherency traffic and lock contention on the global free list.
1830     // Using such local free lists, it doesn&#39;t matter if the om_alloc() call appears
1831     // before or after the CAS(INFLATING) operation.
1832     // See the comments in om_alloc().
1833 
1834     LogStreamHandle(Trace, monitorinflation) lsh;
1835 
1836     if (mark.has_locker()) {
1837       ObjectMonitor* m = om_alloc(self);
1838       // Optimistically prepare the objectmonitor - anticipate successful CAS
1839       // We do this before the CAS in order to minimize the length of time
1840       // in which INFLATING appears in the mark.
1841       m-&gt;Recycle();
1842       m-&gt;_Responsible  = NULL;
1843       m-&gt;_SpinDuration = ObjectMonitor::Knob_SpinLimit;   // Consider: maintain by type/class
1844 
1845       markWord cmp = object-&gt;cas_set_mark(markWord::INFLATING(), mark);
1846       if (cmp != mark) {
1847         // om_release() will reset the allocation state from New to Free.
1848         om_release(self, m, true);
1849         continue;       // Interference -- just retry
1850       }
1851 
1852       // We&#39;ve successfully installed INFLATING (0) into the mark-word.
1853       // This is the only case where 0 will appear in a mark-word.
1854       // Only the singular thread that successfully swings the mark-word
1855       // to 0 can perform (or more precisely, complete) inflation.
1856       //
1857       // Why do we CAS a 0 into the mark-word instead of just CASing the
1858       // mark-word from the stack-locked value directly to the new inflated state?
1859       // Consider what happens when a thread unlocks a stack-locked object.
1860       // It attempts to use CAS to swing the displaced header value from the
1861       // on-stack BasicLock back into the object header.  Recall also that the
1862       // header value (hash code, etc) can reside in (a) the object header, or
1863       // (b) a displaced header associated with the stack-lock, or (c) a displaced
1864       // header in an ObjectMonitor.  The inflate() routine must copy the header
1865       // value from the BasicLock on the owner&#39;s stack to the ObjectMonitor, all
1866       // the while preserving the hashCode stability invariants.  If the owner
1867       // decides to release the lock while the value is 0, the unlock will fail
1868       // and control will eventually pass from slow_exit() to inflate.  The owner
1869       // will then spin, waiting for the 0 value to disappear.   Put another way,
1870       // the 0 causes the owner to stall if the owner happens to try to
1871       // drop the lock (restoring the header from the BasicLock to the object)
1872       // while inflation is in-progress.  This protocol avoids races that might
1873       // would otherwise permit hashCode values to change or &quot;flicker&quot; for an object.
1874       // Critically, while object-&gt;mark is 0 mark.displaced_mark_helper() is stable.
1875       // 0 serves as a &quot;BUSY&quot; inflate-in-progress indicator.
1876 
1877 
1878       // fetch the displaced mark from the owner&#39;s stack.
1879       // The owner can&#39;t die or unwind past the lock while our INFLATING
1880       // object is in the mark.  Furthermore the owner can&#39;t complete
1881       // an unlock on the object, either.
1882       markWord dmw = mark.displaced_mark_helper();
1883       // Catch if the object&#39;s header is not neutral (not locked and
1884       // not marked is what we care about here).
1885       ADIM_guarantee(dmw.is_neutral(), &quot;invariant: header=&quot; INTPTR_FORMAT, dmw.value());
1886 
1887       // Setup monitor fields to proper values -- prepare the monitor
1888       m-&gt;set_header(dmw);
1889 
1890       // Optimization: if the mark.locker stack address is associated
1891       // with this thread we could simply set m-&gt;_owner = self.
1892       // Note that a thread can inflate an object
1893       // that it has stack-locked -- as might happen in wait() -- directly
1894       // with CAS.  That is, we can avoid the xchg-NULL .... ST idiom.
1895       if (AsyncDeflateIdleMonitors) {
1896         m-&gt;set_owner_from(NULL, DEFLATER_MARKER, mark.locker());
1897       } else {
1898         m-&gt;set_owner_from(NULL, mark.locker());
1899       }
1900       m-&gt;set_object(object);
1901       // TODO-FIXME: assert BasicLock-&gt;dhw != 0.
1902 
1903       // Must preserve store ordering. The monitor state must
1904       // be stable at the time of publishing the monitor address.
1905       guarantee(object-&gt;mark() == markWord::INFLATING(), &quot;invariant&quot;);
1906       object-&gt;release_set_mark(markWord::encode(m));
1907 
1908       // Once ObjectMonitor is configured and the object is associated
1909       // with the ObjectMonitor, it is safe to allow async deflation:
1910       assert(m-&gt;is_new(), &quot;freshly allocated monitor must be new&quot;);
1911       m-&gt;set_allocation_state(ObjectMonitor::Old);
1912 
1913       // Hopefully the performance counters are allocated on distinct cache lines
1914       // to avoid false sharing on MP systems ...
1915       OM_PERFDATA_OP(Inflations, inc());
1916       if (log_is_enabled(Trace, monitorinflation)) {
1917         ResourceMark rm(self);
1918         lsh.print_cr(&quot;inflate(has_locker): object=&quot; INTPTR_FORMAT &quot;, mark=&quot;
1919                      INTPTR_FORMAT &quot;, type=&#39;%s&#39;&quot;, p2i(object),
1920                      object-&gt;mark().value(), object-&gt;klass()-&gt;external_name());
1921       }
1922       if (event.should_commit()) {
1923         post_monitor_inflate_event(&amp;event, object, cause);
1924       }
1925       return m;
1926     }
1927 
1928     // CASE: neutral
1929     // TODO-FIXME: for entry we currently inflate and then try to CAS _owner.
1930     // If we know we&#39;re inflating for entry it&#39;s better to inflate by swinging a
1931     // pre-locked ObjectMonitor pointer into the object header.   A successful
1932     // CAS inflates the object *and* confers ownership to the inflating thread.
1933     // In the current implementation we use a 2-step mechanism where we CAS()
1934     // to inflate and then CAS() again to try to swing _owner from NULL to self.
1935     // An inflateTry() method that we could call from enter() would be useful.
1936 
1937     // Catch if the object&#39;s header is not neutral (not locked and
1938     // not marked is what we care about here).
1939     ADIM_guarantee(mark.is_neutral(), &quot;invariant: header=&quot; INTPTR_FORMAT, mark.value());
1940     ObjectMonitor* m = om_alloc(self);
1941     // prepare m for installation - set monitor to initial state
1942     m-&gt;Recycle();
1943     m-&gt;set_header(mark);
1944     if (AsyncDeflateIdleMonitors) {
1945       // DEFLATER_MARKER is the only non-NULL value we should see here.
1946       m-&gt;try_set_owner_from(DEFLATER_MARKER, NULL);
1947     }
1948     m-&gt;set_object(object);
1949     m-&gt;_Responsible  = NULL;
1950     m-&gt;_SpinDuration = ObjectMonitor::Knob_SpinLimit;       // consider: keep metastats by type/class
1951 
1952     if (object-&gt;cas_set_mark(markWord::encode(m), mark) != mark) {
1953       m-&gt;set_header(markWord::zero());
1954       m-&gt;set_object(NULL);
1955       m-&gt;Recycle();
1956       // om_release() will reset the allocation state from New to Free.
1957       om_release(self, m, true);
1958       m = NULL;
1959       continue;
1960       // interference - the markword changed - just retry.
1961       // The state-transitions are one-way, so there&#39;s no chance of
1962       // live-lock -- &quot;Inflated&quot; is an absorbing state.
1963     }
1964 
1965     // Once the ObjectMonitor is configured and object is associated
1966     // with the ObjectMonitor, it is safe to allow async deflation:
1967     assert(m-&gt;is_new(), &quot;freshly allocated monitor must be new&quot;);
1968     m-&gt;set_allocation_state(ObjectMonitor::Old);
1969 
1970     // Hopefully the performance counters are allocated on distinct
1971     // cache lines to avoid false sharing on MP systems ...
1972     OM_PERFDATA_OP(Inflations, inc());
1973     if (log_is_enabled(Trace, monitorinflation)) {
1974       ResourceMark rm(self);
1975       lsh.print_cr(&quot;inflate(neutral): object=&quot; INTPTR_FORMAT &quot;, mark=&quot;
1976                    INTPTR_FORMAT &quot;, type=&#39;%s&#39;&quot;, p2i(object),
1977                    object-&gt;mark().value(), object-&gt;klass()-&gt;external_name());
1978     }
1979     if (event.should_commit()) {
1980       post_monitor_inflate_event(&amp;event, object, cause);
1981     }
1982     return m;
1983   }
1984 }
1985 
1986 
1987 // We maintain a list of in-use monitors for each thread.
1988 //
1989 // For safepoint based deflation:
1990 // deflate_thread_local_monitors() scans a single thread&#39;s in-use list, while
1991 // deflate_idle_monitors() scans only a global list of in-use monitors which
1992 // is populated only as a thread dies (see om_flush()).
1993 //
1994 // These operations are called at all safepoints, immediately after mutators
1995 // are stopped, but before any objects have moved. Collectively they traverse
1996 // the population of in-use monitors, deflating where possible. The scavenged
1997 // monitors are returned to the global monitor free list.
1998 //
1999 // Beware that we scavenge at *every* stop-the-world point. Having a large
2000 // number of monitors in-use could negatively impact performance. We also want
2001 // to minimize the total # of monitors in circulation, as they incur a small
2002 // footprint penalty.
2003 //
2004 // Perversely, the heap size -- and thus the STW safepoint rate --
2005 // typically drives the scavenge rate.  Large heaps can mean infrequent GC,
2006 // which in turn can mean large(r) numbers of ObjectMonitors in circulation.
2007 // This is an unfortunate aspect of this design.
2008 //
2009 // For async deflation:
2010 // If a special deflation request is made, then the safepoint based
2011 // deflation mechanism is used. Otherwise, an async deflation request
2012 // is registered with the ServiceThread and it is notified.
2013 
2014 void ObjectSynchronizer::do_safepoint_work(DeflateMonitorCounters* counters) {
2015   assert(SafepointSynchronize::is_at_safepoint(), &quot;must be at safepoint&quot;);
2016 
2017   // The per-thread in-use lists are handled in
2018   // ParallelSPCleanupThreadClosure::do_thread().
2019 
2020   if (!AsyncDeflateIdleMonitors || is_special_deflation_requested()) {
2021     // Use the older mechanism for the global in-use list or if a
2022     // special deflation has been requested before the safepoint.
2023     ObjectSynchronizer::deflate_idle_monitors(counters);
2024     return;
2025   }
2026 
2027   log_debug(monitorinflation)(&quot;requesting async deflation of idle monitors.&quot;);
2028   // Request deflation of idle monitors by the ServiceThread:
2029   set_is_async_deflation_requested(true);
2030   MonitorLocker ml(Service_lock, Mutex::_no_safepoint_check_flag);
2031   ml.notify_all();
2032 
2033   if (log_is_enabled(Debug, monitorinflation)) {
2034     // exit_globals()&#39;s call to audit_and_print_stats() is done
2035     // at the Info level and not at a safepoint.
2036     // For safepoint based deflation, audit_and_print_stats() is called
2037     // in ObjectSynchronizer::finish_deflate_idle_monitors() at the
2038     // Debug level at a safepoint.
2039     ObjectSynchronizer::audit_and_print_stats(false /* on_exit */);
2040   }
2041 }
2042 
2043 // Deflate a single monitor if not in-use
2044 // Return true if deflated, false if in-use
2045 bool ObjectSynchronizer::deflate_monitor(ObjectMonitor* mid, oop obj,
2046                                          ObjectMonitor** free_head_p,
2047                                          ObjectMonitor** free_tail_p) {
2048   bool deflated;
2049   // Normal case ... The monitor is associated with obj.
2050   const markWord mark = obj-&gt;mark();
2051   guarantee(mark == markWord::encode(mid), &quot;should match: mark=&quot;
2052             INTPTR_FORMAT &quot;, encoded mid=&quot; INTPTR_FORMAT, mark.value(),
2053             markWord::encode(mid).value());
2054   // Make sure that mark.monitor() and markWord::encode() agree:
2055   guarantee(mark.monitor() == mid, &quot;should match: monitor()=&quot; INTPTR_FORMAT
2056             &quot;, mid=&quot; INTPTR_FORMAT, p2i(mark.monitor()), p2i(mid));
2057   const markWord dmw = mid-&gt;header();
2058   guarantee(dmw.is_neutral(), &quot;invariant: header=&quot; INTPTR_FORMAT, dmw.value());
2059 
2060   if (mid-&gt;is_busy()) {
2061     // Easy checks are first - the ObjectMonitor is busy so no deflation.
2062     deflated = false;
2063   } else {
2064     // Deflate the monitor if it is no longer being used
2065     // It&#39;s idle - scavenge and return to the global free list
2066     // plain old deflation ...
2067     if (log_is_enabled(Trace, monitorinflation)) {
2068       ResourceMark rm;
2069       log_trace(monitorinflation)(&quot;deflate_monitor: &quot;
2070                                   &quot;object=&quot; INTPTR_FORMAT &quot;, mark=&quot;
2071                                   INTPTR_FORMAT &quot;, type=&#39;%s&#39;&quot;, p2i(obj),
2072                                   mark.value(), obj-&gt;klass()-&gt;external_name());
2073     }
2074 
2075     // Restore the header back to obj
2076     obj-&gt;release_set_mark(dmw);
2077     if (AsyncDeflateIdleMonitors) {
2078       // clear() expects the owner field to be NULL.
2079       // DEFLATER_MARKER is the only non-NULL value we should see here.
2080       mid-&gt;try_set_owner_from(DEFLATER_MARKER, NULL);
2081     }
2082     mid-&gt;clear();
2083 
2084     assert(mid-&gt;object() == NULL, &quot;invariant: object=&quot; INTPTR_FORMAT,
2085            p2i(mid-&gt;object()));
2086     assert(mid-&gt;is_free(), &quot;invariant&quot;);
2087 
2088     // Move the deflated ObjectMonitor to the working free list
2089     // defined by free_head_p and free_tail_p.
2090     if (*free_head_p == NULL) *free_head_p = mid;
2091     if (*free_tail_p != NULL) {
2092       // We append to the list so the caller can use mid-&gt;_next_om
2093       // to fix the linkages in its context.
2094       ObjectMonitor* prevtail = *free_tail_p;
2095       // Should have been cleaned up by the caller:
2096       // Note: Should not have to lock prevtail here since we&#39;re at a
2097       // safepoint and ObjectMonitors on the local free list should
2098       // not be accessed in parallel.
2099 #ifdef ASSERT
2100       ObjectMonitor* l_next_om = prevtail-&gt;next_om();
2101 #endif
2102       assert(l_next_om == NULL, &quot;must be NULL: _next_om=&quot; INTPTR_FORMAT, p2i(l_next_om));
2103       prevtail-&gt;set_next_om(mid);
2104     }
2105     *free_tail_p = mid;
2106     // At this point, mid-&gt;_next_om still refers to its current
2107     // value and another ObjectMonitor&#39;s _next_om field still
2108     // refers to this ObjectMonitor. Those linkages have to be
2109     // cleaned up by the caller who has the complete context.
2110     deflated = true;
2111   }
2112   return deflated;
2113 }
2114 
2115 // Deflate the specified ObjectMonitor if not in-use using a JavaThread.
2116 // Returns true if it was deflated and false otherwise.
2117 //
2118 // The async deflation protocol sets owner to DEFLATER_MARKER and
2119 // makes contentions negative as signals to contending threads that
2120 // an async deflation is in progress. There are a number of checks
2121 // as part of the protocol to make sure that the calling thread has
2122 // not lost the race to a contending thread.
2123 //
2124 // The ObjectMonitor has been successfully async deflated when:
2125 //   (contentions &lt; 0)
2126 // Contending threads that see that condition know to retry their operation.
2127 //
2128 bool ObjectSynchronizer::deflate_monitor_using_JT(ObjectMonitor* mid,
2129                                                   ObjectMonitor** free_head_p,
2130                                                   ObjectMonitor** free_tail_p) {
2131   assert(AsyncDeflateIdleMonitors, &quot;sanity check&quot;);
2132   assert(Thread::current()-&gt;is_Java_thread(), &quot;precondition&quot;);
2133   // A newly allocated ObjectMonitor should not be seen here so we
2134   // avoid an endless inflate/deflate cycle.
2135   assert(mid-&gt;is_old(), &quot;must be old: allocation_state=%d&quot;,
2136          (int) mid-&gt;allocation_state());
2137 
2138   if (mid-&gt;is_busy()) {
2139     // Easy checks are first - the ObjectMonitor is busy so no deflation.
2140     return false;
2141   }
2142 
2143   // Set a NULL owner to DEFLATER_MARKER to force any contending thread
2144   // through the slow path. This is just the first part of the async
2145   // deflation dance.
2146   if (mid-&gt;try_set_owner_from(NULL, DEFLATER_MARKER) != NULL) {
2147     // The owner field is no longer NULL so we lost the race since the
2148     // ObjectMonitor is now busy.
2149     return false;
2150   }
2151 
2152   if (mid-&gt;contentions() &gt; 0 || mid-&gt;_waiters != 0) {
2153     // Another thread has raced to enter the ObjectMonitor after
2154     // mid-&gt;is_busy() above or has already entered and waited on
2155     // it which makes it busy so no deflation. Restore owner to
2156     // NULL if it is still DEFLATER_MARKER.
2157     if (mid-&gt;try_set_owner_from(DEFLATER_MARKER, NULL) != DEFLATER_MARKER) {
2158       // Deferred decrement for the JT EnterI() that cancelled the async deflation.
2159       mid-&gt;add_to_contentions(-1);
2160     }
2161     return false;
2162   }
2163 
2164   // Make a zero contentions field negative to force any contending threads
2165   // to retry. This is the second part of the async deflation dance.
2166   if (Atomic::cmpxchg(&amp;mid-&gt;_contentions, (jint)0, -max_jint) != 0) {
2167     // Contentions was no longer 0 so we lost the race since the
2168     // ObjectMonitor is now busy. Restore owner to NULL if it is
2169     // still DEFLATER_MARKER:
2170     if (mid-&gt;try_set_owner_from(DEFLATER_MARKER, NULL) != DEFLATER_MARKER) {
2171       // Deferred decrement for the JT EnterI() that cancelled the async deflation.
2172       mid-&gt;add_to_contentions(-1);
2173     }
2174     return false;
2175   }
2176 
2177   // Sanity checks for the races:
2178   guarantee(mid-&gt;owner_is_DEFLATER_MARKER(), &quot;must be deflater marker&quot;);
2179   guarantee(mid-&gt;contentions() &lt; 0, &quot;must be negative: contentions=%d&quot;,
2180             mid-&gt;contentions());
2181   guarantee(mid-&gt;_waiters == 0, &quot;must be 0: waiters=%d&quot;, mid-&gt;_waiters);
2182   guarantee(mid-&gt;_cxq == NULL, &quot;must be no contending threads: cxq=&quot;
2183             INTPTR_FORMAT, p2i(mid-&gt;_cxq));
2184   guarantee(mid-&gt;_EntryList == NULL,
2185             &quot;must be no entering threads: EntryList=&quot; INTPTR_FORMAT,
2186             p2i(mid-&gt;_EntryList));
2187 
2188   const oop obj = (oop) mid-&gt;object();
2189   if (log_is_enabled(Trace, monitorinflation)) {
2190     ResourceMark rm;
2191     log_trace(monitorinflation)(&quot;deflate_monitor_using_JT: &quot;
2192                                 &quot;object=&quot; INTPTR_FORMAT &quot;, mark=&quot;
2193                                 INTPTR_FORMAT &quot;, type=&#39;%s&#39;&quot;,
2194                                 p2i(obj), obj-&gt;mark().value(),
2195                                 obj-&gt;klass()-&gt;external_name());
2196   }
2197 
2198   // Install the old mark word if nobody else has already done it.
2199   mid-&gt;install_displaced_markword_in_object(obj);
2200   mid-&gt;clear_common();
2201 
2202   assert(mid-&gt;object() == NULL, &quot;must be NULL: object=&quot; INTPTR_FORMAT,
2203          p2i(mid-&gt;object()));
2204   assert(mid-&gt;is_free(), &quot;must be free: allocation_state=%d&quot;,
2205          (int)mid-&gt;allocation_state());
2206 
2207   // Move the deflated ObjectMonitor to the working free list
2208   // defined by free_head_p and free_tail_p.
2209   if (*free_head_p == NULL) {
2210     // First one on the list.
2211     *free_head_p = mid;
2212   }
2213   if (*free_tail_p != NULL) {
2214     // We append to the list so the caller can use mid-&gt;_next_om
2215     // to fix the linkages in its context.
2216     ObjectMonitor* prevtail = *free_tail_p;
2217     // prevtail should have been cleaned up by the caller:
2218 #ifdef ASSERT
2219     ObjectMonitor* l_next_om = unmarked_next(prevtail);
2220 #endif
2221     assert(l_next_om == NULL, &quot;must be NULL: _next_om=&quot; INTPTR_FORMAT, p2i(l_next_om));
2222     om_lock(prevtail);
2223     prevtail-&gt;set_next_om(mid);  // prevtail now points to mid (and is unlocked)
2224   }
2225   *free_tail_p = mid;
2226 
2227   // At this point, mid-&gt;_next_om still refers to its current
2228   // value and another ObjectMonitor&#39;s _next_om field still
2229   // refers to this ObjectMonitor. Those linkages have to be
2230   // cleaned up by the caller who has the complete context.
2231 
2232   // We leave owner == DEFLATER_MARKER and contentions &lt; 0
2233   // to force any racing threads to retry.
2234   return true;  // Success, ObjectMonitor has been deflated.
2235 }
2236 
2237 // Walk a given monitor list, and deflate idle monitors.
2238 // The given list could be a per-thread list or a global list.
2239 //
2240 // In the case of parallel processing of thread local monitor lists,
2241 // work is done by Threads::parallel_threads_do() which ensures that
2242 // each Java thread is processed by exactly one worker thread, and
2243 // thus avoid conflicts that would arise when worker threads would
2244 // process the same monitor lists concurrently.
2245 //
2246 // See also ParallelSPCleanupTask and
2247 // SafepointSynchronize::do_cleanup_tasks() in safepoint.cpp and
2248 // Threads::parallel_java_threads_do() in thread.cpp.
2249 int ObjectSynchronizer::deflate_monitor_list(ObjectMonitor** list_p,
2250                                              int* count_p,
2251                                              ObjectMonitor** free_head_p,
2252                                              ObjectMonitor** free_tail_p) {
2253   ObjectMonitor* cur_mid_in_use = NULL;
2254   ObjectMonitor* mid = NULL;
2255   ObjectMonitor* next = NULL;
2256   int deflated_count = 0;
2257 
2258   // This list walk executes at a safepoint and does not race with any
2259   // other list walkers.
2260 
2261   for (mid = Atomic::load(list_p); mid != NULL; mid = next) {
2262     next = unmarked_next(mid);
2263     oop obj = (oop) mid-&gt;object();
2264     if (obj != NULL &amp;&amp; deflate_monitor(mid, obj, free_head_p, free_tail_p)) {
2265       // Deflation succeeded and already updated free_head_p and
2266       // free_tail_p as needed. Finish the move to the local free list
2267       // by unlinking mid from the global or per-thread in-use list.
2268       if (cur_mid_in_use == NULL) {
2269         // mid is the list head so switch the list head to next:
2270         Atomic::store(list_p, next);
2271       } else {
2272         // Switch cur_mid_in_use&#39;s next field to next:
2273         cur_mid_in_use-&gt;set_next_om(next);
2274       }
2275       // At this point mid is disconnected from the in-use list.
2276       deflated_count++;
2277       Atomic::dec(count_p);
2278       // mid is current tail in the free_head_p list so NULL terminate it:
2279       mid-&gt;set_next_om(NULL);
2280     } else {
2281       cur_mid_in_use = mid;
2282     }
2283   }
2284   return deflated_count;
2285 }
2286 
2287 // Walk a given ObjectMonitor list and deflate idle ObjectMonitors using
2288 // a JavaThread. Returns the number of deflated ObjectMonitors. The given
2289 // list could be a per-thread in-use list or the global in-use list.
2290 // If a safepoint has started, then we save state via saved_mid_in_use_p
2291 // and return to the caller to honor the safepoint.
2292 //
2293 int ObjectSynchronizer::deflate_monitor_list_using_JT(ObjectMonitor** list_p,
2294                                                       int* count_p,
2295                                                       ObjectMonitor** free_head_p,
2296                                                       ObjectMonitor** free_tail_p,
2297                                                       ObjectMonitor** saved_mid_in_use_p) {
2298   assert(AsyncDeflateIdleMonitors, &quot;sanity check&quot;);
2299   JavaThread* self = JavaThread::current();
2300 
2301   ObjectMonitor* cur_mid_in_use = NULL;
2302   ObjectMonitor* mid = NULL;
2303   ObjectMonitor* next = NULL;
2304   ObjectMonitor* next_next = NULL;
2305   int deflated_count = 0;
2306   NoSafepointVerifier nsv;
2307 
2308   // We use the more complicated lock-cur_mid_in_use-and-mid-as-we-go
2309   // protocol because om_release() can do list deletions in parallel;
2310   // this also prevents races with a list walker thread. We also
2311   // lock-next-next-as-we-go to prevent an om_flush() that is behind
2312   // this thread from passing us.
2313   if (*saved_mid_in_use_p == NULL) {
2314     // No saved state so start at the beginning.
2315     // Lock the list head so we can possibly deflate it:
2316     if ((mid = get_list_head_locked(list_p)) == NULL) {
2317       return 0;  // The list is empty so nothing to deflate.
2318     }
2319     next = unmarked_next(mid);
2320   } else {
2321     // We&#39;re restarting after a safepoint so restore the necessary state
2322     // before we resume.
2323     cur_mid_in_use = *saved_mid_in_use_p;
2324     // Lock cur_mid_in_use so we can possibly update its
2325     // next field to extract a deflated ObjectMonitor.
2326     om_lock(cur_mid_in_use);
2327     mid = unmarked_next(cur_mid_in_use);
2328     if (mid == NULL) {
2329       om_unlock(cur_mid_in_use);
2330       *saved_mid_in_use_p = NULL;
2331       return 0;  // The remainder is empty so nothing more to deflate.
2332     }
2333     // Lock mid so we can possibly deflate it:
2334     om_lock(mid);
2335     next = unmarked_next(mid);
2336   }
2337 
2338   while (true) {
2339     // The current mid is locked at this point. If we have a
2340     // cur_mid_in_use, then it is also locked at this point.
2341 
2342     if (next != NULL) {
2343       // We lock next so that an om_flush() thread that is behind us
2344       // cannot pass us when we unlock the current mid.
2345       om_lock(next);
2346       next_next = unmarked_next(next);
2347     }
2348 
2349     // Only try to deflate if there is an associated Java object and if
2350     // mid is old (is not newly allocated and is not newly freed).
2351     if (mid-&gt;object() != NULL &amp;&amp; mid-&gt;is_old() &amp;&amp;
2352         deflate_monitor_using_JT(mid, free_head_p, free_tail_p)) {
2353       // Deflation succeeded and already updated free_head_p and
2354       // free_tail_p as needed. Finish the move to the local free list
2355       // by unlinking mid from the global or per-thread in-use list.
2356       if (cur_mid_in_use == NULL) {
2357         // mid is the list head and it is locked. Switch the list head
2358         // to next which is also locked (if not NULL) and also leave
2359         // mid locked:
2360         Atomic::store(list_p, next);
2361       } else {
2362         ObjectMonitor* locked_next = mark_om_ptr(next);
2363         // mid and cur_mid_in_use are locked. Switch cur_mid_in_use&#39;s
2364         // next field to locked_next and also leave mid locked:
2365         cur_mid_in_use-&gt;set_next_om(locked_next);
2366       }
2367       // At this point mid is disconnected from the in-use list so
2368       // its lock longer has any effects on in-use list.
2369       deflated_count++;
2370       Atomic::dec(count_p);
2371       // mid is current tail in the free_head_p list so NULL terminate it
2372       // (which also unlocks it):
2373       mid-&gt;set_next_om(NULL);
2374 
2375       // All the list management is done so move on to the next one:
2376       mid = next;  // mid keeps non-NULL next&#39;s locked state
2377       next = next_next;
2378     } else {
2379       // mid is considered in-use if it does not have an associated
2380       // Java object or mid is not old or deflation did not succeed.
2381       // A mid-&gt;is_new() node can be seen here when it is freshly
2382       // returned by om_alloc() (and skips the deflation code path).
2383       // A mid-&gt;is_old() node can be seen here when deflation failed.
2384       // A mid-&gt;is_free() node can be seen here when a fresh node from
2385       // om_alloc() is released by om_release() due to losing the race
2386       // in inflate().
2387 
2388       // All the list management is done so move on to the next one:
2389       if (cur_mid_in_use != NULL) {
2390         om_unlock(cur_mid_in_use);
2391       }
2392       // The next cur_mid_in_use keeps mid&#39;s lock state so
2393       // that it is stable for a possible next field change. It
2394       // cannot be modified by om_release() while it is locked.
2395       cur_mid_in_use = mid;
2396       mid = next;  // mid keeps non-NULL next&#39;s locked state
2397       next = next_next;
2398 
2399       if (SafepointMechanism::should_block(self) &amp;&amp;
2400           cur_mid_in_use != Atomic::load(list_p) &amp;&amp; cur_mid_in_use-&gt;is_old()) {
2401         // If a safepoint has started and cur_mid_in_use is not the list
2402         // head and is old, then it is safe to use as saved state. Return
2403         // to the caller before blocking.
2404         *saved_mid_in_use_p = cur_mid_in_use;
2405         om_unlock(cur_mid_in_use);
2406         if (mid != NULL) {
2407           om_unlock(mid);
2408         }
2409         return deflated_count;
2410       }
2411     }
2412     if (mid == NULL) {
2413       if (cur_mid_in_use != NULL) {
2414         om_unlock(cur_mid_in_use);
2415       }
2416       break;  // Reached end of the list so nothing more to deflate.
2417     }
2418 
2419     // The current mid&#39;s next field is locked at this point. If we have
2420     // a cur_mid_in_use, then it is also locked at this point.
2421   }
2422   // We finished the list without a safepoint starting so there&#39;s
2423   // no need to save state.
2424   *saved_mid_in_use_p = NULL;
2425   return deflated_count;
2426 }
2427 
2428 void ObjectSynchronizer::prepare_deflate_idle_monitors(DeflateMonitorCounters* counters) {
2429   counters-&gt;n_in_use = 0;              // currently associated with objects
2430   counters-&gt;n_in_circulation = 0;      // extant
2431   counters-&gt;n_scavenged = 0;           // reclaimed (global and per-thread)
2432   counters-&gt;per_thread_scavenged = 0;  // per-thread scavenge total
2433   counters-&gt;per_thread_times = 0.0;    // per-thread scavenge times
2434 }
2435 
2436 void ObjectSynchronizer::deflate_idle_monitors(DeflateMonitorCounters* counters) {
2437   assert(SafepointSynchronize::is_at_safepoint(), &quot;must be at safepoint&quot;);
2438 
2439   if (AsyncDeflateIdleMonitors) {
2440     // Nothing to do when global idle ObjectMonitors are deflated using
2441     // a JavaThread unless a special deflation has been requested.
2442     if (!is_special_deflation_requested()) {
2443       return;
2444     }
2445   }
2446 
2447   bool deflated = false;
2448 
2449   ObjectMonitor* free_head_p = NULL;  // Local SLL of scavenged monitors
2450   ObjectMonitor* free_tail_p = NULL;
2451   elapsedTimer timer;
2452 
2453   if (log_is_enabled(Info, monitorinflation)) {
2454     timer.start();
2455   }
2456 
2457   // Note: the thread-local monitors lists get deflated in
2458   // a separate pass. See deflate_thread_local_monitors().
2459 
2460   // For moribund threads, scan om_list_globals._in_use_list
2461   int deflated_count = 0;
2462   if (Atomic::load(&amp;om_list_globals._in_use_list) != NULL) {
2463     // Update n_in_circulation before om_list_globals._in_use_count is
2464     // updated by deflation.
2465     Atomic::add(&amp;counters-&gt;n_in_circulation,
2466                 Atomic::load(&amp;om_list_globals._in_use_count));
2467 
2468     deflated_count = deflate_monitor_list(&amp;om_list_globals._in_use_list,
2469                                           &amp;om_list_globals._in_use_count,
2470                                           &amp;free_head_p, &amp;free_tail_p);
2471     Atomic::add(&amp;counters-&gt;n_in_use, Atomic::load(&amp;om_list_globals._in_use_count));
2472   }
2473 
2474   if (free_head_p != NULL) {
2475     // Move the deflated ObjectMonitors back to the global free list.
2476     guarantee(free_tail_p != NULL &amp;&amp; deflated_count &gt; 0, &quot;invariant&quot;);
2477 #ifdef ASSERT
2478     ObjectMonitor* l_next_om = free_tail_p-&gt;next_om();
2479 #endif
2480     assert(l_next_om == NULL, &quot;must be NULL: _next_om=&quot; INTPTR_FORMAT, p2i(l_next_om));
2481     prepend_list_to_global_free_list(free_head_p, free_tail_p, deflated_count);
2482     Atomic::add(&amp;counters-&gt;n_scavenged, deflated_count);
2483   }
2484   timer.stop();
2485 
2486   LogStreamHandle(Debug, monitorinflation) lsh_debug;
2487   LogStreamHandle(Info, monitorinflation) lsh_info;
2488   LogStream* ls = NULL;
2489   if (log_is_enabled(Debug, monitorinflation)) {
2490     ls = &amp;lsh_debug;
2491   } else if (deflated_count != 0 &amp;&amp; log_is_enabled(Info, monitorinflation)) {
2492     ls = &amp;lsh_info;
2493   }
2494   if (ls != NULL) {
2495     ls-&gt;print_cr(&quot;deflating global idle monitors, %3.7f secs, %d monitors&quot;, timer.seconds(), deflated_count);
2496   }
2497 }
2498 
2499 class HandshakeForDeflation : public HandshakeClosure {
2500  public:
2501   HandshakeForDeflation() : HandshakeClosure(&quot;HandshakeForDeflation&quot;) {}
2502 
2503   void do_thread(Thread* thread) {
2504     log_trace(monitorinflation)(&quot;HandshakeForDeflation::do_thread: thread=&quot;
2505                                 INTPTR_FORMAT, p2i(thread));
2506   }
2507 };
2508 
2509 void ObjectSynchronizer::deflate_idle_monitors_using_JT() {
2510   assert(AsyncDeflateIdleMonitors, &quot;sanity check&quot;);
2511 
2512   // Deflate any global idle monitors.
2513   deflate_global_idle_monitors_using_JT();
2514 
2515   int count = 0;
2516   for (JavaThreadIteratorWithHandle jtiwh; JavaThread *jt = jtiwh.next(); ) {
2517     if (Atomic::load(&amp;jt-&gt;om_in_use_count) &gt; 0 &amp;&amp; !jt-&gt;is_exiting()) {
2518       // This JavaThread is using ObjectMonitors so deflate any that
2519       // are idle unless this JavaThread is exiting; do not race with
2520       // ObjectSynchronizer::om_flush().
2521       deflate_per_thread_idle_monitors_using_JT(jt);
2522       count++;
2523     }
2524   }
2525   if (count &gt; 0) {
2526     log_debug(monitorinflation)(&quot;did async deflation of idle monitors for %d thread(s).&quot;, count);
2527   }
2528 
2529   log_info(monitorinflation)(&quot;async global_population=%d, global_in_use_count=%d, &quot;
2530                              &quot;global_free_count=%d, global_wait_count=%d&quot;,
2531                              Atomic::load(&amp;om_list_globals._population),
2532                              Atomic::load(&amp;om_list_globals._in_use_count),
2533                              Atomic::load(&amp;om_list_globals._free_count),
2534                              Atomic::load(&amp;om_list_globals._wait_count));
2535 
2536   // The ServiceThread&#39;s async deflation request has been processed.
2537   set_is_async_deflation_requested(false);
2538 
2539   if (Atomic::load(&amp;om_list_globals._wait_count) &gt; 0) {
2540     // There are deflated ObjectMonitors waiting for a handshake
2541     // (or a safepoint) for safety.
2542 
2543     ObjectMonitor* list = Atomic::load(&amp;om_list_globals._wait_list);
2544     ADIM_guarantee(list != NULL, &quot;om_list_globals._wait_list must not be NULL&quot;);
2545     int count = Atomic::load(&amp;om_list_globals._wait_count);
2546     Atomic::store(&amp;om_list_globals._wait_count, 0);
2547     Atomic::store(&amp;om_list_globals._wait_list, (ObjectMonitor*)NULL);
2548 
2549     // Find the tail for prepend_list_to_common(). No need to mark
2550     // ObjectMonitors for this list walk since only the deflater
2551     // thread manages the wait list.
2552     int l_count = 0;
2553     ObjectMonitor* tail = NULL;
2554     for (ObjectMonitor* n = list; n != NULL; n = unmarked_next(n)) {
2555       tail = n;
2556       l_count++;
2557     }
2558     ADIM_guarantee(count == l_count, &quot;count=%d != l_count=%d&quot;, count, l_count);
2559 
2560     // Will execute a safepoint if !ThreadLocalHandshakes:
2561     HandshakeForDeflation hfd_hc;
2562     Handshake::execute(&amp;hfd_hc);
2563 
2564     prepend_list_to_common(list, tail, count, &amp;om_list_globals._free_list,
2565                            &amp;om_list_globals._free_count);
2566 
2567     log_info(monitorinflation)(&quot;moved %d idle monitors from global waiting list to global free list&quot;, count);
2568   }
2569 }
2570 
2571 // Deflate global idle ObjectMonitors using a JavaThread.
2572 //
2573 void ObjectSynchronizer::deflate_global_idle_monitors_using_JT() {
2574   assert(AsyncDeflateIdleMonitors, &quot;sanity check&quot;);
2575   assert(Thread::current()-&gt;is_Java_thread(), &quot;precondition&quot;);
2576   JavaThread* self = JavaThread::current();
2577 
2578   deflate_common_idle_monitors_using_JT(true /* is_global */, self);
2579 }
2580 
2581 // Deflate the specified JavaThread&#39;s idle ObjectMonitors using a JavaThread.
2582 //
2583 void ObjectSynchronizer::deflate_per_thread_idle_monitors_using_JT(JavaThread* target) {
2584   assert(AsyncDeflateIdleMonitors, &quot;sanity check&quot;);
2585   assert(Thread::current()-&gt;is_Java_thread(), &quot;precondition&quot;);
2586 
2587   deflate_common_idle_monitors_using_JT(false /* !is_global */, target);
2588 }
2589 
2590 // Deflate global or per-thread idle ObjectMonitors using a JavaThread.
2591 //
2592 void ObjectSynchronizer::deflate_common_idle_monitors_using_JT(bool is_global, JavaThread* target) {
2593   JavaThread* self = JavaThread::current();
2594 
2595   int deflated_count = 0;
2596   ObjectMonitor* free_head_p = NULL;  // Local SLL of scavenged ObjectMonitors
2597   ObjectMonitor* free_tail_p = NULL;
2598   ObjectMonitor* saved_mid_in_use_p = NULL;
2599   elapsedTimer timer;
2600 
2601   if (log_is_enabled(Info, monitorinflation)) {
2602     timer.start();
2603   }
2604 
2605   if (is_global) {
2606     OM_PERFDATA_OP(MonExtant, set_value(Atomic::load(&amp;om_list_globals._in_use_count)));
2607   } else {
2608     OM_PERFDATA_OP(MonExtant, inc(Atomic::load(&amp;target-&gt;om_in_use_count)));
2609   }
2610 
2611   do {
2612     if (saved_mid_in_use_p != NULL) {
2613       // We looped around because deflate_monitor_list_using_JT()
2614       // detected a pending safepoint. Honoring the safepoint is good,
2615       // but as long as is_special_deflation_requested() is supported,
2616       // we can&#39;t safely restart using saved_mid_in_use_p. That saved
2617       // ObjectMonitor could have been deflated by safepoint based
2618       // deflation and would no longer be on the in-use list where we
2619       // originally found it.
2620       saved_mid_in_use_p = NULL;
2621     }
2622     int local_deflated_count;
2623     if (is_global) {
2624       local_deflated_count =
2625           deflate_monitor_list_using_JT(&amp;om_list_globals._in_use_list,
2626                                         &amp;om_list_globals._in_use_count,
2627                                         &amp;free_head_p, &amp;free_tail_p,
2628                                         &amp;saved_mid_in_use_p);
2629     } else {
2630       local_deflated_count =
2631           deflate_monitor_list_using_JT(&amp;target-&gt;om_in_use_list,
2632                                         &amp;target-&gt;om_in_use_count, &amp;free_head_p,
2633                                         &amp;free_tail_p, &amp;saved_mid_in_use_p);
2634     }
2635     deflated_count += local_deflated_count;
2636 
2637     if (free_head_p != NULL) {
2638       // Move the deflated ObjectMonitors to the global free list.
2639       guarantee(free_tail_p != NULL &amp;&amp; local_deflated_count &gt; 0, &quot;free_tail_p=&quot; INTPTR_FORMAT &quot;, local_deflated_count=%d&quot;, p2i(free_tail_p), local_deflated_count);
2640       // Note: The target thread can be doing an om_alloc() that
2641       // is trying to prepend an ObjectMonitor on its in-use list
2642       // at the same time that we have deflated the current in-use
2643       // list head and put it on the local free list. prepend_to_common()
2644       // will detect the race and retry which avoids list corruption,
2645       // but the next field in free_tail_p can flicker to marked
2646       // and then unmarked while prepend_to_common() is sorting it
2647       // all out.
2648 #ifdef ASSERT
2649       ObjectMonitor* l_next_om = unmarked_next(free_tail_p);
2650 #endif
2651       assert(l_next_om == NULL, &quot;must be NULL: _next_om=&quot; INTPTR_FORMAT, p2i(l_next_om));
2652 
2653       prepend_list_to_global_wait_list(free_head_p, free_tail_p, local_deflated_count);
2654 
2655       OM_PERFDATA_OP(Deflations, inc(local_deflated_count));
2656     }
2657 
2658     if (saved_mid_in_use_p != NULL) {
2659       // deflate_monitor_list_using_JT() detected a safepoint starting.
2660       timer.stop();
2661       {
2662         if (is_global) {
2663           log_debug(monitorinflation)(&quot;pausing deflation of global idle monitors for a safepoint.&quot;);
2664         } else {
2665           log_debug(monitorinflation)(&quot;jt=&quot; INTPTR_FORMAT &quot;: pausing deflation of per-thread idle monitors for a safepoint.&quot;, p2i(target));
2666         }
2667         assert(SafepointMechanism::should_block(self), &quot;sanity check&quot;);
2668         ThreadBlockInVM blocker(self);
2669       }
2670       // Prepare for another loop after the safepoint.
2671       free_head_p = NULL;
2672       free_tail_p = NULL;
2673       if (log_is_enabled(Info, monitorinflation)) {
2674         timer.start();
2675       }
2676     }
2677   } while (saved_mid_in_use_p != NULL);
2678   timer.stop();
2679 
2680   LogStreamHandle(Debug, monitorinflation) lsh_debug;
2681   LogStreamHandle(Info, monitorinflation) lsh_info;
2682   LogStream* ls = NULL;
2683   if (log_is_enabled(Debug, monitorinflation)) {
2684     ls = &amp;lsh_debug;
2685   } else if (deflated_count != 0 &amp;&amp; log_is_enabled(Info, monitorinflation)) {
2686     ls = &amp;lsh_info;
2687   }
2688   if (ls != NULL) {
2689     if (is_global) {
2690       ls-&gt;print_cr(&quot;async-deflating global idle monitors, %3.7f secs, %d monitors&quot;, timer.seconds(), deflated_count);
2691     } else {
2692       ls-&gt;print_cr(&quot;jt=&quot; INTPTR_FORMAT &quot;: async-deflating per-thread idle monitors, %3.7f secs, %d monitors&quot;, p2i(target), timer.seconds(), deflated_count);
2693     }
2694   }
2695 }
2696 
2697 void ObjectSynchronizer::finish_deflate_idle_monitors(DeflateMonitorCounters* counters) {
2698   // Report the cumulative time for deflating each thread&#39;s idle
2699   // monitors. Note: if the work is split among more than one
2700   // worker thread, then the reported time will likely be more
2701   // than a beginning to end measurement of the phase.
2702   log_info(safepoint, cleanup)(&quot;deflating per-thread idle monitors, %3.7f secs, monitors=%d&quot;, counters-&gt;per_thread_times, counters-&gt;per_thread_scavenged);
2703 
2704   bool needs_special_deflation = is_special_deflation_requested();
2705   if (AsyncDeflateIdleMonitors &amp;&amp; !needs_special_deflation) {
2706     // Nothing to do when idle ObjectMonitors are deflated using
2707     // a JavaThread unless a special deflation has been requested.
2708     return;
2709   }
2710 
2711   if (log_is_enabled(Debug, monitorinflation)) {
2712     // exit_globals()&#39;s call to audit_and_print_stats() is done
2713     // at the Info level and not at a safepoint.
2714     // For async deflation, audit_and_print_stats() is called in
2715     // ObjectSynchronizer::do_safepoint_work() at the Debug level
2716     // at a safepoint.
2717     ObjectSynchronizer::audit_and_print_stats(false /* on_exit */);
2718   } else if (log_is_enabled(Info, monitorinflation)) {
2719     log_info(monitorinflation)(&quot;global_population=%d, global_in_use_count=%d, &quot;
2720                                &quot;global_free_count=%d, global_wait_count=%d&quot;,
2721                                Atomic::load(&amp;om_list_globals._population),
2722                                Atomic::load(&amp;om_list_globals._in_use_count),
2723                                Atomic::load(&amp;om_list_globals._free_count),
2724                                Atomic::load(&amp;om_list_globals._wait_count));
2725   }
2726 
2727   OM_PERFDATA_OP(Deflations, inc(counters-&gt;n_scavenged));
2728   OM_PERFDATA_OP(MonExtant, set_value(counters-&gt;n_in_circulation));
2729 
2730   GVars.stw_random = os::random();
2731   GVars.stw_cycle++;
2732 
2733   if (needs_special_deflation) {
2734     set_is_special_deflation_requested(false);  // special deflation is done
2735   }
2736 }
2737 
2738 void ObjectSynchronizer::deflate_thread_local_monitors(Thread* thread, DeflateMonitorCounters* counters) {
2739   assert(SafepointSynchronize::is_at_safepoint(), &quot;must be at safepoint&quot;);
2740 
2741   if (AsyncDeflateIdleMonitors &amp;&amp; !is_special_deflation_requested()) {
2742     // Nothing to do if a special deflation has NOT been requested.
2743     return;
2744   }
2745 
2746   ObjectMonitor* free_head_p = NULL;  // Local SLL of scavenged monitors
2747   ObjectMonitor* free_tail_p = NULL;
2748   elapsedTimer timer;
2749 
2750   if (log_is_enabled(Info, safepoint, cleanup) ||
2751       log_is_enabled(Info, monitorinflation)) {
2752     timer.start();
2753   }
2754 
2755   // Update n_in_circulation before om_in_use_count is updated by deflation.
2756   Atomic::add(&amp;counters-&gt;n_in_circulation, Atomic::load(&amp;thread-&gt;om_in_use_count));
2757 
2758   int deflated_count = deflate_monitor_list(&amp;thread-&gt;om_in_use_list, &amp;thread-&gt;om_in_use_count, &amp;free_head_p, &amp;free_tail_p);
2759   Atomic::add(&amp;counters-&gt;n_in_use, Atomic::load(&amp;thread-&gt;om_in_use_count));
2760 
2761   if (free_head_p != NULL) {
2762     // Move the deflated ObjectMonitors back to the global free list.
2763     guarantee(free_tail_p != NULL &amp;&amp; deflated_count &gt; 0, &quot;invariant&quot;);
2764 #ifdef ASSERT
2765     ObjectMonitor* l_next_om = free_tail_p-&gt;next_om();
2766 #endif
2767     assert(l_next_om == NULL, &quot;must be NULL: _next_om=&quot; INTPTR_FORMAT, p2i(l_next_om));
2768     prepend_list_to_global_free_list(free_head_p, free_tail_p, deflated_count);
2769     Atomic::add(&amp;counters-&gt;n_scavenged, deflated_count);
2770     Atomic::add(&amp;counters-&gt;per_thread_scavenged, deflated_count);
2771   }
2772 
2773   timer.stop();
2774   counters-&gt;per_thread_times += timer.seconds();
2775 
2776   LogStreamHandle(Debug, monitorinflation) lsh_debug;
2777   LogStreamHandle(Info, monitorinflation) lsh_info;
2778   LogStream* ls = NULL;
2779   if (log_is_enabled(Debug, monitorinflation)) {
2780     ls = &amp;lsh_debug;
2781   } else if (deflated_count != 0 &amp;&amp; log_is_enabled(Info, monitorinflation)) {
2782     ls = &amp;lsh_info;
2783   }
2784   if (ls != NULL) {
2785     ls-&gt;print_cr(&quot;jt=&quot; INTPTR_FORMAT &quot;: deflating per-thread idle monitors, %3.7f secs, %d monitors&quot;, p2i(thread), timer.seconds(), deflated_count);
2786   }
2787 }
2788 
2789 // Monitor cleanup on JavaThread::exit
2790 
2791 // Iterate through monitor cache and attempt to release thread&#39;s monitors
2792 // Gives up on a particular monitor if an exception occurs, but continues
2793 // the overall iteration, swallowing the exception.
2794 class ReleaseJavaMonitorsClosure: public MonitorClosure {
2795  private:
2796   TRAPS;
2797 
2798  public:
2799   ReleaseJavaMonitorsClosure(Thread* thread) : THREAD(thread) {}
2800   void do_monitor(ObjectMonitor* mid) {
2801     if (mid-&gt;owner() == THREAD) {
2802       (void)mid-&gt;complete_exit(CHECK);
2803     }
2804   }
2805 };
2806 
2807 // Release all inflated monitors owned by THREAD.  Lightweight monitors are
2808 // ignored.  This is meant to be called during JNI thread detach which assumes
2809 // all remaining monitors are heavyweight.  All exceptions are swallowed.
2810 // Scanning the extant monitor list can be time consuming.
2811 // A simple optimization is to add a per-thread flag that indicates a thread
2812 // called jni_monitorenter() during its lifetime.
2813 //
2814 // Instead of No_Savepoint_Verifier it might be cheaper to
2815 // use an idiom of the form:
2816 //   auto int tmp = SafepointSynchronize::_safepoint_counter ;
2817 //   &lt;code that must not run at safepoint&gt;
2818 //   guarantee (((tmp ^ _safepoint_counter) | (tmp &amp; 1)) == 0) ;
2819 // Since the tests are extremely cheap we could leave them enabled
2820 // for normal product builds.
2821 
2822 void ObjectSynchronizer::release_monitors_owned_by_thread(TRAPS) {
2823   assert(THREAD == JavaThread::current(), &quot;must be current Java thread&quot;);
2824   NoSafepointVerifier nsv;
2825   ReleaseJavaMonitorsClosure rjmc(THREAD);
2826   ObjectSynchronizer::monitors_iterate(&amp;rjmc);
2827   THREAD-&gt;clear_pending_exception();
2828 }
2829 
2830 const char* ObjectSynchronizer::inflate_cause_name(const InflateCause cause) {
2831   switch (cause) {
2832     case inflate_cause_vm_internal:    return &quot;VM Internal&quot;;
2833     case inflate_cause_monitor_enter:  return &quot;Monitor Enter&quot;;
2834     case inflate_cause_wait:           return &quot;Monitor Wait&quot;;
2835     case inflate_cause_notify:         return &quot;Monitor Notify&quot;;
2836     case inflate_cause_hash_code:      return &quot;Monitor Hash Code&quot;;
2837     case inflate_cause_jni_enter:      return &quot;JNI Monitor Enter&quot;;
2838     case inflate_cause_jni_exit:       return &quot;JNI Monitor Exit&quot;;
2839     default:
2840       ShouldNotReachHere();
2841   }
2842   return &quot;Unknown&quot;;
2843 }
2844 
2845 //------------------------------------------------------------------------------
2846 // Debugging code
2847 
2848 u_char* ObjectSynchronizer::get_gvars_addr() {
2849   return (u_char*)&amp;GVars;
2850 }
2851 
2852 u_char* ObjectSynchronizer::get_gvars_hc_sequence_addr() {
2853   return (u_char*)&amp;GVars.hc_sequence;
2854 }
2855 
2856 size_t ObjectSynchronizer::get_gvars_size() {
2857   return sizeof(SharedGlobals);
2858 }
2859 
2860 u_char* ObjectSynchronizer::get_gvars_stw_random_addr() {
2861   return (u_char*)&amp;GVars.stw_random;
2862 }
2863 
2864 // This function can be called at a safepoint or it can be called when
2865 // we are trying to exit the VM. When we are trying to exit the VM, the
2866 // list walker functions can run in parallel with the other list
2867 // operations so spin-locking is used for safety.
2868 //
2869 // Calls to this function can be added in various places as a debugging
2870 // aid; pass &#39;true&#39; for the &#39;on_exit&#39; parameter to have in-use monitor
2871 // details logged at the Info level and &#39;false&#39; for the &#39;on_exit&#39;
2872 // parameter to have in-use monitor details logged at the Trace level.
2873 // deflate_monitor_list() no longer uses spin-locking so be careful
2874 // when adding audit_and_print_stats() calls at a safepoint.
2875 //
2876 void ObjectSynchronizer::audit_and_print_stats(bool on_exit) {
2877   assert(on_exit || SafepointSynchronize::is_at_safepoint(), &quot;invariant&quot;);
2878 
2879   LogStreamHandle(Debug, monitorinflation) lsh_debug;
2880   LogStreamHandle(Info, monitorinflation) lsh_info;
2881   LogStreamHandle(Trace, monitorinflation) lsh_trace;
2882   LogStream* ls = NULL;
2883   if (log_is_enabled(Trace, monitorinflation)) {
2884     ls = &amp;lsh_trace;
2885   } else if (log_is_enabled(Debug, monitorinflation)) {
2886     ls = &amp;lsh_debug;
2887   } else if (log_is_enabled(Info, monitorinflation)) {
2888     ls = &amp;lsh_info;
2889   }
2890   assert(ls != NULL, &quot;sanity check&quot;);
2891 
2892   // Log counts for the global and per-thread monitor lists:
2893   int chk_om_population = log_monitor_list_counts(ls);
2894   int error_cnt = 0;
2895 
2896   ls-&gt;print_cr(&quot;Checking global lists:&quot;);
2897 
2898   // Check om_list_globals._population:
2899   if (Atomic::load(&amp;om_list_globals._population) == chk_om_population) {
2900     ls-&gt;print_cr(&quot;global_population=%d equals chk_om_population=%d&quot;,
2901                  Atomic::load(&amp;om_list_globals._population), chk_om_population);
2902   } else {
2903     // With fine grained locks on the monitor lists, it is possible for
2904     // log_monitor_list_counts() to return a value that doesn&#39;t match
2905     // om_list_globals._population. So far a higher value has been
2906     // seen in testing so something is being double counted by
2907     // log_monitor_list_counts().
2908     ls-&gt;print_cr(&quot;WARNING: global_population=%d is not equal to &quot;
2909                  &quot;chk_om_population=%d&quot;,
2910                  Atomic::load(&amp;om_list_globals._population), chk_om_population);
2911   }
2912 
2913   // Check om_list_globals._in_use_list and om_list_globals._in_use_count:
2914   chk_global_in_use_list_and_count(ls, &amp;error_cnt);
2915 
2916   // Check om_list_globals._free_list and om_list_globals._free_count:
2917   chk_global_free_list_and_count(ls, &amp;error_cnt);
2918 
2919   // Check om_list_globals._wait_list and om_list_globals._wait_count:
2920   chk_global_wait_list_and_count(ls, &amp;error_cnt);
2921 
2922   ls-&gt;print_cr(&quot;Checking per-thread lists:&quot;);
2923 
2924   for (JavaThreadIteratorWithHandle jtiwh; JavaThread *jt = jtiwh.next(); ) {
2925     // Check om_in_use_list and om_in_use_count:
2926     chk_per_thread_in_use_list_and_count(jt, ls, &amp;error_cnt);
2927 
2928     // Check om_free_list and om_free_count:
2929     chk_per_thread_free_list_and_count(jt, ls, &amp;error_cnt);
2930   }
2931 
2932   if (error_cnt == 0) {
2933     ls-&gt;print_cr(&quot;No errors found in monitor list checks.&quot;);
2934   } else {
2935     log_error(monitorinflation)(&quot;found monitor list errors: error_cnt=%d&quot;, error_cnt);
2936   }
2937 
2938   if ((on_exit &amp;&amp; log_is_enabled(Info, monitorinflation)) ||
2939       (!on_exit &amp;&amp; log_is_enabled(Trace, monitorinflation))) {
2940     // When exiting this log output is at the Info level. When called
2941     // at a safepoint, this log output is at the Trace level since
2942     // there can be a lot of it.
2943     log_in_use_monitor_details(ls);
2944   }
2945 
2946   ls-&gt;flush();
2947 
2948   guarantee(error_cnt == 0, &quot;ERROR: found monitor list errors: error_cnt=%d&quot;, error_cnt);
2949 }
2950 
2951 // Check a free monitor entry; log any errors.
2952 void ObjectSynchronizer::chk_free_entry(JavaThread* jt, ObjectMonitor* n,
2953                                         outputStream * out, int *error_cnt_p) {
2954   stringStream ss;
2955   if (n-&gt;is_busy()) {
2956     if (jt != NULL) {
2957       out-&gt;print_cr(&quot;ERROR: jt=&quot; INTPTR_FORMAT &quot;, monitor=&quot; INTPTR_FORMAT
2958                     &quot;: free per-thread monitor must not be busy: %s&quot;, p2i(jt),
2959                     p2i(n), n-&gt;is_busy_to_string(&amp;ss));
2960     } else {
2961       out-&gt;print_cr(&quot;ERROR: monitor=&quot; INTPTR_FORMAT &quot;: free global monitor &quot;
2962                     &quot;must not be busy: %s&quot;, p2i(n), n-&gt;is_busy_to_string(&amp;ss));
2963     }
2964     *error_cnt_p = *error_cnt_p + 1;
2965   }
2966   if (n-&gt;header().value() != 0) {
2967     if (jt != NULL) {
2968       out-&gt;print_cr(&quot;ERROR: jt=&quot; INTPTR_FORMAT &quot;, monitor=&quot; INTPTR_FORMAT
2969                     &quot;: free per-thread monitor must have NULL _header &quot;
2970                     &quot;field: _header=&quot; INTPTR_FORMAT, p2i(jt), p2i(n),
2971                     n-&gt;header().value());
2972       *error_cnt_p = *error_cnt_p + 1;
2973     } else if (!AsyncDeflateIdleMonitors) {
2974       out-&gt;print_cr(&quot;ERROR: monitor=&quot; INTPTR_FORMAT &quot;: free global monitor &quot;
2975                     &quot;must have NULL _header field: _header=&quot; INTPTR_FORMAT,
2976                     p2i(n), n-&gt;header().value());
2977       *error_cnt_p = *error_cnt_p + 1;
2978     }
2979   }
2980   if (n-&gt;object() != NULL) {
2981     if (jt != NULL) {
2982       out-&gt;print_cr(&quot;ERROR: jt=&quot; INTPTR_FORMAT &quot;, monitor=&quot; INTPTR_FORMAT
2983                     &quot;: free per-thread monitor must have NULL _object &quot;
2984                     &quot;field: _object=&quot; INTPTR_FORMAT, p2i(jt), p2i(n),
2985                     p2i(n-&gt;object()));
2986     } else {
2987       out-&gt;print_cr(&quot;ERROR: monitor=&quot; INTPTR_FORMAT &quot;: free global monitor &quot;
2988                     &quot;must have NULL _object field: _object=&quot; INTPTR_FORMAT,
2989                     p2i(n), p2i(n-&gt;object()));
2990     }
2991     *error_cnt_p = *error_cnt_p + 1;
2992   }
2993 }
2994 
2995 // Lock the next ObjectMonitor for traversal and unlock the current
2996 // ObjectMonitor. Returns the next ObjectMonitor if there is one.
2997 // Otherwise returns NULL (after unlocking the current ObjectMonitor).
2998 // This function is used by the various list walker functions to
2999 // safely walk a list without allowing an ObjectMonitor to be moved
3000 // to another list in the middle of a walk.
3001 static ObjectMonitor* lock_next_for_traversal(ObjectMonitor* cur) {
3002   assert(is_locked(cur), &quot;cur=&quot; INTPTR_FORMAT &quot; must be locked&quot;, p2i(cur));
3003   ObjectMonitor* next = unmarked_next(cur);
3004   if (next == NULL) {  // Reached the end of the list.
3005     om_unlock(cur);
3006     return NULL;
3007   }
3008   om_lock(next);   // Lock next before unlocking current to keep
3009   om_unlock(cur);  // from being by-passed by another thread.
3010   return next;
3011 }
3012 
3013 // Check the global free list and count; log the results of the checks.
3014 void ObjectSynchronizer::chk_global_free_list_and_count(outputStream * out,
3015                                                         int *error_cnt_p) {
3016   int chk_om_free_count = 0;
3017   ObjectMonitor* cur = NULL;
3018   if ((cur = get_list_head_locked(&amp;om_list_globals._free_list)) != NULL) {
3019     // Marked the global free list head so process the list.
3020     while (true) {
3021       chk_free_entry(NULL /* jt */, cur, out, error_cnt_p);
3022       chk_om_free_count++;
3023 
3024       cur = lock_next_for_traversal(cur);
3025       if (cur == NULL) {
3026         break;
3027       }
3028     }
3029   }
3030   int l_free_count = Atomic::load(&amp;om_list_globals._free_count);
3031   if (l_free_count == chk_om_free_count) {
3032     out-&gt;print_cr(&quot;global_free_count=%d equals chk_om_free_count=%d&quot;,
3033                   l_free_count, chk_om_free_count);
3034   } else {
3035     // With fine grained locks on om_list_globals._free_list, it
3036     // is possible for an ObjectMonitor to be prepended to
3037     // om_list_globals._free_list after we started calculating
3038     // chk_om_free_count so om_list_globals._free_count may not
3039     // match anymore.
3040     out-&gt;print_cr(&quot;WARNING: global_free_count=%d is not equal to &quot;
3041                   &quot;chk_om_free_count=%d&quot;, l_free_count, chk_om_free_count);
3042   }
3043 }
3044 
3045 // Check the global wait list and count; log the results of the checks.
3046 void ObjectSynchronizer::chk_global_wait_list_and_count(outputStream * out,
3047                                                         int *error_cnt_p) {
3048   int chk_om_wait_count = 0;
3049   ObjectMonitor* cur = NULL;
3050   if ((cur = get_list_head_locked(&amp;om_list_globals._wait_list)) != NULL) {
3051     // Marked the global wait list head so process the list.
3052     while (true) {
3053       // Rules for om_list_globals._wait_list are the same as for
3054       // om_list_globals._free_list:
3055       chk_free_entry(NULL /* jt */, cur, out, error_cnt_p);
3056       chk_om_wait_count++;
3057 
3058       cur = lock_next_for_traversal(cur);
3059       if (cur == NULL) {
3060         break;
3061       }
3062     }
3063   }
3064   if (Atomic::load(&amp;om_list_globals._wait_count) == chk_om_wait_count) {
3065     out-&gt;print_cr(&quot;global_wait_count=%d equals chk_om_wait_count=%d&quot;,
3066                   Atomic::load(&amp;om_list_globals._wait_count), chk_om_wait_count);
3067   } else {
3068     out-&gt;print_cr(&quot;ERROR: global_wait_count=%d is not equal to &quot;
3069                   &quot;chk_om_wait_count=%d&quot;,
3070                   Atomic::load(&amp;om_list_globals._wait_count), chk_om_wait_count);
3071     *error_cnt_p = *error_cnt_p + 1;
3072   }
3073 }
3074 
3075 // Check the global in-use list and count; log the results of the checks.
3076 void ObjectSynchronizer::chk_global_in_use_list_and_count(outputStream * out,
3077                                                           int *error_cnt_p) {
3078   int chk_om_in_use_count = 0;
3079   ObjectMonitor* cur = NULL;
3080   if ((cur = get_list_head_locked(&amp;om_list_globals._in_use_list)) != NULL) {
3081     // Marked the global in-use list head so process the list.
3082     while (true) {
3083       chk_in_use_entry(NULL /* jt */, cur, out, error_cnt_p);
3084       chk_om_in_use_count++;
3085 
3086       cur = lock_next_for_traversal(cur);
3087       if (cur == NULL) {
3088         break;
3089       }
3090     }
3091   }
3092   int l_in_use_count = Atomic::load(&amp;om_list_globals._in_use_count);
3093   if (l_in_use_count == chk_om_in_use_count) {
3094     out-&gt;print_cr(&quot;global_in_use_count=%d equals chk_om_in_use_count=%d&quot;,
3095                   l_in_use_count, chk_om_in_use_count);
3096   } else {
3097     // With fine grained locks on the monitor lists, it is possible for
3098     // an exiting JavaThread to put its in-use ObjectMonitors on the
3099     // global in-use list after chk_om_in_use_count is calculated above.
3100     out-&gt;print_cr(&quot;WARNING: global_in_use_count=%d is not equal to chk_om_in_use_count=%d&quot;,
3101                   l_in_use_count, chk_om_in_use_count);
3102   }
3103 }
3104 
3105 // Check an in-use monitor entry; log any errors.
3106 void ObjectSynchronizer::chk_in_use_entry(JavaThread* jt, ObjectMonitor* n,
3107                                           outputStream * out, int *error_cnt_p) {
3108   if (n-&gt;header().value() == 0) {
3109     if (jt != NULL) {
3110       out-&gt;print_cr(&quot;ERROR: jt=&quot; INTPTR_FORMAT &quot;, monitor=&quot; INTPTR_FORMAT
3111                     &quot;: in-use per-thread monitor must have non-NULL _header &quot;
3112                     &quot;field.&quot;, p2i(jt), p2i(n));
3113     } else {
3114       out-&gt;print_cr(&quot;ERROR: monitor=&quot; INTPTR_FORMAT &quot;: in-use global monitor &quot;
3115                     &quot;must have non-NULL _header field.&quot;, p2i(n));
3116     }
3117     *error_cnt_p = *error_cnt_p + 1;
3118   }
3119   if (n-&gt;object() == NULL) {
3120     if (jt != NULL) {
3121       out-&gt;print_cr(&quot;ERROR: jt=&quot; INTPTR_FORMAT &quot;, monitor=&quot; INTPTR_FORMAT
3122                     &quot;: in-use per-thread monitor must have non-NULL _object &quot;
3123                     &quot;field.&quot;, p2i(jt), p2i(n));
3124     } else {
3125       out-&gt;print_cr(&quot;ERROR: monitor=&quot; INTPTR_FORMAT &quot;: in-use global monitor &quot;
3126                     &quot;must have non-NULL _object field.&quot;, p2i(n));
3127     }
3128     *error_cnt_p = *error_cnt_p + 1;
3129   }
3130   const oop obj = (oop)n-&gt;object();
3131   const markWord mark = obj-&gt;mark();
3132   if (!mark.has_monitor()) {
3133     if (jt != NULL) {
3134       out-&gt;print_cr(&quot;ERROR: jt=&quot; INTPTR_FORMAT &quot;, monitor=&quot; INTPTR_FORMAT
3135                     &quot;: in-use per-thread monitor&#39;s object does not think &quot;
3136                     &quot;it has a monitor: obj=&quot; INTPTR_FORMAT &quot;, mark=&quot;
3137                     INTPTR_FORMAT,  p2i(jt), p2i(n), p2i(obj), mark.value());
3138     } else {
3139       out-&gt;print_cr(&quot;ERROR: monitor=&quot; INTPTR_FORMAT &quot;: in-use global &quot;
3140                     &quot;monitor&#39;s object does not think it has a monitor: obj=&quot;
3141                     INTPTR_FORMAT &quot;, mark=&quot; INTPTR_FORMAT, p2i(n),
3142                     p2i(obj), mark.value());
3143     }
3144     *error_cnt_p = *error_cnt_p + 1;
3145   }
3146   ObjectMonitor* const obj_mon = mark.monitor();
3147   if (n != obj_mon) {
3148     if (jt != NULL) {
3149       out-&gt;print_cr(&quot;ERROR: jt=&quot; INTPTR_FORMAT &quot;, monitor=&quot; INTPTR_FORMAT
3150                     &quot;: in-use per-thread monitor&#39;s object does not refer &quot;
3151                     &quot;to the same monitor: obj=&quot; INTPTR_FORMAT &quot;, mark=&quot;
3152                     INTPTR_FORMAT &quot;, obj_mon=&quot; INTPTR_FORMAT, p2i(jt),
3153                     p2i(n), p2i(obj), mark.value(), p2i(obj_mon));
3154     } else {
3155       out-&gt;print_cr(&quot;ERROR: monitor=&quot; INTPTR_FORMAT &quot;: in-use global &quot;
3156                     &quot;monitor&#39;s object does not refer to the same monitor: obj=&quot;
3157                     INTPTR_FORMAT &quot;, mark=&quot; INTPTR_FORMAT &quot;, obj_mon=&quot;
3158                     INTPTR_FORMAT, p2i(n), p2i(obj), mark.value(), p2i(obj_mon));
3159     }
3160     *error_cnt_p = *error_cnt_p + 1;
3161   }
3162 }
3163 
3164 // Check the thread&#39;s free list and count; log the results of the checks.
3165 void ObjectSynchronizer::chk_per_thread_free_list_and_count(JavaThread *jt,
3166                                                             outputStream * out,
3167                                                             int *error_cnt_p) {
3168   int chk_om_free_count = 0;
3169   ObjectMonitor* cur = NULL;
3170   if ((cur = get_list_head_locked(&amp;jt-&gt;om_free_list)) != NULL) {
3171     // Marked the per-thread free list head so process the list.
3172     while (true) {
3173       chk_free_entry(jt, cur, out, error_cnt_p);
3174       chk_om_free_count++;
3175 
3176       cur = lock_next_for_traversal(cur);
3177       if (cur == NULL) {
3178         break;
3179       }
3180     }
3181   }
3182   int l_om_free_count = Atomic::load(&amp;jt-&gt;om_free_count);
3183   if (l_om_free_count == chk_om_free_count) {
3184     out-&gt;print_cr(&quot;jt=&quot; INTPTR_FORMAT &quot;: om_free_count=%d equals &quot;
3185                   &quot;chk_om_free_count=%d&quot;, p2i(jt), l_om_free_count, chk_om_free_count);
3186   } else {
3187     out-&gt;print_cr(&quot;ERROR: jt=&quot; INTPTR_FORMAT &quot;: om_free_count=%d is not &quot;
3188                   &quot;equal to chk_om_free_count=%d&quot;, p2i(jt), l_om_free_count,
3189                   chk_om_free_count);
3190     *error_cnt_p = *error_cnt_p + 1;
3191   }
3192 }
3193 
3194 // Check the thread&#39;s in-use list and count; log the results of the checks.
3195 void ObjectSynchronizer::chk_per_thread_in_use_list_and_count(JavaThread *jt,
3196                                                               outputStream * out,
3197                                                               int *error_cnt_p) {
3198   int chk_om_in_use_count = 0;
3199   ObjectMonitor* cur = NULL;
3200   if ((cur = get_list_head_locked(&amp;jt-&gt;om_in_use_list)) != NULL) {
3201     // Marked the per-thread in-use list head so process the list.
3202     while (true) {
3203       chk_in_use_entry(jt, cur, out, error_cnt_p);
3204       chk_om_in_use_count++;
3205 
3206       cur = lock_next_for_traversal(cur);
3207       if (cur == NULL) {
3208         break;
3209       }
3210     }
3211   }
3212   int l_om_in_use_count = Atomic::load(&amp;jt-&gt;om_in_use_count);
3213   if (l_om_in_use_count == chk_om_in_use_count) {
3214     out-&gt;print_cr(&quot;jt=&quot; INTPTR_FORMAT &quot;: om_in_use_count=%d equals &quot;
3215                   &quot;chk_om_in_use_count=%d&quot;, p2i(jt), l_om_in_use_count,
3216                   chk_om_in_use_count);
3217   } else {
3218     out-&gt;print_cr(&quot;ERROR: jt=&quot; INTPTR_FORMAT &quot;: om_in_use_count=%d is not &quot;
3219                   &quot;equal to chk_om_in_use_count=%d&quot;, p2i(jt), l_om_in_use_count,
3220                   chk_om_in_use_count);
3221     *error_cnt_p = *error_cnt_p + 1;
3222   }
3223 }
3224 
3225 // Log details about ObjectMonitors on the in-use lists. The &#39;BHL&#39;
3226 // flags indicate why the entry is in-use, &#39;object&#39; and &#39;object type&#39;
3227 // indicate the associated object and its type.
3228 void ObjectSynchronizer::log_in_use_monitor_details(outputStream * out) {
3229   stringStream ss;
3230   if (Atomic::load(&amp;om_list_globals._in_use_count) &gt; 0) {
3231     out-&gt;print_cr(&quot;In-use global monitor info:&quot;);
3232     out-&gt;print_cr(&quot;(B -&gt; is_busy, H -&gt; has hash code, L -&gt; lock status)&quot;);
3233     out-&gt;print_cr(&quot;%18s  %s  %18s  %18s&quot;,
3234                   &quot;monitor&quot;, &quot;BHL&quot;, &quot;object&quot;, &quot;object type&quot;);
3235     out-&gt;print_cr(&quot;==================  ===  ==================  ==================&quot;);
3236     ObjectMonitor* cur = NULL;
3237     if ((cur = get_list_head_locked(&amp;om_list_globals._in_use_list)) != NULL) {
3238       // Marked the global in-use list head so process the list.
3239       while (true) {
3240         const oop obj = (oop) cur-&gt;object();
3241         const markWord mark = cur-&gt;header();
3242         ResourceMark rm;
3243         out-&gt;print(INTPTR_FORMAT &quot;  %d%d%d  &quot; INTPTR_FORMAT &quot;  %s&quot;, p2i(cur),
3244                    cur-&gt;is_busy() != 0, mark.hash() != 0, cur-&gt;owner() != NULL,
3245                    p2i(obj), obj-&gt;klass()-&gt;external_name());
3246         if (cur-&gt;is_busy() != 0) {
3247           out-&gt;print(&quot; (%s)&quot;, cur-&gt;is_busy_to_string(&amp;ss));
3248           ss.reset();
3249         }
3250         out-&gt;cr();
3251 
3252         cur = lock_next_for_traversal(cur);
3253         if (cur == NULL) {
3254           break;
3255         }
3256       }
3257     }
3258   }
3259 
3260   out-&gt;print_cr(&quot;In-use per-thread monitor info:&quot;);
3261   out-&gt;print_cr(&quot;(B -&gt; is_busy, H -&gt; has hash code, L -&gt; lock status)&quot;);
3262   out-&gt;print_cr(&quot;%18s  %18s  %s  %18s  %18s&quot;,
3263                 &quot;jt&quot;, &quot;monitor&quot;, &quot;BHL&quot;, &quot;object&quot;, &quot;object type&quot;);
3264   out-&gt;print_cr(&quot;==================  ==================  ===  ==================  ==================&quot;);
3265   for (JavaThreadIteratorWithHandle jtiwh; JavaThread *jt = jtiwh.next(); ) {
3266     ObjectMonitor* cur = NULL;
3267     if ((cur = get_list_head_locked(&amp;jt-&gt;om_in_use_list)) != NULL) {
3268       // Marked the global in-use list head so process the list.
3269       while (true) {
3270         const oop obj = (oop) cur-&gt;object();
3271         const markWord mark = cur-&gt;header();
3272         ResourceMark rm;
3273         out-&gt;print(INTPTR_FORMAT &quot;  &quot; INTPTR_FORMAT &quot;  %d%d%d  &quot; INTPTR_FORMAT
3274                    &quot;  %s&quot;, p2i(jt), p2i(cur), cur-&gt;is_busy() != 0,
3275                    mark.hash() != 0, cur-&gt;owner() != NULL, p2i(obj),
3276                    obj-&gt;klass()-&gt;external_name());
3277         if (cur-&gt;is_busy() != 0) {
3278           out-&gt;print(&quot; (%s)&quot;, cur-&gt;is_busy_to_string(&amp;ss));
3279           ss.reset();
3280         }
3281         out-&gt;cr();
3282 
3283         cur = lock_next_for_traversal(cur);
3284         if (cur == NULL) {
3285           break;
3286         }
3287       }
3288     }
3289   }
3290 
3291   out-&gt;flush();
3292 }
3293 
3294 // Log counts for the global and per-thread monitor lists and return
3295 // the population count.
3296 int ObjectSynchronizer::log_monitor_list_counts(outputStream * out) {
3297   int pop_count = 0;
3298   out-&gt;print_cr(&quot;%18s  %10s  %10s  %10s  %10s&quot;,
3299                 &quot;Global Lists:&quot;, &quot;InUse&quot;, &quot;Free&quot;, &quot;Wait&quot;, &quot;Total&quot;);
3300   out-&gt;print_cr(&quot;==================  ==========  ==========  ==========  ==========&quot;);
3301   int l_in_use_count = Atomic::load(&amp;om_list_globals._in_use_count);
3302   int l_free_count = Atomic::load(&amp;om_list_globals._free_count);
3303   int l_wait_count = Atomic::load(&amp;om_list_globals._wait_count);
3304   out-&gt;print_cr(&quot;%18s  %10d  %10d  %10d  %10d&quot;, &quot;&quot;, l_in_use_count,
3305                 l_free_count, l_wait_count,
3306                 Atomic::load(&amp;om_list_globals._population));
3307   pop_count += l_in_use_count + l_free_count + l_wait_count;
3308 
3309   out-&gt;print_cr(&quot;%18s  %10s  %10s  %10s&quot;,
3310                 &quot;Per-Thread Lists:&quot;, &quot;InUse&quot;, &quot;Free&quot;, &quot;Provision&quot;);
3311   out-&gt;print_cr(&quot;==================  ==========  ==========  ==========&quot;);
3312 
3313   for (JavaThreadIteratorWithHandle jtiwh; JavaThread *jt = jtiwh.next(); ) {
3314     int l_om_in_use_count = Atomic::load(&amp;jt-&gt;om_in_use_count);
3315     int l_om_free_count = Atomic::load(&amp;jt-&gt;om_free_count);
3316     out-&gt;print_cr(INTPTR_FORMAT &quot;  %10d  %10d  %10d&quot;, p2i(jt),
3317                   l_om_in_use_count, l_om_free_count, jt-&gt;om_free_provision);
3318     pop_count += l_om_in_use_count + l_om_free_count;
3319   }
3320   return pop_count;
3321 }
3322 
3323 #ifndef PRODUCT
3324 
3325 // Check if monitor belongs to the monitor cache
3326 // The list is grow-only so it&#39;s *relatively* safe to traverse
3327 // the list of extant blocks without taking a lock.
3328 
3329 int ObjectSynchronizer::verify_objmon_isinpool(ObjectMonitor *monitor) {
3330   PaddedObjectMonitor* block = Atomic::load(&amp;g_block_list);
3331   while (block != NULL) {
3332     assert(block-&gt;object() == CHAINMARKER, &quot;must be a block header&quot;);
3333     if (monitor &gt; &amp;block[0] &amp;&amp; monitor &lt; &amp;block[_BLOCKSIZE]) {
3334       address mon = (address)monitor;
3335       address blk = (address)block;
3336       size_t diff = mon - blk;
3337       assert((diff % sizeof(PaddedObjectMonitor)) == 0, &quot;must be aligned&quot;);
3338       return 1;
3339     }
3340     // unmarked_next() is not needed with g_block_list (no locking
3341     // used with block linkage _next_om fields).
3342     block = (PaddedObjectMonitor*)block-&gt;next_om();
3343   }
3344   return 0;
3345 }
3346 
3347 #endif
<a name="18" id="anc18"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="18" type="hidden" />
</body>
</html>