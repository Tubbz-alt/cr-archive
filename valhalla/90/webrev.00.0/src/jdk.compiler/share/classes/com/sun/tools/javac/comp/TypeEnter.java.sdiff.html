<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/jdk.compiler/share/classes/com/sun/tools/javac/comp/TypeEnter.java</title>
    <link rel="stylesheet" href="../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="../../../../../../../../java.base/share/classes/java/lang/Class.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="../../../../../../../../../test/hotspot/jtreg/TEST.groups.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/jdk.compiler/share/classes/com/sun/tools/javac/comp/TypeEnter.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 989                     }
 990                 }
 991             }
 992         }
 993     }
 994 
 995     /** Enter member fields and methods of a class
 996      */
 997     private final class MembersPhase extends AbstractMembersPhase {
 998 
 999         public MembersPhase() {
1000             super(CompletionCause.MEMBERS_PHASE, null);
1001         }
1002 
1003         @Override
1004         protected void runPhase(Env&lt;AttrContext&gt; env) {
1005             JCClassDecl tree = env.enclClass;
1006             ClassSymbol sym = tree.sym;
1007             ClassType ct = (ClassType)sym.type;
1008 


1009             // Add default constructor if needed.
1010             DefaultConstructorHelper helper = getDefaultConstructorHelper(env);
1011             if (helper != null) {
<span class="line-modified">1012                 JCTree constrDef = defaultConstructor(make.at(tree.pos), helper);</span>
<span class="line-modified">1013                 tree.defs = tree.defs.prepend(constrDef);</span>
1014             }
1015             if (!sym.isRecord()) {
1016                 enterThisAndSuper(sym, env);
1017             }
1018 
1019             if (!tree.typarams.isEmpty()) {
1020                 for (JCTypeParameter tvar : tree.typarams) {
1021                     chk.checkNonCyclic(tvar, (TypeVar)tvar.type);
1022                 }
1023             }
1024 
<span class="line-modified">1025             finishClass(tree, env);</span>
1026 
1027             if (allowTypeAnnos) {
1028                 typeAnnotations.organizeTypeAnnotationsSignatures(env, (JCClassDecl)env.tree);
1029                 typeAnnotations.validateTypeAnnotationsSignatures(env, (JCClassDecl)env.tree);
1030             }
1031         }
1032 
1033         DefaultConstructorHelper getDefaultConstructorHelper(Env&lt;AttrContext&gt; env) {
1034             JCClassDecl tree = env.enclClass;
1035             ClassSymbol sym = tree.sym;
1036             DefaultConstructorHelper helper = null;
1037             boolean isClassWithoutInit = (sym.flags() &amp; INTERFACE) == 0 &amp;&amp; !TreeInfo.hasConstructors(tree.defs);
1038             boolean isRecord = sym.isRecord();
1039             if (isClassWithoutInit &amp;&amp; !isRecord) {
1040                 helper = new BasicConstructorHelper(sym);
1041                 if (sym.name.isEmpty()) {
1042                     JCNewClass nc = (JCNewClass)env.next.tree;
1043                     if (nc.constructor != null) {
1044                         if (nc.constructor.kind != ERR) {
1045                             helper = new AnonClassConstructorHelper(sym, (MethodSymbol)nc.constructor, nc.encl);
1046                         } else {
1047                             helper = null;
1048                         }
1049                     }
1050                 }
1051             }
1052             if (isRecord) {
1053                 JCMethodDecl canonicalInit = null;
1054                 if (isClassWithoutInit || (canonicalInit = getCanonicalConstructorDecl(env.enclClass)) == null) {
1055                     helper = new RecordConstructorHelper(sym, TreeInfo.recordFields(tree));
1056                 }
1057                 if (canonicalInit != null) {
1058                     canonicalInit.sym.flags_field |= Flags.RECORD;
1059                 }
1060             }
1061             return helper;
1062         }
1063 
1064         /** Enter members for a class.
1065          */
<span class="line-modified">1066         void finishClass(JCClassDecl tree, Env&lt;AttrContext&gt; env) {</span>
1067             if ((tree.mods.flags &amp; Flags.ENUM) != 0 &amp;&amp;
1068                 !tree.sym.type.hasTag(ERROR) &amp;&amp;
1069                 (types.supertype(tree.sym.type).tsym.flags() &amp; Flags.ENUM) == 0) {
1070                 addEnumMembers(tree, env);
1071             }
1072             boolean isRecord = (tree.sym.flags_field &amp; RECORD) != 0;
1073             List&lt;JCTree&gt; alreadyEntered = null;
1074             if (isRecord) {
1075                 alreadyEntered = List.convert(JCTree.class, TreeInfo.recordFields(tree));
1076                 alreadyEntered = alreadyEntered.prependList(tree.defs.stream()
<span class="line-modified">1077                         .filter(t -&gt; TreeInfo.isConstructor(t) &amp;&amp;</span>
<span class="line-removed">1078                                 ((JCMethodDecl)t).sym != null &amp;&amp;</span>
<span class="line-removed">1079                                 (((JCMethodDecl)t).sym.flags_field &amp; Flags.GENERATEDCONSTR) == 0).collect(List.collector()));</span>
1080             }
1081             List&lt;JCTree&gt; defsToEnter = isRecord ?
1082                     tree.defs.diff(alreadyEntered) : tree.defs;
1083             memberEnter.memberEnter(defsToEnter, env);
1084             if (isRecord) {
1085                 addRecordMembersIfNeeded(tree, env);
1086             }
1087             if ((tree.mods.flags &amp; (Flags.VALUE | Flags.INTERFACE)) == Flags.VALUE &amp;&amp; !tree.sym.type.hasTag(ERROR)) {
1088                 addValueMembers(tree, env);
1089             }
1090             if (tree.sym.isAnnotationType()) {
1091                 Assert.check(tree.sym.isCompleted());
1092                 tree.sym.setAnnotationTypeMetadata(new AnnotationTypeMetadata(tree.sym, annotate.annotationTypeSourceCompleter()));
1093             }
1094         }
1095 
1096         private void addAccessor(JCVariableDecl tree, Env&lt;AttrContext&gt; env) {
1097             MethodSymbol implSym = lookupMethod(env.enclClass.sym, tree.sym.name, List.nil());
1098             RecordComponent rec = ((ClassSymbol) tree.sym.owner).getRecordComponent(tree.sym);
1099             if (implSym == null || (implSym.flags_field &amp; GENERATED_MEMBER) != 0) {
</pre>
</td>
<td>
<hr />
<pre>
 989                     }
 990                 }
 991             }
 992         }
 993     }
 994 
 995     /** Enter member fields and methods of a class
 996      */
 997     private final class MembersPhase extends AbstractMembersPhase {
 998 
 999         public MembersPhase() {
1000             super(CompletionCause.MEMBERS_PHASE, null);
1001         }
1002 
1003         @Override
1004         protected void runPhase(Env&lt;AttrContext&gt; env) {
1005             JCClassDecl tree = env.enclClass;
1006             ClassSymbol sym = tree.sym;
1007             ClassType ct = (ClassType)sym.type;
1008 
<span class="line-added">1009             JCTree defaultConstructor = null;</span>
<span class="line-added">1010 </span>
1011             // Add default constructor if needed.
1012             DefaultConstructorHelper helper = getDefaultConstructorHelper(env);
1013             if (helper != null) {
<span class="line-modified">1014                 defaultConstructor = defaultConstructor(make.at(tree.pos), helper);</span>
<span class="line-modified">1015                 tree.defs = tree.defs.prepend(defaultConstructor);</span>
1016             }
1017             if (!sym.isRecord()) {
1018                 enterThisAndSuper(sym, env);
1019             }
1020 
1021             if (!tree.typarams.isEmpty()) {
1022                 for (JCTypeParameter tvar : tree.typarams) {
1023                     chk.checkNonCyclic(tvar, (TypeVar)tvar.type);
1024                 }
1025             }
1026 
<span class="line-modified">1027             finishClass(tree, defaultConstructor, env);</span>
1028 
1029             if (allowTypeAnnos) {
1030                 typeAnnotations.organizeTypeAnnotationsSignatures(env, (JCClassDecl)env.tree);
1031                 typeAnnotations.validateTypeAnnotationsSignatures(env, (JCClassDecl)env.tree);
1032             }
1033         }
1034 
1035         DefaultConstructorHelper getDefaultConstructorHelper(Env&lt;AttrContext&gt; env) {
1036             JCClassDecl tree = env.enclClass;
1037             ClassSymbol sym = tree.sym;
1038             DefaultConstructorHelper helper = null;
1039             boolean isClassWithoutInit = (sym.flags() &amp; INTERFACE) == 0 &amp;&amp; !TreeInfo.hasConstructors(tree.defs);
1040             boolean isRecord = sym.isRecord();
1041             if (isClassWithoutInit &amp;&amp; !isRecord) {
1042                 helper = new BasicConstructorHelper(sym);
1043                 if (sym.name.isEmpty()) {
1044                     JCNewClass nc = (JCNewClass)env.next.tree;
1045                     if (nc.constructor != null) {
1046                         if (nc.constructor.kind != ERR) {
1047                             helper = new AnonClassConstructorHelper(sym, (MethodSymbol)nc.constructor, nc.encl);
1048                         } else {
1049                             helper = null;
1050                         }
1051                     }
1052                 }
1053             }
1054             if (isRecord) {
1055                 JCMethodDecl canonicalInit = null;
1056                 if (isClassWithoutInit || (canonicalInit = getCanonicalConstructorDecl(env.enclClass)) == null) {
1057                     helper = new RecordConstructorHelper(sym, TreeInfo.recordFields(tree));
1058                 }
1059                 if (canonicalInit != null) {
1060                     canonicalInit.sym.flags_field |= Flags.RECORD;
1061                 }
1062             }
1063             return helper;
1064         }
1065 
1066         /** Enter members for a class.
1067          */
<span class="line-modified">1068         void finishClass(JCClassDecl tree, JCTree defaultConstructor, Env&lt;AttrContext&gt; env) {</span>
1069             if ((tree.mods.flags &amp; Flags.ENUM) != 0 &amp;&amp;
1070                 !tree.sym.type.hasTag(ERROR) &amp;&amp;
1071                 (types.supertype(tree.sym.type).tsym.flags() &amp; Flags.ENUM) == 0) {
1072                 addEnumMembers(tree, env);
1073             }
1074             boolean isRecord = (tree.sym.flags_field &amp; RECORD) != 0;
1075             List&lt;JCTree&gt; alreadyEntered = null;
1076             if (isRecord) {
1077                 alreadyEntered = List.convert(JCTree.class, TreeInfo.recordFields(tree));
1078                 alreadyEntered = alreadyEntered.prependList(tree.defs.stream()
<span class="line-modified">1079                         .filter(t -&gt; TreeInfo.isConstructor(t) &amp;&amp; t != defaultConstructor).collect(List.collector()));</span>


1080             }
1081             List&lt;JCTree&gt; defsToEnter = isRecord ?
1082                     tree.defs.diff(alreadyEntered) : tree.defs;
1083             memberEnter.memberEnter(defsToEnter, env);
1084             if (isRecord) {
1085                 addRecordMembersIfNeeded(tree, env);
1086             }
1087             if ((tree.mods.flags &amp; (Flags.VALUE | Flags.INTERFACE)) == Flags.VALUE &amp;&amp; !tree.sym.type.hasTag(ERROR)) {
1088                 addValueMembers(tree, env);
1089             }
1090             if (tree.sym.isAnnotationType()) {
1091                 Assert.check(tree.sym.isCompleted());
1092                 tree.sym.setAnnotationTypeMetadata(new AnnotationTypeMetadata(tree.sym, annotate.annotationTypeSourceCompleter()));
1093             }
1094         }
1095 
1096         private void addAccessor(JCVariableDecl tree, Env&lt;AttrContext&gt; env) {
1097             MethodSymbol implSym = lookupMethod(env.enclClass.sym, tree.sym.name, List.nil());
1098             RecordComponent rec = ((ClassSymbol) tree.sym.owner).getRecordComponent(tree.sym);
1099             if (implSym == null || (implSym.flags_field &amp; GENERATED_MEMBER) != 0) {
</pre>
</td>
</tr>
</table>
<center><a href="../../../../../../../../java.base/share/classes/java/lang/Class.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="../../../../../../../../../test/hotspot/jtreg/TEST.groups.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>