<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff src/hotspot/cpu/x86/c1_MacroAssembler_x86.cpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
  </head>
<body>
<center>&lt; prev <a href="../../../../index.html" target="_top">index</a> <a href="frame_x86.cpp.udiff.html" target="_top">next &gt;</a></center>    <h2>src/hotspot/cpu/x86/c1_MacroAssembler_x86.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -315,10 +315,30 @@</span>
            RuntimeAddress(SharedRuntime::get_ic_miss_stub()));
    const int ic_cmp_size = LP64_ONLY(10) NOT_LP64(9);
    assert(UseCompressedClassPointers || offset() - start_offset == ic_cmp_size, &quot;check alignment in emit_method_entry&quot;);
  }
  
<span class="udiff-line-added">+ void C1_MacroAssembler::build_frame_helper(int frame_size_in_bytes, int sp_inc, bool needs_stack_repair) {</span>
<span class="udiff-line-added">+   push(rbp);</span>
<span class="udiff-line-added">+   if (PreserveFramePointer) {</span>
<span class="udiff-line-added">+     mov(rbp, rsp);</span>
<span class="udiff-line-added">+   }</span>
<span class="udiff-line-added">+   #if !defined(_LP64) &amp;&amp; defined(TIERED)</span>
<span class="udiff-line-added">+     if (UseSSE &lt; 2 ) {</span>
<span class="udiff-line-added">+       // c2 leaves fpu stack dirty. Clean it on entry</span>
<span class="udiff-line-added">+       empty_FPU_stack();</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+   #endif // !_LP64 &amp;&amp; TIERED</span>
<span class="udiff-line-added">+   decrement(rsp, frame_size_in_bytes);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+   if (needs_stack_repair) {</span>
<span class="udiff-line-added">+     // Save stack increment (also account for fixed framesize and rbp)</span>
<span class="udiff-line-added">+     assert((sp_inc &amp; (StackAlignmentInBytes-1)) == 0, &quot;stack increment not aligned&quot;);</span>
<span class="udiff-line-added">+     int real_frame_size = sp_inc + frame_size_in_bytes + wordSize;</span>
<span class="udiff-line-added">+     movptr(Address(rsp, frame_size_in_bytes - wordSize), real_frame_size);</span>
<span class="udiff-line-added">+   }</span>
<span class="udiff-line-added">+ }</span>
  
  void C1_MacroAssembler::build_frame(int frame_size_in_bytes, int bang_size_in_bytes, int sp_offset_for_orig_pc, bool needs_stack_repair, bool has_scalarized_args, Label* verified_value_entry_label) {
    if (has_scalarized_args) {
      // Initialize orig_pc to detect deoptimization during buffering in the entry points
      movptr(Address(rsp, sp_offset_for_orig_pc - frame_size_in_bytes - wordSize), 0);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -331,30 +351,18 @@</span>
    // ordering of C2&#39;s stack overflow check / rsp decrement and allows
    // the SharedRuntime stack overflow handling to be consistent
    // between the two compilers.
    assert(bang_size_in_bytes &gt;= frame_size_in_bytes, &quot;stack bang size incorrect&quot;);
    generate_stack_overflow_check(bang_size_in_bytes);
<span class="udiff-line-removed">-   push(rbp);</span>
<span class="udiff-line-removed">-   if (PreserveFramePointer) {</span>
<span class="udiff-line-removed">-     mov(rbp, rsp);</span>
<span class="udiff-line-removed">-   }</span>
<span class="udiff-line-removed">- #if !defined(_LP64) &amp;&amp; defined(TIERED)</span>
<span class="udiff-line-removed">-   if (UseSSE &lt; 2 ) {</span>
<span class="udiff-line-removed">-     // c2 leaves fpu stack dirty. Clean it on entry</span>
<span class="udiff-line-removed">-     empty_FPU_stack();</span>
<span class="udiff-line-removed">-   }</span>
<span class="udiff-line-removed">- #endif // !_LP64 &amp;&amp; TIERED</span>
<span class="udiff-line-removed">-   decrement(rsp, frame_size_in_bytes); // does not emit code for frame_size == 0</span>
<span class="udiff-line-removed">-   if (needs_stack_repair) {</span>
<span class="udiff-line-removed">-     // Save stack increment (also account for rbp)</span>
<span class="udiff-line-removed">-     int real_frame_size = frame_size_in_bytes + wordSize;</span>
<span class="udiff-line-removed">-     movptr(Address(rsp, frame_size_in_bytes - wordSize), real_frame_size);</span>
<span class="udiff-line-removed">-     if (verified_value_entry_label != NULL) {</span>
<span class="udiff-line-removed">-       bind(*verified_value_entry_label);</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">-   }</span>
  
<span class="udiff-line-added">+   build_frame_helper(frame_size_in_bytes, 0, needs_stack_repair);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+   if (needs_stack_repair &amp;&amp; verified_value_entry_label != NULL) {</span>
<span class="udiff-line-added">+     // Jump here from the scalarized entry points that require additional stack space</span>
<span class="udiff-line-added">+     // for packing scalarized arguments and therefore already created the frame.</span>
<span class="udiff-line-added">+     bind(*verified_value_entry_label);</span>
<span class="udiff-line-added">+   }</span>
    BarrierSetAssembler* bs = BarrierSet::barrier_set()-&gt;barrier_set_assembler();
    bs-&gt;nmethod_entry_barrier(this);
  }
  
  void C1_MacroAssembler::verified_entry() {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -402,22 +410,11 @@</span>
      subptr(rsp, sp_inc);
      push(r13);
    }
  
    // Create a temp frame so we can call into the runtime. It must be properly set up to accommodate GC.
<span class="udiff-line-modified-removed">-   push(rbp);</span>
<span class="udiff-line-removed">-   if (PreserveFramePointer) {</span>
<span class="udiff-line-removed">-     mov(rbp, rsp);</span>
<span class="udiff-line-removed">-   }</span>
<span class="udiff-line-removed">-   subptr(rsp, frame_size_in_bytes);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-   if (ces-&gt;c1_needs_stack_repair()) {</span>
<span class="udiff-line-removed">-     // Save stack increment (also account for fixed framesize and rbp)</span>
<span class="udiff-line-removed">-     assert((sp_inc &amp; (StackAlignmentInBytes-1)) == 0, &quot;stack increment not aligned&quot;);</span>
<span class="udiff-line-removed">-     int real_frame_size = sp_inc + frame_size_in_bytes + wordSize;</span>
<span class="udiff-line-removed">-     movptr(Address(rsp, frame_size_in_bytes - wordSize), real_frame_size);</span>
<span class="udiff-line-removed">-   }</span>
<span class="udiff-line-modified-added">+   build_frame_helper(frame_size_in_bytes, sp_inc, ces-&gt;c1_needs_stack_repair());</span>
  
    // Initialize orig_pc to detect deoptimization during buffering in below runtime call
    movptr(Address(rsp, sp_offset_for_orig_pc), 0);
  
    // FIXME -- call runtime only if we cannot in-line allocate all the incoming value args.
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -436,23 +433,13 @@</span>
    shuffle_value_args(true, is_value_ro_entry, extra_stack_offset, sig_bt, sig_cc,
                       args_passed_cc, args_on_stack_cc, regs_cc, // from
                       args_passed, args_on_stack, regs, sp_inc); // to
  
    if (ces-&gt;c1_needs_stack_repair()) {
<span class="udiff-line-modified-removed">-     // Skip over the stack banging and frame setup code in the</span>
<span class="udiff-line-modified-removed">-     // verified_value_entry (which has a different real_frame_size).</span>
<span class="udiff-line-modified-removed">-     push(rbp);</span>
<span class="udiff-line-removed">-     if (PreserveFramePointer) {</span>
<span class="udiff-line-removed">-       mov(rbp, rsp);</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- #if !defined(_LP64) &amp;&amp; defined(TIERED)</span>
<span class="udiff-line-removed">-     // c2 leaves fpu stack dirty. Clean it on entry</span>
<span class="udiff-line-removed">-     if (UseSSE &lt; 2 ) {</span>
<span class="udiff-line-removed">-       empty_FPU_stack();</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- #endif // TIERED</span>
<span class="udiff-line-removed">-     decrement(rsp, frame_size_in_bytes);</span>
<span class="udiff-line-modified-added">+     // Create the real frame. Below jump will then skip over the stack banging and frame</span>
<span class="udiff-line-modified-added">+     // setup code in the verified_value_entry (which has a different real_frame_size).</span>
<span class="udiff-line-modified-added">+     build_frame_helper(frame_size_in_bytes, sp_inc, true);</span>
    }
  
    jmp(verified_value_entry_label);
    return rt_call_offset;
  }
</pre>
<center>&lt; prev <a href="../../../../index.html" target="_top">index</a> <a href="frame_x86.cpp.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>