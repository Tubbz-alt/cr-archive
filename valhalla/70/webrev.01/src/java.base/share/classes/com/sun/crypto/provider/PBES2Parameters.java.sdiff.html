<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/java.base/share/classes/com/sun/crypto/provider/PBES2Parameters.java</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="OAEPParameters.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="SunJCE.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/java.base/share/classes/com/sun/crypto/provider/PBES2Parameters.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 76  *
 77  * PBKDF2-PRFs ALGORITHM-IDENTIFIER ::= {
 78  *     {NULL IDENTIFIED BY id-hmacWithSHA1} |
 79  *     {NULL IDENTIFIED BY id-hmacWithSHA224} |
 80  *     {NULL IDENTIFIED BY id-hmacWithSHA256} |
 81  *     {NULL IDENTIFIED BY id-hmacWithSHA384} |
 82  *     {NULL IDENTIFIED BY id-hmacWithSHA512}, ... }
 83  *
 84  * algid-hmacWithSHA1 AlgorithmIdentifier {{PBKDF2-PRFs}} ::=
 85  *     {algorithm id-hmacWithSHA1, parameters NULL : NULL}
 86  *
 87  * id-hmacWithSHA1 OBJECT IDENTIFIER ::= {digestAlgorithm 7}
 88  *
 89  * PBES2-Encs ALGORITHM-IDENTIFIER ::= { ... }
 90  *
 91  * &lt;/pre&gt;
 92  */
 93 abstract class PBES2Parameters extends AlgorithmParametersSpi {
 94 
 95     private static ObjectIdentifier pkcs5PBKDF2_OID =
<span class="line-modified"> 96             ObjectIdentifier.of(&quot;1.2.840.113549.1.5.12&quot;);</span>
 97     private static ObjectIdentifier pkcs5PBES2_OID =
<span class="line-modified"> 98             ObjectIdentifier.of(&quot;1.2.840.113549.1.5.13&quot;);</span>
<span class="line-removed"> 99     private static ObjectIdentifier hmacWithSHA1_OID =</span>
<span class="line-removed">100             ObjectIdentifier.of(&quot;1.2.840.113549.2.7&quot;);</span>
<span class="line-removed">101     private static ObjectIdentifier hmacWithSHA224_OID =</span>
<span class="line-removed">102             ObjectIdentifier.of(&quot;1.2.840.113549.2.8&quot;);</span>
<span class="line-removed">103     private static ObjectIdentifier hmacWithSHA256_OID =</span>
<span class="line-removed">104             ObjectIdentifier.of(&quot;1.2.840.113549.2.9&quot;);</span>
<span class="line-removed">105     private static ObjectIdentifier hmacWithSHA384_OID =</span>
<span class="line-removed">106             ObjectIdentifier.of(&quot;1.2.840.113549.2.10&quot;);</span>
<span class="line-removed">107     private static ObjectIdentifier hmacWithSHA512_OID =</span>
<span class="line-removed">108             ObjectIdentifier.of(&quot;1.2.840.113549.2.11&quot;);</span>
109     private static ObjectIdentifier aes128CBC_OID =
<span class="line-modified">110             ObjectIdentifier.of(&quot;2.16.840.1.101.3.4.1.2&quot;);</span>
111     private static ObjectIdentifier aes192CBC_OID =
<span class="line-modified">112             ObjectIdentifier.of(&quot;2.16.840.1.101.3.4.1.22&quot;);</span>
113     private static ObjectIdentifier aes256CBC_OID =
<span class="line-modified">114             ObjectIdentifier.of(&quot;2.16.840.1.101.3.4.1.42&quot;);</span>
115 
116     // the PBES2 algorithm name
117     private String pbes2AlgorithmName = null;
118 
119     // the salt
120     private byte[] salt = null;
121 
122     // the iteration count
123     private int iCount = 0;
124 
125     // the cipher parameter
126     private AlgorithmParameterSpec cipherParam = null;
127 
128     // the key derivation function (default is HmacSHA1)
<span class="line-modified">129     private ObjectIdentifier kdfAlgo_OID = hmacWithSHA1_OID;</span>

130 
131     // the encryption function
132     private ObjectIdentifier cipherAlgo_OID = null;
133 
134     // the cipher keysize (in bits)
135     private int keysize = -1;
136 
137     PBES2Parameters() {
138         // KDF, encryption &amp; keysize values are set later, in engineInit(byte[])
139     }
140 
141     PBES2Parameters(String pbes2AlgorithmName) throws NoSuchAlgorithmException {
142         int and;
143         String kdfAlgo = null;
144         String cipherAlgo = null;
145 
146         // Extract the KDF and encryption algorithm names
147         this.pbes2AlgorithmName = pbes2AlgorithmName;
148         if (pbes2AlgorithmName.startsWith(&quot;PBEWith&quot;) &amp;&amp;
149             (and = pbes2AlgorithmName.indexOf(&quot;And&quot;, 7 + 1)) &gt; 0) {
</pre>
<hr />
<pre>
154             int underscore;
155             if ((underscore = cipherAlgo.indexOf(&#39;_&#39;)) &gt; 0) {
156                 int slash;
157                 if ((slash = cipherAlgo.indexOf(&#39;/&#39;, underscore + 1)) &gt; 0) {
158                     keysize =
159                         Integer.parseInt(cipherAlgo.substring(underscore + 1,
160                             slash));
161                 } else {
162                     keysize =
163                         Integer.parseInt(cipherAlgo.substring(underscore + 1));
164                 }
165                 cipherAlgo = cipherAlgo.substring(0, underscore);
166             }
167         } else {
168             throw new NoSuchAlgorithmException(&quot;No crypto implementation for &quot; +
169                 pbes2AlgorithmName);
170         }
171 
172         switch (kdfAlgo) {
173         case &quot;HmacSHA1&quot;:
<span class="line-removed">174             kdfAlgo_OID = hmacWithSHA1_OID;</span>
<span class="line-removed">175             break;</span>
176         case &quot;HmacSHA224&quot;:
<span class="line-removed">177             kdfAlgo_OID = hmacWithSHA224_OID;</span>
<span class="line-removed">178             break;</span>
179         case &quot;HmacSHA256&quot;:
<span class="line-removed">180             kdfAlgo_OID = hmacWithSHA256_OID;</span>
<span class="line-removed">181             break;</span>
182         case &quot;HmacSHA384&quot;:
<span class="line-removed">183             kdfAlgo_OID = hmacWithSHA384_OID;</span>
<span class="line-removed">184             break;</span>
185         case &quot;HmacSHA512&quot;:
<span class="line-modified">186             kdfAlgo_OID = hmacWithSHA512_OID;</span>
187             break;
188         default:
189             throw new NoSuchAlgorithmException(
190                 &quot;No crypto implementation for &quot; + kdfAlgo);
191         }
192 
193         if (cipherAlgo.equals(&quot;AES&quot;)) {
194             this.keysize = keysize;
195             switch (keysize) {
196             case 128:
197                 cipherAlgo_OID = aes128CBC_OID;
198                 break;
199             case 256:
200                 cipherAlgo_OID = aes256CBC_OID;
201                 break;
202             default:
203                 throw new NoSuchAlgorithmException(
204                     &quot;No Cipher implementation for &quot; + keysize + &quot;-bit &quot; +
205                         cipherAlgo);
206             }
</pre>
<hr />
<pre>
238 
239         // Before JDK-8202837, PBES2-params was mistakenly encoded like
240         // an AlgorithmId which is a sequence of its own OID and the real
241         // PBES2-params. If the first DerValue is an OID instead of a
242         // PBES2-KDFs (which should be a SEQUENCE), we are likely to be
243         // dealing with this buggy encoding. Skip the OID and treat the
244         // next DerValue as the real PBES2-params.
245         if (kdf.getTag() == DerValue.tag_ObjectId) {
246             pBES2_params = pBES2_params.data.getDerValue();
247             kdf = pBES2_params.data.getDerValue();
248         }
249 
250         kdfAlgo = parseKDF(kdf);
251 
252         if (pBES2_params.tag != DerValue.tag_Sequence) {
253             throw new IOException(&quot;PBE parameter parsing error: &quot;
254                 + &quot;not an ASN.1 SEQUENCE tag&quot;);
255         }
256         cipherAlgo = parseES(pBES2_params.data.getDerValue());
257 
<span class="line-modified">258         pbes2AlgorithmName = new StringBuilder().append(&quot;PBEWith&quot;)</span>
259             .append(kdfAlgo).append(&quot;And&quot;).append(cipherAlgo).toString();
260     }
261 
262     @SuppressWarnings(&quot;deprecation&quot;)
263     private String parseKDF(DerValue keyDerivationFunc) throws IOException {
264 
265         if (!pkcs5PBKDF2_OID.equals(keyDerivationFunc.data.getOID())) {
266             throw new IOException(&quot;PBE parameter parsing error: &quot;
267                 + &quot;expecting the object identifier for PBKDF2&quot;);
268         }
269         if (keyDerivationFunc.tag != DerValue.tag_Sequence) {
270             throw new IOException(&quot;PBE parameter parsing error: &quot;
271                 + &quot;not an ASN.1 SEQUENCE tag&quot;);
272         }
273         DerValue pBKDF2_params = keyDerivationFunc.data.getDerValue();
274         if (pBKDF2_params.tag != DerValue.tag_Sequence) {
275             throw new IOException(&quot;PBE parameter parsing error: &quot;
276                 + &quot;not an ASN.1 SEQUENCE tag&quot;);
277         }
278         DerValue specified = pBKDF2_params.data.getDerValue();
</pre>
<hr />
<pre>
289         DerValue prf = null;
290         // keyLength INTEGER (1..MAX) OPTIONAL,
291         if (pBKDF2_params.data.available() &gt; 0) {
292             DerValue keyLength = pBKDF2_params.data.getDerValue();
293             if (keyLength.tag == DerValue.tag_Integer) {
294                 keysize = keyLength.getInteger() * 8; // keysize (in bits)
295             } else {
296                 // Should be the prf
297                 prf = keyLength;
298             }
299         }
300         // prf AlgorithmIdentifier {{PBKDF2-PRFs}} DEFAULT algid-hmacWithSHA1
301         String kdfAlgo = &quot;HmacSHA1&quot;;
302         if (prf == null) {
303             if (pBKDF2_params.data.available() &gt; 0) {
304                 prf = pBKDF2_params.data.getDerValue();
305             }
306         }
307         if (prf != null) {
308             kdfAlgo_OID = prf.data.getOID();
<span class="line-modified">309             if (hmacWithSHA1_OID.equals(kdfAlgo_OID)) {</span>
<span class="line-modified">310                 kdfAlgo = &quot;HmacSHA1&quot;;</span>
<span class="line-modified">311             } else if (hmacWithSHA224_OID.equals(kdfAlgo_OID)) {</span>
<span class="line-modified">312                 kdfAlgo = &quot;HmacSHA224&quot;;</span>
<span class="line-modified">313             } else if (hmacWithSHA256_OID.equals(kdfAlgo_OID)) {</span>
<span class="line-modified">314                 kdfAlgo = &quot;HmacSHA256&quot;;</span>
<span class="line-removed">315             } else if (hmacWithSHA384_OID.equals(kdfAlgo_OID)) {</span>
<span class="line-removed">316                 kdfAlgo = &quot;HmacSHA384&quot;;</span>
<span class="line-removed">317             } else if (hmacWithSHA512_OID.equals(kdfAlgo_OID)) {</span>
<span class="line-removed">318                 kdfAlgo = &quot;HmacSHA512&quot;;</span>
<span class="line-removed">319             } else {</span>
320                 throw new IOException(&quot;PBE parameter parsing error: &quot;
321                         + &quot;expecting the object identifier for a HmacSHA key &quot;
322                         + &quot;derivation function&quot;);
323             }


324             if (prf.data.available() != 0) {
325                 // parameter is &#39;NULL&#39; for all HmacSHA KDFs
326                 DerValue parameter = prf.data.getDerValue();
327                 if (parameter.tag != DerValue.tag_Null) {
328                     throw new IOException(&quot;PBE parameter parsing error: &quot;
329                             + &quot;not an ASN.1 NULL tag&quot;);
330                 }
331             }
332         }
333 
334         return kdfAlgo;
335     }
336 
337     @SuppressWarnings(&quot;deprecation&quot;)
338     private String parseES(DerValue encryptionScheme) throws IOException {
339         String cipherAlgo = null;
340 
341         cipherAlgo_OID = encryptionScheme.data.getOID();
342         if (aes128CBC_OID.equals(cipherAlgo_OID)) {
343             cipherAlgo = &quot;AES_128&quot;;
</pre>
</td>
<td>
<hr />
<pre>
 76  *
 77  * PBKDF2-PRFs ALGORITHM-IDENTIFIER ::= {
 78  *     {NULL IDENTIFIED BY id-hmacWithSHA1} |
 79  *     {NULL IDENTIFIED BY id-hmacWithSHA224} |
 80  *     {NULL IDENTIFIED BY id-hmacWithSHA256} |
 81  *     {NULL IDENTIFIED BY id-hmacWithSHA384} |
 82  *     {NULL IDENTIFIED BY id-hmacWithSHA512}, ... }
 83  *
 84  * algid-hmacWithSHA1 AlgorithmIdentifier {{PBKDF2-PRFs}} ::=
 85  *     {algorithm id-hmacWithSHA1, parameters NULL : NULL}
 86  *
 87  * id-hmacWithSHA1 OBJECT IDENTIFIER ::= {digestAlgorithm 7}
 88  *
 89  * PBES2-Encs ALGORITHM-IDENTIFIER ::= { ... }
 90  *
 91  * &lt;/pre&gt;
 92  */
 93 abstract class PBES2Parameters extends AlgorithmParametersSpi {
 94 
 95     private static ObjectIdentifier pkcs5PBKDF2_OID =
<span class="line-modified"> 96             ObjectIdentifier.of(KnownOIDs.PBKDF2WithHmacSHA1);</span>
 97     private static ObjectIdentifier pkcs5PBES2_OID =
<span class="line-modified"> 98             ObjectIdentifier.of(KnownOIDs.PBES2);</span>










 99     private static ObjectIdentifier aes128CBC_OID =
<span class="line-modified">100             ObjectIdentifier.of(KnownOIDs.AES_128$CBC$NoPadding);</span>
101     private static ObjectIdentifier aes192CBC_OID =
<span class="line-modified">102             ObjectIdentifier.of(KnownOIDs.AES_192$CBC$NoPadding);</span>
103     private static ObjectIdentifier aes256CBC_OID =
<span class="line-modified">104             ObjectIdentifier.of(KnownOIDs.AES_256$CBC$NoPadding);</span>
105 
106     // the PBES2 algorithm name
107     private String pbes2AlgorithmName = null;
108 
109     // the salt
110     private byte[] salt = null;
111 
112     // the iteration count
113     private int iCount = 0;
114 
115     // the cipher parameter
116     private AlgorithmParameterSpec cipherParam = null;
117 
118     // the key derivation function (default is HmacSHA1)
<span class="line-modified">119     private ObjectIdentifier kdfAlgo_OID =</span>
<span class="line-added">120             ObjectIdentifier.of(KnownOIDs.HmacSHA1);</span>
121 
122     // the encryption function
123     private ObjectIdentifier cipherAlgo_OID = null;
124 
125     // the cipher keysize (in bits)
126     private int keysize = -1;
127 
128     PBES2Parameters() {
129         // KDF, encryption &amp; keysize values are set later, in engineInit(byte[])
130     }
131 
132     PBES2Parameters(String pbes2AlgorithmName) throws NoSuchAlgorithmException {
133         int and;
134         String kdfAlgo = null;
135         String cipherAlgo = null;
136 
137         // Extract the KDF and encryption algorithm names
138         this.pbes2AlgorithmName = pbes2AlgorithmName;
139         if (pbes2AlgorithmName.startsWith(&quot;PBEWith&quot;) &amp;&amp;
140             (and = pbes2AlgorithmName.indexOf(&quot;And&quot;, 7 + 1)) &gt; 0) {
</pre>
<hr />
<pre>
145             int underscore;
146             if ((underscore = cipherAlgo.indexOf(&#39;_&#39;)) &gt; 0) {
147                 int slash;
148                 if ((slash = cipherAlgo.indexOf(&#39;/&#39;, underscore + 1)) &gt; 0) {
149                     keysize =
150                         Integer.parseInt(cipherAlgo.substring(underscore + 1,
151                             slash));
152                 } else {
153                     keysize =
154                         Integer.parseInt(cipherAlgo.substring(underscore + 1));
155                 }
156                 cipherAlgo = cipherAlgo.substring(0, underscore);
157             }
158         } else {
159             throw new NoSuchAlgorithmException(&quot;No crypto implementation for &quot; +
160                 pbes2AlgorithmName);
161         }
162 
163         switch (kdfAlgo) {
164         case &quot;HmacSHA1&quot;:


165         case &quot;HmacSHA224&quot;:


166         case &quot;HmacSHA256&quot;:


167         case &quot;HmacSHA384&quot;:


168         case &quot;HmacSHA512&quot;:
<span class="line-modified">169             kdfAlgo_OID = ObjectIdentifier.of(KnownOIDs.findMatch(kdfAlgo));</span>
170             break;
171         default:
172             throw new NoSuchAlgorithmException(
173                 &quot;No crypto implementation for &quot; + kdfAlgo);
174         }
175 
176         if (cipherAlgo.equals(&quot;AES&quot;)) {
177             this.keysize = keysize;
178             switch (keysize) {
179             case 128:
180                 cipherAlgo_OID = aes128CBC_OID;
181                 break;
182             case 256:
183                 cipherAlgo_OID = aes256CBC_OID;
184                 break;
185             default:
186                 throw new NoSuchAlgorithmException(
187                     &quot;No Cipher implementation for &quot; + keysize + &quot;-bit &quot; +
188                         cipherAlgo);
189             }
</pre>
<hr />
<pre>
221 
222         // Before JDK-8202837, PBES2-params was mistakenly encoded like
223         // an AlgorithmId which is a sequence of its own OID and the real
224         // PBES2-params. If the first DerValue is an OID instead of a
225         // PBES2-KDFs (which should be a SEQUENCE), we are likely to be
226         // dealing with this buggy encoding. Skip the OID and treat the
227         // next DerValue as the real PBES2-params.
228         if (kdf.getTag() == DerValue.tag_ObjectId) {
229             pBES2_params = pBES2_params.data.getDerValue();
230             kdf = pBES2_params.data.getDerValue();
231         }
232 
233         kdfAlgo = parseKDF(kdf);
234 
235         if (pBES2_params.tag != DerValue.tag_Sequence) {
236             throw new IOException(&quot;PBE parameter parsing error: &quot;
237                 + &quot;not an ASN.1 SEQUENCE tag&quot;);
238         }
239         cipherAlgo = parseES(pBES2_params.data.getDerValue());
240 
<span class="line-modified">241         this.pbes2AlgorithmName = new StringBuilder().append(&quot;PBEWith&quot;)</span>
242             .append(kdfAlgo).append(&quot;And&quot;).append(cipherAlgo).toString();
243     }
244 
245     @SuppressWarnings(&quot;deprecation&quot;)
246     private String parseKDF(DerValue keyDerivationFunc) throws IOException {
247 
248         if (!pkcs5PBKDF2_OID.equals(keyDerivationFunc.data.getOID())) {
249             throw new IOException(&quot;PBE parameter parsing error: &quot;
250                 + &quot;expecting the object identifier for PBKDF2&quot;);
251         }
252         if (keyDerivationFunc.tag != DerValue.tag_Sequence) {
253             throw new IOException(&quot;PBE parameter parsing error: &quot;
254                 + &quot;not an ASN.1 SEQUENCE tag&quot;);
255         }
256         DerValue pBKDF2_params = keyDerivationFunc.data.getDerValue();
257         if (pBKDF2_params.tag != DerValue.tag_Sequence) {
258             throw new IOException(&quot;PBE parameter parsing error: &quot;
259                 + &quot;not an ASN.1 SEQUENCE tag&quot;);
260         }
261         DerValue specified = pBKDF2_params.data.getDerValue();
</pre>
<hr />
<pre>
272         DerValue prf = null;
273         // keyLength INTEGER (1..MAX) OPTIONAL,
274         if (pBKDF2_params.data.available() &gt; 0) {
275             DerValue keyLength = pBKDF2_params.data.getDerValue();
276             if (keyLength.tag == DerValue.tag_Integer) {
277                 keysize = keyLength.getInteger() * 8; // keysize (in bits)
278             } else {
279                 // Should be the prf
280                 prf = keyLength;
281             }
282         }
283         // prf AlgorithmIdentifier {{PBKDF2-PRFs}} DEFAULT algid-hmacWithSHA1
284         String kdfAlgo = &quot;HmacSHA1&quot;;
285         if (prf == null) {
286             if (pBKDF2_params.data.available() &gt; 0) {
287                 prf = pBKDF2_params.data.getDerValue();
288             }
289         }
290         if (prf != null) {
291             kdfAlgo_OID = prf.data.getOID();
<span class="line-modified">292             KnownOIDs o = KnownOIDs.findMatch(kdfAlgo_OID.toString());</span>
<span class="line-modified">293             if (o == null || (!o.stdName().equals(&quot;HmacSHA1&quot;) &amp;&amp;</span>
<span class="line-modified">294                 !o.stdName().equals(&quot;HmacSHA224&quot;) &amp;&amp;</span>
<span class="line-modified">295                 !o.stdName().equals(&quot;HmacSHA256&quot;) &amp;&amp;</span>
<span class="line-modified">296                 !o.stdName().equals(&quot;HmacSHA384&quot;) &amp;&amp;</span>
<span class="line-modified">297                 !o.stdName().equals(&quot;HmacSHA512&quot;))) {</span>





298                 throw new IOException(&quot;PBE parameter parsing error: &quot;
299                         + &quot;expecting the object identifier for a HmacSHA key &quot;
300                         + &quot;derivation function&quot;);
301             }
<span class="line-added">302             kdfAlgo = o.stdName();</span>
<span class="line-added">303 </span>
304             if (prf.data.available() != 0) {
305                 // parameter is &#39;NULL&#39; for all HmacSHA KDFs
306                 DerValue parameter = prf.data.getDerValue();
307                 if (parameter.tag != DerValue.tag_Null) {
308                     throw new IOException(&quot;PBE parameter parsing error: &quot;
309                             + &quot;not an ASN.1 NULL tag&quot;);
310                 }
311             }
312         }
313 
314         return kdfAlgo;
315     }
316 
317     @SuppressWarnings(&quot;deprecation&quot;)
318     private String parseES(DerValue encryptionScheme) throws IOException {
319         String cipherAlgo = null;
320 
321         cipherAlgo_OID = encryptionScheme.data.getOID();
322         if (aes128CBC_OID.equals(cipherAlgo_OID)) {
323             cipherAlgo = &quot;AES_128&quot;;
</pre>
</td>
</tr>
</table>
<center><a href="OAEPParameters.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="SunJCE.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>