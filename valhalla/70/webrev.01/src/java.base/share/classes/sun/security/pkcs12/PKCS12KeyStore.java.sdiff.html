<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/java.base/share/classes/sun/security/pkcs12/PKCS12KeyStore.java</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
  </head>
<body>
<center><a href="../pkcs/PKCS9Attribute.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="../provider/KeyProtector.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/java.base/share/classes/sun/security/pkcs12/PKCS12KeyStore.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  49 import java.security.spec.InvalidParameterSpecException;
  50 import java.security.spec.KeySpec;
  51 import java.security.spec.PKCS8EncodedKeySpec;
  52 import java.util.*;
  53 
  54 import static java.nio.charset.StandardCharsets.UTF_8;
  55 
  56 import java.security.AlgorithmParameters;
  57 import java.security.InvalidAlgorithmParameterException;
  58 import javax.crypto.spec.PBEParameterSpec;
  59 import javax.crypto.spec.PBEKeySpec;
  60 import javax.crypto.spec.SecretKeySpec;
  61 import javax.crypto.SecretKeyFactory;
  62 import javax.crypto.SecretKey;
  63 import javax.crypto.Cipher;
  64 import javax.crypto.Mac;
  65 import javax.security.auth.DestroyFailedException;
  66 import javax.security.auth.x500.X500Principal;
  67 
  68 import sun.security.tools.KeyStoreUtil;
<span class="line-modified">  69 import sun.security.util.Debug;</span>
<span class="line-removed">  70 import sun.security.util.DerInputStream;</span>
<span class="line-removed">  71 import sun.security.util.DerOutputStream;</span>
<span class="line-removed">  72 import sun.security.util.DerValue;</span>
<span class="line-removed">  73 import sun.security.util.ObjectIdentifier;</span>
  74 import sun.security.pkcs.ContentInfo;
<span class="line-removed">  75 import sun.security.util.SecurityProperties;</span>
  76 import sun.security.x509.AlgorithmId;
  77 import sun.security.pkcs.EncryptedPrivateKeyInfo;
  78 import sun.security.provider.JavaKeyStore.JKS;
<span class="line-removed">  79 import sun.security.util.KeyStoreDelegator;</span>
  80 import sun.security.x509.AuthorityKeyIdentifierExtension;
  81 
  82 
  83 /**
  84  * This class provides the keystore implementation referred to as &quot;PKCS12&quot;.
  85  * Implements the PKCS#12 PFX protected using the Password privacy mode.
  86  * The contents are protected using Password integrity mode.
  87  *
  88  * Currently these PBE algorithms are used by default:
  89  *  - PBEWithSHA1AndDESede to encrypt private keys, iteration count 50000.
  90  *  - PBEWithSHA1AndRC2_40 to encrypt certificates, iteration count 50000.
  91  *
  92  * The default Mac algorithm is  HmacPBESHA1, iteration count 100000.
  93  *
  94  * Supported encryption of various implementations :
  95  *
  96  * Software and mode.     Certificate encryption  Private key encryption
  97  * ---------------------------------------------------------------------
  98  * MSIE4 (domestic            40 bit RC2.            40 bit RC2
  99  * and xport versions)
</pre>
<hr />
<pre>
 131  * @author Seema Malkani
 132  * @author Jeff Nisewanger
 133  * @author Jan Luehe
 134  *
 135  * @see java.security.KeyStoreSpi
 136  */
 137 public final class PKCS12KeyStore extends KeyStoreSpi {
 138 
 139     // special PKCS12 keystore that supports PKCS12 and JKS file formats
 140     public static final class DualFormatPKCS12 extends KeyStoreDelegator {
 141         public DualFormatPKCS12() {
 142             super(&quot;PKCS12&quot;, PKCS12KeyStore.class, &quot;JKS&quot;, JKS.class);
 143         }
 144     }
 145 
 146     public static final int VERSION_3 = 3;
 147 
 148     private static final int MAX_ITERATION_COUNT = 5000000;
 149     private static final int SALT_LEN = 20;
 150 
<span class="line-modified"> 151     // friendlyName, localKeyId, trustedKeyUsage</span>
<span class="line-modified"> 152     private static final String[] CORE_ATTRIBUTES = {</span>
<span class="line-modified"> 153         &quot;1.2.840.113549.1.9.20&quot;,</span>
<span class="line-modified"> 154         &quot;1.2.840.113549.1.9.21&quot;,</span>
<span class="line-removed"> 155         &quot;2.16.840.1.113894.746875.1.1&quot;</span>
 156     };
 157 
 158     private static final Debug debug = Debug.getInstance(&quot;pkcs12&quot;);
 159 
 160     private static final ObjectIdentifier PKCS8ShroudedKeyBag_OID =
<span class="line-modified"> 161             ObjectIdentifier.of(&quot;1.2.840.113549.1.12.10.1.2&quot;);</span>
 162     private static final ObjectIdentifier CertBag_OID =
<span class="line-modified"> 163             ObjectIdentifier.of(&quot;1.2.840.113549.1.12.10.1.3&quot;);</span>
 164     private static final ObjectIdentifier SecretBag_OID =
<span class="line-modified"> 165             ObjectIdentifier.of(&quot;1.2.840.113549.1.12.10.1.5&quot;);</span>

 166     private static final ObjectIdentifier PKCS9FriendlyName_OID =
<span class="line-modified"> 167             ObjectIdentifier.of(&quot;1.2.840.113549.1.9.20&quot;);</span>
 168     private static final ObjectIdentifier PKCS9LocalKeyId_OID =
<span class="line-modified"> 169             ObjectIdentifier.of(&quot;1.2.840.113549.1.9.21&quot;);</span>
 170     private static final ObjectIdentifier PKCS9CertType_OID =
<span class="line-modified"> 171             ObjectIdentifier.of(&quot;1.2.840.113549.1.9.22.1&quot;);</span>
 172     private static final ObjectIdentifier pbes2_OID =
<span class="line-modified"> 173             ObjectIdentifier.of(&quot;1.2.840.113549.1.5.13&quot;);</span>
 174 
 175     /*
 176      * Temporary Oracle OID
 177      *
 178      * {joint-iso-itu-t(2) country(16) us(840) organization(1)
 179      *  oracle(113894) jdk(746875) crypto(1) id-at-trustedKeyUsage(1)}
 180      */
 181     private static final ObjectIdentifier TrustedKeyUsage_OID =
<span class="line-modified"> 182             ObjectIdentifier.of(&quot;2.16.840.1.113894.746875.1.1&quot;);</span>
 183 
 184     private static final ObjectIdentifier[] AnyUsage = new ObjectIdentifier[] {
<span class="line-modified"> 185                 // AnyExtendedKeyUsage</span>
<span class="line-removed"> 186                 ObjectIdentifier.of(&quot;2.5.29.37.0&quot;)</span>
 187             };
 188 
 189     private int counter = 0;
 190 
 191     // private key count
 192     // Note: This is a workaround to allow null localKeyID attribute
 193     // in pkcs12 with one private key entry and associated cert-chain
 194     private int privateKeyCount = 0;
 195 
 196     // secret key count
 197     private int secretKeyCount = 0;
 198 
 199     // certificate count
 200     private int certificateCount = 0;
 201 
 202     // Alg/params used for *this* keystore. Initialized as -1 for ic and
 203     // null for algorithm names. When an existing file is read, they will be
 204     // assigned inside engineLoad() so storing an existing keystore uses the
 205     // old alg/params. This makes sure if a keystore is created password-less
 206     // it will be password-less forever. Otherwise, engineStore() will read
</pre>
<hr />
<pre>
1626             bagAttr3.write(DerValue.tag_Set, bagAttrContent3);
1627             bagAttrValue3.write(DerValue.tag_Sequence, bagAttr3);
1628             trustedKeyUsage = bagAttrValue3.toByteArray();
1629         }
1630 
1631         DerOutputStream attrs = new DerOutputStream();
1632         if (friendlyName != null) {
1633             attrs.write(friendlyName);
1634         }
1635         if (localKeyID != null) {
1636             attrs.write(localKeyID);
1637         }
1638         if (trustedKeyUsage != null) {
1639             attrs.write(trustedKeyUsage);
1640         }
1641 
1642         if (attributes != null) {
1643             for (KeyStore.Entry.Attribute attribute : attributes) {
1644                 String attributeName = attribute.getName();
1645                 // skip friendlyName, localKeyId and trustedKeyUsage
<span class="line-modified">1646                 if (CORE_ATTRIBUTES[0].equals(attributeName) ||</span>
<span class="line-modified">1647                     CORE_ATTRIBUTES[1].equals(attributeName) ||</span>
<span class="line-modified">1648                     CORE_ATTRIBUTES[2].equals(attributeName)) {</span>
1649                     continue;
1650                 }
1651                 attrs.write(((PKCS12Attribute) attribute).getEncoded());
1652             }
1653         }
1654 
1655         bagAttrs.write(DerValue.tag_Set, attrs);
1656         return bagAttrs.toByteArray();
1657     }
1658 
1659     /*
1660      * Create EncryptedData content type, that contains EncryptedContentInfo.
1661      * Includes certificates in individual SafeBags of type CertBag.
1662      * Each CertBag may include pkcs12 attributes
1663      * (see comments in getBagAttributes)
1664      */
1665     private byte[] createEncryptedData(char[] password)
1666         throws CertificateException, IOException
1667     {
1668         DerOutputStream out = new DerOutputStream();
</pre>
</td>
<td>
<hr />
<pre>
  49 import java.security.spec.InvalidParameterSpecException;
  50 import java.security.spec.KeySpec;
  51 import java.security.spec.PKCS8EncodedKeySpec;
  52 import java.util.*;
  53 
  54 import static java.nio.charset.StandardCharsets.UTF_8;
  55 
  56 import java.security.AlgorithmParameters;
  57 import java.security.InvalidAlgorithmParameterException;
  58 import javax.crypto.spec.PBEParameterSpec;
  59 import javax.crypto.spec.PBEKeySpec;
  60 import javax.crypto.spec.SecretKeySpec;
  61 import javax.crypto.SecretKeyFactory;
  62 import javax.crypto.SecretKey;
  63 import javax.crypto.Cipher;
  64 import javax.crypto.Mac;
  65 import javax.security.auth.DestroyFailedException;
  66 import javax.security.auth.x500.X500Principal;
  67 
  68 import sun.security.tools.KeyStoreUtil;
<span class="line-modified">  69 import sun.security.util.*;</span>




  70 import sun.security.pkcs.ContentInfo;

  71 import sun.security.x509.AlgorithmId;
  72 import sun.security.pkcs.EncryptedPrivateKeyInfo;
  73 import sun.security.provider.JavaKeyStore.JKS;

  74 import sun.security.x509.AuthorityKeyIdentifierExtension;
  75 
  76 
  77 /**
  78  * This class provides the keystore implementation referred to as &quot;PKCS12&quot;.
  79  * Implements the PKCS#12 PFX protected using the Password privacy mode.
  80  * The contents are protected using Password integrity mode.
  81  *
  82  * Currently these PBE algorithms are used by default:
  83  *  - PBEWithSHA1AndDESede to encrypt private keys, iteration count 50000.
  84  *  - PBEWithSHA1AndRC2_40 to encrypt certificates, iteration count 50000.
  85  *
  86  * The default Mac algorithm is  HmacPBESHA1, iteration count 100000.
  87  *
  88  * Supported encryption of various implementations :
  89  *
  90  * Software and mode.     Certificate encryption  Private key encryption
  91  * ---------------------------------------------------------------------
  92  * MSIE4 (domestic            40 bit RC2.            40 bit RC2
  93  * and xport versions)
</pre>
<hr />
<pre>
 125  * @author Seema Malkani
 126  * @author Jeff Nisewanger
 127  * @author Jan Luehe
 128  *
 129  * @see java.security.KeyStoreSpi
 130  */
 131 public final class PKCS12KeyStore extends KeyStoreSpi {
 132 
 133     // special PKCS12 keystore that supports PKCS12 and JKS file formats
 134     public static final class DualFormatPKCS12 extends KeyStoreDelegator {
 135         public DualFormatPKCS12() {
 136             super(&quot;PKCS12&quot;, PKCS12KeyStore.class, &quot;JKS&quot;, JKS.class);
 137         }
 138     }
 139 
 140     public static final int VERSION_3 = 3;
 141 
 142     private static final int MAX_ITERATION_COUNT = 5000000;
 143     private static final int SALT_LEN = 20;
 144 
<span class="line-modified"> 145     private static final KnownOIDs[] CORE_ATTRIBUTES = {</span>
<span class="line-modified"> 146         KnownOIDs.FriendlyName,</span>
<span class="line-modified"> 147         KnownOIDs.LocalKeyID,</span>
<span class="line-modified"> 148         KnownOIDs.ORACLE_TrustedKeyUsage</span>

 149     };
 150 
 151     private static final Debug debug = Debug.getInstance(&quot;pkcs12&quot;);
 152 
 153     private static final ObjectIdentifier PKCS8ShroudedKeyBag_OID =
<span class="line-modified"> 154             ObjectIdentifier.of(KnownOIDs.PKCS8ShroudedKeyBag);</span>
 155     private static final ObjectIdentifier CertBag_OID =
<span class="line-modified"> 156             ObjectIdentifier.of(KnownOIDs.CertBag);</span>
 157     private static final ObjectIdentifier SecretBag_OID =
<span class="line-modified"> 158             ObjectIdentifier.of(KnownOIDs.SecretBag);</span>
<span class="line-added"> 159 </span>
 160     private static final ObjectIdentifier PKCS9FriendlyName_OID =
<span class="line-modified"> 161             ObjectIdentifier.of(KnownOIDs.FriendlyName);</span>
 162     private static final ObjectIdentifier PKCS9LocalKeyId_OID =
<span class="line-modified"> 163             ObjectIdentifier.of(KnownOIDs.LocalKeyID);</span>
 164     private static final ObjectIdentifier PKCS9CertType_OID =
<span class="line-modified"> 165             ObjectIdentifier.of(KnownOIDs.CertTypeX509);</span>
 166     private static final ObjectIdentifier pbes2_OID =
<span class="line-modified"> 167             ObjectIdentifier.of(KnownOIDs.PBES2);</span>
 168 
 169     /*
 170      * Temporary Oracle OID
 171      *
 172      * {joint-iso-itu-t(2) country(16) us(840) organization(1)
 173      *  oracle(113894) jdk(746875) crypto(1) id-at-trustedKeyUsage(1)}
 174      */
 175     private static final ObjectIdentifier TrustedKeyUsage_OID =
<span class="line-modified"> 176             ObjectIdentifier.of(KnownOIDs.ORACLE_TrustedKeyUsage);</span>
 177 
 178     private static final ObjectIdentifier[] AnyUsage = new ObjectIdentifier[] {
<span class="line-modified"> 179                 ObjectIdentifier.of(KnownOIDs.anyExtendedKeyUsage)</span>

 180             };
 181 
 182     private int counter = 0;
 183 
 184     // private key count
 185     // Note: This is a workaround to allow null localKeyID attribute
 186     // in pkcs12 with one private key entry and associated cert-chain
 187     private int privateKeyCount = 0;
 188 
 189     // secret key count
 190     private int secretKeyCount = 0;
 191 
 192     // certificate count
 193     private int certificateCount = 0;
 194 
 195     // Alg/params used for *this* keystore. Initialized as -1 for ic and
 196     // null for algorithm names. When an existing file is read, they will be
 197     // assigned inside engineLoad() so storing an existing keystore uses the
 198     // old alg/params. This makes sure if a keystore is created password-less
 199     // it will be password-less forever. Otherwise, engineStore() will read
</pre>
<hr />
<pre>
1619             bagAttr3.write(DerValue.tag_Set, bagAttrContent3);
1620             bagAttrValue3.write(DerValue.tag_Sequence, bagAttr3);
1621             trustedKeyUsage = bagAttrValue3.toByteArray();
1622         }
1623 
1624         DerOutputStream attrs = new DerOutputStream();
1625         if (friendlyName != null) {
1626             attrs.write(friendlyName);
1627         }
1628         if (localKeyID != null) {
1629             attrs.write(localKeyID);
1630         }
1631         if (trustedKeyUsage != null) {
1632             attrs.write(trustedKeyUsage);
1633         }
1634 
1635         if (attributes != null) {
1636             for (KeyStore.Entry.Attribute attribute : attributes) {
1637                 String attributeName = attribute.getName();
1638                 // skip friendlyName, localKeyId and trustedKeyUsage
<span class="line-modified">1639                 if (CORE_ATTRIBUTES[0].value().equals(attributeName) ||</span>
<span class="line-modified">1640                     CORE_ATTRIBUTES[1].value().equals(attributeName) ||</span>
<span class="line-modified">1641                     CORE_ATTRIBUTES[2].value().equals(attributeName)) {</span>
1642                     continue;
1643                 }
1644                 attrs.write(((PKCS12Attribute) attribute).getEncoded());
1645             }
1646         }
1647 
1648         bagAttrs.write(DerValue.tag_Set, attrs);
1649         return bagAttrs.toByteArray();
1650     }
1651 
1652     /*
1653      * Create EncryptedData content type, that contains EncryptedContentInfo.
1654      * Includes certificates in individual SafeBags of type CertBag.
1655      * Each CertBag may include pkcs12 attributes
1656      * (see comments in getBagAttributes)
1657      */
1658     private byte[] createEncryptedData(char[] password)
1659         throws CertificateException, IOException
1660     {
1661         DerOutputStream out = new DerOutputStream();
</pre>
</td>
</tr>
</table>
<center><a href="../pkcs/PKCS9Attribute.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="../provider/KeyProtector.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>