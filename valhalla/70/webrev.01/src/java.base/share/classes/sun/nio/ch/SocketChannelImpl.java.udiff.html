<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff src/java.base/share/classes/sun/nio/ch/SocketChannelImpl.java</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
  </head>
<body>
<center><a href="ServerSocketChannelImpl.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="../../security/pkcs/ContentInfo.java.udiff.html" target="_top">next &gt;</a></center>    <h2>src/java.base/share/classes/sun/nio/ch/SocketChannelImpl.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -26,10 +26,11 @@</span>
  package sun.nio.ch;
  
  import java.io.FileDescriptor;
  import java.io.IOException;
  import java.net.InetAddress;
<span class="udiff-line-added">+ import java.net.Inet4Address;</span>
  import java.net.InetSocketAddress;
  import java.net.ProtocolFamily;
  import java.net.Socket;
  import java.net.SocketAddress;
  import java.net.SocketException;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -69,10 +70,13 @@</span>
      implements SelChImpl
  {
      // Used to make native read and write calls
      private static final NativeDispatcher nd = new SocketDispatcher();
  
<span class="udiff-line-added">+     // The protocol family of the socket</span>
<span class="udiff-line-added">+     private final ProtocolFamily family;</span>
<span class="udiff-line-added">+ </span>
      // Our file descriptor object
      private final FileDescriptor fd;
      private final int fdVal;
  
      // Lock held by current reading or connecting thread
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -116,38 +120,60 @@</span>
      // Socket adaptor, created on demand
      private Socket socket;
  
      // -- End of fields protected by stateLock
  
<span class="udiff-line-removed">- </span>
      // Constructor for normal connecting sockets
      //
      SocketChannelImpl(SelectorProvider sp) throws IOException {
<span class="udiff-line-added">+         this(sp, Net.isIPv6Available()</span>
<span class="udiff-line-added">+                 ? StandardProtocolFamily.INET6</span>
<span class="udiff-line-added">+                 : StandardProtocolFamily.INET);</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     SocketChannelImpl(SelectorProvider sp, ProtocolFamily family) throws IOException {</span>
          super(sp);
<span class="udiff-line-modified-removed">-         this.fd = Net.socket(true);</span>
<span class="udiff-line-modified-added">+         Objects.requireNonNull(family, &quot;&#39;family&#39; is null&quot;);</span>
<span class="udiff-line-added">+         if ((family != StandardProtocolFamily.INET) &amp;&amp;</span>
<span class="udiff-line-added">+                 (family != StandardProtocolFamily.INET6)) {</span>
<span class="udiff-line-added">+             throw new UnsupportedOperationException(&quot;Protocol family not supported&quot;);</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+         if (family == StandardProtocolFamily.INET6 &amp;&amp; !Net.isIPv6Available()) {</span>
<span class="udiff-line-added">+             throw new UnsupportedOperationException(&quot;IPv6 not available&quot;);</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+         this.family = family;</span>
<span class="udiff-line-added">+         this.fd = Net.socket(family, true);</span>
          this.fdVal = IOUtil.fdVal(fd);
      }
  
      SocketChannelImpl(SelectorProvider sp, FileDescriptor fd, boolean bound)
          throws IOException
      {
          super(sp);
<span class="udiff-line-added">+         this.family = Net.isIPv6Available()</span>
<span class="udiff-line-added">+                 ? StandardProtocolFamily.INET6</span>
<span class="udiff-line-added">+                 : StandardProtocolFamily.INET;</span>
          this.fd = fd;
          this.fdVal = IOUtil.fdVal(fd);
<span class="udiff-line-added">+ </span>
          if (bound) {
              synchronized (stateLock) {
                  this.localAddress = Net.localAddress(fd);
              }
          }
      }
  
      // Constructor for sockets obtained from server sockets
      //
<span class="udiff-line-modified-removed">-     SocketChannelImpl(SelectorProvider sp, FileDescriptor fd, InetSocketAddress isa)</span>
<span class="udiff-line-modified-added">+     SocketChannelImpl(SelectorProvider sp,</span>
<span class="udiff-line-added">+                       ProtocolFamily family,</span>
<span class="udiff-line-added">+                       FileDescriptor fd,</span>
<span class="udiff-line-added">+                       InetSocketAddress isa)</span>
          throws IOException
      {
          super(sp);
<span class="udiff-line-added">+         this.family = family;</span>
          this.fd = fd;
          this.fdVal = IOUtil.fdVal(fd);
          synchronized (stateLock) {
              this.localAddress = Net.localAddress(fd);
              this.remoteAddress = isa;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -223,12 +249,10 @@</span>
  
          synchronized (stateLock) {
              ensureOpen();
  
              if (name == StandardSocketOptions.IP_TOS) {
<span class="udiff-line-removed">-                 ProtocolFamily family = Net.isIPv6Available() ?</span>
<span class="udiff-line-removed">-                     StandardProtocolFamily.INET6 : StandardProtocolFamily.INET;</span>
                  Net.setSocketOption(fd, family, name, value);
                  return this;
              }
  
              if (name == StandardSocketOptions.SO_REUSEADDR &amp;&amp; Net.useExclusiveBind()) {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -258,14 +282,12 @@</span>
              if (name == StandardSocketOptions.SO_REUSEADDR &amp;&amp; Net.useExclusiveBind()) {
                  // SO_REUSEADDR emulated when using exclusive bind
                  return (T)Boolean.valueOf(isReuseAddress);
              }
  
<span class="udiff-line-modified-removed">-             // special handling for IP_TOS: always return 0 when IPv6</span>
<span class="udiff-line-modified-added">+             // special handling for IP_TOS</span>
              if (name == StandardSocketOptions.IP_TOS) {
<span class="udiff-line-removed">-                 ProtocolFamily family = Net.isIPv6Available() ?</span>
<span class="udiff-line-removed">-                     StandardProtocolFamily.INET6 : StandardProtocolFamily.INET;</span>
                  return (T) Net.getSocketOption(fd, family, name);
              }
  
              // no options that require special handling
              return (T) Net.getSocketOption(fd, name);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -630,18 +652,22 @@</span>
                      ensureOpen();
                      if (state == ST_CONNECTIONPENDING)
                          throw new ConnectionPendingException();
                      if (localAddress != null)
                          throw new AlreadyBoundException();
<span class="udiff-line-modified-removed">-                     InetSocketAddress isa = (local == null) ?</span>
<span class="udiff-line-modified-removed">-                         new InetSocketAddress(0) : Net.checkAddress(local);</span>
<span class="udiff-line-modified-added">+                     InetSocketAddress isa;</span>
<span class="udiff-line-modified-added">+                     if (local == null) {</span>
<span class="udiff-line-added">+                         isa = new InetSocketAddress(Net.anyLocalAddress(family), 0);</span>
<span class="udiff-line-added">+                     } else {</span>
<span class="udiff-line-added">+                         isa = Net.checkAddress(local, family);</span>
<span class="udiff-line-added">+                     }</span>
                      SecurityManager sm = System.getSecurityManager();
                      if (sm != null) {
                          sm.checkListen(isa.getPort());
                      }
                      NetHooks.beforeTcpBind(fd, isa.getAddress(), isa.getPort());
<span class="udiff-line-modified-removed">-                     Net.bind(fd, isa.getAddress(), isa.getPort());</span>
<span class="udiff-line-modified-added">+                     Net.bind(family, fd, isa.getAddress(), isa.getPort());</span>
                      localAddress = Net.localAddress(fd);
                  }
              } finally {
                  writeLock.unlock();
              }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -721,18 +747,25 @@</span>
      }
  
      /**
       * Checks the remote address to which this channel is to be connected.
       */
<span class="udiff-line-modified-removed">-     private InetSocketAddress checkRemote(SocketAddress sa) throws IOException {</span>
<span class="udiff-line-modified-removed">-         InetSocketAddress isa = Net.checkAddress(sa);</span>
<span class="udiff-line-modified-added">+     private InetSocketAddress checkRemote(SocketAddress sa) {</span>
<span class="udiff-line-modified-added">+         InetSocketAddress isa = Net.checkAddress(sa, family);</span>
          SecurityManager sm = System.getSecurityManager();
          if (sm != null) {
              sm.checkConnect(isa.getAddress().getHostAddress(), isa.getPort());
          }
<span class="udiff-line-modified-removed">-         if (isa.getAddress().isAnyLocalAddress()) {</span>
<span class="udiff-line-modified-removed">-             return new InetSocketAddress(InetAddress.getLocalHost(), isa.getPort());</span>
<span class="udiff-line-modified-added">+         InetAddress address = isa.getAddress();</span>
<span class="udiff-line-modified-added">+         if (address.isAnyLocalAddress()) {</span>
<span class="udiff-line-added">+             int port = isa.getPort();</span>
<span class="udiff-line-added">+             if (address instanceof Inet4Address) {</span>
<span class="udiff-line-added">+                 return new InetSocketAddress(Net.inet4LoopbackAddress(), port);</span>
<span class="udiff-line-added">+             } else {</span>
<span class="udiff-line-added">+                 assert family == StandardProtocolFamily.INET6;</span>
<span class="udiff-line-added">+                 return new InetSocketAddress(Net.inet6LoopbackAddress(), port);</span>
<span class="udiff-line-added">+             }</span>
          } else {
              return isa;
          }
      }
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -746,11 +779,14 @@</span>
                  try {
                      boolean blocking = isBlocking();
                      boolean connected = false;
                      try {
                          beginConnect(blocking, isa);
<span class="udiff-line-modified-removed">-                         int n = Net.connect(fd, isa.getAddress(), isa.getPort());</span>
<span class="udiff-line-modified-added">+                         int n = Net.connect(family,</span>
<span class="udiff-line-added">+                                             fd,</span>
<span class="udiff-line-added">+                                             isa.getAddress(),</span>
<span class="udiff-line-added">+                                             isa.getPort());</span>
                          if (n &gt; 0) {
                              connected = true;
                          } else if (blocking) {
                              assert IOStatus.okayToRetry(n);
                              boolean polled = false;
</pre>
<center><a href="ServerSocketChannelImpl.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="../../security/pkcs/ContentInfo.java.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>