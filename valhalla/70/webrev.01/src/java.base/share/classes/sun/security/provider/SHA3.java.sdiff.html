<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/java.base/share/classes/sun/security/provider/SHA3.java</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
  </head>
<body>
<center><a href="KeyProtector.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="SunEntries.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/java.base/share/classes/sun/security/provider/SHA3.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2016, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.  Oracle designates this
  8  * particular file as subject to the &quot;Classpath&quot; exception as provided
  9  * by Oracle in the LICENSE file that accompanied this code.
 10  *
 11  * This code is distributed in the hope that it will be useful, but WITHOUT
 12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 14  * version 2 for more details (a copy is included in the LICENSE file that
 15  * accompanied this code).
 16  *
 17  * You should have received a copy of the GNU General Public License version
 18  * 2 along with this work; if not, write to the Free Software Foundation,
 19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 20  *
 21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 22  * or visit www.oracle.com if you need additional information or have any
</pre>
<hr />
<pre>
 44  */
 45 abstract class SHA3 extends DigestBase {
 46 
 47     private static final int WIDTH = 200; // in bytes, e.g. 1600 bits
 48     private static final int DM = 5; // dimension of lanes
 49 
 50     private static final int NR = 24; // number of rounds
 51 
 52     // precomputed round constants needed by the step mapping Iota
 53     private static final long[] RC_CONSTANTS = {
 54         0x01L, 0x8082L, 0x800000000000808aL,
 55         0x8000000080008000L, 0x808bL, 0x80000001L,
 56         0x8000000080008081L, 0x8000000000008009L, 0x8aL,
 57         0x88L, 0x80008009L, 0x8000000aL,
 58         0x8000808bL, 0x800000000000008bL, 0x8000000000008089L,
 59         0x8000000000008003L, 0x8000000000008002L, 0x8000000000000080L,
 60         0x800aL, 0x800000008000000aL, 0x8000000080008081L,
 61         0x8000000000008080L, 0x80000001L, 0x8000000080008008L,
 62     };
 63 

 64     private byte[] state = new byte[WIDTH];
 65     private long[] lanes = new long[DM*DM];
 66 
 67     /**
 68      * Creates a new SHA-3 object.
 69      */
<span class="line-modified"> 70     SHA3(String name, int digestLength) {</span>
<span class="line-modified"> 71         super(name, digestLength, (WIDTH - (2 * digestLength)));</span>

 72     }
 73 
 74     /**
 75      * Core compression function. Processes blockSize bytes at a time
 76      * and updates the state of this object.
 77      */
 78     void implCompress(byte[] b, int ofs) {
 79         for (int i = 0; i &lt; buffer.length; i++) {
 80             state[i] ^= b[ofs++];
 81         }
 82         keccak();
 83     }
 84 
 85     /**
 86      * Return the digest. Subclasses do not need to reset() themselves,
 87      * DigestBase calls implReset() when necessary.
 88      */
 89     void implDigest(byte[] out, int ofs) {
 90         int numOfPadding =
<span class="line-modified"> 91             setPaddingBytes(buffer, (int)(bytesProcessed % buffer.length));</span>
 92         if (numOfPadding &lt; 1) {
 93             throw new ProviderException(&quot;Incorrect pad size: &quot; + numOfPadding);
 94         }
 95         for (int i = 0; i &lt; buffer.length; i++) {
 96             state[i] ^= buffer[i];
 97         }
 98         keccak();
 99         System.arraycopy(state, 0, out, ofs, engineGetDigestLength());
100     }
101 
102     /**
103      * Resets the internal state to start a new hash.
104      */
105     void implReset() {
106         Arrays.fill(state, (byte)0);
107         Arrays.fill(lanes, 0L);
108     }
109 
110     /**
111      * Utility function for padding the specified data based on the
112      * pad10*1 algorithm (section 5.1) and the 2-bit suffix &quot;01&quot; required
113      * for SHA-3 hash (section 6.1).
114      */
<span class="line-modified">115     private static int setPaddingBytes(byte[] in, int len) {</span>
116         if (len != in.length) {
117             // erase leftover values
118             Arrays.fill(in, len, in.length, (byte)0);
119             // directly store the padding bytes into the input
120             // as the specified buffer is allocated w/ size = rateR
<span class="line-modified">121             in[len] |= (byte) 0x06;</span>
122             in[in.length - 1] |= (byte) 0x80;
123         }
124         return (in.length - len);
125     }
126 
127     /**
128      * Utility function for transforming the specified byte array &#39;s&#39;
129      * into array of lanes &#39;m&#39; as defined in section 3.1.2.
130      */
131     private static void bytes2Lanes(byte[] s, long[] m) {
132         int sOfs = 0;
133         // Conversion traverses along x-axis before y-axis
134         for (int y = 0; y &lt; DM; y++, sOfs += 40) {
135             b2lLittle(s, sOfs, m, DM*y, 40);
136         }
137     }
138 
139     /**
140      * Utility function for transforming the specified array of
141      * lanes &#39;m&#39; into a byte array &#39;s&#39; as defined in section 3.1.3.
</pre>
<hr />
<pre>
251         // process the lanes through step mappings
252         for (int ir = 0; ir &lt; NR; ir++) {
253             smIota(smChi(smPiRho(smTheta(lanes))), ir);
254         }
255         // convert the resulting 25 lanes back into 200-byte state
256         lanes2Bytes(lanes, state);
257     }
258 
259     public Object clone() throws CloneNotSupportedException {
260         SHA3 copy = (SHA3) super.clone();
261         copy.state = copy.state.clone();
262         copy.lanes = new long[DM*DM];
263         return copy;
264     }
265 
266     /**
267      * SHA3-224 implementation class.
268      */
269     public static final class SHA224 extends SHA3 {
270         public SHA224() {
<span class="line-modified">271             super(&quot;SHA3-224&quot;, 28);</span>
272         }
273     }
274 
275     /**
276      * SHA3-256 implementation class.
277      */
278     public static final class SHA256 extends SHA3 {
279         public SHA256() {
<span class="line-modified">280             super(&quot;SHA3-256&quot;, 32);</span>
281         }
282     }
283 
284     /**
285      * SHAs-384 implementation class.
286      */
287     public static final class SHA384 extends SHA3 {
288         public SHA384() {
<span class="line-modified">289             super(&quot;SHA3-384&quot;, 48);</span>
290         }
291     }
292 
293     /**
294      * SHA3-512 implementation class.
295      */
296     public static final class SHA512 extends SHA3 {
297         public SHA512() {
<span class="line-modified">298             super(&quot;SHA3-512&quot;, 64);</span>
299         }
300     }
301 }
</pre>
</td>
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2016, 2020, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.  Oracle designates this
  8  * particular file as subject to the &quot;Classpath&quot; exception as provided
  9  * by Oracle in the LICENSE file that accompanied this code.
 10  *
 11  * This code is distributed in the hope that it will be useful, but WITHOUT
 12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 14  * version 2 for more details (a copy is included in the LICENSE file that
 15  * accompanied this code).
 16  *
 17  * You should have received a copy of the GNU General Public License version
 18  * 2 along with this work; if not, write to the Free Software Foundation,
 19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 20  *
 21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 22  * or visit www.oracle.com if you need additional information or have any
</pre>
<hr />
<pre>
 44  */
 45 abstract class SHA3 extends DigestBase {
 46 
 47     private static final int WIDTH = 200; // in bytes, e.g. 1600 bits
 48     private static final int DM = 5; // dimension of lanes
 49 
 50     private static final int NR = 24; // number of rounds
 51 
 52     // precomputed round constants needed by the step mapping Iota
 53     private static final long[] RC_CONSTANTS = {
 54         0x01L, 0x8082L, 0x800000000000808aL,
 55         0x8000000080008000L, 0x808bL, 0x80000001L,
 56         0x8000000080008081L, 0x8000000000008009L, 0x8aL,
 57         0x88L, 0x80008009L, 0x8000000aL,
 58         0x8000808bL, 0x800000000000008bL, 0x8000000000008089L,
 59         0x8000000000008003L, 0x8000000000008002L, 0x8000000000000080L,
 60         0x800aL, 0x800000008000000aL, 0x8000000080008081L,
 61         0x8000000000008080L, 0x80000001L, 0x8000000080008008L,
 62     };
 63 
<span class="line-added"> 64     private final byte suffix;</span>
 65     private byte[] state = new byte[WIDTH];
 66     private long[] lanes = new long[DM*DM];
 67 
 68     /**
 69      * Creates a new SHA-3 object.
 70      */
<span class="line-modified"> 71     SHA3(String name, int digestLength, byte suffix, int c) {</span>
<span class="line-modified"> 72         super(name, digestLength, (WIDTH - c));</span>
<span class="line-added"> 73         this.suffix = suffix;</span>
 74     }
 75 
 76     /**
 77      * Core compression function. Processes blockSize bytes at a time
 78      * and updates the state of this object.
 79      */
 80     void implCompress(byte[] b, int ofs) {
 81         for (int i = 0; i &lt; buffer.length; i++) {
 82             state[i] ^= b[ofs++];
 83         }
 84         keccak();
 85     }
 86 
 87     /**
 88      * Return the digest. Subclasses do not need to reset() themselves,
 89      * DigestBase calls implReset() when necessary.
 90      */
 91     void implDigest(byte[] out, int ofs) {
 92         int numOfPadding =
<span class="line-modified"> 93             setPaddingBytes(suffix, buffer, (int)(bytesProcessed % buffer.length));</span>
 94         if (numOfPadding &lt; 1) {
 95             throw new ProviderException(&quot;Incorrect pad size: &quot; + numOfPadding);
 96         }
 97         for (int i = 0; i &lt; buffer.length; i++) {
 98             state[i] ^= buffer[i];
 99         }
100         keccak();
101         System.arraycopy(state, 0, out, ofs, engineGetDigestLength());
102     }
103 
104     /**
105      * Resets the internal state to start a new hash.
106      */
107     void implReset() {
108         Arrays.fill(state, (byte)0);
109         Arrays.fill(lanes, 0L);
110     }
111 
112     /**
113      * Utility function for padding the specified data based on the
114      * pad10*1 algorithm (section 5.1) and the 2-bit suffix &quot;01&quot; required
115      * for SHA-3 hash (section 6.1).
116      */
<span class="line-modified">117     private static int setPaddingBytes(byte suffix, byte[] in, int len) {</span>
118         if (len != in.length) {
119             // erase leftover values
120             Arrays.fill(in, len, in.length, (byte)0);
121             // directly store the padding bytes into the input
122             // as the specified buffer is allocated w/ size = rateR
<span class="line-modified">123             in[len] |= suffix;</span>
124             in[in.length - 1] |= (byte) 0x80;
125         }
126         return (in.length - len);
127     }
128 
129     /**
130      * Utility function for transforming the specified byte array &#39;s&#39;
131      * into array of lanes &#39;m&#39; as defined in section 3.1.2.
132      */
133     private static void bytes2Lanes(byte[] s, long[] m) {
134         int sOfs = 0;
135         // Conversion traverses along x-axis before y-axis
136         for (int y = 0; y &lt; DM; y++, sOfs += 40) {
137             b2lLittle(s, sOfs, m, DM*y, 40);
138         }
139     }
140 
141     /**
142      * Utility function for transforming the specified array of
143      * lanes &#39;m&#39; into a byte array &#39;s&#39; as defined in section 3.1.3.
</pre>
<hr />
<pre>
253         // process the lanes through step mappings
254         for (int ir = 0; ir &lt; NR; ir++) {
255             smIota(smChi(smPiRho(smTheta(lanes))), ir);
256         }
257         // convert the resulting 25 lanes back into 200-byte state
258         lanes2Bytes(lanes, state);
259     }
260 
261     public Object clone() throws CloneNotSupportedException {
262         SHA3 copy = (SHA3) super.clone();
263         copy.state = copy.state.clone();
264         copy.lanes = new long[DM*DM];
265         return copy;
266     }
267 
268     /**
269      * SHA3-224 implementation class.
270      */
271     public static final class SHA224 extends SHA3 {
272         public SHA224() {
<span class="line-modified">273             super(&quot;SHA3-224&quot;, 28, (byte)0x06, 56);</span>
274         }
275     }
276 
277     /**
278      * SHA3-256 implementation class.
279      */
280     public static final class SHA256 extends SHA3 {
281         public SHA256() {
<span class="line-modified">282             super(&quot;SHA3-256&quot;, 32, (byte)0x06, 64);</span>
283         }
284     }
285 
286     /**
287      * SHAs-384 implementation class.
288      */
289     public static final class SHA384 extends SHA3 {
290         public SHA384() {
<span class="line-modified">291             super(&quot;SHA3-384&quot;, 48, (byte)0x06, 96);</span>
292         }
293     }
294 
295     /**
296      * SHA3-512 implementation class.
297      */
298     public static final class SHA512 extends SHA3 {
299         public SHA512() {
<span class="line-modified">300             super(&quot;SHA3-512&quot;, 64, (byte)0x06, 128);</span>
301         }
302     }
303 }
</pre>
</td>
</tr>
</table>
<center><a href="KeyProtector.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="SunEntries.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>