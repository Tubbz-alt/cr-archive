<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff src/java.base/share/classes/sun/nio/ch/ServerSocketChannelImpl.java</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
  </head>
<body>
<center><a href="SelectorProviderImpl.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="SocketChannelImpl.java.udiff.html" target="_top">next &gt;</a></center>    <h2>src/java.base/share/classes/sun/nio/ch/ServerSocketChannelImpl.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -26,14 +26,16 @@</span>
  package sun.nio.ch;
  
  import java.io.FileDescriptor;
  import java.io.IOException;
  import java.net.InetSocketAddress;
<span class="udiff-line-added">+ import java.net.ProtocolFamily;</span>
  import java.net.ServerSocket;
  import java.net.SocketAddress;
  import java.net.SocketOption;
  import java.net.SocketTimeoutException;
<span class="udiff-line-added">+ import java.net.StandardProtocolFamily;</span>
  import java.net.StandardSocketOptions;
  import java.nio.channels.AlreadyBoundException;
  import java.nio.channels.AsynchronousCloseException;
  import java.nio.channels.ClosedChannelException;
  import java.nio.channels.IllegalBlockingModeException;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -60,10 +62,13 @@</span>
      implements SelChImpl
  {
      // Used to make native close and configure calls
      private static final NativeDispatcher nd = new SocketDispatcher();
  
<span class="udiff-line-added">+     // The protocol family of the socket</span>
<span class="udiff-line-added">+     private final ProtocolFamily family;</span>
<span class="udiff-line-added">+ </span>
      // Our file descriptor
      private final FileDescriptor fd;
      private final int fdVal;
  
      // Lock held by thread currently blocked on this channel
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -93,23 +98,44 @@</span>
      // Our socket adaptor, if any
      private ServerSocket socket;
  
      // -- End of fields protected by stateLock
  
<span class="udiff-line-removed">- </span>
      ServerSocketChannelImpl(SelectorProvider sp) {
<span class="udiff-line-added">+         this(sp, Net.isIPv6Available()</span>
<span class="udiff-line-added">+                 ? StandardProtocolFamily.INET6</span>
<span class="udiff-line-added">+                 : StandardProtocolFamily.INET);</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     ServerSocketChannelImpl(SelectorProvider sp, ProtocolFamily family) {</span>
          super(sp);
<span class="udiff-line-modified-removed">-         this.fd = Net.serverSocket(true);</span>
<span class="udiff-line-modified-added">+         Objects.requireNonNull(family, &quot;&#39;family&#39; is null&quot;);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         if ((family != StandardProtocolFamily.INET) &amp;&amp;</span>
<span class="udiff-line-added">+                 (family != StandardProtocolFamily.INET6)) {</span>
<span class="udiff-line-added">+             throw new UnsupportedOperationException(&quot;Protocol family not supported&quot;);</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+         if (family == StandardProtocolFamily.INET6 &amp;&amp; !Net.isIPv6Available()) {</span>
<span class="udiff-line-added">+             throw new UnsupportedOperationException(&quot;IPv6 not available&quot;);</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         this.family = family;</span>
<span class="udiff-line-added">+         this.fd = Net.serverSocket(family, true);</span>
          this.fdVal = IOUtil.fdVal(fd);
      }
  
      ServerSocketChannelImpl(SelectorProvider sp, FileDescriptor fd, boolean bound)
          throws IOException
      {
          super(sp);
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         this.family = Net.isIPv6Available()</span>
<span class="udiff-line-added">+                 ? StandardProtocolFamily.INET6</span>
<span class="udiff-line-added">+                 : StandardProtocolFamily.INET;</span>
          this.fd =  fd;
          this.fdVal = IOUtil.fdVal(fd);
<span class="udiff-line-added">+ </span>
          if (bound) {
              synchronized (stateLock) {
                  localAddress = Net.localAddress(fd);
              }
          }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -208,18 +234,21 @@</span>
      public ServerSocketChannel bind(SocketAddress local, int backlog) throws IOException {
          synchronized (stateLock) {
              ensureOpen();
              if (localAddress != null)
                  throw new AlreadyBoundException();
<span class="udiff-line-modified-removed">-             InetSocketAddress isa = (local == null)</span>
<span class="udiff-line-modified-removed">-                                     ? new InetSocketAddress(0)</span>
<span class="udiff-line-modified-removed">-                                     : Net.checkAddress(local);</span>
<span class="udiff-line-modified-added">+             InetSocketAddress isa;</span>
<span class="udiff-line-modified-added">+             if (local == null) {</span>
<span class="udiff-line-modified-added">+                 isa = new InetSocketAddress(Net.anyLocalAddress(family), 0);</span>
<span class="udiff-line-added">+             } else {</span>
<span class="udiff-line-added">+                 isa = Net.checkAddress(local, family);</span>
<span class="udiff-line-added">+             }</span>
              SecurityManager sm = System.getSecurityManager();
              if (sm != null)
                  sm.checkListen(isa.getPort());
              NetHooks.beforeTcpBind(fd, isa.getAddress(), isa.getPort());
<span class="udiff-line-modified-removed">-             Net.bind(fd, isa.getAddress(), isa.getPort());</span>
<span class="udiff-line-modified-added">+             Net.bind(family, fd, isa.getAddress(), isa.getPort());</span>
              Net.listen(fd, backlog &lt; 1 ? 50 : backlog);
              localAddress = Net.localAddress(fd);
          }
          return this;
      }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -356,11 +385,11 @@</span>
              // check permitted to accept connections from the remote address
              SecurityManager sm = System.getSecurityManager();
              if (sm != null) {
                  sm.checkAccept(isa.getAddress().getHostAddress(), isa.getPort());
              }
<span class="udiff-line-modified-removed">-             return new SocketChannelImpl(provider(), newfd, isa);</span>
<span class="udiff-line-modified-added">+             return new SocketChannelImpl(provider(), family, newfd, isa);</span>
          } catch (Exception e) {
              nd.close(newfd);
              throw e;
          }
      }
</pre>
<center><a href="SelectorProviderImpl.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="SocketChannelImpl.java.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>