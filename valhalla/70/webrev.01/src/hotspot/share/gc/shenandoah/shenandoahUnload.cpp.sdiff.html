<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/hotspot/share/gc/shenandoah/shenandoahUnload.cpp</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
<body>
<center><a href="shenandoahPhaseTimings.hpp.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="../z/zArguments.cpp.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/hotspot/share/gc/shenandoah/shenandoahUnload.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
119   }
120 };
121 
122 ShenandoahUnload::ShenandoahUnload() {
123   if (ShenandoahConcurrentRoots::can_do_concurrent_class_unloading()) {
124     static ShenandoahIsUnloadingBehaviour is_unloading_behaviour;
125     IsUnloadingBehaviour::set_current(&amp;is_unloading_behaviour);
126 
127     static ShenandoahCompiledICProtectionBehaviour ic_protection_behaviour;
128     CompiledICProtectionBehaviour::set_current(&amp;ic_protection_behaviour);
129   }
130 }
131 
132 void ShenandoahUnload::prepare() {
133   assert(SafepointSynchronize::is_at_safepoint(), &quot;Should be at safepoint&quot;);
134   assert(ShenandoahConcurrentRoots::can_do_concurrent_class_unloading(), &quot;Sanity&quot;);
135   CodeCache::increment_unloading_cycle();
136   DependencyContext::cleaning_start();
137 }
138 
<span class="line-removed">139 class ShenandoahUnloadRendezvousClosure : public HandshakeClosure {</span>
<span class="line-removed">140 public:</span>
<span class="line-removed">141   ShenandoahUnloadRendezvousClosure() : HandshakeClosure(&quot;ShenandoahUnloadRendezvous&quot;) {}</span>
<span class="line-removed">142   void do_thread(Thread* thread) {}</span>
<span class="line-removed">143 };</span>
<span class="line-removed">144 </span>
145 void ShenandoahUnload::unload() {
146   ShenandoahHeap* heap = ShenandoahHeap::heap();
147   assert(ShenandoahConcurrentRoots::can_do_concurrent_class_unloading(), &quot;Filtered by caller&quot;);
148   assert(heap-&gt;is_concurrent_weak_root_in_progress(), &quot;Filtered by caller&quot;);
149 
150   // Unlink stale metadata and nmethods
151   {
152     ShenandoahTimingsTracker t(ShenandoahPhaseTimings::conc_class_unload_unlink);
153 
154     SuspendibleThreadSetJoiner sts;
155     bool unloadingOccurred;
156     {
157       ShenandoahTimingsTracker t(ShenandoahPhaseTimings::conc_class_unload_unlink_sd);
158       MutexLocker cldgMl(ClassLoaderDataGraph_lock);
159       unloadingOccurred = SystemDictionary::do_unloading(heap-&gt;gc_timer());
160     }
161 
162     {
163       ShenandoahTimingsTracker t(ShenandoahPhaseTimings::conc_class_unload_unlink_weak_klass);
164       Klass::clean_weak_klass_links(unloadingOccurred);
165     }
166 
167     {
168       ShenandoahTimingsTracker t(ShenandoahPhaseTimings::conc_class_unload_unlink_code_roots);
169       ShenandoahCodeRoots::unlink(heap-&gt;workers(), unloadingOccurred);
170     }
171 
172     DependencyContext::cleaning_end();
173   }
174 
175   // Make sure stale metadata and nmethods are no longer observable
176   {
177     ShenandoahTimingsTracker t(ShenandoahPhaseTimings::conc_class_unload_rendezvous);
<span class="line-modified">178     ShenandoahUnloadRendezvousClosure cl;</span>
179     Handshake::execute(&amp;cl);
180   }
181 
182   // Purge stale metadata and nmethods that were unlinked
183   {
184     ShenandoahTimingsTracker t(ShenandoahPhaseTimings::conc_class_unload_purge);
185 
186     {
187       ShenandoahTimingsTracker t(ShenandoahPhaseTimings::conc_class_unload_purge_coderoots);
188       SuspendibleThreadSetJoiner sts;
189       ShenandoahCodeRoots::purge(heap-&gt;workers());
190     }
191 
192     {
193       ShenandoahTimingsTracker t(ShenandoahPhaseTimings::conc_class_unload_purge_cldg);
194       ClassLoaderDataGraph::purge();
195     }
196 
197     {
198       ShenandoahTimingsTracker t(ShenandoahPhaseTimings::conc_class_unload_purge_ec);
</pre>
</td>
<td>
<hr />
<pre>
119   }
120 };
121 
122 ShenandoahUnload::ShenandoahUnload() {
123   if (ShenandoahConcurrentRoots::can_do_concurrent_class_unloading()) {
124     static ShenandoahIsUnloadingBehaviour is_unloading_behaviour;
125     IsUnloadingBehaviour::set_current(&amp;is_unloading_behaviour);
126 
127     static ShenandoahCompiledICProtectionBehaviour ic_protection_behaviour;
128     CompiledICProtectionBehaviour::set_current(&amp;ic_protection_behaviour);
129   }
130 }
131 
132 void ShenandoahUnload::prepare() {
133   assert(SafepointSynchronize::is_at_safepoint(), &quot;Should be at safepoint&quot;);
134   assert(ShenandoahConcurrentRoots::can_do_concurrent_class_unloading(), &quot;Sanity&quot;);
135   CodeCache::increment_unloading_cycle();
136   DependencyContext::cleaning_start();
137 }
138 






139 void ShenandoahUnload::unload() {
140   ShenandoahHeap* heap = ShenandoahHeap::heap();
141   assert(ShenandoahConcurrentRoots::can_do_concurrent_class_unloading(), &quot;Filtered by caller&quot;);
142   assert(heap-&gt;is_concurrent_weak_root_in_progress(), &quot;Filtered by caller&quot;);
143 
144   // Unlink stale metadata and nmethods
145   {
146     ShenandoahTimingsTracker t(ShenandoahPhaseTimings::conc_class_unload_unlink);
147 
148     SuspendibleThreadSetJoiner sts;
149     bool unloadingOccurred;
150     {
151       ShenandoahTimingsTracker t(ShenandoahPhaseTimings::conc_class_unload_unlink_sd);
152       MutexLocker cldgMl(ClassLoaderDataGraph_lock);
153       unloadingOccurred = SystemDictionary::do_unloading(heap-&gt;gc_timer());
154     }
155 
156     {
157       ShenandoahTimingsTracker t(ShenandoahPhaseTimings::conc_class_unload_unlink_weak_klass);
158       Klass::clean_weak_klass_links(unloadingOccurred);
159     }
160 
161     {
162       ShenandoahTimingsTracker t(ShenandoahPhaseTimings::conc_class_unload_unlink_code_roots);
163       ShenandoahCodeRoots::unlink(heap-&gt;workers(), unloadingOccurred);
164     }
165 
166     DependencyContext::cleaning_end();
167   }
168 
169   // Make sure stale metadata and nmethods are no longer observable
170   {
171     ShenandoahTimingsTracker t(ShenandoahPhaseTimings::conc_class_unload_rendezvous);
<span class="line-modified">172     ShenandoahRendezvousClosure cl;</span>
173     Handshake::execute(&amp;cl);
174   }
175 
176   // Purge stale metadata and nmethods that were unlinked
177   {
178     ShenandoahTimingsTracker t(ShenandoahPhaseTimings::conc_class_unload_purge);
179 
180     {
181       ShenandoahTimingsTracker t(ShenandoahPhaseTimings::conc_class_unload_purge_coderoots);
182       SuspendibleThreadSetJoiner sts;
183       ShenandoahCodeRoots::purge(heap-&gt;workers());
184     }
185 
186     {
187       ShenandoahTimingsTracker t(ShenandoahPhaseTimings::conc_class_unload_purge_cldg);
188       ClassLoaderDataGraph::purge();
189     }
190 
191     {
192       ShenandoahTimingsTracker t(ShenandoahPhaseTimings::conc_class_unload_purge_ec);
</pre>
</td>
</tr>
</table>
<center><a href="shenandoahPhaseTimings.hpp.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="../z/zArguments.cpp.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>