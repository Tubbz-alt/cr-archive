<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff src/hotspot/share/classfile/classLoaderStats.cpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
  </head>
<body>
<center><a href="classFileParser.cpp.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="classLoaderStats.hpp.cdiff.html" target="_top">next &gt;</a></center>    <h2>src/hotspot/share/classfile/classLoaderStats.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 42,31 ***</span>
    virtual void do_klass(Klass* k) {
      _num_classes++;
    }
  };
  
<span class="line-removed">- </span>
  void ClassLoaderStatsClosure::do_cld(ClassLoaderData* cld) {
    oop cl = cld-&gt;class_loader();
<span class="line-removed">-   ClassLoaderStats* cls;</span>
  
    // The hashtable key is the ClassLoader oop since we want to account
    // for &quot;real&quot; classes and anonymous classes together
<span class="line-modified">!   ClassLoaderStats** cls_ptr = _stats-&gt;get(cl);</span>
<span class="line-modified">!   if (cls_ptr == NULL) {</span>
<span class="line-modified">!     cls = new ClassLoaderStats();</span>
<span class="line-modified">!     _stats-&gt;put(cl, cls);</span>
      _total_loaders++;
<span class="line-removed">-   } else {</span>
<span class="line-removed">-     cls = *cls_ptr;</span>
    }
  
    if (!cld-&gt;has_class_mirror_holder()) {
      cls-&gt;_cld = cld;
    }
  
<span class="line-removed">-   cls-&gt;_class_loader = cl;</span>
    if (cl != NULL) {
      cls-&gt;_parent = java_lang_ClassLoader::parent(cl);
      addEmptyParents(cls-&gt;_parent);
    }
  
<span class="line-new-header">--- 42,27 ---</span>
    virtual void do_klass(Klass* k) {
      _num_classes++;
    }
  };
  
  void ClassLoaderStatsClosure::do_cld(ClassLoaderData* cld) {
    oop cl = cld-&gt;class_loader();
  
    // The hashtable key is the ClassLoader oop since we want to account
    // for &quot;real&quot; classes and anonymous classes together
<span class="line-modified">!   bool added = false;</span>
<span class="line-modified">!   ClassLoaderStats* cls = _stats-&gt;put_if_absent(cl, &amp;added);</span>
<span class="line-modified">!   if (added) {</span>
<span class="line-modified">!     cls-&gt;_class_loader = cl;</span>
      _total_loaders++;
    }
<span class="line-added">+   assert(cls-&gt;_class_loader == cl, &quot;Sanity&quot;);</span>
  
    if (!cld-&gt;has_class_mirror_holder()) {
      cls-&gt;_cld = cld;
    }
  
    if (cl != NULL) {
      cls-&gt;_parent = java_lang_ClassLoader::parent(cl);
      addEmptyParents(cls-&gt;_parent);
    }
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 103,29 ***</span>
  #else
    #define SPACE &quot;%s&quot;
  #endif
  
  
<span class="line-modified">! bool ClassLoaderStatsClosure::do_entry(oop const&amp; key, ClassLoaderStats* const&amp; cls) {</span>
<span class="line-modified">!   Klass* class_loader_klass = (cls-&gt;_class_loader == NULL ? NULL : cls-&gt;_class_loader-&gt;klass());</span>
<span class="line-modified">!   Klass* parent_klass = (cls-&gt;_parent == NULL ? NULL : cls-&gt;_parent-&gt;klass());</span>
  
    _out-&gt;print(INTPTR_FORMAT &quot;  &quot; INTPTR_FORMAT &quot;  &quot; INTPTR_FORMAT &quot;  &quot; UINTX_FORMAT_W(6) &quot;  &quot; SIZE_FORMAT_W(8) &quot;  &quot; SIZE_FORMAT_W(8) &quot;  &quot;,
<span class="line-modified">!       p2i(class_loader_klass), p2i(parent_klass), p2i(cls-&gt;_cld),</span>
<span class="line-modified">!       cls-&gt;_classes_count,</span>
<span class="line-modified">!       cls-&gt;_chunk_sz, cls-&gt;_block_sz);</span>
    if (class_loader_klass != NULL) {
      _out-&gt;print(&quot;%s&quot;, class_loader_klass-&gt;external_name());
    } else {
      _out-&gt;print(&quot;&lt;boot class loader&gt;&quot;);
    }
    _out-&gt;cr();
<span class="line-modified">!   if (cls-&gt;_hidden_classes_count &gt; 0) {</span>
      _out-&gt;print_cr(SPACE SPACE SPACE &quot;                                    &quot; UINTX_FORMAT_W(6) &quot;  &quot; SIZE_FORMAT_W(8) &quot;  &quot; SIZE_FORMAT_W(8) &quot;   + hidden classes&quot;,
          &quot;&quot;, &quot;&quot;, &quot;&quot;,
<span class="line-modified">!         cls-&gt;_hidden_classes_count,</span>
<span class="line-modified">!         cls-&gt;_hidden_chunk_sz, cls-&gt;_hidden_block_sz);</span>
    }
    return true;
  }
  
  
<span class="line-new-header">--- 99,29 ---</span>
  #else
    #define SPACE &quot;%s&quot;
  #endif
  
  
<span class="line-modified">! bool ClassLoaderStatsClosure::do_entry(oop const&amp; key, ClassLoaderStats const&amp; cls) {</span>
<span class="line-modified">!   Klass* class_loader_klass = (cls._class_loader == NULL ? NULL : cls._class_loader-&gt;klass());</span>
<span class="line-modified">!   Klass* parent_klass = (cls._parent == NULL ? NULL : cls._parent-&gt;klass());</span>
  
    _out-&gt;print(INTPTR_FORMAT &quot;  &quot; INTPTR_FORMAT &quot;  &quot; INTPTR_FORMAT &quot;  &quot; UINTX_FORMAT_W(6) &quot;  &quot; SIZE_FORMAT_W(8) &quot;  &quot; SIZE_FORMAT_W(8) &quot;  &quot;,
<span class="line-modified">!       p2i(class_loader_klass), p2i(parent_klass), p2i(cls._cld),</span>
<span class="line-modified">!       cls._classes_count,</span>
<span class="line-modified">!       cls._chunk_sz, cls._block_sz);</span>
    if (class_loader_klass != NULL) {
      _out-&gt;print(&quot;%s&quot;, class_loader_klass-&gt;external_name());
    } else {
      _out-&gt;print(&quot;&lt;boot class loader&gt;&quot;);
    }
    _out-&gt;cr();
<span class="line-modified">!   if (cls._hidden_classes_count &gt; 0) {</span>
      _out-&gt;print_cr(SPACE SPACE SPACE &quot;                                    &quot; UINTX_FORMAT_W(6) &quot;  &quot; SIZE_FORMAT_W(8) &quot;  &quot; SIZE_FORMAT_W(8) &quot;   + hidden classes&quot;,
          &quot;&quot;, &quot;&quot;, &quot;&quot;,
<span class="line-modified">!         cls._hidden_classes_count,</span>
<span class="line-modified">!         cls._hidden_chunk_sz, cls._hidden_block_sz);</span>
    }
    return true;
  }
  
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 144,19 ***</span>
  
  
  void ClassLoaderStatsClosure::addEmptyParents(oop cl) {
    while (cl != NULL &amp;&amp; java_lang_ClassLoader::loader_data_acquire(cl) == NULL) {
      // This classloader has not loaded any classes
<span class="line-modified">!     ClassLoaderStats** cls_ptr = _stats-&gt;get(cl);</span>
<span class="line-modified">!     if (cls_ptr == NULL) {</span>
<span class="line-modified">!       // It does not exist in our table - add it</span>
<span class="line-removed">-       ClassLoaderStats* cls = new ClassLoaderStats();</span>
        cls-&gt;_class_loader = cl;
        cls-&gt;_parent = java_lang_ClassLoader::parent(cl);
<span class="line-removed">-       _stats-&gt;put(cl, cls);</span>
        _total_loaders++;
      }
  
      cl = java_lang_ClassLoader::parent(cl);
    }
  }
  
<span class="line-new-header">--- 140,18 ---</span>
  
  
  void ClassLoaderStatsClosure::addEmptyParents(oop cl) {
    while (cl != NULL &amp;&amp; java_lang_ClassLoader::loader_data_acquire(cl) == NULL) {
      // This classloader has not loaded any classes
<span class="line-modified">!     bool added = false;</span>
<span class="line-modified">!     ClassLoaderStats* cls = _stats-&gt;put_if_absent(cl, &amp;added);</span>
<span class="line-modified">!     if (added) {</span>
        cls-&gt;_class_loader = cl;
        cls-&gt;_parent = java_lang_ClassLoader::parent(cl);
        _total_loaders++;
      }
<span class="line-added">+     assert(cls-&gt;_class_loader == cl, &quot;Sanity&quot;);</span>
  
      cl = java_lang_ClassLoader::parent(cl);
    }
  }
  
</pre>
<center><a href="classFileParser.cpp.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="classLoaderStats.hpp.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>