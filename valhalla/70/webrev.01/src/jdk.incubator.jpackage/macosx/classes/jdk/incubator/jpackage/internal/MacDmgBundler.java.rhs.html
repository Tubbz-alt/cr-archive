<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames src/jdk.incubator.jpackage/macosx/classes/jdk/incubator/jpackage/internal/MacDmgBundler.java</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
  2  * Copyright (c) 2012, 2020, Oracle and/or its affiliates. All rights reserved.
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.  Oracle designates this
  8  * particular file as subject to the &quot;Classpath&quot; exception as provided
  9  * by Oracle in the LICENSE file that accompanied this code.
 10  *
 11  * This code is distributed in the hope that it will be useful, but WITHOUT
 12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 14  * version 2 for more details (a copy is included in the LICENSE file that
 15  * accompanied this code).
 16  *
 17  * You should have received a copy of the GNU General Public License version
 18  * 2 along with this work; if not, write to the Free Software Foundation,
 19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 20  *
 21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 22  * or visit www.oracle.com if you need additional information or have any
 23  * questions.
 24  */
 25 
 26 package jdk.incubator.jpackage.internal;
 27 
 28 import java.io.*;
 29 import java.nio.file.Files;
 30 import java.nio.file.Path;
 31 import java.text.MessageFormat;
 32 import java.util.*;
 33 import static jdk.incubator.jpackage.internal.MacAppImageBuilder.ICON_ICNS;
 34 import static jdk.incubator.jpackage.internal.MacAppImageBuilder.MAC_CF_BUNDLE_IDENTIFIER;
 35 import static jdk.incubator.jpackage.internal.OverridableResource.createResource;
 36 
 37 import static jdk.incubator.jpackage.internal.StandardBundlerParam.*;
 38 
 39 public class MacDmgBundler extends MacBaseInstallerBundler {
 40 
 41     private static final ResourceBundle I18N = ResourceBundle.getBundle(
 42             &quot;jdk.incubator.jpackage.internal.resources.MacResources&quot;);
 43 
 44     // Background image name in resources
 45     static final String DEFAULT_BACKGROUND_IMAGE = &quot;background_dmg.tiff&quot;;
 46     // Backround image name and folder under which it will be stored in DMG
 47     static final String BACKGROUND_IMAGE_FOLDER =&quot;.background&quot;;
 48     static final String BACKGROUND_IMAGE = &quot;background.tiff&quot;;
 49     static final String DEFAULT_DMG_SETUP_SCRIPT = &quot;DMGsetup.scpt&quot;;
 50     static final String TEMPLATE_BUNDLE_ICON = &quot;java.icns&quot;;
 51 
 52     static final String DEFAULT_LICENSE_PLIST=&quot;lic_template.plist&quot;;
 53 
 54     public static final BundlerParamInfo&lt;String&gt; INSTALLER_SUFFIX =
 55             new StandardBundlerParam&lt;&gt; (
 56             &quot;mac.dmg.installerName.suffix&quot;,
 57             String.class,
 58             params -&gt; &quot;&quot;,
 59             (s, p) -&gt; s);
 60 
 61     public File bundle(Map&lt;String, ? super Object&gt; params,
 62             File outdir) throws PackagerException {
 63         Log.verbose(MessageFormat.format(I18N.getString(&quot;message.building-dmg&quot;),
 64                 APP_NAME.fetchFrom(params)));
 65 
 66         IOUtils.writableOutputDir(outdir.toPath());
 67 
 68         File appImageDir = APP_IMAGE_TEMP_ROOT.fetchFrom(params);
 69         try {
 70             appImageDir.mkdirs();
<a name="1" id="anc1"></a><span class="line-added"> 71             File appLocation = prepareAppBundle(params);</span>
 72 
<a name="2" id="anc2"></a><span class="line-modified"> 73             if (appLocation != null &amp;&amp; prepareConfigFiles(params)) {</span>

 74                 File configScript = getConfig_Script(params);
 75                 if (configScript.exists()) {
 76                     Log.verbose(MessageFormat.format(
 77                             I18N.getString(&quot;message.running-script&quot;),
 78                             configScript.getAbsolutePath()));
 79                     IOUtils.run(&quot;bash&quot;, configScript);
 80                 }
 81 
<a name="3" id="anc3"></a><span class="line-modified"> 82                 return buildDMG(params, appLocation, outdir);</span>
 83             }
 84             return null;
 85         } catch (IOException ex) {
 86             Log.verbose(ex);
 87             throw new PackagerException(ex);
 88         }
 89     }
 90 
 91     private static final String hdiutil = &quot;/usr/bin/hdiutil&quot;;
 92 
 93     private void prepareDMGSetupScript(Map&lt;String, ? super Object&gt; params)
 94                                                                     throws IOException {
 95         File dmgSetup = getConfig_VolumeScript(params);
 96         Log.verbose(MessageFormat.format(
 97                 I18N.getString(&quot;message.preparing-dmg-setup&quot;),
 98                 dmgSetup.getAbsolutePath()));
 99 
100         // We need to use URL for DMG to find it. We cannot use volume name, since
101         // user might have open DMG with same volume name already. Url should end with
102         // &#39;/&#39; and it should be real path (no symbolic links).
103         File imageDir = IMAGES_ROOT.fetchFrom(params);
104         if (!imageDir.exists()) imageDir.mkdirs(); // Create it, since it does not exist
105         Path rootPath = Path.of(imageDir.toString()).toRealPath();
106         Path volumePath = rootPath.resolve(APP_NAME.fetchFrom(params));
107         String volumeUrl = volumePath.toUri().toString() + File.separator;
108 
109         // Provide full path to backround image, so we can find it.
110         Path bgFile = Path.of(rootPath.toString(), APP_NAME.fetchFrom(params),
111                               BACKGROUND_IMAGE_FOLDER, BACKGROUND_IMAGE);
112 
113         //prepare config for exe
114         Map&lt;String, String&gt; data = new HashMap&lt;&gt;();
115         data.put(&quot;DEPLOY_VOLUME_URL&quot;, volumeUrl);
116         data.put(&quot;DEPLOY_BG_FILE&quot;, bgFile.toString());
117         data.put(&quot;DEPLOY_VOLUME_PATH&quot;, volumePath.toString());
118         data.put(&quot;DEPLOY_APPLICATION_NAME&quot;, APP_NAME.fetchFrom(params));
119 
<a name="4" id="anc4"></a><span class="line-modified">120         data.put(&quot;DEPLOY_INSTALL_LOCATION&quot;, getInstallDir(params));</span>

121 
122         createResource(DEFAULT_DMG_SETUP_SCRIPT, params)
123                 .setCategory(I18N.getString(&quot;resource.dmg-setup-script&quot;))
124                 .setSubstitutionData(data)
125                 .saveToFile(dmgSetup);
126     }
127 
128     private File getConfig_VolumeScript(Map&lt;String, ? super Object&gt; params) {
129         return new File(CONFIG_ROOT.fetchFrom(params),
130                 APP_NAME.fetchFrom(params) + &quot;-dmg-setup.scpt&quot;);
131     }
132 
133     private File getConfig_VolumeBackground(
134             Map&lt;String, ? super Object&gt; params) {
135         return new File(CONFIG_ROOT.fetchFrom(params),
136                 APP_NAME.fetchFrom(params) + &quot;-background.tiff&quot;);
137     }
138 
139     private File getConfig_VolumeIcon(Map&lt;String, ? super Object&gt; params) {
140         return new File(CONFIG_ROOT.fetchFrom(params),
141                 APP_NAME.fetchFrom(params) + &quot;-volume.icns&quot;);
142     }
143 
144     private File getConfig_LicenseFile(Map&lt;String, ? super Object&gt; params) {
145         return new File(CONFIG_ROOT.fetchFrom(params),
146                 APP_NAME.fetchFrom(params) + &quot;-license.plist&quot;);
147     }
148 
149     private void prepareLicense(Map&lt;String, ? super Object&gt; params) {
150         try {
151             String licFileStr = LICENSE_FILE.fetchFrom(params);
152             if (licFileStr == null) {
153                 return;
154             }
155 
156             File licFile = new File(licFileStr);
157             byte[] licenseContentOriginal =
158                     Files.readAllBytes(licFile.toPath());
159             String licenseInBase64 =
160                     Base64.getEncoder().encodeToString(licenseContentOriginal);
161 
162             Map&lt;String, String&gt; data = new HashMap&lt;&gt;();
163             data.put(&quot;APPLICATION_LICENSE_TEXT&quot;, licenseInBase64);
164 
165             createResource(DEFAULT_LICENSE_PLIST, params)
166                     .setCategory(I18N.getString(&quot;resource.license-setup&quot;))
167                     .setSubstitutionData(data)
168                     .saveToFile(getConfig_LicenseFile(params));
169 
170         } catch (IOException ex) {
171             Log.verbose(ex);
172         }
173     }
174 
175     private boolean prepareConfigFiles(Map&lt;String, ? super Object&gt; params)
176             throws IOException {
177 
178         createResource(DEFAULT_BACKGROUND_IMAGE, params)
179                     .setCategory(I18N.getString(&quot;resource.dmg-background&quot;))
180                     .saveToFile(getConfig_VolumeBackground(params));
181 
182         createResource(TEMPLATE_BUNDLE_ICON, params)
183                 .setCategory(I18N.getString(&quot;resource.volume-icon&quot;))
184                 .setExternal(ICON_ICNS.fetchFrom(params))
185                 .saveToFile(getConfig_VolumeIcon(params));
186 
187         createResource(null, params)
188                 .setCategory(I18N.getString(&quot;resource.post-install-script&quot;))
189                 .saveToFile(getConfig_Script(params));
190 
191         prepareLicense(params);
192 
193         prepareDMGSetupScript(params);
194 
195         return true;
196     }
197 
198     // name of post-image script
199     private File getConfig_Script(Map&lt;String, ? super Object&gt; params) {
200         return new File(CONFIG_ROOT.fetchFrom(params),
201                 APP_NAME.fetchFrom(params) + &quot;-post-image.sh&quot;);
202     }
203 
204     // Location of SetFile utility may be different depending on MacOS version
205     // We look for several known places and if none of them work will
206     // try ot find it
207     private String findSetFileUtility() {
208         String typicalPaths[] = {&quot;/Developer/Tools/SetFile&quot;,
209                 &quot;/usr/bin/SetFile&quot;, &quot;/Developer/usr/bin/SetFile&quot;};
210 
211         String setFilePath = null;
212         for (String path: typicalPaths) {
213             File f = new File(path);
214             if (f.exists() &amp;&amp; f.canExecute()) {
215                 setFilePath = path;
216                 break;
217             }
218         }
219 
220         // Validate SetFile, if Xcode is not installed it will run, but exit with error
221         // code
222         if (setFilePath != null) {
223             try {
224                 ProcessBuilder pb = new ProcessBuilder(setFilePath, &quot;-h&quot;);
225                 Process p = pb.start();
226                 int code = p.waitFor();
227                 if (code == 0) {
228                     return setFilePath;
229                 }
230             } catch (Exception ignored) {}
231 
232             // No need for generic find attempt. We found it, but it does not work.
233             // Probably due to missing xcode.
234             return null;
235         }
236 
237         // generic find attempt
238         try {
239             ProcessBuilder pb = new ProcessBuilder(&quot;xcrun&quot;, &quot;-find&quot;, &quot;SetFile&quot;);
240             Process p = pb.start();
241             InputStreamReader isr = new InputStreamReader(p.getInputStream());
242             BufferedReader br = new BufferedReader(isr);
243             String lineRead = br.readLine();
244             if (lineRead != null) {
245                 File f = new File(lineRead);
246                 if (f.exists() &amp;&amp; f.canExecute()) {
247                     return f.getAbsolutePath();
248                 }
249             }
250         } catch (IOException ignored) {}
251 
252         return null;
253     }
254 
<a name="5" id="anc5"></a><span class="line-modified">255     private File buildDMG( Map&lt;String, ? super Object&gt; params,</span>
<span class="line-modified">256             File appLocation, File outdir) throws IOException {</span>

257         File imagesRoot = IMAGES_ROOT.fetchFrom(params);
258         if (!imagesRoot.exists()) imagesRoot.mkdirs();
259 
260         File protoDMG = new File(imagesRoot,
261                 APP_NAME.fetchFrom(params) +&quot;-tmp.dmg&quot;);
262         File finalDMG = new File(outdir, INSTALLER_NAME.fetchFrom(params)
263                 + INSTALLER_SUFFIX.fetchFrom(params) + &quot;.dmg&quot;);
264 
265         File srcFolder = APP_IMAGE_TEMP_ROOT.fetchFrom(params);
266         File predefinedImage =
267                 StandardBundlerParam.getPredefinedAppImage(params);
268         if (predefinedImage != null) {
269             srcFolder = predefinedImage;
<a name="6" id="anc6"></a><span class="line-added">270         } else if (StandardBundlerParam.isRuntimeInstaller(params)) {</span>
<span class="line-added">271             Path newRoot = Files.createTempDirectory(</span>
<span class="line-added">272                 TEMP_ROOT.fetchFrom(params).toPath(), &quot;root-&quot;);</span>
<span class="line-added">273 </span>
<span class="line-added">274             // first, is this already a runtime with</span>
<span class="line-added">275             // &lt;runtime&gt;/Contents/Home - if so we need the Home dir</span>
<span class="line-added">276             Path original = appLocation.toPath();</span>
<span class="line-added">277             Path home = original.resolve(&quot;Contents/Home&quot;);</span>
<span class="line-added">278             Path source = (Files.exists(home)) ? home : original;</span>
<span class="line-added">279 </span>
<span class="line-added">280             // Then we need to put back the &lt;NAME&gt;/Content/Home</span>
<span class="line-added">281             Path root = newRoot.resolve(</span>
<span class="line-added">282                     MAC_CF_BUNDLE_IDENTIFIER.fetchFrom(params));</span>
<span class="line-added">283             Path dest = root.resolve(&quot;Contents/Home&quot;);</span>
<span class="line-added">284 </span>
<span class="line-added">285             IOUtils.copyRecursive(source, dest);</span>
<span class="line-added">286 </span>
<span class="line-added">287             srcFolder = newRoot.toFile();</span>
288         }
289 
290         Log.verbose(MessageFormat.format(I18N.getString(
291                 &quot;message.creating-dmg-file&quot;), finalDMG.getAbsolutePath()));
292 
293         protoDMG.delete();
294         if (finalDMG.exists() &amp;&amp; !finalDMG.delete()) {
295             throw new IOException(MessageFormat.format(I18N.getString(
296                     &quot;message.dmg-cannot-be-overwritten&quot;),
297                     finalDMG.getAbsolutePath()));
298         }
299 
300         protoDMG.getParentFile().mkdirs();
301         finalDMG.getParentFile().mkdirs();
302 
303         String hdiUtilVerbosityFlag = VERBOSE.fetchFrom(params) ?
304                 &quot;-verbose&quot; : &quot;-quiet&quot;;
305 
306         // create temp image
307         ProcessBuilder pb = new ProcessBuilder(
308                 hdiutil,
309                 &quot;create&quot;,
310                 hdiUtilVerbosityFlag,
311                 &quot;-srcfolder&quot;, srcFolder.getAbsolutePath(),
312                 &quot;-volname&quot;, APP_NAME.fetchFrom(params),
313                 &quot;-ov&quot;, protoDMG.getAbsolutePath(),
314                 &quot;-fs&quot;, &quot;HFS+&quot;,
315                 &quot;-format&quot;, &quot;UDRW&quot;);
316         IOUtils.exec(pb);
317 
318         // mount temp image
319         pb = new ProcessBuilder(
320                 hdiutil,
321                 &quot;attach&quot;,
322                 protoDMG.getAbsolutePath(),
323                 hdiUtilVerbosityFlag,
324                 &quot;-mountroot&quot;, imagesRoot.getAbsolutePath());
325         IOUtils.exec(pb, false, null, true);
326 
327         File mountedRoot = new File(imagesRoot.getAbsolutePath(),
328                     APP_NAME.fetchFrom(params));
<a name="7" id="anc7"></a>
329         try {
<a name="8" id="anc8"></a>




330             // background image
331             File bgdir = new File(mountedRoot, BACKGROUND_IMAGE_FOLDER);
332             bgdir.mkdirs();
333             IOUtils.copyFile(getConfig_VolumeBackground(params),
334                     new File(bgdir, BACKGROUND_IMAGE));
335 
<a name="9" id="anc9"></a><span class="line-added">336             // We will not consider setting background image and creating link</span>
<span class="line-added">337             // to install-dir in DMG as critical error, since it can fail in</span>
<span class="line-added">338             // headless enviroment.</span>
<span class="line-added">339             try {</span>
<span class="line-added">340                 pb = new ProcessBuilder(&quot;osascript&quot;,</span>
<span class="line-added">341                         getConfig_VolumeScript(params).getAbsolutePath());</span>
<span class="line-added">342                 IOUtils.exec(pb);</span>
<span class="line-added">343             } catch (IOException ex) {</span>
<span class="line-added">344                 Log.verbose(ex);</span>
<span class="line-added">345             }</span>
<span class="line-added">346 </span>
<span class="line-added">347             // volume icon</span>
<span class="line-added">348             File volumeIconFile = new File(mountedRoot, &quot;.VolumeIcon.icns&quot;);</span>
<span class="line-added">349             IOUtils.copyFile(getConfig_VolumeIcon(params),</span>
<span class="line-added">350                     volumeIconFile);</span>
<span class="line-added">351 </span>
352             // Indicate that we want a custom icon
353             // NB: attributes of the root directory are ignored
354             // when creating the volume
355             // Therefore we have to do this after we mount image
356             String setFileUtility = findSetFileUtility();
357             if (setFileUtility != null) {
358                 //can not find utility =&gt; keep going without icon
359                 try {
360                     volumeIconFile.setWritable(true);
361                     // The &quot;creator&quot; attribute on a file is a legacy attribute
362                     // but it seems Finder excepts these bytes to be
363                     // &quot;icnC&quot; for the volume icon
364                     // (might not work on Mac 10.13 with old XCode)
365                     pb = new ProcessBuilder(
366                             setFileUtility,
367                             &quot;-c&quot;, &quot;icnC&quot;,
368                             volumeIconFile.getAbsolutePath());
369                     IOUtils.exec(pb);
370                     volumeIconFile.setReadOnly();
371 
372                     pb = new ProcessBuilder(
373                             setFileUtility,
374                             &quot;-a&quot;, &quot;C&quot;,
375                             mountedRoot.getAbsolutePath());
376                     IOUtils.exec(pb);
377                 } catch (IOException ex) {
378                     Log.error(ex.getMessage());
379                     Log.verbose(&quot;Cannot enable custom icon using SetFile utility&quot;);
380                 }
381             } else {
382                 Log.verbose(I18N.getString(&quot;message.setfile.dmg&quot;));
383             }
384 
<a name="10" id="anc10"></a>









385         } finally {
386             // Detach the temporary image
387             pb = new ProcessBuilder(
388                     hdiutil,
389                     &quot;detach&quot;,
390                     &quot;-force&quot;,
391                     hdiUtilVerbosityFlag,
392                     mountedRoot.getAbsolutePath());
393             IOUtils.exec(pb);
394         }
395 
396         // Compress it to a new image
397         pb = new ProcessBuilder(
398                 hdiutil,
399                 &quot;convert&quot;,
400                 protoDMG.getAbsolutePath(),
401                 hdiUtilVerbosityFlag,
402                 &quot;-format&quot;, &quot;UDZO&quot;,
403                 &quot;-o&quot;, finalDMG.getAbsolutePath());
404         IOUtils.exec(pb);
405 
406         //add license if needed
407         if (getConfig_LicenseFile(params).exists()) {
408             //hdiutil unflatten your_image_file.dmg
409             pb = new ProcessBuilder(
410                     hdiutil,
411                     &quot;unflatten&quot;,
412                     finalDMG.getAbsolutePath()
413             );
414             IOUtils.exec(pb);
415 
416             //add license
417             pb = new ProcessBuilder(
418                     hdiutil,
419                     &quot;udifrez&quot;,
420                     finalDMG.getAbsolutePath(),
421                     &quot;-xml&quot;,
422                     getConfig_LicenseFile(params).getAbsolutePath()
423             );
424             IOUtils.exec(pb);
425 
426             //hdiutil flatten your_image_file.dmg
427             pb = new ProcessBuilder(
428                     hdiutil,
429                     &quot;flatten&quot;,
430                     finalDMG.getAbsolutePath()
431             );
432             IOUtils.exec(pb);
433 
434         }
435 
436         //Delete the temporary image
437         protoDMG.delete();
438 
439         Log.verbose(MessageFormat.format(I18N.getString(
440                 &quot;message.output-to-location&quot;),
441                 APP_NAME.fetchFrom(params), finalDMG.getAbsolutePath()));
442 
443         return finalDMG;
444     }
445 
446 
447     //////////////////////////////////////////////////////////////////////////
448     // Implement Bundler
449     //////////////////////////////////////////////////////////////////////////
450 
451     @Override
452     public String getName() {
453         return I18N.getString(&quot;dmg.bundler.name&quot;);
454     }
455 
456     @Override
457     public String getID() {
458         return &quot;dmg&quot;;
459     }
460 
461     @Override
462     public boolean validate(Map&lt;String, ? super Object&gt; params)
463             throws ConfigException {
464         try {
465             Objects.requireNonNull(params);
466 
467             //run basic validation to ensure requirements are met
468             //we are not interested in return code, only possible exception
469             validateAppImageAndBundeler(params);
470 
471             return true;
472         } catch (RuntimeException re) {
473             if (re.getCause() instanceof ConfigException) {
474                 throw (ConfigException) re.getCause();
475             } else {
476                 throw new ConfigException(re);
477             }
478         }
479     }
480 
481     @Override
482     public File execute(Map&lt;String, ? super Object&gt; params,
483             File outputParentDir) throws PackagerException {
484         return bundle(params, outputParentDir);
485     }
486 
487     @Override
488     public boolean supported(boolean runtimeInstaller) {
489         return isSupported();
490     }
491 
492     public final static String[] required =
493             {&quot;/usr/bin/hdiutil&quot;, &quot;/usr/bin/osascript&quot;};
494     public static boolean isSupported() {
495         try {
496             for (String s : required) {
497                 File f = new File(s);
498                 if (!f.exists() || !f.canExecute()) {
499                     return false;
500                 }
501             }
502             return true;
503         } catch (Exception e) {
504             return false;
505         }
506     }
507 
508     @Override
509     public boolean isDefault() {
510         return true;
511     }
<a name="11" id="anc11"></a>
512 }
<a name="12" id="anc12"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="12" type="hidden" />
</body>
</html>