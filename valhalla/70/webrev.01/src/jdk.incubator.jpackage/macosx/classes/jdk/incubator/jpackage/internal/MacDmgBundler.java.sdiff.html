<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/jdk.incubator.jpackage/macosx/classes/jdk/incubator/jpackage/internal/MacDmgBundler.java</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="MacBaseInstallerBundler.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="MacPkgBundler.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/jdk.incubator.jpackage/macosx/classes/jdk/incubator/jpackage/internal/MacDmgBundler.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 51 
 52     static final String DEFAULT_LICENSE_PLIST=&quot;lic_template.plist&quot;;
 53 
 54     public static final BundlerParamInfo&lt;String&gt; INSTALLER_SUFFIX =
 55             new StandardBundlerParam&lt;&gt; (
 56             &quot;mac.dmg.installerName.suffix&quot;,
 57             String.class,
 58             params -&gt; &quot;&quot;,
 59             (s, p) -&gt; s);
 60 
 61     public File bundle(Map&lt;String, ? super Object&gt; params,
 62             File outdir) throws PackagerException {
 63         Log.verbose(MessageFormat.format(I18N.getString(&quot;message.building-dmg&quot;),
 64                 APP_NAME.fetchFrom(params)));
 65 
 66         IOUtils.writableOutputDir(outdir.toPath());
 67 
 68         File appImageDir = APP_IMAGE_TEMP_ROOT.fetchFrom(params);
 69         try {
 70             appImageDir.mkdirs();

 71 
<span class="line-modified"> 72             if (prepareAppBundle(params) != null &amp;&amp;</span>
<span class="line-removed"> 73                     prepareConfigFiles(params)) {</span>
 74                 File configScript = getConfig_Script(params);
 75                 if (configScript.exists()) {
 76                     Log.verbose(MessageFormat.format(
 77                             I18N.getString(&quot;message.running-script&quot;),
 78                             configScript.getAbsolutePath()));
 79                     IOUtils.run(&quot;bash&quot;, configScript);
 80                 }
 81 
<span class="line-modified"> 82                 return buildDMG(params, outdir);</span>
 83             }
 84             return null;
 85         } catch (IOException ex) {
 86             Log.verbose(ex);
 87             throw new PackagerException(ex);
 88         }
 89     }
 90 
 91     private static final String hdiutil = &quot;/usr/bin/hdiutil&quot;;
 92 
 93     private void prepareDMGSetupScript(Map&lt;String, ? super Object&gt; params)
 94                                                                     throws IOException {
 95         File dmgSetup = getConfig_VolumeScript(params);
 96         Log.verbose(MessageFormat.format(
 97                 I18N.getString(&quot;message.preparing-dmg-setup&quot;),
 98                 dmgSetup.getAbsolutePath()));
 99 
100         // We need to use URL for DMG to find it. We cannot use volume name, since
101         // user might have open DMG with same volume name already. Url should end with
102         // &#39;/&#39; and it should be real path (no symbolic links).
103         File imageDir = IMAGES_ROOT.fetchFrom(params);
104         if (!imageDir.exists()) imageDir.mkdirs(); // Create it, since it does not exist
105         Path rootPath = Path.of(imageDir.toString()).toRealPath();
106         Path volumePath = rootPath.resolve(APP_NAME.fetchFrom(params));
107         String volumeUrl = volumePath.toUri().toString() + File.separator;
108 
109         // Provide full path to backround image, so we can find it.
110         Path bgFile = Path.of(rootPath.toString(), APP_NAME.fetchFrom(params),
111                               BACKGROUND_IMAGE_FOLDER, BACKGROUND_IMAGE);
112 
113         //prepare config for exe
114         Map&lt;String, String&gt; data = new HashMap&lt;&gt;();
115         data.put(&quot;DEPLOY_VOLUME_URL&quot;, volumeUrl);
116         data.put(&quot;DEPLOY_BG_FILE&quot;, bgFile.toString());
117         data.put(&quot;DEPLOY_VOLUME_PATH&quot;, volumePath.toString());
118         data.put(&quot;DEPLOY_APPLICATION_NAME&quot;, APP_NAME.fetchFrom(params));
119 
<span class="line-modified">120         data.put(&quot;DEPLOY_INSTALL_LOCATION&quot;, MAC_INSTALL_DIR.fetchFrom(params));</span>
<span class="line-removed">121         data.put(&quot;DEPLOY_INSTALL_NAME&quot;, MAC_INSTALL_DIR.fetchFrom(params));</span>
122 
123         createResource(DEFAULT_DMG_SETUP_SCRIPT, params)
124                 .setCategory(I18N.getString(&quot;resource.dmg-setup-script&quot;))
125                 .setSubstitutionData(data)
126                 .saveToFile(dmgSetup);
127     }
128 
129     private File getConfig_VolumeScript(Map&lt;String, ? super Object&gt; params) {
130         return new File(CONFIG_ROOT.fetchFrom(params),
131                 APP_NAME.fetchFrom(params) + &quot;-dmg-setup.scpt&quot;);
132     }
133 
134     private File getConfig_VolumeBackground(
135             Map&lt;String, ? super Object&gt; params) {
136         return new File(CONFIG_ROOT.fetchFrom(params),
137                 APP_NAME.fetchFrom(params) + &quot;-background.tiff&quot;);
138     }
139 
140     private File getConfig_VolumeIcon(Map&lt;String, ? super Object&gt; params) {
141         return new File(CONFIG_ROOT.fetchFrom(params),
</pre>
<hr />
<pre>
236         }
237 
238         // generic find attempt
239         try {
240             ProcessBuilder pb = new ProcessBuilder(&quot;xcrun&quot;, &quot;-find&quot;, &quot;SetFile&quot;);
241             Process p = pb.start();
242             InputStreamReader isr = new InputStreamReader(p.getInputStream());
243             BufferedReader br = new BufferedReader(isr);
244             String lineRead = br.readLine();
245             if (lineRead != null) {
246                 File f = new File(lineRead);
247                 if (f.exists() &amp;&amp; f.canExecute()) {
248                     return f.getAbsolutePath();
249                 }
250             }
251         } catch (IOException ignored) {}
252 
253         return null;
254     }
255 
<span class="line-modified">256     private File buildDMG(</span>
<span class="line-modified">257             Map&lt;String, ? super Object&gt; params, File outdir)</span>
<span class="line-removed">258             throws IOException {</span>
259         File imagesRoot = IMAGES_ROOT.fetchFrom(params);
260         if (!imagesRoot.exists()) imagesRoot.mkdirs();
261 
262         File protoDMG = new File(imagesRoot,
263                 APP_NAME.fetchFrom(params) +&quot;-tmp.dmg&quot;);
264         File finalDMG = new File(outdir, INSTALLER_NAME.fetchFrom(params)
265                 + INSTALLER_SUFFIX.fetchFrom(params) + &quot;.dmg&quot;);
266 
267         File srcFolder = APP_IMAGE_TEMP_ROOT.fetchFrom(params);
268         File predefinedImage =
269                 StandardBundlerParam.getPredefinedAppImage(params);
270         if (predefinedImage != null) {
271             srcFolder = predefinedImage;


















272         }
273 
274         Log.verbose(MessageFormat.format(I18N.getString(
275                 &quot;message.creating-dmg-file&quot;), finalDMG.getAbsolutePath()));
276 
277         protoDMG.delete();
278         if (finalDMG.exists() &amp;&amp; !finalDMG.delete()) {
279             throw new IOException(MessageFormat.format(I18N.getString(
280                     &quot;message.dmg-cannot-be-overwritten&quot;),
281                     finalDMG.getAbsolutePath()));
282         }
283 
284         protoDMG.getParentFile().mkdirs();
285         finalDMG.getParentFile().mkdirs();
286 
287         String hdiUtilVerbosityFlag = VERBOSE.fetchFrom(params) ?
288                 &quot;-verbose&quot; : &quot;-quiet&quot;;
289 
290         // create temp image
291         ProcessBuilder pb = new ProcessBuilder(
</pre>
<hr />
<pre>
293                 &quot;create&quot;,
294                 hdiUtilVerbosityFlag,
295                 &quot;-srcfolder&quot;, srcFolder.getAbsolutePath(),
296                 &quot;-volname&quot;, APP_NAME.fetchFrom(params),
297                 &quot;-ov&quot;, protoDMG.getAbsolutePath(),
298                 &quot;-fs&quot;, &quot;HFS+&quot;,
299                 &quot;-format&quot;, &quot;UDRW&quot;);
300         IOUtils.exec(pb);
301 
302         // mount temp image
303         pb = new ProcessBuilder(
304                 hdiutil,
305                 &quot;attach&quot;,
306                 protoDMG.getAbsolutePath(),
307                 hdiUtilVerbosityFlag,
308                 &quot;-mountroot&quot;, imagesRoot.getAbsolutePath());
309         IOUtils.exec(pb, false, null, true);
310 
311         File mountedRoot = new File(imagesRoot.getAbsolutePath(),
312                     APP_NAME.fetchFrom(params));
<span class="line-removed">313 </span>
314         try {
<span class="line-removed">315             // volume icon</span>
<span class="line-removed">316             File volumeIconFile = new File(mountedRoot, &quot;.VolumeIcon.icns&quot;);</span>
<span class="line-removed">317             IOUtils.copyFile(getConfig_VolumeIcon(params),</span>
<span class="line-removed">318                     volumeIconFile);</span>
<span class="line-removed">319 </span>
320             // background image
321             File bgdir = new File(mountedRoot, BACKGROUND_IMAGE_FOLDER);
322             bgdir.mkdirs();
323             IOUtils.copyFile(getConfig_VolumeBackground(params),
324                     new File(bgdir, BACKGROUND_IMAGE));
325 
















326             // Indicate that we want a custom icon
327             // NB: attributes of the root directory are ignored
328             // when creating the volume
329             // Therefore we have to do this after we mount image
330             String setFileUtility = findSetFileUtility();
331             if (setFileUtility != null) {
332                 //can not find utility =&gt; keep going without icon
333                 try {
334                     volumeIconFile.setWritable(true);
335                     // The &quot;creator&quot; attribute on a file is a legacy attribute
336                     // but it seems Finder excepts these bytes to be
337                     // &quot;icnC&quot; for the volume icon
338                     // (might not work on Mac 10.13 with old XCode)
339                     pb = new ProcessBuilder(
340                             setFileUtility,
341                             &quot;-c&quot;, &quot;icnC&quot;,
342                             volumeIconFile.getAbsolutePath());
343                     IOUtils.exec(pb);
344                     volumeIconFile.setReadOnly();
345 
346                     pb = new ProcessBuilder(
347                             setFileUtility,
348                             &quot;-a&quot;, &quot;C&quot;,
349                             mountedRoot.getAbsolutePath());
350                     IOUtils.exec(pb);
351                 } catch (IOException ex) {
352                     Log.error(ex.getMessage());
353                     Log.verbose(&quot;Cannot enable custom icon using SetFile utility&quot;);
354                 }
355             } else {
356                 Log.verbose(I18N.getString(&quot;message.setfile.dmg&quot;));
357             }
358 
<span class="line-removed">359             // We will not consider setting background image and creating link to</span>
<span class="line-removed">360             // /Application folder in DMG as critical error, since it can fail in</span>
<span class="line-removed">361             // headless enviroment.</span>
<span class="line-removed">362             try {</span>
<span class="line-removed">363                 pb = new ProcessBuilder(&quot;osascript&quot;,</span>
<span class="line-removed">364                         getConfig_VolumeScript(params).getAbsolutePath());</span>
<span class="line-removed">365                 IOUtils.exec(pb);</span>
<span class="line-removed">366             } catch (IOException ex) {</span>
<span class="line-removed">367                 Log.verbose(ex);</span>
<span class="line-removed">368             }</span>
369         } finally {
370             // Detach the temporary image
371             pb = new ProcessBuilder(
372                     hdiutil,
373                     &quot;detach&quot;,
374                     &quot;-force&quot;,
375                     hdiUtilVerbosityFlag,
376                     mountedRoot.getAbsolutePath());
377             IOUtils.exec(pb);
378         }
379 
380         // Compress it to a new image
381         pb = new ProcessBuilder(
382                 hdiutil,
383                 &quot;convert&quot;,
384                 protoDMG.getAbsolutePath(),
385                 hdiUtilVerbosityFlag,
386                 &quot;-format&quot;, &quot;UDZO&quot;,
387                 &quot;-o&quot;, finalDMG.getAbsolutePath());
388         IOUtils.exec(pb);
</pre>
<hr />
<pre>
476     public final static String[] required =
477             {&quot;/usr/bin/hdiutil&quot;, &quot;/usr/bin/osascript&quot;};
478     public static boolean isSupported() {
479         try {
480             for (String s : required) {
481                 File f = new File(s);
482                 if (!f.exists() || !f.canExecute()) {
483                     return false;
484                 }
485             }
486             return true;
487         } catch (Exception e) {
488             return false;
489         }
490     }
491 
492     @Override
493     public boolean isDefault() {
494         return true;
495     }
<span class="line-removed">496 </span>
497 }
</pre>
</td>
<td>
<hr />
<pre>
 51 
 52     static final String DEFAULT_LICENSE_PLIST=&quot;lic_template.plist&quot;;
 53 
 54     public static final BundlerParamInfo&lt;String&gt; INSTALLER_SUFFIX =
 55             new StandardBundlerParam&lt;&gt; (
 56             &quot;mac.dmg.installerName.suffix&quot;,
 57             String.class,
 58             params -&gt; &quot;&quot;,
 59             (s, p) -&gt; s);
 60 
 61     public File bundle(Map&lt;String, ? super Object&gt; params,
 62             File outdir) throws PackagerException {
 63         Log.verbose(MessageFormat.format(I18N.getString(&quot;message.building-dmg&quot;),
 64                 APP_NAME.fetchFrom(params)));
 65 
 66         IOUtils.writableOutputDir(outdir.toPath());
 67 
 68         File appImageDir = APP_IMAGE_TEMP_ROOT.fetchFrom(params);
 69         try {
 70             appImageDir.mkdirs();
<span class="line-added"> 71             File appLocation = prepareAppBundle(params);</span>
 72 
<span class="line-modified"> 73             if (appLocation != null &amp;&amp; prepareConfigFiles(params)) {</span>

 74                 File configScript = getConfig_Script(params);
 75                 if (configScript.exists()) {
 76                     Log.verbose(MessageFormat.format(
 77                             I18N.getString(&quot;message.running-script&quot;),
 78                             configScript.getAbsolutePath()));
 79                     IOUtils.run(&quot;bash&quot;, configScript);
 80                 }
 81 
<span class="line-modified"> 82                 return buildDMG(params, appLocation, outdir);</span>
 83             }
 84             return null;
 85         } catch (IOException ex) {
 86             Log.verbose(ex);
 87             throw new PackagerException(ex);
 88         }
 89     }
 90 
 91     private static final String hdiutil = &quot;/usr/bin/hdiutil&quot;;
 92 
 93     private void prepareDMGSetupScript(Map&lt;String, ? super Object&gt; params)
 94                                                                     throws IOException {
 95         File dmgSetup = getConfig_VolumeScript(params);
 96         Log.verbose(MessageFormat.format(
 97                 I18N.getString(&quot;message.preparing-dmg-setup&quot;),
 98                 dmgSetup.getAbsolutePath()));
 99 
100         // We need to use URL for DMG to find it. We cannot use volume name, since
101         // user might have open DMG with same volume name already. Url should end with
102         // &#39;/&#39; and it should be real path (no symbolic links).
103         File imageDir = IMAGES_ROOT.fetchFrom(params);
104         if (!imageDir.exists()) imageDir.mkdirs(); // Create it, since it does not exist
105         Path rootPath = Path.of(imageDir.toString()).toRealPath();
106         Path volumePath = rootPath.resolve(APP_NAME.fetchFrom(params));
107         String volumeUrl = volumePath.toUri().toString() + File.separator;
108 
109         // Provide full path to backround image, so we can find it.
110         Path bgFile = Path.of(rootPath.toString(), APP_NAME.fetchFrom(params),
111                               BACKGROUND_IMAGE_FOLDER, BACKGROUND_IMAGE);
112 
113         //prepare config for exe
114         Map&lt;String, String&gt; data = new HashMap&lt;&gt;();
115         data.put(&quot;DEPLOY_VOLUME_URL&quot;, volumeUrl);
116         data.put(&quot;DEPLOY_BG_FILE&quot;, bgFile.toString());
117         data.put(&quot;DEPLOY_VOLUME_PATH&quot;, volumePath.toString());
118         data.put(&quot;DEPLOY_APPLICATION_NAME&quot;, APP_NAME.fetchFrom(params));
119 
<span class="line-modified">120         data.put(&quot;DEPLOY_INSTALL_LOCATION&quot;, getInstallDir(params));</span>

121 
122         createResource(DEFAULT_DMG_SETUP_SCRIPT, params)
123                 .setCategory(I18N.getString(&quot;resource.dmg-setup-script&quot;))
124                 .setSubstitutionData(data)
125                 .saveToFile(dmgSetup);
126     }
127 
128     private File getConfig_VolumeScript(Map&lt;String, ? super Object&gt; params) {
129         return new File(CONFIG_ROOT.fetchFrom(params),
130                 APP_NAME.fetchFrom(params) + &quot;-dmg-setup.scpt&quot;);
131     }
132 
133     private File getConfig_VolumeBackground(
134             Map&lt;String, ? super Object&gt; params) {
135         return new File(CONFIG_ROOT.fetchFrom(params),
136                 APP_NAME.fetchFrom(params) + &quot;-background.tiff&quot;);
137     }
138 
139     private File getConfig_VolumeIcon(Map&lt;String, ? super Object&gt; params) {
140         return new File(CONFIG_ROOT.fetchFrom(params),
</pre>
<hr />
<pre>
235         }
236 
237         // generic find attempt
238         try {
239             ProcessBuilder pb = new ProcessBuilder(&quot;xcrun&quot;, &quot;-find&quot;, &quot;SetFile&quot;);
240             Process p = pb.start();
241             InputStreamReader isr = new InputStreamReader(p.getInputStream());
242             BufferedReader br = new BufferedReader(isr);
243             String lineRead = br.readLine();
244             if (lineRead != null) {
245                 File f = new File(lineRead);
246                 if (f.exists() &amp;&amp; f.canExecute()) {
247                     return f.getAbsolutePath();
248                 }
249             }
250         } catch (IOException ignored) {}
251 
252         return null;
253     }
254 
<span class="line-modified">255     private File buildDMG( Map&lt;String, ? super Object&gt; params,</span>
<span class="line-modified">256             File appLocation, File outdir) throws IOException {</span>

257         File imagesRoot = IMAGES_ROOT.fetchFrom(params);
258         if (!imagesRoot.exists()) imagesRoot.mkdirs();
259 
260         File protoDMG = new File(imagesRoot,
261                 APP_NAME.fetchFrom(params) +&quot;-tmp.dmg&quot;);
262         File finalDMG = new File(outdir, INSTALLER_NAME.fetchFrom(params)
263                 + INSTALLER_SUFFIX.fetchFrom(params) + &quot;.dmg&quot;);
264 
265         File srcFolder = APP_IMAGE_TEMP_ROOT.fetchFrom(params);
266         File predefinedImage =
267                 StandardBundlerParam.getPredefinedAppImage(params);
268         if (predefinedImage != null) {
269             srcFolder = predefinedImage;
<span class="line-added">270         } else if (StandardBundlerParam.isRuntimeInstaller(params)) {</span>
<span class="line-added">271             Path newRoot = Files.createTempDirectory(</span>
<span class="line-added">272                 TEMP_ROOT.fetchFrom(params).toPath(), &quot;root-&quot;);</span>
<span class="line-added">273 </span>
<span class="line-added">274             // first, is this already a runtime with</span>
<span class="line-added">275             // &lt;runtime&gt;/Contents/Home - if so we need the Home dir</span>
<span class="line-added">276             Path original = appLocation.toPath();</span>
<span class="line-added">277             Path home = original.resolve(&quot;Contents/Home&quot;);</span>
<span class="line-added">278             Path source = (Files.exists(home)) ? home : original;</span>
<span class="line-added">279 </span>
<span class="line-added">280             // Then we need to put back the &lt;NAME&gt;/Content/Home</span>
<span class="line-added">281             Path root = newRoot.resolve(</span>
<span class="line-added">282                     MAC_CF_BUNDLE_IDENTIFIER.fetchFrom(params));</span>
<span class="line-added">283             Path dest = root.resolve(&quot;Contents/Home&quot;);</span>
<span class="line-added">284 </span>
<span class="line-added">285             IOUtils.copyRecursive(source, dest);</span>
<span class="line-added">286 </span>
<span class="line-added">287             srcFolder = newRoot.toFile();</span>
288         }
289 
290         Log.verbose(MessageFormat.format(I18N.getString(
291                 &quot;message.creating-dmg-file&quot;), finalDMG.getAbsolutePath()));
292 
293         protoDMG.delete();
294         if (finalDMG.exists() &amp;&amp; !finalDMG.delete()) {
295             throw new IOException(MessageFormat.format(I18N.getString(
296                     &quot;message.dmg-cannot-be-overwritten&quot;),
297                     finalDMG.getAbsolutePath()));
298         }
299 
300         protoDMG.getParentFile().mkdirs();
301         finalDMG.getParentFile().mkdirs();
302 
303         String hdiUtilVerbosityFlag = VERBOSE.fetchFrom(params) ?
304                 &quot;-verbose&quot; : &quot;-quiet&quot;;
305 
306         // create temp image
307         ProcessBuilder pb = new ProcessBuilder(
</pre>
<hr />
<pre>
309                 &quot;create&quot;,
310                 hdiUtilVerbosityFlag,
311                 &quot;-srcfolder&quot;, srcFolder.getAbsolutePath(),
312                 &quot;-volname&quot;, APP_NAME.fetchFrom(params),
313                 &quot;-ov&quot;, protoDMG.getAbsolutePath(),
314                 &quot;-fs&quot;, &quot;HFS+&quot;,
315                 &quot;-format&quot;, &quot;UDRW&quot;);
316         IOUtils.exec(pb);
317 
318         // mount temp image
319         pb = new ProcessBuilder(
320                 hdiutil,
321                 &quot;attach&quot;,
322                 protoDMG.getAbsolutePath(),
323                 hdiUtilVerbosityFlag,
324                 &quot;-mountroot&quot;, imagesRoot.getAbsolutePath());
325         IOUtils.exec(pb, false, null, true);
326 
327         File mountedRoot = new File(imagesRoot.getAbsolutePath(),
328                     APP_NAME.fetchFrom(params));

329         try {





330             // background image
331             File bgdir = new File(mountedRoot, BACKGROUND_IMAGE_FOLDER);
332             bgdir.mkdirs();
333             IOUtils.copyFile(getConfig_VolumeBackground(params),
334                     new File(bgdir, BACKGROUND_IMAGE));
335 
<span class="line-added">336             // We will not consider setting background image and creating link</span>
<span class="line-added">337             // to install-dir in DMG as critical error, since it can fail in</span>
<span class="line-added">338             // headless enviroment.</span>
<span class="line-added">339             try {</span>
<span class="line-added">340                 pb = new ProcessBuilder(&quot;osascript&quot;,</span>
<span class="line-added">341                         getConfig_VolumeScript(params).getAbsolutePath());</span>
<span class="line-added">342                 IOUtils.exec(pb);</span>
<span class="line-added">343             } catch (IOException ex) {</span>
<span class="line-added">344                 Log.verbose(ex);</span>
<span class="line-added">345             }</span>
<span class="line-added">346 </span>
<span class="line-added">347             // volume icon</span>
<span class="line-added">348             File volumeIconFile = new File(mountedRoot, &quot;.VolumeIcon.icns&quot;);</span>
<span class="line-added">349             IOUtils.copyFile(getConfig_VolumeIcon(params),</span>
<span class="line-added">350                     volumeIconFile);</span>
<span class="line-added">351 </span>
352             // Indicate that we want a custom icon
353             // NB: attributes of the root directory are ignored
354             // when creating the volume
355             // Therefore we have to do this after we mount image
356             String setFileUtility = findSetFileUtility();
357             if (setFileUtility != null) {
358                 //can not find utility =&gt; keep going without icon
359                 try {
360                     volumeIconFile.setWritable(true);
361                     // The &quot;creator&quot; attribute on a file is a legacy attribute
362                     // but it seems Finder excepts these bytes to be
363                     // &quot;icnC&quot; for the volume icon
364                     // (might not work on Mac 10.13 with old XCode)
365                     pb = new ProcessBuilder(
366                             setFileUtility,
367                             &quot;-c&quot;, &quot;icnC&quot;,
368                             volumeIconFile.getAbsolutePath());
369                     IOUtils.exec(pb);
370                     volumeIconFile.setReadOnly();
371 
372                     pb = new ProcessBuilder(
373                             setFileUtility,
374                             &quot;-a&quot;, &quot;C&quot;,
375                             mountedRoot.getAbsolutePath());
376                     IOUtils.exec(pb);
377                 } catch (IOException ex) {
378                     Log.error(ex.getMessage());
379                     Log.verbose(&quot;Cannot enable custom icon using SetFile utility&quot;);
380                 }
381             } else {
382                 Log.verbose(I18N.getString(&quot;message.setfile.dmg&quot;));
383             }
384 










385         } finally {
386             // Detach the temporary image
387             pb = new ProcessBuilder(
388                     hdiutil,
389                     &quot;detach&quot;,
390                     &quot;-force&quot;,
391                     hdiUtilVerbosityFlag,
392                     mountedRoot.getAbsolutePath());
393             IOUtils.exec(pb);
394         }
395 
396         // Compress it to a new image
397         pb = new ProcessBuilder(
398                 hdiutil,
399                 &quot;convert&quot;,
400                 protoDMG.getAbsolutePath(),
401                 hdiUtilVerbosityFlag,
402                 &quot;-format&quot;, &quot;UDZO&quot;,
403                 &quot;-o&quot;, finalDMG.getAbsolutePath());
404         IOUtils.exec(pb);
</pre>
<hr />
<pre>
492     public final static String[] required =
493             {&quot;/usr/bin/hdiutil&quot;, &quot;/usr/bin/osascript&quot;};
494     public static boolean isSupported() {
495         try {
496             for (String s : required) {
497                 File f = new File(s);
498                 if (!f.exists() || !f.canExecute()) {
499                     return false;
500                 }
501             }
502             return true;
503         } catch (Exception e) {
504             return false;
505         }
506     }
507 
508     @Override
509     public boolean isDefault() {
510         return true;
511     }

512 }
</pre>
</td>
</tr>
</table>
<center><a href="MacBaseInstallerBundler.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="MacPkgBundler.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>