<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff src/jdk.incubator.jpackage/macosx/classes/jdk/incubator/jpackage/internal/MacDmgBundler.java</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="MacBaseInstallerBundler.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="MacPkgBundler.java.udiff.html" target="_top">next &gt;</a></center>    <h2>src/jdk.incubator.jpackage/macosx/classes/jdk/incubator/jpackage/internal/MacDmgBundler.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -66,22 +66,22 @@</span>
          IOUtils.writableOutputDir(outdir.toPath());
  
          File appImageDir = APP_IMAGE_TEMP_ROOT.fetchFrom(params);
          try {
              appImageDir.mkdirs();
<span class="udiff-line-added">+             File appLocation = prepareAppBundle(params);</span>
  
<span class="udiff-line-modified-removed">-             if (prepareAppBundle(params) != null &amp;&amp;</span>
<span class="udiff-line-removed">-                     prepareConfigFiles(params)) {</span>
<span class="udiff-line-modified-added">+             if (appLocation != null &amp;&amp; prepareConfigFiles(params)) {</span>
                  File configScript = getConfig_Script(params);
                  if (configScript.exists()) {
                      Log.verbose(MessageFormat.format(
                              I18N.getString(&quot;message.running-script&quot;),
                              configScript.getAbsolutePath()));
                      IOUtils.run(&quot;bash&quot;, configScript);
                  }
  
<span class="udiff-line-modified-removed">-                 return buildDMG(params, outdir);</span>
<span class="udiff-line-modified-added">+                 return buildDMG(params, appLocation, outdir);</span>
              }
              return null;
          } catch (IOException ex) {
              Log.verbose(ex);
              throw new PackagerException(ex);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -115,12 +115,11 @@</span>
          data.put(&quot;DEPLOY_VOLUME_URL&quot;, volumeUrl);
          data.put(&quot;DEPLOY_BG_FILE&quot;, bgFile.toString());
          data.put(&quot;DEPLOY_VOLUME_PATH&quot;, volumePath.toString());
          data.put(&quot;DEPLOY_APPLICATION_NAME&quot;, APP_NAME.fetchFrom(params));
  
<span class="udiff-line-modified-removed">-         data.put(&quot;DEPLOY_INSTALL_LOCATION&quot;, MAC_INSTALL_DIR.fetchFrom(params));</span>
<span class="udiff-line-removed">-         data.put(&quot;DEPLOY_INSTALL_NAME&quot;, MAC_INSTALL_DIR.fetchFrom(params));</span>
<span class="udiff-line-modified-added">+         data.put(&quot;DEPLOY_INSTALL_LOCATION&quot;, getInstallDir(params));</span>
  
          createResource(DEFAULT_DMG_SETUP_SCRIPT, params)
                  .setCategory(I18N.getString(&quot;resource.dmg-setup-script&quot;))
                  .setSubstitutionData(data)
                  .saveToFile(dmgSetup);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -251,13 +250,12 @@</span>
          } catch (IOException ignored) {}
  
          return null;
      }
  
<span class="udiff-line-modified-removed">-     private File buildDMG(</span>
<span class="udiff-line-modified-removed">-             Map&lt;String, ? super Object&gt; params, File outdir)</span>
<span class="udiff-line-removed">-             throws IOException {</span>
<span class="udiff-line-modified-added">+     private File buildDMG( Map&lt;String, ? super Object&gt; params,</span>
<span class="udiff-line-modified-added">+             File appLocation, File outdir) throws IOException {</span>
          File imagesRoot = IMAGES_ROOT.fetchFrom(params);
          if (!imagesRoot.exists()) imagesRoot.mkdirs();
  
          File protoDMG = new File(imagesRoot,
                  APP_NAME.fetchFrom(params) +&quot;-tmp.dmg&quot;);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -267,10 +265,28 @@</span>
          File srcFolder = APP_IMAGE_TEMP_ROOT.fetchFrom(params);
          File predefinedImage =
                  StandardBundlerParam.getPredefinedAppImage(params);
          if (predefinedImage != null) {
              srcFolder = predefinedImage;
<span class="udiff-line-added">+         } else if (StandardBundlerParam.isRuntimeInstaller(params)) {</span>
<span class="udiff-line-added">+             Path newRoot = Files.createTempDirectory(</span>
<span class="udiff-line-added">+                 TEMP_ROOT.fetchFrom(params).toPath(), &quot;root-&quot;);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             // first, is this already a runtime with</span>
<span class="udiff-line-added">+             // &lt;runtime&gt;/Contents/Home - if so we need the Home dir</span>
<span class="udiff-line-added">+             Path original = appLocation.toPath();</span>
<span class="udiff-line-added">+             Path home = original.resolve(&quot;Contents/Home&quot;);</span>
<span class="udiff-line-added">+             Path source = (Files.exists(home)) ? home : original;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             // Then we need to put back the &lt;NAME&gt;/Content/Home</span>
<span class="udiff-line-added">+             Path root = newRoot.resolve(</span>
<span class="udiff-line-added">+                     MAC_CF_BUNDLE_IDENTIFIER.fetchFrom(params));</span>
<span class="udiff-line-added">+             Path dest = root.resolve(&quot;Contents/Home&quot;);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             IOUtils.copyRecursive(source, dest);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             srcFolder = newRoot.toFile();</span>
          }
  
          Log.verbose(MessageFormat.format(I18N.getString(
                  &quot;message.creating-dmg-file&quot;), finalDMG.getAbsolutePath()));
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -308,23 +324,33 @@</span>
                  &quot;-mountroot&quot;, imagesRoot.getAbsolutePath());
          IOUtils.exec(pb, false, null, true);
  
          File mountedRoot = new File(imagesRoot.getAbsolutePath(),
                      APP_NAME.fetchFrom(params));
<span class="udiff-line-removed">- </span>
          try {
<span class="udiff-line-removed">-             // volume icon</span>
<span class="udiff-line-removed">-             File volumeIconFile = new File(mountedRoot, &quot;.VolumeIcon.icns&quot;);</span>
<span class="udiff-line-removed">-             IOUtils.copyFile(getConfig_VolumeIcon(params),</span>
<span class="udiff-line-removed">-                     volumeIconFile);</span>
<span class="udiff-line-removed">- </span>
              // background image
              File bgdir = new File(mountedRoot, BACKGROUND_IMAGE_FOLDER);
              bgdir.mkdirs();
              IOUtils.copyFile(getConfig_VolumeBackground(params),
                      new File(bgdir, BACKGROUND_IMAGE));
  
<span class="udiff-line-added">+             // We will not consider setting background image and creating link</span>
<span class="udiff-line-added">+             // to install-dir in DMG as critical error, since it can fail in</span>
<span class="udiff-line-added">+             // headless enviroment.</span>
<span class="udiff-line-added">+             try {</span>
<span class="udiff-line-added">+                 pb = new ProcessBuilder(&quot;osascript&quot;,</span>
<span class="udiff-line-added">+                         getConfig_VolumeScript(params).getAbsolutePath());</span>
<span class="udiff-line-added">+                 IOUtils.exec(pb);</span>
<span class="udiff-line-added">+             } catch (IOException ex) {</span>
<span class="udiff-line-added">+                 Log.verbose(ex);</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             // volume icon</span>
<span class="udiff-line-added">+             File volumeIconFile = new File(mountedRoot, &quot;.VolumeIcon.icns&quot;);</span>
<span class="udiff-line-added">+             IOUtils.copyFile(getConfig_VolumeIcon(params),</span>
<span class="udiff-line-added">+                     volumeIconFile);</span>
<span class="udiff-line-added">+ </span>
              // Indicate that we want a custom icon
              // NB: attributes of the root directory are ignored
              // when creating the volume
              // Therefore we have to do this after we mount image
              String setFileUtility = findSetFileUtility();
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -354,20 +380,10 @@</span>
                  }
              } else {
                  Log.verbose(I18N.getString(&quot;message.setfile.dmg&quot;));
              }
  
<span class="udiff-line-removed">-             // We will not consider setting background image and creating link to</span>
<span class="udiff-line-removed">-             // /Application folder in DMG as critical error, since it can fail in</span>
<span class="udiff-line-removed">-             // headless enviroment.</span>
<span class="udiff-line-removed">-             try {</span>
<span class="udiff-line-removed">-                 pb = new ProcessBuilder(&quot;osascript&quot;,</span>
<span class="udiff-line-removed">-                         getConfig_VolumeScript(params).getAbsolutePath());</span>
<span class="udiff-line-removed">-                 IOUtils.exec(pb);</span>
<span class="udiff-line-removed">-             } catch (IOException ex) {</span>
<span class="udiff-line-removed">-                 Log.verbose(ex);</span>
<span class="udiff-line-removed">-             }</span>
          } finally {
              // Detach the temporary image
              pb = new ProcessBuilder(
                      hdiutil,
                      &quot;detach&quot;,
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -491,7 +507,6 @@</span>
  
      @Override
      public boolean isDefault() {
          return true;
      }
<span class="udiff-line-removed">- </span>
  }
</pre>
<center><a href="MacBaseInstallerBundler.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="MacPkgBundler.java.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>