<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff src/jdk.compiler/share/classes/com/sun/tools/javac/comp/Attr.java</title>
    <link rel="stylesheet" href="../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="../code/Symbol.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="Check.java.cdiff.html" target="_top">next &gt;</a></center>    <h2>src/jdk.compiler/share/classes/com/sun/tools/javac/comp/Attr.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 288,20 ***</span>
       */
      boolean isAssignableAsBlankFinal(VarSymbol v, Env&lt;AttrContext&gt; env) {
          Symbol owner = env.info.scope.owner;
             // owner refers to the innermost variable, method or
             // initializer block declaration at this point.
<span class="line-modified">!         return</span>
              v.owner == owner
              ||
              ((owner.name == names.init ||    // i.e. we are in a constructor
                owner.kind == VAR ||           // i.e. we are in a variable initializer
                (owner.flags() &amp; BLOCK) != 0)  // i.e. we are in an initializer block
               &amp;&amp;
               v.owner == owner.owner
               &amp;&amp;
               ((v.flags() &amp; STATIC) != 0) == Resolve.isStatic(env));
      }
  
      /** Check that variable can be assigned to.
       *  @param pos    The current source code position.
       *  @param v      The assigned variable
<span class="line-new-header">--- 288,22 ---</span>
       */
      boolean isAssignableAsBlankFinal(VarSymbol v, Env&lt;AttrContext&gt; env) {
          Symbol owner = env.info.scope.owner;
             // owner refers to the innermost variable, method or
             // initializer block declaration at this point.
<span class="line-modified">!         boolean isAssignable =</span>
              v.owner == owner
              ||
              ((owner.name == names.init ||    // i.e. we are in a constructor
                owner.kind == VAR ||           // i.e. we are in a variable initializer
                (owner.flags() &amp; BLOCK) != 0)  // i.e. we are in an initializer block
               &amp;&amp;
               v.owner == owner.owner
               &amp;&amp;
               ((v.flags() &amp; STATIC) != 0) == Resolve.isStatic(env));
<span class="line-added">+         boolean insideCompactConstructor = env.enclMethod != null &amp;&amp; TreeInfo.isCompactConstructor(env.enclMethod);</span>
<span class="line-added">+         return isAssignable &amp; !insideCompactConstructor;</span>
      }
  
      /** Check that variable can be assigned to.
       *  @param pos    The current source code position.
       *  @param v      The assigned variable
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1105,39 ***</span>
                              log.error(tree, Errors.FirstStatementMustBeCallToAnotherConstructor);
                          }
                      } else {
                          // but if it is the canonical:
  
<span class="line-modified">!                         // if user generated, then it shouldn&#39;t explicitly invoke any other constructor</span>
                          if ((tree.sym.flags_field &amp; GENERATEDCONSTR) == 0) {
                              JCMethodInvocation app = TreeInfo.firstConstructorCall(tree);
                              if (app != null &amp;&amp;
                                      (TreeInfo.name(app.meth) == names._this ||
                                              TreeInfo.name(app.meth) == names._super) &amp;&amp;
                                      checkFirstConstructorStat(app, tree, false)) {
                                  log.error(tree, Errors.InvalidCanonicalConstructorInRecord(
<span class="line-modified">!                                         Fragments.Canonical, tree.sym.name,</span>
                                          Fragments.CanonicalMustNotContainExplicitConstructorInvocation));
                              }
                          }
  
                          // also we want to check that no type variables have been defined
                          if (!tree.typarams.isEmpty()) {
                              log.error(tree, Errors.InvalidCanonicalConstructorInRecord(
<span class="line-modified">!                                     Fragments.Canonical, tree.sym.name, Fragments.CanonicalMustNotDeclareTypeVariables));</span>
                          }
  
                          /* and now we need to check that the constructor&#39;s arguments are exactly the same as those of the
                           * record components
                           */
<span class="line-modified">!                         List&lt;Type&gt; recordComponentTypes = TreeInfo.recordFields(env.enclClass).map(vd -&gt; vd.sym.type);</span>
                          for (JCVariableDecl param: tree.params) {
<span class="line-modified">!                             if (!types.isSameType(param.type, recordComponentTypes.head)) {</span>
                                  log.error(param, Errors.InvalidCanonicalConstructorInRecord(
<span class="line-modified">!                                         Fragments.Canonical, tree.sym.name, Fragments.TypeMustBeIdenticalToCorrespondingRecordComponentType));</span>
                              }
<span class="line-modified">!                             recordComponentTypes = recordComponentTypes.tail;</span>
                          }
                      }
                  }
              }
  
<span class="line-new-header">--- 1107,63 ---</span>
                              log.error(tree, Errors.FirstStatementMustBeCallToAnotherConstructor);
                          }
                      } else {
                          // but if it is the canonical:
  
<span class="line-modified">!                         /* if user generated, then it shouldn&#39;t:</span>
<span class="line-added">+                          *     - have an accessibility stricter than that of the record type</span>
<span class="line-added">+                          *     - explicitly invoke any other constructor</span>
<span class="line-added">+                          */</span>
                          if ((tree.sym.flags_field &amp; GENERATEDCONSTR) == 0) {
<span class="line-added">+                             if (Check.protection(m.flags()) &gt; Check.protection(env.enclClass.sym.flags())) {</span>
<span class="line-added">+                                 log.error(tree,</span>
<span class="line-added">+                                         (env.enclClass.sym.flags() &amp; AccessFlags) == 0 ?</span>
<span class="line-added">+                                             Errors.InvalidCanonicalConstructorInRecord(</span>
<span class="line-added">+                                                 Fragments.Canonical,</span>
<span class="line-added">+                                                 env.enclClass.sym.name,</span>
<span class="line-added">+                                                 Fragments.CanonicalMustNotHaveStrongerAccess(&quot;package&quot;)</span>
<span class="line-added">+                                             ) :</span>
<span class="line-added">+                                             Errors.InvalidCanonicalConstructorInRecord(</span>
<span class="line-added">+                                                     Fragments.Canonical,</span>
<span class="line-added">+                                                     env.enclClass.sym.name,</span>
<span class="line-added">+                                                     Fragments.CanonicalMustNotHaveStrongerAccess(asFlagSet(env.enclClass.sym.flags() &amp; AccessFlags))</span>
<span class="line-added">+                                             )</span>
<span class="line-added">+                                 );</span>
<span class="line-added">+                             }</span>
<span class="line-added">+ </span>
                              JCMethodInvocation app = TreeInfo.firstConstructorCall(tree);
                              if (app != null &amp;&amp;
                                      (TreeInfo.name(app.meth) == names._this ||
                                              TreeInfo.name(app.meth) == names._super) &amp;&amp;
                                      checkFirstConstructorStat(app, tree, false)) {
                                  log.error(tree, Errors.InvalidCanonicalConstructorInRecord(
<span class="line-modified">!                                         Fragments.Canonical, env.enclClass.sym.name,</span>
                                          Fragments.CanonicalMustNotContainExplicitConstructorInvocation));
                              }
                          }
  
                          // also we want to check that no type variables have been defined
                          if (!tree.typarams.isEmpty()) {
                              log.error(tree, Errors.InvalidCanonicalConstructorInRecord(
<span class="line-modified">!                                     Fragments.Canonical, env.enclClass.sym.name, Fragments.CanonicalMustNotDeclareTypeVariables));</span>
                          }
  
                          /* and now we need to check that the constructor&#39;s arguments are exactly the same as those of the
                           * record components
                           */
<span class="line-modified">!                         List&lt;? extends RecordComponent&gt; recordComponents = env.enclClass.sym.getRecordComponents();</span>
<span class="line-added">+                         List&lt;Type&gt; recordFieldTypes = TreeInfo.recordFields(env.enclClass).map(vd -&gt; vd.sym.type);</span>
                          for (JCVariableDecl param: tree.params) {
<span class="line-modified">!                             boolean paramIsVarArgs = (param.sym.flags_field &amp; VARARGS) != 0;</span>
<span class="line-added">+                             if (!types.isSameType(param.type, recordFieldTypes.head) ||</span>
<span class="line-added">+                                     (recordComponents.head.isVarargs() != paramIsVarArgs)) {</span>
                                  log.error(param, Errors.InvalidCanonicalConstructorInRecord(
<span class="line-modified">!                                         Fragments.Canonical, env.enclClass.sym.name,</span>
<span class="line-added">+                                         Fragments.TypeMustBeIdenticalToCorrespondingRecordComponentType));</span>
                              }
<span class="line-modified">!                             recordComponents = recordComponents.tail;</span>
<span class="line-added">+                             recordFieldTypes = recordFieldTypes.tail;</span>
                          }
                      }
                  }
              }
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1207,15 ***</span>
                          List&lt;Name&gt; initParamNames = tree.sym.params.map(p -&gt; p.name);
                          if (!initParamNames.equals(recordComponentNames)) {
                              log.error(tree, Errors.InvalidCanonicalConstructorInRecord(
                                      Fragments.Canonical, env.enclClass.sym.name, Fragments.CanonicalWithNameMismatch));
                          }
<span class="line-removed">-                         if (!tree.sym.isPublic()) {</span>
<span class="line-removed">-                             log.error(tree, Errors.InvalidCanonicalConstructorInRecord(</span>
<span class="line-removed">-                                     TreeInfo.isCompactConstructor(tree) ? Fragments.Compact : Fragments.Canonical,</span>
<span class="line-removed">-                                     env.enclClass.sym.name, Fragments.CanonicalConstructorMustBePublic));</span>
<span class="line-removed">-                         }</span>
                          if (tree.sym.type.asMethodType().thrown != null &amp;&amp; !tree.sym.type.asMethodType().thrown.isEmpty()) {
                              log.error(tree,
                                      Errors.InvalidCanonicalConstructorInRecord(
                                              TreeInfo.isCompactConstructor(tree) ? Fragments.Compact : Fragments.Canonical,
                                              env.enclClass.sym.name,
<span class="line-new-header">--- 1233,10 ---</span>
</pre>
<center><a href="../code/Symbol.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="Check.java.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>