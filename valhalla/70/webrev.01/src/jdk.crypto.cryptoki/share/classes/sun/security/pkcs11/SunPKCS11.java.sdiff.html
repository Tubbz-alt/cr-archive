<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/jdk.crypto.cryptoki/share/classes/sun/security/pkcs11/SunPKCS11.java</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
  </head>
<body>
<center><a href="../../../../../../jdk.compiler/share/classes/com/sun/tools/sjavac/options/OptionHelper.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="../../../../../../jdk.crypto.ec/share/classes/sun/security/ec/SunEC.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/jdk.crypto.cryptoki/share/classes/sun/security/pkcs11/SunPKCS11.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
   1 /*
<span class="line-modified">   2  * Copyright (c) 2003, 2019, Oracle and/or its affiliates. All rights reserved.</span>
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.  Oracle designates this
   8  * particular file as subject to the &quot;Classpath&quot; exception as provided
   9  * by Oracle in the LICENSE file that accompanied this code.
  10  *
  11  * This code is distributed in the hope that it will be useful, but WITHOUT
  12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  14  * version 2 for more details (a copy is included in the LICENSE file that
  15  * accompanied this code).
  16  *
  17  * You should have received a copy of the GNU General Public License version
  18  * 2 along with this work; if not, write to the Free Software Foundation,
  19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  20  *
  21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  22  * or visit www.oracle.com if you need additional information or have any
</pre>
<hr />
<pre>
  28 import java.io.*;
  29 import java.util.*;
  30 
  31 import java.security.*;
  32 import java.security.interfaces.*;
  33 
  34 import javax.crypto.interfaces.*;
  35 
  36 import javax.security.auth.Subject;
  37 import javax.security.auth.login.LoginException;
  38 import javax.security.auth.login.FailedLoginException;
  39 import javax.security.auth.callback.Callback;
  40 import javax.security.auth.callback.CallbackHandler;
  41 import javax.security.auth.callback.ConfirmationCallback;
  42 import javax.security.auth.callback.PasswordCallback;
  43 import javax.security.auth.callback.TextOutputCallback;
  44 
  45 import sun.security.util.Debug;
  46 import sun.security.util.ResourcesMgr;
  47 import static sun.security.util.SecurityConstants.PROVIDER_VER;

  48 
  49 import sun.security.pkcs11.Secmod.*;
  50 
  51 import sun.security.pkcs11.wrapper.*;
  52 import static sun.security.pkcs11.wrapper.PKCS11Constants.*;
  53 
  54 /**
  55  * PKCS#11 provider main class.
  56  *
  57  * @author  Andreas Sterbenz
  58  * @since   1.5
  59  */
  60 public final class SunPKCS11 extends AuthProvider {
  61 
  62     private static final long serialVersionUID = -1354835039035306505L;
  63 
  64     static final Debug debug = Debug.getInstance(&quot;sunpkcs11&quot;);
  65     // the PKCS11 object through which we make the native calls
  66     final PKCS11 p11;
  67 
</pre>
<hr />
<pre>
 388         if (longs.length == 0) {
 389             return &quot;(none)&quot;;
 390         }
 391         StringBuilder sb = new StringBuilder();
 392         sb.append(longs[0]);
 393         for (int i = 1; i &lt; longs.length; i++) {
 394             sb.append(&quot;, &quot;);
 395             sb.append(longs[i]);
 396         }
 397         return sb.toString();
 398     }
 399 
 400     public boolean equals(Object obj) {
 401         return this == obj;
 402     }
 403 
 404     public int hashCode() {
 405         return System.identityHashCode(this);
 406     }
 407 
<span class="line-removed"> 408     private static String[] s(String ...aliases) {</span>
<span class="line-removed"> 409         return aliases;</span>
<span class="line-removed"> 410     }</span>
<span class="line-removed"> 411 </span>
 412     private static final class Descriptor {
 413         final String type;
 414         final String algorithm;
 415         final String className;
<span class="line-modified"> 416         final String[] aliases;</span>
 417         final int[] mechanisms;
 418 
 419         private Descriptor(String type, String algorithm, String className,
<span class="line-modified"> 420                 String[] aliases, int[] mechanisms) {</span>
 421             this.type = type;
 422             this.algorithm = algorithm;
 423             this.className = className;
 424             this.aliases = aliases;
 425             this.mechanisms = mechanisms;
 426         }
 427         private P11Service service(Token token, int mechanism) {
 428             return new P11Service
 429                 (token, type, algorithm, className, aliases, mechanism);
 430         }
 431         public String toString() {
 432             return type + &quot;.&quot; + algorithm;
 433         }
 434     }
 435 
 436     // Map from mechanism to List of Descriptors that should be
 437     // registered if the mechanism is supported
 438     private final static Map&lt;Integer,List&lt;Descriptor&gt;&gt; descriptors =
 439         new HashMap&lt;Integer,List&lt;Descriptor&gt;&gt;();
 440 
</pre>
<hr />
<pre>
 443     }
 444 
 445     private static int[] m(long m1, long m2) {
 446         return new int[] {(int)m1, (int)m2};
 447     }
 448 
 449     private static int[] m(long m1, long m2, long m3) {
 450         return new int[] {(int)m1, (int)m2, (int)m3};
 451     }
 452 
 453     private static int[] m(long m1, long m2, long m3, long m4) {
 454         return new int[] {(int)m1, (int)m2, (int)m3, (int)m4};
 455     }
 456 
 457     private static void d(String type, String algorithm, String className,
 458             int[] m) {
 459         register(new Descriptor(type, algorithm, className, null, m));
 460     }
 461 
 462     private static void d(String type, String algorithm, String className,
<span class="line-modified"> 463             String[] aliases, int[] m) {</span>
 464         register(new Descriptor(type, algorithm, className, aliases, m));
 465     }
 466 






 467     private static void register(Descriptor d) {
 468         for (int i = 0; i &lt; d.mechanisms.length; i++) {
 469             int m = d.mechanisms[i];
 470             Integer key = Integer.valueOf(m);
 471             List&lt;Descriptor&gt; list = descriptors.get(key);
 472             if (list == null) {
 473                 list = new ArrayList&lt;Descriptor&gt;();
 474                 descriptors.put(key, list);
 475             }
 476             list.add(d);
 477         }
 478     }
 479 
 480     private final static String MD  = &quot;MessageDigest&quot;;
 481 
 482     private final static String SIG = &quot;Signature&quot;;
 483 
 484     private final static String KPG = &quot;KeyPairGenerator&quot;;
 485 
 486     private final static String KG  = &quot;KeyGenerator&quot;;
</pre>
<hr />
<pre>
 508         String P11MAC              = &quot;sun.security.pkcs11.P11MAC&quot;;
 509         String P11KeyPairGenerator = &quot;sun.security.pkcs11.P11KeyPairGenerator&quot;;
 510         String P11KeyGenerator     = &quot;sun.security.pkcs11.P11KeyGenerator&quot;;
 511         String P11RSAKeyFactory    = &quot;sun.security.pkcs11.P11RSAKeyFactory&quot;;
 512         String P11DSAKeyFactory    = &quot;sun.security.pkcs11.P11DSAKeyFactory&quot;;
 513         String P11DHKeyFactory     = &quot;sun.security.pkcs11.P11DHKeyFactory&quot;;
 514         String P11KeyAgreement     = &quot;sun.security.pkcs11.P11KeyAgreement&quot;;
 515         String P11SecretKeyFactory = &quot;sun.security.pkcs11.P11SecretKeyFactory&quot;;
 516         String P11Cipher           = &quot;sun.security.pkcs11.P11Cipher&quot;;
 517         String P11RSACipher        = &quot;sun.security.pkcs11.P11RSACipher&quot;;
 518         String P11AEADCipher       = &quot;sun.security.pkcs11.P11AEADCipher&quot;;
 519         String P11Signature        = &quot;sun.security.pkcs11.P11Signature&quot;;
 520         String P11PSSSignature     = &quot;sun.security.pkcs11.P11PSSSignature&quot;;
 521 
 522         // XXX register all aliases
 523 
 524         d(MD, &quot;MD2&quot;,            P11Digest,
 525                 m(CKM_MD2));
 526         d(MD, &quot;MD5&quot;,            P11Digest,
 527                 m(CKM_MD5));
<span class="line-modified"> 528         d(MD, &quot;SHA1&quot;,           P11Digest,</span>
<span class="line-removed"> 529                 s(&quot;SHA&quot;, &quot;SHA-1&quot;, &quot;1.3.14.3.2.26&quot;, &quot;OID.1.3.14.3.2.26&quot;),</span>
 530                 m(CKM_SHA_1));
 531 
<span class="line-modified"> 532         d(MD, &quot;SHA-224&quot;,        P11Digest,</span>
<span class="line-removed"> 533                 s(&quot;2.16.840.1.101.3.4.2.4&quot;, &quot;OID.2.16.840.1.101.3.4.2.4&quot;),</span>
 534                 m(CKM_SHA224));
<span class="line-modified"> 535         d(MD, &quot;SHA-256&quot;,        P11Digest,</span>
<span class="line-removed"> 536                 s(&quot;2.16.840.1.101.3.4.2.1&quot;, &quot;OID.2.16.840.1.101.3.4.2.1&quot;),</span>
 537                 m(CKM_SHA256));
<span class="line-modified"> 538         d(MD, &quot;SHA-384&quot;,        P11Digest,</span>
<span class="line-removed"> 539                 s(&quot;2.16.840.1.101.3.4.2.2&quot;, &quot;OID.2.16.840.1.101.3.4.2.2&quot;),</span>
 540                 m(CKM_SHA384));
<span class="line-modified"> 541         d(MD, &quot;SHA-512&quot;,        P11Digest,</span>
<span class="line-removed"> 542                 s(&quot;2.16.840.1.101.3.4.2.3&quot;, &quot;OID.2.16.840.1.101.3.4.2.3&quot;),</span>
 543                 m(CKM_SHA512));
<span class="line-modified"> 544         d(MD, &quot;SHA-512/224&quot;,        P11Digest,</span>
<span class="line-removed"> 545                 s(&quot;2.16.840.1.101.3.4.2.5&quot;, &quot;OID.2.16.840.1.101.3.4.2.5&quot;),</span>
 546                 m(CKM_SHA512_224));
<span class="line-modified"> 547         d(MD, &quot;SHA-512/256&quot;,        P11Digest,</span>
<span class="line-removed"> 548                 s(&quot;2.16.840.1.101.3.4.2.6&quot;, &quot;OID.2.16.840.1.101.3.4.2.6&quot;),</span>
 549                 m(CKM_SHA512_256));
 550 
 551         d(MAC, &quot;HmacMD5&quot;,       P11MAC,
 552                 m(CKM_MD5_HMAC));
<span class="line-modified"> 553         d(MAC, &quot;HmacSHA1&quot;,      P11MAC,</span>
<span class="line-removed"> 554                 s(&quot;1.2.840.113549.2.7&quot;, &quot;OID.1.2.840.113549.2.7&quot;),</span>
 555                 m(CKM_SHA_1_HMAC));
<span class="line-modified"> 556         d(MAC, &quot;HmacSHA224&quot;,    P11MAC,</span>
<span class="line-removed"> 557                 s(&quot;1.2.840.113549.2.8&quot;, &quot;OID.1.2.840.113549.2.8&quot;),</span>
 558                 m(CKM_SHA224_HMAC));
<span class="line-modified"> 559         d(MAC, &quot;HmacSHA256&quot;,    P11MAC,</span>
<span class="line-removed"> 560                 s(&quot;1.2.840.113549.2.9&quot;, &quot;OID.1.2.840.113549.2.9&quot;),</span>
 561                 m(CKM_SHA256_HMAC));
<span class="line-modified"> 562         d(MAC, &quot;HmacSHA384&quot;,    P11MAC,</span>
<span class="line-removed"> 563                 s(&quot;1.2.840.113549.2.10&quot;, &quot;OID.1.2.840.113549.2.10&quot;),</span>
 564                 m(CKM_SHA384_HMAC));
<span class="line-modified"> 565         d(MAC, &quot;HmacSHA512&quot;,    P11MAC,</span>
<span class="line-removed"> 566                 s(&quot;1.2.840.113549.2.11&quot;, &quot;OID.1.2.840.113549.2.11&quot;),</span>
 567                 m(CKM_SHA512_HMAC));
<span class="line-modified"> 568         d(MAC, &quot;HmacSHA512/224&quot;,    P11MAC,</span>
<span class="line-removed"> 569                 s(&quot;1.2.840.113549.2.12&quot;, &quot;OID.1.2.840.113549.2.12&quot;),</span>
 570                 m(CKM_SHA512_224_HMAC));
<span class="line-modified"> 571         d(MAC, &quot;HmacSHA512/256&quot;,    P11MAC,</span>
<span class="line-removed"> 572                 s(&quot;1.2.840.113549.2.13&quot;, &quot;OID.1.2.840.113549.2.13&quot;),</span>
 573                 m(CKM_SHA512_256_HMAC));
 574 
 575         d(MAC, &quot;SslMacMD5&quot;,     P11MAC,
 576                 m(CKM_SSL3_MD5_MAC));
 577         d(MAC, &quot;SslMacSHA1&quot;,    P11MAC,
 578                 m(CKM_SSL3_SHA1_MAC));
 579 
 580         d(KPG, &quot;RSA&quot;,           P11KeyPairGenerator,
<span class="line-modified"> 581                 s(&quot;1.2.840.113549.1.1&quot;, &quot;OID.1.2.840.113549.1.1&quot;),</span>
 582                 m(CKM_RSA_PKCS_KEY_PAIR_GEN));
 583 
<span class="line-modified"> 584         d(KPG, &quot;DSA&quot;,           P11KeyPairGenerator,</span>
<span class="line-modified"> 585                 s(&quot;1.3.14.3.2.12&quot;, &quot;1.2.840.10040.4.1&quot;, &quot;OID.1.2.840.10040.4.1&quot;),</span>

 586                 m(CKM_DSA_KEY_PAIR_GEN));
<span class="line-modified"> 587         d(KPG, &quot;DH&quot;,            P11KeyPairGenerator,    s(&quot;DiffieHellman&quot;),</span>

 588                 m(CKM_DH_PKCS_KEY_PAIR_GEN));
 589         d(KPG, &quot;EC&quot;,            P11KeyPairGenerator,
 590                 m(CKM_EC_KEY_PAIR_GEN));
 591 
<span class="line-modified"> 592         d(KG,  &quot;ARCFOUR&quot;,       P11KeyGenerator,        s(&quot;RC4&quot;),</span>
 593                 m(CKM_RC4_KEY_GEN));
 594         d(KG,  &quot;DES&quot;,           P11KeyGenerator,
 595                 m(CKM_DES_KEY_GEN));
 596         d(KG,  &quot;DESede&quot;,        P11KeyGenerator,
 597                 m(CKM_DES3_KEY_GEN, CKM_DES2_KEY_GEN));
 598         d(KG,  &quot;AES&quot;,           P11KeyGenerator,
 599                 m(CKM_AES_KEY_GEN));
 600         d(KG,  &quot;Blowfish&quot;,      P11KeyGenerator,
 601                 m(CKM_BLOWFISH_KEY_GEN));
 602 
 603         // register (Secret)KeyFactories if there are any mechanisms
 604         // for a particular algorithm that we support
 605         d(KF, &quot;RSA&quot;,            P11RSAKeyFactory,
<span class="line-modified"> 606                 s(&quot;1.2.840.113549.1.1&quot;, &quot;OID.1.2.840.113549.1.1&quot;),</span>
 607                 m(CKM_RSA_PKCS_KEY_PAIR_GEN, CKM_RSA_PKCS, CKM_RSA_X_509));
<span class="line-modified"> 608         d(KF, &quot;DSA&quot;,            P11DSAKeyFactory,</span>
<span class="line-removed"> 609                 s(&quot;1.3.14.3.2.12&quot;, &quot;1.2.840.10040.4.1&quot;, &quot;OID.1.2.840.10040.4.1&quot;),</span>
 610                 m(CKM_DSA_KEY_PAIR_GEN, CKM_DSA, CKM_DSA_SHA1));
<span class="line-modified"> 611         d(KF, &quot;DH&quot;,             P11DHKeyFactory,        s(&quot;DiffieHellman&quot;),</span>

 612                 m(CKM_DH_PKCS_KEY_PAIR_GEN, CKM_DH_PKCS_DERIVE));
 613         d(KF, &quot;EC&quot;,             P11DHKeyFactory,
 614                 m(CKM_EC_KEY_PAIR_GEN, CKM_ECDH1_DERIVE,
 615                     CKM_ECDSA, CKM_ECDSA_SHA1));
 616 
 617         // AlgorithmParameters for EC.
 618         // Only needed until we have an EC implementation in the SUN provider.
<span class="line-modified"> 619         d(AGP, &quot;EC&quot;,            &quot;sun.security.util.ECParameters&quot;,</span>
<span class="line-removed"> 620                 s(&quot;1.2.840.10045.2.1&quot;),</span>
 621                 m(CKM_EC_KEY_PAIR_GEN, CKM_ECDH1_DERIVE,
 622                     CKM_ECDSA, CKM_ECDSA_SHA1));
 623 
 624 
 625         d(AGP, &quot;GCM&quot;,            &quot;sun.security.util.GCMParameters&quot;,
 626                 m(CKM_AES_GCM));
 627 
<span class="line-modified"> 628         d(KA, &quot;DH&quot;,             P11KeyAgreement,        s(&quot;DiffieHellman&quot;),</span>

 629                 m(CKM_DH_PKCS_DERIVE));
 630         d(KA, &quot;ECDH&quot;,           &quot;sun.security.pkcs11.P11ECDHKeyAgreement&quot;,
 631                 m(CKM_ECDH1_DERIVE));
 632 
<span class="line-modified"> 633         d(SKF, &quot;ARCFOUR&quot;,       P11SecretKeyFactory,    s(&quot;RC4&quot;),</span>
 634                 m(CKM_RC4));
 635         d(SKF, &quot;DES&quot;,           P11SecretKeyFactory,
 636                 m(CKM_DES_CBC));
 637         d(SKF, &quot;DESede&quot;,        P11SecretKeyFactory,
 638                 m(CKM_DES3_CBC));
<span class="line-modified"> 639         d(SKF, &quot;AES&quot;,           P11SecretKeyFactory,</span>
<span class="line-removed"> 640                 s(&quot;2.16.840.1.101.3.4.1&quot;, &quot;OID.2.16.840.1.101.3.4.1&quot;),</span>
 641                 m(CKM_AES_CBC));
 642         d(SKF, &quot;Blowfish&quot;,      P11SecretKeyFactory,
 643                 m(CKM_BLOWFISH_CBC));
 644 
 645         // XXX attributes for Ciphers (supported modes, padding)
<span class="line-modified"> 646         d(CIP, &quot;ARCFOUR&quot;,                       P11Cipher,      s(&quot;RC4&quot;),</span>
 647                 m(CKM_RC4));
 648         d(CIP, &quot;DES/CBC/NoPadding&quot;,             P11Cipher,
 649                 m(CKM_DES_CBC));
 650         d(CIP, &quot;DES/CBC/PKCS5Padding&quot;,          P11Cipher,
 651                 m(CKM_DES_CBC_PAD, CKM_DES_CBC));
 652         d(CIP, &quot;DES/ECB/NoPadding&quot;,             P11Cipher,
 653                 m(CKM_DES_ECB));
<span class="line-modified"> 654         d(CIP, &quot;DES/ECB/PKCS5Padding&quot;,          P11Cipher,      s(&quot;DES&quot;),</span>

 655                 m(CKM_DES_ECB));
 656 
 657         d(CIP, &quot;DESede/CBC/NoPadding&quot;,          P11Cipher,
 658                 m(CKM_DES3_CBC));
 659         d(CIP, &quot;DESede/CBC/PKCS5Padding&quot;,       P11Cipher,
 660                 m(CKM_DES3_CBC_PAD, CKM_DES3_CBC));
 661         d(CIP, &quot;DESede/ECB/NoPadding&quot;,          P11Cipher,
 662                 m(CKM_DES3_ECB));
<span class="line-modified"> 663         d(CIP, &quot;DESede/ECB/PKCS5Padding&quot;,       P11Cipher,      s(&quot;DESede&quot;),</span>

 664                 m(CKM_DES3_ECB));
 665         d(CIP, &quot;AES/CBC/NoPadding&quot;,             P11Cipher,
 666                 m(CKM_AES_CBC));
<span class="line-modified"> 667         d(CIP, &quot;AES_128/CBC/NoPadding&quot;,          P11Cipher,</span>
<span class="line-removed"> 668                 s(&quot;2.16.840.1.101.3.4.1.2&quot;, &quot;OID.2.16.840.1.101.3.4.1.2&quot;),</span>
 669                 m(CKM_AES_CBC));
<span class="line-modified"> 670         d(CIP, &quot;AES_192/CBC/NoPadding&quot;,          P11Cipher,</span>
<span class="line-removed"> 671                 s(&quot;2.16.840.1.101.3.4.1.22&quot;, &quot;OID.2.16.840.1.101.3.4.1.22&quot;),</span>
 672                 m(CKM_AES_CBC));
<span class="line-modified"> 673         d(CIP, &quot;AES_256/CBC/NoPadding&quot;,          P11Cipher,</span>
<span class="line-removed"> 674                 s(&quot;2.16.840.1.101.3.4.1.42&quot;, &quot;OID.2.16.840.1.101.3.4.1.42&quot;),</span>
 675                 m(CKM_AES_CBC));
 676         d(CIP, &quot;AES/CBC/PKCS5Padding&quot;,          P11Cipher,
 677                 m(CKM_AES_CBC_PAD, CKM_AES_CBC));
 678         d(CIP, &quot;AES/ECB/NoPadding&quot;,             P11Cipher,
 679                 m(CKM_AES_ECB));
<span class="line-modified"> 680         d(CIP, &quot;AES_128/ECB/NoPadding&quot;,          P11Cipher,</span>
<span class="line-removed"> 681                 s(&quot;2.16.840.1.101.3.4.1.1&quot;, &quot;OID.2.16.840.1.101.3.4.1.1&quot;),</span>
 682                 m(CKM_AES_ECB));
<span class="line-modified"> 683         d(CIP, &quot;AES_192/ECB/NoPadding&quot;,          P11Cipher,</span>
<span class="line-removed"> 684                 s(&quot;2.16.840.1.101.3.4.1.21&quot;, &quot;OID.2.16.840.1.101.3.4.1.21&quot;),</span>
 685                 m(CKM_AES_ECB));
<span class="line-modified"> 686         d(CIP, &quot;AES_256/ECB/NoPadding&quot;,          P11Cipher,</span>
<span class="line-removed"> 687                 s(&quot;2.16.840.1.101.3.4.1.41&quot;, &quot;OID.2.16.840.1.101.3.4.1.41&quot;),</span>
 688                 m(CKM_AES_ECB));
<span class="line-modified"> 689         d(CIP, &quot;AES/ECB/PKCS5Padding&quot;,          P11Cipher,      s(&quot;AES&quot;),</span>

 690                 m(CKM_AES_ECB));
 691         d(CIP, &quot;AES/CTR/NoPadding&quot;,             P11Cipher,
 692                 m(CKM_AES_CTR));
 693 
 694         d(CIP, &quot;AES/GCM/NoPadding&quot;,             P11AEADCipher,
 695                 m(CKM_AES_GCM));
<span class="line-modified"> 696         d(CIP, &quot;AES_128/GCM/NoPadding&quot;,          P11AEADCipher,</span>
<span class="line-removed"> 697                 s(&quot;2.16.840.1.101.3.4.1.6&quot;, &quot;OID.2.16.840.1.101.3.4.1.6&quot;),</span>
 698                 m(CKM_AES_GCM));
<span class="line-modified"> 699         d(CIP, &quot;AES_192/GCM/NoPadding&quot;,          P11AEADCipher,</span>
<span class="line-removed"> 700                 s(&quot;2.16.840.1.101.3.4.1.26&quot;, &quot;OID.2.16.840.1.101.3.4.1.26&quot;),</span>
 701                 m(CKM_AES_GCM));
<span class="line-modified"> 702         d(CIP, &quot;AES_256/GCM/NoPadding&quot;,          P11AEADCipher,</span>
<span class="line-removed"> 703                 s(&quot;2.16.840.1.101.3.4.1.46&quot;, &quot;OID.2.16.840.1.101.3.4.1.46&quot;),</span>
 704                 m(CKM_AES_GCM));
 705 
 706         d(CIP, &quot;Blowfish/CBC/NoPadding&quot;,        P11Cipher,
 707                 m(CKM_BLOWFISH_CBC));
 708         d(CIP, &quot;Blowfish/CBC/PKCS5Padding&quot;,     P11Cipher,
 709                 m(CKM_BLOWFISH_CBC));
 710 
<span class="line-modified"> 711         d(CIP, &quot;RSA/ECB/PKCS1Padding&quot;,          P11RSACipher,   s(&quot;RSA&quot;),</span>

 712                 m(CKM_RSA_PKCS));
 713         d(CIP, &quot;RSA/ECB/NoPadding&quot;,             P11RSACipher,
 714                 m(CKM_RSA_X_509));
 715 
<span class="line-modified"> 716         d(SIG, &quot;RawDSA&quot;,        P11Signature,   s(&quot;NONEwithDSA&quot;),</span>

 717                 m(CKM_DSA));
<span class="line-modified"> 718         d(SIG, &quot;DSA&quot;,           P11Signature,</span>
<span class="line-removed"> 719                 s(&quot;SHA1withDSA&quot;, &quot;1.3.14.3.2.13&quot;, &quot;1.3.14.3.2.27&quot;,</span>
<span class="line-removed"> 720                   &quot;1.2.840.10040.4.3&quot;, &quot;OID.1.2.840.10040.4.3&quot;),</span>
 721                 m(CKM_DSA_SHA1, CKM_DSA));
<span class="line-modified"> 722         d(SIG, &quot;SHA224withDSA&quot;, P11Signature,</span>
<span class="line-removed"> 723                 s(&quot;2.16.840.1.101.3.4.3.1&quot;, &quot;OID.2.16.840.1.101.3.4.3.1&quot;),</span>
 724                 m(CKM_DSA_SHA224));
<span class="line-modified"> 725         d(SIG, &quot;SHA256withDSA&quot;, P11Signature,</span>
<span class="line-removed"> 726                 s(&quot;2.16.840.1.101.3.4.3.2&quot;, &quot;OID.2.16.840.1.101.3.4.3.2&quot;),</span>
 727                 m(CKM_DSA_SHA256));
<span class="line-modified"> 728         d(SIG, &quot;SHA384withDSA&quot;, P11Signature,</span>
<span class="line-removed"> 729                 s(&quot;2.16.840.1.101.3.4.3.3&quot;, &quot;OID.2.16.840.1.101.3.4.3.3&quot;),</span>
 730                 m(CKM_DSA_SHA384));
<span class="line-modified"> 731         d(SIG, &quot;SHA512withDSA&quot;, P11Signature,</span>
<span class="line-removed"> 732                 s(&quot;2.16.840.1.101.3.4.3.4&quot;, &quot;OID.2.16.840.1.101.3.4.3.4&quot;),</span>
 733                 m(CKM_DSA_SHA512));
 734         d(SIG, &quot;RawDSAinP1363Format&quot;,   P11Signature,
<span class="line-modified"> 735                 s(&quot;NONEwithDSAinP1363Format&quot;),</span>
 736                 m(CKM_DSA));
 737         d(SIG, &quot;DSAinP1363Format&quot;,      P11Signature,
<span class="line-modified"> 738                 s(&quot;SHA1withDSAinP1363Format&quot;),</span>
 739                 m(CKM_DSA_SHA1, CKM_DSA));
 740 
 741         d(SIG, &quot;NONEwithECDSA&quot;, P11Signature,
 742                 m(CKM_ECDSA));
<span class="line-modified"> 743         d(SIG, &quot;SHA1withECDSA&quot;, P11Signature,</span>
<span class="line-removed"> 744                 s(&quot;ECDSA&quot;, &quot;1.2.840.10045.4.1&quot;, &quot;OID.1.2.840.10045.4.1&quot;),</span>
 745                 m(CKM_ECDSA_SHA1, CKM_ECDSA));
<span class="line-modified"> 746         d(SIG, &quot;SHA224withECDSA&quot;,       P11Signature,</span>
<span class="line-removed"> 747                 s(&quot;1.2.840.10045.4.3.1&quot;, &quot;OID.1.2.840.10045.4.3.1&quot;),</span>
 748                 m(CKM_ECDSA));
<span class="line-modified"> 749         d(SIG, &quot;SHA256withECDSA&quot;,       P11Signature,</span>
<span class="line-removed"> 750                 s(&quot;1.2.840.10045.4.3.2&quot;, &quot;OID.1.2.840.10045.4.3.2&quot;),</span>
 751                 m(CKM_ECDSA));
<span class="line-modified"> 752         d(SIG, &quot;SHA384withECDSA&quot;,       P11Signature,</span>
<span class="line-removed"> 753                 s(&quot;1.2.840.10045.4.3.3&quot;, &quot;OID.1.2.840.10045.4.3.3&quot;),</span>
 754                 m(CKM_ECDSA));
<span class="line-modified"> 755         d(SIG, &quot;SHA512withECDSA&quot;,       P11Signature,</span>
<span class="line-removed"> 756                 s(&quot;1.2.840.10045.4.3.4&quot;, &quot;OID.1.2.840.10045.4.3.4&quot;),</span>
 757                 m(CKM_ECDSA));
 758         d(SIG, &quot;NONEwithECDSAinP1363Format&quot;,   P11Signature,
 759                 m(CKM_ECDSA));
 760         d(SIG, &quot;SHA1withECDSAinP1363Format&quot;,   P11Signature,
 761                 m(CKM_ECDSA_SHA1, CKM_ECDSA));
 762         d(SIG, &quot;SHA224withECDSAinP1363Format&quot;, P11Signature,
 763                 m(CKM_ECDSA));
 764         d(SIG, &quot;SHA256withECDSAinP1363Format&quot;, P11Signature,
 765                 m(CKM_ECDSA));
 766         d(SIG, &quot;SHA384withECDSAinP1363Format&quot;, P11Signature,
 767                 m(CKM_ECDSA));
 768         d(SIG, &quot;SHA512withECDSAinP1363Format&quot;, P11Signature,
 769                 m(CKM_ECDSA));
<span class="line-modified"> 770         d(SIG, &quot;MD2withRSA&quot;,    P11Signature,</span>
<span class="line-removed"> 771                 s(&quot;1.2.840.113549.1.1.2&quot;, &quot;OID.1.2.840.113549.1.1.2&quot;),</span>
 772                 m(CKM_MD2_RSA_PKCS, CKM_RSA_PKCS, CKM_RSA_X_509));
<span class="line-modified"> 773         d(SIG, &quot;MD5withRSA&quot;,    P11Signature,</span>
<span class="line-removed"> 774                 s(&quot;1.2.840.113549.1.1.4&quot;, &quot;OID.1.2.840.113549.1.1.4&quot;),</span>
 775                 m(CKM_MD5_RSA_PKCS, CKM_RSA_PKCS, CKM_RSA_X_509));
<span class="line-modified"> 776         d(SIG, &quot;SHA1withRSA&quot;,   P11Signature,</span>
<span class="line-removed"> 777                 s(&quot;1.2.840.113549.1.1.5&quot;, &quot;OID.1.2.840.113549.1.1.5&quot;,</span>
<span class="line-removed"> 778                   &quot;1.3.14.3.2.29&quot;),</span>
 779                 m(CKM_SHA1_RSA_PKCS, CKM_RSA_PKCS, CKM_RSA_X_509));
<span class="line-modified"> 780         d(SIG, &quot;SHA224withRSA&quot;, P11Signature,</span>
<span class="line-removed"> 781                 s(&quot;1.2.840.113549.1.1.14&quot;, &quot;OID.1.2.840.113549.1.1.14&quot;),</span>
 782                 m(CKM_SHA224_RSA_PKCS, CKM_RSA_PKCS, CKM_RSA_X_509));
<span class="line-modified"> 783         d(SIG, &quot;SHA256withRSA&quot;, P11Signature,</span>
<span class="line-removed"> 784                 s(&quot;1.2.840.113549.1.1.11&quot;, &quot;OID.1.2.840.113549.1.1.11&quot;),</span>
 785                 m(CKM_SHA256_RSA_PKCS, CKM_RSA_PKCS, CKM_RSA_X_509));
<span class="line-modified"> 786         d(SIG, &quot;SHA384withRSA&quot;, P11Signature,</span>
<span class="line-removed"> 787                 s(&quot;1.2.840.113549.1.1.12&quot;, &quot;OID.1.2.840.113549.1.1.12&quot;),</span>
 788                 m(CKM_SHA384_RSA_PKCS, CKM_RSA_PKCS, CKM_RSA_X_509));
<span class="line-modified"> 789         d(SIG, &quot;SHA512withRSA&quot;, P11Signature,</span>
<span class="line-removed"> 790                 s(&quot;1.2.840.113549.1.1.13&quot;, &quot;OID.1.2.840.113549.1.1.13&quot;),</span>
 791                 m(CKM_SHA512_RSA_PKCS, CKM_RSA_PKCS, CKM_RSA_X_509));
<span class="line-modified"> 792         d(SIG, &quot;RSASSA-PSS&quot;, P11PSSSignature,</span>
<span class="line-removed"> 793                 s(&quot;1.2.840.113549.1.1.10&quot;, &quot;OID.1.2.840.113549.1.1.10&quot;),</span>
 794                 m(CKM_RSA_PKCS_PSS));
 795         d(SIG, &quot;SHA1withRSASSA-PSS&quot;, P11PSSSignature,
 796                 m(CKM_SHA1_RSA_PKCS_PSS));
 797         d(SIG, &quot;SHA224withRSASSA-PSS&quot;, P11PSSSignature,
 798                 m(CKM_SHA224_RSA_PKCS_PSS));
 799         d(SIG, &quot;SHA256withRSASSA-PSS&quot;, P11PSSSignature,
 800                 m(CKM_SHA256_RSA_PKCS_PSS));
 801         d(SIG, &quot;SHA384withRSASSA-PSS&quot;, P11PSSSignature,
 802                 m(CKM_SHA384_RSA_PKCS_PSS));
 803         d(SIG, &quot;SHA512withRSASSA-PSS&quot;, P11PSSSignature,
 804                 m(CKM_SHA512_RSA_PKCS_PSS));
 805 
 806         d(KG, &quot;SunTlsRsaPremasterSecret&quot;,
 807                     &quot;sun.security.pkcs11.P11TlsRsaPremasterSecretGenerator&quot;,
<span class="line-modified"> 808                     s(&quot;SunTls12RsaPremasterSecret&quot;),</span>
 809                 m(CKM_SSL3_PRE_MASTER_KEY_GEN, CKM_TLS_PRE_MASTER_KEY_GEN));
 810         d(KG, &quot;SunTlsMasterSecret&quot;,
 811                     &quot;sun.security.pkcs11.P11TlsMasterSecretGenerator&quot;,
 812                 m(CKM_SSL3_MASTER_KEY_DERIVE, CKM_TLS_MASTER_KEY_DERIVE,
 813                     CKM_SSL3_MASTER_KEY_DERIVE_DH,
 814                     CKM_TLS_MASTER_KEY_DERIVE_DH));
 815         d(KG, &quot;SunTls12MasterSecret&quot;,
 816                 &quot;sun.security.pkcs11.P11TlsMasterSecretGenerator&quot;,
 817             m(CKM_TLS12_MASTER_KEY_DERIVE, CKM_TLS12_MASTER_KEY_DERIVE_DH));
 818         d(KG, &quot;SunTlsKeyMaterial&quot;,
 819                     &quot;sun.security.pkcs11.P11TlsKeyMaterialGenerator&quot;,
 820                 m(CKM_SSL3_KEY_AND_MAC_DERIVE, CKM_TLS_KEY_AND_MAC_DERIVE));
 821         d(KG, &quot;SunTls12KeyMaterial&quot;,
 822                 &quot;sun.security.pkcs11.P11TlsKeyMaterialGenerator&quot;,
 823             m(CKM_TLS12_KEY_AND_MAC_DERIVE));
 824         d(KG, &quot;SunTlsPrf&quot;, &quot;sun.security.pkcs11.P11TlsPrfGenerator&quot;,
 825                 m(CKM_TLS_PRF, CKM_NSS_TLS_PRF_GENERAL));
 826         d(KG, &quot;SunTls12Prf&quot;, &quot;sun.security.pkcs11.P11TlsPrfGenerator&quot;,
 827                 m(CKM_TLS_MAC));
 828     }
</pre>
<hr />
<pre>
1031                         : supportedAlgs.entrySet()) {
1032                     Descriptor d = entry.getKey();
1033                     int mechanism = entry.getValue().intValue();
1034                     Service s = d.service(token, mechanism);
1035                     putService(s);
1036                 }
1037                 if (((token.tokenInfo.flags &amp; CKF_RNG) != 0)
1038                         &amp;&amp; config.isEnabled(PCKM_SECURERANDOM)
1039                         &amp;&amp; !token.sessionManager.lowMaxSessions()) {
1040                     // do not register SecureRandom if the token does
1041                     // not support many sessions. if we did, we might
1042                     // run out of sessions in the middle of a
1043                     // nextBytes() call where we cannot fail over.
1044                     putService(new P11Service(token, SR, &quot;PKCS11&quot;,
1045                         &quot;sun.security.pkcs11.P11SecureRandom&quot;, null,
1046                         PCKM_SECURERANDOM));
1047                 }
1048                 if (config.isEnabled(PCKM_KEYSTORE)) {
1049                     putService(new P11Service(token, KS, &quot;PKCS11&quot;,
1050                         &quot;sun.security.pkcs11.P11KeyStore&quot;,
<span class="line-modified">1051                         s(&quot;PKCS11-&quot; + config.getName()),</span>
1052                         PCKM_KEYSTORE));
1053                 }
1054                 return null;
1055             }
1056         });
1057 
1058         this.token = token;
1059     }
1060 
1061     private static final class P11Service extends Service {
1062 
1063         private final Token token;
1064 
1065         private final long mechanism;
1066 
1067         P11Service(Token token, String type, String algorithm,
<span class="line-modified">1068                 String className, String[] al, long mechanism) {</span>
<span class="line-modified">1069             super(token.provider, type, algorithm, className, toList(al),</span>
1070                     type.equals(SR) ? Map.of(&quot;ThreadSafe&quot;, &quot;true&quot;) : null);
1071             this.token = token;
1072             this.mechanism = mechanism &amp; 0xFFFFFFFFL;
1073         }
1074 
<span class="line-removed">1075         private static List&lt;String&gt; toList(String[] aliases) {</span>
<span class="line-removed">1076             return (aliases == null) ? null : Arrays.asList(aliases);</span>
<span class="line-removed">1077         }</span>
<span class="line-removed">1078 </span>
1079         public Object newInstance(Object param)
1080                 throws NoSuchAlgorithmException {
1081             if (token.isValid() == false) {
1082                 throw new NoSuchAlgorithmException(&quot;Token has been removed&quot;);
1083             }
1084             try {
1085                 return newInstance0(param);
1086             } catch (PKCS11Exception e) {
1087                 throw new NoSuchAlgorithmException(e);
1088             }
1089         }
1090 
1091         public Object newInstance0(Object param) throws
1092                 PKCS11Exception, NoSuchAlgorithmException {
1093             String algorithm = getAlgorithm();
1094             String type = getType();
1095             if (type == MD) {
1096                 return new P11Digest(token, algorithm, mechanism);
1097             } else if (type == CIP) {
1098                 if (algorithm.startsWith(&quot;RSA&quot;)) {
</pre>
</td>
<td>
<hr />
<pre>
   1 /*
<span class="line-modified">   2  * Copyright (c) 2003, 2020, Oracle and/or its affiliates. All rights reserved.</span>
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.  Oracle designates this
   8  * particular file as subject to the &quot;Classpath&quot; exception as provided
   9  * by Oracle in the LICENSE file that accompanied this code.
  10  *
  11  * This code is distributed in the hope that it will be useful, but WITHOUT
  12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  14  * version 2 for more details (a copy is included in the LICENSE file that
  15  * accompanied this code).
  16  *
  17  * You should have received a copy of the GNU General Public License version
  18  * 2 along with this work; if not, write to the Free Software Foundation,
  19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  20  *
  21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  22  * or visit www.oracle.com if you need additional information or have any
</pre>
<hr />
<pre>
  28 import java.io.*;
  29 import java.util.*;
  30 
  31 import java.security.*;
  32 import java.security.interfaces.*;
  33 
  34 import javax.crypto.interfaces.*;
  35 
  36 import javax.security.auth.Subject;
  37 import javax.security.auth.login.LoginException;
  38 import javax.security.auth.login.FailedLoginException;
  39 import javax.security.auth.callback.Callback;
  40 import javax.security.auth.callback.CallbackHandler;
  41 import javax.security.auth.callback.ConfirmationCallback;
  42 import javax.security.auth.callback.PasswordCallback;
  43 import javax.security.auth.callback.TextOutputCallback;
  44 
  45 import sun.security.util.Debug;
  46 import sun.security.util.ResourcesMgr;
  47 import static sun.security.util.SecurityConstants.PROVIDER_VER;
<span class="line-added">  48 import static sun.security.util.SecurityProviderConstants.getAliases;</span>
  49 
  50 import sun.security.pkcs11.Secmod.*;
  51 
  52 import sun.security.pkcs11.wrapper.*;
  53 import static sun.security.pkcs11.wrapper.PKCS11Constants.*;
  54 
  55 /**
  56  * PKCS#11 provider main class.
  57  *
  58  * @author  Andreas Sterbenz
  59  * @since   1.5
  60  */
  61 public final class SunPKCS11 extends AuthProvider {
  62 
  63     private static final long serialVersionUID = -1354835039035306505L;
  64 
  65     static final Debug debug = Debug.getInstance(&quot;sunpkcs11&quot;);
  66     // the PKCS11 object through which we make the native calls
  67     final PKCS11 p11;
  68 
</pre>
<hr />
<pre>
 389         if (longs.length == 0) {
 390             return &quot;(none)&quot;;
 391         }
 392         StringBuilder sb = new StringBuilder();
 393         sb.append(longs[0]);
 394         for (int i = 1; i &lt; longs.length; i++) {
 395             sb.append(&quot;, &quot;);
 396             sb.append(longs[i]);
 397         }
 398         return sb.toString();
 399     }
 400 
 401     public boolean equals(Object obj) {
 402         return this == obj;
 403     }
 404 
 405     public int hashCode() {
 406         return System.identityHashCode(this);
 407     }
 408 




 409     private static final class Descriptor {
 410         final String type;
 411         final String algorithm;
 412         final String className;
<span class="line-modified"> 413         final List&lt;String&gt; aliases;</span>
 414         final int[] mechanisms;
 415 
 416         private Descriptor(String type, String algorithm, String className,
<span class="line-modified"> 417                 List&lt;String&gt; aliases, int[] mechanisms) {</span>
 418             this.type = type;
 419             this.algorithm = algorithm;
 420             this.className = className;
 421             this.aliases = aliases;
 422             this.mechanisms = mechanisms;
 423         }
 424         private P11Service service(Token token, int mechanism) {
 425             return new P11Service
 426                 (token, type, algorithm, className, aliases, mechanism);
 427         }
 428         public String toString() {
 429             return type + &quot;.&quot; + algorithm;
 430         }
 431     }
 432 
 433     // Map from mechanism to List of Descriptors that should be
 434     // registered if the mechanism is supported
 435     private final static Map&lt;Integer,List&lt;Descriptor&gt;&gt; descriptors =
 436         new HashMap&lt;Integer,List&lt;Descriptor&gt;&gt;();
 437 
</pre>
<hr />
<pre>
 440     }
 441 
 442     private static int[] m(long m1, long m2) {
 443         return new int[] {(int)m1, (int)m2};
 444     }
 445 
 446     private static int[] m(long m1, long m2, long m3) {
 447         return new int[] {(int)m1, (int)m2, (int)m3};
 448     }
 449 
 450     private static int[] m(long m1, long m2, long m3, long m4) {
 451         return new int[] {(int)m1, (int)m2, (int)m3, (int)m4};
 452     }
 453 
 454     private static void d(String type, String algorithm, String className,
 455             int[] m) {
 456         register(new Descriptor(type, algorithm, className, null, m));
 457     }
 458 
 459     private static void d(String type, String algorithm, String className,
<span class="line-modified"> 460             List&lt;String&gt; aliases, int[] m) {</span>
 461         register(new Descriptor(type, algorithm, className, aliases, m));
 462     }
 463 
<span class="line-added"> 464     private static void dA(String type, String algorithm, String className,</span>
<span class="line-added"> 465             int[] m) {</span>
<span class="line-added"> 466         register(new Descriptor(type, algorithm, className,</span>
<span class="line-added"> 467                 getAliases(algorithm), m));</span>
<span class="line-added"> 468     }</span>
<span class="line-added"> 469 </span>
 470     private static void register(Descriptor d) {
 471         for (int i = 0; i &lt; d.mechanisms.length; i++) {
 472             int m = d.mechanisms[i];
 473             Integer key = Integer.valueOf(m);
 474             List&lt;Descriptor&gt; list = descriptors.get(key);
 475             if (list == null) {
 476                 list = new ArrayList&lt;Descriptor&gt;();
 477                 descriptors.put(key, list);
 478             }
 479             list.add(d);
 480         }
 481     }
 482 
 483     private final static String MD  = &quot;MessageDigest&quot;;
 484 
 485     private final static String SIG = &quot;Signature&quot;;
 486 
 487     private final static String KPG = &quot;KeyPairGenerator&quot;;
 488 
 489     private final static String KG  = &quot;KeyGenerator&quot;;
</pre>
<hr />
<pre>
 511         String P11MAC              = &quot;sun.security.pkcs11.P11MAC&quot;;
 512         String P11KeyPairGenerator = &quot;sun.security.pkcs11.P11KeyPairGenerator&quot;;
 513         String P11KeyGenerator     = &quot;sun.security.pkcs11.P11KeyGenerator&quot;;
 514         String P11RSAKeyFactory    = &quot;sun.security.pkcs11.P11RSAKeyFactory&quot;;
 515         String P11DSAKeyFactory    = &quot;sun.security.pkcs11.P11DSAKeyFactory&quot;;
 516         String P11DHKeyFactory     = &quot;sun.security.pkcs11.P11DHKeyFactory&quot;;
 517         String P11KeyAgreement     = &quot;sun.security.pkcs11.P11KeyAgreement&quot;;
 518         String P11SecretKeyFactory = &quot;sun.security.pkcs11.P11SecretKeyFactory&quot;;
 519         String P11Cipher           = &quot;sun.security.pkcs11.P11Cipher&quot;;
 520         String P11RSACipher        = &quot;sun.security.pkcs11.P11RSACipher&quot;;
 521         String P11AEADCipher       = &quot;sun.security.pkcs11.P11AEADCipher&quot;;
 522         String P11Signature        = &quot;sun.security.pkcs11.P11Signature&quot;;
 523         String P11PSSSignature     = &quot;sun.security.pkcs11.P11PSSSignature&quot;;
 524 
 525         // XXX register all aliases
 526 
 527         d(MD, &quot;MD2&quot;,            P11Digest,
 528                 m(CKM_MD2));
 529         d(MD, &quot;MD5&quot;,            P11Digest,
 530                 m(CKM_MD5));
<span class="line-modified"> 531         dA(MD, &quot;SHA-1&quot;,           P11Digest,</span>

 532                 m(CKM_SHA_1));
 533 
<span class="line-modified"> 534         dA(MD, &quot;SHA-224&quot;,        P11Digest,</span>

 535                 m(CKM_SHA224));
<span class="line-modified"> 536         dA(MD, &quot;SHA-256&quot;,        P11Digest,</span>

 537                 m(CKM_SHA256));
<span class="line-modified"> 538         dA(MD, &quot;SHA-384&quot;,        P11Digest,</span>

 539                 m(CKM_SHA384));
<span class="line-modified"> 540         dA(MD, &quot;SHA-512&quot;,        P11Digest,</span>

 541                 m(CKM_SHA512));
<span class="line-modified"> 542         dA(MD, &quot;SHA-512/224&quot;,        P11Digest,</span>

 543                 m(CKM_SHA512_224));
<span class="line-modified"> 544         dA(MD, &quot;SHA-512/256&quot;,        P11Digest,</span>

 545                 m(CKM_SHA512_256));
 546 
 547         d(MAC, &quot;HmacMD5&quot;,       P11MAC,
 548                 m(CKM_MD5_HMAC));
<span class="line-modified"> 549         dA(MAC, &quot;HmacSHA1&quot;,      P11MAC,</span>

 550                 m(CKM_SHA_1_HMAC));
<span class="line-modified"> 551         dA(MAC, &quot;HmacSHA224&quot;,    P11MAC,</span>

 552                 m(CKM_SHA224_HMAC));
<span class="line-modified"> 553         dA(MAC, &quot;HmacSHA256&quot;,    P11MAC,</span>

 554                 m(CKM_SHA256_HMAC));
<span class="line-modified"> 555         dA(MAC, &quot;HmacSHA384&quot;,    P11MAC,</span>

 556                 m(CKM_SHA384_HMAC));
<span class="line-modified"> 557         dA(MAC, &quot;HmacSHA512&quot;,    P11MAC,</span>

 558                 m(CKM_SHA512_HMAC));
<span class="line-modified"> 559         dA(MAC, &quot;HmacSHA512/224&quot;,    P11MAC,</span>

 560                 m(CKM_SHA512_224_HMAC));
<span class="line-modified"> 561         dA(MAC, &quot;HmacSHA512/256&quot;,    P11MAC,</span>

 562                 m(CKM_SHA512_256_HMAC));
 563 
 564         d(MAC, &quot;SslMacMD5&quot;,     P11MAC,
 565                 m(CKM_SSL3_MD5_MAC));
 566         d(MAC, &quot;SslMacSHA1&quot;,    P11MAC,
 567                 m(CKM_SSL3_SHA1_MAC));
 568 
 569         d(KPG, &quot;RSA&quot;,           P11KeyPairGenerator,
<span class="line-modified"> 570                 getAliases(&quot;PKCS1&quot;),</span>
 571                 m(CKM_RSA_PKCS_KEY_PAIR_GEN));
 572 
<span class="line-modified"> 573         List&lt;String&gt; dhAlias = List.of(&quot;DiffieHellman&quot;);</span>
<span class="line-modified"> 574 </span>
<span class="line-added"> 575         dA(KPG, &quot;DSA&quot;,           P11KeyPairGenerator,</span>
 576                 m(CKM_DSA_KEY_PAIR_GEN));
<span class="line-modified"> 577         d(KPG, &quot;DH&quot;,            P11KeyPairGenerator,</span>
<span class="line-added"> 578                 dhAlias,</span>
 579                 m(CKM_DH_PKCS_KEY_PAIR_GEN));
 580         d(KPG, &quot;EC&quot;,            P11KeyPairGenerator,
 581                 m(CKM_EC_KEY_PAIR_GEN));
 582 
<span class="line-modified"> 583         dA(KG,  &quot;ARCFOUR&quot;,       P11KeyGenerator,</span>
 584                 m(CKM_RC4_KEY_GEN));
 585         d(KG,  &quot;DES&quot;,           P11KeyGenerator,
 586                 m(CKM_DES_KEY_GEN));
 587         d(KG,  &quot;DESede&quot;,        P11KeyGenerator,
 588                 m(CKM_DES3_KEY_GEN, CKM_DES2_KEY_GEN));
 589         d(KG,  &quot;AES&quot;,           P11KeyGenerator,
 590                 m(CKM_AES_KEY_GEN));
 591         d(KG,  &quot;Blowfish&quot;,      P11KeyGenerator,
 592                 m(CKM_BLOWFISH_KEY_GEN));
 593 
 594         // register (Secret)KeyFactories if there are any mechanisms
 595         // for a particular algorithm that we support
 596         d(KF, &quot;RSA&quot;,            P11RSAKeyFactory,
<span class="line-modified"> 597                 getAliases(&quot;PKCS1&quot;),</span>
 598                 m(CKM_RSA_PKCS_KEY_PAIR_GEN, CKM_RSA_PKCS, CKM_RSA_X_509));
<span class="line-modified"> 599         dA(KF, &quot;DSA&quot;,            P11DSAKeyFactory,</span>

 600                 m(CKM_DSA_KEY_PAIR_GEN, CKM_DSA, CKM_DSA_SHA1));
<span class="line-modified"> 601         d(KF, &quot;DH&quot;,             P11DHKeyFactory,</span>
<span class="line-added"> 602                 dhAlias,</span>
 603                 m(CKM_DH_PKCS_KEY_PAIR_GEN, CKM_DH_PKCS_DERIVE));
 604         d(KF, &quot;EC&quot;,             P11DHKeyFactory,
 605                 m(CKM_EC_KEY_PAIR_GEN, CKM_ECDH1_DERIVE,
 606                     CKM_ECDSA, CKM_ECDSA_SHA1));
 607 
 608         // AlgorithmParameters for EC.
 609         // Only needed until we have an EC implementation in the SUN provider.
<span class="line-modified"> 610         dA(AGP, &quot;EC&quot;,            &quot;sun.security.util.ECParameters&quot;,</span>

 611                 m(CKM_EC_KEY_PAIR_GEN, CKM_ECDH1_DERIVE,
 612                     CKM_ECDSA, CKM_ECDSA_SHA1));
 613 
 614 
 615         d(AGP, &quot;GCM&quot;,            &quot;sun.security.util.GCMParameters&quot;,
 616                 m(CKM_AES_GCM));
 617 
<span class="line-modified"> 618         d(KA, &quot;DH&quot;,             P11KeyAgreement,</span>
<span class="line-added"> 619                 dhAlias,</span>
 620                 m(CKM_DH_PKCS_DERIVE));
 621         d(KA, &quot;ECDH&quot;,           &quot;sun.security.pkcs11.P11ECDHKeyAgreement&quot;,
 622                 m(CKM_ECDH1_DERIVE));
 623 
<span class="line-modified"> 624         dA(SKF, &quot;ARCFOUR&quot;,       P11SecretKeyFactory,</span>
 625                 m(CKM_RC4));
 626         d(SKF, &quot;DES&quot;,           P11SecretKeyFactory,
 627                 m(CKM_DES_CBC));
 628         d(SKF, &quot;DESede&quot;,        P11SecretKeyFactory,
 629                 m(CKM_DES3_CBC));
<span class="line-modified"> 630         dA(SKF, &quot;AES&quot;,           P11SecretKeyFactory,</span>

 631                 m(CKM_AES_CBC));
 632         d(SKF, &quot;Blowfish&quot;,      P11SecretKeyFactory,
 633                 m(CKM_BLOWFISH_CBC));
 634 
 635         // XXX attributes for Ciphers (supported modes, padding)
<span class="line-modified"> 636         dA(CIP, &quot;ARCFOUR&quot;,                      P11Cipher,</span>
 637                 m(CKM_RC4));
 638         d(CIP, &quot;DES/CBC/NoPadding&quot;,             P11Cipher,
 639                 m(CKM_DES_CBC));
 640         d(CIP, &quot;DES/CBC/PKCS5Padding&quot;,          P11Cipher,
 641                 m(CKM_DES_CBC_PAD, CKM_DES_CBC));
 642         d(CIP, &quot;DES/ECB/NoPadding&quot;,             P11Cipher,
 643                 m(CKM_DES_ECB));
<span class="line-modified"> 644         d(CIP, &quot;DES/ECB/PKCS5Padding&quot;,          P11Cipher,</span>
<span class="line-added"> 645                 List.of(&quot;DES&quot;),</span>
 646                 m(CKM_DES_ECB));
 647 
 648         d(CIP, &quot;DESede/CBC/NoPadding&quot;,          P11Cipher,
 649                 m(CKM_DES3_CBC));
 650         d(CIP, &quot;DESede/CBC/PKCS5Padding&quot;,       P11Cipher,
 651                 m(CKM_DES3_CBC_PAD, CKM_DES3_CBC));
 652         d(CIP, &quot;DESede/ECB/NoPadding&quot;,          P11Cipher,
 653                 m(CKM_DES3_ECB));
<span class="line-modified"> 654         d(CIP, &quot;DESede/ECB/PKCS5Padding&quot;,       P11Cipher,</span>
<span class="line-added"> 655                 List.of(&quot;DESede&quot;),</span>
 656                 m(CKM_DES3_ECB));
 657         d(CIP, &quot;AES/CBC/NoPadding&quot;,             P11Cipher,
 658                 m(CKM_AES_CBC));
<span class="line-modified"> 659         dA(CIP, &quot;AES_128/CBC/NoPadding&quot;,          P11Cipher,</span>

 660                 m(CKM_AES_CBC));
<span class="line-modified"> 661         dA(CIP, &quot;AES_192/CBC/NoPadding&quot;,          P11Cipher,</span>

 662                 m(CKM_AES_CBC));
<span class="line-modified"> 663         dA(CIP, &quot;AES_256/CBC/NoPadding&quot;,          P11Cipher,</span>

 664                 m(CKM_AES_CBC));
 665         d(CIP, &quot;AES/CBC/PKCS5Padding&quot;,          P11Cipher,
 666                 m(CKM_AES_CBC_PAD, CKM_AES_CBC));
 667         d(CIP, &quot;AES/ECB/NoPadding&quot;,             P11Cipher,
 668                 m(CKM_AES_ECB));
<span class="line-modified"> 669         dA(CIP, &quot;AES_128/ECB/NoPadding&quot;,          P11Cipher,</span>

 670                 m(CKM_AES_ECB));
<span class="line-modified"> 671         dA(CIP, &quot;AES_192/ECB/NoPadding&quot;,          P11Cipher,</span>

 672                 m(CKM_AES_ECB));
<span class="line-modified"> 673         dA(CIP, &quot;AES_256/ECB/NoPadding&quot;,          P11Cipher,</span>

 674                 m(CKM_AES_ECB));
<span class="line-modified"> 675         d(CIP, &quot;AES/ECB/PKCS5Padding&quot;,          P11Cipher,</span>
<span class="line-added"> 676                 List.of(&quot;AES&quot;),</span>
 677                 m(CKM_AES_ECB));
 678         d(CIP, &quot;AES/CTR/NoPadding&quot;,             P11Cipher,
 679                 m(CKM_AES_CTR));
 680 
 681         d(CIP, &quot;AES/GCM/NoPadding&quot;,             P11AEADCipher,
 682                 m(CKM_AES_GCM));
<span class="line-modified"> 683         dA(CIP, &quot;AES_128/GCM/NoPadding&quot;,          P11AEADCipher,</span>

 684                 m(CKM_AES_GCM));
<span class="line-modified"> 685         dA(CIP, &quot;AES_192/GCM/NoPadding&quot;,          P11AEADCipher,</span>

 686                 m(CKM_AES_GCM));
<span class="line-modified"> 687         dA(CIP, &quot;AES_256/GCM/NoPadding&quot;,          P11AEADCipher,</span>

 688                 m(CKM_AES_GCM));
 689 
 690         d(CIP, &quot;Blowfish/CBC/NoPadding&quot;,        P11Cipher,
 691                 m(CKM_BLOWFISH_CBC));
 692         d(CIP, &quot;Blowfish/CBC/PKCS5Padding&quot;,     P11Cipher,
 693                 m(CKM_BLOWFISH_CBC));
 694 
<span class="line-modified"> 695         d(CIP, &quot;RSA/ECB/PKCS1Padding&quot;,          P11RSACipher,</span>
<span class="line-added"> 696                 List.of(&quot;RSA&quot;),</span>
 697                 m(CKM_RSA_PKCS));
 698         d(CIP, &quot;RSA/ECB/NoPadding&quot;,             P11RSACipher,
 699                 m(CKM_RSA_X_509));
 700 
<span class="line-modified"> 701         d(SIG, &quot;RawDSA&quot;,        P11Signature,</span>
<span class="line-added"> 702                 List.of(&quot;NONEwithDSA&quot;),</span>
 703                 m(CKM_DSA));
<span class="line-modified"> 704         dA(SIG, &quot;SHA1withDSA&quot;,           P11Signature,</span>


 705                 m(CKM_DSA_SHA1, CKM_DSA));
<span class="line-modified"> 706         dA(SIG, &quot;SHA224withDSA&quot;, P11Signature,</span>

 707                 m(CKM_DSA_SHA224));
<span class="line-modified"> 708         dA(SIG, &quot;SHA256withDSA&quot;, P11Signature,</span>

 709                 m(CKM_DSA_SHA256));
<span class="line-modified"> 710         dA(SIG, &quot;SHA384withDSA&quot;, P11Signature,</span>

 711                 m(CKM_DSA_SHA384));
<span class="line-modified"> 712         dA(SIG, &quot;SHA512withDSA&quot;, P11Signature,</span>

 713                 m(CKM_DSA_SHA512));
 714         d(SIG, &quot;RawDSAinP1363Format&quot;,   P11Signature,
<span class="line-modified"> 715                 List.of(&quot;NONEwithDSAinP1363Format&quot;),</span>
 716                 m(CKM_DSA));
 717         d(SIG, &quot;DSAinP1363Format&quot;,      P11Signature,
<span class="line-modified"> 718                 List.of(&quot;SHA1withDSAinP1363Format&quot;),</span>
 719                 m(CKM_DSA_SHA1, CKM_DSA));
 720 
 721         d(SIG, &quot;NONEwithECDSA&quot;, P11Signature,
 722                 m(CKM_ECDSA));
<span class="line-modified"> 723         dA(SIG, &quot;SHA1withECDSA&quot;, P11Signature,</span>

 724                 m(CKM_ECDSA_SHA1, CKM_ECDSA));
<span class="line-modified"> 725         dA(SIG, &quot;SHA224withECDSA&quot;,       P11Signature,</span>

 726                 m(CKM_ECDSA));
<span class="line-modified"> 727         dA(SIG, &quot;SHA256withECDSA&quot;,       P11Signature,</span>

 728                 m(CKM_ECDSA));
<span class="line-modified"> 729         dA(SIG, &quot;SHA384withECDSA&quot;,       P11Signature,</span>

 730                 m(CKM_ECDSA));
<span class="line-modified"> 731         dA(SIG, &quot;SHA512withECDSA&quot;,       P11Signature,</span>

 732                 m(CKM_ECDSA));
 733         d(SIG, &quot;NONEwithECDSAinP1363Format&quot;,   P11Signature,
 734                 m(CKM_ECDSA));
 735         d(SIG, &quot;SHA1withECDSAinP1363Format&quot;,   P11Signature,
 736                 m(CKM_ECDSA_SHA1, CKM_ECDSA));
 737         d(SIG, &quot;SHA224withECDSAinP1363Format&quot;, P11Signature,
 738                 m(CKM_ECDSA));
 739         d(SIG, &quot;SHA256withECDSAinP1363Format&quot;, P11Signature,
 740                 m(CKM_ECDSA));
 741         d(SIG, &quot;SHA384withECDSAinP1363Format&quot;, P11Signature,
 742                 m(CKM_ECDSA));
 743         d(SIG, &quot;SHA512withECDSAinP1363Format&quot;, P11Signature,
 744                 m(CKM_ECDSA));
<span class="line-modified"> 745         dA(SIG, &quot;MD2withRSA&quot;,    P11Signature,</span>

 746                 m(CKM_MD2_RSA_PKCS, CKM_RSA_PKCS, CKM_RSA_X_509));
<span class="line-modified"> 747         dA(SIG, &quot;MD5withRSA&quot;,    P11Signature,</span>

 748                 m(CKM_MD5_RSA_PKCS, CKM_RSA_PKCS, CKM_RSA_X_509));
<span class="line-modified"> 749         dA(SIG, &quot;SHA1withRSA&quot;,   P11Signature,</span>


 750                 m(CKM_SHA1_RSA_PKCS, CKM_RSA_PKCS, CKM_RSA_X_509));
<span class="line-modified"> 751         dA(SIG, &quot;SHA224withRSA&quot;, P11Signature,</span>

 752                 m(CKM_SHA224_RSA_PKCS, CKM_RSA_PKCS, CKM_RSA_X_509));
<span class="line-modified"> 753         dA(SIG, &quot;SHA256withRSA&quot;, P11Signature,</span>

 754                 m(CKM_SHA256_RSA_PKCS, CKM_RSA_PKCS, CKM_RSA_X_509));
<span class="line-modified"> 755         dA(SIG, &quot;SHA384withRSA&quot;, P11Signature,</span>

 756                 m(CKM_SHA384_RSA_PKCS, CKM_RSA_PKCS, CKM_RSA_X_509));
<span class="line-modified"> 757         dA(SIG, &quot;SHA512withRSA&quot;, P11Signature,</span>

 758                 m(CKM_SHA512_RSA_PKCS, CKM_RSA_PKCS, CKM_RSA_X_509));
<span class="line-modified"> 759         dA(SIG, &quot;RSASSA-PSS&quot;, P11PSSSignature,</span>

 760                 m(CKM_RSA_PKCS_PSS));
 761         d(SIG, &quot;SHA1withRSASSA-PSS&quot;, P11PSSSignature,
 762                 m(CKM_SHA1_RSA_PKCS_PSS));
 763         d(SIG, &quot;SHA224withRSASSA-PSS&quot;, P11PSSSignature,
 764                 m(CKM_SHA224_RSA_PKCS_PSS));
 765         d(SIG, &quot;SHA256withRSASSA-PSS&quot;, P11PSSSignature,
 766                 m(CKM_SHA256_RSA_PKCS_PSS));
 767         d(SIG, &quot;SHA384withRSASSA-PSS&quot;, P11PSSSignature,
 768                 m(CKM_SHA384_RSA_PKCS_PSS));
 769         d(SIG, &quot;SHA512withRSASSA-PSS&quot;, P11PSSSignature,
 770                 m(CKM_SHA512_RSA_PKCS_PSS));
 771 
 772         d(KG, &quot;SunTlsRsaPremasterSecret&quot;,
 773                     &quot;sun.security.pkcs11.P11TlsRsaPremasterSecretGenerator&quot;,
<span class="line-modified"> 774                 List.of(&quot;SunTls12RsaPremasterSecret&quot;),</span>
 775                 m(CKM_SSL3_PRE_MASTER_KEY_GEN, CKM_TLS_PRE_MASTER_KEY_GEN));
 776         d(KG, &quot;SunTlsMasterSecret&quot;,
 777                     &quot;sun.security.pkcs11.P11TlsMasterSecretGenerator&quot;,
 778                 m(CKM_SSL3_MASTER_KEY_DERIVE, CKM_TLS_MASTER_KEY_DERIVE,
 779                     CKM_SSL3_MASTER_KEY_DERIVE_DH,
 780                     CKM_TLS_MASTER_KEY_DERIVE_DH));
 781         d(KG, &quot;SunTls12MasterSecret&quot;,
 782                 &quot;sun.security.pkcs11.P11TlsMasterSecretGenerator&quot;,
 783             m(CKM_TLS12_MASTER_KEY_DERIVE, CKM_TLS12_MASTER_KEY_DERIVE_DH));
 784         d(KG, &quot;SunTlsKeyMaterial&quot;,
 785                     &quot;sun.security.pkcs11.P11TlsKeyMaterialGenerator&quot;,
 786                 m(CKM_SSL3_KEY_AND_MAC_DERIVE, CKM_TLS_KEY_AND_MAC_DERIVE));
 787         d(KG, &quot;SunTls12KeyMaterial&quot;,
 788                 &quot;sun.security.pkcs11.P11TlsKeyMaterialGenerator&quot;,
 789             m(CKM_TLS12_KEY_AND_MAC_DERIVE));
 790         d(KG, &quot;SunTlsPrf&quot;, &quot;sun.security.pkcs11.P11TlsPrfGenerator&quot;,
 791                 m(CKM_TLS_PRF, CKM_NSS_TLS_PRF_GENERAL));
 792         d(KG, &quot;SunTls12Prf&quot;, &quot;sun.security.pkcs11.P11TlsPrfGenerator&quot;,
 793                 m(CKM_TLS_MAC));
 794     }
</pre>
<hr />
<pre>
 997                         : supportedAlgs.entrySet()) {
 998                     Descriptor d = entry.getKey();
 999                     int mechanism = entry.getValue().intValue();
1000                     Service s = d.service(token, mechanism);
1001                     putService(s);
1002                 }
1003                 if (((token.tokenInfo.flags &amp; CKF_RNG) != 0)
1004                         &amp;&amp; config.isEnabled(PCKM_SECURERANDOM)
1005                         &amp;&amp; !token.sessionManager.lowMaxSessions()) {
1006                     // do not register SecureRandom if the token does
1007                     // not support many sessions. if we did, we might
1008                     // run out of sessions in the middle of a
1009                     // nextBytes() call where we cannot fail over.
1010                     putService(new P11Service(token, SR, &quot;PKCS11&quot;,
1011                         &quot;sun.security.pkcs11.P11SecureRandom&quot;, null,
1012                         PCKM_SECURERANDOM));
1013                 }
1014                 if (config.isEnabled(PCKM_KEYSTORE)) {
1015                     putService(new P11Service(token, KS, &quot;PKCS11&quot;,
1016                         &quot;sun.security.pkcs11.P11KeyStore&quot;,
<span class="line-modified">1017                         List.of(&quot;PKCS11-&quot; + config.getName()),</span>
1018                         PCKM_KEYSTORE));
1019                 }
1020                 return null;
1021             }
1022         });
1023 
1024         this.token = token;
1025     }
1026 
1027     private static final class P11Service extends Service {
1028 
1029         private final Token token;
1030 
1031         private final long mechanism;
1032 
1033         P11Service(Token token, String type, String algorithm,
<span class="line-modified">1034                 String className, List&lt;String&gt; al, long mechanism) {</span>
<span class="line-modified">1035             super(token.provider, type, algorithm, className, al,</span>
1036                     type.equals(SR) ? Map.of(&quot;ThreadSafe&quot;, &quot;true&quot;) : null);
1037             this.token = token;
1038             this.mechanism = mechanism &amp; 0xFFFFFFFFL;
1039         }
1040 




1041         public Object newInstance(Object param)
1042                 throws NoSuchAlgorithmException {
1043             if (token.isValid() == false) {
1044                 throw new NoSuchAlgorithmException(&quot;Token has been removed&quot;);
1045             }
1046             try {
1047                 return newInstance0(param);
1048             } catch (PKCS11Exception e) {
1049                 throw new NoSuchAlgorithmException(e);
1050             }
1051         }
1052 
1053         public Object newInstance0(Object param) throws
1054                 PKCS11Exception, NoSuchAlgorithmException {
1055             String algorithm = getAlgorithm();
1056             String type = getType();
1057             if (type == MD) {
1058                 return new P11Digest(token, algorithm, mechanism);
1059             } else if (type == CIP) {
1060                 if (algorithm.startsWith(&quot;RSA&quot;)) {
</pre>
</td>
</tr>
</table>
<center><a href="../../../../../../jdk.compiler/share/classes/com/sun/tools/sjavac/options/OptionHelper.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="../../../../../../jdk.crypto.ec/share/classes/sun/security/ec/SunEC.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>