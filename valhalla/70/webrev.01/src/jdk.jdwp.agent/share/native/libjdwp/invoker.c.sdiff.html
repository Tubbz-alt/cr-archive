<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/jdk.jdwp.agent/share/native/libjdwp/invoker.c</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
<body>
<center><a href="inStream.h.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="util.c.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/jdk.jdwp.agent/share/native/libjdwp/invoker.c</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 11  * This code is distributed in the hope that it will be useful, but WITHOUT
 12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 14  * version 2 for more details (a copy is included in the LICENSE file that
 15  * accompanied this code).
 16  *
 17  * You should have received a copy of the GNU General Public License version
 18  * 2 along with this work; if not, write to the Free Software Foundation,
 19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 20  *
 21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 22  * or visit www.oracle.com if you need additional information or have any
 23  * questions.
 24  */
 25 
 26 #include &quot;util.h&quot;
 27 #include &quot;invoker.h&quot;
 28 #include &quot;eventHandler.h&quot;
 29 #include &quot;threadControl.h&quot;
 30 #include &quot;outStream.h&quot;

 31 
 32 static jrawMonitorID invokerLock;
 33 
 34 void
 35 invoker_initialize(void)
 36 {
 37     invokerLock = debugMonitorCreate(&quot;JDWP Invocation Lock&quot;);
 38 }
 39 
 40 void
 41 invoker_reset(void)
 42 {
 43 }
 44 
 45 void invoker_lock(void)
 46 {
 47     debugMonitorEnter(invokerLock);
 48 }
 49 
 50 void invoker_unlock(void)
 51 {
 52     debugMonitorExit(invokerLock);
 53 }
 54 
<span class="line-removed"> 55 static jbyte</span>
<span class="line-removed"> 56 returnTypeTag(char *signature)</span>
<span class="line-removed"> 57 {</span>
<span class="line-removed"> 58     char *tagPtr = strchr(signature, SIGNATURE_END_ARGS);</span>
<span class="line-removed"> 59     JDI_ASSERT(tagPtr);</span>
<span class="line-removed"> 60     tagPtr++;    /* 1st character after the end of args */</span>
<span class="line-removed"> 61     return (jbyte)*tagPtr;</span>
<span class="line-removed"> 62 }</span>
<span class="line-removed"> 63 </span>
<span class="line-removed"> 64 static jbyte</span>
<span class="line-removed"> 65 nextArgumentTypeTag(void **cursor)</span>
<span class="line-removed"> 66 {</span>
<span class="line-removed"> 67     char *tagPtr = *cursor;</span>
<span class="line-removed"> 68     jbyte argumentTag = (jbyte)*tagPtr;</span>
<span class="line-removed"> 69 </span>
<span class="line-removed"> 70     if (*tagPtr != SIGNATURE_END_ARGS) {</span>
<span class="line-removed"> 71         /* Skip any array modifiers */</span>
<span class="line-removed"> 72         while (*tagPtr == JDWP_TAG(ARRAY)) {</span>
<span class="line-removed"> 73             tagPtr++;</span>
<span class="line-removed"> 74         }</span>
<span class="line-removed"> 75         /* Skip class name */</span>
<span class="line-removed"> 76         if (*tagPtr == JDWP_TAG(OBJECT)) {</span>
<span class="line-removed"> 77             tagPtr = strchr(tagPtr, SIGNATURE_END_CLASS) + 1;</span>
<span class="line-removed"> 78             JDI_ASSERT(tagPtr);</span>
<span class="line-removed"> 79         } else {</span>
<span class="line-removed"> 80             /* Skip primitive sig */</span>
<span class="line-removed"> 81             tagPtr++;</span>
<span class="line-removed"> 82         }</span>
<span class="line-removed"> 83     }</span>
<span class="line-removed"> 84 </span>
<span class="line-removed"> 85     *cursor = tagPtr;</span>
<span class="line-removed"> 86     return argumentTag;</span>
<span class="line-removed"> 87 }</span>
<span class="line-removed"> 88 </span>
<span class="line-removed"> 89 static jbyte</span>
<span class="line-removed"> 90 firstArgumentTypeTag(char *signature, void **cursor)</span>
<span class="line-removed"> 91 {</span>
<span class="line-removed"> 92     JDI_ASSERT(signature[0] == SIGNATURE_BEGIN_ARGS);</span>
<span class="line-removed"> 93     *cursor = signature + 1; /* skip to the first arg */</span>
<span class="line-removed"> 94     return nextArgumentTypeTag(cursor);</span>
<span class="line-removed"> 95 }</span>
<span class="line-removed"> 96 </span>
<span class="line-removed"> 97 </span>
 98 /*
 99  * Note: argument refs may be destroyed on out-of-memory error
100  */
101 static jvmtiError
102 createGlobalRefs(JNIEnv *env, InvokeRequest *request)
103 {
<span class="line-modified">104     jvmtiError error;</span>




105     jclass clazz = NULL;
106     jobject instance = NULL;
<span class="line-removed">107     jint argIndex;</span>
<span class="line-removed">108     jbyte argumentTag;</span>
<span class="line-removed">109     jvalue *argument;</span>
<span class="line-removed">110     void *cursor;</span>
111     jobject *argRefs = NULL;
112 
<span class="line-removed">113     error = JVMTI_ERROR_NONE;</span>
<span class="line-removed">114 </span>
115     if ( request-&gt;argumentCount &gt; 0 ) {
116         /*LINTED*/
117         argRefs = jvmtiAllocate((jint)(request-&gt;argumentCount*sizeof(jobject)));
118         if ( argRefs==NULL ) {
119             error = AGENT_ERROR_OUT_OF_MEMORY;
120         } else {
121             /*LINTED*/
122             (void)memset(argRefs, 0, request-&gt;argumentCount*sizeof(jobject));
123         }
124     }
125 
126     if ( error == JVMTI_ERROR_NONE ) {
127         saveGlobalRef(env, request-&gt;clazz, &amp;clazz);
128         if (clazz == NULL) {
129             error = AGENT_ERROR_OUT_OF_MEMORY;
130         }
131     }
132 
133     if ( error == JVMTI_ERROR_NONE &amp;&amp; request-&gt;instance != NULL ) {
134         saveGlobalRef(env, request-&gt;instance, &amp;instance);
135         if (instance == NULL) {
136             error = AGENT_ERROR_OUT_OF_MEMORY;
137         }
138     }
139 
140     if ( error == JVMTI_ERROR_NONE &amp;&amp; argRefs!=NULL ) {
<span class="line-modified">141         argIndex = 0;</span>
<span class="line-modified">142         argumentTag = firstArgumentTypeTag(request-&gt;methodSignature, &amp;cursor);</span>
<span class="line-removed">143         argument = request-&gt;arguments;</span>
<span class="line-removed">144         while (argumentTag != SIGNATURE_END_ARGS) {</span>
145             if ( argIndex &gt; request-&gt;argumentCount ) {
146                 break;
147             }
<span class="line-modified">148             if ((argumentTag == JDWP_TAG(OBJECT)) ||</span>
<span class="line-removed">149                 (argumentTag == JDWP_TAG(ARRAY))  ||</span>
<span class="line-removed">150 		(argumentTag == JDWP_TAG(INLINE_OBJECT))) {</span>
151                 /* Create a global ref for any non-null argument */
152                 if (argument-&gt;l != NULL) {
153                     saveGlobalRef(env, argument-&gt;l, &amp;argRefs[argIndex]);
154                     if (argRefs[argIndex] == NULL) {
155                         error = AGENT_ERROR_OUT_OF_MEMORY;
156                         break;
157                     }
158                 }
159             }
160             argument++;
161             argIndex++;
<span class="line-removed">162             argumentTag = nextArgumentTypeTag(&amp;cursor);</span>
163         }
164     }
165 
166 #ifdef FIXUP /* Why isn&#39;t this an error? */
167     /* Make sure the argument count matches */
168     if ( error == JVMTI_ERROR_NONE &amp;&amp; argIndex != request-&gt;argumentCount ) {
169         error = AGENT_ERROR_INVALID_COUNT;
170     }
171 #endif
172 
173     /* Finally, put the global refs into the request if no errors */
174     if ( error == JVMTI_ERROR_NONE ) {
175         request-&gt;clazz = clazz;
176         request-&gt;instance = instance;
177         if ( argRefs!=NULL ) {
178             argIndex = 0;
<span class="line-modified">179             argumentTag = firstArgumentTypeTag(request-&gt;methodSignature, &amp;cursor);</span>
180             argument = request-&gt;arguments;
<span class="line-modified">181             while ( argIndex &lt; request-&gt;argumentCount ) {</span>
<span class="line-modified">182                 if ((argumentTag == JDWP_TAG(OBJECT)) ||</span>
<span class="line-modified">183                     (argumentTag == JDWP_TAG(ARRAY))  ||</span>
<span class="line-removed">184 		    (argumentTag == JDWP_TAG(INLINE_OBJECT))) {</span>
185                     argument-&gt;l = argRefs[argIndex];
186                 }
187                 argument++;
188                 argIndex++;
<span class="line-removed">189                 argumentTag = nextArgumentTypeTag(&amp;cursor);</span>
190             }
191             jvmtiDeallocate(argRefs);
192         }
193         return JVMTI_ERROR_NONE;
194 
195     } else {
196         /* Delete global references */
197         if ( clazz != NULL ) {
198             tossGlobalRef(env, &amp;clazz);
199         }
200         if ( instance != NULL ) {
201             tossGlobalRef(env, &amp;instance);
202         }
203         if ( argRefs!=NULL ) {
204             for ( argIndex=0; argIndex &lt; request-&gt;argumentCount; argIndex++ ) {
205                 if ( argRefs[argIndex] != NULL ) {
206                     tossGlobalRef(env, &amp;argRefs[argIndex]);
207                 }
208             }
209             jvmtiDeallocate(argRefs);
210         }
211     }
212 
213     return error;
214 }
215 
216 /*
217  * Delete global argument references from the request which got put there before a
218  * invoke request was carried out. See fillInvokeRequest().
219  */
220 static void
221 deleteGlobalArgumentRefs(JNIEnv *env, InvokeRequest *request)
222 {
<span class="line-modified">223     void *cursor;</span>
224     jint argIndex = 0;

225     jvalue *argument = request-&gt;arguments;
<span class="line-modified">226     jbyte argumentTag = firstArgumentTypeTag(request-&gt;methodSignature, &amp;cursor);</span>
227 
228     if (request-&gt;clazz != NULL) {
229         tossGlobalRef(env, &amp;(request-&gt;clazz));
230     }
231     if (request-&gt;instance != NULL) {
232         tossGlobalRef(env, &amp;(request-&gt;instance));
233     }
234     /* Delete global argument references */
<span class="line-modified">235     while (argIndex &lt; request-&gt;argumentCount) {</span>
<span class="line-modified">236         if ((argumentTag == JDWP_TAG(OBJECT)) ||</span>
<span class="line-modified">237             (argumentTag == JDWP_TAG(ARRAY))  ||</span>
<span class="line-removed">238 	    (argumentTag == JDWP_TAG(INLINE_OBJECT))) {</span>
239             if (argument-&gt;l != NULL) {
240                 tossGlobalRef(env, &amp;(argument-&gt;l));
241             }
242         }
243         argument++;
244         argIndex++;
<span class="line-removed">245         argumentTag = nextArgumentTypeTag(&amp;cursor);</span>
246     }
247 }
248 
249 static jvmtiError
250 fillInvokeRequest(JNIEnv *env, InvokeRequest *request,
251                   jbyte invokeType, jbyte options, jint id,
252                   jthread thread, jclass clazz, jmethodID method,
253                   jobject instance,
254                   jvalue *arguments, jint argumentCount)
255 {
256     jvmtiError error;
257     if (!request-&gt;available) {
258         /*
259          * Thread is not at a point where it can invoke.
260          */
261         return AGENT_ERROR_INVALID_THREAD;
262     }
263     if (request-&gt;pending) {
264         /*
265          * Pending invoke
</pre>
<hr />
<pre>
390 }
391 
392 static void
393 invokeConstructor(JNIEnv *env, InvokeRequest *request)
394 {
395     jobject object;
396 
397     JDI_ASSERT_MSG(request-&gt;clazz, &quot;Request clazz null&quot;);
398     object = JNI_FUNC_PTR(env,NewObjectA)(env, request-&gt;clazz,
399                                      request-&gt;method,
400                                      request-&gt;arguments);
401     request-&gt;returnValue.l = NULL;
402     if (object != NULL) {
403         saveGlobalRef(env, object, &amp;(request-&gt;returnValue.l));
404     }
405 }
406 
407 static void
408 invokeStatic(JNIEnv *env, InvokeRequest *request)
409 {
<span class="line-modified">410     switch(returnTypeTag(request-&gt;methodSignature)) {</span>
<span class="line-modified">411         case JDWP_TAG(OBJECT):</span>
<span class="line-modified">412         case JDWP_TAG(ARRAY):</span>
<span class="line-modified">413         case JDWP_TAG(INLINE_OBJECT): {</span>
<span class="line-modified">414             jobject object;</span>
<span class="line-modified">415             JDI_ASSERT_MSG(request-&gt;clazz, &quot;Request clazz null&quot;);</span>
<span class="line-modified">416             object = JNI_FUNC_PTR(env,CallStaticObjectMethodA)(env,</span>
<span class="line-modified">417                                        request-&gt;clazz,</span>
<span class="line-modified">418                                        request-&gt;method,</span>
<span class="line-modified">419                                        request-&gt;arguments);</span>
<span class="line-modified">420             request-&gt;returnValue.l = NULL;</span>
<span class="line-modified">421             if (object != NULL) {</span>
<span class="line-removed">422                 saveGlobalRef(env, object, &amp;(request-&gt;returnValue.l));</span>
<span class="line-removed">423             }</span>
<span class="line-removed">424             break;</span>
425         }


426 
<span class="line-modified">427 </span>
428         case JDWP_TAG(BYTE):
429             request-&gt;returnValue.b = JNI_FUNC_PTR(env,CallStaticByteMethodA)(env,
430                                                        request-&gt;clazz,
431                                                        request-&gt;method,
432                                                        request-&gt;arguments);
433             break;
434 
435         case JDWP_TAG(CHAR):
436             request-&gt;returnValue.c = JNI_FUNC_PTR(env,CallStaticCharMethodA)(env,
437                                                        request-&gt;clazz,
438                                                        request-&gt;method,
439                                                        request-&gt;arguments);
440             break;
441 
442         case JDWP_TAG(FLOAT):
443             request-&gt;returnValue.f = JNI_FUNC_PTR(env,CallStaticFloatMethodA)(env,
444                                                        request-&gt;clazz,
445                                                        request-&gt;method,
446                                                        request-&gt;arguments);
447             break;
</pre>
<hr />
<pre>
480                                                        request-&gt;method,
481                                                        request-&gt;arguments);
482             break;
483 
484         case JDWP_TAG(VOID):
485             JNI_FUNC_PTR(env,CallStaticVoidMethodA)(env,
486                                           request-&gt;clazz,
487                                           request-&gt;method,
488                                           request-&gt;arguments);
489             break;
490 
491         default:
492             EXIT_ERROR(AGENT_ERROR_NULL_POINTER,&quot;Invalid method signature&quot;);
493             break;
494     }
495 }
496 
497 static void
498 invokeVirtual(JNIEnv *env, InvokeRequest *request)
499 {
<span class="line-modified">500     switch(returnTypeTag(request-&gt;methodSignature)) {</span>
<span class="line-modified">501         case JDWP_TAG(OBJECT):</span>
<span class="line-modified">502         case JDWP_TAG(ARRAY):</span>
<span class="line-modified">503         case JDWP_TAG(INLINE_OBJECT): {</span>
<span class="line-modified">504             jobject object;</span>
<span class="line-modified">505             JDI_ASSERT_MSG(request-&gt;instance, &quot;Request instance null&quot;);</span>
<span class="line-modified">506             object = JNI_FUNC_PTR(env,CallObjectMethodA)(env,</span>
<span class="line-modified">507                                  request-&gt;instance,</span>
<span class="line-modified">508                                  request-&gt;method,</span>
<span class="line-modified">509                                  request-&gt;arguments);</span>
<span class="line-modified">510             request-&gt;returnValue.l = NULL;</span>
<span class="line-removed">511             if (object != NULL) {</span>
<span class="line-removed">512                 saveGlobalRef(env, object, &amp;(request-&gt;returnValue.l));</span>
<span class="line-removed">513             }</span>
<span class="line-removed">514             break;</span>
515         }


516 

517         case JDWP_TAG(BYTE):
518             request-&gt;returnValue.b = JNI_FUNC_PTR(env,CallByteMethodA)(env,
519                                                  request-&gt;instance,
520                                                  request-&gt;method,
521                                                  request-&gt;arguments);
522             break;
523 
524         case JDWP_TAG(CHAR):
525             request-&gt;returnValue.c = JNI_FUNC_PTR(env,CallCharMethodA)(env,
526                                                  request-&gt;instance,
527                                                  request-&gt;method,
528                                                  request-&gt;arguments);
529             break;
530 
531         case JDWP_TAG(FLOAT):
532             request-&gt;returnValue.f = JNI_FUNC_PTR(env,CallFloatMethodA)(env,
533                                                  request-&gt;instance,
534                                                  request-&gt;method,
535                                                  request-&gt;arguments);
536             break;
</pre>
<hr />
<pre>
569                                                  request-&gt;method,
570                                                  request-&gt;arguments);
571             break;
572 
573         case JDWP_TAG(VOID):
574             JNI_FUNC_PTR(env,CallVoidMethodA)(env,
575                                     request-&gt;instance,
576                                     request-&gt;method,
577                                     request-&gt;arguments);
578             break;
579 
580         default:
581             EXIT_ERROR(AGENT_ERROR_NULL_POINTER,&quot;Invalid method signature&quot;);
582             break;
583     }
584 }
585 
586 static void
587 invokeNonvirtual(JNIEnv *env, InvokeRequest *request)
588 {
<span class="line-modified">589     switch(returnTypeTag(request-&gt;methodSignature)) {</span>
<span class="line-modified">590         case JDWP_TAG(OBJECT):</span>
<span class="line-modified">591         case JDWP_TAG(ARRAY):</span>
<span class="line-modified">592         case JDWP_TAG(INLINE_OBJECT): {</span>
<span class="line-modified">593             jobject object;</span>
<span class="line-modified">594             JDI_ASSERT_MSG(request-&gt;clazz, &quot;Request clazz null&quot;);</span>
<span class="line-modified">595             JDI_ASSERT_MSG(request-&gt;instance, &quot;Request instance null&quot;);</span>
<span class="line-modified">596             object = JNI_FUNC_PTR(env,CallNonvirtualObjectMethodA)(env,</span>
<span class="line-modified">597                                            request-&gt;instance,</span>
<span class="line-modified">598                                            request-&gt;clazz,</span>
<span class="line-modified">599                                            request-&gt;method,</span>
<span class="line-modified">600                                            request-&gt;arguments);</span>
<span class="line-modified">601             request-&gt;returnValue.l = NULL;</span>
<span class="line-removed">602             if (object != NULL) {</span>
<span class="line-removed">603                 saveGlobalRef(env, object, &amp;(request-&gt;returnValue.l));</span>
<span class="line-removed">604             }</span>
<span class="line-removed">605             break;</span>
606         }


607 

608         case JDWP_TAG(BYTE):
609             request-&gt;returnValue.b = JNI_FUNC_PTR(env,CallNonvirtualByteMethodA)(env,
610                                                  request-&gt;instance,
611                                                  request-&gt;clazz,
612                                                  request-&gt;method,
613                                                  request-&gt;arguments);
614             break;
615 
616         case JDWP_TAG(CHAR):
617             request-&gt;returnValue.c = JNI_FUNC_PTR(env,CallNonvirtualCharMethodA)(env,
618                                                  request-&gt;instance,
619                                                  request-&gt;clazz,
620                                                  request-&gt;method,
621                                                  request-&gt;arguments);
622             break;
623 
624         case JDWP_TAG(FLOAT):
625             request-&gt;returnValue.f = JNI_FUNC_PTR(env,CallNonvirtualFloatMethodA)(env,
626                                                  request-&gt;instance,
627                                                  request-&gt;clazz,
</pre>
<hr />
<pre>
786 
787     request-&gt;pending = JNI_FALSE;
788     request-&gt;started = JNI_FALSE;
789     request-&gt;available = JNI_TRUE; /* For next time around */
790 
791     detached = request-&gt;detached;
792     if (!detached) {
793         if (request-&gt;options &amp; JDWP_INVOKE_OPTIONS(SINGLE_THREADED)) {
794             (void)threadControl_suspendThread(thread, JNI_FALSE);
795         } else {
796             (void)threadControl_suspendAll();
797         }
798 
799         if (request-&gt;invokeType == INVOKE_CONSTRUCTOR) {
800             /*
801              * Although constructors technically have a return type of
802              * void, we return the object created.
803              */
804             tag = specificTypeKey(env, request-&gt;returnValue.l);
805         } else {
<span class="line-modified">806             tag = returnTypeTag(request-&gt;methodSignature);</span>
807         }
808         id = request-&gt;id;
809         exc = request-&gt;exception;
810         returnValue = request-&gt;returnValue;
811 
812         /* Release return value and exception references, but delay the release
813          * until after the return packet was sent. */

814         mustReleaseReturnValue = request-&gt;invokeType == INVOKE_CONSTRUCTOR ||
<span class="line-modified">815            returnTypeTag(request-&gt;methodSignature) == JDWP_TAG(OBJECT) ||</span>
<span class="line-removed">816            returnTypeTag(request-&gt;methodSignature) == JDWP_TAG(ARRAY)  ||</span>
<span class="line-removed">817 	   returnTypeTag(request-&gt;methodSignature) == JDWP_TAG(INLINE_OBJECT);</span>
818     }
819 
820     /*
821      * At this time, there&#39;s no need to retain global references on
822      * arguments since the reply is processed. No one will deal with
823      * this request ID anymore, so we must call deleteGlobalArgumentRefs().
824      *
825      * We cannot delete saved exception or return value references
826      * since otherwise a deleted handle would escape when writing
827      * the response to the stream. Instead, we clean those refs up
828      * after writing the respone.
829      */
830     deleteGlobalArgumentRefs(env, request);
831 
832     /* From now on, do not access the request structure anymore
833      * for this request id, because once we give up the invokerLock it may
834      * be immediately reused by a new invoke request.
835      */
836     request = NULL;
837 
</pre>
</td>
<td>
<hr />
<pre>
 11  * This code is distributed in the hope that it will be useful, but WITHOUT
 12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 14  * version 2 for more details (a copy is included in the LICENSE file that
 15  * accompanied this code).
 16  *
 17  * You should have received a copy of the GNU General Public License version
 18  * 2 along with this work; if not, write to the Free Software Foundation,
 19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 20  *
 21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 22  * or visit www.oracle.com if you need additional information or have any
 23  * questions.
 24  */
 25 
 26 #include &quot;util.h&quot;
 27 #include &quot;invoker.h&quot;
 28 #include &quot;eventHandler.h&quot;
 29 #include &quot;threadControl.h&quot;
 30 #include &quot;outStream.h&quot;
<span class="line-added"> 31 #include &quot;signature.h&quot;</span>
 32 
 33 static jrawMonitorID invokerLock;
 34 
 35 void
 36 invoker_initialize(void)
 37 {
 38     invokerLock = debugMonitorCreate(&quot;JDWP Invocation Lock&quot;);
 39 }
 40 
 41 void
 42 invoker_reset(void)
 43 {
 44 }
 45 
 46 void invoker_lock(void)
 47 {
 48     debugMonitorEnter(invokerLock);
 49 }
 50 
 51 void invoker_unlock(void)
 52 {
 53     debugMonitorExit(invokerLock);
 54 }
 55 











































 56 /*
 57  * Note: argument refs may be destroyed on out-of-memory error
 58  */
 59 static jvmtiError
 60 createGlobalRefs(JNIEnv *env, InvokeRequest *request)
 61 {
<span class="line-modified"> 62     jvmtiError error = JVMTI_ERROR_NONE;</span>
<span class="line-added"> 63     void *cursor = NULL;</span>
<span class="line-added"> 64     jbyte argumentTag = 0;</span>
<span class="line-added"> 65     jint argIndex = 0;</span>
<span class="line-added"> 66     jvalue *argument = request-&gt;arguments;</span>
 67     jclass clazz = NULL;
 68     jobject instance = NULL;




 69     jobject *argRefs = NULL;
 70 


 71     if ( request-&gt;argumentCount &gt; 0 ) {
 72         /*LINTED*/
 73         argRefs = jvmtiAllocate((jint)(request-&gt;argumentCount*sizeof(jobject)));
 74         if ( argRefs==NULL ) {
 75             error = AGENT_ERROR_OUT_OF_MEMORY;
 76         } else {
 77             /*LINTED*/
 78             (void)memset(argRefs, 0, request-&gt;argumentCount*sizeof(jobject));
 79         }
 80     }
 81 
 82     if ( error == JVMTI_ERROR_NONE ) {
 83         saveGlobalRef(env, request-&gt;clazz, &amp;clazz);
 84         if (clazz == NULL) {
 85             error = AGENT_ERROR_OUT_OF_MEMORY;
 86         }
 87     }
 88 
 89     if ( error == JVMTI_ERROR_NONE &amp;&amp; request-&gt;instance != NULL ) {
 90         saveGlobalRef(env, request-&gt;instance, &amp;instance);
 91         if (instance == NULL) {
 92             error = AGENT_ERROR_OUT_OF_MEMORY;
 93         }
 94     }
 95 
 96     if ( error == JVMTI_ERROR_NONE &amp;&amp; argRefs!=NULL ) {
<span class="line-modified"> 97         methodSignature_init(request-&gt;methodSignature, &amp;cursor);</span>
<span class="line-modified"> 98         while (methodSignature_nextArgumentExists(&amp;cursor, &amp;argumentTag)) {</span>


 99             if ( argIndex &gt; request-&gt;argumentCount ) {
100                 break;
101             }
<span class="line-modified">102             if (isReferenceTag(argumentTag)) {</span>


103                 /* Create a global ref for any non-null argument */
104                 if (argument-&gt;l != NULL) {
105                     saveGlobalRef(env, argument-&gt;l, &amp;argRefs[argIndex]);
106                     if (argRefs[argIndex] == NULL) {
107                         error = AGENT_ERROR_OUT_OF_MEMORY;
108                         break;
109                     }
110                 }
111             }
112             argument++;
113             argIndex++;

114         }
115     }
116 
117 #ifdef FIXUP /* Why isn&#39;t this an error? */
118     /* Make sure the argument count matches */
119     if ( error == JVMTI_ERROR_NONE &amp;&amp; argIndex != request-&gt;argumentCount ) {
120         error = AGENT_ERROR_INVALID_COUNT;
121     }
122 #endif
123 
124     /* Finally, put the global refs into the request if no errors */
125     if ( error == JVMTI_ERROR_NONE ) {
126         request-&gt;clazz = clazz;
127         request-&gt;instance = instance;
128         if ( argRefs!=NULL ) {
129             argIndex = 0;
<span class="line-modified">130             methodSignature_init(request-&gt;methodSignature, &amp;cursor);</span>
131             argument = request-&gt;arguments;
<span class="line-modified">132             while ( methodSignature_nextArgumentExists(&amp;cursor, &amp;argumentTag) &amp;&amp;</span>
<span class="line-modified">133                    argIndex &lt; request-&gt;argumentCount ) {</span>
<span class="line-modified">134                 if ( isReferenceTag(argumentTag) ) {</span>

135                     argument-&gt;l = argRefs[argIndex];
136                 }
137                 argument++;
138                 argIndex++;

139             }
140             jvmtiDeallocate(argRefs);
141         }
142         return JVMTI_ERROR_NONE;
143 
144     } else {
145         /* Delete global references */
146         if ( clazz != NULL ) {
147             tossGlobalRef(env, &amp;clazz);
148         }
149         if ( instance != NULL ) {
150             tossGlobalRef(env, &amp;instance);
151         }
152         if ( argRefs!=NULL ) {
153             for ( argIndex=0; argIndex &lt; request-&gt;argumentCount; argIndex++ ) {
154                 if ( argRefs[argIndex] != NULL ) {
155                     tossGlobalRef(env, &amp;argRefs[argIndex]);
156                 }
157             }
158             jvmtiDeallocate(argRefs);
159         }
160     }
161 
162     return error;
163 }
164 
165 /*
166  * Delete global argument references from the request which got put there before a
167  * invoke request was carried out. See fillInvokeRequest().
168  */
169 static void
170 deleteGlobalArgumentRefs(JNIEnv *env, InvokeRequest *request)
171 {
<span class="line-modified">172     void *cursor = NULL;</span>
173     jint argIndex = 0;
<span class="line-added">174     jbyte argumentTag = 0;</span>
175     jvalue *argument = request-&gt;arguments;
<span class="line-modified">176     methodSignature_init(request-&gt;methodSignature, &amp;cursor);</span>
177 
178     if (request-&gt;clazz != NULL) {
179         tossGlobalRef(env, &amp;(request-&gt;clazz));
180     }
181     if (request-&gt;instance != NULL) {
182         tossGlobalRef(env, &amp;(request-&gt;instance));
183     }
184     /* Delete global argument references */
<span class="line-modified">185     while (methodSignature_nextArgumentExists(&amp;cursor, &amp;argumentTag) &amp;&amp;</span>
<span class="line-modified">186            argIndex &lt; request-&gt;argumentCount) {</span>
<span class="line-modified">187         if (isReferenceTag(argumentTag)) {</span>

188             if (argument-&gt;l != NULL) {
189                 tossGlobalRef(env, &amp;(argument-&gt;l));
190             }
191         }
192         argument++;
193         argIndex++;

194     }
195 }
196 
197 static jvmtiError
198 fillInvokeRequest(JNIEnv *env, InvokeRequest *request,
199                   jbyte invokeType, jbyte options, jint id,
200                   jthread thread, jclass clazz, jmethodID method,
201                   jobject instance,
202                   jvalue *arguments, jint argumentCount)
203 {
204     jvmtiError error;
205     if (!request-&gt;available) {
206         /*
207          * Thread is not at a point where it can invoke.
208          */
209         return AGENT_ERROR_INVALID_THREAD;
210     }
211     if (request-&gt;pending) {
212         /*
213          * Pending invoke
</pre>
<hr />
<pre>
338 }
339 
340 static void
341 invokeConstructor(JNIEnv *env, InvokeRequest *request)
342 {
343     jobject object;
344 
345     JDI_ASSERT_MSG(request-&gt;clazz, &quot;Request clazz null&quot;);
346     object = JNI_FUNC_PTR(env,NewObjectA)(env, request-&gt;clazz,
347                                      request-&gt;method,
348                                      request-&gt;arguments);
349     request-&gt;returnValue.l = NULL;
350     if (object != NULL) {
351         saveGlobalRef(env, object, &amp;(request-&gt;returnValue.l));
352     }
353 }
354 
355 static void
356 invokeStatic(JNIEnv *env, InvokeRequest *request)
357 {
<span class="line-modified">358     jbyte returnType = methodSignature_returnTag(request-&gt;methodSignature);</span>
<span class="line-modified">359 </span>
<span class="line-modified">360     if (isReferenceTag(returnType)) {</span>
<span class="line-modified">361         jobject object;</span>
<span class="line-modified">362         JDI_ASSERT_MSG(request-&gt;clazz, &quot;Request clazz null&quot;);</span>
<span class="line-modified">363         object = JNI_FUNC_PTR(env,CallStaticObjectMethodA)(env,</span>
<span class="line-modified">364                                    request-&gt;clazz,</span>
<span class="line-modified">365                                    request-&gt;method,</span>
<span class="line-modified">366                                    request-&gt;arguments);</span>
<span class="line-modified">367         request-&gt;returnValue.l = NULL;</span>
<span class="line-modified">368         if (object != NULL) {</span>
<span class="line-modified">369             saveGlobalRef(env, object, &amp;(request-&gt;returnValue.l));</span>



370         }
<span class="line-added">371         return;</span>
<span class="line-added">372     }</span>
373 
<span class="line-modified">374     switch (returnType) {</span>
375         case JDWP_TAG(BYTE):
376             request-&gt;returnValue.b = JNI_FUNC_PTR(env,CallStaticByteMethodA)(env,
377                                                        request-&gt;clazz,
378                                                        request-&gt;method,
379                                                        request-&gt;arguments);
380             break;
381 
382         case JDWP_TAG(CHAR):
383             request-&gt;returnValue.c = JNI_FUNC_PTR(env,CallStaticCharMethodA)(env,
384                                                        request-&gt;clazz,
385                                                        request-&gt;method,
386                                                        request-&gt;arguments);
387             break;
388 
389         case JDWP_TAG(FLOAT):
390             request-&gt;returnValue.f = JNI_FUNC_PTR(env,CallStaticFloatMethodA)(env,
391                                                        request-&gt;clazz,
392                                                        request-&gt;method,
393                                                        request-&gt;arguments);
394             break;
</pre>
<hr />
<pre>
427                                                        request-&gt;method,
428                                                        request-&gt;arguments);
429             break;
430 
431         case JDWP_TAG(VOID):
432             JNI_FUNC_PTR(env,CallStaticVoidMethodA)(env,
433                                           request-&gt;clazz,
434                                           request-&gt;method,
435                                           request-&gt;arguments);
436             break;
437 
438         default:
439             EXIT_ERROR(AGENT_ERROR_NULL_POINTER,&quot;Invalid method signature&quot;);
440             break;
441     }
442 }
443 
444 static void
445 invokeVirtual(JNIEnv *env, InvokeRequest *request)
446 {
<span class="line-modified">447     jbyte returnType = methodSignature_returnTag(request-&gt;methodSignature);</span>
<span class="line-modified">448     if (isReferenceTag(returnType)) {</span>
<span class="line-modified">449         jobject object;</span>
<span class="line-modified">450         JDI_ASSERT_MSG(request-&gt;instance, &quot;Request instance null&quot;);</span>
<span class="line-modified">451         object = JNI_FUNC_PTR(env,CallObjectMethodA)(env,</span>
<span class="line-modified">452                              request-&gt;instance,</span>
<span class="line-modified">453                              request-&gt;method,</span>
<span class="line-modified">454                              request-&gt;arguments);</span>
<span class="line-modified">455         request-&gt;returnValue.l = NULL;</span>
<span class="line-modified">456         if (object != NULL) {</span>
<span class="line-modified">457             saveGlobalRef(env, object, &amp;(request-&gt;returnValue.l));</span>




458         }
<span class="line-added">459         return;</span>
<span class="line-added">460     }</span>
461 
<span class="line-added">462     switch (returnType) {</span>
463         case JDWP_TAG(BYTE):
464             request-&gt;returnValue.b = JNI_FUNC_PTR(env,CallByteMethodA)(env,
465                                                  request-&gt;instance,
466                                                  request-&gt;method,
467                                                  request-&gt;arguments);
468             break;
469 
470         case JDWP_TAG(CHAR):
471             request-&gt;returnValue.c = JNI_FUNC_PTR(env,CallCharMethodA)(env,
472                                                  request-&gt;instance,
473                                                  request-&gt;method,
474                                                  request-&gt;arguments);
475             break;
476 
477         case JDWP_TAG(FLOAT):
478             request-&gt;returnValue.f = JNI_FUNC_PTR(env,CallFloatMethodA)(env,
479                                                  request-&gt;instance,
480                                                  request-&gt;method,
481                                                  request-&gt;arguments);
482             break;
</pre>
<hr />
<pre>
515                                                  request-&gt;method,
516                                                  request-&gt;arguments);
517             break;
518 
519         case JDWP_TAG(VOID):
520             JNI_FUNC_PTR(env,CallVoidMethodA)(env,
521                                     request-&gt;instance,
522                                     request-&gt;method,
523                                     request-&gt;arguments);
524             break;
525 
526         default:
527             EXIT_ERROR(AGENT_ERROR_NULL_POINTER,&quot;Invalid method signature&quot;);
528             break;
529     }
530 }
531 
532 static void
533 invokeNonvirtual(JNIEnv *env, InvokeRequest *request)
534 {
<span class="line-modified">535     jbyte returnType = methodSignature_returnTag(request-&gt;methodSignature);</span>
<span class="line-modified">536     if (isReferenceTag(returnType)) {</span>
<span class="line-modified">537         jobject object;</span>
<span class="line-modified">538         JDI_ASSERT_MSG(request-&gt;clazz, &quot;Request clazz null&quot;);</span>
<span class="line-modified">539         JDI_ASSERT_MSG(request-&gt;instance, &quot;Request instance null&quot;);</span>
<span class="line-modified">540         object = JNI_FUNC_PTR(env,CallNonvirtualObjectMethodA)(env,</span>
<span class="line-modified">541                                        request-&gt;instance,</span>
<span class="line-modified">542                                        request-&gt;clazz,</span>
<span class="line-modified">543                                        request-&gt;method,</span>
<span class="line-modified">544                                        request-&gt;arguments);</span>
<span class="line-modified">545         request-&gt;returnValue.l = NULL;</span>
<span class="line-modified">546         if (object != NULL) {</span>
<span class="line-modified">547             saveGlobalRef(env, object, &amp;(request-&gt;returnValue.l));</span>




548         }
<span class="line-added">549         return;</span>
<span class="line-added">550     }</span>
551 
<span class="line-added">552     switch (returnType) {</span>
553         case JDWP_TAG(BYTE):
554             request-&gt;returnValue.b = JNI_FUNC_PTR(env,CallNonvirtualByteMethodA)(env,
555                                                  request-&gt;instance,
556                                                  request-&gt;clazz,
557                                                  request-&gt;method,
558                                                  request-&gt;arguments);
559             break;
560 
561         case JDWP_TAG(CHAR):
562             request-&gt;returnValue.c = JNI_FUNC_PTR(env,CallNonvirtualCharMethodA)(env,
563                                                  request-&gt;instance,
564                                                  request-&gt;clazz,
565                                                  request-&gt;method,
566                                                  request-&gt;arguments);
567             break;
568 
569         case JDWP_TAG(FLOAT):
570             request-&gt;returnValue.f = JNI_FUNC_PTR(env,CallNonvirtualFloatMethodA)(env,
571                                                  request-&gt;instance,
572                                                  request-&gt;clazz,
</pre>
<hr />
<pre>
731 
732     request-&gt;pending = JNI_FALSE;
733     request-&gt;started = JNI_FALSE;
734     request-&gt;available = JNI_TRUE; /* For next time around */
735 
736     detached = request-&gt;detached;
737     if (!detached) {
738         if (request-&gt;options &amp; JDWP_INVOKE_OPTIONS(SINGLE_THREADED)) {
739             (void)threadControl_suspendThread(thread, JNI_FALSE);
740         } else {
741             (void)threadControl_suspendAll();
742         }
743 
744         if (request-&gt;invokeType == INVOKE_CONSTRUCTOR) {
745             /*
746              * Although constructors technically have a return type of
747              * void, we return the object created.
748              */
749             tag = specificTypeKey(env, request-&gt;returnValue.l);
750         } else {
<span class="line-modified">751             tag = methodSignature_returnTag(request-&gt;methodSignature);</span>
752         }
753         id = request-&gt;id;
754         exc = request-&gt;exception;
755         returnValue = request-&gt;returnValue;
756 
757         /* Release return value and exception references, but delay the release
758          * until after the return packet was sent. */
<span class="line-added">759         jbyte returnType = methodSignature_returnTag(request-&gt;methodSignature);</span>
760         mustReleaseReturnValue = request-&gt;invokeType == INVOKE_CONSTRUCTOR ||
<span class="line-modified">761            isReferenceTag(returnType);</span>


762     }
763 
764     /*
765      * At this time, there&#39;s no need to retain global references on
766      * arguments since the reply is processed. No one will deal with
767      * this request ID anymore, so we must call deleteGlobalArgumentRefs().
768      *
769      * We cannot delete saved exception or return value references
770      * since otherwise a deleted handle would escape when writing
771      * the response to the stream. Instead, we clean those refs up
772      * after writing the respone.
773      */
774     deleteGlobalArgumentRefs(env, request);
775 
776     /* From now on, do not access the request structure anymore
777      * for this request id, because once we give up the invokerLock it may
778      * be immediately reused by a new invoke request.
779      */
780     request = NULL;
781 
</pre>
</td>
</tr>
</table>
<center><a href="inStream.h.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="util.c.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>