<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff src/jdk.jdwp.agent/share/native/libjdwp/util.c</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
<body>
<center><a href="invoker.c.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="util.h.udiff.html" target="_top">next &gt;</a></center>    <h2>src/jdk.jdwp.agent/share/native/libjdwp/util.c</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -1,7 +1,7 @@</span>
  /*
<span class="udiff-line-modified-removed">-  * Copyright (c) 1998, 2019, Oracle and/or its affiliates. All rights reserved.</span>
<span class="udiff-line-modified-added">+  * Copyright (c) 1998, 2020, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.  Oracle designates this
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -30,10 +30,12 @@</span>
  #include &quot;eventHandler.h&quot;
  #include &quot;threadControl.h&quot;
  #include &quot;outStream.h&quot;
  #include &quot;inStream.h&quot;
  #include &quot;invoker.h&quot;
<span class="udiff-line-added">+ #include &quot;signature.h&quot;</span>
<span class="udiff-line-added">+ </span>
  
  /* Global data area */
  BackendGlobalData *gdata = NULL;
  
  /* Forward declarations */
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -169,10 +171,12 @@</span>
          EXIT_ERROR(AGENT_ERROR_NULL_POINTER,NULL);
      }
      return method;
  }
  
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ </span>
  void
  util_initialize(JNIEnv *env)
  {
      WITH_LOCAL_REFS(env, 6) {
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -342,31 +346,28 @@</span>
      error = fieldSignature(clazz, field, NULL, &amp;signature, NULL);
      if (error != JVMTI_ERROR_NONE) {
          outStream_setError(out, map2jdwpError(error));
          return;
      }
<span class="udiff-line-modified-removed">-     typeKey = signature[0];</span>
<span class="udiff-line-modified-added">+     typeKey = jdwpTag(signature);</span>
      jvmtiDeallocate(signature);
  
<span class="udiff-line-added">+     if (isReferenceTag(typeKey)) {</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         jobject value = JNI_FUNC_PTR(env,GetObjectField)(env, object, field);</span>
<span class="udiff-line-added">+         (void)outStream_writeByte(out, specificTypeKey(env, value));</span>
<span class="udiff-line-added">+         (void)outStream_writeObjectRef(env, out, value);</span>
<span class="udiff-line-added">+         return;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
      /*
<span class="udiff-line-modified-removed">-      * For primitive types, the type key is bounced back as is. Objects</span>
<span class="udiff-line-removed">-      * are handled in the switch statement below.</span>
<span class="udiff-line-modified-added">+      * For primitive types, the type key is bounced back as is.</span>
       */
<span class="udiff-line-modified-removed">-     if ((typeKey != JDWP_TAG(OBJECT)) &amp;&amp; (typeKey != JDWP_TAG(ARRAY)) &amp;&amp; (typeKey != JDWP_TAG(INLINE_OBJECT))) {</span>
<span class="udiff-line-removed">-         (void)outStream_writeByte(out, typeKey);</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-modified-added">+     (void)outStream_writeByte(out, typeKey);</span>
  
      switch (typeKey) {
<span class="udiff-line-removed">-         case JDWP_TAG(OBJECT):</span>
<span class="udiff-line-removed">-         case JDWP_TAG(ARRAY):</span>
<span class="udiff-line-removed">-         case JDWP_TAG(INLINE_OBJECT): {</span>
<span class="udiff-line-removed">-             jobject value = JNI_FUNC_PTR(env,GetObjectField)(env, object, field);</span>
<span class="udiff-line-removed">-             (void)outStream_writeByte(out, specificTypeKey(env, value));</span>
<span class="udiff-line-removed">-             (void)outStream_writeObjectRef(env, out, value);</span>
<span class="udiff-line-removed">-             break;</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">- </span>
          case JDWP_TAG(BYTE):
              (void)outStream_writeByte(out,
                        JNI_FUNC_PTR(env,GetByteField)(env, object, field));
              break;
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -418,31 +419,28 @@</span>
      error = fieldSignature(clazz, field, NULL, &amp;signature, NULL);
      if (error != JVMTI_ERROR_NONE) {
          outStream_setError(out, map2jdwpError(error));
          return;
      }
<span class="udiff-line-modified-removed">-     typeKey = signature[0];</span>
<span class="udiff-line-modified-added">+     typeKey = jdwpTag(signature);</span>
      jvmtiDeallocate(signature);
  
<span class="udiff-line-modified-removed">-     /*</span>
<span class="udiff-line-modified-removed">-      * For primitive types, the type key is bounced back as is. Objects</span>
<span class="udiff-line-modified-removed">-      * are handled in the switch statement below.</span>
<span class="udiff-line-modified-removed">-      */</span>
<span class="udiff-line-modified-removed">-     if ((typeKey != JDWP_TAG(OBJECT)) &amp;&amp; (typeKey != JDWP_TAG(ARRAY)) &amp;&amp; (typeKey != JDWP_TAG(INLINE_OBJECT))) {</span>
<span class="udiff-line-modified-removed">-         (void)outStream_writeByte(out, typeKey);</span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-modified-added">+     if (isReferenceTag(typeKey)) {</span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-modified-added">+         jobject value = JNI_FUNC_PTR(env,GetStaticObjectField)(env, clazz, field);</span>
<span class="udiff-line-modified-added">+         (void)outStream_writeByte(out, specificTypeKey(env, value));</span>
<span class="udiff-line-modified-added">+         (void)outStream_writeObjectRef(env, out, value);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         return;</span>
      }
  
<span class="udiff-line-added">+     /*</span>
<span class="udiff-line-added">+      * For primitive types, the type key is bounced back as is.</span>
<span class="udiff-line-added">+      */</span>
<span class="udiff-line-added">+     (void)outStream_writeByte(out, typeKey);</span>
      switch (typeKey) {
<span class="udiff-line-removed">-         case JDWP_TAG(OBJECT):</span>
<span class="udiff-line-removed">-         case JDWP_TAG(ARRAY):</span>
<span class="udiff-line-removed">-         case JDWP_TAG(INLINE_OBJECT): {</span>
<span class="udiff-line-removed">-             jobject value = JNI_FUNC_PTR(env,GetStaticObjectField)(env, clazz, field);</span>
<span class="udiff-line-removed">-             (void)outStream_writeByte(out, specificTypeKey(env, value));</span>
<span class="udiff-line-removed">-             (void)outStream_writeObjectRef(env, out, value);</span>
<span class="udiff-line-removed">-             break;</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">- </span>
          case JDWP_TAG(BYTE):
              (void)outStream_writeByte(out,
                        JNI_FUNC_PTR(env,GetStaticByteField)(env, clazz, field));
              break;
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -571,11 +569,11 @@</span>
          if (arguments == NULL) {
              outStream_setError(out, JDWP_ERROR(OUT_OF_MEMORY));
              return JNI_TRUE;
          }
          for (i = 0; (i &lt; argumentCount) &amp;&amp; !inStream_error(in); i++) {
<span class="udiff-line-modified-removed">-             arguments[i] = inStream_readValue(in, NULL);</span>
<span class="udiff-line-modified-added">+             arguments[i] = inStream_readValue(in);</span>
          }
          if (inStream_error(in)) {
              return JNI_TRUE;
          }
      }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -978,36 +976,10 @@</span>
  {
      return JVMTI_FUNC_PTR(gdata-&gt;jvmti,GetSourceDebugExtension)
                  (gdata-&gt;jvmti, clazz, extensionPtr);
  }
  
<span class="udiff-line-removed">- /*</span>
<span class="udiff-line-removed">-  * Convert the signature &quot;Ljava/lang/Foo;&quot; to a</span>
<span class="udiff-line-removed">-  * classname &quot;java.lang.Foo&quot; compatible with the pattern.</span>
<span class="udiff-line-removed">-  * Signature is overwritten in-place.</span>
<span class="udiff-line-removed">-  */</span>
<span class="udiff-line-removed">- void</span>
<span class="udiff-line-removed">- convertSignatureToClassname(char *convert)</span>
<span class="udiff-line-removed">- {</span>
<span class="udiff-line-removed">-     char *p;</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     p = convert + 1;</span>
<span class="udiff-line-removed">-     while ((*p != &#39;;&#39;) &amp;&amp; (*p != &#39;\0&#39;)) {</span>
<span class="udiff-line-removed">-         char c = *p;</span>
<span class="udiff-line-removed">-         if (c == &#39;/&#39;) {</span>
<span class="udiff-line-removed">-             *(p-1) = &#39;.&#39;;</span>
<span class="udiff-line-removed">-         } else if (c == &#39;.&#39;) {</span>
<span class="udiff-line-removed">-             // class signature of a hidden class is &quot;Ljava/lang/Foo.1234;&quot;</span>
<span class="udiff-line-removed">-             // map to &quot;java.lang.Foo/1234&quot;</span>
<span class="udiff-line-removed">-             *(p-1) = &#39;/&#39;;</span>
<span class="udiff-line-removed">-         } else {</span>
<span class="udiff-line-removed">-             *(p-1) = c;</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">-         p++;</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">-     *(p-1) = &#39;\0&#39;;</span>
<span class="udiff-line-removed">- }</span>
  
  static void
  handleInterrupt(void)
  {
      /*
</pre>
<center><a href="invoker.c.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="util.h.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>