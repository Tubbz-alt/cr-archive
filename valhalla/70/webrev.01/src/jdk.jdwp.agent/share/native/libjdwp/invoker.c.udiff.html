<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff src/jdk.jdwp.agent/share/native/libjdwp/invoker.c</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
<body>
<center><a href="inStream.h.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="util.c.udiff.html" target="_top">next &gt;</a></center>    <h2>src/jdk.jdwp.agent/share/native/libjdwp/invoker.c</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -26,10 +26,11 @@</span>
  #include &quot;util.h&quot;
  #include &quot;invoker.h&quot;
  #include &quot;eventHandler.h&quot;
  #include &quot;threadControl.h&quot;
  #include &quot;outStream.h&quot;
<span class="udiff-line-added">+ #include &quot;signature.h&quot;</span>
  
  static jrawMonitorID invokerLock;
  
  void
  invoker_initialize(void)
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -50,70 +51,25 @@</span>
  void invoker_unlock(void)
  {
      debugMonitorExit(invokerLock);
  }
  
<span class="udiff-line-removed">- static jbyte</span>
<span class="udiff-line-removed">- returnTypeTag(char *signature)</span>
<span class="udiff-line-removed">- {</span>
<span class="udiff-line-removed">-     char *tagPtr = strchr(signature, SIGNATURE_END_ARGS);</span>
<span class="udiff-line-removed">-     JDI_ASSERT(tagPtr);</span>
<span class="udiff-line-removed">-     tagPtr++;    /* 1st character after the end of args */</span>
<span class="udiff-line-removed">-     return (jbyte)*tagPtr;</span>
<span class="udiff-line-removed">- }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">- static jbyte</span>
<span class="udiff-line-removed">- nextArgumentTypeTag(void **cursor)</span>
<span class="udiff-line-removed">- {</span>
<span class="udiff-line-removed">-     char *tagPtr = *cursor;</span>
<span class="udiff-line-removed">-     jbyte argumentTag = (jbyte)*tagPtr;</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     if (*tagPtr != SIGNATURE_END_ARGS) {</span>
<span class="udiff-line-removed">-         /* Skip any array modifiers */</span>
<span class="udiff-line-removed">-         while (*tagPtr == JDWP_TAG(ARRAY)) {</span>
<span class="udiff-line-removed">-             tagPtr++;</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">-         /* Skip class name */</span>
<span class="udiff-line-removed">-         if (*tagPtr == JDWP_TAG(OBJECT)) {</span>
<span class="udiff-line-removed">-             tagPtr = strchr(tagPtr, SIGNATURE_END_CLASS) + 1;</span>
<span class="udiff-line-removed">-             JDI_ASSERT(tagPtr);</span>
<span class="udiff-line-removed">-         } else {</span>
<span class="udiff-line-removed">-             /* Skip primitive sig */</span>
<span class="udiff-line-removed">-             tagPtr++;</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     *cursor = tagPtr;</span>
<span class="udiff-line-removed">-     return argumentTag;</span>
<span class="udiff-line-removed">- }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">- static jbyte</span>
<span class="udiff-line-removed">- firstArgumentTypeTag(char *signature, void **cursor)</span>
<span class="udiff-line-removed">- {</span>
<span class="udiff-line-removed">-     JDI_ASSERT(signature[0] == SIGNATURE_BEGIN_ARGS);</span>
<span class="udiff-line-removed">-     *cursor = signature + 1; /* skip to the first arg */</span>
<span class="udiff-line-removed">-     return nextArgumentTypeTag(cursor);</span>
<span class="udiff-line-removed">- }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">- </span>
  /*
   * Note: argument refs may be destroyed on out-of-memory error
   */
  static jvmtiError
  createGlobalRefs(JNIEnv *env, InvokeRequest *request)
  {
<span class="udiff-line-modified-removed">-     jvmtiError error;</span>
<span class="udiff-line-modified-added">+     jvmtiError error = JVMTI_ERROR_NONE;</span>
<span class="udiff-line-added">+     void *cursor = NULL;</span>
<span class="udiff-line-added">+     jbyte argumentTag = 0;</span>
<span class="udiff-line-added">+     jint argIndex = 0;</span>
<span class="udiff-line-added">+     jvalue *argument = request-&gt;arguments;</span>
      jclass clazz = NULL;
      jobject instance = NULL;
<span class="udiff-line-removed">-     jint argIndex;</span>
<span class="udiff-line-removed">-     jbyte argumentTag;</span>
<span class="udiff-line-removed">-     jvalue *argument;</span>
<span class="udiff-line-removed">-     void *cursor;</span>
      jobject *argRefs = NULL;
  
<span class="udiff-line-removed">-     error = JVMTI_ERROR_NONE;</span>
<span class="udiff-line-removed">- </span>
      if ( request-&gt;argumentCount &gt; 0 ) {
          /*LINTED*/
          argRefs = jvmtiAllocate((jint)(request-&gt;argumentCount*sizeof(jobject)));
          if ( argRefs==NULL ) {
              error = AGENT_ERROR_OUT_OF_MEMORY;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -136,20 +92,16 @@</span>
              error = AGENT_ERROR_OUT_OF_MEMORY;
          }
      }
  
      if ( error == JVMTI_ERROR_NONE &amp;&amp; argRefs!=NULL ) {
<span class="udiff-line-modified-removed">-         argIndex = 0;</span>
<span class="udiff-line-modified-removed">-         argumentTag = firstArgumentTypeTag(request-&gt;methodSignature, &amp;cursor);</span>
<span class="udiff-line-removed">-         argument = request-&gt;arguments;</span>
<span class="udiff-line-removed">-         while (argumentTag != SIGNATURE_END_ARGS) {</span>
<span class="udiff-line-modified-added">+         methodSignature_init(request-&gt;methodSignature, &amp;cursor);</span>
<span class="udiff-line-modified-added">+         while (methodSignature_nextArgumentExists(&amp;cursor, &amp;argumentTag)) {</span>
              if ( argIndex &gt; request-&gt;argumentCount ) {
                  break;
              }
<span class="udiff-line-modified-removed">-             if ((argumentTag == JDWP_TAG(OBJECT)) ||</span>
<span class="udiff-line-removed">-                 (argumentTag == JDWP_TAG(ARRAY))  ||</span>
<span class="udiff-line-removed">- 		(argumentTag == JDWP_TAG(INLINE_OBJECT))) {</span>
<span class="udiff-line-modified-added">+             if (isReferenceTag(argumentTag)) {</span>
                  /* Create a global ref for any non-null argument */
                  if (argument-&gt;l != NULL) {
                      saveGlobalRef(env, argument-&gt;l, &amp;argRefs[argIndex]);
                      if (argRefs[argIndex] == NULL) {
                          error = AGENT_ERROR_OUT_OF_MEMORY;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -157,11 +109,10 @@</span>
                      }
                  }
              }
              argument++;
              argIndex++;
<span class="udiff-line-removed">-             argumentTag = nextArgumentTypeTag(&amp;cursor);</span>
          }
      }
  
  #ifdef FIXUP /* Why isn&#39;t this an error? */
      /* Make sure the argument count matches */
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -174,21 +125,19 @@</span>
      if ( error == JVMTI_ERROR_NONE ) {
          request-&gt;clazz = clazz;
          request-&gt;instance = instance;
          if ( argRefs!=NULL ) {
              argIndex = 0;
<span class="udiff-line-modified-removed">-             argumentTag = firstArgumentTypeTag(request-&gt;methodSignature, &amp;cursor);</span>
<span class="udiff-line-modified-added">+             methodSignature_init(request-&gt;methodSignature, &amp;cursor);</span>
              argument = request-&gt;arguments;
<span class="udiff-line-modified-removed">-             while ( argIndex &lt; request-&gt;argumentCount ) {</span>
<span class="udiff-line-modified-removed">-                 if ((argumentTag == JDWP_TAG(OBJECT)) ||</span>
<span class="udiff-line-modified-removed">-                     (argumentTag == JDWP_TAG(ARRAY))  ||</span>
<span class="udiff-line-removed">- 		    (argumentTag == JDWP_TAG(INLINE_OBJECT))) {</span>
<span class="udiff-line-modified-added">+             while ( methodSignature_nextArgumentExists(&amp;cursor, &amp;argumentTag) &amp;&amp;</span>
<span class="udiff-line-modified-added">+                    argIndex &lt; request-&gt;argumentCount ) {</span>
<span class="udiff-line-modified-added">+                 if ( isReferenceTag(argumentTag) ) {</span>
                      argument-&gt;l = argRefs[argIndex];
                  }
                  argument++;
                  argIndex++;
<span class="udiff-line-removed">-                 argumentTag = nextArgumentTypeTag(&amp;cursor);</span>
              }
              jvmtiDeallocate(argRefs);
          }
          return JVMTI_ERROR_NONE;
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -218,33 +167,32 @@</span>
   * invoke request was carried out. See fillInvokeRequest().
   */
  static void
  deleteGlobalArgumentRefs(JNIEnv *env, InvokeRequest *request)
  {
<span class="udiff-line-modified-removed">-     void *cursor;</span>
<span class="udiff-line-modified-added">+     void *cursor = NULL;</span>
      jint argIndex = 0;
<span class="udiff-line-added">+     jbyte argumentTag = 0;</span>
      jvalue *argument = request-&gt;arguments;
<span class="udiff-line-modified-removed">-     jbyte argumentTag = firstArgumentTypeTag(request-&gt;methodSignature, &amp;cursor);</span>
<span class="udiff-line-modified-added">+     methodSignature_init(request-&gt;methodSignature, &amp;cursor);</span>
  
      if (request-&gt;clazz != NULL) {
          tossGlobalRef(env, &amp;(request-&gt;clazz));
      }
      if (request-&gt;instance != NULL) {
          tossGlobalRef(env, &amp;(request-&gt;instance));
      }
      /* Delete global argument references */
<span class="udiff-line-modified-removed">-     while (argIndex &lt; request-&gt;argumentCount) {</span>
<span class="udiff-line-modified-removed">-         if ((argumentTag == JDWP_TAG(OBJECT)) ||</span>
<span class="udiff-line-modified-removed">-             (argumentTag == JDWP_TAG(ARRAY))  ||</span>
<span class="udiff-line-removed">- 	    (argumentTag == JDWP_TAG(INLINE_OBJECT))) {</span>
<span class="udiff-line-modified-added">+     while (methodSignature_nextArgumentExists(&amp;cursor, &amp;argumentTag) &amp;&amp;</span>
<span class="udiff-line-modified-added">+            argIndex &lt; request-&gt;argumentCount) {</span>
<span class="udiff-line-modified-added">+         if (isReferenceTag(argumentTag)) {</span>
              if (argument-&gt;l != NULL) {
                  tossGlobalRef(env, &amp;(argument-&gt;l));
              }
          }
          argument++;
          argIndex++;
<span class="udiff-line-removed">-         argumentTag = nextArgumentTypeTag(&amp;cursor);</span>
      }
  }
  
  static jvmtiError
  fillInvokeRequest(JNIEnv *env, InvokeRequest *request,
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -405,28 +353,27 @@</span>
  }
  
  static void
  invokeStatic(JNIEnv *env, InvokeRequest *request)
  {
<span class="udiff-line-modified-removed">-     switch(returnTypeTag(request-&gt;methodSignature)) {</span>
<span class="udiff-line-modified-removed">-         case JDWP_TAG(OBJECT):</span>
<span class="udiff-line-modified-removed">-         case JDWP_TAG(ARRAY):</span>
<span class="udiff-line-modified-removed">-         case JDWP_TAG(INLINE_OBJECT): {</span>
<span class="udiff-line-modified-removed">-             jobject object;</span>
<span class="udiff-line-modified-removed">-             JDI_ASSERT_MSG(request-&gt;clazz, &quot;Request clazz null&quot;);</span>
<span class="udiff-line-modified-removed">-             object = JNI_FUNC_PTR(env,CallStaticObjectMethodA)(env,</span>
<span class="udiff-line-modified-removed">-                                        request-&gt;clazz,</span>
<span class="udiff-line-modified-removed">-                                        request-&gt;method,</span>
<span class="udiff-line-modified-removed">-                                        request-&gt;arguments);</span>
<span class="udiff-line-modified-removed">-             request-&gt;returnValue.l = NULL;</span>
<span class="udiff-line-modified-removed">-             if (object != NULL) {</span>
<span class="udiff-line-removed">-                 saveGlobalRef(env, object, &amp;(request-&gt;returnValue.l));</span>
<span class="udiff-line-removed">-             }</span>
<span class="udiff-line-removed">-             break;</span>
<span class="udiff-line-modified-added">+     jbyte returnType = methodSignature_returnTag(request-&gt;methodSignature);</span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-modified-added">+     if (isReferenceTag(returnType)) {</span>
<span class="udiff-line-modified-added">+         jobject object;</span>
<span class="udiff-line-modified-added">+         JDI_ASSERT_MSG(request-&gt;clazz, &quot;Request clazz null&quot;);</span>
<span class="udiff-line-modified-added">+         object = JNI_FUNC_PTR(env,CallStaticObjectMethodA)(env,</span>
<span class="udiff-line-modified-added">+                                    request-&gt;clazz,</span>
<span class="udiff-line-modified-added">+                                    request-&gt;method,</span>
<span class="udiff-line-modified-added">+                                    request-&gt;arguments);</span>
<span class="udiff-line-modified-added">+         request-&gt;returnValue.l = NULL;</span>
<span class="udiff-line-modified-added">+         if (object != NULL) {</span>
<span class="udiff-line-modified-added">+             saveGlobalRef(env, object, &amp;(request-&gt;returnValue.l));</span>
          }
<span class="udiff-line-added">+         return;</span>
<span class="udiff-line-added">+     }</span>
  
<span class="udiff-line-modified-removed">- </span>
<span class="udiff-line-modified-added">+     switch (returnType) {</span>
          case JDWP_TAG(BYTE):
              request-&gt;returnValue.b = JNI_FUNC_PTR(env,CallStaticByteMethodA)(env,
                                                         request-&gt;clazz,
                                                         request-&gt;method,
                                                         request-&gt;arguments);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -495,27 +442,26 @@</span>
  }
  
  static void
  invokeVirtual(JNIEnv *env, InvokeRequest *request)
  {
<span class="udiff-line-modified-removed">-     switch(returnTypeTag(request-&gt;methodSignature)) {</span>
<span class="udiff-line-modified-removed">-         case JDWP_TAG(OBJECT):</span>
<span class="udiff-line-modified-removed">-         case JDWP_TAG(ARRAY):</span>
<span class="udiff-line-modified-removed">-         case JDWP_TAG(INLINE_OBJECT): {</span>
<span class="udiff-line-modified-removed">-             jobject object;</span>
<span class="udiff-line-modified-removed">-             JDI_ASSERT_MSG(request-&gt;instance, &quot;Request instance null&quot;);</span>
<span class="udiff-line-modified-removed">-             object = JNI_FUNC_PTR(env,CallObjectMethodA)(env,</span>
<span class="udiff-line-modified-removed">-                                  request-&gt;instance,</span>
<span class="udiff-line-modified-removed">-                                  request-&gt;method,</span>
<span class="udiff-line-modified-removed">-                                  request-&gt;arguments);</span>
<span class="udiff-line-modified-removed">-             request-&gt;returnValue.l = NULL;</span>
<span class="udiff-line-removed">-             if (object != NULL) {</span>
<span class="udiff-line-removed">-                 saveGlobalRef(env, object, &amp;(request-&gt;returnValue.l));</span>
<span class="udiff-line-removed">-             }</span>
<span class="udiff-line-removed">-             break;</span>
<span class="udiff-line-modified-added">+     jbyte returnType = methodSignature_returnTag(request-&gt;methodSignature);</span>
<span class="udiff-line-modified-added">+     if (isReferenceTag(returnType)) {</span>
<span class="udiff-line-modified-added">+         jobject object;</span>
<span class="udiff-line-modified-added">+         JDI_ASSERT_MSG(request-&gt;instance, &quot;Request instance null&quot;);</span>
<span class="udiff-line-modified-added">+         object = JNI_FUNC_PTR(env,CallObjectMethodA)(env,</span>
<span class="udiff-line-modified-added">+                              request-&gt;instance,</span>
<span class="udiff-line-modified-added">+                              request-&gt;method,</span>
<span class="udiff-line-modified-added">+                              request-&gt;arguments);</span>
<span class="udiff-line-modified-added">+         request-&gt;returnValue.l = NULL;</span>
<span class="udiff-line-modified-added">+         if (object != NULL) {</span>
<span class="udiff-line-modified-added">+             saveGlobalRef(env, object, &amp;(request-&gt;returnValue.l));</span>
          }
<span class="udiff-line-added">+         return;</span>
<span class="udiff-line-added">+     }</span>
  
<span class="udiff-line-added">+     switch (returnType) {</span>
          case JDWP_TAG(BYTE):
              request-&gt;returnValue.b = JNI_FUNC_PTR(env,CallByteMethodA)(env,
                                                   request-&gt;instance,
                                                   request-&gt;method,
                                                   request-&gt;arguments);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -584,29 +530,28 @@</span>
  }
  
  static void
  invokeNonvirtual(JNIEnv *env, InvokeRequest *request)
  {
<span class="udiff-line-modified-removed">-     switch(returnTypeTag(request-&gt;methodSignature)) {</span>
<span class="udiff-line-modified-removed">-         case JDWP_TAG(OBJECT):</span>
<span class="udiff-line-modified-removed">-         case JDWP_TAG(ARRAY):</span>
<span class="udiff-line-modified-removed">-         case JDWP_TAG(INLINE_OBJECT): {</span>
<span class="udiff-line-modified-removed">-             jobject object;</span>
<span class="udiff-line-modified-removed">-             JDI_ASSERT_MSG(request-&gt;clazz, &quot;Request clazz null&quot;);</span>
<span class="udiff-line-modified-removed">-             JDI_ASSERT_MSG(request-&gt;instance, &quot;Request instance null&quot;);</span>
<span class="udiff-line-modified-removed">-             object = JNI_FUNC_PTR(env,CallNonvirtualObjectMethodA)(env,</span>
<span class="udiff-line-modified-removed">-                                            request-&gt;instance,</span>
<span class="udiff-line-modified-removed">-                                            request-&gt;clazz,</span>
<span class="udiff-line-modified-removed">-                                            request-&gt;method,</span>
<span class="udiff-line-modified-removed">-                                            request-&gt;arguments);</span>
<span class="udiff-line-modified-removed">-             request-&gt;returnValue.l = NULL;</span>
<span class="udiff-line-removed">-             if (object != NULL) {</span>
<span class="udiff-line-removed">-                 saveGlobalRef(env, object, &amp;(request-&gt;returnValue.l));</span>
<span class="udiff-line-removed">-             }</span>
<span class="udiff-line-removed">-             break;</span>
<span class="udiff-line-modified-added">+     jbyte returnType = methodSignature_returnTag(request-&gt;methodSignature);</span>
<span class="udiff-line-modified-added">+     if (isReferenceTag(returnType)) {</span>
<span class="udiff-line-modified-added">+         jobject object;</span>
<span class="udiff-line-modified-added">+         JDI_ASSERT_MSG(request-&gt;clazz, &quot;Request clazz null&quot;);</span>
<span class="udiff-line-modified-added">+         JDI_ASSERT_MSG(request-&gt;instance, &quot;Request instance null&quot;);</span>
<span class="udiff-line-modified-added">+         object = JNI_FUNC_PTR(env,CallNonvirtualObjectMethodA)(env,</span>
<span class="udiff-line-modified-added">+                                        request-&gt;instance,</span>
<span class="udiff-line-modified-added">+                                        request-&gt;clazz,</span>
<span class="udiff-line-modified-added">+                                        request-&gt;method,</span>
<span class="udiff-line-modified-added">+                                        request-&gt;arguments);</span>
<span class="udiff-line-modified-added">+         request-&gt;returnValue.l = NULL;</span>
<span class="udiff-line-modified-added">+         if (object != NULL) {</span>
<span class="udiff-line-modified-added">+             saveGlobalRef(env, object, &amp;(request-&gt;returnValue.l));</span>
          }
<span class="udiff-line-added">+         return;</span>
<span class="udiff-line-added">+     }</span>
  
<span class="udiff-line-added">+     switch (returnType) {</span>
          case JDWP_TAG(BYTE):
              request-&gt;returnValue.b = JNI_FUNC_PTR(env,CallNonvirtualByteMethodA)(env,
                                                   request-&gt;instance,
                                                   request-&gt;clazz,
                                                   request-&gt;method,
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -801,22 +746,21 @@</span>
               * Although constructors technically have a return type of
               * void, we return the object created.
               */
              tag = specificTypeKey(env, request-&gt;returnValue.l);
          } else {
<span class="udiff-line-modified-removed">-             tag = returnTypeTag(request-&gt;methodSignature);</span>
<span class="udiff-line-modified-added">+             tag = methodSignature_returnTag(request-&gt;methodSignature);</span>
          }
          id = request-&gt;id;
          exc = request-&gt;exception;
          returnValue = request-&gt;returnValue;
  
          /* Release return value and exception references, but delay the release
           * until after the return packet was sent. */
<span class="udiff-line-added">+         jbyte returnType = methodSignature_returnTag(request-&gt;methodSignature);</span>
          mustReleaseReturnValue = request-&gt;invokeType == INVOKE_CONSTRUCTOR ||
<span class="udiff-line-modified-removed">-            returnTypeTag(request-&gt;methodSignature) == JDWP_TAG(OBJECT) ||</span>
<span class="udiff-line-removed">-            returnTypeTag(request-&gt;methodSignature) == JDWP_TAG(ARRAY)  ||</span>
<span class="udiff-line-removed">- 	   returnTypeTag(request-&gt;methodSignature) == JDWP_TAG(INLINE_OBJECT);</span>
<span class="udiff-line-modified-added">+            isReferenceTag(returnType);</span>
      }
  
      /*
       * At this time, there&#39;s no need to retain global references on
       * arguments since the reply is processed. No one will deal with
</pre>
<center><a href="inStream.h.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="util.c.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>