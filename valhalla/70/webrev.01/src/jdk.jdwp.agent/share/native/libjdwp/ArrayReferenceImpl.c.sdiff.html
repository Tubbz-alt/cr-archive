<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/jdk.jdwp.agent/share/native/libjdwp/ArrayReferenceImpl.c</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
<body>
<center><a href="../../../../jdk.jdi/share/classes/com/sun/tools/jdi/VoidValueImpl.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="ArrayTypeImpl.c.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/jdk.jdwp.agent/share/native/libjdwp/ArrayReferenceImpl.c</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 10  *
 11  * This code is distributed in the hope that it will be useful, but WITHOUT
 12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 14  * version 2 for more details (a copy is included in the LICENSE file that
 15  * accompanied this code).
 16  *
 17  * You should have received a copy of the GNU General Public License version
 18  * 2 along with this work; if not, write to the Free Software Foundation,
 19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 20  *
 21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 22  * or visit www.oracle.com if you need additional information or have any
 23  * questions.
 24  */
 25 
 26 #include &quot;util.h&quot;
 27 #include &quot;ArrayReferenceImpl.h&quot;
 28 #include &quot;inStream.h&quot;
 29 #include &quot;outStream.h&quot;

 30 
 31 static jboolean
 32 length(PacketInputStream *in, PacketOutputStream *out)
 33 {
 34     JNIEnv *env = getEnv();
 35     jsize arrayLength;
 36 
 37     jarray  array = inStream_readArrayRef(env, in);
 38     if (inStream_error(in)) {
 39         return JNI_TRUE;
 40     }
 41 
 42     arrayLength = JNI_FUNC_PTR(env,GetArrayLength)(env, array);
 43     (void)outStream_writeInt(out, arrayLength);
 44     return JNI_TRUE;
 45 }
 46 
 47 static void *
 48 newComponents(PacketOutputStream *out, jint length, size_t nbytes)
 49 {
</pre>
<hr />
<pre>
187 
188 static void
189 writeDoubleComponents(JNIEnv *env, PacketOutputStream *out,
190                     jarray array, jint index, jint length)
191 {
192     jdouble *components;
193 
194     components = newComponents(out, length, sizeof(jdouble));
195     if (components != NULL) {
196         jint i;
197         JNI_FUNC_PTR(env,GetDoubleArrayRegion)(env, array, index, length, components);
198         for (i = 0; i &lt; length; i++) {
199             (void)outStream_writeDouble(out, components[i]);
200         }
201         deleteComponents(components);
202     }
203 }
204 
205 static void
206 writeObjectComponents(JNIEnv *env, PacketOutputStream *out,
<span class="line-modified">207                     jarray array, jint index, jint length)</span>
208 {
209 
210     WITH_LOCAL_REFS(env, length) {
211 
212         int i;
213         jobject component;
214 
215         for (i = 0; i &lt; length; i++) {
216             component = JNI_FUNC_PTR(env,GetObjectArrayElement)(env, array, index + i);
217             if (JNI_FUNC_PTR(env,ExceptionOccurred)(env)) {
218                 /* cleared by caller */
219                 break;
220             }
221             (void)outStream_writeByte(out, specificTypeKey(env, component));
222             (void)outStream_writeObjectRef(env, out, component);
223         }
224 
225     } END_WITH_LOCAL_REFS(env);
226 }
227 



228 static jboolean
229 getValues(PacketInputStream *in, PacketOutputStream *out)
230 {
231     JNIEnv *env = getEnv();
232     jint arrayLength;
233     jarray array;
234     jint index;
235     jint length;
236 
237     array = inStream_readArrayRef(env, in);
238     if (inStream_error(in)) {
239         return JNI_TRUE;
240     }
241     index = inStream_readInt(in);
242     if (inStream_error(in)) {
243         return JNI_TRUE;
244     }
245     length = inStream_readInt(in);
246     if (inStream_error(in)) {
247         return JNI_TRUE;
248     }
249 
250     arrayLength = JNI_FUNC_PTR(env,GetArrayLength)(env, array);
251 
252     if (length == -1) {
253         length = arrayLength - index;
254     }
255 
256     if ((index &lt; 0) || (index &gt; arrayLength - 1)) {
257         outStream_setError(out, JDWP_ERROR(INVALID_INDEX));
258         return JNI_TRUE;
259     }
260 
261     if ((length &lt; 0) || (length + index &gt; arrayLength)) {
262         outStream_setError(out, JDWP_ERROR(INVALID_LENGTH));
263         return JNI_TRUE;
264     }
265 
266     WITH_LOCAL_REFS(env, 1) {
267 
<span class="line-removed">268         jclass arrayClass;</span>
269         char *signature = NULL;
<span class="line-removed">270         char *componentSignature;</span>
<span class="line-removed">271         jbyte typeKey;</span>
<span class="line-removed">272         jvmtiError error;</span>
<span class="line-removed">273 </span>
<span class="line-removed">274         arrayClass = JNI_FUNC_PTR(env,GetObjectClass)(env, array);</span>
<span class="line-removed">275         error = classSignature(arrayClass, &amp;signature, NULL);</span>
<span class="line-removed">276         if (error != JVMTI_ERROR_NONE) {</span>
<span class="line-removed">277             goto err;</span>
<span class="line-removed">278         }</span>
<span class="line-removed">279         componentSignature = &amp;signature[1];</span>
<span class="line-removed">280         typeKey = componentSignature[0];</span>
281 
<span class="line-modified">282         (void)outStream_writeByte(out, typeKey);</span>
<span class="line-modified">283         (void)outStream_writeInt(out, length);</span>
<span class="line-modified">284 </span>
<span class="line-modified">285         if (isObjectTag(typeKey)) {</span>
<span class="line-modified">286             writeObjectComponents(env, out, array, index, length);</span>
<span class="line-removed">287         } else {</span>
<span class="line-removed">288             switch (typeKey) {</span>
<span class="line-removed">289                 case JDWP_TAG(BYTE):</span>
<span class="line-removed">290                     writeByteComponents(env, out, array, index, length);</span>
<span class="line-removed">291                     break;</span>
<span class="line-removed">292 </span>
<span class="line-removed">293                 case JDWP_TAG(CHAR):</span>
<span class="line-removed">294                     writeCharComponents(env, out, array, index, length);</span>
<span class="line-removed">295                     break;</span>
<span class="line-removed">296 </span>
<span class="line-removed">297                 case JDWP_TAG(FLOAT):</span>
<span class="line-removed">298                     writeFloatComponents(env, out, array, index, length);</span>
<span class="line-removed">299                     break;</span>
<span class="line-removed">300 </span>
<span class="line-removed">301                 case JDWP_TAG(DOUBLE):</span>
<span class="line-removed">302                     writeDoubleComponents(env, out, array, index, length);</span>
<span class="line-removed">303                     break;</span>
<span class="line-removed">304 </span>
<span class="line-removed">305                 case JDWP_TAG(INT):</span>
<span class="line-removed">306                     writeIntComponents(env, out, array, index, length);</span>
<span class="line-removed">307                     break;</span>
<span class="line-removed">308 </span>
<span class="line-removed">309                 case JDWP_TAG(LONG):</span>
<span class="line-removed">310                     writeLongComponents(env, out, array, index, length);</span>
<span class="line-removed">311                     break;</span>
<span class="line-removed">312 </span>
<span class="line-removed">313                 case JDWP_TAG(SHORT):</span>
<span class="line-removed">314                     writeShortComponents(env, out, array, index, length);</span>
<span class="line-removed">315                     break;</span>
<span class="line-removed">316 </span>
<span class="line-removed">317                 case JDWP_TAG(BOOLEAN):</span>
<span class="line-removed">318                     writeBooleanComponents(env, out, array, index, length);</span>
<span class="line-removed">319                     break;</span>
<span class="line-removed">320 </span>
<span class="line-removed">321                 default:</span>
<span class="line-removed">322                     outStream_setError(out, JDWP_ERROR(INVALID_TAG));</span>
<span class="line-removed">323                     break;</span>
<span class="line-removed">324             }</span>
325         }
326 
<span class="line-removed">327         jvmtiDeallocate(signature);</span>
<span class="line-removed">328 </span>
<span class="line-removed">329     err:;</span>
<span class="line-removed">330 </span>
331     } END_WITH_LOCAL_REFS(env);
332 
333     if (JNI_FUNC_PTR(env,ExceptionOccurred)(env)) {
334         outStream_setError(out, JDWP_ERROR(INTERNAL));
335         JNI_FUNC_PTR(env,ExceptionClear)(env);
336     }
337 
338     return JNI_TRUE;
339 }
340 




















































341 static jdwpError
342 readBooleanComponents(JNIEnv *env, PacketInputStream *in,
343                    jarray array, int index, int length)
344 {
345     int i;
346     jboolean component;
347 
348     for (i = 0; (i &lt; length) &amp;&amp; !inStream_error(in); i++) {
349         component = inStream_readBoolean(in);
350         JNI_FUNC_PTR(env,SetBooleanArrayRegion)(env, array, index + i, 1, &amp;component);
351     }
352     return inStream_error(in);
353 }
354 
355 static jdwpError
356 readByteComponents(JNIEnv *env, PacketInputStream *in,
357                    jarray array, int index, int length)
358 {
359     int i;
360     jbyte component;
</pre>
<hr />
<pre>
460 static jdwpError
461 readObjectComponents(JNIEnv *env, PacketInputStream *in,
462                    jarray array, int index, int length)
463                    /* char *componentSignature) */
464 {
465     int i;
466 
467     for (i = 0; i &lt; length; i++) {
468         jobject object = inStream_readObjectRef(env, in);
469 
470         JNI_FUNC_PTR(env,SetObjectArrayElement)(env, array, index + i, object);
471         if (JNI_FUNC_PTR(env,ExceptionOccurred)(env)) {
472             /* caller will clear */
473             break;
474         }
475     }
476 
477     return JDWP_ERROR(NONE);
478 }
479 


480 
481 static jboolean
482 setValues(PacketInputStream *in, PacketOutputStream *out)
483 {
484     JNIEnv *env = getEnv();
485     jdwpError serror = JDWP_ERROR(NONE);
486     int arrayLength;
487     jarray array;
488     jint index;
489     jint length;
490 
491     array = inStream_readArrayRef(env, in);
492     if (inStream_error(in)) {
493         return JNI_TRUE;
494     }
495     index = inStream_readInt(in);
496     if (inStream_error(in)) {
497         return JNI_TRUE;
498     }
499     length = inStream_readInt(in);
500     if (inStream_error(in)) {
501         return JNI_TRUE;
502     }
503 
504     arrayLength = JNI_FUNC_PTR(env,GetArrayLength)(env, array);
505 
506     if ((index &lt; 0) || (index &gt; arrayLength - 1)) {
507         outStream_setError(out, JDWP_ERROR(INVALID_INDEX));
508         return JNI_TRUE;
509     }
510 
511     if ((length &lt; 0) || (length + index &gt; arrayLength)) {
512         outStream_setError(out, JDWP_ERROR(INVALID_LENGTH));
513         return JNI_TRUE;
514     }
515 
516     WITH_LOCAL_REFS(env, 1)  {
517 
<span class="line-removed">518         jclass arrayClass;</span>
519         char *signature = NULL;
<span class="line-removed">520         char *componentSignature;</span>
<span class="line-removed">521         jvmtiError error;</span>
522 
<span class="line-modified">523         arrayClass = JNI_FUNC_PTR(env,GetObjectClass)(env, array);</span>
<span class="line-modified">524         error = classSignature(arrayClass, &amp;signature, NULL);</span>
<span class="line-modified">525         if (error != JVMTI_ERROR_NONE) {</span>
<span class="line-modified">526             goto err;</span>

527         }
<span class="line-modified">528         componentSignature = &amp;signature[1];</span>
<span class="line-removed">529 </span>
<span class="line-removed">530         switch (componentSignature[0]) {</span>
<span class="line-removed">531             case JDWP_TAG(OBJECT):</span>
<span class="line-removed">532             case JDWP_TAG(ARRAY):</span>
<span class="line-removed">533             case JDWP_TAG(INLINE_OBJECT):</span>
<span class="line-removed">534                 serror = readObjectComponents(env, in, array, index, length);</span>
<span class="line-removed">535                 break;</span>
<span class="line-removed">536 </span>
<span class="line-removed">537             case JDWP_TAG(BYTE):</span>
<span class="line-removed">538                 serror = readByteComponents(env, in, array, index, length);</span>
<span class="line-removed">539                 break;</span>
540 
<span class="line-modified">541             case JDWP_TAG(CHAR):</span>
<span class="line-modified">542                 serror = readCharComponents(env, in, array, index, length);</span>
<span class="line-modified">543                 break;</span>




544 
<span class="line-modified">545             case JDWP_TAG(FLOAT):</span>
<span class="line-modified">546                 serror = readFloatComponents(env, in, array, index, length);</span>
<span class="line-modified">547                 break;</span>
548 
<span class="line-modified">549             case JDWP_TAG(DOUBLE):</span>
<span class="line-modified">550                 serror = readDoubleComponents(env, in, array, index, length);</span>
<span class="line-modified">551                 break;</span>
552 
<span class="line-modified">553             case JDWP_TAG(INT):</span>
<span class="line-modified">554                 serror = readIntComponents(env, in, array, index, length);</span>
<span class="line-modified">555                 break;</span>







556 
<span class="line-modified">557             case JDWP_TAG(LONG):</span>
<span class="line-modified">558                 serror = readLongComponents(env, in, array, index, length);</span>
<span class="line-modified">559                 break;</span>
560 
<span class="line-modified">561             case JDWP_TAG(SHORT):</span>
<span class="line-modified">562                 serror = readShortComponents(env, in, array, index, length);</span>
<span class="line-modified">563                 break;</span>
564 
<span class="line-modified">565             case JDWP_TAG(BOOLEAN):</span>
<span class="line-modified">566                 serror = readBooleanComponents(env, in, array, index, length);</span>
<span class="line-modified">567                 break;</span>
568 
<span class="line-modified">569             default:</span>
<span class="line-modified">570                 {</span>
<span class="line-modified">571                     ERROR_MESSAGE((&quot;Invalid array component signature: %s&quot;,</span>
<span class="line-removed">572                                         componentSignature));</span>
<span class="line-removed">573                     EXIT_ERROR(AGENT_ERROR_INVALID_OBJECT,NULL);</span>
<span class="line-removed">574                 }</span>
<span class="line-removed">575                 break;</span>
<span class="line-removed">576         }</span>
577 
<span class="line-modified">578         jvmtiDeallocate(signature);</span>


579 
<span class="line-modified">580     err:;</span>


581 
<span class="line-modified">582     } END_WITH_LOCAL_REFS(env);</span>


583 
<span class="line-modified">584     if (JNI_FUNC_PTR(env,ExceptionOccurred)(env)) {</span>
<span class="line-modified">585         /*</span>
<span class="line-modified">586          * TO DO: Check exception type</span>
<span class="line-modified">587          */</span>
<span class="line-modified">588         serror = JDWP_ERROR(TYPE_MISMATCH);</span>
<span class="line-modified">589         JNI_FUNC_PTR(env,ExceptionClear)(env);</span>

590     }
591 
<span class="line-modified">592     outStream_setError(out, serror);</span>
<span class="line-removed">593     return JNI_TRUE;</span>
594 }
595 
596 Command ArrayReference_Commands[] = {
597     {length, &quot;Length&quot;},
598     {getValues, &quot;GetValues&quot;},
599     {setValues, &quot;SetValues&quot;}
600 };
601 
602 DEBUG_DISPATCH_DEFINE_CMDSET(ArrayReference)
</pre>
</td>
<td>
<hr />
<pre>
 10  *
 11  * This code is distributed in the hope that it will be useful, but WITHOUT
 12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 14  * version 2 for more details (a copy is included in the LICENSE file that
 15  * accompanied this code).
 16  *
 17  * You should have received a copy of the GNU General Public License version
 18  * 2 along with this work; if not, write to the Free Software Foundation,
 19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 20  *
 21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 22  * or visit www.oracle.com if you need additional information or have any
 23  * questions.
 24  */
 25 
 26 #include &quot;util.h&quot;
 27 #include &quot;ArrayReferenceImpl.h&quot;
 28 #include &quot;inStream.h&quot;
 29 #include &quot;outStream.h&quot;
<span class="line-added"> 30 #include &quot;signature.h&quot;</span>
 31 
 32 static jboolean
 33 length(PacketInputStream *in, PacketOutputStream *out)
 34 {
 35     JNIEnv *env = getEnv();
 36     jsize arrayLength;
 37 
 38     jarray  array = inStream_readArrayRef(env, in);
 39     if (inStream_error(in)) {
 40         return JNI_TRUE;
 41     }
 42 
 43     arrayLength = JNI_FUNC_PTR(env,GetArrayLength)(env, array);
 44     (void)outStream_writeInt(out, arrayLength);
 45     return JNI_TRUE;
 46 }
 47 
 48 static void *
 49 newComponents(PacketOutputStream *out, jint length, size_t nbytes)
 50 {
</pre>
<hr />
<pre>
188 
189 static void
190 writeDoubleComponents(JNIEnv *env, PacketOutputStream *out,
191                     jarray array, jint index, jint length)
192 {
193     jdouble *components;
194 
195     components = newComponents(out, length, sizeof(jdouble));
196     if (components != NULL) {
197         jint i;
198         JNI_FUNC_PTR(env,GetDoubleArrayRegion)(env, array, index, length, components);
199         for (i = 0; i &lt; length; i++) {
200             (void)outStream_writeDouble(out, components[i]);
201         }
202         deleteComponents(components);
203     }
204 }
205 
206 static void
207 writeObjectComponents(JNIEnv *env, PacketOutputStream *out,
<span class="line-modified">208                       jarray array, jint index, jint length)</span>
209 {
210 
211     WITH_LOCAL_REFS(env, length) {
212 
213         int i;
214         jobject component;
215 
216         for (i = 0; i &lt; length; i++) {
217             component = JNI_FUNC_PTR(env,GetObjectArrayElement)(env, array, index + i);
218             if (JNI_FUNC_PTR(env,ExceptionOccurred)(env)) {
219                 /* cleared by caller */
220                 break;
221             }
222             (void)outStream_writeByte(out, specificTypeKey(env, component));
223             (void)outStream_writeObjectRef(env, out, component);
224         }
225 
226     } END_WITH_LOCAL_REFS(env);
227 }
228 
<span class="line-added">229 static void writeComponents(JNIEnv *env, PacketOutputStream *out, char *signature,</span>
<span class="line-added">230                             jarray array, jint index, jint length);</span>
<span class="line-added">231 </span>
232 static jboolean
233 getValues(PacketInputStream *in, PacketOutputStream *out)
234 {
235     JNIEnv *env = getEnv();
236     jint arrayLength;
237     jarray array;
238     jint index;
239     jint length;
240 
241     array = inStream_readArrayRef(env, in);
242     if (inStream_error(in)) {
243         return JNI_TRUE;
244     }
245     index = inStream_readInt(in);
246     if (inStream_error(in)) {
247         return JNI_TRUE;
248     }
249     length = inStream_readInt(in);
250     if (inStream_error(in)) {
251         return JNI_TRUE;
252     }
253 
254     arrayLength = JNI_FUNC_PTR(env,GetArrayLength)(env, array);
255 
256     if (length == -1) {
257         length = arrayLength - index;
258     }
259 
260     if ((index &lt; 0) || (index &gt; arrayLength - 1)) {
261         outStream_setError(out, JDWP_ERROR(INVALID_INDEX));
262         return JNI_TRUE;
263     }
264 
265     if ((length &lt; 0) || (length + index &gt; arrayLength)) {
266         outStream_setError(out, JDWP_ERROR(INVALID_LENGTH));
267         return JNI_TRUE;
268     }
269 
270     WITH_LOCAL_REFS(env, 1) {
271 

272         char *signature = NULL;











273 
<span class="line-modified">274         jclass arrayClass = JNI_FUNC_PTR(env,GetObjectClass)(env, array);</span>
<span class="line-modified">275         jvmtiError error = classSignature(arrayClass, &amp;signature, NULL);</span>
<span class="line-modified">276         if (error == JVMTI_ERROR_NONE) {</span>
<span class="line-modified">277             writeComponents(env, out, signature, array, index, length);</span>
<span class="line-modified">278             jvmtiDeallocate(signature);</span>






































279         }
280 




281     } END_WITH_LOCAL_REFS(env);
282 
283     if (JNI_FUNC_PTR(env,ExceptionOccurred)(env)) {
284         outStream_setError(out, JDWP_ERROR(INTERNAL));
285         JNI_FUNC_PTR(env,ExceptionClear)(env);
286     }
287 
288     return JNI_TRUE;
289 }
290 
<span class="line-added">291 static void writeComponents(JNIEnv *env, PacketOutputStream *out, char *signature,</span>
<span class="line-added">292                             jarray array, jint index, jint length) {</span>
<span class="line-added">293 </span>
<span class="line-added">294     char * componentSignature = componentTypeSignature(signature);</span>
<span class="line-added">295     jbyte typeKey = jdwpTag(componentSignature);</span>
<span class="line-added">296 </span>
<span class="line-added">297     (void)outStream_writeByte(out, typeKey);</span>
<span class="line-added">298     (void)outStream_writeInt(out, length);</span>
<span class="line-added">299 </span>
<span class="line-added">300     if (isReferenceTag(typeKey)) {</span>
<span class="line-added">301         writeObjectComponents(env, out, array, index, length);</span>
<span class="line-added">302         return;</span>
<span class="line-added">303     }</span>
<span class="line-added">304     switch (typeKey) {</span>
<span class="line-added">305         case JDWP_TAG(BYTE):</span>
<span class="line-added">306             writeByteComponents(env, out, array, index, length);</span>
<span class="line-added">307             break;</span>
<span class="line-added">308 </span>
<span class="line-added">309         case JDWP_TAG(CHAR):</span>
<span class="line-added">310             writeCharComponents(env, out, array, index, length);</span>
<span class="line-added">311             break;</span>
<span class="line-added">312 </span>
<span class="line-added">313         case JDWP_TAG(FLOAT):</span>
<span class="line-added">314             writeFloatComponents(env, out, array, index, length);</span>
<span class="line-added">315             break;</span>
<span class="line-added">316 </span>
<span class="line-added">317         case JDWP_TAG(DOUBLE):</span>
<span class="line-added">318             writeDoubleComponents(env, out, array, index, length);</span>
<span class="line-added">319             break;</span>
<span class="line-added">320 </span>
<span class="line-added">321         case JDWP_TAG(INT):</span>
<span class="line-added">322             writeIntComponents(env, out, array, index, length);</span>
<span class="line-added">323             break;</span>
<span class="line-added">324 </span>
<span class="line-added">325         case JDWP_TAG(LONG):</span>
<span class="line-added">326             writeLongComponents(env, out, array, index, length);</span>
<span class="line-added">327             break;</span>
<span class="line-added">328 </span>
<span class="line-added">329         case JDWP_TAG(SHORT):</span>
<span class="line-added">330             writeShortComponents(env, out, array, index, length);</span>
<span class="line-added">331             break;</span>
<span class="line-added">332 </span>
<span class="line-added">333         case JDWP_TAG(BOOLEAN):</span>
<span class="line-added">334             writeBooleanComponents(env, out, array, index, length);</span>
<span class="line-added">335             break;</span>
<span class="line-added">336 </span>
<span class="line-added">337         default:</span>
<span class="line-added">338             outStream_setError(out, JDWP_ERROR(INVALID_TAG));</span>
<span class="line-added">339             break;</span>
<span class="line-added">340     }</span>
<span class="line-added">341 }</span>
<span class="line-added">342 </span>
343 static jdwpError
344 readBooleanComponents(JNIEnv *env, PacketInputStream *in,
345                    jarray array, int index, int length)
346 {
347     int i;
348     jboolean component;
349 
350     for (i = 0; (i &lt; length) &amp;&amp; !inStream_error(in); i++) {
351         component = inStream_readBoolean(in);
352         JNI_FUNC_PTR(env,SetBooleanArrayRegion)(env, array, index + i, 1, &amp;component);
353     }
354     return inStream_error(in);
355 }
356 
357 static jdwpError
358 readByteComponents(JNIEnv *env, PacketInputStream *in,
359                    jarray array, int index, int length)
360 {
361     int i;
362     jbyte component;
</pre>
<hr />
<pre>
462 static jdwpError
463 readObjectComponents(JNIEnv *env, PacketInputStream *in,
464                    jarray array, int index, int length)
465                    /* char *componentSignature) */
466 {
467     int i;
468 
469     for (i = 0; i &lt; length; i++) {
470         jobject object = inStream_readObjectRef(env, in);
471 
472         JNI_FUNC_PTR(env,SetObjectArrayElement)(env, array, index + i, object);
473         if (JNI_FUNC_PTR(env,ExceptionOccurred)(env)) {
474             /* caller will clear */
475             break;
476         }
477     }
478 
479     return JDWP_ERROR(NONE);
480 }
481 
<span class="line-added">482 static jdwpError readComponents(JNIEnv *env, PacketInputStream *in, char *signature,</span>
<span class="line-added">483                                 jarray array, jint index, jint length);</span>
484 
485 static jboolean
486 setValues(PacketInputStream *in, PacketOutputStream *out)
487 {
488     JNIEnv *env = getEnv();
489     jdwpError serror = JDWP_ERROR(NONE);
490     int arrayLength;
491     jarray array;
492     jint index;
493     jint length;
494 
495     array = inStream_readArrayRef(env, in);
496     if (inStream_error(in)) {
497         return JNI_TRUE;
498     }
499     index = inStream_readInt(in);
500     if (inStream_error(in)) {
501         return JNI_TRUE;
502     }
503     length = inStream_readInt(in);
504     if (inStream_error(in)) {
505         return JNI_TRUE;
506     }
507 
508     arrayLength = JNI_FUNC_PTR(env,GetArrayLength)(env, array);
509 
510     if ((index &lt; 0) || (index &gt; arrayLength - 1)) {
511         outStream_setError(out, JDWP_ERROR(INVALID_INDEX));
512         return JNI_TRUE;
513     }
514 
515     if ((length &lt; 0) || (length + index &gt; arrayLength)) {
516         outStream_setError(out, JDWP_ERROR(INVALID_LENGTH));
517         return JNI_TRUE;
518     }
519 
520     WITH_LOCAL_REFS(env, 1)  {
521 

522         char *signature = NULL;


523 
<span class="line-modified">524         jclass arrayClass = JNI_FUNC_PTR(env,GetObjectClass)(env, array);</span>
<span class="line-modified">525         jvmtiError error = classSignature(arrayClass, &amp;signature, NULL);</span>
<span class="line-modified">526         if (error == JVMTI_ERROR_NONE) {</span>
<span class="line-modified">527             serror = readComponents(env, in, signature, array, index, length);</span>
<span class="line-added">528             jvmtiDeallocate(signature);</span>
529         }
<span class="line-modified">530     } END_WITH_LOCAL_REFS(env);</span>











531 
<span class="line-modified">532     if (JNI_FUNC_PTR(env,ExceptionOccurred)(env)) {</span>
<span class="line-modified">533         /*</span>
<span class="line-modified">534          * TO DO: Check exception type</span>
<span class="line-added">535          */</span>
<span class="line-added">536         serror = JDWP_ERROR(TYPE_MISMATCH);</span>
<span class="line-added">537         JNI_FUNC_PTR(env,ExceptionClear)(env);</span>
<span class="line-added">538     }</span>
539 
<span class="line-modified">540     outStream_setError(out, serror);</span>
<span class="line-modified">541     return JNI_TRUE;</span>
<span class="line-modified">542 }</span>
543 
<span class="line-modified">544 static jdwpError readComponents(JNIEnv *env, PacketInputStream *in, char *signature,</span>
<span class="line-modified">545 jarray array, jint index, jint length) {</span>
<span class="line-modified">546     jdwpError serror = JDWP_ERROR(NONE);</span>
547 
<span class="line-modified">548     char *componentSignature = componentTypeSignature(signature);</span>
<span class="line-modified">549     jbyte typeKey = jdwpTag(componentSignature);</span>
<span class="line-modified">550     if (isReferenceTag(typeKey)) {</span>
<span class="line-added">551         serror = readObjectComponents(env, in, array, index, length);</span>
<span class="line-added">552         return serror;</span>
<span class="line-added">553     }</span>
<span class="line-added">554     switch (typeKey) {</span>
<span class="line-added">555         case JDWP_TAG(BYTE):</span>
<span class="line-added">556             serror = readByteComponents(env, in, array, index, length);</span>
<span class="line-added">557             break;</span>
558 
<span class="line-modified">559         case JDWP_TAG(CHAR):</span>
<span class="line-modified">560             serror = readCharComponents(env, in, array, index, length);</span>
<span class="line-modified">561             break;</span>
562 
<span class="line-modified">563         case JDWP_TAG(FLOAT):</span>
<span class="line-modified">564             serror = readFloatComponents(env, in, array, index, length);</span>
<span class="line-modified">565             break;</span>
566 
<span class="line-modified">567         case JDWP_TAG(DOUBLE):</span>
<span class="line-modified">568             serror = readDoubleComponents(env, in, array, index, length);</span>
<span class="line-modified">569             break;</span>
570 
<span class="line-modified">571         case JDWP_TAG(INT):</span>
<span class="line-modified">572             serror = readIntComponents(env, in, array, index, length);</span>
<span class="line-modified">573             break;</span>





574 
<span class="line-modified">575         case JDWP_TAG(LONG):</span>
<span class="line-added">576             serror = readLongComponents(env, in, array, index, length);</span>
<span class="line-added">577             break;</span>
578 
<span class="line-modified">579         case JDWP_TAG(SHORT):</span>
<span class="line-added">580             serror = readShortComponents(env, in, array, index, length);</span>
<span class="line-added">581             break;</span>
582 
<span class="line-modified">583         case JDWP_TAG(BOOLEAN):</span>
<span class="line-added">584             serror = readBooleanComponents(env, in, array, index, length);</span>
<span class="line-added">585             break;</span>
586 
<span class="line-modified">587         default:</span>
<span class="line-modified">588             {</span>
<span class="line-modified">589                 ERROR_MESSAGE((&quot;Invalid array component signature: %s&quot;,</span>
<span class="line-modified">590                                     componentSignature));</span>
<span class="line-modified">591                 EXIT_ERROR(AGENT_ERROR_INVALID_OBJECT,NULL);</span>
<span class="line-modified">592             }</span>
<span class="line-added">593             break;</span>
594     }
595 
<span class="line-modified">596     return serror;</span>

597 }
598 
599 Command ArrayReference_Commands[] = {
600     {length, &quot;Length&quot;},
601     {getValues, &quot;GetValues&quot;},
602     {setValues, &quot;SetValues&quot;}
603 };
604 
605 DEBUG_DISPATCH_DEFINE_CMDSET(ArrayReference)
</pre>
</td>
</tr>
</table>
<center><a href="../../../../jdk.jdi/share/classes/com/sun/tools/jdi/VoidValueImpl.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="ArrayTypeImpl.c.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>