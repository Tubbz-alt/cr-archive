<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff src/jdk.jdwp.agent/share/native/libjdwp/ArrayReferenceImpl.c</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
<body>
<center><a href="../../../../jdk.jdi/share/classes/com/sun/tools/jdi/VoidValueImpl.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="ArrayTypeImpl.c.udiff.html" target="_top">next &gt;</a></center>    <h2>src/jdk.jdwp.agent/share/native/libjdwp/ArrayReferenceImpl.c</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -25,10 +25,11 @@</span>
  
  #include &quot;util.h&quot;
  #include &quot;ArrayReferenceImpl.h&quot;
  #include &quot;inStream.h&quot;
  #include &quot;outStream.h&quot;
<span class="udiff-line-added">+ #include &quot;signature.h&quot;</span>
  
  static jboolean
  length(PacketInputStream *in, PacketOutputStream *out)
  {
      JNIEnv *env = getEnv();
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -202,11 +203,11 @@</span>
      }
  }
  
  static void
  writeObjectComponents(JNIEnv *env, PacketOutputStream *out,
<span class="udiff-line-modified-removed">-                     jarray array, jint index, jint length)</span>
<span class="udiff-line-modified-added">+                       jarray array, jint index, jint length)</span>
  {
  
      WITH_LOCAL_REFS(env, length) {
  
          int i;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -223,10 +224,13 @@</span>
          }
  
      } END_WITH_LOCAL_REFS(env);
  }
  
<span class="udiff-line-added">+ static void writeComponents(JNIEnv *env, PacketOutputStream *out, char *signature,</span>
<span class="udiff-line-added">+                             jarray array, jint index, jint length);</span>
<span class="udiff-line-added">+ </span>
  static jboolean
  getValues(PacketInputStream *in, PacketOutputStream *out)
  {
      JNIEnv *env = getEnv();
      jint arrayLength;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -263,83 +267,81 @@</span>
          return JNI_TRUE;
      }
  
      WITH_LOCAL_REFS(env, 1) {
  
<span class="udiff-line-removed">-         jclass arrayClass;</span>
          char *signature = NULL;
<span class="udiff-line-removed">-         char *componentSignature;</span>
<span class="udiff-line-removed">-         jbyte typeKey;</span>
<span class="udiff-line-removed">-         jvmtiError error;</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-         arrayClass = JNI_FUNC_PTR(env,GetObjectClass)(env, array);</span>
<span class="udiff-line-removed">-         error = classSignature(arrayClass, &amp;signature, NULL);</span>
<span class="udiff-line-removed">-         if (error != JVMTI_ERROR_NONE) {</span>
<span class="udiff-line-removed">-             goto err;</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">-         componentSignature = &amp;signature[1];</span>
<span class="udiff-line-removed">-         typeKey = componentSignature[0];</span>
  
<span class="udiff-line-modified-removed">-         (void)outStream_writeByte(out, typeKey);</span>
<span class="udiff-line-modified-removed">-         (void)outStream_writeInt(out, length);</span>
<span class="udiff-line-modified-removed">- </span>
<span class="udiff-line-modified-removed">-         if (isObjectTag(typeKey)) {</span>
<span class="udiff-line-modified-removed">-             writeObjectComponents(env, out, array, index, length);</span>
<span class="udiff-line-removed">-         } else {</span>
<span class="udiff-line-removed">-             switch (typeKey) {</span>
<span class="udiff-line-removed">-                 case JDWP_TAG(BYTE):</span>
<span class="udiff-line-removed">-                     writeByteComponents(env, out, array, index, length);</span>
<span class="udiff-line-removed">-                     break;</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-                 case JDWP_TAG(CHAR):</span>
<span class="udiff-line-removed">-                     writeCharComponents(env, out, array, index, length);</span>
<span class="udiff-line-removed">-                     break;</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-                 case JDWP_TAG(FLOAT):</span>
<span class="udiff-line-removed">-                     writeFloatComponents(env, out, array, index, length);</span>
<span class="udiff-line-removed">-                     break;</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-                 case JDWP_TAG(DOUBLE):</span>
<span class="udiff-line-removed">-                     writeDoubleComponents(env, out, array, index, length);</span>
<span class="udiff-line-removed">-                     break;</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-                 case JDWP_TAG(INT):</span>
<span class="udiff-line-removed">-                     writeIntComponents(env, out, array, index, length);</span>
<span class="udiff-line-removed">-                     break;</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-                 case JDWP_TAG(LONG):</span>
<span class="udiff-line-removed">-                     writeLongComponents(env, out, array, index, length);</span>
<span class="udiff-line-removed">-                     break;</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-                 case JDWP_TAG(SHORT):</span>
<span class="udiff-line-removed">-                     writeShortComponents(env, out, array, index, length);</span>
<span class="udiff-line-removed">-                     break;</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-                 case JDWP_TAG(BOOLEAN):</span>
<span class="udiff-line-removed">-                     writeBooleanComponents(env, out, array, index, length);</span>
<span class="udiff-line-removed">-                     break;</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-                 default:</span>
<span class="udiff-line-removed">-                     outStream_setError(out, JDWP_ERROR(INVALID_TAG));</span>
<span class="udiff-line-removed">-                     break;</span>
<span class="udiff-line-removed">-             }</span>
<span class="udiff-line-modified-added">+         jclass arrayClass = JNI_FUNC_PTR(env,GetObjectClass)(env, array);</span>
<span class="udiff-line-modified-added">+         jvmtiError error = classSignature(arrayClass, &amp;signature, NULL);</span>
<span class="udiff-line-modified-added">+         if (error == JVMTI_ERROR_NONE) {</span>
<span class="udiff-line-modified-added">+             writeComponents(env, out, signature, array, index, length);</span>
<span class="udiff-line-modified-added">+             jvmtiDeallocate(signature);</span>
          }
  
<span class="udiff-line-removed">-         jvmtiDeallocate(signature);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     err:;</span>
<span class="udiff-line-removed">- </span>
      } END_WITH_LOCAL_REFS(env);
  
      if (JNI_FUNC_PTR(env,ExceptionOccurred)(env)) {
          outStream_setError(out, JDWP_ERROR(INTERNAL));
          JNI_FUNC_PTR(env,ExceptionClear)(env);
      }
  
      return JNI_TRUE;
  }
  
<span class="udiff-line-added">+ static void writeComponents(JNIEnv *env, PacketOutputStream *out, char *signature,</span>
<span class="udiff-line-added">+                             jarray array, jint index, jint length) {</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     char * componentSignature = componentTypeSignature(signature);</span>
<span class="udiff-line-added">+     jbyte typeKey = jdwpTag(componentSignature);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     (void)outStream_writeByte(out, typeKey);</span>
<span class="udiff-line-added">+     (void)outStream_writeInt(out, length);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     if (isReferenceTag(typeKey)) {</span>
<span class="udiff-line-added">+         writeObjectComponents(env, out, array, index, length);</span>
<span class="udiff-line-added">+         return;</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+     switch (typeKey) {</span>
<span class="udiff-line-added">+         case JDWP_TAG(BYTE):</span>
<span class="udiff-line-added">+             writeByteComponents(env, out, array, index, length);</span>
<span class="udiff-line-added">+             break;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         case JDWP_TAG(CHAR):</span>
<span class="udiff-line-added">+             writeCharComponents(env, out, array, index, length);</span>
<span class="udiff-line-added">+             break;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         case JDWP_TAG(FLOAT):</span>
<span class="udiff-line-added">+             writeFloatComponents(env, out, array, index, length);</span>
<span class="udiff-line-added">+             break;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         case JDWP_TAG(DOUBLE):</span>
<span class="udiff-line-added">+             writeDoubleComponents(env, out, array, index, length);</span>
<span class="udiff-line-added">+             break;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         case JDWP_TAG(INT):</span>
<span class="udiff-line-added">+             writeIntComponents(env, out, array, index, length);</span>
<span class="udiff-line-added">+             break;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         case JDWP_TAG(LONG):</span>
<span class="udiff-line-added">+             writeLongComponents(env, out, array, index, length);</span>
<span class="udiff-line-added">+             break;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         case JDWP_TAG(SHORT):</span>
<span class="udiff-line-added">+             writeShortComponents(env, out, array, index, length);</span>
<span class="udiff-line-added">+             break;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         case JDWP_TAG(BOOLEAN):</span>
<span class="udiff-line-added">+             writeBooleanComponents(env, out, array, index, length);</span>
<span class="udiff-line-added">+             break;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         default:</span>
<span class="udiff-line-added">+             outStream_setError(out, JDWP_ERROR(INVALID_TAG));</span>
<span class="udiff-line-added">+             break;</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
  static jdwpError
  readBooleanComponents(JNIEnv *env, PacketInputStream *in,
                     jarray array, int index, int length)
  {
      int i;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -475,10 +477,12 @@</span>
      }
  
      return JDWP_ERROR(NONE);
  }
  
<span class="udiff-line-added">+ static jdwpError readComponents(JNIEnv *env, PacketInputStream *in, char *signature,</span>
<span class="udiff-line-added">+                                 jarray array, jint index, jint length);</span>
  
  static jboolean
  setValues(PacketInputStream *in, PacketOutputStream *out)
  {
      JNIEnv *env = getEnv();
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -513,86 +517,85 @@</span>
          return JNI_TRUE;
      }
  
      WITH_LOCAL_REFS(env, 1)  {
  
<span class="udiff-line-removed">-         jclass arrayClass;</span>
          char *signature = NULL;
<span class="udiff-line-removed">-         char *componentSignature;</span>
<span class="udiff-line-removed">-         jvmtiError error;</span>
  
<span class="udiff-line-modified-removed">-         arrayClass = JNI_FUNC_PTR(env,GetObjectClass)(env, array);</span>
<span class="udiff-line-modified-removed">-         error = classSignature(arrayClass, &amp;signature, NULL);</span>
<span class="udiff-line-modified-removed">-         if (error != JVMTI_ERROR_NONE) {</span>
<span class="udiff-line-modified-removed">-             goto err;</span>
<span class="udiff-line-modified-added">+         jclass arrayClass = JNI_FUNC_PTR(env,GetObjectClass)(env, array);</span>
<span class="udiff-line-modified-added">+         jvmtiError error = classSignature(arrayClass, &amp;signature, NULL);</span>
<span class="udiff-line-modified-added">+         if (error == JVMTI_ERROR_NONE) {</span>
<span class="udiff-line-modified-added">+             serror = readComponents(env, in, signature, array, index, length);</span>
<span class="udiff-line-added">+             jvmtiDeallocate(signature);</span>
          }
<span class="udiff-line-modified-removed">-         componentSignature = &amp;signature[1];</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-         switch (componentSignature[0]) {</span>
<span class="udiff-line-removed">-             case JDWP_TAG(OBJECT):</span>
<span class="udiff-line-removed">-             case JDWP_TAG(ARRAY):</span>
<span class="udiff-line-removed">-             case JDWP_TAG(INLINE_OBJECT):</span>
<span class="udiff-line-removed">-                 serror = readObjectComponents(env, in, array, index, length);</span>
<span class="udiff-line-removed">-                 break;</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-             case JDWP_TAG(BYTE):</span>
<span class="udiff-line-removed">-                 serror = readByteComponents(env, in, array, index, length);</span>
<span class="udiff-line-removed">-                 break;</span>
<span class="udiff-line-modified-added">+     } END_WITH_LOCAL_REFS(env);</span>
  
<span class="udiff-line-modified-removed">-             case JDWP_TAG(CHAR):</span>
<span class="udiff-line-modified-removed">-                 serror = readCharComponents(env, in, array, index, length);</span>
<span class="udiff-line-modified-removed">-                 break;</span>
<span class="udiff-line-modified-added">+     if (JNI_FUNC_PTR(env,ExceptionOccurred)(env)) {</span>
<span class="udiff-line-modified-added">+         /*</span>
<span class="udiff-line-modified-added">+          * TO DO: Check exception type</span>
<span class="udiff-line-added">+          */</span>
<span class="udiff-line-added">+         serror = JDWP_ERROR(TYPE_MISMATCH);</span>
<span class="udiff-line-added">+         JNI_FUNC_PTR(env,ExceptionClear)(env);</span>
<span class="udiff-line-added">+     }</span>
  
<span class="udiff-line-modified-removed">-             case JDWP_TAG(FLOAT):</span>
<span class="udiff-line-modified-removed">-                 serror = readFloatComponents(env, in, array, index, length);</span>
<span class="udiff-line-modified-removed">-                 break;</span>
<span class="udiff-line-modified-added">+     outStream_setError(out, serror);</span>
<span class="udiff-line-modified-added">+     return JNI_TRUE;</span>
<span class="udiff-line-modified-added">+ }</span>
  
<span class="udiff-line-modified-removed">-             case JDWP_TAG(DOUBLE):</span>
<span class="udiff-line-modified-removed">-                 serror = readDoubleComponents(env, in, array, index, length);</span>
<span class="udiff-line-modified-removed">-                 break;</span>
<span class="udiff-line-modified-added">+ static jdwpError readComponents(JNIEnv *env, PacketInputStream *in, char *signature,</span>
<span class="udiff-line-modified-added">+ jarray array, jint index, jint length) {</span>
<span class="udiff-line-modified-added">+     jdwpError serror = JDWP_ERROR(NONE);</span>
  
<span class="udiff-line-modified-removed">-             case JDWP_TAG(INT):</span>
<span class="udiff-line-modified-removed">-                 serror = readIntComponents(env, in, array, index, length);</span>
<span class="udiff-line-modified-removed">-                 break;</span>
<span class="udiff-line-modified-added">+     char *componentSignature = componentTypeSignature(signature);</span>
<span class="udiff-line-modified-added">+     jbyte typeKey = jdwpTag(componentSignature);</span>
<span class="udiff-line-modified-added">+     if (isReferenceTag(typeKey)) {</span>
<span class="udiff-line-added">+         serror = readObjectComponents(env, in, array, index, length);</span>
<span class="udiff-line-added">+         return serror;</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+     switch (typeKey) {</span>
<span class="udiff-line-added">+         case JDWP_TAG(BYTE):</span>
<span class="udiff-line-added">+             serror = readByteComponents(env, in, array, index, length);</span>
<span class="udiff-line-added">+             break;</span>
  
<span class="udiff-line-modified-removed">-             case JDWP_TAG(LONG):</span>
<span class="udiff-line-modified-removed">-                 serror = readLongComponents(env, in, array, index, length);</span>
<span class="udiff-line-modified-removed">-                 break;</span>
<span class="udiff-line-modified-added">+         case JDWP_TAG(CHAR):</span>
<span class="udiff-line-modified-added">+             serror = readCharComponents(env, in, array, index, length);</span>
<span class="udiff-line-modified-added">+             break;</span>
  
<span class="udiff-line-modified-removed">-             case JDWP_TAG(SHORT):</span>
<span class="udiff-line-modified-removed">-                 serror = readShortComponents(env, in, array, index, length);</span>
<span class="udiff-line-modified-removed">-                 break;</span>
<span class="udiff-line-modified-added">+         case JDWP_TAG(FLOAT):</span>
<span class="udiff-line-modified-added">+             serror = readFloatComponents(env, in, array, index, length);</span>
<span class="udiff-line-modified-added">+             break;</span>
  
<span class="udiff-line-modified-removed">-             case JDWP_TAG(BOOLEAN):</span>
<span class="udiff-line-modified-removed">-                 serror = readBooleanComponents(env, in, array, index, length);</span>
<span class="udiff-line-modified-removed">-                 break;</span>
<span class="udiff-line-modified-added">+         case JDWP_TAG(DOUBLE):</span>
<span class="udiff-line-modified-added">+             serror = readDoubleComponents(env, in, array, index, length);</span>
<span class="udiff-line-modified-added">+             break;</span>
  
<span class="udiff-line-modified-removed">-             default:</span>
<span class="udiff-line-modified-removed">-                 {</span>
<span class="udiff-line-modified-removed">-                     ERROR_MESSAGE((&quot;Invalid array component signature: %s&quot;,</span>
<span class="udiff-line-removed">-                                         componentSignature));</span>
<span class="udiff-line-removed">-                     EXIT_ERROR(AGENT_ERROR_INVALID_OBJECT,NULL);</span>
<span class="udiff-line-removed">-                 }</span>
<span class="udiff-line-removed">-                 break;</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-modified-added">+         case JDWP_TAG(INT):</span>
<span class="udiff-line-modified-added">+             serror = readIntComponents(env, in, array, index, length);</span>
<span class="udiff-line-modified-added">+             break;</span>
  
<span class="udiff-line-modified-removed">-         jvmtiDeallocate(signature);</span>
<span class="udiff-line-modified-added">+         case JDWP_TAG(LONG):</span>
<span class="udiff-line-added">+             serror = readLongComponents(env, in, array, index, length);</span>
<span class="udiff-line-added">+             break;</span>
  
<span class="udiff-line-modified-removed">-     err:;</span>
<span class="udiff-line-modified-added">+         case JDWP_TAG(SHORT):</span>
<span class="udiff-line-added">+             serror = readShortComponents(env, in, array, index, length);</span>
<span class="udiff-line-added">+             break;</span>
  
<span class="udiff-line-modified-removed">-     } END_WITH_LOCAL_REFS(env);</span>
<span class="udiff-line-modified-added">+         case JDWP_TAG(BOOLEAN):</span>
<span class="udiff-line-added">+             serror = readBooleanComponents(env, in, array, index, length);</span>
<span class="udiff-line-added">+             break;</span>
  
<span class="udiff-line-modified-removed">-     if (JNI_FUNC_PTR(env,ExceptionOccurred)(env)) {</span>
<span class="udiff-line-modified-removed">-         /*</span>
<span class="udiff-line-modified-removed">-          * TO DO: Check exception type</span>
<span class="udiff-line-modified-removed">-          */</span>
<span class="udiff-line-modified-removed">-         serror = JDWP_ERROR(TYPE_MISMATCH);</span>
<span class="udiff-line-modified-removed">-         JNI_FUNC_PTR(env,ExceptionClear)(env);</span>
<span class="udiff-line-modified-added">+         default:</span>
<span class="udiff-line-modified-added">+             {</span>
<span class="udiff-line-modified-added">+                 ERROR_MESSAGE((&quot;Invalid array component signature: %s&quot;,</span>
<span class="udiff-line-modified-added">+                                     componentSignature));</span>
<span class="udiff-line-modified-added">+                 EXIT_ERROR(AGENT_ERROR_INVALID_OBJECT,NULL);</span>
<span class="udiff-line-modified-added">+             }</span>
<span class="udiff-line-added">+             break;</span>
      }
  
<span class="udiff-line-modified-removed">-     outStream_setError(out, serror);</span>
<span class="udiff-line-removed">-     return JNI_TRUE;</span>
<span class="udiff-line-modified-added">+     return serror;</span>
  }
  
  Command ArrayReference_Commands[] = {
      {length, &quot;Length&quot;},
      {getValues, &quot;GetValues&quot;},
</pre>
<center><a href="../../../../jdk.jdi/share/classes/com/sun/tools/jdi/VoidValueImpl.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="ArrayTypeImpl.c.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>