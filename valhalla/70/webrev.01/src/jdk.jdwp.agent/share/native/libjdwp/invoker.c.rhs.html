<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames src/jdk.jdwp.agent/share/native/libjdwp/invoker.c</title>
    <link rel="stylesheet" href="../../../../../style.css" />
    <script type="text/javascript" src="../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
  2  * Copyright (c) 1998, 2017, Oracle and/or its affiliates. All rights reserved.
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.  Oracle designates this
  8  * particular file as subject to the &quot;Classpath&quot; exception as provided
  9  * by Oracle in the LICENSE file that accompanied this code.
 10  *
 11  * This code is distributed in the hope that it will be useful, but WITHOUT
 12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 14  * version 2 for more details (a copy is included in the LICENSE file that
 15  * accompanied this code).
 16  *
 17  * You should have received a copy of the GNU General Public License version
 18  * 2 along with this work; if not, write to the Free Software Foundation,
 19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 20  *
 21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 22  * or visit www.oracle.com if you need additional information or have any
 23  * questions.
 24  */
 25 
 26 #include &quot;util.h&quot;
 27 #include &quot;invoker.h&quot;
 28 #include &quot;eventHandler.h&quot;
 29 #include &quot;threadControl.h&quot;
 30 #include &quot;outStream.h&quot;
<a name="1" id="anc1"></a><span class="line-added"> 31 #include &quot;signature.h&quot;</span>
 32 
 33 static jrawMonitorID invokerLock;
 34 
 35 void
 36 invoker_initialize(void)
 37 {
 38     invokerLock = debugMonitorCreate(&quot;JDWP Invocation Lock&quot;);
 39 }
 40 
 41 void
 42 invoker_reset(void)
 43 {
 44 }
 45 
 46 void invoker_lock(void)
 47 {
 48     debugMonitorEnter(invokerLock);
 49 }
 50 
 51 void invoker_unlock(void)
 52 {
 53     debugMonitorExit(invokerLock);
 54 }
 55 
<a name="2" id="anc2"></a>










































 56 /*
 57  * Note: argument refs may be destroyed on out-of-memory error
 58  */
 59 static jvmtiError
 60 createGlobalRefs(JNIEnv *env, InvokeRequest *request)
 61 {
<a name="3" id="anc3"></a><span class="line-modified"> 62     jvmtiError error = JVMTI_ERROR_NONE;</span>
<span class="line-added"> 63     void *cursor = NULL;</span>
<span class="line-added"> 64     jbyte argumentTag = 0;</span>
<span class="line-added"> 65     jint argIndex = 0;</span>
<span class="line-added"> 66     jvalue *argument = request-&gt;arguments;</span>
 67     jclass clazz = NULL;
 68     jobject instance = NULL;
<a name="4" id="anc4"></a>



 69     jobject *argRefs = NULL;
 70 
<a name="5" id="anc5"></a>

 71     if ( request-&gt;argumentCount &gt; 0 ) {
 72         /*LINTED*/
 73         argRefs = jvmtiAllocate((jint)(request-&gt;argumentCount*sizeof(jobject)));
 74         if ( argRefs==NULL ) {
 75             error = AGENT_ERROR_OUT_OF_MEMORY;
 76         } else {
 77             /*LINTED*/
 78             (void)memset(argRefs, 0, request-&gt;argumentCount*sizeof(jobject));
 79         }
 80     }
 81 
 82     if ( error == JVMTI_ERROR_NONE ) {
 83         saveGlobalRef(env, request-&gt;clazz, &amp;clazz);
 84         if (clazz == NULL) {
 85             error = AGENT_ERROR_OUT_OF_MEMORY;
 86         }
 87     }
 88 
 89     if ( error == JVMTI_ERROR_NONE &amp;&amp; request-&gt;instance != NULL ) {
 90         saveGlobalRef(env, request-&gt;instance, &amp;instance);
 91         if (instance == NULL) {
 92             error = AGENT_ERROR_OUT_OF_MEMORY;
 93         }
 94     }
 95 
 96     if ( error == JVMTI_ERROR_NONE &amp;&amp; argRefs!=NULL ) {
<a name="6" id="anc6"></a><span class="line-modified"> 97         methodSignature_init(request-&gt;methodSignature, &amp;cursor);</span>
<span class="line-modified"> 98         while (methodSignature_nextArgumentExists(&amp;cursor, &amp;argumentTag)) {</span>


 99             if ( argIndex &gt; request-&gt;argumentCount ) {
100                 break;
101             }
<a name="7" id="anc7"></a><span class="line-modified">102             if (isReferenceTag(argumentTag)) {</span>


103                 /* Create a global ref for any non-null argument */
104                 if (argument-&gt;l != NULL) {
105                     saveGlobalRef(env, argument-&gt;l, &amp;argRefs[argIndex]);
106                     if (argRefs[argIndex] == NULL) {
107                         error = AGENT_ERROR_OUT_OF_MEMORY;
108                         break;
109                     }
110                 }
111             }
112             argument++;
113             argIndex++;
<a name="8" id="anc8"></a>
114         }
115     }
116 
117 #ifdef FIXUP /* Why isn&#39;t this an error? */
118     /* Make sure the argument count matches */
119     if ( error == JVMTI_ERROR_NONE &amp;&amp; argIndex != request-&gt;argumentCount ) {
120         error = AGENT_ERROR_INVALID_COUNT;
121     }
122 #endif
123 
124     /* Finally, put the global refs into the request if no errors */
125     if ( error == JVMTI_ERROR_NONE ) {
126         request-&gt;clazz = clazz;
127         request-&gt;instance = instance;
128         if ( argRefs!=NULL ) {
129             argIndex = 0;
<a name="9" id="anc9"></a><span class="line-modified">130             methodSignature_init(request-&gt;methodSignature, &amp;cursor);</span>
131             argument = request-&gt;arguments;
<a name="10" id="anc10"></a><span class="line-modified">132             while ( methodSignature_nextArgumentExists(&amp;cursor, &amp;argumentTag) &amp;&amp;</span>
<span class="line-modified">133                    argIndex &lt; request-&gt;argumentCount ) {</span>
<span class="line-modified">134                 if ( isReferenceTag(argumentTag) ) {</span>

135                     argument-&gt;l = argRefs[argIndex];
136                 }
137                 argument++;
138                 argIndex++;
<a name="11" id="anc11"></a>
139             }
140             jvmtiDeallocate(argRefs);
141         }
142         return JVMTI_ERROR_NONE;
143 
144     } else {
145         /* Delete global references */
146         if ( clazz != NULL ) {
147             tossGlobalRef(env, &amp;clazz);
148         }
149         if ( instance != NULL ) {
150             tossGlobalRef(env, &amp;instance);
151         }
152         if ( argRefs!=NULL ) {
153             for ( argIndex=0; argIndex &lt; request-&gt;argumentCount; argIndex++ ) {
154                 if ( argRefs[argIndex] != NULL ) {
155                     tossGlobalRef(env, &amp;argRefs[argIndex]);
156                 }
157             }
158             jvmtiDeallocate(argRefs);
159         }
160     }
161 
162     return error;
163 }
164 
165 /*
166  * Delete global argument references from the request which got put there before a
167  * invoke request was carried out. See fillInvokeRequest().
168  */
169 static void
170 deleteGlobalArgumentRefs(JNIEnv *env, InvokeRequest *request)
171 {
<a name="12" id="anc12"></a><span class="line-modified">172     void *cursor = NULL;</span>
173     jint argIndex = 0;
<a name="13" id="anc13"></a><span class="line-added">174     jbyte argumentTag = 0;</span>
175     jvalue *argument = request-&gt;arguments;
<a name="14" id="anc14"></a><span class="line-modified">176     methodSignature_init(request-&gt;methodSignature, &amp;cursor);</span>
177 
178     if (request-&gt;clazz != NULL) {
179         tossGlobalRef(env, &amp;(request-&gt;clazz));
180     }
181     if (request-&gt;instance != NULL) {
182         tossGlobalRef(env, &amp;(request-&gt;instance));
183     }
184     /* Delete global argument references */
<a name="15" id="anc15"></a><span class="line-modified">185     while (methodSignature_nextArgumentExists(&amp;cursor, &amp;argumentTag) &amp;&amp;</span>
<span class="line-modified">186            argIndex &lt; request-&gt;argumentCount) {</span>
<span class="line-modified">187         if (isReferenceTag(argumentTag)) {</span>

188             if (argument-&gt;l != NULL) {
189                 tossGlobalRef(env, &amp;(argument-&gt;l));
190             }
191         }
192         argument++;
193         argIndex++;
<a name="16" id="anc16"></a>
194     }
195 }
196 
197 static jvmtiError
198 fillInvokeRequest(JNIEnv *env, InvokeRequest *request,
199                   jbyte invokeType, jbyte options, jint id,
200                   jthread thread, jclass clazz, jmethodID method,
201                   jobject instance,
202                   jvalue *arguments, jint argumentCount)
203 {
204     jvmtiError error;
205     if (!request-&gt;available) {
206         /*
207          * Thread is not at a point where it can invoke.
208          */
209         return AGENT_ERROR_INVALID_THREAD;
210     }
211     if (request-&gt;pending) {
212         /*
213          * Pending invoke
214          */
215         return AGENT_ERROR_ALREADY_INVOKING;
216     }
217 
218     request-&gt;invokeType = invokeType;
219     request-&gt;options = options;
220     request-&gt;detached = JNI_FALSE;
221     request-&gt;id = id;
222     request-&gt;clazz = clazz;
223     request-&gt;method = method;
224     request-&gt;instance = instance;
225     request-&gt;arguments = arguments;
226     request-&gt;arguments = arguments;
227     request-&gt;argumentCount = argumentCount;
228 
229     request-&gt;returnValue.j = 0;
230     request-&gt;exception = 0;
231 
232     /*
233      * Squirrel away the method signature
234      */
235     error = methodSignature(method, NULL, &amp;request-&gt;methodSignature,  NULL);
236     if (error != JVMTI_ERROR_NONE) {
237         return error;
238     }
239 
240     /*
241      * The given references for class and instance are not guaranteed
242      * to be around long enough for invocation, so create new ones
243      * here.
244      */
245     error = createGlobalRefs(env, request);
246     if (error != JVMTI_ERROR_NONE) {
247         jvmtiDeallocate(request-&gt;methodSignature);
248         return error;
249     }
250 
251     request-&gt;pending = JNI_TRUE;
252     request-&gt;available = JNI_FALSE;
253     return JVMTI_ERROR_NONE;
254 }
255 
256 void
257 invoker_enableInvokeRequests(jthread thread)
258 {
259     InvokeRequest *request;
260 
261     JDI_ASSERT(thread);
262 
263     debugMonitorEnter(invokerLock);
264     request = threadControl_getInvokeRequest(thread);
265     if (request == NULL) {
266         EXIT_ERROR(AGENT_ERROR_INVALID_THREAD, &quot;getting thread invoke request&quot;);
267     }
268 
269     request-&gt;available = JNI_TRUE;
270     debugMonitorExit(invokerLock);
271 }
272 
273 /*
274  * Check that method is in the specified clazz or one of its super classes.
275  * We have to enforce this check at the JDWP layer because the JNI layer
276  * has different requirements.
277  */
278 static jvmtiError check_methodClass(JNIEnv *env, jclass clazz, jmethodID method)
279 {
280     jclass containing_class = NULL;
281     jvmtiError error;
282 
283     error = JVMTI_FUNC_PTR(gdata-&gt;jvmti,GetMethodDeclaringClass)
284                 (gdata-&gt;jvmti, method, &amp;containing_class);
285     if (error != JVMTI_ERROR_NONE) {
286         return JVMTI_ERROR_NONE;  /* Bad jmethodID ?  This will be handled elsewhere */
287     }
288 
289     if (JNI_FUNC_PTR(env,IsSameObject)(env, clazz, containing_class)) {
290         return JVMTI_ERROR_NONE;
291     }
292 
293     // If not the same class then check that containing_class is a superclass of
294     // clazz (not a superinterface).
295     if (JNI_FUNC_PTR(env,IsAssignableFrom)(env, clazz, containing_class) &amp;&amp;
296         referenceTypeTag(containing_class) != JDWP_TYPE_TAG(INTERFACE)) {
297         return JVMTI_ERROR_NONE;
298     }
299     return JVMTI_ERROR_INVALID_METHODID;
300 }
301 
302 jvmtiError
303 invoker_requestInvoke(jbyte invokeType, jbyte options, jint id,
304                       jthread thread, jclass clazz, jmethodID method,
305                       jobject instance,
306                       jvalue *arguments, jint argumentCount)
307 {
308     JNIEnv *env = getEnv();
309     InvokeRequest *request;
310     jvmtiError error = JVMTI_ERROR_NONE;
311 
312     if (invokeType == INVOKE_STATIC) {
313         error = check_methodClass(env, clazz, method);
314         if (error != JVMTI_ERROR_NONE) {
315             return error;
316         }
317     }
318 
319     debugMonitorEnter(invokerLock);
320     request = threadControl_getInvokeRequest(thread);
321     if (request != NULL) {
322         error = fillInvokeRequest(env, request, invokeType, options, id,
323                                   thread, clazz, method, instance,
324                                   arguments, argumentCount);
325     }
326     debugMonitorExit(invokerLock);
327 
328     if (error == JVMTI_ERROR_NONE) {
329         if (options &amp; JDWP_INVOKE_OPTIONS(SINGLE_THREADED) ) {
330             /* true means it is okay to unblock the commandLoop thread */
331             (void)threadControl_resumeThread(thread, JNI_TRUE);
332         } else {
333             (void)threadControl_resumeAll();
334         }
335     }
336 
337     return error;
338 }
339 
340 static void
341 invokeConstructor(JNIEnv *env, InvokeRequest *request)
342 {
343     jobject object;
344 
345     JDI_ASSERT_MSG(request-&gt;clazz, &quot;Request clazz null&quot;);
346     object = JNI_FUNC_PTR(env,NewObjectA)(env, request-&gt;clazz,
347                                      request-&gt;method,
348                                      request-&gt;arguments);
349     request-&gt;returnValue.l = NULL;
350     if (object != NULL) {
351         saveGlobalRef(env, object, &amp;(request-&gt;returnValue.l));
352     }
353 }
354 
355 static void
356 invokeStatic(JNIEnv *env, InvokeRequest *request)
357 {
<a name="17" id="anc17"></a><span class="line-modified">358     jbyte returnType = methodSignature_returnTag(request-&gt;methodSignature);</span>
<span class="line-modified">359 </span>
<span class="line-modified">360     if (isReferenceTag(returnType)) {</span>
<span class="line-modified">361         jobject object;</span>
<span class="line-modified">362         JDI_ASSERT_MSG(request-&gt;clazz, &quot;Request clazz null&quot;);</span>
<span class="line-modified">363         object = JNI_FUNC_PTR(env,CallStaticObjectMethodA)(env,</span>
<span class="line-modified">364                                    request-&gt;clazz,</span>
<span class="line-modified">365                                    request-&gt;method,</span>
<span class="line-modified">366                                    request-&gt;arguments);</span>
<span class="line-modified">367         request-&gt;returnValue.l = NULL;</span>
<span class="line-modified">368         if (object != NULL) {</span>
<span class="line-modified">369             saveGlobalRef(env, object, &amp;(request-&gt;returnValue.l));</span>



370         }
<a name="18" id="anc18"></a><span class="line-added">371         return;</span>
<span class="line-added">372     }</span>
373 
<a name="19" id="anc19"></a><span class="line-modified">374     switch (returnType) {</span>
375         case JDWP_TAG(BYTE):
376             request-&gt;returnValue.b = JNI_FUNC_PTR(env,CallStaticByteMethodA)(env,
377                                                        request-&gt;clazz,
378                                                        request-&gt;method,
379                                                        request-&gt;arguments);
380             break;
381 
382         case JDWP_TAG(CHAR):
383             request-&gt;returnValue.c = JNI_FUNC_PTR(env,CallStaticCharMethodA)(env,
384                                                        request-&gt;clazz,
385                                                        request-&gt;method,
386                                                        request-&gt;arguments);
387             break;
388 
389         case JDWP_TAG(FLOAT):
390             request-&gt;returnValue.f = JNI_FUNC_PTR(env,CallStaticFloatMethodA)(env,
391                                                        request-&gt;clazz,
392                                                        request-&gt;method,
393                                                        request-&gt;arguments);
394             break;
395 
396         case JDWP_TAG(DOUBLE):
397             request-&gt;returnValue.d = JNI_FUNC_PTR(env,CallStaticDoubleMethodA)(env,
398                                                        request-&gt;clazz,
399                                                        request-&gt;method,
400                                                        request-&gt;arguments);
401             break;
402 
403         case JDWP_TAG(INT):
404             request-&gt;returnValue.i = JNI_FUNC_PTR(env,CallStaticIntMethodA)(env,
405                                                        request-&gt;clazz,
406                                                        request-&gt;method,
407                                                        request-&gt;arguments);
408             break;
409 
410         case JDWP_TAG(LONG):
411             request-&gt;returnValue.j = JNI_FUNC_PTR(env,CallStaticLongMethodA)(env,
412                                                        request-&gt;clazz,
413                                                        request-&gt;method,
414                                                        request-&gt;arguments);
415             break;
416 
417         case JDWP_TAG(SHORT):
418             request-&gt;returnValue.s = JNI_FUNC_PTR(env,CallStaticShortMethodA)(env,
419                                                        request-&gt;clazz,
420                                                        request-&gt;method,
421                                                        request-&gt;arguments);
422             break;
423 
424         case JDWP_TAG(BOOLEAN):
425             request-&gt;returnValue.z = JNI_FUNC_PTR(env,CallStaticBooleanMethodA)(env,
426                                                        request-&gt;clazz,
427                                                        request-&gt;method,
428                                                        request-&gt;arguments);
429             break;
430 
431         case JDWP_TAG(VOID):
432             JNI_FUNC_PTR(env,CallStaticVoidMethodA)(env,
433                                           request-&gt;clazz,
434                                           request-&gt;method,
435                                           request-&gt;arguments);
436             break;
437 
438         default:
439             EXIT_ERROR(AGENT_ERROR_NULL_POINTER,&quot;Invalid method signature&quot;);
440             break;
441     }
442 }
443 
444 static void
445 invokeVirtual(JNIEnv *env, InvokeRequest *request)
446 {
<a name="20" id="anc20"></a><span class="line-modified">447     jbyte returnType = methodSignature_returnTag(request-&gt;methodSignature);</span>
<span class="line-modified">448     if (isReferenceTag(returnType)) {</span>
<span class="line-modified">449         jobject object;</span>
<span class="line-modified">450         JDI_ASSERT_MSG(request-&gt;instance, &quot;Request instance null&quot;);</span>
<span class="line-modified">451         object = JNI_FUNC_PTR(env,CallObjectMethodA)(env,</span>
<span class="line-modified">452                              request-&gt;instance,</span>
<span class="line-modified">453                              request-&gt;method,</span>
<span class="line-modified">454                              request-&gt;arguments);</span>
<span class="line-modified">455         request-&gt;returnValue.l = NULL;</span>
<span class="line-modified">456         if (object != NULL) {</span>
<span class="line-modified">457             saveGlobalRef(env, object, &amp;(request-&gt;returnValue.l));</span>




458         }
<a name="21" id="anc21"></a><span class="line-added">459         return;</span>
<span class="line-added">460     }</span>
461 
<a name="22" id="anc22"></a><span class="line-added">462     switch (returnType) {</span>
463         case JDWP_TAG(BYTE):
464             request-&gt;returnValue.b = JNI_FUNC_PTR(env,CallByteMethodA)(env,
465                                                  request-&gt;instance,
466                                                  request-&gt;method,
467                                                  request-&gt;arguments);
468             break;
469 
470         case JDWP_TAG(CHAR):
471             request-&gt;returnValue.c = JNI_FUNC_PTR(env,CallCharMethodA)(env,
472                                                  request-&gt;instance,
473                                                  request-&gt;method,
474                                                  request-&gt;arguments);
475             break;
476 
477         case JDWP_TAG(FLOAT):
478             request-&gt;returnValue.f = JNI_FUNC_PTR(env,CallFloatMethodA)(env,
479                                                  request-&gt;instance,
480                                                  request-&gt;method,
481                                                  request-&gt;arguments);
482             break;
483 
484         case JDWP_TAG(DOUBLE):
485             request-&gt;returnValue.d = JNI_FUNC_PTR(env,CallDoubleMethodA)(env,
486                                                  request-&gt;instance,
487                                                  request-&gt;method,
488                                                  request-&gt;arguments);
489             break;
490 
491         case JDWP_TAG(INT):
492             request-&gt;returnValue.i = JNI_FUNC_PTR(env,CallIntMethodA)(env,
493                                                  request-&gt;instance,
494                                                  request-&gt;method,
495                                                  request-&gt;arguments);
496             break;
497 
498         case JDWP_TAG(LONG):
499             request-&gt;returnValue.j = JNI_FUNC_PTR(env,CallLongMethodA)(env,
500                                                  request-&gt;instance,
501                                                  request-&gt;method,
502                                                  request-&gt;arguments);
503             break;
504 
505         case JDWP_TAG(SHORT):
506             request-&gt;returnValue.s = JNI_FUNC_PTR(env,CallShortMethodA)(env,
507                                                  request-&gt;instance,
508                                                  request-&gt;method,
509                                                  request-&gt;arguments);
510             break;
511 
512         case JDWP_TAG(BOOLEAN):
513             request-&gt;returnValue.z = JNI_FUNC_PTR(env,CallBooleanMethodA)(env,
514                                                  request-&gt;instance,
515                                                  request-&gt;method,
516                                                  request-&gt;arguments);
517             break;
518 
519         case JDWP_TAG(VOID):
520             JNI_FUNC_PTR(env,CallVoidMethodA)(env,
521                                     request-&gt;instance,
522                                     request-&gt;method,
523                                     request-&gt;arguments);
524             break;
525 
526         default:
527             EXIT_ERROR(AGENT_ERROR_NULL_POINTER,&quot;Invalid method signature&quot;);
528             break;
529     }
530 }
531 
532 static void
533 invokeNonvirtual(JNIEnv *env, InvokeRequest *request)
534 {
<a name="23" id="anc23"></a><span class="line-modified">535     jbyte returnType = methodSignature_returnTag(request-&gt;methodSignature);</span>
<span class="line-modified">536     if (isReferenceTag(returnType)) {</span>
<span class="line-modified">537         jobject object;</span>
<span class="line-modified">538         JDI_ASSERT_MSG(request-&gt;clazz, &quot;Request clazz null&quot;);</span>
<span class="line-modified">539         JDI_ASSERT_MSG(request-&gt;instance, &quot;Request instance null&quot;);</span>
<span class="line-modified">540         object = JNI_FUNC_PTR(env,CallNonvirtualObjectMethodA)(env,</span>
<span class="line-modified">541                                        request-&gt;instance,</span>
<span class="line-modified">542                                        request-&gt;clazz,</span>
<span class="line-modified">543                                        request-&gt;method,</span>
<span class="line-modified">544                                        request-&gt;arguments);</span>
<span class="line-modified">545         request-&gt;returnValue.l = NULL;</span>
<span class="line-modified">546         if (object != NULL) {</span>
<span class="line-modified">547             saveGlobalRef(env, object, &amp;(request-&gt;returnValue.l));</span>




548         }
<a name="24" id="anc24"></a><span class="line-added">549         return;</span>
<span class="line-added">550     }</span>
551 
<a name="25" id="anc25"></a><span class="line-added">552     switch (returnType) {</span>
553         case JDWP_TAG(BYTE):
554             request-&gt;returnValue.b = JNI_FUNC_PTR(env,CallNonvirtualByteMethodA)(env,
555                                                  request-&gt;instance,
556                                                  request-&gt;clazz,
557                                                  request-&gt;method,
558                                                  request-&gt;arguments);
559             break;
560 
561         case JDWP_TAG(CHAR):
562             request-&gt;returnValue.c = JNI_FUNC_PTR(env,CallNonvirtualCharMethodA)(env,
563                                                  request-&gt;instance,
564                                                  request-&gt;clazz,
565                                                  request-&gt;method,
566                                                  request-&gt;arguments);
567             break;
568 
569         case JDWP_TAG(FLOAT):
570             request-&gt;returnValue.f = JNI_FUNC_PTR(env,CallNonvirtualFloatMethodA)(env,
571                                                  request-&gt;instance,
572                                                  request-&gt;clazz,
573                                                  request-&gt;method,
574                                                  request-&gt;arguments);
575             break;
576 
577         case JDWP_TAG(DOUBLE):
578             request-&gt;returnValue.d = JNI_FUNC_PTR(env,CallNonvirtualDoubleMethodA)(env,
579                                                  request-&gt;instance,
580                                                  request-&gt;clazz,
581                                                  request-&gt;method,
582                                                  request-&gt;arguments);
583             break;
584 
585         case JDWP_TAG(INT):
586             request-&gt;returnValue.i = JNI_FUNC_PTR(env,CallNonvirtualIntMethodA)(env,
587                                                  request-&gt;instance,
588                                                  request-&gt;clazz,
589                                                  request-&gt;method,
590                                                  request-&gt;arguments);
591             break;
592 
593         case JDWP_TAG(LONG):
594             request-&gt;returnValue.j = JNI_FUNC_PTR(env,CallNonvirtualLongMethodA)(env,
595                                                  request-&gt;instance,
596                                                  request-&gt;clazz,
597                                                  request-&gt;method,
598                                                  request-&gt;arguments);
599             break;
600 
601         case JDWP_TAG(SHORT):
602             request-&gt;returnValue.s = JNI_FUNC_PTR(env,CallNonvirtualShortMethodA)(env,
603                                                  request-&gt;instance,
604                                                  request-&gt;clazz,
605                                                  request-&gt;method,
606                                                  request-&gt;arguments);
607             break;
608 
609         case JDWP_TAG(BOOLEAN):
610             request-&gt;returnValue.z = JNI_FUNC_PTR(env,CallNonvirtualBooleanMethodA)(env,
611                                                  request-&gt;instance,
612                                                  request-&gt;clazz,
613                                                  request-&gt;method,
614                                                  request-&gt;arguments);
615             break;
616 
617         case JDWP_TAG(VOID):
618             JNI_FUNC_PTR(env,CallNonvirtualVoidMethodA)(env,
619                                     request-&gt;instance,
620                                     request-&gt;clazz,
621                                     request-&gt;method,
622                                     request-&gt;arguments);
623             break;
624 
625         default:
626             EXIT_ERROR(AGENT_ERROR_NULL_POINTER,&quot;Invalid method signature&quot;);
627             break;
628     }
629 }
630 
631 jboolean
632 invoker_doInvoke(jthread thread)
633 {
634     JNIEnv *env;
635     jboolean startNow;
636     InvokeRequest *request;
637     jbyte options;
638     jbyte invokeType;
639 
640     JDI_ASSERT(thread);
641 
642     debugMonitorEnter(invokerLock);
643 
644     request = threadControl_getInvokeRequest(thread);
645     if (request == NULL) {
646         EXIT_ERROR(AGENT_ERROR_INVALID_THREAD, &quot;getting thread invoke request&quot;);
647     }
648 
649     request-&gt;available = JNI_FALSE;
650     startNow = request-&gt;pending &amp;&amp; !request-&gt;started;
651 
652     if (startNow) {
653         request-&gt;started = JNI_TRUE;
654     }
655     options = request-&gt;options;
656     invokeType = request-&gt;invokeType;
657 
658     debugMonitorExit(invokerLock);
659 
660     if (!startNow) {
661         return JNI_FALSE;
662     }
663 
664     env = getEnv();
665 
666     WITH_LOCAL_REFS(env, 2) {  /* 1 for obj return values, 1 for exception */
667 
668         jobject exception;
669 
670         JNI_FUNC_PTR(env,ExceptionClear)(env);
671 
672         switch (invokeType) {
673             case INVOKE_CONSTRUCTOR:
674                 invokeConstructor(env, request);
675                 break;
676             case INVOKE_STATIC:
677                 invokeStatic(env, request);
678                 break;
679             case INVOKE_INSTANCE:
680                 if (options &amp; JDWP_INVOKE_OPTIONS(NONVIRTUAL) ) {
681                     invokeNonvirtual(env, request);
682                 } else {
683                     invokeVirtual(env, request);
684                 }
685                 break;
686             default:
687                 JDI_ASSERT(JNI_FALSE);
688         }
689         request-&gt;exception = NULL;
690         exception = JNI_FUNC_PTR(env,ExceptionOccurred)(env);
691         if (exception != NULL) {
692             JNI_FUNC_PTR(env,ExceptionClear)(env);
693             saveGlobalRef(env, exception, &amp;(request-&gt;exception));
694         }
695 
696     } END_WITH_LOCAL_REFS(env);
697 
698     return JNI_TRUE;
699 }
700 
701 void
702 invoker_completeInvokeRequest(jthread thread)
703 {
704     JNIEnv *env = getEnv();
705     PacketOutputStream out;
706     jbyte tag;
707     jobject exc;
708     jvalue returnValue;
709     jint id;
710     InvokeRequest *request;
711     jboolean detached;
712     jboolean mustReleaseReturnValue = JNI_FALSE;
713 
714     JDI_ASSERT(thread);
715 
716     /* Prevent gcc errors on uninitialized variables. */
717     tag = 0;
718     exc = NULL;
719     id  = 0;
720 
721     eventHandler_lock(); /* for proper lock order */
722     debugMonitorEnter(invokerLock);
723 
724     request = threadControl_getInvokeRequest(thread);
725     if (request == NULL) {
726         EXIT_ERROR(AGENT_ERROR_INVALID_THREAD, &quot;getting thread invoke request&quot;);
727     }
728 
729     JDI_ASSERT(request-&gt;pending);
730     JDI_ASSERT(request-&gt;started);
731 
732     request-&gt;pending = JNI_FALSE;
733     request-&gt;started = JNI_FALSE;
734     request-&gt;available = JNI_TRUE; /* For next time around */
735 
736     detached = request-&gt;detached;
737     if (!detached) {
738         if (request-&gt;options &amp; JDWP_INVOKE_OPTIONS(SINGLE_THREADED)) {
739             (void)threadControl_suspendThread(thread, JNI_FALSE);
740         } else {
741             (void)threadControl_suspendAll();
742         }
743 
744         if (request-&gt;invokeType == INVOKE_CONSTRUCTOR) {
745             /*
746              * Although constructors technically have a return type of
747              * void, we return the object created.
748              */
749             tag = specificTypeKey(env, request-&gt;returnValue.l);
750         } else {
<a name="26" id="anc26"></a><span class="line-modified">751             tag = methodSignature_returnTag(request-&gt;methodSignature);</span>
752         }
753         id = request-&gt;id;
754         exc = request-&gt;exception;
755         returnValue = request-&gt;returnValue;
756 
757         /* Release return value and exception references, but delay the release
758          * until after the return packet was sent. */
<a name="27" id="anc27"></a><span class="line-added">759         jbyte returnType = methodSignature_returnTag(request-&gt;methodSignature);</span>
760         mustReleaseReturnValue = request-&gt;invokeType == INVOKE_CONSTRUCTOR ||
<a name="28" id="anc28"></a><span class="line-modified">761            isReferenceTag(returnType);</span>


762     }
763 
764     /*
765      * At this time, there&#39;s no need to retain global references on
766      * arguments since the reply is processed. No one will deal with
767      * this request ID anymore, so we must call deleteGlobalArgumentRefs().
768      *
769      * We cannot delete saved exception or return value references
770      * since otherwise a deleted handle would escape when writing
771      * the response to the stream. Instead, we clean those refs up
772      * after writing the respone.
773      */
774     deleteGlobalArgumentRefs(env, request);
775 
776     /* From now on, do not access the request structure anymore
777      * for this request id, because once we give up the invokerLock it may
778      * be immediately reused by a new invoke request.
779      */
780     request = NULL;
781 
782     /*
783      * Give up the lock before I/O operation
784      */
785     debugMonitorExit(invokerLock);
786     eventHandler_unlock();
787 
788     if (!detached) {
789         outStream_initReply(&amp;out, id);
790         (void)outStream_writeValue(env, &amp;out, tag, returnValue);
791         (void)outStream_writeObjectTag(env, &amp;out, exc);
792         (void)outStream_writeObjectRef(env, &amp;out, exc);
793         outStream_sendReply(&amp;out);
794     }
795 
796     /*
797      * Delete potentially saved global references of return value
798      * and exception
799      */
800     eventHandler_lock(); // for proper lock order
801     debugMonitorEnter(invokerLock);
802     if (mustReleaseReturnValue &amp;&amp; returnValue.l != NULL) {
803         tossGlobalRef(env, &amp;returnValue.l);
804     }
805     if (exc != NULL) {
806         tossGlobalRef(env, &amp;exc);
807     }
808     debugMonitorExit(invokerLock);
809     eventHandler_unlock();
810 }
811 
812 jboolean
813 invoker_isEnabled(jthread thread)
814 {
815     InvokeRequest *request;
816     jboolean isEnabled;
817 
818     JDI_ASSERT(thread);
819     debugMonitorEnter(invokerLock);
820     request = threadControl_getInvokeRequest(thread);
821     if (request == NULL) {
822         EXIT_ERROR(AGENT_ERROR_INVALID_THREAD, &quot;getting thread invoke request&quot;);
823     }
824     isEnabled = request-&gt;available;
825     debugMonitorExit(invokerLock);
826     return isEnabled;
827 }
828 
829 void
830 invoker_detach(InvokeRequest *request)
831 {
832     JDI_ASSERT(request);
833     debugMonitorEnter(invokerLock);
834     request-&gt;detached = JNI_TRUE;
835     debugMonitorExit(invokerLock);
836 }
<a name="29" id="anc29"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="29" type="hidden" />
</body>
</html>