<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>New src/jdk.crypto.ec/share/classes/sun/security/ec/ed/EdDSAParameters.java</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
  <body>
    <pre>
  1 /*
  2  * Copyright (c) 2020, Oracle and/or its affiliates. All rights reserved.
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.  Oracle designates this
  8  * particular file as subject to the &quot;Classpath&quot; exception as provided
  9  * by Oracle in the LICENSE file that accompanied this code.
 10  *
 11  * This code is distributed in the hope that it will be useful, but WITHOUT
 12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 14  * version 2 for more details (a copy is included in the LICENSE file that
 15  * accompanied this code).
 16  *
 17  * You should have received a copy of the GNU General Public License version
 18  * 2 along with this work; if not, write to the Free Software Foundation,
 19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 20  *
 21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 22  * or visit www.oracle.com if you need additional information or have any
 23  * questions.
 24  */
 25 package sun.security.ec.ed;
 26 
 27 import sun.security.ec.ParametersMap;
 28 import sun.security.provider.SHAKE256;
 29 import sun.security.util.ObjectIdentifier;
 30 import sun.security.util.KnownOIDs;
 31 import sun.security.util.math.*;
 32 import sun.security.util.math.intpoly.*;
 33 import sun.security.x509.AlgorithmId;
 34 
 35 import java.io.IOException;
 36 import java.math.BigInteger;
 37 import java.nio.charset.StandardCharsets;
 38 import java.security.*;
 39 import java.security.spec.*;
 40 import java.util.function.Function;
 41 
 42 /*
 43  * The set of parameters that defines an instance of the EdDSA signature
 44  * scheme.
 45  */
 46 public class EdDSAParameters {
 47 
 48     public interface DigesterFactory {
 49         // Default digest creator
 50         Digester createDigester();
 51 
 52         // Override this method if multiple key lengths are needed
 53         default Digester createDigester(int len) {
 54             return createDigester();
 55         }
 56 
 57         // Return a digest over all the provided byte arrays
 58         default byte[] digest(byte[]... data) {
 59             Digester d = createDigester();
 60             for (byte[] curData : data) {
 61                 d.update(curData, 0, curData.length);
 62             }
 63             return d.digest();
 64         }
 65     }
 66 
 67     // Hash for Ed25519
 68     private static class SHA512DigesterFactory implements DigesterFactory {
 69         @Override
 70         public Digester createDigester() {
 71             try {
 72                 MessageDigest md = MessageDigest.getInstance(&quot;SHA-512&quot;);
 73                 return new MessageDigester(md);
 74             } catch (NoSuchAlgorithmException ex) {
 75                 throw new ProviderException(ex);
 76             }
 77         }
 78     }
 79 
 80     // Hash for Ed448
 81     private static class SHAKE256DigesterFactory implements DigesterFactory {
 82         @Override
 83         // Most usage for Ed448 is 114bytes long
 84         public Digester createDigester() {
 85             return new SHAKE256Digester(114);
 86         }
 87 
 88         // Ed448 uses 64bytes long hasg for the signature message
 89         @Override
 90         public Digester createDigester(int len) {
 91             return new SHAKE256Digester(len);
 92         }
 93     }
 94 
 95     public interface Digester {
 96         void update(byte data);
 97         void update(byte[] data, int off, int len);
 98         byte[] digest();
 99     }
100 
101     private static class MessageDigester implements Digester {
102         private final MessageDigest md;
103 
104         private MessageDigester(MessageDigest md) {
105             this.md = md;
106         }
107 
108         @Override
109         public void update(byte data) {
110             md.update(data);
111         }
112         @Override
113         public void update(byte[] data, int off, int len) {
114             md.update(data, off, len);
115         }
116         @Override
117         public byte[] digest() {
118             return md.digest();
119         }
120     }
121 
122     private static class SHAKE256Digester implements Digester {
123         SHAKE256 md;
124 
125         SHAKE256Digester(int len) {
126             md = new SHAKE256(len);
127         }
128         @Override
129         public void update(byte data) {
130             md.update(data);
131         }
132         @Override
133         public void update(byte[] data, int off, int len) {
134             md.update(data, off, len);
135         }
136         @Override
137         public byte[] digest() {
138             return md.digest();
139         }
140     }
141 
142     static ParametersMap&lt;EdDSAParameters&gt; namedParams = new ParametersMap&lt;&gt;();
143 
144     private final String name;
145     private final ObjectIdentifier oid;
146     private final IntegerFieldModuloP field;
147     private final IntegerFieldModuloP orderField;
148     private final ImmutableIntegerModuloP d;
149     private final EdECOperations edOperations;
150     private final DigesterFactory digester;
151     private final int keyLength;
152     private final int bits;
153     private final int logCofactor;
154     private final Function&lt;EdDSAParameterSpec, byte[]&gt; dom;
155 
156     public EdDSAParameters(String name, ObjectIdentifier oid,
157                            IntegerFieldModuloP field,
158                            IntegerFieldModuloP orderField,
159                            ImmutableIntegerModuloP d,
160                            EdECOperations edOps,
161                            DigesterFactory digester,
162                            Function&lt;EdDSAParameterSpec, byte[]&gt; dom,
163                            int keyLength, int bits, int logCofactor) {
164         this.oid = oid;
165         this.name = name;
166         this.field = field;
167         this.orderField = orderField;
168         this.d = d;
169         this.edOperations = edOps;
170         this.digester = digester;
171         this.keyLength = keyLength;
172         this.bits = bits;
173         this.logCofactor = logCofactor;
174         this.dom = dom;
175     }
176 
177     public String getName() {
178         return name;
179     }
180     public ObjectIdentifier getOid() {
181         return oid;
182     }
183     public IntegerFieldModuloP getField() {
184         return field;
185     }
186     public IntegerFieldModuloP getOrderField() {
187         return orderField;
188     }
189     public ImmutableIntegerModuloP getD() {
190         return d;
191     }
192     public EdECOperations getEdOperations() {
193         return edOperations;
194     }
195     public int getKeyLength() {
196         return keyLength;
197     }
198     public int getBits() {
199         return bits;
200     }
201     public int getLogCofactor() {
202         return logCofactor;
203     }
204 
205     public Digester createDigester() {
206         return digester.createDigester();
207     }
208 
209     public Digester createDigester(int len) {
210         return digester.createDigester(len);
211     }
212 
213     public byte[] digest(byte[]... data) {
214         return digester.digest(data);
215     }
216 
217     public byte[] dom(EdDSAParameterSpec sigParams) {
218         return dom.apply(sigParams);
219     }
220 
221     private final static String prefixStr25519 =
222         &quot;SigEd25519 no Ed25519 collisions&quot;;
223     private final static String prefixStr448 = &quot;SigEd448&quot;;
224 
225     // Used for Ed25519
226     static byte[] dom2(EdDSAParameterSpec sigParams) {
227         if (!sigParams.isPrehash() &amp;&amp; !sigParams.getContext().isPresent()) {
228             return new byte[0];
229         }
230         return domImpl(prefixStr25519, sigParams);
231     }
232 
233     // Used for Ed488
234     static byte[] dom4(EdDSAParameterSpec sigParams) {
235         return domImpl(prefixStr448, sigParams);
236     }
237 
238     static byte[] domImpl(String prefixStr, EdDSAParameterSpec sigParams) {
239         byte[] prefix = prefixStr.getBytes(StandardCharsets.US_ASCII);
240         byte[] context = sigParams.getContext().orElse(new byte[0]);
241         int length = prefix.length + 2 + context.length;
242         byte[] result = new byte[length];
243         System.arraycopy(prefix, 0, result, 0, prefix.length);
244         byte x = (byte) (sigParams.isPrehash() ? 1 : 0);
245         result[prefix.length] = x;
246         result[prefix.length + 1] = (byte) context.length;
247         System.arraycopy(context, 0, result, prefix.length + 2,
248             context.length);
249         return result;
250     }
251 
252     static {
253         // set up Ed25519
254         IntegerFieldModuloP ed25519Field = new IntegerPolynomial25519();
255         IntegerFieldModuloP ed25519OrderField = new Curve25519OrderField();
256         BigInteger biD = new BigInteger(&quot;3709570593466943934313808350875&quot; +
257                 &quot;4565189542113879843219016388785533085940283555&quot;);
258         ImmutableIntegerModuloP d = ed25519Field.getElement(biD);
259         BigInteger baseX = new BigInteger(&quot;15112221349535400772501151409&quot; +
260                 &quot;588531511454012693041857206046113283949847762202&quot;);
261         BigInteger baseY = new BigInteger(&quot;46316835694926478169428394003&quot; +
262                 &quot;475163141307993866256225615783033603165251855960&quot;);
263         EdECOperations edOps = new Ed25519Operations(d, baseX, baseY);
264         String name = NamedParameterSpec.ED25519.getName();
265         ObjectIdentifier oid = ObjectIdentifier.of(KnownOIDs.Ed25519);
266         int bits = 255;
267         DigesterFactory digester = new SHA512DigesterFactory();
268         EdDSAParameters params = new EdDSAParameters(name, oid,
269                 ed25519Field, ed25519OrderField, d, edOps,
270                 digester, EdDSAParameters::dom2, 32, bits, 3);
271 
272         namedParams.put(name, oid, bits, params);
273 
274         // set up Ed448
275         IntegerFieldModuloP ed448Field = new IntegerPolynomial448();
276         IntegerFieldModuloP ed448OrderField = new Curve448OrderField();
277         biD = ed448Field.getSize().subtract(new BigInteger(&quot;39081&quot;));
278         d = ed448Field.getElement(biD);
279         baseX = new BigInteger(&quot;224580040295924300187604334&quot; +
280                 &quot;099896036246789641632564134246125461686950415467406032909&quot; +
281                 &quot;029192869357953282578032075146446173674602635247710&quot;);
282         baseY = new BigInteger(&quot;298819210078481492676017930&quot; +
283                 &quot;443930673437544040154080242095928241372331506189835876003&quot; +
284                 &quot;536878655418784733982303233503462500531545062832660&quot;);
285         edOps = new Ed448Operations(d, baseX, baseY);
286         name = NamedParameterSpec.ED448.getName();
287         oid = ObjectIdentifier.of(KnownOIDs.Ed448);
288         bits = 448;
289         digester = new SHAKE256DigesterFactory();
290         params = new EdDSAParameters(name, oid,
291                 ed448Field, ed448OrderField, d, edOps,
292                 digester, EdDSAParameters::dom4, 57, bits, 2);
293 
294         namedParams.put(name, oid, bits, params);
295 
296         namedParams.fix();
297     }
298 
299     public static
300     &lt;T extends Throwable&gt;
301     EdDSAParameters getBySize(Function&lt;String, T&gt; exception,
302                             int size) throws T {
303 
304         return namedParams.getBySize(exception, size);
305     }
306 
307     public static
308     &lt;T extends Throwable&gt;
309     EdDSAParameters get(Function&lt;String, T&gt; exception,
310                       AlgorithmId algId) throws T {
311 
312         return namedParams.get(exception, algId);
313     }
314 
315     public static
316     &lt;T extends Throwable&gt;
317     EdDSAParameters get(Function&lt;String, T&gt; exception,
318                       AlgorithmParameterSpec params) throws T {
319 
320         return namedParams.get(exception, params);
321     }
322 }
    </pre>
  </body>
</html>