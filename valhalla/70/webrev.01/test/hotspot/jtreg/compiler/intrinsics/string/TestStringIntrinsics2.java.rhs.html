<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames test/hotspot/jtreg/compiler/intrinsics/string/TestStringIntrinsics2.java</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
  2  * Copyright (c) 2016, 2020, Oracle and/or its affiliates. All rights reserved.
  3  * Copyright (c) 2016 SAP SE. All rights reserved.
  4  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  5  *
  6  * This code is free software; you can redistribute it and/or modify it
  7  * under the terms of the GNU General Public License version 2 only, as
  8  * published by the Free Software Foundation.
  9  *
 10  * This code is distributed in the hope that it will be useful, but WITHOUT
 11  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 12  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 13  * version 2 for more details (a copy is included in the LICENSE file that
 14  * accompanied this code).
 15  *
 16  * You should have received a copy of the GNU General Public License version
 17  * 2 along with this work; if not, write to the Free Software Foundation,
 18  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 19  *
 20  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 21  * or visit www.oracle.com if you need additional information or have any
 22  * questions.
 23  */
 24 
 25 /*
 26  * @test
 27  * @bug 8145336
 28  * @summary PPC64: fix string intrinsics after CompactStrings change
 29  * @modules java.base/jdk.internal.misc
 30  * @library /test/lib
 31  *
 32  * @build sun.hotspot.WhiteBox
 33  * @run driver ClassFileInstaller sun.hotspot.WhiteBox
 34  *
 35  * @run main/othervm
 36  *        -Xbootclasspath/a:.
 37  *        -Xmixed
 38  *        -XX:+UnlockDiagnosticVMOptions
 39  *        -XX:+WhiteBoxAPI
<a name="1" id="anc1"></a><span class="line-added"> 40  *        -XX:+IgnoreUnrecognizedVMOptions</span>
 41  *        -XX:MaxInlineSize=70
 42  *        -XX:MinInliningThreshold=0
 43  *        compiler.intrinsics.string.TestStringIntrinsics2
 44  */
 45 
 46 package compiler.intrinsics.string;
 47 
 48 import sun.hotspot.WhiteBox;
 49 
 50 import java.lang.annotation.ElementType;
 51 import java.lang.annotation.Retention;
 52 import java.lang.annotation.RetentionPolicy;
 53 import java.lang.annotation.Target;
 54 import java.util.Arrays;
 55 import java.util.function.Consumer;
 56 
 57 import static jdk.test.lib.Asserts.assertEquals;
 58 import static jdk.test.lib.Asserts.assertFalse;
 59 import static jdk.test.lib.Asserts.assertTrue;
 60 
 61 public class TestStringIntrinsics2 {
 62     // ------------------------------------------------------------------------
 63     //
 64     // We test the following cases:
 65     // - no match in string.  Do we miss the end condition? Will crash if we read
 66     //   past the string.
 67     // - no match in string, but after the string there is a match.
 68     //   Do we incorrectly report this match?  We had a case where we stepped
 69     //   a few chars past the string, this test would report that error. The
 70     //   one above would not.
 71     // - The needle is exactly at the end of the string.
 72     // - The needle spans the end of the string
 73     //
 74     // A special case are needles of length 1. For these we test:
 75     // - needle is first char
 76     // - needle is last char
 77     // - no match
 78     // - match behind string.
 79     //
 80     // We test all these for an unknown needle, and needles known to the compiler
 81     // of lengths 5, 2 and 1.
 82 
 83 
 84     private static final WhiteBox WB = WhiteBox.getWhiteBox();
 85 
 86     public enum Role {
 87         TEST_ENTRY,
 88         TEST_HELPER
 89     }
 90 
 91     @Retention(RetentionPolicy.RUNTIME)
 92     @Target(ElementType.METHOD)
 93     @interface Test {
 94         Role role();
 95         int compileAt() default 0;
 96         int warmup() default 0;
 97         String[] warmupArgs() default {};
 98     }
 99 
100     // All this mess is needed to avoid try/catch inside the lambdas below.
101     // See: http://stackoverflow.com/questions/27644361/how-can-i-throw-checked-exceptions-from-inside-java-8-streams
102     @SuppressWarnings (&quot;unchecked&quot;)
103     private static &lt;E extends Throwable&gt; void throwAsUnchecked(Exception exception) throws E {
104         throw (E)exception;
105     }
106     @FunctionalInterface
107     public interface Consumer_WithExceptions&lt;T, E extends Exception&gt; {
108         void accept(T t) throws E;
109     }
110     public static &lt;T, E extends Exception&gt; Consumer&lt;T&gt; rethrowConsumer(Consumer_WithExceptions&lt;T, E&gt; consumer) {
111         return t -&gt; {
112             try { consumer.accept(t); }
113             catch (Exception exception) { throwAsUnchecked(exception); }
114         };
115     }
116 
117     public static void main(String[] args) throws Exception {
118 
119         // Warmup helper methods
120         Arrays.stream(TestStringIntrinsics2.class.getDeclaredMethods())
121             .filter(m -&gt; m.isAnnotationPresent(Test.class))
122             .filter(m -&gt; m.getAnnotation(Test.class).warmup() &gt; 0)
123             .forEach(rethrowConsumer(m -&gt; {
124                         Test a = m.getAnnotation(Test.class);
125                         System.out.println(&quot;Warming up &quot; + m + &quot; &quot; + a.warmup() + &quot; time(s) &quot;);
126                         for (int i=0; i &lt; a.warmup(); i++) {
127                             m.invoke(null, (Object[])a.warmupArgs());
128                         }
129                     }));
130 
131         // Compile helper methods
132         Arrays.stream(TestStringIntrinsics2.class.getDeclaredMethods())
133             .filter(m -&gt; m.isAnnotationPresent(Test.class))
134             .filter(m -&gt; m.getAnnotation(Test.class).compileAt() &gt; 0)
135             .forEach(rethrowConsumer(m -&gt; {
136                         Test a = m.getAnnotation(Test.class);
137                         if (WB.isMethodCompilable(m, a.compileAt())) {
138                             WB.enqueueMethodForCompilation(m, a.compileAt());
139                             while (WB.isMethodQueuedForCompilation(m)) Thread.sleep(10);
140                             System.out.println(m + &quot; compiled at &quot; + WB.getMethodCompilationLevel(m));
141                         } else {
142                             System.out.println(&quot;Can&#39;t compile &quot; + m + &quot; at level &quot; + a.compileAt());
143                         }
144                     }));
145 
146         // Run test methods
147         Arrays.stream(TestStringIntrinsics2.class.getDeclaredMethods())
148             .filter(m -&gt; m.isAnnotationPresent(Test.class))
149             .filter(m -&gt; m.getAnnotation(Test.class).role() == Role.TEST_ENTRY)
150             .forEach(rethrowConsumer(m -&gt; {
151                         System.out.print(&quot;Executing &quot; + m);
152                         m.invoke(null, (Object[])null);
153                         System.out.println(&quot; - OK&quot;);
154                     }));
155     }
156 
157     static String text = &quot;&lt;t&gt;&lt;t&gt;&lt;t&gt;&lt;t&gt;&lt;t&gt;&lt;t&gt;\n&quot; + &quot;&lt;hit&gt;&quot;;
158     static String text2 = &quot;&lt;t&gt;&lt;t&gt;&lt;t&gt;&lt;t&gt;&lt;t&gt;&lt;t&gt;&lt;t&gt;\n&quot; + &quot;&lt;hit&gt;&quot;;
159     static String[] ss = text.split(&quot;\n&quot;);
160     static String[] ss2 = null;
161     static String needle = &quot;&lt;miss&gt;&quot;;
162 
163     @Test(role = Role.TEST_ENTRY)
164     public static void test_indexOf_no_match() {
165         int res = indexOf_no_match_unknown_needle(ss[0], &quot;&lt;miss&gt;&quot;);
166         assertEquals(res, -1, &quot;test_indexOf_no_match_unknown_needle matched at: &quot; + res);
167         res = indexOf_no_match_imm_needle(ss[0]);
168         assertEquals(res, -1, &quot;test_indexOf_no_match_imm_needle matched at: &quot; + res);
169         res = indexOf_no_match_imm2_needle(ss[0]);
170         assertEquals(res, -1, &quot;test_indexOf_no_match_imm2_needle matched at: &quot; + res);
171 
172         if (ss2 == null) ss2 = text.split(&quot;\n&quot;);
173         res = indexOf_no_match_unknown_needle(ss2[0], &quot;&lt;miss&gt;&quot;);
174         assertEquals(res, -1, &quot;test_indexOf_no_match_unknown_needle matched at: &quot; + res);
175         res = indexOf_no_match_imm_needle(ss2[0]);
176         assertEquals(res, -1, &quot;test_indexOf_no_match_imm_needle matched at: &quot; + res);
177         res = indexOf_no_match_imm2_needle(ss2[0]);
178         assertEquals(res, -1, &quot;test_indexOf_no_match_imm2_needle matched at: &quot; + res);
179         res = indexOf_no_match_imm1_needle(ss2[0]);
180         assertEquals(res, -1, &quot;test_indexOf_no_match_imm1_needle matched at: &quot; + res);
181     }
182 
183     @Test(role = Role.TEST_HELPER, compileAt = 4, warmup = 1, warmupArgs = { &quot;&lt;t&gt;&lt;t&gt;&lt;t&gt;&quot;, &quot;&lt;miss&gt;&quot; })
184     static int indexOf_no_match_unknown_needle(String s, String needle) {
185         int index = s.indexOf(needle);
186         return index;
187     }
188 
189     @Test(role = Role.TEST_HELPER, compileAt = 4, warmup = 1, warmupArgs = { &quot;&lt;t&gt;&lt;t&gt;&lt;t&gt;&quot; })
190     static int indexOf_no_match_imm_needle(String s) {
191         int index = s.indexOf(&quot;&lt;hitt&gt;&quot;);
192         return index;
193     }
194 
195     @Test(role = Role.TEST_HELPER, compileAt = 4, warmup = 1, warmupArgs = { &quot;&lt;t&gt;&lt;t&gt;&lt;t&gt;&quot; })
196     static int indexOf_no_match_imm2_needle(String s) {
197         int index = s.indexOf(&quot;&lt;m&quot;);
198         return index;
199     }
200 
201     @Test(role = Role.TEST_HELPER, compileAt = 4, warmup = 1, warmupArgs = { &quot;&lt;t&gt;&lt;t&gt;&lt;t&gt;&quot; })
202     static int indexOf_no_match_imm1_needle(String s) {
203         int index = s.indexOf(&quot;m&quot;);
204         return index;
205     }
206 
207     @Test(role = Role.TEST_ENTRY)
208     public static void test_indexOf_reads_past_string() {
209         if (ss == null) ss = text.split(&quot;\n&quot;);
210         String res = indexOf_reads_past_string_unknown_needle(ss[0], &quot;&lt;hit&gt;&quot;);
211         assertEquals(res, null, &quot;test_indexOf_reads_past_string_unknown_needle &quot; + res);
212         res = indexOf_reads_past_string_imm_needle(ss[0]);
213         assertEquals(res, null, &quot;test_indexOf_reads_past_string_imm_needle &quot; + res);
214         res = indexOf_reads_past_string_imm2_needle(ss[0]);
215         assertEquals(res, null, &quot;test_indexOf_reads_past_string_imm2_needle &quot; + res);
216         res = indexOf_reads_past_string_imm1_needle(ss[0]);
217         assertEquals(res, null, &quot;test_indexOf_reads_past_string_imm1_needle &quot; + res);
218     }
219 
220     @Test(role = Role.TEST_HELPER, compileAt = 4, warmup = 1, warmupArgs = { &quot;&lt;t&gt;&lt;t&gt;&lt;t&gt;&quot;, &quot;&lt;hit&gt;&quot; })
221     static String indexOf_reads_past_string_unknown_needle(String s, String needle) {
222         int index = s.indexOf(needle);
223         if (index &gt; s.length()) {
224             return &quot;Found needle \&quot;&quot; + needle + &quot;\&quot; behind string of length &quot; + s.length()
225                 + &quot; at position &quot; + index + &quot;.&quot;;
226         }
227         return null;
228     }
229 
230     @Test(role = Role.TEST_HELPER, compileAt = 4, warmup = 1, warmupArgs = { &quot;&lt;t&gt;&lt;t&gt;&lt;t&gt;&quot; })
231     static String indexOf_reads_past_string_imm_needle(String s) {
232         int index = s.indexOf(&quot;&lt;hit&gt;&quot;);
233         if (index &gt; s.length()) {
234             return &quot;Found needle \&quot;&lt;hit&gt;\&quot; behind string of length &quot; + s.length() + &quot; at position &quot; + index + &quot;.&quot;;
235         }
236         return null;
237     }
238 
239     @Test(role = Role.TEST_HELPER, compileAt = 4, warmup = 1, warmupArgs = { &quot;&lt;t&gt;&lt;t&gt;&lt;t&gt;&quot; })
240     static String indexOf_reads_past_string_imm2_needle(String s) {
241         int index = s.indexOf(&quot;&lt;h&quot;);
242         if (index &gt; s.length()) {
243             return &quot;Found needle \&quot;&lt;h\&quot; behind string of length &quot; + s.length() + &quot; at position &quot; + index + &quot;.&quot;;
244         }
245         return null;
246     }
247 
248     @Test(role = Role.TEST_HELPER, compileAt = 4, warmup = 1, warmupArgs = { &quot;&lt;t&gt;&lt;t&gt;&lt;t&gt;&quot; })
249     static String indexOf_reads_past_string_imm1_needle(String s) {
250         int index = s.indexOf(&quot;h&quot;);
251         if (index &gt; s.length()) {
252             return &quot;Found needle \&quot;&lt;h\&quot; behind string of length &quot; + s.length() + &quot; at position &quot; + index + &quot;.&quot;;
253         }
254         return null;
255     }
256 
257     static String text3 =    &quot;&lt;t&gt;&lt;hi&gt;&lt;t&gt;&lt;h&gt;&lt;hit&lt;t&gt;&lt;hit&gt;&quot;;
258     static String text4 =   &quot;a&lt;t&gt;&lt;hi&gt;&lt;t&gt;&lt;h&gt;&lt;hit&lt;t&gt;&lt;hit&gt;&quot;;
259     static String text5 =  &quot;gg&lt;t&gt;&lt;hi&gt;&lt;t&gt;&lt;h&gt;&lt;hit&lt;t&gt;&lt;hit&gt;&quot;;
260     static String text6 = &quot;ccc&lt;t&gt;&lt;hi&gt;&lt;t&gt;&lt;h&gt;&lt;hit&lt;t&gt;&lt;hit&gt;&quot;;
261     static int len3 = text3.length();
262     static int len4 = text4.length();
263     static int len5 = text5.length();
264     static int len6 = text6.length();
265 
266     static String text7  =    &quot;&lt;t&gt;&lt;t&gt;&lt;t&gt;&lt;t&gt;&lt;t&lt;t&gt;&lt;h&quot;;
267     static String text8  =   &quot;a&lt;t&gt;&lt;t&gt;&lt;t&gt;&lt;t&gt;&lt;t&lt;t&gt;&lt;h&quot;;
268     static String text9  =  &quot;gg&lt;t&gt;&lt;t&gt;&lt;t&gt;&lt;t&gt;&lt;t&lt;t&gt;&lt;h&quot;;
269     static String text10 = &quot;ccc&lt;t&gt;&lt;t&gt;&lt;t&gt;&lt;t&gt;&lt;t&lt;t&gt;&lt;h&quot;;
270 
271     @Test(role = Role.TEST_ENTRY)
272     public static void test_indexOf_match_at_end_of_string() {
273         String testname = &quot;test_indexOf_match_at_end_of_string&quot;;
274         int res = 0;
275         res = indexOf_match_at_end_of_string_unknown_needle(text3, &quot;&lt;hit&gt;&quot;);
276         assertEquals(len3, res + 5, testname);
277         res = indexOf_match_at_end_of_string_unknown_needle(text4, &quot;&lt;hit&gt;&quot;);
278         assertEquals(len4, res + 5, testname);
279         res = indexOf_match_at_end_of_string_unknown_needle(text5, &quot;&lt;hit&gt;&quot;);
280         assertEquals(len5, res + 5, testname);
281         res = indexOf_match_at_end_of_string_unknown_needle(text6, &quot;&lt;hit&gt;&quot;);
282         assertEquals(len6, res + 5, testname);
283 
284         res = indexOf_match_at_end_of_string_imm_needle(text3);
285         assertEquals(len3, res + 5, testname);
286         res = indexOf_match_at_end_of_string_imm_needle(text4);
287         assertEquals(len4, res + 5, testname);
288         res = indexOf_match_at_end_of_string_imm_needle(text5);
289         assertEquals(len5, res + 5, testname);
290         res = indexOf_match_at_end_of_string_imm_needle(text6);
291         assertEquals(len6, res + 5, testname);
292 
293         res = indexOf_match_at_end_of_string_imm2_needle(text7);
294         assertEquals(text7.length(),  res + 2, testname);
295         res = indexOf_match_at_end_of_string_imm2_needle(text8);
296         assertEquals(text8.length(),  res + 2, testname);
297         res = indexOf_match_at_end_of_string_imm2_needle(text9);
298         assertEquals(text9.length(),  res + 2, testname);
299         res = indexOf_match_at_end_of_string_imm2_needle(text10);
300         assertEquals(text10.length(), res + 2, testname);
301 
302         res = indexOf_match_at_end_of_string_imm1_needle(text7);
303         assertEquals(text7.length(),  res + 1, testname);
304         res = indexOf_match_at_end_of_string_imm1_needle(text8);
305         assertEquals(text8.length(),  res + 1, testname);
306         res = indexOf_match_at_end_of_string_imm1_needle(text9);
307         assertEquals(text9.length(),  res + 1, testname);
308         res = indexOf_match_at_end_of_string_imm1_needle(text10);
309         assertEquals(text10.length(), res + 1, testname);
310     }
311 
312     @Test(role = Role.TEST_HELPER, compileAt = 4, warmup = 1, warmupArgs = { &quot;&lt;t&gt;&lt;hi&gt;&lt;t&gt;&lt;h&gt;&lt;hit&lt;t&gt;&lt;hit&gt;&quot;, &quot;&lt;hit&gt;&quot; })
313     static int indexOf_match_at_end_of_string_unknown_needle(String s, String needle) {
314         int index = s.indexOf(needle);
315         return index;
316     }
317 
318     @Test(role = Role.TEST_HELPER, compileAt = 4, warmup = 1, warmupArgs = { &quot;&lt;t&gt;&lt;hi&gt;&lt;t&gt;&lt;h&gt;&lt;hit&lt;t&gt;&lt;hit&gt;&quot; })
319     static int indexOf_match_at_end_of_string_imm_needle(String s) {
320         int index = s.indexOf(&quot;&lt;hit&gt;&quot;);
321         return index;
322     }
323 
324     @Test(role = Role.TEST_HELPER, compileAt = 4, warmup = 1, warmupArgs = { &quot;&lt;t&gt;&lt;hi&gt;&lt;t&gt;&lt;h&gt;&lt;hit&lt;t&gt;&lt;hit&gt;&quot; })
325     static int indexOf_match_at_end_of_string_imm2_needle(String s) {
326         int index = s.indexOf(&quot;&lt;h&quot;);
327         return index;
328     }
329 
330     @Test(role = Role.TEST_HELPER, compileAt = 4, warmup = 1, warmupArgs = { &quot;&lt;t&gt;&lt;hi&gt;&lt;t&gt;&lt;h&gt;&lt;hit&lt;t&gt;&lt;hit&gt;&quot; })
331     static int indexOf_match_at_end_of_string_imm1_needle(String s) {
332         int index = s.indexOf(&quot;h&quot;);
333         return index;
334     }
335 
336     static String s0_1 = text3.substring(0, len3-1);
337     static String s0_2 = text3.substring(0, len3-2);
338     static String s0_3 = text3.substring(0, len3-3);
339     static String s0_4 = text3.substring(0, len3-4);
340     static String s1_1 = text4.substring(0, len4-1);
341     static String s1_2 = text4.substring(0, len4-2);
342     static String s1_3 = text4.substring(0, len4-3);
343     static String s1_4 = text4.substring(0, len4-4);
344     static String s2_1 = text5.substring(0, len5-1);
345     static String s2_2 = text5.substring(0, len5-2);
346     static String s2_3 = text5.substring(0, len5-3);
347     static String s2_4 = text5.substring(0, len5-4);
348     static String s3_1 = text6.substring(0, len6-1);
349     static String s3_2 = text6.substring(0, len6-2);
350     static String s3_3 = text6.substring(0, len6-3);
351     static String s3_4 = text6.substring(0, len6-4);
352 
353     static String s0_1x = text7 .substring(0, text7 .length()-1);
354     static String s1_1x = text8 .substring(0, text8 .length()-1);
355     static String s2_1x = text9 .substring(0, text9 .length()-1);
356     static String s3_1x = text10.substring(0, text10.length()-1);
357 
358     @Test(role = Role.TEST_ENTRY)
359     public static void test_indexOf_match_spans_end_of_string() {
360         String res = null;
361         res = indexOf_match_spans_end_of_string_unknown_needle(s0_1, &quot;&lt;hit&gt;&quot;);
362         assertEquals(res, null, &quot;test_indexOf_match_spans_end_of_string_unknown_needle s0_1 &quot; + res);
363         res = indexOf_match_spans_end_of_string_unknown_needle(s0_2, &quot;&lt;hit&gt;&quot;);
364         assertEquals(res, null, &quot;test_indexOf_match_spans_end_of_string_unknown_needle s0_2 &quot; + res);
365         res = indexOf_match_spans_end_of_string_unknown_needle(s0_3, &quot;&lt;hit&gt;&quot;);
366         assertEquals(res, null, &quot;test_indexOf_match_spans_end_of_string_unknown_needle s0_3 &quot; + res);
367         res = indexOf_match_spans_end_of_string_unknown_needle(s0_4, &quot;&lt;hit&gt;&quot;);
368         assertEquals(res, null, &quot;test_indexOf_match_spans_end_of_string_unknown_needle s0_4 &quot; + res);
369         res = indexOf_match_spans_end_of_string_unknown_needle(s1_1, &quot;&lt;hit&gt;&quot;);
370         assertEquals(res, null, &quot;test_indexOf_match_spans_end_of_string_unknown_needle s1_1 &quot; + res);
371         res = indexOf_match_spans_end_of_string_unknown_needle(s1_2, &quot;&lt;hit&gt;&quot;);
372         assertEquals(res, null, &quot;test_indexOf_match_spans_end_of_string_unknown_needle s1_2 &quot; + res);
373         res = indexOf_match_spans_end_of_string_unknown_needle(s1_3, &quot;&lt;hit&gt;&quot;);
374         assertEquals(res, null, &quot;test_indexOf_match_spans_end_of_string_unknown_needle s1_3 &quot; + res);
375         res = indexOf_match_spans_end_of_string_unknown_needle(s1_4, &quot;&lt;hit&gt;&quot;);
376         assertEquals(res, null, &quot;test_indexOf_match_spans_end_of_string_unknown_needle s1_4 &quot; + res);
377         res = indexOf_match_spans_end_of_string_unknown_needle(s2_1, &quot;&lt;hit&gt;&quot;);
378         assertEquals(res, null, &quot;test_indexOf_match_spans_end_of_string_unknown_needle s2_1 &quot; + res);
379         res = indexOf_match_spans_end_of_string_unknown_needle(s2_2, &quot;&lt;hit&gt;&quot;);
380         assertEquals(res, null, &quot;test_indexOf_match_spans_end_of_string_unknown_needle s2_2 &quot; + res);
381         res = indexOf_match_spans_end_of_string_unknown_needle(s2_3, &quot;&lt;hit&gt;&quot;);
382         assertEquals(res, null, &quot;test_indexOf_match_spans_end_of_string_unknown_needle s2_3 &quot; + res);
383         res = indexOf_match_spans_end_of_string_unknown_needle(s2_4, &quot;&lt;hit&gt;&quot;);
384         assertEquals(res, null, &quot;test_indexOf_match_spans_end_of_string_unknown_needle s2_4 &quot; + res);
385         res = indexOf_match_spans_end_of_string_unknown_needle(s3_1, &quot;&lt;hit&gt;&quot;);
386         assertEquals(res, null, &quot;test_indexOf_match_spans_end_of_string_unknown_needle s3_1 &quot; + res);
387         res = indexOf_match_spans_end_of_string_unknown_needle(s3_2, &quot;&lt;hit&gt;&quot;);
388         assertEquals(res, null, &quot;test_indexOf_match_spans_end_of_string_unknown_needle s3_2 &quot; + res);
389         res = indexOf_match_spans_end_of_string_unknown_needle(s3_3, &quot;&lt;hit&gt;&quot;);
390         assertEquals(res, null, &quot;test_indexOf_match_spans_end_of_string_unknown_needle s3_3 &quot; + res);
391         res = indexOf_match_spans_end_of_string_unknown_needle(s3_4, &quot;&lt;hit&gt;&quot;);
392         assertEquals(res, null, &quot;test_indexOf_match_spans_end_of_string_unknown_needle s3_4 &quot; + res);
393 
394         res = indexOf_match_spans_end_of_string_imm_needle(s0_1);
395         assertEquals(res, null, &quot;test_indexOf_match_spans_end_of_string_imm_needle s0_1 &quot; + res);
396         res = indexOf_match_spans_end_of_string_imm_needle(s0_2);
397         assertEquals(res, null, &quot;test_indexOf_match_spans_end_of_string_imm_needle s0_2 &quot; + res);
398         res = indexOf_match_spans_end_of_string_imm_needle(s0_3);
399         assertEquals(res, null, &quot;test_indexOf_match_spans_end_of_string_imm_needle s0_3 &quot; + res);
400         res = indexOf_match_spans_end_of_string_imm_needle(s0_4);
401         assertEquals(res, null, &quot;test_indexOf_match_spans_end_of_string_imm_needle s0_4 &quot; + res);
402         res = indexOf_match_spans_end_of_string_imm_needle(s1_1);
403         assertEquals(res, null, &quot;test_indexOf_match_spans_end_of_string_imm_needle s1_1 &quot; + res);
404         res = indexOf_match_spans_end_of_string_imm_needle(s1_2);
405         assertEquals(res, null, &quot;test_indexOf_match_spans_end_of_string_imm_needle s1_2 &quot; + res);
406         res = indexOf_match_spans_end_of_string_imm_needle(s1_3);
407         assertEquals(res, null, &quot;test_indexOf_match_spans_end_of_string_imm_needle s1_3 &quot; + res);
408         res = indexOf_match_spans_end_of_string_imm_needle(s1_4);
409         assertEquals(res, null, &quot;test_indexOf_match_spans_end_of_string_imm_needle s1_4 &quot; + res);
410         res = indexOf_match_spans_end_of_string_imm_needle(s2_1);
411         assertEquals(res, null, &quot;test_indexOf_match_spans_end_of_string_imm_needle s2_1 &quot; + res);
412         res = indexOf_match_spans_end_of_string_imm_needle(s2_2);
413         assertEquals(res, null, &quot;test_indexOf_match_spans_end_of_string_imm_needle s2_2 &quot; + res);
414         res = indexOf_match_spans_end_of_string_imm_needle(s2_3);
415         assertEquals(res, null, &quot;test_indexOf_match_spans_end_of_string_imm_needle s2_3 &quot; + res);
416         res = indexOf_match_spans_end_of_string_imm_needle(s2_4);
417         assertEquals(res, null, &quot;test_indexOf_match_spans_end_of_string_imm_needle s2_4 &quot; + res);
418         res = indexOf_match_spans_end_of_string_imm_needle(s3_1);
419         assertEquals(res, null, &quot;test_indexOf_match_spans_end_of_string_imm_needle s3_1 &quot; + res);
420         res = indexOf_match_spans_end_of_string_imm_needle(s3_2);
421         assertEquals(res, null, &quot;test_indexOf_match_spans_end_of_string_imm_needle s3_2 &quot; + res);
422         res = indexOf_match_spans_end_of_string_imm_needle(s3_3);
423         assertEquals(res, null, &quot;test_indexOf_match_spans_end_of_string_imm_needle s3_3 &quot; + res);
424         res = indexOf_match_spans_end_of_string_imm_needle(s3_4);
425         assertEquals(res, null, &quot;test_indexOf_match_spans_end_of_string_imm_needle s3_4 &quot; + res);
426 
427         res = indexOf_match_spans_end_of_string_imm2_needle(s0_1x);
428         assertEquals(res, null, &quot;test_indexOf_match_spans_end_of_string_imm2_needle s0_1x &quot; + res);
429         res = indexOf_match_spans_end_of_string_imm2_needle(s1_1x);
430         assertEquals(res, null, &quot;test_indexOf_match_spans_end_of_string_imm2_needle s1_1x &quot; + res);
431         res = indexOf_match_spans_end_of_string_imm2_needle(s2_1x);
432         assertEquals(res, null, &quot;test_indexOf_match_spans_end_of_string_imm2_needle s2_1x &quot; + res);
433         res = indexOf_match_spans_end_of_string_imm2_needle(s3_1x);
434         assertEquals(res, null, &quot;test_indexOf_match_spans_end_of_string_imm2_needle s3_1x &quot; + res);
435     }
436 
437     @Test(role = Role.TEST_HELPER, compileAt = 4, warmup = 1, warmupArgs = { &quot;&lt;t&gt;&lt;hi&gt;&lt;t&gt;&lt;h&gt;&lt;hit&lt;t&gt;&lt;hit&quot;, &quot;&lt;hit&gt;&quot; })
438     static String indexOf_match_spans_end_of_string_unknown_needle(String s, String needle) {
439         int index = s.indexOf(needle);
440         if (index &gt; -1) {
441             return &quot;Found needle \&quot;&quot; + needle + &quot;\&quot; that is spanning the end of the string: &quot; + s + &quot;.&quot;;
442         }
443         return null;
444     }
445 
446     @Test(role = Role.TEST_HELPER, compileAt = 4, warmup = 1, warmupArgs = { &quot;&lt;t&gt;&lt;hi&gt;&lt;t&gt;&lt;h&gt;&lt;hit&lt;t&gt;&lt;hit&quot; })
447     static String indexOf_match_spans_end_of_string_imm_needle(String s) {
448         int index = s.indexOf(&quot;&lt;hit&gt;&quot;);
449         if (index &gt; -1) {
450             return &quot;Found needle \&quot;&lt;hit&gt;\&quot; that is spanning the end of the string: &quot; + s + &quot;.&quot;;
451         }
452         return null;
453     }
454 
455     @Test(role = Role.TEST_HELPER, compileAt = 4, warmup = 1, warmupArgs = { &quot;&lt;t&gt;&lt;t&gt;&lt;t&gt;&lt;t&gt;&lt;t&lt;t&gt;&lt;&quot; })
456     static String indexOf_match_spans_end_of_string_imm2_needle(String s) {
457         int index = s.indexOf(&quot;&lt;h&quot;);
458         if (index &gt; -1) {
459             return &quot;Found needle \&quot;&lt;h\&quot; that is spanning the end of the string: &quot; + s + &quot;.&quot;;
460         }
461         return null;
462     }
463 
464     static String text16 = &quot;ooooooo&quot;;
465     static String text11 = &quot;1ooooooo&quot;;
466     static String text12 = &quot;ooooooo1&quot;;
467     static String text13 = &quot;oooooooo1&quot;;
468     static String text14 = &quot;ooooooooo1&quot;;
469     static String text15 = &quot;oooooooooo1&quot;;
470     static int len12 = text12.length();
471     static int len13 = text13.length();
472     static int len14 = text14.length();
473     static int len15 = text15.length();
474 
475     static String text12_1 = text12.substring(0, len12-1);
476     static String text13_1 = text13.substring(0, len13-1);
477     static String text14_1 = text14.substring(0, len14-1);
478     static String text15_1 = text15.substring(0, len15-1);
479 
480     @Test(role = Role.TEST_ENTRY)
481     public static void test_indexOf_imm1_needle() {
482         assertEquals(     -1, indexOf_imm1_needle(text16), &quot;test_indexOf_imm1_needle no_match&quot;);
483 
484         assertEquals(      0, indexOf_imm1_needle(text11), &quot;test_indexOf_imm1_needle first_matches&quot;);
485 
486         assertEquals(len12-1, indexOf_imm1_needle(text12), &quot;test_indexOf_imm1_needle last_matches&quot;);
487         assertEquals(len13-1, indexOf_imm1_needle(text13), &quot;test_indexOf_imm1_needle last_matches&quot;);
488         assertEquals(len14-1, indexOf_imm1_needle(text14), &quot;test_indexOf_imm1_needle last_matches&quot;);
489         assertEquals(len15-1, indexOf_imm1_needle(text15), &quot;test_indexOf_imm1_needle last_matches&quot;);
490 
491         assertEquals(     -1, indexOf_imm1_needle(text12_1), &quot;test_indexOf_imm1_needle walked_past&quot;);
492         assertEquals(     -1, indexOf_imm1_needle(text13_1), &quot;test_indexOf_imm1_needle walked_past&quot;);
493         assertEquals(     -1, indexOf_imm1_needle(text14_1), &quot;test_indexOf_imm1_needle walked_past&quot;);
494         assertEquals(     -1, indexOf_imm1_needle(text15_1), &quot;test_indexOf_imm1_needle walked_past&quot;);
495     }
496 
497     @Test(role = Role.TEST_HELPER, compileAt = 4, warmup = 1, warmupArgs = { &quot;ooooooo1&quot; })
498     static int indexOf_imm1_needle(String s) {
499         return s.indexOf(&quot;1&quot;);
500     }
501 
502     static String text1UTF16 = &quot;A&quot; + &quot;\u05d0&quot; + &quot;\u05d1&quot; + &quot;B&quot;;
503 
504     @Test(role = Role.TEST_ENTRY)
505     public static void test_indexOf_immUTF16() {
506         assertEquals(      3, indexOf_imm1Latin1_needle(text1UTF16), &quot;test_indexOf_immUTF16&quot;);
507         assertEquals(      1, indexOf_imm1UTF16_needle(text1UTF16), &quot;test_indexOf_immUTF16&quot;);
508         assertEquals(      1, indexOf_immUTF16_needle(text1UTF16), &quot;test_indexOf_immUTF16&quot;);
509     }
510 
511     @Test(role = Role.TEST_HELPER, compileAt = 4, warmup = 1, warmupArgs = { &quot;A&quot; + &quot;\u05d0&quot; + &quot;\u05d1&quot; + &quot;B&quot; })
512     static int indexOf_imm1Latin1_needle(String s) {
513         return s.indexOf(&quot;B&quot;);
514     }
515 
516     @Test(role = Role.TEST_HELPER, compileAt = 4, warmup = 1, warmupArgs = { &quot;A&quot; + &quot;\u05d0&quot; + &quot;\u05d1&quot; + &quot;B&quot; })
517     static int indexOf_imm1UTF16_needle(String s) {
518         return s.indexOf(&quot;\u05d0&quot;);
519     }
520 
521     @Test(role = Role.TEST_HELPER, compileAt = 4, warmup = 1, warmupArgs = { &quot;A&quot; + &quot;\u05d0&quot; + &quot;\u05d1&quot; + &quot;B&quot; })
522     static int indexOf_immUTF16_needle(String s) {
523         return s.indexOf(&quot;\u05d0&quot; + &quot;\u05d1&quot;);
524     }
525 
526     @Test(role = Role.TEST_HELPER, compileAt = 4, warmup = 1, warmupArgs = { &quot;abc&quot;, &quot;abcd&quot; })
527     public static int asmStringCompareTo(String a, String b) {
528         return a.compareTo(b);
529     }
530 
531     @Test(role = Role.TEST_ENTRY)
532     public static void test_asmStringCompareTo() {
533         // null
534         try {
535             asmStringCompareTo(&quot;not null&quot;, null);
536             assertTrue(false,
537                        &quot;TestOther.asmStringCompareTo(\&quot;not null\&quot;, null) doesn&#39;t throw exception&quot;);
538         } catch (NullPointerException e) {
539             assertEquals(&quot;java.lang.String.compareTo&quot;,
540                          e.getStackTrace()[0].getClassName() + &quot;.&quot; +
541                          e.getStackTrace()[0].getMethodName(),
542                          &quot;TestOther.asmStringCompareTo(\&quot;not null\&quot;, null) throws exception&quot;);
543         }
544 
545         // ==0
546         {
547             // check length 0 optimization
548             assertEquals(0, asmStringCompareTo(&quot;&quot;, &quot;&quot;),
549                          &quot;TestOther.asmStringCompareTo(\&quot;\&quot;, \&quot;\&quot;)&quot;);
550 
551             // check first character optimization
552             assertEquals(0, asmStringCompareTo(&quot;A&quot;, &quot;A&quot;),
553                          &quot;TestOther.asmStringCompareTo(\&quot;A\&quot;, \&quot;A\&quot;)&quot;);
554 
555             // check real comparisons
556             assertEquals(0, asmStringCompareTo(new String(&quot;eq&quot;) + new String(&quot;ual&quot;), &quot;equal&quot;),
557                          &quot;TestOther.asmStringCompareTo(\&quot;equal\&quot;, \&quot;equal\&quot;)&quot;);
558             assertEquals(0, asmStringCompareTo(&quot;textABC&quot;, &quot;textABC&quot;),
559                          &quot;TestOther.asmStringCompareTo(\&quot;textABC\&quot;, \&quot;textABC\&quot;)&quot;);
560             assertEquals(0,
561                          asmStringCompareTo(new String(&quot;abcdefgh01234&quot;) +
562                                             new String(&quot;56abcdefgh0123456abcdefgh0123456&quot;),
563                                             &quot;abcdefgh0123456abcdefgh0123456abcdefgh0123456&quot;),
564                          &quot;TestOther.asmStringCompareTo(\&quot;abcdefgh0123456abcdefgh0123456abcdefgh0123456\&quot;, &quot; +
565                          &quot;\&quot;abcdefgh0123456abcdefgh0123456abcdefgh0123456\&quot;)&quot;);
566         }
567 
568         // &lt;0
569         {
570             // check first character optimization
571             assertEquals(-1, asmStringCompareTo(&quot;4&quot;, &quot;5&quot;),
572                          &quot;TestOther.asmStringCompareTo(\&quot;4\&quot;, \&quot;5\&quot;)&quot;);
573 
574             // check real comparisons
575             assertEquals(-1, asmStringCompareTo(&quot;diff4&quot;, &quot;diff5&quot;),
576                          &quot;TestOther.asmStringCompareTo(\&quot;diff4\&quot;, \&quot;diff5\&quot;)&quot;);
577             assertEquals(-10, asmStringCompareTo(&quot;&quot;, &quot;123456789A&quot;),
578                          &quot;TestOther.asmStringCompareTo(\&quot;\&quot;, \&quot;123456789A\&quot;)&quot;);
579             assertEquals(-10, asmStringCompareTo(&quot;ZYX&quot;, &quot;ZYX123456789A&quot;),
580                          &quot;TestOther.asmStringCompareTo(\&quot;ZYX\&quot;, \&quot;ZYX123456789A\&quot;)&quot;);
581         }
582 
583         // &gt;0
584         {
585             // check first character optimization
586             assertEquals(1, asmStringCompareTo(&quot;5&quot;, &quot;4&quot;),
587                          &quot;TestOther.asmStringCompareTo(\&quot;5\&quot;, \&quot;4\&quot;)&quot;);
588 
589             // check real comparisons
590             assertEquals(1, asmStringCompareTo(&quot;diff5&quot;, &quot;diff4&quot;),
591                          &quot;TestOther.asmStringCompareTo(\&quot;diff5\&quot;, \&quot;diff4\&quot;)&quot;);
592             assertEquals(10, asmStringCompareTo(&quot;123456789A&quot;, &quot;&quot;),
593                          &quot;TestOther.asmStringCompareTo(\&quot;123456789A\&quot;, \&quot;\&quot;)&quot;);
594             assertEquals(10, asmStringCompareTo(&quot;ZYX123456789A&quot;, &quot;ZYX&quot;),
595                          &quot;TestOther.asmStringCompareTo(\&quot;ZYX123456789A\&quot;, \&quot;ZYX\&quot;)&quot;);
596         }
597 
598         // very long strings (100k)
599         {
600             char[] ac = new char[(100 * 1024)];
601             for (int i = 0; i &lt; (100 * 1024); i += 315)
602                 ac[i] = (char) ((i % 12) + &#39;a&#39;);
603             char[] bc = new char[(100 * 1024)];
604             for (int i = 0; i &lt; (100 * 1024); i += 315)
605                 bc[i] = (char) ((i % 12) + &#39;a&#39;);
606 
607             ac[(100 * 1024) - 1] = &#39;2&#39;;
608             bc[(100 * 1024) - 1] = &#39;2&#39;;
609             String a1 = new String(ac);
610             String b1 = new String(bc);
611             assertEquals(0, asmStringCompareTo(a1, b1),
612                          &quot;TestOther.asmStringCompareTo(very_long_strings_1)&quot;);
613 
614             ac[(100 * 1024) - 1] = &#39;X&#39;;
615             bc[(100 * 1024) - 1] = &#39;Z&#39;;
616             String a2 = new String(ac);
617             String b2 = new String(bc);
618             assertEquals(-2, asmStringCompareTo(a2, b2),
619                          &quot;TestOther.asmStringCompareTo(very_long_strings_2)&quot;);
620         }
621 
622         // very very long strings (2M)
623         {
624             char[] ac = new char[(2 * 1024 * 1024)];
625             for (int i = 0; i &lt; (2 * 1024 * 1024); i += 315)
626                 ac[i] = (char) ((i % 12) + &#39;a&#39;);
627             char[] bc = new char[(2 * 1024 * 1024)];
628             for (int i = 0; i &lt; (2 * 1024 * 1024); i += 315)
629                 bc[i] = (char) ((i % 12) + &#39;a&#39;);
630 
631             ac[(2 * 1024 * 1024) - 1] = &#39;3&#39;;
632             bc[(2 * 1024 * 1024) - 1] = &#39;3&#39;;
633             String a1 = new String(ac);
634             String b1 = new String(bc);
635             assertEquals(0, asmStringCompareTo(a1, b1),
636                          &quot;TestOther.asmStringCompareTo(very_very_long_strings_1)&quot;);
637 
638             ac[(2 * 1024 * 1024) - 1] = &#39;W&#39;;
639             bc[(2 * 1024 * 1024) - 1] = &#39;Z&#39;;
640             String a2 = new String(ac);
641             String b2 = new String(bc);
642             assertEquals(-3, asmStringCompareTo(a2, b2),
643                          &quot;TestOther.asmStringCompareTo(very_very_long_strings_2)&quot;);
644         }
645 
646         // See bug 8215100
647         {
648             assertEquals(-20, asmStringCompareTo(&quot;e.\u0259.&quot;, &quot;y.e.&quot;));
649             assertEquals(20, asmStringCompareTo(&quot;y.e.&quot;, &quot;e.\u0259.&quot;));
650         }
651     }
652 
653 
654     @Test(role = Role.TEST_HELPER, compileAt = 4, warmup = 1, warmupArgs = { &quot;abc&quot;, &quot;abcd&quot; })
655     public static boolean asmStringEquals(String a, String b) {
656         return a.equals(b);
657     }
658 
659     static String a1 = &quot;abcd&quot;;
660     static String b1 = &quot;abcd&quot;;
661     static final String a2 = &quot;1234&quot;;
662     static final String b2 = &quot;1234&quot;;
663 
664     @Test(role = Role.TEST_HELPER, compileAt = 4, warmup = 1)
665     public static boolean asmStringEqualsConst() {
666         boolean ret = a1.equals(b1);
667         ret &amp;= a2.equals(b2);
668         ret &amp;= !a2.equals(b1);
669         ret &amp;= &quot;ABCD&quot;.equals(&quot;ABCD&quot;);
670         return ret;
671     }
672 
673 
674     @Test(role = Role.TEST_ENTRY)
675     public static void test_asmStringEquals() {
676         // null
677         {
678             assertFalse(asmStringEquals(&quot;not null&quot;, null),
679                         &quot;TestOther.asmStringEquals(\&quot;not null\&quot;, null)&quot;);
680         }
681 
682         // true
683         {
684             // check constant optimization
685             assertTrue(asmStringEqualsConst(),
686                        &quot;TestOther.asmStringEqualsConst(\&quot;\&quot;, \&quot;\&quot;)&quot;);
687 
688             // check length 0 optimization
689             assertTrue(asmStringEquals(&quot;&quot;, &quot;&quot;),
690                        &quot;TestOther.asmStringEquals(\&quot;\&quot;, \&quot;\&quot;)&quot;);
691 
692             // check first character optimization
693             assertTrue(asmStringEquals(&quot;A&quot;, &quot;A&quot;),
694                        &quot;TestOther.asmStringEquals(\&quot;A\&quot;, \&quot;A\&quot;)&quot;);
695 
696             // check real comparisons
697             assertTrue(asmStringEquals(new String(&quot;eq&quot;) + new String(&quot;ual&quot;), &quot;equal&quot;),
698                        &quot;TestOther.asmStringEquals(\&quot;equal\&quot;, \&quot;equal\&quot;)&quot;);
699             assertTrue(asmStringEquals(&quot;textABC&quot;, &quot;textABC&quot;),
700                        &quot;TestOther.asmStringEquals(\&quot;textABC\&quot;, \&quot;textABC\&quot;)&quot;);
701             assertTrue(asmStringEquals(new String(&quot;abcdefgh01234&quot;) +
702                                        new String(&quot;56abcdefgh0123456abcdefgh0123456&quot;),
703                                        &quot;abcdefgh0123456abcdefgh0123456abcdefgh0123456&quot;),
704                        &quot;TestOther.asmStringEquals(\&quot;abcdefgh0123456abcdefgh0123456abcdefgh0123456\&quot;, &quot; +
705                        &quot;\&quot;abcdefgh0123456abcdefgh0123456abcdefgh0123456\&quot;)&quot;);
706         }
707     }
708 
709 }
<a name="2" id="anc2"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="2" type="hidden" />
</body>
</html>