<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff test/hotspot/jtreg/runtime/cds/appcds/dynamicArchive/DynamicArchiveTestBase.java</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
  </head>
<body>
<center><a href="DynamicArchiveRelocationTest.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="DynamicLotsOfClasses.java.udiff.html" target="_top">next &gt;</a></center>    <h2>test/hotspot/jtreg/runtime/cds/appcds/dynamicArchive/DynamicArchiveTestBase.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -26,17 +26,20 @@</span>
  import jdk.test.lib.process.OutputAnalyzer;
  import jdk.test.lib.process.ProcessTools;
  import jdk.test.lib.cds.CDSOptions;
  import jdk.test.lib.cds.CDSTestUtils;
  import jdk.test.lib.cds.CDSTestUtils.Result;
<span class="udiff-line-added">+ import sun.hotspot.WhiteBox;</span>
  
  /**
   * Base class for test cases in test/hotspot/jtreg/runtime/cds/appcds/dynamicArchive/
   */
  class DynamicArchiveTestBase {
      private static boolean executedIn_run = false;
  
<span class="udiff-line-added">+     private static final WhiteBox WB = WhiteBox.getWhiteBox();</span>
<span class="udiff-line-added">+ </span>
      public static interface DynamicArchiveTest {
          public void run() throws Exception;
      }
  
      public static interface DynamicArchiveTestWithArgs {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -102,20 +105,26 @@</span>
      {
          String[] cmdLine = TestCommon.concat(
              &quot;-XX:ArchiveClassesAtExit=&quot; + topArchiveName);
          // to allow dynamic archive tests to be run in the &quot;rt-non-cds-mode&quot;
          cmdLine = TestCommon.concat(cmdLine, &quot;-Xshare:auto&quot;);
<span class="udiff-line-added">+         if (baseArchiveName == null &amp;&amp; isUseSharedSpacesDisabled()) {</span>
<span class="udiff-line-added">+             baseArchiveName = getTempBaseArchive();</span>
<span class="udiff-line-added">+         }</span>
          if (baseArchiveName != null) {
              cmdLine = TestCommon.concat(cmdLine, &quot;-XX:SharedArchiveFile=&quot; + baseArchiveName);
          }
          cmdLine = TestCommon.concat(cmdLine, cmdLineSuffix);
          return execProcess(&quot;dump&quot;, null, cmdLine);
      }
  
      public static Result dump2_WB(String baseArchiveName, String topArchiveName, String ... cmdLineSuffix)
          throws Exception
      {
<span class="udiff-line-added">+         if (baseArchiveName == null &amp;&amp; isUseSharedSpacesDisabled()) {</span>
<span class="udiff-line-added">+             baseArchiveName = getTempBaseArchive();</span>
<span class="udiff-line-added">+         }</span>
          return dump2(baseArchiveName, topArchiveName,
                       TestCommon.concat(wbRuntimeArgs(), cmdLineSuffix));
      }
  
      /**
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -129,32 +138,16 @@</span>
      {
          return dump2(null, topArchiveName, cmdLineSuffix);
      }
  
      /**
<span class="udiff-line-modified-removed">-      * Dump the base archive. The JDK&#39;s default class list is used (unless otherwise specified</span>
<span class="udiff-line-removed">-      * in cmdLineSuffix).</span>
<span class="udiff-line-removed">-      */</span>
<span class="udiff-line-removed">-     public static OutputAnalyzer dumpBaseArchive(String baseArchiveName, String ... cmdLineSuffix)</span>
<span class="udiff-line-removed">-         throws Exception</span>
<span class="udiff-line-removed">-     {</span>
<span class="udiff-line-removed">-         CDSOptions opts = new CDSOptions();</span>
<span class="udiff-line-removed">-         opts.setArchiveName(baseArchiveName);</span>
<span class="udiff-line-removed">-         opts.addSuffix(cmdLineSuffix);</span>
<span class="udiff-line-removed">-         opts.addSuffix(&quot;-Djava.class.path=&quot;);</span>
<span class="udiff-line-removed">-         OutputAnalyzer out = CDSTestUtils.createArchive(opts);</span>
<span class="udiff-line-removed">-         CDSTestUtils.checkDump(out);</span>
<span class="udiff-line-removed">-         return out;</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     /**</span>
<span class="udiff-line-removed">-      * Same as dumpBaseArchive, but also add WhiteBox to the bootcp</span>
<span class="udiff-line-modified-added">+      * Same as TestCommon.dumpBaseArchive, but also add WhiteBox to the bootcp</span>
       */
      public static void dumpBaseArchive_WB(String baseArchiveName, String ... cmdLineSuffix)
          throws Exception
      {
<span class="udiff-line-modified-removed">-         dumpBaseArchive(baseArchiveName,</span>
<span class="udiff-line-modified-added">+         TestCommon.dumpBaseArchive(baseArchiveName,</span>
                          TestCommon.concat(&quot;-Xbootclasspath/a:&quot; + getWhiteBoxJar(), cmdLineSuffix));
      }
  
      private static String getWhiteBoxJar() {
          String wbJar = ClassFileInstaller.getJarPath(&quot;WhiteBox.jar&quot;);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -180,10 +173,13 @@</span>
      public static Result run2(String baseArchiveName, String topArchiveName, String ... cmdLineSuffix)
          throws Exception {
          if (baseArchiveName == null &amp;&amp; topArchiveName == null) {
              throw new RuntimeException(&quot;Both baseArchiveName and topArchiveName cannot be null at the same time.&quot;);
          }
<span class="udiff-line-added">+         if (baseArchiveName == null &amp;&amp; isUseSharedSpacesDisabled()) {</span>
<span class="udiff-line-added">+             baseArchiveName = getTempBaseArchive();</span>
<span class="udiff-line-added">+         }</span>
          String archiveFiles = (baseArchiveName == null) ? topArchiveName :
              (topArchiveName == null) ? baseArchiveName :
              baseArchiveName + File.pathSeparator + topArchiveName;
          String[] cmdLine = TestCommon.concat(
              &quot;-Xshare:on&quot;,
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -196,10 +192,13 @@</span>
                                String jarDir, String ... cmdLineSuffix)
          throws Exception {
          if (baseArchiveName == null &amp;&amp; topArchiveName == null) {
              throw new RuntimeException(&quot;Both baseArchiveName and topArchiveName cannot be null at the same time.&quot;);
          }
<span class="udiff-line-added">+         if (baseArchiveName == null &amp;&amp; isUseSharedSpacesDisabled()) {</span>
<span class="udiff-line-added">+             baseArchiveName = getTempBaseArchive();</span>
<span class="udiff-line-added">+         }</span>
          String archiveFiles = (baseArchiveName == null) ? topArchiveName :
              (topArchiveName == null) ? baseArchiveName :
              baseArchiveName + File.pathSeparator + topArchiveName;
          String[] cmdLine = TestCommon.concat(
              &quot;-Xshare:on&quot;,
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -261,6 +260,37 @@</span>
       */
      public static void dumpAndRun(String topArchiveName, String ... cmdLineSuffix) throws Exception {
          dump(topArchiveName, cmdLineSuffix).assertNormalExit();
          run(topArchiveName,  cmdLineSuffix).assertNormalExit();
      }
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     private static String tempBaseArchive;</span>
<span class="udiff-line-added">+     /**</span>
<span class="udiff-line-added">+      * Return the name of a base archive.</span>
<span class="udiff-line-added">+      * It will generate one if one doesn&#39;t exist.</span>
<span class="udiff-line-added">+      */</span>
<span class="udiff-line-added">+     private static String getTempBaseArchive() throws Exception {</span>
<span class="udiff-line-added">+         if (tempBaseArchive == null) {</span>
<span class="udiff-line-added">+             tempBaseArchive = getNewArchiveName(&quot;tempBaseArchive&quot;);</span>
<span class="udiff-line-added">+             TestCommon.dumpBaseArchive(tempBaseArchive);</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+         return tempBaseArchive;</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     /**</span>
<span class="udiff-line-added">+      * Return true if the UseSharedSpaces flag has been disabled.</span>
<span class="udiff-line-added">+      * By default, the VM will be started with -Xshare:auto.</span>
<span class="udiff-line-added">+      * The UseSharedSpaces flag will be disabled by the VM if there&#39;s some</span>
<span class="udiff-line-added">+      * problem in using the default CDS archive. It could happen under some</span>
<span class="udiff-line-added">+      * situations such as follows:</span>
<span class="udiff-line-added">+      * - the default CDS archive wasn&#39;t generated during build time because</span>
<span class="udiff-line-added">+      *   the JDK was built via cross-compilation on a different platform;</span>
<span class="udiff-line-added">+      * - the VM under test was started with a different options than the ones</span>
<span class="udiff-line-added">+      *   when the default CDS archive was built. E.g. the VM was started with</span>
<span class="udiff-line-added">+      *   -XX:+UseZGC which implicitly disabled the UseCompressedOoops and the</span>
<span class="udiff-line-added">+      *   UseCompressedClassPointers options. Those &quot;compressed&quot; options were</span>
<span class="udiff-line-added">+      *   enabled when the default CDS archive was built.</span>
<span class="udiff-line-added">+      */</span>
<span class="udiff-line-added">+     private static boolean isUseSharedSpacesDisabled() {</span>
<span class="udiff-line-added">+         return (WB.getBooleanVMFlag(&quot;UseSharedSpaces&quot;) == false);</span>
<span class="udiff-line-added">+     }</span>
  }
</pre>
<center><a href="DynamicArchiveRelocationTest.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="DynamicLotsOfClasses.java.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>