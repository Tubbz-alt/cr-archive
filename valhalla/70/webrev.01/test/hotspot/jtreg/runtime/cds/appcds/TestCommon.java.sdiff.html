<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff test/hotspot/jtreg/runtime/cds/appcds/TestCommon.java</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
  </head>
<body>
<center><a href="../DeterministicDump.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="dynamicArchive/AppendClasspath.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>test/hotspot/jtreg/runtime/cds/appcds/TestCommon.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
120         for (String name : files) {
121             if (name.startsWith(&quot;appcds-&quot;) &amp;&amp; name.endsWith(&quot;.jsa&quot;)) {
122                 if (!(new File(dir, name)).delete())
123                     System.out.println(&quot;deletePriorArchives(): delete failed for file &quot; + name);
124             }
125         }
126     }
127 
128     // Create AppCDS archive using most common args - convenience method
129     // Legacy name preserved for compatibility
130     public static OutputAnalyzer dump(String appJar, String classList[],
131                                                String... suffix) throws Exception {
132         return createArchive(appJar, classList, suffix);
133     }
134 
135     public static OutputAnalyzer dump(String appJarDir, String appJar, String classList[],
136                                                String... suffix) throws Exception {
137         return createArchive(appJarDir, appJar, classList, suffix);
138     }
139 
















140     // Create AppCDS archive using most common args - convenience method
141     public static OutputAnalyzer createArchive(String appJar, String classList[],
142                                                String... suffix) throws Exception {
143         AppCDSOptions opts = (new AppCDSOptions()).setAppJar(appJar);
144         opts.setClassList(classList);
145         opts.addSuffix(suffix);
146         return createArchive(opts);
147     }
148 
149     public static OutputAnalyzer createArchive(String appJarDir, String appJar, String classList[],
150                                                String... suffix) throws Exception {
151         AppCDSOptions opts = (new AppCDSOptions()).setAppJar(appJar);
152         opts.setAppJarDir(appJarDir);
153         opts.setClassList(classList);
154         opts.addSuffix(suffix);
155         return createArchive(opts);
156     }
157 
158     // Simulate -Xshare:dump with -XX:ArchiveClassesAtExit. See comments around patchJarForDynamicDump()
159     private static final Class tmp = DynamicDumpHelper.class;
160 



161     // Create AppCDS archive using appcds options
162     public static OutputAnalyzer createArchive(AppCDSOptions opts)
163         throws Exception {
164         ArrayList&lt;String&gt; cmd = new ArrayList&lt;String&gt;();
165         startNewArchiveName();
166 
167         for (String p : opts.prefix) cmd.add(p);
168 
169         if (opts.appJar != null) {
170             cmd.add(&quot;-cp&quot;);
171             cmd.add(opts.appJar);
172             File jf = new File(opts.appJar);
173             if (DYNAMIC_DUMP &amp;&amp; !jf.isDirectory()) {
174                 patchJarForDynamicDump(opts.appJar);
175             }
176         } else {
177             cmd.add(&quot;-Djava.class.path=&quot;);
178         }
179 
180         if (opts.archiveName == null) {
181             opts.archiveName = getCurrentArchiveName();
182         }
183 
184         if (DYNAMIC_DUMP) {





185             cmd.add(&quot;-Xshare:on&quot;);

186             cmd.add(&quot;-XX:ArchiveClassesAtExit=&quot; + opts.archiveName);
<span class="line-removed">187 </span>
188             cmd.add(&quot;-Xlog:cds&quot;);
189             cmd.add(&quot;-Xlog:cds+dynamic&quot;);
190             boolean mainModuleSpecified = false;
191             boolean patchModuleSpecified = false;
192             for (String s : opts.suffix) {
193                 if (s.length() == 0) {
194                     continue;
195                 }
196                 if (s.equals(&quot;-m&quot;)) {
197                     mainModuleSpecified = true;
198                 }
199                 if (s.startsWith(&quot;--patch-module=&quot;)) {
200                     patchModuleSpecified = true;
201                 }
202                 cmd.add(s);
203             }
204 
205             if (opts.appJar != null) {
206                 // classlist is supported only when we have a Jar file to patch (to insert
207                 // cdsutils.DynamicDumpHelper)
</pre>
</td>
<td>
<hr />
<pre>
120         for (String name : files) {
121             if (name.startsWith(&quot;appcds-&quot;) &amp;&amp; name.endsWith(&quot;.jsa&quot;)) {
122                 if (!(new File(dir, name)).delete())
123                     System.out.println(&quot;deletePriorArchives(): delete failed for file &quot; + name);
124             }
125         }
126     }
127 
128     // Create AppCDS archive using most common args - convenience method
129     // Legacy name preserved for compatibility
130     public static OutputAnalyzer dump(String appJar, String classList[],
131                                                String... suffix) throws Exception {
132         return createArchive(appJar, classList, suffix);
133     }
134 
135     public static OutputAnalyzer dump(String appJarDir, String appJar, String classList[],
136                                                String... suffix) throws Exception {
137         return createArchive(appJarDir, appJar, classList, suffix);
138     }
139 
<span class="line-added">140     /**</span>
<span class="line-added">141      * Dump the base archive. The JDK&#39;s default class list is used (unless otherwise specified</span>
<span class="line-added">142      * in cmdLineSuffix).</span>
<span class="line-added">143      */</span>
<span class="line-added">144     public static OutputAnalyzer dumpBaseArchive(String baseArchiveName, String ... cmdLineSuffix)</span>
<span class="line-added">145         throws Exception</span>
<span class="line-added">146     {</span>
<span class="line-added">147         CDSOptions opts = new CDSOptions();</span>
<span class="line-added">148         opts.setArchiveName(baseArchiveName);</span>
<span class="line-added">149         opts.addSuffix(cmdLineSuffix);</span>
<span class="line-added">150         opts.addSuffix(&quot;-Djava.class.path=&quot;);</span>
<span class="line-added">151         OutputAnalyzer out = CDSTestUtils.createArchive(opts);</span>
<span class="line-added">152         CDSTestUtils.checkBaseDump(out);</span>
<span class="line-added">153         return out;</span>
<span class="line-added">154     }</span>
<span class="line-added">155 </span>
156     // Create AppCDS archive using most common args - convenience method
157     public static OutputAnalyzer createArchive(String appJar, String classList[],
158                                                String... suffix) throws Exception {
159         AppCDSOptions opts = (new AppCDSOptions()).setAppJar(appJar);
160         opts.setClassList(classList);
161         opts.addSuffix(suffix);
162         return createArchive(opts);
163     }
164 
165     public static OutputAnalyzer createArchive(String appJarDir, String appJar, String classList[],
166                                                String... suffix) throws Exception {
167         AppCDSOptions opts = (new AppCDSOptions()).setAppJar(appJar);
168         opts.setAppJarDir(appJarDir);
169         opts.setClassList(classList);
170         opts.addSuffix(suffix);
171         return createArchive(opts);
172     }
173 
174     // Simulate -Xshare:dump with -XX:ArchiveClassesAtExit. See comments around patchJarForDynamicDump()
175     private static final Class tmp = DynamicDumpHelper.class;
176 
<span class="line-added">177     // name of the base archive to be used for dynamic dump</span>
<span class="line-added">178     private static String tempBaseArchive = null;</span>
<span class="line-added">179 </span>
180     // Create AppCDS archive using appcds options
181     public static OutputAnalyzer createArchive(AppCDSOptions opts)
182         throws Exception {
183         ArrayList&lt;String&gt; cmd = new ArrayList&lt;String&gt;();
184         startNewArchiveName();
185 
186         for (String p : opts.prefix) cmd.add(p);
187 
188         if (opts.appJar != null) {
189             cmd.add(&quot;-cp&quot;);
190             cmd.add(opts.appJar);
191             File jf = new File(opts.appJar);
192             if (DYNAMIC_DUMP &amp;&amp; !jf.isDirectory()) {
193                 patchJarForDynamicDump(opts.appJar);
194             }
195         } else {
196             cmd.add(&quot;-Djava.class.path=&quot;);
197         }
198 
199         if (opts.archiveName == null) {
200             opts.archiveName = getCurrentArchiveName();
201         }
202 
203         if (DYNAMIC_DUMP) {
<span class="line-added">204             File baseArchive = null;</span>
<span class="line-added">205             if (tempBaseArchive == null || !(new File(tempBaseArchive)).isFile()) {</span>
<span class="line-added">206                 tempBaseArchive = getNewArchiveName(&quot;tempBaseArchive&quot;);</span>
<span class="line-added">207                 dumpBaseArchive(tempBaseArchive);</span>
<span class="line-added">208             }</span>
209             cmd.add(&quot;-Xshare:on&quot;);
<span class="line-added">210             cmd.add(&quot;-XX:SharedArchiveFile=&quot; + tempBaseArchive);</span>
211             cmd.add(&quot;-XX:ArchiveClassesAtExit=&quot; + opts.archiveName);

212             cmd.add(&quot;-Xlog:cds&quot;);
213             cmd.add(&quot;-Xlog:cds+dynamic&quot;);
214             boolean mainModuleSpecified = false;
215             boolean patchModuleSpecified = false;
216             for (String s : opts.suffix) {
217                 if (s.length() == 0) {
218                     continue;
219                 }
220                 if (s.equals(&quot;-m&quot;)) {
221                     mainModuleSpecified = true;
222                 }
223                 if (s.startsWith(&quot;--patch-module=&quot;)) {
224                     patchModuleSpecified = true;
225                 }
226                 cmd.add(s);
227             }
228 
229             if (opts.appJar != null) {
230                 // classlist is supported only when we have a Jar file to patch (to insert
231                 // cdsutils.DynamicDumpHelper)
</pre>
</td>
</tr>
</table>
<center><a href="../DeterministicDump.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="dynamicArchive/AppendClasspath.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>