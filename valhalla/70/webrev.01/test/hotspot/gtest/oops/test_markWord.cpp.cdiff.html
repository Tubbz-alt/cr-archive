<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff test/hotspot/gtest/oops/test_markWord.cpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
  </head>
<body>
<center><a href="../../../../src/utils/hsdis/hsdis.c.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="../utilities/test_resourceHash.cpp.cdiff.html" target="_top">next &gt;</a></center>    <h2>test/hotspot/gtest/oops/test_markWord.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 83,38 ***</span>
  TEST_VM(markWord, printing) {
    JavaThread* THREAD = JavaThread::current();
    ThreadInVMfromNative invm(THREAD);
    ResourceMark rm(THREAD);
  
<span class="line-removed">-   if (!UseBiasedLocking || !BiasedLocking::enabled()) {</span>
<span class="line-removed">-     // Can&#39;t test this with biased locking disabled.</span>
<span class="line-removed">-     return;</span>
<span class="line-removed">-   }</span>
<span class="line-removed">- </span>
    oop obj = SystemDictionary::Byte_klass()-&gt;allocate_instance(THREAD);
  
    FlagSetting fs(WizardMode, true);
  
    HandleMark hm(THREAD);
    Handle h_obj(THREAD, obj);
  
<span class="line-modified">!   // Biased locking is initially enabled for this java.lang.Byte object.</span>
<span class="line-modified">!   assert_test_pattern(h_obj, &quot;is_biased&quot;);</span>
<span class="line-modified">! </span>
<span class="line-modified">!   // Lock using biased locking.</span>
<span class="line-modified">!   BasicObjectLock lock;</span>
<span class="line-modified">!   lock.set_obj(obj);</span>
<span class="line-modified">!   markWord prototype_header = obj-&gt;klass()-&gt;prototype_header();</span>
<span class="line-modified">!   markWord mark = obj-&gt;mark();</span>
<span class="line-modified">!   markWord biased_mark = markWord::encode((JavaThread*) THREAD, mark.age(), prototype_header.bias_epoch());</span>
<span class="line-modified">!   obj-&gt;set_mark(biased_mark);</span>
<span class="line-modified">!   // Look for the biased_locker in markWord, not prototype_header.</span>
  #ifdef _LP64
<span class="line-modified">!   assert_not_test_pattern(h_obj, &quot;mark(is_biased biased_locker=0x0000000000000000&quot;);</span>
  #else
<span class="line-modified">!   assert_not_test_pattern(h_obj, &quot;mark(is_biased biased_locker=0x00000000&quot;);</span>
  #endif
  
    // Same thread tries to lock it again.
    {
      ObjectLocker ol(h_obj, THREAD);
      assert_test_pattern(h_obj, &quot;locked&quot;);
<span class="line-new-header">--- 83,36 ---</span>
  TEST_VM(markWord, printing) {
    JavaThread* THREAD = JavaThread::current();
    ThreadInVMfromNative invm(THREAD);
    ResourceMark rm(THREAD);
  
    oop obj = SystemDictionary::Byte_klass()-&gt;allocate_instance(THREAD);
  
    FlagSetting fs(WizardMode, true);
  
    HandleMark hm(THREAD);
    Handle h_obj(THREAD, obj);
  
<span class="line-modified">!   if (UseBiasedLocking &amp;&amp; BiasedLocking::enabled()) {</span>
<span class="line-modified">!     // Can&#39;t test this with biased locking disabled.</span>
<span class="line-modified">!     // Biased locking is initially enabled for this java.lang.Byte object.</span>
<span class="line-modified">!     assert_test_pattern(h_obj, &quot;is_biased&quot;);</span>
<span class="line-modified">! </span>
<span class="line-modified">!     // Lock using biased locking.</span>
<span class="line-modified">!     BasicObjectLock lock;</span>
<span class="line-modified">!     lock.set_obj(obj);</span>
<span class="line-modified">!     markWord prototype_header = obj-&gt;klass()-&gt;prototype_header();</span>
<span class="line-modified">!     markWord mark = obj-&gt;mark();</span>
<span class="line-modified">!     markWord biased_mark = markWord::encode((JavaThread*) THREAD, mark.age(), prototype_header.bias_epoch());</span>
<span class="line-added">+     obj-&gt;set_mark(biased_mark);</span>
<span class="line-added">+     // Look for the biased_locker in markWord, not prototype_header.</span>
  #ifdef _LP64
<span class="line-modified">!     assert_not_test_pattern(h_obj, &quot;mark(is_biased biased_locker=0x0000000000000000&quot;);</span>
  #else
<span class="line-modified">!     assert_not_test_pattern(h_obj, &quot;mark(is_biased biased_locker=0x00000000&quot;);</span>
  #endif
<span class="line-added">+   }</span>
  
    // Same thread tries to lock it again.
    {
      ObjectLocker ol(h_obj, THREAD);
      assert_test_pattern(h_obj, &quot;locked&quot;);
</pre>
<center><a href="../../../../src/utils/hsdis/hsdis.c.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="../utilities/test_resourceHash.cpp.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>