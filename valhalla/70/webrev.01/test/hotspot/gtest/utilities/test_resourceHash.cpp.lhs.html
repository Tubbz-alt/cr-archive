<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames test/hotspot/gtest/utilities/test_resourceHash.cpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
    <script type="text/javascript" src="../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
  2  * Copyright (c) 2015, 2016, Oracle and/or its affiliates. All rights reserved.
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 #include &quot;precompiled.hpp&quot;
 25 #include &quot;memory/allocation.hpp&quot;
 26 #include &quot;memory/resourceArea.hpp&quot;
 27 #include &quot;unittest.hpp&quot;
 28 #include &quot;utilities/debug.hpp&quot;
<a name="1" id="anc1"></a>
 29 #include &quot;utilities/resourceHash.hpp&quot;
 30 
 31 class CommonResourceHashtableTest : public ::testing::Test {
 32  protected:
 33   typedef void* K;
<a name="2" id="anc2"></a><span class="line-modified"> 34   typedef int V;</span>
 35   const static MEMFLAGS MEM_TYPE = mtInternal;
 36 
 37   static unsigned identity_hash(const K&amp; k) {
 38     return (unsigned) (uintptr_t) k;
 39   }
 40 
 41   static unsigned bad_hash(const K&amp; k) {
 42     return 1;
 43   }
 44 
 45   static void* as_K(uintptr_t val) {
 46     return (void*) val;
 47   }
 48 
 49   class EqualityTestIter {
 50    public:
 51 
 52     bool do_entry(K const&amp; k, V const&amp; v) {
 53       if ((uintptr_t) k != (uintptr_t) v) {
 54         EXPECT_EQ((uintptr_t) k, (uintptr_t) v);
 55         return false;
 56       } else {
 57         return true; // continue iteration
 58       }
 59     }
 60   };
<a name="3" id="anc3"></a>
 61 };
 62 
 63 class SmallResourceHashtableTest : public CommonResourceHashtableTest {
 64  protected:
 65 
 66   template&lt;
 67   unsigned (*HASH) (K const&amp;) = primitive_hash&lt;K&gt;,
 68   bool (*EQUALS)(K const&amp;, K const&amp;) = primitive_equals&lt;K&gt;,
 69   unsigned SIZE = 256,
 70   ResourceObj::allocation_type ALLOC_TYPE = ResourceObj::RESOURCE_AREA
 71   &gt;
 72   class Runner : public AllStatic {
 73    public:
 74 
 75     static void test(V step) {
 76       EqualityTestIter et;
 77       ResourceHashtable&lt;K, V, HASH, EQUALS, SIZE, ALLOC_TYPE, MEM_TYPE&gt; rh;
 78 
 79       ASSERT_FALSE(rh.contains(as_K(step)));
 80 
 81       ASSERT_TRUE(rh.put(as_K(step), step));
 82       ASSERT_TRUE(rh.contains(as_K(step)));
 83 
 84       ASSERT_FALSE(rh.put(as_K(step), step));
 85 
 86       ASSERT_TRUE(rh.put(as_K(2 * step), 2 * step));
 87       ASSERT_TRUE(rh.put(as_K(3 * step), 3 * step));
 88       ASSERT_TRUE(rh.put(as_K(4 * step), 4 * step));
 89       ASSERT_TRUE(rh.put(as_K(5 * step), 5 * step));
 90 
 91       ASSERT_FALSE(rh.remove(as_K(0x0)));
 92 
 93       rh.iterate(&amp;et);
 94       if (::testing::Test::HasFailure()) {
 95         return;
 96       }
 97 
 98       ASSERT_TRUE(rh.remove(as_K(step)));
<a name="4" id="anc4"></a>


















 99       rh.iterate(&amp;et);
<a name="5" id="anc5"></a>

















100     }
101   };
102 };
103 
104 TEST_VM_F(SmallResourceHashtableTest, default) {
105   ResourceMark rm;
106   Runner&lt;&gt;::test(0x1);
107 }
108 
109 TEST_VM_F(SmallResourceHashtableTest, default_shifted) {
110   ResourceMark rm;
111   Runner&lt;&gt;::test(0x10);
112 }
113 
114 TEST_VM_F(SmallResourceHashtableTest, bad_hash) {
115   ResourceMark rm;
116   Runner&lt;bad_hash&gt;::test(0x1);
117 }
118 
119 TEST_VM_F(SmallResourceHashtableTest, bad_hash_shifted) {
120   ResourceMark rm;
121   Runner&lt;bad_hash&gt;::test(0x10);
122 }
123 
124 TEST_VM_F(SmallResourceHashtableTest, identity_hash) {
125   ResourceMark rm;
126   Runner&lt;identity_hash&gt;::test(0x1);
127 }
128 
129 TEST_VM_F(SmallResourceHashtableTest, identity_hash_shifted) {
130   ResourceMark rm;
131   Runner&lt;identity_hash&gt;::test(0x10);
132 }
133 
134 TEST_VM_F(SmallResourceHashtableTest, primitive_hash_no_rm) {
135   Runner&lt;primitive_hash&lt;K&gt;, primitive_equals&lt;K&gt;, 512, ResourceObj::C_HEAP&gt;::test(0x1);
136 }
137 
138 TEST_VM_F(SmallResourceHashtableTest, primitive_hash_no_rm_shifted) {
139   Runner&lt;primitive_hash&lt;K&gt;, primitive_equals&lt;K&gt;, 512, ResourceObj::C_HEAP&gt;::test(0x10);
140 }
141 
142 TEST_VM_F(SmallResourceHashtableTest, bad_hash_no_rm) {
143   Runner&lt;bad_hash, primitive_equals&lt;K&gt;, 512, ResourceObj::C_HEAP&gt;::test(0x1);
144 }
145 
146 TEST_VM_F(SmallResourceHashtableTest, bad_hash_no_rm_shifted) {
147   Runner&lt;bad_hash, primitive_equals&lt;K&gt;, 512, ResourceObj::C_HEAP&gt;::test(0x10);
148 }
149 
150 TEST_VM_F(SmallResourceHashtableTest, identity_hash_no_rm) {
151   Runner&lt;identity_hash, primitive_equals&lt;K&gt;, 1, ResourceObj::C_HEAP&gt;::test(0x1);
152 }
153 
154 TEST_VM_F(SmallResourceHashtableTest, identity_hash_no_rm_shifted) {
155   Runner&lt;identity_hash, primitive_equals&lt;K&gt;, 1, ResourceObj::C_HEAP&gt;::test(0x10);
156 }
157 
158 class GenericResourceHashtableTest : public CommonResourceHashtableTest {
159  protected:
160 
161   template&lt;
162   unsigned (*HASH) (K const&amp;) = primitive_hash&lt;K&gt;,
163   bool (*EQUALS)(K const&amp;, K const&amp;) = primitive_equals&lt;K&gt;,
164   unsigned SIZE = 256,
165   ResourceObj::allocation_type ALLOC_TYPE = ResourceObj::RESOURCE_AREA
166   &gt;
167   class Runner : public AllStatic {
168    public:
169 
170     static void test(unsigned num_elements = SIZE) {
171       EqualityTestIter et;
172       ResourceHashtable&lt;K, V, HASH, EQUALS, SIZE, ALLOC_TYPE, MEM_TYPE&gt; rh;
173 
174       for (uintptr_t i = 0; i &lt; num_elements; ++i) {
175         ASSERT_TRUE(rh.put(as_K(i), i));
176       }
177 
178       rh.iterate(&amp;et);
179       if (::testing::Test::HasFailure()) {
180         return;
181       }
182 
183       for (uintptr_t i = num_elements; i &gt; 0; --i) {
184         uintptr_t index = i - 1;
185         ASSERT_TRUE((rh.remove(as_K(index))));
186       }
187 
188       rh.iterate(&amp;et);
189       if (::testing::Test::HasFailure()) {
190         return;
191       }
192       for (uintptr_t i = num_elements; i &gt; 0; --i) {
193         uintptr_t index = i - 1;
194         ASSERT_FALSE(rh.remove(as_K(index)));
195       }
196       rh.iterate(&amp;et);
197     }
198   };
199 };
200 
201 TEST_VM_F(GenericResourceHashtableTest, default) {
202   ResourceMark rm;
203   Runner&lt;&gt;::test();
204 }
205 
206 TEST_VM_F(GenericResourceHashtableTest, bad_hash) {
207   ResourceMark rm;
208   Runner&lt;bad_hash&gt;::test();
209 }
210 
211 TEST_VM_F(GenericResourceHashtableTest, identity_hash) {
212   ResourceMark rm;
213   Runner&lt;identity_hash&gt;::test();
214 }
215 
216 TEST_VM_F(GenericResourceHashtableTest, primitive_hash_no_rm) {
217   Runner&lt;primitive_hash&lt;K&gt;, primitive_equals&lt;K&gt;, 512, ResourceObj::C_HEAP&gt;::test();
218 }
219 
220 TEST_VM_F(GenericResourceHashtableTest, bad_hash_no_rm) {
221   Runner&lt;bad_hash, primitive_equals&lt;K&gt;, 512, ResourceObj::C_HEAP&gt;::test();
222 }
223 
224 TEST_VM_F(GenericResourceHashtableTest, identity_hash_no_rm) {
225   Runner&lt;identity_hash, primitive_equals&lt;K&gt;, 1, ResourceObj::C_HEAP&gt;::test(512);
226 }
<a name="6" id="anc6"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="6" type="hidden" />
</body>
</html>