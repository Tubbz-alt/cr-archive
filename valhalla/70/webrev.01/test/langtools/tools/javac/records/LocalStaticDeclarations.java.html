<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>New test/langtools/tools/javac/records/LocalStaticDeclarations.java</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
  <body>
    <pre>
  1 /*
  2  * Copyright (c) 2020, Oracle and/or its affiliates. All rights reserved.
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 /*
 25  * @test
 26  * @bug 8242293
 27  * @summary allow for local interfaces and enums plus nested records, interfaces and enums
 28  * @library /tools/javac/lib
 29  * @modules jdk.compiler/com.sun.tools.javac.api
 30  *          jdk.compiler/com.sun.tools.javac.file
 31  *          jdk.compiler/com.sun.tools.javac.util
 32  * @build combo.ComboTestHelper
 33  * @compile --enable-preview -source ${jdk.version} LocalStaticDeclarations.java
 34  * @run main/othervm --enable-preview LocalStaticDeclarations
 35  */
 36 
 37 import javax.lang.model.element.Element;
 38 import javax.tools.Diagnostic;
 39 import javax.tools.JavaFileObject;
 40 
 41 import com.sun.tools.javac.util.Assert;
 42 
 43 import com.sun.tools.javac.api.ClientCodeWrapper;
 44 import com.sun.tools.javac.util.JCDiagnostic;
 45 import com.sun.tools.javac.util.List;
 46 import combo.ComboInstance;
 47 import combo.ComboParameter;
 48 import combo.ComboTask;
 49 import combo.ComboTask.Result;
 50 import combo.ComboTestHelper;
 51 
 52 public class LocalStaticDeclarations extends ComboInstance&lt;LocalStaticDeclarations&gt; {
 53 
 54     static final String sourceTemplate =
 55             &quot;&quot;&quot;
 56             import java.lang.annotation.*;
 57             class Test {
 58                 int INSTANCE_FIELD = 0;
 59                 static int STATIC_FIELD = 0;
 60                 // instance initializer
 61                 { int LOCAL_VARIABLE = 0;
 62                     #{CONTAINER}
 63                 }
 64                 Test() {
 65                     #{CONTAINER}
 66                 }
 67                 void m() {
 68                     int LOCAL_VARIABLE = 0;
 69                     #{CONTAINER}
 70                 }
 71                 static void foo() {
 72                     int LOCAL_VARIABLE = 0;
 73                     #{CONTAINER}
 74                 }
 75             }
 76             &quot;&quot;&quot;;
 77 
 78     enum Container implements ComboParameter {
 79         NO_CONTAINER(&quot;#{STATIC_LOCAL}&quot;),
 80         INTERFACE(&quot;interface CI { #{STATIC_LOCAL} }&quot;),
 81         ANNOTATION(&quot;@interface CA { #{STATIC_LOCAL} }&quot;),
 82         ANONYMOUS(
 83                 &quot;&quot;&quot;
 84                     new Object() {
 85                         // instance initializer
 86                         {
 87                             #{STATIC_LOCAL}
 88                         }
 89 
 90                         void m() {
 91                             #{STATIC_LOCAL}
 92                         }
 93                     };
 94                 &quot;&quot;&quot;
 95         ),
 96         RECORD(&quot;record CR() { #{STATIC_LOCAL} }&quot;),
 97         CLASS(&quot;class CC { #{STATIC_LOCAL} }&quot;),
 98         ENUM(&quot;enum CE { #{STATIC_LOCAL} }&quot;),
 99         LAMBDA(&quot;Runnable run = () -&gt; { #{STATIC_LOCAL} };&quot;);
100 
101         String container;
102 
103         Container(String container) {
104             this.container = container;
105         }
106 
107         public String expand(String optParameter) {
108             return container;
109         }
110     }
111 
112     enum StaticLocalDecl implements ComboParameter {
113         ENUM(&quot;enum E { E1; #{MEMBER} }&quot;),
114         RECORD(&quot;record R() { #{MEMBER} }&quot;),
115         ANNOTATION(&quot;@interface A { #{MEMBER} }&quot;),
116         INTERFACE(&quot;interface I { #{MEMBER} }&quot;);
117 
118         String localDecl;
119 
120         StaticLocalDecl(String localDecl) {
121             this.localDecl = localDecl;
122         }
123 
124         public String expand(String optParameter) {
125             return localDecl;
126         }
127     }
128 
129     enum Member implements ComboParameter {
130         NONE(&quot;&quot;),
131         METHOD(&quot;int foo() { return #{EXPR}; }&quot;),
132         DEFAULT_METHOD(&quot;default int foo() { return #{EXPR}; }&quot;);
133 
134         String member;
135 
136         Member(String member) {
137             this.member = member;
138         }
139 
140         public String expand(String optParameter) {
141             return member;
142         }
143     }
144 
145     enum Expression implements ComboParameter {
146          LITERAL(&quot;1&quot;),
147          STATIC_FIELD(&quot;STATIC_FIELD&quot;),
148          LOCAL_VARIABLE(&quot;LOCAL_VARIABLE&quot;),
149          INSTANCE_FIELD(&quot;INSTANCE_FIELD&quot;);
150 
151          String expr;
152 
153          Expression(String expr) {
154              this.expr = expr;
155          }
156 
157         public String expand(String optParameter) {
158             return expr;
159         }
160     }
161 
162     public static void main(String... args) throws Exception {
163         new combo.ComboTestHelper&lt;LocalStaticDeclarations&gt;()
164                 .withFilter(LocalStaticDeclarations::notTriviallyIncorrect)
165                 .withDimension(&quot;CONTAINER&quot;, (x, t) -&gt; { x.container = t; }, Container.values())
166                 .withDimension(&quot;STATIC_LOCAL&quot;, (x, t) -&gt; { x.decl = t; }, StaticLocalDecl.values())
167                 .withDimension(&quot;MEMBER&quot;, (x, t) -&gt; { x.member = t; }, Member.values())
168                 .withDimension(&quot;EXPR&quot;, (x, expr) -&gt; x.expr = expr, Expression.values())
169                 .run(LocalStaticDeclarations::new);
170     }
171 
172     Container container;
173     StaticLocalDecl decl;
174     Member member;
175     Expression expr;
176 
177     @Override
178     public void doWork() throws Throwable {
179         newCompilationTask()
180                 .withOptions(new String[]{&quot;--enable-preview&quot;, &quot;-source&quot;, Integer.toString(Runtime.version().feature())})
181                 .withSourceFromTemplate(&quot;Test&quot;, sourceTemplate)
182                 .generate(this::check);
183     }
184 
185     boolean notTriviallyIncorrect() {
186         return decl == StaticLocalDecl.INTERFACE &amp;&amp; (member == Member.DEFAULT_METHOD || member == Member.NONE) ||
187                decl != StaticLocalDecl.INTERFACE &amp;&amp; (member == Member.METHOD || member == Member.NONE) &amp;&amp;
188                ((decl != StaticLocalDecl.ANNOTATION) ||
189                (decl == StaticLocalDecl.ANNOTATION &amp;&amp; member == Member.NONE));
190     }
191 
192     void check(ComboTask.Result&lt;Iterable&lt;? extends JavaFileObject&gt;&gt; result) {
193         if (shouldFail()) {
194             Assert.check(result.hasErrors(), result.compilationInfo());
195             if (!expectedDiagFound(result)) {
196                 fail(&quot;test failing with unexpected error message\n&quot; + result.compilationInfo());
197             }
198         } else {
199             Assert.check(!result.hasErrors(), result.compilationInfo());
200         }
201     }
202 
203     boolean shouldFail() {
204         return ((container != Container.NO_CONTAINER &amp;&amp;
205                 container != Container.LAMBDA &amp;&amp;
206                 container != Container.ANONYMOUS)) ||
207                 (member != Member.NONE &amp;&amp; !acceptableExpr());
208     }
209 
210     boolean acceptableExpr() {
211         return (expr == Expression.LITERAL || expr == Expression.STATIC_FIELD);
212     }
213 
214     boolean expectedDiagFound(ComboTask.Result&lt;Iterable&lt;? extends JavaFileObject&gt;&gt; result) {
215         if ((container == Container.NO_CONTAINER ||
216                 container == Container.LAMBDA ||
217                 container == Container.ANONYMOUS) &amp;&amp;
218                 !acceptableExpr()) {
219             return result.containsKey(&quot;compiler.err.non-static.cant.be.ref&quot;);
220         } else if (container == Container.ENUM) {
221             if (decl == StaticLocalDecl.ANNOTATION) {
222                 return result.containsKey(&quot;compiler.err.expected&quot;);
223             } else {
224                 return result.containsKey(&quot;compiler.err.enum.constant.expected&quot; );
225             }
226         }
227         return result.containsKey(&quot;compiler.err.static.declaration.not.allowed.in.inner.classes&quot; );
228     }
229 }
    </pre>
  </body>
</html>