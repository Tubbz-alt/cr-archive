<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>New test/jdk/java/nio/channels/etc/ProtocolFamilies.java</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
  </head>
  <body>
    <pre>
  1 /*
  2  * Copyright (c) 2020, Oracle and/or its affiliates. All rights reserved.
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 import jdk.test.lib.NetworkConfiguration;
 25 import jdk.test.lib.Platform;
 26 import jdk.test.lib.net.IPSupport;
 27 import org.testng.annotations.BeforeTest;
 28 import org.testng.annotations.DataProvider;
 29 import org.testng.annotations.Test;
 30 import org.testng.Assert.ThrowingRunnable;
 31 import java.io.IOException;
 32 import java.net.*;
 33 import java.nio.channels.*;
 34 import java.nio.channels.spi.AbstractSelector;
 35 import java.nio.channels.spi.SelectorProvider;
 36 import static java.lang.System.out;
 37 import static java.lang.System.getProperty;
 38 import static java.lang.Boolean.parseBoolean;
 39 import static java.net.StandardProtocolFamily.INET;
 40 import static java.net.StandardProtocolFamily.INET6;
 41 import static jdk.test.lib.net.IPSupport.*;
 42 import static org.testng.Assert.assertThrows;
 43 
 44 /*
 45  * @test
 46  * @summary Test SocketChannel, ServerSocketChannel and DatagramChannel
 47  *          with various ProtocolFamily combinations
 48  * @library /test/lib
 49  * @build jdk.test.lib.NetworkConfiguration
 50  * @run testng ProtocolFamilies
 51  * @run testng/othervm -Djava.net.preferIPv4Stack=true ProtocolFamilies
 52  */
 53 
 54 
 55 public class ProtocolFamilies {
 56     static final boolean hasIPv6 = hasIPv6();
 57     static final boolean preferIPv4 = preferIPv4Stack();
 58     static Inet4Address ia4;
 59     static Inet6Address ia6;
 60 
 61     @BeforeTest()
 62     public void setup() throws Exception {
 63         NetworkConfiguration.printSystemConfiguration(out);
 64         IPSupport.printPlatformSupport(out);
 65         throwSkippedExceptionIfNonOperational();
 66 
 67         ia4 = getLocalIPv4Address();
 68         ia6 = getLocalIPv6Address();
 69         out.println(&quot;ia4: &quot; + ia4);
 70         out.println(&quot;ia6: &quot; + ia6 + &quot;\n&quot;);
 71     }
 72 
 73     static final Class&lt;UnsupportedAddressTypeException&gt; UATE = UnsupportedAddressTypeException.class;
 74     static final Class&lt;UnsupportedOperationException&gt; UOE = UnsupportedOperationException.class;
 75 
 76     @DataProvider(name = &quot;open&quot;)
 77     public Object[][] open() {
 78         if (hasIPv6 &amp;&amp; !preferIPv4) {
 79             return new Object[][]{
 80                     {  INET,   null  },
 81                     {  INET6,  null  }
 82             };
 83         } else {
 84             return new Object[][]{
 85                     {  INET,   null  },
 86                     {  INET6,  UOE   }
 87             };
 88         }
 89     }
 90 
 91     @Test(dataProvider = &quot;open&quot;)
 92     public void scOpen(StandardProtocolFamily family,
 93                        Class&lt;? extends Exception&gt; expectedException)
 94         throws Throwable
 95     {
 96         SocketChannel sc = null;
 97         try {
 98             if (expectedException == UOE) {
 99                 try {
100                     sc = openSC(family);
101                 } catch (UnsupportedOperationException e) {}
102             } else {
103                 sc = openSC(family);
104             }
105         } finally {
106             if (sc != null)
107                 sc.close();
108         }
109     }
110 
111     @Test(dataProvider = &quot;open&quot;)
112     public void sscOpen(StandardProtocolFamily family,
113                         Class&lt;? extends Exception&gt; expectedException)
114         throws Throwable
115     {
116         ServerSocketChannel ssc = null;
117         try {
118             if (expectedException == UOE) {
119                 try {
120                     ssc = openSSC(family);
121                 } catch (UnsupportedOperationException e) {}
122             } else {
123                 openSSC(family);
124             }
125         } finally {
126             if (ssc != null)
127                 ssc.close();
128         }
129     }
130 
131     @Test(dataProvider = &quot;open&quot;)
132     public void dcOpen(StandardProtocolFamily family,
133                        Class&lt;? extends Exception&gt; expectedException)
134         throws Throwable
135     {
136         DatagramChannel dc = null;
137         try {
138             if (expectedException == UOE) {
139                 try {
140                     dc = openDC(family);
141                 } catch (UnsupportedOperationException e) {}
142             } else {
143                 openDC(family);
144             }
145         } finally {
146             if (dc != null)
147                 dc.close();
148         }
149     }
150 
151     @DataProvider(name = &quot;openBind&quot;)
152     public Object[][] openBind() {
153         if (hasIPv6 &amp;&amp; !preferIPv4) {
154             return new Object[][]{
155                     {   INET,   INET,   null   },
156                     {   INET,   INET6,  UATE   },
157                     {   INET,   null,   null   },
158                     {   INET6,  INET,   null   },
159                     {   INET6,  INET6,  null   },
160                     {   INET6,  null,   null   },
161                     {   null,   INET,   null   },
162                     {   null,   INET6,  null   },
163                     {   null,   null,   null   }
164             };
165         } else {
166             return new Object[][]{
167                     {   INET,   INET,   null   },
168                     {   INET,   INET6,  UATE   },
169                     {   INET,   null,   null   },
170                     {   null,   INET,   null   },
171                     {   null,   INET6,  UATE   },
172                     {   null,   null,   null   }
173             };
174         }
175     }
176 
177     // SocketChannel open - INET, INET6, default
178     // SocketChannel bind - INET, INET6, null
179 
180     @Test(dataProvider = &quot;openBind&quot;)
181     public void scOpenBind(StandardProtocolFamily ofamily,
182                            StandardProtocolFamily bfamily,
183                            Class&lt;? extends Exception&gt; expectedException)
184         throws Throwable
185     {
186         try (SocketChannel sc = openSC(ofamily)) {
187             SocketAddress addr = getSocketAddress(bfamily);
188             ThrowingRunnable bindOp = () -&gt; sc.bind(addr);
189                 if (expectedException == null)
190                     bindOp.run();
191             else
192                 assertThrows(expectedException, bindOp);
193         }
194     }
195 
196     //  ServerSocketChannel open - INET, INET6, default
197     //  ServerSocketChannel bind - INET, INET6, null
198 
199     @Test(dataProvider = &quot;openBind&quot;)
200     public void sscOpenBind(StandardProtocolFamily ofamily,
201                             StandardProtocolFamily bfamily,
202                             Class&lt;? extends Exception&gt; expectedException)
203         throws Throwable
204     {
205         try (ServerSocketChannel ssc = openSSC(ofamily)) {
206             SocketAddress addr = getSocketAddress(bfamily);
207             ThrowingRunnable bindOp = () -&gt; ssc.bind(addr);
208             if (expectedException == null)
209                 bindOp.run();
210             else
211                 assertThrows(expectedException, bindOp);
212         }
213     }
214 
215     //  DatagramChannel open - INET, INET6, default
216     //  DatagramChannel bind - INET, INET6, null
217 
218     @Test(dataProvider = &quot;openBind&quot;)
219     public void dcOpenBind(StandardProtocolFamily ofamily,
220                            StandardProtocolFamily bfamily,
221                            Class&lt;? extends Exception&gt; expectedException)
222         throws Throwable
223     {
224         try (DatagramChannel dc = openDC(ofamily)) {
225             SocketAddress addr = getSocketAddress(bfamily);
226             ThrowingRunnable bindOp = () -&gt; dc.bind(addr);
227             if (expectedException == null)
228                 bindOp.run();
229             else
230                 assertThrows(expectedException, bindOp);
231         }
232     }
233 
234     //  SocketChannel open    - INET, INET6, default
235     //  SocketChannel connect - INET, INET6, default
236 
237     @DataProvider(name = &quot;openConnect&quot;)
238     public Object[][] openConnect() {
239         if (hasIPv6 &amp;&amp; !preferIPv4) {
240             return new Object[][]{
241                     {   INET,   INET,   null   },
242                     {   INET,   INET6,  null   },
243                     {   INET,   null,   null   },
244                     {   INET6,  INET,   UATE   },
245                     {   INET6,  INET6,  null   },
246                     {   INET6,  null,   null   },
247                     {   null,   INET,   UATE   },
248                     {   null,   INET6,  null   },
249                     {   null,   null,   null   }
250             };
251         } else {
252             // INET6 channels cannot be created - UOE - tested elsewhere
253             return new Object[][]{
254                     {   INET,   INET,   null   },
255                     {   INET,   null,   null   },
256                     {   null,   INET,   null   },
257                     {   null,   null,   null   }
258             };
259         }
260     }
261 
262     @Test(dataProvider = &quot;openConnect&quot;)
263     public void scOpenConnect(StandardProtocolFamily sfamily,
264                               StandardProtocolFamily cfamily,
265                               Class&lt;? extends Exception&gt; expectedException)
266         throws Throwable
267     {
268         try (ServerSocketChannel ssc = openSSC(sfamily)) {
269             ssc.bind(null);
270             SocketAddress saddr = ssc.getLocalAddress();
271             try (SocketChannel sc = openSC(cfamily)) {
272                 if (expectedException == null)
273                     sc.connect(saddr);
274                 else
275                     assertThrows(expectedException, () -&gt; sc.connect(saddr));
276             }
277         }
278     }
279 
280     static final Class&lt;NullPointerException&gt; NPE = NullPointerException.class;
281 
282     // Tests null handling
283     @Test
284     public void testNulls() {
285         assertThrows(NPE, () -&gt; SocketChannel.open((ProtocolFamily)null));
286         assertThrows(NPE, () -&gt; ServerSocketChannel.open(null));
287         assertThrows(NPE, () -&gt; DatagramChannel.open(null));
288 
289         assertThrows(NPE, () -&gt; SelectorProvider.provider().openSocketChannel(null));
290         assertThrows(NPE, () -&gt; SelectorProvider.provider().openServerSocketChannel(null));
291         assertThrows(NPE, () -&gt; SelectorProvider.provider().openDatagramChannel(null));
292     }
293 
294     static final ProtocolFamily BAD_PF = () -&gt; &quot;BAD_PROTOCOL_FAMILY&quot;;
295 
296     // Tests UOE handling
297     @Test
298     public void testUoe() {
299         assertThrows(UOE, () -&gt; SocketChannel.open(BAD_PF));
300         assertThrows(UOE, () -&gt; ServerSocketChannel.open(BAD_PF));
301         assertThrows(UOE, () -&gt; DatagramChannel.open(BAD_PF));
302 
303         assertThrows(UOE, () -&gt; SelectorProvider.provider().openSocketChannel(BAD_PF));
304         assertThrows(UOE, () -&gt; SelectorProvider.provider().openServerSocketChannel(BAD_PF));
305         assertThrows(UOE, () -&gt; SelectorProvider.provider().openDatagramChannel(BAD_PF));
306     }
307 
308     // A concrete subclass of SelectorProvider, in order to test implSpec
309     static final SelectorProvider customerSelectorProvider = new SelectorProvider() {
310         @Override public DatagramChannel openDatagramChannel() { return null; }
311         @Override public DatagramChannel openDatagramChannel(ProtocolFamily family) { return null; }
312         @Override public Pipe openPipe() { return null; }
313         @Override public AbstractSelector openSelector() { return null; }
314         @Override public ServerSocketChannel openServerSocketChannel() { return null; }
315         @Override public SocketChannel openSocketChannel() { return null; }
316     };
317 
318     // Tests the specified default implementation of SelectorProvider
319     @Test
320     public void testCustomProvider() {
321         assertThrows(NPE, () -&gt; customerSelectorProvider.openSocketChannel(null));
322         assertThrows(NPE, () -&gt; customerSelectorProvider.openServerSocketChannel(null));
323 
324         assertThrows(UOE, () -&gt; customerSelectorProvider.openSocketChannel(BAD_PF));
325         assertThrows(UOE, () -&gt; customerSelectorProvider.openServerSocketChannel(BAD_PF));
326     }
327 
328     // Helper methods
329 
330     private static SocketChannel openSC(StandardProtocolFamily family)
331             throws IOException {
332         return family == null ? SocketChannel.open()
333                 : SocketChannel.open(family);
334     }
335 
336     private static ServerSocketChannel openSSC(StandardProtocolFamily family)
337             throws IOException {
338         return family == null ? ServerSocketChannel.open()
339                 : ServerSocketChannel.open(family);
340     }
341 
342     private static DatagramChannel openDC(StandardProtocolFamily family)
343             throws IOException {
344         return family == null ? DatagramChannel.open()
345                 : DatagramChannel.open(family);
346     }
347 
348     private static SocketAddress getSocketAddress(StandardProtocolFamily family) {
349         return family == null ? null : switch (family) {
350             case INET -&gt; new InetSocketAddress(ia4, 0);
351             case INET6 -&gt; new InetSocketAddress(ia6, 0);
352         };
353     }
354 
355     private static SocketAddress getLoopback(StandardProtocolFamily family, int port)
356             throws UnknownHostException {
357         if ((family == null || family == INET6) &amp;&amp; hasIPv6) {
358             return new InetSocketAddress(InetAddress.getByName(&quot;::1&quot;), port);
359         } else {
360             return new InetSocketAddress(InetAddress.getByName(&quot;127.0.0.1&quot;), port);
361         }
362     }
363 
364     private static Inet4Address getLocalIPv4Address()
365             throws Exception {
366         return NetworkConfiguration.probe()
367                 .ip4Addresses()
368                 .filter(a -&gt; !a.isLoopbackAddress())
369                 .findFirst()
370                 .orElse((Inet4Address)InetAddress.getByName(&quot;0.0.0.0&quot;));
371     }
372 
373     private static Inet6Address getLocalIPv6Address()
374             throws Exception {
375         return NetworkConfiguration.probe()
376                 .ip6Addresses()
377                 .filter(a -&gt; !a.isLoopbackAddress())
378                 .findFirst()
379                 .orElse((Inet6Address) InetAddress.getByName(&quot;::0&quot;));
380     }
381 }
    </pre>
  </body>
</html>