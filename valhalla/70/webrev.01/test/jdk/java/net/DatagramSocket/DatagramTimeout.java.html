<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>New test/jdk/java/net/DatagramSocket/DatagramTimeout.java</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
  <body>
    <pre>
  1 /*
  2  * Copyright (c) 1998, 2019, Oracle and/or its affiliates. All rights reserved.
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 /**
 25  * @test
 26  * @bug 4163126 8222829
 27  * @summary Test to see if timeout hangs. Also checks that
 28  * negative timeout value fails as expected.
 29  * @run testng DatagramTimeout
 30  * @run testng/othervm -Djdk.net.usePlainDatagramSocketImpl DatagramTimeout
 31  */
 32 
 33 import java.net.DatagramPacket;
 34 import java.net.DatagramSocket;
 35 import java.net.MulticastSocket;
 36 import java.net.SocketException;
 37 import java.net.SocketTimeoutException;
 38 import java.nio.channels.DatagramChannel;
 39 
 40 import org.testng.annotations.AfterTest;
 41 import org.testng.annotations.BeforeTest;
 42 import org.testng.annotations.DataProvider;
 43 import org.testng.annotations.Test;
 44 
 45 import static org.testng.Assert.assertEquals;
 46 import static org.testng.Assert.assertThrows;
 47 
 48 public class DatagramTimeout {
 49     private static final Class&lt;IllegalArgumentException&gt; IAE =
 50             IllegalArgumentException.class;
 51     private static final Class&lt;SocketTimeoutException&gt; STE =
 52             SocketTimeoutException.class;
 53     private static final Class&lt;SocketException&gt; SE = SocketException.class;
 54 
 55     private DatagramSocket datagramSocket, multicastSocket,
 56             datagramSocketAdaptor;
 57 
 58     @BeforeTest
 59     public void setUp() throws Exception {
 60         datagramSocket = new DatagramSocket();
 61         multicastSocket = new MulticastSocket();
 62         datagramSocketAdaptor = DatagramChannel.open().socket();
 63     }
 64 
 65     @DataProvider(name = &quot;data&quot;)
 66     public Object[][] variants() {
 67         return new Object[][]{
 68                 { datagramSocket        },
 69                 { datagramSocketAdaptor },
 70                 { multicastSocket       },
 71         };
 72     }
 73 
 74     @Test(dataProvider = &quot;data&quot;)
 75     public void testSetNegTimeout(DatagramSocket ds)  {
 76         assertThrows(IAE, () -&gt; ds.setSoTimeout(-1));
 77     }
 78 
 79     @Test(dataProvider = &quot;data&quot;)
 80     public void testSetTimeout(DatagramSocket ds) throws Exception {
 81         byte[] buffer = new byte[50];
 82         DatagramPacket pkt = new DatagramPacket(buffer, buffer.length);
 83         ds.setSoTimeout(2);
 84         assertThrows(STE, () -&gt; ds.receive(pkt));
 85     }
 86 
 87     @Test(dataProvider = &quot;data&quot;)
 88     public void testGetTimeout(DatagramSocket ds) throws Exception {
 89         ds.setSoTimeout(10);
 90         assertEquals(10, ds.getSoTimeout());
 91     }
 92 
 93     @AfterTest
 94     public void tearDown() {
 95         datagramSocket.close();
 96         multicastSocket.close();
 97         datagramSocketAdaptor.close();
 98     }
 99 
100     @Test
101     public void testSetGetAfterClose() throws Exception {
102         var ds = new DatagramSocket();
103         var ms = new MulticastSocket();
104         var dsa = DatagramChannel.open().socket();
105 
106         ds.close();
107         ms.close();
108         dsa.close();
109         assertThrows(SE, () -&gt; ds.setSoTimeout(10));
110         assertThrows(SE, () -&gt; ds.getSoTimeout());
111         assertThrows(SE, () -&gt; ms.setSoTimeout(10));
112         assertThrows(SE, () -&gt; ms.getSoTimeout());
113         assertThrows(SE, () -&gt; dsa.setSoTimeout(10));
114         assertThrows(SE, () -&gt; dsa.getSoTimeout());
115     }
116 }
    </pre>
  </body>
</html>