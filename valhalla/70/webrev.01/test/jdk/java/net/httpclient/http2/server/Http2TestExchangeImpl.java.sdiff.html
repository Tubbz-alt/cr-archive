<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff test/jdk/java/net/httpclient/http2/server/Http2TestExchangeImpl.java</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
  </head>
<body>
<center><a href="../../../SocketOption/OptionsTest.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="../../websocket/WSHandshakeExceptionTest.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>test/jdk/java/net/httpclient/http2/server/Http2TestExchangeImpl.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 import java.io.InputStream;
 25 import java.io.OutputStream;
 26 import java.io.IOException;
 27 import java.net.URI;
 28 import java.net.InetSocketAddress;
 29 import java.net.http.HttpHeaders;
 30 import java.util.List;
 31 import java.util.Map;
 32 import java.util.concurrent.CompletableFuture;
 33 import javax.net.ssl.SSLSession;
 34 import jdk.internal.net.http.common.HttpHeadersBuilder;
 35 import jdk.internal.net.http.frame.HeaderFrame;
 36 import jdk.internal.net.http.frame.HeadersFrame;
 37 
 38 public class Http2TestExchangeImpl implements Http2TestExchange {
 39 

 40     final HttpHeaders reqheaders;
 41     final HttpHeadersBuilder rspheadersBuilder;
 42     final URI uri;
 43     final String method;
 44     final InputStream is;
 45     final BodyOutputStream os;
 46     final SSLSession sslSession;
 47     final int streamid;
 48     final boolean pushAllowed;
 49     final Http2TestServerConnection conn;
 50     final Http2TestServer server;
 51 
 52     int responseCode = -1;
 53     long responseLength;
 54 
 55     Http2TestExchangeImpl(int streamid,
 56                           String method,
 57                           HttpHeaders reqheaders,
 58                           HttpHeadersBuilder rspheadersBuilder,
 59                           URI uri,
</pre>
<hr />
<pre>
112             os.close();
113         } catch (IOException e) {
114             System.err.println(&quot;TestServer: HttpExchange.close exception: &quot; + e);
115             e.printStackTrace();
116         }
117     }
118 
119     @Override
120     public InputStream getRequestBody() {
121         return is;
122     }
123 
124     @Override
125     public OutputStream getResponseBody() {
126         return os;
127     }
128 
129     @Override
130     public void sendResponseHeaders(int rCode, long responseLength) throws IOException {
131         this.responseLength = responseLength;
<span class="line-modified">132         if (responseLength !=0 &amp;&amp; rCode != 204) {</span>
133                 long clen = responseLength &gt; 0 ? responseLength : 0;
134             rspheadersBuilder.setHeader(&quot;Content-length&quot;, Long.toString(clen));
135         }
136 
137         rspheadersBuilder.setHeader(&quot;:status&quot;, Integer.toString(rCode));
138         HttpHeaders headers = rspheadersBuilder.build();
139 
140         Http2TestServerConnection.ResponseHeaders response
141                 = new Http2TestServerConnection.ResponseHeaders(headers);
142         response.streamid(streamid);
143         response.setFlag(HeaderFrame.END_HEADERS);
144 
145 
146         if (responseLength &lt; 0 || rCode == 204) {
147             response.setFlag(HeadersFrame.END_STREAM);
148             os.closeInternal();
149         }
150         conn.outputQ.put(response);
151         os.goodToGo();
152         System.err.println(&quot;Sent response headers &quot; + rCode);
</pre>
<hr />
<pre>
181     public void serverPush(URI uri, HttpHeaders headers, InputStream content) {
182         HttpHeadersBuilder headersBuilder = new HttpHeadersBuilder();
183         headersBuilder.setHeader(&quot;:method&quot;, &quot;GET&quot;);
184         headersBuilder.setHeader(&quot;:scheme&quot;, uri.getScheme());
185         headersBuilder.setHeader(&quot;:authority&quot;, uri.getAuthority());
186         headersBuilder.setHeader(&quot;:path&quot;, uri.getPath());
187         for (Map.Entry&lt;String,List&lt;String&gt;&gt; entry : headers.map().entrySet()) {
188             for (String value : entry.getValue())
189                 headersBuilder.addHeader(entry.getKey(), value);
190         }
191         HttpHeaders combinedHeaders = headersBuilder.build();
192         OutgoingPushPromise pp = new OutgoingPushPromise(streamid, uri, combinedHeaders, content);
193 
194         try {
195             conn.outputQ.put(pp);
196             // writeLoop will spin up thread to read the InputStream
197         } catch (IOException ex) {
198             System.err.println(&quot;TestServer: pushPromise exception: &quot; + ex);
199         }
200     }




201 }
</pre>
</td>
<td>
<hr />
<pre>
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 import java.io.InputStream;
 25 import java.io.OutputStream;
 26 import java.io.IOException;
 27 import java.net.URI;
 28 import java.net.InetSocketAddress;
 29 import java.net.http.HttpHeaders;
 30 import java.util.List;
 31 import java.util.Map;
 32 import java.util.concurrent.CompletableFuture;
 33 import javax.net.ssl.SSLSession;
 34 import jdk.internal.net.http.common.HttpHeadersBuilder;
 35 import jdk.internal.net.http.frame.HeaderFrame;
 36 import jdk.internal.net.http.frame.HeadersFrame;
 37 
 38 public class Http2TestExchangeImpl implements Http2TestExchange {
 39 
<span class="line-added"> 40     static final String HEAD = &quot;HEAD&quot;;</span>
 41     final HttpHeaders reqheaders;
 42     final HttpHeadersBuilder rspheadersBuilder;
 43     final URI uri;
 44     final String method;
 45     final InputStream is;
 46     final BodyOutputStream os;
 47     final SSLSession sslSession;
 48     final int streamid;
 49     final boolean pushAllowed;
 50     final Http2TestServerConnection conn;
 51     final Http2TestServer server;
 52 
 53     int responseCode = -1;
 54     long responseLength;
 55 
 56     Http2TestExchangeImpl(int streamid,
 57                           String method,
 58                           HttpHeaders reqheaders,
 59                           HttpHeadersBuilder rspheadersBuilder,
 60                           URI uri,
</pre>
<hr />
<pre>
113             os.close();
114         } catch (IOException e) {
115             System.err.println(&quot;TestServer: HttpExchange.close exception: &quot; + e);
116             e.printStackTrace();
117         }
118     }
119 
120     @Override
121     public InputStream getRequestBody() {
122         return is;
123     }
124 
125     @Override
126     public OutputStream getResponseBody() {
127         return os;
128     }
129 
130     @Override
131     public void sendResponseHeaders(int rCode, long responseLength) throws IOException {
132         this.responseLength = responseLength;
<span class="line-modified">133         if (responseLength !=0 &amp;&amp; rCode != 204 &amp;&amp; !isHeadRequest()) {</span>
134                 long clen = responseLength &gt; 0 ? responseLength : 0;
135             rspheadersBuilder.setHeader(&quot;Content-length&quot;, Long.toString(clen));
136         }
137 
138         rspheadersBuilder.setHeader(&quot;:status&quot;, Integer.toString(rCode));
139         HttpHeaders headers = rspheadersBuilder.build();
140 
141         Http2TestServerConnection.ResponseHeaders response
142                 = new Http2TestServerConnection.ResponseHeaders(headers);
143         response.streamid(streamid);
144         response.setFlag(HeaderFrame.END_HEADERS);
145 
146 
147         if (responseLength &lt; 0 || rCode == 204) {
148             response.setFlag(HeadersFrame.END_STREAM);
149             os.closeInternal();
150         }
151         conn.outputQ.put(response);
152         os.goodToGo();
153         System.err.println(&quot;Sent response headers &quot; + rCode);
</pre>
<hr />
<pre>
182     public void serverPush(URI uri, HttpHeaders headers, InputStream content) {
183         HttpHeadersBuilder headersBuilder = new HttpHeadersBuilder();
184         headersBuilder.setHeader(&quot;:method&quot;, &quot;GET&quot;);
185         headersBuilder.setHeader(&quot;:scheme&quot;, uri.getScheme());
186         headersBuilder.setHeader(&quot;:authority&quot;, uri.getAuthority());
187         headersBuilder.setHeader(&quot;:path&quot;, uri.getPath());
188         for (Map.Entry&lt;String,List&lt;String&gt;&gt; entry : headers.map().entrySet()) {
189             for (String value : entry.getValue())
190                 headersBuilder.addHeader(entry.getKey(), value);
191         }
192         HttpHeaders combinedHeaders = headersBuilder.build();
193         OutgoingPushPromise pp = new OutgoingPushPromise(streamid, uri, combinedHeaders, content);
194 
195         try {
196             conn.outputQ.put(pp);
197             // writeLoop will spin up thread to read the InputStream
198         } catch (IOException ex) {
199             System.err.println(&quot;TestServer: pushPromise exception: &quot; + ex);
200         }
201     }
<span class="line-added">202 </span>
<span class="line-added">203     private boolean isHeadRequest() {</span>
<span class="line-added">204         return HEAD.equalsIgnoreCase(getRequestMethod());</span>
<span class="line-added">205     }</span>
206 }
</pre>
</td>
</tr>
</table>
<center><a href="../../../SocketOption/OptionsTest.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="../../websocket/WSHandshakeExceptionTest.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>