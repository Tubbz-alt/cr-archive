<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff test/jdk/sun/security/pkcs12/ParamsTest.java</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
<body>
<center><a href="ParamsPreferences.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="../tools/jarsigner/TimestampCheck.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>test/jdk/sun/security/pkcs12/ParamsTest.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2018, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 /*
 25  * @test
<span class="line-modified"> 26  * @bug 8076190</span>
 27  * @library /test/lib
 28  * @modules java.base/sun.security.pkcs
<span class="line-removed"> 29  *          java.base/sun.security.x509</span>
 30  *          java.base/sun.security.util
 31  * @summary Customizing the generation of a PKCS12 keystore
 32  */
 33 
 34 import jdk.test.lib.Asserts;
 35 import jdk.test.lib.SecurityTools;
 36 import jdk.test.lib.process.OutputAnalyzer;
 37 
 38 import java.io.File;
 39 import java.io.FileInputStream;
 40 import java.io.FileOutputStream;
 41 import java.io.IOException;
 42 import java.io.InputStream;
 43 import java.io.OutputStream;
 44 import java.io.UncheckedIOException;
 45 import java.nio.file.Files;
 46 import java.nio.file.Path;
 47 import java.security.KeyStore;
 48 import java.util.Base64;
 49 import java.util.Objects;
 50 
 51 import static jdk.test.lib.security.DerUtils.*;
<span class="line-modified"> 52 import static sun.security.x509.AlgorithmId.*;</span>

 53 import static sun.security.pkcs.ContentInfo.*;
 54 
 55 public class ParamsTest  {
 56 
 57     public static void main(String[] args) throws Throwable {
 58 
 59         // De-BASE64 textual files in ./params to `pwd`
 60         Files.newDirectoryStream(Path.of(System.getProperty(&quot;test.src&quot;), &quot;params&quot;))
 61                 .forEach(p -&gt; {
 62                     try (InputStream is = Files.newInputStream(p);
 63                          OutputStream os = Files.newOutputStream(p.getFileName())){
 64                         Base64.getMimeDecoder().wrap(is).transferTo(os);
 65                     } catch (IOException e) {
 66                         throw new UncheckedIOException(e);
 67                     }
 68                 });
 69 
 70         byte[] data;
 71 
 72         // openssl -&gt; keytool interop check
</pre>
<hr />
<pre>
 85 
 86         // os4. non default algs
 87         check(&quot;os4&quot;, &quot;a&quot;, &quot;changeit&quot;, &quot;changeit&quot;, true, true, true);
 88         check(&quot;os4&quot;, &quot;a&quot;, &quot;wrongpass&quot;, &quot;-&quot;, IOException.class, &quot;-&quot;, &quot;-&quot;);
 89         // no storepass no cert
 90         check(&quot;os4&quot;, &quot;a&quot;, null, &quot;changeit&quot;, true, false, true);
 91 
 92         // os5. strong non default algs
 93         check(&quot;os5&quot;, &quot;a&quot;, &quot;changeit&quot;, &quot;changeit&quot;, true, true, true);
 94         check(&quot;os5&quot;, &quot;a&quot;, &quot;wrongpass&quot;, &quot;-&quot;, IOException.class, &quot;-&quot;, &quot;-&quot;);
 95         // no storepass no cert
 96         check(&quot;os5&quot;, &quot;a&quot;, null, &quot;changeit&quot;, true, false, true);
 97 
 98         // keytool
 99 
100         // Current default pkcs12 setting
101         keytool(&quot;-importkeystore -srckeystore ks -srcstorepass changeit &quot;
102                 + &quot;-destkeystore ksnormal -deststorepass changeit&quot;);
103         data = Files.readAllBytes(Path.of(&quot;ksnormal&quot;));
104         checkInt(data, &quot;22&quot;, 100000); // Mac ic
<span class="line-modified">105         checkAlg(data, &quot;2000&quot;, SHA_oid); // Mac alg</span>
<span class="line-modified">106         checkAlg(data, &quot;110c010c01000&quot;, pbeWithSHA1AndDESede_oid); // key alg</span>
107         checkInt(data, &quot;110c010c010011&quot;, 50000); // key ic
108         checkAlg(data, &quot;110c10&quot;, ENCRYPTED_DATA_OID);
<span class="line-modified">109         checkAlg(data, &quot;110c110110&quot;, pbeWithSHA1AndRC2_40_oid); // cert alg</span>
110         checkInt(data, &quot;110c1101111&quot;, 50000); // cert ic
111 
112         check(&quot;ksnormal&quot;, &quot;a&quot;, &quot;changeit&quot;, &quot;changeit&quot;, true, true, true);
113         check(&quot;ksnormal&quot;, &quot;a&quot;, null, &quot;changeit&quot;, true, false, true);
114         check(&quot;ksnormal&quot;, &quot;a&quot;, &quot;wrongpass&quot;, &quot;-&quot;, IOException.class, &quot;-&quot;, &quot;-&quot;);
115 
116         // Add a new entry with password-less settings, still has a storepass
117         keytool(&quot;-keystore ksnormal -genkeypair -keyalg DSA &quot;
118                 + &quot;-storepass changeit -alias b -dname CN=b &quot;
119                 + &quot;-J-Dkeystore.pkcs12.certProtectionAlgorithm=NONE &quot;
120                 + &quot;-J-Dkeystore.pkcs12.macAlgorithm=NONE&quot;);
121         data = Files.readAllBytes(Path.of(&quot;ksnormal&quot;));
122         checkInt(data, &quot;22&quot;, 100000); // Mac ic
<span class="line-modified">123         checkAlg(data, &quot;2000&quot;, SHA_oid); // Mac alg</span>
<span class="line-modified">124         checkAlg(data, &quot;110c010c01000&quot;, pbeWithSHA1AndDESede_oid); // key alg</span>
125         checkInt(data, &quot;110c010c010011&quot;, 50000); // key ic
<span class="line-modified">126         checkAlg(data, &quot;110c010c11000&quot;, pbeWithSHA1AndDESede_oid); // new key alg</span>
127         checkInt(data, &quot;110c010c110011&quot;, 50000); // new key ic
128         checkAlg(data, &quot;110c10&quot;, ENCRYPTED_DATA_OID);
<span class="line-modified">129         checkAlg(data, &quot;110c110110&quot;, pbeWithSHA1AndRC2_40_oid); // cert alg</span>
130         checkInt(data, &quot;110c1101111&quot;, 50000); // cert ic
131         check(&quot;ksnormal&quot;, &quot;b&quot;, null, &quot;changeit&quot;, true, false, true);
132         check(&quot;ksnormal&quot;, &quot;b&quot;, &quot;changeit&quot;, &quot;changeit&quot;, true, true, true);
133 
134         // Different keypbe alg, no cert pbe and no mac
135         keytool(&quot;-importkeystore -srckeystore ks -srcstorepass changeit &quot;
136                 + &quot;-destkeystore ksnopass -deststorepass changeit &quot;
137                 + &quot;-J-Dkeystore.pkcs12.keyProtectionAlgorithm=PBEWithSHA1AndRC4_128 &quot;
138                 + &quot;-J-Dkeystore.pkcs12.certProtectionAlgorithm=NONE &quot;
139                 + &quot;-J-Dkeystore.pkcs12.macAlgorithm=NONE&quot;);
140         data = Files.readAllBytes(Path.of(&quot;ksnopass&quot;));
141         shouldNotExist(data, &quot;2&quot;); // no Mac
<span class="line-modified">142         checkAlg(data, &quot;110c010c01000&quot;, pbeWithSHA1AndRC4_128_oid);</span>
143         checkInt(data, &quot;110c010c010011&quot;, 50000);
144         checkAlg(data, &quot;110c10&quot;, DATA_OID);
145         check(&quot;ksnopass&quot;, &quot;a&quot;, null, &quot;changeit&quot;, true, true, true);
146         check(&quot;ksnopass&quot;, &quot;a&quot;, &quot;changeit&quot;, &quot;changeit&quot;, true, true, true);
147         check(&quot;ksnopass&quot;, &quot;a&quot;, &quot;wrongpass&quot;, &quot;changeit&quot;, true, true, true);
148 
149         // Add a new entry with normal settings, still password-less
150         keytool(&quot;-keystore ksnopass -genkeypair -keyalg DSA &quot;
151                 + &quot;-storepass changeit -alias b -dname CN=B&quot;);
152         data = Files.readAllBytes(Path.of(&quot;ksnopass&quot;));
153         shouldNotExist(data, &quot;2&quot;); // no Mac
<span class="line-modified">154         checkAlg(data, &quot;110c010c01000&quot;, pbeWithSHA1AndRC4_128_oid);</span>
155         checkInt(data, &quot;110c010c010011&quot;, 50000);
<span class="line-modified">156         checkAlg(data, &quot;110c010c11000&quot;, pbeWithSHA1AndDESede_oid);</span>
157         checkInt(data, &quot;110c010c110011&quot;, 50000);
158         checkAlg(data, &quot;110c10&quot;, DATA_OID);
159         check(&quot;ksnopass&quot;, &quot;a&quot;, null, &quot;changeit&quot;, true, true, true);
160         check(&quot;ksnopass&quot;, &quot;b&quot;, null, &quot;changeit&quot;, true, true, true);
161 
162         keytool(&quot;-importkeystore -srckeystore ks -srcstorepass changeit &quot;
163                 + &quot;-destkeystore ksnewic -deststorepass changeit &quot;
164                 + &quot;-J-Dkeystore.pkcs12.macIterationCount=5555 &quot;
165                 + &quot;-J-Dkeystore.pkcs12.certPbeIterationCount=6666 &quot;
166                 + &quot;-J-Dkeystore.pkcs12.keyPbeIterationCount=7777&quot;);
167         data = Files.readAllBytes(Path.of(&quot;ksnewic&quot;));
168         checkInt(data, &quot;22&quot;, 5555); // Mac ic
<span class="line-modified">169         checkAlg(data, &quot;2000&quot;, SHA_oid); // Mac alg</span>
<span class="line-modified">170         checkAlg(data, &quot;110c010c01000&quot;, pbeWithSHA1AndDESede_oid); // key alg</span>
171         checkInt(data, &quot;110c010c010011&quot;, 7777); // key ic
<span class="line-modified">172         checkAlg(data, &quot;110c110110&quot;, pbeWithSHA1AndRC2_40_oid); // cert alg</span>
173         checkInt(data, &quot;110c1101111&quot;, 6666); // cert ic
174 
175         // keypbe alg cannot be NONE
176         keytool(&quot;-keystore ksnewic -genkeypair -keyalg DSA &quot;
177                 + &quot;-storepass changeit -alias b -dname CN=B &quot;
178                 + &quot;-J-Dkeystore.pkcs12.keyProtectionAlgorithm=NONE&quot;)
179                 .shouldContain(&quot;NONE AlgorithmParameters not available&quot;)
180                 .shouldHaveExitValue(1);
181 
182         // new entry new keypbe alg (and default ic), else unchanged
183         keytool(&quot;-keystore ksnewic -genkeypair -keyalg DSA &quot;
184                 + &quot;-storepass changeit -alias b -dname CN=B &quot;
185                 + &quot;-J-Dkeystore.pkcs12.keyProtectionAlgorithm=PBEWithSHA1AndRC4_128&quot;);
186         data = Files.readAllBytes(Path.of(&quot;ksnewic&quot;));
187         checkInt(data, &quot;22&quot;, 5555); // Mac ic
<span class="line-modified">188         checkAlg(data, &quot;2000&quot;, SHA_oid); // Mac alg</span>
<span class="line-modified">189         checkAlg(data, &quot;110c010c01000&quot;, pbeWithSHA1AndDESede_oid); // key alg</span>
190         checkInt(data, &quot;110c010c010011&quot;, 7777); // key ic
<span class="line-modified">191         checkAlg(data, &quot;110c010c11000&quot;, pbeWithSHA1AndRC4_128_oid); // new key alg</span>
192         checkInt(data, &quot;110c010c110011&quot;, 50000); // new key ic
<span class="line-modified">193         checkAlg(data, &quot;110c110110&quot;, pbeWithSHA1AndRC2_40_oid); // cert alg</span>
194         checkInt(data, &quot;110c1101111&quot;, 6666); // cert ic
195 
196         // Check KeyStore loading multiple keystores
197         KeyStore ks = KeyStore.getInstance(&quot;pkcs12&quot;);
198         try (FileInputStream fis = new FileInputStream(&quot;ksnormal&quot;);
199                 FileOutputStream fos = new FileOutputStream(&quot;ksnormaldup&quot;)) {
200             ks.load(fis, &quot;changeit&quot;.toCharArray());
201             ks.store(fos, &quot;changeit&quot;.toCharArray());
202         }
203         data = Files.readAllBytes(Path.of(&quot;ksnormaldup&quot;));
204         checkInt(data, &quot;22&quot;, 100000); // Mac ic
<span class="line-modified">205         checkAlg(data, &quot;2000&quot;, SHA_oid); // Mac alg</span>
<span class="line-modified">206         checkAlg(data, &quot;110c010c01000&quot;, pbeWithSHA1AndDESede_oid); // key alg</span>
207         checkInt(data, &quot;110c010c010011&quot;, 50000); // key ic
<span class="line-modified">208         checkAlg(data, &quot;110c010c11000&quot;, pbeWithSHA1AndDESede_oid); // new key alg</span>
209         checkInt(data, &quot;110c010c110011&quot;, 50000); // new key ic
210         checkAlg(data, &quot;110c10&quot;, ENCRYPTED_DATA_OID);
<span class="line-modified">211         checkAlg(data, &quot;110c110110&quot;, pbeWithSHA1AndRC2_40_oid); // cert alg</span>
212         checkInt(data, &quot;110c1101111&quot;, 50000); // cert ic
213 
214         try (FileInputStream fis = new FileInputStream(&quot;ksnopass&quot;);
215              FileOutputStream fos = new FileOutputStream(&quot;ksnopassdup&quot;)) {
216             ks.load(fis, &quot;changeit&quot;.toCharArray());
217             ks.store(fos, &quot;changeit&quot;.toCharArray());
218         }
219         data = Files.readAllBytes(Path.of(&quot;ksnopassdup&quot;));
220         shouldNotExist(data, &quot;2&quot;); // no Mac
<span class="line-modified">221         checkAlg(data, &quot;110c010c01000&quot;, pbeWithSHA1AndRC4_128_oid);</span>
222         checkInt(data, &quot;110c010c010011&quot;, 50000);
<span class="line-modified">223         checkAlg(data, &quot;110c010c11000&quot;, pbeWithSHA1AndDESede_oid);</span>
224         checkInt(data, &quot;110c010c110011&quot;, 50000);
225         checkAlg(data, &quot;110c10&quot;, DATA_OID);
226 
227         try (FileInputStream fis = new FileInputStream(&quot;ksnewic&quot;);
228              FileOutputStream fos = new FileOutputStream(&quot;ksnewicdup&quot;)) {
229             ks.load(fis, &quot;changeit&quot;.toCharArray());
230             ks.store(fos, &quot;changeit&quot;.toCharArray());
231         }
232         data = Files.readAllBytes(Path.of(&quot;ksnewicdup&quot;));
233         checkInt(data, &quot;22&quot;, 5555); // Mac ic
<span class="line-modified">234         checkAlg(data, &quot;2000&quot;, SHA_oid); // Mac alg</span>
<span class="line-modified">235         checkAlg(data, &quot;110c010c01000&quot;, pbeWithSHA1AndDESede_oid); // key alg</span>
236         checkInt(data, &quot;110c010c010011&quot;, 7777); // key ic
<span class="line-modified">237         checkAlg(data, &quot;110c010c11000&quot;, pbeWithSHA1AndRC4_128_oid); // new key alg</span>
238         checkInt(data, &quot;110c010c110011&quot;, 50000); // new key ic
<span class="line-modified">239         checkAlg(data, &quot;110c110110&quot;, pbeWithSHA1AndRC2_40_oid); // cert alg</span>
240         checkInt(data, &quot;110c1101111&quot;, 6666); // cert ic
241 
242         // Check keytool behavior
243 
244         // ksnormal has password
245 
246         keytool(&quot;-list -keystore ksnormal&quot;)
247                 .shouldContain(&quot;WARNING WARNING WARNING&quot;)
248                 .shouldContain(&quot;Certificate chain length: 0&quot;);
249 
250         SecurityTools.setResponse(&quot;changeit&quot;);
251         keytool(&quot;-list -keystore ksnormal&quot;)
252                 .shouldNotContain(&quot;WARNING WARNING WARNING&quot;)
253                 .shouldContain(&quot;Certificate fingerprint&quot;);
254 
255         // ksnopass is password-less
256 
257         keytool(&quot;-list -keystore ksnopass&quot;)
258                 .shouldNotContain(&quot;WARNING WARNING WARNING&quot;)
259                 .shouldContain(&quot;Certificate fingerprint&quot;);
</pre>
<hr />
<pre>
417             return;
418         }
419 
420         try {
421             actualCert = (ks.getCertificate(alias) != null);
422         } catch (Exception e) {
423             e.printStackTrace(System.out);
424             actualCert = e.getClass();
425         }
426         Asserts.assertEQ(expectedCert, actualCert, label + &quot;-cert&quot;);
427 
428         try {
429             actualKey = (ks.getKey(alias, keypass.toCharArray()) != null);
430         } catch (Exception e) {
431             e.printStackTrace(System.out);
432             actualKey = e.getClass();
433         }
434         Asserts.assertEQ(expectedKey, actualKey, label + &quot;-key&quot;);
435     }
436 




437     static OutputAnalyzer keytool(String s) throws Throwable {
438         return SecurityTools.keytool(s);
439     }
440 }
</pre>
</td>
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2018, 2020, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 /*
 25  * @test
<span class="line-modified"> 26  * @bug 8076190 8242151</span>
 27  * @library /test/lib
 28  * @modules java.base/sun.security.pkcs

 29  *          java.base/sun.security.util
 30  * @summary Customizing the generation of a PKCS12 keystore
 31  */
 32 
 33 import jdk.test.lib.Asserts;
 34 import jdk.test.lib.SecurityTools;
 35 import jdk.test.lib.process.OutputAnalyzer;
 36 
 37 import java.io.File;
 38 import java.io.FileInputStream;
 39 import java.io.FileOutputStream;
 40 import java.io.IOException;
 41 import java.io.InputStream;
 42 import java.io.OutputStream;
 43 import java.io.UncheckedIOException;
 44 import java.nio.file.Files;
 45 import java.nio.file.Path;
 46 import java.security.KeyStore;
 47 import java.util.Base64;
 48 import java.util.Objects;
 49 
 50 import static jdk.test.lib.security.DerUtils.*;
<span class="line-modified"> 51 import sun.security.util.ObjectIdentifier;</span>
<span class="line-added"> 52 import sun.security.util.KnownOIDs;</span>
 53 import static sun.security.pkcs.ContentInfo.*;
 54 
 55 public class ParamsTest  {
 56 
 57     public static void main(String[] args) throws Throwable {
 58 
 59         // De-BASE64 textual files in ./params to `pwd`
 60         Files.newDirectoryStream(Path.of(System.getProperty(&quot;test.src&quot;), &quot;params&quot;))
 61                 .forEach(p -&gt; {
 62                     try (InputStream is = Files.newInputStream(p);
 63                          OutputStream os = Files.newOutputStream(p.getFileName())){
 64                         Base64.getMimeDecoder().wrap(is).transferTo(os);
 65                     } catch (IOException e) {
 66                         throw new UncheckedIOException(e);
 67                     }
 68                 });
 69 
 70         byte[] data;
 71 
 72         // openssl -&gt; keytool interop check
</pre>
<hr />
<pre>
 85 
 86         // os4. non default algs
 87         check(&quot;os4&quot;, &quot;a&quot;, &quot;changeit&quot;, &quot;changeit&quot;, true, true, true);
 88         check(&quot;os4&quot;, &quot;a&quot;, &quot;wrongpass&quot;, &quot;-&quot;, IOException.class, &quot;-&quot;, &quot;-&quot;);
 89         // no storepass no cert
 90         check(&quot;os4&quot;, &quot;a&quot;, null, &quot;changeit&quot;, true, false, true);
 91 
 92         // os5. strong non default algs
 93         check(&quot;os5&quot;, &quot;a&quot;, &quot;changeit&quot;, &quot;changeit&quot;, true, true, true);
 94         check(&quot;os5&quot;, &quot;a&quot;, &quot;wrongpass&quot;, &quot;-&quot;, IOException.class, &quot;-&quot;, &quot;-&quot;);
 95         // no storepass no cert
 96         check(&quot;os5&quot;, &quot;a&quot;, null, &quot;changeit&quot;, true, false, true);
 97 
 98         // keytool
 99 
100         // Current default pkcs12 setting
101         keytool(&quot;-importkeystore -srckeystore ks -srcstorepass changeit &quot;
102                 + &quot;-destkeystore ksnormal -deststorepass changeit&quot;);
103         data = Files.readAllBytes(Path.of(&quot;ksnormal&quot;));
104         checkInt(data, &quot;22&quot;, 100000); // Mac ic
<span class="line-modified">105         checkAlg(data, &quot;2000&quot;, oid(KnownOIDs.SHA_1)); // Mac alg</span>
<span class="line-modified">106         checkAlg(data, &quot;110c010c01000&quot;, oid(KnownOIDs.PBEWithSHA1AndDESede)); // key alg</span>
107         checkInt(data, &quot;110c010c010011&quot;, 50000); // key ic
108         checkAlg(data, &quot;110c10&quot;, ENCRYPTED_DATA_OID);
<span class="line-modified">109         checkAlg(data, &quot;110c110110&quot;, oid(KnownOIDs.PBEWithSHA1AndRC2_40)); // cert alg</span>
110         checkInt(data, &quot;110c1101111&quot;, 50000); // cert ic
111 
112         check(&quot;ksnormal&quot;, &quot;a&quot;, &quot;changeit&quot;, &quot;changeit&quot;, true, true, true);
113         check(&quot;ksnormal&quot;, &quot;a&quot;, null, &quot;changeit&quot;, true, false, true);
114         check(&quot;ksnormal&quot;, &quot;a&quot;, &quot;wrongpass&quot;, &quot;-&quot;, IOException.class, &quot;-&quot;, &quot;-&quot;);
115 
116         // Add a new entry with password-less settings, still has a storepass
117         keytool(&quot;-keystore ksnormal -genkeypair -keyalg DSA &quot;
118                 + &quot;-storepass changeit -alias b -dname CN=b &quot;
119                 + &quot;-J-Dkeystore.pkcs12.certProtectionAlgorithm=NONE &quot;
120                 + &quot;-J-Dkeystore.pkcs12.macAlgorithm=NONE&quot;);
121         data = Files.readAllBytes(Path.of(&quot;ksnormal&quot;));
122         checkInt(data, &quot;22&quot;, 100000); // Mac ic
<span class="line-modified">123         checkAlg(data, &quot;2000&quot;, oid(KnownOIDs.SHA_1)); // Mac alg</span>
<span class="line-modified">124         checkAlg(data, &quot;110c010c01000&quot;, oid(KnownOIDs.PBEWithSHA1AndDESede)); // key alg</span>
125         checkInt(data, &quot;110c010c010011&quot;, 50000); // key ic
<span class="line-modified">126         checkAlg(data, &quot;110c010c11000&quot;, oid(KnownOIDs.PBEWithSHA1AndDESede)); // new key alg</span>
127         checkInt(data, &quot;110c010c110011&quot;, 50000); // new key ic
128         checkAlg(data, &quot;110c10&quot;, ENCRYPTED_DATA_OID);
<span class="line-modified">129         checkAlg(data, &quot;110c110110&quot;, oid(KnownOIDs.PBEWithSHA1AndRC2_40)); // cert alg</span>
130         checkInt(data, &quot;110c1101111&quot;, 50000); // cert ic
131         check(&quot;ksnormal&quot;, &quot;b&quot;, null, &quot;changeit&quot;, true, false, true);
132         check(&quot;ksnormal&quot;, &quot;b&quot;, &quot;changeit&quot;, &quot;changeit&quot;, true, true, true);
133 
134         // Different keypbe alg, no cert pbe and no mac
135         keytool(&quot;-importkeystore -srckeystore ks -srcstorepass changeit &quot;
136                 + &quot;-destkeystore ksnopass -deststorepass changeit &quot;
137                 + &quot;-J-Dkeystore.pkcs12.keyProtectionAlgorithm=PBEWithSHA1AndRC4_128 &quot;
138                 + &quot;-J-Dkeystore.pkcs12.certProtectionAlgorithm=NONE &quot;
139                 + &quot;-J-Dkeystore.pkcs12.macAlgorithm=NONE&quot;);
140         data = Files.readAllBytes(Path.of(&quot;ksnopass&quot;));
141         shouldNotExist(data, &quot;2&quot;); // no Mac
<span class="line-modified">142         checkAlg(data, &quot;110c010c01000&quot;, oid(KnownOIDs.PBEWithSHA1AndRC4_128));</span>
143         checkInt(data, &quot;110c010c010011&quot;, 50000);
144         checkAlg(data, &quot;110c10&quot;, DATA_OID);
145         check(&quot;ksnopass&quot;, &quot;a&quot;, null, &quot;changeit&quot;, true, true, true);
146         check(&quot;ksnopass&quot;, &quot;a&quot;, &quot;changeit&quot;, &quot;changeit&quot;, true, true, true);
147         check(&quot;ksnopass&quot;, &quot;a&quot;, &quot;wrongpass&quot;, &quot;changeit&quot;, true, true, true);
148 
149         // Add a new entry with normal settings, still password-less
150         keytool(&quot;-keystore ksnopass -genkeypair -keyalg DSA &quot;
151                 + &quot;-storepass changeit -alias b -dname CN=B&quot;);
152         data = Files.readAllBytes(Path.of(&quot;ksnopass&quot;));
153         shouldNotExist(data, &quot;2&quot;); // no Mac
<span class="line-modified">154         checkAlg(data, &quot;110c010c01000&quot;, oid(KnownOIDs.PBEWithSHA1AndRC4_128));</span>
155         checkInt(data, &quot;110c010c010011&quot;, 50000);
<span class="line-modified">156         checkAlg(data, &quot;110c010c11000&quot;, oid(KnownOIDs.PBEWithSHA1AndDESede));</span>
157         checkInt(data, &quot;110c010c110011&quot;, 50000);
158         checkAlg(data, &quot;110c10&quot;, DATA_OID);
159         check(&quot;ksnopass&quot;, &quot;a&quot;, null, &quot;changeit&quot;, true, true, true);
160         check(&quot;ksnopass&quot;, &quot;b&quot;, null, &quot;changeit&quot;, true, true, true);
161 
162         keytool(&quot;-importkeystore -srckeystore ks -srcstorepass changeit &quot;
163                 + &quot;-destkeystore ksnewic -deststorepass changeit &quot;
164                 + &quot;-J-Dkeystore.pkcs12.macIterationCount=5555 &quot;
165                 + &quot;-J-Dkeystore.pkcs12.certPbeIterationCount=6666 &quot;
166                 + &quot;-J-Dkeystore.pkcs12.keyPbeIterationCount=7777&quot;);
167         data = Files.readAllBytes(Path.of(&quot;ksnewic&quot;));
168         checkInt(data, &quot;22&quot;, 5555); // Mac ic
<span class="line-modified">169         checkAlg(data, &quot;2000&quot;, oid(KnownOIDs.SHA_1)); // Mac alg</span>
<span class="line-modified">170         checkAlg(data, &quot;110c010c01000&quot;, oid(KnownOIDs.PBEWithSHA1AndDESede)); // key alg</span>
171         checkInt(data, &quot;110c010c010011&quot;, 7777); // key ic
<span class="line-modified">172         checkAlg(data, &quot;110c110110&quot;, oid(KnownOIDs.PBEWithSHA1AndRC2_40)); // cert alg</span>
173         checkInt(data, &quot;110c1101111&quot;, 6666); // cert ic
174 
175         // keypbe alg cannot be NONE
176         keytool(&quot;-keystore ksnewic -genkeypair -keyalg DSA &quot;
177                 + &quot;-storepass changeit -alias b -dname CN=B &quot;
178                 + &quot;-J-Dkeystore.pkcs12.keyProtectionAlgorithm=NONE&quot;)
179                 .shouldContain(&quot;NONE AlgorithmParameters not available&quot;)
180                 .shouldHaveExitValue(1);
181 
182         // new entry new keypbe alg (and default ic), else unchanged
183         keytool(&quot;-keystore ksnewic -genkeypair -keyalg DSA &quot;
184                 + &quot;-storepass changeit -alias b -dname CN=B &quot;
185                 + &quot;-J-Dkeystore.pkcs12.keyProtectionAlgorithm=PBEWithSHA1AndRC4_128&quot;);
186         data = Files.readAllBytes(Path.of(&quot;ksnewic&quot;));
187         checkInt(data, &quot;22&quot;, 5555); // Mac ic
<span class="line-modified">188         checkAlg(data, &quot;2000&quot;, oid(KnownOIDs.SHA_1)); // Mac alg</span>
<span class="line-modified">189         checkAlg(data, &quot;110c010c01000&quot;, oid(KnownOIDs.PBEWithSHA1AndDESede)); // key alg</span>
190         checkInt(data, &quot;110c010c010011&quot;, 7777); // key ic
<span class="line-modified">191         checkAlg(data, &quot;110c010c11000&quot;, oid(KnownOIDs.PBEWithSHA1AndRC4_128)); // new key alg</span>
192         checkInt(data, &quot;110c010c110011&quot;, 50000); // new key ic
<span class="line-modified">193         checkAlg(data, &quot;110c110110&quot;, oid(KnownOIDs.PBEWithSHA1AndRC2_40)); // cert alg</span>
194         checkInt(data, &quot;110c1101111&quot;, 6666); // cert ic
195 
196         // Check KeyStore loading multiple keystores
197         KeyStore ks = KeyStore.getInstance(&quot;pkcs12&quot;);
198         try (FileInputStream fis = new FileInputStream(&quot;ksnormal&quot;);
199                 FileOutputStream fos = new FileOutputStream(&quot;ksnormaldup&quot;)) {
200             ks.load(fis, &quot;changeit&quot;.toCharArray());
201             ks.store(fos, &quot;changeit&quot;.toCharArray());
202         }
203         data = Files.readAllBytes(Path.of(&quot;ksnormaldup&quot;));
204         checkInt(data, &quot;22&quot;, 100000); // Mac ic
<span class="line-modified">205         checkAlg(data, &quot;2000&quot;, oid(KnownOIDs.SHA_1)); // Mac alg</span>
<span class="line-modified">206         checkAlg(data, &quot;110c010c01000&quot;, oid(KnownOIDs.PBEWithSHA1AndDESede)); // key alg</span>
207         checkInt(data, &quot;110c010c010011&quot;, 50000); // key ic
<span class="line-modified">208         checkAlg(data, &quot;110c010c11000&quot;, oid(KnownOIDs.PBEWithSHA1AndDESede)); // new key alg</span>
209         checkInt(data, &quot;110c010c110011&quot;, 50000); // new key ic
210         checkAlg(data, &quot;110c10&quot;, ENCRYPTED_DATA_OID);
<span class="line-modified">211         checkAlg(data, &quot;110c110110&quot;, oid(KnownOIDs.PBEWithSHA1AndRC2_40)); // cert alg</span>
212         checkInt(data, &quot;110c1101111&quot;, 50000); // cert ic
213 
214         try (FileInputStream fis = new FileInputStream(&quot;ksnopass&quot;);
215              FileOutputStream fos = new FileOutputStream(&quot;ksnopassdup&quot;)) {
216             ks.load(fis, &quot;changeit&quot;.toCharArray());
217             ks.store(fos, &quot;changeit&quot;.toCharArray());
218         }
219         data = Files.readAllBytes(Path.of(&quot;ksnopassdup&quot;));
220         shouldNotExist(data, &quot;2&quot;); // no Mac
<span class="line-modified">221         checkAlg(data, &quot;110c010c01000&quot;, oid(KnownOIDs.PBEWithSHA1AndRC4_128));</span>
222         checkInt(data, &quot;110c010c010011&quot;, 50000);
<span class="line-modified">223         checkAlg(data, &quot;110c010c11000&quot;, oid(KnownOIDs.PBEWithSHA1AndDESede));</span>
224         checkInt(data, &quot;110c010c110011&quot;, 50000);
225         checkAlg(data, &quot;110c10&quot;, DATA_OID);
226 
227         try (FileInputStream fis = new FileInputStream(&quot;ksnewic&quot;);
228              FileOutputStream fos = new FileOutputStream(&quot;ksnewicdup&quot;)) {
229             ks.load(fis, &quot;changeit&quot;.toCharArray());
230             ks.store(fos, &quot;changeit&quot;.toCharArray());
231         }
232         data = Files.readAllBytes(Path.of(&quot;ksnewicdup&quot;));
233         checkInt(data, &quot;22&quot;, 5555); // Mac ic
<span class="line-modified">234         checkAlg(data, &quot;2000&quot;, oid(KnownOIDs.SHA_1)); // Mac alg</span>
<span class="line-modified">235         checkAlg(data, &quot;110c010c01000&quot;, oid(KnownOIDs.PBEWithSHA1AndDESede)); // key alg</span>
236         checkInt(data, &quot;110c010c010011&quot;, 7777); // key ic
<span class="line-modified">237         checkAlg(data, &quot;110c010c11000&quot;, oid(KnownOIDs.PBEWithSHA1AndRC4_128)); // new key alg</span>
238         checkInt(data, &quot;110c010c110011&quot;, 50000); // new key ic
<span class="line-modified">239         checkAlg(data, &quot;110c110110&quot;, oid(KnownOIDs.PBEWithSHA1AndRC2_40)); // cert alg</span>
240         checkInt(data, &quot;110c1101111&quot;, 6666); // cert ic
241 
242         // Check keytool behavior
243 
244         // ksnormal has password
245 
246         keytool(&quot;-list -keystore ksnormal&quot;)
247                 .shouldContain(&quot;WARNING WARNING WARNING&quot;)
248                 .shouldContain(&quot;Certificate chain length: 0&quot;);
249 
250         SecurityTools.setResponse(&quot;changeit&quot;);
251         keytool(&quot;-list -keystore ksnormal&quot;)
252                 .shouldNotContain(&quot;WARNING WARNING WARNING&quot;)
253                 .shouldContain(&quot;Certificate fingerprint&quot;);
254 
255         // ksnopass is password-less
256 
257         keytool(&quot;-list -keystore ksnopass&quot;)
258                 .shouldNotContain(&quot;WARNING WARNING WARNING&quot;)
259                 .shouldContain(&quot;Certificate fingerprint&quot;);
</pre>
<hr />
<pre>
417             return;
418         }
419 
420         try {
421             actualCert = (ks.getCertificate(alias) != null);
422         } catch (Exception e) {
423             e.printStackTrace(System.out);
424             actualCert = e.getClass();
425         }
426         Asserts.assertEQ(expectedCert, actualCert, label + &quot;-cert&quot;);
427 
428         try {
429             actualKey = (ks.getKey(alias, keypass.toCharArray()) != null);
430         } catch (Exception e) {
431             e.printStackTrace(System.out);
432             actualKey = e.getClass();
433         }
434         Asserts.assertEQ(expectedKey, actualKey, label + &quot;-key&quot;);
435     }
436 
<span class="line-added">437     private static ObjectIdentifier oid(KnownOIDs o) {</span>
<span class="line-added">438         return ObjectIdentifier.of(o);</span>
<span class="line-added">439     }</span>
<span class="line-added">440 </span>
441     static OutputAnalyzer keytool(String s) throws Throwable {
442         return SecurityTools.keytool(s);
443     }
444 }
</pre>
</td>
</tr>
</table>
<center><a href="ParamsPreferences.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="../tools/jarsigner/TimestampCheck.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>