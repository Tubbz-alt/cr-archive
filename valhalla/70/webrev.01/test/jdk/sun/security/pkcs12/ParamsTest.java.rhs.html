<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames test/jdk/sun/security/pkcs12/ParamsTest.java</title>
    <link rel="stylesheet" href="../../../../../style.css" />
    <script type="text/javascript" src="../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
<a name="1" id="anc1"></a><span class="line-modified">  2  * Copyright (c) 2018, 2020, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 /*
 25  * @test
<a name="2" id="anc2"></a><span class="line-modified"> 26  * @bug 8076190 8242151</span>
 27  * @library /test/lib
 28  * @modules java.base/sun.security.pkcs
<a name="3" id="anc3"></a>
 29  *          java.base/sun.security.util
 30  * @summary Customizing the generation of a PKCS12 keystore
 31  */
 32 
 33 import jdk.test.lib.Asserts;
 34 import jdk.test.lib.SecurityTools;
 35 import jdk.test.lib.process.OutputAnalyzer;
 36 
 37 import java.io.File;
 38 import java.io.FileInputStream;
 39 import java.io.FileOutputStream;
 40 import java.io.IOException;
 41 import java.io.InputStream;
 42 import java.io.OutputStream;
 43 import java.io.UncheckedIOException;
 44 import java.nio.file.Files;
 45 import java.nio.file.Path;
 46 import java.security.KeyStore;
 47 import java.util.Base64;
 48 import java.util.Objects;
 49 
 50 import static jdk.test.lib.security.DerUtils.*;
<a name="4" id="anc4"></a><span class="line-modified"> 51 import sun.security.util.ObjectIdentifier;</span>
<span class="line-added"> 52 import sun.security.util.KnownOIDs;</span>
 53 import static sun.security.pkcs.ContentInfo.*;
 54 
 55 public class ParamsTest  {
 56 
 57     public static void main(String[] args) throws Throwable {
 58 
 59         // De-BASE64 textual files in ./params to `pwd`
 60         Files.newDirectoryStream(Path.of(System.getProperty(&quot;test.src&quot;), &quot;params&quot;))
 61                 .forEach(p -&gt; {
 62                     try (InputStream is = Files.newInputStream(p);
 63                          OutputStream os = Files.newOutputStream(p.getFileName())){
 64                         Base64.getMimeDecoder().wrap(is).transferTo(os);
 65                     } catch (IOException e) {
 66                         throw new UncheckedIOException(e);
 67                     }
 68                 });
 69 
 70         byte[] data;
 71 
 72         // openssl -&gt; keytool interop check
 73 
 74         // os2. no cert pbe, no mac.
 75         check(&quot;os2&quot;, &quot;a&quot;, null, &quot;changeit&quot;, true, true, true);
 76         check(&quot;os2&quot;, &quot;a&quot;, &quot;changeit&quot;, &quot;changeit&quot;, true, true, true);
 77         // You can even load it with a wrong storepass, controversial
 78         check(&quot;os2&quot;, &quot;a&quot;, &quot;wrongpass&quot;, &quot;changeit&quot;, true, true, true);
 79 
 80         // os3. no cert pbe, has mac. just like JKS
 81         check(&quot;os3&quot;, &quot;a&quot;, null, &quot;changeit&quot;, true, true, true);
 82         check(&quot;os3&quot;, &quot;a&quot;, &quot;changeit&quot;, &quot;changeit&quot;, true, true, true);
 83         // Cannot load with a wrong storepass, same as JKS
 84         check(&quot;os3&quot;, &quot;a&quot;, &quot;wrongpass&quot;, &quot;-&quot;, IOException.class, &quot;-&quot;, &quot;-&quot;);
 85 
 86         // os4. non default algs
 87         check(&quot;os4&quot;, &quot;a&quot;, &quot;changeit&quot;, &quot;changeit&quot;, true, true, true);
 88         check(&quot;os4&quot;, &quot;a&quot;, &quot;wrongpass&quot;, &quot;-&quot;, IOException.class, &quot;-&quot;, &quot;-&quot;);
 89         // no storepass no cert
 90         check(&quot;os4&quot;, &quot;a&quot;, null, &quot;changeit&quot;, true, false, true);
 91 
 92         // os5. strong non default algs
 93         check(&quot;os5&quot;, &quot;a&quot;, &quot;changeit&quot;, &quot;changeit&quot;, true, true, true);
 94         check(&quot;os5&quot;, &quot;a&quot;, &quot;wrongpass&quot;, &quot;-&quot;, IOException.class, &quot;-&quot;, &quot;-&quot;);
 95         // no storepass no cert
 96         check(&quot;os5&quot;, &quot;a&quot;, null, &quot;changeit&quot;, true, false, true);
 97 
 98         // keytool
 99 
100         // Current default pkcs12 setting
101         keytool(&quot;-importkeystore -srckeystore ks -srcstorepass changeit &quot;
102                 + &quot;-destkeystore ksnormal -deststorepass changeit&quot;);
103         data = Files.readAllBytes(Path.of(&quot;ksnormal&quot;));
104         checkInt(data, &quot;22&quot;, 100000); // Mac ic
<a name="5" id="anc5"></a><span class="line-modified">105         checkAlg(data, &quot;2000&quot;, oid(KnownOIDs.SHA_1)); // Mac alg</span>
<span class="line-modified">106         checkAlg(data, &quot;110c010c01000&quot;, oid(KnownOIDs.PBEWithSHA1AndDESede)); // key alg</span>
107         checkInt(data, &quot;110c010c010011&quot;, 50000); // key ic
108         checkAlg(data, &quot;110c10&quot;, ENCRYPTED_DATA_OID);
<a name="6" id="anc6"></a><span class="line-modified">109         checkAlg(data, &quot;110c110110&quot;, oid(KnownOIDs.PBEWithSHA1AndRC2_40)); // cert alg</span>
110         checkInt(data, &quot;110c1101111&quot;, 50000); // cert ic
111 
112         check(&quot;ksnormal&quot;, &quot;a&quot;, &quot;changeit&quot;, &quot;changeit&quot;, true, true, true);
113         check(&quot;ksnormal&quot;, &quot;a&quot;, null, &quot;changeit&quot;, true, false, true);
114         check(&quot;ksnormal&quot;, &quot;a&quot;, &quot;wrongpass&quot;, &quot;-&quot;, IOException.class, &quot;-&quot;, &quot;-&quot;);
115 
116         // Add a new entry with password-less settings, still has a storepass
117         keytool(&quot;-keystore ksnormal -genkeypair -keyalg DSA &quot;
118                 + &quot;-storepass changeit -alias b -dname CN=b &quot;
119                 + &quot;-J-Dkeystore.pkcs12.certProtectionAlgorithm=NONE &quot;
120                 + &quot;-J-Dkeystore.pkcs12.macAlgorithm=NONE&quot;);
121         data = Files.readAllBytes(Path.of(&quot;ksnormal&quot;));
122         checkInt(data, &quot;22&quot;, 100000); // Mac ic
<a name="7" id="anc7"></a><span class="line-modified">123         checkAlg(data, &quot;2000&quot;, oid(KnownOIDs.SHA_1)); // Mac alg</span>
<span class="line-modified">124         checkAlg(data, &quot;110c010c01000&quot;, oid(KnownOIDs.PBEWithSHA1AndDESede)); // key alg</span>
125         checkInt(data, &quot;110c010c010011&quot;, 50000); // key ic
<a name="8" id="anc8"></a><span class="line-modified">126         checkAlg(data, &quot;110c010c11000&quot;, oid(KnownOIDs.PBEWithSHA1AndDESede)); // new key alg</span>
127         checkInt(data, &quot;110c010c110011&quot;, 50000); // new key ic
128         checkAlg(data, &quot;110c10&quot;, ENCRYPTED_DATA_OID);
<a name="9" id="anc9"></a><span class="line-modified">129         checkAlg(data, &quot;110c110110&quot;, oid(KnownOIDs.PBEWithSHA1AndRC2_40)); // cert alg</span>
130         checkInt(data, &quot;110c1101111&quot;, 50000); // cert ic
131         check(&quot;ksnormal&quot;, &quot;b&quot;, null, &quot;changeit&quot;, true, false, true);
132         check(&quot;ksnormal&quot;, &quot;b&quot;, &quot;changeit&quot;, &quot;changeit&quot;, true, true, true);
133 
134         // Different keypbe alg, no cert pbe and no mac
135         keytool(&quot;-importkeystore -srckeystore ks -srcstorepass changeit &quot;
136                 + &quot;-destkeystore ksnopass -deststorepass changeit &quot;
137                 + &quot;-J-Dkeystore.pkcs12.keyProtectionAlgorithm=PBEWithSHA1AndRC4_128 &quot;
138                 + &quot;-J-Dkeystore.pkcs12.certProtectionAlgorithm=NONE &quot;
139                 + &quot;-J-Dkeystore.pkcs12.macAlgorithm=NONE&quot;);
140         data = Files.readAllBytes(Path.of(&quot;ksnopass&quot;));
141         shouldNotExist(data, &quot;2&quot;); // no Mac
<a name="10" id="anc10"></a><span class="line-modified">142         checkAlg(data, &quot;110c010c01000&quot;, oid(KnownOIDs.PBEWithSHA1AndRC4_128));</span>
143         checkInt(data, &quot;110c010c010011&quot;, 50000);
144         checkAlg(data, &quot;110c10&quot;, DATA_OID);
145         check(&quot;ksnopass&quot;, &quot;a&quot;, null, &quot;changeit&quot;, true, true, true);
146         check(&quot;ksnopass&quot;, &quot;a&quot;, &quot;changeit&quot;, &quot;changeit&quot;, true, true, true);
147         check(&quot;ksnopass&quot;, &quot;a&quot;, &quot;wrongpass&quot;, &quot;changeit&quot;, true, true, true);
148 
149         // Add a new entry with normal settings, still password-less
150         keytool(&quot;-keystore ksnopass -genkeypair -keyalg DSA &quot;
151                 + &quot;-storepass changeit -alias b -dname CN=B&quot;);
152         data = Files.readAllBytes(Path.of(&quot;ksnopass&quot;));
153         shouldNotExist(data, &quot;2&quot;); // no Mac
<a name="11" id="anc11"></a><span class="line-modified">154         checkAlg(data, &quot;110c010c01000&quot;, oid(KnownOIDs.PBEWithSHA1AndRC4_128));</span>
155         checkInt(data, &quot;110c010c010011&quot;, 50000);
<a name="12" id="anc12"></a><span class="line-modified">156         checkAlg(data, &quot;110c010c11000&quot;, oid(KnownOIDs.PBEWithSHA1AndDESede));</span>
157         checkInt(data, &quot;110c010c110011&quot;, 50000);
158         checkAlg(data, &quot;110c10&quot;, DATA_OID);
159         check(&quot;ksnopass&quot;, &quot;a&quot;, null, &quot;changeit&quot;, true, true, true);
160         check(&quot;ksnopass&quot;, &quot;b&quot;, null, &quot;changeit&quot;, true, true, true);
161 
162         keytool(&quot;-importkeystore -srckeystore ks -srcstorepass changeit &quot;
163                 + &quot;-destkeystore ksnewic -deststorepass changeit &quot;
164                 + &quot;-J-Dkeystore.pkcs12.macIterationCount=5555 &quot;
165                 + &quot;-J-Dkeystore.pkcs12.certPbeIterationCount=6666 &quot;
166                 + &quot;-J-Dkeystore.pkcs12.keyPbeIterationCount=7777&quot;);
167         data = Files.readAllBytes(Path.of(&quot;ksnewic&quot;));
168         checkInt(data, &quot;22&quot;, 5555); // Mac ic
<a name="13" id="anc13"></a><span class="line-modified">169         checkAlg(data, &quot;2000&quot;, oid(KnownOIDs.SHA_1)); // Mac alg</span>
<span class="line-modified">170         checkAlg(data, &quot;110c010c01000&quot;, oid(KnownOIDs.PBEWithSHA1AndDESede)); // key alg</span>
171         checkInt(data, &quot;110c010c010011&quot;, 7777); // key ic
<a name="14" id="anc14"></a><span class="line-modified">172         checkAlg(data, &quot;110c110110&quot;, oid(KnownOIDs.PBEWithSHA1AndRC2_40)); // cert alg</span>
173         checkInt(data, &quot;110c1101111&quot;, 6666); // cert ic
174 
175         // keypbe alg cannot be NONE
176         keytool(&quot;-keystore ksnewic -genkeypair -keyalg DSA &quot;
177                 + &quot;-storepass changeit -alias b -dname CN=B &quot;
178                 + &quot;-J-Dkeystore.pkcs12.keyProtectionAlgorithm=NONE&quot;)
179                 .shouldContain(&quot;NONE AlgorithmParameters not available&quot;)
180                 .shouldHaveExitValue(1);
181 
182         // new entry new keypbe alg (and default ic), else unchanged
183         keytool(&quot;-keystore ksnewic -genkeypair -keyalg DSA &quot;
184                 + &quot;-storepass changeit -alias b -dname CN=B &quot;
185                 + &quot;-J-Dkeystore.pkcs12.keyProtectionAlgorithm=PBEWithSHA1AndRC4_128&quot;);
186         data = Files.readAllBytes(Path.of(&quot;ksnewic&quot;));
187         checkInt(data, &quot;22&quot;, 5555); // Mac ic
<a name="15" id="anc15"></a><span class="line-modified">188         checkAlg(data, &quot;2000&quot;, oid(KnownOIDs.SHA_1)); // Mac alg</span>
<span class="line-modified">189         checkAlg(data, &quot;110c010c01000&quot;, oid(KnownOIDs.PBEWithSHA1AndDESede)); // key alg</span>
190         checkInt(data, &quot;110c010c010011&quot;, 7777); // key ic
<a name="16" id="anc16"></a><span class="line-modified">191         checkAlg(data, &quot;110c010c11000&quot;, oid(KnownOIDs.PBEWithSHA1AndRC4_128)); // new key alg</span>
192         checkInt(data, &quot;110c010c110011&quot;, 50000); // new key ic
<a name="17" id="anc17"></a><span class="line-modified">193         checkAlg(data, &quot;110c110110&quot;, oid(KnownOIDs.PBEWithSHA1AndRC2_40)); // cert alg</span>
194         checkInt(data, &quot;110c1101111&quot;, 6666); // cert ic
195 
196         // Check KeyStore loading multiple keystores
197         KeyStore ks = KeyStore.getInstance(&quot;pkcs12&quot;);
198         try (FileInputStream fis = new FileInputStream(&quot;ksnormal&quot;);
199                 FileOutputStream fos = new FileOutputStream(&quot;ksnormaldup&quot;)) {
200             ks.load(fis, &quot;changeit&quot;.toCharArray());
201             ks.store(fos, &quot;changeit&quot;.toCharArray());
202         }
203         data = Files.readAllBytes(Path.of(&quot;ksnormaldup&quot;));
204         checkInt(data, &quot;22&quot;, 100000); // Mac ic
<a name="18" id="anc18"></a><span class="line-modified">205         checkAlg(data, &quot;2000&quot;, oid(KnownOIDs.SHA_1)); // Mac alg</span>
<span class="line-modified">206         checkAlg(data, &quot;110c010c01000&quot;, oid(KnownOIDs.PBEWithSHA1AndDESede)); // key alg</span>
207         checkInt(data, &quot;110c010c010011&quot;, 50000); // key ic
<a name="19" id="anc19"></a><span class="line-modified">208         checkAlg(data, &quot;110c010c11000&quot;, oid(KnownOIDs.PBEWithSHA1AndDESede)); // new key alg</span>
209         checkInt(data, &quot;110c010c110011&quot;, 50000); // new key ic
210         checkAlg(data, &quot;110c10&quot;, ENCRYPTED_DATA_OID);
<a name="20" id="anc20"></a><span class="line-modified">211         checkAlg(data, &quot;110c110110&quot;, oid(KnownOIDs.PBEWithSHA1AndRC2_40)); // cert alg</span>
212         checkInt(data, &quot;110c1101111&quot;, 50000); // cert ic
213 
214         try (FileInputStream fis = new FileInputStream(&quot;ksnopass&quot;);
215              FileOutputStream fos = new FileOutputStream(&quot;ksnopassdup&quot;)) {
216             ks.load(fis, &quot;changeit&quot;.toCharArray());
217             ks.store(fos, &quot;changeit&quot;.toCharArray());
218         }
219         data = Files.readAllBytes(Path.of(&quot;ksnopassdup&quot;));
220         shouldNotExist(data, &quot;2&quot;); // no Mac
<a name="21" id="anc21"></a><span class="line-modified">221         checkAlg(data, &quot;110c010c01000&quot;, oid(KnownOIDs.PBEWithSHA1AndRC4_128));</span>
222         checkInt(data, &quot;110c010c010011&quot;, 50000);
<a name="22" id="anc22"></a><span class="line-modified">223         checkAlg(data, &quot;110c010c11000&quot;, oid(KnownOIDs.PBEWithSHA1AndDESede));</span>
224         checkInt(data, &quot;110c010c110011&quot;, 50000);
225         checkAlg(data, &quot;110c10&quot;, DATA_OID);
226 
227         try (FileInputStream fis = new FileInputStream(&quot;ksnewic&quot;);
228              FileOutputStream fos = new FileOutputStream(&quot;ksnewicdup&quot;)) {
229             ks.load(fis, &quot;changeit&quot;.toCharArray());
230             ks.store(fos, &quot;changeit&quot;.toCharArray());
231         }
232         data = Files.readAllBytes(Path.of(&quot;ksnewicdup&quot;));
233         checkInt(data, &quot;22&quot;, 5555); // Mac ic
<a name="23" id="anc23"></a><span class="line-modified">234         checkAlg(data, &quot;2000&quot;, oid(KnownOIDs.SHA_1)); // Mac alg</span>
<span class="line-modified">235         checkAlg(data, &quot;110c010c01000&quot;, oid(KnownOIDs.PBEWithSHA1AndDESede)); // key alg</span>
236         checkInt(data, &quot;110c010c010011&quot;, 7777); // key ic
<a name="24" id="anc24"></a><span class="line-modified">237         checkAlg(data, &quot;110c010c11000&quot;, oid(KnownOIDs.PBEWithSHA1AndRC4_128)); // new key alg</span>
238         checkInt(data, &quot;110c010c110011&quot;, 50000); // new key ic
<a name="25" id="anc25"></a><span class="line-modified">239         checkAlg(data, &quot;110c110110&quot;, oid(KnownOIDs.PBEWithSHA1AndRC2_40)); // cert alg</span>
240         checkInt(data, &quot;110c1101111&quot;, 6666); // cert ic
241 
242         // Check keytool behavior
243 
244         // ksnormal has password
245 
246         keytool(&quot;-list -keystore ksnormal&quot;)
247                 .shouldContain(&quot;WARNING WARNING WARNING&quot;)
248                 .shouldContain(&quot;Certificate chain length: 0&quot;);
249 
250         SecurityTools.setResponse(&quot;changeit&quot;);
251         keytool(&quot;-list -keystore ksnormal&quot;)
252                 .shouldNotContain(&quot;WARNING WARNING WARNING&quot;)
253                 .shouldContain(&quot;Certificate fingerprint&quot;);
254 
255         // ksnopass is password-less
256 
257         keytool(&quot;-list -keystore ksnopass&quot;)
258                 .shouldNotContain(&quot;WARNING WARNING WARNING&quot;)
259                 .shouldContain(&quot;Certificate fingerprint&quot;);
260 
261         // -certreq prompts for keypass
262         SecurityTools.setResponse(&quot;changeit&quot;);
263         keytool(&quot;-certreq -alias a -keystore ksnopass&quot;)
264                 .shouldContain(&quot;Enter key password for &lt;a&gt;&quot;)
265                 .shouldContain(&quot;-----BEGIN NEW CERTIFICATE REQUEST-----&quot;)
266                 .shouldHaveExitValue(0);
267 
268         // -certreq -storepass works fine
269         keytool(&quot;-certreq -alias a -keystore ksnopass -storepass changeit&quot;)
270                 .shouldNotContain(&quot;Enter key password for &lt;a&gt;&quot;)
271                 .shouldContain(&quot;-----BEGIN NEW CERTIFICATE REQUEST-----&quot;)
272                 .shouldHaveExitValue(0);
273 
274         // -certreq -keypass also works fine
275         keytool(&quot;-certreq -alias a -keystore ksnopass -keypass changeit&quot;)
276                 .shouldNotContain(&quot;Enter key password for &lt;a&gt;&quot;)
277                 .shouldContain(&quot;-----BEGIN NEW CERTIFICATE REQUEST-----&quot;)
278                 .shouldHaveExitValue(0);
279 
280         // -importkeystore prompts for srckeypass
281         SecurityTools.setResponse(&quot;changeit&quot;, &quot;changeit&quot;);
282         keytool(&quot;-importkeystore -srckeystore ksnopass &quot;
283                 + &quot;-destkeystore jks3 -deststorepass changeit&quot;)
284                 .shouldContain(&quot;Enter key password for &lt;a&gt;&quot;)
285                 .shouldContain(&quot;Enter key password for &lt;b&gt;&quot;)
286                 .shouldContain(&quot;2 entries successfully imported&quot;);
287 
288         // ksnopass2 is ksnopass + 2 cert entries
289 
290         ks = KeyStore.getInstance(new File(&quot;ksnopass&quot;), (char[])null);
291         ks.setCertificateEntry(&quot;aa&quot;, ks.getCertificate(&quot;a&quot;));
292         ks.setCertificateEntry(&quot;bb&quot;, ks.getCertificate(&quot;b&quot;));
293         try (FileOutputStream fos = new FileOutputStream(&quot;ksnopass2&quot;)) {
294             ks.store(fos, null);
295         }
296 
297         // -importkeystore prompts for srckeypass for private keys
298         // and no prompt for certs
299         SecurityTools.setResponse(&quot;changeit&quot;, &quot;changeit&quot;);
300         keytool(&quot;-importkeystore -srckeystore ksnopass2 &quot;
301                 + &quot;-destkeystore jks5 -deststorepass changeit&quot;)
302                 .shouldContain(&quot;Enter key password for &lt;a&gt;&quot;)
303                 .shouldContain(&quot;Enter key password for &lt;b&gt;&quot;)
304                 .shouldNotContain(&quot;Enter key password for &lt;aa&gt;&quot;)
305                 .shouldNotContain(&quot;Enter key password for &lt;bb&gt;&quot;)
306                 .shouldContain(&quot;4 entries successfully imported&quot;);
307 
308         // ksonlycert has only cert entries
309 
310         ks.deleteEntry(&quot;a&quot;);
311         ks.deleteEntry(&quot;b&quot;);
312         try (FileOutputStream fos = new FileOutputStream(&quot;ksonlycert&quot;)) {
313             ks.store(fos, null);
314         }
315 
316         // -importkeystore does not prompt at all
317         keytool(&quot;-importkeystore -srckeystore ksonlycert &quot;
318                 + &quot;-destkeystore jks6 -deststorepass changeit&quot;)
319                 .shouldNotContain(&quot;Enter key password for &lt;aa&gt;&quot;)
320                 .shouldNotContain(&quot;Enter key password for &lt;bb&gt;&quot;)
321                 .shouldContain(&quot;2 entries successfully imported&quot;);
322 
323         // create a new password-less keystore
324         keytool(&quot;-keystore ksnopass -exportcert -alias a -file a.cert -rfc&quot;);
325 
326         // Normally storepass is prompted for
327         keytool(&quot;-keystore kscert1 -importcert -alias a -file a.cert -noprompt&quot;)
328                 .shouldContain(&quot;Enter keystore password:&quot;);
329         keytool(&quot;-keystore kscert2 -importcert -alias a -file a.cert -noprompt &quot;
330                 + &quot;-J-Dkeystore.pkcs12.certProtectionAlgorithm=NONE&quot;)
331                 .shouldContain(&quot;Enter keystore password:&quot;);
332         keytool(&quot;-keystore kscert3 -importcert -alias a -file a.cert -noprompt &quot;
333                 + &quot;-J-Dkeystore.pkcs12.macAlgorithm=NONE&quot;)
334                 .shouldContain(&quot;Enter keystore password:&quot;);
335         // ... but not if it&#39;s password-less
336         keytool(&quot;-keystore kscert4 -importcert -alias a -file a.cert -noprompt &quot;
337                 + &quot;-J-Dkeystore.pkcs12.certProtectionAlgorithm=NONE &quot;
338                 + &quot;-J-Dkeystore.pkcs12.macAlgorithm=NONE&quot;)
339                 .shouldNotContain(&quot;Enter keystore password:&quot;);
340 
341         // still prompt for keypass for genkeypair and certreq
342         SecurityTools.setResponse(&quot;changeit&quot;, &quot;changeit&quot;);
343         keytool(&quot;-keystore ksnopassnew -genkeypair -keyalg DSA &quot;
344                 + &quot;-alias a -dname CN=A &quot;
345                 + &quot;-J-Dkeystore.pkcs12.certProtectionAlgorithm=NONE &quot;
346                 + &quot;-J-Dkeystore.pkcs12.macAlgorithm=NONE&quot;)
347                 .shouldNotContain(&quot;Enter keystore password:&quot;)
348                 .shouldContain(&quot;Enter key password for &lt;a&gt;&quot;);
349         keytool(&quot;-keystore ksnopassnew -certreq -alias a&quot;)
350                 .shouldNotContain(&quot;Enter keystore password:&quot;)
351                 .shouldContain(&quot;Enter key password for &lt;a&gt;&quot;);
352         keytool(&quot;-keystore ksnopassnew -list -v -alias a&quot;)
353                 .shouldNotContain(&quot;Enter keystore password:&quot;)
354                 .shouldNotContain(&quot;Enter key password for &lt;a&gt;&quot;);
355 
356         // params only read on demand
357 
358         // keyPbeIterationCount is used by -genkeypair
359         keytool(&quot;-keystore ksgenbadkeyic -genkeypair -keyalg DSA &quot;
360                 + &quot;-alias a -dname CN=A &quot;
361                 + &quot;-storepass changeit &quot;
362                 + &quot;-J-Dkeystore.pkcs12.keyPbeIterationCount=abc&quot;)
363                 .shouldContain(&quot;keyPbeIterationCount is not a number: abc&quot;)
364                 .shouldHaveExitValue(1);
365 
366         keytool(&quot;-keystore ksnopassnew -exportcert -alias a -file a.cert&quot;);
367 
368         // but not used by -importcert
369         keytool(&quot;-keystore ksimpbadkeyic -importcert -alias a -file a.cert &quot;
370                 + &quot;-noprompt -storepass changeit &quot;
371                 + &quot;-J-Dkeystore.pkcs12.keyPbeIterationCount=abc&quot;)
372                 .shouldHaveExitValue(0);
373 
374         // None is used by -list
375         keytool(&quot;-keystore ksnormal -storepass changeit -list &quot;
376                 + &quot;-J-Dkeystore.pkcs12.keyPbeIterationCount=abc &quot;
377                 + &quot;-J-Dkeystore.pkcs12.certPbeIterationCount=abc &quot;
378                 + &quot;-J-Dkeystore.pkcs12.macIterationCount=abc&quot;)
379                 .shouldHaveExitValue(0);
380     }
381 
382     /**
383      * Check keystore loading and key/cert reading.
384      *
385      * @param keystore the file name of keystore
386      * @param alias the key/cert to read
387      * @param storePass store pass to try out, can be null
388      * @param keypass key pass to try, can not be null
389      * @param expectedLoad expected result of keystore loading, true if non
390      *                     null, false if null, exception class if exception
391      * @param expectedCert expected result of cert reading
392      * @param expectedKey expected result of key reading
393      */
394     private static void check(
395             String keystore,
396             String alias,
397             String storePass,
398             String keypass,
399             Object expectedLoad,
400             Object expectedCert,
401             Object expectedKey) {
402         KeyStore ks = null;
403         Object actualLoad, actualCert, actualKey;
404         String label = keystore + &quot;-&quot; + alias + &quot;-&quot; + storePass + &quot;-&quot; + keypass;
405         try {
406             ks = KeyStore.getInstance(new File(keystore),
407                     storePass == null ? null : storePass.toCharArray());
408             actualLoad = ks != null;
409         } catch (Exception e) {
410             e.printStackTrace(System.out);
411             actualLoad = e.getClass();
412         }
413         Asserts.assertEQ(expectedLoad, actualLoad, label + &quot;-load&quot;);
414 
415         // If not loaded correctly, skip cert/key reading
416         if (!Objects.equals(actualLoad, true)) {
417             return;
418         }
419 
420         try {
421             actualCert = (ks.getCertificate(alias) != null);
422         } catch (Exception e) {
423             e.printStackTrace(System.out);
424             actualCert = e.getClass();
425         }
426         Asserts.assertEQ(expectedCert, actualCert, label + &quot;-cert&quot;);
427 
428         try {
429             actualKey = (ks.getKey(alias, keypass.toCharArray()) != null);
430         } catch (Exception e) {
431             e.printStackTrace(System.out);
432             actualKey = e.getClass();
433         }
434         Asserts.assertEQ(expectedKey, actualKey, label + &quot;-key&quot;);
435     }
436 
<a name="26" id="anc26"></a><span class="line-added">437     private static ObjectIdentifier oid(KnownOIDs o) {</span>
<span class="line-added">438         return ObjectIdentifier.of(o);</span>
<span class="line-added">439     }</span>
<span class="line-added">440 </span>
441     static OutputAnalyzer keytool(String s) throws Throwable {
442         return SecurityTools.keytool(s);
443     }
444 }
<a name="27" id="anc27"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="27" type="hidden" />
</body>
</html>