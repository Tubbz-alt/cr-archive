<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>New test/jdk/sun/security/tools/keytool/KeyToolTest.java</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
  </head>
  <body>
    <pre>
   1 /*
   2  * Copyright (c) 2005, 2020, Oracle and/or its affiliates. All rights reserved.
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.
   8  *
   9  * This code is distributed in the hope that it will be useful, but WITHOUT
  10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  */
  23 
  24 /*
  25  * @test
  26  * @bug 6251120 8231950 8242151
  27  * @summary Testing keytool
  28  *
  29  * Run through autotest.sh and manualtest.sh
  30  *
  31  * Testing non-PKCS11 keystores:
  32  *       echo | java -Dfile KeyToolTest
  33  *
  34  * Testing NSS PKCS11 keystores:
  35  *       # testing NSS
  36  *       # make sure the NSS db files are in current directory and writable
  37  *       echo | java -Dnss -Dnss.lib=/path/to/libsoftokn3.so KeyToolTest
  38  *
  39  * Testing Solaris Cryptography Framework PKCS11 keystores:
  40  *       # make sure you&#39;ve already run pktool and set test12 as pin
  41  *       echo | java -Dsolaris KeyToolTest
  42  *
  43  * ATTENTION:
  44  * Exception in thread &quot;main&quot; java.security.ProviderException:
  45  *   sun.security.pkcs11.wrapper.PKCS11Exception: CKR_KEY_SIZE_RANGE
  46  *       at sun.security.pkcs11.P11Signature.engineSign(P11Signature.java:420)
  47  *       ...
  48  * Caused by: sun.security.pkcs11.wrapper.PKCS11Exception: CKR_KEY_SIZE_RANGE
  49  *       at sun.security.pkcs11.wrapper.PKCS11.C_SignFinal(Native Method)
  50  *       at sun.security.pkcs11.P11Signature.engineSign(P11Signature.java:391)
  51  *       ...
  52  * been observed. Possibly a Solaris bug
  53  *
  54  * ATTENTION:
  55  * NSS PKCS11 config file are changed, DSA not supported now.
  56  *
  57  * @library /test/lib
  58  * @modules java.base/sun.security.tools.keytool
  59  *          java.base/sun.security.util
  60  *          java.base/sun.security.x509
  61  * @run main/othervm/timeout=600 -Dfile KeyToolTest
  62  */
  63 
  64 import java.nio.file.Files;
  65 import java.nio.file.Paths;
  66 import java.security.KeyStore;
  67 import sun.security.x509.*;
  68 import java.io.*;
  69 import java.security.KeyPairGenerator;
  70 import java.security.NoSuchAlgorithmException;
  71 import java.util.*;
  72 import java.security.cert.X509Certificate;
  73 import jdk.test.lib.util.FileUtils;
  74 import sun.security.util.ObjectIdentifier;
  75 
  76 
  77 public class KeyToolTest {
  78 
  79     // The stdout and stderr outputs after a keytool run
  80     String out;
  81     String err;
  82 
  83     // the output of println() in KeyTool.run
  84     String ex;
  85 
  86     String lastInput = &quot;&quot;, lastCommand = &quot;&quot;;
  87     private static final boolean debug =
  88         System.getProperty(&quot;debug&quot;) != null;
  89 
  90     static final String NSS_P11_ARG =
  91             &quot;-keystore NONE -storetype PKCS11 -providerName SunPKCS11-nss &quot; +
  92             &quot;-addprovider SunPKCS11 &quot; +
  93             &quot;-providerArg p11-nss.txt &quot;;
  94     // Use -providerClass here, to confirm it still works for SunPKCS11.
  95     static final String NSS_SRC_P11_ARG =
  96             &quot;-srckeystore NONE -srcstoretype PKCS11 &quot; +
  97             &quot;-srcproviderName SunPKCS11-nss &quot; +
  98             &quot;-providerClass sun.security.pkcs11.SunPKCS11 &quot; +
  99             &quot;-providerArg p11-nss.txt &quot;;
 100     static final String NZZ_P11_ARG =
 101             &quot;-keystore NONE -storetype PKCS11 -providerName SunPKCS11-nzz &quot; +
 102             &quot;-addprovider SunPKCS11 &quot; +
 103             &quot;-providerArg p11-nzz.txt &quot;;
 104     static final String NZZ_SRC_P11_ARG =
 105             &quot;-srckeystore NONE -srcstoretype PKCS11 &quot; +
 106             &quot;-srcproviderName SunPKCS11-nzz &quot; +
 107             &quot;-addprovider SunPKCS11 &quot; +
 108             &quot;-providerArg p11-nzz.txt &quot;;
 109     static final String SUN_P11_ARG = &quot;-keystore NONE -storetype PKCS11 &quot;;
 110     static final String SUN_SRC_P11_ARG =
 111             &quot;-srckeystore NONE -srcstoretype PKCS11 &quot;;
 112 
 113     String p11Arg, srcP11Arg;
 114 
 115     /** Creates a new instance of KeyToolTest */
 116     KeyToolTest() {
 117         // so that there is &quot;Warning&quot; and not translated into other language
 118         Locale.setDefault(Locale.US);
 119     }
 120 
 121     /**
 122      * Helper, removes a file
 123      */
 124     void remove(String filename) {
 125         if (debug) {
 126             System.err.println(&quot;Removing &quot; + filename);
 127         }
 128         try{
 129             FileUtils.deleteFileIfExistsWithRetry(Paths.get(filename));
 130         }catch(IOException e) {
 131             throw new RuntimeException(&quot;Error deleting &quot; + filename, e);
 132         }
 133     }
 134 
 135     /**
 136      * Run a set of keytool command with given terminal input.
 137      * @param input the terminal inputs, the characters typed by human
 138      *        if &lt;code&gt;cmd&lt;/code&gt; is running on a terminal
 139      * @param cmd the argument of a keytool command line
 140      * @throws if keytool goes wrong in some place
 141      */
 142     void test(String input, String cmd) throws Exception {
 143         lastInput = input;
 144         lastCommand = cmd;
 145 
 146         // &quot;X&quot; is appended so that we can precisely test how input is consumed
 147         HumanInputStream in = new HumanInputStream(input+&quot;X&quot;);
 148         test(in, cmd);
 149         // make sure the input string is no more no less
 150         if(in.read() != &#39;X&#39; || in.read() != -1)
 151             throw new Exception(&quot;Input not consumed exactly&quot;);
 152     }
 153 
 154     void test(InputStream in, String cmd) throws Exception {
 155 
 156         // save the original 3 streams
 157         if (debug) {
 158             System.err.println(cmd);
 159         } else {
 160             System.err.print(&quot;.&quot;);
 161         }
 162         PrintStream p1 = System.out;
 163         PrintStream p2 = System.err;
 164         InputStream i1 = System.in;
 165 
 166         ByteArrayOutputStream b1 = new ByteArrayOutputStream();
 167         ByteArrayOutputStream b2 = new ByteArrayOutputStream();
 168 
 169         try {
 170             System.setIn(in);
 171             System.setOut(new PrintStream(b1));
 172             System.setErr(new PrintStream(b2));
 173 
 174             // since System.in is overrided, the
 175             // sun.security.tools.keytool.Main.main() method will
 176             // never block at user input
 177 
 178             // use -debug so that main() will throw an Exception
 179             // instead of calling System.exit()
 180             sun.security.tools.keytool.Main.main((&quot;-debug &quot;+cmd).split(&quot;\\s+&quot;));
 181         } finally {
 182             out = b1.toString();
 183             err = b2.toString();
 184             ex = out;   // now it goes to System.out
 185             System.setIn(i1);
 186             System.setOut(p1);
 187             System.setErr(p2);
 188         }
 189     }
 190 
 191     /**
 192      * Call this method if you expect test(input, cmd) should go OK
 193      */
 194     void testOK(String input, String cmd) throws Exception {
 195         try {
 196             // Workaround for &quot;8057810: Make SHA256withDSA the default
 197             // jarsigner and keytool algorithm for DSA keys&quot;. Unfortunately
 198             // SunPKCS11-NSS does not support SHA256withDSA yet.
 199             if (cmd.contains(&quot;p11-nss.txt&quot;) &amp;&amp; cmd.contains(&quot;-genkey&quot;)
 200                     &amp;&amp; cmd.contains(&quot;DSA&quot;)) {
 201                 cmd += &quot; -sigalg SHA1withDSA -keysize 1024&quot;;
 202             }
 203             test(input, cmd);
 204         } catch(Exception e) {
 205             afterFail(input, cmd, &quot;OK&quot;);
 206             throw e;
 207         }
 208     }
 209 
 210     /**
 211      * Call this method if you expect test(input, cmd) should fail and throw
 212      * an exception
 213      */
 214     void testFail(String input, String cmd) throws Exception {
 215         boolean ok;
 216         try {
 217             test(input, cmd);
 218             ok = true;
 219         } catch(Exception e) {
 220             if (e instanceof MissingResourceException) {
 221                 ok = true;
 222             } else {
 223                 ok = false;
 224             }
 225         }
 226         if(ok) {
 227             afterFail(input, cmd, &quot;FAIL&quot;);
 228             throw new RuntimeException();
 229         }
 230     }
 231 
 232     /**
 233      * Call this method if you expect test(input, cmd) should go OK
 234      */
 235     void testOK(InputStream is, String cmd) throws Exception {
 236         try {
 237             test(is, cmd);
 238         } catch(Exception e) {
 239             afterFail(&quot;&quot;, cmd, &quot;OK&quot;);
 240             throw e;
 241         }
 242     }
 243 
 244     /**
 245      * Call this method if you expect test(input, cmd) should fail and throw
 246      * an exception
 247      */
 248     void testFail(InputStream is, String cmd) throws Exception {
 249         boolean ok;
 250         try {
 251             test(is, cmd);
 252             ok = true;
 253         } catch(Exception e) {
 254             ok = false;
 255         }
 256         if(ok) {
 257             afterFail(&quot;&quot;, cmd, &quot;FAIL&quot;);
 258             throw new RuntimeException();
 259         }
 260     }
 261 
 262     /**
 263      * Call this method if you just want to run the command and does
 264      * not care if it succeeds or fails.
 265      */
 266     void testAnyway(String input, String cmd) {
 267         try {
 268             test(input, cmd);
 269         } catch(Exception e) {
 270             ;
 271         }
 272     }
 273 
 274     /**
 275      * Helper method, print some output after a test does not do as expected
 276      */
 277     void afterFail(String input, String cmd, String should) {
 278         if (cmd.contains(&quot;p11-nss.txt&quot;)) {
 279             cmd = &quot;-J-Dnss.lib=&quot; + System.getProperty(&quot;nss.lib&quot;) + &quot; &quot; + cmd;
 280         }
 281         System.err.println(&quot;\nTest fails for the command ---\n&quot; +
 282                 &quot;keytool &quot; + cmd + &quot;\nOr its debug version ---\n&quot; +
 283                 &quot;keytool -debug &quot; + cmd);
 284 
 285         System.err.println(&quot;The command result should be &quot; + should +
 286                 &quot;, but it&#39;s not. Try run the command manually and type&quot; +
 287                 &quot; these input into it: &quot;);
 288         char[] inputChars = input.toCharArray();
 289 
 290         for (int i=0; i&lt;inputChars.length; i++) {
 291             char ch = inputChars[i];
 292             if (ch == &#39;\n&#39;) System.err.print(&quot;ENTER &quot;);
 293             else if (ch == &#39; &#39;) System.err.print(&quot;SPACE &quot;);
 294             else System.err.print(ch + &quot; &quot;);
 295         }
 296         System.err.println(&quot;&quot;);
 297 
 298         System.err.println(&quot;ERR is:\n&quot;+err);
 299         System.err.println(&quot;OUT is:\n&quot;+out);
 300     }
 301 
 302     void assertTrue(boolean bool, String msg) {
 303         if (debug) {
 304             System.err.println(&quot;If not &quot; + bool + &quot;, &quot; + msg);
 305         } else {
 306             System.err.print(&quot;v&quot;);
 307         }
 308         if(!bool) {
 309             afterFail(lastInput, lastCommand, &quot;TRUE&quot;);
 310                 System.err.println(msg);
 311             throw new RuntimeException(msg);
 312         }
 313     }
 314 
 315     void assertTrue(boolean bool) {
 316         assertTrue(bool, &quot;well...&quot;);
 317     }
 318     /**
 319      * Helper method, load a keystore
 320      * @param file file for keystore, null or &quot;NONE&quot; for PKCS11
 321      * @pass password for the keystore
 322      * @type keystore type
 323      * @returns the KeyStore object
 324      * @exception Exception if anything goes wrong
 325      */
 326     KeyStore loadStore(String file, String pass, String type) throws Exception {
 327         KeyStore ks = KeyStore.getInstance(type);
 328         FileInputStream is = null;
 329         if (file != null &amp;&amp; !file.equals(&quot;NONE&quot;)) {
 330             is = new FileInputStream(file);
 331         }
 332         ks.load(is, pass.toCharArray());
 333         is.close();
 334         return ks;
 335     }
 336 
 337     /**
 338      * The test suite.
 339      * Maybe it&#39;s better to put this outside the KeyToolTest class
 340      */
 341     void testAll() throws Exception {
 342         KeyStore ks;
 343 
 344         remove(&quot;x.jks&quot;);
 345         remove(&quot;x.jceks&quot;);
 346         remove(&quot;x.p12&quot;);
 347         remove(&quot;x2.jceks&quot;);
 348         remove(&quot;x2.jks&quot;);
 349         remove(&quot;x.jks.p1.cert&quot;);
 350 
 351         // name changes: genkeypair, importcert, exportcert
 352         remove(&quot;x.jks&quot;);
 353         remove(&quot;x.jks.p1.cert&quot;);
 354         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 355                 &quot;-keypass changeit -genkeypair -keyalg DSA -alias p1 -dname CN=olala&quot;);
 356         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 357                 &quot;-exportcert -alias p1 -file x.jks.p1.cert&quot;);
 358         ks = loadStore(&quot;x.jks&quot;, &quot;changeit&quot;, &quot;JKS&quot;);
 359         assertTrue(ks.getKey(&quot;p1&quot;, &quot;changeit&quot;.toCharArray()) != null,
 360             &quot;key not DSA&quot;);
 361         assertTrue(new File(&quot;x.jks.p1.cert&quot;).exists(), &quot;p1 export err&quot;);
 362         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 363                 &quot;-delete -alias p1&quot;);
 364         // importcert, prompt for Yes/No
 365         testOK(&quot;y\n&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 366                 &quot;-importcert -alias c1 -file x.jks.p1.cert&quot;);
 367         // importcert, -noprompt
 368         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 369                 &quot;-importcert -alias c2 -file x.jks.p1.cert -noprompt&quot;);
 370         ks = loadStore(&quot;x.jks&quot;, &quot;changeit&quot;, &quot;JKS&quot;);
 371         assertTrue(ks.getCertificate(&quot;c1&quot;) != null, &quot;import c1 err&quot;);
 372 
 373         // v3
 374         byte[] encoded = ks.getCertificate(&quot;c1&quot;).getEncoded();
 375         X509CertImpl certImpl = new X509CertImpl(encoded);
 376         assertTrue(certImpl.getVersion() == 3, &quot;Version is not 3&quot;);
 377 
 378         // changealias and keyclone
 379         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 380                 &quot;-keypass changeit -genkeypair -keyalg DSA -alias p1 -dname CN=olala&quot;);
 381         testOK(&quot;changeit\n&quot;, &quot;-keystore x.jks -storetype JKS &quot; +
 382                 &quot;-changealias -alias p1 -destalias p11&quot;);
 383         testOK(&quot;changeit\n&quot;, &quot;-keystore x.jks -storetype JKS &quot; +
 384                 &quot;-changealias -alias c1 -destalias c11&quot;);
 385         // press ENTER when prompt for p111&#39;s keypass
 386         testOK(&quot;changeit\n\n&quot;, &quot;-keystore x.jks -storetype JKS &quot; +
 387                 &quot;-keyclone -alias p11 -destalias p111&quot;);
 388         ks = loadStore(&quot;x.jks&quot;, &quot;changeit&quot;, &quot;JKS&quot;);
 389         assertTrue(!ks.containsAlias(&quot;p1&quot;), &quot;there is no p1&quot;);
 390         assertTrue(!ks.containsAlias(&quot;c1&quot;), &quot;there is no c1&quot;);
 391         assertTrue(ks.containsAlias(&quot;p11&quot;), &quot;there is p11&quot;);
 392         assertTrue(ks.containsAlias(&quot;c11&quot;), &quot;there is c11&quot;);
 393         assertTrue(ks.containsAlias(&quot;p111&quot;), &quot;there is p111&quot;);
 394 
 395         // genSecKey
 396         remove(&quot;x.jceks&quot;);
 397         // DES, no need keysize
 398         testOK(&quot;changeit\nchangeit\n\n&quot;, &quot;-keystore x.jceks -storetype JCEKS &quot; +
 399                 &quot;-genseckey -keyalg DES -alias s1&quot;);
 400         // DES, keysize cannot be 128
 401         testFail(&quot;changeit\n\n&quot;, &quot;-keystore x.jceks -storetype JCEKS &quot; +
 402                 &quot;-genseckey -keyalg DES -alias s11 -keysize 128&quot;);
 403         // DESede. no need keysize
 404         testOK(&quot;changeit\n\n&quot;, &quot;-keystore x.jceks -storetype JCEKS &quot; +
 405                 &quot;-genseckey -keyalg DESede -alias s2&quot;);
 406         // AES, need keysize
 407         testFail(&quot;changeit\n\n&quot;, &quot;-keystore x.jceks -storetype AES &quot; +
 408                 &quot;-genseckey -keyalg Rijndael -alias s3&quot;);
 409         testOK(&quot;changeit\n\n&quot;, &quot;-keystore x.jceks -storetype JCEKS &quot; +
 410                 &quot;-genseckey -keyalg AES -alias s3 -keysize 128&quot;);
 411         // about keypass
 412         // can accept storepass
 413         testOK(&quot;\n&quot;, &quot;-keystore x.jceks -storetype JCEKS -storepass changeit &quot; +
 414                 &quot;-genseckey -keyalg DES -alias s4&quot;);
 415         // or a new one
 416         testOK(&quot;keypass\nkeypass\n&quot;, &quot;-keystore x.jceks -storetype JCEKS &quot; +
 417                 &quot;-storepass changeit -genseckey -keyalg DES -alias s5&quot;);
 418         // keypass must be valid (prompt 3 times)
 419         testOK(&quot;bad\n\bad\nkeypass\nkeypass\n&quot;, &quot;-keystore x.jceks &quot; +
 420                 &quot;-storetype JCEKS -storepass changeit -genseckey &quot; +
 421                 &quot;-keyalg DES -alias s6&quot;);
 422         // keypass must be valid (prompt 3 times)
 423         testFail(&quot;bad\n\bad\nbad\n&quot;, &quot;-keystore x.jceks -storetype JCEKS &quot; +
 424                 &quot;-storepass changeit -genseckey -keyalg DES -alias s7&quot;);
 425         // keypass must be valid (prompt 3 times)
 426         testFail(&quot;bad\n\bad\nbad\nkeypass\n&quot;, &quot;-keystore x.jceks &quot; +
 427                 &quot;-storetype JCEKS -storepass changeit -genseckey -keyalg DES -alias s7&quot;);
 428         ks = loadStore(&quot;x.jceks&quot;, &quot;changeit&quot;, &quot;JCEKS&quot;);
 429         assertTrue(ks.getKey(&quot;s1&quot;, &quot;changeit&quot;.toCharArray())
 430                 .getAlgorithm().equalsIgnoreCase(&quot;DES&quot;), &quot;s1 is DES&quot;);
 431         assertTrue(ks.getKey(&quot;s1&quot;, &quot;changeit&quot;.toCharArray())
 432                 .getEncoded().length == 8,  &quot;DES is 56&quot;);
 433         assertTrue(ks.getKey(&quot;s2&quot;, &quot;changeit&quot;.toCharArray())
 434                 .getEncoded().length == 24,  &quot;DESede is 168&quot;);
 435         assertTrue(ks.getKey(&quot;s2&quot;, &quot;changeit&quot;.toCharArray())
 436                 .getAlgorithm().equalsIgnoreCase(&quot;DESede&quot;), &quot;s2 is DESede&quot;);
 437         assertTrue(ks.getKey(&quot;s3&quot;, &quot;changeit&quot;.toCharArray())
 438                 .getAlgorithm().equalsIgnoreCase(&quot;AES&quot;), &quot;s3 is AES&quot;);
 439         assertTrue(ks.getKey(&quot;s4&quot;, &quot;changeit&quot;.toCharArray())
 440                 .getAlgorithm().equalsIgnoreCase(&quot;DES&quot;), &quot;s4 is DES&quot;);
 441         assertTrue(ks.getKey(&quot;s5&quot;, &quot;keypass&quot;.toCharArray())
 442                 .getAlgorithm().equalsIgnoreCase(&quot;DES&quot;), &quot;s5 is DES&quot;);
 443         assertTrue(ks.getKey(&quot;s6&quot;, &quot;keypass&quot;.toCharArray())
 444                 .getAlgorithm().equalsIgnoreCase(&quot;DES&quot;), &quot;s6 is DES&quot;);
 445         assertTrue(!ks.containsAlias(&quot;s7&quot;), &quot;s7 not created&quot;);
 446 
 447         // maybe we needn&#39;t test this, one day JKS will support SecretKey
 448         //testFail(&quot;changeit\nchangeit\n&quot;, &quot;-keystore x.jks -storetype JKS &quot; +
 449         //        &quot;-genseckey -keyalg AES -alias s3 -keysize 128&quot;);
 450 
 451         // importKeyStore
 452         remove(&quot;x.jks&quot;);
 453         remove(&quot;x.jceks&quot;);
 454         // create 2 entries...
 455         testOK(&quot;changeit\nchangeit\n\n&quot;, &quot;-keystore x.jceks -storetype JCEKS &quot; +
 456                 &quot;-genkeypair -keyalg DSA -alias p1 -dname CN=Olala&quot;);
 457         testOK(&quot;&quot;, &quot;-keystore x.jceks -storetype JCEKS -storepass changeit &quot; +
 458                 &quot;-importcert -alias c1 -file x.jks.p1.cert -noprompt&quot;);
 459         ks = loadStore(&quot;x.jceks&quot;, &quot;changeit&quot;, &quot;JCEKS&quot;);
 460         assertTrue(ks.size() == 2, &quot;2 entries in JCEKS&quot;);
 461         // import, shouldn&#39;t mention destalias/srckeypass/destkeypass
 462         // if srcalias is no given
 463         testFail(&quot;changeit\nchangeit\n&quot;, &quot;-importkeystore &quot; +
 464                 &quot;-srckeystore x.jceks -srcstoretype JCEKS &quot; +
 465                 &quot;-destkeystore x.jks -deststoretype JKS -destalias pp&quot;);
 466         testFail(&quot;changeit\nchangeit\n&quot;, &quot;-importkeystore &quot; +
 467                 &quot;-srckeystore x.jceks -srcstoretype JCEKS &quot; +
 468                 &quot;-destkeystore x.jks -deststoretype JKS -srckeypass changeit&quot;);
 469         testFail(&quot;changeit\nchangeit\n&quot;, &quot;-importkeystore &quot; +
 470                 &quot;-srckeystore x.jceks -srcstoretype JCEKS &quot; +
 471                 &quot;-destkeystore x.jks -deststoretype JKS -destkeypass changeit&quot;);
 472         // normal import
 473         testOK(&quot;changeit\nchangeit\nchangeit\n&quot;, &quot;-importkeystore &quot; +
 474                 &quot;-srckeystore x.jceks -srcstoretype JCEKS &quot; +
 475                 &quot;-destkeystore x.jks -deststoretype JKS&quot;);
 476         ks = loadStore(&quot;x.jks&quot;, &quot;changeit&quot;, &quot;JKS&quot;);
 477         assertTrue(ks.size() == 2, &quot;2 entries in JKS&quot;);
 478         // import again, type yes to overwrite old entries
 479         testOK(&quot;changeit\nchangeit\ny\ny\n&quot;, &quot;-importkeystore &quot; +
 480                 &quot;-srckeystore x.jceks -srcstoretype JCEKS &quot; +
 481                 &quot;-destkeystore x.jks -deststoretype JKS&quot;);
 482         ks = loadStore(&quot;x.jks&quot;, &quot;changeit&quot;, &quot;JKS&quot;);
 483         // import again, specify -nopromt
 484         testOK(&quot;changeit\nchangeit\n&quot;, &quot;-importkeystore &quot; +
 485                 &quot;-srckeystore x.jceks -srcstoretype JCEKS &quot; +
 486                 &quot;-destkeystore x.jks -deststoretype JKS -noprompt&quot;);
 487         assertTrue(err.indexOf(&quot;Warning&quot;) != -1, &quot;noprompt will warn&quot;);
 488         ks = loadStore(&quot;x.jks&quot;, &quot;changeit&quot;, &quot;JKS&quot;);
 489         assertTrue(ks.size() == 2, &quot;2 entries in JKS&quot;);
 490         // import again, type into new aliases when prompted
 491         testOK(&quot;changeit\nchangeit\n\ns1\n\ns2\n&quot;, &quot;-importkeystore &quot; +
 492                 &quot;-srckeystore x.jceks -srcstoretype JCEKS &quot; +
 493                 &quot;-destkeystore x.jks -deststoretype JKS&quot;);
 494         ks = loadStore(&quot;x.jks&quot;, &quot;changeit&quot;, &quot;JKS&quot;);
 495         assertTrue(ks.size() == 4, &quot;4 entries in JKS&quot;);
 496 
 497         // importkeystore single
 498         // normal
 499         remove(&quot;x.jks&quot;);
 500         testOK(&quot;changeit\nchangeit\nchangeit\n&quot;, &quot;-importkeystore &quot; +
 501                 &quot;-srckeystore x.jceks -srcstoretype JCEKS &quot; +
 502                 &quot;-destkeystore x.jks -deststoretype JKS -srcalias p1&quot;);
 503         ks = loadStore(&quot;x.jks&quot;, &quot;changeit&quot;, &quot;JKS&quot;);
 504         assertTrue(ks.size() == 1, &quot;1 entries in JKS&quot;);
 505         // overwrite
 506         testOK(&quot;changeit\nchangeit\ny\n&quot;, &quot;-importkeystore &quot; +
 507                 &quot;-srckeystore x.jceks -srcstoretype JCEKS &quot; +
 508                 &quot;-destkeystore x.jks -deststoretype JKS -srcalias p1&quot;);
 509         ks = loadStore(&quot;x.jks&quot;, &quot;changeit&quot;, &quot;JKS&quot;);
 510         assertTrue(ks.size() == 1, &quot;1 entries in JKS&quot;);
 511         // noprompt
 512         testOK(&quot;changeit\nchangeit\n&quot;, &quot;-importkeystore &quot; +
 513                 &quot;-srckeystore x.jceks -srcstoretype JCEKS &quot; +
 514                 &quot;-destkeystore x.jks -deststoretype JKS &quot; +
 515                 &quot;-srcalias p1 -noprompt&quot;);
 516         ks = loadStore(&quot;x.jks&quot;, &quot;changeit&quot;, &quot;JKS&quot;);
 517         assertTrue(ks.size() == 1, &quot;1 entries in JKS&quot;);
 518         // rename
 519         testOK(&quot;changeit\nchangeit\n&quot;, &quot;-importkeystore &quot; +
 520                 &quot;-srckeystore x.jceks -srcstoretype JCEKS &quot; +
 521                 &quot;-destkeystore x.jks -deststoretype JKS &quot; +
 522                 &quot;-srcalias p1 -destalias p2&quot;);
 523         ks = loadStore(&quot;x.jks&quot;, &quot;changeit&quot;, &quot;JKS&quot;);
 524         assertTrue(ks.size() == 2, &quot;2 entries in JKS&quot;);
 525         // another rename
 526         testOK(&quot;changeit\nchangeit\n\nnewalias\n&quot;, &quot;-importkeystore &quot; +
 527                 &quot;-srckeystore x.jceks -srcstoretype JCEKS &quot; +
 528                 &quot;-destkeystore x.jks -deststoretype JKS -srcalias p1&quot;);
 529         ks = loadStore(&quot;x.jks&quot;, &quot;changeit&quot;, &quot;JKS&quot;);
 530         assertTrue(ks.size() == 3, &quot;3 entries in JKS&quot;);
 531 
 532         // importkeystore single, different keypass
 533         remove(&quot;x.jks&quot;);
 534         // generate entry with different keypass
 535         testOK(&quot;changeit\nkeypass\nkeypass\n&quot;, &quot;-keystore x.jceks &quot; +
 536                 &quot;-storetype JCEKS -genkeypair -keyalg DSA -alias p2 -dname CN=Olala&quot;);
 537         // prompt
 538         testOK(&quot;changeit\nchangeit\nchangeit\nkeypass\n&quot;, &quot;-importkeystore &quot; +
 539                 &quot;-srckeystore x.jceks -srcstoretype JCEKS &quot; +
 540                 &quot;-destkeystore x.jks -deststoretype JKS -srcalias p2&quot;);
 541         ks = loadStore(&quot;x.jks&quot;, &quot;changeit&quot;, &quot;JKS&quot;);
 542         assertTrue(ks.size() == 1, &quot;1 entries in JKS&quot;);
 543         // diff destkeypass
 544         testOK(&quot;changeit\nchangeit\nkeypass\n&quot;, &quot;-importkeystore &quot; +
 545                 &quot;-srckeystore x.jceks -srcstoretype JCEKS &quot; +
 546                 &quot;-destkeystore x.jks -deststoretype JKS &quot; +
 547                 &quot;-srcalias p2 -destalias p3 -destkeypass keypass2&quot;);
 548         ks = loadStore(&quot;x.jks&quot;, &quot;changeit&quot;, &quot;JKS&quot;);
 549         assertTrue(ks.size() == 2, &quot;2 entries in JKS&quot;);
 550         assertTrue(ks.getKey(&quot;p2&quot;, &quot;keypass&quot;.toCharArray()) != null,
 551                 &quot;p2 has old password&quot;);
 552         assertTrue(ks.getKey(&quot;p3&quot;, &quot;keypass2&quot;.toCharArray()) != null,
 553                 &quot;p3 has new password&quot;);
 554 
 555         // importkeystore single, cert
 556         remove(&quot;x.jks&quot;);
 557         // normal
 558         testOK(&quot;changeit\nchangeit\nchangeit\n&quot;, &quot;-importkeystore &quot; +
 559                 &quot;-srckeystore x.jceks -srcstoretype JCEKS &quot; +
 560                 &quot;-destkeystore x.jks -deststoretype JKS -srcalias c1&quot;);
 561         // in fact srcstorepass can be ignored
 562         testOK(&quot;changeit\n\n&quot;, &quot;-importkeystore &quot; +
 563                 &quot;-srckeystore x.jceks -srcstoretype JCEKS &quot; +
 564                 &quot;-destkeystore x.jks -deststoretype JKS &quot; +
 565                 &quot;-srcalias c1 -destalias c2&quot;);
 566         assertTrue(err.indexOf(&quot;WARNING&quot;) != -1, &quot;But will warn&quot;);
 567         // 2nd import, press y to overwrite ...
 568         testOK(&quot;changeit\n\ny\n&quot;, &quot;-importkeystore &quot; +
 569                 &quot;-srckeystore x.jceks -srcstoretype JCEKS &quot; +
 570                 &quot;-destkeystore x.jks -deststoretype JKS &quot; +
 571                 &quot;-srcalias c1 -destalias c2&quot;);
 572         // ... or rename
 573         testOK(&quot;changeit\n\n\nc3\n&quot;, &quot;-importkeystore &quot; +
 574                 &quot;-srckeystore x.jceks -srcstoretype JCEKS &quot; +
 575                 &quot;-destkeystore x.jks -deststoretype JKS &quot; +
 576                 &quot;-srcalias c1 -destalias c2&quot;);
 577         ks = loadStore(&quot;x.jks&quot;, &quot;changeit&quot;, &quot;JKS&quot;);
 578         // c1, c2, c3
 579         assertTrue(ks.size() == 3, &quot;3 entries in JKS&quot;);
 580 
 581         // importkeystore, secretkey
 582         remove(&quot;x.jks&quot;);
 583         // create SecretKeyEntry
 584         testOK(&quot;changeit\n\n&quot;, &quot;-keystore x.jceks -storetype JCEKS &quot; +
 585                 &quot;-genseckey -keyalg DES -alias s1&quot;);
 586         // create SecretKeyEntry
 587         testOK(&quot;changeit\n\n&quot;, &quot;-keystore x.jceks -storetype JCEKS &quot; +
 588                 &quot;-genseckey -keyalg DES -alias s2&quot;);
 589         // remove the keypass!=storepass one
 590         testOK(&quot;changeit\n&quot;, &quot;-keystore x.jceks -storetype JCEKS &quot; +
 591                 &quot;-delete -alias p2&quot;);
 592         ks = loadStore(&quot;x.jceks&quot;, &quot;changeit&quot;, &quot;JCEKS&quot;);
 593         // p1, c1, s1, s2
 594         assertTrue(ks.size() == 4, &quot;4 entries in JCEKS&quot;);
 595         // normal
 596         testOK(&quot;changeit\nchangeit\nchangeit\n&quot;, &quot;-importkeystore &quot; +
 597                 &quot;-srckeystore x.jceks -srcstoretype JCEKS &quot; +
 598                 &quot;-destkeystore x.jks -deststoretype JKS -srcalias s1&quot;);
 599         assertTrue(err.indexOf(&quot;not imported&quot;) != -1, &quot;Not imported&quot;);
 600         assertTrue(err.indexOf(&quot;Cannot store non-PrivateKeys&quot;) != -1,
 601                 &quot;Not imported&quot;);
 602 
 603         // Importing a JCEKS keystore to a JKS one. Will warn
 604         // for the 2 SecretKey entries
 605 
 606         remove(&quot;x.jks&quot;);
 607         // Two &quot;no&quot; answers to bypass warnings
 608         // normal
 609         testOK(&quot;\n\n&quot;, &quot;-srcstorepass changeit -deststorepass changeit &quot; +
 610                 &quot;-importkeystore -srckeystore x.jceks -srcstoretype JCEKS &quot; +
 611                 &quot;-destkeystore x.jks -deststoretype JKS&quot;);
 612         assertTrue(err.indexOf(&quot;s1 not&quot;) != -1, &quot;s1 not&quot;);
 613         assertTrue(err.indexOf(&quot;s2 not&quot;) != -1, &quot;s2 not&quot;);
 614         assertTrue(err.indexOf(&quot;c1 success&quot;) != -1, &quot;c1 success&quot;);
 615         assertTrue(err.indexOf(&quot;p1 success&quot;) != -1, &quot;p1 success&quot;);
 616         remove(&quot;x.jks&quot;);
 617         // One &quot;yes&quot; to stop
 618         // normal
 619         testOK(&quot;yes\n&quot;, &quot;-srcstorepass changeit -deststorepass changeit &quot; +
 620                 &quot;-importkeystore -srckeystore x.jceks -srcstoretype JCEKS &quot; +
 621                 &quot;-destkeystore x.jks -deststoretype JKS&quot;);
 622         // maybe c1 or p1 has been imported before s1 or s2 is touched,
 623         // anyway we know yesNo is only asked once.
 624 
 625         // pkcs12
 626         remove(&quot;x.jks&quot;);
 627         // JKS prompt for keypass
 628         testFail(&quot;changeit\nchangeit\n&quot;, &quot;-keystore x.jks -storetype JKS &quot; +
 629                 &quot;-genkeypair -alias p1 -dname CN=olala&quot;);
 630         remove(&quot;x.jks&quot;);
 631         // just type ENTER means keypass=storepass
 632         testOK(&quot;changeit\nchangeit\n\n&quot;, &quot;-keystore x.jks -storetype JKS &quot; +
 633                 &quot;-genkeypair -keyalg DSA -alias p1 -dname CN=olala&quot;);
 634         remove(&quot;x.p12&quot;);
 635         // PKCS12 only need storepass
 636         testOK(&quot;&quot;, &quot;-keystore x.p12 -storetype PKCS12 -storepass changeit &quot; +
 637                 &quot;-genkeypair -keyalg DSA -alias p0 -dname CN=olala&quot;);
 638         testOK(&quot;changeit\n&quot;, &quot;-keystore x.p12 -storetype PKCS12 &quot; +
 639                 &quot;-genkeypair -keyalg DSA -alias p1 -dname CN=olala&quot;);
 640         // when specify keypass, make sure keypass==storepass...
 641         testOK(&quot;changeit\n&quot;, &quot;-keystore x.p12 -keypass changeit &quot; +
 642                 &quot;-storetype PKCS12 -genkeypair -keyalg DSA -alias p3 -dname CN=olala&quot;);
 643         assertTrue(err.indexOf(&quot;Warning&quot;) == -1,
 644                 &quot;PKCS12 silent when keypass == storepass&quot;);
 645         // otherwise, print a warning
 646         testOK(&quot;changeit\n&quot;, &quot;-keystore x.p12 -keypass another&quot; +
 647                 &quot; -storetype PKCS12 -genkeypair -keyalg DSA -alias p2 -dname CN=olala&quot;);
 648         assertTrue(err.indexOf(&quot;Warning&quot;) != -1,
 649                 &quot;PKCS12 warning when keypass != storepass&quot;);
 650         // no -keypasswd for PKCS12
 651         testFail(&quot;&quot;, &quot;-keystore x.p12 -storepass changeit -storetype PKCS12&quot; +
 652                 &quot; -keypasswd -new changeit -alias p3&quot;);
 653         testOK(&quot;&quot;, &quot;-keystore x.p12 -storepass changeit -storetype PKCS12 &quot; +
 654                 &quot;-changealias -alias p3 -destalias p33&quot;);
 655         testOK(&quot;&quot;, &quot;-keystore x.p12 -storepass changeit -storetype PKCS12 &quot; +
 656                 &quot;-keyclone -alias p33 -destalias p3&quot;);
 657 
 658         // pkcs12
 659         remove(&quot;x.p12&quot;);
 660         // PKCS12 only need storepass
 661         testOK(&quot;&quot;, &quot;-keystore x.p12 -storetype PKCS12 -storepass changeit &quot; +
 662                 &quot;-genkeypair -keyalg DSA -alias p0 -dname CN=olala&quot;);
 663         testOK(&quot;&quot;, &quot;-storepass changeit -keystore x.p12 -storetype PKCS12 &quot; +
 664                 &quot;-genkeypair -keyalg DSA -alias p1 -dname CN=olala&quot;);
 665         // when specify keypass, make sure keypass==storepass...
 666         testOK(&quot;&quot;, &quot;-storepass changeit -keystore x.p12 -keypass changeit &quot; +
 667                 &quot;-storetype PKCS12 -genkeypair -keyalg DSA -alias p3 -dname CN=olala&quot;);
 668         assertTrue(err.indexOf(&quot;Warning&quot;) == -1,
 669                 &quot;PKCS12 silent when keypass == storepass&quot;);
 670         // otherwise, print a warning
 671         testOK(&quot;&quot;, &quot;-storepass changeit -keystore x.p12 -keypass another &quot; +
 672                 &quot;-storetype PKCS12 -genkeypair -keyalg DSA -alias p2 -dname CN=olala&quot;);
 673         assertTrue(err.indexOf(&quot;Warning&quot;) != -1,
 674                 &quot;PKCS12 warning when keypass != storepass&quot;);
 675 
 676         remove(&quot;x.jks&quot;);
 677         remove(&quot;x.jceks&quot;);
 678         remove(&quot;x.p12&quot;);
 679         remove(&quot;x2.jceks&quot;);
 680         remove(&quot;x2.jks&quot;);
 681         remove(&quot;x.jks.p1.cert&quot;);
 682     }
 683 
 684     void testPKCS11() throws Exception {
 685         KeyStore ks;
 686         // pkcs11, the password maybe different and maybe PKCS11 not supported
 687 
 688         // in case last test is not executed successfully
 689         testAnyway(&quot;&quot;, p11Arg + &quot;-storepass test12 -delete -alias p1&quot;);
 690         testAnyway(&quot;&quot;, p11Arg + &quot;-storepass test12 -delete -alias p2&quot;);
 691         testAnyway(&quot;&quot;, p11Arg + &quot;-storepass test12 -delete -alias p3&quot;);
 692         testAnyway(&quot;&quot;, p11Arg + &quot;-storepass test12 -delete -alias nss&quot;);
 693 
 694         testOK(&quot;&quot;, p11Arg + &quot;-storepass test12 -list&quot;);
 695         assertTrue(out.indexOf(&quot;Your keystore contains 0 entries&quot;) != -1,
 696                 &quot;*** MAKE SURE YOU HAVE NO ENTRIES IN YOUR PKCS11 KEYSTORE &quot; +
 697                         &quot;BEFORE THIS TEST ***&quot;);
 698 
 699         testOK(&quot;&quot;, p11Arg +
 700                 &quot;-storepass test12 -genkeypair -keyalg DSA -alias p1 -dname CN=olala&quot;);
 701         testOK(&quot;test12\n&quot;, p11Arg + &quot;-genkeypair -keyalg DSA -alias p2 -dname CN=olala2&quot;);
 702         // cannot provide keypass for PKCS11
 703         testFail(&quot;test12\n&quot;, p11Arg +
 704                 &quot;-keypass test12 -genkeypair -keyalg DSA -alias p3 -dname CN=olala3&quot;);
 705         // cannot provide keypass for PKCS11
 706         testFail(&quot;test12\n&quot;, p11Arg +
 707                 &quot;-keypass nonsense -genkeypair -keyalg DSA -alias p3 -dname CN=olala3&quot;);
 708 
 709         testOK(&quot;&quot;, p11Arg + &quot;-storepass test12 -list&quot;);
 710         assertTrue(out.indexOf(&quot;Your keystore contains 2 entries&quot;) != -1,
 711                 &quot;2 entries in p11&quot;);
 712 
 713         testOK(&quot;test12\n&quot;, p11Arg + &quot;-alias p1 -changealias -destalias p3&quot;);
 714         testOK(&quot;&quot;, p11Arg + &quot;-storepass test12 -list -alias p3&quot;);
 715         testFail(&quot;&quot;, p11Arg + &quot;-storepass test12 -list -alias p1&quot;);
 716 
 717         testOK(&quot;test12\n&quot;, p11Arg + &quot;-alias p3 -keyclone -destalias p1&quot;);
 718         // in PKCS11, keyclone will delete old
 719         testFail(&quot;&quot;, p11Arg + &quot;-storepass test12 -list -alias p3&quot;);
 720         testOK(&quot;&quot;, p11Arg + &quot;-storepass test12 -list -alias p1&quot;);
 721 
 722         // cannot change password for PKCS11
 723         testFail(&quot;test12\n&quot;, p11Arg + &quot;-alias p1 -keypasswd -new another&quot;);
 724 
 725         testOK(&quot;&quot;, p11Arg + &quot;-storepass test12 -list&quot;);
 726         assertTrue(out.indexOf(&quot;Your keystore contains 2 entries&quot;) != -1,
 727                 &quot;2 entries in p11&quot;);
 728 
 729         testOK(&quot;&quot;, p11Arg + &quot;-storepass test12 -delete -alias p1&quot;);
 730         testOK(&quot;&quot;, p11Arg + &quot;-storepass test12 -delete -alias p2&quot;);
 731 
 732         testOK(&quot;&quot;, p11Arg + &quot;-storepass test12 -list&quot;);
 733         assertTrue(out.indexOf(&quot;Your keystore contains 0 entries&quot;) != -1,
 734                 &quot;*** MAKE SURE YOU HAVE NO ENTRIES IN YOUR PKCS11 KEYSTORE&quot; +
 735                         &quot; BEFORE THIS TEST ***&quot;);
 736     }
 737 
 738     void testPKCS11ImportKeyStore() throws Exception {
 739 
 740         KeyStore ks;
 741         testOK(&quot;&quot;, p11Arg +
 742                 &quot;-storepass test12 -genkeypair -keyalg DSA -alias p1 -dname CN=olala&quot;);
 743         testOK(&quot;test12\n&quot;, p11Arg + &quot;-genkeypair -keyalg DSA -alias p2 -dname CN=olala2&quot;);
 744         // test importkeystore for pkcs11
 745 
 746         remove(&quot;x.jks&quot;);
 747         // pkcs11 -&gt; jks
 748         testOK(&quot;changeit\nchangeit\ntest12\n&quot;, srcP11Arg +
 749                 (&quot;-importkeystore -destkeystore x.jks -deststoretype JKS &quot; +
 750                 &quot;-srcalias p1&quot;));
 751         assertTrue(err.indexOf(&quot;not imported&quot;) != -1,
 752                 &quot;cannot import key without destkeypass&quot;);
 753         ks = loadStore(&quot;x.jks&quot;, &quot;changeit&quot;, &quot;JKS&quot;);
 754         assertTrue(!ks.containsAlias(&quot;p1&quot;), &quot;p1 is not imported&quot;);
 755 
 756         testOK(&quot;changeit\ntest12\n&quot;, srcP11Arg +
 757                 (&quot;-importkeystore -destkeystore x.jks -deststoretype JKS &quot; +
 758                 &quot;-srcalias p1 -destkeypass changeit&quot;));
 759         testOK(&quot;changeit\ntest12\n&quot;, srcP11Arg +
 760                 (&quot;-importkeystore -destkeystore x.jks -deststoretype JKS &quot; +
 761                 &quot;-srcalias p2 -destkeypass changeit&quot;));
 762         ks = loadStore(&quot;x.jks&quot;, &quot;changeit&quot;, &quot;JKS&quot;);
 763         assertTrue(ks.containsAlias(&quot;p1&quot;), &quot;p1 is imported&quot;);
 764         assertTrue(ks.containsAlias(&quot;p2&quot;), &quot;p2 is imported&quot;);
 765         // jks -&gt; pkcs11
 766         testOK(&quot;&quot;, p11Arg + &quot;-storepass test12 -delete -alias p1&quot;);
 767         testOK(&quot;&quot;, p11Arg + &quot;-storepass test12 -delete -alias p2&quot;);
 768         testOK(&quot;test12\nchangeit\n&quot;, p11Arg +
 769                 &quot;-importkeystore -srckeystore x.jks -srcstoretype JKS&quot;);
 770         testOK(&quot;&quot;, p11Arg + &quot;-storepass test12 -list -alias p1&quot;);
 771         testOK(&quot;&quot;, p11Arg + &quot;-storepass test12 -list -alias p2&quot;);
 772         testOK(&quot;&quot;, p11Arg + &quot;-storepass test12 -list&quot;);
 773         assertTrue(out.indexOf(&quot;Your keystore contains 2 entries&quot;) != -1,
 774                 &quot;2 entries in p11&quot;);
 775         // clean up
 776         testOK(&quot;&quot;, p11Arg + &quot;-storepass test12 -delete -alias p1&quot;);
 777         testOK(&quot;&quot;, p11Arg + &quot;-storepass test12 -delete -alias p2&quot;);
 778         testOK(&quot;&quot;, p11Arg + &quot;-storepass test12 -list&quot;);
 779         assertTrue(out.indexOf(&quot;Your keystore contains 0 entries&quot;) != -1,
 780                 &quot;empty p11&quot;);
 781 
 782         remove(&quot;x.jks&quot;);
 783     }
 784 
 785     // Selected sqeTest
 786     void sqeTest() throws Exception {
 787         FileOutputStream fos = new FileOutputStream(&quot;badkeystore&quot;);
 788         for (int i=0; i&lt;100; i++) {
 789             fos.write(i);
 790         }
 791         fos.close();
 792 
 793         sqeCsrTest();
 794         sqePrintcertTest();
 795         sqeDeleteTest();
 796         sqeExportTest();
 797         sqeGenkeyTest();
 798         sqeImportTest();
 799         sqeKeyclonetest();
 800         sqeKeypasswdTest();
 801         sqeListTest();
 802         sqeSelfCertTest();
 803         sqeStorepassTest();
 804 
 805         remove(&quot;badkeystore&quot;);
 806     }
 807 
 808     // Import: cacert, prompt, trusted, non-trusted, bad chain, not match
 809     void sqeImportTest() throws Exception {
 810         KeyStore ks;
 811         remove(&quot;x.jks&quot;);
 812         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 813                 &quot;-keypass changeit -genkeypair -keyalg DSA -dname CN=olala&quot;);
 814         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 815                 &quot;-exportcert -file x.jks.p1.cert&quot;);
 816         /* deleted */ testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS &quot; +
 817                 &quot;-storepass changeit -delete -alias mykey&quot;);
 818         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 819                 &quot;-importcert -file x.jks.p1.cert -noprompt&quot;);
 820         /* deleted */ testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS &quot; +
 821                 &quot;-storepass changeit -delete -alias mykey&quot;);
 822         testOK(&quot;yes\n&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 823                 &quot;-importcert -file x.jks.p1.cert&quot;);
 824         ks = loadStore(&quot;x.jks&quot;, &quot;changeit&quot;, &quot;JKS&quot;);
 825         assertTrue(ks.containsAlias(&quot;mykey&quot;), &quot;imported&quot;);
 826         /* deleted */ testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS &quot; +
 827                 &quot;-storepass changeit -delete -alias mykey&quot;);
 828         testOK(&quot;\n&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 829                 &quot;-importcert -file x.jks.p1.cert&quot;);
 830         ks = loadStore(&quot;x.jks&quot;, &quot;changeit&quot;, &quot;JKS&quot;);
 831         assertTrue(!ks.containsAlias(&quot;mykey&quot;), &quot;imported&quot;);
 832         testOK(&quot;no\n&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 833                 &quot;-importcert -file x.jks.p1.cert&quot;);
 834         ks = loadStore(&quot;x.jks&quot;, &quot;changeit&quot;, &quot;JKS&quot;);
 835         assertTrue(!ks.containsAlias(&quot;mykey&quot;), &quot;imported&quot;);
 836         testFail(&quot;no\n&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 837                 &quot;-importcert -file nonexist&quot;);
 838         testFail(&quot;no\n&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 839                 &quot;-importcert -file x.jks&quot;);
 840         remove(&quot;x.jks&quot;);
 841     }
 842     // keyclone: exist. nonexist err, cert err, dest exist, misc
 843     void sqeKeyclonetest() throws Exception {
 844         remove(&quot;x.jks&quot;);
 845         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 846                 &quot;-keypass changeit -genkeypair -keyalg DSA -dname CN=olala&quot;);
 847         // new pass
 848         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 849                 &quot;-keypass changeit -new newpass -keyclone -dest p0&quot;);
 850         // new pass
 851         testOK(&quot;\n&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 852                 &quot;-keypass changeit -keyclone -dest p1&quot;);
 853         testOK(&quot;\n&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 854                 &quot;-keyclone -dest p2&quot;);
 855         testFail(&quot;\n&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 856                 &quot;-keyclone -dest p2&quot;);
 857         testFail(&quot;\n&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 858                 &quot;-keyclone -dest p3 -alias noexist&quot;);
 859         // no cert
 860         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 861                 &quot;-exportcert -file x.jks.p1.cert&quot;);
 862         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 863                 &quot;-delete -alias mykey&quot;);
 864         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 865                 &quot;-importcert -file x.jks.p1.cert -noprompt&quot;);
 866         // new pass
 867         testFail(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 868                 &quot;-keypass changeit -new newpass -keyclone -dest p0&quot;);
 869         remove(&quot;x.jks&quot;);
 870     }
 871     // keypasswd: exist, short, nonexist err, cert err, misc
 872     void sqeKeypasswdTest() throws Exception {
 873         remove(&quot;x.jks&quot;);
 874         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 875                 &quot;-keypass changeit -genkeypair -keyalg DSA -dname CN=olala&quot;);
 876         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 877                 &quot;-keypass changeit -keypasswd -new newpass&quot;);
 878         /*change back*/ testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS &quot; +
 879                 &quot;-storepass changeit -keypass newpass -keypasswd -new changeit&quot;);
 880         testOK(&quot;newpass\nnewpass\n&quot;, &quot;-keystore x.jks -storetype JKS &quot; +
 881                 &quot;-storepass changeit -keypass changeit -keypasswd&quot;);
 882         /*change back*/ testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS &quot; +
 883                 &quot;-storepass changeit -keypass newpass -keypasswd -new changeit&quot;);
 884         testOK(&quot;new\nnew\nnewpass\nnewpass\n&quot;, &quot;-keystore x.jks &quot; +
 885                 &quot;-storetype JKS -storepass changeit -keypass changeit -keypasswd&quot;);
 886         /*change back*/ testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS &quot; +
 887                 &quot;-storepass changeit -keypass newpass -keypasswd -new changeit&quot;);
 888         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 889                 &quot;-keypasswd -new newpass&quot;);
 890         /*change back*/ testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS &quot; +
 891                 &quot;-storepass changeit -keypass newpass -keypasswd -new changeit&quot;);
 892         testOK(&quot;changeit\n&quot;, &quot;-keystore x.jks -storetype JKS &quot; +
 893                 &quot;-keypasswd -new newpass&quot;);
 894         /*change back*/ testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS &quot; +
 895                 &quot;-storepass changeit -keypass newpass -keypasswd -new changeit&quot;);
 896         testFail(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass badpass &quot; +
 897                 &quot;-keypass changeit -keypasswd -new newpass&quot;);
 898         testFail(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 899                 &quot;-keypass bad -keypasswd -new newpass&quot;);
 900         // no cert
 901         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 902                 &quot;-exportcert -file x.jks.p1.cert&quot;);
 903         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 904                 &quot;-delete -alias mykey&quot;);
 905         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 906                 &quot;-importcert -file x.jks.p1.cert -noprompt&quot;);
 907         testFail(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 908                 &quot;-keypass changeit -keypasswd -new newpass&quot;);
 909         // diff pass
 910         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 911                 &quot;-delete -alias mykey&quot;);
 912         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 913                 &quot;-keypass keypass -genkeypair -keyalg DSA -dname CN=olala&quot;);
 914         testFail(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 915                 &quot;-keypasswd -new newpass&quot;);
 916         testOK(&quot;keypass\n&quot;, &quot;-keystore x.jks -storetype JKS &quot; +
 917                 &quot;-storepass changeit -keypasswd -new newpass&quot;);
 918         // i hate those misc test
 919         remove(&quot;x.jks&quot;);
 920     }
 921     // list: -f -alias, exist, nonexist err;
 922     // otherwise, check all shows, -rfc shows more, and misc
 923     void sqeListTest() throws Exception {
 924         remove(&quot;x.jks&quot;);
 925         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 926                 &quot;-keypass changeit -genkeypair -keyalg DSA -dname CN=olala&quot;);
 927         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit -list&quot;);
 928         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 929                 &quot;-list -alias mykey&quot;);
 930         testFail(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 931                 &quot;-list -alias notexist&quot;);
 932         testFail(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass badpass &quot; +
 933                 &quot;-list -alias mykey&quot;);
 934         // keypass ignore
 935         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 936                 &quot;-keypass badpass -list -alias mykey&quot;);
 937         testOK(&quot;\n&quot;, &quot;-keystore x.jks -storetype JKS -list&quot;);
 938         assertTrue(err.indexOf(&quot;WARNING&quot;) != -1, &quot;no storepass&quot;);
 939         testOK(&quot;changeit\n&quot;, &quot;-keystore x.jks -storetype JKS -list&quot;);
 940         assertTrue(err.indexOf(&quot;WARNING&quot;) == -1, &quot;has storepass&quot;);
 941         testFail(&quot;badpass\n&quot;, &quot;-keystore x.jks -storetype JKS -list&quot;);
 942         // misc
 943         testFail(&quot;&quot;, &quot;-keystore aa\\bb//cc -storepass changeit -list&quot;);
 944         testFail(&quot;&quot;, &quot;-keystore nonexisting -storepass changeit -list&quot;);
 945         testFail(&quot;&quot;, &quot;-keystore badkeystore -storepass changeit -list&quot;);
 946         remove(&quot;x.jks&quot;);
 947     }
 948     // selfcert: exist, non-exist err, cert err, sig, dname, wrong keypass, misc
 949     void sqeSelfCertTest() throws Exception {
 950         remove(&quot;x.jks&quot;);
 951         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 952                 &quot;-keypass changeit -genkeypair -keyalg DSA -dname CN=olala&quot;);
 953         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit -selfcert&quot;);
 954         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 955                 &quot;-keypass changeit -selfcert&quot;);
 956         // not exist
 957         testFail(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 958                 &quot;-keypass changeit -selfcert -alias nonexisting&quot;);
 959         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 960                 &quot;-keypass changeit -selfcert -dname CN=NewName&quot;);
 961         // sig not compatible
 962         testFail(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 963                 &quot;-keypass changeit -selfcert -sigalg MD5withRSA&quot;);
 964         // bad pass
 965         testFail(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass wrong &quot; +
 966                 &quot;-keypass changeit -selfcert&quot;);
 967         // bad pass
 968         testFail(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 969                 &quot;-keypass wrong -selfcert&quot;);
 970         //misc
 971         testFail(&quot;&quot;, &quot;-keystore nonexist -storepass changeit &quot; +
 972                 &quot;-keypass changeit -selfcert&quot;);
 973         testFail(&quot;&quot;, &quot;-keystore aa//dd\\gg -storepass changeit &quot; +
 974                 &quot;-keypass changeit -selfcert&quot;);
 975         // diff pass
 976         remove(&quot;x.jks&quot;);
 977         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 978                 &quot;-keypass keypass -genkeypair -keyalg DSA -dname CN=olala&quot;);
 979         testFail(&quot;&quot;, &quot;-keystore x.jks -storetype JKS &quot; +
 980                 &quot;-storepass changeit -selfcert&quot;);
 981         testOK(&quot;keypass\n&quot;, &quot;-keystore x.jks -storetype JKS &quot; +
 982                 &quot;-storepass changeit -selfcert&quot;);
 983 
 984         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 985                 &quot;-exportcert -file x.jks.p1.cert&quot;);
 986         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 987                 &quot;-delete -alias mykey&quot;);
 988         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 989                 &quot;-importcert -file x.jks.p1.cert -noprompt&quot;);
 990         // certentry cannot do selfcert
 991         testFail(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 992                 &quot;-selfcert&quot;);
 993         remove(&quot;x.jks&quot;);
 994     }
 995     // storepass: bad old, short new, misc
 996     void sqeStorepassTest() throws Exception {
 997         remove(&quot;x.jks&quot;);
 998         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
 999                 &quot;-keypass changeit -genkeypair -keyalg DSA -dname CN=olala&quot;);
1000         // all in arg
1001         testOK(&quot;&quot;, &quot;-storepasswd -keystore x.jks -storetype JKS &quot; +
1002                 &quot;-storepass changeit -new newstore&quot;);
1003         /* Change back */ testOK(&quot;&quot;, &quot;-storepasswd -keystore x.jks&quot; +
1004                 &quot; -storetype JKS -storepass newstore -new changeit&quot;);
1005         // all not in arg, new twice
1006         testOK(&quot;changeit\nnewstore\nnewstore\n&quot;, &quot;-storepasswd &quot; +
1007                 &quot;-keystore x.jks -storetype JKS&quot;);
1008         /* Change back */ testOK(&quot;&quot;, &quot;-storepasswd -keystore x.jks &quot; +
1009                 &quot;-storetype JKS -storepass newstore -new changeit&quot;);
1010         // new in arg
1011         testOK(&quot;changeit\n&quot;, &quot;-storepasswd -keystore x.jks &quot; +
1012                 &quot;-storetype JKS -new newstore&quot;);
1013         /* Change back */ testOK(&quot;&quot;, &quot;-storepasswd -keystore x.jks &quot; +
1014                 &quot;-storetype JKS -storepass newstore -new changeit&quot;);
1015         // old in arg
1016         testOK(&quot;newstore\nnewstore\n&quot;, &quot;-storepasswd -keystore x.jks &quot; +
1017                 &quot;-storetype JKS -storepass changeit&quot;);
1018         /* Change back */ testOK(&quot;&quot;, &quot;-storepasswd -keystore x.jks &quot; +
1019                 &quot;-storetype JKS -storepass newstore -new changeit&quot;);
1020         // old in arg
1021         testOK(&quot;new\nnew\nnewstore\nnewstore\n&quot;, &quot;-storepasswd &quot; +
1022                 &quot;-keystore x.jks -storetype JKS -storepass changeit&quot;);
1023         /* Change back */ testOK(&quot;&quot;, &quot;-storepasswd -keystore x.jks &quot; +
1024                 &quot;-storetype JKS -storepass newstore -new changeit&quot;);
1025         // bad old
1026         testFail(&quot;&quot;, &quot;-storepasswd -keystore x.jks -storetype JKS &quot; +
1027                 &quot;-storepass badold -new newstore&quot;);
1028         // short new
1029         testFail(&quot;&quot;, &quot;-storepasswd -keystore x.jks -storetype JKS &quot; +
1030                 &quot;-storepass changeit -new new&quot;);
1031         // misc
1032         // non exist
1033         testFail(&quot;&quot;, &quot;-storepasswd -keystore nonexist &quot; +
1034                 &quot;-storepass changeit -new newstore&quot;);
1035         // bad file
1036         testFail(&quot;&quot;, &quot;-storepasswd -keystore badkeystore &quot; +
1037                 &quot;-storepass changeit -new newstore&quot;);
1038         // bad file
1039         testFail(&quot;&quot;, &quot;-storepasswd -keystore aa\\bb//cc//dd &quot; +
1040                 &quot;-storepass changeit -new newstore&quot;);
1041         remove(&quot;x.jks&quot;);
1042     }
1043 
1044     void sqeGenkeyTest() throws Exception {
1045 
1046         remove(&quot;x.jks&quot;);
1047         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
1048                 &quot;-keypass changeit -genkeypair -keyalg DSA -dname CN=olala&quot;);
1049         testFail(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
1050                 &quot;-keypass changeit -genkeypair -keyalg DSA -dname CN=olala&quot;);
1051         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
1052                 &quot;-keypass changeit -genkeypair -keyalg DSA -dname CN=olala -alias newentry&quot;);
1053         testFail(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
1054                 &quot;-keypass changeit -genkeypair -keyalg DSA -dname CN=olala -alias newentry&quot;);
1055         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
1056                 &quot;-keypass changeit -genkeypair -dname CN=olala -keyalg DSA &quot; +
1057                 &quot;-alias n1&quot;);
1058         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
1059                 &quot;-keypass changeit -genkeypair -dname CN=olala -keyalg RSA &quot; +
1060                 &quot;-alias n2&quot;);
1061         testFail(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
1062                 &quot;-keypass changeit -genkeypair -dname CN=olala &quot; +
1063                 &quot;-keyalg NoSuchAlg -alias n3&quot;);
1064         testFail(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
1065                 &quot;-keypass changeit -genkeypair -keyalg DSA -dname CN=olala -keysize 56 &quot; +
1066                 &quot;-alias n4&quot;);
1067         testFail(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
1068                 &quot;-keypass changeit -genkeypair -keyalg DSA -dname CN=olala -keysize 999 &quot; +
1069                 &quot;-alias n5&quot;);
1070         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
1071                 &quot;-keypass changeit -genkeypair -keyalg DSA -dname CN=olala -keysize 512 &quot; +
1072                 &quot;-alias n6&quot;);
1073         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
1074                 &quot;-keypass changeit -genkeypair -keyalg DSA -dname CN=olala -keysize 1024 &quot; +
1075                 &quot;-alias n7&quot;);
1076         testFail(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
1077                 &quot;-keypass changeit -genkeypair -keyalg DSA -dname CN=olala &quot; +
1078                 &quot;-sigalg NoSuchAlg -alias n8&quot;);
1079         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
1080                 &quot;-keypass changeit -genkeypair -dname CN=olala -keyalg RSA &quot; +
1081                 &quot;-sigalg MD2withRSA -alias n9&quot;);
1082         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
1083                 &quot;-keypass changeit -genkeypair -dname CN=olala -keyalg RSA &quot; +
1084                 &quot;-sigalg MD5withRSA -alias n10&quot;);
1085         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
1086                 &quot;-keypass changeit -genkeypair -dname CN=olala -keyalg RSA &quot; +
1087                 &quot;-sigalg SHA1withRSA -alias n11&quot;);
1088         testFail(&quot;&quot;, &quot;-keystore aa\\bb//cc\\dd -storepass changeit &quot; +
1089                 &quot;-keypass changeit -genkeypair -dname CN=olala -keyalg RSA &quot; +
1090                 &quot;-sigalg NoSuchAlg -alias n12&quot;);
1091         testFail(&quot;&quot;, &quot;-keystore badkeystore -storepass changeit &quot; +
1092                 &quot;-keypass changeit -genkeypair -keyalg DSA -dname CN=olala &quot; +
1093                 &quot;-alias n14&quot;);
1094         testFail(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass badpass &quot; +
1095                 &quot;-keypass changeit -genkeypair -keyalg DSA -dname CN=olala -alias n16&quot;);
1096         testFail(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
1097                 &quot;-keypass changeit -genkeypair -keyalg DSA -dname CNN=olala -alias n17&quot;);
1098         remove(&quot;x.jks&quot;);
1099     }
1100 
1101     void sqeExportTest() throws Exception {
1102         remove(&quot;x.jks&quot;);
1103         // nonexist
1104         testFail(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
1105                 &quot;-export -file mykey.cert -alias mykey&quot;);
1106         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
1107                 &quot;-keypass changeit -genkeypair -keyalg DSA -dname CN=olala&quot;);
1108         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
1109                 &quot;-export -file mykey.cert -alias mykey&quot;);
1110         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
1111                 &quot;-delete -alias mykey&quot;);
1112         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
1113                 &quot;-import -file mykey.cert -noprompt -alias c1&quot;);
1114         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
1115                 &quot;-export -file mykey.cert2 -alias c1&quot;);
1116         testFail(&quot;&quot;, &quot;-keystore aa\\bb//cc\\dd -storepass changeit &quot; +
1117                 &quot;-export -file mykey.cert2 -alias c1&quot;);
1118         testFail(&quot;&quot;, &quot;-keystore nonexistkeystore -storepass changeit &quot; +
1119                 &quot;-export -file mykey.cert2 -alias c1&quot;);
1120         testFail(&quot;&quot;, &quot;-keystore badkeystore -storepass changeit &quot; +
1121                 &quot;-export -file mykey.cert2 -alias c1&quot;);
1122         testFail(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass badpass &quot; +
1123                 &quot;-export -file mykey.cert2 -alias c1&quot;);
1124         remove(&quot;mykey.cert&quot;);
1125         remove(&quot;mykey.cert2&quot;);
1126         remove(&quot;x.jks&quot;);
1127     }
1128 
1129     void sqeDeleteTest() throws Exception {
1130         remove(&quot;x.jks&quot;);
1131         // nonexist
1132         testFail(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
1133                 &quot;-delete -alias mykey&quot;);
1134         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
1135                 &quot;-keypass changeit -genkeypair -keyalg DSA -dname CN=olala&quot;);
1136         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
1137                 &quot;-delete -alias mykey&quot;);
1138         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
1139                 &quot;-keypass changeit -genkeypair -keyalg DSA -dname CN=olala&quot;);
1140         // keystore name illegal
1141         testFail(&quot;&quot;, &quot;-keystore aa\\bb//cc\\dd -storepass changeit &quot; +
1142                 &quot;-delete -alias mykey&quot;);
1143         // keystore not exist
1144         testFail(&quot;&quot;, &quot;-keystore nonexistkeystore -storepass changeit &quot; +
1145                 &quot;-delete -alias mykey&quot;);
1146         // keystore invalid
1147         testFail(&quot;&quot;, &quot;-keystore badkeystore -storepass changeit &quot; +
1148                 &quot;-delete -alias mykey&quot;);
1149         // wrong pass
1150         testFail(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass xxxxxxxx &quot; +
1151                 &quot;-delete -alias mykey&quot;);
1152         remove(&quot;x.jks&quot;);
1153     }
1154 
1155     void sqeCsrTest() throws Exception {
1156         remove(&quot;x.jks&quot;);
1157         remove(&quot;x.jks.p1.cert&quot;);
1158         remove(&quot;csr1&quot;);
1159         // PrivateKeyEntry can do certreq
1160         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
1161                 &quot;-keypass changeit -genkeypair -keyalg DSA -dname CN=olala -keysize 1024&quot;);
1162         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
1163                 &quot;-certreq -file csr1 -alias mykey&quot;);
1164         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
1165                 &quot;-certreq -file csr1&quot;);
1166         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
1167                 &quot;-certreq -file csr1 -sigalg SHA1withDSA&quot;);
1168         // unmatched sigalg
1169         testFail(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
1170                 &quot;-certreq -file csr1 -sigalg MD5withRSA&quot;);
1171         // misc test
1172         // bad storepass
1173         testFail(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass badstorepass &quot; +
1174                 &quot;-certreq -file csr1&quot;);
1175         // storepass from terminal
1176         testOK(&quot;changeit\n&quot;, &quot;-keystore x.jks -storetype JKS &quot; +
1177                 &quot;-certreq -file csr1&quot;);
1178         // must provide storepass
1179         testFail(&quot;\n&quot;, &quot;-keystore x.jks -storetype JKS &quot; +
1180                 &quot;-certreq -file csr1&quot;);
1181         // bad keypass
1182         testFail(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
1183                 &quot;-keypass badkeypass -certreq -file csr1&quot;);
1184         // bad filepath
1185         testFail(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
1186                 &quot;-certreq -file aa\\bb//cc\\dd&quot;);
1187         // non-existing keystore
1188         testFail(&quot;&quot;, &quot;-keystore noexistks -storepass changeit &quot; +
1189                 &quot;-certreq -file csr1&quot;);
1190         // Try the RSA private key
1191         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
1192                 &quot;-delete -alias mykey&quot;);
1193         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
1194                 &quot;-keypass changeit -genkeypair -dname CN=olala -keyalg RSA&quot;);
1195         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
1196                 &quot;-certreq -file csr1 -alias mykey&quot;);
1197         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
1198                 &quot;-certreq -file csr1&quot;);
1199         // unmatched sigalg
1200         testFail(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
1201                 &quot;-certreq -file csr1 -sigalg SHA1withDSA&quot;);
1202         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
1203                 &quot;-certreq -file csr1 -sigalg MD5withRSA&quot;);
1204         // TrustedCertificateEntry cannot do certreq
1205         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
1206                 &quot;-exportcert -file x.jks.p1.cert&quot;);
1207         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
1208                 &quot;-delete -alias mykey&quot;);
1209         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
1210                 &quot;-importcert -file x.jks.p1.cert -noprompt&quot;);
1211         testFail(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
1212                 &quot;-certreq -file csr1 -alias mykey&quot;);
1213         testFail(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
1214                 &quot;-certreq -file csr1&quot;);
1215         remove(&quot;x.jks&quot;);
1216         remove(&quot;x.jks.p1.cert&quot;);
1217         remove(&quot;csr1&quot;);
1218     }
1219 
1220     void sqePrintcertTest() throws Exception {
1221         remove(&quot;x.jks&quot;);
1222         remove(&quot;mykey.cert&quot;);
1223         remove(&quot;myweakkey.cert&quot;);
1224         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
1225                 &quot;-keypass changeit -genkeypair -keyalg DSA -dname CN=olala&quot;);
1226         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
1227                 &quot;-export -file mykey.cert -alias mykey&quot;);
1228         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
1229                 &quot;-keypass changeit -genkeypair -dname CN=weak -keyalg rsa &quot; +
1230                 &quot;-keysize 512 -sigalg MD5withRSA -alias myweakkey&quot;);
1231         testOK(&quot;&quot;, &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
1232                 &quot;-export -file myweakkey.cert -alias myweakkey&quot;);
1233         testFail(&quot;&quot;, &quot;-printcert -file badkeystore&quot;);
1234         testFail(&quot;&quot;, &quot;-printcert -file a/b/c/d&quot;);
1235         testOK(&quot;&quot;, &quot;-printcert -file mykey.cert&quot;);
1236         testOK(&quot;&quot;, &quot;-printcert -file myweakkey.cert&quot;);
1237         FileInputStream fin = new FileInputStream(&quot;mykey.cert&quot;);
1238         testOK(fin, &quot;-printcert&quot;);
1239         fin.close();
1240         remove(&quot;x.jks&quot;);
1241         remove(&quot;mykey.cert&quot;);
1242         remove(&quot;myweakkey.cert&quot;);
1243     }
1244 
1245     // 8074935: jdk8 keytool doesn&#39;t validate pem files for RFC 1421 correctness
1246     static void checkPem(String file) throws Exception {
1247         boolean maybeLast = false;
1248         for (String s: Files.readAllLines(Paths.get(file))) {
1249             if (s.isEmpty()) continue;
1250             if (s.startsWith(&quot;---&quot;)) continue;
1251             if (maybeLast) {
1252                 throw new Exception(&quot;Last line already seen&quot;);
1253             }
1254             if (s.length() &gt; 64) {
1255                 throw new Exception(s);
1256             }
1257             if (s.length() &lt; 64) {
1258                 maybeLast = true;
1259             }
1260         }
1261     }
1262 
1263     void v3extTest(String keyAlg) throws Exception {
1264         KeyStore ks;
1265         remove(&quot;x.jks&quot;);
1266         String simple = &quot;-keystore x.jks -storetype JKS -storepass changeit &quot; +
1267                 &quot;-keypass changeit -noprompt -keyalg &quot; + keyAlg + &quot; &quot;;
1268         String pre = simple + &quot;-genkeypair -keyalg DSA -dname CN=Olala -alias &quot;;
1269 
1270         // Version and SKID
1271         testOK(&quot;&quot;, pre + &quot;o1&quot;);
1272 
1273         ks = loadStore(&quot;x.jks&quot;, &quot;changeit&quot;, &quot;JKS&quot;);
1274         assertTrue(((X509Certificate)ks.getCertificate(&quot;o1&quot;)).getVersion() == 3);
1275         assertTrue(((X509CertImpl)ks.getCertificate(&quot;o1&quot;))
1276                 .getSubjectKeyIdentifierExtension() != null);
1277 
1278         // BC
1279         testOK(&quot;&quot;, pre + &quot;b1 -ext BC:critical&quot;);
1280         testOK(&quot;&quot;, pre + &quot;b2 -ext BC&quot;);
1281         testOK(&quot;&quot;, pre + &quot;b3 -ext bc&quot;);
1282         testOK(&quot;&quot;, pre + &quot;b4 -ext BasicConstraints&quot;);
1283         testOK(&quot;&quot;, pre + &quot;b5 -ext basicconstraints&quot;);
1284         testOK(&quot;&quot;, pre + &quot;b6 -ext BC=ca:true,pathlen:12&quot;);
1285         testOK(&quot;&quot;, pre + &quot;b7 -ext BC=ca:false&quot;);
1286         testOK(&quot;&quot;, pre + &quot;b8 -ext BC:critical=ca:false&quot;);
1287         testOK(&quot;&quot;, pre + &quot;b9 -ext BC=12&quot;);
1288 
1289         ks = loadStore(&quot;x.jks&quot;, &quot;changeit&quot;, &quot;JKS&quot;);
1290         assertTrue(((X509CertImpl)ks.getCertificate(&quot;b1&quot;))
1291                 .getBasicConstraintsExtension().isCritical());
1292         assertTrue(!((X509CertImpl)ks.getCertificate(&quot;b2&quot;))
1293                 .getBasicConstraintsExtension().isCritical());
1294         assertTrue(((X509CertImpl)ks.getCertificate(&quot;b8&quot;))
1295                 .getBasicConstraintsExtension().isCritical());
1296         assertTrue(((X509Certificate)ks.getCertificate(&quot;b1&quot;))
1297                 .getBasicConstraints() == Integer.MAX_VALUE);
1298         assertTrue(((X509Certificate)ks.getCertificate(&quot;b2&quot;))
1299                 .getBasicConstraints() == Integer.MAX_VALUE);
1300         assertTrue(((X509Certificate)ks.getCertificate(&quot;b3&quot;))
1301                 .getBasicConstraints() == Integer.MAX_VALUE);
1302         assertTrue(((X509Certificate)ks.getCertificate(&quot;b4&quot;))
1303                 .getBasicConstraints() == Integer.MAX_VALUE);
1304         assertTrue(((X509Certificate)ks.getCertificate(&quot;b5&quot;))
1305                 .getBasicConstraints() == Integer.MAX_VALUE);
1306         assertTrue(((X509Certificate)ks.getCertificate(&quot;b6&quot;))
1307                 .getBasicConstraints() == 12);
1308         assertTrue(((X509Certificate)ks.getCertificate(&quot;b7&quot;))
1309                 .getBasicConstraints() == -1);
1310         assertTrue(((X509Certificate)ks.getCertificate(&quot;b9&quot;))
1311                 .getBasicConstraints() == 12);
1312 
1313         // KU
1314         testOK(&quot;&quot;, pre + &quot;ku1 -ext KeyUsage:critical=digitalsignature&quot;);
1315         testOK(&quot;&quot;, pre + &quot;ku2 -ext KU=digitalSignature&quot;);
1316         testOK(&quot;&quot;, pre + &quot;ku3 -ext KU=ds&quot;);
1317         testOK(&quot;&quot;, pre + &quot;ku4 -ext KU=dig&quot;);
1318         // ambigous value
1319         testFail(&quot;&quot;, pre + &quot;ku5 -ext KU=d&quot;);
1320         // cRLSign cannot be cs
1321         testFail(&quot;&quot;, pre + &quot;ku6 -ext KU=cs&quot;);
1322         testOK(&quot;&quot;, pre + &quot;ku11 -ext KU=nr&quot;);
1323         // ke means keyAgreement and keyCertSign...
1324         testFail(&quot;&quot;, pre + &quot;ku12 -ext KU=ke&quot;);
1325         testOK(&quot;&quot;, pre + &quot;ku12 -ext KU=keyE&quot;);
1326         testOK(&quot;&quot;, pre + &quot;ku12a -ext KU=kE&quot;); // kE is only keyEncipherment
1327         // de also means decipherOnly
1328         testOK(&quot;&quot;, pre + &quot;ku13a -ext KU=de&quot;); // de is decipherOnly
1329         testOK(&quot;&quot;, pre + &quot;ku13b -ext KU=dE&quot;); // dE is dataEncipherment
1330         testOK(&quot;&quot;, pre + &quot;ku13 -ext KU=dataE&quot;);
1331         testOK(&quot;&quot;, pre + &quot;ku14 -ext KU=ka&quot;);
1332         testOK(&quot;&quot;, pre + &quot;ku15 -ext KU=kcs&quot;);
1333         testOK(&quot;&quot;, pre + &quot;ku16 -ext KU=crls&quot;);
1334         testOK(&quot;&quot;, pre + &quot;ku17 -ext KU=eo&quot;);
1335         testOK(&quot;&quot;, pre + &quot;ku18 -ext KU=do&quot;);
1336         testOK(&quot;&quot;, pre + &quot;ku19 -ext KU=cc&quot;);
1337 
1338         testOK(&quot;&quot;, pre + &quot;ku017 -ext KU=ds,cc,eo&quot;);
1339         testOK(&quot;&quot;, pre + &quot;ku135 -ext KU=nr,dataEncipherment,keyCertSign&quot;);
1340         testOK(&quot;&quot;, pre + &quot;ku246 -ext KU=keyEnc,cRL,keyA&quot;);
1341         testOK(&quot;&quot;, pre + &quot;ku1234 -ext KU=ka,da,keyE,nonR&quot;);
1342 
1343         ks = loadStore(&quot;x.jks&quot;, &quot;changeit&quot;, &quot;JKS&quot;);
1344         class CheckKU {
1345             void check(KeyStore ks, String alias, int... pos) throws Exception {
1346                 System.err.print(&quot;x&quot;);
1347                 boolean[] bs = ((X509Certificate)ks.getCertificate(alias))
1348                         .getKeyUsage();
1349                 bs = Arrays.copyOf(bs, 9);
1350                 for (int i=0; i&lt;bs.length; i++) {
1351                     boolean found = false;
1352                     for (int p: pos) {
1353                         if (p == i) found = true;
1354                     }
1355                     if (!found ^ bs[i]) {
1356                         // OK
1357                     } else {
1358                         throw new RuntimeException(&quot;KU not match at &quot; + i +
1359                                 &quot;: &quot; + found + &quot; vs &quot; + bs[i]);
1360                     }
1361                 }
1362             }
1363         }
1364         CheckKU c = new CheckKU();
1365         assertTrue(((X509CertImpl)ks.getCertificate(&quot;ku1&quot;))
1366                 .getExtension(PKIXExtensions.KeyUsage_Id).isCritical());
1367         assertTrue(!((X509CertImpl)ks.getCertificate(&quot;ku2&quot;))
1368                 .getExtension(PKIXExtensions.KeyUsage_Id).isCritical());
1369         c.check(ks, &quot;ku1&quot;, 0);
1370         c.check(ks, &quot;ku2&quot;, 0);
1371         c.check(ks, &quot;ku3&quot;, 0);
1372         c.check(ks, &quot;ku4&quot;, 0);
1373         c.check(ks, &quot;ku11&quot;, 1);
1374         c.check(ks, &quot;ku12&quot;, 2);
1375         c.check(ks, &quot;ku13&quot;, 3);
1376         c.check(ks, &quot;ku14&quot;, 4);
1377         c.check(ks, &quot;ku15&quot;, 5);
1378         c.check(ks, &quot;ku16&quot;, 6);
1379         c.check(ks, &quot;ku17&quot;, 7);
1380         c.check(ks, &quot;ku18&quot;, 8);
1381         c.check(ks, &quot;ku19&quot;, 1);
1382         c.check(ks, &quot;ku11&quot;, 1);
1383         c.check(ks, &quot;ku11&quot;, 1);
1384         c.check(ks, &quot;ku11&quot;, 1);
1385         c.check(ks, &quot;ku017&quot;, 0, 1, 7);
1386         c.check(ks, &quot;ku135&quot;, 1, 3, 5);
1387         c.check(ks, &quot;ku246&quot;, 6, 2, 4);
1388         c.check(ks, &quot;ku1234&quot;, 1, 2, 3, 4);
1389 
1390         // EKU
1391         testOK(&quot;&quot;, pre + &quot;eku1 -ext EKU:critical=sa&quot;);
1392         testOK(&quot;&quot;, pre + &quot;eku2 -ext ExtendedKeyUsage=ca&quot;);
1393         testOK(&quot;&quot;, pre + &quot;eku3 -ext EKU=cs&quot;);
1394         testOK(&quot;&quot;, pre + &quot;eku4 -ext EKU=ep&quot;);
1395         testOK(&quot;&quot;, pre + &quot;eku8 -ext EKU=ts&quot;);
1396         testFail(&quot;&quot;, pre + &quot;eku9 -ext EKU=os&quot;);
1397         testOK(&quot;&quot;, pre + &quot;eku9 -ext EKU=ocsps&quot;);
1398         testOK(&quot;&quot;, pre + &quot;eku10 -ext EKU=any&quot;);
1399         testOK(&quot;&quot;, pre + &quot;eku11 -ext EKU=1.2.3.4,1.3.5.7,ep&quot;);
1400         testFail(&quot;&quot;, pre + &quot;eku12 -ext EKU=c&quot;);
1401         testFail(&quot;&quot;, pre + &quot;eku12 -ext EKU=nothing&quot;);
1402 
1403         ks = loadStore(&quot;x.jks&quot;, &quot;changeit&quot;, &quot;JKS&quot;);
1404         class CheckEKU {
1405             void check(KeyStore ks, String alias, String... pos) throws Exception {
1406                 System.err.print(&quot;x&quot;);
1407                 List&lt;String&gt; bs = ((X509Certificate)ks.getCertificate(alias))
1408                         .getExtendedKeyUsage();
1409                 int found = 0;
1410                 for (String p: pos) {
1411                     if (bs.contains(p)) {
1412                         found++;
1413                     } else {
1414                         throw new RuntimeException(&quot;EKU: not included &quot; + p);
1415                     }
1416                 }
1417                 if (found != bs.size()) {
1418                     throw new RuntimeException(&quot;EKU: more items than expected&quot;);
1419                 }
1420             }
1421         }
1422         CheckEKU cx = new CheckEKU();
1423         assertTrue(((X509CertImpl)ks.getCertificate(&quot;eku1&quot;))
1424                 .getExtension(PKIXExtensions.ExtendedKeyUsage_Id).isCritical());
1425         assertTrue(!((X509CertImpl)ks.getCertificate(&quot;eku2&quot;))
1426                 .getExtension(PKIXExtensions.ExtendedKeyUsage_Id).isCritical());
1427         cx.check(ks, &quot;eku1&quot;, &quot;1.3.6.1.5.5.7.3.1&quot;);
1428         cx.check(ks, &quot;eku2&quot;, &quot;1.3.6.1.5.5.7.3.2&quot;);
1429         cx.check(ks, &quot;eku3&quot;, &quot;1.3.6.1.5.5.7.3.3&quot;);
1430         cx.check(ks, &quot;eku4&quot;, &quot;1.3.6.1.5.5.7.3.4&quot;);
1431         cx.check(ks, &quot;eku8&quot;, &quot;1.3.6.1.5.5.7.3.8&quot;);
1432         cx.check(ks, &quot;eku9&quot;, &quot;1.3.6.1.5.5.7.3.9&quot;);
1433         cx.check(ks, &quot;eku10&quot;, &quot;2.5.29.37.0&quot;);
1434         cx.check(ks, &quot;eku11&quot;, &quot;1.3.6.1.5.5.7.3.4&quot;, &quot;1.2.3.4&quot;, &quot;1.3.5.7&quot;);
1435 
1436         // SAN
1437         testOK(&quot;&quot;, pre+&quot;san1 -ext san:critical=email:me@me.org&quot;);
1438         testOK(&quot;&quot;, pre+&quot;san2 -ext san=uri:http://me.org&quot;);
1439         testOK(&quot;&quot;, pre+&quot;san3 -ext san=dns:me.org&quot;);
1440         testOK(&quot;&quot;, pre+&quot;san4 -ext san=ip:192.168.0.1&quot;);
1441         testOK(&quot;&quot;, pre+&quot;san5 -ext san=oid:1.2.3.4&quot;);
1442         testOK(&quot;&quot;, pre+&quot;san6 -ext san=dns:1abc.com&quot;); //begin with digit
1443         testOK(&quot;&quot;, pre+&quot;san235 -ext san=uri:http://me.org,dns:me.org,oid:1.2.3.4&quot;);
1444 
1445         ks = loadStore(&quot;x.jks&quot;, &quot;changeit&quot;, &quot;JKS&quot;);
1446         class CheckSAN {
1447             // Please sort items with name type
1448             void check(KeyStore ks, String alias, int type, Object... items)
1449                     throws Exception {
1450                 int pos = 0;
1451                 System.err.print(&quot;x&quot;);
1452                 Object[] names = null;
1453                 if (type == 0) names = ((X509Certificate)ks.getCertificate(alias))
1454                         .getSubjectAlternativeNames().toArray();
1455                 else names = ((X509Certificate)ks.getCertificate(alias))
1456                         .getIssuerAlternativeNames().toArray();
1457                 Arrays.sort(names, new Comparator() {
1458                     public int compare(Object o1, Object o2) {
1459                         int i1 = (Integer)((List)o1).get(0);
1460                         int i2 = (Integer)((List)o2).get(0);
1461                         return i1 - i2;
1462                     }
1463                 });
1464                 for (Object o: names) {
1465                     List l = (List)o;
1466                     for (Object o2: l) {
1467                         if (!items[pos++].equals(o2)) {
1468                             throw new RuntimeException(&quot;Not equals at &quot; + pos
1469                                     + &quot;: &quot; + items[pos-1] + &quot; vs &quot; + o2);
1470                         }
1471                     }
1472                 }
1473                 if (pos != items.length) {
1474                     throw new RuntimeException(&quot;Extra items, pos is &quot; + pos);
1475                 }
1476             }
1477         }
1478         CheckSAN csan = new CheckSAN();
1479         assertTrue(((X509CertImpl)ks.getCertificate(&quot;san1&quot;))
1480                 .getSubjectAlternativeNameExtension().isCritical());
1481         assertTrue(!((X509CertImpl)ks.getCertificate(&quot;san2&quot;))
1482                 .getSubjectAlternativeNameExtension().isCritical());
1483         csan.check(ks, &quot;san1&quot;, 0, 1, &quot;me@me.org&quot;);
1484         csan.check(ks, &quot;san2&quot;, 0, 6, &quot;http://me.org&quot;);
1485         csan.check(ks, &quot;san3&quot;, 0, 2, &quot;me.org&quot;);
1486         csan.check(ks, &quot;san4&quot;, 0, 7, &quot;192.168.0.1&quot;);
1487         csan.check(ks, &quot;san5&quot;, 0, 8, &quot;1.2.3.4&quot;);
1488         csan.check(ks, &quot;san235&quot;, 0, 2, &quot;me.org&quot;, 6, &quot;http://me.org&quot;, 8, &quot;1.2.3.4&quot;);
1489 
1490         // IAN
1491         testOK(&quot;&quot;, pre+&quot;ian1 -ext ian:critical=email:me@me.org&quot;);
1492         testOK(&quot;&quot;, pre+&quot;ian2 -ext ian=uri:http://me.org&quot;);
1493         testOK(&quot;&quot;, pre+&quot;ian3 -ext ian=dns:me.org&quot;);
1494         testOK(&quot;&quot;, pre+&quot;ian4 -ext ian=ip:192.168.0.1&quot;);
1495         testOK(&quot;&quot;, pre+&quot;ian5 -ext ian=oid:1.2.3.4&quot;);
1496         testOK(&quot;&quot;, pre+&quot;ian235 -ext ian=uri:http://me.org,dns:me.org,oid:1.2.3.4&quot;);
1497 
1498         ks = loadStore(&quot;x.jks&quot;, &quot;changeit&quot;, &quot;JKS&quot;);
1499         assertTrue(((X509CertImpl)ks.getCertificate(&quot;ian1&quot;))
1500                 .getIssuerAlternativeNameExtension().isCritical());
1501         assertTrue(!((X509CertImpl)ks.getCertificate(&quot;ian2&quot;))
1502                 .getIssuerAlternativeNameExtension().isCritical());
1503         csan.check(ks, &quot;ian1&quot;, 1, 1, &quot;me@me.org&quot;);
1504         csan.check(ks, &quot;ian2&quot;, 1, 6, &quot;http://me.org&quot;);
1505         csan.check(ks, &quot;ian3&quot;, 1, 2, &quot;me.org&quot;);
1506         csan.check(ks, &quot;ian4&quot;, 1, 7, &quot;192.168.0.1&quot;);
1507         csan.check(ks, &quot;ian5&quot;, 1, 8, &quot;1.2.3.4&quot;);
1508         csan.check(ks, &quot;ian235&quot;, 1, 2, &quot;me.org&quot;, 6, &quot;http://me.org&quot;, 8, &quot;1.2.3.4&quot;);
1509 
1510         // SIA
1511         testOK(&quot;&quot;, pre+&quot;sia1 -ext sia=care:uri:ldap://ca.com/cn=CA&quot;);
1512         testOK(&quot;&quot;, pre+&quot;sia2 -ext sia=ts:email:ts@ca.com&quot;);
1513         testFail(&quot;SIA never critical&quot;, pre +
1514                 &quot;sia3 -ext sia:critical=ts:email:ts@ca.com&quot;);
1515 
1516         ks = loadStore(&quot;x.jks&quot;, &quot;changeit&quot;, &quot;JKS&quot;);
1517         class CheckSia {
1518             void check(KeyStore ks, String alias, int type, Object... items)
1519                     throws Exception {
1520                 int pos = 0;
1521                 System.err.print(&quot;x&quot;);
1522                 AccessDescription[] ads = null;
1523                 if (type == 0) {
1524                     SubjectInfoAccessExtension siae = (SubjectInfoAccessExtension)
1525                             ((X509CertImpl)ks.getCertificate(alias))
1526                             .getExtension(PKIXExtensions.SubjectInfoAccess_Id);
1527                     ads = siae.getAccessDescriptions()
1528                             .toArray(new AccessDescription[0]);
1529                 } else {
1530                     AuthorityInfoAccessExtension aiae =
1531                             (AuthorityInfoAccessExtension)
1532                             ((X509CertImpl)ks.getCertificate(alias))
1533                             .getExtension(PKIXExtensions.AuthInfoAccess_Id);
1534                     ads = aiae.getAccessDescriptions()
1535                             .toArray(new AccessDescription[0]);
1536                 }
1537                 Arrays.sort(ads, new Comparator&lt;AccessDescription&gt;() {
1538                     @Override
1539                     public int compare(AccessDescription o1,
1540                                        AccessDescription o2) {
1541                         return o1.getAccessMethod().toString()
1542                                 .compareTo(o2.getAccessMethod().toString());
1543                     }
1544                 });
1545                 for (AccessDescription ad: ads) {
1546                     if (!ad.getAccessMethod().equals(items[pos++]) ||
1547                             !new Integer(ad.getAccessLocation().getType())
1548                                     .equals(items[pos++])) {
1549                         throw new RuntimeException(&quot;Not same type at &quot; + pos);
1550                     }
1551                     String name = null;
1552                     switch (ad.getAccessLocation().getType()) {
1553                         case 1:
1554                             name = ((RFC822Name)ad.getAccessLocation()
1555                                     .getName()).getName();
1556                             break;
1557                         case 6:
1558                             name = ((URIName)ad.getAccessLocation()
1559                                     .getName()).getURI().toString();
1560                             break;
1561                         default:
1562                             throw new RuntimeException(&quot;Not implemented: &quot; + ad);
1563                     }
1564                     if (!name.equals(items[pos++])) {
1565                         throw new Exception(&quot;Name not same for &quot; + ad +
1566                                 &quot; at pos &quot; + pos);
1567                     }
1568                 }
1569             }
1570         }
1571         CheckSia csia = new CheckSia();
1572         assertTrue(!((X509CertImpl)ks.getCertificate(&quot;sia1&quot;))
1573                 .getExtension(PKIXExtensions.SubjectInfoAccess_Id).isCritical());
1574         csia.check(ks, &quot;sia1&quot;, 0,
1575                 AccessDescription.Ad_CAREPOSITORY_Id, 6, &quot;ldap://ca.com/cn=CA&quot;);
1576         csia.check(ks, &quot;sia2&quot;,
1577                 0, AccessDescription.Ad_TIMESTAMPING_Id, 1, &quot;ts@ca.com&quot;);
1578 
1579         // AIA
1580         testOK(&quot;&quot;, pre+&quot;aia1 -ext aia=cai:uri:ldap://ca.com/cn=CA&quot;);
1581         testOK(&quot;&quot;, pre+&quot;aia2 -ext aia=ocsp:email:ocsp@ca.com&quot;);
1582         testFail(&quot;AIA never critical&quot;, pre +
1583                 &quot;aia3 -ext aia:critical=ts:email:ts@ca.com&quot;);
1584 
1585         ks = loadStore(&quot;x.jks&quot;, &quot;changeit&quot;, &quot;JKS&quot;);
1586         assertTrue(!((X509CertImpl)ks.getCertificate(&quot;aia1&quot;))
1587                 .getExtension(PKIXExtensions.AuthInfoAccess_Id).isCritical());
1588         csia.check(ks, &quot;aia1&quot;, 1,
1589                 AccessDescription.Ad_CAISSUERS_Id, 6, &quot;ldap://ca.com/cn=CA&quot;);
1590         csia.check(ks, &quot;aia2&quot;, 1,
1591                 AccessDescription.Ad_OCSP_Id, 1, &quot;ocsp@ca.com&quot;);
1592 
1593         // OID
1594         testOK(&quot;&quot;, pre+&quot;oid1 -ext 1.2.3:critical=0102&quot;);
1595         testOK(&quot;&quot;, pre+&quot;oid2 -ext 1.2.3&quot;);
1596         testOK(&quot;&quot;, pre+&quot;oid12 -ext 1.2.3 -ext 1.2.4=01:02:03&quot;);
1597 
1598         ks = loadStore(&quot;x.jks&quot;, &quot;changeit&quot;, &quot;JKS&quot;);
1599         class CheckOid {
1600             void check(KeyStore ks, String alias, String oid, byte[] value)
1601                     throws Exception {
1602                 int pos = 0;
1603                 System.err.print(&quot;x&quot;);
1604                 Extension ex = ((X509CertImpl)ks.getCertificate(alias))
1605                         .getExtension(ObjectIdentifier.of(oid));
1606                 if (!Arrays.equals(value, ex.getValue())) {
1607                     throw new RuntimeException(&quot;Not same content in &quot; +
1608                             alias + &quot; for &quot; + oid);
1609                 }
1610             }
1611         }
1612         CheckOid coid = new CheckOid();
1613         assertTrue(((X509CertImpl)ks.getCertificate(&quot;oid1&quot;))
1614                 .getExtension(ObjectIdentifier.of(&quot;1.2.3&quot;)).isCritical());
1615         assertTrue(!((X509CertImpl)ks.getCertificate(&quot;oid2&quot;))
1616                 .getExtension(ObjectIdentifier.of(&quot;1.2.3&quot;)).isCritical());
1617         coid.check(ks, &quot;oid1&quot;, &quot;1.2.3&quot;, new byte[]{1,2});
1618         coid.check(ks, &quot;oid2&quot;, &quot;1.2.3&quot;, new byte[]{});
1619         coid.check(ks, &quot;oid12&quot;, &quot;1.2.3&quot;, new byte[]{});
1620         coid.check(ks, &quot;oid12&quot;, &quot;1.2.4&quot;, new byte[]{1,2,3});
1621 
1622         // honored
1623         testOK(&quot;&quot;, pre+&quot;ca&quot;);
1624         testOK(&quot;&quot;, pre+&quot;a&quot;);
1625         // request: BC,KU,1.2.3,1.2.4,1.2.5
1626         testOK(&quot;&quot;, simple+&quot;-alias a -certreq &quot; +
1627                 &quot;-ext BC=1 -ext KU=crl &quot; +
1628                 &quot;-ext 1.2.3=01 -ext 1.2.4:critical=0102 -ext 1.2.5=010203 &quot; +
1629                 &quot;-rfc -file test.req&quot;);
1630         // printcertreq
1631         testOK(&quot;&quot;, &quot;-printcertreq -file test.req&quot;);
1632         checkPem(&quot;test.req&quot;);
1633         // issue: deny KU, change criticality of 1.2.3 and 1.2.4,
1634         // change content of BC, add 2.3.4
1635         testOK(&quot;&quot;, simple+&quot;-gencert -alias ca -infile test.req -ext &quot; +
1636                 &quot;honored=all,-KU,1.2.3:critical,1.2.4:non-critical &quot; +
1637                 &quot;-ext BC=2 -ext 2.3.4=01020304 &quot; +
1638                 &quot;-debug -rfc -outfile test.cert&quot;);
1639         checkPem(&quot;test.cert&quot;);
1640         testOK(&quot;&quot;, simple+&quot;-importcert -file test.cert -alias a&quot;);
1641         ks = loadStore(&quot;x.jks&quot;, &quot;changeit&quot;, &quot;JKS&quot;);
1642         X509CertImpl a = (X509CertImpl)ks.getCertificate(&quot;a&quot;);
1643         assertTrue(a.getAuthorityKeyIdentifierExtension() != null);
1644         assertTrue(a.getSubjectKeyIdentifierExtension() != null);
1645         assertTrue(a.getKeyUsage() == null);
1646         assertTrue(a.getExtension(ObjectIdentifier.of(&quot;1.2.3&quot;)).isCritical());
1647         assertTrue(!a.getExtension(ObjectIdentifier.of(&quot;1.2.4&quot;)).isCritical());
1648         assertTrue(!a.getExtension(ObjectIdentifier.of(&quot;1.2.5&quot;)).isCritical());
1649         assertTrue(a.getExtensionValue(&quot;1.2.3&quot;).length == 3);
1650         assertTrue(a.getExtensionValue(&quot;1.2.4&quot;).length == 4);
1651         assertTrue(a.getExtensionValue(&quot;1.2.5&quot;).length == 5);
1652         assertTrue(a.getBasicConstraints() == 2);
1653         assertTrue(!a.getExtension(ObjectIdentifier.of(&quot;2.3.4&quot;)).isCritical());
1654         assertTrue(a.getExtensionValue(&quot;2.3.4&quot;).length == 6);
1655 
1656         // 8073181: keytool -ext honored not working correctly
1657         testOK(&quot;&quot;, simple+&quot;-gencert -alias ca -infile test.req -ext &quot; +
1658                 &quot;honored=1.2.3,KU,1.2.4:critical &quot; +
1659                 &quot;-debug -rfc -outfile test2.cert&quot;);
1660         testOK(&quot;&quot;, simple+&quot;-importcert -file test2.cert -alias b&quot;);
1661         ks = loadStore(&quot;x.jks&quot;, &quot;changeit&quot;, &quot;JKS&quot;);
1662         X509CertImpl b = (X509CertImpl)ks.getCertificate(&quot;b&quot;);
1663         assertTrue(!b.getExtension(ObjectIdentifier.of(&quot;1.2.3&quot;)).isCritical());
1664         assertTrue(b.getExtension(ObjectIdentifier.of(&quot;1.2.4&quot;)).isCritical());
1665 
1666         // 8073182: keytool may generate duplicate extensions
1667         testOK(&quot;&quot;, pre+&quot;dup -ext bc=2 -ext 2.5.29.19=30030101FF -ext bc=3&quot;);
1668         ks = loadStore(&quot;x.jks&quot;, &quot;changeit&quot;, &quot;JKS&quot;);
1669         X509CertImpl dup = (X509CertImpl)ks.getCertificate(&quot;dup&quot;);
1670         assertTrue(dup.getBasicConstraints() == 3);
1671 
1672         remove(&quot;x.jks&quot;);
1673         remove(&quot;test.req&quot;);
1674         remove(&quot;test.cert&quot;);
1675     }
1676 
1677     void i18nTest() throws Exception {
1678         //   1.  keytool -help
1679         remove(&quot;x.jks&quot;);
1680         testOK(&quot;&quot;, &quot;-help&quot;);
1681 
1682         //   2. keytool -genkey -keyalg DSA -v -keysize 512 Enter &quot;a&quot; for the keystore
1683         // password. Check error (password too short). Enter &quot;password&quot; for
1684         // the keystore password. Hit &#39;return&#39; for &quot;first and last name&quot;,
1685         // &quot;organizational unit&quot;, &quot;City&quot;, &quot;State&quot;, and &quot;Country Code&quot;.
1686         // Type &quot;yes&quot; when they ask you if everything is correct.
1687         // Type &#39;return&#39; for new key password.
1688         testOK(&quot;a\npassword\npassword\nMe\nHere\nNow\nPlace\nPlace\nUS\nyes\n\n&quot;,
1689                 &quot;-genkey -keyalg DSA -v -keysize 512 -keystore x.jks -storetype JKS&quot;);
1690         //   3. keytool -list -v -storepass password
1691         testOK(&quot;&quot;, &quot;-list -v -storepass password -keystore x.jks -storetype JKS&quot;);
1692         //   4. keytool -list -v Type &quot;a&quot; for the keystore password.
1693         // Check error (wrong keystore password).
1694         testFail(&quot;a\n&quot;, &quot;-list -v -keystore x.jks -storetype JKS&quot;);
1695         assertTrue(ex.indexOf(&quot;password was incorrect&quot;) != -1);
1696         //   5. keytool - -keyalg DSA -v -keysize 512 Enter &quot;password&quot; as the password.
1697         // Check error (alias &#39;mykey&#39; already exists).
1698         testFail(&quot;password\n&quot;, &quot;-genkey -keyalg DSA -v -keysize 512&quot; +
1699                 &quot; -keystore x.jks -storetype JKS&quot;);
1700         assertTrue(ex.indexOf(&quot;alias &lt;mykey&gt; already exists&quot;) != -1);
1701         //   6. keytool -genkey -keyalg DSA -v -keysize 512 -alias mykey2 -storepass password
1702         // Hit &#39;return&#39; for &quot;first and last name&quot;, &quot;organizational unit&quot;, &quot;City&quot;,
1703         // &quot;State&quot;, and &quot;Country Code&quot;. Type &quot;yes&quot; when they ask you if
1704         // everything is correct. Type &#39;return&#39; for new key password.
1705         testOK(&quot;\n\n\n\n\n\nyes\n\n&quot;, &quot;-genkey -keyalg DSA -v -keysize 512 -alias mykey2&quot; +
1706                 &quot; -storepass password -keystore x.jks -storetype JKS&quot;);
1707         //   7. keytool -list -v Type &#39;password&#39; for the store password.
1708         testOK(&quot;password\n&quot;, &quot;-list -v -keystore x.jks -storetype JKS&quot;);
1709         //   8. keytool -keypasswd -v -alias mykey2 -storepass password
1710         // Type &quot;a&quot; for the new key password. Type &quot;aaaaaa&quot; for the new key
1711         // password. Type &quot;bbbbbb&quot; when re-entering the new key password.
1712         // Type &quot;a&quot; for the new key password. Check Error (too many failures).
1713         testFail(&quot;a\naaaaaa\nbbbbbb\na\n&quot;, &quot;-keypasswd -v -alias mykey2&quot; +
1714                 &quot; -storepass password -keystore x.jks -storetype JKS&quot;);
1715         assertTrue(ex.indexOf(&quot;Too many failures - try later&quot;) != -1);
1716         //   9. keytool -keypasswd -v -alias mykey2 -storepass password
1717         // Type &quot;aaaaaa&quot; for the new key password. Type &quot;aaaaaa&quot;
1718         // when re-entering the new key password.
1719         testOK(&quot;aaaaaa\naaaaaa\n&quot;, &quot;-keypasswd -v -alias mykey2 &quot; +
1720                 &quot;-storepass password -keystore x.jks -storetype JKS&quot;);
1721         //  10. keytool -selfcert -v -alias mykey -storepass password
1722         testOK(&quot;&quot;, &quot;-selfcert -v -alias mykey -storepass password &quot; +
1723                 &quot;-keystore x.jks -storetype JKS&quot;);
1724         //  11. keytool -list -v -storepass password
1725         testOK(&quot;&quot;, &quot;-list -v -storepass password -keystore x.jks -storetype JKS&quot;);
1726         //  12. keytool -export -v -alias mykey -file cert -storepass password
1727         remove(&quot;cert&quot;);
1728         testOK(&quot;&quot;, &quot;-export -v -alias mykey -file cert -storepass password &quot; +
1729                 &quot;-keystore x.jks -storetype JKS&quot;);
1730         //  13. keytool -import -v -file cert -storepass password
1731         // Check error (Certificate reply and cert are the same)
1732         testFail(&quot;&quot;, &quot;-import -v -file cert -storepass password&quot; +
1733                 &quot; -keystore x.jks -storetype JKS&quot;);
1734         assertTrue(ex.indexOf(&quot;Certificate reply and certificate&quot; +
1735                 &quot; in keystore are identical&quot;) != -1);
1736         //  14. keytool -printcert -file cert
1737         testOK(&quot;&quot;, &quot;-printcert -file cert -keystore x.jks -storetype JKS&quot;);
1738         remove(&quot;cert&quot;);
1739         //  15. keytool -list -storepass password -addprovider SUN
1740         testOK(&quot;&quot;, &quot;-list -storepass password&quot; +
1741                 &quot; -addprovider SUN&quot; +
1742                 &quot; -keystore x.jks -storetype JKS&quot;);
1743 
1744         //Error tests
1745 
1746         //   1. keytool -storepasswd -storepass password -new abc
1747         // Check error (password too short)
1748         testFail(&quot;&quot;, &quot;-storepasswd -storepass password -new abc&quot;);
1749         assertTrue(ex.indexOf(&quot;New password must be at least 6 characters&quot;) != -1);
1750         // Changed, no NONE needed now
1751         //   2. keytool -list -storetype PKCS11 Check error (-keystore must be NONE)
1752         //testFail(&quot;&quot;, &quot;-list -storetype PKCS11&quot;);
1753         //assertTrue(err.indexOf(&quot;keystore must be NONE&quot;) != -1);
1754         //   3. keytool -storepasswd -storetype PKCS11 -keystore NONE
1755         // Check error (unsupported operation)
1756         testFail(&quot;&quot;, &quot;-storepasswd -storetype PKCS11 -keystore NONE&quot;);
1757         assertTrue(ex.indexOf(&quot;UnsupportedOperationException&quot;) != -1);
1758         //   4. keytool -keypasswd -storetype PKCS11 -keystore NONE
1759         // Check error (unsupported operation)
1760         testFail(&quot;&quot;, &quot;-keypasswd -storetype PKCS11 -keystore NONE&quot;);
1761         assertTrue(ex.indexOf(&quot;UnsupportedOperationException&quot;) != -1);
1762         //   5. keytool -list -protected -storepass password
1763         // Check error (password can not be specified with -protected)
1764         testFail(&quot;&quot;, &quot;-list -protected -storepass password &quot; +
1765                 &quot;-keystore x.jks -storetype JKS&quot;);
1766         assertTrue(ex.indexOf(&quot;if -protected is specified, then&quot;) != -1);
1767         //   6. keytool -keypasswd -protected -keypass password
1768         // Check error (password can not be specified with -protected)
1769         testFail(&quot;&quot;, &quot;-keypasswd -protected -keypass password &quot; +
1770                 &quot;-keystore x.jks -storetype JKS&quot;);
1771         assertTrue(ex.indexOf(&quot;if -protected is specified, then&quot;) != -1);
1772         //   7. keytool -keypasswd -protected -new password
1773         // Check error (password can not be specified with -protected)
1774         testFail(&quot;&quot;, &quot;-keypasswd -protected -new password &quot; +
1775                 &quot;-keystore x.jks -storetype JKS&quot;);
1776         assertTrue(ex.indexOf(&quot;if -protected is specified, then&quot;) != -1);
1777         remove(&quot;x.jks&quot;);
1778     }
1779 
1780     void i18nPKCS11Test() throws Exception {
1781         //PKCS#11 tests
1782 
1783         //   1. sccs edit cert8.db key3.db
1784         //Runtime.getRuntime().exec(&quot;/usr/bin/sccs edit cert8.db key3.db&quot;);
1785         testOK(&quot;&quot;, p11Arg + (&quot;-storepass test12 -genkey -alias genkey&quot; +
1786                 &quot; -dname cn=genkey -keysize 512 -keyalg rsa&quot;));
1787         testOK(&quot;&quot;, p11Arg + &quot;-storepass test12 -list&quot;);
1788         testOK(&quot;&quot;, p11Arg + &quot;-storepass test12 -list -alias genkey&quot;);
1789         testOK(&quot;&quot;, p11Arg +
1790                 &quot;-storepass test12 -certreq -alias genkey -file genkey.certreq&quot;);
1791         testOK(&quot;&quot;, p11Arg +
1792                 &quot;-storepass test12 -export -alias genkey -file genkey.cert&quot;);
1793         testOK(&quot;&quot;, &quot;-printcert -file genkey.cert&quot;);
1794         testOK(&quot;&quot;, p11Arg +
1795                 &quot;-storepass test12 -selfcert -alias genkey -dname cn=selfCert&quot;);
1796         testOK(&quot;&quot;, p11Arg +
1797                 &quot;-storepass test12 -list -alias genkey -v&quot;);
1798         assertTrue(out.indexOf(&quot;Owner: CN=selfCert&quot;) != -1);
1799         //(check that cert subject DN is [cn=selfCert])
1800         testOK(&quot;&quot;, p11Arg + &quot;-storepass test12 -delete -alias genkey&quot;);
1801         testOK(&quot;&quot;, p11Arg + &quot;-storepass test12 -list&quot;);
1802         assertTrue(out.indexOf(&quot;Your keystore contains 0 entries&quot;) != -1);
1803         //(check for empty database listing)
1804         //Runtime.getRuntime().exec(&quot;/usr/bin/sccs unedit cert8.db key3.db&quot;);
1805         remove(&quot;genkey.cert&quot;);
1806         remove(&quot;genkey.certreq&quot;);
1807         //  12. sccs unedit cert8.db key3.db
1808     }
1809 
1810     // tesing new option -srcProviderName
1811     void sszzTest() throws Exception {
1812         testAnyway(&quot;&quot;, NSS_P11_ARG+&quot;-delete -alias nss -storepass test12&quot;);
1813         testAnyway(&quot;&quot;, NZZ_P11_ARG+&quot;-delete -alias nss -storepass test12&quot;);
1814         testOK(&quot;&quot;, NSS_P11_ARG+&quot;-genkeypair -keyalg DSA -dname CN=NSS &quot; +
1815                 &quot;-alias nss -storepass test12&quot;);
1816         testOK(&quot;&quot;, NSS_SRC_P11_ARG + NZZ_P11_ARG +
1817                 &quot;-importkeystore -srcstorepass test12 -deststorepass test12&quot;);
1818         testAnyway(&quot;&quot;, NSS_P11_ARG+&quot;-delete -alias nss -storepass test12&quot;);
1819         testAnyway(&quot;&quot;, NZZ_P11_ARG+&quot;-delete -alias nss -storepass test12&quot;);
1820     }
1821 
1822     public static void main(String[] args) throws Exception {
1823         Locale reservedLocale = Locale.getDefault();
1824         try {
1825             // first test if HumanInputStream really acts like a human being
1826             HumanInputStream.test();
1827             KeyToolTest t = new KeyToolTest();
1828 
1829             if (System.getProperty(&quot;file&quot;) != null) {
1830                 t.sqeTest();
1831                 t.testAll();
1832                 t.i18nTest();
1833                 t.v3extTest(&quot;RSA&quot;);
1834                 t.v3extTest(&quot;DSA&quot;);
1835                 boolean testEC = true;
1836                 try {
1837                     KeyPairGenerator.getInstance(&quot;EC&quot;);
1838                 } catch (NoSuchAlgorithmException nae) {
1839                     testEC = false;
1840                 }
1841                 if (testEC) t.v3extTest(&quot;EC&quot;);
1842             }
1843 
1844             if (System.getProperty(&quot;nss&quot;) != null) {
1845                 t.srcP11Arg = NSS_SRC_P11_ARG;
1846                 t.p11Arg = NSS_P11_ARG;
1847 
1848                 t.testPKCS11();
1849 
1850                 // FAIL:
1851                 // 1. we still don&#39;t have srcprovidername yet
1852                 // 2. cannot store privatekey into NSS keystore
1853                 //    java.security.KeyStoreException: sun.security.pkcs11
1854                 //      .wrapper.PKCS11Exception: CKR_TEMPLATE_INCOMPLETE.
1855                 //t.testPKCS11ImportKeyStore();
1856 
1857                 t.i18nPKCS11Test();
1858                 //FAIL: currently PKCS11-NSS does not support
1859                 // 2 NSS KeyStores to be loaded at the same time
1860                 //t.sszzTest();
1861             }
1862 
1863             if (System.getProperty(&quot;solaris&quot;) != null) {
1864                 // For Solaris Cryptography Framework
1865                 t.srcP11Arg = SUN_SRC_P11_ARG;
1866                 t.p11Arg = SUN_P11_ARG;
1867                 t.testPKCS11();
1868                 t.testPKCS11ImportKeyStore();
1869                 t.i18nPKCS11Test();
1870             }
1871 
1872             System.out.println(&quot;Test pass!!!&quot;);
1873         } finally {
1874             // restore the reserved locale
1875             Locale.setDefault(reservedLocale);
1876         }
1877     }
1878 }
1879 
1880 class TestException extends Exception {
1881     public TestException(String e) {
1882         super(e);
1883     }
1884 }
1885 
1886 /**
1887  * HumanInputStream tries to act like a human sitting in front of a computer
1888  * terminal typing on the keyboard while the keytool program is running.
1889  *
1890  * keytool has called InputStream.read() and BufferedReader.readLine() in
1891  * various places. a call to B.readLine() will try to buffer as much input as
1892  * possible. Thus, a trivial InputStream will find it impossible to feed
1893  * anything to I.read() after a B.readLine() call.
1894  *
1895  * This is why i create HumanInputStream, which will only send a single line
1896  * to B.readLine(), no more, no less, and the next I.read() can have a chance
1897  * to read the exact character right after &quot;\n&quot;.
1898  *
1899  * I don&#39;t know why HumanInputStream works.
1900  */
1901 class HumanInputStream extends InputStream {
1902     byte[] src;
1903     int pos;
1904     int length;
1905     boolean inLine;
1906     int stopIt;
1907 
1908     public HumanInputStream(String input) {
1909         src = input.getBytes();
1910         pos = 0;
1911         length = src.length;
1912         stopIt = 0;
1913         inLine = false;
1914     }
1915 
1916     // the trick: when called through read(byte[], int, int),
1917     // return -1 twice after &quot;\n&quot;
1918 
1919     @Override public int read() throws IOException {
1920         int re;
1921         if(pos &lt; length) {
1922             re = src[pos];
1923             if(inLine) {
1924                 if(stopIt &gt; 0) {
1925                     stopIt--;
1926                     re = -1;
1927                 } else {
1928                     if(re == &#39;\n&#39;) {
1929                         stopIt = 2;
1930                     }
1931                     pos++;
1932                 }
1933             } else {
1934                 pos++;
1935             }
1936         } else {
1937             re = -1;//throw new IOException(&quot;NO MORE TO READ&quot;);
1938         }
1939         //if (re &lt; 32) System.err.printf(&quot;[%02d]&quot;, re);
1940         //else System.err.printf(&quot;[%c]&quot;, (char)re);
1941         return re;
1942     }
1943     @Override public int read(byte[] buffer, int offset, int len) {
1944         inLine = true;
1945         try {
1946             int re = super.read(buffer, offset, len);
1947             return re;
1948         } catch(Exception e) {
1949             throw new RuntimeException(&quot;HumanInputStream error&quot;);
1950         } finally {
1951             inLine = false;
1952         }
1953     }
1954     @Override public int available() {
1955         if(pos &lt; length) return 1;
1956         return 0;
1957     }
1958 
1959     // test part
1960     static void assertTrue(boolean bool) {
1961         if(!bool)
1962             throw new RuntimeException();
1963     }
1964 
1965     public static void test() throws Exception {
1966 
1967         class Tester {
1968             HumanInputStream is;
1969             BufferedReader reader;
1970             Tester(String s) {
1971                 is = new HumanInputStream(s);
1972                 reader = new BufferedReader(new InputStreamReader(is));
1973             }
1974 
1975             // three kinds of test method
1976             // 1. read byte by byte from InputStream
1977             void testStreamReadOnce(int expection) throws Exception {
1978                 assertTrue(is.read() == expection);
1979             }
1980             void testStreamReadMany(String expection) throws Exception {
1981                 char[] keys = expection.toCharArray();
1982                 for(int i=0; i&lt;keys.length; i++) {
1983                     assertTrue(is.read() == keys[i]);
1984                 }
1985             }
1986             // 2. read a line with a newly created Reader
1987             void testReaderReadline(String expection) throws Exception {
1988                 String s = new BufferedReader(new InputStreamReader(is)).readLine();
1989                 if(s == null) assertTrue(expection == null);
1990                 else assertTrue(s.equals(expection));
1991             }
1992             // 3. read a line with the old Reader
1993             void testReaderReadline2(String expection) throws Exception  {
1994                 String s = reader.readLine();
1995                 if(s == null) assertTrue(expection == null);
1996                 else assertTrue(s.equals(expection));
1997             }
1998         }
1999 
2000         Tester test;
2001 
2002         test = new Tester(&quot;111\n222\n\n444\n\n&quot;);
2003         test.testReaderReadline(&quot;111&quot;);
2004         test.testReaderReadline(&quot;222&quot;);
2005         test.testReaderReadline(&quot;&quot;);
2006         test.testReaderReadline(&quot;444&quot;);
2007         test.testReaderReadline(&quot;&quot;);
2008         test.testReaderReadline(null);
2009 
2010         test = new Tester(&quot;111\n222\n\n444\n\n&quot;);
2011         test.testReaderReadline2(&quot;111&quot;);
2012         test.testReaderReadline2(&quot;222&quot;);
2013         test.testReaderReadline2(&quot;&quot;);
2014         test.testReaderReadline2(&quot;444&quot;);
2015         test.testReaderReadline2(&quot;&quot;);
2016         test.testReaderReadline2(null);
2017 
2018         test = new Tester(&quot;111\n222\n\n444\n\n&quot;);
2019         test.testReaderReadline2(&quot;111&quot;);
2020         test.testReaderReadline(&quot;222&quot;);
2021         test.testReaderReadline2(&quot;&quot;);
2022         test.testReaderReadline2(&quot;444&quot;);
2023         test.testReaderReadline(&quot;&quot;);
2024         test.testReaderReadline2(null);
2025 
2026         test = new Tester(&quot;1\n2&quot;);
2027         test.testStreamReadMany(&quot;1\n2&quot;);
2028         test.testStreamReadOnce(-1);
2029 
2030         test = new Tester(&quot;12\n234&quot;);
2031         test.testStreamReadOnce(&#39;1&#39;);
2032         test.testReaderReadline(&quot;2&quot;);
2033         test.testStreamReadOnce(&#39;2&#39;);
2034         test.testReaderReadline2(&quot;34&quot;);
2035         test.testReaderReadline2(null);
2036 
2037         test = new Tester(&quot;changeit\n&quot;);
2038         test.testStreamReadMany(&quot;changeit\n&quot;);
2039         test.testReaderReadline(null);
2040 
2041         test = new Tester(&quot;changeit\nName\nCountry\nYes\n&quot;);
2042         test.testStreamReadMany(&quot;changeit\n&quot;);
2043         test.testReaderReadline(&quot;Name&quot;);
2044         test.testReaderReadline(&quot;Country&quot;);
2045         test.testReaderReadline(&quot;Yes&quot;);
2046         test.testReaderReadline(null);
2047 
2048         test = new Tester(&quot;Me\nHere\n&quot;);
2049         test.testReaderReadline2(&quot;Me&quot;);
2050         test.testReaderReadline2(&quot;Here&quot;);
2051     }
2052 }
    </pre>
  </body>
</html>