<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff test/jdk/sun/security/tools/keytool/KeyToolTest.java</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
  </head>
<body>
<center><a href="../jarsigner/TimestampCheck.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="../../util/Oid/OidEquals.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>test/jdk/sun/security/tools/keytool/KeyToolTest.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
   1 /*
<span class="line-modified">   2  * Copyright (c) 2005, 2019, Oracle and/or its affiliates. All rights reserved.</span>
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.
   8  *
   9  * This code is distributed in the hope that it will be useful, but WITHOUT
  10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  */
  23 
  24 /*
  25  * @test
<span class="line-modified">  26  * @bug 6251120 8231950</span>
  27  * @summary Testing keytool
  28  *
  29  * Run through autotest.sh and manualtest.sh
  30  *
  31  * Testing non-PKCS11 keystores:
  32  *       echo | java -Dfile KeyToolTest
  33  *
  34  * Testing NSS PKCS11 keystores:
  35  *       # testing NSS
  36  *       # make sure the NSS db files are in current directory and writable
  37  *       echo | java -Dnss -Dnss.lib=/path/to/libsoftokn3.so KeyToolTest
  38  *
  39  * Testing Solaris Cryptography Framework PKCS11 keystores:
  40  *       # make sure you&#39;ve already run pktool and set test12 as pin
  41  *       echo | java -Dsolaris KeyToolTest
  42  *
  43  * ATTENTION:
  44  * Exception in thread &quot;main&quot; java.security.ProviderException:
  45  *   sun.security.pkcs11.wrapper.PKCS11Exception: CKR_KEY_SIZE_RANGE
  46  *       at sun.security.pkcs11.P11Signature.engineSign(P11Signature.java:420)
</pre>
<hr />
<pre>
1585         ks = loadStore(&quot;x.jks&quot;, &quot;changeit&quot;, &quot;JKS&quot;);
1586         assertTrue(!((X509CertImpl)ks.getCertificate(&quot;aia1&quot;))
1587                 .getExtension(PKIXExtensions.AuthInfoAccess_Id).isCritical());
1588         csia.check(ks, &quot;aia1&quot;, 1,
1589                 AccessDescription.Ad_CAISSUERS_Id, 6, &quot;ldap://ca.com/cn=CA&quot;);
1590         csia.check(ks, &quot;aia2&quot;, 1,
1591                 AccessDescription.Ad_OCSP_Id, 1, &quot;ocsp@ca.com&quot;);
1592 
1593         // OID
1594         testOK(&quot;&quot;, pre+&quot;oid1 -ext 1.2.3:critical=0102&quot;);
1595         testOK(&quot;&quot;, pre+&quot;oid2 -ext 1.2.3&quot;);
1596         testOK(&quot;&quot;, pre+&quot;oid12 -ext 1.2.3 -ext 1.2.4=01:02:03&quot;);
1597 
1598         ks = loadStore(&quot;x.jks&quot;, &quot;changeit&quot;, &quot;JKS&quot;);
1599         class CheckOid {
1600             void check(KeyStore ks, String alias, String oid, byte[] value)
1601                     throws Exception {
1602                 int pos = 0;
1603                 System.err.print(&quot;x&quot;);
1604                 Extension ex = ((X509CertImpl)ks.getCertificate(alias))
<span class="line-modified">1605                         .getExtension(new ObjectIdentifier(oid));</span>
1606                 if (!Arrays.equals(value, ex.getValue())) {
1607                     throw new RuntimeException(&quot;Not same content in &quot; +
1608                             alias + &quot; for &quot; + oid);
1609                 }
1610             }
1611         }
1612         CheckOid coid = new CheckOid();
1613         assertTrue(((X509CertImpl)ks.getCertificate(&quot;oid1&quot;))
<span class="line-modified">1614                 .getExtension(new ObjectIdentifier(&quot;1.2.3&quot;)).isCritical());</span>
1615         assertTrue(!((X509CertImpl)ks.getCertificate(&quot;oid2&quot;))
<span class="line-modified">1616                 .getExtension(new ObjectIdentifier(&quot;1.2.3&quot;)).isCritical());</span>
1617         coid.check(ks, &quot;oid1&quot;, &quot;1.2.3&quot;, new byte[]{1,2});
1618         coid.check(ks, &quot;oid2&quot;, &quot;1.2.3&quot;, new byte[]{});
1619         coid.check(ks, &quot;oid12&quot;, &quot;1.2.3&quot;, new byte[]{});
1620         coid.check(ks, &quot;oid12&quot;, &quot;1.2.4&quot;, new byte[]{1,2,3});
1621 
1622         // honored
1623         testOK(&quot;&quot;, pre+&quot;ca&quot;);
1624         testOK(&quot;&quot;, pre+&quot;a&quot;);
1625         // request: BC,KU,1.2.3,1.2.4,1.2.5
1626         testOK(&quot;&quot;, simple+&quot;-alias a -certreq &quot; +
1627                 &quot;-ext BC=1 -ext KU=crl &quot; +
1628                 &quot;-ext 1.2.3=01 -ext 1.2.4:critical=0102 -ext 1.2.5=010203 &quot; +
1629                 &quot;-rfc -file test.req&quot;);
1630         // printcertreq
1631         testOK(&quot;&quot;, &quot;-printcertreq -file test.req&quot;);
1632         checkPem(&quot;test.req&quot;);
1633         // issue: deny KU, change criticality of 1.2.3 and 1.2.4,
1634         // change content of BC, add 2.3.4
1635         testOK(&quot;&quot;, simple+&quot;-gencert -alias ca -infile test.req -ext &quot; +
1636                 &quot;honored=all,-KU,1.2.3:critical,1.2.4:non-critical &quot; +
1637                 &quot;-ext BC=2 -ext 2.3.4=01020304 &quot; +
1638                 &quot;-debug -rfc -outfile test.cert&quot;);
1639         checkPem(&quot;test.cert&quot;);
1640         testOK(&quot;&quot;, simple+&quot;-importcert -file test.cert -alias a&quot;);
1641         ks = loadStore(&quot;x.jks&quot;, &quot;changeit&quot;, &quot;JKS&quot;);
1642         X509CertImpl a = (X509CertImpl)ks.getCertificate(&quot;a&quot;);
1643         assertTrue(a.getAuthorityKeyIdentifierExtension() != null);
1644         assertTrue(a.getSubjectKeyIdentifierExtension() != null);
1645         assertTrue(a.getKeyUsage() == null);
<span class="line-modified">1646         assertTrue(a.getExtension(new ObjectIdentifier(&quot;1.2.3&quot;)).isCritical());</span>
<span class="line-modified">1647         assertTrue(!a.getExtension(new ObjectIdentifier(&quot;1.2.4&quot;)).isCritical());</span>
<span class="line-modified">1648         assertTrue(!a.getExtension(new ObjectIdentifier(&quot;1.2.5&quot;)).isCritical());</span>
1649         assertTrue(a.getExtensionValue(&quot;1.2.3&quot;).length == 3);
1650         assertTrue(a.getExtensionValue(&quot;1.2.4&quot;).length == 4);
1651         assertTrue(a.getExtensionValue(&quot;1.2.5&quot;).length == 5);
1652         assertTrue(a.getBasicConstraints() == 2);
<span class="line-modified">1653         assertTrue(!a.getExtension(new ObjectIdentifier(&quot;2.3.4&quot;)).isCritical());</span>
1654         assertTrue(a.getExtensionValue(&quot;2.3.4&quot;).length == 6);
1655 
1656         // 8073181: keytool -ext honored not working correctly
1657         testOK(&quot;&quot;, simple+&quot;-gencert -alias ca -infile test.req -ext &quot; +
1658                 &quot;honored=1.2.3,KU,1.2.4:critical &quot; +
1659                 &quot;-debug -rfc -outfile test2.cert&quot;);
1660         testOK(&quot;&quot;, simple+&quot;-importcert -file test2.cert -alias b&quot;);
1661         ks = loadStore(&quot;x.jks&quot;, &quot;changeit&quot;, &quot;JKS&quot;);
1662         X509CertImpl b = (X509CertImpl)ks.getCertificate(&quot;b&quot;);
<span class="line-modified">1663         assertTrue(!b.getExtension(new ObjectIdentifier(&quot;1.2.3&quot;)).isCritical());</span>
<span class="line-modified">1664         assertTrue(b.getExtension(new ObjectIdentifier(&quot;1.2.4&quot;)).isCritical());</span>
1665 
1666         // 8073182: keytool may generate duplicate extensions
1667         testOK(&quot;&quot;, pre+&quot;dup -ext bc=2 -ext 2.5.29.19=30030101FF -ext bc=3&quot;);
1668         ks = loadStore(&quot;x.jks&quot;, &quot;changeit&quot;, &quot;JKS&quot;);
1669         X509CertImpl dup = (X509CertImpl)ks.getCertificate(&quot;dup&quot;);
1670         assertTrue(dup.getBasicConstraints() == 3);
1671 
1672         remove(&quot;x.jks&quot;);
1673         remove(&quot;test.req&quot;);
1674         remove(&quot;test.cert&quot;);
1675     }
1676 
1677     void i18nTest() throws Exception {
1678         //   1.  keytool -help
1679         remove(&quot;x.jks&quot;);
1680         testOK(&quot;&quot;, &quot;-help&quot;);
1681 
1682         //   2. keytool -genkey -keyalg DSA -v -keysize 512 Enter &quot;a&quot; for the keystore
1683         // password. Check error (password too short). Enter &quot;password&quot; for
1684         // the keystore password. Hit &#39;return&#39; for &quot;first and last name&quot;,
</pre>
</td>
<td>
<hr />
<pre>
   1 /*
<span class="line-modified">   2  * Copyright (c) 2005, 2020, Oracle and/or its affiliates. All rights reserved.</span>
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.
   8  *
   9  * This code is distributed in the hope that it will be useful, but WITHOUT
  10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  */
  23 
  24 /*
  25  * @test
<span class="line-modified">  26  * @bug 6251120 8231950 8242151</span>
  27  * @summary Testing keytool
  28  *
  29  * Run through autotest.sh and manualtest.sh
  30  *
  31  * Testing non-PKCS11 keystores:
  32  *       echo | java -Dfile KeyToolTest
  33  *
  34  * Testing NSS PKCS11 keystores:
  35  *       # testing NSS
  36  *       # make sure the NSS db files are in current directory and writable
  37  *       echo | java -Dnss -Dnss.lib=/path/to/libsoftokn3.so KeyToolTest
  38  *
  39  * Testing Solaris Cryptography Framework PKCS11 keystores:
  40  *       # make sure you&#39;ve already run pktool and set test12 as pin
  41  *       echo | java -Dsolaris KeyToolTest
  42  *
  43  * ATTENTION:
  44  * Exception in thread &quot;main&quot; java.security.ProviderException:
  45  *   sun.security.pkcs11.wrapper.PKCS11Exception: CKR_KEY_SIZE_RANGE
  46  *       at sun.security.pkcs11.P11Signature.engineSign(P11Signature.java:420)
</pre>
<hr />
<pre>
1585         ks = loadStore(&quot;x.jks&quot;, &quot;changeit&quot;, &quot;JKS&quot;);
1586         assertTrue(!((X509CertImpl)ks.getCertificate(&quot;aia1&quot;))
1587                 .getExtension(PKIXExtensions.AuthInfoAccess_Id).isCritical());
1588         csia.check(ks, &quot;aia1&quot;, 1,
1589                 AccessDescription.Ad_CAISSUERS_Id, 6, &quot;ldap://ca.com/cn=CA&quot;);
1590         csia.check(ks, &quot;aia2&quot;, 1,
1591                 AccessDescription.Ad_OCSP_Id, 1, &quot;ocsp@ca.com&quot;);
1592 
1593         // OID
1594         testOK(&quot;&quot;, pre+&quot;oid1 -ext 1.2.3:critical=0102&quot;);
1595         testOK(&quot;&quot;, pre+&quot;oid2 -ext 1.2.3&quot;);
1596         testOK(&quot;&quot;, pre+&quot;oid12 -ext 1.2.3 -ext 1.2.4=01:02:03&quot;);
1597 
1598         ks = loadStore(&quot;x.jks&quot;, &quot;changeit&quot;, &quot;JKS&quot;);
1599         class CheckOid {
1600             void check(KeyStore ks, String alias, String oid, byte[] value)
1601                     throws Exception {
1602                 int pos = 0;
1603                 System.err.print(&quot;x&quot;);
1604                 Extension ex = ((X509CertImpl)ks.getCertificate(alias))
<span class="line-modified">1605                         .getExtension(ObjectIdentifier.of(oid));</span>
1606                 if (!Arrays.equals(value, ex.getValue())) {
1607                     throw new RuntimeException(&quot;Not same content in &quot; +
1608                             alias + &quot; for &quot; + oid);
1609                 }
1610             }
1611         }
1612         CheckOid coid = new CheckOid();
1613         assertTrue(((X509CertImpl)ks.getCertificate(&quot;oid1&quot;))
<span class="line-modified">1614                 .getExtension(ObjectIdentifier.of(&quot;1.2.3&quot;)).isCritical());</span>
1615         assertTrue(!((X509CertImpl)ks.getCertificate(&quot;oid2&quot;))
<span class="line-modified">1616                 .getExtension(ObjectIdentifier.of(&quot;1.2.3&quot;)).isCritical());</span>
1617         coid.check(ks, &quot;oid1&quot;, &quot;1.2.3&quot;, new byte[]{1,2});
1618         coid.check(ks, &quot;oid2&quot;, &quot;1.2.3&quot;, new byte[]{});
1619         coid.check(ks, &quot;oid12&quot;, &quot;1.2.3&quot;, new byte[]{});
1620         coid.check(ks, &quot;oid12&quot;, &quot;1.2.4&quot;, new byte[]{1,2,3});
1621 
1622         // honored
1623         testOK(&quot;&quot;, pre+&quot;ca&quot;);
1624         testOK(&quot;&quot;, pre+&quot;a&quot;);
1625         // request: BC,KU,1.2.3,1.2.4,1.2.5
1626         testOK(&quot;&quot;, simple+&quot;-alias a -certreq &quot; +
1627                 &quot;-ext BC=1 -ext KU=crl &quot; +
1628                 &quot;-ext 1.2.3=01 -ext 1.2.4:critical=0102 -ext 1.2.5=010203 &quot; +
1629                 &quot;-rfc -file test.req&quot;);
1630         // printcertreq
1631         testOK(&quot;&quot;, &quot;-printcertreq -file test.req&quot;);
1632         checkPem(&quot;test.req&quot;);
1633         // issue: deny KU, change criticality of 1.2.3 and 1.2.4,
1634         // change content of BC, add 2.3.4
1635         testOK(&quot;&quot;, simple+&quot;-gencert -alias ca -infile test.req -ext &quot; +
1636                 &quot;honored=all,-KU,1.2.3:critical,1.2.4:non-critical &quot; +
1637                 &quot;-ext BC=2 -ext 2.3.4=01020304 &quot; +
1638                 &quot;-debug -rfc -outfile test.cert&quot;);
1639         checkPem(&quot;test.cert&quot;);
1640         testOK(&quot;&quot;, simple+&quot;-importcert -file test.cert -alias a&quot;);
1641         ks = loadStore(&quot;x.jks&quot;, &quot;changeit&quot;, &quot;JKS&quot;);
1642         X509CertImpl a = (X509CertImpl)ks.getCertificate(&quot;a&quot;);
1643         assertTrue(a.getAuthorityKeyIdentifierExtension() != null);
1644         assertTrue(a.getSubjectKeyIdentifierExtension() != null);
1645         assertTrue(a.getKeyUsage() == null);
<span class="line-modified">1646         assertTrue(a.getExtension(ObjectIdentifier.of(&quot;1.2.3&quot;)).isCritical());</span>
<span class="line-modified">1647         assertTrue(!a.getExtension(ObjectIdentifier.of(&quot;1.2.4&quot;)).isCritical());</span>
<span class="line-modified">1648         assertTrue(!a.getExtension(ObjectIdentifier.of(&quot;1.2.5&quot;)).isCritical());</span>
1649         assertTrue(a.getExtensionValue(&quot;1.2.3&quot;).length == 3);
1650         assertTrue(a.getExtensionValue(&quot;1.2.4&quot;).length == 4);
1651         assertTrue(a.getExtensionValue(&quot;1.2.5&quot;).length == 5);
1652         assertTrue(a.getBasicConstraints() == 2);
<span class="line-modified">1653         assertTrue(!a.getExtension(ObjectIdentifier.of(&quot;2.3.4&quot;)).isCritical());</span>
1654         assertTrue(a.getExtensionValue(&quot;2.3.4&quot;).length == 6);
1655 
1656         // 8073181: keytool -ext honored not working correctly
1657         testOK(&quot;&quot;, simple+&quot;-gencert -alias ca -infile test.req -ext &quot; +
1658                 &quot;honored=1.2.3,KU,1.2.4:critical &quot; +
1659                 &quot;-debug -rfc -outfile test2.cert&quot;);
1660         testOK(&quot;&quot;, simple+&quot;-importcert -file test2.cert -alias b&quot;);
1661         ks = loadStore(&quot;x.jks&quot;, &quot;changeit&quot;, &quot;JKS&quot;);
1662         X509CertImpl b = (X509CertImpl)ks.getCertificate(&quot;b&quot;);
<span class="line-modified">1663         assertTrue(!b.getExtension(ObjectIdentifier.of(&quot;1.2.3&quot;)).isCritical());</span>
<span class="line-modified">1664         assertTrue(b.getExtension(ObjectIdentifier.of(&quot;1.2.4&quot;)).isCritical());</span>
1665 
1666         // 8073182: keytool may generate duplicate extensions
1667         testOK(&quot;&quot;, pre+&quot;dup -ext bc=2 -ext 2.5.29.19=30030101FF -ext bc=3&quot;);
1668         ks = loadStore(&quot;x.jks&quot;, &quot;changeit&quot;, &quot;JKS&quot;);
1669         X509CertImpl dup = (X509CertImpl)ks.getCertificate(&quot;dup&quot;);
1670         assertTrue(dup.getBasicConstraints() == 3);
1671 
1672         remove(&quot;x.jks&quot;);
1673         remove(&quot;test.req&quot;);
1674         remove(&quot;test.cert&quot;);
1675     }
1676 
1677     void i18nTest() throws Exception {
1678         //   1.  keytool -help
1679         remove(&quot;x.jks&quot;);
1680         testOK(&quot;&quot;, &quot;-help&quot;);
1681 
1682         //   2. keytool -genkey -keyalg DSA -v -keysize 512 Enter &quot;a&quot; for the keystore
1683         // password. Check error (password too short). Enter &quot;password&quot; for
1684         // the keystore password. Hit &#39;return&#39; for &quot;first and last name&quot;,
</pre>
</td>
</tr>
</table>
<center><a href="../jarsigner/TimestampCheck.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="../../util/Oid/OidEquals.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>