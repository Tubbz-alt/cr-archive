<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff test/jdk/sun/security/tools/jarsigner/TimestampCheck.java</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
  </head>
<body>
<center><a href="../../pkcs12/ParamsTest.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="../keytool/KeyToolTest.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>test/jdk/sun/security/tools/jarsigner/TimestampCheck.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  46 import java.util.jar.JarEntry;
  47 import java.util.jar.JarFile;
  48 
  49 import jdk.test.lib.SecurityTools;
  50 import jdk.test.lib.process.OutputAnalyzer;
  51 import jdk.test.lib.util.JarUtils;
  52 import sun.security.pkcs.ContentInfo;
  53 import sun.security.pkcs.PKCS7;
  54 import sun.security.pkcs.PKCS9Attribute;
  55 import sun.security.pkcs.SignerInfo;
  56 import sun.security.timestamp.TimestampToken;
  57 import sun.security.util.DerOutputStream;
  58 import sun.security.util.DerValue;
  59 import sun.security.util.ObjectIdentifier;
  60 import sun.security.x509.AlgorithmId;
  61 import sun.security.x509.X500Name;
  62 
  63 /*
  64  * @test
  65  * @bug 6543842 6543440 6939248 8009636 8024302 8163304 8169911 8180289 8172404

  66  * @summary checking response of timestamp
  67  * @modules java.base/sun.security.pkcs
  68  *          java.base/sun.security.timestamp
  69  *          java.base/sun.security.x509
  70  *          java.base/sun.security.util
  71  *          java.base/sun.security.tools.keytool
  72  * @library /lib/testlibrary
  73  * @library /test/lib
  74  * @build jdk.test.lib.util.JarUtils
  75  *        jdk.test.lib.SecurityTools
  76  *        jdk.test.lib.Utils
  77  *        jdk.test.lib.Asserts
  78  *        jdk.test.lib.JDKToolFinder
  79  *        jdk.test.lib.JDKToolLauncher
  80  *        jdk.test.lib.Platform
  81  *        jdk.test.lib.process.*
  82  * @compile -XDignore.symbol.file TimestampCheck.java
  83  * @run main/timeout=600 TimestampCheck
  84  */
  85 public class TimestampCheck {
</pre>
<hr />
<pre>
 117                 t.sendResponseHeaders(500, 0);
 118             }
 119             t.close();
 120         }
 121 
 122         /**
 123          * @param input The data to sign
 124          * @param path different cases to simulate, impl on URL path
 125          * @returns the signed
 126          */
 127         byte[] sign(byte[] input, String path) throws Exception {
 128 
 129             DerValue value = new DerValue(input);
 130             System.out.println(&quot;#\n# Incoming Request\n===================&quot;);
 131             System.out.println(&quot;# Version: &quot; + value.data.getInteger());
 132             DerValue messageImprint = value.data.getDerValue();
 133             AlgorithmId aid = AlgorithmId.parse(
 134                     messageImprint.data.getDerValue());
 135             System.out.println(&quot;# AlgorithmId: &quot; + aid);
 136 
<span class="line-modified"> 137             ObjectIdentifier policyId = new ObjectIdentifier(defaultPolicyId);</span>
 138             BigInteger nonce = null;
 139             while (value.data.available() &gt; 0) {
 140                 DerValue v = value.data.getDerValue();
 141                 if (v.tag == DerValue.tag_Integer) {
 142                     nonce = v.getBigInteger();
 143                     System.out.println(&quot;# nonce: &quot; + nonce);
 144                 } else if (v.tag == DerValue.tag_Boolean) {
 145                     System.out.println(&quot;# certReq: &quot; + v.getBoolean());
 146                 } else if (v.tag == DerValue.tag_ObjectId) {
 147                     policyId = v.getOID();
 148                     System.out.println(&quot;# PolicyID: &quot; + policyId);
 149                 }
 150             }
 151 
 152             System.out.println(&quot;#\n# Response\n===================&quot;);
 153             KeyStore ks = KeyStore.getInstance(
 154                     new File(keystore), &quot;changeit&quot;.toCharArray());
 155 
 156             // If path starts with &quot;ts&quot;, use the TSA it points to.
 157             // Otherwise, always use &quot;ts&quot;.
 158             String alias = path.startsWith(&quot;ts&quot;) ? path : &quot;ts&quot;;
 159 
 160             if (path.equals(&quot;diffpolicy&quot;)) {
<span class="line-modified"> 161                 policyId = new ObjectIdentifier(defaultPolicyId);</span>
 162             }
 163 
 164             DerOutputStream statusInfo = new DerOutputStream();
 165             statusInfo.putInteger(0);
 166 
 167             AlgorithmId[] algorithms = {aid};
 168             Certificate[] chain = ks.getCertificateChain(alias);
 169             X509Certificate[] signerCertificateChain;
 170             X509Certificate signer = (X509Certificate)chain[0];
 171 
 172             if (path.equals(&quot;fullchain&quot;)) {   // Only case 5 uses full chain
 173                 signerCertificateChain = new X509Certificate[chain.length];
 174                 for (int i=0; i&lt;chain.length; i++) {
 175                     signerCertificateChain[i] = (X509Certificate)chain[i];
 176                 }
 177             } else if (path.equals(&quot;nocert&quot;)) {
 178                 signerCertificateChain = new X509Certificate[0];
 179             } else {
 180                 signerCertificateChain = new X509Certificate[1];
 181                 signerCertificateChain[0] = (X509Certificate)chain[0];
</pre>
<hr />
<pre>
 213             } else if (path.equals(&quot;nononce&quot;)) {
 214                 // no noce
 215             } else {
 216                 tst.putInteger(nonce);
 217             }
 218 
 219             DerOutputStream tstInfo = new DerOutputStream();
 220             tstInfo.write(DerValue.tag_Sequence, tst);
 221 
 222             DerOutputStream tstInfo2 = new DerOutputStream();
 223             tstInfo2.putOctetString(tstInfo.toByteArray());
 224 
 225             // Always use the same algorithm at timestamp signing
 226             // so it is different from the hash algorithm.
 227             String sigAlg = &quot;SHA256withRSA&quot;;
 228             Signature sig = Signature.getInstance(sigAlg);
 229             sig.initSign((PrivateKey)(ks.getKey(
 230                     alias, &quot;changeit&quot;.toCharArray())));
 231             sig.update(tstInfo.toByteArray());
 232 
<span class="line-modified"> 233             ContentInfo contentInfo = new ContentInfo(new ObjectIdentifier(</span>
 234                     &quot;1.2.840.113549.1.9.16.1.4&quot;),
 235                     new DerValue(tstInfo2.toByteArray()));
 236 
 237             System.out.println(&quot;# Signing...&quot;);
 238             System.out.println(&quot;# &quot; + new X500Name(signer
 239                     .getIssuerX500Principal().getName()));
 240             System.out.println(&quot;# &quot; + signer.getSerialNumber());
 241 
 242             SignerInfo signerInfo = new SignerInfo(
 243                     new X500Name(signer.getIssuerX500Principal().getName()),
 244                     signer.getSerialNumber(),
 245                     AlgorithmId.get(AlgorithmId.getDigAlgFromSigAlg(sigAlg)),
 246                     AlgorithmId.get(AlgorithmId.getEncAlgFromSigAlg(sigAlg)),
 247                     sig.sign());
 248 
 249             SignerInfo[] signerInfos = {signerInfo};
 250             PKCS7 p7 = new PKCS7(algorithms, contentInfo,
 251                     signerCertificateChain, signerInfos);
 252             ByteArrayOutputStream p7out = new ByteArrayOutputStream();
 253             p7.encodeSignedData(p7out);
</pre>
<hr />
<pre>
 428                 signVerbose(null, &quot;unsigned.jar&quot;, &quot;sha1alg.jar&quot;, &quot;signer&quot;,
 429                         &quot;-strict&quot;, &quot;-digestalg&quot;, &quot;SHA-1&quot;)
 430                         .shouldHaveExitValue(0)
 431                         .shouldContain(&quot;jar signed, with signer errors&quot;)
 432                         .shouldMatch(&quot;SHA-1.*-digestalg.*will be disabled&quot;);
 433                 verify(&quot;sha1alg.jar&quot;, &quot;-strict&quot;)
 434                         .shouldHaveExitValue(0)
 435                         .shouldContain(&quot;jar verified, with signer errors&quot;)
 436                         .shouldContain(&quot;SHA-1 digest algorithm is considered a security risk&quot;)
 437                         .shouldContain(&quot;This algorithm will be disabled in a future update&quot;)
 438                         .shouldNotContain(&quot;is disabled&quot;);
 439 
 440                 sign(&quot;sha1tsaalg&quot;, &quot;-tsadigestalg&quot;, &quot;SHA-1&quot;, &quot;-strict&quot;)
 441                         .shouldHaveExitValue(0)
 442                         .shouldContain(&quot;jar signed, with signer errors&quot;)
 443                         .shouldMatch(&quot;SHA-1.*-tsadigestalg.*will be disabled&quot;)
 444                         .shouldNotContain(&quot;is disabled&quot;);
 445                 verify(&quot;sha1tsaalg.jar&quot;, &quot;-strict&quot;)
 446                         .shouldHaveExitValue(0)
 447                         .shouldContain(&quot;jar verified, with signer errors&quot;)
<span class="line-modified"> 448                         .shouldContain(&quot;SHA-1 digest algorithm is considered a security risk&quot;)</span>
 449                         .shouldNotContain(&quot;is disabled&quot;);
 450 
 451                 // Disabled algorithms
 452                 sign(&quot;tsdisabled&quot;, &quot;-digestalg&quot;, &quot;MD5&quot;,
 453                                 &quot;-sigalg&quot;, &quot;MD5withRSA&quot;, &quot;-tsadigestalg&quot;, &quot;MD5&quot;)
 454                         .shouldHaveExitValue(68)
 455                         .shouldContain(&quot;The timestamp is invalid. Without a valid timestamp&quot;)
 456                         .shouldMatch(&quot;MD5.*-digestalg.*is disabled&quot;)
 457                         .shouldMatch(&quot;MD5.*-tsadigestalg.*is disabled&quot;)
 458                         .shouldMatch(&quot;MD5withRSA.*-sigalg.*is disabled&quot;);
 459                 checkDisabled(&quot;tsdisabled.jar&quot;);
 460 
 461                 signVerbose(&quot;tsdisabled&quot;, &quot;unsigned.jar&quot;, &quot;tsdisabled2.jar&quot;, &quot;signer&quot;)
 462                         .shouldHaveExitValue(64)
 463                         .shouldContain(&quot;The timestamp is invalid. Without a valid timestamp&quot;)
 464                         .shouldContain(&quot;TSA certificate chain is invalid&quot;);
 465 
 466                 // Disabled timestamp is an error and jar treated unsigned
 467                 verify(&quot;tsdisabled2.jar&quot;, &quot;-verbose&quot;)
 468                         .shouldHaveExitValue(16)
</pre>
</td>
<td>
<hr />
<pre>
  46 import java.util.jar.JarEntry;
  47 import java.util.jar.JarFile;
  48 
  49 import jdk.test.lib.SecurityTools;
  50 import jdk.test.lib.process.OutputAnalyzer;
  51 import jdk.test.lib.util.JarUtils;
  52 import sun.security.pkcs.ContentInfo;
  53 import sun.security.pkcs.PKCS7;
  54 import sun.security.pkcs.PKCS9Attribute;
  55 import sun.security.pkcs.SignerInfo;
  56 import sun.security.timestamp.TimestampToken;
  57 import sun.security.util.DerOutputStream;
  58 import sun.security.util.DerValue;
  59 import sun.security.util.ObjectIdentifier;
  60 import sun.security.x509.AlgorithmId;
  61 import sun.security.x509.X500Name;
  62 
  63 /*
  64  * @test
  65  * @bug 6543842 6543440 6939248 8009636 8024302 8163304 8169911 8180289 8172404
<span class="line-added">  66  *          8242151</span>
  67  * @summary checking response of timestamp
  68  * @modules java.base/sun.security.pkcs
  69  *          java.base/sun.security.timestamp
  70  *          java.base/sun.security.x509
  71  *          java.base/sun.security.util
  72  *          java.base/sun.security.tools.keytool
  73  * @library /lib/testlibrary
  74  * @library /test/lib
  75  * @build jdk.test.lib.util.JarUtils
  76  *        jdk.test.lib.SecurityTools
  77  *        jdk.test.lib.Utils
  78  *        jdk.test.lib.Asserts
  79  *        jdk.test.lib.JDKToolFinder
  80  *        jdk.test.lib.JDKToolLauncher
  81  *        jdk.test.lib.Platform
  82  *        jdk.test.lib.process.*
  83  * @compile -XDignore.symbol.file TimestampCheck.java
  84  * @run main/timeout=600 TimestampCheck
  85  */
  86 public class TimestampCheck {
</pre>
<hr />
<pre>
 118                 t.sendResponseHeaders(500, 0);
 119             }
 120             t.close();
 121         }
 122 
 123         /**
 124          * @param input The data to sign
 125          * @param path different cases to simulate, impl on URL path
 126          * @returns the signed
 127          */
 128         byte[] sign(byte[] input, String path) throws Exception {
 129 
 130             DerValue value = new DerValue(input);
 131             System.out.println(&quot;#\n# Incoming Request\n===================&quot;);
 132             System.out.println(&quot;# Version: &quot; + value.data.getInteger());
 133             DerValue messageImprint = value.data.getDerValue();
 134             AlgorithmId aid = AlgorithmId.parse(
 135                     messageImprint.data.getDerValue());
 136             System.out.println(&quot;# AlgorithmId: &quot; + aid);
 137 
<span class="line-modified"> 138             ObjectIdentifier policyId = ObjectIdentifier.of(defaultPolicyId);</span>
 139             BigInteger nonce = null;
 140             while (value.data.available() &gt; 0) {
 141                 DerValue v = value.data.getDerValue();
 142                 if (v.tag == DerValue.tag_Integer) {
 143                     nonce = v.getBigInteger();
 144                     System.out.println(&quot;# nonce: &quot; + nonce);
 145                 } else if (v.tag == DerValue.tag_Boolean) {
 146                     System.out.println(&quot;# certReq: &quot; + v.getBoolean());
 147                 } else if (v.tag == DerValue.tag_ObjectId) {
 148                     policyId = v.getOID();
 149                     System.out.println(&quot;# PolicyID: &quot; + policyId);
 150                 }
 151             }
 152 
 153             System.out.println(&quot;#\n# Response\n===================&quot;);
 154             KeyStore ks = KeyStore.getInstance(
 155                     new File(keystore), &quot;changeit&quot;.toCharArray());
 156 
 157             // If path starts with &quot;ts&quot;, use the TSA it points to.
 158             // Otherwise, always use &quot;ts&quot;.
 159             String alias = path.startsWith(&quot;ts&quot;) ? path : &quot;ts&quot;;
 160 
 161             if (path.equals(&quot;diffpolicy&quot;)) {
<span class="line-modified"> 162                 policyId = ObjectIdentifier.of(defaultPolicyId);</span>
 163             }
 164 
 165             DerOutputStream statusInfo = new DerOutputStream();
 166             statusInfo.putInteger(0);
 167 
 168             AlgorithmId[] algorithms = {aid};
 169             Certificate[] chain = ks.getCertificateChain(alias);
 170             X509Certificate[] signerCertificateChain;
 171             X509Certificate signer = (X509Certificate)chain[0];
 172 
 173             if (path.equals(&quot;fullchain&quot;)) {   // Only case 5 uses full chain
 174                 signerCertificateChain = new X509Certificate[chain.length];
 175                 for (int i=0; i&lt;chain.length; i++) {
 176                     signerCertificateChain[i] = (X509Certificate)chain[i];
 177                 }
 178             } else if (path.equals(&quot;nocert&quot;)) {
 179                 signerCertificateChain = new X509Certificate[0];
 180             } else {
 181                 signerCertificateChain = new X509Certificate[1];
 182                 signerCertificateChain[0] = (X509Certificate)chain[0];
</pre>
<hr />
<pre>
 214             } else if (path.equals(&quot;nononce&quot;)) {
 215                 // no noce
 216             } else {
 217                 tst.putInteger(nonce);
 218             }
 219 
 220             DerOutputStream tstInfo = new DerOutputStream();
 221             tstInfo.write(DerValue.tag_Sequence, tst);
 222 
 223             DerOutputStream tstInfo2 = new DerOutputStream();
 224             tstInfo2.putOctetString(tstInfo.toByteArray());
 225 
 226             // Always use the same algorithm at timestamp signing
 227             // so it is different from the hash algorithm.
 228             String sigAlg = &quot;SHA256withRSA&quot;;
 229             Signature sig = Signature.getInstance(sigAlg);
 230             sig.initSign((PrivateKey)(ks.getKey(
 231                     alias, &quot;changeit&quot;.toCharArray())));
 232             sig.update(tstInfo.toByteArray());
 233 
<span class="line-modified"> 234             ContentInfo contentInfo = new ContentInfo(ObjectIdentifier.of(</span>
 235                     &quot;1.2.840.113549.1.9.16.1.4&quot;),
 236                     new DerValue(tstInfo2.toByteArray()));
 237 
 238             System.out.println(&quot;# Signing...&quot;);
 239             System.out.println(&quot;# &quot; + new X500Name(signer
 240                     .getIssuerX500Principal().getName()));
 241             System.out.println(&quot;# &quot; + signer.getSerialNumber());
 242 
 243             SignerInfo signerInfo = new SignerInfo(
 244                     new X500Name(signer.getIssuerX500Principal().getName()),
 245                     signer.getSerialNumber(),
 246                     AlgorithmId.get(AlgorithmId.getDigAlgFromSigAlg(sigAlg)),
 247                     AlgorithmId.get(AlgorithmId.getEncAlgFromSigAlg(sigAlg)),
 248                     sig.sign());
 249 
 250             SignerInfo[] signerInfos = {signerInfo};
 251             PKCS7 p7 = new PKCS7(algorithms, contentInfo,
 252                     signerCertificateChain, signerInfos);
 253             ByteArrayOutputStream p7out = new ByteArrayOutputStream();
 254             p7.encodeSignedData(p7out);
</pre>
<hr />
<pre>
 429                 signVerbose(null, &quot;unsigned.jar&quot;, &quot;sha1alg.jar&quot;, &quot;signer&quot;,
 430                         &quot;-strict&quot;, &quot;-digestalg&quot;, &quot;SHA-1&quot;)
 431                         .shouldHaveExitValue(0)
 432                         .shouldContain(&quot;jar signed, with signer errors&quot;)
 433                         .shouldMatch(&quot;SHA-1.*-digestalg.*will be disabled&quot;);
 434                 verify(&quot;sha1alg.jar&quot;, &quot;-strict&quot;)
 435                         .shouldHaveExitValue(0)
 436                         .shouldContain(&quot;jar verified, with signer errors&quot;)
 437                         .shouldContain(&quot;SHA-1 digest algorithm is considered a security risk&quot;)
 438                         .shouldContain(&quot;This algorithm will be disabled in a future update&quot;)
 439                         .shouldNotContain(&quot;is disabled&quot;);
 440 
 441                 sign(&quot;sha1tsaalg&quot;, &quot;-tsadigestalg&quot;, &quot;SHA-1&quot;, &quot;-strict&quot;)
 442                         .shouldHaveExitValue(0)
 443                         .shouldContain(&quot;jar signed, with signer errors&quot;)
 444                         .shouldMatch(&quot;SHA-1.*-tsadigestalg.*will be disabled&quot;)
 445                         .shouldNotContain(&quot;is disabled&quot;);
 446                 verify(&quot;sha1tsaalg.jar&quot;, &quot;-strict&quot;)
 447                         .shouldHaveExitValue(0)
 448                         .shouldContain(&quot;jar verified, with signer errors&quot;)
<span class="line-modified"> 449                         .shouldContain(&quot;SHA-1 timestamp digest algorithm is considered a security risk&quot;)</span>
 450                         .shouldNotContain(&quot;is disabled&quot;);
 451 
 452                 // Disabled algorithms
 453                 sign(&quot;tsdisabled&quot;, &quot;-digestalg&quot;, &quot;MD5&quot;,
 454                                 &quot;-sigalg&quot;, &quot;MD5withRSA&quot;, &quot;-tsadigestalg&quot;, &quot;MD5&quot;)
 455                         .shouldHaveExitValue(68)
 456                         .shouldContain(&quot;The timestamp is invalid. Without a valid timestamp&quot;)
 457                         .shouldMatch(&quot;MD5.*-digestalg.*is disabled&quot;)
 458                         .shouldMatch(&quot;MD5.*-tsadigestalg.*is disabled&quot;)
 459                         .shouldMatch(&quot;MD5withRSA.*-sigalg.*is disabled&quot;);
 460                 checkDisabled(&quot;tsdisabled.jar&quot;);
 461 
 462                 signVerbose(&quot;tsdisabled&quot;, &quot;unsigned.jar&quot;, &quot;tsdisabled2.jar&quot;, &quot;signer&quot;)
 463                         .shouldHaveExitValue(64)
 464                         .shouldContain(&quot;The timestamp is invalid. Without a valid timestamp&quot;)
 465                         .shouldContain(&quot;TSA certificate chain is invalid&quot;);
 466 
 467                 // Disabled timestamp is an error and jar treated unsigned
 468                 verify(&quot;tsdisabled2.jar&quot;, &quot;-verbose&quot;)
 469                         .shouldHaveExitValue(16)
</pre>
</td>
</tr>
</table>
<center><a href="../../pkcs12/ParamsTest.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="../keytool/KeyToolTest.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>