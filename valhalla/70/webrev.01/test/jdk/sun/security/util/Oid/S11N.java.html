<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>New test/jdk/sun/security/util/Oid/S11N.java</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
  </head>
  <body>
    <pre>
  1 /*
  2  * Copyright (c) 2013, 2020, Oracle and/or its affiliates. All rights reserved.
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 /*
 25  * @test
 26  * @bug 4811968 6908628 8006564 8130696 8242151
 27  * @modules java.base/sun.security.util
 28  * @run main S11N check
 29  * @summary Serialization compatibility with old versions (and fixes)
 30  */
 31 
 32 import java.io.ByteArrayInputStream;
 33 import java.io.ByteArrayOutputStream;
 34 import java.io.ObjectInputStream;
 35 import java.io.ObjectOutputStream;
 36 import java.util.HashMap;
 37 import java.util.Map;
 38 import sun.security.util.ObjectIdentifier;
 39 
 40 public class S11N {
 41     static String[] SMALL= {
 42         &quot;0.0&quot;,
 43         &quot;1.1&quot;,
 44         &quot;2.2&quot;,
 45         &quot;1.2.3456&quot;,
 46         &quot;1.2.2147483647.4&quot;,
 47         &quot;1.2.268435456.4&quot;,
 48     };
 49 
 50     static String[] HUGE = {
 51         &quot;2.16.764.1.3101555394.1.0.100.2.1&quot;,
 52         &quot;1.2.2147483648.4&quot;,
 53         &quot;2.3.4444444444444444444444&quot;,
 54         &quot;1.2.8888888888888888.33333333333333333.44444444444444&quot;,
 55     };
 56 
 57     public static void main(String[] args) throws Exception {
 58         if (args[0].equals(&quot;check&quot;)) {
 59             String jv = System.getProperty(&quot;java.version&quot;);
 60             // java.version format: $VNUM\-$PRE
 61             String [] va = (jv.split(&quot;-&quot;)[0]).split(&quot;\\.&quot;);
 62             String v = (va.length == 1 || !va[0].equals(&quot;1&quot;)) ? va[0] : va[1];
 63             int version = Integer.valueOf(v);
 64             System.out.println(&quot;version is &quot; + version);
 65             if (version &gt;= 7) {
 66                 for (String oid: SMALL) {
 67                     // 7 -&gt; 7
 68                     check(out(oid), oid);
 69                     // 6 -&gt; 7
 70                     check(out6(oid), oid);
 71                 }
 72                 for (String oid: HUGE) {
 73                     // 7 -&gt; 7
 74                     check(out(oid), oid);
 75                 }
 76             } else {
 77                 for (String oid: SMALL) {
 78                     // 6 -&gt; 6
 79                     check(out(oid), oid);
 80                     // 7 -&gt; 6
 81                     check(out7(oid), oid);
 82                 }
 83                 for (String oid: HUGE) {
 84                     // 7 -&gt; 6 fails for HUGE oids
 85                     boolean ok = false;
 86                     try {
 87                         check(out7(oid), oid);
 88                         ok = true;
 89                     } catch (Exception e) {
 90                         System.out.println(e);
 91                     }
 92                     if (ok) {
 93                         throw new Exception();
 94                     }
 95                 }
 96             }
 97         } else {
 98             // Generates the JDK6 serialized string inside this test, call
 99             //      $JDK7/bin/java S11N dump7
100             //      $JDK6/bin/java S11N dump6
101             // and paste the output at the end of this test.
102             dump(args[0], SMALL);
103             // For jdk6, the following line will throw an exception, ignore it
104             dump(args[0], HUGE);
105         }
106     }
107 
108     // Gets the serialized form for jdk6
109     private static byte[] out6(String oid) throws Exception {
110         return decode(dump6.get(oid));
111     }
112 
113     // Gets the serialized form for jdk7
114     private static byte[] out7(String oid) throws Exception {
115         return decode(dump7.get(oid));
116     }
117 
118     // Gets the serialized form for this java
119     private static byte[] out(String oid) throws Exception {
120         ByteArrayOutputStream bout = new ByteArrayOutputStream();
121         new ObjectOutputStream(bout).writeObject(ObjectIdentifier.of(oid));
122         return bout.toByteArray();
123     }
124 
125     // Makes sure serialized form can be deserialized
126     private static void check(byte[] in, String oid) throws Exception {
127         ObjectIdentifier o = (ObjectIdentifier) (
128                 new ObjectInputStream(new ByteArrayInputStream(in)).readObject());
129         if (!o.toString().equals(oid)) {
130             throw new Exception(&quot;Read Fail &quot; + o + &quot;, not &quot; + oid);
131         }
132     }
133 
134     // dump serialized form to java code style text
135     private static void dump(String title, String[] oids) throws Exception {
136         for (String oid: oids) {
137             String hex = encode(out(oid));
138             System.out.println(&quot;        &quot; + title + &quot;.put(\&quot;&quot; + oid + &quot;\&quot;,&quot;);
139             for (int i = 0; i&lt;hex.length(); i+= 64) {
140                 int end = i + 64;
141                 if (end &gt; hex.length()) {
142                     end = hex.length();
143                 }
144                 System.out.print(&quot;            \&quot;&quot; + hex.substring(i, end) + &quot;\&quot;&quot;);
145                 if (end == hex.length()) {
146                     System.out.println(&quot;);&quot;);
147                 } else {
148                     System.out.println(&quot; +&quot;);
149                 }
150             }
151         }
152     }
153 
154     private static String encode(byte[] bytes) {
155         StringBuilder sb = new StringBuilder(bytes.length * 2);
156         for (byte b: bytes) {
157             sb.append(String.format(&quot;%02x&quot;, b &amp; 0xff));
158         }
159         return sb.toString();
160     }
161 
162     private static byte[] decode(String var) {
163         byte[] data = new byte[var.length()/2];
164         for (int i=0; i&lt;data.length; i++) {
165             data[i] = Integer.valueOf(var.substring(2 * i, 2 * i + 2), 16).byteValue();
166         }
167         return data;
168     }
169 
170     // Do not use diamond operator, this test is also meant to run in jdk6
171     private static Map&lt;String,String&gt; dump7 = new HashMap&lt;String,String&gt;();
172     private static Map&lt;String,String&gt; dump6 = new HashMap&lt;String,String&gt;();
173 
174     static {
175         //////////////  PASTE BEGIN //////////////
176         dump7.put(&quot;0.0&quot;,
177             &quot;aced00057372002273756e2e73656375726974792e7574696c2e4f626a656374&quot; +
178             &quot;4964656e74696669657278b20eec64177f2e03000349000c636f6d706f6e656e&quot; +
179             &quot;744c656e4c000a636f6d706f6e656e74737400124c6a6176612f6c616e672f4f&quot; +
180             &quot;626a6563743b5b0008656e636f64696e677400025b4278700000000275720002&quot; +
181             &quot;5b494dba602676eab2a50200007870000000020000000000000000757200025b&quot; +
182             &quot;42acf317f8060854e00200007870000000010078&quot;);
183         dump7.put(&quot;1.1&quot;,
184             &quot;aced00057372002273756e2e73656375726974792e7574696c2e4f626a656374&quot; +
185             &quot;4964656e74696669657278b20eec64177f2e03000349000c636f6d706f6e656e&quot; +
186             &quot;744c656e4c000a636f6d706f6e656e74737400124c6a6176612f6c616e672f4f&quot; +
187             &quot;626a6563743b5b0008656e636f64696e677400025b4278700000000275720002&quot; +
188             &quot;5b494dba602676eab2a50200007870000000020000000100000001757200025b&quot; +
189             &quot;42acf317f8060854e00200007870000000012978&quot;);
190         dump7.put(&quot;2.2&quot;,
191             &quot;aced00057372002273756e2e73656375726974792e7574696c2e4f626a656374&quot; +
192             &quot;4964656e74696669657278b20eec64177f2e03000349000c636f6d706f6e656e&quot; +
193             &quot;744c656e4c000a636f6d706f6e656e74737400124c6a6176612f6c616e672f4f&quot; +
194             &quot;626a6563743b5b0008656e636f64696e677400025b4278700000000275720002&quot; +
195             &quot;5b494dba602676eab2a50200007870000000020000000200000002757200025b&quot; +
196             &quot;42acf317f8060854e00200007870000000015278&quot;);
197         dump7.put(&quot;1.2.3456&quot;,
198             &quot;aced00057372002273756e2e73656375726974792e7574696c2e4f626a656374&quot; +
199             &quot;4964656e74696669657278b20eec64177f2e03000349000c636f6d706f6e656e&quot; +
200             &quot;744c656e4c000a636f6d706f6e656e74737400124c6a6176612f6c616e672f4f&quot; +
201             &quot;626a6563743b5b0008656e636f64696e677400025b4278700000000375720002&quot; +
202             &quot;5b494dba602676eab2a5020000787000000003000000010000000200000d8075&quot; +
203             &quot;7200025b42acf317f8060854e00200007870000000032a9b0078&quot;);
204         dump7.put(&quot;1.2.2147483647.4&quot;,
205             &quot;aced00057372002273756e2e73656375726974792e7574696c2e4f626a656374&quot; +
206             &quot;4964656e74696669657278b20eec64177f2e03000349000c636f6d706f6e656e&quot; +
207             &quot;744c656e4c000a636f6d706f6e656e74737400124c6a6176612f6c616e672f4f&quot; +
208             &quot;626a6563743b5b0008656e636f64696e677400025b4278700000000475720002&quot; +
209             &quot;5b494dba602676eab2a502000078700000000400000001000000027fffffff00&quot; +
210             &quot;000004757200025b42acf317f8060854e00200007870000000072a87ffffff7f&quot; +
211             &quot;0478&quot;);
212         dump7.put(&quot;1.2.268435456.4&quot;,
213             &quot;aced00057372002273756e2e73656375726974792e7574696c2e4f626a656374&quot; +
214             &quot;4964656e74696669657278b20eec64177f2e03000349000c636f6d706f6e656e&quot; +
215             &quot;744c656e4c000a636f6d706f6e656e74737400124c6a6176612f6c616e672f4f&quot; +
216             &quot;626a6563743b5b0008656e636f64696e677400025b4278700000000475720002&quot; +
217             &quot;5b494dba602676eab2a502000078700000000400000001000000021000000000&quot; +
218             &quot;000004757200025b42acf317f8060854e00200007870000000072a8180808000&quot; +
219             &quot;0478&quot;);
220         dump7.put(&quot;2.16.764.1.3101555394.1.0.100.2.1&quot;,
221             &quot;aced00057372002273756e2e73656375726974792e7574696c2e4f626a656374&quot; +
222             &quot;4964656e74696669657278b20eec64177f2e03000349000c636f6d706f6e656e&quot; +
223             &quot;744c656e4c000a636f6d706f6e656e74737400124c6a6176612f6c616e672f4f&quot; +
224             &quot;626a6563743b5b0008656e636f64696e677400025b427870ffffffff7372003e&quot; +
225             &quot;73756e2e73656375726974792e7574696c2e4f626a6563744964656e74696669&quot; +
226             &quot;657224487567654f69644e6f74537570706f7274656442794f6c644a444b0000&quot; +
227             &quot;0000000000010200007870757200025b42acf317f8060854e002000078700000&quot; +
228             &quot;000e60857c018bc6f7f542010064020178&quot;);
229         dump7.put(&quot;1.2.2147483648.4&quot;,
230             &quot;aced00057372002273756e2e73656375726974792e7574696c2e4f626a656374&quot; +
231             &quot;4964656e74696669657278b20eec64177f2e03000349000c636f6d706f6e656e&quot; +
232             &quot;744c656e4c000a636f6d706f6e656e74737400124c6a6176612f6c616e672f4f&quot; +
233             &quot;626a6563743b5b0008656e636f64696e677400025b427870ffffffff7372003e&quot; +
234             &quot;73756e2e73656375726974792e7574696c2e4f626a6563744964656e74696669&quot; +
235             &quot;657224487567654f69644e6f74537570706f7274656442794f6c644a444b0000&quot; +
236             &quot;0000000000010200007870757200025b42acf317f8060854e002000078700000&quot; +
237             &quot;00072a88808080000478&quot;);
238         dump7.put(&quot;2.3.4444444444444444444444&quot;,
239             &quot;aced00057372002273756e2e73656375726974792e7574696c2e4f626a656374&quot; +
240             &quot;4964656e74696669657278b20eec64177f2e03000349000c636f6d706f6e656e&quot; +
241             &quot;744c656e4c000a636f6d706f6e656e74737400124c6a6176612f6c616e672f4f&quot; +
242             &quot;626a6563743b5b0008656e636f64696e677400025b427870ffffffff7372003e&quot; +
243             &quot;73756e2e73656375726974792e7574696c2e4f626a6563744964656e74696669&quot; +
244             &quot;657224487567654f69644e6f74537570706f7274656442794f6c644a444b0000&quot; +
245             &quot;0000000000010200007870757200025b42acf317f8060854e002000078700000&quot; +
246             &quot;000c5383e1ef87a4d1bdebc78e1c78&quot;);
247         dump7.put(&quot;1.2.8888888888888888.33333333333333333.44444444444444&quot;,
248             &quot;aced00057372002273756e2e73656375726974792e7574696c2e4f626a656374&quot; +
249             &quot;4964656e74696669657278b20eec64177f2e03000349000c636f6d706f6e656e&quot; +
250             &quot;744c656e4c000a636f6d706f6e656e74737400124c6a6176612f6c616e672f4f&quot; +
251             &quot;626a6563743b5b0008656e636f64696e677400025b427870ffffffff7372003e&quot; +
252             &quot;73756e2e73656375726974792e7574696c2e4f626a6563744964656e74696669&quot; +
253             &quot;657224487567654f69644e6f74537570706f7274656442794f6c644a444b0000&quot; +
254             &quot;0000000000010200007870757200025b42acf317f8060854e002000078700000&quot; +
255             &quot;00182a8fe58cdbc5ae9c38bb9b8fd7a48daa558a8dc0bacb8e1c78&quot;);
256 
257         dump6.put(&quot;0.0&quot;,
258             &quot;aced00057372002273756e2e73656375726974792e7574696c2e4f626a656374&quot; +
259             &quot;4964656e74696669657278b20eec64177f2e02000249000c636f6d706f6e656e&quot; +
260             &quot;744c656e5b000a636f6d706f6e656e74737400025b4978700000000275720002&quot; +
261             &quot;5b494dba602676eab2a50200007870000000020000000000000000&quot;);
262         dump6.put(&quot;1.1&quot;,
263             &quot;aced00057372002273756e2e73656375726974792e7574696c2e4f626a656374&quot; +
264             &quot;4964656e74696669657278b20eec64177f2e02000249000c636f6d706f6e656e&quot; +
265             &quot;744c656e5b000a636f6d706f6e656e74737400025b4978700000000275720002&quot; +
266             &quot;5b494dba602676eab2a50200007870000000020000000100000001&quot;);
267         dump6.put(&quot;2.2&quot;,
268             &quot;aced00057372002273756e2e73656375726974792e7574696c2e4f626a656374&quot; +
269             &quot;4964656e74696669657278b20eec64177f2e02000249000c636f6d706f6e656e&quot; +
270             &quot;744c656e5b000a636f6d706f6e656e74737400025b4978700000000275720002&quot; +
271             &quot;5b494dba602676eab2a50200007870000000020000000200000002&quot;);
272         dump6.put(&quot;1.2.3456&quot;,
273             &quot;aced00057372002273756e2e73656375726974792e7574696c2e4f626a656374&quot; +
274             &quot;4964656e74696669657278b20eec64177f2e02000249000c636f6d706f6e656e&quot; +
275             &quot;744c656e5b000a636f6d706f6e656e74737400025b4978700000000375720002&quot; +
276             &quot;5b494dba602676eab2a5020000787000000003000000010000000200000d80&quot;);
277         dump6.put(&quot;1.2.2147483647.4&quot;,
278             &quot;aced00057372002273756e2e73656375726974792e7574696c2e4f626a656374&quot; +
279             &quot;4964656e74696669657278b20eec64177f2e02000249000c636f6d706f6e656e&quot; +
280             &quot;744c656e5b000a636f6d706f6e656e74737400025b4978700000000475720002&quot; +
281             &quot;5b494dba602676eab2a502000078700000000400000001000000027fffffff00&quot; +
282             &quot;000004&quot;);
283         dump6.put(&quot;1.2.268435456.4&quot;,
284             &quot;aced00057372002273756e2e73656375726974792e7574696c2e4f626a656374&quot; +
285             &quot;4964656e74696669657278b20eec64177f2e02000249000c636f6d706f6e656e&quot; +
286             &quot;744c656e5b000a636f6d706f6e656e74737400025b4978700000000475720002&quot; +
287             &quot;5b494dba602676eab2a502000078700000000400000001000000021000000000&quot; +
288             &quot;000004&quot;);
289 
290         //////////////  PASTE END //////////////
291     }
292 }
    </pre>
  </body>
</html>