<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames make/MainSupport.gmk</title>
    <link rel="stylesheet" href="../style.css" />
    <script type="text/javascript" src="../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 #
  2 # Copyright (c) 2011, 2020, Oracle and/or its affiliates. All rights reserved.
  3 # DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4 #
  5 # This code is free software; you can redistribute it and/or modify it
  6 # under the terms of the GNU General Public License version 2 only, as
  7 # published by the Free Software Foundation.  Oracle designates this
  8 # particular file as subject to the &quot;Classpath&quot; exception as provided
  9 # by Oracle in the LICENSE file that accompanied this code.
 10 #
 11 # This code is distributed in the hope that it will be useful, but WITHOUT
 12 # ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 13 # FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 14 # version 2 for more details (a copy is included in the LICENSE file that
 15 # accompanied this code).
 16 #
 17 # You should have received a copy of the GNU General Public License version
 18 # 2 along with this work; if not, write to the Free Software Foundation,
 19 # Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 20 #
 21 # Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 22 # or visit www.oracle.com if you need additional information or have any
 23 # questions.
 24 #
 25 
 26 ################################################################################
 27 # This file contains helper functions for Main.gmk.
 28 ################################################################################
 29 
 30 ifndef _MAINSUPPORT_GMK
 31 _MAINSUPPORT_GMK := 1
 32 
 33 # Setup make rules for creating a top-level target.
 34 # Parameter 1 is the name of the rule. This name is used as variable prefix.
 35 #
 36 # Remaining parameters are named arguments. These include:
 37 #   MAKEFILE the makefile to delegate to
 38 #   TARGET the makefile target
 39 #   ARGS arguments to the makefile
 40 #   DEPS the target(s) this new rule depends on
 41 #
 42 SetupTarget = $(NamedParamsMacroTemplate)
 43 define SetupTargetBody
 44   $1:
 45 	+($(CD) $(TOPDIR)/make &amp;&amp; $(MAKE) $(MAKE_ARGS) -f $$($1_MAKEFILE).gmk $$($1_TARGET) $$($1_ARGS))
 46 
 47   ALL_TARGETS += $1
 48 
 49   ifneq ($(DEPS), none)
 50     $1: $$($1_DEPS)
 51   endif
 52 endef
 53 
 54 define CleanDocs
 55 	@$(PRINTF) &quot;Cleaning docs ...&quot;
 56 	@$(PRINTF) &quot;\n&quot; $(LOG_DEBUG)
 57 	$(RM) -r $(SUPPORT_OUTPUTDIR)/docs
 58 	$(RM) -r $(SUPPORT_OUTPUTDIR)/javadoc
 59 	$(RM) -r $(IMAGES_OUTPUTDIR)/docs
 60 	@$(PRINTF) &quot; done\n&quot;
 61 endef
 62 
 63 # Cleans the dir given as $1
 64 define CleanDir
 65 	@$(PRINTF) &quot;Cleaning $(strip $1) build artifacts ...&quot;
 66 	@$(PRINTF) &quot;\n&quot; $(LOG_DEBUG)
 67 	($(CD) $(OUTPUTDIR) &amp;&amp; $(RM) -r $1)
 68 	@$(PRINTF) &quot; done\n&quot;
 69 endef
 70 
 71 define CleanSupportDir
 72 	@$(PRINTF) &quot;Cleaning $(strip $1) build artifacts ...&quot;
 73 	@$(PRINTF) &quot;\n&quot; $(LOG_DEBUG)
 74 	$(RM) -r $(SUPPORT_OUTPUTDIR)/$(strip $1)
 75 	@$(PRINTF) &quot; done\n&quot;
 76 endef
 77 
 78 define CleanMakeSupportDir
 79 	@$(PRINTF) &quot;Cleaning $(strip $1) make support artifacts ...&quot;
 80 	@$(PRINTF) &quot;\n&quot; $(LOG_DEBUG)
 81 	$(RM) -r $(MAKESUPPORT_OUTPUTDIR)/$(strip $1)
 82 	@$(PRINTF) &quot; done\n&quot;
 83 endef
 84 
 85 define CleanTest
 86 	@$(PRINTF) &quot;Cleaning test $(strip $1) ...&quot;
 87 	@$(PRINTF) &quot;\n&quot; $(LOG_DEBUG)
 88 	$(RM) -r $(SUPPORT_OUTPUTDIR)/test/$(strip $(subst -,/,$1))
 89         # Remove as much of the test directory structure as is empty
 90 	$(RMDIR) -p $(dir $(SUPPORT_OUTPUTDIR)/test/$(strip $(subst -,/,$1))) 2&gt; /dev/null || true
 91 	@$(PRINTF) &quot; done\n&quot;
 92 endef
 93 
 94 define Clean-gensrc
 95 	@$(PRINTF) &quot;Cleaning gensrc $(if $1,for $(strip $1) )...&quot;
 96 	@$(PRINTF) &quot;\n&quot; $(LOG_DEBUG)
 97 	$(RM) -r $(SUPPORT_OUTPUTDIR)/gensrc/$(strip $1)
 98 	@$(PRINTF) &quot; done\n&quot;
 99 endef
100 
101 define Clean-java
102 	@$(PRINTF) &quot;Cleaning java $(if $1,for $(strip $1) )...&quot;
103 	@$(PRINTF) &quot;\n&quot; $(LOG_DEBUG)
104 	$(RM) -r $(JDK_OUTPUTDIR)/modules/$(strip $1)
105 	$(RM) -r $(SUPPORT_OUTPUTDIR)/special_classes/$(strip $1)
106 	$(PRINTF) &quot; done\n&quot;
107 	$(PRINTF) &quot;Cleaning headers $(if $1,for $(strip $1)) ...&quot;
108 	$(RM) -r $(SUPPORT_OUTPUTDIR)/headers/$(strip $1)
109 	@$(PRINTF) &quot; done\n&quot;
110 endef
111 
112 define Clean-native
113 	@$(PRINTF) &quot;Cleaning native $(if $1,for $(strip $1) )...&quot;
114 	@$(PRINTF) &quot;\n&quot; $(LOG_DEBUG)
115 	$(RM) -r $(SUPPORT_OUTPUTDIR)/native/$(strip $1)
116 	$(RM) -r $(SUPPORT_OUTPUTDIR)/modules_libs/$(strip $1)
117 	$(RM) -r $(SUPPORT_OUTPUTDIR)/modules_cmds/$(strip $1)
118 	@$(PRINTF) &quot; done\n&quot;
119 endef
120 
121 define Clean-include
122 	@$(PRINTF) &quot;Cleaning include $(if $1,for $(strip $1) )...&quot;
123 	@$(PRINTF) &quot;\n&quot; $(LOG_DEBUG)
124 	$(RM) -r $(SUPPORT_OUTPUTDIR)/modules_include/$(strip $1)
125 	@$(PRINTF) &quot; done\n&quot;
126 endef
127 
128 define CleanModule
129   $(call Clean-gensrc, $1)
130   $(call Clean-java, $1)
131   $(call Clean-native, $1)
132   $(call Clean-include, $1)
133 endef
134 
135 
136 ################################################################################
137 
138 PHASE_MAKEDIRS := $(TOPDIR)/make
139 
140 # Helper macro for DeclareRecipesForPhase
141 # Declare a recipe for calling the module and phase specific makefile.
142 # If there are multiple makefiles to call, create a rule for each topdir
143 # that contains a makefile with the target $module-$suffix-$repodir,
144 # (i.e: java.base-gensrc-src)
145 # Normally there is only one makefile, and the target will just be
146 # $module-$suffix
147 # Param 1: Name of list to add targets to
148 # Param 2: Module name
149 define DeclareRecipeForModuleMakefile
150   $2-$$($1_TARGET_SUFFIX):
<a name="1" id="anc1"></a><span class="line-modified">151 	+($(CD) $(TOPDIR)/make &amp;&amp; $(MAKE) $(MAKE_ARGS) \</span>
<span class="line-modified">152 	    -f ModuleWrapper.gmk -I $$(TOPDIR)/make/common/modules  \</span>
<span class="line-modified">153 	    $$(addprefix -I, $$(PHASE_MAKEDIRS) \</span>
<span class="line-modified">154 	        $$(addsuffix /modules/$2, $$(PHASE_MAKEDIRS)) \</span>
<span class="line-modified">155 	    ) \</span>
<span class="line-modified">156 	    MODULE=$2 MAKEFILE_PREFIX=$$($1_FILE_PREFIX) $$($1_EXTRA_ARGS))</span>











157 
158 endef
159 
160 # Helper macro for DeclareRecipesForPhase
161 # Param 1: Name of list to add targets to
162 # Param 2: Module name
163 define DeclareRecipesForPhaseAndModule
164   $1_$2_MAKEFILES := $$(strip $$(wildcard \
165       $$(addsuffix /modules/$2/$$($1_FILE_PREFIX).gmk, $$(PHASE_MAKEDIRS))))
166 
167   # Only declare recipes if there are makefiles to call
168   ifneq ($$($1_$2_MAKEFILES), )
169     # Add the top dir specific target to target list regardless of if recipe
170     # generation is disabled.
171     ifeq ($$($1_MULTIPLE_MAKEFILES), true)
172       $$(foreach d, $$($1_$2_TOPDIRS), \
173         $$(eval $1 += $2-$$($1_TARGET_SUFFIX)-$$(notdir $$d)))
174     endif
175     ifeq ($(NO_RECIPES),)
176       $$(eval $$(call DeclareRecipeForModuleMakefile,$1,$2))
177     endif
178     $1 += $2-$$($1_TARGET_SUFFIX)
179     $1_MODULES += $2
180   endif
181 endef
182 
183 # Declare recipes for a specific module and build phase if there are makefiles
184 # present for the specific combination.
185 # Param 1: Name of list to add targets to
186 # Named params:
187 # TARGET_SUFFIX : Suffix of target to create for recipe
188 # MAKE_SUBDIR : Subdir for this build phase
189 # FILE_PREFIX : File prefix for this build phase
<a name="2" id="anc2"></a>
190 # CHECK_MODULES : List of modules to try
191 # MULTIPLE_MAKEFILES : Set to true to handle makefiles for the same module and
192 #                      phase in multiple repos
193 # EXTRA_ARGS : Add extra make args to each makefile call
194 # Exported variables:
195 # $1_MODULES : All modules that had rules generated
196 # $1_TARGETS : All targets generated
197 define DeclareRecipesForPhase
198   $(foreach i,2 3 4 5 6 7 8, $(if $(strip $($i)),$(strip $1)_$(strip $($i)))$(NEWLINE))
199   $(if $(9),$(error Internal makefile error: Too many arguments to \
200       DeclareRecipesForPhase, please update MakeHelper.gmk))
201 
202   $$(foreach m, $$($(strip $1)_CHECK_MODULES), \
203       $$(eval $$(call DeclareRecipesForPhaseAndModule,$(strip $1),$$m)))
204 
205   $(strip $1)_TARGETS := $$($(strip $1))
206 endef
207 
208 ################################################################################
209 
210 endif # _MAINSUPPORT_GMK
<a name="3" id="anc3"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="3" type="hidden" />
</body>
</html>