<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Old make/Main.gmk</title>
    <link rel="stylesheet" href="../style.css" />
  </head>
  <body>
    <pre>
   1 #
   2 # Copyright (c) 2011, 2020, Oracle and/or its affiliates. All rights reserved.
   3 # DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4 #
   5 # This code is free software; you can redistribute it and/or modify it
   6 # under the terms of the GNU General Public License version 2 only, as
   7 # published by the Free Software Foundation.  Oracle designates this
   8 # particular file as subject to the &quot;Classpath&quot; exception as provided
   9 # by Oracle in the LICENSE file that accompanied this code.
  10 #
  11 # This code is distributed in the hope that it will be useful, but WITHOUT
  12 # ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  13 # FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  14 # version 2 for more details (a copy is included in the LICENSE file that
  15 # accompanied this code).
  16 #
  17 # You should have received a copy of the GNU General Public License version
  18 # 2 along with this work; if not, write to the Free Software Foundation,
  19 # Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  20 #
  21 # Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  22 # or visit www.oracle.com if you need additional information or have any
  23 # questions.
  24 #
  25 
  26 ################################################################################
  27 # This is the main makefile containing most actual top level targets. It needs
  28 # to be called with a SPEC file defined.
  29 ################################################################################
  30 
  31 # Declare default target
  32 default:
  33 
  34 ifeq ($(wildcard $(SPEC)),)
  35   $(error Main.gmk needs SPEC set to a proper spec.gmk)
  36 endif
  37 
  38 # Now load the spec
  39 include $(SPEC)
  40 
  41 # Load the vital tools for all the makefiles.
  42 include $(TOPDIR)/make/common/MakeBase.gmk
  43 include $(TOPDIR)/make/common/Modules.gmk
  44 include $(TOPDIR)/make/common/FindTests.gmk
  45 
  46 include $(TOPDIR)/make/MainSupport.gmk
  47 
  48 # Are we requested to ignore dependencies?
  49 ifneq ($(findstring -only, $(MAKECMDGOALS)), )
  50   DEPS := none
  51 endif
  52 
  53 # Declare ALL_TARGETS as an immediate variable. This variable is a list of all
  54 # valid top level targets. It&#39;s used to declare them all as PHONY and to
  55 # generate the -only targets.
  56 ALL_TARGETS :=
  57 
  58 # Hook to include the corresponding custom file, if present.
  59 $(eval $(call IncludeCustomExtension, Main.gmk))
  60 
  61 # All modules for the current target platform.
  62 ALL_MODULES := $(call FindAllModules)
  63 
  64 ################################################################################
  65 ################################################################################
  66 #
  67 # Recipes for all targets. Only recipes, dependencies are declared later.
  68 #
  69 ################################################################################
  70 
  71 ################################################################################
  72 # Interim/build tools targets, compiling tools used during the build
  73 
  74 $(eval $(call SetupTarget, buildtools-langtools, \
  75     MAKEFILE := ToolsLangtools, \
  76 ))
  77 
  78 $(eval $(call SetupTarget, interim-langtools, \
  79     MAKEFILE := CompileInterimLangtools, \
  80 ))
  81 
  82 $(eval $(call SetupTarget, interim-tzdb, \
  83     MAKEFILE := CopyInterimTZDB, \
  84 ))
  85 
  86 $(eval $(call SetupTarget, buildtools-jdk, \
  87     MAKEFILE := CompileToolsJdk, \
  88     DEPS := interim-langtools interim-tzdb, \
  89 ))
  90 
  91 $(eval $(call SetupTarget, buildtools-modules, \
  92     MAKEFILE := CompileModuleTools, \
  93     DEPS := exploded-image-base, \
  94 ))
  95 
  96 $(eval $(call SetupTarget, buildtools-hotspot, \
  97     MAKEFILE := CompileToolsHotspot, \
  98     DEPS := interim-langtools, \
  99 ))
 100 
 101 ################################################################################
 102 # Special targets for certain modules
 103 
 104 $(eval $(call SetupTarget, generate-exported-symbols, \
 105     MAKEFILE := BuildStatic, \
 106     DEPS := java.base-libs jdk.jdwp.agent-libs, \
 107 ))
 108 
 109 ################################################################################
 110 # Gensrc targets, generating source before java compilation can be done
 111 #
 112 $(eval $(call DeclareRecipesForPhase, GENSRC, \
 113     TARGET_SUFFIX := gensrc-src, \
 114     FILE_PREFIX := Gensrc, \
 115     MAKE_SUBDIR := gensrc, \
 116     CHECK_MODULES := $(ALL_MODULES), \
 117 ))
 118 
 119 $(foreach m, $(GENSRC_MODULES), $(eval $m-gensrc: $m-gensrc-src))
 120 
 121 LANGTOOLS_GENSRC_TARGETS := $(filter $(addsuffix -%, $(LANGTOOLS_MODULES)), $(GENSRC_TARGETS))
 122 INTERIM_LANGTOOLS_GENSRC_TARGETS := $(filter $(addsuffix -%, \
 123     $(INTERIM_LANGTOOLS_BASE_MODULES)), $(GENSRC_TARGETS))
 124 HOTSPOT_GENSRC_TARGETS := $(filter $(addsuffix -%, $(HOTSPOT_MODULES)), $(GENSRC_TARGETS))
 125 JDK_GENSRC_TARGETS := $(filter-out $(LANGTOOLS_GENSRC_TARGETS) \
 126     $(HOTSPOT_GENSRC_TARGETS), $(GENSRC_TARGETS))
 127 
 128 GENSRC_MODULEINFO_MODULES := $(ALL_MODULES)
 129 GENSRC_MODULEINFO_TARGETS := $(addsuffix -gensrc-moduleinfo, \
 130     $(GENSRC_MODULEINFO_MODULES))
 131 
 132 GENSRC_MODULES := $(GENSRC_MODULEINFO_MODULES)
 133 GENSRC_TARGETS += $(sort $(GENSRC_MODULEINFO_TARGETS) \
 134     $(addsuffix -gensrc, $(GENSRC_MODULES)))
 135 
 136 define DeclareModuleInfoRecipe
 137   $1-gensrc-moduleinfo:
 138 	+($(CD) $(TOPDIR)/make &amp;&amp; $(MAKE) $(MAKE_ARGS) \
 139 	    -f common/modules/GensrcModuleInfo.gmk MODULE=$1)
 140 
 141   $1-gensrc: $1-gensrc-moduleinfo
 142 endef
 143 
 144 $(foreach m, $(GENSRC_MODULEINFO_MODULES), $(eval $(call DeclareModuleInfoRecipe,$m)))
 145 
 146 ALL_TARGETS += $(GENSRC_TARGETS)
 147 
 148 ################################################################################
 149 # Generate data targets
 150 $(eval $(call DeclareRecipesForPhase, GENDATA, \
 151     TARGET_SUFFIX := gendata, \
 152     FILE_PREFIX := Gendata, \
 153     MAKE_SUBDIR := gendata, \
 154     CHECK_MODULES := $(ALL_MODULES), \
 155     USE_WRAPPER := true))
 156 
 157 ALL_TARGETS += $(GENDATA_TARGETS)
 158 
 159 ################################################################################
 160 # Copy files targets
 161 $(eval $(call DeclareRecipesForPhase, COPY, \
 162     TARGET_SUFFIX := copy, \
 163     FILE_PREFIX := Copy, \
 164     MAKE_SUBDIR := copy, \
 165     CHECK_MODULES := $(ALL_MODULES), \
 166     USE_WRAPPER := true, \
 167 ))
 168 
 169 ALL_COPY_MODULES += $(COPY_MODULES)
 170 ALL_COPY_TARGETS += $(COPY_TARGETS)
 171 
 172 IMPORT_COPY_MODULES := $(call FindImportedModules)
 173 IMPORT_COPY_TARGETS := $(addsuffix -copy, $(IMPORT_COPY_MODULES))
 174 ALL_COPY_MODULES += $(IMPORT_COPY_MODULES)
 175 ALL_COPY_TARGETS += $(IMPORT_COPY_TARGETS)
 176 
 177 define DeclareImportCopyRecipe
 178   $1-copy:
 179 	+($(CD) $(TOPDIR)/make &amp;&amp; $(MAKE) $(MAKE_ARGS) \
 180 	    -f CopyImportModules.gmk MODULE=$1)
 181 endef
 182 
 183 $(foreach m, $(IMPORT_COPY_MODULES), $(eval $(call DeclareImportCopyRecipe,$m)))
 184 
 185 ALL_TARGETS += $(ALL_COPY_TARGETS)
 186 
 187 ################################################################################
 188 # Targets for compiling all java modules.
 189 JAVA_MODULES := $(ALL_MODULES)
 190 JAVA_TARGETS := $(addsuffix -java, $(JAVA_MODULES))
 191 
 192 define DeclareCompileJavaRecipe
 193   $1-java:
 194 	+($(CD) $(TOPDIR)/make &amp;&amp; $(MAKE) $(MAKE_ARGS) \
 195 	    -f CompileJavaModules.gmk MODULE=$1)
 196 endef
 197 
 198 $(foreach m, $(JAVA_MODULES), $(eval $(call DeclareCompileJavaRecipe,$m)))
 199 
 200 ALL_TARGETS += $(JAVA_TARGETS)
 201 
 202 ################################################################################
 203 # Targets for compiling native libraries
 204 $(eval $(call DeclareRecipesForPhase, LIBS, \
 205     TARGET_SUFFIX := libs, \
 206     FILE_PREFIX := Lib, \
 207     MAKE_SUBDIR := lib, \
 208     CHECK_MODULES := $(ALL_MODULES), \
 209     USE_WRAPPER := true))
 210 
 211 ALL_TARGETS += $(LIBS_TARGETS)
 212 
 213 ################################################################################
 214 # Targets for compiling static versions of certain native libraries. These do
 215 # not end up in the jmods or the normal JDK image, but are instead bundled into
 216 # a special deliverable.
 217 $(eval $(call DeclareRecipesForPhase, STATIC_LIBS, \
 218     TARGET_SUFFIX := static-libs, \
 219     FILE_PREFIX := Lib, \
 220     MAKE_SUBDIR := lib, \
 221     CHECK_MODULES := $(STATIC_LIBS_MODULES), \
 222     USE_WRAPPER := true, \
 223     EXTRA_ARGS := STATIC_LIBS=true, \
 224 ))
 225 
 226 ALL_TARGETS += $(STATIC_LIBS_TARGETS)
 227 
 228 ################################################################################
 229 # Targets for compiling native executables
 230 $(eval $(call DeclareRecipesForPhase, LAUNCHER, \
 231     TARGET_SUFFIX := launchers, \
 232     FILE_PREFIX := Launcher, \
 233     MAKE_SUBDIR := launcher, \
 234     CHECK_MODULES := $(ALL_MODULES), \
 235     USE_WRAPPER := true))
 236 
 237 ALL_TARGETS += $(LAUNCHER_TARGETS)
 238 
 239 ################################################################################
 240 # Build hotspot target
 241 
 242 HOTSPOT_VARIANT_TARGETS := $(addprefix hotspot-, $(JVM_VARIANTS))
 243 HOTSPOT_VARIANT_GENSRC_TARGETS := $(addsuffix -gensrc, $(HOTSPOT_VARIANT_TARGETS))
 244 HOTSPOT_VARIANT_LIBS_TARGETS := $(addsuffix -libs, $(HOTSPOT_VARIANT_TARGETS))
 245 
 246 define DeclareHotspotGensrcRecipe
 247   hotspot-$1-gensrc:
 248 	$$(call LogInfo, Building JVM variant &#39;$1&#39; with features &#39;$(JVM_FEATURES_$1)&#39;)
 249 	+($(CD) $(TOPDIR)/make/hotspot &amp;&amp; $(MAKE) $(MAKE_ARGS) -f gensrc/GenerateSources.gmk \
 250 	    JVM_VARIANT=$1)
 251 endef
 252 
 253 $(foreach v, $(JVM_VARIANTS), $(eval $(call DeclareHotspotGensrcRecipe,$v)))
 254 
 255 define DeclareHotspotLibsRecipe
 256   hotspot-$1-libs:
 257 	+($(CD) $(TOPDIR)/make/hotspot &amp;&amp; $(MAKE) $(MAKE_ARGS) -f lib/CompileLibraries.gmk \
 258 	    JVM_VARIANT=$1)
 259 endef
 260 
 261 $(foreach v, $(JVM_VARIANTS), $(eval $(call DeclareHotspotLibsRecipe,$v)))
 262 
 263 $(eval $(call SetupTarget, hotspot-ide-project, \
 264     MAKEFILE := ide/CreateVSProject, \
 265     DEPS := hotspot exploded-image, \
 266 ))
 267 
 268 ALL_TARGETS += $(HOTSPOT_VARIANT_TARGETS) $(HOTSPOT_VARIANT_GENSRC_TARGETS) \
 269     $(HOTSPOT_VARIANT_LIBS_TARGETS)
 270 
 271 ################################################################################
 272 # Generate libs and launcher targets for creating compile_commands.json fragments
 273 define DeclareCompileCommandsRecipe
 274   $1-compile-commands:
 275 	$$(call LogInfo, Generating compile_commands.json fragments for $1)
 276 	+($(CD) $(TOPDIR)/make &amp;&amp; $(MAKE) $(MAKE_ARGS) -f Main.gmk $1-only \
 277 	    GENERATE_COMPILE_COMMANDS_ONLY=true)
 278 
 279   COMPILE_COMMANDS_TARGETS_$2 += $1-compile-commands
 280 endef
 281 
 282 $(foreach t, $(HOTSPOT_VARIANT_LIBS_TARGETS), \
 283   $(eval $(call DeclareCompileCommandsRecipe,$t,HOTSPOT)) \
 284 )
 285 
 286 $(foreach t, $(LIBS_TARGETS) $(LAUNCHER_TARGETS), \
 287   $(eval $(call DeclareCompileCommandsRecipe,$t,JDK)) \
 288 )
 289 
 290 $(eval $(call SetupTarget, compile-commands, \
 291     MAKEFILE := CompileCommands, \
 292 ))
 293 
 294 $(eval $(call SetupTarget, compile-commands-hotspot, \
 295     MAKEFILE := CompileCommands, \
 296 ))
 297 
 298 ALL_TARGETS += $(COMPILE_COMMANDS_TARGETS_HOTSPOT) $(COMPILE_COMMANDS_TARGETS_JDK)
 299 
 300 ################################################################################
 301 # VS Code projects
 302 
 303 $(eval $(call SetupTarget, vscode-project, \
 304     MAKEFILE := CreateVSCodeProject, \
 305     ARGS := VSCODE_INDEXER=cpptools, \
 306     DEPS := compile-commands, \
 307 ))
 308 
 309 $(eval $(call SetupTarget, vscode-project-clangd, \
 310     MAKEFILE := CreateVSCodeProject, \
 311     ARGS := VSCODE_INDEXER=clangd, \
 312     DEPS := compile-commands, \
 313 ))
 314 
 315 $(eval $(call SetupTarget, vscode-project-rtags, \
 316     MAKEFILE := CreateVSCodeProject, \
 317     ARGS := VSCODE_INDEXER=rtags, \
 318     DEPS := compile-commands, \
 319 ))
 320 
 321 $(eval $(call SetupTarget, vscode-project-ccls, \
 322     MAKEFILE := CreateVSCodeProject, \
 323     ARGS := VSCODE_INDEXER=ccls, \
 324     DEPS := compile-commands, \
 325 ))
 326 
 327 ################################################################################
 328 # Build demos targets
 329 
 330 # The demos are currently linking to libjvm and libjava, just like all other
 331 # jdk libs, even though they don&#39;t need to. To avoid warnings, make sure they
 332 # aren&#39;t built until after libjava and libjvm are available to link to.
 333 $(eval $(call SetupTarget, demos-jdk, \
 334     MAKEFILE := CompileDemos, \
 335     DEPS := java.base-libs exploded-image, \
 336 ))
 337 
 338 $(eval $(call SetupTarget, test-image-demos-jdk, \
 339     MAKEFILE := CompileDemos, \
 340     TARGET := images, \
 341     DEPS := demos-jdk, \
 342 ))
 343 
 344 ################################################################################
 345 # Jigsaw specific data and analysis targets.
 346 
 347 $(eval $(call SetupTarget, generate-summary, \
 348     MAKEFILE := GenerateModuleSummary, \
 349     DEPS := jmods buildtools-modules, \
 350 ))
 351 
 352 ################################################################################
 353 # Jmod targets
 354 
 355 JMOD_MODULES := $(ALL_MODULES)
 356 JMOD_TARGETS := $(addsuffix -jmod, $(JMOD_MODULES))
 357 
 358 define DeclareJmodRecipe
 359   $1-jmod:
 360 	+($(CD) $(TOPDIR)/make &amp;&amp; $(MAKE) $(MAKE_ARGS) -f CreateJmods.gmk \
 361 	    MODULE=$1)
 362 endef
 363 
 364 $(foreach m, $(JMOD_MODULES), $(eval $(call DeclareJmodRecipe,$m)))
 365 
 366 ALL_TARGETS += $(JMOD_TARGETS)
 367 
 368 ################################################################################
 369 # Images targets
 370 
 371 $(eval $(call SetupTarget, store-source-revision, \
 372     MAKEFILE := SourceRevision, \
 373     TARGET := store-source-revision, \
 374 ))
 375 
 376 $(eval $(call SetupTarget, create-source-revision-tracker, \
 377     MAKEFILE := SourceRevision, \
 378     TARGET := create-source-revision-tracker, \
 379 ))
 380 
 381 BOOTCYCLE_TARGET := product-images
 382 bootcycle-images:
 383         ifneq ($(COMPILE_TYPE), cross)
 384 	  $(call LogWarn, Boot cycle build step 2: Building a new JDK image using previously built image)
 385 	  $(call MakeDir, $(OUTPUTDIR)/bootcycle-build)
 386 	  +$(MAKE) $(MAKE_ARGS) -f $(TOPDIR)/make/Init.gmk PARALLEL_TARGETS=$(BOOTCYCLE_TARGET) \
 387 	      LOG_PREFIX=&quot;[bootcycle] &quot; JOBS= SPEC=$(dir $(SPEC))bootcycle-spec.gmk main
 388         else
 389 	  $(call LogWarn, Boot cycle build disabled when cross compiling)
 390         endif
 391 
 392 $(eval $(call SetupTarget, zip-security, \
 393     MAKEFILE := ZipSecurity, \
 394     DEPS := java.base-java java.security.jgss-java java.security.jgss-libs, \
 395 ))
 396 
 397 $(eval $(call SetupTarget, zip-source, \
 398     MAKEFILE := ZipSource, \
 399     DEPS := gensrc, \
 400 ))
 401 
 402 $(eval $(call SetupTarget, jrtfs-jar, \
 403     MAKEFILE := JrtfsJar, \
 404     DEPS := interim-langtools, \
 405 ))
 406 
 407 $(eval $(call SetupTarget, jdk-image, \
 408     MAKEFILE := Images, \
 409     TARGET := jdk, \
 410     DEPS := jmods zip-source demos release-file, \
 411 ))
 412 
 413 $(eval $(call SetupTarget, legacy-jre-image, \
 414     MAKEFILE := Images, \
 415     TARGET := jre, \
 416     DEPS := jmods release-file, \
 417 ))
 418 
 419 $(eval $(call SetupTarget, symbols-image, \
 420     MAKEFILE := Images, \
 421     TARGET := symbols, \
 422 ))
 423 
 424 $(eval $(call SetupTarget, static-libs-image, \
 425     MAKEFILE := StaticLibsImage, \
 426 ))
 427 
 428 $(eval $(call SetupTarget, mac-jdk-bundle, \
 429     MAKEFILE := MacBundles, \
 430     TARGET := jdk-bundle, \
 431     DEPS := jdk-image, \
 432 ))
 433 
 434 $(eval $(call SetupTarget, mac-legacy-jre-bundle, \
 435     MAKEFILE := MacBundles, \
 436     TARGET := jre-bundle, \
 437     DEPS := legacy-jre-image, \
 438 ))
 439 
 440 $(eval $(call SetupTarget, release-file, \
 441     MAKEFILE := ReleaseFile, \
 442     DEPS := create-source-revision-tracker, \
 443 ))
 444 
 445 $(eval $(call SetupTarget, exploded-image-optimize, \
 446     MAKEFILE := ExplodedImageOptimize, \
 447     DEPS := java copy gendata java.base-libs java.base-launchers \
 448         buildtools-modules, \
 449 ))
 450 
 451 $(eval $(call SetupTarget, graal-builder-image, \
 452     MAKEFILE := GraalBuilderImage, \
 453     DEPS := jdk-image static-libs-image, \
 454 ))
 455 
 456 ifeq ($(JCOV_ENABLED), true)
 457   $(eval $(call SetupTarget, jcov-image, \
 458       MAKEFILE := Coverage, \
 459       TARGET := jcov-image, \
 460       DEPS := jdk-image, \
 461   ))
 462 endif
 463 
 464 ALL_TARGETS += bootcycle-images
 465 
 466 ################################################################################
 467 # Docs targets
 468 
 469 # If building full docs, to complete docs-*-api we need both the javadoc and
 470 # modulegraph targets.
 471 $(eval $(call SetupTarget, docs-jdk-api-javadoc, \
 472     MAKEFILE := Docs, \
 473     TARGET := docs-jdk-api-javadoc, \
 474 ))
 475 
 476 $(eval $(call SetupTarget, docs-jdk-api-modulegraph, \
 477     MAKEFILE := Docs, \
 478     TARGET := docs-jdk-api-modulegraph, \
 479     DEPS := exploded-image buildtools-modules, \
 480 ))
 481 
 482 $(eval $(call SetupTarget, docs-javase-api-javadoc, \
 483     MAKEFILE := Docs, \
 484     TARGET := docs-javase-api-javadoc, \
 485 ))
 486 
 487 $(eval $(call SetupTarget, docs-javase-api-modulegraph, \
 488     MAKEFILE := Docs, \
 489     TARGET := docs-javase-api-modulegraph, \
 490     DEPS := exploded-image buildtools-modules, \
 491 ))
 492 
 493 $(eval $(call SetupTarget, docs-reference-api-javadoc, \
 494     MAKEFILE := Docs, \
 495     TARGET := docs-reference-api-javadoc, \
 496 ))
 497 
 498 $(eval $(call SetupTarget, docs-reference-api-modulegraph, \
 499     MAKEFILE := Docs, \
 500     TARGET := docs-reference-api-modulegraph, \
 501     DEPS := exploded-image buildtools-modules, \
 502 ))
 503 
 504 # The gensrc steps for jdk.jdi create html spec files.
 505 $(eval $(call SetupTarget, docs-jdk-specs, \
 506     MAKEFILE := Docs, \
 507     TARGET := docs-jdk-specs, \
 508     DEPS := buildtools-jdk jdk.jdi-gensrc docs-jdk-index, \
 509 ))
 510 
 511 $(eval $(call SetupTarget, docs-jdk-index, \
 512     MAKEFILE := Docs, \
 513     TARGET := docs-jdk-index, \
 514 ))
 515 
 516 $(eval $(call SetupTarget, docs-zip, \
 517     MAKEFILE := Docs, \
 518     TARGET := docs-zip, \
 519     DEPS :=  docs-jdk, \
 520 ))
 521 
 522 $(eval $(call SetupTarget, docs-specs-zip, \
 523     MAKEFILE := Docs, \
 524     TARGET := docs-specs-zip, \
 525     DEPS := docs-jdk-specs, \
 526 ))
 527 
 528 $(eval $(call SetupTarget, update-build-docs, \
 529     MAKEFILE := UpdateBuildDocs, \
 530 ))
 531 
 532 $(eval $(call SetupTarget, update-x11wrappers, \
 533     MAKEFILE := UpdateX11Wrappers, \
 534     DEPS := java.base-copy buildtools-jdk, \
 535 ))
 536 
 537 ################################################################################
 538 # Cross compilation support
 539 
 540 ifeq ($(CREATING_BUILDJDK), true)
 541   # This target is only called by the recursive call below.
 542   create-buildjdk-interim-image-helper: interim-image jdk.jlink-launchers \
 543       java.base-copy jdk.jdeps-launchers
 544 endif
 545 
 546 BUILDJDK_MODULES := $(sort $(foreach m, jdk.jlink $(INTERIM_IMAGE_MODULES), \
 547     $(call FindTransitiveDepsForModule, $m) $m))
 548 
 549 $(eval $(call SetupTarget, create-buildjdk-interim-image, \
 550     MAKEFILE := Main, \
 551     TARGET := create-buildjdk-interim-image-helper, \
 552     ARGS := SPEC=$(dir $(SPEC))buildjdk-spec.gmk \
 553         HOTSPOT_SPEC=$(dir $(SPEC))buildjdk-spec.gmk \
 554         CREATING_BUILDJDK=true \
 555         LOG_PREFIX=&quot;[buildjdk] &quot; \
 556         JAVA_MODULES=&quot;$(BUILDJDK_MODULES)&quot;, \
 557 ))
 558 
 559 ################################################################################
 560 # The interim-image is a small jlinked image that is used to generate artifacts
 561 # at build time for use when linking the real images.
 562 
 563 INTERIM_JMOD_TARGETS := $(addsuffix -interim-jmod, $(INTERIM_IMAGE_MODULES))
 564 
 565 define DeclareInterimJmodRecipe
 566   $1-interim-jmod:
 567 	+($(CD) $(TOPDIR)/make &amp;&amp; $(MAKE) $(MAKE_ARGS) -f CreateJmods.gmk \
 568 	    MODULE=$1 \
 569 	    JMODS_DIR=$(INTERIM_JMODS_DIR) \
 570 	    JMODS_SUPPORT_DIR=$(INTERIM_JMODS_DIR)/support \
 571 	    INTERIM_JMOD=true \
 572 	)
 573 endef
 574 
 575 $(foreach m, $(INTERIM_IMAGE_MODULES), $(eval $(call DeclareInterimJmodRecipe,$m)))
 576 
 577 $(eval $(call SetupTarget, interim-image, \
 578     MAKEFILE := InterimImage, \
 579 ))
 580 
 581 ifeq ($(ENABLE_GENERATE_CLASSLIST), true)
 582   $(eval $(call SetupTarget, generate-link-opt-data, \
 583       MAKEFILE := GenerateLinkOptData, \
 584   ))
 585 endif
 586 
 587 ################################################################################
 588 # Generate test names for all JTReg test groups
 589 #
 590 
 591 define DeclareRunTestRecipe
 592   test-$1:
 593 	+($(CD) $(TOPDIR)/make &amp;&amp; $(MAKE) $(MAKE_ARGS) -f RunTests.gmk \
 594 	    TEST=&quot;$1&quot;)
 595 
 596   exploded-test-$1:
 597 	+($(CD) $(TOPDIR)/make &amp;&amp; $(MAKE) $(MAKE_ARGS) -f RunTests.gmk \
 598 	    TEST=&quot;$1&quot; JDK_IMAGE_DIR=$(JDK_OUTPUTDIR))
 599 endef
 600 
 601 # ALL_NAMED_TESTS is defined in FindTests.gmk
 602 $(foreach t, $(ALL_NAMED_TESTS), $(eval $(call DeclareRunTestRecipe,$t)))
 603 ALL_TEST_TARGETS := $(addprefix test-, $(ALL_NAMED_TESTS))
 604 
 605 # We only support the &quot;exploded-test-gtest&quot; shortcut
 606 ALL_EXPLODED_TESTS := gtest
 607 ALL_EXPLODED_TEST_TARGETS := $(addprefix exploded-test-, $(ALL_EXPLODED_TESTS))
 608 
 609 ALL_TARGETS += $(ALL_TEST_TARGETS) $(ALL_EXPLODED_TEST_TARGETS)
 610 
 611 ################################################################################
 612 # Build tests and microbenchmarks
 613 #
 614 
 615 $(eval $(call SetupTarget, prepare-test-image, \
 616     MAKEFILE := TestImage, \
 617     TARGET := prepare-test-image, \
 618 ))
 619 
 620 $(eval $(call SetupTarget, build-test-hotspot-jtreg-native, \
 621     MAKEFILE := test/JtregNativeHotspot, \
 622     TARGET := build-test-hotspot-jtreg-native, \
 623     DEPS := buildtools-jdk, \
 624 ))
 625 
 626 $(eval $(call SetupTarget, test-image-hotspot-jtreg-native, \
 627     MAKEFILE := test/JtregNativeHotspot, \
 628     TARGET := test-image-hotspot-jtreg-native, \
 629     DEPS := build-test-hotspot-jtreg-native, \
 630 ))
 631 
 632 $(eval $(call SetupTarget, build-test-jdk-jtreg-native, \
 633     MAKEFILE := test/JtregNativeJdk, \
 634     TARGET := build-test-jdk-jtreg-native, \
 635     DEPS := buildtools-jdk java.base-libs, \
 636 ))
 637 
 638 $(eval $(call SetupTarget, test-image-jdk-jtreg-native, \
 639     MAKEFILE := test/JtregNativeJdk, \
 640     TARGET := test-image-jdk-jtreg-native, \
 641     DEPS := build-test-jdk-jtreg-native, \
 642 ))
 643 
 644 $(eval $(call SetupTarget, build-test-hotspot-jtreg-graal, \
 645     MAKEFILE := test/JtregGraalUnit, \
 646     TARGET := build-test-hotspot-jtreg-graal, \
 647     DEPS := exploded-image, \
 648 ))
 649 
 650 $(eval $(call SetupTarget, test-image-hotspot-jtreg-graal, \
 651     MAKEFILE := test/JtregGraalUnit, \
 652     TARGET := test-image-hotspot-jtreg-graal, \
 653     DEPS := build-test-hotspot-jtreg-graal, \
 654 ))
 655 
 656 ifeq ($(BUILD_GTEST), true)
 657   $(eval $(call SetupTarget, test-image-hotspot-gtest, \
 658       MAKEFILE := hotspot/test/GtestImage, \
 659       DEPS := hotspot, \
 660   ))
 661 endif
 662 
 663 $(eval $(call SetupTarget, build-test-lib, \
 664     MAKEFILE := test/BuildTestLib, \
 665     DEPS := exploded-image, \
 666 ))
 667 
 668 ifeq ($(BUILD_FAILURE_HANDLER), true)
 669   # Builds the failure handler jtreg extension
 670   $(eval $(call SetupTarget, build-test-failure-handler, \
 671       MAKEFILE := test/BuildFailureHandler, \
 672       TARGET := build, \
 673       DEPS := interim-langtools, \
 674   ))
 675 
 676   # Copies the failure handler jtreg extension into the test image
 677   $(eval $(call SetupTarget, test-image-failure-handler, \
 678       MAKEFILE := test/BuildFailureHandler, \
 679       TARGET := images, \
 680       DEPS := build-test-failure-handler, \
 681   ))
 682 endif
 683 
 684 $(eval $(call SetupTarget, build-microbenchmark, \
 685     MAKEFILE := test/BuildMicrobenchmark, \
 686     DEPS := interim-langtools exploded-image, \
 687 ))
 688 
 689 ################################################################################
 690 # Run tests
 691 
 692 $(eval $(call SetupTarget, test, \
 693     MAKEFILE := RunTests, \
 694     ARGS := TEST=&quot;$(TEST)&quot;, \
 695     DEPS := jdk-image test-image, \
 696 ))
 697 
 698 $(eval $(call SetupTarget, exploded-test, \
 699     MAKEFILE := RunTests, \
 700     ARGS := TEST=&quot;$(TEST)&quot; JDK_IMAGE_DIR=$(JDK_OUTPUTDIR), \
 701     DEPS := exploded-image test-image, \
 702 ))
 703 
 704 ifeq ($(JCOV_ENABLED), true)
 705   $(eval $(call SetupTarget, jcov-test, \
 706       MAKEFILE := RunTests, \
 707       ARGS := TEST=&quot;$(TEST)&quot; TEST_OPTS_JCOV=true, \
 708       DEPS := jcov-image test-image, \
 709   ))
 710 endif
 711 
 712 ################################################################################
 713 # Bundles
 714 
 715 $(eval $(call SetupTarget, product-bundles, \
 716     MAKEFILE := Bundles, \
 717     TARGET := product-bundles, \
 718     DEPS := product-images, \
 719 ))
 720 
 721 $(eval $(call SetupTarget, legacy-bundles, \
 722     MAKEFILE := Bundles, \
 723     TARGET := legacy-bundles, \
 724     DEPS := legacy-images, \
 725 ))
 726 
 727 $(eval $(call SetupTarget, test-bundles, \
 728     MAKEFILE := Bundles, \
 729     TARGET := test-bundles, \
 730     DEPS := test-image, \
 731 ))
 732 
 733 $(eval $(call SetupTarget, docs-bundles, \
 734     MAKEFILE := Bundles, \
 735     TARGET := docs-bundles, \
 736     DEPS := docs-image, \
 737 ))
 738 
 739 $(eval $(call SetupTarget, static-libs-bundles, \
 740     MAKEFILE := Bundles, \
 741     TARGET := static-libs-bundles, \
 742     DEPS := static-libs-image, \
 743 ))
 744 
 745 ifeq ($(JCOV_ENABLED), true)
 746   $(eval $(call SetupTarget, jcov-bundles, \
 747       MAKEFILE := Bundles, \
 748       TARGET := jcov-bundles, \
 749       DEPS := jcov-image, \
 750   ))
 751 endif
 752 
 753 ################################################################################
 754 # Install targets
 755 
 756 $(eval $(call SetupTarget, install, \
 757     MAKEFILE := Install, \
 758     DEPS := product-images, \
 759 ))
 760 
 761 ################################################################################
 762 #
 763 # Dependency declarations between targets.
 764 #
 765 # These are declared in two groups. First all dependencies between targets that
 766 # have recipes above as these dependencies may be disabled. Then the aggregator
 767 # targets that do not have recipes of their own, which will never have their
 768 # dependencies disabled.
 769 #
 770 ################################################################################
 771 # Targets with recipes above
 772 
 773 # If running an *-only target, parallel execution and dependencies between
 774 # recipe targets are disabled. This makes it possible to run a select set of
 775 # recipe targets in order. It&#39;s the responsibility of the user to make sure
 776 # all prerequisites are fulfilled.
 777 ifeq ($(DEPS), none)
 778   .NOTPARALLEL:
 779 else
 780   $(LANGTOOLS_GENSRC_TARGETS): buildtools-langtools
 781 
 782   interim-langtools: $(INTERIM_LANGTOOLS_GENSRC_TARGETS)
 783 
 784   $(HOTSPOT_GENSRC_TARGETS): interim-langtools buildtools-hotspot
 785 
 786   $(JDK_GENSRC_TARGETS): interim-langtools buildtools-jdk
 787 
 788   $(GENSRC_MODULEINFO_TARGETS): buildtools-jdk
 789 
 790   $(GENDATA_TARGETS): interim-langtools buildtools-jdk
 791 
 792   $(JAVA_TARGETS): interim-langtools
 793 
 794   # Declare dependencies between hotspot-&lt;variant&gt;* targets
 795   $(foreach v, $(JVM_VARIANTS), \
 796       $(eval hotspot-$v-gensrc: java.base-copy) \
 797       $(eval hotspot-$v-libs: hotspot-$v-gensrc java.base-copy) \
 798   )
 799 
 800   # If not already set, set the JVM variant target so that the JVM will be built.
 801   JVM_MAIN_LIB_TARGETS ?= hotspot-$(JVM_VARIANT_MAIN)-libs
 802 
 803   # Building one JVM variant is enough to start building the other libs
 804   $(LIBS_TARGETS): $(JVM_MAIN_LIB_TARGETS)
 805 
 806   $(LAUNCHER_TARGETS): java.base-libs
 807 
 808   ifeq ($(STATIC_BUILD), true)
 809     $(LAUNCHER_TARGETS): generate-exported-symbols
 810   endif
 811 
 812   # Declare dependency from &lt;module&gt;-java to &lt;module&gt;-gensrc
 813   $(foreach m, $(GENSRC_MODULES), $(eval $m-java: $m-gensrc))
 814 
 815   # Declare dependencies between java modules
 816   $(foreach m, $(JAVA_MODULES), \
 817       $(eval $m-java: $(addsuffix -java, $(filter $(JAVA_MODULES), \
 818       $(call FindDepsForModule,$m)))))
 819   # Declare dependencies between the module meta targets
 820   $(foreach m, $(ALL_MODULES), $(eval $m: $(call FindDepsForModule,$m)))
 821 
 822   # Declare dependencies from &lt;module&gt;-lib to &lt;module&gt;-java
 823   # Skip modules that do not have java source.
 824   $(foreach m, $(filter $(JAVA_MODULES), $(LIBS_MODULES)), $(eval $m-libs: $m-java))
 825 
 826   # Declare dependencies from all other &lt;module&gt;-lib to java.base-lib
 827   $(foreach t, $(filter-out java.base-libs, $(LIBS_TARGETS)), \
 828       $(eval $t: java.base-libs))
 829 
 830   # jdk.accessibility depends on java.desktop
 831   jdk.accessibility-libs: java.desktop-libs
 832 
 833   # This dependency needs to be explicitly declared. jdk.jdi-gensrc generates a
 834   # header file used by jdk.jdwp.agent-libs. The jdk.jdwp.agent-gensrc is a
 835   # virtual target.
 836   jdk.jdwp.agent-libs: jdk.jdwp.agent-gensrc
 837 
 838   # The swing beans need to have java base properly generated to avoid errors
 839   # in javadoc. The X11 wrappers need the java.base include files to have been
 840   # copied and processed.
 841   java.desktop-gensrc-src: java.base-gensrc java.base-copy
 842 
 843   # The annotation processing for jdk.internal.vm.compiler
 844   # and jdk.internal.vm.compiler.management needs classes from the current JDK.
 845   jdk.internal.vm.compiler-gensrc-src: $(addsuffix -java, \
 846       $(call FindTransitiveDepsForModule, jdk.internal.vm.compiler))
 847   jdk.internal.vm.compiler.management-gensrc-src: $(addsuffix -java, \
 848       $(call FindTransitiveDepsForModule, jdk.internal.vm.compiler.management))
 849 
 850   # For these modules, the gensrc step is generating a module-info.java.extra
 851   # file to be processed by the gensrc-moduleinfo target.
 852   jdk.internal.vm.compiler-gensrc-moduleinfo: jdk.internal.vm.compiler-gensrc-src
 853   jdk.internal.vm.compiler.management-gensrc-moduleinfo: jdk.internal.vm.compiler.management-gensrc-src
 854 
 855   jdk.jdeps-gendata: java
 856 
 857   # The ct.sym generation uses all the moduleinfos as input
 858   jdk.compiler-gendata: $(GENSRC_MODULEINFO_TARGETS)
 859 
 860   # Declare dependencies between jmod targets.
 861   # java.base jmod needs jrt-fs.jar and access to the other jmods to be built.
 862   # When creating the BUILDJDK, we don&#39;t need to add hashes to java.base, thus
 863   # we don&#39;t need to depend on all other jmods
 864   ifneq ($(CREATING_BUILDJDK), true)
 865     java.base-jmod: jrtfs-jar $(filter-out java.base-jmod, $(JMOD_TARGETS))
 866   endif
 867 
 868   # If not already set, set the JVM target so that the JVM will be built.
 869   JVM_MAIN_TARGETS ?= hotspot
 870 
 871   # Building java.base-jmod requires all of VM (ie hotspot) to be built.
 872   java.base-jmod: $(JVM_MAIN_TARGETS)
 873 
 874   # Declare dependencies from &lt;module&gt;-jmod to all other module targets
 875   $(foreach m, $(JAVA_MODULES), $(eval $m_JMOD_DEPS += $m-java))
 876   $(foreach m, $(GENDATA_MODULES), $(eval $m_JMOD_DEPS += $m-gendata))
 877   $(foreach m, $(LIBS_MODULES), $(eval $m_JMOD_DEPS += $m-libs))
 878   $(foreach m, $(LAUNCHER_MODULES), $(eval $m_JMOD_DEPS += $m-launchers))
 879   $(foreach m, $(COPY_MODULES), $(eval $m_JMOD_DEPS += $m-copy))
 880   $(foreach m, $(ALL_MODULES), $(eval $m-jmod: $($(m)_JMOD_DEPS)))
 881   $(foreach m, $(INTERIM_IMAGE_MODULES), $(eval $m-interim-jmod: $($(m)_JMOD_DEPS)))
 882 
 883   # Setup the minimal set of generated native source dependencies for hotspot
 884   $(foreach v, $(JVM_VARIANTS), \
 885     $(eval hotspot-$v-libs-compile-commands: hotspot-$v-gensrc) \
 886     $(foreach m, $(filter java.desktop jdk.hotspot.agent, $(GENSRC_MODULES)), \
 887       $(eval hotspot-$v-libs-compile-commands: $m-gensrc)) \
 888   )
 889 
 890   # For the full JDK compile commands, create all possible generated sources
 891   $(foreach m, $(GENSRC_MODULES), $(eval $m-libs-compile-commands: $m-gensrc))
 892   $(foreach m, $(filter $(JAVA_MODULES), $(LIBS_MODULES)), $(eval $m-libs-compile-commands: $m-java))
 893 
 894   $(COMPILE_COMMANDS_TARGETS_HOTSPOT): clean-compile-commands
 895   $(COMPILE_COMMANDS_TARGETS_JDK): clean-compile-commands
 896   compile-commands-hotspot: $(COMPILE_COMMANDS_TARGETS_HOTSPOT)
 897   compile-commands: $(COMPILE_COMMANDS_TARGETS_HOTSPOT) $(COMPILE_COMMANDS_TARGETS_JDK)
 898 
 899   # The -static-libs targets depend on -java as well as java.base-copy.
 900   $(foreach m, $(filter $(JAVA_MODULES), $(STATIC_LIBS_MODULES)), \
 901     $(eval $m-static-libs: $m-java java.base-copy))
 902 
 903   # Jmods cannot be created until we have the jmod tool ready to run. During
 904   # a normal build we run it from the exploded image, but when cross compiling
 905   # it&#39;s run from the buildjdk, which is either created at build time or user
 906   # supplied.
 907   ifeq ($(CREATE_BUILDJDK), true)
 908     ifneq ($(CREATING_BUILDJDK), true)
 909       # When cross compiling and buildjdk is to be created, simply depend on
 910       # creating the buildjdk.
 911       $(JMOD_TARGETS): create-buildjdk
 912       buildtools-modules: create-buildjdk
 913     else
 914       # While actually creating the buildjdk, we need to list the bare
 915       # minimum dependencies needed before running jmod, to avoid building
 916       # more than necessary. This includes:
 917       # * all java modules
 918       # * jdk.jlink-launchers
 919       # * copy jvm.cfg (done in java.base-copy)
 920       # * tzdb.dat (done in java.base-gendata)
 921       # Without all of these jimage, jlink and jmod won&#39;t start.
 922       $(JMOD_TARGETS) $(INTERIM_JMOD_TARGETS): java.base-libs java.base-copy \
 923           java.base-gendata jdk.jlink-launchers java
 924     endif
 925   else
 926     # The normal non cross compilation case uses needs to wait for the full
 927     # exploded-image to avoid a race with the optimize target.
 928     $(JMOD_TARGETS) $(INTERIM_JMOD_TARGETS): exploded-image
 929   endif
 930 
 931   # All modules include the main license files from java.base.
 932   $(JMOD_TARGETS): java.base-copy
 933 
 934   zip-security: $(filter jdk.crypto%, $(JAVA_TARGETS))
 935 
 936   ifeq ($(ENABLE_GENERATE_CLASSLIST), true)
 937     ifeq ($(CREATE_BUILDJDK), true)
 938       # If creating a buildjdk, the interim image needs to be based on that.
 939       generate-link-opt-data: create-buildjdk
 940     else ifeq ($(EXTERNAL_BUILDJDK), false)
 941       # If an external buildjdk has been provided, we skip generating an
 942       # interim-image and just use the external buildjdk for generating
 943       # classlist.
 944       generate-link-opt-data: interim-image
 945     endif
 946     generate-link-opt-data: buildtools-jdk
 947 
 948     # The generated classlist needs to go into java.base-jmod.
 949     java.base-jmod jdk.jlink-jmod jdk-image legacy-jre-image: generate-link-opt-data
 950   endif
 951 
 952   symbols-image: $(LIBS_TARGETS) $(LAUNCHER_TARGETS)
 953 
 954   static-libs-image: $(STATIC_LIBS_TARGETS)
 955 
 956   bootcycle-images: jdk-image
 957 
 958   docs-jdk-api-javadoc: $(GENSRC_TARGETS)
 959 
 960   docs-javase-api-javadoc: $(GENSRC_TARGETS)
 961 
 962   docs-reference-api-javadoc: $(GENSRC_TARGETS)
 963 
 964   # If not already set, then set the JVM specific docs targets
 965   JVM_DOCS_TARGETS ?= hotspot-$(JVM_VARIANT_MAIN)-gensrc
 966 
 967   # The gensrc steps for hotspot create html spec files.
 968   docs-jdk-specs: $(JVM_DOCS_TARGETS)
 969 
 970   # Tests
 971   test-make: clean-test-make compile-commands
 972 
 973   test-make-compile-commands: compile-commands
 974 
 975   # Declare dependency for all generated test targets
 976   $(foreach t, $(filter-out test-make%, $(ALL_TEST_TARGETS)), $(eval $t: jdk-image test-image))
 977   $(foreach t, $(ALL_EXPLODED_TEST_TARGETS), $(eval $t: exploded-image test-image))
 978 
 979   interim-image: $(INTERIM_JMOD_TARGETS)
 980 
 981   build-test-hotspot-jtreg-native: hotspot-$(JVM_VARIANT_MAIN)-libs
 982 
 983 endif
 984 
 985 ################################################################################
 986 # Virtual targets without recipes
 987 
 988 # If not already set, set the JVM specific tools targets
 989 JVM_TOOLS_TARGETS ?= buildtools-hotspot
 990 buildtools: buildtools-langtools interim-langtools \
 991     buildtools-jdk $(JVM_TOOLS_TARGETS)
 992 
 993 # Declare dependencies from hotspot-&lt;variant&gt; targets
 994 $(foreach v, $(JVM_VARIANTS), \
 995   $(eval hotspot-$v: hotspot-$v-gensrc hotspot-$v-libs) \
 996 )
 997 hotspot: $(HOTSPOT_VARIANT_TARGETS)
 998 
 999 # Create targets hotspot-libs and hotspot-gensrc.
1000 $(foreach v, $(JVM_VARIANTS), \
1001   $(eval hotspot-libs: hotspot-$v-libs) \
1002   $(eval hotspot-gensrc: hotspot-$v-gensrc) \
1003 )
1004 
1005 gensrc: $(GENSRC_TARGETS)
1006 
1007 gendata: $(GENDATA_TARGETS)
1008 
1009 copy: $(ALL_COPY_TARGETS)
1010 
1011 java: $(JAVA_TARGETS)
1012 
1013 libs: $(LIBS_TARGETS)
1014 
1015 static-libs: $(STATIC_LIBS_TARGETS)
1016 
1017 launchers: $(LAUNCHER_TARGETS)
1018 
1019 jmods: $(JMOD_TARGETS)
1020 
1021 # Explicitly declare dependency for virtual target jdk.jdwp.agent-gensrc which
1022 # is actually handled by jdk.jdi-gensrc
1023 jdk.jdwp.agent-gensrc: jdk.jdi-gensrc
1024 
1025 # Declare dependencies from &lt;module&gt; to all the individual targets specific
1026 # to that module &lt;module&gt;-*, that are needed for the exploded image.
1027 $(foreach m, $(GENSRC_MODULES), $(eval $m: $m-gensrc))
1028 $(foreach m, $(JAVA_MODULES), $(eval $m: $m-java))
1029 $(foreach m, $(GENDATA_MODULES), $(eval $m: $m-gendata))
1030 $(foreach m, $(LIBS_MODULES), $(eval $m: $m-libs))
1031 $(foreach m, $(LAUNCHER_MODULES), $(eval $m: $m-launchers))
1032 $(foreach m, $(ALL_COPY_MODULES), $(eval $m: $m-copy))
1033 
1034 # Building java.base includes building all of hotspot.
1035 java.base: $(JVM_MAIN_TARGETS)
1036 
1037 demos: demos-jdk
1038 
1039 # The &quot;exploded image&quot; is a locally runnable JDK in $(OUTPUTDIR)/jdk.
1040 exploded-image-base: $(ALL_MODULES)
1041 exploded-image: exploded-image-base release-file
1042 # When cross compiling, no need to optimize the exploded image since it won&#39;t
1043 # be runnable on the host platform anyway.
1044 ifneq ($(COMPILE_TYPE), cross)
1045   exploded-image: exploded-image-optimize
1046 endif
1047 
1048 create-buildjdk: create-buildjdk-interim-image
1049 
1050 docs-jdk-api: docs-jdk-api-javadoc
1051 docs-javase-api: docs-javase-api-javadoc
1052 docs-reference-api: docs-reference-api-javadoc
1053 
1054 # If we&#39;re building full docs, we must also generate the module graphs to
1055 # get non-broken api documentation.
1056 ifeq ($(ENABLE_FULL_DOCS), true)
1057   docs-jdk-api: docs-jdk-api-modulegraph
1058   docs-javase-api: docs-javase-api-modulegraph
1059   docs-reference-api: docs-reference-api-modulegraph
1060 endif
1061 
1062 docs-jdk: docs-jdk-api docs-jdk-specs docs-jdk-index
1063 docs-javase: docs-javase-api
1064 docs-reference: docs-reference-api
1065 
1066 # alias for backwards compatibility
1067 docs-javadoc: docs-jdk-api
1068 
1069 mac-bundles: mac-jdk-bundle
1070 
1071 # The $(OUTPUTDIR)/images directory contain the resulting deliverables,
1072 # and in line with this, our targets for creating these are named *-image[s].
1073 
1074 # This target builds the product images, e.g. the JDK image
1075 # (and possibly other, more specific versions)
1076 product-images: jdk-image symbols-image exploded-image
1077 
1078 # This target builds the legacy images, e.g. the legacy JRE image
1079 legacy-images: legacy-jre-image
1080 
1081 # zip-security is actually a bundle, but for now it needs to be considered
1082 # an image until this can be cleaned up properly.
1083 product-images: zip-security
1084 
1085 # The module summary cannot be run when:
1086 # * Cross compiling and building a partial BUILDJDK for the build host
1087 # * An external buildjdk has been supplied since it may not match the
1088 #   module selection of the target jdk
1089 ifneq ($(CREATE_BUILDJDK), true)
1090   ifeq ($(EXTERNAL_BUILDJDK), false)
1091     product-images: generate-summary
1092   endif
1093 endif
1094 
1095 ifeq ($(call isTargetOs, macosx), true)
1096   product-images: mac-jdk-bundle
1097 
1098   legacy-images: mac-legacy-jre-bundle
1099 endif
1100 
1101 # This target builds the documentation image
1102 docs-image: docs-jdk
1103 
1104 # If not already set, set the JVM specific targets to build the test image
1105 JVM_TEST_IMAGE_TARGETS ?= test-image-hotspot-jtreg-native test-image-hotspot-gtest
1106 
1107 ifeq ($(INCLUDE_GRAAL), true)
1108   JVM_TEST_IMAGE_TARGETS += test-image-hotspot-jtreg-graal
1109 endif
1110 
1111 # This target builds the test image
1112 test-image: prepare-test-image test-image-jdk-jtreg-native \
1113     test-image-demos-jdk $(JVM_TEST_IMAGE_TARGETS)
1114 
1115 ifeq ($(BUILD_FAILURE_HANDLER), true)
1116   test-image: test-image-failure-handler
1117 endif
1118 
1119 ifneq ($(JMH_CORE_JAR), )
1120   test-image: build-microbenchmark
1121 endif
1122 
1123 ################################################################################
1124 
1125 # all-images builds all our deliverables as images.
1126 all-images: product-images test-image docs-image
1127 
1128 # all-bundles packages all our deliverables as tar.gz bundles.
1129 all-bundles: product-bundles test-bundles docs-bundles static-libs-bundles
1130 
1131 ALL_TARGETS += buildtools hotspot hotspot-libs hotspot-gensrc gensrc gendata \
1132     copy java libs static-libs launchers jmods \
1133     jdk.jdwp.agent-gensrc $(ALL_MODULES) demos \
1134     exploded-image-base exploded-image \
1135     create-buildjdk docs-jdk-api docs-javase-api docs-reference-api docs-jdk \
1136     docs-javase docs-reference docs-javadoc mac-bundles product-images legacy-images \
1137     docs-image test-image all-images \
1138     all-bundles
1139 
1140 ################################################################################
1141 
1142 # Traditional targets typically run by users.
1143 # These can be considered aliases for the targets now named by a more
1144 # &quot;modern&quot; naming scheme.
1145 default: $(DEFAULT_MAKE_TARGET)
1146 jdk: exploded-image
1147 images: product-images
1148 docs: docs-image
1149 bundles: all-bundles
1150 all: all-images
1151 
1152 ALL_TARGETS += default jdk images docs bundles all
1153 
1154 # Aliases used for running tests.
1155 
1156 # Let &quot;run-test&quot; be an alias for &quot;test&quot;
1157 $(foreach t, $(ALL_NAMED_TESTS), $(eval run-test-$t: test-$t))
1158 RUN_TEST_TARGETS := $(addprefix run-test-, $(ALL_NAMED_TESTS))
1159 
1160 run-test: test
1161 exploded-run-test: exploded-test
1162 
1163 # &quot;make check&quot; is a common idiom for running basic testing
1164 check: test-tier1
1165 
1166 # Keep some old names as aliases
1167 test-hotspot-jtreg: test-hotspot_all
1168 test-hotspot-jtreg-native: test-hotspot_native_sanity
1169 test-hotspot-gtest: exploded-test-gtest
1170 test-jdk-jtreg-native: test-jdk_native_sanity
1171 
1172 ALL_TARGETS += $(RUN_TEST_TARGETS) run-test exploded-run-test check \
1173     test-hotspot-jtreg test-hotspot-jtreg-native test-hotspot-gtest \
1174     test-jdk-jtreg-native
1175 
1176 ################################################################################
1177 ################################################################################
1178 #
1179 # Clean targets
1180 #
1181 ################################################################################
1182 # Clean targets are automatically run serially by the Makefile calling this
1183 # file.
1184 
1185 CLEAN_DIRS += hotspot jdk bootcycle-build test buildtools support \
1186     images make-support test-make bundles buildjdk test-results test-support \
1187     support/images
1188 CLEAN_DIR_TARGETS := $(addprefix clean-, $(CLEAN_DIRS))
1189 CLEAN_SUPPORT_DIRS += demos
1190 CLEAN_SUPPORT_DIR_TARGETS := $(addprefix clean-, $(CLEAN_SUPPORT_DIRS))
1191 CLEAN_TESTS += hotspot-jtreg-native jdk-jtreg-native lib
1192 CLEAN_TEST_TARGETS += $(addprefix clean-test-, $(CLEAN_TESTS))
1193 CLEAN_PHASES := gensrc java native include
1194 CLEAN_PHASE_TARGETS := $(addprefix clean-, $(CLEAN_PHASES))
1195 CLEAN_MODULE_TARGETS := $(addprefix clean-, $(ALL_MODULES))
1196 # Construct targets of the form clean-$module-$phase
1197 CLEAN_MODULE_PHASE_TARGETS := $(addprefix clean-, $(foreach m, $(ALL_MODULES), \
1198     $(addprefix $m-, $(CLEAN_PHASES))))
1199 
1200 # Remove everything, except the output from configure.
1201 clean: $(CLEAN_DIR_TARGETS)
1202 	($(CD) $(OUTPUTDIR) &amp;&amp; $(RM) -r build*.log* compile_commands.json)
1203 	$(ECHO) Cleaned all build artifacts.
1204 
1205 clean-docs:
1206 	$(call CleanDocs)
1207 
1208 clean-compile-commands:
1209 	$(call CleanMakeSupportDir,compile-commands)
1210 
1211 $(CLEAN_DIR_TARGETS):
1212 	$(call CleanDir,$(patsubst clean-%, %, $@))
1213 
1214 $(CLEAN_SUPPORT_DIR_TARGETS):
1215 	$(call CleanSupportDir,$(patsubst clean-%, %, $@))
1216 
1217 $(CLEAN_TEST_TARGETS):
1218 	$(call CleanTest,$(patsubst clean-test-%, %, $@))
1219 
1220 $(CLEAN_PHASE_TARGETS):
1221 	$(call Clean-$(patsubst clean-%,%, $@))
1222 
1223 $(CLEAN_MODULE_TARGETS):
1224 	$(call CleanModule,$(patsubst clean-%, %, $@))
1225 
1226 $(CLEAN_MODULE_PHASE_TARGETS):
1227 	$(call Clean-$(word 3, $(subst -,$(SPACE),$@)), \
1228 	    $(word 2, $(subst -,$(SPACE),$@)))
1229 
1230 # When removing the support dir, we must also remove jdk. Building classes has
1231 # the side effect of generating native headers. The headers end up in support
1232 # while classes and touch files end up in jdk.
1233 clean-support: clean-jdk
1234 
1235 clean-test: clean-test-results clean-test-support
1236 
1237 # When cleaning images, also clean the support/images directory.
1238 clean-images: clean-support/images
1239 
1240 # Remove everything, including configure configuration. If the output
1241 # directory was created by configure and now becomes empty, remove it as well.
1242 dist-clean: clean
1243 	($(CD) $(OUTPUTDIR) &amp;&amp; \
1244 	    $(RM) -r *spec.gmk $(CONFIGURESUPPORT_OUTPUTDIR) Makefile compare.sh ide \
1245 	    configure.log* build.log*)
1246 	$(if $(filter $(CONF_NAME),$(notdir $(OUTPUTDIR))), \
1247 	  if test &quot;x`$(LS) $(OUTPUTDIR)`&quot; != x; then \
1248 	    $(ECHO) &quot;Warning: Not removing non-empty configuration directory for &#39;$(CONF_NAME)&#39;&quot; ; \
1249 	  else \
1250 	    ($(CD) $(TOPDIR) &amp;&amp; $(ECHO) &quot;Removing configuration directory for &#39;$(CONF_NAME)&#39;&quot; \
1251 	        &amp;&amp; $(RM) -r $(OUTPUTDIR)) \
1252 	  fi \
1253 	)
1254 	$(ECHO) Cleaned everything, you will have to re-run configure.
1255 
1256 ALL_TARGETS += clean clean-docs clean-compile-commands dist-clean $(CLEAN_DIR_TARGETS) \
1257     $(CLEAN_SUPPORT_DIR_TARGETS) $(CLEAN_TEST_TARGETS) $(CLEAN_PHASE_TARGETS) \
1258     $(CLEAN_MODULE_TARGETS) $(CLEAN_MODULE_PHASE_TARGETS)
1259 
1260 ################################################################################
1261 # Declare *-only targets for each normal target
1262 $(foreach t, $(ALL_TARGETS), $(eval $(t)-only: $(t)))
1263 
1264 ALL_TARGETS += $(addsuffix -only, $(filter-out dist-clean clean%, $(ALL_TARGETS)))
1265 
1266 ################################################################################
1267 
1268 # The following targets are intentionally not added to ALL_TARGETS since they
1269 # are internal only, to support Init.gmk.
1270 
1271 print-targets:
1272 	  @$(ECHO) $(sort $(ALL_TARGETS))
1273 
1274 print-modules:
1275 	  @$(ECHO) $(sort $(ALL_MODULES))
1276 
1277 print-tests:
1278 	  @$(ECHO) $(sort $(ALL_NAMED_TESTS))
1279 
1280 create-main-targets-include:
1281 	  $(call LogInfo, Generating main target list)
1282 	  @$(ECHO) ALL_MAIN_TARGETS := $(sort $(ALL_TARGETS)) &gt; \
1283 	      $(MAKESUPPORT_OUTPUTDIR)/main-targets.gmk
1284 
1285 ################################################################################
1286 # Hook to include the corresponding custom file, if present.
1287 $(eval $(call IncludeCustomExtension, Main-post.gmk))
1288 
1289 .PHONY: $(ALL_TARGETS)
1290 
1291 FRC: # Force target
    </pre>
  </body>
</html>