<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Old make/MainSupport.gmk</title>
    <link rel="stylesheet" href="../style.css" />
  </head>
  <body>
    <pre>
  1 #
  2 # Copyright (c) 2011, 2020, Oracle and/or its affiliates. All rights reserved.
  3 # DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4 #
  5 # This code is free software; you can redistribute it and/or modify it
  6 # under the terms of the GNU General Public License version 2 only, as
  7 # published by the Free Software Foundation.  Oracle designates this
  8 # particular file as subject to the &quot;Classpath&quot; exception as provided
  9 # by Oracle in the LICENSE file that accompanied this code.
 10 #
 11 # This code is distributed in the hope that it will be useful, but WITHOUT
 12 # ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 13 # FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 14 # version 2 for more details (a copy is included in the LICENSE file that
 15 # accompanied this code).
 16 #
 17 # You should have received a copy of the GNU General Public License version
 18 # 2 along with this work; if not, write to the Free Software Foundation,
 19 # Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 20 #
 21 # Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 22 # or visit www.oracle.com if you need additional information or have any
 23 # questions.
 24 #
 25 
 26 ################################################################################
 27 # This file contains helper functions for Main.gmk.
 28 ################################################################################
 29 
 30 ifndef _MAINSUPPORT_GMK
 31 _MAINSUPPORT_GMK := 1
 32 
 33 # Setup make rules for creating a top-level target.
 34 # Parameter 1 is the name of the rule. This name is used as variable prefix.
 35 #
 36 # Remaining parameters are named arguments. These include:
 37 #   MAKEFILE the makefile to delegate to
 38 #   TARGET the makefile target
 39 #   ARGS arguments to the makefile
 40 #   DEPS the target(s) this new rule depends on
 41 #
 42 SetupTarget = $(NamedParamsMacroTemplate)
 43 define SetupTargetBody
 44   $1:
 45 	+($(CD) $(TOPDIR)/make &amp;&amp; $(MAKE) $(MAKE_ARGS) -f $$($1_MAKEFILE).gmk $$($1_TARGET) $$($1_ARGS))
 46 
 47   ALL_TARGETS += $1
 48 
 49   ifneq ($(DEPS), none)
 50     $1: $$($1_DEPS)
 51   endif
 52 endef
 53 
 54 define CleanDocs
 55 	@$(PRINTF) &quot;Cleaning docs ...&quot;
 56 	@$(PRINTF) &quot;\n&quot; $(LOG_DEBUG)
 57 	$(RM) -r $(SUPPORT_OUTPUTDIR)/docs
 58 	$(RM) -r $(SUPPORT_OUTPUTDIR)/javadoc
 59 	$(RM) -r $(IMAGES_OUTPUTDIR)/docs
 60 	@$(PRINTF) &quot; done\n&quot;
 61 endef
 62 
 63 # Cleans the dir given as $1
 64 define CleanDir
 65 	@$(PRINTF) &quot;Cleaning $(strip $1) build artifacts ...&quot;
 66 	@$(PRINTF) &quot;\n&quot; $(LOG_DEBUG)
 67 	($(CD) $(OUTPUTDIR) &amp;&amp; $(RM) -r $1)
 68 	@$(PRINTF) &quot; done\n&quot;
 69 endef
 70 
 71 define CleanSupportDir
 72 	@$(PRINTF) &quot;Cleaning $(strip $1) build artifacts ...&quot;
 73 	@$(PRINTF) &quot;\n&quot; $(LOG_DEBUG)
 74 	$(RM) -r $(SUPPORT_OUTPUTDIR)/$(strip $1)
 75 	@$(PRINTF) &quot; done\n&quot;
 76 endef
 77 
 78 define CleanMakeSupportDir
 79 	@$(PRINTF) &quot;Cleaning $(strip $1) make support artifacts ...&quot;
 80 	@$(PRINTF) &quot;\n&quot; $(LOG_DEBUG)
 81 	$(RM) -r $(MAKESUPPORT_OUTPUTDIR)/$(strip $1)
 82 	@$(PRINTF) &quot; done\n&quot;
 83 endef
 84 
 85 define CleanTest
 86 	@$(PRINTF) &quot;Cleaning test $(strip $1) ...&quot;
 87 	@$(PRINTF) &quot;\n&quot; $(LOG_DEBUG)
 88 	$(RM) -r $(SUPPORT_OUTPUTDIR)/test/$(strip $(subst -,/,$1))
 89         # Remove as much of the test directory structure as is empty
 90 	$(RMDIR) -p $(dir $(SUPPORT_OUTPUTDIR)/test/$(strip $(subst -,/,$1))) 2&gt; /dev/null || true
 91 	@$(PRINTF) &quot; done\n&quot;
 92 endef
 93 
 94 define Clean-gensrc
 95 	@$(PRINTF) &quot;Cleaning gensrc $(if $1,for $(strip $1) )...&quot;
 96 	@$(PRINTF) &quot;\n&quot; $(LOG_DEBUG)
 97 	$(RM) -r $(SUPPORT_OUTPUTDIR)/gensrc/$(strip $1)
 98 	@$(PRINTF) &quot; done\n&quot;
 99 endef
100 
101 define Clean-java
102 	@$(PRINTF) &quot;Cleaning java $(if $1,for $(strip $1) )...&quot;
103 	@$(PRINTF) &quot;\n&quot; $(LOG_DEBUG)
104 	$(RM) -r $(JDK_OUTPUTDIR)/modules/$(strip $1)
105 	$(RM) -r $(SUPPORT_OUTPUTDIR)/special_classes/$(strip $1)
106 	$(PRINTF) &quot; done\n&quot;
107 	$(PRINTF) &quot;Cleaning headers $(if $1,for $(strip $1)) ...&quot;
108 	$(RM) -r $(SUPPORT_OUTPUTDIR)/headers/$(strip $1)
109 	@$(PRINTF) &quot; done\n&quot;
110 endef
111 
112 define Clean-native
113 	@$(PRINTF) &quot;Cleaning native $(if $1,for $(strip $1) )...&quot;
114 	@$(PRINTF) &quot;\n&quot; $(LOG_DEBUG)
115 	$(RM) -r $(SUPPORT_OUTPUTDIR)/native/$(strip $1)
116 	$(RM) -r $(SUPPORT_OUTPUTDIR)/modules_libs/$(strip $1)
117 	$(RM) -r $(SUPPORT_OUTPUTDIR)/modules_cmds/$(strip $1)
118 	@$(PRINTF) &quot; done\n&quot;
119 endef
120 
121 define Clean-include
122 	@$(PRINTF) &quot;Cleaning include $(if $1,for $(strip $1) )...&quot;
123 	@$(PRINTF) &quot;\n&quot; $(LOG_DEBUG)
124 	$(RM) -r $(SUPPORT_OUTPUTDIR)/modules_include/$(strip $1)
125 	@$(PRINTF) &quot; done\n&quot;
126 endef
127 
128 define CleanModule
129   $(call Clean-gensrc, $1)
130   $(call Clean-java, $1)
131   $(call Clean-native, $1)
132   $(call Clean-include, $1)
133 endef
134 
135 
136 ################################################################################
137 
138 PHASE_MAKEDIRS := $(TOPDIR)/make
139 
140 # Helper macro for DeclareRecipesForPhase
141 # Declare a recipe for calling the module and phase specific makefile.
142 # If there are multiple makefiles to call, create a rule for each topdir
143 # that contains a makefile with the target $module-$suffix-$repodir,
144 # (i.e: java.base-gensrc-src)
145 # Normally there is only one makefile, and the target will just be
146 # $module-$suffix
147 # Param 1: Name of list to add targets to
148 # Param 2: Module name
149 define DeclareRecipeForModuleMakefile
150   $2-$$($1_TARGET_SUFFIX):
151         ifeq ($$($1_USE_WRAPPER), true)
152 	  +($(CD) $(TOPDIR)/make &amp;&amp; $(MAKE) $(MAKE_ARGS) \
153 	      -f ModuleWrapper.gmk -I $$(TOPDIR)/make/common/modules  \
154 	      $$(addprefix -I, $$(PHASE_MAKEDIRS) \
155 	          $$(addsuffix /modules/$2, $$(PHASE_MAKEDIRS)) \
156 	      ) \
157 	      MODULE=$2 MAKEFILE_PREFIX=$$($1_FILE_PREFIX) $$($1_EXTRA_ARGS))
158         else
159 	  +($(CD) $$(TOPDIR)/make \
160 	  &amp;&amp; $(MAKE) $(MAKE_ARGS) \
161 	      -f modules/$2/$$($1_FILE_PREFIX).gmk -I $$(TOPDIR)/make/common/modules \
162 	      $$(addprefix -I, $$(PHASE_MAKEDIRS) \
163 	          $$(addsuffix /modules/$2, $$(PHASE_MAKEDIRS)) \
164 	      ) \
165 	      MODULE=$2 $$($1_EXTRA_ARGS) \
166 	  )
167         endif
168 
169 endef
170 
171 # Helper macro for DeclareRecipesForPhase
172 # Param 1: Name of list to add targets to
173 # Param 2: Module name
174 define DeclareRecipesForPhaseAndModule
175   $1_$2_MAKEFILES := $$(strip $$(wildcard \
176       $$(addsuffix /modules/$2/$$($1_FILE_PREFIX).gmk, $$(PHASE_MAKEDIRS))))
177 
178   # Only declare recipes if there are makefiles to call
179   ifneq ($$($1_$2_MAKEFILES), )
180     # Add the top dir specific target to target list regardless of if recipe
181     # generation is disabled.
182     ifeq ($$($1_MULTIPLE_MAKEFILES), true)
183       $$(foreach d, $$($1_$2_TOPDIRS), \
184         $$(eval $1 += $2-$$($1_TARGET_SUFFIX)-$$(notdir $$d)))
185     endif
186     ifeq ($(NO_RECIPES),)
187       $$(eval $$(call DeclareRecipeForModuleMakefile,$1,$2))
188     endif
189     $1 += $2-$$($1_TARGET_SUFFIX)
190     $1_MODULES += $2
191   endif
192 endef
193 
194 # Declare recipes for a specific module and build phase if there are makefiles
195 # present for the specific combination.
196 # Param 1: Name of list to add targets to
197 # Named params:
198 # TARGET_SUFFIX : Suffix of target to create for recipe
199 # MAKE_SUBDIR : Subdir for this build phase
200 # FILE_PREFIX : File prefix for this build phase
201 # USE_WRAPPER : Set to true to use ModuleWrapper.gmk
202 # CHECK_MODULES : List of modules to try
203 # MULTIPLE_MAKEFILES : Set to true to handle makefiles for the same module and
204 #                      phase in multiple repos
205 # EXTRA_ARGS : Add extra make args to each makefile call
206 # Exported variables:
207 # $1_MODULES : All modules that had rules generated
208 # $1_TARGETS : All targets generated
209 define DeclareRecipesForPhase
210   $(foreach i,2 3 4 5 6 7 8, $(if $(strip $($i)),$(strip $1)_$(strip $($i)))$(NEWLINE))
211   $(if $(9),$(error Internal makefile error: Too many arguments to \
212       DeclareRecipesForPhase, please update MakeHelper.gmk))
213 
214   $$(foreach m, $$($(strip $1)_CHECK_MODULES), \
215       $$(eval $$(call DeclareRecipesForPhaseAndModule,$(strip $1),$$m)))
216 
217   $(strip $1)_TARGETS := $$($(strip $1))
218 endef
219 
220 ################################################################################
221 
222 endif # _MAINSUPPORT_GMK
    </pre>
  </body>
</html>