<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff make/langtools/src/classes/build/tools/symbolgenerator/CreateSymbols.java</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
  </head>
<body>
<center><a href="../../../../../build.xml.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="TransitiveDependencies.java.udiff.html" target="_top">next &gt;</a></center>    <h2>make/langtools/src/classes/build/tools/symbolgenerator/CreateSymbols.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -31,13 +31,15 @@</span>
  import build.tools.symbolgenerator.CreateSymbols
                                    .ModuleHeaderDescription
                                    .RequiresDescription;
  import java.io.BufferedInputStream;
  import java.io.BufferedReader;
<span class="udiff-line-added">+ import java.io.BufferedOutputStream;</span>
  import java.io.ByteArrayInputStream;
  import java.io.ByteArrayOutputStream;
  import java.io.File;
<span class="udiff-line-added">+ import java.io.FileOutputStream;</span>
  import java.io.IOException;
  import java.io.InputStream;
  import java.io.OutputStream;
  import java.io.StringWriter;
  import java.io.Writer;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -51,10 +53,11 @@</span>
  import java.util.ArrayList;
  import java.util.Arrays;
  import java.util.Calendar;
  import java.util.Collection;
  import java.util.Collections;
<span class="udiff-line-added">+ import java.util.Comparator;</span>
  import java.util.EnumSet;
  import java.util.HashMap;
  import java.util.HashSet;
  import java.util.Iterator;
  import java.util.LinkedHashMap;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -63,15 +66,19 @@</span>
  import java.util.Map;
  import java.util.Map.Entry;
  import java.util.Objects;
  import java.util.Set;
  import java.util.TimeZone;
<span class="udiff-line-added">+ import java.util.TreeMap;</span>
<span class="udiff-line-added">+ import java.util.TreeSet;</span>
  import java.util.function.Function;
  import java.util.function.Predicate;
  import java.util.regex.Matcher;
  import java.util.regex.Pattern;
  import java.util.stream.Collectors;
<span class="udiff-line-added">+ import java.util.zip.ZipEntry;</span>
<span class="udiff-line-added">+ import java.util.zip.ZipOutputStream;</span>
  
  import javax.tools.JavaFileManager;
  import javax.tools.JavaFileManager.Location;
  import javax.tools.JavaFileObject;
  import javax.tools.JavaFileObject.Kind;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -207,24 +214,26 @@</span>
      //&lt;editor-fold defaultstate=&quot;collapsed&quot; desc=&quot;ct.sym construction&quot;&gt;
      /**Create sig files for ct.sym reading the classes description from the directory that contains
       * {@code ctDescriptionFile}, using the file as a recipe to create the sigfiles.
       */
      @SuppressWarnings(&quot;unchecked&quot;)
<span class="udiff-line-modified-removed">-     public void createSymbols(String ctDescriptionFileExtra, String ctDescriptionFile, String ctSymLocation) throws IOException {</span>
<span class="udiff-line-modified-added">+     public void createSymbols(String ctDescriptionFileExtra, String ctDescriptionFile, String ctSymLocation,</span>
<span class="udiff-line-added">+                               long timestamp, String currentVersion, String systemModules) throws IOException {</span>
          LoadDescriptions data = load(ctDescriptionFileExtra != null ? Paths.get(ctDescriptionFileExtra)
                                                                      : null,
                                       Paths.get(ctDescriptionFile), null);
  
          splitHeaders(data.classes);
  
          Map&lt;String, Map&lt;Character, String&gt;&gt; package2Version2Module = new HashMap&lt;&gt;();
<span class="udiff-line-added">+         Map&lt;String, Set&lt;FileData&gt;&gt; directory2FileData = new TreeMap&lt;&gt;();</span>
  
          for (ModuleDescription md : data.modules.values()) {
              for (ModuleHeaderDescription mhd : md.header) {
                  List&lt;String&gt; versionsList =
                          Collections.singletonList(mhd.versions);
<span class="udiff-line-modified-removed">-                 writeModulesForVersions(ctSymLocation,</span>
<span class="udiff-line-modified-added">+                 writeModulesForVersions(directory2FileData,</span>
                                          md,
                                          mhd,
                                          versionsList);
                  mhd.exports.stream().forEach(pkg -&gt; {
                      for (char v : mhd.versions.toCharArray()) {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -258,16 +267,42 @@</span>
                  }
                  for (Entry&lt;String, StringBuilder&gt; e : module2Versions.entrySet()) {
                      Set&lt;String&gt; currentVersions = new HashSet&lt;&gt;(jointVersions);
                      limitJointVersion(currentVersions, e.getValue().toString());
                      currentVersions = currentVersions.stream().filter(vers -&gt; !disjoint(vers, e.getValue().toString())).collect(Collectors.toSet());
<span class="udiff-line-modified-removed">-                     writeClassesForVersions(ctSymLocation, classDescription, header, e.getKey(), currentVersions);</span>
<span class="udiff-line-modified-added">+                     writeClassesForVersions(directory2FileData, classDescription, header, e.getKey(), currentVersions);</span>
<span class="udiff-line-added">+                 }</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         currentVersion = Integer.toString(Integer.parseInt(currentVersion), Character.MAX_RADIX);</span>
<span class="udiff-line-added">+         currentVersion = currentVersion.toUpperCase(Locale.ROOT);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         openDirectory(directory2FileData, currentVersion + &quot;/&quot;)</span>
<span class="udiff-line-added">+                 .add(new FileData(currentVersion + &quot;/system-modules&quot;,</span>
<span class="udiff-line-added">+                                   Files.readAllBytes(Paths.get(systemModules))));</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         try (OutputStream fos = new FileOutputStream(ctSymLocation);</span>
<span class="udiff-line-added">+              OutputStream bos = new BufferedOutputStream(fos);</span>
<span class="udiff-line-added">+              ZipOutputStream jos = new ZipOutputStream(bos)) {</span>
<span class="udiff-line-added">+             for (Entry&lt;String, Set&lt;FileData&gt;&gt; e : directory2FileData.entrySet()) {</span>
<span class="udiff-line-added">+                 jos.putNextEntry(createZipEntry(e.getKey(), timestamp));</span>
<span class="udiff-line-added">+                 for (FileData fd : e.getValue()) {</span>
<span class="udiff-line-added">+                     jos.putNextEntry(createZipEntry(fd.fileName, timestamp));</span>
<span class="udiff-line-added">+                     jos.write(fd.fileData);</span>
                  }
              }
          }
      }
  
<span class="udiff-line-added">+     private ZipEntry createZipEntry(String name, long timestamp) {</span>
<span class="udiff-line-added">+         ZipEntry ze = new ZipEntry(name);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         ze.setTime(timestamp);</span>
<span class="udiff-line-added">+         return ze;</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
      public static String EXTENSION = &quot;.sig&quot;;
  
      LoadDescriptions load(Path ctDescriptionWithExtraContent, Path ctDescriptionOpen, String deletePlatform) throws IOException {
          Map&lt;String, PlatformInput&gt; platforms = new LinkedHashMap&lt;&gt;();
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -429,11 +464,13 @@</span>
              }
  
              moduleList.put(desc.name, desc);
          }
  
<span class="udiff-line-modified-removed">-         return new LoadDescriptions(result, moduleList, new ArrayList&lt;&gt;(platforms.values()));</span>
<span class="udiff-line-modified-added">+         return new LoadDescriptions(result,</span>
<span class="udiff-line-added">+                                     moduleList,</span>
<span class="udiff-line-added">+                                     new ArrayList&lt;&gt;(platforms.values()));</span>
      }
  
      static final class LoadDescriptions {
          public final ClassList classes;
          public final Map&lt;String, ModuleDescription&gt; modules;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -662,33 +699,33 @@</span>
                  return false;
          }
          return true;
      }
  
<span class="udiff-line-modified-removed">-     void writeClassesForVersions(String ctSymLocation,</span>
<span class="udiff-line-modified-added">+     void writeClassesForVersions(Map&lt;String, Set&lt;FileData&gt;&gt; directory2FileData,</span>
                                   ClassDescription classDescription,
                                   ClassHeaderDescription header,
                                   String module,
                                   Iterable&lt;String&gt; versions)
              throws IOException {
          for (String ver : versions) {
<span class="udiff-line-modified-removed">-             writeClass(ctSymLocation, classDescription, header, module, ver);</span>
<span class="udiff-line-modified-added">+             writeClass(directory2FileData, classDescription, header, module, ver);</span>
          }
      }
  
<span class="udiff-line-modified-removed">-     void writeModulesForVersions(String ctSymLocation,</span>
<span class="udiff-line-modified-added">+     void writeModulesForVersions(Map&lt;String, Set&lt;FileData&gt;&gt; directory2FileData,</span>
                                   ModuleDescription moduleDescription,
                                   ModuleHeaderDescription header,
                                   Iterable&lt;String&gt; versions)
              throws IOException {
          for (String ver : versions) {
<span class="udiff-line-modified-removed">-             writeModule(ctSymLocation, moduleDescription, header, ver);</span>
<span class="udiff-line-modified-added">+             writeModule(directory2FileData, moduleDescription, header, ver);</span>
          }
      }
  
      //&lt;editor-fold defaultstate=&quot;collapsed&quot; desc=&quot;Class Writing&quot;&gt;
<span class="udiff-line-modified-removed">-     void writeModule(String ctSymLocation,</span>
<span class="udiff-line-modified-added">+     void writeModule(Map&lt;String, Set&lt;FileData&gt;&gt; directory2FileData,</span>
                      ModuleDescription moduleDescription,
                      ModuleHeaderDescription header,
                      String version) throws IOException {
          List&lt;CPInfo&gt; constantPool = new ArrayList&lt;&gt;();
          constantPool.add(null);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -711,25 +748,14 @@</span>
                  interfaces,
                  new Field[0],
                  new Method[0],
                  attributes);
  
<span class="udiff-line-modified-removed">-         Path outputClassFile = Paths.get(ctSymLocation,</span>
<span class="udiff-line-removed">-                                          version,</span>
<span class="udiff-line-removed">-                                          moduleDescription.name,</span>
<span class="udiff-line-removed">-                                          &quot;module-info&quot; + EXTENSION);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-         Files.createDirectories(outputClassFile.getParent());</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-         try (OutputStream out = Files.newOutputStream(outputClassFile)) {</span>
<span class="udiff-line-removed">-             ClassWriter w = new ClassWriter();</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-             w.write(classFile, out);</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-modified-added">+         doWrite(directory2FileData, version, moduleDescription.name, &quot;module-info&quot; + EXTENSION, classFile);</span>
      }
  
<span class="udiff-line-modified-removed">-     void writeClass(String ctSymLocation,</span>
<span class="udiff-line-modified-added">+     void writeClass(Map&lt;String, Set&lt;FileData&gt;&gt; directory2FileData,</span>
                      ClassDescription classDescription,
                      ClassHeaderDescription header,
                      String module,
                      String version) throws IOException {
          List&lt;CPInfo&gt; constantPool = new ArrayList&lt;&gt;();
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -781,25 +807,47 @@</span>
                  interfaces,
                  fields.toArray(new Field[0]),
                  methods.toArray(new Method[0]),
                  attributes);
  
<span class="udiff-line-modified-removed">-         Path outputClassFile = Paths.get(ctSymLocation, version);</span>
<span class="udiff-line-modified-added">+         doWrite(directory2FileData, version, module, classDescription.name + EXTENSION, classFile);</span>
<span class="udiff-line-added">+     }</span>
  
<span class="udiff-line-modified-removed">-         if (module != null) {</span>
<span class="udiff-line-modified-removed">-             outputClassFile = outputClassFile.resolve(module);</span>
<span class="udiff-line-modified-removed">-         }</span>
<span class="udiff-line-modified-added">+     private void doWrite(Map&lt;String, Set&lt;FileData&gt;&gt; directory2FileData,</span>
<span class="udiff-line-modified-added">+                          String version,</span>
<span class="udiff-line-modified-added">+                          String moduleName,</span>
<span class="udiff-line-added">+                          String fileName,</span>
<span class="udiff-line-added">+                          ClassFile classFile) throws IOException {</span>
<span class="udiff-line-added">+         int lastSlash = fileName.lastIndexOf(&#39;/&#39;);</span>
<span class="udiff-line-added">+         String pack = lastSlash != (-1) ? fileName.substring(0, lastSlash + 1) : &quot;/&quot;;</span>
<span class="udiff-line-added">+         String directory = version + &quot;/&quot; + moduleName + &quot;/&quot; + pack;</span>
<span class="udiff-line-added">+         String fullFileName = version + &quot;/&quot; + moduleName + &quot;/&quot; + fileName;</span>
<span class="udiff-line-added">+         try (ByteArrayOutputStream out = new ByteArrayOutputStream()) {</span>
<span class="udiff-line-added">+             ClassWriter w = new ClassWriter();</span>
  
<span class="udiff-line-modified-removed">-         outputClassFile = outputClassFile.resolve(classDescription.name + EXTENSION);</span>
<span class="udiff-line-modified-added">+             w.write(classFile, out);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             openDirectory(directory2FileData, directory)</span>
<span class="udiff-line-added">+                 .add(new FileData(fullFileName, out.toByteArray()));</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+     }</span>
  
<span class="udiff-line-modified-removed">-         Files.createDirectories(outputClassFile.getParent());</span>
<span class="udiff-line-modified-added">+     private Set&lt;FileData&gt; openDirectory(Map&lt;String, Set&lt;FileData&gt;&gt; directory2FileData,</span>
<span class="udiff-line-added">+                                String directory) {</span>
<span class="udiff-line-added">+         Comparator&lt;FileData&gt; fileCompare = (fd1, fd2) -&gt; fd1.fileName.compareTo(fd2.fileName);</span>
<span class="udiff-line-added">+         return directory2FileData.computeIfAbsent(directory, d -&gt; new TreeSet&lt;&gt;(fileCompare));</span>
<span class="udiff-line-added">+     }</span>
  
<span class="udiff-line-modified-removed">-         try (OutputStream out = Files.newOutputStream(outputClassFile)) {</span>
<span class="udiff-line-modified-removed">-             ClassWriter w = new ClassWriter();</span>
<span class="udiff-line-modified-added">+     private static class FileData {</span>
<span class="udiff-line-modified-added">+         public final String fileName;</span>
<span class="udiff-line-added">+         public final byte[] fileData;</span>
  
<span class="udiff-line-modified-removed">-             w.write(classFile, out);</span>
<span class="udiff-line-modified-added">+         public FileData(String fileName, byte[] fileData) {</span>
<span class="udiff-line-added">+             this.fileName = fileName;</span>
<span class="udiff-line-added">+             this.fileData = fileData;</span>
          }
<span class="udiff-line-added">+ </span>
      }
  
      private void addAttributes(ModuleDescription md,
                                 ModuleHeaderDescription header,
                                 List&lt;CPInfo&gt; cp,
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -3725,27 +3773,44 @@</span>
              }
              case &quot;build-ctsym&quot;:
                  String ctDescriptionFileExtra;
                  String ctDescriptionFile;
                  String ctSymLocation;
<span class="udiff-line-added">+                 String timestampSpec;</span>
<span class="udiff-line-added">+                 String currentVersion;</span>
<span class="udiff-line-added">+                 String systemModules;</span>
  
<span class="udiff-line-modified-removed">-                 if (args.length == 3) {</span>
<span class="udiff-line-modified-added">+                 if (args.length == 6) {</span>
                      ctDescriptionFileExtra = null;
                      ctDescriptionFile = args[1];
                      ctSymLocation = args[2];
<span class="udiff-line-modified-removed">-                 } else if (args.length == 4) {</span>
<span class="udiff-line-modified-added">+                     timestampSpec = args[3];</span>
<span class="udiff-line-added">+                     currentVersion = args[4];</span>
<span class="udiff-line-added">+                     systemModules = args[5];</span>
<span class="udiff-line-added">+                 } else if (args.length == 7) {</span>
                      ctDescriptionFileExtra = args[1];
                      ctDescriptionFile = args[2];
                      ctSymLocation = args[3];
<span class="udiff-line-added">+                     timestampSpec = args[4];</span>
<span class="udiff-line-added">+                     currentVersion = args[5];</span>
<span class="udiff-line-added">+                     systemModules = args[6];</span>
                  } else {
                      help();
                      return ;
                  }
  
<span class="udiff-line-added">+                 long timestamp = Long.parseLong(timestampSpec);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+                 //SOURCE_DATE_EPOCH is in seconds, convert to milliseconds:</span>
<span class="udiff-line-added">+                 timestamp *= 1000;</span>
<span class="udiff-line-added">+ </span>
                  new CreateSymbols().createSymbols(ctDescriptionFileExtra,
                                                    ctDescriptionFile,
<span class="udiff-line-modified-removed">-                                                   ctSymLocation);</span>
<span class="udiff-line-modified-added">+                                                   ctSymLocation,</span>
<span class="udiff-line-added">+                                                   timestamp,</span>
<span class="udiff-line-added">+                                                   currentVersion,</span>
<span class="udiff-line-added">+                                                   systemModules);</span>
                  break;
          }
      }
  
  }
</pre>
<center><a href="../../../../../build.xml.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="TransitiveDependencies.java.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>