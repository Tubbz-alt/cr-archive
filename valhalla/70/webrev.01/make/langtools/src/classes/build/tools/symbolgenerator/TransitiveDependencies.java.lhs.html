<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames make/langtools/src/classes/build/tools/symbolgenerator/TransitiveDependencies.java</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
  2  * Copyright (c) 2017, 2018, Oracle and/or its affiliates. All rights reserved.
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.  Oracle designates this
  8  * particular file as subject to the &quot;Classpath&quot; exception as provided
  9  * by Oracle in the LICENSE file that accompanied this code.
 10  *
 11  * This code is distributed in the hope that it will be useful, but WITHOUT
 12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 14  * version 2 for more details (a copy is included in the LICENSE file that
 15  * accompanied this code).
 16  *
 17  * You should have received a copy of the GNU General Public License version
 18  * 2 along with this work; if not, write to the Free Software Foundation,
 19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 20  *
 21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 22  * or visit www.oracle.com if you need additional information or have any
 23  * questions.
 24  */
 25 
 26 package build.tools.symbolgenerator;
 27 
 28 import java.io.IOException;
 29 import java.io.PrintWriter;
 30 import java.io.Writer;
 31 import java.nio.charset.Charset;
 32 import java.nio.file.Files;
 33 import java.nio.file.Path;
 34 import java.nio.file.Paths;
 35 import java.util.ArrayDeque;
 36 import java.util.Arrays;
 37 import java.util.Deque;
 38 import java.util.HashSet;
 39 import java.util.LinkedList;
 40 import java.util.List;
 41 import java.util.Locale;
 42 import java.util.Set;
 43 import java.util.stream.Collectors;
 44 
 45 import javax.lang.model.element.ModuleElement.RequiresDirective;
 46 import javax.lang.model.util.Elements;
 47 import javax.tools.JavaCompiler;
 48 
 49 import com.sun.tools.javac.api.JavacTaskImpl;
 50 import com.sun.tools.javac.api.JavacTool;
 51 import com.sun.tools.javac.code.Source;
 52 import com.sun.tools.javac.code.Symbol.ModuleSymbol;
 53 import com.sun.tools.javac.jvm.Target;
 54 
 55 /**
 56  * Write reflexive transitive closure of the given modules along their requires transitive edges into
 57  * file &lt;version&gt;/system-modules in the specified directory.
 58  */
 59 public class TransitiveDependencies {
 60 
 61     private static void help() {
 62         System.err.println(&quot;java TransitiveDependencies &lt;target-directory&gt; &lt;module-source-path&gt; &lt;root-modules&gt;&quot;);
 63     }
 64 
 65     public static void main(String... args) throws IOException {
 66         if (args.length &lt; 2) {
 67             help();
 68             return ;
 69         }
 70 
 71         JavaCompiler compiler = JavacTool.create();
 72         List&lt;String&gt; options = List.of(&quot;-source&quot;, Source.DEFAULT.name,
 73                                        &quot;-target&quot;, Target.DEFAULT.name,
 74                                        &quot;-proc:only&quot;,
 75                                        &quot;--system&quot;, &quot;none&quot;,
 76                                        &quot;--module-source-path&quot;, args[1],
 77                                        &quot;--add-modules&quot;, Arrays.stream(args)
 78                                                               .skip(2)
 79                                                               .collect(Collectors.joining(&quot;,&quot;)));
 80         List&lt;String&gt; jlObjectList = List.of(&quot;java.lang.Object&quot;);
 81         JavacTaskImpl task = (JavacTaskImpl) compiler.getTask(null, null, null, options, jlObjectList, null);
 82         task.enter();
 83         Elements elements = task.getElements();
 84         Deque&lt;String&gt; todo = new ArrayDeque&lt;&gt;();
 85         Arrays.stream(args).skip(2).forEach(todo::add);
 86         Set&lt;String&gt; allModules = new HashSet&lt;&gt;();
 87 
 88         while (!todo.isEmpty()) {
 89             String current = todo.removeFirst();
 90 
 91             if (!allModules.add(current))
 92                 continue;
 93 
 94             ModuleSymbol mod = (ModuleSymbol) elements.getModuleElement(current);
 95 
 96             if (mod == null) {
 97                 throw new IllegalStateException(&quot;Missing: &quot; + current);
 98             }
 99 
100              //use the internal structure to avoid unnecesarily completing the symbol using the UsesProvidesVisitor:
101             for (RequiresDirective rd : mod.requires) {
102                 if (rd.isTransitive()) {
103                     todo.offerLast(rd.getDependency().getQualifiedName().toString());
104                 }
105             }
106         }
107 
108         allModules.add(&quot;java.base&quot;);
109         allModules.add(&quot;jdk.unsupported&quot;);
110 
<a name="1" id="anc1"></a><span class="line-modified">111         String version =</span>
<span class="line-removed">112                 Integer.toString(Integer.parseInt(Source.DEFAULT.name), Character.MAX_RADIX);</span>
<span class="line-removed">113         version = version.toUpperCase(Locale.ROOT);</span>
<span class="line-removed">114 </span>
<span class="line-removed">115         Path targetFile = Paths.get(args[0]).resolve(version).resolve(&quot;system-modules&quot;);</span>
116 
117         Files.createDirectories(targetFile.getParent());
118 
119         try (Writer w = Files.newBufferedWriter(targetFile);
120              PrintWriter out = new PrintWriter(w)) {
121             allModules.stream()
122                       .sorted()
123                       .forEach(out::println);
124         }
125     }
126 
127 }
<a name="2" id="anc2"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="2" type="hidden" />
</body>
</html>