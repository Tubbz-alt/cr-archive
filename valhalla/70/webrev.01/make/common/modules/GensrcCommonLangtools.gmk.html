<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>New make/common/modules/GensrcCommonLangtools.gmk</title>
    <link rel="stylesheet" href="../../../style.css" />
  </head>
  <body>
    <pre>
  1 #
  2 # Copyright (c) 2014, 2020, Oracle and/or its affiliates. All rights reserved.
  3 # DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4 #
  5 # This code is free software; you can redistribute it and/or modify it
  6 # under the terms of the GNU General Public License version 2 only, as
  7 # published by the Free Software Foundation.  Oracle designates this
  8 # particular file as subject to the &quot;Classpath&quot; exception as provided
  9 # by Oracle in the LICENSE file that accompanied this code.
 10 #
 11 # This code is distributed in the hope that it will be useful, but WITHOUT
 12 # ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 13 # FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 14 # version 2 for more details (a copy is included in the LICENSE file that
 15 # accompanied this code).
 16 #
 17 # You should have received a copy of the GNU General Public License version
 18 # 2 along with this work; if not, write to the Free Software Foundation,
 19 # Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 20 #
 21 # Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 22 # or visit www.oracle.com if you need additional information or have any
 23 # questions.
 24 #
 25 include JavaCompilation.gmk
 26 
 27 ################################################################################
 28 # The compileprops tools compiles a properties file into a resource bundle.
 29 TOOL_COMPILEPROPS_CMD := $(JAVA_SMALL) -cp $(BUILDTOOLS_OUTPUTDIR)/langtools_tools_classes \
 30     compileproperties.CompileProperties -quiet
 31 
 32 ################################################################################
 33 # The compileprops tools compiles a properties file into an enum-like class.
 34 TOOL_PARSEPROPS_CMD := $(JAVA_SMALL) -cp $(BUILDTOOLS_OUTPUTDIR)/langtools_tools_classes \
 35     propertiesparser.PropertiesParser
 36 
 37 
 38 ################################################################################
 39 # Sets up a rule that creates a version.properties file in the gensrc output
 40 # directory.
 41 # Param 1 - Variable to add generated file name to
 42 # Param 2 - Name of version.properties file including packages from the src
 43 #           root.
 44 define SetupVersionProperties
 45   $(SUPPORT_OUTPUTDIR)/gensrc/$(MODULE)/$$(strip $2):
 46 	$$(call MakeTargetDir)
 47 	$(PRINTF) &quot;jdk=$(VERSION_NUMBER)\nfull=$(VERSION_STRING)\nrelease=$(VERSION_SHORT)\n&quot; \
 48 	    &gt; $$@
 49 
 50   $$(strip $1) += $(SUPPORT_OUTPUTDIR)/gensrc/$(MODULE)/$$(strip $2)
 51 endef
 52 
 53 ################################################################################
 54 # Finds all properties files in the module source and creates a rule that runs
 55 # CompileProperties on them into the gensrc dir.
 56 # Param 1 - Variable to add targets to
 57 # Param 2 - Extra properties files to process
 58 define SetupCompileProperties
 59   # Lookup the properties that need to be compiled into resource bundles.
 60   PROPSOURCES := $2 \
 61       $$(call FindFiles, $(TOPDIR)/src/$(MODULE)/share/classes, *.properties)
 62 
 63   # Filter out any excluded translations
 64   PROPSOURCES := $$(call FilterExcludedTranslations, $$(PROPSOURCES), .properties)
 65 
 66   # Convert .../src/&lt;module&gt;/share/classes/com/sun/tools/javac/resources/javac_zh_CN.properties
 67   # to .../langtools/gensrc/&lt;module&gt;/com/sun/tools/javac/resources/javac_zh_CN.java
 68   # Strip away prefix and suffix, leaving for example only:
 69   # &quot;&lt;module&gt;/share/classes/com/sun/tools/javac/resources/javac_zh_CN&quot;
 70   PROPJAVAS := $$(patsubst $(TOPDIR)/src/%, \
 71       $(SUPPORT_OUTPUTDIR)/gensrc/%, \
 72       $$(patsubst %.properties, %.java, \
 73       $$(subst /share/classes,, $$(PROPSOURCES))))
 74 
 75   # Generate the package dirs for the to be generated java files. Sort to remove
 76   # duplicates.
 77   PROPDIRS := $$(sort $$(dir $$(PROPJAVAS)))
 78 
 79   # Now generate a sequence of:
 80   # &quot;-compile ...javac_zh_CN.properties ...javac_zh_CN.java java.util.ListResourceBundle&quot;
 81   # suitable to be fed into the CompileProperties command.
 82   PROPCMDLINE := $$(subst _SPACE_, $(SPACE), \
 83       $$(join $$(addprefix -compile_SPACE_, $$(PROPSOURCES)), \
 84       $$(addsuffix _SPACE_java.util.ListResourceBundle, \
 85       $$(addprefix _SPACE_, $$(PROPJAVAS)))))
 86 
 87   # Now setup the rule for the generation of the resource bundles.
 88   $(SUPPORT_OUTPUTDIR)/gensrc/$(MODULE)/_the_props: $$(PROPSOURCES)
 89 	$$(call MakeDir, $$(@D) $$(PROPDIRS))
 90 	$(FIND) $$(@D) -name &quot;*.java&quot; -a ! -name &quot;*Properties.java&quot; $(FIND_DELETE)
 91 	$(ECHO) Compiling $$(words $$(PROPSOURCES)) properties into resource bundles for $(MODULE)
 92 	$(TOOL_COMPILEPROPS_CMD) $$(PROPCMDLINE)
 93 	$(TOUCH) $$@
 94 
 95   $$(strip $1) += $(SUPPORT_OUTPUTDIR)/gensrc/$(MODULE)/_the_props
 96 endef
 97 
 98 ################################################################################
 99 # Parse property files in given location and generate a Java-like enum in the gensrc folder.
100 # Param 1 - Variable to add targets to
101 # Param 2 - Extra properties files to process
102 define SetupParseProperties
103   # property files to process
104   PARSEPROPSOURCES := $$(addprefix $(TOPDIR)/src/$(MODULE)/share/classes/, $2)
105   PARSEPROPSOURCES := $$(call FilterExcludedTranslations, $$(PARSEPROPSOURCES), .properties)
106 
107   PARSEPROPALLDIRS := $$(patsubst $(TOPDIR)/src/$(MODULE)/share/classes/%, \
108       $(SUPPORT_OUTPUTDIR)/gensrc/$(MODULE)/%, \
109       $$(dir $$(PARSEPROPSOURCES)))
110 
111   PARSEPROPDIRS := $$(sort $$(PARSEPROPALLDIRS))
112 
113   PARSEPROPCMDLINE := $$(subst _SPACE_, $$(SPACE), \
114     $$(join $$(foreach var,$$(PARSEPROPSOURCES),$$(addprefix -compile_SPACE_,$$(var))), \
115     $$(addprefix _SPACE_, $$(PARSEPROPALLDIRS))))
116 
117   # Now setup the rule for the generation of the resource bundles.
118   $(SUPPORT_OUTPUTDIR)/gensrc/$(MODULE)/_the_parsed_props: $$(PARSEPROPSOURCES)
119 	$$(call MakeDir, $$(@D) $$(PARSEPROPDIRS))
120 	$(FIND) $$(@D) -name &quot;*Properties.java&quot; $(FIND_DELETE)
121 	$(ECHO) Parsing $$(words $$(PARSEPROPSOURCES)) properties into enum-like class for $(MODULE)
122 	$(TOOL_PARSEPROPS_CMD) $$(PARSEPROPCMDLINE)
123 	$(TOUCH) $$@
124 
125   $$(strip $1) += $(SUPPORT_OUTPUTDIR)/gensrc/$(MODULE)/_the_parsed_props
126 endef
127 
    </pre>
  </body>
</html>