<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Old make/conf/jib-profiles.js</title>
    <link rel="stylesheet" href="../../style.css" />
  </head>
  <body>
    <pre>
   1 /*
   2  * Copyright (c) 2015, 2020, Oracle and/or its affiliates. All rights reserved.
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.  Oracle designates this
   8  * particular file as subject to the &quot;Classpath&quot; exception as provided
   9  * by Oracle in the LICENSE file that accompanied this code.
  10  *
  11  * This code is distributed in the hope that it will be useful, but WITHOUT
  12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  14  * version 2 for more details (a copy is included in the LICENSE file that
  15  * accompanied this code).
  16  *
  17  * You should have received a copy of the GNU General Public License version
  18  * 2 along with this work; if not, write to the Free Software Foundation,
  19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  20  *
  21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  22  * or visit www.oracle.com if you need additional information or have any
  23  * questions.
  24  */
  25 
  26 /*
  27  * This file defines build profiles for the JIB tool and others.
  28  *
  29  * A build profile defines a set of configuration options and external
  30  * dependencies that we for some reason or other care about specifically.
  31  * Typically, build profiles are defined for the build configurations we
  32  * build regularly.
  33  *
  34  * Contract against this file from the tools that use it, is to provide
  35  * a function on the form:
  36  *
  37  * getJibProfiles(input)
  38  *
  39  * which returns an object graph describing the profiles and their
  40  * dependencies. The name of the function is based on the name of this
  41  * file, minus the extension and the &#39;-&#39;, camel cased and prefixed with
  42  * &#39;get&#39;.
  43  *
  44  *
  45  * The parameter &#39;input&#39; is an object that optionally contains  some data.
  46  * Optionally because a tool may read the configuration for different purposes.
  47  * To initially get a list of available profiles, the active profile may not
  48  * yet be known for instance.
  49  *
  50  * Data that may be set on the input object:
  51  *
  52  * input.profile = &lt;name of active profile&gt;
  53  *
  54  * If the active profile is set, the following data from it must also
  55  * be provided:
  56  *
  57  * input.profile
  58  * input.build_id
  59  * input.target_os
  60  * input.target_cpu
  61  * input.build_os
  62  * input.build_cpu
  63  * input.target_platform
  64  * input.build_platform
  65  * // The build_osenv_* variables describe the unix layer on Windows systems,
  66  * // i.e. Cygwin, which may also be 32 or 64 bit.
  67  * input.build_osenv
  68  * input.build_osenv_cpu
  69  * input.build_osenv_platform
  70  *
  71  * For more complex nested attributes, there is a method &quot;get&quot;:
  72  *
  73  * input.get(&quot;&lt;dependency&gt;&quot;, &quot;&lt;attribute&gt;&quot;)
  74  *
  75  * Valid attributes are:
  76  * install_path
  77  * download_path
  78  * download_dir
  79  * home_path
  80  *
  81  *
  82  * The output data generated by this configuration file has the following
  83  * format:
  84  *
  85  * data: {
  86  *   // Identifies the version of this format to the tool reading it
  87  *   format_version: &quot;1.0&quot;,
  88  *
  89  *   // Name of base outputdir. JIB assumes the actual output dir is formed
  90  *   // by adding the configuration name: &lt;output_basedir&gt;/&lt;config-name&gt;
  91  *   output_basedir: &quot;build&quot;,
  92  *   // Configure argument to use to specify configuration name
  93  *   configuration_configure_arg:
  94  *   // Make argument to use to specify configuration name
  95  *   configuration_make_arg:
  96  *
  97  *   profiles: {
  98  *     &lt;profile-name&gt;: {
  99  *       // Name of os the profile is built to run on
 100  *       target_os; &lt;string&gt;
 101  *       // Name of cpu the profile is built to run on
 102  *       target_cpu; &lt;string&gt;
 103  *       // Combination of target_os and target_cpu for convenience
 104  *       target_platform; &lt;string&gt;
 105  *       // Name of os the profile is built on
 106  *       build_os; &lt;string&gt;
 107  *       // Name of cpu the profile is built on
 108  *       build_cpu; &lt;string&gt;
 109  *       // Combination of build_os and build_cpu for convenience
 110  *       build_platform; &lt;string&gt;
 111  *
 112  *       // List of dependencies needed to build this profile
 113  *       dependencies: &lt;Array of strings&gt;
 114  *
 115  *       // List of configure args to use for this profile
 116  *       configure_args: &lt;Array of strings&gt;
 117  *
 118  *       // List of free form labels describing aspects of this profile
 119  *       labels: &lt;Array of strings&gt;
 120  *     }
 121  *   }
 122  *
 123  *   // Dependencies use a Maven like deployment structure
 124  *   dependencies: {
 125  *     &lt;dependency-name&gt;: {
 126  *       // Organization part of path defining this dependency
 127  *       organization: &lt;string&gt;
 128  *       // File extension for this dependency
 129  *       ext: &lt;string&gt;
 130  *       // Module part of path for defining this dependency,
 131  *       // defaults to &lt;dependency-name&gt;
 132  *       module: &lt;string&gt;
 133  *       // Revision part of path for defining this dependency
 134  *       revision: &lt;string&gt;
 135  *
 136  *       // List of configure args to add when using this dependency,
 137  *       // defaults to
 138  *       // &quot;--with-&lt;dependency-name&gt;=input.get(&quot;&lt;dependency-name&quot;, &quot;install_path&quot;)&quot;
 139  *       configure_args: &lt;array of strings&gt;
 140  *
 141  *       // Name of environment variable to set when using this dependency
 142  *       // when running make
 143  *       environment_name: &lt;string&gt;
 144  *       // Value of environment variable to set when using this dependency
 145  *       // when running make
 146  *       environment_value: &lt;string&gt;
 147  *
 148  *       // Value to add to the PATH variable when using this dependency,
 149  *       // applies to both make and configure
 150  *       environment_path: &lt;string&gt;
 151  *     }
 152  *
 153  *     &lt;dependency-name&gt;: {
 154  *       // For certain dependencies where a legacy distribution mechanism is
 155  *       // already in place, the &quot;javare&quot; server layout is also supported
 156  *       // Indicate that an alternate server source and layout should be used
 157  *       server: &quot;javare&quot;
 158  *
 159  *       // For &quot;javare&quot;, a combination of module, revision,
 160  *       // build number (optional), files and checksum file is possible for
 161  *       // artifacts following the standard layout.
 162  *       module: &lt;string&gt;
 163  *       revision: &lt;string&gt;
 164  *       build_number: &lt;string&gt;
 165  *       checksum_file: &lt;string&gt;
 166  *       file: &lt;string&gt;
 167  *
 168  *       // For other files, use checksum path and path instead
 169  *       checksum_path: &lt;string&gt;
 170  *       path: &lt;string&gt;
 171  *     }
 172  *   }
 173  * }
 174  */
 175 
 176 /**
 177  * Main entry to generate the profile configuration
 178  *
 179  * @param input External data to use for generating the configuration
 180  * @returns {{}} Profile configuration
 181  */
 182 var getJibProfiles = function (input) {
 183 
 184     var data = {};
 185 
 186     // Identifies the version of this format to the tool reading it.
 187     // 1.1 signifies that the publish, publish-src and get-src features are usable.
 188     // 1.2 signifies that artifact uploads should fail on missing artifacts by default.
 189     // 1.3 input.get(&lt;dep&gt;, &quot;home_path&quot;) automatically goes down into a single top
 190     //     dir just like default configure_args and environment_path variables.
 191     data.format_version = &quot;1.3&quot;;
 192 
 193     // Organization, product and version are used when uploading/publishing build results
 194     data.organization = &quot;&quot;;
 195     data.product = &quot;jdk&quot;;
 196     data.version = getVersion();
 197 
 198     // The base directory for the build output. JIB will assume that the
 199     // actual build directory will be &lt;output_basedir&gt;/&lt;configuration&gt;
 200     data.output_basedir = &quot;build&quot;;
 201     // The configure argument to use to specify the name of the configuration
 202     data.configuration_configure_arg = &quot;--with-conf-name=&quot;;
 203     // The make argument to use to specify the name of the configuration
 204     data.configuration_make_arg = &quot;CONF_NAME=&quot;;
 205 
 206     // Exclude list to use when Jib creates a source bundle
 207     data.src_bundle_excludes = [
 208         &quot;build&quot;, &quot;{,**/}webrev*&quot;, &quot;{,**/}.hg&quot;, &quot;{,**/}JTwork&quot;, &quot;{,**/}JTreport&quot;,
 209         &quot;{,**/}.git&quot;
 210     ];
 211     // Include list to use when creating a minimal jib source bundle which
 212     // contains just the jib configuration files.
 213     data.conf_bundle_includes = [
 214         &quot;make/autoconf/version-numbers&quot;,
 215     ];
 216 
 217     // Define some common values
 218     var common = getJibProfilesCommon(input, data);
 219     // Generate the profiles part of the configuration
 220     data.profiles = getJibProfilesProfiles(input, common, data);
 221     // Generate the dependencies part of the configuration
 222     data.dependencies = getJibProfilesDependencies(input, common, data);
 223 
 224     return data;
 225 };
 226 
 227 /**
 228  * Generates some common values
 229  *
 230  * @param input External data to use for generating the configuration
 231  * @returns Common values
 232  */
 233 var getJibProfilesCommon = function (input, data) {
 234     var common = {};
 235 
 236     common.organization = &quot;jpg.infra.builddeps&quot;;
 237     common.build_id = getBuildId(input);
 238     common.build_number = input.build_number != null ? input.build_number : &quot;0&quot;;
 239 
 240     // List of the main profile names used for iteration
 241     common.main_profile_names = [
 242         &quot;linux-x64&quot;, &quot;linux-x86&quot;, &quot;macosx-x64&quot;, &quot;solaris-x64&quot;,
 243         &quot;solaris-sparcv9&quot;, &quot;windows-x64&quot;, &quot;windows-x86&quot;,
 244         &quot;linux-aarch64&quot;, &quot;linux-arm32&quot;, &quot;linux-ppc64le&quot;, &quot;linux-s390x&quot;
 245     ];
 246 
 247     // These are the base setttings for all the main build profiles.
 248     common.main_profile_base = {
 249         dependencies: [&quot;boot_jdk&quot;, &quot;gnumake&quot;, &quot;jtreg&quot;, &quot;jib&quot;, &quot;autoconf&quot;, &quot;jmh&quot;, &quot;jcov&quot;],
 250         default_make_targets: [&quot;product-bundles&quot;, &quot;test-bundles&quot;, &quot;static-libs-bundles&quot;],
 251         configure_args: concat(&quot;--enable-jtreg-failure-handler&quot;,
 252             &quot;--with-exclude-translations=de,es,fr,it,ko,pt_BR,sv,ca,tr,cs,sk,ja_JP_A,ja_JP_HA,ja_JP_HI,ja_JP_I,zh_TW,zh_HK&quot;,
 253             &quot;--disable-manpages&quot;,
 254             &quot;--disable-jvm-feature-shenandoahgc&quot;,
 255             versionArgs(input, common))
 256     };
 257     // Extra settings for debug profiles
 258     common.debug_suffix = &quot;-debug&quot;;
 259     common.debug_profile_base = {
 260         configure_args: [&quot;--enable-debug&quot;],
 261         labels: &quot;debug&quot;
 262     };
 263     // Extra settings for slowdebug profiles
 264     common.slowdebug_suffix = &quot;-slowdebug&quot;;
 265     common.slowdebug_profile_base = {
 266         configure_args: [&quot;--with-debug-level=slowdebug&quot;],
 267         labels: &quot;slowdebug&quot;
 268     };
 269     // Extra settings for openjdk only profiles
 270     common.open_suffix = &quot;-open&quot;;
 271     common.open_profile_base = {
 272         configure_args: [&quot;--enable-openjdk-only&quot;],
 273         labels: &quot;open&quot;
 274     };
 275 
 276     common.configure_args_64bit = [&quot;--with-target-bits=64&quot;];
 277     common.configure_args_32bit = [&quot;--with-target-bits=32&quot;];
 278 
 279     /**
 280      * Define common artifacts template for all main profiles
 281      * @param o - Object containing data for artifacts
 282      */
 283     common.main_profile_artifacts = function (o) {
 284         var jdk_subdir = (o.jdk_subdir != null ? o.jdk_subdir : &quot;jdk-&quot; + data.version);
 285         var jdk_suffix = (o.jdk_suffix != null ? o.jdk_suffix : &quot;tar.gz&quot;);
 286         var pf = o.platform
 287         return {
 288             artifacts: {
 289                 jdk: {
 290                     local: &quot;bundles/\\(jdk.*bin.&quot; + jdk_suffix + &quot;\\)&quot;,
 291                     remote: [
 292                         &quot;bundles/&quot; + pf + &quot;/jdk-&quot; + data.version + &quot;_&quot; + pf + &quot;_bin.&quot; + jdk_suffix,
 293                         &quot;bundles/&quot; + pf + &quot;/\\1&quot;
 294                     ],
 295                     subdir: jdk_subdir,
 296                     exploded: &quot;images/jdk&quot;
 297                 },
 298                 test: {
 299                     local: &quot;bundles/\\(jdk.*bin-tests.tar.gz\\)&quot;,
 300                     remote: [
 301                         &quot;bundles/&quot; + pf + &quot;/jdk-&quot; + data.version + &quot;_&quot; + pf + &quot;_bin-tests.tar.gz&quot;,
 302                         &quot;bundles/&quot; + pf + &quot;/\\1&quot;
 303                     ],
 304                     exploded: &quot;images/test&quot;
 305                 },
 306                 test_demos: {
 307                     local: &quot;bundles/\\(jdk.*bin-tests-demos.tar.gz\\)&quot;,
 308                     remote: [
 309                         &quot;bundles/&quot; + pf + &quot;/jdk-&quot; + data.version + &quot;_&quot; + pf + &quot;_bin-tests-demos.tar.gz&quot;,
 310                         &quot;bundles/&quot; + pf + &quot;/\\1&quot;
 311                     ],
 312                     exploded: &quot;images/test&quot;
 313                 },
 314                 jdk_symbols: {
 315                     local: &quot;bundles/\\(jdk.*bin-symbols.tar.gz\\)&quot;,
 316                     remote: [
 317                         &quot;bundles/&quot; + pf + &quot;/jdk-&quot; + data.version + &quot;_&quot; + pf + &quot;_bin-symbols.tar.gz&quot;,
 318                         &quot;bundles/&quot; + pf + &quot;/\\1&quot;
 319                     ],
 320                     subdir: jdk_subdir,
 321                     exploded: &quot;images/jdk&quot;
 322                 },
 323                 static_libs: {
 324                     local: &quot;bundles/\\(jdk.*bin-static-libs.tar.gz\\)&quot;,
 325                     remote: [
 326                         &quot;bundles/&quot; + pf + &quot;/jdk-&quot; + data.version + &quot;_&quot; + pf + &quot;_bin-static-libs.tar.gz&quot;,
 327                         &quot;bundles/&quot; + pf + &quot;/\\1&quot;
 328                     ],
 329                     subdir: jdk_subdir,
 330                 },
 331             }
 332         };
 333     };
 334 
 335 
 336     /**
 337      * Define common artifacts template for all debug profiles
 338      * @param o - Object containing data for artifacts
 339      */
 340     common.debug_profile_artifacts = function (o) {
 341         var jdk_subdir = &quot;jdk-&quot; + data.version + &quot;/fastdebug&quot;;
 342         var jdk_suffix = (o.jdk_suffix != null ? o.jdk_suffix : &quot;tar.gz&quot;);
 343         var pf = o.platform
 344         return {
 345             artifacts: {
 346                 jdk: {
 347                     local: &quot;bundles/\\(jdk.*bin-debug.&quot; + jdk_suffix + &quot;\\)&quot;,
 348                     remote: [
 349                         &quot;bundles/&quot; + pf + &quot;/jdk-&quot; + data.version + &quot;_&quot; + pf + &quot;_bin-debug.&quot; + jdk_suffix,
 350                         &quot;bundles/&quot; + pf + &quot;/\\1&quot;
 351                     ],
 352                     subdir: jdk_subdir,
 353                     exploded: &quot;images/jdk&quot;
 354                 },
 355                 test: {
 356                     local: &quot;bundles/\\(jdk.*bin-tests-debug.tar.gz\\)&quot;,
 357                     remote: [
 358                         &quot;bundles/&quot; + pf + &quot;/jdk-&quot; + data.version + &quot;_&quot; + pf + &quot;_bin-tests-debug.tar.gz&quot;,
 359                         &quot;bundles/&quot; + pf + &quot;/\\1&quot;
 360                     ],
 361                     exploded: &quot;images/test&quot;
 362                 },
 363                 jdk_symbols: {
 364                     local: &quot;bundles/\\(jdk.*bin-debug-symbols.tar.gz\\)&quot;,
 365                     remote: [
 366                         &quot;bundles/&quot; + pf + &quot;/jdk-&quot; + data.version + &quot;_&quot; + pf + &quot;_bin-debug-symbols.tar.gz&quot;,
 367                         &quot;bundles/&quot; + pf + &quot;/\\1&quot;
 368                     ],
 369                     subdir: jdk_subdir,
 370                     exploded: &quot;images/jdk&quot;
 371                 },
 372                 static_libs: {
 373                     local: &quot;bundles/\\(jdk.*bin-static-libs-debug.tar.gz\\)&quot;,
 374                     remote: [
 375                         &quot;bundles/&quot; + pf + &quot;/jdk-&quot; + data.version + &quot;_&quot; + pf + &quot;_bin-static-libs-debug.tar.gz&quot;,
 376                         &quot;bundles/&quot; + pf + &quot;/\\1&quot;
 377                     ],
 378                     subdir: jdk_subdir,
 379                 },
 380             }
 381         };
 382     };
 383 
 384     common.boot_jdk_version = &quot;14&quot;;
 385     common.boot_jdk_build_number = &quot;36&quot;;
 386     common.boot_jdk_home = input.get(&quot;boot_jdk&quot;, &quot;install_path&quot;) + &quot;/jdk-&quot;
 387         + common.boot_jdk_version
 388         + (input.build_os == &quot;macosx&quot; ? &quot;.jdk/Contents/Home&quot; : &quot;&quot;);
 389 
 390     return common;
 391 };
 392 
 393 /**
 394  * Generates the profiles part of the configuration.
 395  *
 396  * @param input External data to use for generating the configuration
 397  * @param common The common values
 398  * @returns {{}} Profiles part of the configuration
 399  */
 400 var getJibProfilesProfiles = function (input, common, data) {
 401     // Main SE profiles
 402     var profiles = {
 403 
 404         &quot;linux-x64&quot;: {
 405             target_os: &quot;linux&quot;,
 406             target_cpu: &quot;x64&quot;,
 407             dependencies: [&quot;devkit&quot;, &quot;graphviz&quot;, &quot;pandoc&quot;, &quot;graalunit_lib&quot;],
 408             configure_args: concat(common.configure_args_64bit,
 409                 &quot;--enable-full-docs&quot;, &quot;--with-zlib=system&quot;,
 410                 (isWsl(input) ? [ &quot;--host=x86_64-unknown-linux-gnu&quot;,
 411                     &quot;--build=x86_64-unknown-linux-gnu&quot; ] : [])),
 412             default_make_targets: [&quot;docs-bundles&quot;],
 413         },
 414 
 415         &quot;linux-x86&quot;: {
 416             target_os: &quot;linux&quot;,
 417             target_cpu: &quot;x86&quot;,
 418             build_cpu: &quot;x64&quot;,
 419             dependencies: [&quot;devkit&quot;],
 420             configure_args: concat(common.configure_args_32bit,
 421                 &quot;--with-jvm-variants=minimal,server&quot;, &quot;--with-zlib=system&quot;),
 422         },
 423 
 424         &quot;macosx-x64&quot;: {
 425             target_os: &quot;macosx&quot;,
 426             target_cpu: &quot;x64&quot;,
 427             dependencies: [&quot;devkit&quot;, &quot;pandoc&quot;, &quot;graalunit_lib&quot;],
 428             configure_args: concat(common.configure_args_64bit, &quot;--with-zlib=system&quot;,
 429                 &quot;--with-macosx-version-max=10.9.0&quot;),
 430         },
 431 
 432         &quot;solaris-x64&quot;: {
 433             target_os: &quot;solaris&quot;,
 434             target_cpu: &quot;x64&quot;,
 435             dependencies: [&quot;devkit&quot;, &quot;cups&quot;],
 436             configure_args: concat(common.configure_args_64bit,
 437                 &quot;--with-zlib=system&quot;, &quot;--enable-dtrace&quot;, &quot;--enable-deprecated-ports=yes&quot;),
 438         },
 439 
 440         &quot;solaris-sparcv9&quot;: {
 441             target_os: &quot;solaris&quot;,
 442             target_cpu: &quot;sparcv9&quot;,
 443             dependencies: [&quot;devkit&quot;, &quot;cups&quot;],
 444             configure_args: concat(common.configure_args_64bit,
 445                 &quot;--with-zlib=system&quot;, &quot;--enable-dtrace&quot;, &quot;--enable-deprecated-ports=yes&quot;),
 446         },
 447 
 448         &quot;windows-x64&quot;: {
 449             target_os: &quot;windows&quot;,
 450             target_cpu: &quot;x64&quot;,
 451             dependencies: [&quot;devkit&quot;, &quot;pandoc&quot;, &quot;graalunit_lib&quot;],
 452             configure_args: concat(common.configure_args_64bit),
 453         },
 454 
 455         &quot;windows-x86&quot;: {
 456             target_os: &quot;windows&quot;,
 457             target_cpu: &quot;x86&quot;,
 458             build_cpu: &quot;x64&quot;,
 459             dependencies: [&quot;devkit&quot;],
 460             configure_args: concat(common.configure_args_32bit),
 461         },
 462 
 463         &quot;linux-aarch64&quot;: {
 464             target_os: &quot;linux&quot;,
 465             target_cpu: &quot;aarch64&quot;,
 466             build_cpu: &quot;x64&quot;,
 467             dependencies: [&quot;devkit&quot;, &quot;build_devkit&quot;, &quot;pandoc&quot;],
 468             configure_args: [
 469                 &quot;--openjdk-target=aarch64-linux-gnu&quot;,
 470 		&quot;--disable-jvm-feature-jvmci&quot;,
 471 		&quot;--disable-jvm-feature-graal&quot;,
 472 		&quot;--disable-jvm-feature-aot&quot;,
 473             ],
 474         },
 475 
 476         &quot;linux-arm32&quot;: {
 477             target_os: &quot;linux&quot;,
 478             target_cpu: &quot;arm&quot;,
 479             build_cpu: &quot;x64&quot;,
 480             dependencies: [&quot;devkit&quot;, &quot;build_devkit&quot;],
 481             configure_args: [
 482                 &quot;--openjdk-target=arm-linux-gnueabihf&quot;, &quot;--with-freetype=bundled&quot;,
 483                 &quot;--with-abi-profile=arm-vfp-hflt&quot;, &quot;--disable-warnings-as-errors&quot;
 484             ],
 485         },
 486 
 487         &quot;linux-ppc64le&quot;: {
 488             target_os: &quot;linux&quot;,
 489             target_cpu: &quot;ppc64le&quot;,
 490             build_cpu: &quot;x64&quot;,
 491             dependencies: [&quot;devkit&quot;, &quot;build_devkit&quot;],
 492             configure_args: [
 493                 &quot;--openjdk-target=ppc64le-linux-gnu&quot;, &quot;--with-freetype=bundled&quot;,
 494                 &quot;--disable-warnings-as-errors&quot;
 495             ],
 496         },
 497 
 498         &quot;linux-s390x&quot;: {
 499             target_os: &quot;linux&quot;,
 500             target_cpu: &quot;s390x&quot;,
 501             build_cpu: &quot;x64&quot;,
 502             dependencies: [&quot;devkit&quot;, &quot;build_devkit&quot;],
 503             configure_args: [
 504                 &quot;--openjdk-target=s390x-linux-gnu&quot;, &quot;--with-freetype=bundled&quot;,
 505                 &quot;--disable-warnings-as-errors&quot;
 506             ],
 507         },
 508     };
 509 
 510     // Add the base settings to all the main profiles
 511     common.main_profile_names.forEach(function (name) {
 512         profiles[name] = concatObjects(common.main_profile_base, profiles[name]);
 513     });
 514 
 515     // Generate debug versions of all the main profiles
 516     common.main_profile_names.forEach(function (name) {
 517         var debugName = name + common.debug_suffix;
 518         profiles[debugName] = concatObjects(profiles[name],
 519                                             common.debug_profile_base);
 520     });
 521     // Generate slowdebug versions of all the main profiles
 522     common.main_profile_names.forEach(function (name) {
 523         var debugName = name + common.slowdebug_suffix;
 524         profiles[debugName] = concatObjects(profiles[name],
 525                                             common.slowdebug_profile_base);
 526     });
 527     // Generate testmake profiles for the main profile of each build host
 528     // platform. This profile only runs the makefile tests.
 529     // Ant is needed to run the idea project generator test.
 530     var testmakeBase = {
 531         dependencies: [ &quot;ant&quot; ],
 532         environment: {
 533             &quot;ANT_HOME&quot;: input.get(&quot;ant&quot;, &quot;home_path&quot;)
 534         }
 535     };
 536     [ &quot;linux-x64&quot;, &quot;macosx-x64&quot;, &quot;solaris-sparcv9&quot;, &quot;solaris-x64&quot;, &quot;windows-x64&quot;]
 537         .forEach(function (name) {
 538             var maketestName = name + &quot;-testmake&quot;;
 539             profiles[maketestName] = concatObjects(profiles[name], testmakeBase);
 540             profiles[maketestName].default_make_targets = [ &quot;test-make&quot; ];
 541         });
 542 
 543     // Generate -gcov profiles
 544     [ &quot;linux-aarch64&quot;, &quot;linux-x64&quot;, &quot;macosx-x64&quot; ].forEach(function (name) {
 545         var gcovName = name + &quot;-gcov&quot;;
 546         profiles[gcovName] = clone(profiles[name]);
 547         profiles[gcovName].default_make_targets = [&quot;product-bundles&quot;, &quot;test-bundles&quot;];
 548         profiles[gcovName].configure_args = concat(profiles[gcovName].configure_args,
 549             [&quot;--enable-native-coverage&quot;, &quot;--disable-warnings-as-errors&quot;]);
 550     });
 551 
 552     // Profiles for building the zero jvm variant. These are used for verification.
 553     var zeroProfiles = {
 554         &quot;linux-x64-zero&quot;: {
 555             target_os: &quot;linux&quot;,
 556             target_cpu: &quot;x64&quot;,
 557             dependencies: [&quot;devkit&quot;],
 558             configure_args: concat(common.configure_args_64bit, [
 559                 &quot;--with-zlib=system&quot;,
 560                 &quot;--with-jvm-variants=zero&quot;,
 561                 &quot;--enable-libffi-bundling&quot;
 562             ])
 563         },
 564 
 565         &quot;linux-x86-zero&quot;: {
 566             target_os: &quot;linux&quot;,
 567             target_cpu: &quot;x86&quot;,
 568             build_cpu: &quot;x64&quot;,
 569             dependencies: [&quot;devkit&quot;],
 570             configure_args:  concat(common.configure_args_32bit, [
 571                 &quot;--with-zlib=system&quot;,
 572                 &quot;--with-jvm-variants=zero&quot;,
 573                 &quot;--enable-libffi-bundling&quot;
 574             ])
 575         }
 576     }
 577     profiles = concatObjects(profiles, zeroProfiles);
 578 
 579     // Add the base settings to the zero profiles and generate debug profiles
 580     Object.keys(zeroProfiles).forEach(function (name) {
 581         var debugName = name + common.debug_suffix;
 582         profiles[name] = concatObjects(common.main_profile_base, profiles[name]);
 583         profiles[debugName] = concatObjects(profiles[name], common.debug_profile_base);
 584     });
 585 
 586     // Define a profile with precompiled headers disabled. This is just used for
 587     // verfication of this build configuration.
 588     var noPchProfiles = {
 589         &quot;linux-x64-debug-nopch&quot;: {
 590             target_os: &quot;linux&quot;,
 591             target_cpu: &quot;x64&quot;,
 592             dependencies: [&quot;devkit&quot;],
 593             configure_args: concat(common.configure_args_64bit,
 594                 &quot;--with-zlib=system&quot;, &quot;--disable-precompiled-headers&quot;),
 595         },
 596     };
 597     profiles = concatObjects(profiles, noPchProfiles);
 598     // Add base settings to noPch profiles
 599     Object.keys(noPchProfiles).forEach(function (name) {
 600         profiles[name] = concatObjects(common.main_profile_base, profiles[name]);
 601         profiles[name] = concatObjects(common.debug_profile_base, profiles[name]);
 602         // Override default make target with hotspot as that&#39;s the only part of
 603         // the build using precompiled headers.
 604         profiles[name].default_make_targets = [&quot;hotspot&quot;];
 605     });
 606 
 607     // Bootcycle profiles runs the build with itself as the boot jdk. This can
 608     // be done in two ways. Either using the builtin bootcycle target in the
 609     // build system. Or by supplying the main jdk build as bootjdk to configure.
 610     [ &quot;linux-x64&quot;, &quot;macosx-x64&quot;, &quot;solaris-sparcv9&quot;, &quot;windows-x64&quot;]
 611         .forEach(function (name) {
 612             var bootcycleName = name + &quot;-bootcycle&quot;;
 613             var bootcyclePrebuiltName = name + &quot;-bootcycle-prebuilt&quot;;
 614             // The base bootcycle profile just changes the default target
 615             // compared to the base profile
 616             profiles[bootcycleName] = clone(profiles[name]);
 617             profiles[bootcycleName].default_make_targets = [ &quot;bootcycle-images&quot; ];
 618             // The prebuilt bootcycle variant modifies the boot jdk argument
 619             var bootcyclePrebuiltBase = {
 620                 dependencies: [ name + &quot;.jdk&quot; ],
 621                 configure_args: [
 622                     &quot;--with-boot-jdk=&quot; + input.get(name + &quot;.jdk&quot;, &quot;home_path&quot;),
 623                     // Full docs do not currently work with bootcycle build
 624                     // since Nashorn was removed. This negates the
 625                     // --enable-full-docs from the main profile.
 626                     &quot;--enable-full-docs=auto&quot;,
 627                 ]
 628             }
 629             profiles[bootcyclePrebuiltName] = concatObjects(profiles[name],
 630                 bootcyclePrebuiltBase);
 631             var bootJdkIndex = profiles[bootcyclePrebuiltName].dependencies.indexOf(&quot;boot_jdk&quot;);
 632             delete profiles[bootcyclePrebuiltName].dependencies[bootJdkIndex];
 633             profiles[bootcyclePrebuiltName].default_make_targets = [ &quot;product-images&quot; ];
 634         });
 635 
 636     // JCov profiles build JCov-instrumented JDK image based on images provided through dependencies.
 637     [ &quot;linux-aarch64&quot;, &quot;linux-x64&quot;, &quot;macosx-x64&quot;, &quot;solaris-sparcv9&quot;, &quot;windows-x64&quot;]
 638         .forEach(function (name) {
 639             var jcovName = name + &quot;-jcov&quot;;
 640             profiles[jcovName] = clone(common.main_profile_base);
 641             profiles[jcovName].target_os = profiles[name].target_os
 642             profiles[jcovName].target_cpu = profiles[name].target_cpu
 643             profiles[jcovName].default_make_targets = [ &quot;jcov-bundles&quot; ];
 644             profiles[jcovName].dependencies = concat(profiles[jcovName].dependencies,
 645                 [ name + &quot;.jdk&quot;, &quot;devkit&quot; ]);
 646             profiles[jcovName].configure_args = concat(profiles[jcovName].configure_args,
 647                 [&quot;--with-jcov-input-jdk=&quot; + input.get(name + &quot;.jdk&quot;, &quot;home_path&quot;)]);
 648         });
 649 
 650     //
 651     // Define artifacts for profiles
 652     //
 653     // Macosx bundles are named osx
 654     // tar.gz.
 655     var artifactData = {
 656         &quot;linux-x64&quot;: {
 657             platform: &quot;linux-x64&quot;,
 658         },
 659         &quot;linux-x86&quot;: {
 660             platform: &quot;linux-x86&quot;,
 661         },
 662         &quot;macosx-x64&quot;: {
 663             platform: &quot;osx-x64&quot;,
 664             jdk_subdir: &quot;jdk-&quot; + data.version +  &quot;.jdk/Contents/Home&quot;,
 665         },
 666         &quot;solaris-x64&quot;: {
 667             platform: &quot;solaris-x64&quot;,
 668         },
 669         &quot;solaris-sparcv9&quot;: {
 670             platform: &quot;solaris-sparcv9&quot;,
 671         },
 672         &quot;windows-x64&quot;: {
 673             platform: &quot;windows-x64&quot;,
 674             jdk_suffix: &quot;zip&quot;,
 675         },
 676         &quot;windows-x86&quot;: {
 677             platform: &quot;windows-x86&quot;,
 678             jdk_suffix: &quot;zip&quot;,
 679         },
 680        &quot;linux-aarch64&quot;: {
 681             platform: &quot;linux-aarch64&quot;,
 682         },
 683        &quot;linux-arm32&quot;: {
 684             platform: &quot;linux-arm32&quot;,
 685         },
 686        &quot;linux-ppc64le&quot;: {
 687             platform: &quot;linux-ppc64le&quot;,
 688         },
 689        &quot;linux-s390x&quot;: {
 690             platform: &quot;linux-s390x&quot;,
 691         }
 692     }
 693     // Generate common artifacts for all main profiles
 694     Object.keys(artifactData).forEach(function (name) {
 695         profiles[name] = concatObjects(profiles[name],
 696             common.main_profile_artifacts(artifactData[name]));
 697     });
 698 
 699     // Generate common artifacts for all debug profiles
 700     Object.keys(artifactData).forEach(function (name) {
 701         var debugName = name + common.debug_suffix;
 702         profiles[debugName] = concatObjects(profiles[debugName],
 703             common.debug_profile_artifacts(artifactData[name]));
 704     });
 705 
 706     profilesArtifacts = {
 707         &quot;linux-x64&quot;: {
 708             artifacts: {
 709                 doc_api_spec: {
 710                     local: &quot;bundles/\\(jdk.*doc-api-spec.tar.gz\\)&quot;,
 711                     remote: [
 712                         &quot;bundles/common/jdk-&quot; + data.version + &quot;_doc-api-spec.tar.gz&quot;,
 713                         &quot;bundles/linux-x64/\\1&quot;
 714                     ],
 715                 },
 716             }
 717         }
 718     };
 719     profiles = concatObjects(profiles, profilesArtifacts);
 720 
 721     // Generate open only profiles for all the main and debug profiles.
 722     // Rewrite artifact remote paths by adding &quot;openjdk/GPL&quot;.
 723     common.main_profile_names.forEach(function (name) {
 724         var openName = name + common.open_suffix;
 725         profiles[openName] = concatObjects(profiles[name],
 726             common.open_profile_base);
 727         for (artifactName in profiles[openName].artifacts) {
 728             var artifact = profiles[openName].artifacts[artifactName];
 729             artifact.remote = replaceAll(
 730                 &quot;bundles\/&quot;, &quot;bundles/openjdk/GPL/&quot;,
 731                 (artifact.remote != null ? artifact.remote : artifact.local));
 732         }
 733         var debugName = name + common.debug_suffix;
 734         var openDebugName = name + common.open_suffix + common.debug_suffix;
 735         profiles[openDebugName] = concatObjects(profiles[debugName],
 736             common.open_profile_base);
 737         for (artifactName in profiles[openDebugName].artifacts) {
 738             var artifact = profiles[openDebugName].artifacts[artifactName];
 739             artifact.remote = replaceAll(
 740                 &quot;bundles\/&quot;, &quot;bundles/openjdk/GPL/&quot;,
 741                 (artifact.remote != null ? artifact.remote : artifact.local));
 742         }
 743     });
 744 
 745     // Define the reference implementation profiles. These are basically the same
 746     // as the open profiles, but upload artifacts to a different location.
 747     common.main_profile_names.forEach(function (name) {
 748         var riName = name + &quot;-ri&quot;;
 749         var riDebugName = riName + common.debug_suffix;
 750         var openName = name + common.open_suffix;
 751         var openDebugName = openName + common.debug_suffix;
 752         profiles[riName] = clone(profiles[openName]);
 753         profiles[riDebugName] = clone(profiles[openDebugName]);
 754         // Rewrite all remote dirs to &quot;bundles/openjdk/BCL/...&quot;
 755         for (artifactName in profiles[riName].artifacts) {
 756             var artifact = profiles[riName].artifacts[artifactName];
 757             artifact.remote = replaceAll(
 758                 &quot;\/GPL\/&quot;, &quot;/BCL/&quot;,
 759                 (artifact.remote != null ? artifact.remote : artifact.local));
 760         }
 761     });
 762 
 763     // For open profiles, the non-debug jdk bundles, need an &quot;open&quot; prefix on the
 764     // remote bundle names, forming the word &quot;openjdk&quot;. See JDK-8188789.
 765     common.main_profile_names.forEach(function (name) {
 766         var openName = name + common.open_suffix;
 767         profiles[openName].artifacts[&quot;jdk&quot;].remote = replaceAll(
 768             &quot;\/jdk-&quot;, &quot;/openjdk-&quot;,
 769             replaceAll(&quot;\/\\1&quot;, &quot;/open\\1&quot;,
 770                        profiles[openName].artifacts[&quot;jdk&quot;].remote));
 771     });
 772 
 773     // Generate cmp-baseline profiles for each main profile and their
 774     // corresponding debug profile. This profile does a compare build run with no
 775     // changes to verify that the compare script has a clean baseline
 776     common.main_profile_names.forEach(function (name) {
 777         [ &quot;&quot;, common.open_suffix ].forEach(function (suffix) {
 778             var cmpBaselineName = name + suffix + &quot;-cmp-baseline&quot;;
 779             profiles[cmpBaselineName] = clone(profiles[name + suffix]);
 780             // Only compare the images target. This should pressumably be expanded
 781             // to include more build targets when possible.
 782             profiles[cmpBaselineName].default_make_targets = [ &quot;images&quot;, &quot;test-image&quot; ];
 783             if (name == &quot;linux-x64&quot;) {
 784                 profiles[cmpBaselineName].default_make_targets
 785                     = concat(profiles[cmpBaselineName].default_make_targets, &quot;docs&quot;);
 786             }
 787             profiles[cmpBaselineName].make_args = [ &quot;COMPARE_BUILD=CONF=&quot; ];
 788             profiles[cmpBaselineName].configure_args = concat(
 789                 profiles[cmpBaselineName].configure_args,
 790                 &quot;--with-hotspot-build-time=n/a&quot;, 
 791                 &quot;--disable-precompiled-headers&quot;);
 792             // Do not inherit artifact definitions from base profile
 793             delete profiles[cmpBaselineName].artifacts;
 794         });
 795     });
 796 
 797     // Artifacts of JCov profiles
 798     [ &quot;linux-aarch64&quot;, &quot;linux-x64&quot;, &quot;macosx-x64&quot;, &quot;solaris-sparcv9&quot;, &quot;windows-x64&quot;]
 799         .forEach(function (name) {
 800             var o = artifactData[name]
 801             var jdk_subdir = (o.jdk_subdir != null ? o.jdk_subdir : &quot;jdk-&quot; + data.version);
 802             var jdk_suffix = (o.jdk_suffix != null ? o.jdk_suffix : &quot;tar.gz&quot;);
 803             var pf = o.platform
 804             var jcovName = name + &quot;-jcov&quot;;
 805             profiles[jcovName].artifacts = {
 806                 jdk: {
 807                     local: &quot;bundles/\\(jdk-jcov.*bin.&quot; + jdk_suffix + &quot;\\)&quot;,
 808                     remote: [
 809                         &quot;bundles/&quot; + pf + &quot;/jdk-jcov-&quot; + data.version + &quot;_&quot; + pf + &quot;_bin.&quot; + jdk_suffix
 810                     ],
 811                     subdir: jdk_subdir,
 812                     exploded: &quot;images/jdk-jcov&quot;
 813                 }
 814             };
 815         });
 816 
 817     // Artifacts of gcov (native-code-coverage) profiles
 818     [ &quot;linux-aarch64&quot;, &quot;linux-x64&quot;, &quot;macosx-x64&quot; ].forEach(function (name) {
 819         var o = artifactData[name]
 820         var pf = o.platform
 821         var jdk_subdir = (o.jdk_subdir != null ? o.jdk_subdir : &quot;jdk-&quot; + data.version);
 822         var jdk_suffix = (o.jdk_suffix != null ? o.jdk_suffix : &quot;tar.gz&quot;);
 823         var gcovName = name + &quot;-gcov&quot;;
 824         profiles[gcovName].artifacts = {
 825             jdk: {
 826                 local: &quot;bundles/\\(jdk.*bin.&quot; + jdk_suffix + &quot;\\)&quot;,
 827                 remote: [
 828                     &quot;bundles/&quot; + pf + &quot;/jdk-&quot; + data.version + &quot;_&quot; + pf + &quot;_bin-gcov.&quot; + jdk_suffix,
 829                 ],
 830                 subdir: jdk_subdir,
 831                 exploded: &quot;images/jdk&quot;,
 832             },
 833             test: {
 834                     local: &quot;bundles/\\(jdk.*bin-tests.tar.gz\\)&quot;,
 835                     remote: [
 836                         &quot;bundles/&quot; + pf + &quot;/jdk-&quot; + data.version + &quot;_&quot; + pf + &quot;_bin-gcov-tests.tar.gz&quot;,
 837                     ],
 838                     exploded: &quot;images/test&quot;
 839             },
 840             jdk_symbols: {
 841                     local: &quot;bundles/\\(jdk.*bin-symbols.tar.gz\\)&quot;,
 842                     remote: [
 843                         &quot;bundles/&quot; + pf + &quot;/jdk-&quot; + data.version + &quot;_&quot; + pf + &quot;_bin-gcov-symbols.tar.gz&quot;,
 844                     ],
 845                     subdir: jdk_subdir,
 846                     exploded: &quot;images/jdk&quot;
 847                 },
 848             };
 849     });
 850 
 851     // Profiles used to run tests.
 852     var testOnlyProfiles = {
 853         &quot;run-test&quot;: {
 854             target_os: input.build_os,
 855             target_cpu: input.build_cpu,
 856             dependencies: [ &quot;jtreg&quot;, &quot;gnumake&quot;, &quot;boot_jdk&quot;, &quot;devkit&quot;, &quot;jib&quot; ],
 857             labels: &quot;test&quot;,
 858             environment: {
 859                 &quot;JT_JAVA&quot;: common.boot_jdk_home
 860             }
 861         }
 862     };
 863     profiles = concatObjects(profiles, testOnlyProfiles);
 864 
 865     // Profiles used to run tests using Jib for internal dependencies.
 866     var testedProfile = input.testedProfile;
 867     if (testedProfile == null) {
 868         testedProfile = input.build_os + &quot;-&quot; + input.build_cpu;
 869     }
 870     var testedProfileJdk = testedProfile + &quot;.jdk&quot;;
 871     // Make it possible to use the test image from a different profile
 872     var testImageProfile;
 873     if (input.testImageProfile != null) {
 874         testImageProfile = input.testImageProfile;
 875     } else if (testedProfile.endsWith(&quot;-jcov&quot;)) {
 876         testImageProfile = testedProfile.substring(0, testedProfile.length - &quot;-jcov&quot;.length);
 877     } else {
 878         testImageProfile = testedProfile;
 879     }
 880     var testedProfileTest = testImageProfile + &quot;.test&quot;
 881     var testOnlyMake = [ &quot;test-prebuilt&quot;, &quot;LOG_CMDLINES=true&quot;, &quot;JTREG_VERBOSE=fail,error,time&quot; ];
 882     if (testedProfile.endsWith(&quot;-gcov&quot;)) {
 883         testOnlyMake = concat(testOnlyMake, &quot;GCOV_ENABLED=true&quot;)
 884     }
 885     var testOnlyProfilesPrebuilt = {
 886         &quot;run-test-prebuilt&quot;: {
 887             target_os: input.build_os,
 888             target_cpu: input.build_cpu,
 889             dependencies: [
 890                 &quot;jtreg&quot;, &quot;gnumake&quot;, &quot;boot_jdk&quot;, &quot;devkit&quot;, &quot;jib&quot;, &quot;jcov&quot;, testedProfileJdk,
 891                 testedProfileTest
 892             ],
 893             src: &quot;src.conf&quot;,
 894             make_args: testOnlyMake,
 895             environment: {
 896                 &quot;BOOT_JDK&quot;: common.boot_jdk_home,
 897                 &quot;JT_HOME&quot;: input.get(&quot;jtreg&quot;, &quot;home_path&quot;),
 898                 &quot;JDK_IMAGE_DIR&quot;: input.get(testedProfileJdk, &quot;home_path&quot;),
 899                 &quot;TEST_IMAGE_DIR&quot;: input.get(testedProfileTest, &quot;home_path&quot;)
 900             },
 901             labels: &quot;test&quot;
 902         }
 903     };
 904 
 905     // If actually running the run-test-prebuilt profile, verify that the input
 906     // variable is valid and if so, add the appropriate target_* values from
 907     // the tested profile. Use testImageProfile value as backup.
 908     if (input.profile == &quot;run-test-prebuilt&quot;) {
 909         if (profiles[testedProfile] == null &amp;&amp; profiles[testImageProfile] == null) {
 910             error(&quot;testedProfile is not defined: &quot; + testedProfile + &quot; &quot; + testImageProfile);
 911         }
 912     }
 913     if (profiles[testedProfile] != null) {
 914         testOnlyProfilesPrebuilt[&quot;run-test-prebuilt&quot;][&quot;target_os&quot;]
 915             = profiles[testedProfile][&quot;target_os&quot;];
 916         testOnlyProfilesPrebuilt[&quot;run-test-prebuilt&quot;][&quot;target_cpu&quot;]
 917             = profiles[testedProfile][&quot;target_cpu&quot;];
 918     } else if (profiles[testImageProfile] != null) {
 919         testOnlyProfilesPrebuilt[&quot;run-test-prebuilt&quot;][&quot;target_os&quot;]
 920             = profiles[testImageProfile][&quot;target_os&quot;];
 921         testOnlyProfilesPrebuilt[&quot;run-test-prebuilt&quot;][&quot;target_cpu&quot;]
 922             = profiles[testImageProfile][&quot;target_cpu&quot;];
 923     }
 924     profiles = concatObjects(profiles, testOnlyProfilesPrebuilt);
 925 
 926     // On macosx add the devkit bin dir to the path in all the run-test profiles.
 927     // This gives us a guaranteed working version of lldb for the jtreg failure handler.
 928     if (input.build_os == &quot;macosx&quot;) {
 929         macosxRunTestExtra = {
 930             environment_path: input.get(&quot;devkit&quot;, &quot;install_path&quot;)
 931                 + &quot;/Xcode.app/Contents/Developer/usr/bin&quot;
 932         };
 933         profiles[&quot;run-test&quot;] = concatObjects(profiles[&quot;run-test&quot;], macosxRunTestExtra);
 934         profiles[&quot;run-test-prebuilt&quot;] = concatObjects(profiles[&quot;run-test-prebuilt&quot;], macosxRunTestExtra);
 935     }
 936     // On windows we want the debug symbols available at test time
 937     if (input.build_os == &quot;windows&quot;) {
 938         windowsRunTestPrebuiltExtra = {
 939             dependencies: [ testedProfile + &quot;.jdk_symbols&quot; ],
 940             environment: {
 941                 &quot;SYMBOLS_IMAGE_DIR&quot;: input.get(testedProfile + &quot;.jdk_symbols&quot;, &quot;home_path&quot;),
 942             }
 943         };
 944         profiles[&quot;run-test-prebuilt&quot;] = concatObjects(profiles[&quot;run-test-prebuilt&quot;],
 945             windowsRunTestPrebuiltExtra);
 946     }
 947 
 948     // The profile run-test-prebuilt defines src.conf as the src bundle. When
 949     // running in Mach 5, this reduces the time it takes to populate the
 950     // considerably. But with just src.conf, we cannot actually run any tests,
 951     // so if running from a workspace with just src.conf in it, we need to also
 952     // get src.full as a dependency, and define the work_dir (where make gets
 953     // run) to be in the src.full install path. By running in the install path,
 954     // the same cached installation of the full src can be reused for multiple
 955     // test tasks. Care must however be taken not to polute that work dir by
 956     // setting the appropriate make variables to control output directories.
 957     //
 958     // Use the existance of the top level README as indication of if this is
 959     // the full source or just src.conf.
 960     if (!new java.io.File(__DIR__, &quot;../../README&quot;).exists()) {
 961         var runTestPrebuiltSrcFullExtra = {
 962             dependencies: &quot;src.full&quot;,
 963             work_dir: input.get(&quot;src.full&quot;, &quot;install_path&quot;),
 964         }
 965         profiles[&quot;run-test-prebuilt&quot;] = concatObjects(profiles[&quot;run-test-prebuilt&quot;],
 966             runTestPrebuiltSrcFullExtra);
 967     }
 968 
 969     // Generate the missing platform attributes
 970     profiles = generatePlatformAttributes(profiles);
 971     profiles = generateDefaultMakeTargetsConfigureArg(common, profiles);
 972     return profiles;
 973 };
 974 
 975 /**
 976  * Generate the dependencies part of the configuration
 977  *
 978  * @param input External data to use for generating the configuration
 979  * @param common The common values
 980  * @returns {{}} Dependencies part of configuration
 981  */
 982 var getJibProfilesDependencies = function (input, common) {
 983 
 984     var devkit_platform_revisions = {
 985         linux_x64: &quot;gcc9.2.0-OL6.4+1.0&quot;,
 986         macosx_x64: &quot;Xcode10.1-MacOSX10.14+1.0&quot;,
 987         solaris_x64: &quot;SS12u4-Solaris11u1+1.0&quot;,
 988         solaris_sparcv9: &quot;SS12u6-Solaris11u3+1.0&quot;,
 989         windows_x64: &quot;VS2017-15.9.16+1.0&quot;,
 990         linux_aarch64: &quot;gcc9.2.0-OL7.6+1.0&quot;,
 991         linux_arm: &quot;gcc8.2.0-Fedora27+1.0&quot;,
 992         linux_ppc64le: &quot;gcc8.2.0-Fedora27+1.0&quot;,
 993         linux_s390x: &quot;gcc8.2.0-Fedora27+1.0&quot;
 994     };
 995 
 996     var devkit_platform = (input.target_cpu == &quot;x86&quot;
 997         ? input.target_os + &quot;_x64&quot;
 998         : input.target_platform);
 999 
1000     var devkit_cross_prefix = &quot;&quot;;
1001     if (input.build_platform != input.target_platform
1002        &amp;&amp; input.build_platform != devkit_platform) {
1003         devkit_cross_prefix = input.build_platform + &quot;-to-&quot;;
1004     }
1005 
1006     var boot_jdk_platform = (input.build_os == &quot;macosx&quot; ? &quot;osx&quot; : input.build_os)
1007         + &quot;-&quot; + input.build_cpu;
1008     var boot_jdk_ext = (input.build_os == &quot;windows&quot; ? &quot;.zip&quot; : &quot;.tar.gz&quot;)
1009     // If running in WSL and building for Windows, it will look like Linux,
1010     // but we need a Windows boot JDK.
1011     if (isWsl(input) &amp;&amp; input.target_os == &quot;windows&quot;) {
1012         boot_jdk_platform = &quot;windows-&quot; + input.build_cpu;
1013         boot_jdk_ext = &quot;.zip&quot;;
1014     }
1015 
1016     var makeBinDir = (input.build_os == &quot;windows&quot;
1017         ? input.get(&quot;gnumake&quot;, &quot;install_path&quot;) + &quot;/cygwin/bin&quot;
1018         : input.get(&quot;gnumake&quot;, &quot;install_path&quot;) + &quot;/bin&quot;);
1019 
1020     if (input.build_cpu == &#39;aarch64&#39;) {
1021         boot_jdk = {
1022             organization: common.organization,
1023             ext: &quot;tar.gz&quot;,
1024             module: &quot;jdk-linux_aarch64&quot;,
1025             revision: &quot;14+1.0&quot;,
1026             configure_args: &quot;--with-boot-jdk=&quot; + common.boot_jdk_home,
1027             environment_path: common.boot_jdk_home + &quot;/bin&quot;
1028         }
1029     } else {
1030         boot_jdk = {
1031             server: &quot;jpg&quot;,
1032             product: &quot;jdk&quot;,
1033             version: common.boot_jdk_version,
1034             build_number: common.boot_jdk_build_number,
1035             file: &quot;bundles/&quot; + boot_jdk_platform + &quot;/jdk-&quot; + common.boot_jdk_version + &quot;_&quot;
1036                 + boot_jdk_platform + &quot;_bin&quot; + boot_jdk_ext,
1037             configure_args: &quot;--with-boot-jdk=&quot; + common.boot_jdk_home,
1038             environment_path: common.boot_jdk_home + &quot;/bin&quot;
1039         }
1040     }
1041     if (input.build_cpu == &#39;sparcv9&#39;) {
1042         boot_jdk.file = &quot;bundles/openjdk/GPL/&quot; + boot_jdk_platform
1043             + &quot;/openjdk-&quot; + common.boot_jdk_version + &quot;_&quot;
1044             + boot_jdk_platform + &quot;_bin&quot; + boot_jdk_ext;
1045     }
1046 
1047     var dependencies = {
1048         boot_jdk: boot_jdk,
1049 
1050         devkit: {
1051             organization: common.organization,
1052             ext: &quot;tar.gz&quot;,
1053             module: &quot;devkit-&quot; + devkit_cross_prefix + devkit_platform,
1054             revision: devkit_platform_revisions[devkit_platform],
1055             environment: {
1056                 &quot;DEVKIT_HOME&quot;: input.get(&quot;devkit&quot;, &quot;home_path&quot;),
1057             }
1058         },
1059 
1060         build_devkit: {
1061             organization: common.organization,
1062             ext: &quot;tar.gz&quot;,
1063             module: &quot;devkit-&quot; + input.build_platform,
1064             revision: devkit_platform_revisions[input.build_platform]
1065         },
1066 
1067         cups: {
1068             organization: common.organization,
1069             ext: &quot;tar.gz&quot;,
1070             revision: &quot;1.0118+1.0&quot;
1071         },
1072 
1073         jtreg: {
1074             server: &quot;jpg&quot;,
1075             product: &quot;jtreg&quot;,
1076             version: &quot;5.0&quot;,
1077             build_number: &quot;b01&quot;,
1078             checksum_file: &quot;MD5_VALUES&quot;,
1079             file: &quot;bundles/jtreg_bin-5.0.zip&quot;,
1080             environment_name: &quot;JT_HOME&quot;,
1081             environment_path: input.get(&quot;jtreg&quot;, &quot;home_path&quot;) + &quot;/bin&quot;,
1082             configure_args: &quot;--with-jtreg=&quot; + input.get(&quot;jtreg&quot;, &quot;home_path&quot;),
1083         },
1084 
1085         jmh: {
1086             organization: common.organization,
1087             ext: &quot;tar.gz&quot;,
1088             revision: &quot;1.21+1.0&quot;
1089         },
1090 
1091         jcov: {
1092             // Until an official build of JCov is available, use custom
1093             // build to support classfile version 57.
1094             // See CODETOOLS-7902358 for more info.
1095             // server: &quot;jpg&quot;,
1096             // product: &quot;jcov&quot;,
1097             // version: &quot;3.0&quot;,
1098             // build_number: &quot;b07&quot;,
1099             // file: &quot;bundles/jcov-3_0.zip&quot;,
1100             organization: common.organization,
1101             revision: &quot;3.0-59-support+1.0&quot;,
1102             ext: &quot;zip&quot;,
1103             environment_name: &quot;JCOV_HOME&quot;,
1104         },
1105 
1106         gnumake: {
1107             organization: common.organization,
1108             ext: &quot;tar.gz&quot;,
1109             revision: &quot;4.0+1.0&quot;,
1110 
1111             module: (input.build_os == &quot;windows&quot;
1112                 ? &quot;gnumake-&quot; + input.build_osenv_platform
1113                 : &quot;gnumake-&quot; + input.build_platform),
1114 
1115             configure_args: &quot;MAKE=&quot; + makeBinDir + &quot;/make&quot;,
1116 
1117             environment: {
1118                 &quot;MAKE&quot;: makeBinDir + &quot;/make&quot;
1119             },
1120 
1121             environment_path: makeBinDir
1122         },
1123 
1124         autoconf: {
1125             organization: common.organization,
1126             ext: &quot;tar.gz&quot;,
1127             revision: &quot;2.69+1.0.1&quot;,
1128             module: (input.build_os == &quot;windows&quot;
1129                 ? &quot;autoconf-&quot; + input.build_osenv_platform
1130                 : &quot;autoconf-&quot; + input.build_platform),
1131             configure_args: &quot;&quot;,
1132             environment_path: input.get(&quot;autoconf&quot;, &quot;install_path&quot;)
1133         },
1134 
1135         graphviz: {
1136             organization: common.organization,
1137             ext: &quot;tar.gz&quot;,
1138             revision: &quot;2.38.0-1+1.1&quot;,
1139             module: &quot;graphviz-&quot; + input.target_platform,
1140             configure_args: &quot;DOT=&quot; + input.get(&quot;graphviz&quot;, &quot;install_path&quot;) + &quot;/dot&quot;,
1141             environment_path: input.get(&quot;graphviz&quot;, &quot;install_path&quot;)
1142         },
1143 
1144         pandoc: {
1145             organization: common.organization,
1146             ext: &quot;tar.gz&quot;,
1147             revision: (input.build_cpu == &#39;aarch64&#39; ? &quot;2.5+1.0&quot; : &quot;2.3.1+1.0&quot;),
1148             module: &quot;pandoc-&quot; + input.build_platform,
1149             configure_args: &quot;PANDOC=&quot; + input.get(&quot;pandoc&quot;, &quot;install_path&quot;) + &quot;/pandoc/pandoc&quot;,
1150             environment_path: input.get(&quot;pandoc&quot;, &quot;install_path&quot;) + &quot;/pandoc&quot;
1151         },
1152 
1153         // This adds java jib as a dependency for the test artifacts resolver
1154         jib: {
1155             organization: &quot;com.oracle.java.jib&quot;,
1156             ext: &quot;zip&quot;,
1157             classifier: &quot;distribution&quot;,
1158             revision: &quot;3.0-SNAPSHOT&quot;,
1159             environment_name: &quot;JIB_HOME&quot;,
1160             environment_value: input.get(&quot;jib&quot;, &quot;home_path&quot;)
1161         },
1162 
1163         ant: {
1164             organization: common.organization,
1165             ext: &quot;zip&quot;,
1166             revision: &quot;1.7.1+1.0&quot;,
1167             configure_args: &quot;&quot;,
1168         },
1169 
1170         graalunit_lib: {
1171             organization: common.organization,
1172             ext: &quot;zip&quot;,
1173             revision: &quot;619_Apr_12_2018&quot;,
1174             module: &quot;graalunit-lib&quot;,
1175             configure_args: &quot;--with-graalunit-lib=&quot; + input.get(&quot;graalunit_lib&quot;, &quot;install_path&quot;),
1176             environment_name: &quot;GRAALUNIT_LIB&quot;
1177         },
1178     };
1179 
1180     return dependencies;
1181 };
1182 
1183 /**
1184  * Generate the missing platform attributes for profiles
1185  *
1186  * @param profiles Profiles map to generate attributes on
1187  * @returns {{}} New profiles map with platform attributes fully filled in
1188  */
1189 var generatePlatformAttributes = function (profiles) {
1190     var ret = concatObjects(profiles, {});
1191     for (var profile in profiles) {
1192         if (ret[profile].build_os == null) {
1193             ret[profile].build_os = ret[profile].target_os;
1194         }
1195         if (ret[profile].build_cpu == null) {
1196             ret[profile].build_cpu = ret[profile].target_cpu;
1197         }
1198         ret[profile].target_platform = ret[profile].target_os + &quot;_&quot; + ret[profile].target_cpu;
1199         ret[profile].build_platform = ret[profile].build_os + &quot;_&quot; + ret[profile].build_cpu;
1200     }
1201     return ret;
1202 };
1203 
1204 /**
1205  * The default_make_targets attribute on a profile is not a real Jib attribute.
1206  * This function rewrites that attribute into the corresponding configure arg.
1207  * Calling this function multiple times on the same profiles object is safe.
1208  *
1209  * @param common Common values
1210  * @param profiles Profiles map to rewrite profiles for
1211  * @returns {{}} New map of profiles with the make targets converted
1212  */
1213 var generateDefaultMakeTargetsConfigureArg = function (common, profiles) {
1214     var ret = concatObjects(profiles, {});
1215     for (var profile in ret) {
1216         if (ret[profile][&quot;default_make_targets&quot;] != null) {
1217             var targetsString = concat(ret[profile].default_make_targets).join(&quot; &quot;);
1218             // Iterate over all configure args and see if --with-default-make-target
1219             // is already there and change it, otherwise add it.
1220             var found = false;
1221             for (var i in ret[profile].configure_args) {
1222                 var arg = ret[profile].configure_args[i];
1223                 if (arg != null &amp;&amp; arg.startsWith(&quot;--with-default-make-target=&quot;)) {
1224                     found = true;
1225                     ret[profile].configure_args[i]
1226                         = &quot;--with-default-make-target=&quot; + targetsString;
1227                 }
1228             }
1229             if (!found) {
1230                 ret[profile].configure_args = concat(
1231                     ret[profile].configure_args,
1232                     &quot;--with-default-make-target=&quot; + targetsString);
1233             }
1234         }
1235     }
1236     return ret;
1237 }
1238 
1239 var getBuildId = function (input) {
1240     if (input.build_id != null) {
1241         return input.build_id;
1242     } else {
1243         var topdir = new java.io.File(__DIR__, &quot;../..&quot;).getCanonicalFile().getName();
1244         var userName = java.lang.System.getProperty(&quot;user.name&quot;);
1245         return userName + &quot;.&quot; + topdir;
1246     }
1247 }
1248 
1249 /**
1250  * Deep clones an object tree.
1251  *
1252  * @param o Object to clone
1253  * @returns {{}} Clone of o
1254  */
1255 var clone = function (o) {
1256     return JSON.parse(JSON.stringify(o));
1257 };
1258 
1259 /**
1260  * Concatenates all arguments into a new array
1261  *
1262  * @returns {Array.&lt;T&gt;} New array containing all arguments
1263  */
1264 var concat = function () {
1265     return Array.prototype.concat.apply([], arguments);
1266 };
1267 
1268 /**
1269  * Takes a String or Array of Strings and does a replace operation on each
1270  * of them.
1271  *
1272  * @param pattern Pattern to look for
1273  * @param replacement Replacement text to insert
1274  * @param a String or Array of Strings to replace
1275  * @returns {Array} Either a new array or a new string depending on the input
1276  */
1277 var replaceAll = function (pattern, replacement, a) {
1278     // If a is an array
1279     if (Array === a.constructor) {
1280     var newA = [];
1281     for (var i in a) {
1282             newA.push(a[i].replace(pattern, replacement));
1283         }
1284         return newA;
1285         } else {
1286         return a.replace(pattern, replacement);
1287     }
1288 };
1289 
1290 /**
1291  * Deep concatenation of two objects. For each node encountered, merge
1292  * the contents with the corresponding node in the other object tree,
1293  * treating all strings as array elements.
1294  *
1295  * @param o1 Object to concatenate
1296  * @param o2 Object to concatenate
1297  * @returns {{}} New object tree containing the concatenation of o1 and o2
1298  */
1299 var concatObjects = function (o1, o2) {
1300     if (o1 == null) {
1301         return clone(o2);
1302     }
1303     if (o2 == null) {
1304         return clone(o1);
1305     }
1306     var ret = {};
1307     for (var a in o1) {
1308         if (o2[a] == null) {
1309             ret[a] = clone(o1[a]);
1310         }
1311     }
1312     for (var a in o2) {
1313         if (o1[a] == null) {
1314             ret[a] = clone(o2[a]);
1315         } else {
1316             if (typeof o1[a] == &#39;string&#39;) {
1317                 ret[a] = clone([o1[a]].concat(o2[a]));
1318             } else if (Array.isArray(o1[a])) {
1319                 ret[a] = clone(o1[a].concat(o2[a]));
1320             } else if (typeof o1[a] == &#39;object&#39;) {
1321                 ret[a] = concatObjects(o1[a], o2[a]);
1322             }
1323         }
1324     }
1325     return ret;
1326 };
1327 
1328 /**
1329  * Constructs the numeric version string from reading the
1330  * make/autoconf/version-numbers file and removing all trailing &quot;.0&quot;.
1331  *
1332  * @param feature Override feature version
1333  * @param interim Override interim version
1334  * @param update Override update version
1335  * @param patch Override patch version
1336  * @returns {String} The numeric version string
1337  */
1338 var getVersion = function (feature, interim, update, patch) {
1339     var version_numbers = getVersionNumbers();
1340     var version = (feature != null ? feature : version_numbers.get(&quot;DEFAULT_VERSION_FEATURE&quot;))
1341         + &quot;.&quot; + (interim != null ? interim : version_numbers.get(&quot;DEFAULT_VERSION_INTERIM&quot;))
1342         + &quot;.&quot; + (update != null ? update :  version_numbers.get(&quot;DEFAULT_VERSION_UPDATE&quot;))
1343         + &quot;.&quot; + (patch != null ? patch : version_numbers.get(&quot;DEFAULT_VERSION_PATCH&quot;))
1344         + &quot;.&quot; + version_numbers.get(&quot;DEFAULT_VERSION_EXTRA1&quot;)
1345         + &quot;.&quot; + version_numbers.get(&quot;DEFAULT_VERSION_EXTRA2&quot;)
1346         + &quot;.&quot; + version_numbers.get(&quot;DEFAULT_VERSION_EXTRA3&quot;);
1347     while (version.match(&quot;.*\\.0$&quot;)) {
1348         version = version.substring(0, version.length - 2);
1349     }
1350     return version;
1351 };
1352 
1353 /**
1354  * Constructs the common version configure args based on build type and
1355  * other version inputs
1356  */
1357 var versionArgs = function(input, common) {
1358     var args = [&quot;--with-version-build=&quot; + common.build_number];
1359     if (input.build_type == &quot;promoted&quot;) {
1360         args = concat(args,
1361                       &quot;--with-version-pre=&quot; + version_numbers.get(&quot;DEFAULT_PROMOTED_VERSION_PRE&quot;),
1362                       &quot;--without-version-opt&quot;);
1363     } else if (input.build_type == &quot;ci&quot;) {
1364         var optString = input.build_id_data.ciBuildNumber;
1365         var preString = input.build_id_data.projectName;
1366         if (preString == &quot;jdk&quot;) {
1367             preString = version_numbers.get(&quot;DEFAULT_PROMOTED_VERSION_PRE&quot;);
1368         }
1369         args = concat(args, &quot;--with-version-pre=&quot; + preString,
1370                      &quot;--with-version-opt=&quot; + optString);
1371     } else {
1372         args = concat(args, &quot;--with-version-opt=&quot; + common.build_id);
1373     }
1374     return args;
1375 }
1376 
1377 // Properties representation of the make/autoconf/version-numbers file. Lazily
1378 // initiated by the function below.
1379 var version_numbers;
1380 
1381 /**
1382  * Read the make/autoconf/version-numbers file into a Properties object.
1383  *
1384  * @returns {java.utilProperties}
1385  */
1386 var getVersionNumbers = function () {
1387     // Read version information from make/autoconf/version-numbers
1388     if (version_numbers == null) {
1389         version_numbers = new java.util.Properties();
1390         var stream = new java.io.FileInputStream(__DIR__ + &quot;/../autoconf/version-numbers&quot;);
1391         version_numbers.load(stream);
1392         stream.close();
1393     }
1394     return version_numbers;
1395 }
1396 
1397 /**
1398  * Returns true if running in Windows Subsystem for Linux. Jib does not yet
1399  * detect wsl as osenv, so fall back on linux with version containing Microsoft.
1400  */
1401 var isWsl = function (input) {
1402     return ( input.build_osenv == &quot;wsl&quot;
1403              || (input.build_os == &quot;linux&quot;
1404                  &amp;&amp; java.lang.System.getProperty(&quot;os.version&quot;).contains(&quot;Microsoft&quot;)));
1405 }
1406 
1407 var error = function (s) {
1408     java.lang.System.err.println(&quot;[ERROR] &quot; + s);
1409     exit(1);
1410 };
    </pre>
  </body>
</html>