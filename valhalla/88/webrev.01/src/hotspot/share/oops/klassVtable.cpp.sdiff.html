<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/hotspot/share/oops/klassVtable.cpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
  </head>
<body>
<center><a href="cpCache.cpp.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="../prims/jvm.cpp.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/hotspot/share/oops/klassVtable.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 944 
 945   Array&lt;Method*&gt;* default_methods = ik()-&gt;default_methods();
 946   if (default_methods != NULL) {
 947     int len = default_methods-&gt;length();
 948     for (int idx = 0; idx &lt; len; idx++) {
 949       if (vtable_index == ik()-&gt;default_vtable_indices()-&gt;at(idx)) {
 950         if (default_methods-&gt;at(idx) == old_method) {
 951           default_methods-&gt;at_put(idx, new_method);
 952           updated = true;
 953         }
 954         break;
 955       }
 956     }
 957   }
 958   return updated;
 959 }
 960 
 961 // search the vtable for uses of either obsolete or EMCP methods
 962 void klassVtable::adjust_method_entries(bool * trace_name_printed) {
 963   int prn_enabled = 0;


 964   for (int index = 0; index &lt; length(); index++) {
 965     Method* old_method = unchecked_method_at(index);
 966     if (old_method == NULL || !old_method-&gt;is_old()) {
 967       continue; // skip uninteresting entries
 968     }
 969     assert(!old_method-&gt;is_deleted(), &quot;vtable methods may not be deleted&quot;);
 970 
 971     Method* new_method = old_method-&gt;get_new_method();
 972     put_method_at(new_method, index);
 973 
 974     // For default methods, need to update the _default_methods array
 975     // which can only have one method entry for a given signature
 976     bool updated_default = false;
 977     if (old_method-&gt;is_default_method()) {
 978       updated_default = adjust_default_method(index, old_method, new_method);
 979     }
 980 
<span class="line-modified"> 981     if (log_is_enabled(Info, redefine, class, update)) {</span>
<span class="line-modified"> 982       ResourceMark rm;</span>
<span class="line-modified"> 983       if (!(*trace_name_printed)) {</span>
<span class="line-modified"> 984         log_info(redefine, class, update)</span>
<span class="line-modified"> 985           (&quot;adjust: klassname=%s for methods from name=%s&quot;,</span>
<span class="line-removed"> 986            _klass-&gt;external_name(), old_method-&gt;method_holder()-&gt;external_name());</span>
<span class="line-removed"> 987         *trace_name_printed = true;</span>
<span class="line-removed"> 988       }</span>
<span class="line-removed"> 989       log_debug(redefine, class, update, vtables)</span>
<span class="line-removed"> 990         (&quot;vtable method update: %s(%s), updated default = %s&quot;,</span>
<span class="line-removed"> 991          new_method-&gt;name()-&gt;as_C_string(), new_method-&gt;signature()-&gt;as_C_string(), updated_default ? &quot;true&quot; : &quot;false&quot;);</span>
 992     }



 993   }
 994 }
 995 
 996 // a vtable should never contain old or obsolete methods
 997 bool klassVtable::check_no_old_or_obsolete_entries() {


 998   for (int i = 0; i &lt; length(); i++) {
 999     Method* m = unchecked_method_at(i);
1000     if (m != NULL &amp;&amp;
1001         (NOT_PRODUCT(!m-&gt;is_valid() ||) m-&gt;is_old() || m-&gt;is_obsolete())) {



1002       return false;
1003     }
1004   }
1005   return true;
1006 }
1007 
1008 void klassVtable::dump_vtable() {
1009   tty-&gt;print_cr(&quot;vtable dump --&quot;);
1010   for (int i = 0; i &lt; length(); i++) {
1011     Method* m = unchecked_method_at(i);
1012     if (m != NULL) {
1013       tty-&gt;print(&quot;      (%5d)  &quot;, i);
1014       m-&gt;access_flags().print_on(tty);
1015       if (m-&gt;is_default_method()) {
1016         tty-&gt;print(&quot;default &quot;);
1017       }
1018       if (m-&gt;is_overpass()) {
1019         tty-&gt;print(&quot;overpass&quot;);
1020       }
1021       tty-&gt;print(&quot; --  &quot;);
</pre>
<hr />
<pre>
1265         ResourceMark rm(THREAD);
1266         if (target != NULL) {
1267           LogTarget(Trace, itables) lt;
1268           LogStream ls(lt);
1269           char* sig = target-&gt;name_and_sig_as_C_string();
1270           ls.print(&quot;interface: %s, ime_num: %d, target: %s, method_holder: %s &quot;,
1271                        interf-&gt;internal_name(), ime_num, sig,
1272                        target-&gt;method_holder()-&gt;internal_name());
1273           ls.print(&quot;target_method flags: &quot;);
1274           target-&gt;print_linkage_flags(&amp;ls);
1275           ls.cr();
1276         }
1277       }
1278     }
1279   }
1280 }
1281 
1282 #if INCLUDE_JVMTI
1283 // search the itable for uses of either obsolete or EMCP methods
1284 void klassItable::adjust_method_entries(bool * trace_name_printed) {
<span class="line-modified">1285 </span>
1286   itableMethodEntry* ime = method_entry(0);

1287   for (int i = 0; i &lt; _size_method_table; i++, ime++) {
1288     Method* old_method = ime-&gt;method();
1289     if (old_method == NULL || !old_method-&gt;is_old()) {
1290       continue; // skip uninteresting entries
1291     }
1292     assert(!old_method-&gt;is_deleted(), &quot;itable methods may not be deleted&quot;);
1293     Method* new_method = old_method-&gt;get_new_method();
1294     ime-&gt;initialize(new_method);
1295 
<span class="line-modified">1296     if (log_is_enabled(Info, redefine, class, update)) {</span>
<span class="line-modified">1297       ResourceMark rm;</span>
<span class="line-modified">1298       if (!(*trace_name_printed)) {</span>
<span class="line-removed">1299         log_info(redefine, class, update)(&quot;adjust: name=%s&quot;, old_method-&gt;method_holder()-&gt;external_name());</span>
<span class="line-removed">1300         *trace_name_printed = true;</span>
<span class="line-removed">1301       }</span>
<span class="line-removed">1302       log_trace(redefine, class, update, itables)</span>
<span class="line-removed">1303         (&quot;itable method update: %s(%s)&quot;, new_method-&gt;name()-&gt;as_C_string(), new_method-&gt;signature()-&gt;as_C_string());</span>
1304     }


1305   }
1306 }
1307 
1308 // an itable should never contain old or obsolete methods
1309 bool klassItable::check_no_old_or_obsolete_entries() {

1310   itableMethodEntry* ime = method_entry(0);

1311   for (int i = 0; i &lt; _size_method_table; i++) {
1312     Method* m = ime-&gt;method();
1313     if (m != NULL &amp;&amp;
1314         (NOT_PRODUCT(!m-&gt;is_valid() ||) m-&gt;is_old() || m-&gt;is_obsolete())) {



1315       return false;
1316     }
1317     ime++;
1318   }
1319   return true;
1320 }
1321 
1322 void klassItable::dump_itable() {
1323   itableMethodEntry* ime = method_entry(0);
1324   tty-&gt;print_cr(&quot;itable dump --&quot;);
1325   for (int i = 0; i &lt; _size_method_table; i++) {
1326     Method* m = ime-&gt;method();
1327     if (m != NULL) {
1328       tty-&gt;print(&quot;      (%5d)  &quot;, i);
1329       m-&gt;access_flags().print_on(tty);
1330       if (m-&gt;is_default_method()) {
1331         tty-&gt;print(&quot;default &quot;);
1332       }
1333       tty-&gt;print(&quot; --  &quot;);
1334       m-&gt;print_name(tty);
</pre>
</td>
<td>
<hr />
<pre>
 944 
 945   Array&lt;Method*&gt;* default_methods = ik()-&gt;default_methods();
 946   if (default_methods != NULL) {
 947     int len = default_methods-&gt;length();
 948     for (int idx = 0; idx &lt; len; idx++) {
 949       if (vtable_index == ik()-&gt;default_vtable_indices()-&gt;at(idx)) {
 950         if (default_methods-&gt;at(idx) == old_method) {
 951           default_methods-&gt;at_put(idx, new_method);
 952           updated = true;
 953         }
 954         break;
 955       }
 956     }
 957   }
 958   return updated;
 959 }
 960 
 961 // search the vtable for uses of either obsolete or EMCP methods
 962 void klassVtable::adjust_method_entries(bool * trace_name_printed) {
 963   int prn_enabled = 0;
<span class="line-added"> 964   ResourceMark rm;</span>
<span class="line-added"> 965 </span>
 966   for (int index = 0; index &lt; length(); index++) {
 967     Method* old_method = unchecked_method_at(index);
 968     if (old_method == NULL || !old_method-&gt;is_old()) {
 969       continue; // skip uninteresting entries
 970     }
 971     assert(!old_method-&gt;is_deleted(), &quot;vtable methods may not be deleted&quot;);
 972 
 973     Method* new_method = old_method-&gt;get_new_method();
 974     put_method_at(new_method, index);
 975 
 976     // For default methods, need to update the _default_methods array
 977     // which can only have one method entry for a given signature
 978     bool updated_default = false;
 979     if (old_method-&gt;is_default_method()) {
 980       updated_default = adjust_default_method(index, old_method, new_method);
 981     }
 982 
<span class="line-modified"> 983     if (!(*trace_name_printed)) {</span>
<span class="line-modified"> 984       log_info(redefine, class, update)</span>
<span class="line-modified"> 985         (&quot;adjust: klassname=%s for methods from name=%s&quot;,</span>
<span class="line-modified"> 986          _klass-&gt;external_name(), old_method-&gt;method_holder()-&gt;external_name());</span>
<span class="line-modified"> 987       *trace_name_printed = true;</span>






 988     }
<span class="line-added"> 989     log_trace(redefine, class, update, vtables)</span>
<span class="line-added"> 990       (&quot;vtable method update: class: %s method: %s, updated default = %s&quot;,</span>
<span class="line-added"> 991        _klass-&gt;external_name(), new_method-&gt;external_name(), updated_default ? &quot;true&quot; : &quot;false&quot;);</span>
 992   }
 993 }
 994 
 995 // a vtable should never contain old or obsolete methods
 996 bool klassVtable::check_no_old_or_obsolete_entries() {
<span class="line-added"> 997   ResourceMark rm;</span>
<span class="line-added"> 998 </span>
 999   for (int i = 0; i &lt; length(); i++) {
1000     Method* m = unchecked_method_at(i);
1001     if (m != NULL &amp;&amp;
1002         (NOT_PRODUCT(!m-&gt;is_valid() ||) m-&gt;is_old() || m-&gt;is_obsolete())) {
<span class="line-added">1003       log_trace(redefine, class, update, vtables)</span>
<span class="line-added">1004         (&quot;vtable check found old method entry: class: %s old: %d obsolete: %d, method: %s&quot;,</span>
<span class="line-added">1005          _klass-&gt;external_name(), m-&gt;is_old(), m-&gt;is_obsolete(), m-&gt;external_name());</span>
1006       return false;
1007     }
1008   }
1009   return true;
1010 }
1011 
1012 void klassVtable::dump_vtable() {
1013   tty-&gt;print_cr(&quot;vtable dump --&quot;);
1014   for (int i = 0; i &lt; length(); i++) {
1015     Method* m = unchecked_method_at(i);
1016     if (m != NULL) {
1017       tty-&gt;print(&quot;      (%5d)  &quot;, i);
1018       m-&gt;access_flags().print_on(tty);
1019       if (m-&gt;is_default_method()) {
1020         tty-&gt;print(&quot;default &quot;);
1021       }
1022       if (m-&gt;is_overpass()) {
1023         tty-&gt;print(&quot;overpass&quot;);
1024       }
1025       tty-&gt;print(&quot; --  &quot;);
</pre>
<hr />
<pre>
1269         ResourceMark rm(THREAD);
1270         if (target != NULL) {
1271           LogTarget(Trace, itables) lt;
1272           LogStream ls(lt);
1273           char* sig = target-&gt;name_and_sig_as_C_string();
1274           ls.print(&quot;interface: %s, ime_num: %d, target: %s, method_holder: %s &quot;,
1275                        interf-&gt;internal_name(), ime_num, sig,
1276                        target-&gt;method_holder()-&gt;internal_name());
1277           ls.print(&quot;target_method flags: &quot;);
1278           target-&gt;print_linkage_flags(&amp;ls);
1279           ls.cr();
1280         }
1281       }
1282     }
1283   }
1284 }
1285 
1286 #if INCLUDE_JVMTI
1287 // search the itable for uses of either obsolete or EMCP methods
1288 void klassItable::adjust_method_entries(bool * trace_name_printed) {
<span class="line-modified">1289   ResourceMark rm;</span>
1290   itableMethodEntry* ime = method_entry(0);
<span class="line-added">1291 </span>
1292   for (int i = 0; i &lt; _size_method_table; i++, ime++) {
1293     Method* old_method = ime-&gt;method();
1294     if (old_method == NULL || !old_method-&gt;is_old()) {
1295       continue; // skip uninteresting entries
1296     }
1297     assert(!old_method-&gt;is_deleted(), &quot;itable methods may not be deleted&quot;);
1298     Method* new_method = old_method-&gt;get_new_method();
1299     ime-&gt;initialize(new_method);
1300 
<span class="line-modified">1301     if (!(*trace_name_printed)) {</span>
<span class="line-modified">1302       log_info(redefine, class, update)(&quot;adjust: name=%s&quot;, old_method-&gt;method_holder()-&gt;external_name());</span>
<span class="line-modified">1303       *trace_name_printed = true;</span>





1304     }
<span class="line-added">1305     log_trace(redefine, class, update, itables)</span>
<span class="line-added">1306       (&quot;itable method update: class: %s method: %s&quot;, _klass-&gt;external_name(), new_method-&gt;external_name());</span>
1307   }
1308 }
1309 
1310 // an itable should never contain old or obsolete methods
1311 bool klassItable::check_no_old_or_obsolete_entries() {
<span class="line-added">1312   ResourceMark rm;</span>
1313   itableMethodEntry* ime = method_entry(0);
<span class="line-added">1314 </span>
1315   for (int i = 0; i &lt; _size_method_table; i++) {
1316     Method* m = ime-&gt;method();
1317     if (m != NULL &amp;&amp;
1318         (NOT_PRODUCT(!m-&gt;is_valid() ||) m-&gt;is_old() || m-&gt;is_obsolete())) {
<span class="line-added">1319       log_trace(redefine, class, update, itables)</span>
<span class="line-added">1320         (&quot;itable check found old method entry: class: %s old: %d obsolete: %d, method: %s&quot;,</span>
<span class="line-added">1321          _klass-&gt;external_name(), m-&gt;is_old(), m-&gt;is_obsolete(), m-&gt;external_name());</span>
1322       return false;
1323     }
1324     ime++;
1325   }
1326   return true;
1327 }
1328 
1329 void klassItable::dump_itable() {
1330   itableMethodEntry* ime = method_entry(0);
1331   tty-&gt;print_cr(&quot;itable dump --&quot;);
1332   for (int i = 0; i &lt; _size_method_table; i++) {
1333     Method* m = ime-&gt;method();
1334     if (m != NULL) {
1335       tty-&gt;print(&quot;      (%5d)  &quot;, i);
1336       m-&gt;access_flags().print_on(tty);
1337       if (m-&gt;is_default_method()) {
1338         tty-&gt;print(&quot;default &quot;);
1339       }
1340       tty-&gt;print(&quot; --  &quot;);
1341       m-&gt;print_name(tty);
</pre>
</td>
</tr>
</table>
<center><a href="cpCache.cpp.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="../prims/jvm.cpp.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>