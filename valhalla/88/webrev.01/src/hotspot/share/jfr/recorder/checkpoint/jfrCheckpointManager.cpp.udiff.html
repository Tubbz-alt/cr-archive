<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff src/hotspot/share/jfr/recorder/checkpoint/jfrCheckpointManager.cpp</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
  </head>
<body>
<center><a href="../../leakprofiler/checkpoint/objectSampleCheckpoint.cpp.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="jfrMetadataEvent.cpp.udiff.html" target="_top">next &gt;</a></center>    <h2>src/hotspot/share/jfr/recorder/checkpoint/jfrCheckpointManager.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -22,10 +22,11 @@</span>
   *
   */
  
  #include &quot;precompiled.hpp&quot;
  #include &quot;classfile/javaClasses.inline.hpp&quot;
<span class="udiff-line-added">+ #include &quot;jfr/jni/jfrJavaSupport.hpp&quot;</span>
  #include &quot;jfr/leakprofiler/checkpoint/objectSampleCheckpoint.hpp&quot;
  #include &quot;jfr/leakprofiler/leakProfiler.hpp&quot;
  #include &quot;jfr/recorder/checkpoint/jfrCheckpointManager.hpp&quot;
  #include &quot;jfr/recorder/checkpoint/jfrCheckpointWriter.hpp&quot;
  #include &quot;jfr/recorder/checkpoint/types/jfrTypeManager.hpp&quot;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -46,10 +47,11 @@</span>
  #include &quot;logging/log.hpp&quot;
  #include &quot;memory/iterator.hpp&quot;
  #include &quot;memory/resourceArea.hpp&quot;
  #include &quot;runtime/atomic.hpp&quot;
  #include &quot;runtime/handles.inline.hpp&quot;
<span class="udiff-line-added">+ #include &quot;runtime/interfaceSupport.inline.hpp&quot;</span>
  #include &quot;runtime/mutex.hpp&quot;
  #include &quot;runtime/os.inline.hpp&quot;
  #include &quot;runtime/safepoint.hpp&quot;
  
  typedef JfrCheckpointManager::BufferPtr BufferPtr;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -323,10 +325,11 @@</span>
    JfrTraceIdEpoch::end_epoch_shift();
    assert(current_epoch != JfrTraceIdEpoch::current(), &quot;invariant&quot;);
  }
  
  size_t JfrCheckpointManager::write() {
<span class="udiff-line-added">+   DEBUG_ONLY(JfrJavaSupport::check_java_thread_in_native(Thread::current()));</span>
    assert(_mspace-&gt;free_list_is_empty(), &quot;invariant&quot;);
    WriteOperation wo(_chunkwriter);
    MutexedWriteOperation mwo(wo);
    ReleaseOperation ro(_mspace, _mspace-&gt;live_list(true));
    WriteReleaseOperation wro(&amp;mwo, &amp;ro);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -355,19 +358,23 @@</span>
    return writer.used_size();
  }
  
  size_t JfrCheckpointManager::write_threads(Thread* thread) {
    assert(thread != NULL, &quot;invariant&quot;);
<span class="udiff-line-added">+   // can safepoint here</span>
<span class="udiff-line-added">+   ThreadInVMfromNative transition((JavaThread*)thread);</span>
<span class="udiff-line-added">+   ResetNoHandleMark rnhm;</span>
<span class="udiff-line-added">+   ResourceMark rm(thread);</span>
<span class="udiff-line-added">+   HandleMark hm(thread);</span>
    JfrCheckpointWriter writer(true, thread, THREADS);
    JfrTypeManager::write_threads(writer);
    return writer.used_size();
  }
  
  size_t JfrCheckpointManager::write_static_type_set_and_threads() {
    Thread* const thread = Thread::current();
<span class="udiff-line-modified-removed">-   ResourceMark rm(thread);</span>
<span class="udiff-line-removed">-   HandleMark hm(thread);</span>
<span class="udiff-line-modified-added">+   DEBUG_ONLY(JfrJavaSupport::check_java_thread_in_native(thread));</span>
    write_static_type_set(thread);
    write_threads(thread);
    return write();
  }
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -378,33 +385,39 @@</span>
  }
  
  void JfrCheckpointManager::clear_type_set() {
    assert(!SafepointSynchronize::is_at_safepoint(), &quot;invariant&quot;);
    assert(!JfrRecorder::is_recording(), &quot;invariant&quot;);
<span class="udiff-line-added">+   Thread* t = Thread::current();</span>
<span class="udiff-line-added">+   DEBUG_ONLY(JfrJavaSupport::check_java_thread_in_native(t));</span>
    // can safepoint here
<span class="udiff-line-added">+   ThreadInVMfromNative transition((JavaThread*)t);</span>
<span class="udiff-line-added">+   ResetNoHandleMark rnhm;</span>
    MutexLocker cld_lock(ClassLoaderDataGraph_lock);
    MutexLocker module_lock(Module_lock);
    JfrTypeSet::clear();
  }
  
  void JfrCheckpointManager::write_type_set() {
    assert(!SafepointSynchronize::is_at_safepoint(), &quot;invariant&quot;);
<span class="udiff-line-modified-removed">-   Thread* const thread = Thread::current();</span>
<span class="udiff-line-modified-removed">-   if (LeakProfiler::is_running()) {</span>
<span class="udiff-line-modified-added">+   {</span>
<span class="udiff-line-modified-added">+     Thread* const thread = Thread::current();</span>
<span class="udiff-line-added">+     DEBUG_ONLY(JfrJavaSupport::check_java_thread_in_native(thread));</span>
      // can safepoint here
<span class="udiff-line-added">+     ThreadInVMfromNative transition((JavaThread*)thread);</span>
<span class="udiff-line-added">+     ResetNoHandleMark rnhm;</span>
      MutexLocker cld_lock(thread, ClassLoaderDataGraph_lock);
      MutexLocker module_lock(thread, Module_lock);
<span class="udiff-line-modified-removed">-     JfrCheckpointWriter leakp_writer(true, thread);</span>
<span class="udiff-line-modified-removed">-     JfrCheckpointWriter writer(true, thread);</span>
<span class="udiff-line-modified-removed">-     JfrTypeSet::serialize(&amp;writer, &amp;leakp_writer, false, false);</span>
<span class="udiff-line-modified-removed">-     ObjectSampleCheckpoint::on_type_set(leakp_writer);</span>
<span class="udiff-line-modified-removed">-   } else {</span>
<span class="udiff-line-modified-removed">-     // can safepoint here</span>
<span class="udiff-line-modified-removed">-     MutexLocker cld_lock(ClassLoaderDataGraph_lock);</span>
<span class="udiff-line-modified-removed">-     MutexLocker module_lock(Module_lock);</span>
<span class="udiff-line-modified-removed">-     JfrCheckpointWriter writer(true, thread);</span>
<span class="udiff-line-removed">-     JfrTypeSet::serialize(&amp;writer, NULL, false, false);</span>
<span class="udiff-line-modified-added">+     if (LeakProfiler::is_running()) {</span>
<span class="udiff-line-modified-added">+       JfrCheckpointWriter leakp_writer(true, thread);</span>
<span class="udiff-line-modified-added">+       JfrCheckpointWriter writer(true, thread);</span>
<span class="udiff-line-modified-added">+       JfrTypeSet::serialize(&amp;writer, &amp;leakp_writer, false, false);</span>
<span class="udiff-line-modified-added">+       ObjectSampleCheckpoint::on_type_set(leakp_writer);</span>
<span class="udiff-line-modified-added">+     } else {</span>
<span class="udiff-line-modified-added">+       JfrCheckpointWriter writer(true, thread);</span>
<span class="udiff-line-modified-added">+       JfrTypeSet::serialize(&amp;writer, NULL, false, false);</span>
<span class="udiff-line-modified-added">+     }</span>
    }
    write();
  }
  
  void JfrCheckpointManager::on_unloading_classes() {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -414,17 +427,37 @@</span>
    if (LeakProfiler::is_running()) {
      ObjectSampleCheckpoint::on_type_set_unload(writer);
    }
  }
  
<span class="udiff-line-added">+ class JavaThreadToVM : public StackObj {</span>
<span class="udiff-line-added">+  private:</span>
<span class="udiff-line-added">+   JavaThread* _jt;</span>
<span class="udiff-line-added">+  public:</span>
<span class="udiff-line-added">+   JavaThreadToVM(Thread* thread) : _jt(thread-&gt;is_Java_thread() ? (JavaThread*)thread : NULL) {</span>
<span class="udiff-line-added">+     if (_jt != NULL) {</span>
<span class="udiff-line-added">+       assert(_jt-&gt;thread_state() == _thread_in_native, &quot;invariant&quot;);</span>
<span class="udiff-line-added">+       _jt-&gt;set_thread_state(_thread_in_vm);</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+   }</span>
<span class="udiff-line-added">+   ~JavaThreadToVM() {</span>
<span class="udiff-line-added">+     if (_jt != NULL) {</span>
<span class="udiff-line-added">+       _jt-&gt;set_thread_state(_thread_in_native);</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+   }</span>
<span class="udiff-line-added">+ };</span>
<span class="udiff-line-added">+ </span>
  size_t JfrCheckpointManager::flush_type_set() {
    size_t elements = 0;
    if (JfrTraceIdEpoch::has_changed_tag_state()) {
<span class="udiff-line-modified-removed">-     JfrCheckpointWriter writer(Thread::current());</span>
<span class="udiff-line-modified-removed">-     // can safepoint here</span>
<span class="udiff-line-modified-removed">-     MutexLocker cld_lock(ClassLoaderDataGraph_lock);</span>
<span class="udiff-line-modified-removed">-     MutexLocker module_lock(Module_lock);</span>
<span class="udiff-line-modified-added">+     Thread* const t = Thread::current();</span>
<span class="udiff-line-modified-added">+     // can safepoint here (if JavaThread)</span>
<span class="udiff-line-modified-added">+     JavaThreadToVM transition(t);</span>
<span class="udiff-line-modified-added">+     ResetNoHandleMark rnhm;</span>
<span class="udiff-line-added">+     MutexLocker cld_lock(t, ClassLoaderDataGraph_lock);</span>
<span class="udiff-line-added">+     MutexLocker module_lock(t, Module_lock);</span>
<span class="udiff-line-added">+     JfrCheckpointWriter writer(t);</span>
      elements = JfrTypeSet::serialize(&amp;writer, NULL, false, true);
    }
    if (is_constant_pending()) {
      WriteOperation wo(_chunkwriter);
      MutexedWriteOperation mwo(wo);
</pre>
<center><a href="../../leakprofiler/checkpoint/objectSampleCheckpoint.cpp.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="jfrMetadataEvent.cpp.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>