<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames src/hotspot/share/classfile/systemDictionary.hpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
    <script type="text/javascript" src="../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
  2  * Copyright (c) 1997, 2020, Oracle and/or its affiliates. All rights reserved.
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  *
 23  */
 24 
 25 #ifndef SHARE_CLASSFILE_SYSTEMDICTIONARY_HPP
 26 #define SHARE_CLASSFILE_SYSTEMDICTIONARY_HPP
 27 
 28 #include &quot;classfile/classLoaderData.hpp&quot;
 29 #include &quot;oops/objArrayOop.hpp&quot;
 30 #include &quot;oops/oopHandle.hpp&quot;
 31 #include &quot;oops/symbol.hpp&quot;
 32 #include &quot;runtime/java.hpp&quot;
 33 #include &quot;runtime/mutexLocker.hpp&quot;
 34 #include &quot;runtime/reflectionUtils.hpp&quot;
 35 #include &quot;runtime/signature.hpp&quot;
 36 #include &quot;utilities/hashtable.hpp&quot;
 37 
 38 class ClassInstanceInfo : public StackObj {
 39  private:
 40   InstanceKlass* _dynamic_nest_host;
 41   Handle _class_data;
 42 
 43  public:
 44   ClassInstanceInfo() {
 45     _dynamic_nest_host = NULL;
 46     _class_data = Handle();
 47   }
 48   ClassInstanceInfo(InstanceKlass* dynamic_nest_host, Handle class_data) {
 49     _dynamic_nest_host = dynamic_nest_host;
 50     _class_data = class_data;
 51   }
 52 
 53   InstanceKlass* dynamic_nest_host() const { return _dynamic_nest_host; }
 54   Handle class_data() const { return _class_data; }
 55   friend class ClassLoadInfo;
 56 };
 57 
 58 class ClassLoadInfo : public StackObj {
 59  private:
 60   Handle                 _protection_domain;
 61   const InstanceKlass*   _unsafe_anonymous_host;
 62   GrowableArray&lt;Handle&gt;* _cp_patches;
 63   ClassInstanceInfo      _class_hidden_info;
 64   bool                   _is_hidden;
 65   bool                   _is_strong_hidden;
 66   bool                   _can_access_vm_annotations;
 67 
 68  public:
 69   ClassLoadInfo();
 70   ClassLoadInfo(Handle protection_domain);
 71   ClassLoadInfo(Handle protection_domain, const InstanceKlass* unsafe_anonymous_host,
 72                 GrowableArray&lt;Handle&gt;* cp_patches, InstanceKlass* dynamic_nest_host,
 73                 Handle class_data, bool is_hidden, bool is_strong_hidden,
 74                 bool can_access_vm_annotations);
 75 
 76   Handle protection_domain()             const { return _protection_domain; }
 77   const InstanceKlass* unsafe_anonymous_host() const { return _unsafe_anonymous_host; }
 78   GrowableArray&lt;Handle&gt;* cp_patches()    const { return _cp_patches; }
 79   const ClassInstanceInfo* class_hidden_info_ptr() const { return &amp;_class_hidden_info; }
 80   bool is_hidden()                       const { return _is_hidden; }
 81   bool is_strong_hidden()                const { return _is_strong_hidden; }
 82   bool can_access_vm_annotations()       const { return _can_access_vm_annotations; }
 83 };
 84 
 85 // The dictionary in each ClassLoaderData stores all loaded classes, either
 86 // initiatied by its class loader or defined by its class loader:
 87 //
 88 //   class loader -&gt; ClassLoaderData -&gt; [class, protection domain set]
 89 //
 90 // Classes are loaded lazily. The default VM class loader is
 91 // represented as NULL.
 92 
 93 // The underlying data structure is an open hash table (Dictionary) per
 94 // ClassLoaderData with a fixed number of buckets. During loading the
 95 // class loader object is locked, (for the VM loader a private lock object is used).
 96 // The global SystemDictionary_lock is held for all additions into the ClassLoaderData
 97 // dictionaries.  TODO: fix lock granularity so that class loading can
 98 // be done concurrently, but only by different loaders.
 99 //
100 // During loading a placeholder (name, loader) is temporarily placed in
101 // a side data structure, and is used to detect ClassCircularityErrors
102 // and to perform verification during GC.  A GC can occur in the midst
103 // of class loading, as we call out to Java, have to take locks, etc.
104 //
105 // When class loading is finished, a new entry is added to the dictionary
106 // of the class loader and the placeholder is removed. Note that the protection
107 // domain field of the dictionary entry has not yet been filled in when
108 // the &quot;real&quot; dictionary entry is created.
109 //
110 // Clients of this class who are interested in finding if a class has
111 // been completely loaded -- not classes in the process of being loaded --
112 // can read the dictionary unlocked. This is safe because
113 //    - entries are only deleted at safepoints
114 //    - readers cannot come to a safepoint while actively examining
115 //         an entry  (an entry cannot be deleted from under a reader)
116 //    - entries must be fully formed before they are available to concurrent
117 //         readers (we must ensure write ordering)
118 //
119 // Note that placeholders are deleted at any time, as they are removed
120 // when a class is completely loaded. Therefore, readers as well as writers
121 // of placeholders must hold the SystemDictionary_lock.
122 //
123 
124 class BootstrapInfo;
125 class ClassFileStream;
126 class Dictionary;
127 class AllFieldStream;
128 class PlaceholderTable;
129 class LoaderConstraintTable;
130 template &lt;MEMFLAGS F&gt; class HashtableBucket;
131 class ResolutionErrorTable;
132 class SymbolPropertyTable;
133 class ProtectionDomainCacheTable;
134 class ProtectionDomainCacheEntry;
135 class GCTimer;
136 class EventClassLoad;
137 
138 #define WK_KLASS_ENUM_NAME(kname)    kname##_knum
139 
140 // Certain classes, such as java.lang.Object and java.lang.String,
141 // are &quot;well-known&quot;, in the sense that no class loader is allowed
142 // to provide a different definition.
143 //
144 // Each well-known class has a short klass name (like object_klass),
145 // and a vmSymbol name (like java_lang_Object).
146 //
147 // The order of these definitions is significant: the classes are
148 // resolved during early VM start-up by resolve_well_known_classes
149 // in this order. Changing the order may require careful restructuring
150 // of the VM start-up sequence.
151 //
152 #define WK_KLASSES_DO(do_klass)                                                                                 \
153   /* well-known classes */                                                                                      \
154   do_klass(Object_klass,                                java_lang_Object                                      ) \
155   do_klass(IdentityObject_klass,                        java_lang_IdentityObject                              ) \
156   do_klass(String_klass,                                java_lang_String                                      ) \
157   do_klass(Class_klass,                                 java_lang_Class                                       ) \
158   do_klass(Cloneable_klass,                             java_lang_Cloneable                                   ) \
159   do_klass(ClassLoader_klass,                           java_lang_ClassLoader                                 ) \
160   do_klass(Serializable_klass,                          java_io_Serializable                                  ) \
161   do_klass(System_klass,                                java_lang_System                                      ) \
162   do_klass(Throwable_klass,                             java_lang_Throwable                                   ) \
163   do_klass(Error_klass,                                 java_lang_Error                                       ) \
164   do_klass(ThreadDeath_klass,                           java_lang_ThreadDeath                                 ) \
165   do_klass(Exception_klass,                             java_lang_Exception                                   ) \
166   do_klass(RuntimeException_klass,                      java_lang_RuntimeException                            ) \
167   do_klass(SecurityManager_klass,                       java_lang_SecurityManager                             ) \
168   do_klass(ProtectionDomain_klass,                      java_security_ProtectionDomain                        ) \
169   do_klass(AccessControlContext_klass,                  java_security_AccessControlContext                    ) \
170   do_klass(AccessController_klass,                      java_security_AccessController                        ) \
171   do_klass(SecureClassLoader_klass,                     java_security_SecureClassLoader                       ) \
172   do_klass(ClassNotFoundException_klass,                java_lang_ClassNotFoundException                      ) \
173   do_klass(Record_klass,                                java_lang_Record                                      ) \
174   do_klass(NoClassDefFoundError_klass,                  java_lang_NoClassDefFoundError                        ) \
175   do_klass(LinkageError_klass,                          java_lang_LinkageError                                ) \
176   do_klass(ClassCastException_klass,                    java_lang_ClassCastException                          ) \
177   do_klass(ArrayStoreException_klass,                   java_lang_ArrayStoreException                         ) \
178   do_klass(VirtualMachineError_klass,                   java_lang_VirtualMachineError                         ) \
179   do_klass(OutOfMemoryError_klass,                      java_lang_OutOfMemoryError                            ) \
180   do_klass(StackOverflowError_klass,                    java_lang_StackOverflowError                          ) \
181   do_klass(IllegalMonitorStateException_klass,          java_lang_IllegalMonitorStateException                ) \
182   do_klass(Reference_klass,                             java_lang_ref_Reference                               ) \
183                                                                                                                 \
184   /* ref klasses and set reference types */                                                                     \
185   do_klass(SoftReference_klass,                         java_lang_ref_SoftReference                           ) \
186   do_klass(WeakReference_klass,                         java_lang_ref_WeakReference                           ) \
187   do_klass(FinalReference_klass,                        java_lang_ref_FinalReference                          ) \
188   do_klass(PhantomReference_klass,                      java_lang_ref_PhantomReference                        ) \
189   do_klass(Finalizer_klass,                             java_lang_ref_Finalizer                               ) \
190                                                                                                                 \
191   do_klass(Thread_klass,                                java_lang_Thread                                      ) \
192   do_klass(ThreadGroup_klass,                           java_lang_ThreadGroup                                 ) \
193   do_klass(Properties_klass,                            java_util_Properties                                  ) \
194   do_klass(Module_klass,                                java_lang_Module                                      ) \
195   do_klass(reflect_AccessibleObject_klass,              java_lang_reflect_AccessibleObject                    ) \
196   do_klass(reflect_Field_klass,                         java_lang_reflect_Field                               ) \
197   do_klass(reflect_Parameter_klass,                     java_lang_reflect_Parameter                           ) \
198   do_klass(reflect_Method_klass,                        java_lang_reflect_Method                              ) \
199   do_klass(reflect_Constructor_klass,                   java_lang_reflect_Constructor                         ) \
200                                                                                                                 \
201   /* NOTE: needed too early in bootstrapping process to have checks based on JDK version */                     \
202   /* It&#39;s okay if this turns out to be NULL in non-1.4 JDKs. */                                                 \
203   do_klass(reflect_MagicAccessorImpl_klass,             reflect_MagicAccessorImpl                             ) \
204   do_klass(reflect_MethodAccessorImpl_klass,            reflect_MethodAccessorImpl                            ) \
205   do_klass(reflect_ConstructorAccessorImpl_klass,       reflect_ConstructorAccessorImpl                       ) \
206   do_klass(reflect_DelegatingClassLoader_klass,         reflect_DelegatingClassLoader                         ) \
207   do_klass(reflect_ConstantPool_klass,                  reflect_ConstantPool                                  ) \
208   do_klass(reflect_UnsafeStaticFieldAccessorImpl_klass, reflect_UnsafeStaticFieldAccessorImpl                 ) \
209   do_klass(reflect_CallerSensitive_klass,               reflect_CallerSensitive                               ) \
210   do_klass(reflect_NativeConstructorAccessorImpl_klass, reflect_NativeConstructorAccessorImpl                 ) \
211                                                                                                                 \
212   /* support for dynamic typing; it&#39;s OK if these are NULL in earlier JDKs */                                   \
213   do_klass(DirectMethodHandle_klass,                    java_lang_invoke_DirectMethodHandle                   ) \
214   do_klass(MethodHandle_klass,                          java_lang_invoke_MethodHandle                         ) \
215   do_klass(VarHandle_klass,                             java_lang_invoke_VarHandle                            ) \
216   do_klass(MemberName_klass,                            java_lang_invoke_MemberName                           ) \
217   do_klass(ResolvedMethodName_klass,                    java_lang_invoke_ResolvedMethodName                   ) \
218   do_klass(MethodHandleNatives_klass,                   java_lang_invoke_MethodHandleNatives                  ) \
219   do_klass(LambdaForm_klass,                            java_lang_invoke_LambdaForm                           ) \
220   do_klass(MethodType_klass,                            java_lang_invoke_MethodType                           ) \
221   do_klass(BootstrapMethodError_klass,                  java_lang_BootstrapMethodError                        ) \
222   do_klass(CallSite_klass,                              java_lang_invoke_CallSite                             ) \
223   do_klass(Context_klass,                               java_lang_invoke_MethodHandleNatives_CallSiteContext  ) \
224   do_klass(ConstantCallSite_klass,                      java_lang_invoke_ConstantCallSite                     ) \
225   do_klass(MutableCallSite_klass,                       java_lang_invoke_MutableCallSite                      ) \
226   do_klass(ValueBootstrapMethods_klass,                 java_lang_invoke_ValueBootstrapMethods                ) \
227   do_klass(VolatileCallSite_klass,                      java_lang_invoke_VolatileCallSite                     ) \
228   /* Note: MethodHandle must be first, and VolatileCallSite last in group */                                    \
229                                                                                                                 \
230   do_klass(AssertionStatusDirectives_klass,             java_lang_AssertionStatusDirectives                   ) \
231   do_klass(StringBuffer_klass,                          java_lang_StringBuffer                                ) \
232   do_klass(StringBuilder_klass,                         java_lang_StringBuilder                               ) \
233   do_klass(UnsafeConstants_klass,                       jdk_internal_misc_UnsafeConstants                     ) \
234   do_klass(internal_Unsafe_klass,                       jdk_internal_misc_Unsafe                              ) \
235   do_klass(module_Modules_klass,                        jdk_internal_module_Modules                           ) \
236                                                                                                                 \
237   /* support for CDS */                                                                                         \
238   do_klass(ByteArrayInputStream_klass,                  java_io_ByteArrayInputStream                          ) \
239   do_klass(URL_klass,                                   java_net_URL                                          ) \
240   do_klass(Jar_Manifest_klass,                          java_util_jar_Manifest                                ) \
241   do_klass(jdk_internal_loader_ClassLoaders_klass,      jdk_internal_loader_ClassLoaders                      ) \
242   do_klass(jdk_internal_loader_ClassLoaders_AppClassLoader_klass,      jdk_internal_loader_ClassLoaders_AppClassLoader) \
243   do_klass(jdk_internal_loader_ClassLoaders_PlatformClassLoader_klass, jdk_internal_loader_ClassLoaders_PlatformClassLoader) \
244   do_klass(CodeSource_klass,                            java_security_CodeSource                              ) \
245                                                                                                                 \
246   do_klass(StackTraceElement_klass,                     java_lang_StackTraceElement                           ) \
247                                                                                                                 \
248   /* It&#39;s okay if this turns out to be NULL in non-1.4 JDKs. */                                                 \
249   do_klass(nio_Buffer_klass,                            java_nio_Buffer                                       ) \
250                                                                                                                 \
251   /* Stack Walking */                                                                                           \
252   do_klass(StackWalker_klass,                           java_lang_StackWalker                                 ) \
253   do_klass(AbstractStackWalker_klass,                   java_lang_StackStreamFactory_AbstractStackWalker      ) \
254   do_klass(StackFrameInfo_klass,                        java_lang_StackFrameInfo                              ) \
255   do_klass(LiveStackFrameInfo_klass,                    java_lang_LiveStackFrameInfo                          ) \
256                                                                                                                 \
257   /* support for stack dump lock analysis */                                                                    \
258   do_klass(java_util_concurrent_locks_AbstractOwnableSynchronizer_klass, java_util_concurrent_locks_AbstractOwnableSynchronizer) \
259                                                                                                                 \
260   /* boxing klasses */                                                                                          \
261   do_klass(Boolean_klass,                               java_lang_Boolean                                     ) \
262   do_klass(Character_klass,                             java_lang_Character                                   ) \
263   do_klass(Float_klass,                                 java_lang_Float                                       ) \
264   do_klass(Double_klass,                                java_lang_Double                                      ) \
265   do_klass(Byte_klass,                                  java_lang_Byte                                        ) \
266   do_klass(Short_klass,                                 java_lang_Short                                       ) \
267   do_klass(Integer_klass,                               java_lang_Integer                                     ) \
268   do_klass(Long_klass,                                  java_lang_Long                                        ) \
269                                                                                                                 \
270   /* force inline of iterators */                                                                               \
271   do_klass(Iterator_klass,                              java_util_Iterator                                    ) \
272                                                                                                                 \
273   do_klass(jdk_internal_vm_jni_SubElementSelector_klass, jdk_internal_vm_jni_SubElementSelector               ) \
274   /* support for records */                                                                                     \
275   do_klass(RecordComponent_klass,                       java_lang_reflect_RecordComponent                     ) \
276                                                                                                                 \
277   /*end*/
278 
279 class SystemDictionary : AllStatic {
280   friend class BootstrapInfo;
281   friend class VMStructs;
282 
283  public:
284   enum WKID {
285     NO_WKID = 0,
286 
287     #define WK_KLASS_ENUM(name, symbol) WK_KLASS_ENUM_NAME(name), WK_KLASS_ENUM_NAME(symbol) = WK_KLASS_ENUM_NAME(name),
288     WK_KLASSES_DO(WK_KLASS_ENUM)
289     #undef WK_KLASS_ENUM
290 
291     WKID_LIMIT,
292 
293     FIRST_WKID = NO_WKID + 1
294   };
295 
296   // Returns a class with a given class name and class loader.  Loads the
297   // class if needed. If not found a NoClassDefFoundError or a
298   // ClassNotFoundException is thrown, depending on the value on the
299   // throw_error flag.  For most uses the throw_error argument should be set
300   // to true.
301 
302   static Klass* resolve_or_fail(Symbol* class_name, Handle class_loader, Handle protection_domain, bool throw_error, TRAPS);
303   // Convenient call for null loader and protection domain.
304   static Klass* resolve_or_fail(Symbol* class_name, bool throw_error, TRAPS);
305 protected:
306   // handle error translation for resolve_or_null results
307   static Klass* handle_resolution_exception(Symbol* class_name, bool throw_error, Klass* klass, TRAPS);
308 
309 public:
310 
311   // Returns a class with a given class name and class loader.
312   // Loads the class if needed. If not found NULL is returned.
313   static Klass* resolve_or_null(Symbol* class_name, Handle class_loader, Handle protection_domain, TRAPS);
314   // Version with null loader and protection domain
315   static Klass* resolve_or_null(Symbol* class_name, TRAPS);
316 
317   // Resolve a superclass or superinterface. Called from ClassFileParser,
318   // parse_interfaces, resolve_instance_class_or_null, load_shared_class
319   // &quot;child_name&quot; is the class whose super class or interface is being resolved.
320   static InstanceKlass* resolve_super_or_fail(Symbol* child_name,
321                                               Symbol* class_name,
322                                               Handle class_loader,
323                                               Handle protection_domain,
324                                               bool is_superclass,
325                                               TRAPS);
326 
327   static Klass* resolve_inline_type_field_or_fail(AllFieldStream* fs,
328                                                   Handle class_loader,
329                                                   Handle protection_domain,
330                                                   bool throw_error,
331                                                   TRAPS);
332 
333   // Parse new stream. This won&#39;t update the dictionary or class
334   // hierarchy, simply parse the stream. Used by JVMTI RedefineClasses
335   // and by Unsafe_DefineAnonymousClass and jvm_lookup_define_class.
336   static InstanceKlass* parse_stream(Symbol* class_name,
337                                      Handle class_loader,
338                                      ClassFileStream* st,
339                                      const ClassLoadInfo&amp; cl_info,
340                                      TRAPS);
341 
342   // Resolve from stream (called by jni_DefineClass and JVM_DefineClass)
343   static InstanceKlass* resolve_from_stream(Symbol* class_name,
344                                             Handle class_loader,
345                                             Handle protection_domain,
346                                             ClassFileStream* st,
347                                             TRAPS);
348 
349   // Lookup an already loaded class. If not found NULL is returned.
350   static Klass* find(Symbol* class_name, Handle class_loader, Handle protection_domain, TRAPS);
351 
352   // Lookup an already loaded instance or array class.
353   // Do not make any queries to class loaders; consult only the cache.
354   // If not found NULL is returned.
355   static Klass* find_instance_or_array_klass(Symbol* class_name,
356                                                Handle class_loader,
357                                                Handle protection_domain,
358                                                TRAPS);
359 
360   // Lookup an instance or array class that has already been loaded
361   // either into the given class loader, or else into another class
362   // loader that is constrained (via loader constraints) to produce
363   // a consistent class.  Do not take protection domains into account.
364   // Do not make any queries to class loaders; consult only the cache.
365   // Return NULL if the class is not found.
366   //
367   // This function is a strict superset of find_instance_or_array_klass.
368   // This function (the unchecked version) makes a conservative prediction
369   // of the result of the checked version, assuming successful lookup.
370   // If both functions return non-null, they must return the same value.
371   // Also, the unchecked version may sometimes be non-null where the
372   // checked version is null.  This can occur in several ways:
373   //   1. No query has yet been made to the class loader.
374   //   2. The class loader was queried, but chose not to delegate.
375   //   3. ClassLoader.checkPackageAccess rejected a proposed protection domain.
376   //   4. Loading was attempted, but there was a linkage error of some sort.
377   // In all of these cases, the loader constraints on this type are
378   // satisfied, and it is safe for classes in the given class loader
379   // to manipulate strongly-typed values of the found class, subject
380   // to local linkage and access checks.
381   static Klass* find_constrained_instance_or_array_klass(Symbol* class_name,
382                                                            Handle class_loader,
383                                                            TRAPS);
384 
385   static void classes_do(MetaspaceClosure* it);
386   // Iterate over all methods in all klasses
387 
388   static void methods_do(void f(Method*));
389 
390   // Garbage collection support
391 
392   // Unload (that is, break root links to) all unmarked classes and
393   // loaders.  Returns &quot;true&quot; iff something was unloaded.
394   static bool do_unloading(GCTimer* gc_timer);
395 
396   // System loader lock
397   static oop system_loader_lock();
398 
399   // Protection Domain Table
400   static ProtectionDomainCacheTable* pd_cache_table() { return _pd_cache_table; }
401 
402 public:
403   // Printing
404   static void print();
405   static void print_on(outputStream* st);
406   static void dump(outputStream* st, bool verbose);
407 
408   // Verification
409   static void verify();
410 
411   // Initialization
412   static void initialize(TRAPS);
413 
414   // Checked fast access to the well-known classes -- so that you don&#39;t try to use them
415   // before they are resolved.
416   static InstanceKlass* check_klass(InstanceKlass* k) {
417     assert(k != NULL, &quot;klass not loaded&quot;);
418     return k;
419   }
420 
421   static bool resolve_wk_klass(WKID id, TRAPS);
422   static InstanceKlass* check_klass_ValhallaClasses(InstanceKlass* k) { return k; }
423   static void resolve_wk_klasses_until(WKID limit_id, WKID &amp;start_id, TRAPS);
424   static void resolve_wk_klasses_through(WKID end_id, WKID &amp;start_id, TRAPS) {
425     int limit = (int)end_id + 1;
426     resolve_wk_klasses_until((WKID) limit, start_id, THREAD);
427   }
428 public:
429   #define WK_KLASS(name) _well_known_klasses[SystemDictionary::WK_KLASS_ENUM_NAME(name)]
430 
431   #define WK_KLASS_DECLARE(name, symbol) \
432     static InstanceKlass* name() { return check_klass(_well_known_klasses[WK_KLASS_ENUM_NAME(name)]); } \
433     static InstanceKlass** name##_addr() {                                                              \
434       return &amp;_well_known_klasses[SystemDictionary::WK_KLASS_ENUM_NAME(name)];                          \
435     }                                                                                                   \
436     static bool name##_is_loaded() {                                                                    \
437       return is_wk_klass_loaded(WK_KLASS(name));                                                        \
438     }
439   WK_KLASSES_DO(WK_KLASS_DECLARE);
440   #undef WK_KLASS_DECLARE
441 
442   static InstanceKlass* well_known_klass(WKID id) {
443     assert(id &gt;= (int)FIRST_WKID &amp;&amp; id &lt; (int)WKID_LIMIT, &quot;oob&quot;);
444     return _well_known_klasses[id];
445   }
446 
447   static InstanceKlass** well_known_klass_addr(WKID id) {
448     assert(id &gt;= (int)FIRST_WKID &amp;&amp; id &lt; (int)WKID_LIMIT, &quot;oob&quot;);
449     return &amp;_well_known_klasses[id];
450   }
451   static void well_known_klasses_do(MetaspaceClosure* it);
452 
453   static InstanceKlass* box_klass(BasicType t) {
454     assert((uint)t &lt; T_VOID+1, &quot;range check&quot;);
455     return check_klass(_box_klasses[t]);
456   }
457   static BasicType box_klass_type(Klass* k);  // inverse of box_klass
458 #ifdef ASSERT
459   static bool is_well_known_klass(Klass* k) {
460     return is_well_known_klass(k-&gt;name());
461   }
462   static bool is_well_known_klass(Symbol* class_name);
463 #endif
464 
465 protected:
466   // Returns the class loader data to be used when looking up/updating the
467   // system dictionary.
468   static ClassLoaderData *class_loader_data(Handle class_loader) {
469     return ClassLoaderData::class_loader_data(class_loader());
470   }
471 
472   static bool is_wk_klass_loaded(InstanceKlass* klass) {
473     return !(klass == NULL || !klass-&gt;is_loaded());
474   }
475 
476 public:
477   static bool Object_klass_loaded()         { return is_wk_klass_loaded(WK_KLASS(Object_klass));             }
478   static bool Class_klass_loaded()          { return is_wk_klass_loaded(WK_KLASS(Class_klass));              }
479   static bool Cloneable_klass_loaded()      { return is_wk_klass_loaded(WK_KLASS(Cloneable_klass));          }
480   static bool Parameter_klass_loaded()      { return is_wk_klass_loaded(WK_KLASS(reflect_Parameter_klass));  }
481   static bool ClassLoader_klass_loaded()    { return is_wk_klass_loaded(WK_KLASS(ClassLoader_klass));        }
482 
483   // Returns java system loader
484   static oop java_system_loader();
485 
486   // Returns java platform loader
487   static oop java_platform_loader();
488 
489   // Compute the java system and platform loaders
490   static void compute_java_loaders(TRAPS);
491 
492   // Register a new class loader
493   static ClassLoaderData* register_loader(Handle class_loader, bool create_mirror_cld = false);
494 protected:
495   // Mirrors for primitive classes (created eagerly)
496   static oop check_mirror(oop m) {
497     assert(m != NULL, &quot;mirror not initialized&quot;);
498     return m;
499   }
500 
501 public:
502   // Note:  java_lang_Class::primitive_type is the inverse of java_mirror
503 
504   // Check class loader constraints
505   static bool add_loader_constraint(Symbol* name, Klass* klass_being_linked,  Handle loader1,
506                                     Handle loader2, TRAPS);
507   static Symbol* check_signature_loaders(Symbol* signature, Klass* klass_being_linked,
508                                          Handle loader1, Handle loader2, bool is_method, TRAPS);
509 
510   // JSR 292
511   // find a java.lang.invoke.MethodHandle.invoke* method for a given signature
512   // (asks Java to compute it if necessary, except in a compiler thread)
513   static Method* find_method_handle_invoker(Klass* klass,
514                                             Symbol* name,
515                                             Symbol* signature,
516                                             Klass* accessing_klass,
517                                             Handle *appendix_result,
518                                             TRAPS);
519   // for a given signature, find the internal MethodHandle method (linkTo* or invokeBasic)
520   // (does not ask Java, since this is a low-level intrinsic defined by the JVM)
521   static Method* find_method_handle_intrinsic(vmIntrinsics::ID iid,
522                                               Symbol* signature,
523                                               TRAPS);
524 
525   // compute java_mirror (java.lang.Class instance) for a type (&quot;I&quot;, &quot;[[B&quot;, &quot;LFoo;&quot;, etc.)
526   // Either the accessing_klass or the CL/PD can be non-null, but not both.
527   static Handle    find_java_mirror_for_type(Symbol* signature,
528                                              Klass* accessing_klass,
529                                              Handle class_loader,
530                                              Handle protection_domain,
531                                              SignatureStream::FailureMode failure_mode,
532                                              TRAPS);
533   static Handle    find_java_mirror_for_type(Symbol* signature,
534                                              Klass* accessing_klass,
535                                              SignatureStream::FailureMode failure_mode,
536                                              TRAPS) {
537     // callee will fill in CL/PD from AK, if they are needed
538     return find_java_mirror_for_type(signature, accessing_klass, Handle(), Handle(),
539                                      failure_mode, THREAD);
540   }
541 
542   // find a java.lang.invoke.MethodType object for a given signature
543   // (asks Java to compute it if necessary, except in a compiler thread)
544   static Handle    find_method_handle_type(Symbol* signature,
545                                            Klass* accessing_klass,
546                                            TRAPS);
547 
548   // find a java.lang.Class object for a given signature
549   static Handle    find_field_handle_type(Symbol* signature,
550                                           Klass* accessing_klass,
551                                           TRAPS);
552 
553   // ask Java to compute a java.lang.invoke.MethodHandle object for a given CP entry
554   static Handle    link_method_handle_constant(Klass* caller,
555                                                int ref_kind, //e.g., JVM_REF_invokeVirtual
556                                                Klass* callee,
557                                                Symbol* name,
558                                                Symbol* signature,
559                                                TRAPS);
560 
561   // ask Java to compute a constant by invoking a BSM given a Dynamic_info CP entry
562   static void      invoke_bootstrap_method(BootstrapInfo&amp; bootstrap_specifier, TRAPS);
563 
564   // Record the error when the first attempt to resolve a reference from a constant
565   // pool entry to a class fails.
566   static void add_resolution_error(const constantPoolHandle&amp; pool, int which, Symbol* error,
567                                    Symbol* message);
568   static void delete_resolution_error(ConstantPool* pool);
569   static Symbol* find_resolution_error(const constantPoolHandle&amp; pool, int which,
570                                        Symbol** message);
571 
572 
573   // Record a nest host resolution/validation error
574   static void add_nest_host_error(const constantPoolHandle&amp; pool, int which,
575                                   const char* message);
576   static const char* find_nest_host_error(const constantPoolHandle&amp; pool, int which);
577 
578   static ProtectionDomainCacheEntry* cache_get(Handle protection_domain);
579 
580  protected:
581 
582   enum Constants {
583     _loader_constraint_size = 107,                     // number of entries in constraint table
584     _resolution_error_size  = 107,                     // number of entries in resolution error table
585     _invoke_method_size     = 139,                     // number of entries in invoke method table
586     _placeholder_table_size = 1009                     // number of entries in hash table for placeholders
587   };
588 
589 
590   // Static tables owned by the SystemDictionary
591 
592   // Hashtable holding placeholders for classes being loaded.
593   static PlaceholderTable*       _placeholders;
594 
595   // Lock object for system class loader
596   static OopHandle               _system_loader_lock_obj;
597 
598   // Constraints on class loaders
599   static LoaderConstraintTable*  _loader_constraints;
600 
601   // Resolution errors
602   static ResolutionErrorTable*   _resolution_errors;
603 
604   // Invoke methods (JSR 292)
605   static SymbolPropertyTable*    _invoke_method_table;
606 
607   // ProtectionDomain cache
608   static ProtectionDomainCacheTable*   _pd_cache_table;
609 
610 protected:
611   static void validate_protection_domain(InstanceKlass* klass,
612                                          Handle class_loader,
613                                          Handle protection_domain, TRAPS);
614 
615   friend class VM_PopulateDumpSharedSpace;
616   friend class TraversePlaceholdersClosure;
617   static PlaceholderTable*   placeholders() { return _placeholders; }
618   static LoaderConstraintTable* constraints() { return _loader_constraints; }
619   static ResolutionErrorTable* resolution_errors() { return _resolution_errors; }
620   static SymbolPropertyTable* invoke_method_table() { return _invoke_method_table; }
621   static void post_class_load_event(EventClassLoad* event, const InstanceKlass* k, const ClassLoaderData* init_cld);
622 
623   // Basic loading operations
624   static InstanceKlass* resolve_instance_class_or_null_helper(Symbol* name,
625                                                               Handle class_loader,
626                                                               Handle protection_domain,
627                                                               TRAPS);
628   static InstanceKlass* resolve_instance_class_or_null(Symbol* class_name, Handle class_loader, Handle protection_domain, TRAPS);
629   static Klass* resolve_array_class_or_null(Symbol* class_name, Handle class_loader, Handle protection_domain, TRAPS);
630   static InstanceKlass* handle_parallel_super_load(Symbol* class_name, Symbol* supername, Handle class_loader, Handle protection_domain, Handle lockObject, TRAPS);
631   // Wait on SystemDictionary_lock; unlocks lockObject before
632   // waiting; relocks lockObject with correct recursion count
633   // after waiting, but before reentering SystemDictionary_lock
634   // to preserve lock order semantics.
635   static void double_lock_wait(Handle lockObject, TRAPS);
636   static void define_instance_class(InstanceKlass* k, TRAPS);
637   static InstanceKlass* find_or_define_instance_class(Symbol* class_name,
638                                                 Handle class_loader,
639                                                 InstanceKlass* k, TRAPS);
640   static bool is_shared_class_visible(Symbol* class_name, InstanceKlass* ik,
641                                       PackageEntry* pkg_entry,
642                                       Handle class_loader, TRAPS);
<a name="1" id="anc1"></a>



643   static bool check_shared_class_super_type(InstanceKlass* child, InstanceKlass* super,
644                                             Handle class_loader,  Handle protection_domain,
645                                             bool is_superclass, TRAPS);
646   static bool check_shared_class_super_types(InstanceKlass* ik, Handle class_loader,
647                                                Handle protection_domain, TRAPS);
648   static InstanceKlass* load_shared_lambda_proxy_class(InstanceKlass* ik,
649                                                        Handle class_loader,
650                                                        Handle protection_domain,
651                                                        PackageEntry* pkg_entry,
652                                                        TRAPS);
653   static InstanceKlass* load_shared_class(InstanceKlass* ik,
654                                           Handle class_loader,
655                                           Handle protection_domain,
656                                           const ClassFileStream *cfs,
657                                           PackageEntry* pkg_entry,
658                                           TRAPS);
659   // Second part of load_shared_class
660   static void load_shared_class_misc(InstanceKlass* ik, ClassLoaderData* loader_data, TRAPS) NOT_CDS_RETURN;
661   static InstanceKlass* load_shared_boot_class(Symbol* class_name,
662                                                PackageEntry* pkg_entry,
663                                                TRAPS);
664   static InstanceKlass* load_instance_class(Symbol* class_name, Handle class_loader, TRAPS);
665   static Handle compute_loader_lock_object(Handle class_loader, TRAPS);
666   static void check_loader_lock_contention(Handle loader_lock, TRAPS);
667   static bool is_parallelCapable(Handle class_loader);
668   static bool is_parallelDefine(Handle class_loader);
669 
670 public:
671   static bool is_system_class_loader(oop class_loader);
672   static bool is_platform_class_loader(oop class_loader);
673   static bool is_boot_class_loader(oop class_loader) { return class_loader == NULL; }
674   static bool is_builtin_class_loader(oop class_loader) {
675     return is_boot_class_loader(class_loader)      ||
676            is_platform_class_loader(class_loader)  ||
677            is_system_class_loader(class_loader);
678   }
679   // Returns TRUE if the method is a non-public member of class java.lang.Object.
680   static bool is_nonpublic_Object_method(Method* m) {
681     assert(m != NULL, &quot;Unexpected NULL Method*&quot;);
682     return !m-&gt;is_public() &amp;&amp; m-&gt;method_holder() == SystemDictionary::Object_klass();
683   }
684 
685   // Return Symbol or throw exception if name given is can not be a valid Symbol.
686   static Symbol* class_name_symbol(const char* name, Symbol* exception, TRAPS);
687 
688 protected:
689   // Setup link to hierarchy
690   static void add_to_hierarchy(InstanceKlass* k, TRAPS);
691 
692   // Basic find on loaded classes
693   static InstanceKlass* find_class(unsigned int hash,
694                                    Symbol* name, Dictionary* dictionary);
695   static InstanceKlass* find_class(Symbol* class_name, ClassLoaderData* loader_data);
696 
697   // Basic find on classes in the midst of being loaded
698   static Symbol* find_placeholder(Symbol* name, ClassLoaderData* loader_data);
699 
700   // Resolve well-known classes so they can be used like SystemDictionary::String_klass()
701   static void resolve_well_known_classes(TRAPS);
702   // quick resolve using CDS for well-known classes only.
703   static void quick_resolve(InstanceKlass* klass, ClassLoaderData* loader_data, Handle domain, TRAPS) NOT_CDS_RETURN;
704 
705   // Class loader constraints
706   static void check_constraints(unsigned int hash,
707                                 InstanceKlass* k, Handle loader,
708                                 bool defining, TRAPS);
709   static void update_dictionary(unsigned int d_hash,
710                                 int p_index, unsigned int p_hash,
711                                 InstanceKlass* k, Handle loader,
712                                 TRAPS);
713 
714   static InstanceKlass* _well_known_klasses[];
715 
716   // table of box klasses (int_klass, etc.)
717   static InstanceKlass* _box_klasses[T_VOID+1];
718 
719 private:
720   static OopHandle  _java_system_loader;
721   static OopHandle  _java_platform_loader;
722 
723 public:
724   static TableStatistics placeholders_statistics();
725   static TableStatistics loader_constraints_statistics();
726   static TableStatistics protection_domain_cache_statistics();
727 };
728 
729 #endif // SHARE_CLASSFILE_SYSTEMDICTIONARY_HPP
<a name="2" id="anc2"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="2" type="hidden" />
</body>
</html>