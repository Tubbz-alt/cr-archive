<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff src/java.base/share/classes/java/lang/AbstractStringBuilder.java</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
  </head>
<body>
<center><a href="../../../../../hotspot/share/services/virtualMemoryTracker.cpp.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="Module.java.udiff.html" target="_top">next &gt;</a></center>    <h2>src/java.base/share/classes/java/lang/AbstractStringBuilder.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -29,10 +29,11 @@</span>
  
  import java.util.Arrays;
  import java.util.Spliterator;
  import java.util.stream.IntStream;
  import java.util.stream.StreamSupport;
<span class="udiff-line-added">+ import jdk.internal.util.ArraysSupport;</span>
  
  import static java.lang.String.COMPACT_STRINGS;
  import static java.lang.String.UTF16;
  import static java.lang.String.LATIN1;
  import static java.lang.String.checkIndex;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -237,41 +238,29 @@</span>
       */
      private static final int MAX_ARRAY_SIZE = Integer.MAX_VALUE - 8;
  
      /**
       * Returns a capacity at least as large as the given minimum capacity.
<span class="udiff-line-modified-removed">-      * Returns the current capacity increased by the same amount + 2 if</span>
<span class="udiff-line-modified-added">+      * Returns the current capacity increased by the current length + 2 if</span>
       * that suffices.
       * Will not return a capacity greater than
       * {@code (MAX_ARRAY_SIZE &gt;&gt; coder)} unless the given minimum capacity
       * is greater than that.
       *
       * @param  minCapacity the desired minimum capacity
       * @throws OutOfMemoryError if minCapacity is less than zero or
       *         greater than (Integer.MAX_VALUE &gt;&gt; coder)
       */
      private int newCapacity(int minCapacity) {
<span class="udiff-line-modified-removed">-         // overflow-conscious code</span>
<span class="udiff-line-modified-removed">-         int oldCapacity = value.length &gt;&gt; coder;</span>
<span class="udiff-line-modified-removed">-         int newCapacity = (oldCapacity &lt;&lt; 1) + 2;</span>
<span class="udiff-line-modified-removed">-         if (newCapacity - minCapacity &lt; 0) {</span>
<span class="udiff-line-modified-removed">-             newCapacity = minCapacity;</span>
<span class="udiff-line-modified-removed">-         }</span>
<span class="udiff-line-removed">-         int SAFE_BOUND = MAX_ARRAY_SIZE &gt;&gt; coder;</span>
<span class="udiff-line-removed">-         return (newCapacity &lt;= 0 || SAFE_BOUND - newCapacity &lt; 0)</span>
<span class="udiff-line-removed">-             ? hugeCapacity(minCapacity)</span>
<span class="udiff-line-removed">-             : newCapacity;</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     private int hugeCapacity(int minCapacity) {</span>
<span class="udiff-line-removed">-         int SAFE_BOUND = MAX_ARRAY_SIZE &gt;&gt; coder;</span>
<span class="udiff-line-removed">-         int UNSAFE_BOUND = Integer.MAX_VALUE &gt;&gt; coder;</span>
<span class="udiff-line-removed">-         if (UNSAFE_BOUND - minCapacity &lt; 0) { // overflow</span>
<span class="udiff-line-removed">-             throw new OutOfMemoryError();</span>
<span class="udiff-line-modified-added">+         int oldLength = value.length;</span>
<span class="udiff-line-modified-added">+         int newLength = minCapacity &lt;&lt; coder;</span>
<span class="udiff-line-modified-added">+         int growth = newLength - oldLength;</span>
<span class="udiff-line-modified-added">+         int length = ArraysSupport.newLength(oldLength, growth, oldLength + (2 &lt;&lt; coder));</span>
<span class="udiff-line-modified-added">+         if (length == Integer.MAX_VALUE) {</span>
<span class="udiff-line-modified-added">+             throw new OutOfMemoryError(&quot;Required length exceeds implementation limit&quot;);</span>
          }
<span class="udiff-line-modified-removed">-         return (minCapacity &gt; SAFE_BOUND)</span>
<span class="udiff-line-removed">-             ? minCapacity : SAFE_BOUND;</span>
<span class="udiff-line-modified-added">+         return length &gt;&gt; coder;</span>
      }
  
      /**
       * If the coder is &quot;isLatin1&quot;, this inflates the internal 8-bit storage
       * to 16-bit &lt;hi=0, low&gt; pair storage.
</pre>
<center><a href="../../../../../hotspot/share/services/virtualMemoryTracker.cpp.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="Module.java.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>