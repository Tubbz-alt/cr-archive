<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff test/jdk/tools/jpackage/helpers/jdk/jpackage/test/PackageTest.java</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="LinuxHelper.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="../../../../share/AddLauncherTest.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>test/jdk/tools/jpackage/helpers/jdk/jpackage/test/PackageTest.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
222     }
223 
224     static void withTestFileAssociationsFile(FileAssociations fa,
225             ThrowingConsumer&lt;Path&gt; consumer) {
226         final Path testFileDefaultName = Path.of(&quot;test&quot; + fa.getSuffix());
227         TKit.withTempFile(testFileDefaultName, testFile -&gt; {
228             if (TKit.isLinux()) {
229                 LinuxHelper.initFileAssociationsTestFile(testFile);
230             }
231             consumer.accept(testFile);
232         });
233     }
234 
235     PackageTest addHelloAppFileAssociationsVerifier(FileAssociations fa,
236             String... faLauncherDefaultArgs) {
237 
238         // Setup test app to have valid jpackage command line before
239         // running check of type of environment.
240         addHelloAppInitializer(null);
241 




242         String noActionMsg = &quot;Not running file associations test&quot;;
243         if (GraphicsEnvironment.isHeadless()) {
244             TKit.trace(String.format(
245                     &quot;%s because running in headless environment&quot;, noActionMsg));
246             return this;
247         }
248 
249         addInstallVerifier(cmd -&gt; {
250             if (cmd.isFakeRuntime(noActionMsg) || cmd.isPackageUnpacked(noActionMsg)) {
251                 return;
252             }
253 
254             withTestFileAssociationsFile(fa, testFile -&gt; {
255                 testFile = testFile.toAbsolutePath().normalize();
256 
257                 final Path appOutput = testFile.getParent()
258                         .resolve(HelloApp.OUTPUT_FILENAME);
259                 Files.deleteIfExists(appOutput);
260 
261                 TKit.trace(String.format(&quot;Use desktop to open [%s] file&quot;,
262                         testFile));
263                 Desktop.getDesktop().open(testFile.toFile());
264                 TKit.waitForFileCreated(appOutput, 7);
265 
266                 List&lt;String&gt; expectedArgs = new ArrayList&lt;&gt;(List.of(
267                         faLauncherDefaultArgs));
268                 expectedArgs.add(testFile.toString());
269 
270                 // Wait a little bit after file has been created to
271                 // make sure there are no pending writes into it.
272                 Thread.sleep(3000);
273                 HelloApp.verifyOutputFile(appOutput, expectedArgs,
274                         Collections.emptyMap());
275             });
276         });
277 
<span class="line-removed">278         forTypes(PackageType.LINUX, () -&gt; {</span>
<span class="line-removed">279             LinuxHelper.addFileAssociationsVerifier(this, fa);</span>
<span class="line-removed">280         });</span>
<span class="line-removed">281 </span>
282         return this;
283     }
284 
285     public PackageTest forTypes(Collection&lt;PackageType&gt; types, Runnable action) {
286         Set&lt;PackageType&gt; oldTypes = Set.of(currentTypes.toArray(
287                 PackageType[]::new));
288         try {
289             forTypes(types);
290             action.run();
291         } finally {
292             forTypes(oldTypes);
293         }
294         return this;
295     }
296 
297     public PackageTest forTypes(PackageType type, Runnable action) {
298         return forTypes(List.of(type), action);
299     }
300 
301     public PackageTest notForTypes(Collection&lt;PackageType&gt; types, Runnable action) {
</pre>
<hr />
<pre>
536 
537         private void verifyPackageBundle(JPackageCommand cmd,
538                 Executor.Result result) {
539             if (expectedJPackageExitCode == 0) {
540                 if (PackageType.LINUX.contains(cmd.packageType())) {
541                     LinuxHelper.verifyPackageBundleEssential(cmd);
542                 }
543             }
544             bundleVerifiers.forEach(v -&gt; v.accept(cmd, result));
545         }
546 
547         private void verifyPackageInstalled(JPackageCommand cmd) {
548             final String formatString;
549             if (cmd.isPackageUnpacked()) {
550                 formatString = &quot;Verify unpacked: %s&quot;;
551             } else {
552                 formatString = &quot;Verify installed: %s&quot;;
553             }
554             TKit.trace(String.format(formatString, cmd.getPrintableCommandLine()));
555 
<span class="line-removed">556             TKit.assertDirectoryExists(cmd.appRuntimeDirectory());</span>
557             if (!cmd.isRuntime()) {
<span class="line-removed">558                 TKit.assertExecutableFileExists(cmd.appLauncherPath());</span>
<span class="line-removed">559 </span>
560                 if (PackageType.WINDOWS.contains(cmd.packageType())
561                         &amp;&amp; !cmd.isPackageUnpacked(
562                                 &quot;Not verifying desktop integration&quot;)) {
563                     new WindowsHelper.DesktopIntegrationVerifier(cmd);
564                 }
565             }
<span class="line-modified">566 </span>
<span class="line-removed">567             if (cmd.isPackageUnpacked()) {</span>
<span class="line-removed">568                 final Path appImageFile = AppImageFile.getPathInAppImage(</span>
<span class="line-removed">569                         Path.of(&quot;&quot;));</span>
<span class="line-removed">570                 try (Stream&lt;Path&gt; walk = ThrowingSupplier.toSupplier(</span>
<span class="line-removed">571                         () -&gt; Files.walk(cmd.unpackedPackageDirectory())).get()) {</span>
<span class="line-removed">572                     walk.filter(path -&gt; path.getFileName().equals(appImageFile))</span>
<span class="line-removed">573                         .findFirst()</span>
<span class="line-removed">574                         .ifPresent(path -&gt; TKit.assertPathExists(path, false));</span>
<span class="line-removed">575                 }</span>
<span class="line-removed">576             } else {</span>
<span class="line-removed">577                 TKit.assertPathExists(AppImageFile.getPathInAppImage(</span>
<span class="line-removed">578                         cmd.appInstallationDirectory()), false);</span>
<span class="line-removed">579             }</span>
580 
581             installVerifiers.forEach(v -&gt; v.accept(cmd));
582         }
583 
584         private void verifyPackageUninstalled(JPackageCommand cmd) {
585             TKit.trace(String.format(&quot;Verify uninstalled: %s&quot;,
586                     cmd.getPrintableCommandLine()));
587             if (!cmd.isRuntime()) {
588                 TKit.assertPathExists(cmd.appLauncherPath(), false);
589 
590                 if (PackageType.WINDOWS.contains(cmd.packageType())) {
591                     new WindowsHelper.DesktopIntegrationVerifier(cmd);
592                 }
593             }
594 
595             Path appInstallDir = cmd.appInstallationDirectory();
596             if (TKit.isLinux() &amp;&amp; Path.of(&quot;/&quot;).equals(appInstallDir)) {
597                 ApplicationLayout appLayout = cmd.appLayout();
598                 TKit.assertPathExists(appLayout.runtimeDirectory(), false);
599             } else {
</pre>
</td>
<td>
<hr />
<pre>
222     }
223 
224     static void withTestFileAssociationsFile(FileAssociations fa,
225             ThrowingConsumer&lt;Path&gt; consumer) {
226         final Path testFileDefaultName = Path.of(&quot;test&quot; + fa.getSuffix());
227         TKit.withTempFile(testFileDefaultName, testFile -&gt; {
228             if (TKit.isLinux()) {
229                 LinuxHelper.initFileAssociationsTestFile(testFile);
230             }
231             consumer.accept(testFile);
232         });
233     }
234 
235     PackageTest addHelloAppFileAssociationsVerifier(FileAssociations fa,
236             String... faLauncherDefaultArgs) {
237 
238         // Setup test app to have valid jpackage command line before
239         // running check of type of environment.
240         addHelloAppInitializer(null);
241 
<span class="line-added">242         forTypes(PackageType.LINUX, () -&gt; {</span>
<span class="line-added">243             LinuxHelper.addFileAssociationsVerifier(this, fa);</span>
<span class="line-added">244         });</span>
<span class="line-added">245 </span>
246         String noActionMsg = &quot;Not running file associations test&quot;;
247         if (GraphicsEnvironment.isHeadless()) {
248             TKit.trace(String.format(
249                     &quot;%s because running in headless environment&quot;, noActionMsg));
250             return this;
251         }
252 
253         addInstallVerifier(cmd -&gt; {
254             if (cmd.isFakeRuntime(noActionMsg) || cmd.isPackageUnpacked(noActionMsg)) {
255                 return;
256             }
257 
258             withTestFileAssociationsFile(fa, testFile -&gt; {
259                 testFile = testFile.toAbsolutePath().normalize();
260 
261                 final Path appOutput = testFile.getParent()
262                         .resolve(HelloApp.OUTPUT_FILENAME);
263                 Files.deleteIfExists(appOutput);
264 
265                 TKit.trace(String.format(&quot;Use desktop to open [%s] file&quot;,
266                         testFile));
267                 Desktop.getDesktop().open(testFile.toFile());
268                 TKit.waitForFileCreated(appOutput, 7);
269 
270                 List&lt;String&gt; expectedArgs = new ArrayList&lt;&gt;(List.of(
271                         faLauncherDefaultArgs));
272                 expectedArgs.add(testFile.toString());
273 
274                 // Wait a little bit after file has been created to
275                 // make sure there are no pending writes into it.
276                 Thread.sleep(3000);
277                 HelloApp.verifyOutputFile(appOutput, expectedArgs,
278                         Collections.emptyMap());
279             });
280         });
281 




282         return this;
283     }
284 
285     public PackageTest forTypes(Collection&lt;PackageType&gt; types, Runnable action) {
286         Set&lt;PackageType&gt; oldTypes = Set.of(currentTypes.toArray(
287                 PackageType[]::new));
288         try {
289             forTypes(types);
290             action.run();
291         } finally {
292             forTypes(oldTypes);
293         }
294         return this;
295     }
296 
297     public PackageTest forTypes(PackageType type, Runnable action) {
298         return forTypes(List.of(type), action);
299     }
300 
301     public PackageTest notForTypes(Collection&lt;PackageType&gt; types, Runnable action) {
</pre>
<hr />
<pre>
536 
537         private void verifyPackageBundle(JPackageCommand cmd,
538                 Executor.Result result) {
539             if (expectedJPackageExitCode == 0) {
540                 if (PackageType.LINUX.contains(cmd.packageType())) {
541                     LinuxHelper.verifyPackageBundleEssential(cmd);
542                 }
543             }
544             bundleVerifiers.forEach(v -&gt; v.accept(cmd, result));
545         }
546 
547         private void verifyPackageInstalled(JPackageCommand cmd) {
548             final String formatString;
549             if (cmd.isPackageUnpacked()) {
550                 formatString = &quot;Verify unpacked: %s&quot;;
551             } else {
552                 formatString = &quot;Verify installed: %s&quot;;
553             }
554             TKit.trace(String.format(formatString, cmd.getPrintableCommandLine()));
555 

556             if (!cmd.isRuntime()) {


557                 if (PackageType.WINDOWS.contains(cmd.packageType())
558                         &amp;&amp; !cmd.isPackageUnpacked(
559                                 &quot;Not verifying desktop integration&quot;)) {
560                     new WindowsHelper.DesktopIntegrationVerifier(cmd);
561                 }
562             }
<span class="line-modified">563             cmd.assertAppLayout();</span>













564 
565             installVerifiers.forEach(v -&gt; v.accept(cmd));
566         }
567 
568         private void verifyPackageUninstalled(JPackageCommand cmd) {
569             TKit.trace(String.format(&quot;Verify uninstalled: %s&quot;,
570                     cmd.getPrintableCommandLine()));
571             if (!cmd.isRuntime()) {
572                 TKit.assertPathExists(cmd.appLauncherPath(), false);
573 
574                 if (PackageType.WINDOWS.contains(cmd.packageType())) {
575                     new WindowsHelper.DesktopIntegrationVerifier(cmd);
576                 }
577             }
578 
579             Path appInstallDir = cmd.appInstallationDirectory();
580             if (TKit.isLinux() &amp;&amp; Path.of(&quot;/&quot;).equals(appInstallDir)) {
581                 ApplicationLayout appLayout = cmd.appLayout();
582                 TKit.assertPathExists(appLayout.runtimeDirectory(), false);
583             } else {
</pre>
</td>
</tr>
</table>
<center><a href="LinuxHelper.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="../../../../share/AddLauncherTest.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>