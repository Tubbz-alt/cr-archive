<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff test/jdk/tools/jpackage/helpers/jdk/jpackage/test/LinuxHelper.java</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="JPackageCommand.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="PackageTest.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>test/jdk/tools/jpackage/helpers/jdk/jpackage/test/LinuxHelper.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 package jdk.jpackage.test;
 24 
 25 import java.io.IOException;
 26 import java.nio.file.Files;
 27 import java.nio.file.Path;
<span class="line-modified"> 28 import java.util.*;</span>






 29 import java.util.function.Function;


 30 import java.util.stream.Collectors;
 31 import java.util.stream.Stream;

 32 import jdk.jpackage.test.PackageTest.PackageHandlers;
 33 


 34 public class LinuxHelper {
 35     private static String getRelease(JPackageCommand cmd) {
 36         return cmd.getArgumentValue(&quot;--linux-app-release&quot;, () -&gt; &quot;1&quot;);
 37     }
 38 
 39     public static String getPackageName(JPackageCommand cmd) {
 40         cmd.verifyIsOfType(PackageType.LINUX);
 41         return cmd.getArgumentValue(&quot;--linux-package-name&quot;,
 42                 () -&gt; cmd.name().toLowerCase());
 43     }
 44 
 45     public static Path getDesktopFile(JPackageCommand cmd) {
 46         return getDesktopFile(cmd, null);
 47     }
 48 
 49     public static Path getDesktopFile(JPackageCommand cmd, String launcherName) {
 50         cmd.verifyIsOfType(PackageType.LINUX);
 51         String desktopFileName = String.format(&quot;%s-%s.desktop&quot;, getPackageName(
 52                 cmd), Optional.ofNullable(launcherName).orElseGet(
 53                         () -&gt; cmd.name()).replaceAll(&quot;\\s+&quot;, &quot;_&quot;));
</pre>
<hr />
<pre>
263 
264         List&lt;String&gt; prerequisites = LinuxHelper.getPrerequisitePackages(cmd);
265         if (checkPrerequisites) {
266             final String vitalPackage = &quot;libc&quot;;
267             TKit.assertTrue(prerequisites.stream().filter(
268                     dep -&gt; dep.contains(vitalPackage)).findAny().isPresent(),
269                     String.format(
270                             &quot;Check [%s] package is in the list of required packages %s of [%s] package&quot;,
271                             vitalPackage, prerequisites, packageName));
272         } else {
273             TKit.trace(String.format(
274                     &quot;Not cheking %s required packages of [%s] package&quot;,
275                     prerequisites, packageName));
276         }
277     }
278 
279     static void addBundleDesktopIntegrationVerifier(PackageTest test,
280             boolean integrated) {
281         final String xdgUtils = &quot;xdg-utils&quot;;
282 
<span class="line-removed">283         test.addBundleVerifier(cmd -&gt; {</span>
<span class="line-removed">284             List&lt;String&gt; prerequisites = getPrerequisitePackages(cmd);</span>
<span class="line-removed">285             boolean xdgUtilsFound = prerequisites.contains(xdgUtils);</span>
<span class="line-removed">286             if (integrated) {</span>
<span class="line-removed">287                 TKit.assertTrue(xdgUtilsFound, String.format(</span>
<span class="line-removed">288                         &quot;Check [%s] is in the list of required packages %s&quot;,</span>
<span class="line-removed">289                         xdgUtils, prerequisites));</span>
<span class="line-removed">290             } else {</span>
<span class="line-removed">291                 TKit.assertFalse(xdgUtilsFound, String.format(</span>
<span class="line-removed">292                         &quot;Check [%s] is NOT in the list of required packages %s&quot;,</span>
<span class="line-removed">293                         xdgUtils, prerequisites));</span>
<span class="line-removed">294             }</span>
<span class="line-removed">295         });</span>
<span class="line-removed">296 </span>
<span class="line-removed">297         test.forTypes(PackageType.LINUX_DEB, () -&gt; {</span>
<span class="line-removed">298             addDebBundleDesktopIntegrationVerifier(test, integrated);</span>
<span class="line-removed">299         });</span>
<span class="line-removed">300     }</span>
<span class="line-removed">301 </span>
<span class="line-removed">302     private static void addDebBundleDesktopIntegrationVerifier(PackageTest test,</span>
<span class="line-removed">303             boolean integrated) {</span>
304         Function&lt;List&lt;String&gt;, String&gt; verifier = (lines) -&gt; {
305             // Lookup for xdg commands
306             return lines.stream().filter(line -&gt; {
307                 Set&lt;String&gt; words = Stream.of(line.split(&quot;\\s+&quot;)).collect(
308                         Collectors.toSet());
309                 return words.contains(&quot;xdg-desktop-menu&quot;) || words.contains(
310                         &quot;xdg-mime&quot;) || words.contains(&quot;xdg-icon-resource&quot;);
311             }).findFirst().orElse(null);
312         };
313 
314         test.addBundleVerifier(cmd -&gt; {
<span class="line-modified">315             TKit.withTempDirectory(&quot;dpkg-control-files&quot;, tempDir -&gt; {</span>
<span class="line-modified">316                 // Extract control Debian package files into temporary directory</span>
<span class="line-modified">317                 Executor.of(&quot;dpkg&quot;, &quot;-e&quot;)</span>
<span class="line-modified">318                 .addArgument(cmd.outputBundle())</span>
<span class="line-modified">319                 .addArgument(tempDir)</span>
<span class="line-modified">320                 .execute();</span>
321 
<span class="line-modified">322                 Path controlFile = Path.of(&quot;postinst&quot;);</span>








323 
<span class="line-modified">324                 // Lookup for xdg commands in postinstall script</span>
<span class="line-modified">325                 String lineWithXsdCommand = verifier.apply(</span>
<span class="line-modified">326                         Files.readAllLines(tempDir.resolve(controlFile)));</span>
327                 String assertMsg = String.format(
<span class="line-modified">328                         &quot;Check if %s@%s control file uses xdg commands&quot;,</span>
<span class="line-modified">329                         cmd.outputBundle(), controlFile);</span>
330                 if (integrated) {
331                     TKit.assertNotNull(lineWithXsdCommand, assertMsg);
332                 } else {
333                     TKit.assertNull(lineWithXsdCommand, assertMsg);
334                 }
335             });
336         });
337     }
338 
339     static void initFileAssociationsTestFile(Path testFile) {
340         try {
341             // Write something in test file.
342             // On Ubuntu and Oracle Linux empty files are considered
343             // plain text. Seems like a system bug.
344             //
345             // $ &gt;foo.jptest1
346             // $ xdg-mime query filetype foo.jptest1
347             // text/plain
348             // $ echo &gt; foo.jptest1
349             // $ xdg-mime query filetype foo.jptest1
</pre>
<hr />
<pre>
394                         mimeHandler, String.format(
395                                 &quot;Check mime type handler is the main application launcher&quot;));
396 
397             });
398         });
399 
400         test.addUninstallVerifier(cmd -&gt; {
401             PackageTest.withTestFileAssociationsFile(fa, testFile -&gt; {
402                 String mimeType = queryFileMimeType(testFile);
403 
404                 TKit.assertNotEquals(fa.getMime(), mimeType, String.format(
405                         &quot;Check mime type of [%s] file&quot;, testFile));
406 
407                 String desktopFileName = queryMimeTypeDefaultHandler(fa.getMime());
408 
409                 TKit.assertNull(desktopFileName, String.format(
410                         &quot;Check there is no default handler for [%s] mime type&quot;,
411                         fa.getMime()));
412             });
413         });













414     }
415 
416     private static String queryFileMimeType(Path file) {
417         return Executor.of(&quot;xdg-mime&quot;, &quot;query&quot;, &quot;filetype&quot;).addArgument(file)
418                 .executeAndGetFirstLineOfOutput();
419     }
420 
421     private static String queryMimeTypeDefaultHandler(String mimeType) {
422         return Executor.of(&quot;xdg-mime&quot;, &quot;query&quot;, &quot;default&quot;, mimeType)
423                 .executeAndGetFirstLineOfOutput();
424     }
425 




















































































































426     public static String getDefaultPackageArch(PackageType type) {
427         if (archs == null) {
428             archs = new HashMap&lt;&gt;();
429         }
430 
431         String arch = archs.get(type);
432         if (arch == null) {
433             Executor exec = null;
434             switch (type) {
435                 case LINUX_DEB:
436                     exec = Executor.of(&quot;dpkg&quot;, &quot;--print-architecture&quot;);
437                     break;
438 
439                 case LINUX_RPM:
440                     exec = Executor.of(&quot;rpmbuild&quot;, &quot;--eval=%{_target_cpu}&quot;);
441                     break;
442             }
443             arch = exec.executeAndGetFirstLineOfOutput();
444             archs.put(type, arch);
445         }
446         return arch;
447     }
448 
449     static final Set&lt;Path&gt; CRITICAL_RUNTIME_FILES = Set.of(Path.of(
450             &quot;lib/server/libjvm.so&quot;));
451 
<span class="line-modified">452     static private Map&lt;PackageType, String&gt; archs;</span>





453 }
</pre>
</td>
<td>
<hr />
<pre>
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 package jdk.jpackage.test;
 24 
 25 import java.io.IOException;
 26 import java.nio.file.Files;
 27 import java.nio.file.Path;
<span class="line-modified"> 28 import java.util.ArrayList;</span>
<span class="line-added"> 29 import java.util.Arrays;</span>
<span class="line-added"> 30 import java.util.HashMap;</span>
<span class="line-added"> 31 import java.util.List;</span>
<span class="line-added"> 32 import java.util.Map;</span>
<span class="line-added"> 33 import java.util.Optional;</span>
<span class="line-added"> 34 import java.util.Set;</span>
 35 import java.util.function.Function;
<span class="line-added"> 36 import java.util.regex.Matcher;</span>
<span class="line-added"> 37 import java.util.regex.Pattern;</span>
 38 import java.util.stream.Collectors;
 39 import java.util.stream.Stream;
<span class="line-added"> 40 import jdk.incubator.jpackage.internal.IOUtils;</span>
 41 import jdk.jpackage.test.PackageTest.PackageHandlers;
 42 
<span class="line-added"> 43 </span>
<span class="line-added"> 44 </span>
 45 public class LinuxHelper {
 46     private static String getRelease(JPackageCommand cmd) {
 47         return cmd.getArgumentValue(&quot;--linux-app-release&quot;, () -&gt; &quot;1&quot;);
 48     }
 49 
 50     public static String getPackageName(JPackageCommand cmd) {
 51         cmd.verifyIsOfType(PackageType.LINUX);
 52         return cmd.getArgumentValue(&quot;--linux-package-name&quot;,
 53                 () -&gt; cmd.name().toLowerCase());
 54     }
 55 
 56     public static Path getDesktopFile(JPackageCommand cmd) {
 57         return getDesktopFile(cmd, null);
 58     }
 59 
 60     public static Path getDesktopFile(JPackageCommand cmd, String launcherName) {
 61         cmd.verifyIsOfType(PackageType.LINUX);
 62         String desktopFileName = String.format(&quot;%s-%s.desktop&quot;, getPackageName(
 63                 cmd), Optional.ofNullable(launcherName).orElseGet(
 64                         () -&gt; cmd.name()).replaceAll(&quot;\\s+&quot;, &quot;_&quot;));
</pre>
<hr />
<pre>
274 
275         List&lt;String&gt; prerequisites = LinuxHelper.getPrerequisitePackages(cmd);
276         if (checkPrerequisites) {
277             final String vitalPackage = &quot;libc&quot;;
278             TKit.assertTrue(prerequisites.stream().filter(
279                     dep -&gt; dep.contains(vitalPackage)).findAny().isPresent(),
280                     String.format(
281                             &quot;Check [%s] package is in the list of required packages %s of [%s] package&quot;,
282                             vitalPackage, prerequisites, packageName));
283         } else {
284             TKit.trace(String.format(
285                     &quot;Not cheking %s required packages of [%s] package&quot;,
286                     prerequisites, packageName));
287         }
288     }
289 
290     static void addBundleDesktopIntegrationVerifier(PackageTest test,
291             boolean integrated) {
292         final String xdgUtils = &quot;xdg-utils&quot;;
293 





















294         Function&lt;List&lt;String&gt;, String&gt; verifier = (lines) -&gt; {
295             // Lookup for xdg commands
296             return lines.stream().filter(line -&gt; {
297                 Set&lt;String&gt; words = Stream.of(line.split(&quot;\\s+&quot;)).collect(
298                         Collectors.toSet());
299                 return words.contains(&quot;xdg-desktop-menu&quot;) || words.contains(
300                         &quot;xdg-mime&quot;) || words.contains(&quot;xdg-icon-resource&quot;);
301             }).findFirst().orElse(null);
302         };
303 
304         test.addBundleVerifier(cmd -&gt; {
<span class="line-modified">305             // Verify dependencies.</span>
<span class="line-modified">306             List&lt;String&gt; prerequisites = getPrerequisitePackages(cmd);</span>
<span class="line-modified">307             boolean xdgUtilsFound = prerequisites.contains(xdgUtils);</span>
<span class="line-modified">308             TKit.assertTrue(xdgUtilsFound == integrated, String.format(</span>
<span class="line-modified">309                     &quot;Check [%s] is%s in the list of required packages %s&quot;,</span>
<span class="line-modified">310                     xdgUtils, integrated ? &quot;&quot; : &quot; NOT&quot;, prerequisites));</span>
311 
<span class="line-modified">312             Map&lt;Scriptlet, List&lt;String&gt;&gt; scriptlets = getScriptlets(cmd);</span>
<span class="line-added">313             if (integrated) {</span>
<span class="line-added">314                 Set&lt;Scriptlet&gt; requiredScriptlets = Stream.of(Scriptlet.values()).sorted().collect(</span>
<span class="line-added">315                         Collectors.toSet());</span>
<span class="line-added">316                 TKit.assertTrue(scriptlets.keySet().containsAll(</span>
<span class="line-added">317                         requiredScriptlets), String.format(</span>
<span class="line-added">318                                 &quot;Check all required scriptlets %s found in the package. Package scriptlets: %s&quot;,</span>
<span class="line-added">319                                 requiredScriptlets, scriptlets.keySet()));</span>
<span class="line-added">320             }</span>
321 
<span class="line-modified">322             // Lookup for xdg commands in scriptlets.</span>
<span class="line-modified">323             scriptlets.entrySet().forEach(scriptlet -&gt; {</span>
<span class="line-modified">324                 String lineWithXsdCommand = verifier.apply(scriptlet.getValue());</span>
325                 String assertMsg = String.format(
<span class="line-modified">326                         &quot;Check if [%s] scriptlet uses xdg commands&quot;,</span>
<span class="line-modified">327                         scriptlet.getKey());</span>
328                 if (integrated) {
329                     TKit.assertNotNull(lineWithXsdCommand, assertMsg);
330                 } else {
331                     TKit.assertNull(lineWithXsdCommand, assertMsg);
332                 }
333             });
334         });
335     }
336 
337     static void initFileAssociationsTestFile(Path testFile) {
338         try {
339             // Write something in test file.
340             // On Ubuntu and Oracle Linux empty files are considered
341             // plain text. Seems like a system bug.
342             //
343             // $ &gt;foo.jptest1
344             // $ xdg-mime query filetype foo.jptest1
345             // text/plain
346             // $ echo &gt; foo.jptest1
347             // $ xdg-mime query filetype foo.jptest1
</pre>
<hr />
<pre>
392                         mimeHandler, String.format(
393                                 &quot;Check mime type handler is the main application launcher&quot;));
394 
395             });
396         });
397 
398         test.addUninstallVerifier(cmd -&gt; {
399             PackageTest.withTestFileAssociationsFile(fa, testFile -&gt; {
400                 String mimeType = queryFileMimeType(testFile);
401 
402                 TKit.assertNotEquals(fa.getMime(), mimeType, String.format(
403                         &quot;Check mime type of [%s] file&quot;, testFile));
404 
405                 String desktopFileName = queryMimeTypeDefaultHandler(fa.getMime());
406 
407                 TKit.assertNull(desktopFileName, String.format(
408                         &quot;Check there is no default handler for [%s] mime type&quot;,
409                         fa.getMime()));
410             });
411         });
<span class="line-added">412 </span>
<span class="line-added">413         test.addBundleVerifier(cmd -&gt; {</span>
<span class="line-added">414             final Path mimeTypeIconFileName = fa.getLinuxIconFileName();</span>
<span class="line-added">415             if (mimeTypeIconFileName != null) {</span>
<span class="line-added">416                 // Verify there are xdg registration commands for mime icon file.</span>
<span class="line-added">417                 Path mimeTypeIcon = cmd.appLayout().destktopIntegrationDirectory().resolve(</span>
<span class="line-added">418                         mimeTypeIconFileName);</span>
<span class="line-added">419 </span>
<span class="line-added">420                 Map&lt;Scriptlet, List&lt;String&gt;&gt; scriptlets = getScriptlets(cmd);</span>
<span class="line-added">421                 scriptlets.entrySet().stream().forEach(e -&gt; verifyIconInScriptlet(</span>
<span class="line-added">422                         e.getKey(), e.getValue(), mimeTypeIcon));</span>
<span class="line-added">423             }</span>
<span class="line-added">424         });</span>
425     }
426 
427     private static String queryFileMimeType(Path file) {
428         return Executor.of(&quot;xdg-mime&quot;, &quot;query&quot;, &quot;filetype&quot;).addArgument(file)
429                 .executeAndGetFirstLineOfOutput();
430     }
431 
432     private static String queryMimeTypeDefaultHandler(String mimeType) {
433         return Executor.of(&quot;xdg-mime&quot;, &quot;query&quot;, &quot;default&quot;, mimeType)
434                 .executeAndGetFirstLineOfOutput();
435     }
436 
<span class="line-added">437     private static void verifyIconInScriptlet(Scriptlet scriptletType,</span>
<span class="line-added">438             List&lt;String&gt; scriptletBody, Path iconPathInPackage) {</span>
<span class="line-added">439         final String dashMime = IOUtils.replaceSuffix(</span>
<span class="line-added">440                 iconPathInPackage.getFileName(), null).toString();</span>
<span class="line-added">441         final String xdgCmdName = &quot;xdg-icon-resource&quot;;</span>
<span class="line-added">442 </span>
<span class="line-added">443         Stream&lt;String&gt; scriptletBodyStream = scriptletBody.stream()</span>
<span class="line-added">444                 .filter(str -&gt; str.startsWith(xdgCmdName))</span>
<span class="line-added">445                 .filter(str -&gt; Pattern.compile(</span>
<span class="line-added">446                         &quot;\\b&quot; + dashMime + &quot;\\b&quot;).matcher(str).find());</span>
<span class="line-added">447         if (scriptletType == Scriptlet.PostInstall) {</span>
<span class="line-added">448             scriptletBodyStream = scriptletBodyStream.filter(str -&gt; List.of(</span>
<span class="line-added">449                     str.split(&quot;\\s+&quot;)).contains(iconPathInPackage.toString()));</span>
<span class="line-added">450         }</span>
<span class="line-added">451 </span>
<span class="line-added">452         scriptletBodyStream.peek(xdgCmd -&gt; {</span>
<span class="line-added">453             Matcher m = XDG_CMD_ICON_SIZE_PATTERN.matcher(xdgCmd);</span>
<span class="line-added">454             TKit.assertTrue(m.find(), String.format(</span>
<span class="line-added">455                     &quot;Check icon size is specified as a number in [%s] xdg command of [%s] scriptlet&quot;,</span>
<span class="line-added">456                     xdgCmd, scriptletType));</span>
<span class="line-added">457             int iconSize = Integer.parseInt(m.group(1));</span>
<span class="line-added">458             TKit.assertTrue(XDG_CMD_VALID_ICON_SIZES.contains(iconSize),</span>
<span class="line-added">459                     String.format(</span>
<span class="line-added">460                             &quot;Check icon size [%s] is one of %s values&quot;,</span>
<span class="line-added">461                             iconSize, XDG_CMD_VALID_ICON_SIZES));</span>
<span class="line-added">462         })</span>
<span class="line-added">463         .findFirst().orElseGet(() -&gt; {</span>
<span class="line-added">464             TKit.assertUnexpected(String.format(</span>
<span class="line-added">465                     &quot;Failed to find [%s] command in [%s] scriptlet for [%s] icon file&quot;,</span>
<span class="line-added">466                     xdgCmdName, scriptletType, iconPathInPackage));</span>
<span class="line-added">467             return null;</span>
<span class="line-added">468         });</span>
<span class="line-added">469     }</span>
<span class="line-added">470 </span>
<span class="line-added">471     private static Map&lt;Scriptlet, List&lt;String&gt;&gt; getScriptlets(</span>
<span class="line-added">472             JPackageCommand cmd, Scriptlet... scriptlets) {</span>
<span class="line-added">473         cmd.verifyIsOfType(PackageType.LINUX);</span>
<span class="line-added">474 </span>
<span class="line-added">475         Set&lt;Scriptlet&gt; scriptletSet = Set.of(</span>
<span class="line-added">476                 scriptlets.length == 0 ? Scriptlet.values() : scriptlets);</span>
<span class="line-added">477         switch (cmd.packageType()) {</span>
<span class="line-added">478             case LINUX_DEB:</span>
<span class="line-added">479                 return getDebScriptlets(cmd, scriptletSet);</span>
<span class="line-added">480 </span>
<span class="line-added">481             case LINUX_RPM:</span>
<span class="line-added">482                 return getRpmScriptlets(cmd, scriptletSet);</span>
<span class="line-added">483         }</span>
<span class="line-added">484 </span>
<span class="line-added">485         // Unreachable</span>
<span class="line-added">486         return null;</span>
<span class="line-added">487     }</span>
<span class="line-added">488 </span>
<span class="line-added">489     private static Map&lt;Scriptlet, List&lt;String&gt;&gt; getDebScriptlets(</span>
<span class="line-added">490             JPackageCommand cmd, Set&lt;Scriptlet&gt; scriptlets) {</span>
<span class="line-added">491         Map&lt;Scriptlet, List&lt;String&gt;&gt; result = new HashMap&lt;&gt;();</span>
<span class="line-added">492         TKit.withTempDirectory(&quot;dpkg-control-files&quot;, tempDir -&gt; {</span>
<span class="line-added">493             // Extract control Debian package files into temporary directory</span>
<span class="line-added">494             Executor.of(&quot;dpkg&quot;, &quot;-e&quot;)</span>
<span class="line-added">495                     .addArgument(cmd.outputBundle())</span>
<span class="line-added">496                     .addArgument(tempDir)</span>
<span class="line-added">497                     .execute();</span>
<span class="line-added">498 </span>
<span class="line-added">499             for (Scriptlet scriptlet : scriptlets) {</span>
<span class="line-added">500                 Path controlFile = Path.of(scriptlet.deb);</span>
<span class="line-added">501                 result.put(scriptlet, Files.readAllLines(tempDir.resolve(</span>
<span class="line-added">502                         controlFile)));</span>
<span class="line-added">503             }</span>
<span class="line-added">504         });</span>
<span class="line-added">505         return result;</span>
<span class="line-added">506     }</span>
<span class="line-added">507 </span>
<span class="line-added">508     private static Map&lt;Scriptlet, List&lt;String&gt;&gt; getRpmScriptlets(</span>
<span class="line-added">509             JPackageCommand cmd, Set&lt;Scriptlet&gt; scriptlets) {</span>
<span class="line-added">510         List&lt;String&gt; output = Executor.of(&quot;rpm&quot;, &quot;-qp&quot;, &quot;--scripts&quot;,</span>
<span class="line-added">511                 cmd.outputBundle().toString()).executeAndGetOutput();</span>
<span class="line-added">512 </span>
<span class="line-added">513         Map&lt;Scriptlet, List&lt;String&gt;&gt; result = new HashMap&lt;&gt;();</span>
<span class="line-added">514         List&lt;String&gt; curScriptletBody = null;</span>
<span class="line-added">515         for (String str : output) {</span>
<span class="line-added">516             Matcher m = Scriptlet.RPM_HEADER_PATTERN.matcher(str);</span>
<span class="line-added">517             if (m.find()) {</span>
<span class="line-added">518                 Scriptlet scriptlet = Scriptlet.RPM_MAP.get(m.group(1));</span>
<span class="line-added">519                 if (scriptlets.contains(scriptlet)) {</span>
<span class="line-added">520                     curScriptletBody = new ArrayList&lt;&gt;();</span>
<span class="line-added">521                     result.put(scriptlet, curScriptletBody);</span>
<span class="line-added">522                 } else if (curScriptletBody != null) {</span>
<span class="line-added">523                     curScriptletBody = null;</span>
<span class="line-added">524                 }</span>
<span class="line-added">525             } else if (curScriptletBody != null) {</span>
<span class="line-added">526                 curScriptletBody.add(str);</span>
<span class="line-added">527             }</span>
<span class="line-added">528         }</span>
<span class="line-added">529 </span>
<span class="line-added">530         return result;</span>
<span class="line-added">531     }</span>
<span class="line-added">532 </span>
<span class="line-added">533     private static enum Scriptlet {</span>
<span class="line-added">534         PostInstall(&quot;postinstall&quot;, &quot;postinst&quot;),</span>
<span class="line-added">535         PreUninstall(&quot;preuninstall&quot;, &quot;prerm&quot;);</span>
<span class="line-added">536 </span>
<span class="line-added">537         Scriptlet(String rpm, String deb) {</span>
<span class="line-added">538             this.rpm = rpm;</span>
<span class="line-added">539             this.deb = deb;</span>
<span class="line-added">540         }</span>
<span class="line-added">541 </span>
<span class="line-added">542         private final String rpm;</span>
<span class="line-added">543         private final String deb;</span>
<span class="line-added">544 </span>
<span class="line-added">545         static final Pattern RPM_HEADER_PATTERN = Pattern.compile(String.format(</span>
<span class="line-added">546                 &quot;(%s) scriptlet \\(using /bin/sh\\):&quot;, Stream.of(values()).map(</span>
<span class="line-added">547                         v -&gt; v.rpm).collect(Collectors.joining(&quot;|&quot;))));</span>
<span class="line-added">548 </span>
<span class="line-added">549         static final Map&lt;String, Scriptlet&gt; RPM_MAP = Stream.of(values()).collect(</span>
<span class="line-added">550                 Collectors.toMap(v -&gt; v.rpm, v -&gt; v));</span>
<span class="line-added">551     };</span>
<span class="line-added">552 </span>
553     public static String getDefaultPackageArch(PackageType type) {
554         if (archs == null) {
555             archs = new HashMap&lt;&gt;();
556         }
557 
558         String arch = archs.get(type);
559         if (arch == null) {
560             Executor exec = null;
561             switch (type) {
562                 case LINUX_DEB:
563                     exec = Executor.of(&quot;dpkg&quot;, &quot;--print-architecture&quot;);
564                     break;
565 
566                 case LINUX_RPM:
567                     exec = Executor.of(&quot;rpmbuild&quot;, &quot;--eval=%{_target_cpu}&quot;);
568                     break;
569             }
570             arch = exec.executeAndGetFirstLineOfOutput();
571             archs.put(type, arch);
572         }
573         return arch;
574     }
575 
576     static final Set&lt;Path&gt; CRITICAL_RUNTIME_FILES = Set.of(Path.of(
577             &quot;lib/server/libjvm.so&quot;));
578 
<span class="line-modified">579     private static Map&lt;PackageType, String&gt; archs;</span>
<span class="line-added">580 </span>
<span class="line-added">581     private final static Pattern XDG_CMD_ICON_SIZE_PATTERN = Pattern.compile(&quot;\\s--size\\s+(\\d+)\\b&quot;);</span>
<span class="line-added">582 </span>
<span class="line-added">583     // Values grabbed from https://linux.die.net/man/1/xdg-icon-resource</span>
<span class="line-added">584     private final static Set&lt;Integer&gt; XDG_CMD_VALID_ICON_SIZES = Set.of(16, 22, 32, 48, 64, 128);</span>
585 }
</pre>
</td>
</tr>
</table>
<center><a href="JPackageCommand.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="PackageTest.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>