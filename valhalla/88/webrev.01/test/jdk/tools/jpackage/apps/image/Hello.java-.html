<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Old test/jdk/tools/jpackage/apps/image/Hello.java</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
  </head>
  <body>
    <pre>
  1 /*
  2  * Copyright (c) 2018, 2019, Oracle and/or its affiliates. All rights reserved.
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 import java.awt.AWTError;
 25 import java.awt.Desktop;
 26 import java.awt.GraphicsEnvironment;
 27 import java.awt.desktop.OpenFilesEvent;
 28 import java.awt.desktop.OpenFilesHandler;
 29 import java.io.File;
 30 import java.io.IOException;
 31 import java.io.PrintWriter;
 32 import java.io.StringWriter;
 33 import java.nio.file.Path;
 34 import java.nio.file.Files;
 35 import java.util.stream.Collectors;
 36 import java.util.List;
 37 import java.util.ArrayList;
 38 import java.util.stream.Stream;
 39 import java.util.Collections;
 40 
 41 public class Hello implements OpenFilesHandler {
 42 
 43     public static void main(String[] args) throws IOException, InterruptedException {
 44         var faFiles = getFaFiles();
 45         if (faFiles != null) {
 46             // Some files got opened through fa mechanizm.
 47             // They are the arguments then.
 48             args = faFiles.toArray(String[]::new);
 49         }
 50 
 51         var lines = printArgs(args);
 52 
 53         lines.forEach(System.out::println);
 54 
 55         var outputFile = getOutputFile(args);
 56         trace(String.format(&quot;Output file: [%s]&quot;, outputFile));
 57         Files.write(outputFile, lines);
 58     }
 59 
 60     private static List&lt;String&gt; printArgs(String[] args) {
 61         List&lt;String&gt; lines = new ArrayList&lt;&gt;();
 62         lines.add(MSG);
 63 
 64         lines.add(&quot;args.length: &quot; + args.length);
 65 
 66         lines.addAll(List.of(args));
 67 
 68         for (int index = 1; index &lt;= EXPECTED_NUM_OF_PARAMS; index++) {
 69             String value = System.getProperty(&quot;param&quot; + index);
 70             if (value != null) {
 71                 lines.add(&quot;-Dparam&quot; + index + &quot;=&quot; + value);
 72             }
 73         }
 74 
 75         return lines;
 76     }
 77 
 78     private static Path getOutputFile(String[] args) {
 79         Path outputFilePath = Path.of(&quot;appOutput.txt&quot;);
 80 
 81         // If first arg is a file (most likely from fa), then put output in the same folder as
 82         // the file from fa.
 83         if (args.length &gt;= 1) {
 84             Path faPath = Path.of(args[0]);
 85             if (Files.exists(faPath)) {
 86                 return faPath.toAbsolutePath().getParent().resolve(outputFilePath);
 87             }
 88         }
 89 
 90         try {
 91             // Try writing in the default output file.
 92             Files.write(outputFilePath, Collections.emptyList());
 93             return outputFilePath;
 94         } catch (IOException ex) {
 95             // Log reason of a failure.
 96             StringWriter errors = new StringWriter();
 97             ex.printStackTrace(new PrintWriter(errors));
 98             Stream.of(errors.toString().split(&quot;\\R&quot;)).forEachOrdered(Hello::trace);
 99         }
100 
101         return Path.of(System.getProperty(&quot;user.home&quot;)).resolve(outputFilePath);
102     }
103 
104     @Override
105     public void openFiles(OpenFilesEvent e) {
106         synchronized(lock) {
107             trace(&quot;openFiles&quot;);
108             files = e.getFiles().stream()
109                 .map(File::toString)
110                 .collect(Collectors.toList());
111 
112             lock.notifyAll();
113         }
114     }
115 
116     private static List&lt;String&gt; getFaFiles() throws InterruptedException {
117         if (openFilesHandler == null) {
118             return null;
119         }
120 
121         synchronized(openFilesHandler.lock) {
122             trace(&quot;getFaFiles: wait&quot;);
123             openFilesHandler.lock.wait(1000);
124             if (openFilesHandler.files == null) {
125                 trace(String.format(&quot;getFaFiles: no files&quot;));
126                 return null;
127             }
128             // Return copy of `files` to keep access to `files` field synchronized.
129             trace(String.format(&quot;getFaFiles: file count %d&quot;,
130                     openFilesHandler.files.size()));
131             return new ArrayList&lt;&gt;(openFilesHandler.files);
132         }
133     }
134 
135     private List&lt;String&gt; files;
136     private final Object lock = new Object();
137     private final static Hello openFilesHandler = createInstance();
138 
139     private static Hello createInstance() {
140         if (GraphicsEnvironment.isHeadless()) {
141             return null;
142         }
143 
144         trace(&quot;Environment supports a display&quot;);
145 
146         try {
147             // Disable JAB.
148             // Needed to suppress error:
149             // Exception in thread &quot;main&quot; java.awt.AWTError: Assistive Technology not found: com.sun.java.accessibility.AccessBridge
150             System.setProperty(&quot;javax.accessibility.assistive_technologies&quot;, &quot;&quot;);
151         } catch (SecurityException ex) {
152             ex.printStackTrace();
153         }
154 
155         try {
156             var desktop = Desktop.getDesktop();
157             if (desktop.isSupported(Desktop.Action.APP_OPEN_FILE)) {
158                 trace(&quot;Set file handler&quot;);
159                 Hello instance = new Hello();
160                 desktop.setOpenFileHandler(instance);
161                 return instance;
162             }
163         } catch (AWTError ex) {
164             trace(&quot;Set file handler failed&quot;);
165             ex.printStackTrace();
166         }
167 
168         return null;
169     }
170 
171     private static final String MSG = &quot;jpackage test application&quot;;
172     private static final int EXPECTED_NUM_OF_PARAMS = 3; // Starts at 1
173 
174     private static void trace(String msg) {
175         System.out.println(&quot;hello: &quot; + msg);
176     }
177 }
    </pre>
  </body>
</html>