<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff test/jdk/tools/jpackage/share/jdk/jpackage/tests/BasicTest.java</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="../../../EmptyFolderPackageTest.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="../../../../../../../langtools/jdk/javadoc/doclet/testWarnings/TestWarnings.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>test/jdk/tools/jpackage/share/jdk/jpackage/tests/BasicTest.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
210         }
211         cmd.executeAndAssertHelloAppImageCreated();
212     }
213 
214     @Test
215     public void testWhitespaceInPaths() {
216         JPackageCommand.helloAppImage(&quot;a/b c.jar:Hello&quot;)
217         .setArgumentValue(&quot;--input&quot;, TKit.workDir().resolve(&quot;The quick brown fox&quot;))
218         .setArgumentValue(&quot;--dest&quot;, TKit.workDir().resolve(&quot;jumps over the lazy dog&quot;))
219         .executeAndAssertHelloAppImageCreated();
220     }
221 
222     @Test
223     @Parameter(&quot;ALL-MODULE-PATH&quot;)
224     @Parameter(&quot;ALL-DEFAULT&quot;)
225     @Parameter(&quot;java.desktop&quot;)
226     @Parameter(&quot;java.desktop,jdk.jartool&quot;)
227     @Parameter({ &quot;java.desktop&quot;, &quot;jdk.jartool&quot; })
228     public void testAddModules(String... addModulesArg) {
229         JPackageCommand cmd = JPackageCommand
<span class="line-modified">230                 .helloAppImage(&quot;goodbye.jar:com.other/com.other.Hello&quot;);</span>

231         Stream.of(addModulesArg).map(v -&gt; Stream.of(&quot;--add-modules&quot;, v)).flatMap(
232                 s -&gt; s).forEachOrdered(cmd::addArgument);
233         cmd.executeAndAssertHelloAppImageCreated();
234     }
235 
236     /**
237      * Test --temp option. Doesn&#39;t make much sense for app image as temporary
238      * directory is used only on Windows. Test it in packaging mode.
239      * @throws IOException
240      */
241     @Test
242     public void testTemp() throws IOException {
243         final Path tempRoot = TKit.createTempDirectory(&quot;temp-root&quot;);
244 
245         Function&lt;JPackageCommand, Path&gt; getTempDir = cmd -&gt; {
246             return tempRoot.resolve(cmd.outputBundle().getFileName());
247         };
248 
249         Supplier&lt;PackageTest&gt; createTest = () -&gt; {
250             return new PackageTest()
</pre>
<hr />
<pre>
253             .addInitializer(JPackageCommand::setDefaultInputOutput)
254             .addInitializer(cmd -&gt; {
255                 Path tempDir = getTempDir.apply(cmd);
256                 Files.createDirectories(tempDir);
257                 cmd.addArguments(&quot;--temp&quot;, tempDir);
258             });
259         };
260 
261         createTest.get()
262         .addBundleVerifier(cmd -&gt; {
263             // Check jpackage actually used the supplied directory.
264             Path tempDir = getTempDir.apply(cmd);
265             TKit.assertNotEquals(0, tempDir.toFile().list().length,
266                     String.format(
267                             &quot;Check jpackage wrote some data in the supplied temporary directory [%s]&quot;,
268                             tempDir));
269         })
270         .run(PackageTest.Action.CREATE);
271 
272         createTest.get()
<span class="line-removed">273         .addInitializer(cmd -&gt; {</span>
<span class="line-removed">274             // Clean output from the previus jpackage run.</span>
<span class="line-removed">275             Files.delete(cmd.outputBundle());</span>
<span class="line-removed">276         })</span>
277         // Temporary directory should not be empty,
278         // jpackage should exit with error.
279         .setExpectedExitCode(1)
280         .run(PackageTest.Action.CREATE);
281     }
282 
283     @Test
284     public void testAtFile() throws IOException {
285         JPackageCommand cmd = JPackageCommand
286                 .helloAppImage()
287                 .setArgumentValue(&quot;--dest&quot;, TKit.createTempDirectory(&quot;output&quot;));
288 
289         // Init options file with the list of options configured
290         // for JPackageCommand instance.
291         final Path optionsFile = TKit.createTempFile(Path.of(&quot;options&quot;));
292         Files.write(optionsFile,
293                 List.of(String.join(&quot; &quot;, cmd.getAllArguments())));
294 
295         // Build app jar file.
296         cmd.executePrerequisiteActions();
</pre>
<hr />
<pre>
321             cmd.executePrerequisiteActions();
322         }
323 
324         final Path runtimeDir = TKit.createTempDirectory(&quot;runtime&quot;).resolve(&quot;data&quot;);
325 
326         // List of modules required for test app.
327         final var modules = new String[] {
328             &quot;java.base&quot;,
329             &quot;java.desktop&quot;
330         };
331 
332         Executor jlink = getToolProvider(JavaTool.JLINK)
333         .saveOutput(false)
334         .addArguments(
335                 &quot;--add-modules&quot;, String.join(&quot;,&quot;, modules),
336                 &quot;--output&quot;, runtimeDir.toString(),
337                 &quot;--strip-debug&quot;,
338                 &quot;--no-header-files&quot;,
339                 &quot;--no-man-pages&quot;);
340 









341         if (moduleName != null) {
342             jlink.addArguments(&quot;--add-modules&quot;, moduleName, &quot;--module-path&quot;,
343                     Path.of(cmd.getArgumentValue(&quot;--module-path&quot;)).resolve(
344                             &quot;hello.jar&quot;).toString());
345         }
346 
347         jlink.execute();
348 
349         cmd.addArguments(&quot;--runtime-image&quot;, runtimeDir);
350         cmd.executeAndAssertHelloAppImageCreated();
351     }
352 
353     private static Executor getJPackageToolProvider() {
354         return getToolProvider(JavaTool.JPACKAGE);
355     }
356 
357     private static Executor getToolProvider(JavaTool tool) {
358         return new Executor().dumpOutput().saveOutput().setToolProvider(tool);
359     }
360 }
</pre>
</td>
<td>
<hr />
<pre>
210         }
211         cmd.executeAndAssertHelloAppImageCreated();
212     }
213 
214     @Test
215     public void testWhitespaceInPaths() {
216         JPackageCommand.helloAppImage(&quot;a/b c.jar:Hello&quot;)
217         .setArgumentValue(&quot;--input&quot;, TKit.workDir().resolve(&quot;The quick brown fox&quot;))
218         .setArgumentValue(&quot;--dest&quot;, TKit.workDir().resolve(&quot;jumps over the lazy dog&quot;))
219         .executeAndAssertHelloAppImageCreated();
220     }
221 
222     @Test
223     @Parameter(&quot;ALL-MODULE-PATH&quot;)
224     @Parameter(&quot;ALL-DEFAULT&quot;)
225     @Parameter(&quot;java.desktop&quot;)
226     @Parameter(&quot;java.desktop,jdk.jartool&quot;)
227     @Parameter({ &quot;java.desktop&quot;, &quot;jdk.jartool&quot; })
228     public void testAddModules(String... addModulesArg) {
229         JPackageCommand cmd = JPackageCommand
<span class="line-modified">230                 .helloAppImage(&quot;goodbye.jar:com.other/com.other.Hello&quot;)</span>
<span class="line-added">231                 .ignoreDefaultRuntime(true); // because of --add-modules</span>
232         Stream.of(addModulesArg).map(v -&gt; Stream.of(&quot;--add-modules&quot;, v)).flatMap(
233                 s -&gt; s).forEachOrdered(cmd::addArgument);
234         cmd.executeAndAssertHelloAppImageCreated();
235     }
236 
237     /**
238      * Test --temp option. Doesn&#39;t make much sense for app image as temporary
239      * directory is used only on Windows. Test it in packaging mode.
240      * @throws IOException
241      */
242     @Test
243     public void testTemp() throws IOException {
244         final Path tempRoot = TKit.createTempDirectory(&quot;temp-root&quot;);
245 
246         Function&lt;JPackageCommand, Path&gt; getTempDir = cmd -&gt; {
247             return tempRoot.resolve(cmd.outputBundle().getFileName());
248         };
249 
250         Supplier&lt;PackageTest&gt; createTest = () -&gt; {
251             return new PackageTest()
</pre>
<hr />
<pre>
254             .addInitializer(JPackageCommand::setDefaultInputOutput)
255             .addInitializer(cmd -&gt; {
256                 Path tempDir = getTempDir.apply(cmd);
257                 Files.createDirectories(tempDir);
258                 cmd.addArguments(&quot;--temp&quot;, tempDir);
259             });
260         };
261 
262         createTest.get()
263         .addBundleVerifier(cmd -&gt; {
264             // Check jpackage actually used the supplied directory.
265             Path tempDir = getTempDir.apply(cmd);
266             TKit.assertNotEquals(0, tempDir.toFile().list().length,
267                     String.format(
268                             &quot;Check jpackage wrote some data in the supplied temporary directory [%s]&quot;,
269                             tempDir));
270         })
271         .run(PackageTest.Action.CREATE);
272 
273         createTest.get()




274         // Temporary directory should not be empty,
275         // jpackage should exit with error.
276         .setExpectedExitCode(1)
277         .run(PackageTest.Action.CREATE);
278     }
279 
280     @Test
281     public void testAtFile() throws IOException {
282         JPackageCommand cmd = JPackageCommand
283                 .helloAppImage()
284                 .setArgumentValue(&quot;--dest&quot;, TKit.createTempDirectory(&quot;output&quot;));
285 
286         // Init options file with the list of options configured
287         // for JPackageCommand instance.
288         final Path optionsFile = TKit.createTempFile(Path.of(&quot;options&quot;));
289         Files.write(optionsFile,
290                 List.of(String.join(&quot; &quot;, cmd.getAllArguments())));
291 
292         // Build app jar file.
293         cmd.executePrerequisiteActions();
</pre>
<hr />
<pre>
318             cmd.executePrerequisiteActions();
319         }
320 
321         final Path runtimeDir = TKit.createTempDirectory(&quot;runtime&quot;).resolve(&quot;data&quot;);
322 
323         // List of modules required for test app.
324         final var modules = new String[] {
325             &quot;java.base&quot;,
326             &quot;java.desktop&quot;
327         };
328 
329         Executor jlink = getToolProvider(JavaTool.JLINK)
330         .saveOutput(false)
331         .addArguments(
332                 &quot;--add-modules&quot;, String.join(&quot;,&quot;, modules),
333                 &quot;--output&quot;, runtimeDir.toString(),
334                 &quot;--strip-debug&quot;,
335                 &quot;--no-header-files&quot;,
336                 &quot;--no-man-pages&quot;);
337 
<span class="line-added">338         TKit.trace(&quot;jlink output BEGIN&quot;);</span>
<span class="line-added">339         try (Stream&lt;Path&gt; paths = Files.walk(runtimeDir)) {</span>
<span class="line-added">340             paths.filter(Files::isRegularFile)</span>
<span class="line-added">341                     .map(runtimeDir::relativize)</span>
<span class="line-added">342                     .map(Path::toString)</span>
<span class="line-added">343                     .forEach(TKit::trace);</span>
<span class="line-added">344         }</span>
<span class="line-added">345         TKit.trace(&quot;jlink output END&quot;);</span>
<span class="line-added">346 </span>
347         if (moduleName != null) {
348             jlink.addArguments(&quot;--add-modules&quot;, moduleName, &quot;--module-path&quot;,
349                     Path.of(cmd.getArgumentValue(&quot;--module-path&quot;)).resolve(
350                             &quot;hello.jar&quot;).toString());
351         }
352 
353         jlink.execute();
354 
355         cmd.addArguments(&quot;--runtime-image&quot;, runtimeDir);
356         cmd.executeAndAssertHelloAppImageCreated();
357     }
358 
359     private static Executor getJPackageToolProvider() {
360         return getToolProvider(JavaTool.JPACKAGE);
361     }
362 
363     private static Executor getToolProvider(JavaTool tool) {
364         return new Executor().dumpOutput().saveOutput().setToolProvider(tool);
365     }
366 }
</pre>
</td>
</tr>
</table>
<center><a href="../../../EmptyFolderPackageTest.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="../../../../../../../langtools/jdk/javadoc/doclet/testWarnings/TestWarnings.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>