<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>New test/jdk/java/util/zip/ZipFile/ZipEntryTimeBounds.java</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
  </head>
  <body>
    <pre>
  1 /*
  2  * Copyright (c) 2020, Oracle and/or its affiliates. All rights reserved.
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 import org.testng.annotations.Test;
 25 
 26 import java.io.File;
 27 import java.io.FileOutputStream;
 28 import java.io.IOException;
 29 import java.nio.file.Files;
 30 import java.util.Calendar;
 31 import java.util.GregorianCalendar;
 32 import java.util.TimeZone;
 33 import java.util.zip.ZipEntry;
 34 import java.util.zip.ZipFile;
 35 import java.util.zip.ZipOutputStream;
 36 
 37 import static org.testng.Assert.*;
 38 
 39 /* @test
 40  * @bug 8246129
 41  * @summary JDK add metadata to zip files with entries timestamped at the
 42  *          lower bound of the DOS time epoch, i.e., 1980-01-01T00:00:00Z
 43  * @run testng/othervm ZipEntryTimeBounds
 44  */
 45 public class ZipEntryTimeBounds {
 46 
 47     @Test
 48     public void testFilesWithEntryAtLowerTimeBoundAreEqual() throws Exception {
 49 
 50         // Ensure that entries that end up being exactly at the start of the
 51         // DOS epoch, java.util.zip.ZipEntry.DOSTIME_BEFORE_1980, or
 52         // 1980-01-01 00:00:00 are written without any extra timestamp metadata
 53         // being written
 54 
 55         TimeZone.setDefault(TimeZone.getTimeZone(&quot;GMT-01&quot;));
 56         File f1 = createTempFile();
 57         makeZip(f1, new GregorianCalendar(1980, Calendar.JANUARY, 1, 0, 0, 0).getTimeInMillis());
 58 
 59         TimeZone.setDefault(TimeZone.getTimeZone(&quot;GMT&quot;));
 60         File f2 = createTempFile();
 61         makeZip(f2, new GregorianCalendar(1980, Calendar.JANUARY, 1, 0, 0, 0).getTimeInMillis());
 62         assertEquals(Files.mismatch(f1.toPath(), f2.toPath()), -1L);
 63 
 64         TimeZone.setDefault(TimeZone.getTimeZone(&quot;GMT+01&quot;));
 65         File f3 = createTempFile();
 66         makeZip(f3, new GregorianCalendar(1980, Calendar.JANUARY, 1, 0, 0, 0).getTimeInMillis());
 67         assertEquals(Files.mismatch(f1.toPath(), f3.toPath()), -1L);
 68 
 69         // Check that the milliseconds part of the time is exactly preserved
 70         assertEquals(new ZipFile(f1).getEntry(&quot;entry.txt&quot;).getTime() % 60000, 0);
 71         assertEquals(new ZipFile(f2).getEntry(&quot;entry.txt&quot;).getTime() % 60000, 0);
 72         assertEquals(new ZipFile(f3).getEntry(&quot;entry.txt&quot;).getTime() % 60000, 0);
 73     }
 74 
 75     @Test
 76     public void testFilesWithEntryAfterLowerTimeBoundAreEqual() throws Exception {
 77         // Ensure files written using different timezone with entries set
 78         // shortly after 1980-01-01 00:00:00 produce exactly identical files
 79         // without metadata
 80 
 81         TimeZone.setDefault(TimeZone.getTimeZone(&quot;GMT-01&quot;));
 82         File f1 = createTempFile();
 83         makeZip(f1, new GregorianCalendar(1980, Calendar.JANUARY, 1, 0, 0, 1).getTimeInMillis());
 84 
 85         TimeZone.setDefault(TimeZone.getTimeZone(&quot;GMT&quot;));
 86         File f2 = createTempFile();
 87         makeZip(f2, new GregorianCalendar(1980, Calendar.JANUARY, 1, 0, 0, 1).getTimeInMillis());
 88         assertEquals(Files.mismatch(f1.toPath(), f2.toPath()), -1L);
 89 
 90         TimeZone.setDefault(TimeZone.getTimeZone(&quot;GMT+01&quot;));
 91         File f3 = createTempFile();
 92         makeZip(f3, new GregorianCalendar(1980, Calendar.JANUARY, 1, 0, 0, 1).getTimeInMillis() + 999);
 93         assertEquals(Files.mismatch(f1.toPath(), f3.toPath()), -1L);
 94 
 95         // Check that the seconds part of the time is lossily preserved,
 96         // rounding down to the previous 2s step since epoch
 97         assertEquals(new ZipFile(f1).getEntry(&quot;entry.txt&quot;).getTime() % 60000, 0);
 98         assertEquals(new ZipFile(f2).getEntry(&quot;entry.txt&quot;).getTime() % 60000, 0);
 99         assertEquals(new ZipFile(f3).getEntry(&quot;entry.txt&quot;).getTime() % 60000, 0);
100 
101         File f4 = createTempFile();
102         makeZip(f4, new GregorianCalendar(1980, Calendar.JANUARY, 1, 0, 0, 2).getTimeInMillis());
103         assertEquals(new ZipFile(f4).getEntry(&quot;entry.txt&quot;).getTime() % 60000, 2000);
104     }
105 
106     @Test
107     public void testFilesWithEntryBeforeLowerTimeBoundAreNotEqual() throws Exception {
108         // Files written using different timezone with entries set shortly
109         // before 1980-01-01 00:00:00 will produce files which add timestamp
110         // metadata that make the files turn up not equal
111 
112         TimeZone.setDefault(TimeZone.getTimeZone(&quot;GMT-01&quot;));
113         File f1 = createTempFile();
114         makeZip(f1, new GregorianCalendar(1979, Calendar.DECEMBER, 31, 23, 59, 59).getTimeInMillis());
115 
116         TimeZone.setDefault(TimeZone.getTimeZone(&quot;GMT&quot;));
117         File f2 = createTempFile();
118         makeZip(f2, new GregorianCalendar(1979, Calendar.DECEMBER, 31, 23, 59, 59).getTimeInMillis());
119         assertNotEquals(Files.mismatch(f1.toPath(), f2.toPath()), -1L);
120 
121         TimeZone.setDefault(TimeZone.getTimeZone(&quot;GMT+01&quot;));
122         File f3 = createTempFile();
123         makeZip(f3, new GregorianCalendar(1979, Calendar.DECEMBER, 31, 23, 59, 59).getTimeInMillis() + 500);
124         assertNotEquals(Files.mismatch(f1.toPath(), f3.toPath()), -1L);
125 
126         // Check that the time is preserved at second precision, no rounding
127         // to 2s
128         assertEquals(new ZipFile(f1).getEntry(&quot;entry.txt&quot;).getTime() % 60000, 59000);
129         assertEquals(new ZipFile(f2).getEntry(&quot;entry.txt&quot;).getTime() % 60000, 59000);
130         // Milliseconds are discarded even when storing entries with extended
131         // time metadata
132         assertEquals(new ZipFile(f3).getEntry(&quot;entry.txt&quot;).getTime() % 60000, 59000);
133     }
134 
135     private static void makeZip(File f, long time) throws Exception {
136         try (ZipOutputStream out = new ZipOutputStream(new FileOutputStream(f))) {
137             ZipEntry e = new ZipEntry(&quot;entry.txt&quot;);
138             e.setTime(time);
139             out.putNextEntry(e);
140             out.write(new byte[] { 0, 1, 2, 3 });
141             out.closeEntry();
142         }
143     }
144 
145     private static File createTempFile() throws IOException {
146         File file = File.createTempFile(&quot;out&quot;, &quot;zip&quot;);
147         file.deleteOnExit();
148         return file;
149     }
150 }
    </pre>
  </body>
</html>