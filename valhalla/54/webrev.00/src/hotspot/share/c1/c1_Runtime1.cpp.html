<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>New src/hotspot/share/c1/c1_Runtime1.cpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
  </head>
  <body>
    <pre>
   1 /*
   2  * Copyright (c) 1999, 2020, Oracle and/or its affiliates. All rights reserved.
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.
   8  *
   9  * This code is distributed in the hope that it will be useful, but WITHOUT
  10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  *
  23  */
  24 
  25 #include &quot;precompiled.hpp&quot;
  26 #include &quot;asm/codeBuffer.hpp&quot;
  27 #include &quot;c1/c1_CodeStubs.hpp&quot;
  28 #include &quot;c1/c1_Defs.hpp&quot;
  29 #include &quot;c1/c1_FrameMap.hpp&quot;
  30 #include &quot;c1/c1_LIRAssembler.hpp&quot;
  31 #include &quot;c1/c1_MacroAssembler.hpp&quot;
  32 #include &quot;c1/c1_Runtime1.hpp&quot;
  33 #include &quot;classfile/systemDictionary.hpp&quot;
  34 #include &quot;classfile/vmSymbols.hpp&quot;
  35 #include &quot;code/codeBlob.hpp&quot;
  36 #include &quot;code/compiledIC.hpp&quot;
  37 #include &quot;code/pcDesc.hpp&quot;
  38 #include &quot;code/scopeDesc.hpp&quot;
  39 #include &quot;code/vtableStubs.hpp&quot;
  40 #include &quot;compiler/compilationPolicy.hpp&quot;
  41 #include &quot;compiler/disassembler.hpp&quot;
  42 #include &quot;gc/shared/barrierSet.hpp&quot;
  43 #include &quot;gc/shared/c1/barrierSetC1.hpp&quot;
  44 #include &quot;gc/shared/collectedHeap.hpp&quot;
  45 #include &quot;interpreter/bytecode.hpp&quot;
  46 #include &quot;interpreter/interpreter.hpp&quot;
  47 #include &quot;jfr/support/jfrIntrinsics.hpp&quot;
  48 #include &quot;logging/log.hpp&quot;
  49 #include &quot;memory/allocation.inline.hpp&quot;
  50 #include &quot;memory/oopFactory.hpp&quot;
  51 #include &quot;memory/resourceArea.hpp&quot;
  52 #include &quot;memory/universe.hpp&quot;
  53 #include &quot;oops/access.inline.hpp&quot;
  54 #include &quot;oops/objArrayOop.inline.hpp&quot;
  55 #include &quot;oops/objArrayKlass.hpp&quot;
  56 #include &quot;oops/oop.inline.hpp&quot;
  57 #include &quot;oops/valueArrayKlass.hpp&quot;
  58 #include &quot;oops/valueArrayOop.inline.hpp&quot;
  59 #include &quot;runtime/atomic.hpp&quot;
  60 #include &quot;runtime/biasedLocking.hpp&quot;
  61 #include &quot;runtime/fieldDescriptor.inline.hpp&quot;
  62 #include &quot;runtime/frame.inline.hpp&quot;
  63 #include &quot;runtime/handles.inline.hpp&quot;
  64 #include &quot;runtime/interfaceSupport.inline.hpp&quot;
  65 #include &quot;runtime/javaCalls.hpp&quot;
  66 #include &quot;runtime/sharedRuntime.hpp&quot;
  67 #include &quot;runtime/threadCritical.hpp&quot;
  68 #include &quot;runtime/vframe.inline.hpp&quot;
  69 #include &quot;runtime/vframeArray.hpp&quot;
  70 #include &quot;runtime/vm_version.hpp&quot;
  71 #include &quot;utilities/copy.hpp&quot;
  72 #include &quot;utilities/events.hpp&quot;
  73 
  74 
  75 // Implementation of StubAssembler
  76 
  77 StubAssembler::StubAssembler(CodeBuffer* code, const char * name, int stub_id) : C1_MacroAssembler(code) {
  78   _name = name;
  79   _must_gc_arguments = false;
  80   _frame_size = no_frame_size;
  81   _num_rt_args = 0;
  82   _stub_id = stub_id;
  83 }
  84 
  85 
  86 void StubAssembler::set_info(const char* name, bool must_gc_arguments) {
  87   _name = name;
  88   _must_gc_arguments = must_gc_arguments;
  89 }
  90 
  91 
  92 void StubAssembler::set_frame_size(int size) {
  93   if (_frame_size == no_frame_size) {
  94     _frame_size = size;
  95   }
  96   assert(_frame_size == size, &quot;can&#39;t change the frame size&quot;);
  97 }
  98 
  99 
 100 void StubAssembler::set_num_rt_args(int args) {
 101   if (_num_rt_args == 0) {
 102     _num_rt_args = args;
 103   }
 104   assert(_num_rt_args == args, &quot;can&#39;t change the number of args&quot;);
 105 }
 106 
 107 // Implementation of Runtime1
 108 
 109 CodeBlob* Runtime1::_blobs[Runtime1::number_of_ids];
 110 const char *Runtime1::_blob_names[] = {
 111   RUNTIME1_STUBS(STUB_NAME, LAST_STUB_NAME)
 112 };
 113 
 114 #ifndef PRODUCT
 115 // statistics
 116 int Runtime1::_generic_arraycopy_cnt = 0;
 117 int Runtime1::_generic_arraycopystub_cnt = 0;
 118 int Runtime1::_arraycopy_slowcase_cnt = 0;
 119 int Runtime1::_arraycopy_checkcast_cnt = 0;
 120 int Runtime1::_arraycopy_checkcast_attempt_cnt = 0;
 121 int Runtime1::_new_type_array_slowcase_cnt = 0;
 122 int Runtime1::_new_object_array_slowcase_cnt = 0;
 123 int Runtime1::_new_value_array_slowcase_cnt = 0;
 124 int Runtime1::_new_instance_slowcase_cnt = 0;
 125 int Runtime1::_new_multi_array_slowcase_cnt = 0;
 126 int Runtime1::_load_flattened_array_slowcase_cnt = 0;
 127 int Runtime1::_store_flattened_array_slowcase_cnt = 0;
 128 int Runtime1::_substitutability_check_slowcase_cnt = 0;
 129 int Runtime1::_buffer_value_args_slowcase_cnt = 0;
 130 int Runtime1::_buffer_value_args_no_receiver_slowcase_cnt = 0;
 131 int Runtime1::_monitorenter_slowcase_cnt = 0;
 132 int Runtime1::_monitorexit_slowcase_cnt = 0;
 133 int Runtime1::_patch_code_slowcase_cnt = 0;
 134 int Runtime1::_throw_range_check_exception_count = 0;
 135 int Runtime1::_throw_index_exception_count = 0;
 136 int Runtime1::_throw_div0_exception_count = 0;
 137 int Runtime1::_throw_null_pointer_exception_count = 0;
 138 int Runtime1::_throw_class_cast_exception_count = 0;
 139 int Runtime1::_throw_incompatible_class_change_error_count = 0;
 140 int Runtime1::_throw_illegal_monitor_state_exception_count = 0;
 141 int Runtime1::_throw_array_store_exception_count = 0;
 142 int Runtime1::_throw_count = 0;
 143 
 144 static int _byte_arraycopy_stub_cnt = 0;
 145 static int _short_arraycopy_stub_cnt = 0;
 146 static int _int_arraycopy_stub_cnt = 0;
 147 static int _long_arraycopy_stub_cnt = 0;
 148 static int _oop_arraycopy_stub_cnt = 0;
 149 
 150 address Runtime1::arraycopy_count_address(BasicType type) {
 151   switch (type) {
 152   case T_BOOLEAN:
 153   case T_BYTE:   return (address)&amp;_byte_arraycopy_stub_cnt;
 154   case T_CHAR:
 155   case T_SHORT:  return (address)&amp;_short_arraycopy_stub_cnt;
 156   case T_FLOAT:
 157   case T_INT:    return (address)&amp;_int_arraycopy_stub_cnt;
 158   case T_DOUBLE:
 159   case T_LONG:   return (address)&amp;_long_arraycopy_stub_cnt;
 160   case T_ARRAY:
 161   case T_OBJECT: return (address)&amp;_oop_arraycopy_stub_cnt;
 162   default:
 163     ShouldNotReachHere();
 164     return NULL;
 165   }
 166 }
 167 
 168 
 169 #endif
 170 
 171 // Simple helper to see if the caller of a runtime stub which
 172 // entered the VM has been deoptimized
 173 
 174 static bool caller_is_deopted() {
 175   JavaThread* thread = JavaThread::current();
 176   RegisterMap reg_map(thread, false);
 177   frame runtime_frame = thread-&gt;last_frame();
 178   frame caller_frame = runtime_frame.sender(&amp;reg_map);
 179   assert(caller_frame.is_compiled_frame(), &quot;must be compiled&quot;);
 180   return caller_frame.is_deoptimized_frame();
 181 }
 182 
 183 // Stress deoptimization
 184 static void deopt_caller() {
 185   if ( !caller_is_deopted()) {
 186     JavaThread* thread = JavaThread::current();
 187     RegisterMap reg_map(thread, false);
 188     frame runtime_frame = thread-&gt;last_frame();
 189     frame caller_frame = runtime_frame.sender(&amp;reg_map);
 190     Deoptimization::deoptimize_frame(thread, caller_frame.id());
 191     assert(caller_is_deopted(), &quot;Must be deoptimized&quot;);
 192   }
 193 }
 194 
 195 class StubIDStubAssemblerCodeGenClosure: public StubAssemblerCodeGenClosure {
 196  private:
 197   Runtime1::StubID _id;
 198  public:
 199   StubIDStubAssemblerCodeGenClosure(Runtime1::StubID id) : _id(id) {}
 200   virtual OopMapSet* generate_code(StubAssembler* sasm) {
 201     return Runtime1::generate_code_for(_id, sasm);
 202   }
 203 };
 204 
 205 CodeBlob* Runtime1::generate_blob(BufferBlob* buffer_blob, int stub_id, const char* name, bool expect_oop_map, StubAssemblerCodeGenClosure* cl) {
 206   ResourceMark rm;
 207   // create code buffer for code storage
 208   CodeBuffer code(buffer_blob);
 209 
 210   OopMapSet* oop_maps;
 211   int frame_size;
 212   bool must_gc_arguments;
 213 
 214   Compilation::setup_code_buffer(&amp;code, 0);
 215 
 216   // create assembler for code generation
 217   StubAssembler* sasm = new StubAssembler(&amp;code, name, stub_id);
 218   // generate code for runtime stub
 219   oop_maps = cl-&gt;generate_code(sasm);
 220   assert(oop_maps == NULL || sasm-&gt;frame_size() != no_frame_size,
 221          &quot;if stub has an oop map it must have a valid frame size&quot;);
 222   assert(!expect_oop_map || oop_maps != NULL, &quot;must have an oopmap&quot;);
 223 
 224   // align so printing shows nop&#39;s instead of random code at the end (SimpleStubs are aligned)
 225   sasm-&gt;align(BytesPerWord);
 226   // make sure all code is in code buffer
 227   sasm-&gt;flush();
 228 
 229   frame_size = sasm-&gt;frame_size();
 230   must_gc_arguments = sasm-&gt;must_gc_arguments();
 231   // create blob - distinguish a few special cases
 232   CodeBlob* blob = RuntimeStub::new_runtime_stub(name,
 233                                                  &amp;code,
 234                                                  CodeOffsets::frame_never_safe,
 235                                                  frame_size,
 236                                                  oop_maps,
 237                                                  must_gc_arguments);
 238   assert(blob != NULL, &quot;blob must exist&quot;);
 239   return blob;
 240 }
 241 
 242 void Runtime1::generate_blob_for(BufferBlob* buffer_blob, StubID id) {
 243   assert(0 &lt;= id &amp;&amp; id &lt; number_of_ids, &quot;illegal stub id&quot;);
 244   bool expect_oop_map = true;
 245 #ifdef ASSERT
 246   // Make sure that stubs that need oopmaps have them
 247   switch (id) {
 248     // These stubs don&#39;t need to have an oopmap
 249   case dtrace_object_alloc_id:
 250   case slow_subtype_check_id:
 251   case fpu2long_stub_id:
 252   case unwind_exception_id:
 253   case counter_overflow_id:
 254 #if defined(SPARC) || defined(PPC32)
 255   case handle_exception_nofpu_id:  // Unused on sparc
 256 #endif
 257     expect_oop_map = false;
 258     break;
 259   default:
 260     break;
 261   }
 262 #endif
 263   StubIDStubAssemblerCodeGenClosure cl(id);
 264   CodeBlob* blob = generate_blob(buffer_blob, id, name_for(id), expect_oop_map, &amp;cl);
 265   // install blob
 266   _blobs[id] = blob;
 267 }
 268 
 269 void Runtime1::initialize(BufferBlob* blob) {
 270   // platform-dependent initialization
 271   initialize_pd();
 272   // generate stubs
 273   for (int id = 0; id &lt; number_of_ids; id++) generate_blob_for(blob, (StubID)id);
 274   // printing
 275 #ifndef PRODUCT
 276   if (PrintSimpleStubs) {
 277     ResourceMark rm;
 278     for (int id = 0; id &lt; number_of_ids; id++) {
 279       _blobs[id]-&gt;print();
 280       if (_blobs[id]-&gt;oop_maps() != NULL) {
 281         _blobs[id]-&gt;oop_maps()-&gt;print();
 282       }
 283     }
 284   }
 285 #endif
 286   BarrierSetC1* bs = BarrierSet::barrier_set()-&gt;barrier_set_c1();
 287   bs-&gt;generate_c1_runtime_stubs(blob);
 288 }
 289 
 290 CodeBlob* Runtime1::blob_for(StubID id) {
 291   assert(0 &lt;= id &amp;&amp; id &lt; number_of_ids, &quot;illegal stub id&quot;);
 292   return _blobs[id];
 293 }
 294 
 295 
 296 const char* Runtime1::name_for(StubID id) {
 297   assert(0 &lt;= id &amp;&amp; id &lt; number_of_ids, &quot;illegal stub id&quot;);
 298   return _blob_names[id];
 299 }
 300 
 301 const char* Runtime1::name_for_address(address entry) {
 302   for (int id = 0; id &lt; number_of_ids; id++) {
 303     if (entry == entry_for((StubID)id)) return name_for((StubID)id);
 304   }
 305 
 306   BarrierSetC1* bsc1 = BarrierSet::barrier_set()-&gt;barrier_set_c1();
 307   const char* name = bsc1-&gt;rtcall_name_for_address(entry);
 308   if (name != NULL) {
 309     return name;
 310   }
 311 
 312 #define FUNCTION_CASE(a, f) \
 313   if ((intptr_t)a == CAST_FROM_FN_PTR(intptr_t, f))  return #f
 314 
 315   FUNCTION_CASE(entry, os::javaTimeMillis);
 316   FUNCTION_CASE(entry, os::javaTimeNanos);
 317   FUNCTION_CASE(entry, SharedRuntime::OSR_migration_end);
 318   FUNCTION_CASE(entry, SharedRuntime::d2f);
 319   FUNCTION_CASE(entry, SharedRuntime::d2i);
 320   FUNCTION_CASE(entry, SharedRuntime::d2l);
 321   FUNCTION_CASE(entry, SharedRuntime::dcos);
 322   FUNCTION_CASE(entry, SharedRuntime::dexp);
 323   FUNCTION_CASE(entry, SharedRuntime::dlog);
 324   FUNCTION_CASE(entry, SharedRuntime::dlog10);
 325   FUNCTION_CASE(entry, SharedRuntime::dpow);
 326   FUNCTION_CASE(entry, SharedRuntime::drem);
 327   FUNCTION_CASE(entry, SharedRuntime::dsin);
 328   FUNCTION_CASE(entry, SharedRuntime::dtan);
 329   FUNCTION_CASE(entry, SharedRuntime::f2i);
 330   FUNCTION_CASE(entry, SharedRuntime::f2l);
 331   FUNCTION_CASE(entry, SharedRuntime::frem);
 332   FUNCTION_CASE(entry, SharedRuntime::l2d);
 333   FUNCTION_CASE(entry, SharedRuntime::l2f);
 334   FUNCTION_CASE(entry, SharedRuntime::ldiv);
 335   FUNCTION_CASE(entry, SharedRuntime::lmul);
 336   FUNCTION_CASE(entry, SharedRuntime::lrem);
 337   FUNCTION_CASE(entry, SharedRuntime::lrem);
 338   FUNCTION_CASE(entry, SharedRuntime::dtrace_method_entry);
 339   FUNCTION_CASE(entry, SharedRuntime::dtrace_method_exit);
 340   FUNCTION_CASE(entry, is_instance_of);
 341   FUNCTION_CASE(entry, trace_block_entry);
 342 #ifdef JFR_HAVE_INTRINSICS
 343   FUNCTION_CASE(entry, JFR_TIME_FUNCTION);
 344 #endif
 345   FUNCTION_CASE(entry, StubRoutines::updateBytesCRC32());
 346   FUNCTION_CASE(entry, StubRoutines::updateBytesCRC32C());
 347   FUNCTION_CASE(entry, StubRoutines::vectorizedMismatch());
 348   FUNCTION_CASE(entry, StubRoutines::dexp());
 349   FUNCTION_CASE(entry, StubRoutines::dlog());
 350   FUNCTION_CASE(entry, StubRoutines::dlog10());
 351   FUNCTION_CASE(entry, StubRoutines::dpow());
 352   FUNCTION_CASE(entry, StubRoutines::dsin());
 353   FUNCTION_CASE(entry, StubRoutines::dcos());
 354   FUNCTION_CASE(entry, StubRoutines::dtan());
 355 
 356 #undef FUNCTION_CASE
 357 
 358   // Soft float adds more runtime names.
 359   return pd_name_for_address(entry);
 360 }
 361 
 362 
 363 JRT_ENTRY(void, Runtime1::new_instance(JavaThread* thread, Klass* klass))
 364   NOT_PRODUCT(_new_instance_slowcase_cnt++;)
 365 
 366   assert(klass-&gt;is_klass(), &quot;not a class&quot;);
 367   Handle holder(THREAD, klass-&gt;klass_holder()); // keep the klass alive
 368   InstanceKlass* h = InstanceKlass::cast(klass);
 369   h-&gt;check_valid_for_instantiation(true, CHECK);
 370   // make sure klass is initialized
 371   h-&gt;initialize(CHECK);
 372   // allocate instance and return via TLS
 373   oop obj = h-&gt;allocate_instance(CHECK);
 374   thread-&gt;set_vm_result(obj);
 375 JRT_END
 376 
 377 
 378 JRT_ENTRY(void, Runtime1::new_type_array(JavaThread* thread, Klass* klass, jint length))
 379   NOT_PRODUCT(_new_type_array_slowcase_cnt++;)
 380   // Note: no handle for klass needed since they are not used
 381   //       anymore after new_typeArray() and no GC can happen before.
 382   //       (This may have to change if this code changes!)
 383   assert(klass-&gt;is_klass(), &quot;not a class&quot;);
 384   BasicType elt_type = TypeArrayKlass::cast(klass)-&gt;element_type();
 385   oop obj = oopFactory::new_typeArray(elt_type, length, CHECK);
 386   thread-&gt;set_vm_result(obj);
 387   // This is pretty rare but this runtime patch is stressful to deoptimization
 388   // if we deoptimize here so force a deopt to stress the path.
 389   if (DeoptimizeALot) {
 390     deopt_caller();
 391   }
 392 
 393 JRT_END
 394 
 395 
 396 JRT_ENTRY(void, Runtime1::new_object_array(JavaThread* thread, Klass* array_klass, jint length))
 397   NOT_PRODUCT(_new_object_array_slowcase_cnt++;)
 398 
 399   // Note: no handle for klass needed since they are not used
 400   //       anymore after new_objArray() and no GC can happen before.
 401   //       (This may have to change if this code changes!)
 402   assert(array_klass-&gt;is_klass(), &quot;not a class&quot;);
 403   Handle holder(THREAD, array_klass-&gt;klass_holder()); // keep the klass alive
 404   Klass* elem_klass = ArrayKlass::cast(array_klass)-&gt;element_klass();
 405   objArrayOop obj = oopFactory::new_objArray(elem_klass, length, CHECK);
 406   thread-&gt;set_vm_result(obj);
 407   // This is pretty rare but this runtime patch is stressful to deoptimization
 408   // if we deoptimize here so force a deopt to stress the path.
 409   if (DeoptimizeALot) {
 410     deopt_caller();
 411   }
 412 JRT_END
 413 
 414 
 415 JRT_ENTRY(void, Runtime1::new_value_array(JavaThread* thread, Klass* array_klass, jint length))
 416   NOT_PRODUCT(_new_value_array_slowcase_cnt++;)
 417 
 418   // Note: no handle for klass needed since they are not used
 419   //       anymore after new_objArray() and no GC can happen before.
 420   //       (This may have to change if this code changes!)
 421   assert(array_klass-&gt;is_klass(), &quot;not a class&quot;);
 422   Handle holder(THREAD, array_klass-&gt;klass_holder()); // keep the klass alive
 423   Klass* elem_klass = ArrayKlass::cast(array_klass)-&gt;element_klass();
 424   assert(elem_klass-&gt;is_value(), &quot;must be&quot;);
 425   // Logically creates elements, ensure klass init
 426   elem_klass-&gt;initialize(CHECK);
 427   arrayOop obj = oopFactory::new_valueArray(elem_klass, length, CHECK);
 428   thread-&gt;set_vm_result(obj);
 429   // This is pretty rare but this runtime patch is stressful to deoptimization
 430   // if we deoptimize here so force a deopt to stress the path.
 431   if (DeoptimizeALot) {
 432     deopt_caller();
 433   }
 434 JRT_END
 435 
 436 
 437 JRT_ENTRY(void, Runtime1::new_multi_array(JavaThread* thread, Klass* klass, int rank, jint* dims))
 438   NOT_PRODUCT(_new_multi_array_slowcase_cnt++;)
 439 
 440   assert(klass-&gt;is_klass(), &quot;not a class&quot;);
 441   assert(rank &gt;= 1, &quot;rank must be nonzero&quot;);
 442   Handle holder(THREAD, klass-&gt;klass_holder()); // keep the klass alive
 443   oop obj = ArrayKlass::cast(klass)-&gt;multi_allocate(rank, dims, CHECK);
 444   thread-&gt;set_vm_result(obj);
 445 JRT_END
 446 
 447 
 448 static void profile_flat_array(JavaThread* thread) {
 449   ResourceMark rm(thread);
 450   vframeStream vfst(thread, true);
 451   assert(!vfst.at_end(), &quot;Java frame must exist&quot;);
 452   int bci = vfst.bci();
 453   Method* method = vfst.method();
 454   MethodData* md = method-&gt;method_data();
 455   if (md != NULL) {
 456     ProfileData* data = md-&gt;bci_to_data(bci);
 457     assert(data != NULL &amp;&amp; data-&gt;is_ArrayLoadStoreData(), &quot;incorrect profiling entry&quot;);
 458     ArrayLoadStoreData* load_store = (ArrayLoadStoreData*)data;
 459     load_store-&gt;set_flat_array();
 460   }
 461 }
 462 
 463 JRT_ENTRY(void, Runtime1::load_flattened_array(JavaThread* thread, valueArrayOopDesc* array, int index))
 464   assert(array-&gt;klass()-&gt;is_valueArray_klass(), &quot;should not be called&quot;);
 465   profile_flat_array(thread);
 466 
 467   NOT_PRODUCT(_load_flattened_array_slowcase_cnt++;)
 468   assert(array-&gt;length() &gt; 0 &amp;&amp; index &lt; array-&gt;length(), &quot;already checked&quot;);
 469   valueArrayHandle vah(thread, array);
 470   oop obj = valueArrayOopDesc::value_alloc_copy_from_index(vah, index, CHECK);
 471   thread-&gt;set_vm_result(obj);
 472 JRT_END
 473 
 474 
 475 JRT_ENTRY(void, Runtime1::store_flattened_array(JavaThread* thread, valueArrayOopDesc* array, int index, oopDesc* value))
 476   if (array-&gt;klass()-&gt;is_valueArray_klass()) {
 477     profile_flat_array(thread);
 478   }
 479 
 480   NOT_PRODUCT(_store_flattened_array_slowcase_cnt++;)
 481   if (value == NULL) {
 482     assert(array-&gt;klass()-&gt;is_valueArray_klass() || array-&gt;klass()-&gt;is_null_free_array_klass(), &quot;should not be called&quot;);
 483     SharedRuntime::throw_and_post_jvmti_exception(thread, vmSymbols::java_lang_NullPointerException());
 484   } else {
 485     assert(array-&gt;klass()-&gt;is_valueArray_klass(), &quot;should not be called&quot;);
 486     array-&gt;value_copy_to_index(value, index);
 487   }
 488 JRT_END
 489 
 490 
 491 JRT_ENTRY(int, Runtime1::substitutability_check(JavaThread* thread, oopDesc* left, oopDesc* right))
 492   NOT_PRODUCT(_substitutability_check_slowcase_cnt++;)
 493   JavaCallArguments args;
 494   args.push_oop(Handle(THREAD, left));
 495   args.push_oop(Handle(THREAD, right));
 496   JavaValue result(T_BOOLEAN);
 497   JavaCalls::call_static(&amp;result,
 498                          SystemDictionary::ValueBootstrapMethods_klass(),
 499                          vmSymbols::isSubstitutable_name(),
 500                          vmSymbols::object_object_boolean_signature(),
 501                          &amp;args, CHECK_0);
 502   return result.get_jboolean() ? 1 : 0;
 503 JRT_END
 504 
 505 
 506 extern &quot;C&quot; void ps();
 507 
 508 void Runtime1::buffer_value_args_impl(JavaThread* thread, Method* m, bool allocate_receiver) {
 509   Thread* THREAD = thread;
 510   methodHandle method(thread, m); // We are inside the verified_entry or verified_value_ro_entry of this method.
 511   oop obj = SharedRuntime::allocate_value_types_impl(thread, method, allocate_receiver, CHECK);
 512   thread-&gt;set_vm_result(obj);
 513 }
 514 
 515 JRT_ENTRY(void, Runtime1::buffer_value_args(JavaThread* thread, Method* method))
 516   NOT_PRODUCT(_buffer_value_args_slowcase_cnt++;)
 517   buffer_value_args_impl(thread, method, true);
 518 JRT_END
 519 
 520 JRT_ENTRY(void, Runtime1::buffer_value_args_no_receiver(JavaThread* thread, Method* method))
 521   NOT_PRODUCT(_buffer_value_args_no_receiver_slowcase_cnt++;)
 522   buffer_value_args_impl(thread, method, false);
 523 JRT_END
 524 
 525 JRT_ENTRY(void, Runtime1::unimplemented_entry(JavaThread* thread, StubID id))
 526   tty-&gt;print_cr(&quot;Runtime1::entry_for(%d) returned unimplemented entry point&quot;, id);
 527 JRT_END
 528 
 529 
 530 JRT_ENTRY(void, Runtime1::throw_array_store_exception(JavaThread* thread, oopDesc* obj))
 531   ResourceMark rm(thread);
 532   const char* klass_name = obj-&gt;klass()-&gt;external_name();
 533   SharedRuntime::throw_and_post_jvmti_exception(thread, vmSymbols::java_lang_ArrayStoreException(), klass_name);
 534 JRT_END
 535 
 536 
 537 // counter_overflow() is called from within C1-compiled methods. The enclosing method is the method
 538 // associated with the top activation record. The inlinee (that is possibly included in the enclosing
 539 // method) method oop is passed as an argument. In order to do that it is embedded in the code as
 540 // a constant.
 541 static nmethod* counter_overflow_helper(JavaThread* THREAD, int branch_bci, Method* m) {
 542   nmethod* osr_nm = NULL;
 543   methodHandle method(THREAD, m);
 544 
 545   RegisterMap map(THREAD, false);
 546   frame fr =  THREAD-&gt;last_frame().sender(&amp;map);
 547   nmethod* nm = (nmethod*) fr.cb();
 548   assert(nm!= NULL &amp;&amp; nm-&gt;is_nmethod(), &quot;Sanity check&quot;);
 549   methodHandle enclosing_method(THREAD, nm-&gt;method());
 550 
 551   CompLevel level = (CompLevel)nm-&gt;comp_level();
 552   int bci = InvocationEntryBci;
 553   if (branch_bci != InvocationEntryBci) {
 554     // Compute destination bci
 555     address pc = method()-&gt;code_base() + branch_bci;
 556     Bytecodes::Code branch = Bytecodes::code_at(method(), pc);
 557     int offset = 0;
 558     switch (branch) {
 559       case Bytecodes::_if_icmplt: case Bytecodes::_iflt:
 560       case Bytecodes::_if_icmpgt: case Bytecodes::_ifgt:
 561       case Bytecodes::_if_icmple: case Bytecodes::_ifle:
 562       case Bytecodes::_if_icmpge: case Bytecodes::_ifge:
 563       case Bytecodes::_if_icmpeq: case Bytecodes::_if_acmpeq: case Bytecodes::_ifeq:
 564       case Bytecodes::_if_icmpne: case Bytecodes::_if_acmpne: case Bytecodes::_ifne:
 565       case Bytecodes::_ifnull: case Bytecodes::_ifnonnull: case Bytecodes::_goto:
 566         offset = (int16_t)Bytes::get_Java_u2(pc + 1);
 567         break;
 568       case Bytecodes::_goto_w:
 569         offset = Bytes::get_Java_u4(pc + 1);
 570         break;
 571       default: ;
 572     }
 573     bci = branch_bci + offset;
 574   }
 575   assert(!HAS_PENDING_EXCEPTION, &quot;Should not have any exceptions pending&quot;);
 576   osr_nm = CompilationPolicy::policy()-&gt;event(enclosing_method, method, branch_bci, bci, level, nm, THREAD);
 577   assert(!HAS_PENDING_EXCEPTION, &quot;Event handler should not throw any exceptions&quot;);
 578   return osr_nm;
 579 }
 580 
 581 JRT_BLOCK_ENTRY(address, Runtime1::counter_overflow(JavaThread* thread, int bci, Method* method))
 582   nmethod* osr_nm;
 583   JRT_BLOCK
 584     osr_nm = counter_overflow_helper(thread, bci, method);
 585     if (osr_nm != NULL) {
 586       RegisterMap map(thread, false);
 587       frame fr =  thread-&gt;last_frame().sender(&amp;map);
 588       Deoptimization::deoptimize_frame(thread, fr.id());
 589     }
 590   JRT_BLOCK_END
 591   return NULL;
 592 JRT_END
 593 
 594 extern void vm_exit(int code);
 595 
 596 // Enter this method from compiled code handler below. This is where we transition
 597 // to VM mode. This is done as a helper routine so that the method called directly
 598 // from compiled code does not have to transition to VM. This allows the entry
 599 // method to see if the nmethod that we have just looked up a handler for has
 600 // been deoptimized while we were in the vm. This simplifies the assembly code
 601 // cpu directories.
 602 //
 603 // We are entering here from exception stub (via the entry method below)
 604 // If there is a compiled exception handler in this method, we will continue there;
 605 // otherwise we will unwind the stack and continue at the caller of top frame method
 606 // Note: we enter in Java using a special JRT wrapper. This wrapper allows us to
 607 // control the area where we can allow a safepoint. After we exit the safepoint area we can
 608 // check to see if the handler we are going to return is now in a nmethod that has
 609 // been deoptimized. If that is the case we return the deopt blob
 610 // unpack_with_exception entry instead. This makes life for the exception blob easier
 611 // because making that same check and diverting is painful from assembly language.
 612 JRT_ENTRY_NO_ASYNC(static address, exception_handler_for_pc_helper(JavaThread* thread, oopDesc* ex, address pc, nmethod*&amp; nm))
 613   // Reset method handle flag.
 614   thread-&gt;set_is_method_handle_return(false);
 615 
 616   Handle exception(thread, ex);
 617   nm = CodeCache::find_nmethod(pc);
 618   assert(nm != NULL, &quot;this is not an nmethod&quot;);
 619   // Adjust the pc as needed/
 620   if (nm-&gt;is_deopt_pc(pc)) {
 621     RegisterMap map(thread, false);
 622     frame exception_frame = thread-&gt;last_frame().sender(&amp;map);
 623     // if the frame isn&#39;t deopted then pc must not correspond to the caller of last_frame
 624     assert(exception_frame.is_deoptimized_frame(), &quot;must be deopted&quot;);
 625     pc = exception_frame.pc();
 626   }
 627 #ifdef ASSERT
 628   assert(exception.not_null(), &quot;NULL exceptions should be handled by throw_exception&quot;);
 629   // Check that exception is a subclass of Throwable, otherwise we have a VerifyError
 630   if (!(exception-&gt;is_a(SystemDictionary::Throwable_klass()))) {
 631     if (ExitVMOnVerifyError) vm_exit(-1);
 632     ShouldNotReachHere();
 633   }
 634 #endif
 635 
 636   // Check the stack guard pages and reenable them if necessary and there is
 637   // enough space on the stack to do so.  Use fast exceptions only if the guard
 638   // pages are enabled.
 639   bool guard_pages_enabled = thread-&gt;stack_guards_enabled();
 640   if (!guard_pages_enabled) guard_pages_enabled = thread-&gt;reguard_stack();
 641 
 642   if (JvmtiExport::can_post_on_exceptions()) {
 643     // To ensure correct notification of exception catches and throws
 644     // we have to deoptimize here.  If we attempted to notify the
 645     // catches and throws during this exception lookup it&#39;s possible
 646     // we could deoptimize on the way out of the VM and end back in
 647     // the interpreter at the throw site.  This would result in double
 648     // notifications since the interpreter would also notify about
 649     // these same catches and throws as it unwound the frame.
 650 
 651     RegisterMap reg_map(thread);
 652     frame stub_frame = thread-&gt;last_frame();
 653     frame caller_frame = stub_frame.sender(&amp;reg_map);
 654 
 655     // We don&#39;t really want to deoptimize the nmethod itself since we
 656     // can actually continue in the exception handler ourselves but I
 657     // don&#39;t see an easy way to have the desired effect.
 658     Deoptimization::deoptimize_frame(thread, caller_frame.id());
 659     assert(caller_is_deopted(), &quot;Must be deoptimized&quot;);
 660 
 661     return SharedRuntime::deopt_blob()-&gt;unpack_with_exception_in_tls();
 662   }
 663 
 664   // ExceptionCache is used only for exceptions at call sites and not for implicit exceptions
 665   if (guard_pages_enabled) {
 666     address fast_continuation = nm-&gt;handler_for_exception_and_pc(exception, pc);
 667     if (fast_continuation != NULL) {
 668       // Set flag if return address is a method handle call site.
 669       thread-&gt;set_is_method_handle_return(nm-&gt;is_method_handle_return(pc));
 670       return fast_continuation;
 671     }
 672   }
 673 
 674   // If the stack guard pages are enabled, check whether there is a handler in
 675   // the current method.  Otherwise (guard pages disabled), force an unwind and
 676   // skip the exception cache update (i.e., just leave continuation==NULL).
 677   address continuation = NULL;
 678   if (guard_pages_enabled) {
 679 
 680     // New exception handling mechanism can support inlined methods
 681     // with exception handlers since the mappings are from PC to PC
 682 
 683     // debugging support
 684     // tracing
 685     if (log_is_enabled(Info, exceptions)) {
 686       ResourceMark rm;
 687       stringStream tempst;
 688       assert(nm-&gt;method() != NULL, &quot;Unexpected NULL method()&quot;);
 689       tempst.print(&quot;compiled method &lt;%s&gt;\n&quot;
 690                    &quot; at PC&quot; INTPTR_FORMAT &quot; for thread &quot; INTPTR_FORMAT,
 691                    nm-&gt;method()-&gt;print_value_string(), p2i(pc), p2i(thread));
 692       Exceptions::log_exception(exception, tempst.as_string());
 693     }
 694     // for AbortVMOnException flag
 695     Exceptions::debug_check_abort(exception);
 696 
 697     // Clear out the exception oop and pc since looking up an
 698     // exception handler can cause class loading, which might throw an
 699     // exception and those fields are expected to be clear during
 700     // normal bytecode execution.
 701     thread-&gt;clear_exception_oop_and_pc();
 702 
 703     bool recursive_exception = false;
 704     continuation = SharedRuntime::compute_compiled_exc_handler(nm, pc, exception, false, false, recursive_exception);
 705     // If an exception was thrown during exception dispatch, the exception oop may have changed
 706     thread-&gt;set_exception_oop(exception());
 707     thread-&gt;set_exception_pc(pc);
 708 
 709     // the exception cache is used only by non-implicit exceptions
 710     // Update the exception cache only when there didn&#39;t happen
 711     // another exception during the computation of the compiled
 712     // exception handler. Checking for exception oop equality is not
 713     // sufficient because some exceptions are pre-allocated and reused.
 714     if (continuation != NULL &amp;&amp; !recursive_exception) {
 715       nm-&gt;add_handler_for_exception_and_pc(exception, pc, continuation);
 716     }
 717   }
 718 
 719   thread-&gt;set_vm_result(exception());
 720   // Set flag if return address is a method handle call site.
 721   thread-&gt;set_is_method_handle_return(nm-&gt;is_method_handle_return(pc));
 722 
 723   if (log_is_enabled(Info, exceptions)) {
 724     ResourceMark rm;
 725     log_info(exceptions)(&quot;Thread &quot; PTR_FORMAT &quot; continuing at PC &quot; PTR_FORMAT
 726                          &quot; for exception thrown at PC &quot; PTR_FORMAT,
 727                          p2i(thread), p2i(continuation), p2i(pc));
 728   }
 729 
 730   return continuation;
 731 JRT_END
 732 
 733 // Enter this method from compiled code only if there is a Java exception handler
 734 // in the method handling the exception.
 735 // We are entering here from exception stub. We don&#39;t do a normal VM transition here.
 736 // We do it in a helper. This is so we can check to see if the nmethod we have just
 737 // searched for an exception handler has been deoptimized in the meantime.
 738 address Runtime1::exception_handler_for_pc(JavaThread* thread) {
 739   oop exception = thread-&gt;exception_oop();
 740   address pc = thread-&gt;exception_pc();
 741   // Still in Java mode
 742   DEBUG_ONLY(ResetNoHandleMark rnhm);
 743   nmethod* nm = NULL;
 744   address continuation = NULL;
 745   {
 746     // Enter VM mode by calling the helper
 747     ResetNoHandleMark rnhm;
 748     continuation = exception_handler_for_pc_helper(thread, exception, pc, nm);
 749   }
 750   // Back in JAVA, use no oops DON&#39;T safepoint
 751 
 752   // Now check to see if the nmethod we were called from is now deoptimized.
 753   // If so we must return to the deopt blob and deoptimize the nmethod
 754   if (nm != NULL &amp;&amp; caller_is_deopted()) {
 755     continuation = SharedRuntime::deopt_blob()-&gt;unpack_with_exception_in_tls();
 756   }
 757 
 758   assert(continuation != NULL, &quot;no handler found&quot;);
 759   return continuation;
 760 }
 761 
 762 
 763 JRT_ENTRY(void, Runtime1::throw_range_check_exception(JavaThread* thread, int index, arrayOopDesc* a))
 764   NOT_PRODUCT(_throw_range_check_exception_count++;)
 765   const int len = 35;
 766   assert(len &lt; strlen(&quot;Index %d out of bounds for length %d&quot;), &quot;Must allocate more space for message.&quot;);
 767   char message[2 * jintAsStringSize + len];
 768   sprintf(message, &quot;Index %d out of bounds for length %d&quot;, index, a-&gt;length());
 769   SharedRuntime::throw_and_post_jvmti_exception(thread, vmSymbols::java_lang_ArrayIndexOutOfBoundsException(), message);
 770 JRT_END
 771 
 772 
 773 JRT_ENTRY(void, Runtime1::throw_index_exception(JavaThread* thread, int index))
 774   NOT_PRODUCT(_throw_index_exception_count++;)
 775   char message[16];
 776   sprintf(message, &quot;%d&quot;, index);
 777   SharedRuntime::throw_and_post_jvmti_exception(thread, vmSymbols::java_lang_IndexOutOfBoundsException(), message);
 778 JRT_END
 779 
 780 
 781 JRT_ENTRY(void, Runtime1::throw_div0_exception(JavaThread* thread))
 782   NOT_PRODUCT(_throw_div0_exception_count++;)
 783   SharedRuntime::throw_and_post_jvmti_exception(thread, vmSymbols::java_lang_ArithmeticException(), &quot;/ by zero&quot;);
 784 JRT_END
 785 
 786 
 787 JRT_ENTRY(void, Runtime1::throw_null_pointer_exception(JavaThread* thread))
 788   NOT_PRODUCT(_throw_null_pointer_exception_count++;)
 789   SharedRuntime::throw_and_post_jvmti_exception(thread, vmSymbols::java_lang_NullPointerException());
 790 JRT_END
 791 
 792 
 793 JRT_ENTRY(void, Runtime1::throw_class_cast_exception(JavaThread* thread, oopDesc* object))
 794   NOT_PRODUCT(_throw_class_cast_exception_count++;)
 795   ResourceMark rm(thread);
 796   char* message = SharedRuntime::generate_class_cast_message(
 797     thread, object-&gt;klass());
 798   SharedRuntime::throw_and_post_jvmti_exception(
 799     thread, vmSymbols::java_lang_ClassCastException(), message);
 800 JRT_END
 801 
 802 
 803 JRT_ENTRY(void, Runtime1::throw_incompatible_class_change_error(JavaThread* thread))
 804   NOT_PRODUCT(_throw_incompatible_class_change_error_count++;)
 805   ResourceMark rm(thread);
 806   SharedRuntime::throw_and_post_jvmti_exception(thread, vmSymbols::java_lang_IncompatibleClassChangeError());
 807 JRT_END
 808 
 809 
 810 JRT_ENTRY(void, Runtime1::throw_illegal_monitor_state_exception(JavaThread* thread))
 811   NOT_PRODUCT(_throw_illegal_monitor_state_exception_count++;)
 812   ResourceMark rm(thread);
 813   SharedRuntime::throw_and_post_jvmti_exception(thread, vmSymbols::java_lang_IllegalMonitorStateException());
 814 JRT_END
 815 
 816 
 817 JRT_ENTRY_NO_ASYNC(void, Runtime1::monitorenter(JavaThread* thread, oopDesc* obj, BasicObjectLock* lock))
 818   NOT_PRODUCT(_monitorenter_slowcase_cnt++;)
 819   if (PrintBiasedLockingStatistics) {
 820     Atomic::inc(BiasedLocking::slow_path_entry_count_addr());
 821   }
 822   Handle h_obj(thread, obj);
 823   if (!UseFastLocking) {
 824     lock-&gt;set_obj(obj);
 825   }
 826   assert(obj == lock-&gt;obj(), &quot;must match&quot;);
 827   ObjectSynchronizer::enter(h_obj, lock-&gt;lock(), THREAD);
 828 JRT_END
 829 
 830 
 831 JRT_LEAF(void, Runtime1::monitorexit(JavaThread* thread, BasicObjectLock* lock))
 832   NOT_PRODUCT(_monitorexit_slowcase_cnt++;)
 833   assert(thread == JavaThread::current(), &quot;threads must correspond&quot;);
 834   assert(thread-&gt;last_Java_sp(), &quot;last_Java_sp must be set&quot;);
 835   // monitorexit is non-blocking (leaf routine) =&gt; no exceptions can be thrown
 836   EXCEPTION_MARK;
 837 
 838   oop obj = lock-&gt;obj();
 839   assert(oopDesc::is_oop(obj), &quot;must be NULL or an object&quot;);
 840   ObjectSynchronizer::exit(obj, lock-&gt;lock(), THREAD);
 841 JRT_END
 842 
 843 // Cf. OptoRuntime::deoptimize_caller_frame
 844 JRT_ENTRY(void, Runtime1::deoptimize(JavaThread* thread, jint trap_request))
 845   // Called from within the owner thread, so no need for safepoint
 846   RegisterMap reg_map(thread, false);
 847   frame stub_frame = thread-&gt;last_frame();
 848   assert(stub_frame.is_runtime_frame(), &quot;Sanity check&quot;);
 849   frame caller_frame = stub_frame.sender(&amp;reg_map);
 850   nmethod* nm = caller_frame.cb()-&gt;as_nmethod_or_null();
 851   assert(nm != NULL, &quot;Sanity check&quot;);
 852   methodHandle method(thread, nm-&gt;method());
 853   assert(nm == CodeCache::find_nmethod(caller_frame.pc()), &quot;Should be the same&quot;);
 854   Deoptimization::DeoptAction action = Deoptimization::trap_request_action(trap_request);
 855   Deoptimization::DeoptReason reason = Deoptimization::trap_request_reason(trap_request);
 856 
 857   if (action == Deoptimization::Action_make_not_entrant) {
 858     if (nm-&gt;make_not_entrant()) {
 859       if (reason == Deoptimization::Reason_tenured) {
 860         MethodData* trap_mdo = Deoptimization::get_method_data(thread, method, true /*create_if_missing*/);
 861         if (trap_mdo != NULL) {
 862           trap_mdo-&gt;inc_tenure_traps();
 863         }
 864       }
 865     }
 866   }
 867 
 868   // Deoptimize the caller frame.
 869   Deoptimization::deoptimize_frame(thread, caller_frame.id());
 870   // Return to the now deoptimized frame.
 871 JRT_END
 872 
 873 
 874 #ifndef DEOPTIMIZE_WHEN_PATCHING
 875 
 876 static Klass* resolve_field_return_klass(const methodHandle&amp; caller, int bci, TRAPS) {
 877   Bytecode_field field_access(caller, bci);
 878   // This can be static or non-static field access
 879   Bytecodes::Code code       = field_access.code();
 880 
 881   // We must load class, initialize class and resolve the field
 882   fieldDescriptor result; // initialize class if needed
 883   constantPoolHandle constants(THREAD, caller-&gt;constants());
 884   LinkResolver::resolve_field_access(result, constants, field_access.index(), caller, Bytecodes::java_code(code), CHECK_NULL);
 885   return result.field_holder();
 886 }
 887 
 888 
 889 //
 890 // This routine patches sites where a class wasn&#39;t loaded or
 891 // initialized at the time the code was generated.  It handles
 892 // references to classes, fields and forcing of initialization.  Most
 893 // of the cases are straightforward and involving simply forcing
 894 // resolution of a class, rewriting the instruction stream with the
 895 // needed constant and replacing the call in this function with the
 896 // patched code.  The case for static field is more complicated since
 897 // the thread which is in the process of initializing a class can
 898 // access it&#39;s static fields but other threads can&#39;t so the code
 899 // either has to deoptimize when this case is detected or execute a
 900 // check that the current thread is the initializing thread.  The
 901 // current
 902 //
 903 // Patches basically look like this:
 904 //
 905 //
 906 // patch_site: jmp patch stub     ;; will be patched
 907 // continue:   ...
 908 //             ...
 909 //             ...
 910 //             ...
 911 //
 912 // They have a stub which looks like this:
 913 //
 914 //             ;; patch body
 915 //             movl &lt;const&gt;, reg           (for class constants)
 916 //        &lt;or&gt; movl [reg1 + &lt;const&gt;], reg  (for field offsets)
 917 //        &lt;or&gt; movl reg, [reg1 + &lt;const&gt;]  (for field offsets)
 918 //             &lt;being_init offset&gt; &lt;bytes to copy&gt; &lt;bytes to skip&gt;
 919 // patch_stub: call Runtime1::patch_code (through a runtime stub)
 920 //             jmp patch_site
 921 //
 922 //
 923 // A normal patch is done by rewriting the patch body, usually a move,
 924 // and then copying it into place over top of the jmp instruction
 925 // being careful to flush caches and doing it in an MP-safe way.  The
 926 // constants following the patch body are used to find various pieces
 927 // of the patch relative to the call site for Runtime1::patch_code.
 928 // The case for getstatic and putstatic is more complicated because
 929 // getstatic and putstatic have special semantics when executing while
 930 // the class is being initialized.  getstatic/putstatic on a class
 931 // which is being_initialized may be executed by the initializing
 932 // thread but other threads have to block when they execute it.  This
 933 // is accomplished in compiled code by executing a test of the current
 934 // thread against the initializing thread of the class.  It&#39;s emitted
 935 // as boilerplate in their stub which allows the patched code to be
 936 // executed before it&#39;s copied back into the main body of the nmethod.
 937 //
 938 // being_init: get_thread(&lt;tmp reg&gt;
 939 //             cmpl [reg1 + &lt;init_thread_offset&gt;], &lt;tmp reg&gt;
 940 //             jne patch_stub
 941 //             movl [reg1 + &lt;const&gt;], reg  (for field offsets)  &lt;or&gt;
 942 //             movl reg, [reg1 + &lt;const&gt;]  (for field offsets)
 943 //             jmp continue
 944 //             &lt;being_init offset&gt; &lt;bytes to copy&gt; &lt;bytes to skip&gt;
 945 // patch_stub: jmp Runtim1::patch_code (through a runtime stub)
 946 //             jmp patch_site
 947 //
 948 // If the class is being initialized the patch body is rewritten and
 949 // the patch site is rewritten to jump to being_init, instead of
 950 // patch_stub.  Whenever this code is executed it checks the current
 951 // thread against the intializing thread so other threads will enter
 952 // the runtime and end up blocked waiting the class to finish
 953 // initializing inside the calls to resolve_field below.  The
 954 // initializing class will continue on it&#39;s way.  Once the class is
 955 // fully_initialized, the intializing_thread of the class becomes
 956 // NULL, so the next thread to execute this code will fail the test,
 957 // call into patch_code and complete the patching process by copying
 958 // the patch body back into the main part of the nmethod and resume
 959 // executing.
 960 
 961 // NB:
 962 //
 963 // Patchable instruction sequences inherently exhibit race conditions,
 964 // where thread A is patching an instruction at the same time thread B
 965 // is executing it.  The algorithms we use ensure that any observation
 966 // that B can make on any intermediate states during A&#39;s patching will
 967 // always end up with a correct outcome.  This is easiest if there are
 968 // few or no intermediate states.  (Some inline caches have two
 969 // related instructions that must be patched in tandem.  For those,
 970 // intermediate states seem to be unavoidable, but we will get the
 971 // right answer from all possible observation orders.)
 972 //
 973 // When patching the entry instruction at the head of a method, or a
 974 // linkable call instruction inside of a method, we try very hard to
 975 // use a patch sequence which executes as a single memory transaction.
 976 // This means, in practice, that when thread A patches an instruction,
 977 // it should patch a 32-bit or 64-bit word that somehow overlaps the
 978 // instruction or is contained in it.  We believe that memory hardware
 979 // will never break up such a word write, if it is naturally aligned
 980 // for the word being written.  We also know that some CPUs work very
 981 // hard to create atomic updates even of naturally unaligned words,
 982 // but we don&#39;t want to bet the farm on this always working.
 983 //
 984 // Therefore, if there is any chance of a race condition, we try to
 985 // patch only naturally aligned words, as single, full-word writes.
 986 
 987 JRT_ENTRY(void, Runtime1::patch_code(JavaThread* thread, Runtime1::StubID stub_id ))
 988   NOT_PRODUCT(_patch_code_slowcase_cnt++;)
 989 
 990   ResourceMark rm(thread);
 991   RegisterMap reg_map(thread, false);
 992   frame runtime_frame = thread-&gt;last_frame();
 993   frame caller_frame = runtime_frame.sender(&amp;reg_map);
 994 
 995   // last java frame on stack
 996   vframeStream vfst(thread, true);
 997   assert(!vfst.at_end(), &quot;Java frame must exist&quot;);
 998 
 999   methodHandle caller_method(THREAD, vfst.method());
1000   // Note that caller_method-&gt;code() may not be same as caller_code because of OSR&#39;s
1001   // Note also that in the presence of inlining it is not guaranteed
1002   // that caller_method() == caller_code-&gt;method()
1003 
1004   int bci = vfst.bci();
1005   Bytecodes::Code code = caller_method()-&gt;java_code_at(bci);
1006 
1007   // this is used by assertions in the access_field_patching_id
1008   BasicType patch_field_type = T_ILLEGAL;
1009   bool deoptimize_for_volatile = false;
1010   bool deoptimize_for_atomic = false;
1011   int patch_field_offset = -1;
1012   Klass* init_klass = NULL; // klass needed by load_klass_patching code
1013   Klass* load_klass = NULL; // klass needed by load_klass_patching code
1014   Handle mirror(THREAD, NULL);                    // oop needed by load_mirror_patching code
1015   Handle appendix(THREAD, NULL);                  // oop needed by appendix_patching code
1016   bool load_klass_or_mirror_patch_id =
1017     (stub_id == Runtime1::load_klass_patching_id || stub_id == Runtime1::load_mirror_patching_id);
1018 
1019   if (stub_id == Runtime1::access_field_patching_id) {
1020 
1021     Bytecode_field field_access(caller_method, bci);
1022     fieldDescriptor result; // initialize class if needed
1023     Bytecodes::Code code = field_access.code();
1024     constantPoolHandle constants(THREAD, caller_method-&gt;constants());
1025     LinkResolver::resolve_field_access(result, constants, field_access.index(), caller_method, Bytecodes::java_code(code), CHECK);
1026     patch_field_offset = result.offset();
1027 
1028     // If we&#39;re patching a field which is volatile then at compile it
1029     // must not have been know to be volatile, so the generated code
1030     // isn&#39;t correct for a volatile reference.  The nmethod has to be
1031     // deoptimized so that the code can be regenerated correctly.
1032     // This check is only needed for access_field_patching since this
1033     // is the path for patching field offsets.  load_klass is only
1034     // used for patching references to oops which don&#39;t need special
1035     // handling in the volatile case.
1036 
1037     deoptimize_for_volatile = result.access_flags().is_volatile();
1038 
1039     // If we are patching a field which should be atomic, then
1040     // the generated code is not correct either, force deoptimizing.
1041     // We need to only cover T_LONG and T_DOUBLE fields, as we can
1042     // break access atomicity only for them.
1043 
1044     // Strictly speaking, the deoptimization on 64-bit platforms
1045     // is unnecessary, and T_LONG stores on 32-bit platforms need
1046     // to be handled by special patching code when AlwaysAtomicAccesses
1047     // becomes product feature. At this point, we are still going
1048     // for the deoptimization for consistency against volatile
1049     // accesses.
1050 
1051     patch_field_type = result.field_type();
1052     deoptimize_for_atomic = (AlwaysAtomicAccesses &amp;&amp; (patch_field_type == T_DOUBLE || patch_field_type == T_LONG));
1053 
1054   } else if (load_klass_or_mirror_patch_id) {
1055     Klass* k = NULL;
1056     switch (code) {
1057       case Bytecodes::_putstatic:
1058       case Bytecodes::_getstatic:
1059         { Klass* klass = resolve_field_return_klass(caller_method, bci, CHECK);
1060           init_klass = klass;
1061           mirror = Handle(THREAD, klass-&gt;java_mirror());
1062         }
1063         break;
1064       case Bytecodes::_new:
1065         { Bytecode_new bnew(caller_method(), caller_method-&gt;bcp_from(bci));
1066           k = caller_method-&gt;constants()-&gt;klass_at(bnew.index(), CHECK);
1067         }
1068         break;
1069       case Bytecodes::_defaultvalue:
1070         { Bytecode_defaultvalue bdefaultvalue(caller_method(), caller_method-&gt;bcp_from(bci));
1071           k = caller_method-&gt;constants()-&gt;klass_at(bdefaultvalue.index(), CHECK);
1072         }
1073         break;
1074       case Bytecodes::_multianewarray:
1075         { Bytecode_multianewarray mna(caller_method(), caller_method-&gt;bcp_from(bci));
1076           k = caller_method-&gt;constants()-&gt;klass_at(mna.index(), CHECK);
1077           if (k-&gt;name()-&gt;is_Q_array_signature()) {
1078             // Logically creates elements, ensure klass init
1079             k-&gt;initialize(CHECK);
1080           }
1081         }
1082         break;
1083       case Bytecodes::_instanceof:
1084         { Bytecode_instanceof io(caller_method(), caller_method-&gt;bcp_from(bci));
1085           k = caller_method-&gt;constants()-&gt;klass_at(io.index(), CHECK);
1086         }
1087         break;
1088       case Bytecodes::_checkcast:
1089         { Bytecode_checkcast cc(caller_method(), caller_method-&gt;bcp_from(bci));
1090           k = caller_method-&gt;constants()-&gt;klass_at(cc.index(), CHECK);
1091         }
1092         break;
1093       case Bytecodes::_anewarray:
1094         { Bytecode_anewarray anew(caller_method(), caller_method-&gt;bcp_from(bci));
1095           Klass* ek = caller_method-&gt;constants()-&gt;klass_at(anew.index(), CHECK);
1096           if (ek-&gt;is_value() &amp;&amp; caller_method-&gt;constants()-&gt;klass_at_noresolve(anew.index())-&gt;is_Q_signature()) {
1097             k = ek-&gt;array_klass(1, CHECK);
1098             assert(k-&gt;is_null_free_array_klass(), &quot;Expect a null-free array class here&quot;);
1099           } else {
1100             k = ek-&gt;array_klass(CHECK);
1101           }
1102         }
1103         break;
1104       case Bytecodes::_ldc:
1105       case Bytecodes::_ldc_w:
1106         {
1107           Bytecode_loadconstant cc(caller_method, bci);
1108           oop m = cc.resolve_constant(CHECK);
1109           mirror = Handle(THREAD, m);
1110         }
1111         break;
1112       default: fatal(&quot;unexpected bytecode for load_klass_or_mirror_patch_id&quot;);
1113     }
1114     load_klass = k;
1115   } else if (stub_id == load_appendix_patching_id) {
1116     Bytecode_invoke bytecode(caller_method, bci);
1117     Bytecodes::Code bc = bytecode.invoke_code();
1118 
1119     CallInfo info;
1120     constantPoolHandle pool(thread, caller_method-&gt;constants());
1121     int index = bytecode.index();
1122     LinkResolver::resolve_invoke(info, Handle(), pool, index, bc, CHECK);
1123     switch (bc) {
1124       case Bytecodes::_invokehandle: {
1125         int cache_index = ConstantPool::decode_cpcache_index(index, true);
1126         assert(cache_index &gt;= 0 &amp;&amp; cache_index &lt; pool-&gt;cache()-&gt;length(), &quot;unexpected cache index&quot;);
1127         ConstantPoolCacheEntry* cpce = pool-&gt;cache()-&gt;entry_at(cache_index);
1128         cpce-&gt;set_method_handle(pool, info);
1129         appendix = Handle(THREAD, cpce-&gt;appendix_if_resolved(pool)); // just in case somebody already resolved the entry
1130         break;
1131       }
1132       case Bytecodes::_invokedynamic: {
1133         ConstantPoolCacheEntry* cpce = pool-&gt;invokedynamic_cp_cache_entry_at(index);
1134         cpce-&gt;set_dynamic_call(pool, info);
1135         appendix = Handle(THREAD, cpce-&gt;appendix_if_resolved(pool)); // just in case somebody already resolved the entry
1136         break;
1137       }
1138       default: fatal(&quot;unexpected bytecode for load_appendix_patching_id&quot;);
1139     }
1140   } else {
1141     ShouldNotReachHere();
1142   }
1143 
1144   if (deoptimize_for_volatile || deoptimize_for_atomic) {
1145     // At compile time we assumed the field wasn&#39;t volatile/atomic but after
1146     // loading it turns out it was volatile/atomic so we have to throw the
1147     // compiled code out and let it be regenerated.
1148     if (TracePatching) {
1149       if (deoptimize_for_volatile) {
1150         tty-&gt;print_cr(&quot;Deoptimizing for patching volatile field reference&quot;);
1151       }
1152       if (deoptimize_for_atomic) {
1153         tty-&gt;print_cr(&quot;Deoptimizing for patching atomic field reference&quot;);
1154       }
1155     }
1156 
1157     // It&#39;s possible the nmethod was invalidated in the last
1158     // safepoint, but if it&#39;s still alive then make it not_entrant.
1159     nmethod* nm = CodeCache::find_nmethod(caller_frame.pc());
1160     if (nm != NULL) {
1161       nm-&gt;make_not_entrant();
1162     }
1163 
1164     Deoptimization::deoptimize_frame(thread, caller_frame.id());
1165 
1166     // Return to the now deoptimized frame.
1167   }
1168 
1169   // Now copy code back
1170 
1171   {
1172     MutexLocker ml_patch (THREAD, Patching_lock, Mutex::_no_safepoint_check_flag);
1173     //
1174     // Deoptimization may have happened while we waited for the lock.
1175     // In that case we don&#39;t bother to do any patching we just return
1176     // and let the deopt happen
1177     if (!caller_is_deopted()) {
1178       NativeGeneralJump* jump = nativeGeneralJump_at(caller_frame.pc());
1179       address instr_pc = jump-&gt;jump_destination();
1180       NativeInstruction* ni = nativeInstruction_at(instr_pc);
1181       if (ni-&gt;is_jump() ) {
1182         // the jump has not been patched yet
1183         // The jump destination is slow case and therefore not part of the stubs
1184         // (stubs are only for StaticCalls)
1185 
1186         // format of buffer
1187         //    ....
1188         //    instr byte 0     &lt;-- copy_buff
1189         //    instr byte 1
1190         //    ..
1191         //    instr byte n-1
1192         //      n
1193         //    ....             &lt;-- call destination
1194 
1195         address stub_location = caller_frame.pc() + PatchingStub::patch_info_offset();
1196         unsigned char* byte_count = (unsigned char*) (stub_location - 1);
1197         unsigned char* byte_skip = (unsigned char*) (stub_location - 2);
1198         unsigned char* being_initialized_entry_offset = (unsigned char*) (stub_location - 3);
1199         address copy_buff = stub_location - *byte_skip - *byte_count;
1200         address being_initialized_entry = stub_location - *being_initialized_entry_offset;
1201         if (TracePatching) {
1202           ttyLocker ttyl;
1203           tty-&gt;print_cr(&quot; Patching %s at bci %d at address &quot; INTPTR_FORMAT &quot;  (%s)&quot;, Bytecodes::name(code), bci,
1204                         p2i(instr_pc), (stub_id == Runtime1::access_field_patching_id) ? &quot;field&quot; : &quot;klass&quot;);
1205           nmethod* caller_code = CodeCache::find_nmethod(caller_frame.pc());
1206           assert(caller_code != NULL, &quot;nmethod not found&quot;);
1207 
1208           // NOTE we use pc() not original_pc() because we already know they are
1209           // identical otherwise we&#39;d have never entered this block of code
1210 
1211           const ImmutableOopMap* map = caller_code-&gt;oop_map_for_return_address(caller_frame.pc());
1212           assert(map != NULL, &quot;null check&quot;);
1213           map-&gt;print();
1214           tty-&gt;cr();
1215 
1216           Disassembler::decode(copy_buff, copy_buff + *byte_count, tty);
1217         }
1218         // depending on the code below, do_patch says whether to copy the patch body back into the nmethod
1219         bool do_patch = true;
1220         if (stub_id == Runtime1::access_field_patching_id) {
1221           // The offset may not be correct if the class was not loaded at code generation time.
1222           // Set it now.
1223           NativeMovRegMem* n_move = nativeMovRegMem_at(copy_buff);
1224           assert(n_move-&gt;offset() == 0 || (n_move-&gt;offset() == 4 &amp;&amp; (patch_field_type == T_DOUBLE || patch_field_type == T_LONG)), &quot;illegal offset for type&quot;);
1225           assert(patch_field_offset &gt;= 0, &quot;illegal offset&quot;);
1226           n_move-&gt;add_offset_in_bytes(patch_field_offset);
1227         } else if (load_klass_or_mirror_patch_id) {
1228           // If a getstatic or putstatic is referencing a klass which
1229           // isn&#39;t fully initialized, the patch body isn&#39;t copied into
1230           // place until initialization is complete.  In this case the
1231           // patch site is setup so that any threads besides the
1232           // initializing thread are forced to come into the VM and
1233           // block.
1234           do_patch = (code != Bytecodes::_getstatic &amp;&amp; code != Bytecodes::_putstatic) ||
1235                      InstanceKlass::cast(init_klass)-&gt;is_initialized();
1236           NativeGeneralJump* jump = nativeGeneralJump_at(instr_pc);
1237           if (jump-&gt;jump_destination() == being_initialized_entry) {
1238             assert(do_patch == true, &quot;initialization must be complete at this point&quot;);
1239           } else {
1240             // patch the instruction &lt;move reg, klass&gt;
1241             NativeMovConstReg* n_copy = nativeMovConstReg_at(copy_buff);
1242 
1243             assert(n_copy-&gt;data() == 0 ||
1244                    n_copy-&gt;data() == (intptr_t)Universe::non_oop_word(),
1245                    &quot;illegal init value&quot;);
1246             if (stub_id == Runtime1::load_klass_patching_id) {
1247               assert(load_klass != NULL, &quot;klass not set&quot;);
1248               n_copy-&gt;set_data((intx) (load_klass));
1249             } else {
1250               assert(mirror() != NULL, &quot;klass not set&quot;);
1251               // Don&#39;t need a G1 pre-barrier here since we assert above that data isn&#39;t an oop.
1252               n_copy-&gt;set_data(cast_from_oop&lt;intx&gt;(mirror()));
1253             }
1254 
1255             if (TracePatching) {
1256               Disassembler::decode(copy_buff, copy_buff + *byte_count, tty);
1257             }
1258           }
1259         } else if (stub_id == Runtime1::load_appendix_patching_id) {
1260           NativeMovConstReg* n_copy = nativeMovConstReg_at(copy_buff);
1261           assert(n_copy-&gt;data() == 0 ||
1262                  n_copy-&gt;data() == (intptr_t)Universe::non_oop_word(),
1263                  &quot;illegal init value&quot;);
1264           n_copy-&gt;set_data(cast_from_oop&lt;intx&gt;(appendix()));
1265 
1266           if (TracePatching) {
1267             Disassembler::decode(copy_buff, copy_buff + *byte_count, tty);
1268           }
1269         } else {
1270           ShouldNotReachHere();
1271         }
1272 
1273 #if defined(SPARC) || defined(PPC32)
1274         if (load_klass_or_mirror_patch_id ||
1275             stub_id == Runtime1::load_appendix_patching_id) {
1276           // Update the location in the nmethod with the proper
1277           // metadata.  When the code was generated, a NULL was stuffed
1278           // in the metadata table and that table needs to be update to
1279           // have the right value.  On intel the value is kept
1280           // directly in the instruction instead of in the metadata
1281           // table, so set_data above effectively updated the value.
1282           nmethod* nm = CodeCache::find_nmethod(instr_pc);
1283           assert(nm != NULL, &quot;invalid nmethod_pc&quot;);
1284           RelocIterator mds(nm, copy_buff, copy_buff + 1);
1285           bool found = false;
1286           while (mds.next() &amp;&amp; !found) {
1287             if (mds.type() == relocInfo::oop_type) {
1288               assert(stub_id == Runtime1::load_mirror_patching_id ||
1289                      stub_id == Runtime1::load_appendix_patching_id, &quot;wrong stub id&quot;);
1290               oop_Relocation* r = mds.oop_reloc();
1291               oop* oop_adr = r-&gt;oop_addr();
1292               *oop_adr = stub_id == Runtime1::load_mirror_patching_id ? mirror() : appendix();
1293               r-&gt;fix_oop_relocation();
1294               found = true;
1295             } else if (mds.type() == relocInfo::metadata_type) {
1296               assert(stub_id == Runtime1::load_klass_patching_id, &quot;wrong stub id&quot;);
1297               metadata_Relocation* r = mds.metadata_reloc();
1298               Metadata** metadata_adr = r-&gt;metadata_addr();
1299               *metadata_adr = load_klass;
1300               r-&gt;fix_metadata_relocation();
1301               found = true;
1302             }
1303           }
1304           assert(found, &quot;the metadata must exist!&quot;);
1305         }
1306 #endif
1307         if (do_patch) {
1308           // replace instructions
1309           // first replace the tail, then the call
1310 #ifdef ARM
1311           if((load_klass_or_mirror_patch_id ||
1312               stub_id == Runtime1::load_appendix_patching_id) &amp;&amp;
1313               nativeMovConstReg_at(copy_buff)-&gt;is_pc_relative()) {
1314             nmethod* nm = CodeCache::find_nmethod(instr_pc);
1315             address addr = NULL;
1316             assert(nm != NULL, &quot;invalid nmethod_pc&quot;);
1317             RelocIterator mds(nm, copy_buff, copy_buff + 1);
1318             while (mds.next()) {
1319               if (mds.type() == relocInfo::oop_type) {
1320                 assert(stub_id == Runtime1::load_mirror_patching_id ||
1321                        stub_id == Runtime1::load_appendix_patching_id, &quot;wrong stub id&quot;);
1322                 oop_Relocation* r = mds.oop_reloc();
1323                 addr = (address)r-&gt;oop_addr();
1324                 break;
1325               } else if (mds.type() == relocInfo::metadata_type) {
1326                 assert(stub_id == Runtime1::load_klass_patching_id, &quot;wrong stub id&quot;);
1327                 metadata_Relocation* r = mds.metadata_reloc();
1328                 addr = (address)r-&gt;metadata_addr();
1329                 break;
1330               }
1331             }
1332             assert(addr != NULL, &quot;metadata relocation must exist&quot;);
1333             copy_buff -= *byte_count;
1334             NativeMovConstReg* n_copy2 = nativeMovConstReg_at(copy_buff);
1335             n_copy2-&gt;set_pc_relative_offset(addr, instr_pc);
1336           }
1337 #endif
1338 
1339           for (int i = NativeGeneralJump::instruction_size; i &lt; *byte_count; i++) {
1340             address ptr = copy_buff + i;
1341             int a_byte = (*ptr) &amp; 0xFF;
1342             address dst = instr_pc + i;
1343             *(unsigned char*)dst = (unsigned char) a_byte;
1344           }
1345           ICache::invalidate_range(instr_pc, *byte_count);
1346           NativeGeneralJump::replace_mt_safe(instr_pc, copy_buff);
1347 
1348           if (load_klass_or_mirror_patch_id ||
1349               stub_id == Runtime1::load_appendix_patching_id) {
1350             relocInfo::relocType rtype =
1351               (stub_id == Runtime1::load_klass_patching_id) ?
1352                                    relocInfo::metadata_type :
1353                                    relocInfo::oop_type;
1354             // update relocInfo to metadata
1355             nmethod* nm = CodeCache::find_nmethod(instr_pc);
1356             assert(nm != NULL, &quot;invalid nmethod_pc&quot;);
1357 
1358             // The old patch site is now a move instruction so update
1359             // the reloc info so that it will get updated during
1360             // future GCs.
1361             RelocIterator iter(nm, (address)instr_pc, (address)(instr_pc + 1));
1362             relocInfo::change_reloc_info_for_address(&amp;iter, (address) instr_pc,
1363                                                      relocInfo::none, rtype);
1364 #ifdef SPARC
1365             // Sparc takes two relocations for an metadata so update the second one.
1366             address instr_pc2 = instr_pc + NativeMovConstReg::add_offset;
1367             RelocIterator iter2(nm, instr_pc2, instr_pc2 + 1);
1368             relocInfo::change_reloc_info_for_address(&amp;iter2, (address) instr_pc2,
1369                                                      relocInfo::none, rtype);
1370 #endif
1371 #ifdef PPC32
1372           { address instr_pc2 = instr_pc + NativeMovConstReg::lo_offset;
1373             RelocIterator iter2(nm, instr_pc2, instr_pc2 + 1);
1374             relocInfo::change_reloc_info_for_address(&amp;iter2, (address) instr_pc2,
1375                                                      relocInfo::none, rtype);
1376           }
1377 #endif
1378           }
1379 
1380         } else {
1381           ICache::invalidate_range(copy_buff, *byte_count);
1382           NativeGeneralJump::insert_unconditional(instr_pc, being_initialized_entry);
1383         }
1384       }
1385     }
1386   }
1387 
1388   // If we are patching in a non-perm oop, make sure the nmethod
1389   // is on the right list.
1390   {
1391     MutexLocker ml_code (THREAD, CodeCache_lock, Mutex::_no_safepoint_check_flag);
1392     nmethod* nm = CodeCache::find_nmethod(caller_frame.pc());
1393     guarantee(nm != NULL, &quot;only nmethods can contain non-perm oops&quot;);
1394 
1395     // Since we&#39;ve patched some oops in the nmethod,
1396     // (re)register it with the heap.
1397     Universe::heap()-&gt;register_nmethod(nm);
1398   }
1399 JRT_END
1400 
1401 #else // DEOPTIMIZE_WHEN_PATCHING
1402 
1403 JRT_ENTRY(void, Runtime1::patch_code(JavaThread* thread, Runtime1::StubID stub_id ))
1404   RegisterMap reg_map(thread, false);
1405 
1406   NOT_PRODUCT(_patch_code_slowcase_cnt++;)
1407   if (TracePatching) {
1408     tty-&gt;print_cr(&quot;Deoptimizing because patch is needed&quot;);
1409   }
1410 
1411   frame runtime_frame = thread-&gt;last_frame();
1412   frame caller_frame = runtime_frame.sender(&amp;reg_map);
1413 
1414   // It&#39;s possible the nmethod was invalidated in the last
1415   // safepoint, but if it&#39;s still alive then make it not_entrant.
1416   nmethod* nm = CodeCache::find_nmethod(caller_frame.pc());
1417   if (nm != NULL) {
1418     nm-&gt;make_not_entrant();
1419   }
1420 
1421   Deoptimization::deoptimize_frame(thread, caller_frame.id());
1422 
1423   // Return to the now deoptimized frame.
1424 JRT_END
1425 
1426 #endif // DEOPTIMIZE_WHEN_PATCHING
1427 
1428 //
1429 // Entry point for compiled code. We want to patch a nmethod.
1430 // We don&#39;t do a normal VM transition here because we want to
1431 // know after the patching is complete and any safepoint(s) are taken
1432 // if the calling nmethod was deoptimized. We do this by calling a
1433 // helper method which does the normal VM transition and when it
1434 // completes we can check for deoptimization. This simplifies the
1435 // assembly code in the cpu directories.
1436 //
1437 int Runtime1::move_klass_patching(JavaThread* thread) {
1438 //
1439 // NOTE: we are still in Java
1440 //
1441   Thread* THREAD = thread;
1442   debug_only(NoHandleMark nhm;)
1443   {
1444     // Enter VM mode
1445 
1446     ResetNoHandleMark rnhm;
1447     patch_code(thread, load_klass_patching_id);
1448   }
1449   // Back in JAVA, use no oops DON&#39;T safepoint
1450 
1451   // Return true if calling code is deoptimized
1452 
1453   return caller_is_deopted();
1454 }
1455 
1456 int Runtime1::move_mirror_patching(JavaThread* thread) {
1457 //
1458 // NOTE: we are still in Java
1459 //
1460   Thread* THREAD = thread;
1461   debug_only(NoHandleMark nhm;)
1462   {
1463     // Enter VM mode
1464 
1465     ResetNoHandleMark rnhm;
1466     patch_code(thread, load_mirror_patching_id);
1467   }
1468   // Back in JAVA, use no oops DON&#39;T safepoint
1469 
1470   // Return true if calling code is deoptimized
1471 
1472   return caller_is_deopted();
1473 }
1474 
1475 int Runtime1::move_appendix_patching(JavaThread* thread) {
1476 //
1477 // NOTE: we are still in Java
1478 //
1479   Thread* THREAD = thread;
1480   debug_only(NoHandleMark nhm;)
1481   {
1482     // Enter VM mode
1483 
1484     ResetNoHandleMark rnhm;
1485     patch_code(thread, load_appendix_patching_id);
1486   }
1487   // Back in JAVA, use no oops DON&#39;T safepoint
1488 
1489   // Return true if calling code is deoptimized
1490 
1491   return caller_is_deopted();
1492 }
1493 //
1494 // Entry point for compiled code. We want to patch a nmethod.
1495 // We don&#39;t do a normal VM transition here because we want to
1496 // know after the patching is complete and any safepoint(s) are taken
1497 // if the calling nmethod was deoptimized. We do this by calling a
1498 // helper method which does the normal VM transition and when it
1499 // completes we can check for deoptimization. This simplifies the
1500 // assembly code in the cpu directories.
1501 //
1502 
1503 int Runtime1::access_field_patching(JavaThread* thread) {
1504 //
1505 // NOTE: we are still in Java
1506 //
1507   Thread* THREAD = thread;
1508   debug_only(NoHandleMark nhm;)
1509   {
1510     // Enter VM mode
1511 
1512     ResetNoHandleMark rnhm;
1513     patch_code(thread, access_field_patching_id);
1514   }
1515   // Back in JAVA, use no oops DON&#39;T safepoint
1516 
1517   // Return true if calling code is deoptimized
1518 
1519   return caller_is_deopted();
1520 JRT_END
1521 
1522 
1523 JRT_LEAF(void, Runtime1::trace_block_entry(jint block_id))
1524   // for now we just print out the block id
1525   tty-&gt;print(&quot;%d &quot;, block_id);
1526 JRT_END
1527 
1528 
1529 JRT_LEAF(int, Runtime1::is_instance_of(oopDesc* mirror, oopDesc* obj))
1530   // had to return int instead of bool, otherwise there may be a mismatch
1531   // between the C calling convention and the Java one.
1532   // e.g., on x86, GCC may clear only %al when returning a bool false, but
1533   // JVM takes the whole %eax as the return value, which may misinterpret
1534   // the return value as a boolean true.
1535 
1536   assert(mirror != NULL, &quot;should null-check on mirror before calling&quot;);
1537   Klass* k = java_lang_Class::as_Klass(mirror);
1538   return (k != NULL &amp;&amp; obj != NULL &amp;&amp; obj-&gt;is_a(k)) ? 1 : 0;
1539 JRT_END
1540 
1541 JRT_ENTRY(void, Runtime1::predicate_failed_trap(JavaThread* thread))
1542   ResourceMark rm;
1543 
1544   assert(!TieredCompilation, &quot;incompatible with tiered compilation&quot;);
1545 
1546   RegisterMap reg_map(thread, false);
1547   frame runtime_frame = thread-&gt;last_frame();
1548   frame caller_frame = runtime_frame.sender(&amp;reg_map);
1549 
1550   nmethod* nm = CodeCache::find_nmethod(caller_frame.pc());
1551   assert (nm != NULL, &quot;no more nmethod?&quot;);
1552   nm-&gt;make_not_entrant();
1553 
1554   methodHandle m(thread, nm-&gt;method());
1555   MethodData* mdo = m-&gt;method_data();
1556 
1557   if (mdo == NULL &amp;&amp; !HAS_PENDING_EXCEPTION) {
1558     // Build an MDO.  Ignore errors like OutOfMemory;
1559     // that simply means we won&#39;t have an MDO to update.
1560     Method::build_interpreter_method_data(m, THREAD);
1561     if (HAS_PENDING_EXCEPTION) {
1562       assert((PENDING_EXCEPTION-&gt;is_a(SystemDictionary::OutOfMemoryError_klass())), &quot;we expect only an OOM error here&quot;);
1563       CLEAR_PENDING_EXCEPTION;
1564     }
1565     mdo = m-&gt;method_data();
1566   }
1567 
1568   if (mdo != NULL) {
1569     mdo-&gt;inc_trap_count(Deoptimization::Reason_none);
1570   }
1571 
1572   if (TracePredicateFailedTraps) {
1573     stringStream ss1, ss2;
1574     vframeStream vfst(thread);
1575     Method* inlinee = vfst.method();
1576     inlinee-&gt;print_short_name(&amp;ss1);
1577     m-&gt;print_short_name(&amp;ss2);
1578     tty-&gt;print_cr(&quot;Predicate failed trap in method %s at bci %d inlined in %s at pc &quot; INTPTR_FORMAT, ss1.as_string(), vfst.bci(), ss2.as_string(), p2i(caller_frame.pc()));
1579   }
1580 
1581 
1582   Deoptimization::deoptimize_frame(thread, caller_frame.id());
1583 
1584 JRT_END
1585 
1586 #ifndef PRODUCT
1587 void Runtime1::print_statistics() {
1588   tty-&gt;print_cr(&quot;C1 Runtime statistics:&quot;);
1589   tty-&gt;print_cr(&quot; _resolve_invoke_virtual_cnt:     %d&quot;, SharedRuntime::_resolve_virtual_ctr);
1590   tty-&gt;print_cr(&quot; _resolve_invoke_opt_virtual_cnt: %d&quot;, SharedRuntime::_resolve_opt_virtual_ctr);
1591   tty-&gt;print_cr(&quot; _resolve_invoke_static_cnt:      %d&quot;, SharedRuntime::_resolve_static_ctr);
1592   tty-&gt;print_cr(&quot; _handle_wrong_method_cnt:        %d&quot;, SharedRuntime::_wrong_method_ctr);
1593   tty-&gt;print_cr(&quot; _ic_miss_cnt:                    %d&quot;, SharedRuntime::_ic_miss_ctr);
1594   tty-&gt;print_cr(&quot; _generic_arraycopy_cnt:          %d&quot;, _generic_arraycopy_cnt);
1595   tty-&gt;print_cr(&quot; _generic_arraycopystub_cnt:      %d&quot;, _generic_arraycopystub_cnt);
1596   tty-&gt;print_cr(&quot; _byte_arraycopy_cnt:             %d&quot;, _byte_arraycopy_stub_cnt);
1597   tty-&gt;print_cr(&quot; _short_arraycopy_cnt:            %d&quot;, _short_arraycopy_stub_cnt);
1598   tty-&gt;print_cr(&quot; _int_arraycopy_cnt:              %d&quot;, _int_arraycopy_stub_cnt);
1599   tty-&gt;print_cr(&quot; _long_arraycopy_cnt:             %d&quot;, _long_arraycopy_stub_cnt);
1600   tty-&gt;print_cr(&quot; _oop_arraycopy_cnt:              %d&quot;, _oop_arraycopy_stub_cnt);
1601   tty-&gt;print_cr(&quot; _arraycopy_slowcase_cnt:         %d&quot;, _arraycopy_slowcase_cnt);
1602   tty-&gt;print_cr(&quot; _arraycopy_checkcast_cnt:        %d&quot;, _arraycopy_checkcast_cnt);
1603   tty-&gt;print_cr(&quot; _arraycopy_checkcast_attempt_cnt:%d&quot;, _arraycopy_checkcast_attempt_cnt);
1604 
1605   tty-&gt;print_cr(&quot; _new_type_array_slowcase_cnt:    %d&quot;, _new_type_array_slowcase_cnt);
1606   tty-&gt;print_cr(&quot; _new_object_array_slowcase_cnt:  %d&quot;, _new_object_array_slowcase_cnt);
1607   tty-&gt;print_cr(&quot; _new_value_array_slowcase_cnt:   %d&quot;, _new_value_array_slowcase_cnt);
1608   tty-&gt;print_cr(&quot; _new_instance_slowcase_cnt:      %d&quot;, _new_instance_slowcase_cnt);
1609   tty-&gt;print_cr(&quot; _new_multi_array_slowcase_cnt:   %d&quot;, _new_multi_array_slowcase_cnt);
1610   tty-&gt;print_cr(&quot; _load_flattened_array_slowcase_cnt:   %d&quot;, _load_flattened_array_slowcase_cnt);
1611   tty-&gt;print_cr(&quot; _store_flattened_array_slowcase_cnt:  %d&quot;, _store_flattened_array_slowcase_cnt);
1612   tty-&gt;print_cr(&quot; _substitutability_check_slowcase_cnt: %d&quot;, _substitutability_check_slowcase_cnt);
1613   tty-&gt;print_cr(&quot; _buffer_value_args_slowcase_cnt:%d&quot;, _buffer_value_args_slowcase_cnt);
1614   tty-&gt;print_cr(&quot; _buffer_value_args_no_receiver_slowcase_cnt:%d&quot;, _buffer_value_args_no_receiver_slowcase_cnt);
1615 
1616   tty-&gt;print_cr(&quot; _monitorenter_slowcase_cnt:      %d&quot;, _monitorenter_slowcase_cnt);
1617   tty-&gt;print_cr(&quot; _monitorexit_slowcase_cnt:       %d&quot;, _monitorexit_slowcase_cnt);
1618   tty-&gt;print_cr(&quot; _patch_code_slowcase_cnt:        %d&quot;, _patch_code_slowcase_cnt);
1619 
1620   tty-&gt;print_cr(&quot; _throw_range_check_exception_count:            %d:&quot;, _throw_range_check_exception_count);
1621   tty-&gt;print_cr(&quot; _throw_index_exception_count:                  %d:&quot;, _throw_index_exception_count);
1622   tty-&gt;print_cr(&quot; _throw_div0_exception_count:                   %d:&quot;, _throw_div0_exception_count);
1623   tty-&gt;print_cr(&quot; _throw_null_pointer_exception_count:           %d:&quot;, _throw_null_pointer_exception_count);
1624   tty-&gt;print_cr(&quot; _throw_class_cast_exception_count:             %d:&quot;, _throw_class_cast_exception_count);
1625   tty-&gt;print_cr(&quot; _throw_incompatible_class_change_error_count:  %d:&quot;, _throw_incompatible_class_change_error_count);
1626   tty-&gt;print_cr(&quot; _throw_illegal_monitor_state_exception_count:  %d:&quot;, _throw_illegal_monitor_state_exception_count);
1627   tty-&gt;print_cr(&quot; _throw_array_store_exception_count:            %d:&quot;, _throw_array_store_exception_count);
1628   tty-&gt;print_cr(&quot; _throw_count:                                  %d:&quot;, _throw_count);
1629 
1630   SharedRuntime::print_ic_miss_histogram();
1631   tty-&gt;cr();
1632 }
1633 #endif // PRODUCT
    </pre>
  </body>
</html>