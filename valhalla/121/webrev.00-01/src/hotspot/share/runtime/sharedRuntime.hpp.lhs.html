<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames src/hotspot/share/runtime/sharedRuntime.hpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
    <script type="text/javascript" src="../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
  2  * Copyright (c) 1997, 2020, Oracle and/or its affiliates. All rights reserved.
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  *
 23  */
 24 
 25 #ifndef SHARE_RUNTIME_SHAREDRUNTIME_HPP
 26 #define SHARE_RUNTIME_SHAREDRUNTIME_HPP
 27 
 28 #include &quot;asm/codeBuffer.hpp&quot;
 29 #include &quot;interpreter/bytecodeHistogram.hpp&quot;
 30 #include &quot;interpreter/bytecodeTracer.hpp&quot;
 31 #include &quot;interpreter/linkResolver.hpp&quot;
 32 #include &quot;memory/allocation.hpp&quot;
 33 #include &quot;memory/resourceArea.hpp&quot;
 34 #include &quot;runtime/signature.hpp&quot;
 35 #include &quot;utilities/hashtable.hpp&quot;
 36 #include &quot;utilities/macros.hpp&quot;
 37 
 38 class AdapterHandlerEntry;
 39 class AdapterHandlerTable;
 40 class AdapterFingerPrint;
 41 class vframeStream;
 42 class SigEntry;
 43 
 44 // Runtime is the base class for various runtime interfaces
 45 // (InterpreterRuntime, CompilerRuntime, etc.). It provides
 46 // shared functionality such as exception forwarding (C++ to
 47 // Java exceptions), locking/unlocking mechanisms, statistical
 48 // information, etc.
 49 
 50 class SharedRuntime: AllStatic {
 51   friend class VMStructs;
 52 
 53  private:
 54   static bool resolve_sub_helper_internal(methodHandle callee_method, const frame&amp; caller_frame,
 55                                           CompiledMethod* caller_nm, bool is_virtual, bool is_optimized,
 56                                           Handle receiver, CallInfo&amp; call_info, Bytecodes::Code invoke_code, TRAPS);
 57   static methodHandle resolve_sub_helper(JavaThread *thread,
 58                                          bool is_virtual,
 59                                          bool is_optimized,
 60                                          bool* caller_is_c1, TRAPS);
 61 
 62   // Shared stub locations
 63 
 64   static RuntimeStub*        _wrong_method_blob;
 65   static RuntimeStub*        _wrong_method_abstract_blob;
 66   static RuntimeStub*        _ic_miss_blob;
 67   static RuntimeStub*        _resolve_opt_virtual_call_blob;
 68   static RuntimeStub*        _resolve_virtual_call_blob;
 69   static RuntimeStub*        _resolve_static_call_blob;
 70 
 71   static DeoptimizationBlob* _deopt_blob;
 72 
 73   static SafepointBlob*      _polling_page_vectors_safepoint_handler_blob;
 74   static SafepointBlob*      _polling_page_safepoint_handler_blob;
 75   static SafepointBlob*      _polling_page_return_handler_blob;
 76 
 77 #ifdef COMPILER2
 78   static UncommonTrapBlob*   _uncommon_trap_blob;
 79 #endif // COMPILER2
 80 
 81 #ifndef PRODUCT
 82   // Counters
 83   static int     _nof_megamorphic_calls;         // total # of megamorphic calls (through vtable)
 84 #endif // !PRODUCT
 85 
 86  private:
 87   enum { POLL_AT_RETURN,  POLL_AT_LOOP, POLL_AT_VECTOR_LOOP };
 88   static SafepointBlob* generate_handler_blob(address call_ptr, int poll_type);
 89   static RuntimeStub*   generate_resolve_blob(address destination, const char* name);
 90  public:
 91   static void generate_stubs(void);
 92 
 93   // max bytes for each dtrace string parameter
 94   enum { max_dtrace_string_size = 256 };
 95 
 96   // The following arithmetic routines are used on platforms that do
 97   // not have machine instructions to implement their functionality.
 98   // Do not remove these.
 99 
100   // long arithmetics
101   static jlong   lmul(jlong y, jlong x);
102   static jlong   ldiv(jlong y, jlong x);
103   static jlong   lrem(jlong y, jlong x);
104 
105   // float and double remainder
106   static jfloat  frem(jfloat  x, jfloat  y);
107   static jdouble drem(jdouble x, jdouble y);
108 
109 
110 #ifdef _WIN64
111   // Workaround for fmod issue in the Windows x64 CRT
112   static double fmod_winx64(double x, double y);
113 #endif
114 
115 #ifdef __SOFTFP__
116   static jfloat  fadd(jfloat x, jfloat y);
117   static jfloat  fsub(jfloat x, jfloat y);
118   static jfloat  fmul(jfloat x, jfloat y);
119   static jfloat  fdiv(jfloat x, jfloat y);
120 
121   static jdouble dadd(jdouble x, jdouble y);
122   static jdouble dsub(jdouble x, jdouble y);
123   static jdouble dmul(jdouble x, jdouble y);
124   static jdouble ddiv(jdouble x, jdouble y);
125 #endif // __SOFTFP__
126 
127   // float conversion (needs to set appropriate rounding mode)
128   static jint    f2i (jfloat  x);
129   static jlong   f2l (jfloat  x);
130   static jint    d2i (jdouble x);
131   static jlong   d2l (jdouble x);
132   static jfloat  d2f (jdouble x);
133   static jfloat  l2f (jlong   x);
134   static jdouble l2d (jlong   x);
135 
136 #ifdef __SOFTFP__
137   static jfloat  i2f (jint    x);
138   static jdouble i2d (jint    x);
139   static jdouble f2d (jfloat  x);
140 #endif // __SOFTFP__
141 
142   // double trigonometrics and transcendentals
143   static jdouble dsin(jdouble x);
144   static jdouble dcos(jdouble x);
145   static jdouble dtan(jdouble x);
146   static jdouble dlog(jdouble x);
147   static jdouble dlog10(jdouble x);
148   static jdouble dexp(jdouble x);
149   static jdouble dpow(jdouble x, jdouble y);
150 
151 #if defined(__SOFTFP__) || defined(E500V2)
152   static double dabs(double f);
153 #endif
154 
155 #if defined(__SOFTFP__) || defined(PPC)
156   static double dsqrt(double f);
157 #endif
158 
159   // Montgomery multiplication
160   static void montgomery_multiply(jint *a_ints, jint *b_ints, jint *n_ints,
161                                   jint len, jlong inv, jint *m_ints);
162   static void montgomery_square(jint *a_ints, jint *n_ints,
163                                 jint len, jlong inv, jint *m_ints);
164 
165 #ifdef __SOFTFP__
166   // C++ compiler generates soft float instructions as well as passing
167   // float and double in registers.
168   static int  fcmpl(float x, float y);
169   static int  fcmpg(float x, float y);
170   static int  dcmpl(double x, double y);
171   static int  dcmpg(double x, double y);
172 
173   static int unordered_fcmplt(float x, float y);
174   static int unordered_dcmplt(double x, double y);
175   static int unordered_fcmple(float x, float y);
176   static int unordered_dcmple(double x, double y);
177   static int unordered_fcmpge(float x, float y);
178   static int unordered_dcmpge(double x, double y);
179   static int unordered_fcmpgt(float x, float y);
180   static int unordered_dcmpgt(double x, double y);
181 
182   static float  fneg(float f);
183   static double dneg(double f);
184 #endif
185 
186   // exception handling across interpreter/compiler boundaries
187   static address raw_exception_handler_for_return_address(JavaThread* thread, address return_address);
188   static address exception_handler_for_return_address(JavaThread* thread, address return_address);
189 
190   // exception handling and implicit exceptions
191   static address compute_compiled_exc_handler(CompiledMethod* nm, address ret_pc, Handle&amp; exception,
192                                               bool force_unwind, bool top_frame_only, bool&amp; recursive_exception_occurred);
193   enum ImplicitExceptionKind {
194     IMPLICIT_NULL,
195     IMPLICIT_DIVIDE_BY_ZERO,
196     STACK_OVERFLOW
197   };
198   static void    throw_AbstractMethodError(JavaThread* thread);
199   static void    throw_IncompatibleClassChangeError(JavaThread* thread);
200   static void    throw_ArithmeticException(JavaThread* thread);
201   static void    throw_NullPointerException(JavaThread* thread);
202   static void    throw_NullPointerException_at_call(JavaThread* thread);
203   static void    throw_StackOverflowError(JavaThread* thread);
204   static void    throw_delayed_StackOverflowError(JavaThread* thread);
205   static void    throw_StackOverflowError_common(JavaThread* thread, bool delayed);
206   static address continuation_for_implicit_exception(JavaThread* thread,
207                                                      address faulting_pc,
208                                                      ImplicitExceptionKind exception_kind);
209 
210   // Post-slow-path-allocation, pre-initializing-stores step for
211   // implementing e.g. ReduceInitialCardMarks
212   static void on_slowpath_allocation_exit(JavaThread* thread);
213 
214   static void enable_stack_reserved_zone(JavaThread* thread);
215   static frame look_for_reserved_stack_annotated_method(JavaThread* thread, frame fr);
216 
217   // Shared stub locations
218   static address get_poll_stub(address pc);
219 
220   static address get_ic_miss_stub() {
221     assert(_ic_miss_blob!= NULL, &quot;oops&quot;);
222     return _ic_miss_blob-&gt;entry_point();
223   }
224 
225   static address get_handle_wrong_method_stub() {
226     assert(_wrong_method_blob!= NULL, &quot;oops&quot;);
227     return _wrong_method_blob-&gt;entry_point();
228   }
229 
230   static address get_handle_wrong_method_abstract_stub() {
231     assert(_wrong_method_abstract_blob!= NULL, &quot;oops&quot;);
232     return _wrong_method_abstract_blob-&gt;entry_point();
233   }
234 
235 #ifdef COMPILER2
236   static void generate_uncommon_trap_blob(void);
237   static UncommonTrapBlob* uncommon_trap_blob()                  { return _uncommon_trap_blob; }
238 #endif // COMPILER2
239 
240   static address get_resolve_opt_virtual_call_stub() {
241     assert(_resolve_opt_virtual_call_blob != NULL, &quot;oops&quot;);
242     return _resolve_opt_virtual_call_blob-&gt;entry_point();
243   }
244   static address get_resolve_virtual_call_stub() {
245     assert(_resolve_virtual_call_blob != NULL, &quot;oops&quot;);
246     return _resolve_virtual_call_blob-&gt;entry_point();
247   }
248   static address get_resolve_static_call_stub() {
249     assert(_resolve_static_call_blob != NULL, &quot;oops&quot;);
250     return _resolve_static_call_blob-&gt;entry_point();
251   }
252 
253   static SafepointBlob* polling_page_return_handler_blob()     { return _polling_page_return_handler_blob; }
254   static SafepointBlob* polling_page_safepoint_handler_blob()  { return _polling_page_safepoint_handler_blob; }
255   static SafepointBlob* polling_page_vectors_safepoint_handler_blob()  { return _polling_page_vectors_safepoint_handler_blob; }
256 
257   // Counters
258 #ifndef PRODUCT
259   static address nof_megamorphic_calls_addr() { return (address)&amp;_nof_megamorphic_calls; }
260 #endif // PRODUCT
261 
262   // Helper routine for full-speed JVMTI exception throwing support
263   static void throw_and_post_jvmti_exception(JavaThread *thread, Handle h_exception);
264   static void throw_and_post_jvmti_exception(JavaThread *thread, Symbol* name, const char *message = NULL);
265 
266   // RedefineClasses() tracing support for obsolete method entry
267   static int rc_trace_method_entry(JavaThread* thread, Method* m);
268 
269   // To be used as the entry point for unresolved native methods.
270   static address native_method_throw_unsatisfied_link_error_entry();
271   static address native_method_throw_unsupported_operation_exception_entry();
272 
273   static oop retrieve_receiver(Symbol* sig, frame caller);
274 
275   static void register_finalizer(JavaThread* thread, oopDesc* obj);
276 
277   // dtrace notifications
278   static int dtrace_object_alloc(oopDesc* o, int size);
279   static int dtrace_object_alloc_base(Thread* thread, oopDesc* o, int size);
280   static int dtrace_method_entry(JavaThread* thread, Method* m);
281   static int dtrace_method_exit(JavaThread* thread, Method* m);
282 
283   // Utility method for retrieving the Java thread id, returns 0 if the
284   // thread is not a well formed Java thread.
285   static jlong get_java_tid(Thread* thread);
286 
287 
288   // used by native wrappers to reenable yellow if overflow happened in native code
289   static void reguard_yellow_pages();
290 
291   // Fill in the &quot;X cannot be cast to a Y&quot; message for ClassCastException
292   //
293   // @param thr the current thread
294   // @param caster_klass the class of the object we are casting
295   // @return the dynamically allocated exception message (must be freed
296   // by the caller using a resource mark)
297   //
298   // BCP must refer to the current &#39;checkcast&#39; opcode for the frame
299   // on top of the stack.
300   // The caller (or one of its callers) must use a ResourceMark
301   // in order to correctly free the result.
302   //
303   static char* generate_class_cast_message(JavaThread* thr, Klass* caster_klass);
304 
305   // Fill in the &quot;X cannot be cast to a Y&quot; message for ClassCastException
306   //
307   // @param caster_klass the class of the object we are casting
308   // @param target_klass the target klass attempt
309   // @return the dynamically allocated exception message (must be freed
310   // by the caller using a resource mark)
311   //
312   // This version does not require access the frame, so it can be called
313   // from interpreted code
314   // The caller (or one of it&#39;s callers) must use a ResourceMark
315   // in order to correctly free the result.
316   //
317   static char* generate_class_cast_message(Klass* caster_klass, Klass* target_klass, Symbol* target_klass_name = NULL);
318 
319   // Resolves a call site- may patch in the destination of the call into the
320   // compiled code.
321   static methodHandle resolve_helper(JavaThread *thread,
322                                      bool is_virtual,
323                                      bool is_optimized,
324                                      bool* caller_is_c1, TRAPS);
325 
326  private:
327   // deopt blob
328   static void generate_deopt_blob(void);
329 
330   static bool handle_ic_miss_helper_internal(Handle receiver, CompiledMethod* caller_nm, const frame&amp; caller_frame,
331                                              methodHandle callee_method, Bytecodes::Code bc, CallInfo&amp; call_info,
332                                              bool&amp; needs_ic_stub_refill, bool&amp; is_optimized, bool caller_is_c1, TRAPS);
333 
334  public:
335   static DeoptimizationBlob* deopt_blob(void)      { return _deopt_blob; }
336 
337   // Resets a call-site in compiled code so it will get resolved again.
338   static methodHandle reresolve_call_site(JavaThread *thread, bool&amp; is_static_call, bool&amp; is_optimized, bool&amp; caller_is_c1, TRAPS);
339 
340   // In the code prolog, if the klass comparison fails, the inline cache
341   // misses and the call site is patched to megamorphic
342   static methodHandle handle_ic_miss_helper(JavaThread* thread, bool&amp; is_optimized, bool&amp; caller_is_c1, TRAPS);
343 
344   // Find the method that called us.
345   static methodHandle find_callee_method(JavaThread* thread, TRAPS);
346 
347   static void monitor_enter_helper(oopDesc* obj, BasicLock* lock, JavaThread* thread);
348 
349   static void monitor_exit_helper(oopDesc* obj, BasicLock* lock, JavaThread* thread);
350 
351   static address entry_for_handle_wrong_method(methodHandle callee_method, bool is_static_call, bool is_optimized, bool caller_is_c1) {
352     assert(callee_method-&gt;verified_code_entry() != NULL, &quot;Jump to zero!&quot;);
353     assert(callee_method-&gt;verified_inline_code_entry() != NULL, &quot;Jump to zero!&quot;);
354     assert(callee_method-&gt;verified_inline_ro_code_entry() != NULL, &quot;Jump to zero!&quot;);
355     if (caller_is_c1) {
356       return callee_method-&gt;verified_inline_code_entry();
357     } else if (is_static_call || is_optimized) {
358       return callee_method-&gt;verified_code_entry();
359     } else {
360       return callee_method-&gt;verified_inline_ro_code_entry();
361     }
362   }
363 
364  private:
365   static Handle find_callee_info(JavaThread* thread,
366                                  Bytecodes::Code&amp; bc,
367                                  CallInfo&amp; callinfo, TRAPS);
368   static Handle find_callee_info_helper(JavaThread* thread,
369                                         vframeStream&amp; vfst,
370                                         Bytecodes::Code&amp; bc,
371                                         CallInfo&amp; callinfo, TRAPS);
372 
373   static Method* extract_attached_method(vframeStream&amp; vfst);
374 
375 #if defined(X86) &amp;&amp; defined(COMPILER1)
376   // For Object.hashCode, System.identityHashCode try to pull hashCode from object header if available.
377   static void inline_check_hashcode_from_object_header(MacroAssembler* masm, const methodHandle&amp; method, Register obj_reg, Register result);
378 #endif // X86 &amp;&amp; COMPILER1
379 
380  public:
381 
382   // Read the array of BasicTypes from a Java signature, and compute where
383   // compiled Java code would like to put the results.  Values in reg_lo and
384   // reg_hi refer to 4-byte quantities.  Values less than SharedInfo::stack0 are
385   // registers, those above refer to 4-byte stack slots.  All stack slots are
386   // based off of the window top.  SharedInfo::stack0 refers to the first usable
387   // slot in the bottom of the frame. SharedInfo::stack0+1 refers to the memory word
388   // 4-bytes higher. So for sparc because the register window save area is at
389   // the bottom of the frame the first 16 words will be skipped and SharedInfo::stack0
390   // will be just above it. (
391   // return value is the maximum number of VMReg stack slots the convention will use.
392   static int java_calling_convention(const BasicType* sig_bt, VMRegPair* regs, int total_args_passed, int is_outgoing);
393   static int java_calling_convention(const GrowableArray&lt;SigEntry&gt;* sig, VMRegPair* regs) {
394     BasicType* sig_bt = NEW_RESOURCE_ARRAY(BasicType, sig-&gt;length());
395     int total_args_passed = SigEntry::fill_sig_bt(sig, sig_bt);
396     return java_calling_convention(sig_bt, regs, total_args_passed, false);
397   }
398   static int java_return_convention(const BasicType* sig_bt, VMRegPair* regs, int total_args_passed);
399   static const uint java_return_convention_max_int;
400   static const uint java_return_convention_max_float;
401 
402   static void check_member_name_argument_is_last_argument(const methodHandle&amp; method,
403                                                           const BasicType* sig_bt,
404                                                           const VMRegPair* regs) NOT_DEBUG_RETURN;
405 
406   // Ditto except for calling C
407   //
408   // C argument in register AND stack slot.
409   // Some architectures require that an argument must be passed in a register
410   // AND in a stack slot. These architectures provide a second VMRegPair array
411   // to be filled by the c_calling_convention method. On other architectures,
412   // NULL is being passed as the second VMRegPair array, so arguments are either
413   // passed in a register OR in a stack slot.
414   static int c_calling_convention(const BasicType *sig_bt, VMRegPair *regs, VMRegPair *regs2,
415                                   int total_args_passed);
416 
417   static size_t trampoline_size();
418 
419   static void generate_trampoline(MacroAssembler *masm, address destination);
420 
421   // Generate I2C and C2I adapters. These adapters are simple argument marshalling
422   // blobs. Unlike adapters in the tiger and earlier releases the code in these
423   // blobs does not create a new frame and are therefore virtually invisible
424   // to the stack walking code. In general these blobs extend the callers stack
425   // as needed for the conversion of argument locations.
426 
427   // When calling a c2i blob the code will always call the interpreter even if
428   // by the time we reach the blob there is compiled code available. This allows
429   // the blob to pass the incoming stack pointer (the sender sp) in a known
430   // location for the interpreter to record. This is used by the frame code
431   // to correct the sender code to match up with the stack pointer when the
432   // thread left the compiled code. In addition it allows the interpreter
433   // to remove the space the c2i adapter allocated to do its argument conversion.
434 
435   // Although a c2i blob will always run interpreted even if compiled code is
436   // present if we see that compiled code is present the compiled call site
437   // will be patched/re-resolved so that later calls will run compiled.
438 
439   // Additionally a c2i blob need to have a unverified entry because it can be reached
440   // in situations where the call site is an inlined cache site and may go megamorphic.
441 
442   // A i2c adapter is simpler than the c2i adapter. This is because it is assumed
443   // that the interpreter before it does any call dispatch will record the current
444   // stack pointer in the interpreter frame. On return it will restore the stack
445   // pointer as needed. This means the i2c adapter code doesn&#39;t need any special
446   // handshaking path with compiled code to keep the stack walking correct.
447 
448   static AdapterHandlerEntry* generate_i2c2i_adapters(MacroAssembler *masm,
449                                                       int comp_args_on_stack,
450                                                       const GrowableArray&lt;SigEntry&gt;* sig,
451                                                       const VMRegPair* regs,
452                                                       const GrowableArray&lt;SigEntry&gt;* sig_cc,
453                                                       const VMRegPair* regs_cc,
454                                                       const GrowableArray&lt;SigEntry&gt;* sig_cc_ro,
455                                                       const VMRegPair* regs_cc_ro,
456                                                       AdapterFingerPrint* fingerprint,
457                                                       AdapterBlob*&amp; new_adapter);
458 
459   static void gen_i2c_adapter(MacroAssembler *_masm,
460                               int comp_args_on_stack,
461                               const GrowableArray&lt;SigEntry&gt;* sig,
462                               const VMRegPair *regs);
463 
464   // OSR support
465 
466   // OSR_migration_begin will extract the jvm state from an interpreter
467   // frame (locals, monitors) and store the data in a piece of C heap
468   // storage. This then allows the interpreter frame to be removed from the
469   // stack and the OSR nmethod to be called. That method is called with a
470   // pointer to the C heap storage. This pointer is the return value from
471   // OSR_migration_begin.
472 
473   static intptr_t* OSR_migration_begin(JavaThread *thread);
474 
475   // OSR_migration_end is a trivial routine. It is called after the compiled
476   // method has extracted the jvm state from the C heap that OSR_migration_begin
477   // created. It&#39;s entire job is to simply free this storage.
478   static void OSR_migration_end(intptr_t* buf);
479 
480   // Convert a sig into a calling convention register layout
481   // and find interesting things about it.
482   static VMRegPair* find_callee_arguments(Symbol* sig, bool has_receiver, bool has_appendix, int *arg_size);
483   static VMReg name_for_receiver();
484 
485   // &quot;Top of Stack&quot; slots that may be unused by the calling convention but must
486   // otherwise be preserved.
487   // On Intel these are not necessary and the value can be zero.
488   // On Sparc this describes the words reserved for storing a register window
489   // when an interrupt occurs.
490   static uint out_preserve_stack_slots();
491 
492   // Is vector&#39;s size (in bytes) bigger than a size saved by default?
493   // For example, on x86 16 bytes XMM registers are saved by default.
494   static bool is_wide_vector(int size);
495 
496   // Save and restore a native result
497   static void    save_native_result(MacroAssembler *_masm, BasicType ret_type, int frame_slots);
498   static void restore_native_result(MacroAssembler *_masm, BasicType ret_type, int frame_slots);
499 
500   // Generate a native wrapper for a given method.  The method takes arguments
501   // in the Java compiled code convention, marshals them to the native
502   // convention (handlizes oops, etc), transitions to native, makes the call,
503   // returns to java state (possibly blocking), unhandlizes any result and
504   // returns.
505   //
506   // The wrapper may contain special-case code if the given method
507   // is a JNI critical method, or a compiled method handle adapter,
508   // such as _invokeBasic, _linkToVirtual, etc.
509   static nmethod* generate_native_wrapper(MacroAssembler* masm,
510                                           const methodHandle&amp; method,
511                                           int compile_id,
512                                           BasicType* sig_bt,
513                                           VMRegPair* regs,
514                                           BasicType ret_type,
515                                           address critical_entry);
516 
517   // Block before entering a JNI critical method
518   static void block_for_jni_critical(JavaThread* thread);
519 
520   // Pin/Unpin object
521   static oopDesc* pin_object(JavaThread* thread, oopDesc* obj);
522   static void unpin_object(JavaThread* thread, oopDesc* obj);
523 
524   // A compiled caller has just called the interpreter, but compiled code
525   // exists.  Patch the caller so he no longer calls into the interpreter.
526   static void fixup_callers_callsite(Method* moop, address ret_pc);
527   static bool should_fixup_call_destination(address destination, address entry_point, address caller_pc, Method* moop, CodeBlob* cb);
528 
529   // Slow-path Locking and Unlocking
530   static void complete_monitor_locking_C(oopDesc* obj, BasicLock* lock, JavaThread* thread);
531   static void complete_monitor_unlocking_C(oopDesc* obj, BasicLock* lock, JavaThread* thread);
532 
533   // Resolving of calls
534   static address resolve_static_call_C     (JavaThread *thread);
535   static address resolve_virtual_call_C    (JavaThread *thread);
536   static address resolve_opt_virtual_call_C(JavaThread *thread);
537 
538   static void load_inline_type_fields_in_regs(JavaThread *thread, oopDesc* res);
539   static void store_inline_type_fields_to_buf(JavaThread *thread, intptr_t res);
540 
541   // arraycopy, the non-leaf version.  (See StubRoutines for all the leaf calls.)
542   static void slow_arraycopy_C(oopDesc* src,  jint src_pos,
543                                oopDesc* dest, jint dest_pos,
544                                jint length, JavaThread* thread);
545 
546   // handle ic miss with caller being compiled code
547   // wrong method handling (inline cache misses, zombie methods)
548   static address handle_wrong_method(JavaThread* thread);
549   static address handle_wrong_method_abstract(JavaThread* thread);
550   static address handle_wrong_method_ic_miss(JavaThread* thread);
551   static void allocate_inline_types(JavaThread* thread, Method* callee, bool allocate_receiver);
552   static oop allocate_inline_types_impl(JavaThread* thread, methodHandle callee, bool allocate_receiver, TRAPS);
553   static void apply_post_barriers(JavaThread* thread, objArrayOopDesc* array);
554 
555   static address handle_unsafe_access(JavaThread* thread, address next_pc);
556 
557   static BufferedInlineTypeBlob* generate_buffered_inline_type_adapter(const InlineKlass* vk);
558 #ifndef PRODUCT
559 
560   // Collect and print inline cache miss statistics
561  private:
562   enum { maxICmiss_count = 100 };
563   static int     _ICmiss_index;                  // length of IC miss histogram
564   static int     _ICmiss_count[maxICmiss_count]; // miss counts
565   static address _ICmiss_at[maxICmiss_count];    // miss addresses
566   static void trace_ic_miss(address at);
567 
568  public:
569   static int _throw_null_ctr;                    // throwing a null-pointer exception
570   static int _ic_miss_ctr;                       // total # of IC misses
571   static int _wrong_method_ctr;
572   static int _resolve_static_ctr;
573   static int _resolve_virtual_ctr;
574   static int _resolve_opt_virtual_ctr;
575   static int _implicit_null_throws;
576   static int _implicit_div0_throws;
577 
578   static int _jbyte_array_copy_ctr;        // Slow-path byte array copy
579   static int _jshort_array_copy_ctr;       // Slow-path short array copy
580   static int _jint_array_copy_ctr;         // Slow-path int array copy
581   static int _jlong_array_copy_ctr;        // Slow-path long array copy
582   static int _oop_array_copy_ctr;          // Slow-path oop array copy
583   static int _checkcast_array_copy_ctr;    // Slow-path oop array copy, with cast
584   static int _unsafe_array_copy_ctr;       // Slow-path includes alignment checks
585   static int _generic_array_copy_ctr;      // Slow-path includes type decoding
586   static int _slow_array_copy_ctr;         // Slow-path failed out to a method call
587 
588   static int _new_instance_ctr;            // &#39;new&#39; object requires GC
589   static int _new_array_ctr;               // &#39;new&#39; array requires GC
590   static int _multi1_ctr, _multi2_ctr, _multi3_ctr, _multi4_ctr, _multi5_ctr;
591   static int _find_handler_ctr;            // find exception handler
592   static int _rethrow_ctr;                 // rethrow exception
593   static int _mon_enter_stub_ctr;          // monitor enter stub
594   static int _mon_exit_stub_ctr;           // monitor exit stub
595   static int _mon_enter_ctr;               // monitor enter slow
596   static int _mon_exit_ctr;                // monitor exit slow
597   static int _partial_subtype_ctr;         // SubRoutines::partial_subtype_check
598 
599   // Statistics code
600   // stats for &quot;normal&quot; compiled calls (non-interface)
601   static int     _nof_normal_calls;              // total # of calls
602   static int     _nof_optimized_calls;           // total # of statically-bound calls
603   static int     _nof_inlined_calls;             // total # of inlined normal calls
604   static int     _nof_static_calls;              // total # of calls to static methods or super methods (invokespecial)
605   static int     _nof_inlined_static_calls;      // total # of inlined static calls
606   // stats for compiled interface calls
607   static int     _nof_interface_calls;           // total # of compiled calls
608   static int     _nof_optimized_interface_calls; // total # of statically-bound interface calls
609   static int     _nof_inlined_interface_calls;   // total # of inlined interface calls
610   static int     _nof_megamorphic_interface_calls;// total # of megamorphic interface calls
611   // stats for runtime exceptions
612   static int     _nof_removable_exceptions;      // total # of exceptions that could be replaced by branches due to inlining
613 
614  public: // for compiler
615   static address nof_normal_calls_addr()                { return (address)&amp;_nof_normal_calls; }
616   static address nof_optimized_calls_addr()             { return (address)&amp;_nof_optimized_calls; }
617   static address nof_inlined_calls_addr()               { return (address)&amp;_nof_inlined_calls; }
618   static address nof_static_calls_addr()                { return (address)&amp;_nof_static_calls; }
619   static address nof_inlined_static_calls_addr()        { return (address)&amp;_nof_inlined_static_calls; }
620   static address nof_interface_calls_addr()             { return (address)&amp;_nof_interface_calls; }
621   static address nof_optimized_interface_calls_addr()   { return (address)&amp;_nof_optimized_interface_calls; }
622   static address nof_inlined_interface_calls_addr()     { return (address)&amp;_nof_inlined_interface_calls; }
623   static address nof_megamorphic_interface_calls_addr() { return (address)&amp;_nof_megamorphic_interface_calls; }
624   static void print_call_statistics(int comp_total);
625   static void print_statistics();
626   static void print_ic_miss_histogram();
627 
628 #endif // PRODUCT
629 };
630 
631 
632 // ---------------------------------------------------------------------------
633 // Implementation of AdapterHandlerLibrary
634 //
635 // This library manages argument marshaling adapters and native wrappers.
636 // There are 2 flavors of adapters: I2C and C2I.
637 //
638 // The I2C flavor takes a stock interpreted call setup, marshals the
639 // arguments for a Java-compiled call, and jumps to Rmethod-&gt; code()-&gt;
640 // code_begin().  It is broken to call it without an nmethod assigned.
641 // The usual behavior is to lift any register arguments up out of the
642 // stack and possibly re-pack the extra arguments to be contiguous.
643 // I2C adapters will save what the interpreter&#39;s stack pointer will be
644 // after arguments are popped, then adjust the interpreter&#39;s frame
645 // size to force alignment and possibly to repack the arguments.
646 // After re-packing, it jumps to the compiled code start.  There are
647 // no safepoints in this adapter code and a GC cannot happen while
648 // marshaling is in progress.
649 //
650 // The C2I flavor takes a stock compiled call setup plus the target method in
651 // Rmethod, marshals the arguments for an interpreted call and jumps to
652 // Rmethod-&gt;_i2i_entry.  On entry, the interpreted frame has not yet been
653 // setup.  Compiled frames are fixed-size and the args are likely not in the
654 // right place.  Hence all the args will likely be copied into the
655 // interpreter&#39;s frame, forcing that frame to grow.  The compiled frame&#39;s
656 // outgoing stack args will be dead after the copy.
657 //
658 // Native wrappers, like adapters, marshal arguments.  Unlike adapters they
659 // also perform an official frame push &amp; pop.  They have a call to the native
660 // routine in their middles and end in a return (instead of ending in a jump).
661 // The native wrappers are stored in real nmethods instead of the BufferBlobs
662 // used by the adapters.  The code generation happens here because it&#39;s very
663 // similar to what the adapters have to do.
664 
665 class AdapterHandlerEntry : public BasicHashtableEntry&lt;mtCode&gt; {
666   friend class AdapterHandlerTable;
667 
668  private:
669   AdapterFingerPrint* _fingerprint;
670   address _i2c_entry;
671   address _c2i_entry;
672   address _c2i_inline_entry;
673   address _c2i_inline_ro_entry;
674   address _c2i_unverified_entry;
675   address _c2i_unverified_inline_entry;
676   address _c2i_no_clinit_check_entry;
677 
678   // Support for scalarized inline type calling convention
679   const GrowableArray&lt;SigEntry&gt;* _sig_cc;
680 
681 #ifdef ASSERT
682   // Captures code and signature used to generate this adapter when
683   // verifying adapter equivalence.
684   unsigned char* _saved_code;
685   int            _saved_code_length;
686 #endif
687 
688   void init(AdapterFingerPrint* fingerprint, address i2c_entry, address c2i_entry, address c2i_inline_entry,
689             address c2i_inline_ro_entry, address c2i_unverified_entry, address c2i_unverified_inline_entry, address c2i_no_clinit_check_entry) {
690     _fingerprint = fingerprint;
691     _i2c_entry = i2c_entry;
692     _c2i_entry = c2i_entry;
693     _c2i_inline_entry = c2i_inline_entry;
694     _c2i_inline_ro_entry = c2i_inline_ro_entry;
695     _c2i_unverified_entry = c2i_unverified_entry;
696     _c2i_unverified_inline_entry = c2i_unverified_inline_entry;
697     _c2i_no_clinit_check_entry = c2i_no_clinit_check_entry;
698     _sig_cc = NULL;
699 #ifdef ASSERT
700     _saved_code = NULL;
701     _saved_code_length = 0;
702 #endif
703   }
704 
705   void deallocate();
706 
707   // should never be used
708   AdapterHandlerEntry();
709 
710  public:
711   address get_i2c_entry()                  const { return _i2c_entry; }
712   address get_c2i_entry()                  const { return _c2i_entry; }
713   address get_c2i_inline_entry()            const { return _c2i_inline_entry; }
714   address get_c2i_inline_ro_entry()         const { return _c2i_inline_ro_entry; }
715   address get_c2i_unverified_entry()       const { return _c2i_unverified_entry; }
716   address get_c2i_unverified_inline_entry() const { return _c2i_unverified_inline_entry; }
717   address get_c2i_no_clinit_check_entry()  const { return _c2i_no_clinit_check_entry; }
718 
719   address base_address();
720   void relocate(address new_base);
721 
722   // Support for scalarized inline type calling convention
723   void set_sig_cc(const GrowableArray&lt;SigEntry&gt;* sig)  { _sig_cc = sig; }
724   const GrowableArray&lt;SigEntry&gt;* get_sig_cc()    const { return _sig_cc; }
725 
726   AdapterFingerPrint* fingerprint() const { return _fingerprint; }
727 
728   AdapterHandlerEntry* next() {
729     return (AdapterHandlerEntry*)BasicHashtableEntry&lt;mtCode&gt;::next();
730   }
731 
732 #ifdef ASSERT
733   // Used to verify that code generated for shared adapters is equivalent
734   void save_code   (unsigned char* code, int length);
735   bool compare_code(unsigned char* code, int length);
736 #endif
737 
738   //virtual void print_on(outputStream* st) const;  DO NOT USE
739   void print_adapter_on(outputStream* st) const;
740 };
741 
742 // This class is used only with DumpSharedSpaces==true. It holds extra information
743 // that&#39;s used only during CDS dump time.
744 // For details, see comments around Method::link_method()
745 class CDSAdapterHandlerEntry: public AdapterHandlerEntry {
746   address               _c2i_entry_trampoline;           // allocated from shared spaces &quot;MC&quot; region
<a name="1" id="anc1"></a><span class="line-modified">747   address               _c2i_inline_ro_entry_trampoline;  // allocated from shared spaces &quot;MC&quot; region</span>
<span class="line-modified">748   address               _c2i_inline_entry_trampoline;     // allocated from shared spaces &quot;MC&quot; region</span>
749   AdapterHandlerEntry** _adapter_trampoline;             // allocated from shared spaces &quot;MD&quot; region
750 
751 public:
752   address get_c2i_entry_trampoline()             const { return _c2i_entry_trampoline; }
<a name="2" id="anc2"></a><span class="line-modified">753   address get_c2i_inline_ro_entry_trampoline()    const { return _c2i_inline_ro_entry_trampoline; }</span>
<span class="line-modified">754   address get_c2i_inline_entry_trampoline()       const { return _c2i_inline_entry_trampoline; }</span>
755   AdapterHandlerEntry** get_adapter_trampoline() const { return _adapter_trampoline; }
756   void init() NOT_CDS_RETURN;
757 };
758 
759 
760 class AdapterHandlerLibrary: public AllStatic {
761  private:
762   static BufferBlob* _buffer; // the temporary code buffer in CodeCache
763   static AdapterHandlerTable* _adapters;
764   static AdapterHandlerEntry* _abstract_method_handler;
765   static BufferBlob* buffer_blob();
766   static void initialize();
767   static AdapterHandlerEntry* get_adapter0(const methodHandle&amp; method);
768 
769  public:
770 
771   static AdapterHandlerEntry* new_entry(AdapterFingerPrint* fingerprint,
772                                         address i2c_entry, address c2i_entry, address c2i_inline_entry, address c2i_inline_ro_entry,
773                                         address c2i_unverified_entry, address c2i_unverified_inline_entry, address c2i_no_clinit_check_entry = NULL);
774   static void create_native_wrapper(const methodHandle&amp; method);
775   static AdapterHandlerEntry* get_adapter(const methodHandle&amp; method);
776 
777   static void print_handler(const CodeBlob* b) { print_handler_on(tty, b); }
778   static void print_handler_on(outputStream* st, const CodeBlob* b);
779   static bool contains(const CodeBlob* b);
780 #ifndef PRODUCT
781   static void print_statistics();
782 #endif // PRODUCT
783 
784 };
785 
786 // Utility class for computing the calling convention of the 3 types
787 // of compiled method entries:
788 //     Method::_from_compiled_entry               - sig_cc
<a name="3" id="anc3"></a><span class="line-modified">789 //     Method::_from_compiled_inline_ro_entry      - sig_cc_ro</span>
<span class="line-modified">790 //     Method::_from_compiled_inline_entry         - sig</span>
791 class CompiledEntrySignature : public StackObj {
792   Method* _method;
793   int  _num_inline_args;
794   bool _has_inline_recv;
795   GrowableArray&lt;SigEntry&gt; *_sig;
796   GrowableArray&lt;SigEntry&gt; *_sig_cc;
797   GrowableArray&lt;SigEntry&gt; *_sig_cc_ro;
798   VMRegPair* _regs;
799   VMRegPair* _regs_cc;
800   VMRegPair* _regs_cc_ro;
801 
802   int _args_on_stack;
803   int _args_on_stack_cc;
804   int _args_on_stack_cc_ro;
805 
806   bool _c1_needs_stack_repair;
807   bool _c2_needs_stack_repair;
808   bool _has_scalarized_args;
809   bool _has_reserved_entries;
810 
811 public:
812   Method* method()                     const { return _method; }
813 
814   // Used by Method::_from_compiled_inline_entry
815   GrowableArray&lt;SigEntry&gt;&amp; sig()       const { return *_sig; }
816 
817   // Used by Method::_from_compiled_entry
818   GrowableArray&lt;SigEntry&gt;&amp; sig_cc()    const { return *_sig_cc; }
819 
820   // Used by Method::_from_compiled_inline_ro_entry
821   GrowableArray&lt;SigEntry&gt;&amp; sig_cc_ro() const { return *_sig_cc_ro; }
822 
823   VMRegPair* regs()                    const { return _regs; }
824   VMRegPair* regs_cc()                 const { return _regs_cc; }
825   VMRegPair* regs_cc_ro()              const { return _regs_cc_ro; }
826 
827   int args_on_stack()                  const { return _args_on_stack; }
828   int args_on_stack_cc()               const { return _args_on_stack_cc; }
829   int args_on_stack_cc_ro()            const { return _args_on_stack_cc_ro; }
830 
831   int  num_inline_args()               const { return _num_inline_args; }
<a name="4" id="anc4"></a><span class="line-modified">832   bool has_inline_arg()                const { return _num_inline_args &gt; 0;  }</span>
833   bool has_inline_recv()               const { return _has_inline_recv; }
834 
835   bool has_scalarized_args()           const { return _has_scalarized_args; }
836   bool c1_needs_stack_repair()         const { return _c1_needs_stack_repair; }
837   bool c2_needs_stack_repair()         const { return _c2_needs_stack_repair; }
838   CodeOffsets::Entries c1_inline_ro_entry_type() const;
839 
840   CompiledEntrySignature(Method* method);
841   void compute_calling_conventions();
842 
843 private:
844   int compute_scalarized_cc(GrowableArray&lt;SigEntry&gt;*&amp; sig_cc, VMRegPair*&amp; regs_cc, bool scalar_receiver);
845   int insert_reserved_entry(int ret_off);
846 };
847 
848 #endif // SHARE_RUNTIME_SHAREDRUNTIME_HPP
<a name="5" id="anc5"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="5" type="hidden" />
</body>
</html>