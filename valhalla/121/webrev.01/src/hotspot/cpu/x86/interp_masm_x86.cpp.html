<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>New src/hotspot/cpu/x86/interp_masm_x86.cpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
  </head>
  <body>
    <pre>
   1 /*
   2  * Copyright (c) 1997, 2020, Oracle and/or its affiliates. All rights reserved.
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.
   8  *
   9  * This code is distributed in the hope that it will be useful, but WITHOUT
  10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  *
  23  */
  24 
  25 #include &quot;precompiled.hpp&quot;
  26 #include &quot;interp_masm_x86.hpp&quot;
  27 #include &quot;interpreter/interpreter.hpp&quot;
  28 #include &quot;interpreter/interpreterRuntime.hpp&quot;
  29 #include &quot;logging/log.hpp&quot;
  30 #include &quot;oops/arrayOop.hpp&quot;
  31 #include &quot;oops/markWord.hpp&quot;
  32 #include &quot;oops/methodData.hpp&quot;
  33 #include &quot;oops/method.hpp&quot;
  34 #include &quot;oops/inlineKlass.hpp&quot;
  35 #include &quot;prims/jvmtiExport.hpp&quot;
  36 #include &quot;prims/jvmtiThreadState.hpp&quot;
  37 #include &quot;runtime/basicLock.hpp&quot;
  38 #include &quot;runtime/biasedLocking.hpp&quot;
  39 #include &quot;runtime/frame.inline.hpp&quot;
  40 #include &quot;runtime/safepointMechanism.hpp&quot;
  41 #include &quot;runtime/sharedRuntime.hpp&quot;
  42 #include &quot;runtime/thread.inline.hpp&quot;
  43 #include &quot;utilities/powerOfTwo.hpp&quot;
  44 
  45 // Implementation of InterpreterMacroAssembler
  46 
  47 void InterpreterMacroAssembler::jump_to_entry(address entry) {
  48   assert(entry, &quot;Entry must have been generated by now&quot;);
  49   jump(RuntimeAddress(entry));
  50 }
  51 
  52 void InterpreterMacroAssembler::profile_obj_type(Register obj, const Address&amp; mdo_addr) {
  53   Label update, next, none;
  54 
  55   interp_verify_oop(obj, atos);
  56 
  57   testptr(obj, obj);
  58   jccb(Assembler::notZero, update);
  59   orptr(mdo_addr, TypeEntries::null_seen);
  60   jmpb(next);
  61 
  62   bind(update);
  63   Register tmp_load_klass = LP64_ONLY(rscratch1) NOT_LP64(noreg);
  64   load_klass(obj, obj, tmp_load_klass);
  65 
  66   xorptr(obj, mdo_addr);
  67   testptr(obj, TypeEntries::type_klass_mask);
  68   jccb(Assembler::zero, next); // klass seen before, nothing to
  69                                // do. The unknown bit may have been
  70                                // set already but no need to check.
  71 
  72   testptr(obj, TypeEntries::type_unknown);
  73   jccb(Assembler::notZero, next); // already unknown. Nothing to do anymore.
  74 
  75   cmpptr(mdo_addr, 0);
  76   jccb(Assembler::equal, none);
  77   cmpptr(mdo_addr, TypeEntries::null_seen);
  78   jccb(Assembler::equal, none);
  79   // There is a chance that the checks above (re-reading profiling
  80   // data from memory) fail if another thread has just set the
  81   // profiling to this obj&#39;s klass
  82   xorptr(obj, mdo_addr);
  83   testptr(obj, TypeEntries::type_klass_mask);
  84   jccb(Assembler::zero, next);
  85 
  86   // different than before. Cannot keep accurate profile.
  87   orptr(mdo_addr, TypeEntries::type_unknown);
  88   jmpb(next);
  89 
  90   bind(none);
  91   // first time here. Set profile type.
  92   movptr(mdo_addr, obj);
  93 
  94   bind(next);
  95 }
  96 
  97 void InterpreterMacroAssembler::profile_arguments_type(Register mdp, Register callee, Register tmp, bool is_virtual) {
  98   if (!ProfileInterpreter) {
  99     return;
 100   }
 101 
 102   if (MethodData::profile_arguments() || MethodData::profile_return()) {
 103     Label profile_continue;
 104 
 105     test_method_data_pointer(mdp, profile_continue);
 106 
 107     int off_to_start = is_virtual ? in_bytes(VirtualCallData::virtual_call_data_size()) : in_bytes(CounterData::counter_data_size());
 108 
 109     cmpb(Address(mdp, in_bytes(DataLayout::tag_offset()) - off_to_start), is_virtual ? DataLayout::virtual_call_type_data_tag : DataLayout::call_type_data_tag);
 110     jcc(Assembler::notEqual, profile_continue);
 111 
 112     if (MethodData::profile_arguments()) {
 113       Label done;
 114       int off_to_args = in_bytes(TypeEntriesAtCall::args_data_offset());
 115       addptr(mdp, off_to_args);
 116 
 117       for (int i = 0; i &lt; TypeProfileArgsLimit; i++) {
 118         if (i &gt; 0 || MethodData::profile_return()) {
 119           // If return value type is profiled we may have no argument to profile
 120           movptr(tmp, Address(mdp, in_bytes(TypeEntriesAtCall::cell_count_offset())-off_to_args));
 121           subl(tmp, i*TypeStackSlotEntries::per_arg_count());
 122           cmpl(tmp, TypeStackSlotEntries::per_arg_count());
 123           jcc(Assembler::less, done);
 124         }
 125         movptr(tmp, Address(callee, Method::const_offset()));
 126         load_unsigned_short(tmp, Address(tmp, ConstMethod::size_of_parameters_offset()));
 127         // stack offset o (zero based) from the start of the argument
 128         // list, for n arguments translates into offset n - o - 1 from
 129         // the end of the argument list
 130         subptr(tmp, Address(mdp, in_bytes(TypeEntriesAtCall::stack_slot_offset(i))-off_to_args));
 131         subl(tmp, 1);
 132         Address arg_addr = argument_address(tmp);
 133         movptr(tmp, arg_addr);
 134 
 135         Address mdo_arg_addr(mdp, in_bytes(TypeEntriesAtCall::argument_type_offset(i))-off_to_args);
 136         profile_obj_type(tmp, mdo_arg_addr);
 137 
 138         int to_add = in_bytes(TypeStackSlotEntries::per_arg_size());
 139         addptr(mdp, to_add);
 140         off_to_args += to_add;
 141       }
 142 
 143       if (MethodData::profile_return()) {
 144         movptr(tmp, Address(mdp, in_bytes(TypeEntriesAtCall::cell_count_offset())-off_to_args));
 145         subl(tmp, TypeProfileArgsLimit*TypeStackSlotEntries::per_arg_count());
 146       }
 147 
 148       bind(done);
 149 
 150       if (MethodData::profile_return()) {
 151         // We&#39;re right after the type profile for the last
 152         // argument. tmp is the number of cells left in the
 153         // CallTypeData/VirtualCallTypeData to reach its end. Non null
 154         // if there&#39;s a return to profile.
 155         assert(SingleTypeEntry::static_cell_count() &lt; TypeStackSlotEntries::per_arg_count(), &quot;can&#39;t move past ret type&quot;);
 156         shll(tmp, exact_log2(DataLayout::cell_size));
 157         addptr(mdp, tmp);
 158       }
 159       movptr(Address(rbp, frame::interpreter_frame_mdp_offset * wordSize), mdp);
 160     } else {
 161       assert(MethodData::profile_return(), &quot;either profile call args or call ret&quot;);
 162       update_mdp_by_constant(mdp, in_bytes(TypeEntriesAtCall::return_only_size()));
 163     }
 164 
 165     // mdp points right after the end of the
 166     // CallTypeData/VirtualCallTypeData, right after the cells for the
 167     // return value type if there&#39;s one
 168 
 169     bind(profile_continue);
 170   }
 171 }
 172 
 173 void InterpreterMacroAssembler::profile_return_type(Register mdp, Register ret, Register tmp) {
 174   assert_different_registers(mdp, ret, tmp, _bcp_register);
 175   if (ProfileInterpreter &amp;&amp; MethodData::profile_return()) {
 176     Label profile_continue;
 177 
 178     test_method_data_pointer(mdp, profile_continue);
 179 
 180     if (MethodData::profile_return_jsr292_only()) {
 181       assert(Method::intrinsic_id_size_in_bytes() == 2, &quot;assuming Method::_intrinsic_id is u2&quot;);
 182 
 183       // If we don&#39;t profile all invoke bytecodes we must make sure
 184       // it&#39;s a bytecode we indeed profile. We can&#39;t go back to the
 185       // begining of the ProfileData we intend to update to check its
 186       // type because we&#39;re right after it and we don&#39;t known its
 187       // length
 188       Label do_profile;
 189       cmpb(Address(_bcp_register, 0), Bytecodes::_invokedynamic);
 190       jcc(Assembler::equal, do_profile);
 191       cmpb(Address(_bcp_register, 0), Bytecodes::_invokehandle);
 192       jcc(Assembler::equal, do_profile);
 193       get_method(tmp);
 194       cmpw(Address(tmp, Method::intrinsic_id_offset_in_bytes()), vmIntrinsics::_compiledLambdaForm);
 195       jcc(Assembler::notEqual, profile_continue);
 196 
 197       bind(do_profile);
 198     }
 199 
 200     Address mdo_ret_addr(mdp, -in_bytes(SingleTypeEntry::size()));
 201     mov(tmp, ret);
 202     profile_obj_type(tmp, mdo_ret_addr);
 203 
 204     bind(profile_continue);
 205   }
 206 }
 207 
 208 void InterpreterMacroAssembler::profile_parameters_type(Register mdp, Register tmp1, Register tmp2) {
 209   if (ProfileInterpreter &amp;&amp; MethodData::profile_parameters()) {
 210     Label profile_continue;
 211 
 212     test_method_data_pointer(mdp, profile_continue);
 213 
 214     // Load the offset of the area within the MDO used for
 215     // parameters. If it&#39;s negative we&#39;re not profiling any parameters
 216     movl(tmp1, Address(mdp, in_bytes(MethodData::parameters_type_data_di_offset()) - in_bytes(MethodData::data_offset())));
 217     testl(tmp1, tmp1);
 218     jcc(Assembler::negative, profile_continue);
 219 
 220     // Compute a pointer to the area for parameters from the offset
 221     // and move the pointer to the slot for the last
 222     // parameters. Collect profiling from last parameter down.
 223     // mdo start + parameters offset + array length - 1
 224     addptr(mdp, tmp1);
 225     movptr(tmp1, Address(mdp, ArrayData::array_len_offset()));
 226     decrement(tmp1, TypeStackSlotEntries::per_arg_count());
 227 
 228     Label loop;
 229     bind(loop);
 230 
 231     int off_base = in_bytes(ParametersTypeData::stack_slot_offset(0));
 232     int type_base = in_bytes(ParametersTypeData::type_offset(0));
 233     Address::ScaleFactor per_arg_scale = Address::times(DataLayout::cell_size);
 234     Address arg_off(mdp, tmp1, per_arg_scale, off_base);
 235     Address arg_type(mdp, tmp1, per_arg_scale, type_base);
 236 
 237     // load offset on the stack from the slot for this parameter
 238     movptr(tmp2, arg_off);
 239     negptr(tmp2);
 240     // read the parameter from the local area
 241     movptr(tmp2, Address(_locals_register, tmp2, Interpreter::stackElementScale()));
 242 
 243     // profile the parameter
 244     profile_obj_type(tmp2, arg_type);
 245 
 246     // go to next parameter
 247     decrement(tmp1, TypeStackSlotEntries::per_arg_count());
 248     jcc(Assembler::positive, loop);
 249 
 250     bind(profile_continue);
 251   }
 252 }
 253 
 254 void InterpreterMacroAssembler::call_VM_leaf_base(address entry_point,
 255                                                   int number_of_arguments) {
 256   // interpreter specific
 257   //
 258   // Note: No need to save/restore bcp &amp; locals registers
 259   //       since these are callee saved registers and no blocking/
 260   //       GC can happen in leaf calls.
 261   // Further Note: DO NOT save/restore bcp/locals. If a caller has
 262   // already saved them so that it can use rsi/rdi as temporaries
 263   // then a save/restore here will DESTROY the copy the caller
 264   // saved! There used to be a save_bcp() that only happened in
 265   // the ASSERT path (no restore_bcp). Which caused bizarre failures
 266   // when jvm built with ASSERTs.
 267 #ifdef ASSERT
 268   {
 269     Label L;
 270     cmpptr(Address(rbp, frame::interpreter_frame_last_sp_offset * wordSize), (int32_t)NULL_WORD);
 271     jcc(Assembler::equal, L);
 272     stop(&quot;InterpreterMacroAssembler::call_VM_leaf_base:&quot;
 273          &quot; last_sp != NULL&quot;);
 274     bind(L);
 275   }
 276 #endif
 277   // super call
 278   MacroAssembler::call_VM_leaf_base(entry_point, number_of_arguments);
 279   // interpreter specific
 280   // LP64: Used to ASSERT that r13/r14 were equal to frame&#39;s bcp/locals
 281   // but since they may not have been saved (and we don&#39;t want to
 282   // save them here (see note above) the assert is invalid.
 283 }
 284 
 285 void InterpreterMacroAssembler::call_VM_base(Register oop_result,
 286                                              Register java_thread,
 287                                              Register last_java_sp,
 288                                              address  entry_point,
 289                                              int      number_of_arguments,
 290                                              bool     check_exceptions) {
 291   // interpreter specific
 292   //
 293   // Note: Could avoid restoring locals ptr (callee saved) - however doesn&#39;t
 294   //       really make a difference for these runtime calls, since they are
 295   //       slow anyway. Btw., bcp must be saved/restored since it may change
 296   //       due to GC.
 297   NOT_LP64(assert(java_thread == noreg , &quot;not expecting a precomputed java thread&quot;);)
 298   save_bcp();
 299 #ifdef ASSERT
 300   {
 301     Label L;
 302     cmpptr(Address(rbp, frame::interpreter_frame_last_sp_offset * wordSize), (int32_t)NULL_WORD);
 303     jcc(Assembler::equal, L);
 304     stop(&quot;InterpreterMacroAssembler::call_VM_base:&quot;
 305          &quot; last_sp != NULL&quot;);
 306     bind(L);
 307   }
 308 #endif /* ASSERT */
 309   // super call
 310   MacroAssembler::call_VM_base(oop_result, noreg, last_java_sp,
 311                                entry_point, number_of_arguments,
 312                                check_exceptions);
 313   // interpreter specific
 314   restore_bcp();
 315   restore_locals();
 316 }
 317 
 318 void InterpreterMacroAssembler::check_and_handle_popframe(Register java_thread) {
 319   if (JvmtiExport::can_pop_frame()) {
 320     Label L;
 321     // Initiate popframe handling only if it is not already being
 322     // processed.  If the flag has the popframe_processing bit set, it
 323     // means that this code is called *during* popframe handling - we
 324     // don&#39;t want to reenter.
 325     // This method is only called just after the call into the vm in
 326     // call_VM_base, so the arg registers are available.
 327     Register pop_cond = NOT_LP64(java_thread) // Not clear if any other register is available on 32 bit
 328                         LP64_ONLY(c_rarg0);
 329     movl(pop_cond, Address(java_thread, JavaThread::popframe_condition_offset()));
 330     testl(pop_cond, JavaThread::popframe_pending_bit);
 331     jcc(Assembler::zero, L);
 332     testl(pop_cond, JavaThread::popframe_processing_bit);
 333     jcc(Assembler::notZero, L);
 334     // Call Interpreter::remove_activation_preserving_args_entry() to get the
 335     // address of the same-named entrypoint in the generated interpreter code.
 336     call_VM_leaf(CAST_FROM_FN_PTR(address, Interpreter::remove_activation_preserving_args_entry));
 337     jmp(rax);
 338     bind(L);
 339     NOT_LP64(get_thread(java_thread);)
 340   }
 341 }
 342 
 343 void InterpreterMacroAssembler::load_earlyret_value(TosState state) {
 344   Register thread = LP64_ONLY(r15_thread) NOT_LP64(rcx);
 345   NOT_LP64(get_thread(thread);)
 346   movptr(rcx, Address(thread, JavaThread::jvmti_thread_state_offset()));
 347   const Address tos_addr(rcx, JvmtiThreadState::earlyret_tos_offset());
 348   const Address oop_addr(rcx, JvmtiThreadState::earlyret_oop_offset());
 349   const Address val_addr(rcx, JvmtiThreadState::earlyret_value_offset());
 350 #ifdef _LP64
 351   switch (state) {
 352     case atos: movptr(rax, oop_addr);
 353                movptr(oop_addr, (int32_t)NULL_WORD);
 354                interp_verify_oop(rax, state);         break;
 355     case ltos: movptr(rax, val_addr);                 break;
 356     case btos:                                   // fall through
 357     case ztos:                                   // fall through
 358     case ctos:                                   // fall through
 359     case stos:                                   // fall through
 360     case itos: movl(rax, val_addr);                 break;
 361     case ftos: load_float(val_addr);                break;
 362     case dtos: load_double(val_addr);               break;
 363     case vtos: /* nothing to do */                  break;
 364     default  : ShouldNotReachHere();
 365   }
 366   // Clean up tos value in the thread object
 367   movl(tos_addr,  (int) ilgl);
 368   movl(val_addr,  (int32_t) NULL_WORD);
 369 #else
 370   const Address val_addr1(rcx, JvmtiThreadState::earlyret_value_offset()
 371                              + in_ByteSize(wordSize));
 372   switch (state) {
 373     case atos: movptr(rax, oop_addr);
 374                movptr(oop_addr, NULL_WORD);
 375                interp_verify_oop(rax, state);         break;
 376     case ltos:
 377                movl(rdx, val_addr1);               // fall through
 378     case btos:                                     // fall through
 379     case ztos:                                     // fall through
 380     case ctos:                                     // fall through
 381     case stos:                                     // fall through
 382     case itos: movl(rax, val_addr);                   break;
 383     case ftos: load_float(val_addr);                  break;
 384     case dtos: load_double(val_addr);                 break;
 385     case vtos: /* nothing to do */                    break;
 386     default  : ShouldNotReachHere();
 387   }
 388 #endif // _LP64
 389   // Clean up tos value in the thread object
 390   movl(tos_addr,  (int32_t) ilgl);
 391   movptr(val_addr,  NULL_WORD);
 392   NOT_LP64(movptr(val_addr1, NULL_WORD);)
 393 }
 394 
 395 
 396 void InterpreterMacroAssembler::check_and_handle_earlyret(Register java_thread) {
 397   if (JvmtiExport::can_force_early_return()) {
 398     Label L;
 399     Register tmp = LP64_ONLY(c_rarg0) NOT_LP64(java_thread);
 400     Register rthread = LP64_ONLY(r15_thread) NOT_LP64(java_thread);
 401 
 402     movptr(tmp, Address(rthread, JavaThread::jvmti_thread_state_offset()));
 403     testptr(tmp, tmp);
 404     jcc(Assembler::zero, L); // if (thread-&gt;jvmti_thread_state() == NULL) exit;
 405 
 406     // Initiate earlyret handling only if it is not already being processed.
 407     // If the flag has the earlyret_processing bit set, it means that this code
 408     // is called *during* earlyret handling - we don&#39;t want to reenter.
 409     movl(tmp, Address(tmp, JvmtiThreadState::earlyret_state_offset()));
 410     cmpl(tmp, JvmtiThreadState::earlyret_pending);
 411     jcc(Assembler::notEqual, L);
 412 
 413     // Call Interpreter::remove_activation_early_entry() to get the address of the
 414     // same-named entrypoint in the generated interpreter code.
 415     NOT_LP64(get_thread(java_thread);)
 416     movptr(tmp, Address(rthread, JavaThread::jvmti_thread_state_offset()));
 417 #ifdef _LP64
 418     movl(tmp, Address(tmp, JvmtiThreadState::earlyret_tos_offset()));
 419     call_VM_leaf(CAST_FROM_FN_PTR(address, Interpreter::remove_activation_early_entry), tmp);
 420 #else
 421     pushl(Address(tmp, JvmtiThreadState::earlyret_tos_offset()));
 422     call_VM_leaf(CAST_FROM_FN_PTR(address, Interpreter::remove_activation_early_entry), 1);
 423 #endif // _LP64
 424     jmp(rax);
 425     bind(L);
 426     NOT_LP64(get_thread(java_thread);)
 427   }
 428 }
 429 
 430 void InterpreterMacroAssembler::get_unsigned_2_byte_index_at_bcp(Register reg, int bcp_offset) {
 431   assert(bcp_offset &gt;= 0, &quot;bcp is still pointing to start of bytecode&quot;);
 432   load_unsigned_short(reg, Address(_bcp_register, bcp_offset));
 433   bswapl(reg);
 434   shrl(reg, 16);
 435 }
 436 
 437 void InterpreterMacroAssembler::get_cache_index_at_bcp(Register index,
 438                                                        int bcp_offset,
 439                                                        size_t index_size) {
 440   assert(bcp_offset &gt; 0, &quot;bcp is still pointing to start of bytecode&quot;);
 441   if (index_size == sizeof(u2)) {
 442     load_unsigned_short(index, Address(_bcp_register, bcp_offset));
 443   } else if (index_size == sizeof(u4)) {
 444     movl(index, Address(_bcp_register, bcp_offset));
 445     // Check if the secondary index definition is still ~x, otherwise
 446     // we have to change the following assembler code to calculate the
 447     // plain index.
 448     assert(ConstantPool::decode_invokedynamic_index(~123) == 123, &quot;else change next line&quot;);
 449     notl(index);  // convert to plain index
 450   } else if (index_size == sizeof(u1)) {
 451     load_unsigned_byte(index, Address(_bcp_register, bcp_offset));
 452   } else {
 453     ShouldNotReachHere();
 454   }
 455 }
 456 
 457 void InterpreterMacroAssembler::get_cache_and_index_at_bcp(Register cache,
 458                                                            Register index,
 459                                                            int bcp_offset,
 460                                                            size_t index_size) {
 461   assert_different_registers(cache, index);
 462   get_cache_index_at_bcp(index, bcp_offset, index_size);
 463   movptr(cache, Address(rbp, frame::interpreter_frame_cache_offset * wordSize));
 464   assert(sizeof(ConstantPoolCacheEntry) == 4 * wordSize, &quot;adjust code below&quot;);
 465   // convert from field index to ConstantPoolCacheEntry index
 466   assert(exact_log2(in_words(ConstantPoolCacheEntry::size())) == 2, &quot;else change next line&quot;);
 467   shll(index, 2);
 468 }
 469 
 470 void InterpreterMacroAssembler::get_cache_and_index_and_bytecode_at_bcp(Register cache,
 471                                                                         Register index,
 472                                                                         Register bytecode,
 473                                                                         int byte_no,
 474                                                                         int bcp_offset,
 475                                                                         size_t index_size) {
 476   get_cache_and_index_at_bcp(cache, index, bcp_offset, index_size);
 477   // We use a 32-bit load here since the layout of 64-bit words on
 478   // little-endian machines allow us that.
 479   movl(bytecode, Address(cache, index, Address::times_ptr, ConstantPoolCache::base_offset() + ConstantPoolCacheEntry::indices_offset()));
 480   const int shift_count = (1 + byte_no) * BitsPerByte;
 481   assert((byte_no == TemplateTable::f1_byte &amp;&amp; shift_count == ConstantPoolCacheEntry::bytecode_1_shift) ||
 482          (byte_no == TemplateTable::f2_byte &amp;&amp; shift_count == ConstantPoolCacheEntry::bytecode_2_shift),
 483          &quot;correct shift count&quot;);
 484   shrl(bytecode, shift_count);
 485   assert(ConstantPoolCacheEntry::bytecode_1_mask == ConstantPoolCacheEntry::bytecode_2_mask, &quot;common mask&quot;);
 486   andl(bytecode, ConstantPoolCacheEntry::bytecode_1_mask);
 487 }
 488 
 489 void InterpreterMacroAssembler::get_cache_entry_pointer_at_bcp(Register cache,
 490                                                                Register tmp,
 491                                                                int bcp_offset,
 492                                                                size_t index_size) {
 493   assert_different_registers(cache, tmp);
 494 
 495   get_cache_index_at_bcp(tmp, bcp_offset, index_size);
 496   assert(sizeof(ConstantPoolCacheEntry) == 4 * wordSize, &quot;adjust code below&quot;);
 497   // convert from field index to ConstantPoolCacheEntry index
 498   // and from word offset to byte offset
 499   assert(exact_log2(in_bytes(ConstantPoolCacheEntry::size_in_bytes())) == 2 + LogBytesPerWord, &quot;else change next line&quot;);
 500   shll(tmp, 2 + LogBytesPerWord);
 501   movptr(cache, Address(rbp, frame::interpreter_frame_cache_offset * wordSize));
 502   // skip past the header
 503   addptr(cache, in_bytes(ConstantPoolCache::base_offset()));
 504   addptr(cache, tmp);  // construct pointer to cache entry
 505 }
 506 
 507 // Load object from cpool-&gt;resolved_references(index)
 508 void InterpreterMacroAssembler::load_resolved_reference_at_index(Register result,
 509                                                                  Register index,
 510                                                                  Register tmp) {
 511   assert_different_registers(result, index);
 512 
 513   get_constant_pool(result);
 514   // load pointer for resolved_references[] objArray
 515   movptr(result, Address(result, ConstantPool::cache_offset_in_bytes()));
 516   movptr(result, Address(result, ConstantPoolCache::resolved_references_offset_in_bytes()));
 517   resolve_oop_handle(result, tmp);
 518   load_heap_oop(result, Address(result, index,
 519                                 UseCompressedOops ? Address::times_4 : Address::times_ptr,
 520                                 arrayOopDesc::base_offset_in_bytes(T_OBJECT)), tmp);
 521 }
 522 
 523 // load cpool-&gt;resolved_klass_at(index)
 524 void InterpreterMacroAssembler::load_resolved_klass_at_index(Register klass,
 525                                                              Register cpool,
 526                                                              Register index) {
 527   assert_different_registers(cpool, index);
 528 
 529   movw(index, Address(cpool, index, Address::times_ptr, sizeof(ConstantPool)));
 530   Register resolved_klasses = cpool;
 531   movptr(resolved_klasses, Address(cpool, ConstantPool::resolved_klasses_offset_in_bytes()));
 532   movptr(klass, Address(resolved_klasses, index, Address::times_ptr, Array&lt;Klass*&gt;::base_offset_in_bytes()));
 533 }
 534 
 535 void InterpreterMacroAssembler::load_resolved_method_at_index(int byte_no,
 536                                                               Register method,
 537                                                               Register cache,
 538                                                               Register index) {
 539   assert_different_registers(cache, index);
 540 
 541   const int method_offset = in_bytes(
 542     ConstantPoolCache::base_offset() +
 543       ((byte_no == TemplateTable::f2_byte)
 544        ? ConstantPoolCacheEntry::f2_offset()
 545        : ConstantPoolCacheEntry::f1_offset()));
 546 
 547   movptr(method, Address(cache, index, Address::times_ptr, method_offset)); // get f1 Method*
 548 }
 549 
 550 // Generate a subtype check: branch to ok_is_subtype if sub_klass is a
 551 // subtype of super_klass.
 552 //
 553 // Args:
 554 //      rax: superklass
 555 //      Rsub_klass: subklass
 556 //
 557 // Kills:
 558 //      rcx, rdi
 559 void InterpreterMacroAssembler::gen_subtype_check(Register Rsub_klass,
 560                                                   Label&amp; ok_is_subtype,
 561                                                   bool profile) {
 562   assert(Rsub_klass != rax, &quot;rax holds superklass&quot;);
 563   LP64_ONLY(assert(Rsub_klass != r14, &quot;r14 holds locals&quot;);)
 564   LP64_ONLY(assert(Rsub_klass != r13, &quot;r13 holds bcp&quot;);)
 565   assert(Rsub_klass != rcx, &quot;rcx holds 2ndary super array length&quot;);
 566   assert(Rsub_klass != rdi, &quot;rdi holds 2ndary super array scan ptr&quot;);
 567 
 568   // Profile the not-null value&#39;s klass.
 569   if (profile) {
 570     profile_typecheck(rcx, Rsub_klass, rdi); // blows rcx, reloads rdi
 571   }
 572 
 573   // Do the check.
 574   check_klass_subtype(Rsub_klass, rax, rcx, ok_is_subtype); // blows rcx
 575 
 576   // Profile the failure of the check.
 577   if (profile) {
 578     profile_typecheck_failed(rcx); // blows rcx
 579   }
 580 }
 581 
 582 
 583 #ifndef _LP64
 584 void InterpreterMacroAssembler::f2ieee() {
 585   if (IEEEPrecision) {
 586     fstp_s(Address(rsp, 0));
 587     fld_s(Address(rsp, 0));
 588   }
 589 }
 590 
 591 
 592 void InterpreterMacroAssembler::d2ieee() {
 593   if (IEEEPrecision) {
 594     fstp_d(Address(rsp, 0));
 595     fld_d(Address(rsp, 0));
 596   }
 597 }
 598 #endif // _LP64
 599 
 600 // Java Expression Stack
 601 
 602 void InterpreterMacroAssembler::pop_ptr(Register r) {
 603   pop(r);
 604 }
 605 
 606 void InterpreterMacroAssembler::push_ptr(Register r) {
 607   push(r);
 608 }
 609 
 610 void InterpreterMacroAssembler::push_i(Register r) {
 611   push(r);
 612 }
 613 
 614 void InterpreterMacroAssembler::push_f(XMMRegister r) {
 615   subptr(rsp, wordSize);
 616   movflt(Address(rsp, 0), r);
 617 }
 618 
 619 void InterpreterMacroAssembler::pop_f(XMMRegister r) {
 620   movflt(r, Address(rsp, 0));
 621   addptr(rsp, wordSize);
 622 }
 623 
 624 void InterpreterMacroAssembler::push_d(XMMRegister r) {
 625   subptr(rsp, 2 * wordSize);
 626   movdbl(Address(rsp, 0), r);
 627 }
 628 
 629 void InterpreterMacroAssembler::pop_d(XMMRegister r) {
 630   movdbl(r, Address(rsp, 0));
 631   addptr(rsp, 2 * Interpreter::stackElementSize);
 632 }
 633 
 634 #ifdef _LP64
 635 void InterpreterMacroAssembler::pop_i(Register r) {
 636   // XXX can&#39;t use pop currently, upper half non clean
 637   movl(r, Address(rsp, 0));
 638   addptr(rsp, wordSize);
 639 }
 640 
 641 void InterpreterMacroAssembler::pop_l(Register r) {
 642   movq(r, Address(rsp, 0));
 643   addptr(rsp, 2 * Interpreter::stackElementSize);
 644 }
 645 
 646 void InterpreterMacroAssembler::push_l(Register r) {
 647   subptr(rsp, 2 * wordSize);
 648   movptr(Address(rsp, Interpreter::expr_offset_in_bytes(0)), r         );
 649   movptr(Address(rsp, Interpreter::expr_offset_in_bytes(1)), NULL_WORD );
 650 }
 651 
 652 void InterpreterMacroAssembler::pop(TosState state) {
 653   switch (state) {
 654   case atos: pop_ptr();                 break;
 655   case btos:
 656   case ztos:
 657   case ctos:
 658   case stos:
 659   case itos: pop_i();                   break;
 660   case ltos: pop_l();                   break;
 661   case ftos: pop_f(xmm0);               break;
 662   case dtos: pop_d(xmm0);               break;
 663   case vtos: /* nothing to do */        break;
 664   default:   ShouldNotReachHere();
 665   }
 666   interp_verify_oop(rax, state);
 667 }
 668 
 669 void InterpreterMacroAssembler::push(TosState state) {
 670   interp_verify_oop(rax, state);
 671   switch (state) {
 672   case atos: push_ptr();                break;
 673   case btos:
 674   case ztos:
 675   case ctos:
 676   case stos:
 677   case itos: push_i();                  break;
 678   case ltos: push_l();                  break;
 679   case ftos: push_f(xmm0);              break;
 680   case dtos: push_d(xmm0);              break;
 681   case vtos: /* nothing to do */        break;
 682   default  : ShouldNotReachHere();
 683   }
 684 }
 685 #else
 686 void InterpreterMacroAssembler::pop_i(Register r) {
 687   pop(r);
 688 }
 689 
 690 void InterpreterMacroAssembler::pop_l(Register lo, Register hi) {
 691   pop(lo);
 692   pop(hi);
 693 }
 694 
 695 void InterpreterMacroAssembler::pop_f() {
 696   fld_s(Address(rsp, 0));
 697   addptr(rsp, 1 * wordSize);
 698 }
 699 
 700 void InterpreterMacroAssembler::pop_d() {
 701   fld_d(Address(rsp, 0));
 702   addptr(rsp, 2 * wordSize);
 703 }
 704 
 705 
 706 void InterpreterMacroAssembler::pop(TosState state) {
 707   switch (state) {
 708     case atos: pop_ptr(rax);                                 break;
 709     case btos:                                               // fall through
 710     case ztos:                                               // fall through
 711     case ctos:                                               // fall through
 712     case stos:                                               // fall through
 713     case itos: pop_i(rax);                                   break;
 714     case ltos: pop_l(rax, rdx);                              break;
 715     case ftos:
 716       if (UseSSE &gt;= 1) {
 717         pop_f(xmm0);
 718       } else {
 719         pop_f();
 720       }
 721       break;
 722     case dtos:
 723       if (UseSSE &gt;= 2) {
 724         pop_d(xmm0);
 725       } else {
 726         pop_d();
 727       }
 728       break;
 729     case vtos: /* nothing to do */                           break;
 730     default  : ShouldNotReachHere();
 731   }
 732   interp_verify_oop(rax, state);
 733 }
 734 
 735 
 736 void InterpreterMacroAssembler::push_l(Register lo, Register hi) {
 737   push(hi);
 738   push(lo);
 739 }
 740 
 741 void InterpreterMacroAssembler::push_f() {
 742   // Do not schedule for no AGI! Never write beyond rsp!
 743   subptr(rsp, 1 * wordSize);
 744   fstp_s(Address(rsp, 0));
 745 }
 746 
 747 void InterpreterMacroAssembler::push_d() {
 748   // Do not schedule for no AGI! Never write beyond rsp!
 749   subptr(rsp, 2 * wordSize);
 750   fstp_d(Address(rsp, 0));
 751 }
 752 
 753 
 754 void InterpreterMacroAssembler::push(TosState state) {
 755   interp_verify_oop(rax, state);
 756   switch (state) {
 757     case atos: push_ptr(rax); break;
 758     case btos:                                               // fall through
 759     case ztos:                                               // fall through
 760     case ctos:                                               // fall through
 761     case stos:                                               // fall through
 762     case itos: push_i(rax);                                    break;
 763     case ltos: push_l(rax, rdx);                               break;
 764     case ftos:
 765       if (UseSSE &gt;= 1) {
 766         push_f(xmm0);
 767       } else {
 768         push_f();
 769       }
 770       break;
 771     case dtos:
 772       if (UseSSE &gt;= 2) {
 773         push_d(xmm0);
 774       } else {
 775         push_d();
 776       }
 777       break;
 778     case vtos: /* nothing to do */                             break;
 779     default  : ShouldNotReachHere();
 780   }
 781 }
 782 #endif // _LP64
 783 
 784 
 785 // Helpers for swap and dup
 786 void InterpreterMacroAssembler::load_ptr(int n, Register val) {
 787   movptr(val, Address(rsp, Interpreter::expr_offset_in_bytes(n)));
 788 }
 789 
 790 void InterpreterMacroAssembler::store_ptr(int n, Register val) {
 791   movptr(Address(rsp, Interpreter::expr_offset_in_bytes(n)), val);
 792 }
 793 
 794 
 795 void InterpreterMacroAssembler::prepare_to_jump_from_interpreted() {
 796   // set sender sp
 797   lea(_bcp_register, Address(rsp, wordSize));
 798   // record last_sp
 799   movptr(Address(rbp, frame::interpreter_frame_last_sp_offset * wordSize), _bcp_register);
 800 }
 801 
 802 
 803 // Jump to from_interpreted entry of a call unless single stepping is possible
 804 // in this thread in which case we must call the i2i entry
 805 void InterpreterMacroAssembler::jump_from_interpreted(Register method, Register temp) {
 806   prepare_to_jump_from_interpreted();
 807 
 808   if (JvmtiExport::can_post_interpreter_events()) {
 809     Label run_compiled_code;
 810     // JVMTI events, such as single-stepping, are implemented partly by avoiding running
 811     // compiled code in threads for which the event is enabled.  Check here for
 812     // interp_only_mode if these events CAN be enabled.
 813     // interp_only is an int, on little endian it is sufficient to test the byte only
 814     // Is a cmpl faster?
 815     LP64_ONLY(temp = r15_thread;)
 816     NOT_LP64(get_thread(temp);)
 817     cmpb(Address(temp, JavaThread::interp_only_mode_offset()), 0);
 818     jccb(Assembler::zero, run_compiled_code);
 819     jmp(Address(method, Method::interpreter_entry_offset()));
 820     bind(run_compiled_code);
 821   }
 822 
 823   jmp(Address(method, Method::from_interpreted_offset()));
 824 }
 825 
 826 // The following two routines provide a hook so that an implementation
 827 // can schedule the dispatch in two parts.  x86 does not do this.
 828 void InterpreterMacroAssembler::dispatch_prolog(TosState state, int step) {
 829   // Nothing x86 specific to be done here
 830 }
 831 
 832 void InterpreterMacroAssembler::dispatch_epilog(TosState state, int step) {
 833   dispatch_next(state, step);
 834 }
 835 
 836 void InterpreterMacroAssembler::dispatch_base(TosState state,
 837                                               address* table,
 838                                               bool verifyoop,
 839                                               bool generate_poll) {
 840   verify_FPU(1, state);
 841   if (VerifyActivationFrameSize) {
 842     Label L;
 843     mov(rcx, rbp);
 844     subptr(rcx, rsp);
 845     int32_t min_frame_size =
 846       (frame::link_offset - frame::interpreter_frame_initial_sp_offset) *
 847       wordSize;
 848     cmpptr(rcx, (int32_t)min_frame_size);
 849     jcc(Assembler::greaterEqual, L);
 850     stop(&quot;broken stack frame&quot;);
 851     bind(L);
 852   }
 853   if (verifyoop) {
 854     interp_verify_oop(rax, state);
 855   }
 856 
 857   address* const safepoint_table = Interpreter::safept_table(state);
 858 #ifdef _LP64
 859   Label no_safepoint, dispatch;
 860   if (table != safepoint_table &amp;&amp; generate_poll) {
 861     NOT_PRODUCT(block_comment(&quot;Thread-local Safepoint poll&quot;));
 862     testb(Address(r15_thread, Thread::polling_page_offset()), SafepointMechanism::poll_bit());
 863 
 864     jccb(Assembler::zero, no_safepoint);
 865     lea(rscratch1, ExternalAddress((address)safepoint_table));
 866     jmpb(dispatch);
 867   }
 868 
 869   bind(no_safepoint);
 870   lea(rscratch1, ExternalAddress((address)table));
 871   bind(dispatch);
 872   jmp(Address(rscratch1, rbx, Address::times_8));
 873 
 874 #else
 875   Address index(noreg, rbx, Address::times_ptr);
 876   if (table != safepoint_table &amp;&amp; generate_poll) {
 877     NOT_PRODUCT(block_comment(&quot;Thread-local Safepoint poll&quot;));
 878     Label no_safepoint;
 879     const Register thread = rcx;
 880     get_thread(thread);
 881     testb(Address(thread, Thread::polling_page_offset()), SafepointMechanism::poll_bit());
 882 
 883     jccb(Assembler::zero, no_safepoint);
 884     ArrayAddress dispatch_addr(ExternalAddress((address)safepoint_table), index);
 885     jump(dispatch_addr);
 886     bind(no_safepoint);
 887   }
 888 
 889   {
 890     ArrayAddress dispatch_addr(ExternalAddress((address)table), index);
 891     jump(dispatch_addr);
 892   }
 893 #endif // _LP64
 894 }
 895 
 896 void InterpreterMacroAssembler::dispatch_only(TosState state, bool generate_poll) {
 897   dispatch_base(state, Interpreter::dispatch_table(state), true, generate_poll);
 898 }
 899 
 900 void InterpreterMacroAssembler::dispatch_only_normal(TosState state) {
 901   dispatch_base(state, Interpreter::normal_table(state));
 902 }
 903 
 904 void InterpreterMacroAssembler::dispatch_only_noverify(TosState state) {
 905   dispatch_base(state, Interpreter::normal_table(state), false);
 906 }
 907 
 908 
 909 void InterpreterMacroAssembler::dispatch_next(TosState state, int step, bool generate_poll) {
 910   // load next bytecode (load before advancing _bcp_register to prevent AGI)
 911   load_unsigned_byte(rbx, Address(_bcp_register, step));
 912   // advance _bcp_register
 913   increment(_bcp_register, step);
 914   dispatch_base(state, Interpreter::dispatch_table(state), true, generate_poll);
 915 }
 916 
 917 void InterpreterMacroAssembler::dispatch_via(TosState state, address* table) {
 918   // load current bytecode
 919   load_unsigned_byte(rbx, Address(_bcp_register, 0));
 920   dispatch_base(state, table);
 921 }
 922 
 923 void InterpreterMacroAssembler::narrow(Register result) {
 924 
 925   // Get method-&gt;_constMethod-&gt;_result_type
 926   movptr(rcx, Address(rbp, frame::interpreter_frame_method_offset * wordSize));
 927   movptr(rcx, Address(rcx, Method::const_offset()));
 928   load_unsigned_byte(rcx, Address(rcx, ConstMethod::result_type_offset()));
 929 
 930   Label done, notBool, notByte, notChar;
 931 
 932   // common case first
 933   cmpl(rcx, T_INT);
 934   jcc(Assembler::equal, done);
 935 
 936   // mask integer result to narrower return type.
 937   cmpl(rcx, T_BOOLEAN);
 938   jcc(Assembler::notEqual, notBool);
 939   andl(result, 0x1);
 940   jmp(done);
 941 
 942   bind(notBool);
 943   cmpl(rcx, T_BYTE);
 944   jcc(Assembler::notEqual, notByte);
 945   LP64_ONLY(movsbl(result, result);)
 946   NOT_LP64(shll(result, 24);)      // truncate upper 24 bits
 947   NOT_LP64(sarl(result, 24);)      // and sign-extend byte
 948   jmp(done);
 949 
 950   bind(notByte);
 951   cmpl(rcx, T_CHAR);
 952   jcc(Assembler::notEqual, notChar);
 953   LP64_ONLY(movzwl(result, result);)
 954   NOT_LP64(andl(result, 0xFFFF);)  // truncate upper 16 bits
 955   jmp(done);
 956 
 957   bind(notChar);
 958   // cmpl(rcx, T_SHORT);  // all that&#39;s left
 959   // jcc(Assembler::notEqual, done);
 960   LP64_ONLY(movswl(result, result);)
 961   NOT_LP64(shll(result, 16);)      // truncate upper 16 bits
 962   NOT_LP64(sarl(result, 16);)      // and sign-extend short
 963 
 964   // Nothing to do for T_INT
 965   bind(done);
 966 }
 967 
 968 // remove activation
 969 //
 970 // Unlock the receiver if this is a synchronized method.
 971 // Unlock any Java monitors from syncronized blocks.
 972 // Remove the activation from the stack.
 973 //
 974 // If there are locked Java monitors
 975 //    If throw_monitor_exception
 976 //       throws IllegalMonitorStateException
 977 //    Else if install_monitor_exception
 978 //       installs IllegalMonitorStateException
 979 //    Else
 980 //       no error processing
 981 void InterpreterMacroAssembler::remove_activation(
 982         TosState state,
 983         Register ret_addr,
 984         bool throw_monitor_exception,
 985         bool install_monitor_exception,
 986         bool notify_jvmdi) {
 987   // Note: Registers rdx xmm0 may be in use for the
 988   // result check if synchronized method
 989   Label unlocked, unlock, no_unlock;
 990 
 991   const Register rthread = LP64_ONLY(r15_thread) NOT_LP64(rcx);
 992   const Register robj    = LP64_ONLY(c_rarg1) NOT_LP64(rdx);
 993   const Register rmon    = LP64_ONLY(c_rarg1) NOT_LP64(rcx);
 994                               // monitor pointers need different register
 995                               // because rdx may have the result in it
 996   NOT_LP64(get_thread(rcx);)
 997 
 998   // get the value of _do_not_unlock_if_synchronized into rdx
 999   const Address do_not_unlock_if_synchronized(rthread,
1000     in_bytes(JavaThread::do_not_unlock_if_synchronized_offset()));
1001   movbool(rbx, do_not_unlock_if_synchronized);
1002   movbool(do_not_unlock_if_synchronized, false); // reset the flag
1003 
1004   // get method access flags
1005   movptr(rcx, Address(rbp, frame::interpreter_frame_method_offset * wordSize));
1006   movl(rcx, Address(rcx, Method::access_flags_offset()));
1007   testl(rcx, JVM_ACC_SYNCHRONIZED);
1008   jcc(Assembler::zero, unlocked);
1009 
1010   // Don&#39;t unlock anything if the _do_not_unlock_if_synchronized flag
1011   // is set.
1012   testbool(rbx);
1013   jcc(Assembler::notZero, no_unlock);
1014 
1015   // unlock monitor
1016   push(state); // save result
1017 
1018   // BasicObjectLock will be first in list, since this is a
1019   // synchronized method. However, need to check that the object has
1020   // not been unlocked by an explicit monitorexit bytecode.
1021   const Address monitor(rbp, frame::interpreter_frame_initial_sp_offset *
1022                         wordSize - (int) sizeof(BasicObjectLock));
1023   // We use c_rarg1/rdx so that if we go slow path it will be the correct
1024   // register for unlock_object to pass to VM directly
1025   lea(robj, monitor); // address of first monitor
1026 
1027   movptr(rax, Address(robj, BasicObjectLock::obj_offset_in_bytes()));
1028   testptr(rax, rax);
1029   jcc(Assembler::notZero, unlock);
1030 
1031   pop(state);
1032   if (throw_monitor_exception) {
1033     // Entry already unlocked, need to throw exception
1034     NOT_LP64(empty_FPU_stack();)  // remove possible return value from FPU-stack, otherwise stack could overflow
1035     call_VM(noreg, CAST_FROM_FN_PTR(address,
1036                    InterpreterRuntime::throw_illegal_monitor_state_exception));
1037     should_not_reach_here();
1038   } else {
1039     // Monitor already unlocked during a stack unroll. If requested,
1040     // install an illegal_monitor_state_exception.  Continue with
1041     // stack unrolling.
1042     if (install_monitor_exception) {
1043       NOT_LP64(empty_FPU_stack();)
1044       call_VM(noreg, CAST_FROM_FN_PTR(address,
1045                      InterpreterRuntime::new_illegal_monitor_state_exception));
1046     }
1047     jmp(unlocked);
1048   }
1049 
1050   bind(unlock);
1051   unlock_object(robj);
1052   pop(state);
1053 
1054   // Check that for block-structured locking (i.e., that all locked
1055   // objects has been unlocked)
1056   bind(unlocked);
1057 
1058   // rax, rdx: Might contain return value
1059 
1060   // Check that all monitors are unlocked
1061   {
1062     Label loop, exception, entry, restart;
1063     const int entry_size = frame::interpreter_frame_monitor_size() * wordSize;
1064     const Address monitor_block_top(
1065         rbp, frame::interpreter_frame_monitor_block_top_offset * wordSize);
1066     const Address monitor_block_bot(
1067         rbp, frame::interpreter_frame_initial_sp_offset * wordSize);
1068 
1069     bind(restart);
1070     // We use c_rarg1 so that if we go slow path it will be the correct
1071     // register for unlock_object to pass to VM directly
1072     movptr(rmon, monitor_block_top); // points to current entry, starting
1073                                   // with top-most entry
1074     lea(rbx, monitor_block_bot);  // points to word before bottom of
1075                                   // monitor block
1076     jmp(entry);
1077 
1078     // Entry already locked, need to throw exception
1079     bind(exception);
1080 
1081     if (throw_monitor_exception) {
1082       // Throw exception
1083       NOT_LP64(empty_FPU_stack();)
1084       MacroAssembler::call_VM(noreg,
1085                               CAST_FROM_FN_PTR(address, InterpreterRuntime::
1086                                    throw_illegal_monitor_state_exception));
1087       should_not_reach_here();
1088     } else {
1089       // Stack unrolling. Unlock object and install illegal_monitor_exception.
1090       // Unlock does not block, so don&#39;t have to worry about the frame.
1091       // We don&#39;t have to preserve c_rarg1 since we are going to throw an exception.
1092 
1093       push(state);
1094       mov(robj, rmon);   // nop if robj and rmon are the same
1095       unlock_object(robj);
1096       pop(state);
1097 
1098       if (install_monitor_exception) {
1099         NOT_LP64(empty_FPU_stack();)
1100         call_VM(noreg, CAST_FROM_FN_PTR(address,
1101                                         InterpreterRuntime::
1102                                         new_illegal_monitor_state_exception));
1103       }
1104 
1105       jmp(restart);
1106     }
1107 
1108     bind(loop);
1109     // check if current entry is used
1110     cmpptr(Address(rmon, BasicObjectLock::obj_offset_in_bytes()), (int32_t) NULL);
1111     jcc(Assembler::notEqual, exception);
1112 
1113     addptr(rmon, entry_size); // otherwise advance to next entry
1114     bind(entry);
1115     cmpptr(rmon, rbx); // check if bottom reached
1116     jcc(Assembler::notEqual, loop); // if not at bottom then check this entry
1117   }
1118 
1119   bind(no_unlock);
1120 
1121   // jvmti support
1122   if (notify_jvmdi) {
1123     notify_method_exit(state, NotifyJVMTI);    // preserve TOSCA
1124   } else {
1125     notify_method_exit(state, SkipNotifyJVMTI); // preserve TOSCA
1126   }
1127 
1128   if (StackReservedPages &gt; 0) {
1129     movptr(rbx,
1130                Address(rbp, frame::interpreter_frame_sender_sp_offset * wordSize));
1131     // testing if reserved zone needs to be re-enabled
1132     Register rthread = LP64_ONLY(r15_thread) NOT_LP64(rcx);
1133     Label no_reserved_zone_enabling;
1134 
1135     NOT_LP64(get_thread(rthread);)
1136 
1137     cmpl(Address(rthread, JavaThread::stack_guard_state_offset()), JavaThread::stack_guard_enabled);
1138     jcc(Assembler::equal, no_reserved_zone_enabling);
1139 
1140     cmpptr(rbx, Address(rthread, JavaThread::reserved_stack_activation_offset()));
1141     jcc(Assembler::lessEqual, no_reserved_zone_enabling);
1142 
1143     call_VM_leaf(
1144       CAST_FROM_FN_PTR(address, SharedRuntime::enable_stack_reserved_zone), rthread);
1145     call_VM(noreg, CAST_FROM_FN_PTR(address,
1146                    InterpreterRuntime::throw_delayed_StackOverflowError));
1147     should_not_reach_here();
1148 
1149     bind(no_reserved_zone_enabling);
1150   }
1151 
1152   // remove activation
1153   // get sender sp
1154   movptr(rbx,
1155          Address(rbp, frame::interpreter_frame_sender_sp_offset * wordSize));
1156 
1157   if (state == atos &amp;&amp; InlineTypeReturnedAsFields) {
1158     Label skip;
1159     // Test if the return type is an inline type
1160     movptr(rdi, Address(rbp, frame::interpreter_frame_method_offset * wordSize));
1161     movptr(rdi, Address(rdi, Method::const_offset()));
1162     load_unsigned_byte(rdi, Address(rdi, ConstMethod::result_type_offset()));
1163     cmpl(rdi, T_INLINE_TYPE);
1164     jcc(Assembler::notEqual, skip);
1165 
1166     // We are returning an inline type, load its fields into registers
1167 #ifndef _LP64
1168     super_call_VM_leaf(StubRoutines::load_inline_type_fields_in_regs());
1169 #else
1170     // Load fields from a buffered value with an inline class specific handler
1171     Register tmp_load_klass = LP64_ONLY(rscratch1) NOT_LP64(noreg);
1172     load_klass(rdi, rax, tmp_load_klass);
1173     movptr(rdi, Address(rdi, InstanceKlass::adr_inlineklass_fixed_block_offset()));
1174     movptr(rdi, Address(rdi, InlineKlass::unpack_handler_offset()));
1175 
1176     testptr(rdi, rdi);
1177     jcc(Assembler::equal, skip);
1178 
1179     call(rdi);
1180 #endif
1181     // call above kills the value in rbx. Reload it.
1182     movptr(rbx, Address(rbp, frame::interpreter_frame_sender_sp_offset * wordSize));
1183     bind(skip);
1184   }
1185   leave();                           // remove frame anchor
1186   pop(ret_addr);                     // get return address
1187   mov(rsp, rbx);                     // set sp to sender sp
1188 }
1189 
1190 void InterpreterMacroAssembler::get_method_counters(Register method,
1191                                                     Register mcs, Label&amp; skip) {
1192   Label has_counters;
1193   movptr(mcs, Address(method, Method::method_counters_offset()));
1194   testptr(mcs, mcs);
1195   jcc(Assembler::notZero, has_counters);
1196   call_VM(noreg, CAST_FROM_FN_PTR(address,
1197           InterpreterRuntime::build_method_counters), method);
1198   movptr(mcs, Address(method,Method::method_counters_offset()));
1199   testptr(mcs, mcs);
1200   jcc(Assembler::zero, skip); // No MethodCounters allocated, OutOfMemory
1201   bind(has_counters);
1202 }
1203 
1204 void InterpreterMacroAssembler::allocate_instance(Register klass, Register new_obj,
1205                                                   Register t1, Register t2,
1206                                                   bool clear_fields, Label&amp; alloc_failed) {
1207   MacroAssembler::allocate_instance(klass, new_obj, t1, t2, clear_fields, alloc_failed);
1208   {
1209     SkipIfEqual skip_if(this, &amp;DTraceAllocProbes, 0);
1210     // Trigger dtrace event for fastpath
1211     push(atos);
1212     call_VM_leaf(CAST_FROM_FN_PTR(address, SharedRuntime::dtrace_object_alloc), new_obj);
1213     pop(atos);
1214   }
1215 }
1216 
1217 
1218 void InterpreterMacroAssembler::read_inlined_field(Register holder_klass,
1219                                                      Register field_index, Register field_offset,
1220                                                      Register obj) {
1221   Label alloc_failed, empty_value, done;
1222   const Register src = field_offset;
1223   const Register alloc_temp = LP64_ONLY(rscratch1) NOT_LP64(rsi);
1224   const Register dst_temp   = LP64_ONLY(rscratch2) NOT_LP64(rdi);
1225   assert_different_registers(obj, holder_klass, field_index, field_offset, dst_temp);
1226 
1227   // Grap the inline field klass
1228   push(holder_klass);
1229   const Register field_klass = holder_klass;
1230   get_inline_type_field_klass(holder_klass, field_index, field_klass);
1231 
1232   //check for empty value klass
1233   test_klass_is_empty_inline_type(field_klass, dst_temp, empty_value);
1234 
1235   // allocate buffer
1236   push(obj); // save holder
1237   allocate_instance(field_klass, obj, alloc_temp, dst_temp, false, alloc_failed);
1238 
1239   // Have an oop instance buffer, copy into it
1240   data_for_oop(obj, dst_temp, field_klass);
1241   pop(alloc_temp);             // restore holder
1242   lea(src, Address(alloc_temp, field_offset));
1243   // call_VM_leaf, clobbers a few regs, save restore new obj
1244   push(obj);
1245   access_value_copy(IS_DEST_UNINITIALIZED, src, dst_temp, field_klass);
1246   pop(obj);
1247   pop(holder_klass);
1248   jmp(done);
1249 
1250   bind(empty_value);
1251   get_empty_inline_type_oop(field_klass, dst_temp, obj);
1252   pop(holder_klass);
1253   jmp(done);
1254 
1255   bind(alloc_failed);
1256   pop(obj);
1257   pop(holder_klass);
1258   call_VM(obj, CAST_FROM_FN_PTR(address, InterpreterRuntime::read_inlined_field),
1259           obj, field_index, holder_klass);
1260 
1261   bind(done);
1262 }
1263 
1264 void InterpreterMacroAssembler::read_flattened_element(Register array, Register index,
1265                                                        Register t1, Register t2,
1266                                                        Register obj) {
1267   assert_different_registers(array, index, t1, t2);
1268   Label alloc_failed, empty_value, done;
1269   const Register array_klass = t2;
1270   const Register elem_klass = t1;
1271   const Register alloc_temp = LP64_ONLY(rscratch1) NOT_LP64(rsi);
1272   const Register dst_temp   = LP64_ONLY(rscratch2) NOT_LP64(rdi);
1273 
1274   // load in array-&gt;klass()-&gt;element_klass()
1275   Register tmp_load_klass = LP64_ONLY(rscratch1) NOT_LP64(noreg);
1276   load_klass(array_klass, array, tmp_load_klass);
1277   movptr(elem_klass, Address(array_klass, ArrayKlass::element_klass_offset()));
1278 
1279   //check for empty value klass
1280   test_klass_is_empty_inline_type(elem_klass, dst_temp, empty_value);
1281 
1282   // calc source into &quot;array_klass&quot; and free up some regs
1283   const Register src = array_klass;
1284   push(index); // preserve index reg in case alloc_failed
1285   data_for_value_array_index(array, array_klass, index, src);
1286 
1287   allocate_instance(elem_klass, obj, alloc_temp, dst_temp, false, alloc_failed);
1288   // Have an oop instance buffer, copy into it
1289   store_ptr(0, obj); // preserve obj (overwrite index, no longer needed)
1290   data_for_oop(obj, dst_temp, elem_klass);
1291   access_value_copy(IS_DEST_UNINITIALIZED, src, dst_temp, elem_klass);
1292   pop(obj);
1293   jmp(done);
1294 
1295   bind(empty_value);
1296   get_empty_inline_type_oop(elem_klass, dst_temp, obj);
1297   jmp(done);
1298 
1299   bind(alloc_failed);
1300   pop(index);
1301   if (array == c_rarg2) {
1302     mov(elem_klass, array);
1303     array = elem_klass;
1304   }
1305   call_VM(obj, CAST_FROM_FN_PTR(address, InterpreterRuntime::value_array_load), array, index);
1306 
1307   bind(done);
1308 }
1309 
1310 
1311 // Lock object
1312 //
1313 // Args:
1314 //      rdx, c_rarg1: BasicObjectLock to be used for locking
1315 //
1316 // Kills:
1317 //      rax, rbx
1318 void InterpreterMacroAssembler::lock_object(Register lock_reg) {
1319   assert(lock_reg == LP64_ONLY(c_rarg1) NOT_LP64(rdx),
1320          &quot;The argument is only for looks. It must be c_rarg1&quot;);
1321 
1322   if (UseHeavyMonitors) {
1323     call_VM(noreg,
1324             CAST_FROM_FN_PTR(address, InterpreterRuntime::monitorenter),
1325             lock_reg);
1326   } else {
1327     Label done;
1328 
1329     const Register swap_reg = rax; // Must use rax for cmpxchg instruction
1330     const Register tmp_reg = rbx; // Will be passed to biased_locking_enter to avoid a
1331                                   // problematic case where tmp_reg = no_reg.
1332     const Register obj_reg = LP64_ONLY(c_rarg3) NOT_LP64(rcx); // Will contain the oop
1333 
1334     const int obj_offset = BasicObjectLock::obj_offset_in_bytes();
1335     const int lock_offset = BasicObjectLock::lock_offset_in_bytes ();
1336     const int mark_offset = lock_offset +
1337                             BasicLock::displaced_header_offset_in_bytes();
1338 
1339     Label slow_case;
1340 
1341     // Load object pointer into obj_reg
1342     movptr(obj_reg, Address(lock_reg, obj_offset));
1343 
1344     if (UseBiasedLocking) {
1345       Register rklass_decode_tmp = LP64_ONLY(rscratch1) NOT_LP64(noreg);
1346       biased_locking_enter(lock_reg, obj_reg, swap_reg, tmp_reg, rklass_decode_tmp, false, done, &amp;slow_case);
1347     }
1348 
1349     // Load immediate 1 into swap_reg %rax
1350     movl(swap_reg, (int32_t)1);
1351 
1352     // Load (object-&gt;mark() | 1) into swap_reg %rax
1353     orptr(swap_reg, Address(obj_reg, oopDesc::mark_offset_in_bytes()));
1354     if (EnableValhalla &amp;&amp; !UseBiasedLocking) {
1355       // For slow path is_always_locked, using biased, which is never natural for !UseBiasLocking
1356       andptr(swap_reg, ~((int) markWord::biased_lock_bit_in_place));
1357     }
1358 
1359     // Save (object-&gt;mark() | 1) into BasicLock&#39;s displaced header
1360     movptr(Address(lock_reg, mark_offset), swap_reg);
1361 
1362     assert(lock_offset == 0,
1363            &quot;displaced header must be first word in BasicObjectLock&quot;);
1364 
1365     lock();
1366     cmpxchgptr(lock_reg, Address(obj_reg, oopDesc::mark_offset_in_bytes()));
1367     if (PrintBiasedLockingStatistics) {
1368       cond_inc32(Assembler::zero,
1369                  ExternalAddress((address) BiasedLocking::fast_path_entry_count_addr()));
1370     }
1371     jcc(Assembler::zero, done);
1372 
1373     const int zero_bits = LP64_ONLY(7) NOT_LP64(3);
1374 
1375     // Test if the oopMark is an obvious stack pointer, i.e.,
1376     //  1) (mark &amp; zero_bits) == 0, and
1377     //  2) rsp &lt;= mark &lt; mark + os::pagesize()
1378     //
1379     // These 3 tests can be done by evaluating the following
1380     // expression: ((mark - rsp) &amp; (zero_bits - os::vm_page_size())),
1381     // assuming both stack pointer and pagesize have their
1382     // least significant bits clear.
1383     // NOTE: the oopMark is in swap_reg %rax as the result of cmpxchg
1384     subptr(swap_reg, rsp);
1385     andptr(swap_reg, zero_bits - os::vm_page_size());
1386 
1387     // Save the test result, for recursive case, the result is zero
1388     movptr(Address(lock_reg, mark_offset), swap_reg);
1389 
1390     if (PrintBiasedLockingStatistics) {
1391       cond_inc32(Assembler::zero,
1392                  ExternalAddress((address) BiasedLocking::fast_path_entry_count_addr()));
1393     }
1394     jcc(Assembler::zero, done);
1395 
1396     bind(slow_case);
1397 
1398     // Call the runtime routine for slow case
1399     call_VM(noreg,
1400             CAST_FROM_FN_PTR(address, InterpreterRuntime::monitorenter),
1401             lock_reg);
1402 
1403     bind(done);
1404   }
1405 }
1406 
1407 
1408 // Unlocks an object. Used in monitorexit bytecode and
1409 // remove_activation.  Throws an IllegalMonitorException if object is
1410 // not locked by current thread.
1411 //
1412 // Args:
1413 //      rdx, c_rarg1: BasicObjectLock for lock
1414 //
1415 // Kills:
1416 //      rax
1417 //      c_rarg0, c_rarg1, c_rarg2, c_rarg3, ... (param regs)
1418 //      rscratch1 (scratch reg)
1419 // rax, rbx, rcx, rdx
1420 void InterpreterMacroAssembler::unlock_object(Register lock_reg) {
1421   assert(lock_reg == LP64_ONLY(c_rarg1) NOT_LP64(rdx),
1422          &quot;The argument is only for looks. It must be c_rarg1&quot;);
1423 
1424   if (UseHeavyMonitors) {
1425     call_VM(noreg,
1426             CAST_FROM_FN_PTR(address, InterpreterRuntime::monitorexit),
1427             lock_reg);
1428   } else {
1429     Label done;
1430 
1431     const Register swap_reg   = rax;  // Must use rax for cmpxchg instruction
1432     const Register header_reg = LP64_ONLY(c_rarg2) NOT_LP64(rbx);  // Will contain the old oopMark
1433     const Register obj_reg    = LP64_ONLY(c_rarg3) NOT_LP64(rcx);  // Will contain the oop
1434 
1435     save_bcp(); // Save in case of exception
1436 
1437     // Convert from BasicObjectLock structure to object and BasicLock
1438     // structure Store the BasicLock address into %rax
1439     lea(swap_reg, Address(lock_reg, BasicObjectLock::lock_offset_in_bytes()));
1440 
1441     // Load oop into obj_reg(%c_rarg3)
1442     movptr(obj_reg, Address(lock_reg, BasicObjectLock::obj_offset_in_bytes()));
1443 
1444     // Free entry
1445     movptr(Address(lock_reg, BasicObjectLock::obj_offset_in_bytes()), (int32_t)NULL_WORD);
1446 
1447     if (UseBiasedLocking) {
1448       biased_locking_exit(obj_reg, header_reg, done);
1449     }
1450 
1451     // Load the old header from BasicLock structure
1452     movptr(header_reg, Address(swap_reg,
1453                                BasicLock::displaced_header_offset_in_bytes()));
1454 
1455     // Test for recursion
1456     testptr(header_reg, header_reg);
1457 
1458     // zero for recursive case
1459     jcc(Assembler::zero, done);
1460 
1461     // Atomic swap back the old header
1462     lock();
1463     cmpxchgptr(header_reg, Address(obj_reg, oopDesc::mark_offset_in_bytes()));
1464 
1465     // zero for simple unlock of a stack-lock case
1466     jcc(Assembler::zero, done);
1467 
1468     // Call the runtime routine for slow case.
1469     movptr(Address(lock_reg, BasicObjectLock::obj_offset_in_bytes()),
1470          obj_reg); // restore obj
1471     call_VM(noreg,
1472             CAST_FROM_FN_PTR(address, InterpreterRuntime::monitorexit),
1473             lock_reg);
1474 
1475     bind(done);
1476 
1477     restore_bcp();
1478   }
1479 }
1480 
1481 void InterpreterMacroAssembler::test_method_data_pointer(Register mdp,
1482                                                          Label&amp; zero_continue) {
1483   assert(ProfileInterpreter, &quot;must be profiling interpreter&quot;);
1484   movptr(mdp, Address(rbp, frame::interpreter_frame_mdp_offset * wordSize));
1485   testptr(mdp, mdp);
1486   jcc(Assembler::zero, zero_continue);
1487 }
1488 
1489 
1490 // Set the method data pointer for the current bcp.
1491 void InterpreterMacroAssembler::set_method_data_pointer_for_bcp() {
1492   assert(ProfileInterpreter, &quot;must be profiling interpreter&quot;);
1493   Label set_mdp;
1494   push(rax);
1495   push(rbx);
1496 
1497   get_method(rbx);
1498   // Test MDO to avoid the call if it is NULL.
1499   movptr(rax, Address(rbx, in_bytes(Method::method_data_offset())));
1500   testptr(rax, rax);
1501   jcc(Assembler::zero, set_mdp);
1502   // rbx: method
1503   // _bcp_register: bcp
1504   call_VM_leaf(CAST_FROM_FN_PTR(address, InterpreterRuntime::bcp_to_di), rbx, _bcp_register);
1505   // rax: mdi
1506   // mdo is guaranteed to be non-zero here, we checked for it before the call.
1507   movptr(rbx, Address(rbx, in_bytes(Method::method_data_offset())));
1508   addptr(rbx, in_bytes(MethodData::data_offset()));
1509   addptr(rax, rbx);
1510   bind(set_mdp);
1511   movptr(Address(rbp, frame::interpreter_frame_mdp_offset * wordSize), rax);
1512   pop(rbx);
1513   pop(rax);
1514 }
1515 
1516 void InterpreterMacroAssembler::verify_method_data_pointer() {
1517   assert(ProfileInterpreter, &quot;must be profiling interpreter&quot;);
1518 #ifdef ASSERT
1519   Label verify_continue;
1520   push(rax);
1521   push(rbx);
1522   Register arg3_reg = LP64_ONLY(c_rarg3) NOT_LP64(rcx);
1523   Register arg2_reg = LP64_ONLY(c_rarg2) NOT_LP64(rdx);
1524   push(arg3_reg);
1525   push(arg2_reg);
1526   test_method_data_pointer(arg3_reg, verify_continue); // If mdp is zero, continue
1527   get_method(rbx);
1528 
1529   // If the mdp is valid, it will point to a DataLayout header which is
1530   // consistent with the bcp.  The converse is highly probable also.
1531   load_unsigned_short(arg2_reg,
1532                       Address(arg3_reg, in_bytes(DataLayout::bci_offset())));
1533   addptr(arg2_reg, Address(rbx, Method::const_offset()));
1534   lea(arg2_reg, Address(arg2_reg, ConstMethod::codes_offset()));
1535   cmpptr(arg2_reg, _bcp_register);
1536   jcc(Assembler::equal, verify_continue);
1537   // rbx: method
1538   // _bcp_register: bcp
1539   // c_rarg3: mdp
1540   call_VM_leaf(CAST_FROM_FN_PTR(address, InterpreterRuntime::verify_mdp),
1541                rbx, _bcp_register, arg3_reg);
1542   bind(verify_continue);
1543   pop(arg2_reg);
1544   pop(arg3_reg);
1545   pop(rbx);
1546   pop(rax);
1547 #endif // ASSERT
1548 }
1549 
1550 
1551 void InterpreterMacroAssembler::set_mdp_data_at(Register mdp_in,
1552                                                 int constant,
1553                                                 Register value) {
1554   assert(ProfileInterpreter, &quot;must be profiling interpreter&quot;);
1555   Address data(mdp_in, constant);
1556   movptr(data, value);
1557 }
1558 
1559 
1560 void InterpreterMacroAssembler::increment_mdp_data_at(Register mdp_in,
1561                                                       int constant,
1562                                                       bool decrement) {
1563   // Counter address
1564   Address data(mdp_in, constant);
1565 
1566   increment_mdp_data_at(data, decrement);
1567 }
1568 
1569 void InterpreterMacroAssembler::increment_mdp_data_at(Address data,
1570                                                       bool decrement) {
1571   assert(ProfileInterpreter, &quot;must be profiling interpreter&quot;);
1572   // %%% this does 64bit counters at best it is wasting space
1573   // at worst it is a rare bug when counters overflow
1574 
1575   if (decrement) {
1576     // Decrement the register.  Set condition codes.
1577     addptr(data, (int32_t) -DataLayout::counter_increment);
1578     // If the decrement causes the counter to overflow, stay negative
1579     Label L;
1580     jcc(Assembler::negative, L);
1581     addptr(data, (int32_t) DataLayout::counter_increment);
1582     bind(L);
1583   } else {
1584     assert(DataLayout::counter_increment == 1,
1585            &quot;flow-free idiom only works with 1&quot;);
1586     // Increment the register.  Set carry flag.
1587     addptr(data, DataLayout::counter_increment);
1588     // If the increment causes the counter to overflow, pull back by 1.
1589     sbbptr(data, (int32_t)0);
1590   }
1591 }
1592 
1593 
1594 void InterpreterMacroAssembler::increment_mdp_data_at(Register mdp_in,
1595                                                       Register reg,
1596                                                       int constant,
1597                                                       bool decrement) {
1598   Address data(mdp_in, reg, Address::times_1, constant);
1599 
1600   increment_mdp_data_at(data, decrement);
1601 }
1602 
1603 void InterpreterMacroAssembler::set_mdp_flag_at(Register mdp_in,
1604                                                 int flag_byte_constant) {
1605   assert(ProfileInterpreter, &quot;must be profiling interpreter&quot;);
1606   int header_offset = in_bytes(DataLayout::flags_offset());
1607   int header_bits = flag_byte_constant;
1608   // Set the flag
1609   orb(Address(mdp_in, header_offset), header_bits);
1610 }
1611 
1612 
1613 
1614 void InterpreterMacroAssembler::test_mdp_data_at(Register mdp_in,
1615                                                  int offset,
1616                                                  Register value,
1617                                                  Register test_value_out,
1618                                                  Label&amp; not_equal_continue) {
1619   assert(ProfileInterpreter, &quot;must be profiling interpreter&quot;);
1620   if (test_value_out == noreg) {
1621     cmpptr(value, Address(mdp_in, offset));
1622   } else {
1623     // Put the test value into a register, so caller can use it:
1624     movptr(test_value_out, Address(mdp_in, offset));
1625     cmpptr(test_value_out, value);
1626   }
1627   jcc(Assembler::notEqual, not_equal_continue);
1628 }
1629 
1630 
1631 void InterpreterMacroAssembler::update_mdp_by_offset(Register mdp_in,
1632                                                      int offset_of_disp) {
1633   assert(ProfileInterpreter, &quot;must be profiling interpreter&quot;);
1634   Address disp_address(mdp_in, offset_of_disp);
1635   addptr(mdp_in, disp_address);
1636   movptr(Address(rbp, frame::interpreter_frame_mdp_offset * wordSize), mdp_in);
1637 }
1638 
1639 
1640 void InterpreterMacroAssembler::update_mdp_by_offset(Register mdp_in,
1641                                                      Register reg,
1642                                                      int offset_of_disp) {
1643   assert(ProfileInterpreter, &quot;must be profiling interpreter&quot;);
1644   Address disp_address(mdp_in, reg, Address::times_1, offset_of_disp);
1645   addptr(mdp_in, disp_address);
1646   movptr(Address(rbp, frame::interpreter_frame_mdp_offset * wordSize), mdp_in);
1647 }
1648 
1649 
1650 void InterpreterMacroAssembler::update_mdp_by_constant(Register mdp_in,
1651                                                        int constant) {
1652   assert(ProfileInterpreter, &quot;must be profiling interpreter&quot;);
1653   addptr(mdp_in, constant);
1654   movptr(Address(rbp, frame::interpreter_frame_mdp_offset * wordSize), mdp_in);
1655 }
1656 
1657 
1658 void InterpreterMacroAssembler::update_mdp_for_ret(Register return_bci) {
1659   assert(ProfileInterpreter, &quot;must be profiling interpreter&quot;);
1660   push(return_bci); // save/restore across call_VM
1661   call_VM(noreg,
1662           CAST_FROM_FN_PTR(address, InterpreterRuntime::update_mdp_for_ret),
1663           return_bci);
1664   pop(return_bci);
1665 }
1666 
1667 
1668 void InterpreterMacroAssembler::profile_taken_branch(Register mdp,
1669                                                      Register bumped_count) {
1670   if (ProfileInterpreter) {
1671     Label profile_continue;
1672 
1673     // If no method data exists, go to profile_continue.
1674     // Otherwise, assign to mdp
1675     test_method_data_pointer(mdp, profile_continue);
1676 
1677     // We are taking a branch.  Increment the taken count.
1678     // We inline increment_mdp_data_at to return bumped_count in a register
1679     //increment_mdp_data_at(mdp, in_bytes(JumpData::taken_offset()));
1680     Address data(mdp, in_bytes(JumpData::taken_offset()));
1681     movptr(bumped_count, data);
1682     assert(DataLayout::counter_increment == 1,
1683             &quot;flow-free idiom only works with 1&quot;);
1684     addptr(bumped_count, DataLayout::counter_increment);
1685     sbbptr(bumped_count, 0);
1686     movptr(data, bumped_count); // Store back out
1687 
1688     // The method data pointer needs to be updated to reflect the new target.
1689     update_mdp_by_offset(mdp, in_bytes(JumpData::displacement_offset()));
1690     bind(profile_continue);
1691   }
1692 }
1693 
1694 
1695 void InterpreterMacroAssembler::profile_not_taken_branch(Register mdp) {
1696   if (ProfileInterpreter) {
1697     Label profile_continue;
1698 
1699     // If no method data exists, go to profile_continue.
1700     test_method_data_pointer(mdp, profile_continue);
1701 
1702     // We are taking a branch.  Increment the not taken count.
1703     increment_mdp_data_at(mdp, in_bytes(BranchData::not_taken_offset()));
1704 
1705     // The method data pointer needs to be updated to correspond to
1706     // the next bytecode
1707     update_mdp_by_constant(mdp, in_bytes(BranchData::branch_data_size()));
1708     bind(profile_continue);
1709   }
1710 }
1711 
1712 void InterpreterMacroAssembler::profile_call(Register mdp) {
1713   if (ProfileInterpreter) {
1714     Label profile_continue;
1715 
1716     // If no method data exists, go to profile_continue.
1717     test_method_data_pointer(mdp, profile_continue);
1718 
1719     // We are making a call.  Increment the count.
1720     increment_mdp_data_at(mdp, in_bytes(CounterData::count_offset()));
1721 
1722     // The method data pointer needs to be updated to reflect the new target.
1723     update_mdp_by_constant(mdp, in_bytes(CounterData::counter_data_size()));
1724     bind(profile_continue);
1725   }
1726 }
1727 
1728 
1729 void InterpreterMacroAssembler::profile_final_call(Register mdp) {
1730   if (ProfileInterpreter) {
1731     Label profile_continue;
1732 
1733     // If no method data exists, go to profile_continue.
1734     test_method_data_pointer(mdp, profile_continue);
1735 
1736     // We are making a call.  Increment the count.
1737     increment_mdp_data_at(mdp, in_bytes(CounterData::count_offset()));
1738 
1739     // The method data pointer needs to be updated to reflect the new target.
1740     update_mdp_by_constant(mdp,
1741                            in_bytes(VirtualCallData::
1742                                     virtual_call_data_size()));
1743     bind(profile_continue);
1744   }
1745 }
1746 
1747 
1748 void InterpreterMacroAssembler::profile_virtual_call(Register receiver,
1749                                                      Register mdp,
1750                                                      Register reg2,
1751                                                      bool receiver_can_be_null) {
1752   if (ProfileInterpreter) {
1753     Label profile_continue;
1754 
1755     // If no method data exists, go to profile_continue.
1756     test_method_data_pointer(mdp, profile_continue);
1757 
1758     Label skip_receiver_profile;
1759     if (receiver_can_be_null) {
1760       Label not_null;
1761       testptr(receiver, receiver);
1762       jccb(Assembler::notZero, not_null);
1763       // We are making a call.  Increment the count for null receiver.
1764       increment_mdp_data_at(mdp, in_bytes(CounterData::count_offset()));
1765       jmp(skip_receiver_profile);
1766       bind(not_null);
1767     }
1768 
1769     // Record the receiver type.
1770     record_klass_in_profile(receiver, mdp, reg2, true);
1771     bind(skip_receiver_profile);
1772 
1773     // The method data pointer needs to be updated to reflect the new target.
1774     update_mdp_by_constant(mdp, in_bytes(VirtualCallData::virtual_call_data_size()));
1775     bind(profile_continue);
1776   }
1777 }
1778 
1779 // This routine creates a state machine for updating the multi-row
1780 // type profile at a virtual call site (or other type-sensitive bytecode).
1781 // The machine visits each row (of receiver/count) until the receiver type
1782 // is found, or until it runs out of rows.  At the same time, it remembers
1783 // the location of the first empty row.  (An empty row records null for its
1784 // receiver, and can be allocated for a newly-observed receiver type.)
1785 // Because there are two degrees of freedom in the state, a simple linear
1786 // search will not work; it must be a decision tree.  Hence this helper
1787 // function is recursive, to generate the required tree structured code.
1788 // It&#39;s the interpreter, so we are trading off code space for speed.
1789 // See below for example code.
1790 void InterpreterMacroAssembler::record_klass_in_profile_helper(
1791                                         Register receiver, Register mdp,
1792                                         Register reg2, int start_row,
1793                                         Label&amp; done, bool is_virtual_call) {
1794   if (TypeProfileWidth == 0) {
1795     if (is_virtual_call) {
1796       increment_mdp_data_at(mdp, in_bytes(CounterData::count_offset()));
1797     }
1798 #if INCLUDE_JVMCI
1799     else if (EnableJVMCI) {
1800       increment_mdp_data_at(mdp, in_bytes(ReceiverTypeData::nonprofiled_receiver_count_offset()));
1801     }
1802 #endif // INCLUDE_JVMCI
1803   } else {
1804     int non_profiled_offset = -1;
1805     if (is_virtual_call) {
1806       non_profiled_offset = in_bytes(CounterData::count_offset());
1807     }
1808 #if INCLUDE_JVMCI
1809     else if (EnableJVMCI) {
1810       non_profiled_offset = in_bytes(ReceiverTypeData::nonprofiled_receiver_count_offset());
1811     }
1812 #endif // INCLUDE_JVMCI
1813 
1814     record_item_in_profile_helper(receiver, mdp, reg2, 0, done, TypeProfileWidth,
1815         &amp;VirtualCallData::receiver_offset, &amp;VirtualCallData::receiver_count_offset, non_profiled_offset);
1816   }
1817 }
1818 
1819 void InterpreterMacroAssembler::record_item_in_profile_helper(Register item, Register mdp,
1820                                         Register reg2, int start_row, Label&amp; done, int total_rows,
1821                                         OffsetFunction item_offset_fn, OffsetFunction item_count_offset_fn,
1822                                         int non_profiled_offset) {
1823   int last_row = total_rows - 1;
1824   assert(start_row &lt;= last_row, &quot;must be work left to do&quot;);
1825   // Test this row for both the item and for null.
1826   // Take any of three different outcomes:
1827   //   1. found item =&gt; increment count and goto done
1828   //   2. found null =&gt; keep looking for case 1, maybe allocate this cell
1829   //   3. found something else =&gt; keep looking for cases 1 and 2
1830   // Case 3 is handled by a recursive call.
1831   for (int row = start_row; row &lt;= last_row; row++) {
1832     Label next_test;
1833     bool test_for_null_also = (row == start_row);
1834 
1835     // See if the item is item[n].
1836     int item_offset = in_bytes(item_offset_fn(row));
1837     test_mdp_data_at(mdp, item_offset, item,
1838                      (test_for_null_also ? reg2 : noreg),
1839                      next_test);
1840     // (Reg2 now contains the item from the CallData.)
1841 
1842     // The item is item[n].  Increment count[n].
1843     int count_offset = in_bytes(item_count_offset_fn(row));
1844     increment_mdp_data_at(mdp, count_offset);
1845     jmp(done);
1846     bind(next_test);
1847 
1848     if (test_for_null_also) {
1849       // Failed the equality check on item[n]...  Test for null.
1850       testptr(reg2, reg2);
1851       if (start_row == last_row) {
1852         // The only thing left to do is handle the null case.
1853         if (non_profiled_offset &gt;= 0) {
1854           Label found_null;
1855           jccb(Assembler::zero, found_null);
1856           // Item did not match any saved item and there is no empty row for it.
1857           // Increment total counter to indicate polymorphic case.
1858           increment_mdp_data_at(mdp, non_profiled_offset);
1859           jmp(done);
1860           bind(found_null);
1861         } else {
1862           jcc(Assembler::notZero, done);
1863         }
1864         break;
1865       }
1866       Label found_null;
1867       // Since null is rare, make it be the branch-taken case.
1868       jcc(Assembler::zero, found_null);
1869 
1870       // Put all the &quot;Case 3&quot; tests here.
1871       record_item_in_profile_helper(item, mdp, reg2, start_row + 1, done, total_rows,
1872         item_offset_fn, item_count_offset_fn, non_profiled_offset);
1873 
1874       // Found a null.  Keep searching for a matching item,
1875       // but remember that this is an empty (unused) slot.
1876       bind(found_null);
1877     }
1878   }
1879 
1880   // In the fall-through case, we found no matching item, but we
1881   // observed the item[start_row] is NULL.
1882 
1883   // Fill in the item field and increment the count.
1884   int item_offset = in_bytes(item_offset_fn(start_row));
1885   set_mdp_data_at(mdp, item_offset, item);
1886   int count_offset = in_bytes(item_count_offset_fn(start_row));
1887   movl(reg2, DataLayout::counter_increment);
1888   set_mdp_data_at(mdp, count_offset, reg2);
1889   if (start_row &gt; 0) {
1890     jmp(done);
1891   }
1892 }
1893 
1894 // Example state machine code for three profile rows:
1895 //   // main copy of decision tree, rooted at row[1]
1896 //   if (row[0].rec == rec) { row[0].incr(); goto done; }
1897 //   if (row[0].rec != NULL) {
1898 //     // inner copy of decision tree, rooted at row[1]
1899 //     if (row[1].rec == rec) { row[1].incr(); goto done; }
1900 //     if (row[1].rec != NULL) {
1901 //       // degenerate decision tree, rooted at row[2]
1902 //       if (row[2].rec == rec) { row[2].incr(); goto done; }
1903 //       if (row[2].rec != NULL) { count.incr(); goto done; } // overflow
1904 //       row[2].init(rec); goto done;
1905 //     } else {
1906 //       // remember row[1] is empty
1907 //       if (row[2].rec == rec) { row[2].incr(); goto done; }
1908 //       row[1].init(rec); goto done;
1909 //     }
1910 //   } else {
1911 //     // remember row[0] is empty
1912 //     if (row[1].rec == rec) { row[1].incr(); goto done; }
1913 //     if (row[2].rec == rec) { row[2].incr(); goto done; }
1914 //     row[0].init(rec); goto done;
1915 //   }
1916 //   done:
1917 
1918 void InterpreterMacroAssembler::record_klass_in_profile(Register receiver,
1919                                                         Register mdp, Register reg2,
1920                                                         bool is_virtual_call) {
1921   assert(ProfileInterpreter, &quot;must be profiling&quot;);
1922   Label done;
1923 
1924   record_klass_in_profile_helper(receiver, mdp, reg2, 0, done, is_virtual_call);
1925 
1926   bind (done);
1927 }
1928 
1929 void InterpreterMacroAssembler::profile_ret(Register return_bci,
1930                                             Register mdp) {
1931   if (ProfileInterpreter) {
1932     Label profile_continue;
1933     uint row;
1934 
1935     // If no method data exists, go to profile_continue.
1936     test_method_data_pointer(mdp, profile_continue);
1937 
1938     // Update the total ret count.
1939     increment_mdp_data_at(mdp, in_bytes(CounterData::count_offset()));
1940 
1941     for (row = 0; row &lt; RetData::row_limit(); row++) {
1942       Label next_test;
1943 
1944       // See if return_bci is equal to bci[n]:
1945       test_mdp_data_at(mdp,
1946                        in_bytes(RetData::bci_offset(row)),
1947                        return_bci, noreg,
1948                        next_test);
1949 
1950       // return_bci is equal to bci[n].  Increment the count.
1951       increment_mdp_data_at(mdp, in_bytes(RetData::bci_count_offset(row)));
1952 
1953       // The method data pointer needs to be updated to reflect the new target.
1954       update_mdp_by_offset(mdp,
1955                            in_bytes(RetData::bci_displacement_offset(row)));
1956       jmp(profile_continue);
1957       bind(next_test);
1958     }
1959 
1960     update_mdp_for_ret(return_bci);
1961 
1962     bind(profile_continue);
1963   }
1964 }
1965 
1966 
1967 void InterpreterMacroAssembler::profile_null_seen(Register mdp) {
1968   if (ProfileInterpreter) {
1969     Label profile_continue;
1970 
1971     // If no method data exists, go to profile_continue.
1972     test_method_data_pointer(mdp, profile_continue);
1973 
1974     set_mdp_flag_at(mdp, BitData::null_seen_byte_constant());
1975 
1976     // The method data pointer needs to be updated.
1977     int mdp_delta = in_bytes(BitData::bit_data_size());
1978     if (TypeProfileCasts) {
1979       mdp_delta = in_bytes(VirtualCallData::virtual_call_data_size());
1980     }
1981     update_mdp_by_constant(mdp, mdp_delta);
1982 
1983     bind(profile_continue);
1984   }
1985 }
1986 
1987 
1988 void InterpreterMacroAssembler::profile_typecheck_failed(Register mdp) {
1989   if (ProfileInterpreter &amp;&amp; TypeProfileCasts) {
1990     Label profile_continue;
1991 
1992     // If no method data exists, go to profile_continue.
1993     test_method_data_pointer(mdp, profile_continue);
1994 
1995     int count_offset = in_bytes(CounterData::count_offset());
1996     // Back up the address, since we have already bumped the mdp.
1997     count_offset -= in_bytes(VirtualCallData::virtual_call_data_size());
1998 
1999     // *Decrement* the counter.  We expect to see zero or small negatives.
2000     increment_mdp_data_at(mdp, count_offset, true);
2001 
2002     bind (profile_continue);
2003   }
2004 }
2005 
2006 
2007 void InterpreterMacroAssembler::profile_typecheck(Register mdp, Register klass, Register reg2) {
2008   if (ProfileInterpreter) {
2009     Label profile_continue;
2010 
2011     // If no method data exists, go to profile_continue.
2012     test_method_data_pointer(mdp, profile_continue);
2013 
2014     // The method data pointer needs to be updated.
2015     int mdp_delta = in_bytes(BitData::bit_data_size());
2016     if (TypeProfileCasts) {
2017       mdp_delta = in_bytes(VirtualCallData::virtual_call_data_size());
2018 
2019       // Record the object type.
2020       record_klass_in_profile(klass, mdp, reg2, false);
2021       NOT_LP64(assert(reg2 == rdi, &quot;we know how to fix this blown reg&quot;);)
2022       NOT_LP64(restore_locals();)         // Restore EDI
2023     }
2024     update_mdp_by_constant(mdp, mdp_delta);
2025 
2026     bind(profile_continue);
2027   }
2028 }
2029 
2030 
2031 void InterpreterMacroAssembler::profile_switch_default(Register mdp) {
2032   if (ProfileInterpreter) {
2033     Label profile_continue;
2034 
2035     // If no method data exists, go to profile_continue.
2036     test_method_data_pointer(mdp, profile_continue);
2037 
2038     // Update the default case count
2039     increment_mdp_data_at(mdp,
2040                           in_bytes(MultiBranchData::default_count_offset()));
2041 
2042     // The method data pointer needs to be updated.
2043     update_mdp_by_offset(mdp,
2044                          in_bytes(MultiBranchData::
2045                                   default_displacement_offset()));
2046 
2047     bind(profile_continue);
2048   }
2049 }
2050 
2051 
2052 void InterpreterMacroAssembler::profile_switch_case(Register index,
2053                                                     Register mdp,
2054                                                     Register reg2) {
2055   if (ProfileInterpreter) {
2056     Label profile_continue;
2057 
2058     // If no method data exists, go to profile_continue.
2059     test_method_data_pointer(mdp, profile_continue);
2060 
2061     // Build the base (index * per_case_size_in_bytes()) +
2062     // case_array_offset_in_bytes()
2063     movl(reg2, in_bytes(MultiBranchData::per_case_size()));
2064     imulptr(index, reg2); // XXX l ?
2065     addptr(index, in_bytes(MultiBranchData::case_array_offset())); // XXX l ?
2066 
2067     // Update the case count
2068     increment_mdp_data_at(mdp,
2069                           index,
2070                           in_bytes(MultiBranchData::relative_count_offset()));
2071 
2072     // The method data pointer needs to be updated.
2073     update_mdp_by_offset(mdp,
2074                          index,
2075                          in_bytes(MultiBranchData::
2076                                   relative_displacement_offset()));
2077 
2078     bind(profile_continue);
2079   }
2080 }
2081 
2082 void InterpreterMacroAssembler::profile_array(Register mdp,
2083                                               Register array,
2084                                               Register tmp) {
2085   if (ProfileInterpreter) {
2086     Label profile_continue;
2087 
2088     // If no method data exists, go to profile_continue.
2089     test_method_data_pointer(mdp, profile_continue);
2090 
2091     mov(tmp, array);
2092     profile_obj_type(tmp, Address(mdp, in_bytes(ArrayLoadStoreData::array_offset())));
2093 
2094     Label not_flat;
2095     test_non_flattened_array_oop(array, tmp, not_flat);
2096 
2097     set_mdp_flag_at(mdp, ArrayLoadStoreData::flat_array_byte_constant());
2098 
2099     bind(not_flat);
2100 
2101     Label not_null_free;
2102     test_non_null_free_array_oop(array, tmp, not_null_free);
2103 
2104     set_mdp_flag_at(mdp, ArrayLoadStoreData::null_free_array_byte_constant());
2105 
2106     bind(not_null_free);
2107 
2108     bind(profile_continue);
2109   }
2110 }
2111 
2112 void InterpreterMacroAssembler::profile_element(Register mdp,
2113                                                 Register element,
2114                                                 Register tmp) {
2115   if (ProfileInterpreter) {
2116     Label profile_continue;
2117 
2118     // If no method data exists, go to profile_continue.
2119     test_method_data_pointer(mdp, profile_continue);
2120 
2121     mov(tmp, element);
2122     profile_obj_type(tmp, Address(mdp, in_bytes(ArrayLoadStoreData::element_offset())));
2123 
2124     // The method data pointer needs to be updated.
2125     update_mdp_by_constant(mdp, in_bytes(ArrayLoadStoreData::array_load_store_data_size()));
2126 
2127     bind(profile_continue);
2128   }
2129 }
2130 
2131 void InterpreterMacroAssembler::_interp_verify_oop(Register reg, TosState state, const char* file, int line) {
2132   if (state == atos) {
2133     MacroAssembler::_verify_oop(reg, &quot;broken oop&quot;, file, line);
2134   }
2135 }
2136 
2137 void InterpreterMacroAssembler::verify_FPU(int stack_depth, TosState state) {
2138 #ifndef _LP64
2139   if ((state == ftos &amp;&amp; UseSSE &lt; 1) ||
2140       (state == dtos &amp;&amp; UseSSE &lt; 2)) {
2141     MacroAssembler::verify_FPU(stack_depth);
2142   }
2143 #endif
2144 }
2145 
2146 // Jump if ((*counter_addr += increment) &amp; mask) satisfies the condition.
2147 void InterpreterMacroAssembler::increment_mask_and_jump(Address counter_addr,
2148                                                         int increment, Address mask,
2149                                                         Register scratch, bool preloaded,
2150                                                         Condition cond, Label* where) {
2151   if (!preloaded) {
2152     movl(scratch, counter_addr);
2153   }
2154   incrementl(scratch, increment);
2155   movl(counter_addr, scratch);
2156   andl(scratch, mask);
2157   if (where != NULL) {
2158     jcc(cond, *where);
2159   }
2160 }
2161 
2162 void InterpreterMacroAssembler::notify_method_entry() {
2163   // Whenever JVMTI is interp_only_mode, method entry/exit events are sent to
2164   // track stack depth.  If it is possible to enter interp_only_mode we add
2165   // the code to check if the event should be sent.
2166   Register rthread = LP64_ONLY(r15_thread) NOT_LP64(rcx);
2167   Register rarg = LP64_ONLY(c_rarg1) NOT_LP64(rbx);
2168   if (JvmtiExport::can_post_interpreter_events()) {
2169     Label L;
2170     NOT_LP64(get_thread(rthread);)
2171     movl(rdx, Address(rthread, JavaThread::interp_only_mode_offset()));
2172     testl(rdx, rdx);
2173     jcc(Assembler::zero, L);
2174     call_VM(noreg, CAST_FROM_FN_PTR(address,
2175                                     InterpreterRuntime::post_method_entry));
2176     bind(L);
2177   }
2178 
2179   {
2180     SkipIfEqual skip(this, &amp;DTraceMethodProbes, false);
2181     NOT_LP64(get_thread(rthread);)
2182     get_method(rarg);
2183     call_VM_leaf(CAST_FROM_FN_PTR(address, SharedRuntime::dtrace_method_entry),
2184                  rthread, rarg);
2185   }
2186 
2187   // RedefineClasses() tracing support for obsolete method entry
2188   if (log_is_enabled(Trace, redefine, class, obsolete)) {
2189     NOT_LP64(get_thread(rthread);)
2190     get_method(rarg);
2191     call_VM_leaf(
2192       CAST_FROM_FN_PTR(address, SharedRuntime::rc_trace_method_entry),
2193       rthread, rarg);
2194   }
2195 }
2196 
2197 
2198 void InterpreterMacroAssembler::notify_method_exit(
2199     TosState state, NotifyMethodExitMode mode) {
2200   // Whenever JVMTI is interp_only_mode, method entry/exit events are sent to
2201   // track stack depth.  If it is possible to enter interp_only_mode we add
2202   // the code to check if the event should be sent.
2203   Register rthread = LP64_ONLY(r15_thread) NOT_LP64(rcx);
2204   Register rarg = LP64_ONLY(c_rarg1) NOT_LP64(rbx);
2205   if (mode == NotifyJVMTI &amp;&amp; JvmtiExport::can_post_interpreter_events()) {
2206     Label L;
2207     // Note: frame::interpreter_frame_result has a dependency on how the
2208     // method result is saved across the call to post_method_exit. If this
2209     // is changed then the interpreter_frame_result implementation will
2210     // need to be updated too.
2211 
2212     // template interpreter will leave the result on the top of the stack.
2213     push(state);
2214     NOT_LP64(get_thread(rthread);)
2215     movl(rdx, Address(rthread, JavaThread::interp_only_mode_offset()));
2216     testl(rdx, rdx);
2217     jcc(Assembler::zero, L);
2218     call_VM(noreg,
2219             CAST_FROM_FN_PTR(address, InterpreterRuntime::post_method_exit));
2220     bind(L);
2221     pop(state);
2222   }
2223 
2224   {
2225     SkipIfEqual skip(this, &amp;DTraceMethodProbes, false);
2226     push(state);
2227     NOT_LP64(get_thread(rthread);)
2228     get_method(rarg);
2229     call_VM_leaf(CAST_FROM_FN_PTR(address, SharedRuntime::dtrace_method_exit),
2230                  rthread, rarg);
2231     pop(state);
2232   }
2233 }
    </pre>
  </body>
</html>