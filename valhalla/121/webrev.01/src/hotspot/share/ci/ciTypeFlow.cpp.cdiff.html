<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff src/hotspot/share/ci/ciTypeFlow.cpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
  </head>
<body>
<center><a href="ciTypeArrayKlass.hpp.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="ciTypeFlow.hpp.cdiff.html" target="_top">next &gt;</a></center>    <h2>src/hotspot/share/ci/ciTypeFlow.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 23,17 ***</span>
   */
  
  #include &quot;precompiled.hpp&quot;
  #include &quot;ci/ciConstant.hpp&quot;
  #include &quot;ci/ciField.hpp&quot;
  #include &quot;ci/ciMethod.hpp&quot;
  #include &quot;ci/ciMethodData.hpp&quot;
  #include &quot;ci/ciObjArrayKlass.hpp&quot;
  #include &quot;ci/ciStreams.hpp&quot;
  #include &quot;ci/ciTypeArrayKlass.hpp&quot;
  #include &quot;ci/ciTypeFlow.hpp&quot;
<span class="line-removed">- #include &quot;ci/ciValueKlass.hpp&quot;</span>
  #include &quot;compiler/compileLog.hpp&quot;
  #include &quot;interpreter/bytecode.hpp&quot;
  #include &quot;interpreter/bytecodes.hpp&quot;
  #include &quot;memory/allocation.inline.hpp&quot;
  #include &quot;memory/resourceArea.hpp&quot;
<span class="line-new-header">--- 23,17 ---</span>
   */
  
  #include &quot;precompiled.hpp&quot;
  #include &quot;ci/ciConstant.hpp&quot;
  #include &quot;ci/ciField.hpp&quot;
<span class="line-added">+ #include &quot;ci/ciInlineKlass.hpp&quot;</span>
  #include &quot;ci/ciMethod.hpp&quot;
  #include &quot;ci/ciMethodData.hpp&quot;
  #include &quot;ci/ciObjArrayKlass.hpp&quot;
  #include &quot;ci/ciStreams.hpp&quot;
  #include &quot;ci/ciTypeArrayKlass.hpp&quot;
  #include &quot;ci/ciTypeFlow.hpp&quot;
  #include &quot;compiler/compileLog.hpp&quot;
  #include &quot;interpreter/bytecode.hpp&quot;
  #include &quot;interpreter/bytecodes.hpp&quot;
  #include &quot;memory/allocation.inline.hpp&quot;
  #include &quot;memory/resourceArea.hpp&quot;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 278,20 ***</span>
      return t1;
    } else if (t1-&gt;is_primitive_type() || t2-&gt;is_primitive_type()) {
      // Special case null_type.  null_type meet any reference type T
      // is T (except for inline types).  null_type meet null_type is null_type.
      if (t1-&gt;equals(null_type())) {
<span class="line-modified">!       if (t2-&gt;is_valuetype()) {</span>
          // Inline types are null-free, return the super type
<span class="line-modified">!         return t2-&gt;as_value_klass()-&gt;super();</span>
        } else if (!t2-&gt;is_primitive_type() || t2-&gt;equals(null_type())) {
          return t2;
        }
      } else if (t2-&gt;equals(null_type())) {
<span class="line-modified">!       if (t1-&gt;is_valuetype()) {</span>
          // Inline types are null-free, return the super type
<span class="line-modified">!         return t1-&gt;as_value_klass()-&gt;super();</span>
        } else if (!t1-&gt;is_primitive_type()) {
          return t1;
        }
      }
  
<span class="line-new-header">--- 278,20 ---</span>
      return t1;
    } else if (t1-&gt;is_primitive_type() || t2-&gt;is_primitive_type()) {
      // Special case null_type.  null_type meet any reference type T
      // is T (except for inline types).  null_type meet null_type is null_type.
      if (t1-&gt;equals(null_type())) {
<span class="line-modified">!       if (t2-&gt;is_inlinetype()) {</span>
          // Inline types are null-free, return the super type
<span class="line-modified">!         return t2-&gt;as_inline_klass()-&gt;super();</span>
        } else if (!t2-&gt;is_primitive_type() || t2-&gt;equals(null_type())) {
          return t2;
        }
      } else if (t2-&gt;equals(null_type())) {
<span class="line-modified">!       if (t1-&gt;is_inlinetype()) {</span>
          // Inline types are null-free, return the super type
<span class="line-modified">!         return t1-&gt;as_inline_klass()-&gt;super();</span>
        } else if (!t1-&gt;is_primitive_type()) {
          return t1;
        }
      }
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 314,15 ***</span>
      // When an interface meets a non-interface, we get Object;
      // This is what the verifier does.
      return object_klass;
    } else if (k1-&gt;is_array_klass() || k2-&gt;is_array_klass()) {
      // When an array meets a non-array, we get Object.
<span class="line-modified">!     // When (obj/value)Array meets typeArray, we also get Object.</span>
      // And when typeArray meets different typeArray, we again get Object.
<span class="line-modified">!     // But when (obj/value)Array meets (obj/value)Array, we look carefully at element types.</span>
<span class="line-modified">!     if ((k1-&gt;is_obj_array_klass() || k1-&gt;is_value_array_klass()) &amp;&amp;</span>
<span class="line-modified">!         (k2-&gt;is_obj_array_klass() || k2-&gt;is_value_array_klass())) {</span>
        ciType* elem1 = k1-&gt;as_array_klass()-&gt;element_klass();
        ciType* elem2 = k2-&gt;as_array_klass()-&gt;element_klass();
        ciType* elem = elem1;
        if (elem1 != elem2) {
          elem = type_meet_internal(elem1, elem2, analyzer)-&gt;as_klass();
<span class="line-new-header">--- 314,15 ---</span>
      // When an interface meets a non-interface, we get Object;
      // This is what the verifier does.
      return object_klass;
    } else if (k1-&gt;is_array_klass() || k2-&gt;is_array_klass()) {
      // When an array meets a non-array, we get Object.
<span class="line-modified">!     // When (obj/flat)Array meets typeArray, we also get Object.</span>
      // And when typeArray meets different typeArray, we again get Object.
<span class="line-modified">!     // But when (obj/flat)Array meets (obj/flat)Array, we look carefully at element types.</span>
<span class="line-modified">!     if ((k1-&gt;is_obj_array_klass() || k1-&gt;is_flat_array_klass()) &amp;&amp;</span>
<span class="line-modified">!         (k2-&gt;is_obj_array_klass() || k2-&gt;is_flat_array_klass())) {</span>
        ciType* elem1 = k1-&gt;as_array_klass()-&gt;element_klass();
        ciType* elem2 = k2-&gt;as_array_klass()-&gt;element_klass();
        ciType* elem = elem1;
        if (elem1 != elem2) {
          elem = type_meet_internal(elem1, elem2, analyzer)-&gt;as_klass();
</pre>
<hr />
<pre>
<span class="line-old-header">*** 559,11 ***</span>
  
  // ------------------------------------------------------------------
  // ciTypeFlow::StateVector::do_aload
  void ciTypeFlow::StateVector::do_aload(ciBytecodeStream* str) {
    pop_int();
<span class="line-modified">!   ciArrayKlass* array_klass = pop_objOrValueArray();</span>
    if (array_klass == NULL) {
      // Did aload on a null reference; push a null and ignore the exception.
      // This instruction will never continue normally.  All we have to do
      // is report a value that will meet correctly with any downstream
      // reference types on paths that will truly be executed.  This null type
<span class="line-new-header">--- 559,11 ---</span>
  
  // ------------------------------------------------------------------
  // ciTypeFlow::StateVector::do_aload
  void ciTypeFlow::StateVector::do_aload(ciBytecodeStream* str) {
    pop_int();
<span class="line-modified">!   ciArrayKlass* array_klass = pop_objOrFlatArray();</span>
    if (array_klass == NULL) {
      // Did aload on a null reference; push a null and ignore the exception.
      // This instruction will never continue normally.  All we have to do
      // is report a value that will meet correctly with any downstream
      // reference types on paths that will truly be executed.  This null type
</pre>
<hr />
<pre>
<span class="line-old-header">*** 793,11 ***</span>
    bool will_link;
    ciKlass* klass = str-&gt;get_klass(will_link);
    if (!will_link) {
      trap(str, klass, str-&gt;get_klass_index());
    } else {
<span class="line-modified">!     assert(klass-&gt;is_valuetype(), &quot;should be value type&quot;);</span>
      push_object(klass);
    }
  }
  
  // ------------------------------------------------------------------
<span class="line-new-header">--- 793,11 ---</span>
    bool will_link;
    ciKlass* klass = str-&gt;get_klass(will_link);
    if (!will_link) {
      trap(str, klass, str-&gt;get_klass_index());
    } else {
<span class="line-modified">!     assert(klass-&gt;is_inlinetype(), &quot;should be inline type&quot;);</span>
      push_object(klass);
    }
  }
  
  // ------------------------------------------------------------------
</pre>
<hr />
<pre>
<span class="line-old-header">*** 816,11 ***</span>
        ciType* type2 = pop_value();
        assert(type2-&gt;is_two_word(), &quot;must be 2nd half&quot;);
        assert(type == half_type(type2), &quot;must be 2nd half&quot;);
      }
      pop_object();
<span class="line-modified">!     assert(klass-&gt;is_valuetype(), &quot;should be value type&quot;);</span>
      push_object(klass);
    }
  }
  
  // ------------------------------------------------------------------
<span class="line-new-header">--- 816,11 ---</span>
        ciType* type2 = pop_value();
        assert(type2-&gt;is_two_word(), &quot;must be 2nd half&quot;);
        assert(type == half_type(type2), &quot;must be 2nd half&quot;);
      }
      pop_object();
<span class="line-modified">!     assert(klass-&gt;is_inlinetype(), &quot;should be inline type&quot;);</span>
      push_object(klass);
    }
  }
  
  // ------------------------------------------------------------------
</pre>
<hr />
<pre>
<span class="line-old-header">*** 932,11 ***</span>
  
    case Bytecodes::_aastore:
      {
        pop_object();
        pop_int();
<span class="line-modified">!       pop_objOrValueArray();</span>
        break;
      }
    case Bytecodes::_aconst_null:
      {
        push_null();
<span class="line-new-header">--- 932,11 ---</span>
  
    case Bytecodes::_aastore:
      {
        pop_object();
        pop_int();
<span class="line-modified">!       pop_objOrFlatArray();</span>
        break;
      }
    case Bytecodes::_aconst_null:
      {
        push_null();
</pre>
<center><a href="ciTypeArrayKlass.hpp.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="ciTypeFlow.hpp.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>