<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff test/hotspot/jtreg/runtime/valhalla/valuetypes/ValueTypesTest.java</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
  </head>
<body>
<center><a href="ValueTypeCreation.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> next &gt;</center>    <h2>test/hotspot/jtreg/runtime/valhalla/valuetypes/ValueTypesTest.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
129                         .ifcmp(TypeTag.I, CondKind.NE, &quot;end&quot;);
130                         n--;
131                     }
132                     CODE
133                     .iconst_1()
134                     .return_(TypeTag.Z)
135                     .label(&quot;end&quot;)
136                     .iconst_0()
137                     .return_(TypeTag.Z);
138                 });
139         boolean result = (boolean) fromExecStackToLocalVar.invokeExact();
140         System.out.println(result);
141         assertTrue(result, &quot;Invariant&quot;);
142     }
143 
144     static void testExecutionStackToFields(Class&lt;?&gt; inlineClass, Class&lt;?&gt; containerClass) throws Throwable {
145         final int ITERATIONS = Platform.isDebugBuild() ? 3 : 512;
146         String sig = &quot;()Q&quot; + inlineClass.getName() + &quot;;&quot;;
147         final String methodSignature = sig.replace(&#39;.&#39;, &#39;/&#39;);
148         final String fieldQSignature = &quot;Q&quot; + inlineClass.getName().replace(&#39;.&#39;, &#39;/&#39;) + &quot;;&quot;;
<span class="line-modified">149         final String fieldLSignature = &quot;L&quot; + inlineClass.getName().replace(&#39;.&#39;, &#39;/&#39;) + &quot;;&quot;;</span>
150         System.out.println(methodSignature);
151         MethodHandle fromExecStackToFields = MethodHandleBuilder.loadCode(
152                 LOOKUP,
153                 &quot;execStackToFields&quot;,
154                 MethodType.methodType(boolean.class),
155                 CODE -&gt; {
156                     CODE
157                     .invokestatic(System.class, &quot;gc&quot;, &quot;()V&quot;, false)
158                     .new_(containerClass)
159                     .dup()
160                     .invoke(MacroCodeBuilder.InvocationKind.INVOKESPECIAL, containerClass, &quot;&lt;init&gt;&quot;, &quot;()V&quot;, false)
161                     .astore_1()
162                     .iconst_m1()
163                     .istore_2()
164                     .label(&quot;loop&quot;)
165                     .iload_2()
166                     .ldc(ITERATIONS)
167                     .ifcmp(TypeTag.I, CondKind.EQ, &quot;end&quot;)
168                     .aload_1()
169                     .invokestatic(inlineClass, &quot;getInstance&quot;, methodSignature, false)
170                     .putfield(containerClass, &quot;nonStaticValueField&quot;, fieldQSignature)
171                     .invokestatic(System.class, &quot;gc&quot;, &quot;()V&quot;, false)
172                     .aload_1()
173                     .getfield(containerClass, &quot;nonStaticValueField&quot;, fieldQSignature)
174                     .invokevirtual(inlineClass, &quot;verify&quot;, &quot;()Z&quot;, false)
175                     .iconst_1()
176                     .ifcmp(TypeTag.I, CondKind.NE, &quot;failed&quot;)
177                     .aload_1()
178                     .invokestatic(inlineClass, &quot;getNonBufferedInstance&quot;, methodSignature, false)
179                     .putfield(containerClass, &quot;nonStaticValueField&quot;, fieldQSignature)
180                     .invokestatic(System.class, &quot;gc&quot;, &quot;()V&quot;, false)
181                     .aload_1()
182                     .getfield(containerClass, &quot;nonStaticValueField&quot;, fieldQSignature)
183                     .invokevirtual(inlineClass, &quot;verify&quot;, &quot;()Z&quot;, false)
184                     .iconst_1()
185                     .ifcmp(TypeTag.I, CondKind.NE, &quot;failed&quot;)
186                     .invokestatic(inlineClass, &quot;getInstance&quot;, methodSignature, false)
187                     .putstatic(containerClass, &quot;staticValueField&quot;, fieldLSignature)
188                     .invokestatic(System.class, &quot;gc&quot;, &quot;()V&quot;, false)
189                     .getstatic(containerClass, &quot;staticValueField&quot;, fieldLSignature)

190                     .invokevirtual(inlineClass, &quot;verify&quot;, &quot;()Z&quot;, false)
191                     .iconst_1()
192                     .ifcmp(TypeTag.I, CondKind.NE, &quot;failed&quot;)
193                     .invokestatic(inlineClass, &quot;getNonBufferedInstance&quot;, methodSignature, false)
194                     .putstatic(containerClass, &quot;staticValueField&quot;, fieldLSignature)
195                     .invokestatic(System.class, &quot;gc&quot;, &quot;()V&quot;, false)
196                     .getstatic(containerClass, &quot;staticValueField&quot;, fieldLSignature)

197                     .invokevirtual(inlineClass, &quot;verify&quot;, &quot;()Z&quot;, false)
198                     .iconst_1()
199                     .ifcmp(TypeTag.I, CondKind.NE, &quot;failed&quot;)
200                     .iinc(2, 1)
201                     .goto_(&quot;loop&quot;)
202                     .label(&quot;end&quot;)
203                     .iconst_1()
204                     .return_(TypeTag.Z)
205                     .label(&quot;failed&quot;)
206                     .iconst_0()
207                     .return_(TypeTag.Z);
208                 });
209         boolean result = (boolean) fromExecStackToFields.invokeExact();
210         System.out.println(result);
211         assertTrue(result, &quot;Invariant&quot;);
212     }
213 
214     static void testExecutionStackToValueArray(Class&lt;?&gt; inlineClass, Class&lt;?&gt; containerClass) throws Throwable {
215         final int ITERATIONS = Platform.isDebugBuild() ? 3 : 100;
216         String sig = &quot;()Q&quot; + inlineClass.getName() + &quot;;&quot;;
</pre>
</td>
<td>
<hr />
<pre>
129                         .ifcmp(TypeTag.I, CondKind.NE, &quot;end&quot;);
130                         n--;
131                     }
132                     CODE
133                     .iconst_1()
134                     .return_(TypeTag.Z)
135                     .label(&quot;end&quot;)
136                     .iconst_0()
137                     .return_(TypeTag.Z);
138                 });
139         boolean result = (boolean) fromExecStackToLocalVar.invokeExact();
140         System.out.println(result);
141         assertTrue(result, &quot;Invariant&quot;);
142     }
143 
144     static void testExecutionStackToFields(Class&lt;?&gt; inlineClass, Class&lt;?&gt; containerClass) throws Throwable {
145         final int ITERATIONS = Platform.isDebugBuild() ? 3 : 512;
146         String sig = &quot;()Q&quot; + inlineClass.getName() + &quot;;&quot;;
147         final String methodSignature = sig.replace(&#39;.&#39;, &#39;/&#39;);
148         final String fieldQSignature = &quot;Q&quot; + inlineClass.getName().replace(&#39;.&#39;, &#39;/&#39;) + &quot;;&quot;;
<span class="line-modified">149         final String fieldLSignature = &quot;L&quot; + inlineClass.getName().replace(&#39;.&#39;, &#39;/&#39;) + &quot;$ref;&quot;;</span>
150         System.out.println(methodSignature);
151         MethodHandle fromExecStackToFields = MethodHandleBuilder.loadCode(
152                 LOOKUP,
153                 &quot;execStackToFields&quot;,
154                 MethodType.methodType(boolean.class),
155                 CODE -&gt; {
156                     CODE
157                     .invokestatic(System.class, &quot;gc&quot;, &quot;()V&quot;, false)
158                     .new_(containerClass)
159                     .dup()
160                     .invoke(MacroCodeBuilder.InvocationKind.INVOKESPECIAL, containerClass, &quot;&lt;init&gt;&quot;, &quot;()V&quot;, false)
161                     .astore_1()
162                     .iconst_m1()
163                     .istore_2()
164                     .label(&quot;loop&quot;)
165                     .iload_2()
166                     .ldc(ITERATIONS)
167                     .ifcmp(TypeTag.I, CondKind.EQ, &quot;end&quot;)
168                     .aload_1()
169                     .invokestatic(inlineClass, &quot;getInstance&quot;, methodSignature, false)
170                     .putfield(containerClass, &quot;nonStaticValueField&quot;, fieldQSignature)
171                     .invokestatic(System.class, &quot;gc&quot;, &quot;()V&quot;, false)
172                     .aload_1()
173                     .getfield(containerClass, &quot;nonStaticValueField&quot;, fieldQSignature)
174                     .invokevirtual(inlineClass, &quot;verify&quot;, &quot;()Z&quot;, false)
175                     .iconst_1()
176                     .ifcmp(TypeTag.I, CondKind.NE, &quot;failed&quot;)
177                     .aload_1()
178                     .invokestatic(inlineClass, &quot;getNonBufferedInstance&quot;, methodSignature, false)
179                     .putfield(containerClass, &quot;nonStaticValueField&quot;, fieldQSignature)
180                     .invokestatic(System.class, &quot;gc&quot;, &quot;()V&quot;, false)
181                     .aload_1()
182                     .getfield(containerClass, &quot;nonStaticValueField&quot;, fieldQSignature)
183                     .invokevirtual(inlineClass, &quot;verify&quot;, &quot;()Z&quot;, false)
184                     .iconst_1()
185                     .ifcmp(TypeTag.I, CondKind.NE, &quot;failed&quot;)
186                     .invokestatic(inlineClass, &quot;getInstance&quot;, methodSignature, false)
187                     .putstatic(containerClass, &quot;staticValueField&quot;, fieldLSignature)
188                     .invokestatic(System.class, &quot;gc&quot;, &quot;()V&quot;, false)
189                     .getstatic(containerClass, &quot;staticValueField&quot;, fieldLSignature)
<span class="line-added">190                     .checkcast(inlineClass)</span>
191                     .invokevirtual(inlineClass, &quot;verify&quot;, &quot;()Z&quot;, false)
192                     .iconst_1()
193                     .ifcmp(TypeTag.I, CondKind.NE, &quot;failed&quot;)
194                     .invokestatic(inlineClass, &quot;getNonBufferedInstance&quot;, methodSignature, false)
195                     .putstatic(containerClass, &quot;staticValueField&quot;, fieldLSignature)
196                     .invokestatic(System.class, &quot;gc&quot;, &quot;()V&quot;, false)
197                     .getstatic(containerClass, &quot;staticValueField&quot;, fieldLSignature)
<span class="line-added">198                     .checkcast(inlineClass)</span>
199                     .invokevirtual(inlineClass, &quot;verify&quot;, &quot;()Z&quot;, false)
200                     .iconst_1()
201                     .ifcmp(TypeTag.I, CondKind.NE, &quot;failed&quot;)
202                     .iinc(2, 1)
203                     .goto_(&quot;loop&quot;)
204                     .label(&quot;end&quot;)
205                     .iconst_1()
206                     .return_(TypeTag.Z)
207                     .label(&quot;failed&quot;)
208                     .iconst_0()
209                     .return_(TypeTag.Z);
210                 });
211         boolean result = (boolean) fromExecStackToFields.invokeExact();
212         System.out.println(result);
213         assertTrue(result, &quot;Invariant&quot;);
214     }
215 
216     static void testExecutionStackToValueArray(Class&lt;?&gt; inlineClass, Class&lt;?&gt; containerClass) throws Throwable {
217         final int ITERATIONS = Platform.isDebugBuild() ? 3 : 100;
218         String sig = &quot;()Q&quot; + inlineClass.getName() + &quot;;&quot;;
</pre>
</td>
</tr>
</table>
<center><a href="ValueTypeCreation.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> next &gt;</center>  </body>
</html>