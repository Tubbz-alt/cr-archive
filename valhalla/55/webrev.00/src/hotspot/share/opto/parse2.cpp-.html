<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Old src/hotspot/share/opto/parse2.cpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
  </head>
  <body>
    <pre>
   1 /*
   2  * Copyright (c) 1998, 2019, Oracle and/or its affiliates. All rights reserved.
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.
   8  *
   9  * This code is distributed in the hope that it will be useful, but WITHOUT
  10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  *
  23  */
  24 
  25 #include &quot;precompiled.hpp&quot;
  26 #include &quot;ci/ciMethodData.hpp&quot;
  27 #include &quot;classfile/systemDictionary.hpp&quot;
  28 #include &quot;classfile/vmSymbols.hpp&quot;
  29 #include &quot;compiler/compileLog.hpp&quot;
  30 #include &quot;interpreter/linkResolver.hpp&quot;
  31 #include &quot;memory/resourceArea.hpp&quot;
  32 #include &quot;memory/universe.hpp&quot;
  33 #include &quot;oops/oop.inline.hpp&quot;
  34 #include &quot;opto/addnode.hpp&quot;
  35 #include &quot;opto/castnode.hpp&quot;
  36 #include &quot;opto/convertnode.hpp&quot;
  37 #include &quot;opto/divnode.hpp&quot;
  38 #include &quot;opto/idealGraphPrinter.hpp&quot;
  39 #include &quot;opto/idealKit.hpp&quot;
  40 #include &quot;opto/matcher.hpp&quot;
  41 #include &quot;opto/memnode.hpp&quot;
  42 #include &quot;opto/mulnode.hpp&quot;
  43 #include &quot;opto/opaquenode.hpp&quot;
  44 #include &quot;opto/parse.hpp&quot;
  45 #include &quot;opto/runtime.hpp&quot;
  46 #include &quot;opto/valuetypenode.hpp&quot;
  47 #include &quot;runtime/deoptimization.hpp&quot;
  48 #include &quot;runtime/sharedRuntime.hpp&quot;
  49 
  50 #ifndef PRODUCT
  51 extern int explicit_null_checks_inserted,
  52            explicit_null_checks_elided;
  53 #endif
  54 
  55 Node* Parse::record_profile_for_speculation_at_array_load(Node* ld) {
  56   // Feed unused profile data to type speculation
  57   if (UseTypeSpeculation &amp;&amp; UseArrayLoadStoreProfile) {
  58     ciKlass* array_type = NULL;
  59     ciKlass* element_type = NULL;
  60     ProfilePtrKind element_ptr = ProfileMaybeNull;
  61     bool flat_array = true;
  62     bool null_free_array = true;
  63     method()-&gt;array_access_profiled_type(bci(), array_type, element_type, element_ptr, flat_array, null_free_array);
  64     if (element_type != NULL || element_ptr != ProfileMaybeNull) {
  65       ld = record_profile_for_speculation(ld, element_type, element_ptr);
  66     }
  67   }
  68   return ld;
  69 }
  70 
  71 
  72 //---------------------------------array_load----------------------------------
  73 void Parse::array_load(BasicType bt) {
  74   const Type* elemtype = Type::TOP;
  75   Node* adr = array_addressing(bt, 0, elemtype);
  76   if (stopped())  return;     // guaranteed null or range check
  77 
  78   Node* idx = pop();
  79   Node* ary = pop();
  80 
  81   // Handle value type arrays
  82   const TypeOopPtr* elemptr = elemtype-&gt;make_oopptr();
  83   const TypeAryPtr* ary_t = _gvn.type(ary)-&gt;is_aryptr();
  84   if (elemtype-&gt;isa_valuetype() != NULL) {
  85     C-&gt;set_flattened_accesses();
  86     // Load from flattened value type array
  87     Node* vt = ValueTypeNode::make_from_flattened(this, elemtype-&gt;value_klass(), ary, adr);
  88     push(vt);
  89     return;
  90   } else if (elemptr != NULL &amp;&amp; elemptr-&gt;is_valuetypeptr() &amp;&amp; !elemptr-&gt;maybe_null()) {
  91     // Load from non-flattened but flattenable value type array (elements can never be null)
  92     bt = T_VALUETYPE;
  93   } else if (!ary_t-&gt;is_not_flat()) {
  94     // Cannot statically determine if array is flattened, emit runtime check
  95     assert(ValueArrayFlatten &amp;&amp; is_reference_type(bt) &amp;&amp; elemptr-&gt;can_be_value_type() &amp;&amp; !ary_t-&gt;klass_is_exact() &amp;&amp; !ary_t-&gt;is_not_null_free() &amp;&amp;
  96            (!elemptr-&gt;is_valuetypeptr() || elemptr-&gt;value_klass()-&gt;flatten_array()), &quot;array can&#39;t be flattened&quot;);
  97     Node* ctl = control();
  98     IdealKit ideal(this);
  99     IdealVariable res(ideal);
 100     ideal.declarations_done();
 101     Node* flattened = gen_flattened_array_test(ary);
 102     ideal.if_then(flattened, BoolTest::ne, zerocon(flattened-&gt;bottom_type()-&gt;basic_type())); {
 103       // flattened
 104       sync_kit(ideal);
 105       if (elemptr-&gt;is_valuetypeptr()) {
 106         // Element type is known, cast and load from flattened representation
 107         ciValueKlass* vk = elemptr-&gt;value_klass();
 108         assert(vk-&gt;flatten_array() &amp;&amp; elemptr-&gt;maybe_null(), &quot;must be a flattenable and nullable array&quot;);
 109         ciArrayKlass* array_klass = ciArrayKlass::make(vk, /* never_null */ true);
 110         const TypeAryPtr* arytype = TypeOopPtr::make_from_klass(array_klass)-&gt;isa_aryptr();
 111         Node* cast = _gvn.transform(new CheckCastPPNode(control(), ary, arytype));
 112         Node* casted_adr = array_element_address(cast, idx, T_VALUETYPE, ary_t-&gt;size(), control());
 113         // Re-execute flattened array load if buffering triggers deoptimization
 114         PreserveReexecuteState preexecs(this);
 115         jvms()-&gt;set_should_reexecute(true);
 116         inc_sp(2);
 117         Node* vt = ValueTypeNode::make_from_flattened(this, vk, cast, casted_adr)-&gt;allocate(this, false)-&gt;get_oop();
 118         ideal.set(res, vt);
 119         ideal.sync_kit(this);
 120       } else {
 121         Node* kls = load_object_klass(ary);
 122         // Element type is unknown, emit runtime call
 123         Node* k_adr = basic_plus_adr(kls, in_bytes(ArrayKlass::element_klass_offset()));
 124         Node* elem_klass = _gvn.transform(LoadKlassNode::make(_gvn, NULL, immutable_memory(), k_adr, TypeInstPtr::KLASS));
 125         Node* obj_size  = NULL;
 126         kill_dead_locals();
 127         // Re-execute flattened array load if buffering triggers deoptimization
 128         PreserveReexecuteState preexecs(this);
 129         jvms()-&gt;set_bci(_bci);
 130         jvms()-&gt;set_should_reexecute(true);
 131         inc_sp(2);
 132         Node* alloc_obj = new_instance(elem_klass, NULL, &amp;obj_size, /*deoptimize_on_exception=*/true);
 133 
 134         AllocateNode* alloc = AllocateNode::Ideal_allocation(alloc_obj, &amp;_gvn);
 135         assert(alloc-&gt;maybe_set_complete(&amp;_gvn), &quot;&quot;);
 136         alloc-&gt;initialization()-&gt;set_complete_with_arraycopy();
 137 
 138         // This membar keeps this access to an unknown flattened array
 139         // correctly ordered with other unknown and known flattened
 140         // array accesses.
 141         insert_mem_bar_volatile(Op_MemBarCPUOrder, C-&gt;get_alias_index(TypeAryPtr::VALUES));
 142 
 143         BarrierSetC2* bs = BarrierSet::barrier_set()-&gt;barrier_set_c2();
 144         // Unknown value type might contain reference fields
 145         if (false &amp;&amp; !bs-&gt;array_copy_requires_gc_barriers(false, T_OBJECT, false, BarrierSetC2::Parsing)) {
 146           // FIXME 8230656 also merge changes from 8238759 in
 147           int base_off = sizeof(instanceOopDesc);
 148           Node* dst_base = basic_plus_adr(alloc_obj, base_off);
 149           Node* countx = obj_size;
 150           countx = _gvn.transform(new SubXNode(countx, MakeConX(base_off)));
 151           countx = _gvn.transform(new URShiftXNode(countx, intcon(LogBytesPerLong)));
 152 
 153           assert(Klass::_lh_log2_element_size_shift == 0, &quot;use shift in place&quot;);
 154           Node* lhp = basic_plus_adr(kls, in_bytes(Klass::layout_helper_offset()));
 155           Node* elem_shift = make_load(NULL, lhp, TypeInt::INT, T_INT, MemNode::unordered);
 156           uint header = arrayOopDesc::base_offset_in_bytes(T_VALUETYPE);
 157           Node* base  = basic_plus_adr(ary, header);
 158           idx = Compile::conv_I2X_index(&amp;_gvn, idx, TypeInt::POS, control());
 159           Node* scale = _gvn.transform(new LShiftXNode(idx, elem_shift));
 160           Node* adr = basic_plus_adr(ary, base, scale);
 161 
 162           access_clone(adr, dst_base, countx, false);
 163         } else {
 164           ideal.sync_kit(this);
 165           ideal.make_leaf_call(OptoRuntime::load_unknown_value_Type(),
 166                                CAST_FROM_FN_PTR(address, OptoRuntime::load_unknown_value),
 167                                &quot;load_unknown_value&quot;,
 168                                ary, idx, alloc_obj);
 169           sync_kit(ideal);
 170         }
 171 
 172         // This makes sure no other thread sees a partially initialized buffered value
 173         insert_mem_bar_volatile(Op_MemBarStoreStore, Compile::AliasIdxRaw, alloc-&gt;proj_out_or_null(AllocateNode::RawAddress));
 174 
 175         // Same as MemBarCPUOrder above: keep this unknown flattened
 176         // array access correctly ordered with other flattened array
 177         // access
 178         insert_mem_bar_volatile(Op_MemBarCPUOrder, C-&gt;get_alias_index(TypeAryPtr::VALUES));
 179 
 180         // Prevent any use of the newly allocated value before it is
 181         // fully initialized
 182         alloc_obj = new CastPPNode(alloc_obj, _gvn.type(alloc_obj), true);
 183         alloc_obj-&gt;set_req(0, control());
 184         alloc_obj = _gvn.transform(alloc_obj);
 185 
 186         const Type* unknown_value = elemptr-&gt;is_instptr()-&gt;cast_to_flat_array();
 187         alloc_obj = _gvn.transform(new CheckCastPPNode(control(), alloc_obj, unknown_value));
 188 
 189         ideal.sync_kit(this);
 190         ideal.set(res, alloc_obj);
 191       }
 192     } ideal.else_(); {
 193       // non-flattened
 194       sync_kit(ideal);
 195       const TypeAryPtr* adr_type = TypeAryPtr::get_array_body_type(bt);
 196       Node* ld = access_load_at(ary, adr, adr_type, elemptr, bt,
 197                                 IN_HEAP | IS_ARRAY | C2_CONTROL_DEPENDENT_LOAD, ctl);
 198       ideal.sync_kit(this);
 199       ideal.set(res, ld);
 200     } ideal.end_if();
 201     sync_kit(ideal);
 202     Node* ld = _gvn.transform(ideal.value(res));
 203     ld = record_profile_for_speculation_at_array_load(ld);
 204     push_node(bt, ld);
 205     return;
 206   }
 207 
 208   if (elemtype == TypeInt::BOOL) {
 209     bt = T_BOOLEAN;
 210   }
 211   const TypeAryPtr* adr_type = TypeAryPtr::get_array_body_type(bt);
 212   Node* ld = access_load_at(ary, adr, adr_type, elemtype, bt,
 213                             IN_HEAP | IS_ARRAY | C2_CONTROL_DEPENDENT_LOAD);
 214   if (bt == T_VALUETYPE) {
 215     // Loading a non-flattened (but flattenable) value type from an array
 216     assert(!gvn().type(ld)-&gt;maybe_null(), &quot;value type array elements should never be null&quot;);
 217     if (elemptr-&gt;value_klass()-&gt;is_scalarizable()) {
 218       ld = ValueTypeNode::make_from_oop(this, ld, elemptr-&gt;value_klass());
 219     }
 220   }
 221   if (!ld-&gt;is_ValueType()) {
 222     ld = record_profile_for_speculation_at_array_load(ld);
 223   }
 224 
 225   push_node(bt, ld);
 226 }
 227 
 228 
 229 //--------------------------------array_store----------------------------------
 230 void Parse::array_store(BasicType bt) {
 231   const Type* elemtype = Type::TOP;
 232   Node* adr = array_addressing(bt, type2size[bt], elemtype);
 233   if (stopped())  return;     // guaranteed null or range check
 234   Node* cast_val = NULL;
 235   if (bt == T_OBJECT) {
 236     cast_val = array_store_check();
 237     if (stopped()) return;
 238   }
 239   Node* val = pop_node(bt); // Value to store
 240   Node* idx = pop();        // Index in the array
 241   Node* ary = pop();        // The array itself
 242 
 243   const TypeAryPtr* ary_t = _gvn.type(ary)-&gt;is_aryptr();
 244   const TypeAryPtr* adr_type = TypeAryPtr::get_array_body_type(bt);
 245 
 246   if (elemtype == TypeInt::BOOL) {
 247     bt = T_BOOLEAN;
 248   } else if (bt == T_OBJECT) {
 249     elemtype = elemtype-&gt;make_oopptr();
 250     const Type* tval = _gvn.type(cast_val);
 251     // We may have lost type information for &#39;val&#39; here due to the casts
 252     // emitted by the array_store_check code (see JDK-6312651)
 253     // TODO Remove this code once JDK-6312651 is in.
 254     const Type* tval_init = _gvn.type(val);
 255     bool can_be_value_type = tval-&gt;isa_valuetype() || (tval != TypePtr::NULL_PTR &amp;&amp; tval_init-&gt;is_oopptr()-&gt;can_be_value_type() &amp;&amp; tval-&gt;is_oopptr()-&gt;can_be_value_type());
 256     bool not_flattenable = !can_be_value_type || ((tval_init-&gt;is_valuetypeptr() || tval_init-&gt;isa_valuetype()) &amp;&amp; !tval_init-&gt;value_klass()-&gt;flatten_array());
 257 
 258     if (!ary_t-&gt;is_not_null_free() &amp;&amp; !can_be_value_type &amp;&amp; (!tval-&gt;maybe_null() || !tval_init-&gt;maybe_null())) {
 259       // Storing a non-inline-type, mark array as not null-free.
 260       // This is only legal for non-null stores because the array_store_check passes for null.
 261       ary_t = ary_t-&gt;cast_to_not_null_free();
 262       Node* cast = _gvn.transform(new CheckCastPPNode(control(), ary, ary_t));
 263       replace_in_map(ary, cast);
 264       ary = cast;
 265     } else if (!ary_t-&gt;is_not_flat() &amp;&amp; not_flattenable) {
 266       // Storing a non-flattenable value, mark array as not flat.
 267       ary_t = ary_t-&gt;cast_to_not_flat();
 268       if (tval != TypePtr::NULL_PTR) {
 269         // For NULL, this transformation is only valid after the null guard below
 270         Node* cast = _gvn.transform(new CheckCastPPNode(control(), ary, ary_t));
 271         replace_in_map(ary, cast);
 272         ary = cast;
 273       }
 274     }
 275 
 276     if (ary_t-&gt;elem()-&gt;isa_valuetype() != NULL) {
 277       // Store to flattened value type array
 278       C-&gt;set_flattened_accesses();
 279       if (!cast_val-&gt;is_ValueType()) {
 280         inc_sp(3);
 281         cast_val = null_check(cast_val);
 282         if (stopped()) return;
 283         dec_sp(3);
 284         cast_val = ValueTypeNode::make_from_oop(this, cast_val, ary_t-&gt;elem()-&gt;value_klass());
 285       }
 286       // Re-execute flattened array store if buffering triggers deoptimization
 287       PreserveReexecuteState preexecs(this);
 288       inc_sp(3);
 289       jvms()-&gt;set_should_reexecute(true);
 290       cast_val-&gt;as_ValueType()-&gt;store_flattened(this, ary, adr, NULL, 0, MO_UNORDERED | IN_HEAP | IS_ARRAY);
 291       return;
 292     } else if (elemtype-&gt;is_valuetypeptr() &amp;&amp; !elemtype-&gt;maybe_null()) {
 293       // Store to non-flattened but flattenable value type array (elements can never be null)
 294       if (!cast_val-&gt;is_ValueType() &amp;&amp; tval-&gt;maybe_null()) {
 295         inc_sp(3);
 296         cast_val = null_check(cast_val);
 297         if (stopped()) return;
 298         dec_sp(3);
 299       }
 300     } else if (!ary_t-&gt;is_not_flat()) {
 301       // Array might be flattened, emit runtime checks
 302       assert(ValueArrayFlatten &amp;&amp; !not_flattenable &amp;&amp; elemtype-&gt;is_oopptr()-&gt;can_be_value_type() &amp;&amp;
 303              !ary_t-&gt;klass_is_exact() &amp;&amp; !ary_t-&gt;is_not_null_free(), &quot;array can&#39;t be flattened&quot;);
 304       IdealKit ideal(this);
 305       Node* flattened = gen_flattened_array_test(ary);
 306       ideal.if_then(flattened, BoolTest::ne, zerocon(flattened-&gt;bottom_type()-&gt;basic_type())); {
 307         Node* val = cast_val;
 308         // flattened
 309         if (!val-&gt;is_ValueType() &amp;&amp; tval-&gt;maybe_null()) {
 310           // Add null check
 311           sync_kit(ideal);
 312           Node* null_ctl = top();
 313           val = null_check_oop(val, &amp;null_ctl);
 314           if (null_ctl != top()) {
 315             PreserveJVMState pjvms(this);
 316             inc_sp(3);
 317             set_control(null_ctl);
 318             uncommon_trap(Deoptimization::Reason_null_check, Deoptimization::Action_none);
 319             dec_sp(3);
 320           }
 321           ideal.sync_kit(this);
 322         }
 323         // Try to determine the value klass
 324         ciValueKlass* vk = NULL;
 325         if (tval-&gt;isa_valuetype() || tval-&gt;is_valuetypeptr()) {
 326           vk = tval-&gt;value_klass();
 327         } else if (tval_init-&gt;isa_valuetype() || tval_init-&gt;is_valuetypeptr()) {
 328           vk = tval_init-&gt;value_klass();
 329         } else if (elemtype-&gt;is_valuetypeptr()) {
 330           vk = elemtype-&gt;value_klass();
 331         }
 332         Node* casted_ary = ary;
 333         if (vk != NULL &amp;&amp; !stopped()) {
 334           // Element type is known, cast and store to flattened representation
 335           sync_kit(ideal);
 336           assert(vk-&gt;flatten_array() &amp;&amp; elemtype-&gt;maybe_null(), &quot;must be a flattenable and nullable array&quot;);
 337           ciArrayKlass* array_klass = ciArrayKlass::make(vk, /* never_null */ true);
 338           const TypeAryPtr* arytype = TypeOopPtr::make_from_klass(array_klass)-&gt;isa_aryptr();
 339           casted_ary = _gvn.transform(new CheckCastPPNode(control(), casted_ary, arytype));
 340           Node* casted_adr = array_element_address(casted_ary, idx, T_OBJECT, arytype-&gt;size(), control());
 341           if (!val-&gt;is_ValueType()) {
 342             assert(!gvn().type(val)-&gt;maybe_null(), &quot;value type array elements should never be null&quot;);
 343             val = ValueTypeNode::make_from_oop(this, val, vk);
 344           }
 345           // Re-execute flattened array store if buffering triggers deoptimization
 346           PreserveReexecuteState preexecs(this);
 347           inc_sp(3);
 348           jvms()-&gt;set_should_reexecute(true);
 349           val-&gt;as_ValueType()-&gt;store_flattened(this, casted_ary, casted_adr, NULL, 0, MO_UNORDERED | IN_HEAP | IS_ARRAY);
 350           ideal.sync_kit(this);
 351         } else if (!ideal.ctrl()-&gt;is_top()) {
 352           // Element type is unknown, emit runtime call
 353           sync_kit(ideal);
 354 
 355           // This membar keeps this access to an unknown flattened
 356           // array correctly ordered with other unknown and known
 357           // flattened array accesses.
 358           insert_mem_bar_volatile(Op_MemBarCPUOrder, C-&gt;get_alias_index(TypeAryPtr::VALUES));
 359           ideal.sync_kit(this);
 360 
 361           ideal.make_leaf_call(OptoRuntime::store_unknown_value_Type(),
 362                                CAST_FROM_FN_PTR(address, OptoRuntime::store_unknown_value),
 363                                &quot;store_unknown_value&quot;,
 364                                val, casted_ary, idx);
 365 
 366           sync_kit(ideal);
 367           // Same as MemBarCPUOrder above: keep this unknown
 368           // flattened array access correctly ordered with other
 369           // flattened array accesses.
 370           insert_mem_bar_volatile(Op_MemBarCPUOrder, C-&gt;get_alias_index(TypeAryPtr::VALUES));
 371           ideal.sync_kit(this);
 372         }
 373       }
 374       ideal.else_();
 375       {
 376         // non-flattened
 377         sync_kit(ideal);
 378         gen_value_array_null_guard(ary, cast_val, 3);
 379         inc_sp(3);
 380         access_store_at(ary, adr, adr_type, cast_val, elemtype, bt, MO_UNORDERED | IN_HEAP | IS_ARRAY, false);
 381         dec_sp(3);
 382         ideal.sync_kit(this);
 383       }
 384       ideal.end_if();
 385       sync_kit(ideal);
 386       return;
 387     } else if (!ary_t-&gt;is_not_null_free()) {
 388       // Array is not flattened but may be null free
 389       assert(elemtype-&gt;is_oopptr()-&gt;can_be_value_type() &amp;&amp; !ary_t-&gt;klass_is_exact(), &quot;array can&#39;t be null free&quot;);
 390       ary = gen_value_array_null_guard(ary, cast_val, 3, true);
 391     }
 392   }
 393   inc_sp(3);
 394   access_store_at(ary, adr, adr_type, val, elemtype, bt, MO_UNORDERED | IN_HEAP | IS_ARRAY);
 395   dec_sp(3);
 396 }
 397 
 398 
 399 //------------------------------array_addressing-------------------------------
 400 // Pull array and index from the stack.  Compute pointer-to-element.
 401 Node* Parse::array_addressing(BasicType type, int vals, const Type*&amp; elemtype) {
 402   Node *idx   = peek(0+vals);   // Get from stack without popping
 403   Node *ary   = peek(1+vals);   // in case of exception
 404 
 405   // Null check the array base, with correct stack contents
 406   ary = null_check(ary, T_ARRAY);
 407   // Compile-time detect of null-exception?
 408   if (stopped())  return top();
 409 
 410   const TypeAryPtr* arytype  = _gvn.type(ary)-&gt;is_aryptr();
 411   const TypeInt*    sizetype = arytype-&gt;size();
 412   elemtype = arytype-&gt;elem();
 413 
 414   if (UseUniqueSubclasses) {
 415     const Type* el = elemtype-&gt;make_ptr();
 416     if (el &amp;&amp; el-&gt;isa_instptr()) {
 417       const TypeInstPtr* toop = el-&gt;is_instptr();
 418       if (toop-&gt;klass()-&gt;as_instance_klass()-&gt;unique_concrete_subklass()) {
 419         // If we load from &quot;AbstractClass[]&quot; we must see &quot;ConcreteSubClass&quot;.
 420         const Type* subklass = Type::get_const_type(toop-&gt;klass());
 421         elemtype = subklass-&gt;join_speculative(el);
 422       }
 423     }
 424   }
 425 
 426   // Check for big class initializers with all constant offsets
 427   // feeding into a known-size array.
 428   const TypeInt* idxtype = _gvn.type(idx)-&gt;is_int();
 429   // See if the highest idx value is less than the lowest array bound,
 430   // and if the idx value cannot be negative:
 431   bool need_range_check = true;
 432   if (idxtype-&gt;_hi &lt; sizetype-&gt;_lo &amp;&amp; idxtype-&gt;_lo &gt;= 0) {
 433     need_range_check = false;
 434     if (C-&gt;log() != NULL)   C-&gt;log()-&gt;elem(&quot;observe that=&#39;!need_range_check&#39;&quot;);
 435   }
 436 
 437   ciKlass * arytype_klass = arytype-&gt;klass();
 438   if ((arytype_klass != NULL) &amp;&amp; (!arytype_klass-&gt;is_loaded())) {
 439     // Only fails for some -Xcomp runs
 440     // The class is unloaded.  We have to run this bytecode in the interpreter.
 441     uncommon_trap(Deoptimization::Reason_unloaded,
 442                   Deoptimization::Action_reinterpret,
 443                   arytype-&gt;klass(), &quot;!loaded array&quot;);
 444     return top();
 445   }
 446 
 447   // Do the range check
 448   if (GenerateRangeChecks &amp;&amp; need_range_check) {
 449     Node* tst;
 450     if (sizetype-&gt;_hi &lt;= 0) {
 451       // The greatest array bound is negative, so we can conclude that we&#39;re
 452       // compiling unreachable code, but the unsigned compare trick used below
 453       // only works with non-negative lengths.  Instead, hack &quot;tst&quot; to be zero so
 454       // the uncommon_trap path will always be taken.
 455       tst = _gvn.intcon(0);
 456     } else {
 457       // Range is constant in array-oop, so we can use the original state of mem
 458       Node* len = load_array_length(ary);
 459 
 460       // Test length vs index (standard trick using unsigned compare)
 461       Node* chk = _gvn.transform( new CmpUNode(idx, len) );
 462       BoolTest::mask btest = BoolTest::lt;
 463       tst = _gvn.transform( new BoolNode(chk, btest) );
 464     }
 465     RangeCheckNode* rc = new RangeCheckNode(control(), tst, PROB_MAX, COUNT_UNKNOWN);
 466     _gvn.set_type(rc, rc-&gt;Value(&amp;_gvn));
 467     if (!tst-&gt;is_Con()) {
 468       record_for_igvn(rc);
 469     }
 470     set_control(_gvn.transform(new IfTrueNode(rc)));
 471     // Branch to failure if out of bounds
 472     {
 473       PreserveJVMState pjvms(this);
 474       set_control(_gvn.transform(new IfFalseNode(rc)));
 475       if (C-&gt;allow_range_check_smearing()) {
 476         // Do not use builtin_throw, since range checks are sometimes
 477         // made more stringent by an optimistic transformation.
 478         // This creates &quot;tentative&quot; range checks at this point,
 479         // which are not guaranteed to throw exceptions.
 480         // See IfNode::Ideal, is_range_check, adjust_check.
 481         uncommon_trap(Deoptimization::Reason_range_check,
 482                       Deoptimization::Action_make_not_entrant,
 483                       NULL, &quot;range_check&quot;);
 484       } else {
 485         // If we have already recompiled with the range-check-widening
 486         // heroic optimization turned off, then we must really be throwing
 487         // range check exceptions.
 488         builtin_throw(Deoptimization::Reason_range_check, idx);
 489       }
 490     }
 491   }
 492   // Check for always knowing you are throwing a range-check exception
 493   if (stopped())  return top();
 494 
 495   // This could be an access to a value array. We can&#39;t tell if it&#39;s
 496   // flat or not. Speculating it&#39;s not leads to a much simpler graph
 497   // shape. Check profiling.
 498   // For aastore, by the time we&#39;re here, the array store check should
 499   // have already taken advantage of profiling to cast the array to an
 500   // exact type reported by profiling
 501   const TypeOopPtr* elemptr = elemtype-&gt;make_oopptr();
 502   if (elemtype-&gt;isa_valuetype() == NULL &amp;&amp;
 503       (elemptr == NULL || !elemptr-&gt;is_valuetypeptr() || elemptr-&gt;maybe_null()) &amp;&amp;
 504       !arytype-&gt;is_not_flat()) {
 505     assert(is_reference_type(type), &quot;Only references&quot;);
 506     // First check the speculative type
 507     Deoptimization::DeoptReason reason = Deoptimization::Reason_speculate_class_check;
 508     ciKlass* array_type = arytype-&gt;speculative_type();
 509     if (too_many_traps_or_recompiles(reason) || array_type == NULL) {
 510       // No speculative type, check profile data at this bci
 511       array_type = NULL;
 512       reason = Deoptimization::Reason_class_check;
 513       if (UseArrayLoadStoreProfile &amp;&amp; !too_many_traps_or_recompiles(reason)) {
 514         ciKlass* element_type = NULL;
 515         ProfilePtrKind element_ptr = ProfileMaybeNull;
 516         bool flat_array = true;
 517         bool null_free_array = true;
 518         method()-&gt;array_access_profiled_type(bci(), array_type, element_type, element_ptr, flat_array, null_free_array);
 519       }
 520     }
 521     if (array_type != NULL) {
 522       // Speculate that this array has the exact type reported by profile data
 523       Node* better_ary = NULL;
 524       Node* slow_ctl = type_check_receiver(ary, array_type, 1.0, &amp;better_ary);
 525       { PreserveJVMState pjvms(this);
 526         set_control(slow_ctl);
 527         uncommon_trap_exact(reason, Deoptimization::Action_maybe_recompile);
 528       }
 529       replace_in_map(ary, better_ary);
 530       ary = better_ary;
 531       arytype  = _gvn.type(ary)-&gt;is_aryptr();
 532       elemtype = arytype-&gt;elem();
 533     }
 534   } else if (UseTypeSpeculation &amp;&amp; UseArrayLoadStoreProfile) {
 535     // No need to speculate: feed profile data at this bci for the
 536     // array to type speculation
 537     ciKlass* array_type = NULL;
 538     ciKlass* element_type = NULL;
 539     ProfilePtrKind element_ptr = ProfileMaybeNull;
 540     bool flat_array = true;
 541     bool null_free_array = true;
 542     method()-&gt;array_access_profiled_type(bci(), array_type, element_type, element_ptr, flat_array, null_free_array);
 543     if (array_type != NULL) {
 544       record_profile_for_speculation(ary, array_type, ProfileMaybeNull);
 545     }
 546   }
 547 
 548   // We have no exact array type from profile data. Check profile data
 549   // for a non null free or non flat array. Non null free implies non
 550   // flat so check this one first. Speculating on a non null free
 551   // array doesn&#39;t help aaload but could be profitable for a
 552   // subsequent aastore.
 553   elemptr = elemtype-&gt;make_oopptr();
 554   if (!arytype-&gt;is_not_null_free() &amp;&amp;
 555       elemtype-&gt;isa_valuetype() == NULL &amp;&amp;
 556       (elemptr == NULL || !elemptr-&gt;is_valuetypeptr()) &amp;&amp;
 557       UseArrayLoadStoreProfile) {
 558     assert(is_reference_type(type), &quot;&quot;);
 559     bool null_free_array = true;
 560     Deoptimization::DeoptReason reason = Deoptimization::Reason_none;
 561     if (arytype-&gt;speculative() != NULL &amp;&amp;
 562         arytype-&gt;speculative()-&gt;is_aryptr()-&gt;is_not_null_free() &amp;&amp;
 563         !too_many_traps_or_recompiles(Deoptimization::Reason_speculate_class_check)) {
 564       null_free_array = false;
 565       reason = Deoptimization::Reason_speculate_class_check;
 566     } else if (!too_many_traps_or_recompiles(Deoptimization::Reason_class_check)) {
 567       ciKlass* array_type = NULL;
 568       ciKlass* element_type = NULL;
 569       ProfilePtrKind element_ptr = ProfileMaybeNull;
 570       bool flat_array = true;
 571       method()-&gt;array_access_profiled_type(bci(), array_type, element_type, element_ptr, flat_array, null_free_array);
 572       reason = Deoptimization::Reason_class_check;
 573     }
 574     if (!null_free_array) {
 575       Node* tst = gen_null_free_array_check(ary);
 576       {
 577         BuildCutout unless(this, tst, PROB_MAX);
 578         uncommon_trap_exact(reason, Deoptimization::Action_maybe_recompile);
 579       }
 580       Node* better_ary = _gvn.transform(new CheckCastPPNode(control(), ary, arytype-&gt;cast_to_not_null_free()));
 581       replace_in_map(ary, better_ary);
 582       ary = better_ary;
 583       arytype  = _gvn.type(ary)-&gt;is_aryptr();
 584     }
 585   }
 586 
 587   if (!arytype-&gt;is_not_flat() &amp;&amp; elemtype-&gt;isa_valuetype() == NULL) {
 588     assert(is_reference_type(type), &quot;&quot;);
 589     bool flat_array = true;
 590     Deoptimization::DeoptReason reason = Deoptimization::Reason_none;
 591     if (arytype-&gt;speculative() != NULL &amp;&amp;
 592         arytype-&gt;speculative()-&gt;is_aryptr()-&gt;is_not_flat() &amp;&amp;
 593         !too_many_traps_or_recompiles(Deoptimization::Reason_speculate_class_check)) {
 594       flat_array = false;
 595       reason = Deoptimization::Reason_speculate_class_check;
 596     } else if (UseArrayLoadStoreProfile &amp;&amp; !too_many_traps_or_recompiles(reason)) {
 597       ciKlass* array_type = NULL;
 598       ciKlass* element_type = NULL;
 599       ProfilePtrKind element_ptr = ProfileMaybeNull;
 600       bool null_free_array = true;
 601       method()-&gt;array_access_profiled_type(bci(), array_type, element_type, element_ptr, flat_array, null_free_array);
 602       reason = Deoptimization::Reason_class_check;
 603     }
 604     if (!flat_array) {
 605       Node* flattened = gen_flattened_array_test(ary);
 606       Node* chk = NULL;
 607       if (_gvn.type(flattened)-&gt;isa_int()) {
 608         chk = _gvn.transform(new CmpINode(flattened, intcon(0)));
 609       } else {
 610         assert(_gvn.type(flattened)-&gt;isa_long(), &quot;flattened property is int or long&quot;);
 611         chk = _gvn.transform(new CmpLNode(flattened, longcon(0)));
 612       }
 613       Node* tst = _gvn.transform(new BoolNode(chk, BoolTest::eq));
 614       {
 615         BuildCutout unless(this, tst, PROB_MAX);
 616         uncommon_trap_exact(reason, Deoptimization::Action_maybe_recompile);
 617       }
 618       Node* better_ary = _gvn.transform(new CheckCastPPNode(control(), ary, arytype-&gt;cast_to_not_flat()));
 619       replace_in_map(ary, better_ary);
 620       ary = better_ary;
 621       arytype  = _gvn.type(ary)-&gt;is_aryptr();
 622     }
 623   }
 624 
 625   // Make array address computation control dependent to prevent it
 626   // from floating above the range check during loop optimizations.
 627   Node* ptr = array_element_address(ary, idx, type, sizetype, control());
 628   assert(ptr != top(), &quot;top should go hand-in-hand with stopped&quot;);
 629 
 630   return ptr;
 631 }
 632 
 633 
 634 // returns IfNode
 635 IfNode* Parse::jump_if_fork_int(Node* a, Node* b, BoolTest::mask mask, float prob, float cnt) {
 636   Node   *cmp = _gvn.transform(new CmpINode(a, b)); // two cases: shiftcount &gt; 32 and shiftcount &lt;= 32
 637   Node   *tst = _gvn.transform(new BoolNode(cmp, mask));
 638   IfNode *iff = create_and_map_if(control(), tst, prob, cnt);
 639   return iff;
 640 }
 641 
 642 // return Region node
 643 Node* Parse::jump_if_join(Node* iffalse, Node* iftrue) {
 644   Node *region  = new RegionNode(3); // 2 results
 645   record_for_igvn(region);
 646   region-&gt;init_req(1, iffalse);
 647   region-&gt;init_req(2, iftrue );
 648   _gvn.set_type(region, Type::CONTROL);
 649   region = _gvn.transform(region);
 650   set_control (region);
 651   return region;
 652 }
 653 
 654 // sentinel value for the target bci to mark never taken branches
 655 // (according to profiling)
 656 static const int never_reached = INT_MAX;
 657 
 658 //------------------------------helper for tableswitch-------------------------
 659 void Parse::jump_if_true_fork(IfNode *iff, int dest_bci_if_true, int prof_table_index, bool unc) {
 660   // True branch, use existing map info
 661   { PreserveJVMState pjvms(this);
 662     Node *iftrue  = _gvn.transform( new IfTrueNode (iff) );
 663     set_control( iftrue );
 664     if (unc) {
 665       repush_if_args();
 666       uncommon_trap(Deoptimization::Reason_unstable_if,
 667                     Deoptimization::Action_reinterpret,
 668                     NULL,
 669                     &quot;taken always&quot;);
 670     } else {
 671       assert(dest_bci_if_true != never_reached, &quot;inconsistent dest&quot;);
 672       profile_switch_case(prof_table_index);
 673       merge_new_path(dest_bci_if_true);
 674     }
 675   }
 676 
 677   // False branch
 678   Node *iffalse = _gvn.transform( new IfFalseNode(iff) );
 679   set_control( iffalse );
 680 }
 681 
 682 void Parse::jump_if_false_fork(IfNode *iff, int dest_bci_if_true, int prof_table_index, bool unc) {
 683   // True branch, use existing map info
 684   { PreserveJVMState pjvms(this);
 685     Node *iffalse  = _gvn.transform( new IfFalseNode (iff) );
 686     set_control( iffalse );
 687     if (unc) {
 688       repush_if_args();
 689       uncommon_trap(Deoptimization::Reason_unstable_if,
 690                     Deoptimization::Action_reinterpret,
 691                     NULL,
 692                     &quot;taken never&quot;);
 693     } else {
 694       assert(dest_bci_if_true != never_reached, &quot;inconsistent dest&quot;);
 695       profile_switch_case(prof_table_index);
 696       merge_new_path(dest_bci_if_true);
 697     }
 698   }
 699 
 700   // False branch
 701   Node *iftrue = _gvn.transform( new IfTrueNode(iff) );
 702   set_control( iftrue );
 703 }
 704 
 705 void Parse::jump_if_always_fork(int dest_bci, int prof_table_index, bool unc) {
 706   // False branch, use existing map and control()
 707   if (unc) {
 708     repush_if_args();
 709     uncommon_trap(Deoptimization::Reason_unstable_if,
 710                   Deoptimization::Action_reinterpret,
 711                   NULL,
 712                   &quot;taken never&quot;);
 713   } else {
 714     assert(dest_bci != never_reached, &quot;inconsistent dest&quot;);
 715     profile_switch_case(prof_table_index);
 716     merge_new_path(dest_bci);
 717   }
 718 }
 719 
 720 
 721 extern &quot;C&quot; {
 722   static int jint_cmp(const void *i, const void *j) {
 723     int a = *(jint *)i;
 724     int b = *(jint *)j;
 725     return a &gt; b ? 1 : a &lt; b ? -1 : 0;
 726   }
 727 }
 728 
 729 
 730 // Default value for methodData switch indexing. Must be a negative value to avoid
 731 // conflict with any legal switch index.
 732 #define NullTableIndex -1
 733 
 734 class SwitchRange : public StackObj {
 735   // a range of integers coupled with a bci destination
 736   jint _lo;                     // inclusive lower limit
 737   jint _hi;                     // inclusive upper limit
 738   int _dest;
 739   int _table_index;             // index into method data table
 740   float _cnt;                   // how many times this range was hit according to profiling
 741 
 742 public:
 743   jint lo() const              { return _lo;   }
 744   jint hi() const              { return _hi;   }
 745   int  dest() const            { return _dest; }
 746   int  table_index() const     { return _table_index; }
 747   bool is_singleton() const    { return _lo == _hi; }
 748   float cnt() const            { return _cnt; }
 749 
 750   void setRange(jint lo, jint hi, int dest, int table_index, float cnt) {
 751     assert(lo &lt;= hi, &quot;must be a non-empty range&quot;);
 752     _lo = lo, _hi = hi; _dest = dest; _table_index = table_index; _cnt = cnt;
 753     assert(_cnt &gt;= 0, &quot;&quot;);
 754   }
 755   bool adjoinRange(jint lo, jint hi, int dest, int table_index, float cnt, bool trim_ranges) {
 756     assert(lo &lt;= hi, &quot;must be a non-empty range&quot;);
 757     if (lo == _hi+1 &amp;&amp; table_index == _table_index) {
 758       // see merge_ranges() comment below
 759       if (trim_ranges) {
 760         if (cnt == 0) {
 761           if (_cnt != 0) {
 762             return false;
 763           }
 764           if (dest != _dest) {
 765             _dest = never_reached;
 766           }
 767         } else {
 768           if (_cnt == 0) {
 769             return false;
 770           }
 771           if (dest != _dest) {
 772             return false;
 773           }
 774         }
 775       } else {
 776         if (dest != _dest) {
 777           return false;
 778         }
 779       }
 780       _hi = hi;
 781       _cnt += cnt;
 782       return true;
 783     }
 784     return false;
 785   }
 786 
 787   void set (jint value, int dest, int table_index, float cnt) {
 788     setRange(value, value, dest, table_index, cnt);
 789   }
 790   bool adjoin(jint value, int dest, int table_index, float cnt, bool trim_ranges) {
 791     return adjoinRange(value, value, dest, table_index, cnt, trim_ranges);
 792   }
 793   bool adjoin(SwitchRange&amp; other) {
 794     return adjoinRange(other._lo, other._hi, other._dest, other._table_index, other._cnt, false);
 795   }
 796 
 797   void print() {
 798     if (is_singleton())
 799       tty-&gt;print(&quot; {%d}=&gt;%d (cnt=%f)&quot;, lo(), dest(), cnt());
 800     else if (lo() == min_jint)
 801       tty-&gt;print(&quot; {..%d}=&gt;%d (cnt=%f)&quot;, hi(), dest(), cnt());
 802     else if (hi() == max_jint)
 803       tty-&gt;print(&quot; {%d..}=&gt;%d (cnt=%f)&quot;, lo(), dest(), cnt());
 804     else
 805       tty-&gt;print(&quot; {%d..%d}=&gt;%d (cnt=%f)&quot;, lo(), hi(), dest(), cnt());
 806   }
 807 };
 808 
 809 // We try to minimize the number of ranges and the size of the taken
 810 // ones using profiling data. When ranges are created,
 811 // SwitchRange::adjoinRange() only allows 2 adjoining ranges to merge
 812 // if both were never hit or both were hit to build longer unreached
 813 // ranges. Here, we now merge adjoining ranges with the same
 814 // destination and finally set destination of unreached ranges to the
 815 // special value never_reached because it can help minimize the number
 816 // of tests that are necessary.
 817 //
 818 // For instance:
 819 // [0, 1] to target1 sometimes taken
 820 // [1, 2] to target1 never taken
 821 // [2, 3] to target2 never taken
 822 // would lead to:
 823 // [0, 1] to target1 sometimes taken
 824 // [1, 3] never taken
 825 //
 826 // (first 2 ranges to target1 are not merged)
 827 static void merge_ranges(SwitchRange* ranges, int&amp; rp) {
 828   if (rp == 0) {
 829     return;
 830   }
 831   int shift = 0;
 832   for (int j = 0; j &lt; rp; j++) {
 833     SwitchRange&amp; r1 = ranges[j-shift];
 834     SwitchRange&amp; r2 = ranges[j+1];
 835     if (r1.adjoin(r2)) {
 836       shift++;
 837     } else if (shift &gt; 0) {
 838       ranges[j+1-shift] = r2;
 839     }
 840   }
 841   rp -= shift;
 842   for (int j = 0; j &lt;= rp; j++) {
 843     SwitchRange&amp; r = ranges[j];
 844     if (r.cnt() == 0 &amp;&amp; r.dest() != never_reached) {
 845       r.setRange(r.lo(), r.hi(), never_reached, r.table_index(), r.cnt());
 846     }
 847   }
 848 }
 849 
 850 //-------------------------------do_tableswitch--------------------------------
 851 void Parse::do_tableswitch() {
 852   Node* lookup = pop();
 853   // Get information about tableswitch
 854   int default_dest = iter().get_dest_table(0);
 855   int lo_index     = iter().get_int_table(1);
 856   int hi_index     = iter().get_int_table(2);
 857   int len          = hi_index - lo_index + 1;
 858 
 859   if (len &lt; 1) {
 860     // If this is a backward branch, add safepoint
 861     maybe_add_safepoint(default_dest);
 862     merge(default_dest);
 863     return;
 864   }
 865 
 866   ciMethodData* methodData = method()-&gt;method_data();
 867   ciMultiBranchData* profile = NULL;
 868   if (methodData-&gt;is_mature() &amp;&amp; UseSwitchProfiling) {
 869     ciProfileData* data = methodData-&gt;bci_to_data(bci());
 870     if (data != NULL &amp;&amp; data-&gt;is_MultiBranchData()) {
 871       profile = (ciMultiBranchData*)data;
 872     }
 873   }
 874   bool trim_ranges = !method_data_update() &amp;&amp; !C-&gt;too_many_traps(method(), bci(), Deoptimization::Reason_unstable_if);
 875 
 876   // generate decision tree, using trichotomy when possible
 877   int rnum = len+2;
 878   bool makes_backward_branch = false;
 879   SwitchRange* ranges = NEW_RESOURCE_ARRAY(SwitchRange, rnum);
 880   int rp = -1;
 881   if (lo_index != min_jint) {
 882     uint cnt = 1;
 883     if (profile != NULL) {
 884       cnt = profile-&gt;default_count() / (hi_index != max_jint ? 2 : 1);
 885     }
 886     ranges[++rp].setRange(min_jint, lo_index-1, default_dest, NullTableIndex, cnt);
 887   }
 888   for (int j = 0; j &lt; len; j++) {
 889     jint match_int = lo_index+j;
 890     int  dest      = iter().get_dest_table(j+3);
 891     makes_backward_branch |= (dest &lt;= bci());
 892     int  table_index = method_data_update() ? j : NullTableIndex;
 893     uint cnt = 1;
 894     if (profile != NULL) {
 895       cnt = profile-&gt;count_at(j);
 896     }
 897     if (rp &lt; 0 || !ranges[rp].adjoin(match_int, dest, table_index, cnt, trim_ranges)) {
 898       ranges[++rp].set(match_int, dest, table_index, cnt);
 899     }
 900   }
 901   jint highest = lo_index+(len-1);
 902   assert(ranges[rp].hi() == highest, &quot;&quot;);
 903   if (highest != max_jint) {
 904     uint cnt = 1;
 905     if (profile != NULL) {
 906       cnt = profile-&gt;default_count() / (lo_index != min_jint ? 2 : 1);
 907     }
 908     if (!ranges[rp].adjoinRange(highest+1, max_jint, default_dest, NullTableIndex, cnt, trim_ranges)) {
 909       ranges[++rp].setRange(highest+1, max_jint, default_dest, NullTableIndex, cnt);
 910     }
 911   }
 912   assert(rp &lt; len+2, &quot;not too many ranges&quot;);
 913 
 914   if (trim_ranges) {
 915     merge_ranges(ranges, rp);
 916   }
 917 
 918   // Safepoint in case if backward branch observed
 919   if( makes_backward_branch &amp;&amp; UseLoopSafepoints )
 920     add_safepoint();
 921 
 922   jump_switch_ranges(lookup, &amp;ranges[0], &amp;ranges[rp]);
 923 }
 924 
 925 
 926 //------------------------------do_lookupswitch--------------------------------
 927 void Parse::do_lookupswitch() {
 928   Node *lookup = pop();         // lookup value
 929   // Get information about lookupswitch
 930   int default_dest = iter().get_dest_table(0);
 931   int len          = iter().get_int_table(1);
 932 
 933   if (len &lt; 1) {    // If this is a backward branch, add safepoint
 934     maybe_add_safepoint(default_dest);
 935     merge(default_dest);
 936     return;
 937   }
 938 
 939   ciMethodData* methodData = method()-&gt;method_data();
 940   ciMultiBranchData* profile = NULL;
 941   if (methodData-&gt;is_mature() &amp;&amp; UseSwitchProfiling) {
 942     ciProfileData* data = methodData-&gt;bci_to_data(bci());
 943     if (data != NULL &amp;&amp; data-&gt;is_MultiBranchData()) {
 944       profile = (ciMultiBranchData*)data;
 945     }
 946   }
 947   bool trim_ranges = !method_data_update() &amp;&amp; !C-&gt;too_many_traps(method(), bci(), Deoptimization::Reason_unstable_if);
 948 
 949   // generate decision tree, using trichotomy when possible
 950   jint* table = NEW_RESOURCE_ARRAY(jint, len*3);
 951   {
 952     for (int j = 0; j &lt; len; j++) {
 953       table[3*j+0] = iter().get_int_table(2+2*j);
 954       table[3*j+1] = iter().get_dest_table(2+2*j+1);
 955       table[3*j+2] = profile == NULL ? 1 : profile-&gt;count_at(j);
 956     }
 957     qsort(table, len, 3*sizeof(table[0]), jint_cmp);
 958   }
 959 
 960   float defaults = 0;
 961   jint prev = min_jint;
 962   for (int j = 0; j &lt; len; j++) {
 963     jint match_int = table[3*j+0];
 964     if (match_int != prev) {
 965       defaults += (float)match_int - prev;
 966     }
 967     prev = match_int+1;
 968   }
 969   if (prev-1 != max_jint) {
 970     defaults += (float)max_jint - prev + 1;
 971   }
 972   float default_cnt = 1;
 973   if (profile != NULL) {
 974     default_cnt = profile-&gt;default_count()/defaults;
 975   }
 976 
 977   int rnum = len*2+1;
 978   bool makes_backward_branch = false;
 979   SwitchRange* ranges = NEW_RESOURCE_ARRAY(SwitchRange, rnum);
 980   int rp = -1;
 981   for (int j = 0; j &lt; len; j++) {
 982     jint match_int   = table[3*j+0];
 983     int  dest        = table[3*j+1];
 984     int  cnt         = table[3*j+2];
 985     int  next_lo     = rp &lt; 0 ? min_jint : ranges[rp].hi()+1;
 986     int  table_index = method_data_update() ? j : NullTableIndex;
 987     makes_backward_branch |= (dest &lt;= bci());
 988     float c = default_cnt * ((float)match_int - next_lo);
 989     if (match_int != next_lo &amp;&amp; (rp &lt; 0 || !ranges[rp].adjoinRange(next_lo, match_int-1, default_dest, NullTableIndex, c, trim_ranges))) {
 990       assert(default_dest != never_reached, &quot;sentinel value for dead destinations&quot;);
 991       ranges[++rp].setRange(next_lo, match_int-1, default_dest, NullTableIndex, c);
 992     }
 993     if (rp &lt; 0 || !ranges[rp].adjoin(match_int, dest, table_index, cnt, trim_ranges)) {
 994       assert(dest != never_reached, &quot;sentinel value for dead destinations&quot;);
 995       ranges[++rp].set(match_int, dest, table_index, cnt);
 996     }
 997   }
 998   jint highest = table[3*(len-1)];
 999   assert(ranges[rp].hi() == highest, &quot;&quot;);
1000   if (highest != max_jint &amp;&amp;
1001       !ranges[rp].adjoinRange(highest+1, max_jint, default_dest, NullTableIndex, default_cnt * ((float)max_jint - highest), trim_ranges)) {
1002     ranges[++rp].setRange(highest+1, max_jint, default_dest, NullTableIndex, default_cnt * ((float)max_jint - highest));
1003   }
1004   assert(rp &lt; rnum, &quot;not too many ranges&quot;);
1005 
1006   if (trim_ranges) {
1007     merge_ranges(ranges, rp);
1008   }
1009 
1010   // Safepoint in case backward branch observed
1011   if (makes_backward_branch &amp;&amp; UseLoopSafepoints)
1012     add_safepoint();
1013 
1014   jump_switch_ranges(lookup, &amp;ranges[0], &amp;ranges[rp]);
1015 }
1016 
1017 static float if_prob(float taken_cnt, float total_cnt) {
1018   assert(taken_cnt &lt;= total_cnt, &quot;&quot;);
1019   if (total_cnt == 0) {
1020     return PROB_FAIR;
1021   }
1022   float p = taken_cnt / total_cnt;
1023   return clamp(p, PROB_MIN, PROB_MAX);
1024 }
1025 
1026 static float if_cnt(float cnt) {
1027   if (cnt == 0) {
1028     return COUNT_UNKNOWN;
1029   }
1030   return cnt;
1031 }
1032 
1033 static float sum_of_cnts(SwitchRange *lo, SwitchRange *hi) {
1034   float total_cnt = 0;
1035   for (SwitchRange* sr = lo; sr &lt;= hi; sr++) {
1036     total_cnt += sr-&gt;cnt();
1037   }
1038   return total_cnt;
1039 }
1040 
1041 class SwitchRanges : public ResourceObj {
1042 public:
1043   SwitchRange* _lo;
1044   SwitchRange* _hi;
1045   SwitchRange* _mid;
1046   float _cost;
1047 
1048   enum {
1049     Start,
1050     LeftDone,
1051     RightDone,
1052     Done
1053   } _state;
1054 
1055   SwitchRanges(SwitchRange *lo, SwitchRange *hi)
1056     : _lo(lo), _hi(hi), _mid(NULL),
1057       _cost(0), _state(Start) {
1058   }
1059 
1060   SwitchRanges()
1061     : _lo(NULL), _hi(NULL), _mid(NULL),
1062       _cost(0), _state(Start) {}
1063 };
1064 
1065 // Estimate cost of performing a binary search on lo..hi
1066 static float compute_tree_cost(SwitchRange *lo, SwitchRange *hi, float total_cnt) {
1067   GrowableArray&lt;SwitchRanges&gt; tree;
1068   SwitchRanges root(lo, hi);
1069   tree.push(root);
1070 
1071   float cost = 0;
1072   do {
1073     SwitchRanges&amp; r = *tree.adr_at(tree.length()-1);
1074     if (r._hi != r._lo) {
1075       if (r._mid == NULL) {
1076         float r_cnt = sum_of_cnts(r._lo, r._hi);
1077 
1078         if (r_cnt == 0) {
1079           tree.pop();
1080           cost = 0;
1081           continue;
1082         }
1083 
1084         SwitchRange* mid = NULL;
1085         mid = r._lo;
1086         for (float cnt = 0; ; ) {
1087           assert(mid &lt;= r._hi, &quot;out of bounds&quot;);
1088           cnt += mid-&gt;cnt();
1089           if (cnt &gt; r_cnt / 2) {
1090             break;
1091           }
1092           mid++;
1093         }
1094         assert(mid &lt;= r._hi, &quot;out of bounds&quot;);
1095         r._mid = mid;
1096         r._cost = r_cnt / total_cnt;
1097       }
1098       r._cost += cost;
1099       if (r._state &lt; SwitchRanges::LeftDone &amp;&amp; r._mid &gt; r._lo) {
1100         cost = 0;
1101         r._state = SwitchRanges::LeftDone;
1102         tree.push(SwitchRanges(r._lo, r._mid-1));
1103       } else if (r._state &lt; SwitchRanges::RightDone) {
1104         cost = 0;
1105         r._state = SwitchRanges::RightDone;
1106         tree.push(SwitchRanges(r._mid == r._lo ? r._mid+1 : r._mid, r._hi));
1107       } else {
1108         tree.pop();
1109         cost = r._cost;
1110       }
1111     } else {
1112       tree.pop();
1113       cost = r._cost;
1114     }
1115   } while (tree.length() &gt; 0);
1116 
1117 
1118   return cost;
1119 }
1120 
1121 // It sometimes pays off to test most common ranges before the binary search
1122 void Parse::linear_search_switch_ranges(Node* key_val, SwitchRange*&amp; lo, SwitchRange*&amp; hi) {
1123   uint nr = hi - lo + 1;
1124   float total_cnt = sum_of_cnts(lo, hi);
1125 
1126   float min = compute_tree_cost(lo, hi, total_cnt);
1127   float extra = 1;
1128   float sub = 0;
1129 
1130   SwitchRange* array1 = lo;
1131   SwitchRange* array2 = NEW_RESOURCE_ARRAY(SwitchRange, nr);
1132 
1133   SwitchRange* ranges = NULL;
1134 
1135   while (nr &gt;= 2) {
1136     assert(lo == array1 || lo == array2, &quot;one the 2 already allocated arrays&quot;);
1137     ranges = (lo == array1) ? array2 : array1;
1138 
1139     // Find highest frequency range
1140     SwitchRange* candidate = lo;
1141     for (SwitchRange* sr = lo+1; sr &lt;= hi; sr++) {
1142       if (sr-&gt;cnt() &gt; candidate-&gt;cnt()) {
1143         candidate = sr;
1144       }
1145     }
1146     SwitchRange most_freq = *candidate;
1147     if (most_freq.cnt() == 0) {
1148       break;
1149     }
1150 
1151     // Copy remaining ranges into another array
1152     int shift = 0;
1153     for (uint i = 0; i &lt; nr; i++) {
1154       SwitchRange* sr = &amp;lo[i];
1155       if (sr != candidate) {
1156         ranges[i-shift] = *sr;
1157       } else {
1158         shift++;
1159         if (i &gt; 0 &amp;&amp; i &lt; nr-1) {
1160           SwitchRange prev = lo[i-1];
1161           prev.setRange(prev.lo(), sr-&gt;hi(), prev.dest(), prev.table_index(), prev.cnt());
1162           if (prev.adjoin(lo[i+1])) {
1163             shift++;
1164             i++;
1165           }
1166           ranges[i-shift] = prev;
1167         }
1168       }
1169     }
1170     nr -= shift;
1171 
1172     // Evaluate cost of testing the most common range and performing a
1173     // binary search on the other ranges
1174     float cost = extra + compute_tree_cost(&amp;ranges[0], &amp;ranges[nr-1], total_cnt);
1175     if (cost &gt;= min) {
1176       break;
1177     }
1178     // swap arrays
1179     lo = &amp;ranges[0];
1180     hi = &amp;ranges[nr-1];
1181 
1182     // It pays off: emit the test for the most common range
1183     assert(most_freq.cnt() &gt; 0, &quot;must be taken&quot;);
1184     Node* val = _gvn.transform(new SubINode(key_val, _gvn.intcon(most_freq.lo())));
1185     Node* cmp = _gvn.transform(new CmpUNode(val, _gvn.intcon(most_freq.hi() - most_freq.lo())));
1186     Node* tst = _gvn.transform(new BoolNode(cmp, BoolTest::le));
1187     IfNode* iff = create_and_map_if(control(), tst, if_prob(most_freq.cnt(), total_cnt), if_cnt(most_freq.cnt()));
1188     jump_if_true_fork(iff, most_freq.dest(), most_freq.table_index(), false);
1189 
1190     sub += most_freq.cnt() / total_cnt;
1191     extra += 1 - sub;
1192     min = cost;
1193   }
1194 }
1195 
1196 //----------------------------create_jump_tables-------------------------------
1197 bool Parse::create_jump_tables(Node* key_val, SwitchRange* lo, SwitchRange* hi) {
1198   // Are jumptables enabled
1199   if (!UseJumpTables)  return false;
1200 
1201   // Are jumptables supported
1202   if (!Matcher::has_match_rule(Op_Jump))  return false;
1203 
1204   // Don&#39;t make jump table if profiling
1205   if (method_data_update())  return false;
1206 
1207   bool trim_ranges = !C-&gt;too_many_traps(method(), bci(), Deoptimization::Reason_unstable_if);
1208 
1209   // Decide if a guard is needed to lop off big ranges at either (or
1210   // both) end(s) of the input set. We&#39;ll call this the default target
1211   // even though we can&#39;t be sure that it is the true &quot;default&quot;.
1212 
1213   bool needs_guard = false;
1214   int default_dest;
1215   int64_t total_outlier_size = 0;
1216   int64_t hi_size = ((int64_t)hi-&gt;hi()) - ((int64_t)hi-&gt;lo()) + 1;
1217   int64_t lo_size = ((int64_t)lo-&gt;hi()) - ((int64_t)lo-&gt;lo()) + 1;
1218 
1219   if (lo-&gt;dest() == hi-&gt;dest()) {
1220     total_outlier_size = hi_size + lo_size;
1221     default_dest = lo-&gt;dest();
1222   } else if (lo_size &gt; hi_size) {
1223     total_outlier_size = lo_size;
1224     default_dest = lo-&gt;dest();
1225   } else {
1226     total_outlier_size = hi_size;
1227     default_dest = hi-&gt;dest();
1228   }
1229 
1230   float total = sum_of_cnts(lo, hi);
1231   float cost = compute_tree_cost(lo, hi, total);
1232 
1233   // If a guard test will eliminate very sparse end ranges, then
1234   // it is worth the cost of an extra jump.
1235   float trimmed_cnt = 0;
1236   if (total_outlier_size &gt; (MaxJumpTableSparseness * 4)) {
1237     needs_guard = true;
1238     if (default_dest == lo-&gt;dest()) {
1239       trimmed_cnt += lo-&gt;cnt();
1240       lo++;
1241     }
1242     if (default_dest == hi-&gt;dest()) {
1243       trimmed_cnt += hi-&gt;cnt();
1244       hi--;
1245     }
1246   }
1247 
1248   // Find the total number of cases and ranges
1249   int64_t num_cases = ((int64_t)hi-&gt;hi()) - ((int64_t)lo-&gt;lo()) + 1;
1250   int num_range = hi - lo + 1;
1251 
1252   // Don&#39;t create table if: too large, too small, or too sparse.
1253   if (num_cases &gt; MaxJumpTableSize)
1254     return false;
1255   if (UseSwitchProfiling) {
1256     // MinJumpTableSize is set so with a well balanced binary tree,
1257     // when the number of ranges is MinJumpTableSize, it&#39;s cheaper to
1258     // go through a JumpNode that a tree of IfNodes. Average cost of a
1259     // tree of IfNodes with MinJumpTableSize is
1260     // log2f(MinJumpTableSize) comparisons. So if the cost computed
1261     // from profile data is less than log2f(MinJumpTableSize) then
1262     // going with the binary search is cheaper.
1263     if (cost &lt; log2f(MinJumpTableSize)) {
1264       return false;
1265     }
1266   } else {
1267     if (num_cases &lt; MinJumpTableSize)
1268       return false;
1269   }
1270   if (num_cases &gt; (MaxJumpTableSparseness * num_range))
1271     return false;
1272 
1273   // Normalize table lookups to zero
1274   int lowval = lo-&gt;lo();
1275   key_val = _gvn.transform( new SubINode(key_val, _gvn.intcon(lowval)) );
1276 
1277   // Generate a guard to protect against input keyvals that aren&#39;t
1278   // in the switch domain.
1279   if (needs_guard) {
1280     Node*   size = _gvn.intcon(num_cases);
1281     Node*   cmp = _gvn.transform(new CmpUNode(key_val, size));
1282     Node*   tst = _gvn.transform(new BoolNode(cmp, BoolTest::ge));
1283     IfNode* iff = create_and_map_if(control(), tst, if_prob(trimmed_cnt, total), if_cnt(trimmed_cnt));
1284     jump_if_true_fork(iff, default_dest, NullTableIndex, trim_ranges &amp;&amp; trimmed_cnt == 0);
1285 
1286     total -= trimmed_cnt;
1287   }
1288 
1289   // Create an ideal node JumpTable that has projections
1290   // of all possible ranges for a switch statement
1291   // The key_val input must be converted to a pointer offset and scaled.
1292   // Compare Parse::array_addressing above.
1293 
1294   // Clean the 32-bit int into a real 64-bit offset.
1295   // Otherwise, the jint value 0 might turn into an offset of 0x0800000000.
1296   const TypeInt* ikeytype = TypeInt::make(0, num_cases, Type::WidenMin);
1297   // Make I2L conversion control dependent to prevent it from
1298   // floating above the range check during loop optimizations.
1299   key_val = C-&gt;conv_I2X_index(&amp;_gvn, key_val, ikeytype, control());
1300 
1301   // Shift the value by wordsize so we have an index into the table, rather
1302   // than a switch value
1303   Node *shiftWord = _gvn.MakeConX(wordSize);
1304   key_val = _gvn.transform( new MulXNode( key_val, shiftWord));
1305 
1306   // Create the JumpNode
1307   Arena* arena = C-&gt;comp_arena();
1308   float* probs = (float*)arena-&gt;Amalloc(sizeof(float)*num_cases);
1309   int i = 0;
1310   if (total == 0) {
1311     for (SwitchRange* r = lo; r &lt;= hi; r++) {
1312       for (int64_t j = r-&gt;lo(); j &lt;= r-&gt;hi(); j++, i++) {
1313         probs[i] = 1.0F / num_cases;
1314       }
1315     }
1316   } else {
1317     for (SwitchRange* r = lo; r &lt;= hi; r++) {
1318       float prob = r-&gt;cnt()/total;
1319       for (int64_t j = r-&gt;lo(); j &lt;= r-&gt;hi(); j++, i++) {
1320         probs[i] = prob / (r-&gt;hi() - r-&gt;lo() + 1);
1321       }
1322     }
1323   }
1324 
1325   ciMethodData* methodData = method()-&gt;method_data();
1326   ciMultiBranchData* profile = NULL;
1327   if (methodData-&gt;is_mature()) {
1328     ciProfileData* data = methodData-&gt;bci_to_data(bci());
1329     if (data != NULL &amp;&amp; data-&gt;is_MultiBranchData()) {
1330       profile = (ciMultiBranchData*)data;
1331     }
1332   }
1333 
1334   Node* jtn = _gvn.transform(new JumpNode(control(), key_val, num_cases, probs, profile == NULL ? COUNT_UNKNOWN : total));
1335 
1336   // These are the switch destinations hanging off the jumpnode
1337   i = 0;
1338   for (SwitchRange* r = lo; r &lt;= hi; r++) {
1339     for (int64_t j = r-&gt;lo(); j &lt;= r-&gt;hi(); j++, i++) {
1340       Node* input = _gvn.transform(new JumpProjNode(jtn, i, r-&gt;dest(), (int)(j - lowval)));
1341       {
1342         PreserveJVMState pjvms(this);
1343         set_control(input);
1344         jump_if_always_fork(r-&gt;dest(), r-&gt;table_index(), trim_ranges &amp;&amp; r-&gt;cnt() == 0);
1345       }
1346     }
1347   }
1348   assert(i == num_cases, &quot;miscount of cases&quot;);
1349   stop_and_kill_map();  // no more uses for this JVMS
1350   return true;
1351 }
1352 
1353 //----------------------------jump_switch_ranges-------------------------------
1354 void Parse::jump_switch_ranges(Node* key_val, SwitchRange *lo, SwitchRange *hi, int switch_depth) {
1355   Block* switch_block = block();
1356   bool trim_ranges = !method_data_update() &amp;&amp; !C-&gt;too_many_traps(method(), bci(), Deoptimization::Reason_unstable_if);
1357 
1358   if (switch_depth == 0) {
1359     // Do special processing for the top-level call.
1360     assert(lo-&gt;lo() == min_jint, &quot;initial range must exhaust Type::INT&quot;);
1361     assert(hi-&gt;hi() == max_jint, &quot;initial range must exhaust Type::INT&quot;);
1362 
1363     // Decrement pred-numbers for the unique set of nodes.
1364 #ifdef ASSERT
1365     if (!trim_ranges) {
1366       // Ensure that the block&#39;s successors are a (duplicate-free) set.
1367       int successors_counted = 0;  // block occurrences in [hi..lo]
1368       int unique_successors = switch_block-&gt;num_successors();
1369       for (int i = 0; i &lt; unique_successors; i++) {
1370         Block* target = switch_block-&gt;successor_at(i);
1371 
1372         // Check that the set of successors is the same in both places.
1373         int successors_found = 0;
1374         for (SwitchRange* p = lo; p &lt;= hi; p++) {
1375           if (p-&gt;dest() == target-&gt;start())  successors_found++;
1376         }
1377         assert(successors_found &gt; 0, &quot;successor must be known&quot;);
1378         successors_counted += successors_found;
1379       }
1380       assert(successors_counted == (hi-lo)+1, &quot;no unexpected successors&quot;);
1381     }
1382 #endif
1383 
1384     // Maybe prune the inputs, based on the type of key_val.
1385     jint min_val = min_jint;
1386     jint max_val = max_jint;
1387     const TypeInt* ti = key_val-&gt;bottom_type()-&gt;isa_int();
1388     if (ti != NULL) {
1389       min_val = ti-&gt;_lo;
1390       max_val = ti-&gt;_hi;
1391       assert(min_val &lt;= max_val, &quot;invalid int type&quot;);
1392     }
1393     while (lo-&gt;hi() &lt; min_val) {
1394       lo++;
1395     }
1396     if (lo-&gt;lo() &lt; min_val)  {
1397       lo-&gt;setRange(min_val, lo-&gt;hi(), lo-&gt;dest(), lo-&gt;table_index(), lo-&gt;cnt());
1398     }
1399     while (hi-&gt;lo() &gt; max_val) {
1400       hi--;
1401     }
1402     if (hi-&gt;hi() &gt; max_val) {
1403       hi-&gt;setRange(hi-&gt;lo(), max_val, hi-&gt;dest(), hi-&gt;table_index(), hi-&gt;cnt());
1404     }
1405 
1406     linear_search_switch_ranges(key_val, lo, hi);
1407   }
1408 
1409 #ifndef PRODUCT
1410   if (switch_depth == 0) {
1411     _max_switch_depth = 0;
1412     _est_switch_depth = log2_intptr((hi-lo+1)-1)+1;
1413   }
1414 #endif
1415 
1416   assert(lo &lt;= hi, &quot;must be a non-empty set of ranges&quot;);
1417   if (lo == hi) {
1418     jump_if_always_fork(lo-&gt;dest(), lo-&gt;table_index(), trim_ranges &amp;&amp; lo-&gt;cnt() == 0);
1419   } else {
1420     assert(lo-&gt;hi() == (lo+1)-&gt;lo()-1, &quot;contiguous ranges&quot;);
1421     assert(hi-&gt;lo() == (hi-1)-&gt;hi()+1, &quot;contiguous ranges&quot;);
1422 
1423     if (create_jump_tables(key_val, lo, hi)) return;
1424 
1425     SwitchRange* mid = NULL;
1426     float total_cnt = sum_of_cnts(lo, hi);
1427 
1428     int nr = hi - lo + 1;
1429     if (UseSwitchProfiling) {
1430       // Don&#39;t keep the binary search tree balanced: pick up mid point
1431       // that split frequencies in half.
1432       float cnt = 0;
1433       for (SwitchRange* sr = lo; sr &lt;= hi; sr++) {
1434         cnt += sr-&gt;cnt();
1435         if (cnt &gt;= total_cnt / 2) {
1436           mid = sr;
1437           break;
1438         }
1439       }
1440     } else {
1441       mid = lo + nr/2;
1442 
1443       // if there is an easy choice, pivot at a singleton:
1444       if (nr &gt; 3 &amp;&amp; !mid-&gt;is_singleton() &amp;&amp; (mid-1)-&gt;is_singleton())  mid--;
1445 
1446       assert(lo &lt; mid &amp;&amp; mid &lt;= hi, &quot;good pivot choice&quot;);
1447       assert(nr != 2 || mid == hi,   &quot;should pick higher of 2&quot;);
1448       assert(nr != 3 || mid == hi-1, &quot;should pick middle of 3&quot;);
1449     }
1450 
1451 
1452     Node *test_val = _gvn.intcon(mid == lo ? mid-&gt;hi() : mid-&gt;lo());
1453 
1454     if (mid-&gt;is_singleton()) {
1455       IfNode *iff_ne = jump_if_fork_int(key_val, test_val, BoolTest::ne, 1-if_prob(mid-&gt;cnt(), total_cnt), if_cnt(mid-&gt;cnt()));
1456       jump_if_false_fork(iff_ne, mid-&gt;dest(), mid-&gt;table_index(), trim_ranges &amp;&amp; mid-&gt;cnt() == 0);
1457 
1458       // Special Case:  If there are exactly three ranges, and the high
1459       // and low range each go to the same place, omit the &quot;gt&quot; test,
1460       // since it will not discriminate anything.
1461       bool eq_test_only = (hi == lo+2 &amp;&amp; hi-&gt;dest() == lo-&gt;dest() &amp;&amp; mid == hi-1) || mid == lo;
1462 
1463       // if there is a higher range, test for it and process it:
1464       if (mid &lt; hi &amp;&amp; !eq_test_only) {
1465         // two comparisons of same values--should enable 1 test for 2 branches
1466         // Use BoolTest::lt instead of BoolTest::gt
1467         float cnt = sum_of_cnts(lo, mid-1);
1468         IfNode *iff_lt  = jump_if_fork_int(key_val, test_val, BoolTest::lt, if_prob(cnt, total_cnt), if_cnt(cnt));
1469         Node   *iftrue  = _gvn.transform( new IfTrueNode(iff_lt) );
1470         Node   *iffalse = _gvn.transform( new IfFalseNode(iff_lt) );
1471         { PreserveJVMState pjvms(this);
1472           set_control(iffalse);
1473           jump_switch_ranges(key_val, mid+1, hi, switch_depth+1);
1474         }
1475         set_control(iftrue);
1476       }
1477 
1478     } else {
1479       // mid is a range, not a singleton, so treat mid..hi as a unit
1480       float cnt = sum_of_cnts(mid == lo ? mid+1 : mid, hi);
1481       IfNode *iff_ge = jump_if_fork_int(key_val, test_val, mid == lo ? BoolTest::gt : BoolTest::ge, if_prob(cnt, total_cnt), if_cnt(cnt));
1482 
1483       // if there is a higher range, test for it and process it:
1484       if (mid == hi) {
1485         jump_if_true_fork(iff_ge, mid-&gt;dest(), mid-&gt;table_index(), trim_ranges &amp;&amp; cnt == 0);
1486       } else {
1487         Node *iftrue  = _gvn.transform( new IfTrueNode(iff_ge) );
1488         Node *iffalse = _gvn.transform( new IfFalseNode(iff_ge) );
1489         { PreserveJVMState pjvms(this);
1490           set_control(iftrue);
1491           jump_switch_ranges(key_val, mid == lo ? mid+1 : mid, hi, switch_depth+1);
1492         }
1493         set_control(iffalse);
1494       }
1495     }
1496 
1497     // in any case, process the lower range
1498     if (mid == lo) {
1499       if (mid-&gt;is_singleton()) {
1500         jump_switch_ranges(key_val, lo+1, hi, switch_depth+1);
1501       } else {
1502         jump_if_always_fork(lo-&gt;dest(), lo-&gt;table_index(), trim_ranges &amp;&amp; lo-&gt;cnt() == 0);
1503       }
1504     } else {
1505       jump_switch_ranges(key_val, lo, mid-1, switch_depth+1);
1506     }
1507   }
1508 
1509   // Decrease pred_count for each successor after all is done.
1510   if (switch_depth == 0) {
1511     int unique_successors = switch_block-&gt;num_successors();
1512     for (int i = 0; i &lt; unique_successors; i++) {
1513       Block* target = switch_block-&gt;successor_at(i);
1514       // Throw away the pre-allocated path for each unique successor.
1515       target-&gt;next_path_num();
1516     }
1517   }
1518 
1519 #ifndef PRODUCT
1520   _max_switch_depth = MAX2(switch_depth, _max_switch_depth);
1521   if (TraceOptoParse &amp;&amp; Verbose &amp;&amp; WizardMode &amp;&amp; switch_depth == 0) {
1522     SwitchRange* r;
1523     int nsing = 0;
1524     for( r = lo; r &lt;= hi; r++ ) {
1525       if( r-&gt;is_singleton() )  nsing++;
1526     }
1527     tty-&gt;print(&quot;&gt;&gt;&gt; &quot;);
1528     _method-&gt;print_short_name();
1529     tty-&gt;print_cr(&quot; switch decision tree&quot;);
1530     tty-&gt;print_cr(&quot;    %d ranges (%d singletons), max_depth=%d, est_depth=%d&quot;,
1531                   (int) (hi-lo+1), nsing, _max_switch_depth, _est_switch_depth);
1532     if (_max_switch_depth &gt; _est_switch_depth) {
1533       tty-&gt;print_cr(&quot;******** BAD SWITCH DEPTH ********&quot;);
1534     }
1535     tty-&gt;print(&quot;   &quot;);
1536     for( r = lo; r &lt;= hi; r++ ) {
1537       r-&gt;print();
1538     }
1539     tty-&gt;cr();
1540   }
1541 #endif
1542 }
1543 
1544 void Parse::modf() {
1545   Node *f2 = pop();
1546   Node *f1 = pop();
1547   Node* c = make_runtime_call(RC_LEAF, OptoRuntime::modf_Type(),
1548                               CAST_FROM_FN_PTR(address, SharedRuntime::frem),
1549                               &quot;frem&quot;, NULL, //no memory effects
1550                               f1, f2);
1551   Node* res = _gvn.transform(new ProjNode(c, TypeFunc::Parms + 0));
1552 
1553   push(res);
1554 }
1555 
1556 void Parse::modd() {
1557   Node *d2 = pop_pair();
1558   Node *d1 = pop_pair();
1559   Node* c = make_runtime_call(RC_LEAF, OptoRuntime::Math_DD_D_Type(),
1560                               CAST_FROM_FN_PTR(address, SharedRuntime::drem),
1561                               &quot;drem&quot;, NULL, //no memory effects
1562                               d1, top(), d2, top());
1563   Node* res_d   = _gvn.transform(new ProjNode(c, TypeFunc::Parms + 0));
1564 
1565 #ifdef ASSERT
1566   Node* res_top = _gvn.transform(new ProjNode(c, TypeFunc::Parms + 1));
1567   assert(res_top == top(), &quot;second value must be top&quot;);
1568 #endif
1569 
1570   push_pair(res_d);
1571 }
1572 
1573 void Parse::l2f() {
1574   Node* f2 = pop();
1575   Node* f1 = pop();
1576   Node* c = make_runtime_call(RC_LEAF, OptoRuntime::l2f_Type(),
1577                               CAST_FROM_FN_PTR(address, SharedRuntime::l2f),
1578                               &quot;l2f&quot;, NULL, //no memory effects
1579                               f1, f2);
1580   Node* res = _gvn.transform(new ProjNode(c, TypeFunc::Parms + 0));
1581 
1582   push(res);
1583 }
1584 
1585 void Parse::do_irem() {
1586   // Must keep both values on the expression-stack during null-check
1587   zero_check_int(peek());
1588   // Compile-time detect of null-exception?
1589   if (stopped())  return;
1590 
1591   Node* b = pop();
1592   Node* a = pop();
1593 
1594   const Type *t = _gvn.type(b);
1595   if (t != Type::TOP) {
1596     const TypeInt *ti = t-&gt;is_int();
1597     if (ti-&gt;is_con()) {
1598       int divisor = ti-&gt;get_con();
1599       // check for positive power of 2
1600       if (divisor &gt; 0 &amp;&amp;
1601           (divisor &amp; ~(divisor-1)) == divisor) {
1602         // yes !
1603         Node *mask = _gvn.intcon((divisor - 1));
1604         // Sigh, must handle negative dividends
1605         Node *zero = _gvn.intcon(0);
1606         IfNode *ifff = jump_if_fork_int(a, zero, BoolTest::lt, PROB_FAIR, COUNT_UNKNOWN);
1607         Node *iff = _gvn.transform( new IfFalseNode(ifff) );
1608         Node *ift = _gvn.transform( new IfTrueNode (ifff) );
1609         Node *reg = jump_if_join(ift, iff);
1610         Node *phi = PhiNode::make(reg, NULL, TypeInt::INT);
1611         // Negative path; negate/and/negate
1612         Node *neg = _gvn.transform( new SubINode(zero, a) );
1613         Node *andn= _gvn.transform( new AndINode(neg, mask) );
1614         Node *negn= _gvn.transform( new SubINode(zero, andn) );
1615         phi-&gt;init_req(1, negn);
1616         // Fast positive case
1617         Node *andx = _gvn.transform( new AndINode(a, mask) );
1618         phi-&gt;init_req(2, andx);
1619         // Push the merge
1620         push( _gvn.transform(phi) );
1621         return;
1622       }
1623     }
1624   }
1625   // Default case
1626   push( _gvn.transform( new ModINode(control(),a,b) ) );
1627 }
1628 
1629 // Handle jsr and jsr_w bytecode
1630 void Parse::do_jsr() {
1631   assert(bc() == Bytecodes::_jsr || bc() == Bytecodes::_jsr_w, &quot;wrong bytecode&quot;);
1632 
1633   // Store information about current state, tagged with new _jsr_bci
1634   int return_bci = iter().next_bci();
1635   int jsr_bci    = (bc() == Bytecodes::_jsr) ? iter().get_dest() : iter().get_far_dest();
1636 
1637   // Update method data
1638   profile_taken_branch(jsr_bci);
1639 
1640   // The way we do things now, there is only one successor block
1641   // for the jsr, because the target code is cloned by ciTypeFlow.
1642   Block* target = successor_for_bci(jsr_bci);
1643 
1644   // What got pushed?
1645   const Type* ret_addr = target-&gt;peek();
1646   assert(ret_addr-&gt;singleton(), &quot;must be a constant (cloned jsr body)&quot;);
1647 
1648   // Effect on jsr on stack
1649   push(_gvn.makecon(ret_addr));
1650 
1651   // Flow to the jsr.
1652   merge(jsr_bci);
1653 }
1654 
1655 // Handle ret bytecode
1656 void Parse::do_ret() {
1657   // Find to whom we return.
1658   assert(block()-&gt;num_successors() == 1, &quot;a ret can only go one place now&quot;);
1659   Block* target = block()-&gt;successor_at(0);
1660   assert(!target-&gt;is_ready(), &quot;our arrival must be expected&quot;);
1661   profile_ret(target-&gt;flow()-&gt;start());
1662   int pnum = target-&gt;next_path_num();
1663   merge_common(target, pnum);
1664 }
1665 
1666 static bool has_injected_profile(BoolTest::mask btest, Node* test, int&amp; taken, int&amp; not_taken) {
1667   if (btest != BoolTest::eq &amp;&amp; btest != BoolTest::ne) {
1668     // Only ::eq and ::ne are supported for profile injection.
1669     return false;
1670   }
1671   if (test-&gt;is_Cmp() &amp;&amp;
1672       test-&gt;in(1)-&gt;Opcode() == Op_ProfileBoolean) {
1673     ProfileBooleanNode* profile = (ProfileBooleanNode*)test-&gt;in(1);
1674     int false_cnt = profile-&gt;false_count();
1675     int  true_cnt = profile-&gt;true_count();
1676 
1677     // Counts matching depends on the actual test operation (::eq or ::ne).
1678     // No need to scale the counts because profile injection was designed
1679     // to feed exact counts into VM.
1680     taken     = (btest == BoolTest::eq) ? false_cnt :  true_cnt;
1681     not_taken = (btest == BoolTest::eq) ?  true_cnt : false_cnt;
1682 
1683     profile-&gt;consume();
1684     return true;
1685   }
1686   return false;
1687 }
1688 //--------------------------dynamic_branch_prediction--------------------------
1689 // Try to gather dynamic branch prediction behavior.  Return a probability
1690 // of the branch being taken and set the &quot;cnt&quot; field.  Returns a -1.0
1691 // if we need to use static prediction for some reason.
1692 float Parse::dynamic_branch_prediction(float &amp;cnt, BoolTest::mask btest, Node* test) {
1693   ResourceMark rm;
1694 
1695   cnt  = COUNT_UNKNOWN;
1696 
1697   int     taken = 0;
1698   int not_taken = 0;
1699 
1700   bool use_mdo = !has_injected_profile(btest, test, taken, not_taken);
1701 
1702   if (use_mdo) {
1703     // Use MethodData information if it is available
1704     // FIXME: free the ProfileData structure
1705     ciMethodData* methodData = method()-&gt;method_data();
1706     if (!methodData-&gt;is_mature())  return PROB_UNKNOWN;
1707     ciProfileData* data = methodData-&gt;bci_to_data(bci());
1708     if (data == NULL) {
1709       return PROB_UNKNOWN;
1710     }
1711     if (!data-&gt;is_JumpData())  return PROB_UNKNOWN;
1712 
1713     // get taken and not taken values
1714     taken = data-&gt;as_JumpData()-&gt;taken();
1715     not_taken = 0;
1716     if (data-&gt;is_BranchData()) {
1717       not_taken = data-&gt;as_BranchData()-&gt;not_taken();
1718     }
1719 
1720     // scale the counts to be commensurate with invocation counts:
1721     taken = method()-&gt;scale_count(taken);
1722     not_taken = method()-&gt;scale_count(not_taken);
1723   }
1724 
1725   // Give up if too few (or too many, in which case the sum will overflow) counts to be meaningful.
1726   // We also check that individual counters are positive first, otherwise the sum can become positive.
1727   if (taken &lt; 0 || not_taken &lt; 0 || taken + not_taken &lt; 40) {
1728     if (C-&gt;log() != NULL) {
1729       C-&gt;log()-&gt;elem(&quot;branch target_bci=&#39;%d&#39; taken=&#39;%d&#39; not_taken=&#39;%d&#39;&quot;, iter().get_dest(), taken, not_taken);
1730     }
1731     return PROB_UNKNOWN;
1732   }
1733 
1734   // Compute frequency that we arrive here
1735   float sum = taken + not_taken;
1736   // Adjust, if this block is a cloned private block but the
1737   // Jump counts are shared.  Taken the private counts for
1738   // just this path instead of the shared counts.
1739   if( block()-&gt;count() &gt; 0 )
1740     sum = block()-&gt;count();
1741   cnt = sum / FreqCountInvocations;
1742 
1743   // Pin probability to sane limits
1744   float prob;
1745   if( !taken )
1746     prob = (0+PROB_MIN) / 2;
1747   else if( !not_taken )
1748     prob = (1+PROB_MAX) / 2;
1749   else {                         // Compute probability of true path
1750     prob = (float)taken / (float)(taken + not_taken);
1751     if (prob &gt; PROB_MAX)  prob = PROB_MAX;
1752     if (prob &lt; PROB_MIN)   prob = PROB_MIN;
1753   }
1754 
1755   assert((cnt &gt; 0.0f) &amp;&amp; (prob &gt; 0.0f),
1756          &quot;Bad frequency assignment in if&quot;);
1757 
1758   if (C-&gt;log() != NULL) {
1759     const char* prob_str = NULL;
1760     if (prob &gt;= PROB_MAX)  prob_str = (prob == PROB_MAX) ? &quot;max&quot; : &quot;always&quot;;
1761     if (prob &lt;= PROB_MIN)  prob_str = (prob == PROB_MIN) ? &quot;min&quot; : &quot;never&quot;;
1762     char prob_str_buf[30];
1763     if (prob_str == NULL) {
1764       jio_snprintf(prob_str_buf, sizeof(prob_str_buf), &quot;%20.2f&quot;, prob);
1765       prob_str = prob_str_buf;
1766     }
1767     C-&gt;log()-&gt;elem(&quot;branch target_bci=&#39;%d&#39; taken=&#39;%d&#39; not_taken=&#39;%d&#39; cnt=&#39;%f&#39; prob=&#39;%s&#39;&quot;,
1768                    iter().get_dest(), taken, not_taken, cnt, prob_str);
1769   }
1770   return prob;
1771 }
1772 
1773 //-----------------------------branch_prediction-------------------------------
1774 float Parse::branch_prediction(float&amp; cnt,
1775                                BoolTest::mask btest,
1776                                int target_bci,
1777                                Node* test) {
1778   float prob = dynamic_branch_prediction(cnt, btest, test);
1779   // If prob is unknown, switch to static prediction
1780   if (prob != PROB_UNKNOWN)  return prob;
1781 
1782   prob = PROB_FAIR;                   // Set default value
1783   if (btest == BoolTest::eq)          // Exactly equal test?
1784     prob = PROB_STATIC_INFREQUENT;    // Assume its relatively infrequent
1785   else if (btest == BoolTest::ne)
1786     prob = PROB_STATIC_FREQUENT;      // Assume its relatively frequent
1787 
1788   // If this is a conditional test guarding a backwards branch,
1789   // assume its a loop-back edge.  Make it a likely taken branch.
1790   if (target_bci &lt; bci()) {
1791     if (is_osr_parse()) {    // Could be a hot OSR&#39;d loop; force deopt
1792       // Since it&#39;s an OSR, we probably have profile data, but since
1793       // branch_prediction returned PROB_UNKNOWN, the counts are too small.
1794       // Let&#39;s make a special check here for completely zero counts.
1795       ciMethodData* methodData = method()-&gt;method_data();
1796       if (!methodData-&gt;is_empty()) {
1797         ciProfileData* data = methodData-&gt;bci_to_data(bci());
1798         // Only stop for truly zero counts, which mean an unknown part
1799         // of the OSR-ed method, and we want to deopt to gather more stats.
1800         // If you have ANY counts, then this loop is simply &#39;cold&#39; relative
1801         // to the OSR loop.
1802         if (data == NULL ||
1803             (data-&gt;as_BranchData()-&gt;taken() +  data-&gt;as_BranchData()-&gt;not_taken() == 0)) {
1804           // This is the only way to return PROB_UNKNOWN:
1805           return PROB_UNKNOWN;
1806         }
1807       }
1808     }
1809     prob = PROB_STATIC_FREQUENT;     // Likely to take backwards branch
1810   }
1811 
1812   assert(prob != PROB_UNKNOWN, &quot;must have some guess at this point&quot;);
1813   return prob;
1814 }
1815 
1816 // The magic constants are chosen so as to match the output of
1817 // branch_prediction() when the profile reports a zero taken count.
1818 // It is important to distinguish zero counts unambiguously, because
1819 // some branches (e.g., _213_javac.Assembler.eliminate) validly produce
1820 // very small but nonzero probabilities, which if confused with zero
1821 // counts would keep the program recompiling indefinitely.
1822 bool Parse::seems_never_taken(float prob) const {
1823   return prob &lt; PROB_MIN;
1824 }
1825 
1826 // True if the comparison seems to be the kind that will not change its
1827 // statistics from true to false.  See comments in adjust_map_after_if.
1828 // This question is only asked along paths which are already
1829 // classifed as untaken (by seems_never_taken), so really,
1830 // if a path is never taken, its controlling comparison is
1831 // already acting in a stable fashion.  If the comparison
1832 // seems stable, we will put an expensive uncommon trap
1833 // on the untaken path.
1834 bool Parse::seems_stable_comparison() const {
1835   if (C-&gt;too_many_traps(method(), bci(), Deoptimization::Reason_unstable_if)) {
1836     return false;
1837   }
1838   return true;
1839 }
1840 
1841 //-------------------------------repush_if_args--------------------------------
1842 // Push arguments of an &quot;if&quot; bytecode back onto the stack by adjusting _sp.
1843 inline int Parse::repush_if_args() {
1844   if (PrintOpto &amp;&amp; WizardMode) {
1845     tty-&gt;print(&quot;defending against excessive implicit null exceptions on %s @%d in &quot;,
1846                Bytecodes::name(iter().cur_bc()), iter().cur_bci());
1847     method()-&gt;print_name(); tty-&gt;cr();
1848   }
1849   int bc_depth = - Bytecodes::depth(iter().cur_bc());
1850   assert(bc_depth == 1 || bc_depth == 2, &quot;only two kinds of branches&quot;);
1851   DEBUG_ONLY(sync_jvms());   // argument(n) requires a synced jvms
1852   assert(argument(0) != NULL, &quot;must exist&quot;);
1853   assert(bc_depth == 1 || argument(1) != NULL, &quot;two must exist&quot;);
1854   inc_sp(bc_depth);
1855   return bc_depth;
1856 }
1857 
1858 //----------------------------------do_ifnull----------------------------------
1859 void Parse::do_ifnull(BoolTest::mask btest, Node *c) {
1860   int target_bci = iter().get_dest();
1861 
1862   Block* branch_block = successor_for_bci(target_bci);
1863   Block* next_block   = successor_for_bci(iter().next_bci());
1864 
1865   float cnt;
1866   float prob = branch_prediction(cnt, btest, target_bci, c);
1867   if (prob == PROB_UNKNOWN) {
1868     // (An earlier version of do_ifnull omitted this trap for OSR methods.)
1869     if (PrintOpto &amp;&amp; Verbose) {
1870       tty-&gt;print_cr(&quot;Never-taken edge stops compilation at bci %d&quot;, bci());
1871     }
1872     repush_if_args(); // to gather stats on loop
1873     // We need to mark this branch as taken so that if we recompile we will
1874     // see that it is possible. In the tiered system the interpreter doesn&#39;t
1875     // do profiling and by the time we get to the lower tier from the interpreter
1876     // the path may be cold again. Make sure it doesn&#39;t look untaken
1877     profile_taken_branch(target_bci, !ProfileInterpreter);
1878     uncommon_trap(Deoptimization::Reason_unreached,
1879                   Deoptimization::Action_reinterpret,
1880                   NULL, &quot;cold&quot;);
1881     if (C-&gt;eliminate_boxing()) {
1882       // Mark the successor blocks as parsed
1883       branch_block-&gt;next_path_num();
1884       next_block-&gt;next_path_num();
1885     }
1886     return;
1887   }
1888 
1889   NOT_PRODUCT(explicit_null_checks_inserted++);
1890 
1891   // Generate real control flow
1892   Node   *tst = _gvn.transform( new BoolNode( c, btest ) );
1893 
1894   // Sanity check the probability value
1895   assert(prob &gt; 0.0f,&quot;Bad probability in Parser&quot;);
1896  // Need xform to put node in hash table
1897   IfNode *iff = create_and_xform_if( control(), tst, prob, cnt );
1898   assert(iff-&gt;_prob &gt; 0.0f,&quot;Optimizer made bad probability in parser&quot;);
1899   // True branch
1900   { PreserveJVMState pjvms(this);
1901     Node* iftrue  = _gvn.transform( new IfTrueNode (iff) );
1902     set_control(iftrue);
1903 
1904     if (stopped()) {            // Path is dead?
1905       NOT_PRODUCT(explicit_null_checks_elided++);
1906       if (C-&gt;eliminate_boxing()) {
1907         // Mark the successor block as parsed
1908         branch_block-&gt;next_path_num();
1909       }
1910     } else {                    // Path is live.
1911       // Update method data
1912       profile_taken_branch(target_bci);
1913       adjust_map_after_if(btest, c, prob, branch_block);
1914       if (!stopped()) {
1915         merge(target_bci);
1916       }
1917     }
1918   }
1919 
1920   // False branch
1921   Node* iffalse = _gvn.transform( new IfFalseNode(iff) );
1922   set_control(iffalse);
1923 
1924   if (stopped()) {              // Path is dead?
1925     NOT_PRODUCT(explicit_null_checks_elided++);
1926     if (C-&gt;eliminate_boxing()) {
1927       // Mark the successor block as parsed
1928       next_block-&gt;next_path_num();
1929     }
1930   } else  {                     // Path is live.
1931     // Update method data
1932     profile_not_taken_branch();
1933     adjust_map_after_if(BoolTest(btest).negate(), c, 1.0-prob, next_block);
1934   }
1935 }
1936 
1937 //------------------------------------do_if------------------------------------
1938 void Parse::do_if(BoolTest::mask btest, Node* c, bool new_path, Node** ctrl_taken) {
1939   int target_bci = iter().get_dest();
1940 
1941   Block* branch_block = successor_for_bci(target_bci);
1942   Block* next_block   = successor_for_bci(iter().next_bci());
1943 
1944   float cnt;
1945   float prob = branch_prediction(cnt, btest, target_bci, c);
1946   float untaken_prob = 1.0 - prob;
1947 
1948   if (prob == PROB_UNKNOWN) {
1949     if (PrintOpto &amp;&amp; Verbose) {
1950       tty-&gt;print_cr(&quot;Never-taken edge stops compilation at bci %d&quot;, bci());
1951     }
1952     repush_if_args(); // to gather stats on loop
1953     // We need to mark this branch as taken so that if we recompile we will
1954     // see that it is possible. In the tiered system the interpreter doesn&#39;t
1955     // do profiling and by the time we get to the lower tier from the interpreter
1956     // the path may be cold again. Make sure it doesn&#39;t look untaken
1957     profile_taken_branch(target_bci, !ProfileInterpreter);
1958     uncommon_trap(Deoptimization::Reason_unreached,
1959                   Deoptimization::Action_reinterpret,
1960                   NULL, &quot;cold&quot;);
1961     if (C-&gt;eliminate_boxing()) {
1962       // Mark the successor blocks as parsed
1963       branch_block-&gt;next_path_num();
1964       next_block-&gt;next_path_num();
1965     }
1966     return;
1967   }
1968 
1969   // Sanity check the probability value
1970   assert(0.0f &lt; prob &amp;&amp; prob &lt; 1.0f,&quot;Bad probability in Parser&quot;);
1971 
1972   bool taken_if_true = true;
1973   // Convert BoolTest to canonical form:
1974   if (!BoolTest(btest).is_canonical()) {
1975     btest         = BoolTest(btest).negate();
1976     taken_if_true = false;
1977     // prob is NOT updated here; it remains the probability of the taken
1978     // path (as opposed to the prob of the path guarded by an &#39;IfTrueNode&#39;).
1979   }
1980   assert(btest != BoolTest::eq, &quot;!= is the only canonical exact test&quot;);
1981 
1982   Node* tst0 = new BoolNode(c, btest);
1983   Node* tst = _gvn.transform(tst0);
1984   BoolTest::mask taken_btest   = BoolTest::illegal;
1985   BoolTest::mask untaken_btest = BoolTest::illegal;
1986 
1987   if (tst-&gt;is_Bool()) {
1988     // Refresh c from the transformed bool node, since it may be
1989     // simpler than the original c.  Also re-canonicalize btest.
1990     // This wins when (Bool ne (Conv2B p) 0) =&gt; (Bool ne (CmpP p NULL)).
1991     // That can arise from statements like: if (x instanceof C) ...
1992     if (tst != tst0) {
1993       // Canonicalize one more time since transform can change it.
1994       btest = tst-&gt;as_Bool()-&gt;_test._test;
1995       if (!BoolTest(btest).is_canonical()) {
1996         // Reverse edges one more time...
1997         tst   = _gvn.transform( tst-&gt;as_Bool()-&gt;negate(&amp;_gvn) );
1998         btest = tst-&gt;as_Bool()-&gt;_test._test;
1999         assert(BoolTest(btest).is_canonical(), &quot;sanity&quot;);
2000         taken_if_true = !taken_if_true;
2001       }
2002       c = tst-&gt;in(1);
2003     }
2004     BoolTest::mask neg_btest = BoolTest(btest).negate();
2005     taken_btest   = taken_if_true ?     btest : neg_btest;
2006     untaken_btest = taken_if_true ? neg_btest :     btest;
2007   }
2008 
2009   // Generate real control flow
2010   float true_prob = (taken_if_true ? prob : untaken_prob);
2011   IfNode* iff = create_and_map_if(control(), tst, true_prob, cnt);
2012   assert(iff-&gt;_prob &gt; 0.0f,&quot;Optimizer made bad probability in parser&quot;);
2013   Node* taken_branch   = new IfTrueNode(iff);
2014   Node* untaken_branch = new IfFalseNode(iff);
2015   if (!taken_if_true) {  // Finish conversion to canonical form
2016     Node* tmp      = taken_branch;
2017     taken_branch   = untaken_branch;
2018     untaken_branch = tmp;
2019   }
2020 
2021   // Branch is taken:
2022   { PreserveJVMState pjvms(this);
2023     taken_branch = _gvn.transform(taken_branch);
2024     set_control(taken_branch);
2025 
2026     if (stopped()) {
2027       if (C-&gt;eliminate_boxing() &amp;&amp; !new_path) {
2028         // Mark the successor block as parsed (if we haven&#39;t created a new path)
2029         branch_block-&gt;next_path_num();
2030       }
2031     } else {
2032       // Update method data
2033       profile_taken_branch(target_bci);
2034       adjust_map_after_if(taken_btest, c, prob, branch_block);
2035       if (!stopped()) {
2036         if (new_path) {
2037           // Merge by using a new path
2038           merge_new_path(target_bci);
2039         } else if (ctrl_taken != NULL) {
2040           // Don&#39;t merge but save taken branch to be wired by caller
2041           *ctrl_taken = control();
2042         } else {
2043           merge(target_bci);
2044         }
2045       }
2046     }
2047   }
2048 
2049   untaken_branch = _gvn.transform(untaken_branch);
2050   set_control(untaken_branch);
2051 
2052   // Branch not taken.
2053   if (stopped() &amp;&amp; ctrl_taken == NULL) {
2054     if (C-&gt;eliminate_boxing()) {
2055       // Mark the successor block as parsed (if caller does not re-wire control flow)
2056       next_block-&gt;next_path_num();
2057     }
2058   } else {
2059     // Update method data
2060     profile_not_taken_branch();
2061     adjust_map_after_if(untaken_btest, c, untaken_prob, next_block);
2062   }
2063 }
2064 
2065 void Parse::do_acmp(BoolTest::mask btest, Node* a, Node* b) {
2066   ciMethod* subst_method = ciEnv::current()-&gt;ValueBootstrapMethods_klass()-&gt;find_method(ciSymbol::isSubstitutable_name(), ciSymbol::object_object_boolean_signature());
2067   // If current method is ValueBootstrapMethods::isSubstitutable(),
2068   // compile the acmp as a regular pointer comparison otherwise we
2069   // could call ValueBootstrapMethods::isSubstitutable() back
2070   if (!EnableValhalla || (method() == subst_method)) {
2071     Node* cmp = CmpP(a, b);
2072     cmp = optimize_cmp_with_klass(cmp);
2073     do_if(btest, cmp);
2074     return;
2075   }
2076 
2077   // Allocate value type operands and re-execute on deoptimization
2078   if (a-&gt;is_ValueType()) {
2079     PreserveReexecuteState preexecs(this);
2080     inc_sp(2);
2081     jvms()-&gt;set_should_reexecute(true);
2082     a = a-&gt;as_ValueType()-&gt;allocate(this)-&gt;get_oop();
2083   }
2084   if (b-&gt;is_ValueType()) {
2085     PreserveReexecuteState preexecs(this);
2086     inc_sp(2);
2087     jvms()-&gt;set_should_reexecute(true);
2088     b = b-&gt;as_ValueType()-&gt;allocate(this)-&gt;get_oop();
2089   }
2090 
2091   // First, do a normal pointer comparison
2092   const TypeOopPtr* ta = _gvn.type(a)-&gt;isa_oopptr();
2093   const TypeOopPtr* tb = _gvn.type(b)-&gt;isa_oopptr();
2094   Node* cmp = CmpP(a, b);
2095   cmp = optimize_cmp_with_klass(cmp);
2096   if (ta == NULL || !ta-&gt;can_be_value_type() ||
2097       tb == NULL || !tb-&gt;can_be_value_type()) {
2098     // This is sufficient, if one of the operands can&#39;t be a value type
2099     do_if(btest, cmp);
2100     return;
2101   }
2102   Node* eq_region = NULL;
2103   if (btest == BoolTest::eq) {
2104     do_if(btest, cmp, true);
2105     if (stopped()) {
2106       return;
2107     }
2108   } else {
2109     assert(btest == BoolTest::ne, &quot;only eq or ne&quot;);
2110     Node* is_not_equal = NULL;
2111     eq_region = new RegionNode(3);
2112     {
2113       PreserveJVMState pjvms(this);
2114       do_if(btest, cmp, false, &amp;is_not_equal);
2115       if (!stopped()) {
2116         eq_region-&gt;init_req(1, control());
2117       }
2118     }
2119     if (is_not_equal == NULL || is_not_equal-&gt;is_top()) {
2120       record_for_igvn(eq_region);
2121       set_control(_gvn.transform(eq_region));
2122       return;
2123     }
2124     set_control(is_not_equal);
2125   }
2126 
2127   // Pointers are not equal, check if first operand is non-null
2128   Node* ne_region = new RegionNode(6);
2129   inc_sp(2);
2130   Node* null_ctl = top();
2131   Node* not_null_a = null_check_oop(a, &amp;null_ctl, !too_many_traps(Deoptimization::Reason_null_check), false, false);
2132   dec_sp(2);
2133   ne_region-&gt;init_req(1, null_ctl);
2134   if (stopped()) {
2135     record_for_igvn(ne_region);
2136     set_control(_gvn.transform(ne_region));
2137     if (btest == BoolTest::ne) {
2138       {
2139         PreserveJVMState pjvms(this);
2140         int target_bci = iter().get_dest();
2141         merge(target_bci);
2142       }
2143       record_for_igvn(eq_region);
2144       set_control(_gvn.transform(eq_region));
2145     }
2146     return;
2147   }
2148 
2149   // First operand is non-null, check if it is a value type
2150   Node* is_value = is_always_locked(not_null_a);
2151   IfNode* is_value_iff = create_and_map_if(control(), is_value, PROB_FAIR, COUNT_UNKNOWN);
2152   Node* not_value = _gvn.transform(new IfFalseNode(is_value_iff));
2153   ne_region-&gt;init_req(2, not_value);
2154   set_control(_gvn.transform(new IfTrueNode(is_value_iff)));
2155 
2156   // The first operand is a value type, check if the second operand is non-null
2157   inc_sp(2);
2158   null_ctl = top();
2159   Node* not_null_b = null_check_oop(b, &amp;null_ctl, !too_many_traps(Deoptimization::Reason_null_check), false, false);
2160   dec_sp(2);
2161   ne_region-&gt;init_req(3, null_ctl);
2162   if (stopped()) {
2163     record_for_igvn(ne_region);
2164     set_control(_gvn.transform(ne_region));
2165     if (btest == BoolTest::ne) {
2166       {
2167         PreserveJVMState pjvms(this);
2168         int target_bci = iter().get_dest();
2169         merge(target_bci);
2170       }
2171       record_for_igvn(eq_region);
2172       set_control(_gvn.transform(eq_region));
2173     }
2174     return;
2175   }
2176 
2177   // Check if both operands are of the same class. We don&#39;t need to clear the array property
2178   // bits in the klass pointer for the cmp because we know that the first operand is a value type.
2179   Node* kls_a = load_object_klass(not_null_a, /* clear_prop_bits = */ false);
2180   Node* kls_b = load_object_klass(not_null_b, /* clear_prop_bits = */ false);
2181   Node* kls_cmp = CmpP(kls_a, kls_b);
2182   Node* kls_bol = _gvn.transform(new BoolNode(kls_cmp, BoolTest::ne));
2183   IfNode* kls_iff = create_and_map_if(control(), kls_bol, PROB_FAIR, COUNT_UNKNOWN);
2184   Node* kls_ne = _gvn.transform(new IfTrueNode(kls_iff));
2185   set_control(_gvn.transform(new IfFalseNode(kls_iff)));
2186   ne_region-&gt;init_req(4, kls_ne);
2187 
2188   if (stopped()) {
2189     record_for_igvn(ne_region);
2190     set_control(_gvn.transform(ne_region));
2191     if (btest == BoolTest::ne) {
2192       {
2193         PreserveJVMState pjvms(this);
2194         int target_bci = iter().get_dest();
2195         merge(target_bci);
2196       }
2197       record_for_igvn(eq_region);
2198       set_control(_gvn.transform(eq_region));
2199     }
2200     return;
2201   }
2202 
2203   // Both operands are values types of the same class, we need to perform a
2204   // substitutability test. Delegate to ValueBootstrapMethods::isSubstitutable().
2205   Node* ne_io_phi = PhiNode::make(ne_region, i_o());
2206   Node* mem = reset_memory();
2207   Node* ne_mem_phi = PhiNode::make(ne_region, mem);
2208 
2209   Node* eq_io_phi = NULL;
2210   Node* eq_mem_phi = NULL;
2211   if (eq_region != NULL) {
2212     eq_io_phi = PhiNode::make(eq_region, i_o());
2213     eq_mem_phi = PhiNode::make(eq_region, mem);
2214   }
2215 
2216   set_all_memory(mem);
2217 
2218   kill_dead_locals();
2219   CallStaticJavaNode *call = new CallStaticJavaNode(C, TypeFunc::make(subst_method), SharedRuntime::get_resolve_static_call_stub(), subst_method, bci());
2220   call-&gt;set_override_symbolic_info(true);
2221   call-&gt;init_req(TypeFunc::Parms, not_null_a);
2222   call-&gt;init_req(TypeFunc::Parms+1, not_null_b);
2223   inc_sp(2);
2224   set_edges_for_java_call(call, false, false);
2225   Node* ret = set_results_for_java_call(call, false, true);
2226   dec_sp(2);
2227 
2228   // Test the return value of ValueBootstrapMethods::isSubstitutable()
2229   Node* subst_cmp = _gvn.transform(new CmpINode(ret, intcon(1)));
2230   Node* ctl = C-&gt;top();
2231   if (btest == BoolTest::eq) {
2232     PreserveJVMState pjvms(this);
2233     do_if(btest, subst_cmp);
2234     if (!stopped()) {
2235       ctl = control();
2236     }
2237   } else {
2238     assert(btest == BoolTest::ne, &quot;only eq or ne&quot;);
2239     PreserveJVMState pjvms(this);
2240     do_if(btest, subst_cmp, false, &amp;ctl);
2241     if (!stopped()) {
2242       eq_region-&gt;init_req(2, control());
2243       eq_io_phi-&gt;init_req(2, i_o());
2244       eq_mem_phi-&gt;init_req(2, reset_memory());
2245     }
2246   }
2247   ne_region-&gt;init_req(5, ctl);
2248   ne_io_phi-&gt;init_req(5, i_o());
2249   ne_mem_phi-&gt;init_req(5, reset_memory());
2250 
2251   record_for_igvn(ne_region);
2252   set_control(_gvn.transform(ne_region));
2253   set_i_o(_gvn.transform(ne_io_phi));
2254   set_all_memory(_gvn.transform(ne_mem_phi));
2255 
2256   if (btest == BoolTest::ne) {
2257     {
2258       PreserveJVMState pjvms(this);
2259       int target_bci = iter().get_dest();
2260       merge(target_bci);
2261     }
2262 
2263     record_for_igvn(eq_region);
2264     set_control(_gvn.transform(eq_region));
2265     set_i_o(_gvn.transform(eq_io_phi));
2266     set_all_memory(_gvn.transform(eq_mem_phi));
2267   }
2268 }
2269 
2270 bool Parse::path_is_suitable_for_uncommon_trap(float prob) const {
2271   // Don&#39;t want to speculate on uncommon traps when running with -Xcomp
2272   if (!UseInterpreter) {
2273     return false;
2274   }
2275   return (seems_never_taken(prob) &amp;&amp; seems_stable_comparison());
2276 }
2277 
2278 void Parse::maybe_add_predicate_after_if(Block* path) {
2279   if (path-&gt;is_SEL_head() &amp;&amp; path-&gt;preds_parsed() == 0) {
2280     // Add predicates at bci of if dominating the loop so traps can be
2281     // recorded on the if&#39;s profile data
2282     int bc_depth = repush_if_args();
2283     add_empty_predicates();
2284     dec_sp(bc_depth);
2285     path-&gt;set_has_predicates();
2286   }
2287 }
2288 
2289 
2290 //----------------------------adjust_map_after_if------------------------------
2291 // Adjust the JVM state to reflect the result of taking this path.
2292 // Basically, it means inspecting the CmpNode controlling this
2293 // branch, seeing how it constrains a tested value, and then
2294 // deciding if it&#39;s worth our while to encode this constraint
2295 // as graph nodes in the current abstract interpretation map.
2296 void Parse::adjust_map_after_if(BoolTest::mask btest, Node* c, float prob, Block* path) {
2297   if (!c-&gt;is_Cmp()) {
2298     maybe_add_predicate_after_if(path);
2299     return;
2300   }
2301 
2302   if (stopped() || btest == BoolTest::illegal) {
2303     return;                             // nothing to do
2304   }
2305 
2306   bool is_fallthrough = (path == successor_for_bci(iter().next_bci()));
2307 
2308   if (path_is_suitable_for_uncommon_trap(prob)) {
2309     repush_if_args();
2310     uncommon_trap(Deoptimization::Reason_unstable_if,
2311                   Deoptimization::Action_reinterpret,
2312                   NULL,
2313                   (is_fallthrough ? &quot;taken always&quot; : &quot;taken never&quot;));
2314     return;
2315   }
2316 
2317   Node* val = c-&gt;in(1);
2318   Node* con = c-&gt;in(2);
2319   const Type* tcon = _gvn.type(con);
2320   const Type* tval = _gvn.type(val);
2321   bool have_con = tcon-&gt;singleton();
2322   if (tval-&gt;singleton()) {
2323     if (!have_con) {
2324       // Swap, so constant is in con.
2325       con  = val;
2326       tcon = tval;
2327       val  = c-&gt;in(2);
2328       tval = _gvn.type(val);
2329       btest = BoolTest(btest).commute();
2330       have_con = true;
2331     } else {
2332       // Do we have two constants?  Then leave well enough alone.
2333       have_con = false;
2334     }
2335   }
2336   if (!have_con) {                        // remaining adjustments need a con
2337     maybe_add_predicate_after_if(path);
2338     return;
2339   }
2340 
2341   sharpen_type_after_if(btest, con, tcon, val, tval);
2342   maybe_add_predicate_after_if(path);
2343 }
2344 
2345 
2346 static Node* extract_obj_from_klass_load(PhaseGVN* gvn, Node* n) {
2347   Node* ldk;
2348   if (n-&gt;is_DecodeNKlass()) {
2349     if (n-&gt;in(1)-&gt;Opcode() != Op_LoadNKlass) {
2350       return NULL;
2351     } else {
2352       ldk = n-&gt;in(1);
2353     }
2354   } else if (n-&gt;Opcode() != Op_LoadKlass) {
2355     return NULL;
2356   } else {
2357     ldk = n;
2358   }
2359   assert(ldk != NULL &amp;&amp; ldk-&gt;is_Load(), &quot;should have found a LoadKlass or LoadNKlass node&quot;);
2360 
2361   Node* adr = ldk-&gt;in(MemNode::Address);
2362   intptr_t off = 0;
2363   Node* obj = AddPNode::Ideal_base_and_offset(adr, gvn, off);
2364   if (obj == NULL || off != oopDesc::klass_offset_in_bytes()) // loading oopDesc::_klass?
2365     return NULL;
2366   const TypePtr* tp = gvn-&gt;type(obj)-&gt;is_ptr();
2367   if (tp == NULL || !(tp-&gt;isa_instptr() || tp-&gt;isa_aryptr())) // is obj a Java object ptr?
2368     return NULL;
2369 
2370   return obj;
2371 }
2372 
2373 void Parse::sharpen_type_after_if(BoolTest::mask btest,
2374                                   Node* con, const Type* tcon,
2375                                   Node* val, const Type* tval) {
2376   // Look for opportunities to sharpen the type of a node
2377   // whose klass is compared with a constant klass.
2378   if (btest == BoolTest::eq &amp;&amp; tcon-&gt;isa_klassptr()) {
2379     Node* obj = extract_obj_from_klass_load(&amp;_gvn, val);
2380     const TypeOopPtr* con_type = tcon-&gt;isa_klassptr()-&gt;as_instance_type();
2381     if (obj != NULL &amp;&amp; (con_type-&gt;isa_instptr() || con_type-&gt;isa_aryptr())) {
2382        // Found:
2383        //   Bool(CmpP(LoadKlass(obj._klass), ConP(Foo.klass)), [eq])
2384        // or the narrowOop equivalent.
2385        const Type* obj_type = _gvn.type(obj);
2386        const TypeOopPtr* tboth = obj_type-&gt;join_speculative(con_type)-&gt;isa_oopptr();
2387        if (tboth != NULL &amp;&amp; tboth-&gt;klass_is_exact() &amp;&amp; tboth != obj_type &amp;&amp;
2388            tboth-&gt;higher_equal(obj_type)) {
2389           // obj has to be of the exact type Foo if the CmpP succeeds.
2390           int obj_in_map = map()-&gt;find_edge(obj);
2391           JVMState* jvms = this-&gt;jvms();
2392           if (obj_in_map &gt;= 0 &amp;&amp;
2393               (jvms-&gt;is_loc(obj_in_map) || jvms-&gt;is_stk(obj_in_map))) {
2394             TypeNode* ccast = new CheckCastPPNode(control(), obj, tboth);
2395             const Type* tcc = ccast-&gt;as_Type()-&gt;type();
2396             assert(tcc != obj_type &amp;&amp; tcc-&gt;higher_equal(obj_type), &quot;must improve&quot;);
2397             // Delay transform() call to allow recovery of pre-cast value
2398             // at the control merge.
2399             _gvn.set_type_bottom(ccast);
2400             record_for_igvn(ccast);
2401             // Here&#39;s the payoff.
2402             replace_in_map(obj, ccast);
2403           }
2404        }
2405     }
2406   }
2407 
2408   int val_in_map = map()-&gt;find_edge(val);
2409   if (val_in_map &lt; 0)  return;          // replace_in_map would be useless
2410   {
2411     JVMState* jvms = this-&gt;jvms();
2412     if (!(jvms-&gt;is_loc(val_in_map) ||
2413           jvms-&gt;is_stk(val_in_map)))
2414       return;                           // again, it would be useless
2415   }
2416 
2417   // Check for a comparison to a constant, and &quot;know&quot; that the compared
2418   // value is constrained on this path.
2419   assert(tcon-&gt;singleton(), &quot;&quot;);
2420   ConstraintCastNode* ccast = NULL;
2421   Node* cast = NULL;
2422 
2423   switch (btest) {
2424   case BoolTest::eq:                    // Constant test?
2425     {
2426       const Type* tboth = tcon-&gt;join_speculative(tval);
2427       if (tboth == tval)  break;        // Nothing to gain.
2428       if (tcon-&gt;isa_int()) {
2429         ccast = new CastIINode(val, tboth);
2430       } else if (tcon == TypePtr::NULL_PTR) {
2431         // Cast to null, but keep the pointer identity temporarily live.
2432         ccast = new CastPPNode(val, tboth);
2433       } else {
2434         const TypeF* tf = tcon-&gt;isa_float_constant();
2435         const TypeD* td = tcon-&gt;isa_double_constant();
2436         // Exclude tests vs float/double 0 as these could be
2437         // either +0 or -0.  Just because you are equal to +0
2438         // doesn&#39;t mean you ARE +0!
2439         // Note, following code also replaces Long and Oop values.
2440         if ((!tf || tf-&gt;_f != 0.0) &amp;&amp;
2441             (!td || td-&gt;_d != 0.0))
2442           cast = con;                   // Replace non-constant val by con.
2443       }
2444     }
2445     break;
2446 
2447   case BoolTest::ne:
2448     if (tcon == TypePtr::NULL_PTR) {
2449       cast = cast_not_null(val, false);
2450     }
2451     break;
2452 
2453   default:
2454     // (At this point we could record int range types with CastII.)
2455     break;
2456   }
2457 
2458   if (ccast != NULL) {
2459     const Type* tcc = ccast-&gt;as_Type()-&gt;type();
2460     assert(tcc != tval &amp;&amp; tcc-&gt;higher_equal(tval), &quot;must improve&quot;);
2461     // Delay transform() call to allow recovery of pre-cast value
2462     // at the control merge.
2463     ccast-&gt;set_req(0, control());
2464     _gvn.set_type_bottom(ccast);
2465     record_for_igvn(ccast);
2466     cast = ccast;
2467   }
2468 
2469   if (cast != NULL) {                   // Here&#39;s the payoff.
2470     replace_in_map(val, cast);
2471   }
2472 }
2473 
2474 /**
2475  * Use speculative type to optimize CmpP node: if comparison is
2476  * against the low level class, cast the object to the speculative
2477  * type if any. CmpP should then go away.
2478  *
2479  * @param c  expected CmpP node
2480  * @return   result of CmpP on object casted to speculative type
2481  *
2482  */
2483 Node* Parse::optimize_cmp_with_klass(Node* c) {
2484   // If this is transformed by the _gvn to a comparison with the low
2485   // level klass then we may be able to use speculation
2486   if (c-&gt;Opcode() == Op_CmpP &amp;&amp;
2487       (c-&gt;in(1)-&gt;Opcode() == Op_LoadKlass || c-&gt;in(1)-&gt;Opcode() == Op_DecodeNKlass) &amp;&amp;
2488       c-&gt;in(2)-&gt;is_Con()) {
2489     Node* load_klass = NULL;
2490     Node* decode = NULL;
2491     if (c-&gt;in(1)-&gt;Opcode() == Op_DecodeNKlass) {
2492       decode = c-&gt;in(1);
2493       load_klass = c-&gt;in(1)-&gt;in(1);
2494     } else {
2495       load_klass = c-&gt;in(1);
2496     }
2497     if (load_klass-&gt;in(2)-&gt;is_AddP()) {
2498       Node* addp = load_klass-&gt;in(2);
2499       Node* obj = addp-&gt;in(AddPNode::Address);
2500       const TypeOopPtr* obj_type = _gvn.type(obj)-&gt;is_oopptr();
2501       if (obj_type-&gt;speculative_type_not_null() != NULL) {
2502         ciKlass* k = obj_type-&gt;speculative_type();
2503         inc_sp(2);
2504         obj = maybe_cast_profiled_obj(obj, k);
2505         dec_sp(2);
2506         if (obj-&gt;is_ValueType()) {
2507           assert(obj-&gt;as_ValueType()-&gt;is_allocated(&amp;_gvn), &quot;must be allocated&quot;);
2508           obj = obj-&gt;as_ValueType()-&gt;get_oop();
2509         }
2510         // Make the CmpP use the casted obj
2511         addp = basic_plus_adr(obj, addp-&gt;in(AddPNode::Offset));
2512         load_klass = load_klass-&gt;clone();
2513         load_klass-&gt;set_req(2, addp);
2514         load_klass = _gvn.transform(load_klass);
2515         if (decode != NULL) {
2516           decode = decode-&gt;clone();
2517           decode-&gt;set_req(1, load_klass);
2518           load_klass = _gvn.transform(decode);
2519         }
2520         c = c-&gt;clone();
2521         c-&gt;set_req(1, load_klass);
2522         c = _gvn.transform(c);
2523       }
2524     }
2525   }
2526   return c;
2527 }
2528 
2529 //------------------------------do_one_bytecode--------------------------------
2530 // Parse this bytecode, and alter the Parsers JVM-&gt;Node mapping
2531 void Parse::do_one_bytecode() {
2532   Node *a, *b, *c, *d;          // Handy temps
2533   BoolTest::mask btest;
2534   int i;
2535 
2536   assert(!has_exceptions(), &quot;bytecode entry state must be clear of throws&quot;);
2537 
2538   if (C-&gt;check_node_count(NodeLimitFudgeFactor * 5,
2539                           &quot;out of nodes parsing method&quot;)) {
2540     return;
2541   }
2542 
2543 #ifdef ASSERT
2544   // for setting breakpoints
2545   if (TraceOptoParse) {
2546     tty-&gt;print(&quot; @&quot;);
2547     dump_bci(bci());
2548     tty-&gt;cr();
2549   }
2550 #endif
2551 
2552   switch (bc()) {
2553   case Bytecodes::_nop:
2554     // do nothing
2555     break;
2556   case Bytecodes::_lconst_0:
2557     push_pair(longcon(0));
2558     break;
2559 
2560   case Bytecodes::_lconst_1:
2561     push_pair(longcon(1));
2562     break;
2563 
2564   case Bytecodes::_fconst_0:
2565     push(zerocon(T_FLOAT));
2566     break;
2567 
2568   case Bytecodes::_fconst_1:
2569     push(makecon(TypeF::ONE));
2570     break;
2571 
2572   case Bytecodes::_fconst_2:
2573     push(makecon(TypeF::make(2.0f)));
2574     break;
2575 
2576   case Bytecodes::_dconst_0:
2577     push_pair(zerocon(T_DOUBLE));
2578     break;
2579 
2580   case Bytecodes::_dconst_1:
2581     push_pair(makecon(TypeD::ONE));
2582     break;
2583 
2584   case Bytecodes::_iconst_m1:push(intcon(-1)); break;
2585   case Bytecodes::_iconst_0: push(intcon( 0)); break;
2586   case Bytecodes::_iconst_1: push(intcon( 1)); break;
2587   case Bytecodes::_iconst_2: push(intcon( 2)); break;
2588   case Bytecodes::_iconst_3: push(intcon( 3)); break;
2589   case Bytecodes::_iconst_4: push(intcon( 4)); break;
2590   case Bytecodes::_iconst_5: push(intcon( 5)); break;
2591   case Bytecodes::_bipush:   push(intcon(iter().get_constant_u1())); break;
2592   case Bytecodes::_sipush:   push(intcon(iter().get_constant_u2())); break;
2593   case Bytecodes::_aconst_null: push(null());  break;
2594   case Bytecodes::_ldc:
2595   case Bytecodes::_ldc_w:
2596   case Bytecodes::_ldc2_w:
2597     // If the constant is unresolved, run this BC once in the interpreter.
2598     {
2599       ciConstant constant = iter().get_constant();
2600       if (!constant.is_valid() ||
2601           (constant.basic_type() == T_OBJECT &amp;&amp;
2602            !constant.as_object()-&gt;is_loaded())) {
2603         int index = iter().get_constant_pool_index();
2604         constantTag tag = iter().get_constant_pool_tag(index);
2605         uncommon_trap(Deoptimization::make_trap_request
2606                       (Deoptimization::Reason_unloaded,
2607                        Deoptimization::Action_reinterpret,
2608                        index),
2609                       NULL, tag.internal_name());
2610         break;
2611       }
2612       assert(constant.basic_type() != T_OBJECT || constant.as_object()-&gt;is_instance(),
2613              &quot;must be java_mirror of klass&quot;);
2614       const Type* con_type = Type::make_from_constant(constant);
2615       if (con_type != NULL) {
2616         push_node(con_type-&gt;basic_type(), makecon(con_type));
2617       }
2618     }
2619 
2620     break;
2621 
2622   case Bytecodes::_aload_0:
2623     push( local(0) );
2624     break;
2625   case Bytecodes::_aload_1:
2626     push( local(1) );
2627     break;
2628   case Bytecodes::_aload_2:
2629     push( local(2) );
2630     break;
2631   case Bytecodes::_aload_3:
2632     push( local(3) );
2633     break;
2634   case Bytecodes::_aload:
2635     push( local(iter().get_index()) );
2636     break;
2637 
2638   case Bytecodes::_fload_0:
2639   case Bytecodes::_iload_0:
2640     push( local(0) );
2641     break;
2642   case Bytecodes::_fload_1:
2643   case Bytecodes::_iload_1:
2644     push( local(1) );
2645     break;
2646   case Bytecodes::_fload_2:
2647   case Bytecodes::_iload_2:
2648     push( local(2) );
2649     break;
2650   case Bytecodes::_fload_3:
2651   case Bytecodes::_iload_3:
2652     push( local(3) );
2653     break;
2654   case Bytecodes::_fload:
2655   case Bytecodes::_iload:
2656     push( local(iter().get_index()) );
2657     break;
2658   case Bytecodes::_lload_0:
2659     push_pair_local( 0 );
2660     break;
2661   case Bytecodes::_lload_1:
2662     push_pair_local( 1 );
2663     break;
2664   case Bytecodes::_lload_2:
2665     push_pair_local( 2 );
2666     break;
2667   case Bytecodes::_lload_3:
2668     push_pair_local( 3 );
2669     break;
2670   case Bytecodes::_lload:
2671     push_pair_local( iter().get_index() );
2672     break;
2673 
2674   case Bytecodes::_dload_0:
2675     push_pair_local(0);
2676     break;
2677   case Bytecodes::_dload_1:
2678     push_pair_local(1);
2679     break;
2680   case Bytecodes::_dload_2:
2681     push_pair_local(2);
2682     break;
2683   case Bytecodes::_dload_3:
2684     push_pair_local(3);
2685     break;
2686   case Bytecodes::_dload:
2687     push_pair_local(iter().get_index());
2688     break;
2689   case Bytecodes::_fstore_0:
2690   case Bytecodes::_istore_0:
2691   case Bytecodes::_astore_0:
2692     set_local( 0, pop() );
2693     break;
2694   case Bytecodes::_fstore_1:
2695   case Bytecodes::_istore_1:
2696   case Bytecodes::_astore_1:
2697     set_local( 1, pop() );
2698     break;
2699   case Bytecodes::_fstore_2:
2700   case Bytecodes::_istore_2:
2701   case Bytecodes::_astore_2:
2702     set_local( 2, pop() );
2703     break;
2704   case Bytecodes::_fstore_3:
2705   case Bytecodes::_istore_3:
2706   case Bytecodes::_astore_3:
2707     set_local( 3, pop() );
2708     break;
2709   case Bytecodes::_fstore:
2710   case Bytecodes::_istore:
2711   case Bytecodes::_astore:
2712     set_local( iter().get_index(), pop() );
2713     break;
2714   // long stores
2715   case Bytecodes::_lstore_0:
2716     set_pair_local( 0, pop_pair() );
2717     break;
2718   case Bytecodes::_lstore_1:
2719     set_pair_local( 1, pop_pair() );
2720     break;
2721   case Bytecodes::_lstore_2:
2722     set_pair_local( 2, pop_pair() );
2723     break;
2724   case Bytecodes::_lstore_3:
2725     set_pair_local( 3, pop_pair() );
2726     break;
2727   case Bytecodes::_lstore:
2728     set_pair_local( iter().get_index(), pop_pair() );
2729     break;
2730 
2731   // double stores
2732   case Bytecodes::_dstore_0:
2733     set_pair_local( 0, dstore_rounding(pop_pair()) );
2734     break;
2735   case Bytecodes::_dstore_1:
2736     set_pair_local( 1, dstore_rounding(pop_pair()) );
2737     break;
2738   case Bytecodes::_dstore_2:
2739     set_pair_local( 2, dstore_rounding(pop_pair()) );
2740     break;
2741   case Bytecodes::_dstore_3:
2742     set_pair_local( 3, dstore_rounding(pop_pair()) );
2743     break;
2744   case Bytecodes::_dstore:
2745     set_pair_local( iter().get_index(), dstore_rounding(pop_pair()) );
2746     break;
2747 
2748   case Bytecodes::_pop:  dec_sp(1);   break;
2749   case Bytecodes::_pop2: dec_sp(2);   break;
2750   case Bytecodes::_swap:
2751     a = pop();
2752     b = pop();
2753     push(a);
2754     push(b);
2755     break;
2756   case Bytecodes::_dup:
2757     a = pop();
2758     push(a);
2759     push(a);
2760     break;
2761   case Bytecodes::_dup_x1:
2762     a = pop();
2763     b = pop();
2764     push( a );
2765     push( b );
2766     push( a );
2767     break;
2768   case Bytecodes::_dup_x2:
2769     a = pop();
2770     b = pop();
2771     c = pop();
2772     push( a );
2773     push( c );
2774     push( b );
2775     push( a );
2776     break;
2777   case Bytecodes::_dup2:
2778     a = pop();
2779     b = pop();
2780     push( b );
2781     push( a );
2782     push( b );
2783     push( a );
2784     break;
2785 
2786   case Bytecodes::_dup2_x1:
2787     // before: .. c, b, a
2788     // after:  .. b, a, c, b, a
2789     // not tested
2790     a = pop();
2791     b = pop();
2792     c = pop();
2793     push( b );
2794     push( a );
2795     push( c );
2796     push( b );
2797     push( a );
2798     break;
2799   case Bytecodes::_dup2_x2:
2800     // before: .. d, c, b, a
2801     // after:  .. b, a, d, c, b, a
2802     // not tested
2803     a = pop();
2804     b = pop();
2805     c = pop();
2806     d = pop();
2807     push( b );
2808     push( a );
2809     push( d );
2810     push( c );
2811     push( b );
2812     push( a );
2813     break;
2814 
2815   case Bytecodes::_arraylength: {
2816     // Must do null-check with value on expression stack
2817     Node *ary = null_check(peek(), T_ARRAY);
2818     // Compile-time detect of null-exception?
2819     if (stopped())  return;
2820     a = pop();
2821     push(load_array_length(a));
2822     break;
2823   }
2824 
2825   case Bytecodes::_baload:  array_load(T_BYTE);    break;
2826   case Bytecodes::_caload:  array_load(T_CHAR);    break;
2827   case Bytecodes::_iaload:  array_load(T_INT);     break;
2828   case Bytecodes::_saload:  array_load(T_SHORT);   break;
2829   case Bytecodes::_faload:  array_load(T_FLOAT);   break;
2830   case Bytecodes::_aaload:  array_load(T_OBJECT);  break;
2831   case Bytecodes::_laload:  array_load(T_LONG);    break;
2832   case Bytecodes::_daload:  array_load(T_DOUBLE);  break;
2833   case Bytecodes::_bastore: array_store(T_BYTE);   break;
2834   case Bytecodes::_castore: array_store(T_CHAR);   break;
2835   case Bytecodes::_iastore: array_store(T_INT);    break;
2836   case Bytecodes::_sastore: array_store(T_SHORT);  break;
2837   case Bytecodes::_fastore: array_store(T_FLOAT);  break;
2838   case Bytecodes::_aastore: array_store(T_OBJECT); break;
2839   case Bytecodes::_lastore: array_store(T_LONG);   break;
2840   case Bytecodes::_dastore: array_store(T_DOUBLE); break;
2841 
2842   case Bytecodes::_getfield:
2843     do_getfield();
2844     break;
2845 
2846   case Bytecodes::_getstatic:
2847     do_getstatic();
2848     break;
2849 
2850   case Bytecodes::_putfield:
2851     do_putfield();
2852     break;
2853 
2854   case Bytecodes::_putstatic:
2855     do_putstatic();
2856     break;
2857 
2858   case Bytecodes::_irem:
2859     do_irem();
2860     break;
2861   case Bytecodes::_idiv:
2862     // Must keep both values on the expression-stack during null-check
2863     zero_check_int(peek());
2864     // Compile-time detect of null-exception?
2865     if (stopped())  return;
2866     b = pop();
2867     a = pop();
2868     push( _gvn.transform( new DivINode(control(),a,b) ) );
2869     break;
2870   case Bytecodes::_imul:
2871     b = pop(); a = pop();
2872     push( _gvn.transform( new MulINode(a,b) ) );
2873     break;
2874   case Bytecodes::_iadd:
2875     b = pop(); a = pop();
2876     push( _gvn.transform( new AddINode(a,b) ) );
2877     break;
2878   case Bytecodes::_ineg:
2879     a = pop();
2880     push( _gvn.transform( new SubINode(_gvn.intcon(0),a)) );
2881     break;
2882   case Bytecodes::_isub:
2883     b = pop(); a = pop();
2884     push( _gvn.transform( new SubINode(a,b) ) );
2885     break;
2886   case Bytecodes::_iand:
2887     b = pop(); a = pop();
2888     push( _gvn.transform( new AndINode(a,b) ) );
2889     break;
2890   case Bytecodes::_ior:
2891     b = pop(); a = pop();
2892     push( _gvn.transform( new OrINode(a,b) ) );
2893     break;
2894   case Bytecodes::_ixor:
2895     b = pop(); a = pop();
2896     push( _gvn.transform( new XorINode(a,b) ) );
2897     break;
2898   case Bytecodes::_ishl:
2899     b = pop(); a = pop();
2900     push( _gvn.transform( new LShiftINode(a,b) ) );
2901     break;
2902   case Bytecodes::_ishr:
2903     b = pop(); a = pop();
2904     push( _gvn.transform( new RShiftINode(a,b) ) );
2905     break;
2906   case Bytecodes::_iushr:
2907     b = pop(); a = pop();
2908     push( _gvn.transform( new URShiftINode(a,b) ) );
2909     break;
2910 
2911   case Bytecodes::_fneg:
2912     a = pop();
2913     b = _gvn.transform(new NegFNode (a));
2914     push(b);
2915     break;
2916 
2917   case Bytecodes::_fsub:
2918     b = pop();
2919     a = pop();
2920     c = _gvn.transform( new SubFNode(a,b) );
2921     d = precision_rounding(c);
2922     push( d );
2923     break;
2924 
2925   case Bytecodes::_fadd:
2926     b = pop();
2927     a = pop();
2928     c = _gvn.transform( new AddFNode(a,b) );
2929     d = precision_rounding(c);
2930     push( d );
2931     break;
2932 
2933   case Bytecodes::_fmul:
2934     b = pop();
2935     a = pop();
2936     c = _gvn.transform( new MulFNode(a,b) );
2937     d = precision_rounding(c);
2938     push( d );
2939     break;
2940 
2941   case Bytecodes::_fdiv:
2942     b = pop();
2943     a = pop();
2944     c = _gvn.transform( new DivFNode(0,a,b) );
2945     d = precision_rounding(c);
2946     push( d );
2947     break;
2948 
2949   case Bytecodes::_frem:
2950     if (Matcher::has_match_rule(Op_ModF)) {
2951       // Generate a ModF node.
2952       b = pop();
2953       a = pop();
2954       c = _gvn.transform( new ModFNode(0,a,b) );
2955       d = precision_rounding(c);
2956       push( d );
2957     }
2958     else {
2959       // Generate a call.
2960       modf();
2961     }
2962     break;
2963 
2964   case Bytecodes::_fcmpl:
2965     b = pop();
2966     a = pop();
2967     c = _gvn.transform( new CmpF3Node( a, b));
2968     push(c);
2969     break;
2970   case Bytecodes::_fcmpg:
2971     b = pop();
2972     a = pop();
2973 
2974     // Same as fcmpl but need to flip the unordered case.  Swap the inputs,
2975     // which negates the result sign except for unordered.  Flip the unordered
2976     // as well by using CmpF3 which implements unordered-lesser instead of
2977     // unordered-greater semantics.  Finally, commute the result bits.  Result
2978     // is same as using a CmpF3Greater except we did it with CmpF3 alone.
2979     c = _gvn.transform( new CmpF3Node( b, a));
2980     c = _gvn.transform( new SubINode(_gvn.intcon(0),c) );
2981     push(c);
2982     break;
2983 
2984   case Bytecodes::_f2i:
2985     a = pop();
2986     push(_gvn.transform(new ConvF2INode(a)));
2987     break;
2988 
2989   case Bytecodes::_d2i:
2990     a = pop_pair();
2991     b = _gvn.transform(new ConvD2INode(a));
2992     push( b );
2993     break;
2994 
2995   case Bytecodes::_f2d:
2996     a = pop();
2997     b = _gvn.transform( new ConvF2DNode(a));
2998     push_pair( b );
2999     break;
3000 
3001   case Bytecodes::_d2f:
3002     a = pop_pair();
3003     b = _gvn.transform( new ConvD2FNode(a));
3004     // This breaks _227_mtrt (speed &amp; correctness) and _222_mpegaudio (speed)
3005     //b = _gvn.transform(new RoundFloatNode(0, b) );
3006     push( b );
3007     break;
3008 
3009   case Bytecodes::_l2f:
3010     if (Matcher::convL2FSupported()) {
3011       a = pop_pair();
3012       b = _gvn.transform( new ConvL2FNode(a));
3013       // For i486.ad, FILD doesn&#39;t restrict precision to 24 or 53 bits.
3014       // Rather than storing the result into an FP register then pushing
3015       // out to memory to round, the machine instruction that implements
3016       // ConvL2D is responsible for rounding.
3017       // c = precision_rounding(b);
3018       c = _gvn.transform(b);
3019       push(c);
3020     } else {
3021       l2f();
3022     }
3023     break;
3024 
3025   case Bytecodes::_l2d:
3026     a = pop_pair();
3027     b = _gvn.transform( new ConvL2DNode(a));
3028     // For i486.ad, rounding is always necessary (see _l2f above).
3029     // c = dprecision_rounding(b);
3030     c = _gvn.transform(b);
3031     push_pair(c);
3032     break;
3033 
3034   case Bytecodes::_f2l:
3035     a = pop();
3036     b = _gvn.transform( new ConvF2LNode(a));
3037     push_pair(b);
3038     break;
3039 
3040   case Bytecodes::_d2l:
3041     a = pop_pair();
3042     b = _gvn.transform( new ConvD2LNode(a));
3043     push_pair(b);
3044     break;
3045 
3046   case Bytecodes::_dsub:
3047     b = pop_pair();
3048     a = pop_pair();
3049     c = _gvn.transform( new SubDNode(a,b) );
3050     d = dprecision_rounding(c);
3051     push_pair( d );
3052     break;
3053 
3054   case Bytecodes::_dadd:
3055     b = pop_pair();
3056     a = pop_pair();
3057     c = _gvn.transform( new AddDNode(a,b) );
3058     d = dprecision_rounding(c);
3059     push_pair( d );
3060     break;
3061 
3062   case Bytecodes::_dmul:
3063     b = pop_pair();
3064     a = pop_pair();
3065     c = _gvn.transform( new MulDNode(a,b) );
3066     d = dprecision_rounding(c);
3067     push_pair( d );
3068     break;
3069 
3070   case Bytecodes::_ddiv:
3071     b = pop_pair();
3072     a = pop_pair();
3073     c = _gvn.transform( new DivDNode(0,a,b) );
3074     d = dprecision_rounding(c);
3075     push_pair( d );
3076     break;
3077 
3078   case Bytecodes::_dneg:
3079     a = pop_pair();
3080     b = _gvn.transform(new NegDNode (a));
3081     push_pair(b);
3082     break;
3083 
3084   case Bytecodes::_drem:
3085     if (Matcher::has_match_rule(Op_ModD)) {
3086       // Generate a ModD node.
3087       b = pop_pair();
3088       a = pop_pair();
3089       // a % b
3090 
3091       c = _gvn.transform( new ModDNode(0,a,b) );
3092       d = dprecision_rounding(c);
3093       push_pair( d );
3094     }
3095     else {
3096       // Generate a call.
3097       modd();
3098     }
3099     break;
3100 
3101   case Bytecodes::_dcmpl:
3102     b = pop_pair();
3103     a = pop_pair();
3104     c = _gvn.transform( new CmpD3Node( a, b));
3105     push(c);
3106     break;
3107 
3108   case Bytecodes::_dcmpg:
3109     b = pop_pair();
3110     a = pop_pair();
3111     // Same as dcmpl but need to flip the unordered case.
3112     // Commute the inputs, which negates the result sign except for unordered.
3113     // Flip the unordered as well by using CmpD3 which implements
3114     // unordered-lesser instead of unordered-greater semantics.
3115     // Finally, negate the result bits.  Result is same as using a
3116     // CmpD3Greater except we did it with CmpD3 alone.
3117     c = _gvn.transform( new CmpD3Node( b, a));
3118     c = _gvn.transform( new SubINode(_gvn.intcon(0),c) );
3119     push(c);
3120     break;
3121 
3122 
3123     // Note for longs -&gt; lo word is on TOS, hi word is on TOS - 1
3124   case Bytecodes::_land:
3125     b = pop_pair();
3126     a = pop_pair();
3127     c = _gvn.transform( new AndLNode(a,b) );
3128     push_pair(c);
3129     break;
3130   case Bytecodes::_lor:
3131     b = pop_pair();
3132     a = pop_pair();
3133     c = _gvn.transform( new OrLNode(a,b) );
3134     push_pair(c);
3135     break;
3136   case Bytecodes::_lxor:
3137     b = pop_pair();
3138     a = pop_pair();
3139     c = _gvn.transform( new XorLNode(a,b) );
3140     push_pair(c);
3141     break;
3142 
3143   case Bytecodes::_lshl:
3144     b = pop();                  // the shift count
3145     a = pop_pair();             // value to be shifted
3146     c = _gvn.transform( new LShiftLNode(a,b) );
3147     push_pair(c);
3148     break;
3149   case Bytecodes::_lshr:
3150     b = pop();                  // the shift count
3151     a = pop_pair();             // value to be shifted
3152     c = _gvn.transform( new RShiftLNode(a,b) );
3153     push_pair(c);
3154     break;
3155   case Bytecodes::_lushr:
3156     b = pop();                  // the shift count
3157     a = pop_pair();             // value to be shifted
3158     c = _gvn.transform( new URShiftLNode(a,b) );
3159     push_pair(c);
3160     break;
3161   case Bytecodes::_lmul:
3162     b = pop_pair();
3163     a = pop_pair();
3164     c = _gvn.transform( new MulLNode(a,b) );
3165     push_pair(c);
3166     break;
3167 
3168   case Bytecodes::_lrem:
3169     // Must keep both values on the expression-stack during null-check
3170     assert(peek(0) == top(), &quot;long word order&quot;);
3171     zero_check_long(peek(1));
3172     // Compile-time detect of null-exception?
3173     if (stopped())  return;
3174     b = pop_pair();
3175     a = pop_pair();
3176     c = _gvn.transform( new ModLNode(control(),a,b) );
3177     push_pair(c);
3178     break;
3179 
3180   case Bytecodes::_ldiv:
3181     // Must keep both values on the expression-stack during null-check
3182     assert(peek(0) == top(), &quot;long word order&quot;);
3183     zero_check_long(peek(1));
3184     // Compile-time detect of null-exception?
3185     if (stopped())  return;
3186     b = pop_pair();
3187     a = pop_pair();
3188     c = _gvn.transform( new DivLNode(control(),a,b) );
3189     push_pair(c);
3190     break;
3191 
3192   case Bytecodes::_ladd:
3193     b = pop_pair();
3194     a = pop_pair();
3195     c = _gvn.transform( new AddLNode(a,b) );
3196     push_pair(c);
3197     break;
3198   case Bytecodes::_lsub:
3199     b = pop_pair();
3200     a = pop_pair();
3201     c = _gvn.transform( new SubLNode(a,b) );
3202     push_pair(c);
3203     break;
3204   case Bytecodes::_lcmp:
3205     // Safepoints are now inserted _before_ branches.  The long-compare
3206     // bytecode painfully produces a 3-way value (-1,0,+1) which requires a
3207     // slew of control flow.  These are usually followed by a CmpI vs zero and
3208     // a branch; this pattern then optimizes to the obvious long-compare and
3209     // branch.  However, if the branch is backwards there&#39;s a Safepoint
3210     // inserted.  The inserted Safepoint captures the JVM state at the
3211     // pre-branch point, i.e. it captures the 3-way value.  Thus if a
3212     // long-compare is used to control a loop the debug info will force
3213     // computation of the 3-way value, even though the generated code uses a
3214     // long-compare and branch.  We try to rectify the situation by inserting
3215     // a SafePoint here and have it dominate and kill the safepoint added at a
3216     // following backwards branch.  At this point the JVM state merely holds 2
3217     // longs but not the 3-way value.
3218     if( UseLoopSafepoints ) {
3219       switch( iter().next_bc() ) {
3220       case Bytecodes::_ifgt:
3221       case Bytecodes::_iflt:
3222       case Bytecodes::_ifge:
3223       case Bytecodes::_ifle:
3224       case Bytecodes::_ifne:
3225       case Bytecodes::_ifeq:
3226         // If this is a backwards branch in the bytecodes, add Safepoint
3227         maybe_add_safepoint(iter().next_get_dest());
3228       default:
3229         break;
3230       }
3231     }
3232     b = pop_pair();
3233     a = pop_pair();
3234     c = _gvn.transform( new CmpL3Node( a, b ));
3235     push(c);
3236     break;
3237 
3238   case Bytecodes::_lneg:
3239     a = pop_pair();
3240     b = _gvn.transform( new SubLNode(longcon(0),a));
3241     push_pair(b);
3242     break;
3243   case Bytecodes::_l2i:
3244     a = pop_pair();
3245     push( _gvn.transform( new ConvL2INode(a)));
3246     break;
3247   case Bytecodes::_i2l:
3248     a = pop();
3249     b = _gvn.transform( new ConvI2LNode(a));
3250     push_pair(b);
3251     break;
3252   case Bytecodes::_i2b:
3253     // Sign extend
3254     a = pop();
3255     a = _gvn.transform( new LShiftINode(a,_gvn.intcon(24)) );
3256     a = _gvn.transform( new RShiftINode(a,_gvn.intcon(24)) );
3257     push( a );
3258     break;
3259   case Bytecodes::_i2s:
3260     a = pop();
3261     a = _gvn.transform( new LShiftINode(a,_gvn.intcon(16)) );
3262     a = _gvn.transform( new RShiftINode(a,_gvn.intcon(16)) );
3263     push( a );
3264     break;
3265   case Bytecodes::_i2c:
3266     a = pop();
3267     push( _gvn.transform( new AndINode(a,_gvn.intcon(0xFFFF)) ) );
3268     break;
3269 
3270   case Bytecodes::_i2f:
3271     a = pop();
3272     b = _gvn.transform( new ConvI2FNode(a) ) ;
3273     c = precision_rounding(b);
3274     push (b);
3275     break;
3276 
3277   case Bytecodes::_i2d:
3278     a = pop();
3279     b = _gvn.transform( new ConvI2DNode(a));
3280     push_pair(b);
3281     break;
3282 
3283   case Bytecodes::_iinc:        // Increment local
3284     i = iter().get_index();     // Get local index
3285     set_local( i, _gvn.transform( new AddINode( _gvn.intcon(iter().get_iinc_con()), local(i) ) ) );
3286     break;
3287 
3288   // Exit points of synchronized methods must have an unlock node
3289   case Bytecodes::_return:
3290     return_current(NULL);
3291     break;
3292 
3293   case Bytecodes::_ireturn:
3294   case Bytecodes::_areturn:
3295   case Bytecodes::_freturn:
3296     return_current(pop());
3297     break;
3298   case Bytecodes::_lreturn:
3299     return_current(pop_pair());
3300     break;
3301   case Bytecodes::_dreturn:
3302     return_current(pop_pair());
3303     break;
3304 
3305   case Bytecodes::_athrow:
3306     // null exception oop throws NULL pointer exception
3307     null_check(peek());
3308     if (stopped())  return;
3309     // Hook the thrown exception directly to subsequent handlers.
3310     if (BailoutToInterpreterForThrows) {
3311       // Keep method interpreted from now on.
3312       uncommon_trap(Deoptimization::Reason_unhandled,
3313                     Deoptimization::Action_make_not_compilable);
3314       return;
3315     }
3316     if (env()-&gt;jvmti_can_post_on_exceptions()) {
3317       // check if we must post exception events, take uncommon trap if so (with must_throw = false)
3318       uncommon_trap_if_should_post_on_exceptions(Deoptimization::Reason_unhandled, false);
3319     }
3320     // Here if either can_post_on_exceptions or should_post_on_exceptions is false
3321     add_exception_state(make_exception_state(peek()));
3322     break;
3323 
3324   case Bytecodes::_goto:   // fall through
3325   case Bytecodes::_goto_w: {
3326     int target_bci = (bc() == Bytecodes::_goto) ? iter().get_dest() : iter().get_far_dest();
3327 
3328     // If this is a backwards branch in the bytecodes, add Safepoint
3329     maybe_add_safepoint(target_bci);
3330 
3331     // Update method data
3332     profile_taken_branch(target_bci);
3333 
3334     // Merge the current control into the target basic block
3335     merge(target_bci);
3336 
3337     // See if we can get some profile data and hand it off to the next block
3338     Block *target_block = block()-&gt;successor_for_bci(target_bci);
3339     if (target_block-&gt;pred_count() != 1)  break;
3340     ciMethodData* methodData = method()-&gt;method_data();
3341     if (!methodData-&gt;is_mature())  break;
3342     ciProfileData* data = methodData-&gt;bci_to_data(bci());
3343     assert(data != NULL &amp;&amp; data-&gt;is_JumpData(), &quot;need JumpData for taken branch&quot;);
3344     int taken = ((ciJumpData*)data)-&gt;taken();
3345     taken = method()-&gt;scale_count(taken);
3346     target_block-&gt;set_count(taken);
3347     break;
3348   }
3349 
3350   case Bytecodes::_ifnull:    btest = BoolTest::eq; goto handle_if_null;
3351   case Bytecodes::_ifnonnull: btest = BoolTest::ne; goto handle_if_null;
3352   handle_if_null:
3353     // If this is a backwards branch in the bytecodes, add Safepoint
3354     maybe_add_safepoint(iter().get_dest());
3355     a = null();
3356     b = pop();
3357     if (b-&gt;is_ValueType()) {
3358       // Return constant false because &#39;b&#39; is always non-null
3359       c = _gvn.makecon(TypeInt::CC_GT);
3360     } else {
3361       if (!_gvn.type(b)-&gt;speculative_maybe_null() &amp;&amp;
3362           !too_many_traps(Deoptimization::Reason_speculate_null_check)) {
3363         inc_sp(1);
3364         Node* null_ctl = top();
3365         b = null_check_oop(b, &amp;null_ctl, true, true, true);
3366         assert(null_ctl-&gt;is_top(), &quot;no null control here&quot;);
3367         dec_sp(1);
3368       } else if (_gvn.type(b)-&gt;speculative_always_null() &amp;&amp;
3369                  !too_many_traps(Deoptimization::Reason_speculate_null_assert)) {
3370         inc_sp(1);
3371         b = null_assert(b);
3372         dec_sp(1);
3373       }
3374       c = _gvn.transform( new CmpPNode(b, a) );
3375     }
3376     do_ifnull(btest, c);
3377     break;
3378 
3379   case Bytecodes::_if_acmpeq: btest = BoolTest::eq; goto handle_if_acmp;
3380   case Bytecodes::_if_acmpne: btest = BoolTest::ne; goto handle_if_acmp;
3381   handle_if_acmp:
3382     // If this is a backwards branch in the bytecodes, add Safepoint
3383     maybe_add_safepoint(iter().get_dest());
3384     a = pop();
3385     b = pop();
3386     do_acmp(btest, a, b);
3387     break;
3388 
3389   case Bytecodes::_ifeq: btest = BoolTest::eq; goto handle_ifxx;
3390   case Bytecodes::_ifne: btest = BoolTest::ne; goto handle_ifxx;
3391   case Bytecodes::_iflt: btest = BoolTest::lt; goto handle_ifxx;
3392   case Bytecodes::_ifle: btest = BoolTest::le; goto handle_ifxx;
3393   case Bytecodes::_ifgt: btest = BoolTest::gt; goto handle_ifxx;
3394   case Bytecodes::_ifge: btest = BoolTest::ge; goto handle_ifxx;
3395   handle_ifxx:
3396     // If this is a backwards branch in the bytecodes, add Safepoint
3397     maybe_add_safepoint(iter().get_dest());
3398     a = _gvn.intcon(0);
3399     b = pop();
3400     c = _gvn.transform( new CmpINode(b, a) );
3401     do_if(btest, c);
3402     break;
3403 
3404   case Bytecodes::_if_icmpeq: btest = BoolTest::eq; goto handle_if_icmp;
3405   case Bytecodes::_if_icmpne: btest = BoolTest::ne; goto handle_if_icmp;
3406   case Bytecodes::_if_icmplt: btest = BoolTest::lt; goto handle_if_icmp;
3407   case Bytecodes::_if_icmple: btest = BoolTest::le; goto handle_if_icmp;
3408   case Bytecodes::_if_icmpgt: btest = BoolTest::gt; goto handle_if_icmp;
3409   case Bytecodes::_if_icmpge: btest = BoolTest::ge; goto handle_if_icmp;
3410   handle_if_icmp:
3411     // If this is a backwards branch in the bytecodes, add Safepoint
3412     maybe_add_safepoint(iter().get_dest());
3413     a = pop();
3414     b = pop();
3415     c = _gvn.transform( new CmpINode( b, a ) );
3416     do_if(btest, c);
3417     break;
3418 
3419   case Bytecodes::_tableswitch:
3420     do_tableswitch();
3421     break;
3422 
3423   case Bytecodes::_lookupswitch:
3424     do_lookupswitch();
3425     break;
3426 
3427   case Bytecodes::_invokestatic:
3428   case Bytecodes::_invokedynamic:
3429   case Bytecodes::_invokespecial:
3430   case Bytecodes::_invokevirtual:
3431   case Bytecodes::_invokeinterface:
3432     do_call();
3433     break;
3434   case Bytecodes::_checkcast:
3435     do_checkcast();
3436     break;
3437   case Bytecodes::_instanceof:
3438     do_instanceof();
3439     break;
3440   case Bytecodes::_anewarray:
3441     do_newarray();
3442     break;
3443   case Bytecodes::_newarray:
3444     do_newarray((BasicType)iter().get_index());
3445     break;
3446   case Bytecodes::_multianewarray:
3447     do_multianewarray();
3448     break;
3449   case Bytecodes::_new:
3450     do_new();
3451     break;
3452   case Bytecodes::_defaultvalue:
3453     do_defaultvalue();
3454     break;
3455   case Bytecodes::_withfield:
3456     do_withfield();
3457     break;
3458 
3459   case Bytecodes::_jsr:
3460   case Bytecodes::_jsr_w:
3461     do_jsr();
3462     break;
3463 
3464   case Bytecodes::_ret:
3465     do_ret();
3466     break;
3467 
3468 
3469   case Bytecodes::_monitorenter:
3470     do_monitor_enter();
3471     break;
3472 
3473   case Bytecodes::_monitorexit:
3474     do_monitor_exit();
3475     break;
3476 
3477   case Bytecodes::_breakpoint:
3478     // Breakpoint set concurrently to compile
3479     // %%% use an uncommon trap?
3480     C-&gt;record_failure(&quot;breakpoint in method&quot;);
3481     return;
3482 
3483   default:
3484 #ifndef PRODUCT
3485     map()-&gt;dump(99);
3486 #endif
3487     tty-&gt;print(&quot;\nUnhandled bytecode %s\n&quot;, Bytecodes::name(bc()) );
3488     ShouldNotReachHere();
3489   }
3490 
3491 #ifndef PRODUCT
3492   IdealGraphPrinter *printer = C-&gt;printer();
3493   if (printer &amp;&amp; printer-&gt;should_print(1)) {
3494     char buffer[256];
3495     jio_snprintf(buffer, sizeof(buffer), &quot;Bytecode %d: %s&quot;, bci(), Bytecodes::name(bc()));
3496     bool old = printer-&gt;traverse_outs();
3497     printer-&gt;set_traverse_outs(true);
3498     printer-&gt;print_method(buffer, 4);
3499     printer-&gt;set_traverse_outs(old);
3500   }
3501 #endif
3502 }
    </pre>
  </body>
</html>