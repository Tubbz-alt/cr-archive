<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Old src/hotspot/share/opto/graphKit.hpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
  </head>
  <body>
    <pre>
  1 /*
  2  * Copyright (c) 2001, 2019, Oracle and/or its affiliates. All rights reserved.
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  *
 23  */
 24 
 25 #ifndef SHARE_OPTO_GRAPHKIT_HPP
 26 #define SHARE_OPTO_GRAPHKIT_HPP
 27 
 28 #include &quot;ci/ciEnv.hpp&quot;
 29 #include &quot;ci/ciMethodData.hpp&quot;
 30 #include &quot;gc/shared/c2/barrierSetC2.hpp&quot;
 31 #include &quot;opto/addnode.hpp&quot;
 32 #include &quot;opto/callnode.hpp&quot;
 33 #include &quot;opto/cfgnode.hpp&quot;
 34 #include &quot;opto/compile.hpp&quot;
 35 #include &quot;opto/divnode.hpp&quot;
 36 #include &quot;opto/mulnode.hpp&quot;
 37 #include &quot;opto/phaseX.hpp&quot;
 38 #include &quot;opto/subnode.hpp&quot;
 39 #include &quot;opto/type.hpp&quot;
 40 #include &quot;opto/valuetypenode.hpp&quot;
 41 #include &quot;runtime/deoptimization.hpp&quot;
 42 
 43 class BarrierSetC2;
 44 class FastLockNode;
 45 class FastUnlockNode;
 46 class IdealKit;
 47 class LibraryCallKit;
 48 class Parse;
 49 class RootNode;
 50 
 51 //-----------------------------------------------------------------------------
 52 //----------------------------GraphKit-----------------------------------------
 53 // Toolkit for building the common sorts of subgraphs.
 54 // Does not know about bytecode parsing or type-flow results.
 55 // It is able to create graphs implementing the semantics of most
 56 // or all bytecodes, so that it can expand intrinsics and calls.
 57 // It may depend on JVMState structure, but it must not depend
 58 // on specific bytecode streams.
 59 class GraphKit : public Phase {
 60   friend class PreserveJVMState;
 61 
 62  protected:
 63   ciEnv*            _env;       // Compilation environment
 64   PhaseGVN         &amp;_gvn;       // Some optimizations while parsing
 65   SafePointNode*    _map;       // Parser map from JVM to Nodes
 66   SafePointNode*    _exceptions;// Parser map(s) for exception state(s)
 67   int               _bci;       // JVM Bytecode Pointer
 68   ciMethod*         _method;    // JVM Current Method
 69   BarrierSetC2*     _barrier_set;
 70 #ifdef ASSERT
 71   uint              _worklist_size;
 72 #endif
 73 
 74  private:
 75   int               _sp;        // JVM Expression Stack Pointer; don&#39;t modify directly!
 76 
 77  private:
 78   SafePointNode*     map_not_null() const {
 79     assert(_map != NULL, &quot;must call stopped() to test for reset compiler map&quot;);
 80     return _map;
 81   }
 82 
 83  public:
 84   GraphKit();                   // empty constructor
 85   GraphKit(JVMState* jvms, PhaseGVN* gvn = NULL);     // the JVM state on which to operate
 86 
 87 #ifdef ASSERT
 88   ~GraphKit() {
 89     assert(!has_exceptions(), &quot;user must call transfer_exceptions_into_jvms&quot;);
 90     // During incremental inlining, the Node_Array of the C-&gt;for_igvn() worklist and the IGVN
 91     // worklist are shared but the _in_worklist VectorSet is not. To avoid inconsistencies,
 92     // we should not add nodes to the _for_igvn worklist when using IGVN for the GraphKit.
 93     assert((_gvn.is_IterGVN() == NULL) || (_gvn.C-&gt;for_igvn()-&gt;size() == _worklist_size),
 94            &quot;GraphKit should not modify _for_igvn worklist after parsing&quot;);
 95   }
 96 #endif
 97 
 98   virtual Parse*          is_Parse()          const { return NULL; }
 99   virtual LibraryCallKit* is_LibraryCallKit() const { return NULL; }
100 
101   ciEnv*        env()               const { return _env; }
102   PhaseGVN&amp;     gvn()               const { return _gvn; }
103   void*         barrier_set_state() const { return C-&gt;barrier_set_state(); }
104 
105   void record_for_igvn(Node* n) const { _gvn.record_for_igvn(n); }
106 
107   // Handy well-known nodes:
108   Node*         null()          const { return zerocon(T_OBJECT); }
109   Node*         top()           const { return C-&gt;top(); }
110   RootNode*     root()          const { return C-&gt;root(); }
111 
112   // Create or find a constant node
113   Node* intcon(jint con)        const { return _gvn.intcon(con); }
114   Node* longcon(jlong con)      const { return _gvn.longcon(con); }
115   Node* makecon(const Type *t)  const { return _gvn.makecon(t); }
116   Node* zerocon(BasicType bt)   const { return _gvn.zerocon(bt); }
117   // (See also macro MakeConX in type.hpp, which uses intcon or longcon.)
118 
119   jint  find_int_con(Node* n, jint value_if_unknown) {
120     return _gvn.find_int_con(n, value_if_unknown);
121   }
122   jlong find_long_con(Node* n, jlong value_if_unknown) {
123     return _gvn.find_long_con(n, value_if_unknown);
124   }
125   // (See also macro find_intptr_t_con in type.hpp, which uses one of these.)
126 
127   // JVM State accessors:
128   // Parser mapping from JVM indices into Nodes.
129   // Low slots are accessed by the StartNode::enum.
130   // Then come the locals at StartNode::Parms to StartNode::Parms+max_locals();
131   // Then come JVM stack slots.
132   // Finally come the monitors, if any.
133   // See layout accessors in class JVMState.
134 
135   SafePointNode*     map()      const { return _map; }
136   bool               has_exceptions() const { return _exceptions != NULL; }
137   JVMState*          jvms()     const { return map_not_null()-&gt;_jvms; }
138   int                sp()       const { return _sp; }
139   int                bci()      const { return _bci; }
140   Bytecodes::Code    java_bc()  const;
141   ciMethod*          method()   const { return _method; }
142 
143   void set_jvms(JVMState* jvms)       { set_map(jvms-&gt;map());
144                                         assert(jvms == this-&gt;jvms(), &quot;sanity&quot;);
145                                         _sp = jvms-&gt;sp();
146                                         _bci = jvms-&gt;bci();
147                                         _method = jvms-&gt;has_method() ? jvms-&gt;method() : NULL; }
148   void set_map(SafePointNode* m)      { _map = m; debug_only(verify_map()); }
149   void set_sp(int sp)                 { assert(sp &gt;= 0, &quot;sp must be non-negative: %d&quot;, sp); _sp = sp; }
150   void clean_stack(int from_sp); // clear garbage beyond from_sp to top
151 
152   void inc_sp(int i)                  { set_sp(sp() + i); }
153   void dec_sp(int i)                  { set_sp(sp() - i); }
154   void set_bci(int bci)               { _bci = bci; }
155 
156   // Make sure jvms has current bci &amp; sp.
157   JVMState* sync_jvms() const;
158   JVMState* sync_jvms_for_reexecute();
159 
160 #ifdef ASSERT
161   // Make sure JVMS has an updated copy of bci and sp.
162   // Also sanity-check method, depth, and monitor depth.
163   bool jvms_in_sync() const;
164 
165   // Make sure the map looks OK.
166   void verify_map() const;
167 
168   // Make sure a proposed exception state looks OK.
169   static void verify_exception_state(SafePointNode* ex_map);
170 #endif
171 
172   // Clone the existing map state.  (Implements PreserveJVMState.)
173   SafePointNode* clone_map();
174 
175   // Set the map to a clone of the given one.
176   void set_map_clone(SafePointNode* m);
177 
178   // Tell if the compilation is failing.
179   bool failing() const { return C-&gt;failing(); }
180 
181   // Set _map to NULL, signalling a stop to further bytecode execution.
182   // Preserve the map intact for future use, and return it back to the caller.
183   SafePointNode* stop() { SafePointNode* m = map(); set_map(NULL); return m; }
184 
185   // Stop, but first smash the map&#39;s inputs to NULL, to mark it dead.
186   void stop_and_kill_map();
187 
188   // Tell if _map is NULL, or control is top.
189   bool stopped();
190 
191   // Tell if this method or any caller method has exception handlers.
192   bool has_ex_handler();
193 
194   // Save an exception without blowing stack contents or other JVM state.
195   // (The extra pointer is stuck with add_req on the map, beyond the JVMS.)
196   static void set_saved_ex_oop(SafePointNode* ex_map, Node* ex_oop);
197 
198   // Recover a saved exception from its map.
199   static Node* saved_ex_oop(SafePointNode* ex_map);
200 
201   // Recover a saved exception from its map, and remove it from the map.
202   static Node* clear_saved_ex_oop(SafePointNode* ex_map);
203 
204 #ifdef ASSERT
205   // Recover a saved exception from its map, and remove it from the map.
206   static bool has_saved_ex_oop(SafePointNode* ex_map);
207 #endif
208 
209   // Push an exception in the canonical position for handlers (stack(0)).
210   void push_ex_oop(Node* ex_oop) {
211     ensure_stack(1);  // ensure room to push the exception
212     set_stack(0, ex_oop);
213     set_sp(1);
214     clean_stack(1);
215   }
216 
217   // Detach and return an exception state.
218   SafePointNode* pop_exception_state() {
219     SafePointNode* ex_map = _exceptions;
220     if (ex_map != NULL) {
221       _exceptions = ex_map-&gt;next_exception();
222       ex_map-&gt;set_next_exception(NULL);
223       debug_only(verify_exception_state(ex_map));
224     }
225     return ex_map;
226   }
227 
228   // Add an exception, using the given JVM state, without commoning.
229   void push_exception_state(SafePointNode* ex_map) {
230     debug_only(verify_exception_state(ex_map));
231     ex_map-&gt;set_next_exception(_exceptions);
232     _exceptions = ex_map;
233   }
234 
235   // Turn the current JVM state into an exception state, appending the ex_oop.
236   SafePointNode* make_exception_state(Node* ex_oop);
237 
238   // Add an exception, using the given JVM state.
239   // Combine all exceptions with a common exception type into a single state.
240   // (This is done via combine_exception_states.)
241   void add_exception_state(SafePointNode* ex_map);
242 
243   // Combine all exceptions of any sort whatever into a single master state.
244   SafePointNode* combine_and_pop_all_exception_states() {
245     if (_exceptions == NULL)  return NULL;
246     SafePointNode* phi_map = pop_exception_state();
247     SafePointNode* ex_map;
248     while ((ex_map = pop_exception_state()) != NULL) {
249       combine_exception_states(ex_map, phi_map);
250     }
251     return phi_map;
252   }
253 
254   // Combine the two exception states, building phis as necessary.
255   // The second argument is updated to include contributions from the first.
256   void combine_exception_states(SafePointNode* ex_map, SafePointNode* phi_map);
257 
258   // Reset the map to the given state.  If there are any half-finished phis
259   // in it (created by combine_exception_states), transform them now.
260   // Returns the exception oop.  (Caller must call push_ex_oop if required.)
261   Node* use_exception_state(SafePointNode* ex_map);
262 
263   // Collect exceptions from a given JVM state into my exception list.
264   void add_exception_states_from(JVMState* jvms);
265 
266   // Collect all raised exceptions into the current JVM state.
267   // Clear the current exception list and map, returns the combined states.
268   JVMState* transfer_exceptions_into_jvms();
269 
270   // Helper to throw a built-in exception.
271   // Range checks take the offending index.
272   // Cast and array store checks take the offending class.
273   // Others do not take the optional argument.
274   // The JVMS must allow the bytecode to be re-executed
275   // via an uncommon trap.
276   void builtin_throw(Deoptimization::DeoptReason reason, Node* arg = NULL);
277 
278   // Helper to check the JavaThread::_should_post_on_exceptions flag
279   // and branch to an uncommon_trap if it is true (with the specified reason and must_throw)
280   void uncommon_trap_if_should_post_on_exceptions(Deoptimization::DeoptReason reason,
281                                                   bool must_throw) ;
282 
283   // Helper Functions for adding debug information
284   void kill_dead_locals();
285 #ifdef ASSERT
286   bool dead_locals_are_killed();
287 #endif
288   // The call may deoptimize.  Supply required JVM state as debug info.
289   // If must_throw is true, the call is guaranteed not to return normally.
290   void add_safepoint_edges(SafePointNode* call,
291                            bool must_throw = false);
292 
293   // How many stack inputs does the current BC consume?
294   // And, how does the stack change after the bytecode?
295   // Returns false if unknown.
296   bool compute_stack_effects(int&amp; inputs, int&amp; depth);
297 
298   // Add a fixed offset to a pointer
299   Node* basic_plus_adr(Node* base, Node* ptr, intptr_t offset) {
300     return basic_plus_adr(base, ptr, MakeConX(offset));
301   }
302   Node* basic_plus_adr(Node* base, intptr_t offset) {
303     return basic_plus_adr(base, base, MakeConX(offset));
304   }
305   // Add a variable offset to a pointer
306   Node* basic_plus_adr(Node* base, Node* offset) {
307     return basic_plus_adr(base, base, offset);
308   }
309   Node* basic_plus_adr(Node* base, Node* ptr, Node* offset);
310 
311 
312   // Some convenient shortcuts for common nodes
313   Node* IfTrue(IfNode* iff)                   { return _gvn.transform(new IfTrueNode(iff));      }
314   Node* IfFalse(IfNode* iff)                  { return _gvn.transform(new IfFalseNode(iff));     }
315 
316   Node* AddI(Node* l, Node* r)                { return _gvn.transform(new AddINode(l, r));       }
317   Node* SubI(Node* l, Node* r)                { return _gvn.transform(new SubINode(l, r));       }
318   Node* MulI(Node* l, Node* r)                { return _gvn.transform(new MulINode(l, r));       }
319   Node* DivI(Node* ctl, Node* l, Node* r)     { return _gvn.transform(new DivINode(ctl, l, r));  }
320 
321   Node* AndI(Node* l, Node* r)                { return _gvn.transform(new AndINode(l, r));       }
322   Node* OrI(Node* l, Node* r)                 { return _gvn.transform(new OrINode(l, r));        }
323   Node* XorI(Node* l, Node* r)                { return _gvn.transform(new XorINode(l, r));       }
324 
325   Node* MaxI(Node* l, Node* r)                { return _gvn.transform(new MaxINode(l, r));       }
326   Node* MinI(Node* l, Node* r)                { return _gvn.transform(new MinINode(l, r));       }
327 
328   Node* LShiftI(Node* l, Node* r)             { return _gvn.transform(new LShiftINode(l, r));    }
329   Node* RShiftI(Node* l, Node* r)             { return _gvn.transform(new RShiftINode(l, r));    }
330   Node* URShiftI(Node* l, Node* r)            { return _gvn.transform(new URShiftINode(l, r));   }
331 
332   Node* CmpI(Node* l, Node* r)                { return _gvn.transform(new CmpINode(l, r));       }
333   Node* CmpL(Node* l, Node* r)                { return _gvn.transform(new CmpLNode(l, r));       }
334   Node* CmpP(Node* l, Node* r)                { return _gvn.transform(new CmpPNode(l, r));       }
335   Node* Bool(Node* cmp, BoolTest::mask relop) { return _gvn.transform(new BoolNode(cmp, relop)); }
336 
337   Node* AddP(Node* b, Node* a, Node* o)       { return _gvn.transform(new AddPNode(b, a, o));    }
338 
339   // Convert between int and long, and size_t.
340   // (See macros ConvI2X, etc., in type.hpp for ConvI2X, etc.)
341   Node* ConvI2L(Node* offset);
342   Node* ConvI2UL(Node* offset);
343   Node* ConvL2I(Node* offset);
344   // Find out the klass of an object.
345   Node* load_object_klass(Node* object, bool clear_prop_bits = true);
346   // Find out the length of an array.
347   Node* load_array_length(Node* array);
348 
349 
350   // Helper function to do a NULL pointer check or ZERO check based on type.
351   // Throw an exception if a given value is null.
352   // Return the value cast to not-null.
353   // Be clever about equivalent dominating null checks.
354   Node* null_check_common(Node* value, BasicType type,
355                           bool assert_null = false,
356                           Node* *null_control = NULL,
357                           bool speculative = false);
358   Node* null_check(Node* value, BasicType type = T_OBJECT) {
359     return null_check_common(value, type, false, NULL, !_gvn.type(value)-&gt;speculative_maybe_null());
360   }
361   Node* null_check_receiver() {
362     assert(argument(0)-&gt;bottom_type()-&gt;isa_ptr(), &quot;must be&quot;);
363     return null_check(argument(0));
364   }
365   Node* zero_check_int(Node* value) {
366     assert(value-&gt;bottom_type()-&gt;basic_type() == T_INT,
367            &quot;wrong type: %s&quot;, type2name(value-&gt;bottom_type()-&gt;basic_type()));
368     return null_check_common(value, T_INT);
369   }
370   Node* zero_check_long(Node* value) {
371     assert(value-&gt;bottom_type()-&gt;basic_type() == T_LONG,
372            &quot;wrong type: %s&quot;, type2name(value-&gt;bottom_type()-&gt;basic_type()));
373     return null_check_common(value, T_LONG);
374   }
375   // Throw an uncommon trap if a given value is __not__ null.
376   // Return the value cast to null, and be clever about dominating checks.
377   Node* null_assert(Node* value, BasicType type = T_OBJECT) {
378     return null_check_common(value, type, true, NULL, _gvn.type(value)-&gt;speculative_always_null());
379   }
380 
381   Node* null2default(Node* value, ciValueKlass* vk = NULL);
382 
383   // Check if value is null and abort if it is
384   Node* must_be_not_null(Node* value, bool do_replace_in_map);
385 
386   // Null check oop.  Return null-path control into (*null_control).
387   // Return a cast-not-null node which depends on the not-null control.
388   // If never_see_null, use an uncommon trap (*null_control sees a top).
389   // The cast is not valid along the null path; keep a copy of the original.
390   // If safe_for_replace, then we can replace the value with the cast
391   // in the parsing map (the cast is guaranteed to dominate the map)
392   Node* null_check_oop(Node* value, Node* *null_control,
393                        bool never_see_null = false,
394                        bool safe_for_replace = false,
395                        bool speculative = false);
396 
397   // Check the null_seen bit.
398   bool seems_never_null(Node* obj, ciProfileData* data, bool&amp; speculating);
399 
400   void guard_klass_being_initialized(Node* klass);
401   void guard_init_thread(Node* klass);
402 
403   void clinit_barrier(ciInstanceKlass* ik, ciMethod* context);
404 
405   // Check for unique class for receiver at call
406   ciKlass* profile_has_unique_klass() {
407     ciCallProfile profile = method()-&gt;call_profile_at_bci(bci());
408     if (profile.count() &gt;= 0 &amp;&amp;         // no cast failures here
409         profile.has_receiver(0) &amp;&amp;
410         profile.morphism() == 1) {
411       return profile.receiver(0);
412     }
413     return NULL;
414   }
415 
416   // record type from profiling with the type system
417   Node* record_profile_for_speculation(Node* n, ciKlass* exact_kls, ProfilePtrKind ptr_kind);
418   void record_profiled_arguments_for_speculation(ciMethod* dest_method, Bytecodes::Code bc);
419   void record_profiled_parameters_for_speculation();
420   void record_profiled_return_for_speculation();
421   Node* record_profiled_receiver_for_speculation(Node* n);
422 
423   // Use the type profile to narrow an object type.
424   Node* maybe_cast_profiled_receiver(Node* not_null_obj,
425                                      ciKlass* require_klass,
426                                      ciKlass* spec,
427                                      bool safe_for_replace);
428 
429   // Cast obj to type and emit guard unless we had too many traps here already
430   Node* maybe_cast_profiled_obj(Node* obj,
431                                 ciKlass* type,
432                                 bool not_null = false);
433 
434   // Cast obj to not-null on this path
435   Node* cast_not_null(Node* obj, bool do_replace_in_map = true);
436   // Replace all occurrences of one node by another.
437   void replace_in_map(Node* old, Node* neww);
438 
439   void  push(Node* n)     { map_not_null();        _map-&gt;set_stack(_map-&gt;_jvms,   _sp++        , n); }
440   Node* pop()             { map_not_null(); return _map-&gt;stack(    _map-&gt;_jvms, --_sp             ); }
441   Node* peek(int off = 0) { map_not_null(); return _map-&gt;stack(    _map-&gt;_jvms,   _sp - off - 1   ); }
442 
443   void push_pair(Node* ldval) {
444     push(ldval);
445     push(top());  // the halfword is merely a placeholder
446   }
447   void push_pair_local(int i) {
448     // longs are stored in locals in &quot;push&quot; order
449     push(  local(i+0) );  // the real value
450     assert(local(i+1) == top(), &quot;&quot;);
451     push(top());  // halfword placeholder
452   }
453   Node* pop_pair() {
454     // the second half is pushed last &amp; popped first; it contains exactly nothing
455     Node* halfword = pop();
456     assert(halfword == top(), &quot;&quot;);
457     // the long bits are pushed first &amp; popped last:
458     return pop();
459   }
460   void set_pair_local(int i, Node* lval) {
461     // longs are stored in locals as a value/half pair (like doubles)
462     set_local(i+0, lval);
463     set_local(i+1, top());
464   }
465 
466   // Push the node, which may be zero, one, or two words.
467   void push_node(BasicType n_type, Node* n) {
468     int n_size = type2size[n_type];
469     if      (n_size == 1)  push(      n );  // T_INT, ...
470     else if (n_size == 2)  push_pair( n );  // T_DOUBLE, T_LONG
471     else                   { assert(n_size == 0, &quot;must be T_VOID&quot;); }
472   }
473 
474   Node* pop_node(BasicType n_type) {
475     int n_size = type2size[n_type];
476     if      (n_size == 1)  return pop();
477     else if (n_size == 2)  return pop_pair();
478     else                   return NULL;
479   }
480 
481   Node* control()               const { return map_not_null()-&gt;control(); }
482   Node* i_o()                   const { return map_not_null()-&gt;i_o(); }
483   Node* returnadr()             const { return map_not_null()-&gt;returnadr(); }
484   Node* frameptr()              const { return map_not_null()-&gt;frameptr(); }
485   Node* local(uint idx)         const { map_not_null(); return _map-&gt;local(      _map-&gt;_jvms, idx); }
486   Node* stack(uint idx)         const { map_not_null(); return _map-&gt;stack(      _map-&gt;_jvms, idx); }
487   Node* argument(uint idx)      const { map_not_null(); return _map-&gt;argument(   _map-&gt;_jvms, idx); }
488   Node* monitor_box(uint idx)   const { map_not_null(); return _map-&gt;monitor_box(_map-&gt;_jvms, idx); }
489   Node* monitor_obj(uint idx)   const { map_not_null(); return _map-&gt;monitor_obj(_map-&gt;_jvms, idx); }
490 
491   void set_control  (Node* c)         { map_not_null()-&gt;set_control(c); }
492   void set_i_o      (Node* c)         { map_not_null()-&gt;set_i_o(c); }
493   void set_local(uint idx, Node* c)   { map_not_null(); _map-&gt;set_local(   _map-&gt;_jvms, idx, c); }
494   void set_stack(uint idx, Node* c)   { map_not_null(); _map-&gt;set_stack(   _map-&gt;_jvms, idx, c); }
495   void set_argument(uint idx, Node* c){ map_not_null(); _map-&gt;set_argument(_map-&gt;_jvms, idx, c); }
496   void ensure_stack(uint stk_size)    { map_not_null(); _map-&gt;ensure_stack(_map-&gt;_jvms, stk_size); }
497 
498   // Access unaliased memory
499   Node* memory(uint alias_idx);
500   Node* memory(const TypePtr *tp) { return memory(C-&gt;get_alias_index(tp)); }
501   Node* memory(Node* adr) { return memory(_gvn.type(adr)-&gt;is_ptr()); }
502 
503   // Access immutable memory
504   Node* immutable_memory() { return C-&gt;immutable_memory(); }
505 
506   // Set unaliased memory
507   void set_memory(Node* c, uint alias_idx) { merged_memory()-&gt;set_memory_at(alias_idx, c); }
508   void set_memory(Node* c, const TypePtr *tp) { set_memory(c,C-&gt;get_alias_index(tp)); }
509   void set_memory(Node* c, Node* adr) { set_memory(c,_gvn.type(adr)-&gt;is_ptr()); }
510 
511   // Get the entire memory state (probably a MergeMemNode), and reset it
512   // (The resetting prevents somebody from using the dangling Node pointer.)
513   Node* reset_memory();
514 
515   // Get the entire memory state, asserted to be a MergeMemNode.
516   MergeMemNode* merged_memory() {
517     Node* mem = map_not_null()-&gt;memory();
518     assert(mem-&gt;is_MergeMem(), &quot;parse memory is always pre-split&quot;);
519     return mem-&gt;as_MergeMem();
520   }
521 
522   // Set the entire memory state; produce a new MergeMemNode.
523   void set_all_memory(Node* newmem);
524 
525   // Create a memory projection from the call, then set_all_memory.
526   void set_all_memory_call(Node* call, bool separate_io_proj = false);
527 
528   // Create a LoadNode, reading from the parser&#39;s memory state.
529   // (Note:  require_atomic_access is useful only with T_LONG.)
530   //
531   // We choose the unordered semantics by default because we have
532   // adapted the `do_put_xxx&#39; and `do_get_xxx&#39; procedures for the case
533   // of volatile fields.
534   Node* make_load(Node* ctl, Node* adr, const Type* t, BasicType bt,
535                   MemNode::MemOrd mo, LoadNode::ControlDependency control_dependency = LoadNode::DependsOnlyOnTest,
536                   bool require_atomic_access = false, bool unaligned = false,
537                   bool mismatched = false, bool unsafe = false, uint8_t barrier_data = 0) {
538     // This version computes alias_index from bottom_type
539     return make_load(ctl, adr, t, bt, adr-&gt;bottom_type()-&gt;is_ptr(),
540                      mo, control_dependency, require_atomic_access,
541                      unaligned, mismatched, unsafe, barrier_data);
542   }
543   Node* make_load(Node* ctl, Node* adr, const Type* t, BasicType bt, const TypePtr* adr_type,
544                   MemNode::MemOrd mo, LoadNode::ControlDependency control_dependency = LoadNode::DependsOnlyOnTest,
545                   bool require_atomic_access = false, bool unaligned = false,
546                   bool mismatched = false, bool unsafe = false, uint8_t barrier_data = 0) {
547     // This version computes alias_index from an address type
548     assert(adr_type != NULL, &quot;use other make_load factory&quot;);
549     return make_load(ctl, adr, t, bt, C-&gt;get_alias_index(adr_type),
550                      mo, control_dependency, require_atomic_access,
551                      unaligned, mismatched, unsafe, barrier_data);
552   }
553   // This is the base version which is given an alias index.
554   Node* make_load(Node* ctl, Node* adr, const Type* t, BasicType bt, int adr_idx,
555                   MemNode::MemOrd mo, LoadNode::ControlDependency control_dependency = LoadNode::DependsOnlyOnTest,
556                   bool require_atomic_access = false, bool unaligned = false,
557                   bool mismatched = false, bool unsafe = false, uint8_t barrier_data = 0);
558 
559   // Create &amp; transform a StoreNode and store the effect into the
560   // parser&#39;s memory state.
561   //
562   // We must ensure that stores of object references will be visible
563   // only after the object&#39;s initialization. So the clients of this
564   // procedure must indicate that the store requires `release&#39;
565   // semantics, if the stored value is an object reference that might
566   // point to a new object and may become externally visible.
567   Node* store_to_memory(Node* ctl, Node* adr, Node* val, BasicType bt,
568                         const TypePtr* adr_type,
569                         MemNode::MemOrd mo,
570                         bool require_atomic_access = false,
571                         bool unaligned = false,
572                         bool mismatched = false,
573                         bool unsafe = false) {
574     // This version computes alias_index from an address type
575     assert(adr_type != NULL, &quot;use other store_to_memory factory&quot;);
576     return store_to_memory(ctl, adr, val, bt,
577                            C-&gt;get_alias_index(adr_type),
578                            mo, require_atomic_access,
579                            unaligned, mismatched, unsafe);
580   }
581   // This is the base version which is given alias index
582   // Return the new StoreXNode
583   Node* store_to_memory(Node* ctl, Node* adr, Node* val, BasicType bt,
584                         int adr_idx,
585                         MemNode::MemOrd,
586                         bool require_atomic_access = false,
587                         bool unaligned = false,
588                         bool mismatched = false,
589                         bool unsafe = false);
590 
591   // Perform decorated accesses
592 
593   Node* access_store_at(Node* obj,   // containing obj
594                         Node* adr,   // actual adress to store val at
595                         const TypePtr* adr_type,
596                         Node* val,
597                         const Type* val_type,
598                         BasicType bt,
599                         DecoratorSet decorators,
600                         bool safe_for_replace = true);
601 
602   Node* access_load_at(Node* obj,   // containing obj
603                        Node* adr,   // actual adress to load val at
604                        const TypePtr* adr_type,
605                        const Type* val_type,
606                        BasicType bt,
607                        DecoratorSet decorators,
608                        Node* ctl = NULL);
609 
610   Node* access_load(Node* adr,   // actual adress to load val at
611                     const Type* val_type,
612                     BasicType bt,
613                     DecoratorSet decorators);
614 
615   Node* access_atomic_cmpxchg_val_at(Node* obj,
616                                      Node* adr,
617                                      const TypePtr* adr_type,
618                                      int alias_idx,
619                                      Node* expected_val,
620                                      Node* new_val,
621                                      const Type* value_type,
622                                      BasicType bt,
623                                      DecoratorSet decorators);
624 
625   Node* access_atomic_cmpxchg_bool_at(Node* obj,
626                                       Node* adr,
627                                       const TypePtr* adr_type,
628                                       int alias_idx,
629                                       Node* expected_val,
630                                       Node* new_val,
631                                       const Type* value_type,
632                                       BasicType bt,
633                                       DecoratorSet decorators);
634 
635   Node* access_atomic_xchg_at(Node* obj,
636                               Node* adr,
637                               const TypePtr* adr_type,
638                               int alias_idx,
639                               Node* new_val,
640                               const Type* value_type,
641                               BasicType bt,
642                               DecoratorSet decorators);
643 
644   Node* access_atomic_add_at(Node* obj,
645                              Node* adr,
646                              const TypePtr* adr_type,
647                              int alias_idx,
648                              Node* new_val,
649                              const Type* value_type,
650                              BasicType bt,
651                              DecoratorSet decorators);
652 
653   void access_clone(Node* src_base, Node* dst_base, Node* countx, bool is_array);
654 
655   // Return addressing for an array element.
656   Node* array_element_address(Node* ary, Node* idx, BasicType elembt,
657                               // Optional constraint on the array size:
658                               const TypeInt* sizetype = NULL,
659                               // Optional control dependency (for example, on range check)
660                               Node* ctrl = NULL);
661 
662   // Return a load of array element at idx.
663   Node* load_array_element(Node* ctl, Node* ary, Node* idx, const TypeAryPtr* arytype);
664 
665   //---------------- Dtrace support --------------------
666   void make_dtrace_method_entry_exit(ciMethod* method, bool is_entry);
667   void make_dtrace_method_entry(ciMethod* method) {
668     make_dtrace_method_entry_exit(method, true);
669   }
670   void make_dtrace_method_exit(ciMethod* method) {
671     make_dtrace_method_entry_exit(method, false);
672   }
673 
674   //--------------- stub generation -------------------
675  public:
676   void gen_stub(address C_function,
677                 const char *name,
678                 int is_fancy_jump,
679                 bool pass_tls,
680                 bool return_pc);
681 
682   //---------- help for generating calls --------------
683 
684   // Do a null check on the receiver as it would happen before the call to
685   // callee (with all arguments still on the stack).
686   Node* null_check_receiver_before_call(ciMethod* callee, bool replace_value = true) {
687     assert(!callee-&gt;is_static(), &quot;must be a virtual method&quot;);
688     if (argument(0)-&gt;is_ValueType()) {
689       return argument(0);
690     }
691     // Callsite signature can be different from actual method being called (i.e _linkTo* sites).
692     // Use callsite signature always.
693     ciMethod* declared_method = method()-&gt;get_method_at_bci(bci());
694     const int nargs = declared_method-&gt;arg_size();
695     inc_sp(nargs);
696     Node* n = null_check_receiver();
697     dec_sp(nargs);
698     // Scalarize value type receiver
699     const Type* recv_type = gvn().type(n);
700     if (recv_type-&gt;is_valuetypeptr() &amp;&amp; recv_type-&gt;value_klass()-&gt;is_scalarizable()) {
701       assert(!recv_type-&gt;maybe_null(), &quot;should never be null&quot;);
702       ValueTypeNode* vt = ValueTypeNode::make_from_oop(this, n, recv_type-&gt;value_klass());
703       set_argument(0, vt);
704       if (replace_value &amp;&amp; !Compile::current()-&gt;inlining_incrementally()) {
705         // Only replace in map if we are not incrementally inlining because we
706         // share a map with the caller which might expect the value type as oop.
707         replace_in_map(n, vt);
708       }
709       n = vt;
710     }
711     return n;
712   }
713 
714   // Fill in argument edges for the call from argument(0), argument(1), ...
715   // (The next step is to call set_edges_for_java_call.)
716   void  set_arguments_for_java_call(CallJavaNode* call, bool is_late_inline = false);
717 
718   // Fill in non-argument edges for the call.
719   // Transform the call, and update the basics: control, i_o, memory.
720   // (The next step is usually to call set_results_for_java_call.)
721   void set_edges_for_java_call(CallJavaNode* call,
722                                bool must_throw = false, bool separate_io_proj = false);
723 
724   // Finish up a java call that was started by set_edges_for_java_call.
725   // Call add_exception on any throw arising from the call.
726   // Return the call result (transformed).
727   Node* set_results_for_java_call(CallJavaNode* call, bool separate_io_proj = false, bool deoptimize = false);
728 
729   // Similar to set_edges_for_java_call, but simplified for runtime calls.
730   void  set_predefined_output_for_runtime_call(Node* call) {
731     set_predefined_output_for_runtime_call(call, NULL, NULL);
732   }
733   void  set_predefined_output_for_runtime_call(Node* call,
734                                                Node* keep_mem,
735                                                const TypePtr* hook_mem);
736   Node* set_predefined_input_for_runtime_call(SafePointNode* call, Node* narrow_mem = NULL);
737 
738   // Replace the call with the current state of the kit.  Requires
739   // that the call was generated with separate io_projs so that
740   // exceptional control flow can be handled properly.
741   void replace_call(CallNode* call, Node* result, bool do_replaced_nodes = false);
742 
743   // helper functions for statistics
744   void increment_counter(address counter_addr);   // increment a debug counter
745   void increment_counter(Node*   counter_addr);   // increment a debug counter
746 
747   // Bail out to the interpreter right now
748   // The optional klass is the one causing the trap.
749   // The optional reason is debug information written to the compile log.
750   // Optional must_throw is the same as with add_safepoint_edges.
751   void uncommon_trap(int trap_request,
752                      ciKlass* klass = NULL, const char* reason_string = NULL,
753                      bool must_throw = false, bool keep_exact_action = false);
754 
755   // Shorthand, to avoid saying &quot;Deoptimization::&quot; so many times.
756   void uncommon_trap(Deoptimization::DeoptReason reason,
757                      Deoptimization::DeoptAction action,
758                      ciKlass* klass = NULL, const char* reason_string = NULL,
759                      bool must_throw = false, bool keep_exact_action = false) {
760     uncommon_trap(Deoptimization::make_trap_request(reason, action),
761                   klass, reason_string, must_throw, keep_exact_action);
762   }
763 
764   // Bail out to the interpreter and keep exact action (avoid switching to Action_none).
765   void uncommon_trap_exact(Deoptimization::DeoptReason reason,
766                            Deoptimization::DeoptAction action,
767                            ciKlass* klass = NULL, const char* reason_string = NULL,
768                            bool must_throw = false) {
769     uncommon_trap(Deoptimization::make_trap_request(reason, action),
770                   klass, reason_string, must_throw, /*keep_exact_action=*/true);
771   }
772 
773   // SP when bytecode needs to be reexecuted.
774   virtual int reexecute_sp() { return sp(); }
775 
776   // Report if there were too many traps at the current method and bci.
777   // Report if a trap was recorded, and/or PerMethodTrapLimit was exceeded.
778   // If there is no MDO at all, report no trap unless told to assume it.
779   bool too_many_traps(Deoptimization::DeoptReason reason) {
780     return C-&gt;too_many_traps(method(), bci(), reason);
781   }
782 
783   // Report if there were too many recompiles at the current method and bci.
784   bool too_many_recompiles(Deoptimization::DeoptReason reason) {
785     return C-&gt;too_many_recompiles(method(), bci(), reason);
786   }
787 
788   bool too_many_traps_or_recompiles(Deoptimization::DeoptReason reason) {
789       return C-&gt;too_many_traps_or_recompiles(method(), bci(), reason);
790   }
791 
792   // Returns the object (if any) which was created the moment before.
793   Node* just_allocated_object(Node* current_control);
794 
795   // Sync Ideal and Graph kits.
796   void sync_kit(IdealKit&amp; ideal);
797   void final_sync(IdealKit&amp; ideal);
798 
799   public:
800   // Helper function to round double arguments before a call
801   void round_double_arguments(ciMethod* dest_method);
802   void round_double_result(ciMethod* dest_method);
803 
804   // rounding for strict float precision conformance
805   Node* precision_rounding(Node* n);
806 
807   // rounding for strict double precision conformance
808   Node* dprecision_rounding(Node* n);
809 
810   // rounding for non-strict double stores
811   Node* dstore_rounding(Node* n);
812 
813   // Helper functions for fast/slow path codes
814   Node* opt_iff(Node* region, Node* iff);
815   Node* make_runtime_call(int flags,
816                           const TypeFunc* call_type, address call_addr,
817                           const char* call_name,
818                           const TypePtr* adr_type, // NULL if no memory effects
819                           Node* parm0 = NULL, Node* parm1 = NULL,
820                           Node* parm2 = NULL, Node* parm3 = NULL,
821                           Node* parm4 = NULL, Node* parm5 = NULL,
822                           Node* parm6 = NULL, Node* parm7 = NULL);
823   enum {  // flag values for make_runtime_call
824     RC_NO_FP = 1,               // CallLeafNoFPNode
825     RC_NO_IO = 2,               // do not hook IO edges
826     RC_NO_LEAF = 4,             // CallStaticJavaNode
827     RC_MUST_THROW = 8,          // flag passed to add_safepoint_edges
828     RC_NARROW_MEM = 16,         // input memory is same as output
829     RC_UNCOMMON = 32,           // freq. expected to be like uncommon trap
830     RC_LEAF = 0                 // null value:  no flags set
831   };
832 
833   // merge in all memory slices from new_mem, along the given path
834   void merge_memory(Node* new_mem, Node* region, int new_path);
835   void make_slow_call_ex(Node* call, ciInstanceKlass* ex_klass, bool separate_io_proj, bool deoptimize = false);
836 
837   // Helper functions to build synchronizations
838   int next_monitor();
839   Node* insert_mem_bar(int opcode, Node* precedent = NULL);
840   Node* insert_mem_bar_volatile(int opcode, int alias_idx, Node* precedent = NULL);
841   // Optional &#39;precedent&#39; is appended as an extra edge, to force ordering.
842   FastLockNode* shared_lock(Node* obj);
843   void shared_unlock(Node* box, Node* obj);
844 
845   // helper functions for the fast path/slow path idioms
846   Node* fast_and_slow(Node* in, const Type *result_type, Node* null_result, IfNode* fast_test, Node* fast_result, address slow_call, const TypeFunc *slow_call_type, Node* slow_arg, Klass* ex_klass, Node* slow_result);
847 
848   // Generate an instance-of idiom.  Used by both the instance-of bytecode
849   // and the reflective instance-of call.
850   Node* gen_instanceof(Node *subobj, Node* superkls, bool safe_for_replace = false);
851 
852   // Generate a check-cast idiom.  Used by both the check-cast bytecode
853   // and the array-store bytecode
854   Node* gen_checkcast(Node *subobj, Node* superkls, Node* *failure_control = NULL, bool never_null = false);
855 
856   Node* is_always_locked(Node* obj);
857   Node* is_value_mirror(Node* mirror);
858   Node* gen_null_free_array_check(Node* ary);
859   Node* gen_flattened_array_test(Node* ary);
860   Node* gen_value_array_null_guard(Node* ary, Node* val, int nargs, bool safe_for_replace = false);
861   Node* load_lh_array_tag(Node* kls);
862   Node* gen_lh_array_test(Node* kls, unsigned int lh_value);
863 
864   Node* gen_subtype_check(Node* obj, Node* superklass);
865 
866   // Exact type check used for predicted calls and casts.
867   // Rewrites (*casted_receiver) to be casted to the stronger type.
868   // (Caller is responsible for doing replace_in_map.)
869   Node* type_check_receiver(Node* receiver, ciKlass* klass, float prob,
870                             Node* *casted_receiver);
871   Node* type_check(Node* recv_klass, const TypeKlassPtr* tklass, float prob);
872 
873   // Inexact type check used for predicted calls.
874   Node* subtype_check_receiver(Node* receiver, ciKlass* klass,
875                                Node** casted_receiver);
876 
877   // implementation of object creation
878   Node* set_output_for_allocation(AllocateNode* alloc,
879                                   const TypeOopPtr* oop_type,
880                                   bool deoptimize_on_exception=false);
881   Node* get_layout_helper(Node* klass_node, jint&amp; constant_value);
882   Node* new_instance(Node* klass_node,
883                      Node* slow_test = NULL,
884                      Node* *return_size_val = NULL,
885                      bool deoptimize_on_exception = false,
886                      ValueTypeBaseNode* value_node = NULL);
887   Node* new_array(Node* klass_node, Node* count_val, int nargs,
888                   Node* *return_size_val = NULL,
889                   bool deoptimize_on_exception = false,
890                   Node* elem_mirror = NULL);
891 
892   // java.lang.String helpers
893   Node* load_String_length(Node* str, bool set_ctrl);
894   Node* load_String_value(Node* str, bool set_ctrl);
895   Node* load_String_coder(Node* str, bool set_ctrl);
896   void store_String_value(Node* str, Node* value);
897   void store_String_coder(Node* str, Node* value);
898   Node* capture_memory(const TypePtr* src_type, const TypePtr* dst_type);
899   Node* compress_string(Node* src, const TypeAryPtr* src_type, Node* dst, Node* count);
900   void inflate_string(Node* src, Node* dst, const TypeAryPtr* dst_type, Node* count);
901   void inflate_string_slow(Node* src, Node* dst, Node* start, Node* count);
902 
903   // Handy for making control flow
904   IfNode* create_and_map_if(Node* ctrl, Node* tst, float prob, float cnt) {
905     IfNode* iff = new IfNode(ctrl, tst, prob, cnt);// New IfNode&#39;s
906     _gvn.set_type(iff, iff-&gt;Value(&amp;_gvn)); // Value may be known at parse-time
907     // Place &#39;if&#39; on worklist if it will be in graph
908     if (!tst-&gt;is_Con())  record_for_igvn(iff);     // Range-check and Null-check removal is later
909     return iff;
910   }
911 
912   IfNode* create_and_xform_if(Node* ctrl, Node* tst, float prob, float cnt) {
913     IfNode* iff = new IfNode(ctrl, tst, prob, cnt);// New IfNode&#39;s
914     _gvn.transform(iff);                           // Value may be known at parse-time
915     // Place &#39;if&#39; on worklist if it will be in graph
916     if (!tst-&gt;is_Con())  record_for_igvn(iff);     // Range-check and Null-check removal is later
917     return iff;
918   }
919 
920   void add_empty_predicates(int nargs = 0);
921   void add_empty_predicate_impl(Deoptimization::DeoptReason reason, int nargs);
922 
923   Node* make_constant_from_field(ciField* field, Node* obj);
924 
925   Node* load_mirror_from_klass(Node* klass);
926 };
927 
928 // Helper class to support building of control flow branches. Upon
929 // creation the map and sp at bci are cloned and restored upon de-
930 // struction. Typical use:
931 //
932 // { PreserveJVMState pjvms(this);
933 //   // code of new branch
934 // }
935 // // here the JVM state at bci is established
936 
937 class PreserveJVMState: public StackObj {
938  protected:
939   GraphKit*      _kit;
940 #ifdef ASSERT
941   int            _block;  // PO of current block, if a Parse
942   int            _bci;
943 #endif
944   SafePointNode* _map;
945   uint           _sp;
946 
947  public:
948   PreserveJVMState(GraphKit* kit, bool clone_map = true);
949   ~PreserveJVMState();
950 };
951 
952 // Helper class to build cutouts of the form if (p) ; else {x...}.
953 // The code {x...} must not fall through.
954 // The kit&#39;s main flow of control is set to the &quot;then&quot; continuation of if(p).
955 class BuildCutout: public PreserveJVMState {
956  public:
957   BuildCutout(GraphKit* kit, Node* p, float prob, float cnt = COUNT_UNKNOWN);
958   ~BuildCutout();
959 };
960 
961 // Helper class to preserve the original _reexecute bit and _sp and restore
962 // them back
963 class PreserveReexecuteState: public StackObj {
964  protected:
965   GraphKit*                 _kit;
966   uint                      _sp;
967   JVMState::ReexecuteState  _reexecute;
968 
969  public:
970   PreserveReexecuteState(GraphKit* kit);
971   ~PreserveReexecuteState();
972 };
973 
974 #endif // SHARE_OPTO_GRAPHKIT_HPP
    </pre>
  </body>
</html>