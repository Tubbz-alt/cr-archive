<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff test/hotspot/jtreg/runtime/valhalla/valuetypes/TestJNIArrays.java</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
  </head>
<body>
<center>&lt; prev <a href="../../../../../../index.html" target="_top">index</a> <a href="ValueTypeArray.java.cdiff.html" target="_top">next &gt;</a></center>    <h2>test/hotspot/jtreg/runtime/valhalla/valuetypes/TestJNIArrays.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 1,7 ***</span>
  /*
<span class="line-modified">!  * Copyright (c) 2019, 2019, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
<span class="line-new-header">--- 1,7 ---</span>
  /*
<span class="line-modified">!  * Copyright (c) 2019, 2020, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
</pre>
<hr />
<pre>
<span class="line-old-header">*** 37,832 ***</span>
   * @summary Test flattened arrays accesses through JNI
   * @modules java.base/jdk.internal.misc java.base/jdk.internal.vm.jni
   * @library /testlibrary /test/lib
   * @requires (os.simpleArch == &quot;x64&quot;)
   * @requires (os.family == &quot;linux&quot; | os.family == &quot;mac&quot;)
<span class="line-modified">!  * @compile -XDallowGenericsOverValues -XDallowWithFieldOperator TestJNIArrays.java</span>
   * @run main/othervm/native/timeout=3000 -XX:ValueArrayElemMaxFlatSize=128 -XX:+PrintFlattenableLayouts -XX:+UseCompressedOops TestJNIArrays
   * @run main/othervm/native/timeout=3000 -XX:ValueArrayElemMaxFlatSize=128 -XX:+PrintFlattenableLayouts -XX:-UseCompressedOops TestJNIArrays
   */
<span class="line-removed">- </span>
  public class TestJNIArrays {
  
      static final Unsafe U = Unsafe.getUnsafe();
<span class="line-modified">!     </span>
      public static final int ARRAY_SIZE = 1024;
      static long seed;
      static Random random;
  
      static {
<span class="line-modified">! 	seed = System.nanoTime();</span>
<span class="line-modified">! 	System.out.println(&quot;Seed = &quot; + seed); </span>
<span class="line-modified">! 	random = new Random(seed);</span>
      }
  
      static {
          System.loadLibrary(&quot;TestJNIArrays&quot;);
      }
  
      static inline class IntInt {
<span class="line-modified">! 	int i0;</span>
<span class="line-modified">! 	int i1;</span>
  
<span class="line-modified">! 	public IntInt(int i0, int i1) {</span>
<span class="line-modified">! 	    this.i0 = i0;</span>
<span class="line-modified">! 	    this.i1 = i1;</span>
<span class="line-modified">! 	}</span>
      }
  
<span class="line-modified">!     static class IntIntComparator implements Comparator&lt;IntInt&gt; {</span>
<span class="line-modified">! 	public int compare(IntInt a, IntInt b) {</span>
<span class="line-modified">! 	    if (a.i0 &lt; b.i0) return -1;</span>
<span class="line-modified">! 	    if (a.i0 &gt; b.i0) return 1;</span>
<span class="line-modified">! 	    if (a.i1 &lt; b.i1) return -1;</span>
<span class="line-modified">! 	    if (a.i1 &gt; b.i1) return 1;</span>
<span class="line-modified">! 	    return 0;</span>
<span class="line-modified">! 	}</span>
      }
  
      static inline class Containee {
<span class="line-modified">! 	float f;</span>
<span class="line-modified">! 	short s;</span>
  
<span class="line-modified">! 	Containee(float f, short s) {</span>
<span class="line-modified">! 	    this.f = f;</span>
<span class="line-modified">! 	    this.s = s;</span>
<span class="line-modified">! 	}</span>
      }
<span class="line-removed">-     </span>
<span class="line-removed">-     static inline class Container {</span>
<span class="line-removed">- 	double d;</span>
<span class="line-removed">- 	Containee c;</span>
<span class="line-removed">- 	byte b;</span>
  
<span class="line-modified">! 	Container(double d, Containee c, byte b) {</span>
<span class="line-modified">! 	    this.d = d ;</span>
<span class="line-modified">! 	    this.c = c;</span>
<span class="line-modified">! 	    this.b = b;</span>
<span class="line-modified">! 	}</span>
  
<span class="line-modified">! 	Container setc(Containee c) {</span>
              Container res = __WithField(this.c, c);
              return res;
          }
  
      }
  
      static inline class LongLongLongLong {
<span class="line-modified">! 	long l0, l1, l2, l3;</span>
<span class="line-modified">! </span>
<span class="line-modified">! 	public LongLongLongLong(long l0, long l1, long l2, long l3) {</span>
<span class="line-modified">! 	    this.l0 = l0;</span>
<span class="line-modified">! 	    this.l1 = l1;</span>
<span class="line-modified">! 	    this.l2 = l2;</span>
<span class="line-modified">! 	    this.l3 = l3;</span>
<span class="line-modified">! 	}</span>
      }
  
      static inline class BigValue {
<span class="line-modified">! 	long l0 = 0, l1 = 0,   l2 = 0, l3 = 0, l4 = 0, l5 = 0, l6 = 0, l7 = 0, l8 = 0, l9 = 0;</span>
<span class="line-modified">! 	long l10 = 0, l11 = 0, l12 = 0, l13 = 0, l14 = 0, l15 = 0, l16 = 0, l17 = 0, l18 = 0, l19 = 0;</span>
<span class="line-modified">! 	long l20 = 0, l21 = 0, l22 = 0, l23 = 0, l24 = 0, l25 = 0, l26 = 0, l27 = 0, l28 = 0, l29 = 0;</span>
<span class="line-modified">! 	long l30 = 0, l31 = 0, l32 = 0, l33 = 0, l34 = 0, l35 = 0, l36 = 0, l37 = 0, l38 = 0, l39 = 0;</span>
      }
  
      static inline class ValueWithOops {
<span class="line-modified">! 	String s = &quot;bonjour&quot;;</span>
<span class="line-modified">! 	int i = 0;</span>
<span class="line-modified">! 	Containee c = new Containee(2.3f, (short)4);</span>
<span class="line-modified">! 	BigValue b = new BigValue();</span>
      }
<span class="line-modified">!     </span>
      public static void main(String[] args) {
<span class="line-modified">! 	TestJNIArrays test = new TestJNIArrays();</span>
<span class="line-modified">! 	test.checkGetFlattenedArrayElementSize();</span>
<span class="line-modified">! 	test.checkGetFlattenedArrayElementClass();</span>
<span class="line-modified">! 	test.checkGetFieldOffsetInFlattenedLayout();</span>
<span class="line-modified">! 	test.checkGetFlattenedArrayElements();</span>
<span class="line-modified">! 	test.checkSubElementAPI();</span>
<span class="line-modified">! 	test.checkBehaviors();</span>
<span class="line-modified">! 	// test.mesureInitializationTime(1024 * 1024 * 10 , 1000);</span>
<span class="line-modified">! 	// test.mesureInitializationTime2(1024 * 1024 * 10 , 1000);</span>
<span class="line-modified">! 	// test.mesureUpdateTime2(1024 * 1024 * 10, 1000);</span>
<span class="line-modified">! 	// test.mesureSortingTime(1024 * 1024, 100); // reduced number of iterations because Java sorting is slow (because of generics?)</span>
<span class="line-modified">! 	test.mesureInitializationTime3(1024 * 1024 * 2 , 1000);</span>
      }
  
      void checkSubElementAPI() {
<span class="line-modified">! 	Throwable e = null;</span>
<span class="line-modified">! 	ValueWithOops[] arrayWithOops = new ValueWithOops[100];</span>
<span class="line-modified">! 	ValueWithOops v = new ValueWithOops();</span>
<span class="line-modified">! 	for (int i = 0; i &lt; 100; i++) {</span>
<span class="line-modified">! 	    arrayWithOops[i] = v;</span>
<span class="line-modified">! 	}</span>
<span class="line-modified">! 	SubElementSelector selector1 = createSubElementSelector(arrayWithOops);</span>
<span class="line-modified">! 	SubElementSelector selector2 = getSubElementSelector(selector1, ValueWithOops.class, &quot;s&quot;, &quot;Ljava/lang/String;&quot;);</span>
<span class="line-modified">! 	String s = (String) getObjectSubElement(arrayWithOops, selector2, 1);</span>
<span class="line-modified">! 	System.out.println(&quot;s = &quot; + s);</span>
<span class="line-modified">! 	Asserts.assertEquals(s.equals(&quot;bonjour&quot;), true, &quot;Wrong string, expecting \&quot;bonjour\&quot;, got &quot; + s); </span>
<span class="line-modified">! 	SubElementSelector selector3 = getSubElementSelector(selector1, ValueWithOops.class, &quot;c&quot;, &quot;QTestJNIArrays$Containee;&quot;);</span>
<span class="line-modified">! 	Containee c = (Containee) getObjectSubElement(arrayWithOops, selector3, 2);</span>
<span class="line-modified">! 	Asserts.assertEquals(c.f, 2.3f, &quot;Wrong float value: &quot; + c.f);</span>
<span class="line-modified">! 	Asserts.assertEquals(c.s, (short)4, &quot;Wrong short value &quot; + c.s);</span>
<span class="line-modified">! 	setObjectSubElement(arrayWithOops, selector2, 1, &quot;Hello&quot;);</span>
<span class="line-modified">! 	Asserts.assertEquals(arrayWithOops[1].s.equals(&quot;Hello&quot;), true, &quot;Wrong string, expecting \&quot;Hello\&quot;, got &quot; + s);</span>
<span class="line-modified">! 	Integer myInteger = new Integer(345);</span>
<span class="line-modified">! 	e = null;</span>
<span class="line-modified">! 	try {</span>
<span class="line-modified">! 	    setObjectSubElement(arrayWithOops, selector2, 1, myInteger);</span>
<span class="line-modified">! 	} catch(Throwable t) {</span>
<span class="line-modified">! 	    e = t;</span>
<span class="line-modified">! 	}</span>
<span class="line-modified">! 	Asserts.assertNotNull(e, &quot;An exception should have been thrown&quot;);</span>
<span class="line-modified">! 	Asserts.assertEquals(e.getClass(), java.lang.ArrayStoreException.class, &quot;Wrong exception type&quot;);</span>
<span class="line-modified">! 	c = new Containee(9.8f, (short)-3);</span>
<span class="line-modified">! 	setObjectSubElement(arrayWithOops, selector3, 2, c);</span>
<span class="line-modified">! 	Asserts.assertEquals(c.f, 9.8f, &quot;Wrong float value: &quot; + c.f);</span>
<span class="line-modified">! 	Asserts.assertEquals(c.s, (short)-3, &quot;Wrong short value &quot; + c.s);</span>
<span class="line-modified">! 	e = null;</span>
<span class="line-modified">! 	try {</span>
<span class="line-modified">! 	    setObjectSubElement(arrayWithOops, selector3, 2, null);</span>
<span class="line-modified">! 	} catch(Throwable t) {</span>
<span class="line-modified">! 	    e = t;</span>
<span class="line-modified">! 	}</span>
<span class="line-modified">! 	Asserts.assertNotNull(e, &quot;An exception should have been thrown&quot;);</span>
<span class="line-modified">! 	Asserts.assertEquals(e.getClass(), java.lang.ArrayStoreException.class, &quot;Wrong exception type&quot;);</span>
<span class="line-modified">! 	SubElementSelector selector4 = getSubElementSelector(selector3, TestJNIArrays.Containee.class, &quot;s&quot;, &quot;S&quot;);</span>
<span class="line-modified">! 	short s2 = getShortSubElement(arrayWithOops, selector4, 3);</span>
<span class="line-modified">! 	Asserts.assertEquals(s2, (short)4, &quot;Wrong short value &quot; + s2);</span>
<span class="line-modified">! 	setShortSubElement(arrayWithOops, selector4, 3, (short)7);</span>
<span class="line-modified">! 	Asserts.assertEquals(arrayWithOops[3].c.s, (short)7, &quot;Wrong short value &quot; + arrayWithOops[3].c.s);</span>
<span class="line-modified">! 	e = null;</span>
<span class="line-modified">! 	try {</span>
<span class="line-modified">! 	    // should fail because selector4 designates a field with type short, not int</span>
<span class="line-modified">! 	    getIntSubElement(arrayWithOops, selector4, 3);</span>
<span class="line-modified">! 	} catch(Throwable t) {</span>
<span class="line-modified">! 	    e = t;</span>
<span class="line-modified">! 	}</span>
<span class="line-modified">! 	Asserts.assertNotNull(e, &quot;An exception should have been thrown&quot;);</span>
<span class="line-modified">! 	Asserts.assertEquals(e.getClass(), java.lang.IllegalArgumentException.class, &quot;Wrong exception type&quot;);</span>
<span class="line-modified">! 	SubElementSelector selector5 = getSubElementSelector(selector1, ValueWithOops.class, &quot;b&quot;, &quot;QTestJNIArrays$BigValue;&quot;);</span>
<span class="line-modified">! 	e = null;</span>
<span class="line-modified">! 	try {</span>
<span class="line-modified">! 	    // Should fail because selector5 designates a non-flattened field</span>
<span class="line-modified">! 	    SubElementSelector selector6 = getSubElementSelector(selector5, TestJNIArrays.BigValue.class, &quot;l0&quot;, &quot;J&quot;);</span>
<span class="line-modified">! 	} catch(Throwable t) {</span>
<span class="line-modified">! 	    e = t;</span>
<span class="line-modified">! 	}</span>
<span class="line-modified">! 	Asserts.assertNotNull(e, &quot;An exception should have been thrown&quot;);</span>
<span class="line-modified">! 	Asserts.assertEquals(e.getClass(), java.lang.IllegalArgumentException.class, &quot;Wrong exception type&quot;);</span>
<span class="line-modified">! 	System.gc();</span>
      }
<span class="line-modified">!     </span>
      void checkGetFlattenedArrayElementSize() {
<span class="line-modified">! 	Throwable exception = null;</span>
<span class="line-modified">! 	try {</span>
<span class="line-modified">! 	    Object o = new Object();</span>
<span class="line-modified">! 	    GetFlattenedArrayElementSizeWrapper(o);</span>
<span class="line-modified">! 	} catch(Throwable t) {</span>
<span class="line-modified">! 	    exception = t;</span>
<span class="line-modified">! 	}</span>
<span class="line-modified">! 	Asserts.assertNotNull(exception, &quot;An IAE should have been thrown&quot;);</span>
<span class="line-modified">! 	Asserts.assertEquals(exception.getClass(), IllegalArgumentException.class , &quot;Wrong exception type&quot;);</span>
<span class="line-modified">! 	exception = null;</span>
<span class="line-modified">! 	try {</span>
<span class="line-modified">! 	    int[] array = new int[16];</span>
<span class="line-modified">! 	    Object o = array;</span>
<span class="line-modified">! 	    GetFlattenedArrayElementSizeWrapper(o);</span>
<span class="line-modified">! 	} catch(Throwable t) {</span>
<span class="line-modified">! 	    exception = t;</span>
<span class="line-modified">! 	}</span>
<span class="line-modified">! 	Asserts.assertNotNull(exception, &quot;An IAE should have been thrown&quot;);</span>
<span class="line-modified">! 	Asserts.assertEquals(exception.getClass(), IllegalArgumentException.class , &quot;Wrong exception type&quot;);</span>
<span class="line-modified">! 	exception = null;</span>
<span class="line-modified">! 	try {</span>
<span class="line-modified">! 	    GetFlattenedArrayElementSizeWrapper(new String[16]);</span>
<span class="line-modified">! 	} catch(Throwable t) {</span>
<span class="line-modified">! 	    exception = t;</span>
<span class="line-modified">! 	}</span>
<span class="line-modified">! 	Asserts.assertNotNull(exception, &quot;An IAE should have been thrown&quot;);</span>
<span class="line-modified">! 	Asserts.assertEquals(exception.getClass(), IllegalArgumentException.class , &quot;Wrong exception type&quot;);</span>
<span class="line-modified">! 	exception = null;</span>
<span class="line-modified">! 	try {</span>
<span class="line-modified">! 	    // Array of BigValue should not be flattened because BigValue is *big*</span>
<span class="line-modified">! 	    GetFlattenedArrayElementSizeWrapper(new BigValue[16]);</span>
<span class="line-modified">! 	} catch(Throwable t) {</span>
<span class="line-modified">! 	    exception = t;</span>
<span class="line-modified">! 	}</span>
<span class="line-modified">! 	Asserts.assertNotNull(exception, &quot;An IAE should have been thrown&quot;);</span>
<span class="line-modified">! 	Asserts.assertTrue(exception instanceof IllegalArgumentException , &quot;Exception should be a IAE&quot;);</span>
<span class="line-modified">! 	exception = null;</span>
<span class="line-modified">! 	int size = -1;</span>
<span class="line-modified">! 	try {</span>
<span class="line-modified">! 	    size = GetFlattenedArrayElementSizeWrapper(new IntInt[16]);</span>
<span class="line-modified">! 	} catch(Throwable t) {</span>
<span class="line-modified">! 	    exception = t;</span>
<span class="line-modified">! 	}</span>
<span class="line-modified">! 	Asserts.assertNull(exception, &quot;No exception should have been thrown&quot;);</span>
<span class="line-modified">! 	Asserts.assertEquals(size, 8, &quot;Wrong size&quot;);</span>
      }
  
      void checkGetFlattenedArrayElementClass() {
<span class="line-modified">! 	Throwable exception = null;</span>
<span class="line-modified">! 	try {</span>
<span class="line-modified">! 	    Object o = new Object();</span>
<span class="line-modified">! 	    GetFlattenedArrayElementClassWrapper(o);</span>
<span class="line-modified">! 	} catch(Throwable t) {</span>
<span class="line-modified">! 	    exception = t;</span>
<span class="line-modified">! 	}</span>
<span class="line-modified">! 	Asserts.assertNotNull(exception, &quot;An IAE should have been thrown&quot;);</span>
<span class="line-modified">! 	Asserts.assertEquals(exception.getClass(), IllegalArgumentException.class , &quot;Wrong exception type&quot;);</span>
<span class="line-modified">! 	exception = null;</span>
<span class="line-modified">! 	try {</span>
<span class="line-modified">! 	    int[] array = new int[16];</span>
<span class="line-modified">! 	    Object o = array;</span>
<span class="line-modified">! 	    GetFlattenedArrayElementClassWrapper(o);</span>
<span class="line-modified">! 	} catch(Throwable t) {</span>
<span class="line-modified">! 	    exception = t;</span>
<span class="line-modified">! 	}</span>
<span class="line-modified">! 	Asserts.assertNotNull(exception, &quot;An IAE should have been thrown&quot;);</span>
<span class="line-modified">! 	Asserts.assertEquals(exception.getClass(), IllegalArgumentException.class , &quot;Wrong exception type&quot;);</span>
<span class="line-modified">! 	exception = null;</span>
<span class="line-modified">! 	try {</span>
<span class="line-modified">! 	    GetFlattenedArrayElementClassWrapper(new String[16]);</span>
<span class="line-modified">! 	} catch(Throwable t) {</span>
<span class="line-modified">! 	    exception = t;</span>
<span class="line-modified">! 	}</span>
<span class="line-modified">! 	Asserts.assertNotNull(exception, &quot;An IAE should have been thrown&quot;);</span>
<span class="line-modified">! 	Asserts.assertEquals(exception.getClass(), IllegalArgumentException.class , &quot;Wrong exception type&quot;);</span>
<span class="line-modified">! 	exception = null;</span>
<span class="line-modified">! 	try {</span>
<span class="line-modified">! 	    // Array of BigValue should not be flattened because BigValue is *big*</span>
<span class="line-modified">! 	    GetFlattenedArrayElementClassWrapper(new BigValue[16]);</span>
<span class="line-modified">! 	} catch(Throwable t) {</span>
<span class="line-modified">! 	    exception = t;</span>
<span class="line-modified">! 	}</span>
<span class="line-modified">! 	Asserts.assertNotNull(exception, &quot;An IAE should have been thrown&quot;);</span>
<span class="line-modified">! 	Asserts.assertTrue(exception instanceof IllegalArgumentException , &quot;Exception should be a IAE&quot;);</span>
<span class="line-modified">! 	exception = null;</span>
<span class="line-modified">! 	Class c = null;</span>
<span class="line-modified">! 	try {</span>
<span class="line-modified">! 	    c = GetFlattenedArrayElementClassWrapper(new IntInt[16]);</span>
<span class="line-modified">! 	} catch(Throwable t) {</span>
<span class="line-modified">! 	    exception = t;</span>
<span class="line-modified">! 	}</span>
<span class="line-modified">! 	Asserts.assertNull(exception, &quot;No exception should have been thrown&quot;);</span>
<span class="line-modified">! 	Asserts.assertEquals(c, IntInt.class, &quot;Wrong class&quot;);</span>
      }
  
      void checkGetFieldOffsetInFlattenedLayout() {
<span class="line-modified">! 	Throwable exception = null;</span>
<span class="line-modified">! 	try {</span>
<span class="line-modified">! 	    Object o = new Object();</span>
<span class="line-modified">! 	    GetFieldOffsetInFlattenedLayoutWrapper(o.getClass(), &quot;foo&quot;, &quot;I&quot;, true);</span>
<span class="line-modified">! 	} catch(Throwable t) {</span>
<span class="line-modified">! 	    exception = t;</span>
<span class="line-modified">! 	}</span>
<span class="line-modified">! 	Asserts.assertNotNull(exception, &quot;An IAE should have been thrown&quot;);</span>
<span class="line-modified">! 	Asserts.assertEquals(exception.getClass(), IllegalArgumentException.class , &quot;Wrong exception type&quot;);</span>
<span class="line-modified">! 	exception = null;</span>
<span class="line-modified">! 	try {</span>
<span class="line-modified">! 	    int[] array = new int[16];</span>
<span class="line-modified">! 	    GetFieldOffsetInFlattenedLayoutWrapper(array.getClass(), &quot;foo&quot;, &quot;I&quot;, true);</span>
<span class="line-modified">! 	} catch(Throwable t) {</span>
<span class="line-modified">! 	    exception = t;</span>
<span class="line-modified">! 	}</span>
<span class="line-modified">! 	Asserts.assertNotNull(exception, &quot;An IAE should have been thrown&quot;);</span>
<span class="line-modified">! 	Asserts.assertEquals(exception.getClass(), IllegalArgumentException.class , &quot;Wrong exception type&quot;);</span>
<span class="line-modified">! 	exception = null;</span>
<span class="line-modified">! 	try {</span>
<span class="line-modified">! 	    String[] array = new String[16];</span>
<span class="line-modified">! 	    GetFieldOffsetInFlattenedLayoutWrapper(array.getClass(), &quot;foo&quot;, &quot;I&quot;, true);</span>
<span class="line-modified">! 	} catch(Throwable t) {</span>
<span class="line-modified">! 	    exception = t;</span>
<span class="line-modified">! 	}</span>
<span class="line-modified">! 	Asserts.assertNotNull(exception, &quot;An IAE should have been thrown&quot;);</span>
<span class="line-modified">! 	Asserts.assertEquals(exception.getClass(), IllegalArgumentException.class , &quot;Wrong exception type&quot;);</span>
<span class="line-modified">! 	exception = null;</span>
<span class="line-modified">! 	Containee ce  = new Containee(3.4f, (short)5);</span>
<span class="line-modified">! 	Container c = new Container(123.876, ce, (byte)7);</span>
<span class="line-modified">! 	Class&lt;?&gt; cclass = c.getClass();</span>
<span class="line-modified">! 	Container[] containerArray = new Container[32];</span>
<span class="line-modified">! 	int elementSize = GetFlattenedArrayElementSizeWrapper(containerArray);</span>
<span class="line-modified">! 	int offset = -1;</span>
<span class="line-modified">! 	try {</span>
<span class="line-modified">! 	    offset = GetFieldOffsetInFlattenedLayoutWrapper(cclass, &quot;d&quot;, &quot;D&quot;, false);</span>
<span class="line-modified">! 	} catch(Throwable t) {</span>
<span class="line-modified">! 	    exception = t;</span>
<span class="line-modified">! 	}</span>
<span class="line-modified">! 	Asserts.assertNull(exception, &quot;No exception should have been thrown&quot;);</span>
<span class="line-modified">! 	Field f = null;</span>
<span class="line-modified">! 	try {</span>
<span class="line-modified">! 	    f = cclass.getDeclaredField(&quot;d&quot;);</span>
<span class="line-modified">! 	} catch(NoSuchFieldException e) {</span>
<span class="line-modified">! 	    e.printStackTrace();</span>
<span class="line-modified">! 	    return;</span>
<span class="line-modified">! 	}</span>
<span class="line-modified">! 	Asserts.assertEquals(U.valueHeaderSize(cclass) + offset, U.objectFieldOffset(cclass, f.getName()),</span>
<span class="line-modified">! 			     &quot;Incorrect offset&quot;);</span>
<span class="line-modified">! 	Asserts.assertLessThan(offset, elementSize, &quot;Invalid offset&quot;);</span>
<span class="line-modified">! 	exception = null;</span>
<span class="line-modified">! 	try {</span>
<span class="line-modified">! 	    // Field c should be flattened, so last argument is true, no exception expected</span>
<span class="line-modified">! 	    GetFieldOffsetInFlattenedLayoutWrapper(cclass, &quot;c&quot;, &quot;QTestJNIArrays$Containee;&quot;, true);</span>
<span class="line-modified">! 	} catch(Throwable t) {</span>
<span class="line-modified">! 	    exception = t;</span>
<span class="line-modified">! 	}</span>
<span class="line-modified">! 	Asserts.assertNull(exception, &quot;No exception should have been thrown&quot;);</span>
<span class="line-modified">! 	Asserts.assertLessThan(offset, elementSize, &quot;Invalid offset&quot;);</span>
<span class="line-modified">! 	exception = null;</span>
<span class="line-modified">! 	try {</span>
<span class="line-modified">! 	    // Field c should be flattened, with last argument being false, exception expected from the wrapper </span>
<span class="line-modified">! 	    GetFieldOffsetInFlattenedLayoutWrapper(cclass, &quot;c&quot;, &quot;QTestJNIArrays$Containee;&quot;, false);</span>
<span class="line-modified">! 	} catch(Throwable t) {</span>
<span class="line-modified">! 	    exception = t;</span>
<span class="line-modified">! 	}</span>
<span class="line-modified">! 	Asserts.assertNotNull(exception, &quot;Wrapper should have thrown a RuntimeException&quot;);</span>
<span class="line-modified">! 	Asserts.assertEquals(exception.getClass(), RuntimeException.class , &quot;Wrong exception type&quot;);</span>
      }
<span class="line-modified">!     </span>
<span class="line-modified">!      void checkGetFlattenedArrayElements() {</span>
<span class="line-modified">! 	Throwable exception = null;</span>
<span class="line-modified">! 	Object o = new Object();</span>
<span class="line-modified">! 	try {</span>
<span class="line-modified">! 	    GetFlattenedArrayElementsWrapper(o);</span>
<span class="line-modified">! 	} catch(Throwable t) {</span>
<span class="line-modified">! 	    exception = t;</span>
<span class="line-modified">! 	}</span>
<span class="line-modified">! 	Asserts.assertNotNull(exception, &quot;An IAE should have been thrown&quot;);</span>
<span class="line-modified">! 	Asserts.assertEquals(exception.getClass(), IllegalArgumentException.class , &quot;Wrong exception type&quot;);</span>
<span class="line-modified">! 	exception = null;</span>
<span class="line-modified">! 	int[] a1 = new int[16];</span>
<span class="line-modified">! 	o = a1;</span>
<span class="line-modified">! 	try {</span>
<span class="line-modified">! 	    GetFlattenedArrayElementsWrapper(o);</span>
<span class="line-modified">! 	} catch(Throwable t) {</span>
<span class="line-modified">! 	    exception = t;</span>
<span class="line-modified">! 	}</span>
<span class="line-modified">! 	Asserts.assertNotNull(exception, &quot;An IAE should have been thrown&quot;);</span>
<span class="line-modified">! 	Asserts.assertEquals(exception.getClass(), IllegalArgumentException.class , &quot;Wrong exception type&quot;);</span>
<span class="line-modified">! 	exception = null;</span>
<span class="line-modified">! 	try {</span>
<span class="line-modified">! 	    GetFlattenedArrayElementsWrapper(new String[16]);</span>
<span class="line-modified">! 	} catch(Throwable t) {</span>
<span class="line-modified">! 	    exception = t;</span>
<span class="line-modified">! 	}</span>
<span class="line-modified">! 	Asserts.assertNotNull(exception, &quot;An IAE should have been thrown&quot;);</span>
<span class="line-modified">! 	Asserts.assertEquals(exception.getClass(), IllegalArgumentException.class , &quot;Wrong exception type&quot;);</span>
<span class="line-modified">! 	exception = null;</span>
<span class="line-modified">! 	try {</span>
<span class="line-modified">! 	    // Array of BigValue should not be flattened because BigValue is *big*</span>
<span class="line-modified">! 	    GetFlattenedArrayElementsWrapper(new BigValue[16]);</span>
<span class="line-modified">! 	} catch(Throwable t) {</span>
<span class="line-modified">! 	    exception = t;</span>
<span class="line-modified">! 	}</span>
<span class="line-modified">! 	Asserts.assertNotNull(exception, &quot;An IAE should have been thrown&quot;);</span>
<span class="line-modified">! 	Asserts.assertTrue(exception instanceof IllegalArgumentException , &quot;Exception should be a IAE&quot;);</span>
<span class="line-modified">! 	exception = null;</span>
<span class="line-modified">! 	try {</span>
<span class="line-modified">! 	    // Direct native access to flattened arrays is not allowed if elements contain oops</span>
<span class="line-modified">! 	    GetFlattenedArrayElementsWrapper(new ValueWithOops[16]);</span>
<span class="line-modified">! 	} catch(Throwable t) {</span>
<span class="line-modified">! 	    exception = t;</span>
<span class="line-modified">! 	}</span>
<span class="line-modified">! 	Asserts.assertNotNull(exception, &quot;An IAE should have been thrown&quot;);</span>
<span class="line-modified">! 	Asserts.assertTrue(exception instanceof IllegalArgumentException , &quot;Exception should be a IAE&quot;);</span>
<span class="line-modified">! 	exception = null;</span>
<span class="line-modified">! 	long addr = 0;</span>
<span class="line-modified">! 	IntInt[] a2 = new IntInt[16];</span>
<span class="line-modified">! 	try {</span>
<span class="line-modified">! 	    addr = GetFlattenedArrayElementsWrapper(a2);</span>
<span class="line-modified">! 	} catch(Throwable t) {</span>
<span class="line-modified">! 	    exception = t;</span>
<span class="line-modified">! 	}</span>
<span class="line-modified">! 	Asserts.assertNull(exception, &quot;No exception should have been thrown&quot;);</span>
<span class="line-modified">! 	if (exception == null) {</span>
<span class="line-modified">! 	    ReleaseFlattenedArrayElementsWrapper(a2, addr, 0);</span>
<span class="line-modified">! 	}</span>
      }
<span class="line-modified">!     </span>
      void checkBehaviors() {
<span class="line-modified">! 	System.out.println(&quot;Check 1&quot;);</span>
<span class="line-modified">! 	IntInt[] array = new IntInt[ARRAY_SIZE];</span>
<span class="line-modified">! 	int value = getIntFieldAtIndex(array, 1, &quot;i0&quot;, &quot;I&quot;);</span>
<span class="line-modified">! 	Asserts.assertEquals(value, 0, &quot;Initial value must be zero&quot;);</span>
<span class="line-modified">! 	printArrayInformation(array);</span>
<span class="line-modified">! 	int i0_value = 42;</span>
<span class="line-modified">! 	int i1_value = -314;</span>
<span class="line-modified">! 	initializeIntIntArrayBuffer(array, i0_value, i1_value);</span>
<span class="line-modified">! 	System.gc();</span>
<span class="line-modified">! 	for (int i = 0; i &lt; array.length; i++) {</span>
<span class="line-modified">! 	    Asserts.assertEquals(array[i].i0, i0_value, &quot;Bad value of i0 at index &quot; + i);</span>
<span class="line-modified">! 	    Asserts.assertEquals(array[i].i1, i1_value, &quot;Bad value of i1 at index &quot; + i);</span>
<span class="line-modified">! 	}</span>
<span class="line-modified">! 	System.out.println(&quot;Check 2&quot;);</span>
<span class="line-modified">! 	array = new IntInt[ARRAY_SIZE];</span>
<span class="line-modified">! 	i0_value = -194;</span>
<span class="line-modified">! 	i1_value = 91;</span>
<span class="line-modified">! 	initializeIntIntArrayFields(array, i0_value, i1_value);</span>
<span class="line-modified">! 	System.gc();</span>
<span class="line-modified">! 	for (int i = 0; i &lt; array.length; i++) {</span>
<span class="line-modified">! 	    Asserts.assertEquals(array[i].i0, i0_value, &quot;Bad value of i0 at index &quot; + i);</span>
<span class="line-modified">! 	    Asserts.assertEquals(array[i].i1, i1_value, &quot;Bad value of i1 at index &quot; + i);</span>
<span class="line-modified">! 	}</span>
<span class="line-modified">! 	System.out.println(&quot;Check 3&quot;);</span>
<span class="line-modified">! 	array = new IntInt[ARRAY_SIZE];</span>
<span class="line-modified">! 	initializeIntIntArrayJava(array, i0_value, i1_value);</span>
<span class="line-modified">! 	System.gc();</span>
<span class="line-modified">! 	for (int i = 0; i &lt; array.length; i++) {</span>
<span class="line-modified">! 	    Asserts.assertEquals(array[i].i0, i0_value, &quot;Bad value of i0 at index &quot; + i);</span>
<span class="line-modified">! 	    Asserts.assertEquals(array[i].i1, i1_value, &quot;Bad value of i1 at index &quot; + i);</span>
<span class="line-modified">! 	}</span>
<span class="line-modified">! 	System.out.println(&quot;Check 4&quot;);</span>
<span class="line-modified">! 	random = new Random(seed);</span>
<span class="line-modified">! 	array = new IntInt[ARRAY_SIZE];</span>
<span class="line-modified">! 	for (int i = 0; i &lt; ARRAY_SIZE; i++) {</span>
<span class="line-modified">! 	    array[i] = new IntInt(random.nextInt(), random.nextInt());</span>
<span class="line-modified">! 	}</span>
<span class="line-modified">! 	sortIntIntArray(array);</span>
<span class="line-modified">! 	System.gc();</span>
<span class="line-modified">! 	for (int i = 0; i &lt; array.length - 1; i++) {</span>
<span class="line-modified">! 	    Asserts.assertLessThanOrEqual(array[i].i0, array[i+1].i0, &quot;Incorrect i0 fields ordering at index &quot; + i);</span>
<span class="line-modified">! 	    if (array[i].i0 == array[i+1].i0) {</span>
<span class="line-modified">! 		Asserts.assertLessThanOrEqual(array[i].i1, array[i+1].i1, &quot;Incorrect i1 fields ordering at index &quot; + i);</span>
<span class="line-modified">! 	    }</span>
<span class="line-modified">! 	}</span>
<span class="line-modified">! 	System.out.println(&quot;Check 5&quot;);</span>
<span class="line-modified">! 	random = new Random(seed);</span>
<span class="line-modified">! 	array = new IntInt[ARRAY_SIZE];</span>
<span class="line-modified">! 	for (int i = 0; i &lt; ARRAY_SIZE; i++) {</span>
<span class="line-modified">! 	    array[i] = new IntInt(random.nextInt(), random.nextInt());</span>
<span class="line-modified">! 	}</span>
<span class="line-modified">! 	Arrays.sort(array, new IntIntComparator());</span>
<span class="line-modified">! 	System.gc();</span>
<span class="line-modified">! 	for (int i = 0; i &lt; array.length - 1; i++) {</span>
<span class="line-modified">! 	    Asserts.assertLessThanOrEqual(array[i].i0, array[i+1].i0, &quot;Incorrect i0 fields ordering at index &quot; + i);</span>
<span class="line-modified">! 	    if (array[i].i0 == array[i+1].i0) {</span>
<span class="line-modified">! 		Asserts.assertLessThanOrEqual(array[i].i1, array[i+1].i1, &quot;Incorrect i1 fields ordering at index &quot; + i);</span>
<span class="line-modified">! 	    }</span>
<span class="line-modified">! 	}</span>
<span class="line-modified">! 	System.out.println(&quot;Check 6&quot;);</span>
<span class="line-modified">! 	Container[] array2 = new Container[ARRAY_SIZE];</span>
<span class="line-modified">! 	double d  = 1.23456789;</span>
<span class="line-modified">! 	float f = -987.654321f;</span>
<span class="line-modified">! 	short s = -512;</span>
<span class="line-modified">! 	byte b = 127;</span>
<span class="line-modified">! 	Containee c = new Containee(f,s);</span>
<span class="line-modified">! 	Container c2 = new Container(d, c, b);</span>
<span class="line-modified">! 	initializeContainerArray(array2, d, f, s, b);</span>
<span class="line-modified">! 	System.gc();</span>
<span class="line-modified">! 	for (int i = 0; i &lt; array2.length; i++) {</span>
<span class="line-modified">! 	    Asserts.assertEquals(array2[i], c2, &quot;Incorrect value at index &quot; + i);</span>
<span class="line-modified">! 	    Asserts.assertEquals(array2[i].d, d, &quot;Incorrect d value at index &quot; + i);</span>
<span class="line-modified">! 	    Asserts.assertEquals(array2[i].c.f, f, &quot;Incorrect f value at index &quot; + i);</span>
<span class="line-modified">! 	    Asserts.assertEquals(array2[i].c.s, s, &quot;Incorrect s value at index &quot; + i);</span>
<span class="line-modified">! 	    Asserts.assertEquals(array2[i].b, b, &quot;Incorrect b value at inde &quot; +i);</span>
<span class="line-modified">! 	}</span>
<span class="line-modified">! 	System.out.println(&quot;Check 7&quot;);</span>
<span class="line-modified">! 	f = 19.2837465f;</span>
<span class="line-modified">! 	s = 231;</span>
<span class="line-modified">! 	updateContainerArray(array2, f, s);</span>
<span class="line-modified">! 	System.gc();</span>
<span class="line-modified">! 	for (int i = 0; i &lt; array2.length; i++) {</span>
<span class="line-modified">! 	    Asserts.assertEquals(array2[i].d, d, &quot;Incorrect d value at index &quot; + i);</span>
<span class="line-modified">! 	    Asserts.assertEquals(array2[i].c.f, f, &quot;Incorrect f value at index &quot; + i);</span>
<span class="line-modified">! 	    Asserts.assertEquals(array2[i].c.s, s, &quot;Incorrect s value at index &quot; + i);</span>
<span class="line-modified">! 	    Asserts.assertEquals(array2[i].b, b, &quot;Incorrect b value at inde &quot; +i);</span>
<span class="line-modified">! 	}</span>
<span class="line-modified">! 	System.out.println(&quot;Check 8&quot;);</span>
<span class="line-modified">! 	long l0 = 52467923;</span>
<span class="line-modified">! 	long l1= -7854022;</span>
<span class="line-modified">! 	long l2 = 230947485;</span>
<span class="line-modified">! 	long l3 = -752497024;</span>
<span class="line-modified">! 	LongLongLongLong[] array3 = new LongLongLongLong[ARRAY_SIZE/8];</span>
<span class="line-modified">! 	initializeLongLongLongLongArray(array3, l0, l1, l2, l3);</span>
<span class="line-modified">! 	System.gc();</span>
<span class="line-modified">! 	for (int i = 0; i &lt; array3.length; i++) {</span>
<span class="line-modified">! 	    Asserts.assertEquals(array3[i].l0, l0, &quot;Bad value of l0 at index &quot; + i);</span>
<span class="line-modified">! 	    Asserts.assertEquals(array3[i].l1, l1, &quot;Bad value of l1 at index &quot; + i);</span>
<span class="line-modified">! 	    Asserts.assertEquals(array3[i].l2, l2, &quot;Bad value of l2 at index &quot; + i);</span>
<span class="line-modified">! 	    Asserts.assertEquals(array3[i].l3, l3, &quot;Bad value of l3 at index &quot; + i);</span>
<span class="line-modified">! 	}</span>
      }
  
      void initializeIntIntArrayJava(IntInt[] array, int i0, int i1) {
<span class="line-modified">! 	IntInt ii = new IntInt(i0, i1);</span>
<span class="line-modified">! 	for (int i = 0; i &lt; array.length; i++) {</span>
<span class="line-modified">! 	    array[i] = ii;</span>
<span class="line-modified">! 	}</span>
      }
  
      void initializeContainerArrayJava(Container[] array, double d, float f, short s, byte b) {
<span class="line-modified">! 	Containee c = new Containee(f,s);</span>
<span class="line-modified">! 	Container c2 = new Container(d, c, b);</span>
<span class="line-modified">! 	for (int i = 0; i &lt; array.length; i++) {</span>
<span class="line-modified">! 	    array[i] = c2;</span>
<span class="line-modified">! 	}</span>
      }
  
      void updateContainerArrayJava(Container[] array, float f, short s) {
<span class="line-modified">! 	Containee c = new Containee(f, s);</span>
<span class="line-modified">! 	for (int i = 0; i &lt; array.length; i++) {</span>
<span class="line-modified">! 	    array[i] = array[i].setc(c);;</span>
<span class="line-modified">! 	}</span>
      }
  
      void initializeLongLongLongLongArrayJava(LongLongLongLong[] array, long l0, long l1, long l2, long l3) {
<span class="line-modified">! 	LongLongLongLong llll = new LongLongLongLong(l0, l1, l2, l3);</span>
<span class="line-modified">! 	for (int i = 0; i &lt; array.length; i++) {</span>
<span class="line-modified">! 	    array[i] = llll;</span>
<span class="line-modified">! 	}</span>
      }
<span class="line-modified">!     </span>
<span class="line-modified">!     void mesureInitializationTime(int array_size, int iterations) {</span>
<span class="line-modified">! 	System.out.println(&quot;\nInitialization time for IntInt[]:&quot;);</span>
<span class="line-modified">! 	long[] start = new long[iterations];</span>
<span class="line-modified">! 	long[] end = new long[iterations];</span>
<span class="line-modified">! </span>
<span class="line-modified">! 	</span>
<span class="line-modified">! 	System.out.println(&quot;\nJava:&quot;);</span>
<span class="line-modified">! 	// Warmup</span>
<span class="line-modified">! 	for (int i = 0; i &lt; 10; i++) {</span>
<span class="line-modified">! 	    IntInt[] array = new IntInt[array_size];</span>
<span class="line-modified">! 	    initializeIntIntArrayJava(array, 42, -314);</span>
<span class="line-modified">! 	}</span>
<span class="line-modified">! 	// Measure</span>
<span class="line-modified">! 	for (int i = 0; i &lt; iterations; i++) {</span>
<span class="line-modified">! 	    IntInt[] array = new IntInt[array_size];</span>
<span class="line-modified">! 	    start[i] = System.nanoTime();</span>
<span class="line-modified">! 	    initializeIntIntArrayJava(array, 42, -314);</span>
<span class="line-modified">! 	    end[i] = System.nanoTime();</span>
<span class="line-modified">! 	}</span>
<span class="line-modified">! 	// Results</span>
<span class="line-modified">! 	computeStatistics(start, end);</span>
<span class="line-modified">! </span>
<span class="line-modified">! 	System.out.println(&quot;\nNative(memcpy):&quot;);</span>
<span class="line-modified">! 	// Warmup</span>
<span class="line-modified">! 	for (int i = 0; i &lt; 10; i++) {</span>
<span class="line-modified">! 	    IntInt[] array = new IntInt[array_size];</span>
<span class="line-modified">! 	    initializeIntIntArrayBuffer(array, 42, -314);</span>
<span class="line-modified">! 	}</span>
<span class="line-modified">! 	// Measure</span>
<span class="line-modified">! 	for (int i = 0; i &lt; iterations; i++) {</span>
<span class="line-modified">! 	    IntInt[] array = new IntInt[array_size];</span>
<span class="line-modified">! 	    start[i] = System.nanoTime();</span>
<span class="line-modified">! 	    initializeIntIntArrayBuffer(array, 42, -314);</span>
<span class="line-modified">! 	    end[i] = System.nanoTime();</span>
<span class="line-modified">! 	}</span>
<span class="line-modified">! 	// Results</span>
<span class="line-modified">! 	computeStatistics(start, end);</span>
<span class="line-modified">! 	</span>
<span class="line-modified">! 	</span>
<span class="line-modified">! 	System.out.println(&quot;\nNative(fields):&quot;);</span>
<span class="line-modified">! 	// Warmup</span>
<span class="line-modified">! 	for (int i = 0; i &lt; 10; i++) {</span>
<span class="line-modified">! 	    IntInt[] array = new IntInt[array_size];</span>
<span class="line-modified">! 	    initializeIntIntArrayFields(array, 42, -314);</span>
<span class="line-modified">! 	}</span>
<span class="line-modified">! 	// Measure</span>
<span class="line-modified">! 	for (int i = 0; i &lt; iterations; i++) {</span>
<span class="line-modified">! 	    IntInt[] array = new IntInt[array_size];</span>
<span class="line-modified">! 	    start[i] = System.nanoTime();</span>
<span class="line-modified">! 	    initializeIntIntArrayFields(array, 42, -314);</span>
<span class="line-modified">! 	    end[i] = System.nanoTime();</span>
<span class="line-modified">! 	}</span>
<span class="line-modified">! 	// Results</span>
<span class="line-modified">! 	computeStatistics(start, end);</span>
      }
  
<span class="line-modified">!     void mesureInitializationTime2(int array_size, int iterations) {</span>
<span class="line-modified">! 	System.out.println(&quot;\nInitialization time for Container[]:&quot;);</span>
<span class="line-modified">! 	long[] start = new long[iterations];</span>
<span class="line-modified">! 	long[] end = new long[iterations];</span>
<span class="line-modified">! </span>
<span class="line-modified">! 	double d = 0.369852147;</span>
<span class="line-modified">! 	float f = -321.654987f;</span>
<span class="line-modified">! 	short s = -3579;</span>
<span class="line-modified">! 	byte b = 42;</span>
<span class="line-modified">! 	</span>
<span class="line-modified">! 	System.out.println(&quot;\nJava:&quot;);</span>
<span class="line-modified">! 	// Warmup</span>
<span class="line-modified">! 	for (int i = 0; i &lt; 10; i++) {</span>
<span class="line-modified">! 	    Container[] array = new Container[array_size];</span>
<span class="line-modified">! 	    initializeContainerArrayJava(array, d, f, s, b);</span>
<span class="line-modified">! 	}</span>
<span class="line-modified">! 	// Measure</span>
<span class="line-modified">! 	for (int i = 0; i &lt; iterations; i++) {</span>
<span class="line-modified">! 	    Container[] array = new Container[array_size];</span>
<span class="line-modified">! 	    start[i] = System.nanoTime();</span>
<span class="line-modified">! 	    initializeContainerArrayJava(array, d, f, s, b);</span>
<span class="line-modified">! 	    end[i] = System.nanoTime();</span>
<span class="line-modified">! 	}</span>
<span class="line-modified">! 	// Results</span>
<span class="line-modified">! 	computeStatistics(start, end);</span>
<span class="line-modified">! </span>
<span class="line-modified">! 	System.out.println(&quot;\nNative:&quot;);</span>
<span class="line-modified">! 	// Warmup</span>
<span class="line-modified">! 	for (int i = 0; i &lt; 10; i++) {</span>
<span class="line-modified">! 	    Container[] array = new Container[array_size];</span>
<span class="line-modified">! 	    initializeContainerArray(array, d, f, s, b);</span>
<span class="line-modified">! 	}</span>
<span class="line-modified">! 	// Measure</span>
<span class="line-modified">! 	for (int i = 0; i &lt; iterations; i++) {</span>
<span class="line-modified">! 	    Container[] array = new Container[array_size];</span>
<span class="line-modified">! 	    start[i] = System.nanoTime();</span>
<span class="line-modified">! 	    initializeContainerArray(array, d, f, s, b);</span>
<span class="line-modified">! 	    end[i] = System.nanoTime();</span>
<span class="line-modified">! 	}</span>
<span class="line-modified">! 	// Results</span>
<span class="line-modified">! 	computeStatistics(start, end);</span>
      }
  
<span class="line-modified">!     void mesureUpdateTime2(int array_size, int iterations) {</span>
<span class="line-modified">! 	System.out.println(&quot;\nUpdating Container[]:&quot;);</span>
<span class="line-modified">! 	long[] start = new long[iterations];</span>
<span class="line-modified">! 	long[] end = new long[iterations];</span>
<span class="line-modified">! </span>
<span class="line-modified">! 	double d = 0.369852147;</span>
<span class="line-modified">! 	float f = -321.654987f;</span>
<span class="line-modified">! 	short s = -3579;</span>
<span class="line-modified">! 	byte b = 42;</span>
<span class="line-modified">! </span>
<span class="line-modified">! 	Containee c = new Containee(f,s);</span>
<span class="line-modified">! 	Container c2 = new Container(d, c, b);</span>
<span class="line-modified">! 	</span>
<span class="line-modified">! 	System.out.println(&quot;\nJava:&quot;);</span>
<span class="line-modified">! 	// Warmup</span>
<span class="line-modified">! 	for (int i = 0; i &lt; 10; i++) {</span>
<span class="line-modified">! 	    Container[] array = new Container[array_size];</span>
<span class="line-modified">! 	    for (int j = 0; j &lt; array.length; j++) {</span>
<span class="line-modified">! 		array[j] = c2;</span>
<span class="line-modified">! 	    }</span>
<span class="line-modified">! 	    updateContainerArrayJava(array, f, s);</span>
<span class="line-modified">! 	}</span>
<span class="line-modified">! 	// Measure</span>
<span class="line-modified">! 	for (int i = 0; i &lt; iterations; i++) {</span>
<span class="line-modified">! 	    Container[] array = new Container[array_size];</span>
<span class="line-modified">! 	    for (int j = 0; j &lt; array.length; j++) {</span>
<span class="line-modified">! 		array[i] = c2;</span>
<span class="line-modified">! 	    }</span>
<span class="line-modified">! 	    start[i] = System.nanoTime();</span>
<span class="line-modified">! 	    updateContainerArrayJava(array, f, s);</span>
<span class="line-modified">! 	    end[i] = System.nanoTime();</span>
<span class="line-modified">! 	}</span>
<span class="line-modified">! 	// Results</span>
<span class="line-modified">! 	computeStatistics(start, end);</span>
<span class="line-modified">! </span>
<span class="line-modified">! 	System.out.println(&quot;\nNative:&quot;);</span>
<span class="line-modified">! 	// Warmup</span>
<span class="line-modified">! 	for (int i = 0; i &lt; 10; i++) {</span>
<span class="line-modified">! 	    Container[] array = new Container[array_size];</span>
<span class="line-modified">! 	    for (int j = 0; j &lt; array.length; j++) {</span>
<span class="line-modified">! 		array[i] = c2;</span>
<span class="line-modified">! 	    }</span>
<span class="line-modified">! 	    updateContainerArray(array, f, s);</span>
<span class="line-modified">! 	}</span>
<span class="line-modified">! 	// Measure</span>
<span class="line-modified">! 	for (int i = 0; i &lt; iterations; i++) {</span>
<span class="line-modified">! 	    Container[] array = new Container[array_size];</span>
<span class="line-modified">! 	    for (int j = 0; j &lt; array.length; j++) {</span>
<span class="line-modified">! 		array[i] = c2;</span>
<span class="line-modified">! 	    }</span>
<span class="line-modified">! 	    start[i] = System.nanoTime();</span>
<span class="line-modified">! 	    updateContainerArray(array, f, s);</span>
<span class="line-modified">! 	    end[i] = System.nanoTime();</span>
<span class="line-modified">! 	}</span>
<span class="line-modified">! 	// Results</span>
<span class="line-modified">! 	computeStatistics(start, end);</span>
      }
<span class="line-modified">!     </span>
<span class="line-modified">!     void mesureSortingTime(int array_size, int iterations) {</span>
<span class="line-modified">! 	System.out.println(&quot;\nSorting time:&quot;);</span>
<span class="line-modified">! 	long[] start = new long[iterations];</span>
<span class="line-modified">! 	long[] end = new long[iterations];</span>
<span class="line-modified">! </span>
<span class="line-modified">! 	random = new Random(seed);</span>
<span class="line-modified">! 	System.out.println(&quot;\nJava:&quot;);</span>
<span class="line-modified">! 	IntIntComparator comparator = new IntIntComparator();</span>
<span class="line-modified">! 	// Warmup</span>
<span class="line-modified">! 	for (int i = 0; i &lt; 10; i++) {</span>
<span class="line-modified">! 	    IntInt[] array = new IntInt[array_size];</span>
<span class="line-modified">! 	    array = new IntInt[array_size];</span>
<span class="line-modified">! 	    for (int j = 0; j &lt; array_size; j++) {</span>
<span class="line-modified">! 		array[j] = new IntInt(random.nextInt(), random.nextInt());</span>
<span class="line-modified">! 	    }</span>
<span class="line-modified">! 	    Arrays.sort(array, comparator);</span>
<span class="line-modified">! 	}</span>
<span class="line-modified">! 	// Measure</span>
<span class="line-modified">! 	for (int i = 0; i &lt; iterations; i++) {</span>
<span class="line-modified">! 	    IntInt[] array = new IntInt[array_size];</span>
<span class="line-modified">! 	    for (int j = 0; j &lt; array_size; j++) {</span>
<span class="line-modified">! 		array[j] = new IntInt(random.nextInt(), random.nextInt());</span>
<span class="line-modified">! 	    }</span>
<span class="line-modified">! 	    start[i] = System.nanoTime();</span>
<span class="line-modified">! 	    Arrays.sort(array, comparator);</span>
<span class="line-modified">! 	    end[i] = System.nanoTime();</span>
<span class="line-modified">! 	}</span>
<span class="line-modified">! 	// Results</span>
<span class="line-modified">! 	computeStatistics(start, end);</span>
<span class="line-modified">! </span>
<span class="line-modified">! 	random = new Random(seed);</span>
<span class="line-modified">! 	System.out.println(&quot;\nNative:&quot;);</span>
<span class="line-modified">! 	// Warmup</span>
<span class="line-modified">! 	for (int i = 0; i &lt; 10; i++) {</span>
<span class="line-modified">! 	    IntInt[] array = new IntInt[array_size];</span>
<span class="line-modified">! 	    array = new IntInt[array_size];</span>
<span class="line-modified">! 	    for (int j = 0; j &lt; array_size; j++) {</span>
<span class="line-modified">! 		array[j] = new IntInt(random.nextInt(), random.nextInt());</span>
<span class="line-modified">! 	    }</span>
<span class="line-modified">! 	    sortIntIntArray(array);</span>
<span class="line-modified">! 	}</span>
<span class="line-modified">! 	// Measure</span>
<span class="line-modified">! 	for (int i = 0; i &lt; iterations; i++) {</span>
<span class="line-modified">! 	    IntInt[] array = new IntInt[array_size];</span>
<span class="line-modified">! 	    for (int j = 0; j &lt; array_size; j++) {</span>
<span class="line-modified">! 		array[j] = new IntInt(random.nextInt(), random.nextInt());</span>
<span class="line-modified">! 	    }</span>
<span class="line-modified">! 	    start[i] = System.nanoTime();</span>
<span class="line-modified">! 	    sortIntIntArray(array);</span>
<span class="line-modified">! 	    end[i] = System.nanoTime();</span>
<span class="line-modified">! 	}</span>
<span class="line-modified">! 	// Results</span>
<span class="line-modified">! 	computeStatistics(start, end);</span>
      }
  
  
<span class="line-modified">!     void mesureInitializationTime3(int array_size, int iterations) {</span>
<span class="line-modified">! 	System.out.println(&quot;\nInitialization time for LongLongLongLong[]:&quot;);</span>
<span class="line-modified">! 	long[] start = new long[iterations];</span>
<span class="line-modified">! 	long[] end = new long[iterations];</span>
<span class="line-modified">! </span>
<span class="line-modified">! 	long l0 = 123456;</span>
<span class="line-modified">! 	long l1 = -987654;</span>
<span class="line-modified">! 	long l2 = 192837;</span>
<span class="line-modified">! 	long l3 = -56473829;</span>
<span class="line-modified">! 	</span>
<span class="line-modified">! 	System.out.println(&quot;\nJava:&quot;);</span>
<span class="line-modified">! 	// Warmup</span>
<span class="line-modified">! 	for (int i = 0; i &lt; 10; i++) {</span>
<span class="line-modified">! 	    LongLongLongLong[] array = new LongLongLongLong[array_size];</span>
<span class="line-modified">! 	    initializeLongLongLongLongArrayJava(array, l0, l1, l2, l3);</span>
<span class="line-modified">! 	}</span>
<span class="line-modified">! 	// Measure</span>
<span class="line-modified">! 	for (int i = 0; i &lt; iterations; i++) {</span>
<span class="line-modified">! 	    LongLongLongLong[] array = new LongLongLongLong[array_size];</span>
<span class="line-modified">! 	    start[i] = System.nanoTime();</span>
<span class="line-modified">! 	    initializeLongLongLongLongArrayJava(array, l0, l1, l2, l3);</span>
<span class="line-modified">! 	    end[i] = System.nanoTime();</span>
<span class="line-modified">! 	}</span>
<span class="line-modified">! 	// Results</span>
<span class="line-modified">! 	computeStatistics(start, end);</span>
<span class="line-modified">! </span>
<span class="line-modified">! 	System.out.println(&quot;\nNative:&quot;);</span>
<span class="line-modified">! 	// Warmup</span>
<span class="line-modified">! 	for (int i = 0; i &lt; 10; i++) {</span>
<span class="line-modified">! 	    LongLongLongLong[] array = new LongLongLongLong[array_size];</span>
<span class="line-modified">! 	    initializeLongLongLongLongArray(array, l0, l1, l2, l3);</span>
<span class="line-modified">! 	}</span>
<span class="line-modified">! 	// Measure</span>
<span class="line-modified">! 	for (int i = 0; i &lt; iterations; i++) {</span>
<span class="line-modified">! 	    LongLongLongLong[] array = new LongLongLongLong[array_size];</span>
<span class="line-modified">! 	    start[i] = System.nanoTime();</span>
<span class="line-modified">! 	    initializeLongLongLongLongArray(array, l0, l1, l2, l3);</span>
<span class="line-modified">! 	    end[i] = System.nanoTime();</span>
<span class="line-modified">! 	}</span>
<span class="line-modified">! 	// Results</span>
<span class="line-modified">! 	computeStatistics(start, end);</span>
      }
<span class="line-modified">!     </span>
      void computeStatistics(long[] start, long[] end) {
<span class="line-modified">! 	int iterations = start.length;</span>
<span class="line-modified">! 	long[] duration = new long[iterations];</span>
<span class="line-modified">! 	long sum = 0;</span>
<span class="line-modified">! 	long min = end[0] - start[0];</span>
<span class="line-modified">! 	long max = min;</span>
<span class="line-modified">! 	double var = 0.0;</span>
<span class="line-modified">! 	for (int i = 0 ; i &lt; iterations; i++) {</span>
<span class="line-modified">! 	    duration[i] = end[i] - start[i];</span>
<span class="line-modified">! 	    if (duration[i] &lt; min) min = duration[i];</span>
<span class="line-modified">! 	    if (duration[i] &gt; max) max = duration[i];</span>
<span class="line-modified">! 	    sum += duration[i];</span>
<span class="line-modified">! 	    double d = (double) duration[i];</span>
<span class="line-modified">! 	    var += Math.pow(d, 2);</span>
<span class="line-modified">! 	}</span>
<span class="line-modified">! 	double avg = (sum/iterations) / 1000;</span>
<span class="line-modified">! 	double std = (Math.sqrt(var/iterations - Math.pow(sum/iterations, 2))) / 1000;</span>
<span class="line-modified">! 	System.out.println(String.format(&quot;Avg: %8.2f us&quot;, avg));</span>
<span class="line-modified">! 	System.out.println(String.format(&quot;Std: %8.2f us&quot;, std));</span>
<span class="line-modified">! 	System.out.println(String.format(&quot;Min: %8d us&quot;, (min/1000)));</span>
<span class="line-modified">! 	System.out.println(String.format(&quot;Max: %8d us&quot;, (max/1000)));</span>
      }
  
      native int GetFlattenedArrayElementSizeWrapper(Object array);
      native Class GetFlattenedArrayElementClassWrapper(Object array);
      native long GetFlattenedArrayElementsWrapper(Object array);
      native void ReleaseFlattenedArrayElementsWrapper(Object array, long addr,int mode);
      native int GetFieldOffsetInFlattenedLayoutWrapper(Class klass, String name, String signature, boolean flattened);
<span class="line-modified">!     </span>
      native int getIntFieldAtIndex(Object[] array, int index, String fieldName, String FieldSignature);
      native void printArrayInformation(Object[] array);
  
      native void initializeIntIntArrayBuffer(Object[] array, int i0, int i1);
      native void initializeIntIntArrayFields(Object[] array, int i0, int i1);
<span class="line-new-header">--- 37,833 ---</span>
   * @summary Test flattened arrays accesses through JNI
   * @modules java.base/jdk.internal.misc java.base/jdk.internal.vm.jni
   * @library /testlibrary /test/lib
   * @requires (os.simpleArch == &quot;x64&quot;)
   * @requires (os.family == &quot;linux&quot; | os.family == &quot;mac&quot;)
<span class="line-modified">!  * @compile -XDallowWithFieldOperator TestJNIArrays.java</span>
   * @run main/othervm/native/timeout=3000 -XX:ValueArrayElemMaxFlatSize=128 -XX:+PrintFlattenableLayouts -XX:+UseCompressedOops TestJNIArrays
   * @run main/othervm/native/timeout=3000 -XX:ValueArrayElemMaxFlatSize=128 -XX:+PrintFlattenableLayouts -XX:-UseCompressedOops TestJNIArrays
   */
  public class TestJNIArrays {
  
      static final Unsafe U = Unsafe.getUnsafe();
<span class="line-modified">! </span>
      public static final int ARRAY_SIZE = 1024;
      static long seed;
      static Random random;
  
      static {
<span class="line-modified">!         seed = System.nanoTime();</span>
<span class="line-modified">!         System.out.println(&quot;Seed = &quot; + seed);</span>
<span class="line-modified">!         random = new Random(seed);</span>
      }
  
      static {
          System.loadLibrary(&quot;TestJNIArrays&quot;);
      }
  
      static inline class IntInt {
<span class="line-modified">!         int i0;</span>
<span class="line-modified">!         int i1;</span>
  
<span class="line-modified">!         public IntInt(int i0, int i1) {</span>
<span class="line-modified">!             this.i0 = i0;</span>
<span class="line-modified">!             this.i1 = i1;</span>
<span class="line-modified">!         }</span>
      }
  
<span class="line-modified">!     static class IntIntComparator implements Comparator&lt;IntInt.ref&gt; {</span>
<span class="line-modified">!         public int compare(IntInt.ref a, IntInt.ref b) {</span>
<span class="line-modified">!             if (a.i0 &lt; b.i0) return -1;</span>
<span class="line-modified">!             if (a.i0 &gt; b.i0) return 1;</span>
<span class="line-modified">!             if (a.i1 &lt; b.i1) return -1;</span>
<span class="line-modified">!             if (a.i1 &gt; b.i1) return 1;</span>
<span class="line-modified">!             return 0;</span>
<span class="line-modified">!         }</span>
      }
  
      static inline class Containee {
<span class="line-modified">!         float f;</span>
<span class="line-modified">!         short s;</span>
  
<span class="line-modified">!         Containee(float f, short s) {</span>
<span class="line-modified">!             this.f = f;</span>
<span class="line-modified">!             this.s = s;</span>
<span class="line-modified">!         }</span>
      }
  
<span class="line-modified">!     static inline class Container {</span>
<span class="line-modified">!         double d;</span>
<span class="line-modified">!         Containee c;</span>
<span class="line-modified">!         byte b;</span>
<span class="line-modified">! </span>
<span class="line-added">+         Container(double d, Containee c, byte b) {</span>
<span class="line-added">+             this.d = d ;</span>
<span class="line-added">+             this.c = c;</span>
<span class="line-added">+             this.b = b;</span>
<span class="line-added">+         }</span>
  
<span class="line-modified">!         Container setc(Containee c) {</span>
              Container res = __WithField(this.c, c);
              return res;
          }
  
      }
  
      static inline class LongLongLongLong {
<span class="line-modified">!         long l0, l1, l2, l3;</span>
<span class="line-modified">! </span>
<span class="line-modified">!         public LongLongLongLong(long l0, long l1, long l2, long l3) {</span>
<span class="line-modified">!             this.l0 = l0;</span>
<span class="line-modified">!             this.l1 = l1;</span>
<span class="line-modified">!             this.l2 = l2;</span>
<span class="line-modified">!             this.l3 = l3;</span>
<span class="line-modified">!         }</span>
      }
  
      static inline class BigValue {
<span class="line-modified">!         long l0 = 0, l1 = 0,   l2 = 0, l3 = 0, l4 = 0, l5 = 0, l6 = 0, l7 = 0, l8 = 0, l9 = 0;</span>
<span class="line-modified">!         long l10 = 0, l11 = 0, l12 = 0, l13 = 0, l14 = 0, l15 = 0, l16 = 0, l17 = 0, l18 = 0, l19 = 0;</span>
<span class="line-modified">!         long l20 = 0, l21 = 0, l22 = 0, l23 = 0, l24 = 0, l25 = 0, l26 = 0, l27 = 0, l28 = 0, l29 = 0;</span>
<span class="line-modified">!         long l30 = 0, l31 = 0, l32 = 0, l33 = 0, l34 = 0, l35 = 0, l36 = 0, l37 = 0, l38 = 0, l39 = 0;</span>
      }
  
      static inline class ValueWithOops {
<span class="line-modified">!         String s = &quot;bonjour&quot;;</span>
<span class="line-modified">!         int i = 0;</span>
<span class="line-modified">!         Containee c = new Containee(2.3f, (short)4);</span>
<span class="line-modified">!         BigValue b = new BigValue();</span>
      }
<span class="line-modified">! </span>
      public static void main(String[] args) {
<span class="line-modified">!         TestJNIArrays test = new TestJNIArrays();</span>
<span class="line-modified">!         test.checkGetFlattenedArrayElementSize();</span>
<span class="line-modified">!         test.checkGetFlattenedArrayElementClass();</span>
<span class="line-modified">!         test.checkGetFieldOffsetInFlattenedLayout();</span>
<span class="line-modified">!         test.checkGetFlattenedArrayElements();</span>
<span class="line-modified">!         test.checkSubElementAPI();</span>
<span class="line-modified">!         test.checkBehaviors();</span>
<span class="line-modified">! </span>
<span class="line-modified">!         // TODO: move these to micro-benchmark or out of tier1 testing...</span>
<span class="line-modified">!         // test.measureInitializationTime(1024 * 1024 * 10 , 1000);</span>
<span class="line-modified">!         // test.measureInitializationTime2(1024 * 1024 * 10 , 1000);</span>
<span class="line-modified">!         // test.measureUpdateTime2(1024 * 1024 * 10, 1000);</span>
<span class="line-added">+         // test.measureSortingTime(1024 * 1024, 100); // reduced number of iterations because Java sorting is slow (because of generics?)</span>
<span class="line-added">+         //test.measureInitializationTime3(1024 * 1024 * 2 , 10);</span>
      }
  
      void checkSubElementAPI() {
<span class="line-modified">!         Throwable e = null;</span>
<span class="line-modified">!         ValueWithOops[] arrayWithOops = new ValueWithOops[100];</span>
<span class="line-modified">!         ValueWithOops v = new ValueWithOops();</span>
<span class="line-modified">!         for (int i = 0; i &lt; 100; i++) {</span>
<span class="line-modified">!             arrayWithOops[i] = v;</span>
<span class="line-modified">!         }</span>
<span class="line-modified">!         SubElementSelector selector1 = createSubElementSelector(arrayWithOops);</span>
<span class="line-modified">!         SubElementSelector selector2 = getSubElementSelector(selector1, ValueWithOops.class, &quot;s&quot;, &quot;Ljava/lang/String;&quot;);</span>
<span class="line-modified">!         String s = (String) getObjectSubElement(arrayWithOops, selector2, 1);</span>
<span class="line-modified">!         System.out.println(&quot;s = &quot; + s);</span>
<span class="line-modified">!         Asserts.assertEquals(s.equals(&quot;bonjour&quot;), true, &quot;Wrong string, expecting \&quot;bonjour\&quot;, got &quot; + s);</span>
<span class="line-modified">!         SubElementSelector selector3 = getSubElementSelector(selector1, ValueWithOops.class, &quot;c&quot;, &quot;QTestJNIArrays$Containee;&quot;);</span>
<span class="line-modified">!         Containee c = (Containee) getObjectSubElement(arrayWithOops, selector3, 2);</span>
<span class="line-modified">!         Asserts.assertEquals(c.f, 2.3f, &quot;Wrong float value: &quot; + c.f);</span>
<span class="line-modified">!         Asserts.assertEquals(c.s, (short)4, &quot;Wrong short value &quot; + c.s);</span>
<span class="line-modified">!         setObjectSubElement(arrayWithOops, selector2, 1, &quot;Hello&quot;);</span>
<span class="line-modified">!         Asserts.assertEquals(arrayWithOops[1].s.equals(&quot;Hello&quot;), true, &quot;Wrong string, expecting \&quot;Hello\&quot;, got &quot; + s);</span>
<span class="line-modified">!         Integer myInteger = new Integer(345);</span>
<span class="line-modified">!         e = null;</span>
<span class="line-modified">!         try {</span>
<span class="line-modified">!             setObjectSubElement(arrayWithOops, selector2, 1, myInteger);</span>
<span class="line-modified">!         } catch(Throwable t) {</span>
<span class="line-modified">!             e = t;</span>
<span class="line-modified">!         }</span>
<span class="line-modified">!         Asserts.assertNotNull(e, &quot;An exception should have been thrown&quot;);</span>
<span class="line-modified">!         Asserts.assertEquals(e.getClass(), java.lang.ArrayStoreException.class, &quot;Wrong exception type&quot;);</span>
<span class="line-modified">!         c = new Containee(9.8f, (short)-3);</span>
<span class="line-modified">!         setObjectSubElement(arrayWithOops, selector3, 2, c);</span>
<span class="line-modified">!         Asserts.assertEquals(c.f, 9.8f, &quot;Wrong float value: &quot; + c.f);</span>
<span class="line-modified">!         Asserts.assertEquals(c.s, (short)-3, &quot;Wrong short value &quot; + c.s);</span>
<span class="line-modified">!         e = null;</span>
<span class="line-modified">!         try {</span>
<span class="line-modified">!             setObjectSubElement(arrayWithOops, selector3, 2, null);</span>
<span class="line-modified">!         } catch(Throwable t) {</span>
<span class="line-modified">!             e = t;</span>
<span class="line-modified">!         }</span>
<span class="line-modified">!         Asserts.assertNotNull(e, &quot;An exception should have been thrown&quot;);</span>
<span class="line-modified">!         Asserts.assertEquals(e.getClass(), java.lang.ArrayStoreException.class, &quot;Wrong exception type&quot;);</span>
<span class="line-modified">!         SubElementSelector selector4 = getSubElementSelector(selector3, TestJNIArrays.Containee.class, &quot;s&quot;, &quot;S&quot;);</span>
<span class="line-modified">!         short s2 = getShortSubElement(arrayWithOops, selector4, 3);</span>
<span class="line-modified">!         Asserts.assertEquals(s2, (short)4, &quot;Wrong short value &quot; + s2);</span>
<span class="line-modified">!         setShortSubElement(arrayWithOops, selector4, 3, (short)7);</span>
<span class="line-modified">!         Asserts.assertEquals(arrayWithOops[3].c.s, (short)7, &quot;Wrong short value &quot; + arrayWithOops[3].c.s);</span>
<span class="line-modified">!         e = null;</span>
<span class="line-modified">!         try {</span>
<span class="line-modified">!             // should fail because selector4 designates a field with type short, not int</span>
<span class="line-modified">!             getIntSubElement(arrayWithOops, selector4, 3);</span>
<span class="line-modified">!         } catch(Throwable t) {</span>
<span class="line-modified">!             e = t;</span>
<span class="line-modified">!         }</span>
<span class="line-modified">!         Asserts.assertNotNull(e, &quot;An exception should have been thrown&quot;);</span>
<span class="line-modified">!         Asserts.assertEquals(e.getClass(), java.lang.IllegalArgumentException.class, &quot;Wrong exception type&quot;);</span>
<span class="line-modified">!         SubElementSelector selector5 = getSubElementSelector(selector1, ValueWithOops.class, &quot;b&quot;, &quot;QTestJNIArrays$BigValue;&quot;);</span>
<span class="line-modified">!         e = null;</span>
<span class="line-modified">!         try {</span>
<span class="line-modified">!             // Should fail because selector5 designates a non-flattened field</span>
<span class="line-modified">!             SubElementSelector selector6 = getSubElementSelector(selector5, TestJNIArrays.BigValue.class, &quot;l0&quot;, &quot;J&quot;);</span>
<span class="line-modified">!         } catch(Throwable t) {</span>
<span class="line-modified">!             e = t;</span>
<span class="line-modified">!         }</span>
<span class="line-modified">!         Asserts.assertNotNull(e, &quot;An exception should have been thrown&quot;);</span>
<span class="line-modified">!         Asserts.assertEquals(e.getClass(), java.lang.IllegalArgumentException.class, &quot;Wrong exception type&quot;);</span>
<span class="line-modified">!         System.gc();</span>
      }
<span class="line-modified">! </span>
      void checkGetFlattenedArrayElementSize() {
<span class="line-modified">!         Throwable exception = null;</span>
<span class="line-modified">!         try {</span>
<span class="line-modified">!             Object o = new Object();</span>
<span class="line-modified">!             GetFlattenedArrayElementSizeWrapper(o);</span>
<span class="line-modified">!         } catch(Throwable t) {</span>
<span class="line-modified">!             exception = t;</span>
<span class="line-modified">!         }</span>
<span class="line-modified">!         Asserts.assertNotNull(exception, &quot;An IAE should have been thrown&quot;);</span>
<span class="line-modified">!         Asserts.assertEquals(exception.getClass(), IllegalArgumentException.class , &quot;Wrong exception type&quot;);</span>
<span class="line-modified">!         exception = null;</span>
<span class="line-modified">!         try {</span>
<span class="line-modified">!             int[] array = new int[16];</span>
<span class="line-modified">!             Object o = array;</span>
<span class="line-modified">!             GetFlattenedArrayElementSizeWrapper(o);</span>
<span class="line-modified">!         } catch(Throwable t) {</span>
<span class="line-modified">!             exception = t;</span>
<span class="line-modified">!         }</span>
<span class="line-modified">!         Asserts.assertNotNull(exception, &quot;An IAE should have been thrown&quot;);</span>
<span class="line-modified">!         Asserts.assertEquals(exception.getClass(), IllegalArgumentException.class , &quot;Wrong exception type&quot;);</span>
<span class="line-modified">!         exception = null;</span>
<span class="line-modified">!         try {</span>
<span class="line-modified">!             GetFlattenedArrayElementSizeWrapper(new String[16]);</span>
<span class="line-modified">!         } catch(Throwable t) {</span>
<span class="line-modified">!             exception = t;</span>
<span class="line-modified">!         }</span>
<span class="line-modified">!         Asserts.assertNotNull(exception, &quot;An IAE should have been thrown&quot;);</span>
<span class="line-modified">!         Asserts.assertEquals(exception.getClass(), IllegalArgumentException.class , &quot;Wrong exception type&quot;);</span>
<span class="line-modified">!         exception = null;</span>
<span class="line-modified">!         try {</span>
<span class="line-modified">!             // Array of BigValue should not be flattened because BigValue is *big*</span>
<span class="line-modified">!             GetFlattenedArrayElementSizeWrapper(new BigValue[16]);</span>
<span class="line-modified">!         } catch(Throwable t) {</span>
<span class="line-modified">!             exception = t;</span>
<span class="line-modified">!         }</span>
<span class="line-modified">!         Asserts.assertNotNull(exception, &quot;An IAE should have been thrown&quot;);</span>
<span class="line-modified">!         Asserts.assertTrue(exception instanceof IllegalArgumentException , &quot;Exception should be a IAE&quot;);</span>
<span class="line-modified">!         exception = null;</span>
<span class="line-modified">!         int size = -1;</span>
<span class="line-modified">!         try {</span>
<span class="line-modified">!             size = GetFlattenedArrayElementSizeWrapper(new IntInt[16]);</span>
<span class="line-modified">!         } catch(Throwable t) {</span>
<span class="line-modified">!             exception = t;</span>
<span class="line-modified">!         }</span>
<span class="line-modified">!         Asserts.assertNull(exception, &quot;No exception should have been thrown&quot;);</span>
<span class="line-modified">!         Asserts.assertEquals(size, 8, &quot;Wrong size&quot;);</span>
      }
  
      void checkGetFlattenedArrayElementClass() {
<span class="line-modified">!         Throwable exception = null;</span>
<span class="line-modified">!         try {</span>
<span class="line-modified">!             Object o = new Object();</span>
<span class="line-modified">!             GetFlattenedArrayElementClassWrapper(o);</span>
<span class="line-modified">!         } catch(Throwable t) {</span>
<span class="line-modified">!             exception = t;</span>
<span class="line-modified">!         }</span>
<span class="line-modified">!         Asserts.assertNotNull(exception, &quot;An IAE should have been thrown&quot;);</span>
<span class="line-modified">!         Asserts.assertEquals(exception.getClass(), IllegalArgumentException.class , &quot;Wrong exception type&quot;);</span>
<span class="line-modified">!         exception = null;</span>
<span class="line-modified">!         try {</span>
<span class="line-modified">!             int[] array = new int[16];</span>
<span class="line-modified">!             Object o = array;</span>
<span class="line-modified">!             GetFlattenedArrayElementClassWrapper(o);</span>
<span class="line-modified">!         } catch(Throwable t) {</span>
<span class="line-modified">!             exception = t;</span>
<span class="line-modified">!         }</span>
<span class="line-modified">!         Asserts.assertNotNull(exception, &quot;An IAE should have been thrown&quot;);</span>
<span class="line-modified">!         Asserts.assertEquals(exception.getClass(), IllegalArgumentException.class , &quot;Wrong exception type&quot;);</span>
<span class="line-modified">!         exception = null;</span>
<span class="line-modified">!         try {</span>
<span class="line-modified">!             GetFlattenedArrayElementClassWrapper(new String[16]);</span>
<span class="line-modified">!         } catch(Throwable t) {</span>
<span class="line-modified">!             exception = t;</span>
<span class="line-modified">!         }</span>
<span class="line-modified">!         Asserts.assertNotNull(exception, &quot;An IAE should have been thrown&quot;);</span>
<span class="line-modified">!         Asserts.assertEquals(exception.getClass(), IllegalArgumentException.class , &quot;Wrong exception type&quot;);</span>
<span class="line-modified">!         exception = null;</span>
<span class="line-modified">!         try {</span>
<span class="line-modified">!             // Array of BigValue should not be flattened because BigValue is *big*</span>
<span class="line-modified">!             GetFlattenedArrayElementClassWrapper(new BigValue[16]);</span>
<span class="line-modified">!         } catch(Throwable t) {</span>
<span class="line-modified">!             exception = t;</span>
<span class="line-modified">!         }</span>
<span class="line-modified">!         Asserts.assertNotNull(exception, &quot;An IAE should have been thrown&quot;);</span>
<span class="line-modified">!         Asserts.assertTrue(exception instanceof IllegalArgumentException , &quot;Exception should be a IAE&quot;);</span>
<span class="line-modified">!         exception = null;</span>
<span class="line-modified">!         Class c = null;</span>
<span class="line-modified">!         try {</span>
<span class="line-modified">!             c = GetFlattenedArrayElementClassWrapper(new IntInt[16]);</span>
<span class="line-modified">!         } catch(Throwable t) {</span>
<span class="line-modified">!             exception = t;</span>
<span class="line-modified">!         }</span>
<span class="line-modified">!         Asserts.assertNull(exception, &quot;No exception should have been thrown&quot;);</span>
<span class="line-modified">!         Asserts.assertEquals(c, IntInt.class, &quot;Wrong class&quot;);</span>
      }
  
      void checkGetFieldOffsetInFlattenedLayout() {
<span class="line-modified">!         Throwable exception = null;</span>
<span class="line-modified">!         try {</span>
<span class="line-modified">!             Object o = new Object();</span>
<span class="line-modified">!             GetFieldOffsetInFlattenedLayoutWrapper(o.getClass(), &quot;foo&quot;, &quot;I&quot;, true);</span>
<span class="line-modified">!         } catch(Throwable t) {</span>
<span class="line-modified">!             exception = t;</span>
<span class="line-modified">!         }</span>
<span class="line-modified">!         Asserts.assertNotNull(exception, &quot;An IAE should have been thrown&quot;);</span>
<span class="line-modified">!         Asserts.assertEquals(exception.getClass(), IllegalArgumentException.class , &quot;Wrong exception type&quot;);</span>
<span class="line-modified">!         exception = null;</span>
<span class="line-modified">!         try {</span>
<span class="line-modified">!             int[] array = new int[16];</span>
<span class="line-modified">!             GetFieldOffsetInFlattenedLayoutWrapper(array.getClass(), &quot;foo&quot;, &quot;I&quot;, true);</span>
<span class="line-modified">!         } catch(Throwable t) {</span>
<span class="line-modified">!             exception = t;</span>
<span class="line-modified">!         }</span>
<span class="line-modified">!         Asserts.assertNotNull(exception, &quot;An IAE should have been thrown&quot;);</span>
<span class="line-modified">!         Asserts.assertEquals(exception.getClass(), IllegalArgumentException.class , &quot;Wrong exception type&quot;);</span>
<span class="line-modified">!         exception = null;</span>
<span class="line-modified">!         try {</span>
<span class="line-modified">!             String[] array = new String[16];</span>
<span class="line-modified">!             GetFieldOffsetInFlattenedLayoutWrapper(array.getClass(), &quot;foo&quot;, &quot;I&quot;, true);</span>
<span class="line-modified">!         } catch(Throwable t) {</span>
<span class="line-modified">!             exception = t;</span>
<span class="line-modified">!         }</span>
<span class="line-modified">!         Asserts.assertNotNull(exception, &quot;An IAE should have been thrown&quot;);</span>
<span class="line-modified">!         Asserts.assertEquals(exception.getClass(), IllegalArgumentException.class , &quot;Wrong exception type&quot;);</span>
<span class="line-modified">!         exception = null;</span>
<span class="line-modified">!         Containee ce  = new Containee(3.4f, (short)5);</span>
<span class="line-modified">!         Container c = new Container(123.876, ce, (byte)7);</span>
<span class="line-modified">!         Class&lt;?&gt; cclass = c.getClass();</span>
<span class="line-modified">!         Container[] containerArray = new Container[32];</span>
<span class="line-modified">!         int elementSize = GetFlattenedArrayElementSizeWrapper(containerArray);</span>
<span class="line-modified">!         int offset = -1;</span>
<span class="line-modified">!         try {</span>
<span class="line-modified">!             offset = GetFieldOffsetInFlattenedLayoutWrapper(cclass, &quot;d&quot;, &quot;D&quot;, false);</span>
<span class="line-modified">!         } catch(Throwable t) {</span>
<span class="line-modified">!             exception = t;</span>
<span class="line-modified">!         }</span>
<span class="line-modified">!         Asserts.assertNull(exception, &quot;No exception should have been thrown&quot;);</span>
<span class="line-modified">!         Field f = null;</span>
<span class="line-modified">!         try {</span>
<span class="line-modified">!             f = cclass.getDeclaredField(&quot;d&quot;);</span>
<span class="line-modified">!         } catch(NoSuchFieldException e) {</span>
<span class="line-modified">!             e.printStackTrace();</span>
<span class="line-modified">!             return;</span>
<span class="line-modified">!         }</span>
<span class="line-modified">!         Asserts.assertEquals(U.valueHeaderSize(cclass) + offset, U.objectFieldOffset(cclass, f.getName()),</span>
<span class="line-modified">!                              &quot;Incorrect offset&quot;);</span>
<span class="line-modified">!         Asserts.assertLessThan(offset, elementSize, &quot;Invalid offset&quot;);</span>
<span class="line-modified">!         exception = null;</span>
<span class="line-modified">!         try {</span>
<span class="line-modified">!             // Field c should be flattened, so last argument is true, no exception expected</span>
<span class="line-modified">!             GetFieldOffsetInFlattenedLayoutWrapper(cclass, &quot;c&quot;, &quot;QTestJNIArrays$Containee;&quot;, true);</span>
<span class="line-modified">!         } catch(Throwable t) {</span>
<span class="line-modified">!             exception = t;</span>
<span class="line-modified">!         }</span>
<span class="line-modified">!         Asserts.assertNull(exception, &quot;No exception should have been thrown&quot;);</span>
<span class="line-modified">!         Asserts.assertLessThan(offset, elementSize, &quot;Invalid offset&quot;);</span>
<span class="line-modified">!         exception = null;</span>
<span class="line-modified">!         try {</span>
<span class="line-modified">!             // Field c should be flattened, with last argument being false, exception expected from the wrapper</span>
<span class="line-modified">!             GetFieldOffsetInFlattenedLayoutWrapper(cclass, &quot;c&quot;, &quot;QTestJNIArrays$Containee;&quot;, false);</span>
<span class="line-modified">!         } catch(Throwable t) {</span>
<span class="line-modified">!             exception = t;</span>
<span class="line-modified">!         }</span>
<span class="line-modified">!         Asserts.assertNotNull(exception, &quot;Wrapper should have thrown a RuntimeException&quot;);</span>
<span class="line-modified">!         Asserts.assertEquals(exception.getClass(), RuntimeException.class , &quot;Wrong exception type&quot;);</span>
      }
<span class="line-modified">! </span>
<span class="line-modified">!     void checkGetFlattenedArrayElements() {</span>
<span class="line-modified">!         Throwable exception = null;</span>
<span class="line-modified">!         Object o = new Object();</span>
<span class="line-modified">!         try {</span>
<span class="line-modified">!             GetFlattenedArrayElementsWrapper(o);</span>
<span class="line-modified">!         } catch(Throwable t) {</span>
<span class="line-modified">!             exception = t;</span>
<span class="line-modified">!         }</span>
<span class="line-modified">!         Asserts.assertNotNull(exception, &quot;An IAE should have been thrown&quot;);</span>
<span class="line-modified">!         Asserts.assertEquals(exception.getClass(), IllegalArgumentException.class , &quot;Wrong exception type&quot;);</span>
<span class="line-modified">!         exception = null;</span>
<span class="line-modified">!         int[] a1 = new int[16];</span>
<span class="line-modified">!         o = a1;</span>
<span class="line-modified">!         try {</span>
<span class="line-modified">!             GetFlattenedArrayElementsWrapper(o);</span>
<span class="line-modified">!         } catch(Throwable t) {</span>
<span class="line-modified">!             exception = t;</span>
<span class="line-modified">!         }</span>
<span class="line-modified">!         Asserts.assertNotNull(exception, &quot;An IAE should have been thrown&quot;);</span>
<span class="line-modified">!         Asserts.assertEquals(exception.getClass(), IllegalArgumentException.class , &quot;Wrong exception type&quot;);</span>
<span class="line-modified">!         exception = null;</span>
<span class="line-modified">!         try {</span>
<span class="line-modified">!             GetFlattenedArrayElementsWrapper(new String[16]);</span>
<span class="line-modified">!         } catch(Throwable t) {</span>
<span class="line-modified">!             exception = t;</span>
<span class="line-modified">!         }</span>
<span class="line-modified">!         Asserts.assertNotNull(exception, &quot;An IAE should have been thrown&quot;);</span>
<span class="line-modified">!         Asserts.assertEquals(exception.getClass(), IllegalArgumentException.class , &quot;Wrong exception type&quot;);</span>
<span class="line-modified">!         exception = null;</span>
<span class="line-modified">!         try {</span>
<span class="line-modified">!             // Array of BigValue should not be flattened because BigValue is *big*</span>
<span class="line-modified">!             GetFlattenedArrayElementsWrapper(new BigValue[16]);</span>
<span class="line-modified">!         } catch(Throwable t) {</span>
<span class="line-modified">!             exception = t;</span>
<span class="line-modified">!         }</span>
<span class="line-modified">!         Asserts.assertNotNull(exception, &quot;An IAE should have been thrown&quot;);</span>
<span class="line-modified">!         Asserts.assertTrue(exception instanceof IllegalArgumentException , &quot;Exception should be a IAE&quot;);</span>
<span class="line-modified">!         exception = null;</span>
<span class="line-modified">!         try {</span>
<span class="line-modified">!             // Direct native access to flattened arrays is not allowed if elements contain oops</span>
<span class="line-modified">!             GetFlattenedArrayElementsWrapper(new ValueWithOops[16]);</span>
<span class="line-modified">!         } catch(Throwable t) {</span>
<span class="line-modified">!             exception = t;</span>
<span class="line-modified">!         }</span>
<span class="line-modified">!         Asserts.assertNotNull(exception, &quot;An IAE should have been thrown&quot;);</span>
<span class="line-modified">!         Asserts.assertTrue(exception instanceof IllegalArgumentException , &quot;Exception should be a IAE&quot;);</span>
<span class="line-modified">!         exception = null;</span>
<span class="line-modified">!         long addr = 0;</span>
<span class="line-modified">!         IntInt[] a2 = new IntInt[16];</span>
<span class="line-modified">!         try {</span>
<span class="line-modified">!             addr = GetFlattenedArrayElementsWrapper(a2);</span>
<span class="line-modified">!         } catch(Throwable t) {</span>
<span class="line-modified">!             exception = t;</span>
<span class="line-modified">!         }</span>
<span class="line-modified">!         Asserts.assertNull(exception, &quot;No exception should have been thrown&quot;);</span>
<span class="line-modified">!         if (exception == null) {</span>
<span class="line-modified">!             ReleaseFlattenedArrayElementsWrapper(a2, addr, 0);</span>
<span class="line-modified">!         }</span>
      }
<span class="line-modified">! </span>
      void checkBehaviors() {
<span class="line-modified">!         System.out.println(&quot;Check 1&quot;);</span>
<span class="line-modified">!         IntInt[] array = new IntInt[ARRAY_SIZE];</span>
<span class="line-modified">!         int value = getIntFieldAtIndex(array, 1, &quot;i0&quot;, &quot;I&quot;);</span>
<span class="line-modified">!         Asserts.assertEquals(value, 0, &quot;Initial value must be zero&quot;);</span>
<span class="line-modified">!         printArrayInformation(array);</span>
<span class="line-modified">!         int i0_value = 42;</span>
<span class="line-modified">!         int i1_value = -314;</span>
<span class="line-modified">!         initializeIntIntArrayBuffer(array, i0_value, i1_value);</span>
<span class="line-modified">!         System.gc();</span>
<span class="line-modified">!         for (int i = 0; i &lt; array.length; i++) {</span>
<span class="line-modified">!             Asserts.assertEquals(array[i].i0, i0_value, &quot;Bad value of i0 at index &quot; + i);</span>
<span class="line-modified">!             Asserts.assertEquals(array[i].i1, i1_value, &quot;Bad value of i1 at index &quot; + i);</span>
<span class="line-modified">!         }</span>
<span class="line-modified">!         System.out.println(&quot;Check 2&quot;);</span>
<span class="line-modified">!         array = new IntInt[ARRAY_SIZE];</span>
<span class="line-modified">!         i0_value = -194;</span>
<span class="line-modified">!         i1_value = 91;</span>
<span class="line-modified">!         initializeIntIntArrayFields(array, i0_value, i1_value);</span>
<span class="line-modified">!         System.gc();</span>
<span class="line-modified">!         for (int i = 0; i &lt; array.length; i++) {</span>
<span class="line-modified">!             Asserts.assertEquals(array[i].i0, i0_value, &quot;Bad value of i0 at index &quot; + i);</span>
<span class="line-modified">!             Asserts.assertEquals(array[i].i1, i1_value, &quot;Bad value of i1 at index &quot; + i);</span>
<span class="line-modified">!         }</span>
<span class="line-modified">!         System.out.println(&quot;Check 3&quot;);</span>
<span class="line-modified">!         array = new IntInt[ARRAY_SIZE];</span>
<span class="line-modified">!         initializeIntIntArrayJava(array, i0_value, i1_value);</span>
<span class="line-modified">!         System.gc();</span>
<span class="line-modified">!         for (int i = 0; i &lt; array.length; i++) {</span>
<span class="line-modified">!             Asserts.assertEquals(array[i].i0, i0_value, &quot;Bad value of i0 at index &quot; + i);</span>
<span class="line-modified">!             Asserts.assertEquals(array[i].i1, i1_value, &quot;Bad value of i1 at index &quot; + i);</span>
<span class="line-modified">!         }</span>
<span class="line-modified">!         System.out.println(&quot;Check 4&quot;);</span>
<span class="line-modified">!         random = new Random(seed);</span>
<span class="line-modified">!         array = new IntInt[ARRAY_SIZE];</span>
<span class="line-modified">!         for (int i = 0; i &lt; ARRAY_SIZE; i++) {</span>
<span class="line-modified">!             array[i] = new IntInt(random.nextInt(), random.nextInt());</span>
<span class="line-modified">!         }</span>
<span class="line-modified">!         sortIntIntArray(array);</span>
<span class="line-modified">!         System.gc();</span>
<span class="line-modified">!         for (int i = 0; i &lt; array.length - 1; i++) {</span>
<span class="line-modified">!             Asserts.assertLessThanOrEqual(array[i].i0, array[i+1].i0, &quot;Incorrect i0 fields ordering at index &quot; + i);</span>
<span class="line-modified">!             if (array[i].i0 == array[i+1].i0) {</span>
<span class="line-modified">!                 Asserts.assertLessThanOrEqual(array[i].i1, array[i+1].i1, &quot;Incorrect i1 fields ordering at index &quot; + i);</span>
<span class="line-modified">!             }</span>
<span class="line-modified">!         }</span>
<span class="line-modified">!         System.out.println(&quot;Check 5&quot;);</span>
<span class="line-modified">!         random = new Random(seed);</span>
<span class="line-modified">!         array = new IntInt[ARRAY_SIZE];</span>
<span class="line-modified">!         for (int i = 0; i &lt; ARRAY_SIZE; i++) {</span>
<span class="line-modified">!             array[i] = new IntInt(random.nextInt(), random.nextInt());</span>
<span class="line-modified">!         }</span>
<span class="line-modified">!         Arrays.sort(array, new IntIntComparator());</span>
<span class="line-modified">!         System.gc();</span>
<span class="line-modified">!         for (int i = 0; i &lt; array.length - 1; i++) {</span>
<span class="line-modified">!             Asserts.assertLessThanOrEqual(array[i].i0, array[i+1].i0, &quot;Incorrect i0 fields ordering at index &quot; + i);</span>
<span class="line-modified">!             if (array[i].i0 == array[i+1].i0) {</span>
<span class="line-modified">!                 Asserts.assertLessThanOrEqual(array[i].i1, array[i+1].i1, &quot;Incorrect i1 fields ordering at index &quot; + i);</span>
<span class="line-modified">!             }</span>
<span class="line-modified">!         }</span>
<span class="line-modified">!         System.out.println(&quot;Check 6&quot;);</span>
<span class="line-modified">!         Container[] array2 = new Container[ARRAY_SIZE];</span>
<span class="line-modified">!         double d  = 1.23456789;</span>
<span class="line-modified">!         float f = -987.654321f;</span>
<span class="line-modified">!         short s = -512;</span>
<span class="line-modified">!         byte b = 127;</span>
<span class="line-modified">!         Containee c = new Containee(f,s);</span>
<span class="line-modified">!         Container c2 = new Container(d, c, b);</span>
<span class="line-modified">!         initializeContainerArray(array2, d, f, s, b);</span>
<span class="line-modified">!         System.gc();</span>
<span class="line-modified">!         for (int i = 0; i &lt; array2.length; i++) {</span>
<span class="line-modified">!             Asserts.assertEquals(array2[i], c2, &quot;Incorrect value at index &quot; + i);</span>
<span class="line-modified">!             Asserts.assertEquals(array2[i].d, d, &quot;Incorrect d value at index &quot; + i);</span>
<span class="line-modified">!             Asserts.assertEquals(array2[i].c.f, f, &quot;Incorrect f value at index &quot; + i);</span>
<span class="line-modified">!             Asserts.assertEquals(array2[i].c.s, s, &quot;Incorrect s value at index &quot; + i);</span>
<span class="line-modified">!             Asserts.assertEquals(array2[i].b, b, &quot;Incorrect b value at inde &quot; +i);</span>
<span class="line-modified">!         }</span>
<span class="line-modified">!         System.out.println(&quot;Check 7&quot;);</span>
<span class="line-modified">!         f = 19.2837465f;</span>
<span class="line-modified">!         s = 231;</span>
<span class="line-modified">!         updateContainerArray(array2, f, s);</span>
<span class="line-modified">!         System.gc();</span>
<span class="line-modified">!         for (int i = 0; i &lt; array2.length; i++) {</span>
<span class="line-modified">!             Asserts.assertEquals(array2[i].d, d, &quot;Incorrect d value at index &quot; + i);</span>
<span class="line-modified">!             Asserts.assertEquals(array2[i].c.f, f, &quot;Incorrect f value at index &quot; + i);</span>
<span class="line-modified">!             Asserts.assertEquals(array2[i].c.s, s, &quot;Incorrect s value at index &quot; + i);</span>
<span class="line-modified">!             Asserts.assertEquals(array2[i].b, b, &quot;Incorrect b value at inde &quot; +i);</span>
<span class="line-modified">!         }</span>
<span class="line-modified">!         System.out.println(&quot;Check 8&quot;);</span>
<span class="line-modified">!         long l0 = 52467923;</span>
<span class="line-modified">!         long l1= -7854022;</span>
<span class="line-modified">!         long l2 = 230947485;</span>
<span class="line-modified">!         long l3 = -752497024;</span>
<span class="line-modified">!         LongLongLongLong[] array3 = new LongLongLongLong[ARRAY_SIZE/8];</span>
<span class="line-modified">!         initializeLongLongLongLongArray(array3, l0, l1, l2, l3);</span>
<span class="line-modified">!         System.gc();</span>
<span class="line-modified">!         for (int i = 0; i &lt; array3.length; i++) {</span>
<span class="line-modified">!             Asserts.assertEquals(array3[i].l0, l0, &quot;Bad value of l0 at index &quot; + i);</span>
<span class="line-modified">!             Asserts.assertEquals(array3[i].l1, l1, &quot;Bad value of l1 at index &quot; + i);</span>
<span class="line-modified">!             Asserts.assertEquals(array3[i].l2, l2, &quot;Bad value of l2 at index &quot; + i);</span>
<span class="line-modified">!             Asserts.assertEquals(array3[i].l3, l3, &quot;Bad value of l3 at index &quot; + i);</span>
<span class="line-modified">!         }</span>
      }
  
      void initializeIntIntArrayJava(IntInt[] array, int i0, int i1) {
<span class="line-modified">!         IntInt ii = new IntInt(i0, i1);</span>
<span class="line-modified">!         for (int i = 0; i &lt; array.length; i++) {</span>
<span class="line-modified">!             array[i] = ii;</span>
<span class="line-modified">!         }</span>
      }
  
      void initializeContainerArrayJava(Container[] array, double d, float f, short s, byte b) {
<span class="line-modified">!         Containee c = new Containee(f,s);</span>
<span class="line-modified">!         Container c2 = new Container(d, c, b);</span>
<span class="line-modified">!         for (int i = 0; i &lt; array.length; i++) {</span>
<span class="line-modified">!             array[i] = c2;</span>
<span class="line-modified">!         }</span>
      }
  
      void updateContainerArrayJava(Container[] array, float f, short s) {
<span class="line-modified">!         Containee c = new Containee(f, s);</span>
<span class="line-modified">!         for (int i = 0; i &lt; array.length; i++) {</span>
<span class="line-modified">!             array[i] = array[i].setc(c);;</span>
<span class="line-modified">!         }</span>
      }
  
      void initializeLongLongLongLongArrayJava(LongLongLongLong[] array, long l0, long l1, long l2, long l3) {
<span class="line-modified">!         LongLongLongLong llll = new LongLongLongLong(l0, l1, l2, l3);</span>
<span class="line-modified">!         for (int i = 0; i &lt; array.length; i++) {</span>
<span class="line-modified">!             array[i] = llll;</span>
<span class="line-modified">!         }</span>
      }
<span class="line-modified">! </span>
<span class="line-modified">!     void measureInitializationTime(int array_size, int iterations) {</span>
<span class="line-modified">!         System.out.println(&quot;\nInitialization time for IntInt[]:&quot;);</span>
<span class="line-modified">!         long[] start = new long[iterations];</span>
<span class="line-modified">!         long[] end = new long[iterations];</span>
<span class="line-modified">! </span>
<span class="line-modified">! </span>
<span class="line-modified">!         System.out.println(&quot;\nJava:&quot;);</span>
<span class="line-modified">!         // Warmup</span>
<span class="line-modified">!         for (int i = 0; i &lt; 10; i++) {</span>
<span class="line-modified">!             IntInt[] array = new IntInt[array_size];</span>
<span class="line-modified">!             initializeIntIntArrayJava(array, 42, -314);</span>
<span class="line-modified">!         }</span>
<span class="line-modified">!         // Measure</span>
<span class="line-modified">!         for (int i = 0; i &lt; iterations; i++) {</span>
<span class="line-modified">!             IntInt[] array = new IntInt[array_size];</span>
<span class="line-modified">!             start[i] = System.nanoTime();</span>
<span class="line-modified">!             initializeIntIntArrayJava(array, 42, -314);</span>
<span class="line-modified">!             end[i] = System.nanoTime();</span>
<span class="line-modified">!         }</span>
<span class="line-modified">!         // Results</span>
<span class="line-modified">!         computeStatistics(start, end);</span>
<span class="line-modified">! </span>
<span class="line-modified">!         System.out.println(&quot;\nNative(memcpy):&quot;);</span>
<span class="line-modified">!         // Warmup</span>
<span class="line-modified">!         for (int i = 0; i &lt; 10; i++) {</span>
<span class="line-modified">!             IntInt[] array = new IntInt[array_size];</span>
<span class="line-modified">!             initializeIntIntArrayBuffer(array, 42, -314);</span>
<span class="line-modified">!         }</span>
<span class="line-modified">!         // Measure</span>
<span class="line-modified">!         for (int i = 0; i &lt; iterations; i++) {</span>
<span class="line-modified">!             IntInt[] array = new IntInt[array_size];</span>
<span class="line-modified">!             start[i] = System.nanoTime();</span>
<span class="line-modified">!             initializeIntIntArrayBuffer(array, 42, -314);</span>
<span class="line-modified">!             end[i] = System.nanoTime();</span>
<span class="line-modified">!         }</span>
<span class="line-modified">!         // Results</span>
<span class="line-modified">!         computeStatistics(start, end);</span>
<span class="line-modified">! </span>
<span class="line-modified">! </span>
<span class="line-modified">!         System.out.println(&quot;\nNative(fields):&quot;);</span>
<span class="line-modified">!         // Warmup</span>
<span class="line-modified">!         for (int i = 0; i &lt; 10; i++) {</span>
<span class="line-modified">!             IntInt[] array = new IntInt[array_size];</span>
<span class="line-modified">!             initializeIntIntArrayFields(array, 42, -314);</span>
<span class="line-modified">!         }</span>
<span class="line-modified">!         // Measure</span>
<span class="line-modified">!         for (int i = 0; i &lt; iterations; i++) {</span>
<span class="line-modified">!             IntInt[] array = new IntInt[array_size];</span>
<span class="line-modified">!             start[i] = System.nanoTime();</span>
<span class="line-modified">!             initializeIntIntArrayFields(array, 42, -314);</span>
<span class="line-modified">!             end[i] = System.nanoTime();</span>
<span class="line-modified">!         }</span>
<span class="line-modified">!         // Results</span>
<span class="line-modified">!         computeStatistics(start, end);</span>
      }
  
<span class="line-modified">!     void measureInitializationTime2(int array_size, int iterations) {</span>
<span class="line-modified">!         System.out.println(&quot;\nInitialization time for Container[]:&quot;);</span>
<span class="line-modified">!         long[] start = new long[iterations];</span>
<span class="line-modified">!         long[] end = new long[iterations];</span>
<span class="line-modified">! </span>
<span class="line-modified">!         double d = 0.369852147;</span>
<span class="line-modified">!         float f = -321.654987f;</span>
<span class="line-modified">!         short s = -3579;</span>
<span class="line-modified">!         byte b = 42;</span>
<span class="line-modified">! </span>
<span class="line-modified">!         System.out.println(&quot;\nJava:&quot;);</span>
<span class="line-modified">!         // Warmup</span>
<span class="line-modified">!         for (int i = 0; i &lt; 10; i++) {</span>
<span class="line-modified">!             Container[] array = new Container[array_size];</span>
<span class="line-modified">!             initializeContainerArrayJava(array, d, f, s, b);</span>
<span class="line-modified">!         }</span>
<span class="line-modified">!         // Measure</span>
<span class="line-modified">!         for (int i = 0; i &lt; iterations; i++) {</span>
<span class="line-modified">!             Container[] array = new Container[array_size];</span>
<span class="line-modified">!             start[i] = System.nanoTime();</span>
<span class="line-modified">!             initializeContainerArrayJava(array, d, f, s, b);</span>
<span class="line-modified">!             end[i] = System.nanoTime();</span>
<span class="line-modified">!         }</span>
<span class="line-modified">!         // Results</span>
<span class="line-modified">!         computeStatistics(start, end);</span>
<span class="line-modified">! </span>
<span class="line-modified">!         System.out.println(&quot;\nNative:&quot;);</span>
<span class="line-modified">!         // Warmup</span>
<span class="line-modified">!         for (int i = 0; i &lt; 10; i++) {</span>
<span class="line-modified">!             Container[] array = new Container[array_size];</span>
<span class="line-modified">!             initializeContainerArray(array, d, f, s, b);</span>
<span class="line-modified">!         }</span>
<span class="line-modified">!         // Measure</span>
<span class="line-modified">!         for (int i = 0; i &lt; iterations; i++) {</span>
<span class="line-modified">!             Container[] array = new Container[array_size];</span>
<span class="line-modified">!             start[i] = System.nanoTime();</span>
<span class="line-modified">!             initializeContainerArray(array, d, f, s, b);</span>
<span class="line-modified">!             end[i] = System.nanoTime();</span>
<span class="line-modified">!         }</span>
<span class="line-modified">!         // Results</span>
<span class="line-modified">!         computeStatistics(start, end);</span>
      }
  
<span class="line-modified">!     void measureUpdateTime2(int array_size, int iterations) {</span>
<span class="line-modified">!         System.out.println(&quot;\nUpdating Container[]:&quot;);</span>
<span class="line-modified">!         long[] start = new long[iterations];</span>
<span class="line-modified">!         long[] end = new long[iterations];</span>
<span class="line-modified">! </span>
<span class="line-modified">!         double d = 0.369852147;</span>
<span class="line-modified">!         float f = -321.654987f;</span>
<span class="line-modified">!         short s = -3579;</span>
<span class="line-modified">!         byte b = 42;</span>
<span class="line-modified">! </span>
<span class="line-modified">!         Containee c = new Containee(f,s);</span>
<span class="line-modified">!         Container c2 = new Container(d, c, b);</span>
<span class="line-modified">! </span>
<span class="line-modified">!         System.out.println(&quot;\nJava:&quot;);</span>
<span class="line-modified">!         // Warmup</span>
<span class="line-modified">!         for (int i = 0; i &lt; 10; i++) {</span>
<span class="line-modified">!             Container[] array = new Container[array_size];</span>
<span class="line-modified">!             for (int j = 0; j &lt; array.length; j++) {</span>
<span class="line-modified">!                 array[j] = c2;</span>
<span class="line-modified">!             }</span>
<span class="line-modified">!             updateContainerArrayJava(array, f, s);</span>
<span class="line-modified">!         }</span>
<span class="line-modified">!         // Measure</span>
<span class="line-modified">!         for (int i = 0; i &lt; iterations; i++) {</span>
<span class="line-modified">!             Container[] array = new Container[array_size];</span>
<span class="line-modified">!             for (int j = 0; j &lt; array.length; j++) {</span>
<span class="line-modified">!                 array[i] = c2;</span>
<span class="line-modified">!             }</span>
<span class="line-modified">!             start[i] = System.nanoTime();</span>
<span class="line-modified">!             updateContainerArrayJava(array, f, s);</span>
<span class="line-modified">!             end[i] = System.nanoTime();</span>
<span class="line-modified">!         }</span>
<span class="line-modified">!         // Results</span>
<span class="line-modified">!         computeStatistics(start, end);</span>
<span class="line-modified">! </span>
<span class="line-modified">!         System.out.println(&quot;\nNative:&quot;);</span>
<span class="line-modified">!         // Warmup</span>
<span class="line-modified">!         for (int i = 0; i &lt; 10; i++) {</span>
<span class="line-modified">!             Container[] array = new Container[array_size];</span>
<span class="line-modified">!             for (int j = 0; j &lt; array.length; j++) {</span>
<span class="line-modified">!                 array[i] = c2;</span>
<span class="line-modified">!             }</span>
<span class="line-modified">!             updateContainerArray(array, f, s);</span>
<span class="line-modified">!         }</span>
<span class="line-modified">!         // Measure</span>
<span class="line-modified">!         for (int i = 0; i &lt; iterations; i++) {</span>
<span class="line-modified">!             Container[] array = new Container[array_size];</span>
<span class="line-modified">!             for (int j = 0; j &lt; array.length; j++) {</span>
<span class="line-modified">!                 array[i] = c2;</span>
<span class="line-modified">!             }</span>
<span class="line-modified">!             start[i] = System.nanoTime();</span>
<span class="line-modified">!             updateContainerArray(array, f, s);</span>
<span class="line-modified">!             end[i] = System.nanoTime();</span>
<span class="line-modified">!         }</span>
<span class="line-modified">!         // Results</span>
<span class="line-modified">!         computeStatistics(start, end);</span>
      }
<span class="line-modified">! </span>
<span class="line-modified">!     void measureSortingTime(int array_size, int iterations) {</span>
<span class="line-modified">!         System.out.println(&quot;\nSorting time:&quot;);</span>
<span class="line-modified">!         long[] start = new long[iterations];</span>
<span class="line-modified">!         long[] end = new long[iterations];</span>
<span class="line-modified">! </span>
<span class="line-modified">!         random = new Random(seed);</span>
<span class="line-modified">!         System.out.println(&quot;\nJava:&quot;);</span>
<span class="line-modified">!         IntIntComparator comparator = new IntIntComparator();</span>
<span class="line-modified">!         // Warmup</span>
<span class="line-modified">!         for (int i = 0; i &lt; 10; i++) {</span>
<span class="line-modified">!             IntInt[] array = new IntInt[array_size];</span>
<span class="line-modified">!             array = new IntInt[array_size];</span>
<span class="line-modified">!             for (int j = 0; j &lt; array_size; j++) {</span>
<span class="line-modified">!                 array[j] = new IntInt(random.nextInt(), random.nextInt());</span>
<span class="line-modified">!             }</span>
<span class="line-modified">!             Arrays.sort(array, comparator);</span>
<span class="line-modified">!         }</span>
<span class="line-modified">!         // Measure</span>
<span class="line-modified">!         for (int i = 0; i &lt; iterations; i++) {</span>
<span class="line-modified">!             IntInt[] array = new IntInt[array_size];</span>
<span class="line-modified">!             for (int j = 0; j &lt; array_size; j++) {</span>
<span class="line-modified">!                 array[j] = new IntInt(random.nextInt(), random.nextInt());</span>
<span class="line-modified">!             }</span>
<span class="line-modified">!             start[i] = System.nanoTime();</span>
<span class="line-modified">!             Arrays.sort(array, comparator);</span>
<span class="line-modified">!             end[i] = System.nanoTime();</span>
<span class="line-modified">!         }</span>
<span class="line-modified">!         // Results</span>
<span class="line-modified">!         computeStatistics(start, end);</span>
<span class="line-modified">! </span>
<span class="line-modified">!         random = new Random(seed);</span>
<span class="line-modified">!         System.out.println(&quot;\nNative:&quot;);</span>
<span class="line-modified">!         // Warmup</span>
<span class="line-modified">!         for (int i = 0; i &lt; 10; i++) {</span>
<span class="line-modified">!             IntInt[] array = new IntInt[array_size];</span>
<span class="line-modified">!             array = new IntInt[array_size];</span>
<span class="line-modified">!             for (int j = 0; j &lt; array_size; j++) {</span>
<span class="line-modified">!                 array[j] = new IntInt(random.nextInt(), random.nextInt());</span>
<span class="line-modified">!             }</span>
<span class="line-modified">!             sortIntIntArray(array);</span>
<span class="line-modified">!         }</span>
<span class="line-modified">!         // Measure</span>
<span class="line-modified">!         for (int i = 0; i &lt; iterations; i++) {</span>
<span class="line-modified">!             IntInt[] array = new IntInt[array_size];</span>
<span class="line-modified">!             for (int j = 0; j &lt; array_size; j++) {</span>
<span class="line-modified">!                 array[j] = new IntInt(random.nextInt(), random.nextInt());</span>
<span class="line-modified">!             }</span>
<span class="line-modified">!             start[i] = System.nanoTime();</span>
<span class="line-modified">!             sortIntIntArray(array);</span>
<span class="line-modified">!             end[i] = System.nanoTime();</span>
<span class="line-modified">!         }</span>
<span class="line-modified">!         // Results</span>
<span class="line-modified">!         computeStatistics(start, end);</span>
      }
  
  
<span class="line-modified">!     void measureInitializationTime3(int array_size, int iterations) {</span>
<span class="line-modified">!         System.out.println(&quot;\nInitialization time for LongLongLongLong[]:&quot;);</span>
<span class="line-modified">!         long[] start = new long[iterations];</span>
<span class="line-modified">!         long[] end = new long[iterations];</span>
<span class="line-modified">! </span>
<span class="line-modified">!         long l0 = 123456;</span>
<span class="line-modified">!         long l1 = -987654;</span>
<span class="line-modified">!         long l2 = 192837;</span>
<span class="line-modified">!         long l3 = -56473829;</span>
<span class="line-modified">! </span>
<span class="line-modified">!         System.out.println(&quot;\nJava:&quot;);</span>
<span class="line-modified">!         // Warmup</span>
<span class="line-modified">!         for (int i = 0; i &lt; 10; i++) {</span>
<span class="line-modified">!             LongLongLongLong[] array = new LongLongLongLong[array_size];</span>
<span class="line-modified">!             initializeLongLongLongLongArrayJava(array, l0, l1, l2, l3);</span>
<span class="line-modified">!         }</span>
<span class="line-modified">!         // Measure</span>
<span class="line-modified">!         for (int i = 0; i &lt; iterations; i++) {</span>
<span class="line-modified">!             LongLongLongLong[] array = new LongLongLongLong[array_size];</span>
<span class="line-modified">!             start[i] = System.nanoTime();</span>
<span class="line-modified">!             initializeLongLongLongLongArrayJava(array, l0, l1, l2, l3);</span>
<span class="line-modified">!             end[i] = System.nanoTime();</span>
<span class="line-modified">!         }</span>
<span class="line-modified">!         // Results</span>
<span class="line-modified">!         computeStatistics(start, end);</span>
<span class="line-modified">! </span>
<span class="line-modified">!         System.out.println(&quot;\nNative:&quot;);</span>
<span class="line-modified">!         // Warmup</span>
<span class="line-modified">!         for (int i = 0; i &lt; 10; i++) {</span>
<span class="line-modified">!             LongLongLongLong[] array = new LongLongLongLong[array_size];</span>
<span class="line-modified">!             initializeLongLongLongLongArray(array, l0, l1, l2, l3);</span>
<span class="line-modified">!         }</span>
<span class="line-modified">!         // Measure</span>
<span class="line-modified">!         for (int i = 0; i &lt; iterations; i++) {</span>
<span class="line-modified">!             LongLongLongLong[] array = new LongLongLongLong[array_size];</span>
<span class="line-modified">!             start[i] = System.nanoTime();</span>
<span class="line-modified">!             initializeLongLongLongLongArray(array, l0, l1, l2, l3);</span>
<span class="line-modified">!             end[i] = System.nanoTime();</span>
<span class="line-modified">!         }</span>
<span class="line-modified">!         // Results</span>
<span class="line-modified">!         computeStatistics(start, end);</span>
      }
<span class="line-modified">! </span>
      void computeStatistics(long[] start, long[] end) {
<span class="line-modified">!         int iterations = start.length;</span>
<span class="line-modified">!         long[] duration = new long[iterations];</span>
<span class="line-modified">!         long sum = 0;</span>
<span class="line-modified">!         long min = end[0] - start[0];</span>
<span class="line-modified">!         long max = min;</span>
<span class="line-modified">!         double var = 0.0;</span>
<span class="line-modified">!         for (int i = 0 ; i &lt; iterations; i++) {</span>
<span class="line-modified">!             duration[i] = end[i] - start[i];</span>
<span class="line-modified">!             if (duration[i] &lt; min) min = duration[i];</span>
<span class="line-modified">!             if (duration[i] &gt; max) max = duration[i];</span>
<span class="line-modified">!             sum += duration[i];</span>
<span class="line-modified">!             double d = (double) duration[i];</span>
<span class="line-modified">!             var += Math.pow(d, 2);</span>
<span class="line-modified">!         }</span>
<span class="line-modified">!         double avg = (sum/iterations) / 1000;</span>
<span class="line-modified">!         double std = (Math.sqrt(var/iterations - Math.pow(sum/iterations, 2))) / 1000;</span>
<span class="line-modified">!         System.out.println(String.format(&quot;Avg: %8.2f us&quot;, avg));</span>
<span class="line-modified">!         System.out.println(String.format(&quot;Std: %8.2f us&quot;, std));</span>
<span class="line-modified">!         System.out.println(String.format(&quot;Min: %8d us&quot;, (min/1000)));</span>
<span class="line-modified">!         System.out.println(String.format(&quot;Max: %8d us&quot;, (max/1000)));</span>
      }
  
      native int GetFlattenedArrayElementSizeWrapper(Object array);
      native Class GetFlattenedArrayElementClassWrapper(Object array);
      native long GetFlattenedArrayElementsWrapper(Object array);
      native void ReleaseFlattenedArrayElementsWrapper(Object array, long addr,int mode);
      native int GetFieldOffsetInFlattenedLayoutWrapper(Class klass, String name, String signature, boolean flattened);
<span class="line-modified">! </span>
      native int getIntFieldAtIndex(Object[] array, int index, String fieldName, String FieldSignature);
      native void printArrayInformation(Object[] array);
  
      native void initializeIntIntArrayBuffer(Object[] array, int i0, int i1);
      native void initializeIntIntArrayFields(Object[] array, int i0, int i1);
</pre>
<center>&lt; prev <a href="../../../../../../index.html" target="_top">index</a> <a href="ValueTypeArray.java.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>