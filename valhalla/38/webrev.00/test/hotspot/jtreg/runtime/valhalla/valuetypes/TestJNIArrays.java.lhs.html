<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames test/hotspot/jtreg/runtime/valhalla/valuetypes/TestJNIArrays.java</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
<a name="1" id="anc1"></a><span class="line-modified">  2  * Copyright (c) 2019, 2019, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 
 25 import jdk.test.lib.Asserts;
 26 
 27 import java.lang.reflect.*;
 28 import java.util.Random;
 29 import java.util.Arrays;
 30 import java.util.Comparator;
 31 
 32 import jdk.internal.misc.Unsafe;
 33 import jdk.internal.vm.jni.SubElementSelector;
 34 
 35 /*
 36  * @test
 37  * @summary Test flattened arrays accesses through JNI
 38  * @modules java.base/jdk.internal.misc java.base/jdk.internal.vm.jni
 39  * @library /testlibrary /test/lib
 40  * @requires (os.simpleArch == &quot;x64&quot;)
 41  * @requires (os.family == &quot;linux&quot; | os.family == &quot;mac&quot;)
<a name="2" id="anc2"></a><span class="line-modified"> 42  * @compile -XDallowGenericsOverValues -XDallowWithFieldOperator TestJNIArrays.java</span>
 43  * @run main/othervm/native/timeout=3000 -XX:ValueArrayElemMaxFlatSize=128 -XX:+PrintFlattenableLayouts -XX:+UseCompressedOops TestJNIArrays
 44  * @run main/othervm/native/timeout=3000 -XX:ValueArrayElemMaxFlatSize=128 -XX:+PrintFlattenableLayouts -XX:-UseCompressedOops TestJNIArrays
 45  */
<a name="3" id="anc3"></a><span class="line-removed"> 46 </span>
 47 public class TestJNIArrays {
 48 
 49     static final Unsafe U = Unsafe.getUnsafe();
<a name="4" id="anc4"></a><span class="line-modified"> 50     </span>
 51     public static final int ARRAY_SIZE = 1024;
 52     static long seed;
 53     static Random random;
 54 
 55     static {
<a name="5" id="anc5"></a><span class="line-modified"> 56 	seed = System.nanoTime();</span>
<span class="line-modified"> 57 	System.out.println(&quot;Seed = &quot; + seed); </span>
<span class="line-modified"> 58 	random = new Random(seed);</span>
 59     }
 60 
 61     static {
 62         System.loadLibrary(&quot;TestJNIArrays&quot;);
 63     }
 64 
 65     static inline class IntInt {
<a name="6" id="anc6"></a><span class="line-modified"> 66 	int i0;</span>
<span class="line-modified"> 67 	int i1;</span>
 68 
<a name="7" id="anc7"></a><span class="line-modified"> 69 	public IntInt(int i0, int i1) {</span>
<span class="line-modified"> 70 	    this.i0 = i0;</span>
<span class="line-modified"> 71 	    this.i1 = i1;</span>
<span class="line-modified"> 72 	}</span>
 73     }
 74 
<a name="8" id="anc8"></a><span class="line-modified"> 75     static class IntIntComparator implements Comparator&lt;IntInt&gt; {</span>
<span class="line-modified"> 76 	public int compare(IntInt a, IntInt b) {</span>
<span class="line-modified"> 77 	    if (a.i0 &lt; b.i0) return -1;</span>
<span class="line-modified"> 78 	    if (a.i0 &gt; b.i0) return 1;</span>
<span class="line-modified"> 79 	    if (a.i1 &lt; b.i1) return -1;</span>
<span class="line-modified"> 80 	    if (a.i1 &gt; b.i1) return 1;</span>
<span class="line-modified"> 81 	    return 0;</span>
<span class="line-modified"> 82 	}</span>
 83     }
 84 
 85     static inline class Containee {
<a name="9" id="anc9"></a><span class="line-modified"> 86 	float f;</span>
<span class="line-modified"> 87 	short s;</span>
 88 
<a name="10" id="anc10"></a><span class="line-modified"> 89 	Containee(float f, short s) {</span>
<span class="line-modified"> 90 	    this.f = f;</span>
<span class="line-modified"> 91 	    this.s = s;</span>
<span class="line-modified"> 92 	}</span>
 93     }
<a name="11" id="anc11"></a><span class="line-removed"> 94     </span>
<span class="line-removed"> 95     static inline class Container {</span>
<span class="line-removed"> 96 	double d;</span>
<span class="line-removed"> 97 	Containee c;</span>
<span class="line-removed"> 98 	byte b;</span>
 99 
<a name="12" id="anc12"></a><span class="line-modified">100 	Container(double d, Containee c, byte b) {</span>
<span class="line-modified">101 	    this.d = d ;</span>
<span class="line-modified">102 	    this.c = c;</span>
<span class="line-modified">103 	    this.b = b;</span>
<span class="line-modified">104 	}</span>





105 
<a name="13" id="anc13"></a><span class="line-modified">106 	Container setc(Containee c) {</span>
107             Container res = __WithField(this.c, c);
108             return res;
109         }
110 
111     }
112 
113     static inline class LongLongLongLong {
<a name="14" id="anc14"></a><span class="line-modified">114 	long l0, l1, l2, l3;</span>
<span class="line-modified">115 </span>
<span class="line-modified">116 	public LongLongLongLong(long l0, long l1, long l2, long l3) {</span>
<span class="line-modified">117 	    this.l0 = l0;</span>
<span class="line-modified">118 	    this.l1 = l1;</span>
<span class="line-modified">119 	    this.l2 = l2;</span>
<span class="line-modified">120 	    this.l3 = l3;</span>
<span class="line-modified">121 	}</span>
122     }
123 
124     static inline class BigValue {
<a name="15" id="anc15"></a><span class="line-modified">125 	long l0 = 0, l1 = 0,   l2 = 0, l3 = 0, l4 = 0, l5 = 0, l6 = 0, l7 = 0, l8 = 0, l9 = 0;</span>
<span class="line-modified">126 	long l10 = 0, l11 = 0, l12 = 0, l13 = 0, l14 = 0, l15 = 0, l16 = 0, l17 = 0, l18 = 0, l19 = 0;</span>
<span class="line-modified">127 	long l20 = 0, l21 = 0, l22 = 0, l23 = 0, l24 = 0, l25 = 0, l26 = 0, l27 = 0, l28 = 0, l29 = 0;</span>
<span class="line-modified">128 	long l30 = 0, l31 = 0, l32 = 0, l33 = 0, l34 = 0, l35 = 0, l36 = 0, l37 = 0, l38 = 0, l39 = 0;</span>
129     }
130 
131     static inline class ValueWithOops {
<a name="16" id="anc16"></a><span class="line-modified">132 	String s = &quot;bonjour&quot;;</span>
<span class="line-modified">133 	int i = 0;</span>
<span class="line-modified">134 	Containee c = new Containee(2.3f, (short)4);</span>
<span class="line-modified">135 	BigValue b = new BigValue();</span>
136     }
<a name="17" id="anc17"></a><span class="line-modified">137     </span>
138     public static void main(String[] args) {
<a name="18" id="anc18"></a><span class="line-modified">139 	TestJNIArrays test = new TestJNIArrays();</span>
<span class="line-modified">140 	test.checkGetFlattenedArrayElementSize();</span>
<span class="line-modified">141 	test.checkGetFlattenedArrayElementClass();</span>
<span class="line-modified">142 	test.checkGetFieldOffsetInFlattenedLayout();</span>
<span class="line-modified">143 	test.checkGetFlattenedArrayElements();</span>
<span class="line-modified">144 	test.checkSubElementAPI();</span>
<span class="line-modified">145 	test.checkBehaviors();</span>
<span class="line-modified">146 	// test.mesureInitializationTime(1024 * 1024 * 10 , 1000);</span>
<span class="line-modified">147 	// test.mesureInitializationTime2(1024 * 1024 * 10 , 1000);</span>
<span class="line-modified">148 	// test.mesureUpdateTime2(1024 * 1024 * 10, 1000);</span>
<span class="line-modified">149 	// test.mesureSortingTime(1024 * 1024, 100); // reduced number of iterations because Java sorting is slow (because of generics?)</span>
<span class="line-modified">150 	test.mesureInitializationTime3(1024 * 1024 * 2 , 1000);</span>


151     }
152 
153     void checkSubElementAPI() {
<a name="19" id="anc19"></a><span class="line-modified">154 	Throwable e = null;</span>
<span class="line-modified">155 	ValueWithOops[] arrayWithOops = new ValueWithOops[100];</span>
<span class="line-modified">156 	ValueWithOops v = new ValueWithOops();</span>
<span class="line-modified">157 	for (int i = 0; i &lt; 100; i++) {</span>
<span class="line-modified">158 	    arrayWithOops[i] = v;</span>
<span class="line-modified">159 	}</span>
<span class="line-modified">160 	SubElementSelector selector1 = createSubElementSelector(arrayWithOops);</span>
<span class="line-modified">161 	SubElementSelector selector2 = getSubElementSelector(selector1, ValueWithOops.class, &quot;s&quot;, &quot;Ljava/lang/String;&quot;);</span>
<span class="line-modified">162 	String s = (String) getObjectSubElement(arrayWithOops, selector2, 1);</span>
<span class="line-modified">163 	System.out.println(&quot;s = &quot; + s);</span>
<span class="line-modified">164 	Asserts.assertEquals(s.equals(&quot;bonjour&quot;), true, &quot;Wrong string, expecting \&quot;bonjour\&quot;, got &quot; + s); </span>
<span class="line-modified">165 	SubElementSelector selector3 = getSubElementSelector(selector1, ValueWithOops.class, &quot;c&quot;, &quot;QTestJNIArrays$Containee;&quot;);</span>
<span class="line-modified">166 	Containee c = (Containee) getObjectSubElement(arrayWithOops, selector3, 2);</span>
<span class="line-modified">167 	Asserts.assertEquals(c.f, 2.3f, &quot;Wrong float value: &quot; + c.f);</span>
<span class="line-modified">168 	Asserts.assertEquals(c.s, (short)4, &quot;Wrong short value &quot; + c.s);</span>
<span class="line-modified">169 	setObjectSubElement(arrayWithOops, selector2, 1, &quot;Hello&quot;);</span>
<span class="line-modified">170 	Asserts.assertEquals(arrayWithOops[1].s.equals(&quot;Hello&quot;), true, &quot;Wrong string, expecting \&quot;Hello\&quot;, got &quot; + s);</span>
<span class="line-modified">171 	Integer myInteger = new Integer(345);</span>
<span class="line-modified">172 	e = null;</span>
<span class="line-modified">173 	try {</span>
<span class="line-modified">174 	    setObjectSubElement(arrayWithOops, selector2, 1, myInteger);</span>
<span class="line-modified">175 	} catch(Throwable t) {</span>
<span class="line-modified">176 	    e = t;</span>
<span class="line-modified">177 	}</span>
<span class="line-modified">178 	Asserts.assertNotNull(e, &quot;An exception should have been thrown&quot;);</span>
<span class="line-modified">179 	Asserts.assertEquals(e.getClass(), java.lang.ArrayStoreException.class, &quot;Wrong exception type&quot;);</span>
<span class="line-modified">180 	c = new Containee(9.8f, (short)-3);</span>
<span class="line-modified">181 	setObjectSubElement(arrayWithOops, selector3, 2, c);</span>
<span class="line-modified">182 	Asserts.assertEquals(c.f, 9.8f, &quot;Wrong float value: &quot; + c.f);</span>
<span class="line-modified">183 	Asserts.assertEquals(c.s, (short)-3, &quot;Wrong short value &quot; + c.s);</span>
<span class="line-modified">184 	e = null;</span>
<span class="line-modified">185 	try {</span>
<span class="line-modified">186 	    setObjectSubElement(arrayWithOops, selector3, 2, null);</span>
<span class="line-modified">187 	} catch(Throwable t) {</span>
<span class="line-modified">188 	    e = t;</span>
<span class="line-modified">189 	}</span>
<span class="line-modified">190 	Asserts.assertNotNull(e, &quot;An exception should have been thrown&quot;);</span>
<span class="line-modified">191 	Asserts.assertEquals(e.getClass(), java.lang.ArrayStoreException.class, &quot;Wrong exception type&quot;);</span>
<span class="line-modified">192 	SubElementSelector selector4 = getSubElementSelector(selector3, TestJNIArrays.Containee.class, &quot;s&quot;, &quot;S&quot;);</span>
<span class="line-modified">193 	short s2 = getShortSubElement(arrayWithOops, selector4, 3);</span>
<span class="line-modified">194 	Asserts.assertEquals(s2, (short)4, &quot;Wrong short value &quot; + s2);</span>
<span class="line-modified">195 	setShortSubElement(arrayWithOops, selector4, 3, (short)7);</span>
<span class="line-modified">196 	Asserts.assertEquals(arrayWithOops[3].c.s, (short)7, &quot;Wrong short value &quot; + arrayWithOops[3].c.s);</span>
<span class="line-modified">197 	e = null;</span>
<span class="line-modified">198 	try {</span>
<span class="line-modified">199 	    // should fail because selector4 designates a field with type short, not int</span>
<span class="line-modified">200 	    getIntSubElement(arrayWithOops, selector4, 3);</span>
<span class="line-modified">201 	} catch(Throwable t) {</span>
<span class="line-modified">202 	    e = t;</span>
<span class="line-modified">203 	}</span>
<span class="line-modified">204 	Asserts.assertNotNull(e, &quot;An exception should have been thrown&quot;);</span>
<span class="line-modified">205 	Asserts.assertEquals(e.getClass(), java.lang.IllegalArgumentException.class, &quot;Wrong exception type&quot;);</span>
<span class="line-modified">206 	SubElementSelector selector5 = getSubElementSelector(selector1, ValueWithOops.class, &quot;b&quot;, &quot;QTestJNIArrays$BigValue;&quot;);</span>
<span class="line-modified">207 	e = null;</span>
<span class="line-modified">208 	try {</span>
<span class="line-modified">209 	    // Should fail because selector5 designates a non-flattened field</span>
<span class="line-modified">210 	    SubElementSelector selector6 = getSubElementSelector(selector5, TestJNIArrays.BigValue.class, &quot;l0&quot;, &quot;J&quot;);</span>
<span class="line-modified">211 	} catch(Throwable t) {</span>
<span class="line-modified">212 	    e = t;</span>
<span class="line-modified">213 	}</span>
<span class="line-modified">214 	Asserts.assertNotNull(e, &quot;An exception should have been thrown&quot;);</span>
<span class="line-modified">215 	Asserts.assertEquals(e.getClass(), java.lang.IllegalArgumentException.class, &quot;Wrong exception type&quot;);</span>
<span class="line-modified">216 	System.gc();</span>
217     }
<a name="20" id="anc20"></a><span class="line-modified">218     </span>
219     void checkGetFlattenedArrayElementSize() {
<a name="21" id="anc21"></a><span class="line-modified">220 	Throwable exception = null;</span>
<span class="line-modified">221 	try {</span>
<span class="line-modified">222 	    Object o = new Object();</span>
<span class="line-modified">223 	    GetFlattenedArrayElementSizeWrapper(o);</span>
<span class="line-modified">224 	} catch(Throwable t) {</span>
<span class="line-modified">225 	    exception = t;</span>
<span class="line-modified">226 	}</span>
<span class="line-modified">227 	Asserts.assertNotNull(exception, &quot;An IAE should have been thrown&quot;);</span>
<span class="line-modified">228 	Asserts.assertEquals(exception.getClass(), IllegalArgumentException.class , &quot;Wrong exception type&quot;);</span>
<span class="line-modified">229 	exception = null;</span>
<span class="line-modified">230 	try {</span>
<span class="line-modified">231 	    int[] array = new int[16];</span>
<span class="line-modified">232 	    Object o = array;</span>
<span class="line-modified">233 	    GetFlattenedArrayElementSizeWrapper(o);</span>
<span class="line-modified">234 	} catch(Throwable t) {</span>
<span class="line-modified">235 	    exception = t;</span>
<span class="line-modified">236 	}</span>
<span class="line-modified">237 	Asserts.assertNotNull(exception, &quot;An IAE should have been thrown&quot;);</span>
<span class="line-modified">238 	Asserts.assertEquals(exception.getClass(), IllegalArgumentException.class , &quot;Wrong exception type&quot;);</span>
<span class="line-modified">239 	exception = null;</span>
<span class="line-modified">240 	try {</span>
<span class="line-modified">241 	    GetFlattenedArrayElementSizeWrapper(new String[16]);</span>
<span class="line-modified">242 	} catch(Throwable t) {</span>
<span class="line-modified">243 	    exception = t;</span>
<span class="line-modified">244 	}</span>
<span class="line-modified">245 	Asserts.assertNotNull(exception, &quot;An IAE should have been thrown&quot;);</span>
<span class="line-modified">246 	Asserts.assertEquals(exception.getClass(), IllegalArgumentException.class , &quot;Wrong exception type&quot;);</span>
<span class="line-modified">247 	exception = null;</span>
<span class="line-modified">248 	try {</span>
<span class="line-modified">249 	    // Array of BigValue should not be flattened because BigValue is *big*</span>
<span class="line-modified">250 	    GetFlattenedArrayElementSizeWrapper(new BigValue[16]);</span>
<span class="line-modified">251 	} catch(Throwable t) {</span>
<span class="line-modified">252 	    exception = t;</span>
<span class="line-modified">253 	}</span>
<span class="line-modified">254 	Asserts.assertNotNull(exception, &quot;An IAE should have been thrown&quot;);</span>
<span class="line-modified">255 	Asserts.assertTrue(exception instanceof IllegalArgumentException , &quot;Exception should be a IAE&quot;);</span>
<span class="line-modified">256 	exception = null;</span>
<span class="line-modified">257 	int size = -1;</span>
<span class="line-modified">258 	try {</span>
<span class="line-modified">259 	    size = GetFlattenedArrayElementSizeWrapper(new IntInt[16]);</span>
<span class="line-modified">260 	} catch(Throwable t) {</span>
<span class="line-modified">261 	    exception = t;</span>
<span class="line-modified">262 	}</span>
<span class="line-modified">263 	Asserts.assertNull(exception, &quot;No exception should have been thrown&quot;);</span>
<span class="line-modified">264 	Asserts.assertEquals(size, 8, &quot;Wrong size&quot;);</span>
265     }
266 
267     void checkGetFlattenedArrayElementClass() {
<a name="22" id="anc22"></a><span class="line-modified">268 	Throwable exception = null;</span>
<span class="line-modified">269 	try {</span>
<span class="line-modified">270 	    Object o = new Object();</span>
<span class="line-modified">271 	    GetFlattenedArrayElementClassWrapper(o);</span>
<span class="line-modified">272 	} catch(Throwable t) {</span>
<span class="line-modified">273 	    exception = t;</span>
<span class="line-modified">274 	}</span>
<span class="line-modified">275 	Asserts.assertNotNull(exception, &quot;An IAE should have been thrown&quot;);</span>
<span class="line-modified">276 	Asserts.assertEquals(exception.getClass(), IllegalArgumentException.class , &quot;Wrong exception type&quot;);</span>
<span class="line-modified">277 	exception = null;</span>
<span class="line-modified">278 	try {</span>
<span class="line-modified">279 	    int[] array = new int[16];</span>
<span class="line-modified">280 	    Object o = array;</span>
<span class="line-modified">281 	    GetFlattenedArrayElementClassWrapper(o);</span>
<span class="line-modified">282 	} catch(Throwable t) {</span>
<span class="line-modified">283 	    exception = t;</span>
<span class="line-modified">284 	}</span>
<span class="line-modified">285 	Asserts.assertNotNull(exception, &quot;An IAE should have been thrown&quot;);</span>
<span class="line-modified">286 	Asserts.assertEquals(exception.getClass(), IllegalArgumentException.class , &quot;Wrong exception type&quot;);</span>
<span class="line-modified">287 	exception = null;</span>
<span class="line-modified">288 	try {</span>
<span class="line-modified">289 	    GetFlattenedArrayElementClassWrapper(new String[16]);</span>
<span class="line-modified">290 	} catch(Throwable t) {</span>
<span class="line-modified">291 	    exception = t;</span>
<span class="line-modified">292 	}</span>
<span class="line-modified">293 	Asserts.assertNotNull(exception, &quot;An IAE should have been thrown&quot;);</span>
<span class="line-modified">294 	Asserts.assertEquals(exception.getClass(), IllegalArgumentException.class , &quot;Wrong exception type&quot;);</span>
<span class="line-modified">295 	exception = null;</span>
<span class="line-modified">296 	try {</span>
<span class="line-modified">297 	    // Array of BigValue should not be flattened because BigValue is *big*</span>
<span class="line-modified">298 	    GetFlattenedArrayElementClassWrapper(new BigValue[16]);</span>
<span class="line-modified">299 	} catch(Throwable t) {</span>
<span class="line-modified">300 	    exception = t;</span>
<span class="line-modified">301 	}</span>
<span class="line-modified">302 	Asserts.assertNotNull(exception, &quot;An IAE should have been thrown&quot;);</span>
<span class="line-modified">303 	Asserts.assertTrue(exception instanceof IllegalArgumentException , &quot;Exception should be a IAE&quot;);</span>
<span class="line-modified">304 	exception = null;</span>
<span class="line-modified">305 	Class c = null;</span>
<span class="line-modified">306 	try {</span>
<span class="line-modified">307 	    c = GetFlattenedArrayElementClassWrapper(new IntInt[16]);</span>
<span class="line-modified">308 	} catch(Throwable t) {</span>
<span class="line-modified">309 	    exception = t;</span>
<span class="line-modified">310 	}</span>
<span class="line-modified">311 	Asserts.assertNull(exception, &quot;No exception should have been thrown&quot;);</span>
<span class="line-modified">312 	Asserts.assertEquals(c, IntInt.class, &quot;Wrong class&quot;);</span>
313     }
314 
315     void checkGetFieldOffsetInFlattenedLayout() {
<a name="23" id="anc23"></a><span class="line-modified">316 	Throwable exception = null;</span>
<span class="line-modified">317 	try {</span>
<span class="line-modified">318 	    Object o = new Object();</span>
<span class="line-modified">319 	    GetFieldOffsetInFlattenedLayoutWrapper(o.getClass(), &quot;foo&quot;, &quot;I&quot;, true);</span>
<span class="line-modified">320 	} catch(Throwable t) {</span>
<span class="line-modified">321 	    exception = t;</span>
<span class="line-modified">322 	}</span>
<span class="line-modified">323 	Asserts.assertNotNull(exception, &quot;An IAE should have been thrown&quot;);</span>
<span class="line-modified">324 	Asserts.assertEquals(exception.getClass(), IllegalArgumentException.class , &quot;Wrong exception type&quot;);</span>
<span class="line-modified">325 	exception = null;</span>
<span class="line-modified">326 	try {</span>
<span class="line-modified">327 	    int[] array = new int[16];</span>
<span class="line-modified">328 	    GetFieldOffsetInFlattenedLayoutWrapper(array.getClass(), &quot;foo&quot;, &quot;I&quot;, true);</span>
<span class="line-modified">329 	} catch(Throwable t) {</span>
<span class="line-modified">330 	    exception = t;</span>
<span class="line-modified">331 	}</span>
<span class="line-modified">332 	Asserts.assertNotNull(exception, &quot;An IAE should have been thrown&quot;);</span>
<span class="line-modified">333 	Asserts.assertEquals(exception.getClass(), IllegalArgumentException.class , &quot;Wrong exception type&quot;);</span>
<span class="line-modified">334 	exception = null;</span>
<span class="line-modified">335 	try {</span>
<span class="line-modified">336 	    String[] array = new String[16];</span>
<span class="line-modified">337 	    GetFieldOffsetInFlattenedLayoutWrapper(array.getClass(), &quot;foo&quot;, &quot;I&quot;, true);</span>
<span class="line-modified">338 	} catch(Throwable t) {</span>
<span class="line-modified">339 	    exception = t;</span>
<span class="line-modified">340 	}</span>
<span class="line-modified">341 	Asserts.assertNotNull(exception, &quot;An IAE should have been thrown&quot;);</span>
<span class="line-modified">342 	Asserts.assertEquals(exception.getClass(), IllegalArgumentException.class , &quot;Wrong exception type&quot;);</span>
<span class="line-modified">343 	exception = null;</span>
<span class="line-modified">344 	Containee ce  = new Containee(3.4f, (short)5);</span>
<span class="line-modified">345 	Container c = new Container(123.876, ce, (byte)7);</span>
<span class="line-modified">346 	Class&lt;?&gt; cclass = c.getClass();</span>
<span class="line-modified">347 	Container[] containerArray = new Container[32];</span>
<span class="line-modified">348 	int elementSize = GetFlattenedArrayElementSizeWrapper(containerArray);</span>
<span class="line-modified">349 	int offset = -1;</span>
<span class="line-modified">350 	try {</span>
<span class="line-modified">351 	    offset = GetFieldOffsetInFlattenedLayoutWrapper(cclass, &quot;d&quot;, &quot;D&quot;, false);</span>
<span class="line-modified">352 	} catch(Throwable t) {</span>
<span class="line-modified">353 	    exception = t;</span>
<span class="line-modified">354 	}</span>
<span class="line-modified">355 	Asserts.assertNull(exception, &quot;No exception should have been thrown&quot;);</span>
<span class="line-modified">356 	Field f = null;</span>
<span class="line-modified">357 	try {</span>
<span class="line-modified">358 	    f = cclass.getDeclaredField(&quot;d&quot;);</span>
<span class="line-modified">359 	} catch(NoSuchFieldException e) {</span>
<span class="line-modified">360 	    e.printStackTrace();</span>
<span class="line-modified">361 	    return;</span>
<span class="line-modified">362 	}</span>
<span class="line-modified">363 	Asserts.assertEquals(U.valueHeaderSize(cclass) + offset, U.objectFieldOffset(cclass, f.getName()),</span>
<span class="line-modified">364 			     &quot;Incorrect offset&quot;);</span>
<span class="line-modified">365 	Asserts.assertLessThan(offset, elementSize, &quot;Invalid offset&quot;);</span>
<span class="line-modified">366 	exception = null;</span>
<span class="line-modified">367 	try {</span>
<span class="line-modified">368 	    // Field c should be flattened, so last argument is true, no exception expected</span>
<span class="line-modified">369 	    GetFieldOffsetInFlattenedLayoutWrapper(cclass, &quot;c&quot;, &quot;QTestJNIArrays$Containee;&quot;, true);</span>
<span class="line-modified">370 	} catch(Throwable t) {</span>
<span class="line-modified">371 	    exception = t;</span>
<span class="line-modified">372 	}</span>
<span class="line-modified">373 	Asserts.assertNull(exception, &quot;No exception should have been thrown&quot;);</span>
<span class="line-modified">374 	Asserts.assertLessThan(offset, elementSize, &quot;Invalid offset&quot;);</span>
<span class="line-modified">375 	exception = null;</span>
<span class="line-modified">376 	try {</span>
<span class="line-modified">377 	    // Field c should be flattened, with last argument being false, exception expected from the wrapper </span>
<span class="line-modified">378 	    GetFieldOffsetInFlattenedLayoutWrapper(cclass, &quot;c&quot;, &quot;QTestJNIArrays$Containee;&quot;, false);</span>
<span class="line-modified">379 	} catch(Throwable t) {</span>
<span class="line-modified">380 	    exception = t;</span>
<span class="line-modified">381 	}</span>
<span class="line-modified">382 	Asserts.assertNotNull(exception, &quot;Wrapper should have thrown a RuntimeException&quot;);</span>
<span class="line-modified">383 	Asserts.assertEquals(exception.getClass(), RuntimeException.class , &quot;Wrong exception type&quot;);</span>
384     }
<a name="24" id="anc24"></a><span class="line-modified">385     </span>
<span class="line-modified">386      void checkGetFlattenedArrayElements() {</span>
<span class="line-modified">387 	Throwable exception = null;</span>
<span class="line-modified">388 	Object o = new Object();</span>
<span class="line-modified">389 	try {</span>
<span class="line-modified">390 	    GetFlattenedArrayElementsWrapper(o);</span>
<span class="line-modified">391 	} catch(Throwable t) {</span>
<span class="line-modified">392 	    exception = t;</span>
<span class="line-modified">393 	}</span>
<span class="line-modified">394 	Asserts.assertNotNull(exception, &quot;An IAE should have been thrown&quot;);</span>
<span class="line-modified">395 	Asserts.assertEquals(exception.getClass(), IllegalArgumentException.class , &quot;Wrong exception type&quot;);</span>
<span class="line-modified">396 	exception = null;</span>
<span class="line-modified">397 	int[] a1 = new int[16];</span>
<span class="line-modified">398 	o = a1;</span>
<span class="line-modified">399 	try {</span>
<span class="line-modified">400 	    GetFlattenedArrayElementsWrapper(o);</span>
<span class="line-modified">401 	} catch(Throwable t) {</span>
<span class="line-modified">402 	    exception = t;</span>
<span class="line-modified">403 	}</span>
<span class="line-modified">404 	Asserts.assertNotNull(exception, &quot;An IAE should have been thrown&quot;);</span>
<span class="line-modified">405 	Asserts.assertEquals(exception.getClass(), IllegalArgumentException.class , &quot;Wrong exception type&quot;);</span>
<span class="line-modified">406 	exception = null;</span>
<span class="line-modified">407 	try {</span>
<span class="line-modified">408 	    GetFlattenedArrayElementsWrapper(new String[16]);</span>
<span class="line-modified">409 	} catch(Throwable t) {</span>
<span class="line-modified">410 	    exception = t;</span>
<span class="line-modified">411 	}</span>
<span class="line-modified">412 	Asserts.assertNotNull(exception, &quot;An IAE should have been thrown&quot;);</span>
<span class="line-modified">413 	Asserts.assertEquals(exception.getClass(), IllegalArgumentException.class , &quot;Wrong exception type&quot;);</span>
<span class="line-modified">414 	exception = null;</span>
<span class="line-modified">415 	try {</span>
<span class="line-modified">416 	    // Array of BigValue should not be flattened because BigValue is *big*</span>
<span class="line-modified">417 	    GetFlattenedArrayElementsWrapper(new BigValue[16]);</span>
<span class="line-modified">418 	} catch(Throwable t) {</span>
<span class="line-modified">419 	    exception = t;</span>
<span class="line-modified">420 	}</span>
<span class="line-modified">421 	Asserts.assertNotNull(exception, &quot;An IAE should have been thrown&quot;);</span>
<span class="line-modified">422 	Asserts.assertTrue(exception instanceof IllegalArgumentException , &quot;Exception should be a IAE&quot;);</span>
<span class="line-modified">423 	exception = null;</span>
<span class="line-modified">424 	try {</span>
<span class="line-modified">425 	    // Direct native access to flattened arrays is not allowed if elements contain oops</span>
<span class="line-modified">426 	    GetFlattenedArrayElementsWrapper(new ValueWithOops[16]);</span>
<span class="line-modified">427 	} catch(Throwable t) {</span>
<span class="line-modified">428 	    exception = t;</span>
<span class="line-modified">429 	}</span>
<span class="line-modified">430 	Asserts.assertNotNull(exception, &quot;An IAE should have been thrown&quot;);</span>
<span class="line-modified">431 	Asserts.assertTrue(exception instanceof IllegalArgumentException , &quot;Exception should be a IAE&quot;);</span>
<span class="line-modified">432 	exception = null;</span>
<span class="line-modified">433 	long addr = 0;</span>
<span class="line-modified">434 	IntInt[] a2 = new IntInt[16];</span>
<span class="line-modified">435 	try {</span>
<span class="line-modified">436 	    addr = GetFlattenedArrayElementsWrapper(a2);</span>
<span class="line-modified">437 	} catch(Throwable t) {</span>
<span class="line-modified">438 	    exception = t;</span>
<span class="line-modified">439 	}</span>
<span class="line-modified">440 	Asserts.assertNull(exception, &quot;No exception should have been thrown&quot;);</span>
<span class="line-modified">441 	if (exception == null) {</span>
<span class="line-modified">442 	    ReleaseFlattenedArrayElementsWrapper(a2, addr, 0);</span>
<span class="line-modified">443 	}</span>
444     }
<a name="25" id="anc25"></a><span class="line-modified">445     </span>
446     void checkBehaviors() {
<a name="26" id="anc26"></a><span class="line-modified">447 	System.out.println(&quot;Check 1&quot;);</span>
<span class="line-modified">448 	IntInt[] array = new IntInt[ARRAY_SIZE];</span>
<span class="line-modified">449 	int value = getIntFieldAtIndex(array, 1, &quot;i0&quot;, &quot;I&quot;);</span>
<span class="line-modified">450 	Asserts.assertEquals(value, 0, &quot;Initial value must be zero&quot;);</span>
<span class="line-modified">451 	printArrayInformation(array);</span>
<span class="line-modified">452 	int i0_value = 42;</span>
<span class="line-modified">453 	int i1_value = -314;</span>
<span class="line-modified">454 	initializeIntIntArrayBuffer(array, i0_value, i1_value);</span>
<span class="line-modified">455 	System.gc();</span>
<span class="line-modified">456 	for (int i = 0; i &lt; array.length; i++) {</span>
<span class="line-modified">457 	    Asserts.assertEquals(array[i].i0, i0_value, &quot;Bad value of i0 at index &quot; + i);</span>
<span class="line-modified">458 	    Asserts.assertEquals(array[i].i1, i1_value, &quot;Bad value of i1 at index &quot; + i);</span>
<span class="line-modified">459 	}</span>
<span class="line-modified">460 	System.out.println(&quot;Check 2&quot;);</span>
<span class="line-modified">461 	array = new IntInt[ARRAY_SIZE];</span>
<span class="line-modified">462 	i0_value = -194;</span>
<span class="line-modified">463 	i1_value = 91;</span>
<span class="line-modified">464 	initializeIntIntArrayFields(array, i0_value, i1_value);</span>
<span class="line-modified">465 	System.gc();</span>
<span class="line-modified">466 	for (int i = 0; i &lt; array.length; i++) {</span>
<span class="line-modified">467 	    Asserts.assertEquals(array[i].i0, i0_value, &quot;Bad value of i0 at index &quot; + i);</span>
<span class="line-modified">468 	    Asserts.assertEquals(array[i].i1, i1_value, &quot;Bad value of i1 at index &quot; + i);</span>
<span class="line-modified">469 	}</span>
<span class="line-modified">470 	System.out.println(&quot;Check 3&quot;);</span>
<span class="line-modified">471 	array = new IntInt[ARRAY_SIZE];</span>
<span class="line-modified">472 	initializeIntIntArrayJava(array, i0_value, i1_value);</span>
<span class="line-modified">473 	System.gc();</span>
<span class="line-modified">474 	for (int i = 0; i &lt; array.length; i++) {</span>
<span class="line-modified">475 	    Asserts.assertEquals(array[i].i0, i0_value, &quot;Bad value of i0 at index &quot; + i);</span>
<span class="line-modified">476 	    Asserts.assertEquals(array[i].i1, i1_value, &quot;Bad value of i1 at index &quot; + i);</span>
<span class="line-modified">477 	}</span>
<span class="line-modified">478 	System.out.println(&quot;Check 4&quot;);</span>
<span class="line-modified">479 	random = new Random(seed);</span>
<span class="line-modified">480 	array = new IntInt[ARRAY_SIZE];</span>
<span class="line-modified">481 	for (int i = 0; i &lt; ARRAY_SIZE; i++) {</span>
<span class="line-modified">482 	    array[i] = new IntInt(random.nextInt(), random.nextInt());</span>
<span class="line-modified">483 	}</span>
<span class="line-modified">484 	sortIntIntArray(array);</span>
<span class="line-modified">485 	System.gc();</span>
<span class="line-modified">486 	for (int i = 0; i &lt; array.length - 1; i++) {</span>
<span class="line-modified">487 	    Asserts.assertLessThanOrEqual(array[i].i0, array[i+1].i0, &quot;Incorrect i0 fields ordering at index &quot; + i);</span>
<span class="line-modified">488 	    if (array[i].i0 == array[i+1].i0) {</span>
<span class="line-modified">489 		Asserts.assertLessThanOrEqual(array[i].i1, array[i+1].i1, &quot;Incorrect i1 fields ordering at index &quot; + i);</span>
<span class="line-modified">490 	    }</span>
<span class="line-modified">491 	}</span>
<span class="line-modified">492 	System.out.println(&quot;Check 5&quot;);</span>
<span class="line-modified">493 	random = new Random(seed);</span>
<span class="line-modified">494 	array = new IntInt[ARRAY_SIZE];</span>
<span class="line-modified">495 	for (int i = 0; i &lt; ARRAY_SIZE; i++) {</span>
<span class="line-modified">496 	    array[i] = new IntInt(random.nextInt(), random.nextInt());</span>
<span class="line-modified">497 	}</span>
<span class="line-modified">498 	Arrays.sort(array, new IntIntComparator());</span>
<span class="line-modified">499 	System.gc();</span>
<span class="line-modified">500 	for (int i = 0; i &lt; array.length - 1; i++) {</span>
<span class="line-modified">501 	    Asserts.assertLessThanOrEqual(array[i].i0, array[i+1].i0, &quot;Incorrect i0 fields ordering at index &quot; + i);</span>
<span class="line-modified">502 	    if (array[i].i0 == array[i+1].i0) {</span>
<span class="line-modified">503 		Asserts.assertLessThanOrEqual(array[i].i1, array[i+1].i1, &quot;Incorrect i1 fields ordering at index &quot; + i);</span>
<span class="line-modified">504 	    }</span>
<span class="line-modified">505 	}</span>
<span class="line-modified">506 	System.out.println(&quot;Check 6&quot;);</span>
<span class="line-modified">507 	Container[] array2 = new Container[ARRAY_SIZE];</span>
<span class="line-modified">508 	double d  = 1.23456789;</span>
<span class="line-modified">509 	float f = -987.654321f;</span>
<span class="line-modified">510 	short s = -512;</span>
<span class="line-modified">511 	byte b = 127;</span>
<span class="line-modified">512 	Containee c = new Containee(f,s);</span>
<span class="line-modified">513 	Container c2 = new Container(d, c, b);</span>
<span class="line-modified">514 	initializeContainerArray(array2, d, f, s, b);</span>
<span class="line-modified">515 	System.gc();</span>
<span class="line-modified">516 	for (int i = 0; i &lt; array2.length; i++) {</span>
<span class="line-modified">517 	    Asserts.assertEquals(array2[i], c2, &quot;Incorrect value at index &quot; + i);</span>
<span class="line-modified">518 	    Asserts.assertEquals(array2[i].d, d, &quot;Incorrect d value at index &quot; + i);</span>
<span class="line-modified">519 	    Asserts.assertEquals(array2[i].c.f, f, &quot;Incorrect f value at index &quot; + i);</span>
<span class="line-modified">520 	    Asserts.assertEquals(array2[i].c.s, s, &quot;Incorrect s value at index &quot; + i);</span>
<span class="line-modified">521 	    Asserts.assertEquals(array2[i].b, b, &quot;Incorrect b value at inde &quot; +i);</span>
<span class="line-modified">522 	}</span>
<span class="line-modified">523 	System.out.println(&quot;Check 7&quot;);</span>
<span class="line-modified">524 	f = 19.2837465f;</span>
<span class="line-modified">525 	s = 231;</span>
<span class="line-modified">526 	updateContainerArray(array2, f, s);</span>
<span class="line-modified">527 	System.gc();</span>
<span class="line-modified">528 	for (int i = 0; i &lt; array2.length; i++) {</span>
<span class="line-modified">529 	    Asserts.assertEquals(array2[i].d, d, &quot;Incorrect d value at index &quot; + i);</span>
<span class="line-modified">530 	    Asserts.assertEquals(array2[i].c.f, f, &quot;Incorrect f value at index &quot; + i);</span>
<span class="line-modified">531 	    Asserts.assertEquals(array2[i].c.s, s, &quot;Incorrect s value at index &quot; + i);</span>
<span class="line-modified">532 	    Asserts.assertEquals(array2[i].b, b, &quot;Incorrect b value at inde &quot; +i);</span>
<span class="line-modified">533 	}</span>
<span class="line-modified">534 	System.out.println(&quot;Check 8&quot;);</span>
<span class="line-modified">535 	long l0 = 52467923;</span>
<span class="line-modified">536 	long l1= -7854022;</span>
<span class="line-modified">537 	long l2 = 230947485;</span>
<span class="line-modified">538 	long l3 = -752497024;</span>
<span class="line-modified">539 	LongLongLongLong[] array3 = new LongLongLongLong[ARRAY_SIZE/8];</span>
<span class="line-modified">540 	initializeLongLongLongLongArray(array3, l0, l1, l2, l3);</span>
<span class="line-modified">541 	System.gc();</span>
<span class="line-modified">542 	for (int i = 0; i &lt; array3.length; i++) {</span>
<span class="line-modified">543 	    Asserts.assertEquals(array3[i].l0, l0, &quot;Bad value of l0 at index &quot; + i);</span>
<span class="line-modified">544 	    Asserts.assertEquals(array3[i].l1, l1, &quot;Bad value of l1 at index &quot; + i);</span>
<span class="line-modified">545 	    Asserts.assertEquals(array3[i].l2, l2, &quot;Bad value of l2 at index &quot; + i);</span>
<span class="line-modified">546 	    Asserts.assertEquals(array3[i].l3, l3, &quot;Bad value of l3 at index &quot; + i);</span>
<span class="line-modified">547 	}</span>
548     }
549 
550     void initializeIntIntArrayJava(IntInt[] array, int i0, int i1) {
<a name="27" id="anc27"></a><span class="line-modified">551 	IntInt ii = new IntInt(i0, i1);</span>
<span class="line-modified">552 	for (int i = 0; i &lt; array.length; i++) {</span>
<span class="line-modified">553 	    array[i] = ii;</span>
<span class="line-modified">554 	}</span>
555     }
556 
557     void initializeContainerArrayJava(Container[] array, double d, float f, short s, byte b) {
<a name="28" id="anc28"></a><span class="line-modified">558 	Containee c = new Containee(f,s);</span>
<span class="line-modified">559 	Container c2 = new Container(d, c, b);</span>
<span class="line-modified">560 	for (int i = 0; i &lt; array.length; i++) {</span>
<span class="line-modified">561 	    array[i] = c2;</span>
<span class="line-modified">562 	}</span>
563     }
564 
565     void updateContainerArrayJava(Container[] array, float f, short s) {
<a name="29" id="anc29"></a><span class="line-modified">566 	Containee c = new Containee(f, s);</span>
<span class="line-modified">567 	for (int i = 0; i &lt; array.length; i++) {</span>
<span class="line-modified">568 	    array[i] = array[i].setc(c);;</span>
<span class="line-modified">569 	}</span>
570     }
571 
572     void initializeLongLongLongLongArrayJava(LongLongLongLong[] array, long l0, long l1, long l2, long l3) {
<a name="30" id="anc30"></a><span class="line-modified">573 	LongLongLongLong llll = new LongLongLongLong(l0, l1, l2, l3);</span>
<span class="line-modified">574 	for (int i = 0; i &lt; array.length; i++) {</span>
<span class="line-modified">575 	    array[i] = llll;</span>
<span class="line-modified">576 	}</span>
577     }
<a name="31" id="anc31"></a><span class="line-modified">578     </span>
<span class="line-modified">579     void mesureInitializationTime(int array_size, int iterations) {</span>
<span class="line-modified">580 	System.out.println(&quot;\nInitialization time for IntInt[]:&quot;);</span>
<span class="line-modified">581 	long[] start = new long[iterations];</span>
<span class="line-modified">582 	long[] end = new long[iterations];</span>
<span class="line-modified">583 </span>
<span class="line-modified">584 	</span>
<span class="line-modified">585 	System.out.println(&quot;\nJava:&quot;);</span>
<span class="line-modified">586 	// Warmup</span>
<span class="line-modified">587 	for (int i = 0; i &lt; 10; i++) {</span>
<span class="line-modified">588 	    IntInt[] array = new IntInt[array_size];</span>
<span class="line-modified">589 	    initializeIntIntArrayJava(array, 42, -314);</span>
<span class="line-modified">590 	}</span>
<span class="line-modified">591 	// Measure</span>
<span class="line-modified">592 	for (int i = 0; i &lt; iterations; i++) {</span>
<span class="line-modified">593 	    IntInt[] array = new IntInt[array_size];</span>
<span class="line-modified">594 	    start[i] = System.nanoTime();</span>
<span class="line-modified">595 	    initializeIntIntArrayJava(array, 42, -314);</span>
<span class="line-modified">596 	    end[i] = System.nanoTime();</span>
<span class="line-modified">597 	}</span>
<span class="line-modified">598 	// Results</span>
<span class="line-modified">599 	computeStatistics(start, end);</span>
<span class="line-modified">600 </span>
<span class="line-modified">601 	System.out.println(&quot;\nNative(memcpy):&quot;);</span>
<span class="line-modified">602 	// Warmup</span>
<span class="line-modified">603 	for (int i = 0; i &lt; 10; i++) {</span>
<span class="line-modified">604 	    IntInt[] array = new IntInt[array_size];</span>
<span class="line-modified">605 	    initializeIntIntArrayBuffer(array, 42, -314);</span>
<span class="line-modified">606 	}</span>
<span class="line-modified">607 	// Measure</span>
<span class="line-modified">608 	for (int i = 0; i &lt; iterations; i++) {</span>
<span class="line-modified">609 	    IntInt[] array = new IntInt[array_size];</span>
<span class="line-modified">610 	    start[i] = System.nanoTime();</span>
<span class="line-modified">611 	    initializeIntIntArrayBuffer(array, 42, -314);</span>
<span class="line-modified">612 	    end[i] = System.nanoTime();</span>
<span class="line-modified">613 	}</span>
<span class="line-modified">614 	// Results</span>
<span class="line-modified">615 	computeStatistics(start, end);</span>
<span class="line-modified">616 	</span>
<span class="line-modified">617 	</span>
<span class="line-modified">618 	System.out.println(&quot;\nNative(fields):&quot;);</span>
<span class="line-modified">619 	// Warmup</span>
<span class="line-modified">620 	for (int i = 0; i &lt; 10; i++) {</span>
<span class="line-modified">621 	    IntInt[] array = new IntInt[array_size];</span>
<span class="line-modified">622 	    initializeIntIntArrayFields(array, 42, -314);</span>
<span class="line-modified">623 	}</span>
<span class="line-modified">624 	// Measure</span>
<span class="line-modified">625 	for (int i = 0; i &lt; iterations; i++) {</span>
<span class="line-modified">626 	    IntInt[] array = new IntInt[array_size];</span>
<span class="line-modified">627 	    start[i] = System.nanoTime();</span>
<span class="line-modified">628 	    initializeIntIntArrayFields(array, 42, -314);</span>
<span class="line-modified">629 	    end[i] = System.nanoTime();</span>
<span class="line-modified">630 	}</span>
<span class="line-modified">631 	// Results</span>
<span class="line-modified">632 	computeStatistics(start, end);</span>
633     }
634 
<a name="32" id="anc32"></a><span class="line-modified">635     void mesureInitializationTime2(int array_size, int iterations) {</span>
<span class="line-modified">636 	System.out.println(&quot;\nInitialization time for Container[]:&quot;);</span>
<span class="line-modified">637 	long[] start = new long[iterations];</span>
<span class="line-modified">638 	long[] end = new long[iterations];</span>
<span class="line-modified">639 </span>
<span class="line-modified">640 	double d = 0.369852147;</span>
<span class="line-modified">641 	float f = -321.654987f;</span>
<span class="line-modified">642 	short s = -3579;</span>
<span class="line-modified">643 	byte b = 42;</span>
<span class="line-modified">644 	</span>
<span class="line-modified">645 	System.out.println(&quot;\nJava:&quot;);</span>
<span class="line-modified">646 	// Warmup</span>
<span class="line-modified">647 	for (int i = 0; i &lt; 10; i++) {</span>
<span class="line-modified">648 	    Container[] array = new Container[array_size];</span>
<span class="line-modified">649 	    initializeContainerArrayJava(array, d, f, s, b);</span>
<span class="line-modified">650 	}</span>
<span class="line-modified">651 	// Measure</span>
<span class="line-modified">652 	for (int i = 0; i &lt; iterations; i++) {</span>
<span class="line-modified">653 	    Container[] array = new Container[array_size];</span>
<span class="line-modified">654 	    start[i] = System.nanoTime();</span>
<span class="line-modified">655 	    initializeContainerArrayJava(array, d, f, s, b);</span>
<span class="line-modified">656 	    end[i] = System.nanoTime();</span>
<span class="line-modified">657 	}</span>
<span class="line-modified">658 	// Results</span>
<span class="line-modified">659 	computeStatistics(start, end);</span>
<span class="line-modified">660 </span>
<span class="line-modified">661 	System.out.println(&quot;\nNative:&quot;);</span>
<span class="line-modified">662 	// Warmup</span>
<span class="line-modified">663 	for (int i = 0; i &lt; 10; i++) {</span>
<span class="line-modified">664 	    Container[] array = new Container[array_size];</span>
<span class="line-modified">665 	    initializeContainerArray(array, d, f, s, b);</span>
<span class="line-modified">666 	}</span>
<span class="line-modified">667 	// Measure</span>
<span class="line-modified">668 	for (int i = 0; i &lt; iterations; i++) {</span>
<span class="line-modified">669 	    Container[] array = new Container[array_size];</span>
<span class="line-modified">670 	    start[i] = System.nanoTime();</span>
<span class="line-modified">671 	    initializeContainerArray(array, d, f, s, b);</span>
<span class="line-modified">672 	    end[i] = System.nanoTime();</span>
<span class="line-modified">673 	}</span>
<span class="line-modified">674 	// Results</span>
<span class="line-modified">675 	computeStatistics(start, end);</span>
676     }
677 
<a name="33" id="anc33"></a><span class="line-modified">678     void mesureUpdateTime2(int array_size, int iterations) {</span>
<span class="line-modified">679 	System.out.println(&quot;\nUpdating Container[]:&quot;);</span>
<span class="line-modified">680 	long[] start = new long[iterations];</span>
<span class="line-modified">681 	long[] end = new long[iterations];</span>
<span class="line-modified">682 </span>
<span class="line-modified">683 	double d = 0.369852147;</span>
<span class="line-modified">684 	float f = -321.654987f;</span>
<span class="line-modified">685 	short s = -3579;</span>
<span class="line-modified">686 	byte b = 42;</span>
<span class="line-modified">687 </span>
<span class="line-modified">688 	Containee c = new Containee(f,s);</span>
<span class="line-modified">689 	Container c2 = new Container(d, c, b);</span>
<span class="line-modified">690 	</span>
<span class="line-modified">691 	System.out.println(&quot;\nJava:&quot;);</span>
<span class="line-modified">692 	// Warmup</span>
<span class="line-modified">693 	for (int i = 0; i &lt; 10; i++) {</span>
<span class="line-modified">694 	    Container[] array = new Container[array_size];</span>
<span class="line-modified">695 	    for (int j = 0; j &lt; array.length; j++) {</span>
<span class="line-modified">696 		array[j] = c2;</span>
<span class="line-modified">697 	    }</span>
<span class="line-modified">698 	    updateContainerArrayJava(array, f, s);</span>
<span class="line-modified">699 	}</span>
<span class="line-modified">700 	// Measure</span>
<span class="line-modified">701 	for (int i = 0; i &lt; iterations; i++) {</span>
<span class="line-modified">702 	    Container[] array = new Container[array_size];</span>
<span class="line-modified">703 	    for (int j = 0; j &lt; array.length; j++) {</span>
<span class="line-modified">704 		array[i] = c2;</span>
<span class="line-modified">705 	    }</span>
<span class="line-modified">706 	    start[i] = System.nanoTime();</span>
<span class="line-modified">707 	    updateContainerArrayJava(array, f, s);</span>
<span class="line-modified">708 	    end[i] = System.nanoTime();</span>
<span class="line-modified">709 	}</span>
<span class="line-modified">710 	// Results</span>
<span class="line-modified">711 	computeStatistics(start, end);</span>
<span class="line-modified">712 </span>
<span class="line-modified">713 	System.out.println(&quot;\nNative:&quot;);</span>
<span class="line-modified">714 	// Warmup</span>
<span class="line-modified">715 	for (int i = 0; i &lt; 10; i++) {</span>
<span class="line-modified">716 	    Container[] array = new Container[array_size];</span>
<span class="line-modified">717 	    for (int j = 0; j &lt; array.length; j++) {</span>
<span class="line-modified">718 		array[i] = c2;</span>
<span class="line-modified">719 	    }</span>
<span class="line-modified">720 	    updateContainerArray(array, f, s);</span>
<span class="line-modified">721 	}</span>
<span class="line-modified">722 	// Measure</span>
<span class="line-modified">723 	for (int i = 0; i &lt; iterations; i++) {</span>
<span class="line-modified">724 	    Container[] array = new Container[array_size];</span>
<span class="line-modified">725 	    for (int j = 0; j &lt; array.length; j++) {</span>
<span class="line-modified">726 		array[i] = c2;</span>
<span class="line-modified">727 	    }</span>
<span class="line-modified">728 	    start[i] = System.nanoTime();</span>
<span class="line-modified">729 	    updateContainerArray(array, f, s);</span>
<span class="line-modified">730 	    end[i] = System.nanoTime();</span>
<span class="line-modified">731 	}</span>
<span class="line-modified">732 	// Results</span>
<span class="line-modified">733 	computeStatistics(start, end);</span>
734     }
<a name="34" id="anc34"></a><span class="line-modified">735     </span>
<span class="line-modified">736     void mesureSortingTime(int array_size, int iterations) {</span>
<span class="line-modified">737 	System.out.println(&quot;\nSorting time:&quot;);</span>
<span class="line-modified">738 	long[] start = new long[iterations];</span>
<span class="line-modified">739 	long[] end = new long[iterations];</span>
<span class="line-modified">740 </span>
<span class="line-modified">741 	random = new Random(seed);</span>
<span class="line-modified">742 	System.out.println(&quot;\nJava:&quot;);</span>
<span class="line-modified">743 	IntIntComparator comparator = new IntIntComparator();</span>
<span class="line-modified">744 	// Warmup</span>
<span class="line-modified">745 	for (int i = 0; i &lt; 10; i++) {</span>
<span class="line-modified">746 	    IntInt[] array = new IntInt[array_size];</span>
<span class="line-modified">747 	    array = new IntInt[array_size];</span>
<span class="line-modified">748 	    for (int j = 0; j &lt; array_size; j++) {</span>
<span class="line-modified">749 		array[j] = new IntInt(random.nextInt(), random.nextInt());</span>
<span class="line-modified">750 	    }</span>
<span class="line-modified">751 	    Arrays.sort(array, comparator);</span>
<span class="line-modified">752 	}</span>
<span class="line-modified">753 	// Measure</span>
<span class="line-modified">754 	for (int i = 0; i &lt; iterations; i++) {</span>
<span class="line-modified">755 	    IntInt[] array = new IntInt[array_size];</span>
<span class="line-modified">756 	    for (int j = 0; j &lt; array_size; j++) {</span>
<span class="line-modified">757 		array[j] = new IntInt(random.nextInt(), random.nextInt());</span>
<span class="line-modified">758 	    }</span>
<span class="line-modified">759 	    start[i] = System.nanoTime();</span>
<span class="line-modified">760 	    Arrays.sort(array, comparator);</span>
<span class="line-modified">761 	    end[i] = System.nanoTime();</span>
<span class="line-modified">762 	}</span>
<span class="line-modified">763 	// Results</span>
<span class="line-modified">764 	computeStatistics(start, end);</span>
<span class="line-modified">765 </span>
<span class="line-modified">766 	random = new Random(seed);</span>
<span class="line-modified">767 	System.out.println(&quot;\nNative:&quot;);</span>
<span class="line-modified">768 	// Warmup</span>
<span class="line-modified">769 	for (int i = 0; i &lt; 10; i++) {</span>
<span class="line-modified">770 	    IntInt[] array = new IntInt[array_size];</span>
<span class="line-modified">771 	    array = new IntInt[array_size];</span>
<span class="line-modified">772 	    for (int j = 0; j &lt; array_size; j++) {</span>
<span class="line-modified">773 		array[j] = new IntInt(random.nextInt(), random.nextInt());</span>
<span class="line-modified">774 	    }</span>
<span class="line-modified">775 	    sortIntIntArray(array);</span>
<span class="line-modified">776 	}</span>
<span class="line-modified">777 	// Measure</span>
<span class="line-modified">778 	for (int i = 0; i &lt; iterations; i++) {</span>
<span class="line-modified">779 	    IntInt[] array = new IntInt[array_size];</span>
<span class="line-modified">780 	    for (int j = 0; j &lt; array_size; j++) {</span>
<span class="line-modified">781 		array[j] = new IntInt(random.nextInt(), random.nextInt());</span>
<span class="line-modified">782 	    }</span>
<span class="line-modified">783 	    start[i] = System.nanoTime();</span>
<span class="line-modified">784 	    sortIntIntArray(array);</span>
<span class="line-modified">785 	    end[i] = System.nanoTime();</span>
<span class="line-modified">786 	}</span>
<span class="line-modified">787 	// Results</span>
<span class="line-modified">788 	computeStatistics(start, end);</span>
789     }
790 
791 
<a name="35" id="anc35"></a><span class="line-modified">792     void mesureInitializationTime3(int array_size, int iterations) {</span>
<span class="line-modified">793 	System.out.println(&quot;\nInitialization time for LongLongLongLong[]:&quot;);</span>
<span class="line-modified">794 	long[] start = new long[iterations];</span>
<span class="line-modified">795 	long[] end = new long[iterations];</span>
<span class="line-modified">796 </span>
<span class="line-modified">797 	long l0 = 123456;</span>
<span class="line-modified">798 	long l1 = -987654;</span>
<span class="line-modified">799 	long l2 = 192837;</span>
<span class="line-modified">800 	long l3 = -56473829;</span>
<span class="line-modified">801 	</span>
<span class="line-modified">802 	System.out.println(&quot;\nJava:&quot;);</span>
<span class="line-modified">803 	// Warmup</span>
<span class="line-modified">804 	for (int i = 0; i &lt; 10; i++) {</span>
<span class="line-modified">805 	    LongLongLongLong[] array = new LongLongLongLong[array_size];</span>
<span class="line-modified">806 	    initializeLongLongLongLongArrayJava(array, l0, l1, l2, l3);</span>
<span class="line-modified">807 	}</span>
<span class="line-modified">808 	// Measure</span>
<span class="line-modified">809 	for (int i = 0; i &lt; iterations; i++) {</span>
<span class="line-modified">810 	    LongLongLongLong[] array = new LongLongLongLong[array_size];</span>
<span class="line-modified">811 	    start[i] = System.nanoTime();</span>
<span class="line-modified">812 	    initializeLongLongLongLongArrayJava(array, l0, l1, l2, l3);</span>
<span class="line-modified">813 	    end[i] = System.nanoTime();</span>
<span class="line-modified">814 	}</span>
<span class="line-modified">815 	// Results</span>
<span class="line-modified">816 	computeStatistics(start, end);</span>
<span class="line-modified">817 </span>
<span class="line-modified">818 	System.out.println(&quot;\nNative:&quot;);</span>
<span class="line-modified">819 	// Warmup</span>
<span class="line-modified">820 	for (int i = 0; i &lt; 10; i++) {</span>
<span class="line-modified">821 	    LongLongLongLong[] array = new LongLongLongLong[array_size];</span>
<span class="line-modified">822 	    initializeLongLongLongLongArray(array, l0, l1, l2, l3);</span>
<span class="line-modified">823 	}</span>
<span class="line-modified">824 	// Measure</span>
<span class="line-modified">825 	for (int i = 0; i &lt; iterations; i++) {</span>
<span class="line-modified">826 	    LongLongLongLong[] array = new LongLongLongLong[array_size];</span>
<span class="line-modified">827 	    start[i] = System.nanoTime();</span>
<span class="line-modified">828 	    initializeLongLongLongLongArray(array, l0, l1, l2, l3);</span>
<span class="line-modified">829 	    end[i] = System.nanoTime();</span>
<span class="line-modified">830 	}</span>
<span class="line-modified">831 	// Results</span>
<span class="line-modified">832 	computeStatistics(start, end);</span>
833     }
<a name="36" id="anc36"></a><span class="line-modified">834     </span>
835     void computeStatistics(long[] start, long[] end) {
<a name="37" id="anc37"></a><span class="line-modified">836 	int iterations = start.length;</span>
<span class="line-modified">837 	long[] duration = new long[iterations];</span>
<span class="line-modified">838 	long sum = 0;</span>
<span class="line-modified">839 	long min = end[0] - start[0];</span>
<span class="line-modified">840 	long max = min;</span>
<span class="line-modified">841 	double var = 0.0;</span>
<span class="line-modified">842 	for (int i = 0 ; i &lt; iterations; i++) {</span>
<span class="line-modified">843 	    duration[i] = end[i] - start[i];</span>
<span class="line-modified">844 	    if (duration[i] &lt; min) min = duration[i];</span>
<span class="line-modified">845 	    if (duration[i] &gt; max) max = duration[i];</span>
<span class="line-modified">846 	    sum += duration[i];</span>
<span class="line-modified">847 	    double d = (double) duration[i];</span>
<span class="line-modified">848 	    var += Math.pow(d, 2);</span>
<span class="line-modified">849 	}</span>
<span class="line-modified">850 	double avg = (sum/iterations) / 1000;</span>
<span class="line-modified">851 	double std = (Math.sqrt(var/iterations - Math.pow(sum/iterations, 2))) / 1000;</span>
<span class="line-modified">852 	System.out.println(String.format(&quot;Avg: %8.2f us&quot;, avg));</span>
<span class="line-modified">853 	System.out.println(String.format(&quot;Std: %8.2f us&quot;, std));</span>
<span class="line-modified">854 	System.out.println(String.format(&quot;Min: %8d us&quot;, (min/1000)));</span>
<span class="line-modified">855 	System.out.println(String.format(&quot;Max: %8d us&quot;, (max/1000)));</span>
856     }
857 
858     native int GetFlattenedArrayElementSizeWrapper(Object array);
859     native Class GetFlattenedArrayElementClassWrapper(Object array);
860     native long GetFlattenedArrayElementsWrapper(Object array);
861     native void ReleaseFlattenedArrayElementsWrapper(Object array, long addr,int mode);
862     native int GetFieldOffsetInFlattenedLayoutWrapper(Class klass, String name, String signature, boolean flattened);
<a name="38" id="anc38"></a><span class="line-modified">863     </span>
864     native int getIntFieldAtIndex(Object[] array, int index, String fieldName, String FieldSignature);
865     native void printArrayInformation(Object[] array);
866 
867     native void initializeIntIntArrayBuffer(Object[] array, int i0, int i1);
868     native void initializeIntIntArrayFields(Object[] array, int i0, int i1);
869     native void sortIntIntArray(Object[] array);
870 
871     native void initializeContainerArray(Object[] array, double d, float f, short s, byte b);
872     native void updateContainerArray(Object[] array, float f, short s);
873 
874     native void initializeLongLongLongLongArray(Object[] array, long l0, long l1, long l2, long l3);
875 
876     native SubElementSelector createSubElementSelector(Object[] array);
877     native SubElementSelector getSubElementSelector(SubElementSelector selector, Class&lt;?&gt; klass, String name, String signature);
878     native Object getObjectSubElement(Object[] array, SubElementSelector selector, int index);
879     native void setObjectSubElement(Object[] array, SubElementSelector selector, int index, Object value);
880 
881     native short getShortSubElement(Object[] array, SubElementSelector selector, int index);
882     native void setShortSubElement(Object[] array, SubElementSelector selector, int index, short value);
883     native int getIntSubElement(Object[] array, SubElementSelector selector, int index);
884     native void setIntSubElement(Object[] array, SubElementSelector selector, int index, int value);
885 }
<a name="39" id="anc39"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="39" type="hidden" />
</body>
</html>