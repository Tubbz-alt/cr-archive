<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames test/hotspot/jtreg/runtime/valhalla/valuetypes/TestJNIArrays.java</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
<a name="1" id="anc1"></a><span class="line-modified">  2  * Copyright (c) 2019, 2020, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 
 25 import jdk.test.lib.Asserts;
 26 
 27 import java.lang.reflect.*;
 28 import java.util.Random;
 29 import java.util.Arrays;
 30 import java.util.Comparator;
 31 
 32 import jdk.internal.misc.Unsafe;
 33 import jdk.internal.vm.jni.SubElementSelector;
 34 
 35 /*
 36  * @test
 37  * @summary Test flattened arrays accesses through JNI
 38  * @modules java.base/jdk.internal.misc java.base/jdk.internal.vm.jni
 39  * @library /testlibrary /test/lib
 40  * @requires (os.simpleArch == &quot;x64&quot;)
 41  * @requires (os.family == &quot;linux&quot; | os.family == &quot;mac&quot;)
<a name="2" id="anc2"></a><span class="line-modified"> 42  * @compile -XDallowWithFieldOperator TestJNIArrays.java</span>
 43  * @run main/othervm/native/timeout=3000 -XX:ValueArrayElemMaxFlatSize=128 -XX:+PrintFlattenableLayouts -XX:+UseCompressedOops TestJNIArrays
 44  * @run main/othervm/native/timeout=3000 -XX:ValueArrayElemMaxFlatSize=128 -XX:+PrintFlattenableLayouts -XX:-UseCompressedOops TestJNIArrays
 45  */
<a name="3" id="anc3"></a>
 46 public class TestJNIArrays {
 47 
 48     static final Unsafe U = Unsafe.getUnsafe();
<a name="4" id="anc4"></a><span class="line-modified"> 49 </span>
 50     public static final int ARRAY_SIZE = 1024;
 51     static long seed;
 52     static Random random;
 53 
 54     static {
<a name="5" id="anc5"></a><span class="line-modified"> 55         seed = System.nanoTime();</span>
<span class="line-modified"> 56         System.out.println(&quot;Seed = &quot; + seed);</span>
<span class="line-modified"> 57         random = new Random(seed);</span>
 58     }
 59 
 60     static {
 61         System.loadLibrary(&quot;TestJNIArrays&quot;);
 62     }
 63 
 64     static inline class IntInt {
<a name="6" id="anc6"></a><span class="line-modified"> 65         int i0;</span>
<span class="line-modified"> 66         int i1;</span>
 67 
<a name="7" id="anc7"></a><span class="line-modified"> 68         public IntInt(int i0, int i1) {</span>
<span class="line-modified"> 69             this.i0 = i0;</span>
<span class="line-modified"> 70             this.i1 = i1;</span>
<span class="line-modified"> 71         }</span>
 72     }
 73 
<a name="8" id="anc8"></a><span class="line-modified"> 74     static class IntIntComparator implements Comparator&lt;IntInt.ref&gt; {</span>
<span class="line-modified"> 75         public int compare(IntInt.ref a, IntInt.ref b) {</span>
<span class="line-modified"> 76             if (a.i0 &lt; b.i0) return -1;</span>
<span class="line-modified"> 77             if (a.i0 &gt; b.i0) return 1;</span>
<span class="line-modified"> 78             if (a.i1 &lt; b.i1) return -1;</span>
<span class="line-modified"> 79             if (a.i1 &gt; b.i1) return 1;</span>
<span class="line-modified"> 80             return 0;</span>
<span class="line-modified"> 81         }</span>
 82     }
 83 
 84     static inline class Containee {
<a name="9" id="anc9"></a><span class="line-modified"> 85         float f;</span>
<span class="line-modified"> 86         short s;</span>
 87 
<a name="10" id="anc10"></a><span class="line-modified"> 88         Containee(float f, short s) {</span>
<span class="line-modified"> 89             this.f = f;</span>
<span class="line-modified"> 90             this.s = s;</span>
<span class="line-modified"> 91         }</span>
 92     }
<a name="11" id="anc11"></a>




 93 
<a name="12" id="anc12"></a><span class="line-modified"> 94     static inline class Container {</span>
<span class="line-modified"> 95         double d;</span>
<span class="line-modified"> 96         Containee c;</span>
<span class="line-modified"> 97         byte b;</span>
<span class="line-modified"> 98 </span>
<span class="line-added"> 99         Container(double d, Containee c, byte b) {</span>
<span class="line-added">100             this.d = d ;</span>
<span class="line-added">101             this.c = c;</span>
<span class="line-added">102             this.b = b;</span>
<span class="line-added">103         }</span>
104 
<a name="13" id="anc13"></a><span class="line-modified">105         Container setc(Containee c) {</span>
106             Container res = __WithField(this.c, c);
107             return res;
108         }
109 
110     }
111 
112     static inline class LongLongLongLong {
<a name="14" id="anc14"></a><span class="line-modified">113         long l0, l1, l2, l3;</span>
<span class="line-modified">114 </span>
<span class="line-modified">115         public LongLongLongLong(long l0, long l1, long l2, long l3) {</span>
<span class="line-modified">116             this.l0 = l0;</span>
<span class="line-modified">117             this.l1 = l1;</span>
<span class="line-modified">118             this.l2 = l2;</span>
<span class="line-modified">119             this.l3 = l3;</span>
<span class="line-modified">120         }</span>
121     }
122 
123     static inline class BigValue {
<a name="15" id="anc15"></a><span class="line-modified">124         long l0 = 0, l1 = 0,   l2 = 0, l3 = 0, l4 = 0, l5 = 0, l6 = 0, l7 = 0, l8 = 0, l9 = 0;</span>
<span class="line-modified">125         long l10 = 0, l11 = 0, l12 = 0, l13 = 0, l14 = 0, l15 = 0, l16 = 0, l17 = 0, l18 = 0, l19 = 0;</span>
<span class="line-modified">126         long l20 = 0, l21 = 0, l22 = 0, l23 = 0, l24 = 0, l25 = 0, l26 = 0, l27 = 0, l28 = 0, l29 = 0;</span>
<span class="line-modified">127         long l30 = 0, l31 = 0, l32 = 0, l33 = 0, l34 = 0, l35 = 0, l36 = 0, l37 = 0, l38 = 0, l39 = 0;</span>
128     }
129 
130     static inline class ValueWithOops {
<a name="16" id="anc16"></a><span class="line-modified">131         String s = &quot;bonjour&quot;;</span>
<span class="line-modified">132         int i = 0;</span>
<span class="line-modified">133         Containee c = new Containee(2.3f, (short)4);</span>
<span class="line-modified">134         BigValue b = new BigValue();</span>
135     }
<a name="17" id="anc17"></a><span class="line-modified">136 </span>
137     public static void main(String[] args) {
<a name="18" id="anc18"></a><span class="line-modified">138         TestJNIArrays test = new TestJNIArrays();</span>
<span class="line-modified">139         test.checkGetFlattenedArrayElementSize();</span>
<span class="line-modified">140         test.checkGetFlattenedArrayElementClass();</span>
<span class="line-modified">141         test.checkGetFieldOffsetInFlattenedLayout();</span>
<span class="line-modified">142         test.checkGetFlattenedArrayElements();</span>
<span class="line-modified">143         test.checkSubElementAPI();</span>
<span class="line-modified">144         test.checkBehaviors();</span>
<span class="line-modified">145 </span>
<span class="line-modified">146         // TODO: move these to micro-benchmark or out of tier1 testing...</span>
<span class="line-modified">147         // test.measureInitializationTime(1024 * 1024 * 10 , 1000);</span>
<span class="line-modified">148         // test.measureInitializationTime2(1024 * 1024 * 10 , 1000);</span>
<span class="line-modified">149         // test.measureUpdateTime2(1024 * 1024 * 10, 1000);</span>
<span class="line-added">150         // test.measureSortingTime(1024 * 1024, 100); // reduced number of iterations because Java sorting is slow (because of generics?)</span>
<span class="line-added">151         //test.measureInitializationTime3(1024 * 1024 * 2 , 10);</span>
152     }
153 
154     void checkSubElementAPI() {
<a name="19" id="anc19"></a><span class="line-modified">155         Throwable e = null;</span>
<span class="line-modified">156         ValueWithOops[] arrayWithOops = new ValueWithOops[100];</span>
<span class="line-modified">157         ValueWithOops v = new ValueWithOops();</span>
<span class="line-modified">158         for (int i = 0; i &lt; 100; i++) {</span>
<span class="line-modified">159             arrayWithOops[i] = v;</span>
<span class="line-modified">160         }</span>
<span class="line-modified">161         SubElementSelector selector1 = createSubElementSelector(arrayWithOops);</span>
<span class="line-modified">162         SubElementSelector selector2 = getSubElementSelector(selector1, ValueWithOops.class, &quot;s&quot;, &quot;Ljava/lang/String;&quot;);</span>
<span class="line-modified">163         String s = (String) getObjectSubElement(arrayWithOops, selector2, 1);</span>
<span class="line-modified">164         System.out.println(&quot;s = &quot; + s);</span>
<span class="line-modified">165         Asserts.assertEquals(s.equals(&quot;bonjour&quot;), true, &quot;Wrong string, expecting \&quot;bonjour\&quot;, got &quot; + s);</span>
<span class="line-modified">166         SubElementSelector selector3 = getSubElementSelector(selector1, ValueWithOops.class, &quot;c&quot;, &quot;QTestJNIArrays$Containee;&quot;);</span>
<span class="line-modified">167         Containee c = (Containee) getObjectSubElement(arrayWithOops, selector3, 2);</span>
<span class="line-modified">168         Asserts.assertEquals(c.f, 2.3f, &quot;Wrong float value: &quot; + c.f);</span>
<span class="line-modified">169         Asserts.assertEquals(c.s, (short)4, &quot;Wrong short value &quot; + c.s);</span>
<span class="line-modified">170         setObjectSubElement(arrayWithOops, selector2, 1, &quot;Hello&quot;);</span>
<span class="line-modified">171         Asserts.assertEquals(arrayWithOops[1].s.equals(&quot;Hello&quot;), true, &quot;Wrong string, expecting \&quot;Hello\&quot;, got &quot; + s);</span>
<span class="line-modified">172         Integer myInteger = new Integer(345);</span>
<span class="line-modified">173         e = null;</span>
<span class="line-modified">174         try {</span>
<span class="line-modified">175             setObjectSubElement(arrayWithOops, selector2, 1, myInteger);</span>
<span class="line-modified">176         } catch(Throwable t) {</span>
<span class="line-modified">177             e = t;</span>
<span class="line-modified">178         }</span>
<span class="line-modified">179         Asserts.assertNotNull(e, &quot;An exception should have been thrown&quot;);</span>
<span class="line-modified">180         Asserts.assertEquals(e.getClass(), java.lang.ArrayStoreException.class, &quot;Wrong exception type&quot;);</span>
<span class="line-modified">181         c = new Containee(9.8f, (short)-3);</span>
<span class="line-modified">182         setObjectSubElement(arrayWithOops, selector3, 2, c);</span>
<span class="line-modified">183         Asserts.assertEquals(c.f, 9.8f, &quot;Wrong float value: &quot; + c.f);</span>
<span class="line-modified">184         Asserts.assertEquals(c.s, (short)-3, &quot;Wrong short value &quot; + c.s);</span>
<span class="line-modified">185         e = null;</span>
<span class="line-modified">186         try {</span>
<span class="line-modified">187             setObjectSubElement(arrayWithOops, selector3, 2, null);</span>
<span class="line-modified">188         } catch(Throwable t) {</span>
<span class="line-modified">189             e = t;</span>
<span class="line-modified">190         }</span>
<span class="line-modified">191         Asserts.assertNotNull(e, &quot;An exception should have been thrown&quot;);</span>
<span class="line-modified">192         Asserts.assertEquals(e.getClass(), java.lang.ArrayStoreException.class, &quot;Wrong exception type&quot;);</span>
<span class="line-modified">193         SubElementSelector selector4 = getSubElementSelector(selector3, TestJNIArrays.Containee.class, &quot;s&quot;, &quot;S&quot;);</span>
<span class="line-modified">194         short s2 = getShortSubElement(arrayWithOops, selector4, 3);</span>
<span class="line-modified">195         Asserts.assertEquals(s2, (short)4, &quot;Wrong short value &quot; + s2);</span>
<span class="line-modified">196         setShortSubElement(arrayWithOops, selector4, 3, (short)7);</span>
<span class="line-modified">197         Asserts.assertEquals(arrayWithOops[3].c.s, (short)7, &quot;Wrong short value &quot; + arrayWithOops[3].c.s);</span>
<span class="line-modified">198         e = null;</span>
<span class="line-modified">199         try {</span>
<span class="line-modified">200             // should fail because selector4 designates a field with type short, not int</span>
<span class="line-modified">201             getIntSubElement(arrayWithOops, selector4, 3);</span>
<span class="line-modified">202         } catch(Throwable t) {</span>
<span class="line-modified">203             e = t;</span>
<span class="line-modified">204         }</span>
<span class="line-modified">205         Asserts.assertNotNull(e, &quot;An exception should have been thrown&quot;);</span>
<span class="line-modified">206         Asserts.assertEquals(e.getClass(), java.lang.IllegalArgumentException.class, &quot;Wrong exception type&quot;);</span>
<span class="line-modified">207         SubElementSelector selector5 = getSubElementSelector(selector1, ValueWithOops.class, &quot;b&quot;, &quot;QTestJNIArrays$BigValue;&quot;);</span>
<span class="line-modified">208         e = null;</span>
<span class="line-modified">209         try {</span>
<span class="line-modified">210             // Should fail because selector5 designates a non-flattened field</span>
<span class="line-modified">211             SubElementSelector selector6 = getSubElementSelector(selector5, TestJNIArrays.BigValue.class, &quot;l0&quot;, &quot;J&quot;);</span>
<span class="line-modified">212         } catch(Throwable t) {</span>
<span class="line-modified">213             e = t;</span>
<span class="line-modified">214         }</span>
<span class="line-modified">215         Asserts.assertNotNull(e, &quot;An exception should have been thrown&quot;);</span>
<span class="line-modified">216         Asserts.assertEquals(e.getClass(), java.lang.IllegalArgumentException.class, &quot;Wrong exception type&quot;);</span>
<span class="line-modified">217         System.gc();</span>
218     }
<a name="20" id="anc20"></a><span class="line-modified">219 </span>
220     void checkGetFlattenedArrayElementSize() {
<a name="21" id="anc21"></a><span class="line-modified">221         Throwable exception = null;</span>
<span class="line-modified">222         try {</span>
<span class="line-modified">223             Object o = new Object();</span>
<span class="line-modified">224             GetFlattenedArrayElementSizeWrapper(o);</span>
<span class="line-modified">225         } catch(Throwable t) {</span>
<span class="line-modified">226             exception = t;</span>
<span class="line-modified">227         }</span>
<span class="line-modified">228         Asserts.assertNotNull(exception, &quot;An IAE should have been thrown&quot;);</span>
<span class="line-modified">229         Asserts.assertEquals(exception.getClass(), IllegalArgumentException.class , &quot;Wrong exception type&quot;);</span>
<span class="line-modified">230         exception = null;</span>
<span class="line-modified">231         try {</span>
<span class="line-modified">232             int[] array = new int[16];</span>
<span class="line-modified">233             Object o = array;</span>
<span class="line-modified">234             GetFlattenedArrayElementSizeWrapper(o);</span>
<span class="line-modified">235         } catch(Throwable t) {</span>
<span class="line-modified">236             exception = t;</span>
<span class="line-modified">237         }</span>
<span class="line-modified">238         Asserts.assertNotNull(exception, &quot;An IAE should have been thrown&quot;);</span>
<span class="line-modified">239         Asserts.assertEquals(exception.getClass(), IllegalArgumentException.class , &quot;Wrong exception type&quot;);</span>
<span class="line-modified">240         exception = null;</span>
<span class="line-modified">241         try {</span>
<span class="line-modified">242             GetFlattenedArrayElementSizeWrapper(new String[16]);</span>
<span class="line-modified">243         } catch(Throwable t) {</span>
<span class="line-modified">244             exception = t;</span>
<span class="line-modified">245         }</span>
<span class="line-modified">246         Asserts.assertNotNull(exception, &quot;An IAE should have been thrown&quot;);</span>
<span class="line-modified">247         Asserts.assertEquals(exception.getClass(), IllegalArgumentException.class , &quot;Wrong exception type&quot;);</span>
<span class="line-modified">248         exception = null;</span>
<span class="line-modified">249         try {</span>
<span class="line-modified">250             // Array of BigValue should not be flattened because BigValue is *big*</span>
<span class="line-modified">251             GetFlattenedArrayElementSizeWrapper(new BigValue[16]);</span>
<span class="line-modified">252         } catch(Throwable t) {</span>
<span class="line-modified">253             exception = t;</span>
<span class="line-modified">254         }</span>
<span class="line-modified">255         Asserts.assertNotNull(exception, &quot;An IAE should have been thrown&quot;);</span>
<span class="line-modified">256         Asserts.assertTrue(exception instanceof IllegalArgumentException , &quot;Exception should be a IAE&quot;);</span>
<span class="line-modified">257         exception = null;</span>
<span class="line-modified">258         int size = -1;</span>
<span class="line-modified">259         try {</span>
<span class="line-modified">260             size = GetFlattenedArrayElementSizeWrapper(new IntInt[16]);</span>
<span class="line-modified">261         } catch(Throwable t) {</span>
<span class="line-modified">262             exception = t;</span>
<span class="line-modified">263         }</span>
<span class="line-modified">264         Asserts.assertNull(exception, &quot;No exception should have been thrown&quot;);</span>
<span class="line-modified">265         Asserts.assertEquals(size, 8, &quot;Wrong size&quot;);</span>
266     }
267 
268     void checkGetFlattenedArrayElementClass() {
<a name="22" id="anc22"></a><span class="line-modified">269         Throwable exception = null;</span>
<span class="line-modified">270         try {</span>
<span class="line-modified">271             Object o = new Object();</span>
<span class="line-modified">272             GetFlattenedArrayElementClassWrapper(o);</span>
<span class="line-modified">273         } catch(Throwable t) {</span>
<span class="line-modified">274             exception = t;</span>
<span class="line-modified">275         }</span>
<span class="line-modified">276         Asserts.assertNotNull(exception, &quot;An IAE should have been thrown&quot;);</span>
<span class="line-modified">277         Asserts.assertEquals(exception.getClass(), IllegalArgumentException.class , &quot;Wrong exception type&quot;);</span>
<span class="line-modified">278         exception = null;</span>
<span class="line-modified">279         try {</span>
<span class="line-modified">280             int[] array = new int[16];</span>
<span class="line-modified">281             Object o = array;</span>
<span class="line-modified">282             GetFlattenedArrayElementClassWrapper(o);</span>
<span class="line-modified">283         } catch(Throwable t) {</span>
<span class="line-modified">284             exception = t;</span>
<span class="line-modified">285         }</span>
<span class="line-modified">286         Asserts.assertNotNull(exception, &quot;An IAE should have been thrown&quot;);</span>
<span class="line-modified">287         Asserts.assertEquals(exception.getClass(), IllegalArgumentException.class , &quot;Wrong exception type&quot;);</span>
<span class="line-modified">288         exception = null;</span>
<span class="line-modified">289         try {</span>
<span class="line-modified">290             GetFlattenedArrayElementClassWrapper(new String[16]);</span>
<span class="line-modified">291         } catch(Throwable t) {</span>
<span class="line-modified">292             exception = t;</span>
<span class="line-modified">293         }</span>
<span class="line-modified">294         Asserts.assertNotNull(exception, &quot;An IAE should have been thrown&quot;);</span>
<span class="line-modified">295         Asserts.assertEquals(exception.getClass(), IllegalArgumentException.class , &quot;Wrong exception type&quot;);</span>
<span class="line-modified">296         exception = null;</span>
<span class="line-modified">297         try {</span>
<span class="line-modified">298             // Array of BigValue should not be flattened because BigValue is *big*</span>
<span class="line-modified">299             GetFlattenedArrayElementClassWrapper(new BigValue[16]);</span>
<span class="line-modified">300         } catch(Throwable t) {</span>
<span class="line-modified">301             exception = t;</span>
<span class="line-modified">302         }</span>
<span class="line-modified">303         Asserts.assertNotNull(exception, &quot;An IAE should have been thrown&quot;);</span>
<span class="line-modified">304         Asserts.assertTrue(exception instanceof IllegalArgumentException , &quot;Exception should be a IAE&quot;);</span>
<span class="line-modified">305         exception = null;</span>
<span class="line-modified">306         Class c = null;</span>
<span class="line-modified">307         try {</span>
<span class="line-modified">308             c = GetFlattenedArrayElementClassWrapper(new IntInt[16]);</span>
<span class="line-modified">309         } catch(Throwable t) {</span>
<span class="line-modified">310             exception = t;</span>
<span class="line-modified">311         }</span>
<span class="line-modified">312         Asserts.assertNull(exception, &quot;No exception should have been thrown&quot;);</span>
<span class="line-modified">313         Asserts.assertEquals(c, IntInt.class, &quot;Wrong class&quot;);</span>
314     }
315 
316     void checkGetFieldOffsetInFlattenedLayout() {
<a name="23" id="anc23"></a><span class="line-modified">317         Throwable exception = null;</span>
<span class="line-modified">318         try {</span>
<span class="line-modified">319             Object o = new Object();</span>
<span class="line-modified">320             GetFieldOffsetInFlattenedLayoutWrapper(o.getClass(), &quot;foo&quot;, &quot;I&quot;, true);</span>
<span class="line-modified">321         } catch(Throwable t) {</span>
<span class="line-modified">322             exception = t;</span>
<span class="line-modified">323         }</span>
<span class="line-modified">324         Asserts.assertNotNull(exception, &quot;An IAE should have been thrown&quot;);</span>
<span class="line-modified">325         Asserts.assertEquals(exception.getClass(), IllegalArgumentException.class , &quot;Wrong exception type&quot;);</span>
<span class="line-modified">326         exception = null;</span>
<span class="line-modified">327         try {</span>
<span class="line-modified">328             int[] array = new int[16];</span>
<span class="line-modified">329             GetFieldOffsetInFlattenedLayoutWrapper(array.getClass(), &quot;foo&quot;, &quot;I&quot;, true);</span>
<span class="line-modified">330         } catch(Throwable t) {</span>
<span class="line-modified">331             exception = t;</span>
<span class="line-modified">332         }</span>
<span class="line-modified">333         Asserts.assertNotNull(exception, &quot;An IAE should have been thrown&quot;);</span>
<span class="line-modified">334         Asserts.assertEquals(exception.getClass(), IllegalArgumentException.class , &quot;Wrong exception type&quot;);</span>
<span class="line-modified">335         exception = null;</span>
<span class="line-modified">336         try {</span>
<span class="line-modified">337             String[] array = new String[16];</span>
<span class="line-modified">338             GetFieldOffsetInFlattenedLayoutWrapper(array.getClass(), &quot;foo&quot;, &quot;I&quot;, true);</span>
<span class="line-modified">339         } catch(Throwable t) {</span>
<span class="line-modified">340             exception = t;</span>
<span class="line-modified">341         }</span>
<span class="line-modified">342         Asserts.assertNotNull(exception, &quot;An IAE should have been thrown&quot;);</span>
<span class="line-modified">343         Asserts.assertEquals(exception.getClass(), IllegalArgumentException.class , &quot;Wrong exception type&quot;);</span>
<span class="line-modified">344         exception = null;</span>
<span class="line-modified">345         Containee ce  = new Containee(3.4f, (short)5);</span>
<span class="line-modified">346         Container c = new Container(123.876, ce, (byte)7);</span>
<span class="line-modified">347         Class&lt;?&gt; cclass = c.getClass();</span>
<span class="line-modified">348         Container[] containerArray = new Container[32];</span>
<span class="line-modified">349         int elementSize = GetFlattenedArrayElementSizeWrapper(containerArray);</span>
<span class="line-modified">350         int offset = -1;</span>
<span class="line-modified">351         try {</span>
<span class="line-modified">352             offset = GetFieldOffsetInFlattenedLayoutWrapper(cclass, &quot;d&quot;, &quot;D&quot;, false);</span>
<span class="line-modified">353         } catch(Throwable t) {</span>
<span class="line-modified">354             exception = t;</span>
<span class="line-modified">355         }</span>
<span class="line-modified">356         Asserts.assertNull(exception, &quot;No exception should have been thrown&quot;);</span>
<span class="line-modified">357         Field f = null;</span>
<span class="line-modified">358         try {</span>
<span class="line-modified">359             f = cclass.getDeclaredField(&quot;d&quot;);</span>
<span class="line-modified">360         } catch(NoSuchFieldException e) {</span>
<span class="line-modified">361             e.printStackTrace();</span>
<span class="line-modified">362             return;</span>
<span class="line-modified">363         }</span>
<span class="line-modified">364         Asserts.assertEquals(U.valueHeaderSize(cclass) + offset, U.objectFieldOffset(cclass, f.getName()),</span>
<span class="line-modified">365                              &quot;Incorrect offset&quot;);</span>
<span class="line-modified">366         Asserts.assertLessThan(offset, elementSize, &quot;Invalid offset&quot;);</span>
<span class="line-modified">367         exception = null;</span>
<span class="line-modified">368         try {</span>
<span class="line-modified">369             // Field c should be flattened, so last argument is true, no exception expected</span>
<span class="line-modified">370             GetFieldOffsetInFlattenedLayoutWrapper(cclass, &quot;c&quot;, &quot;QTestJNIArrays$Containee;&quot;, true);</span>
<span class="line-modified">371         } catch(Throwable t) {</span>
<span class="line-modified">372             exception = t;</span>
<span class="line-modified">373         }</span>
<span class="line-modified">374         Asserts.assertNull(exception, &quot;No exception should have been thrown&quot;);</span>
<span class="line-modified">375         Asserts.assertLessThan(offset, elementSize, &quot;Invalid offset&quot;);</span>
<span class="line-modified">376         exception = null;</span>
<span class="line-modified">377         try {</span>
<span class="line-modified">378             // Field c should be flattened, with last argument being false, exception expected from the wrapper</span>
<span class="line-modified">379             GetFieldOffsetInFlattenedLayoutWrapper(cclass, &quot;c&quot;, &quot;QTestJNIArrays$Containee;&quot;, false);</span>
<span class="line-modified">380         } catch(Throwable t) {</span>
<span class="line-modified">381             exception = t;</span>
<span class="line-modified">382         }</span>
<span class="line-modified">383         Asserts.assertNotNull(exception, &quot;Wrapper should have thrown a RuntimeException&quot;);</span>
<span class="line-modified">384         Asserts.assertEquals(exception.getClass(), RuntimeException.class , &quot;Wrong exception type&quot;);</span>
385     }
<a name="24" id="anc24"></a><span class="line-modified">386 </span>
<span class="line-modified">387     void checkGetFlattenedArrayElements() {</span>
<span class="line-modified">388         Throwable exception = null;</span>
<span class="line-modified">389         Object o = new Object();</span>
<span class="line-modified">390         try {</span>
<span class="line-modified">391             GetFlattenedArrayElementsWrapper(o);</span>
<span class="line-modified">392         } catch(Throwable t) {</span>
<span class="line-modified">393             exception = t;</span>
<span class="line-modified">394         }</span>
<span class="line-modified">395         Asserts.assertNotNull(exception, &quot;An IAE should have been thrown&quot;);</span>
<span class="line-modified">396         Asserts.assertEquals(exception.getClass(), IllegalArgumentException.class , &quot;Wrong exception type&quot;);</span>
<span class="line-modified">397         exception = null;</span>
<span class="line-modified">398         int[] a1 = new int[16];</span>
<span class="line-modified">399         o = a1;</span>
<span class="line-modified">400         try {</span>
<span class="line-modified">401             GetFlattenedArrayElementsWrapper(o);</span>
<span class="line-modified">402         } catch(Throwable t) {</span>
<span class="line-modified">403             exception = t;</span>
<span class="line-modified">404         }</span>
<span class="line-modified">405         Asserts.assertNotNull(exception, &quot;An IAE should have been thrown&quot;);</span>
<span class="line-modified">406         Asserts.assertEquals(exception.getClass(), IllegalArgumentException.class , &quot;Wrong exception type&quot;);</span>
<span class="line-modified">407         exception = null;</span>
<span class="line-modified">408         try {</span>
<span class="line-modified">409             GetFlattenedArrayElementsWrapper(new String[16]);</span>
<span class="line-modified">410         } catch(Throwable t) {</span>
<span class="line-modified">411             exception = t;</span>
<span class="line-modified">412         }</span>
<span class="line-modified">413         Asserts.assertNotNull(exception, &quot;An IAE should have been thrown&quot;);</span>
<span class="line-modified">414         Asserts.assertEquals(exception.getClass(), IllegalArgumentException.class , &quot;Wrong exception type&quot;);</span>
<span class="line-modified">415         exception = null;</span>
<span class="line-modified">416         try {</span>
<span class="line-modified">417             // Array of BigValue should not be flattened because BigValue is *big*</span>
<span class="line-modified">418             GetFlattenedArrayElementsWrapper(new BigValue[16]);</span>
<span class="line-modified">419         } catch(Throwable t) {</span>
<span class="line-modified">420             exception = t;</span>
<span class="line-modified">421         }</span>
<span class="line-modified">422         Asserts.assertNotNull(exception, &quot;An IAE should have been thrown&quot;);</span>
<span class="line-modified">423         Asserts.assertTrue(exception instanceof IllegalArgumentException , &quot;Exception should be a IAE&quot;);</span>
<span class="line-modified">424         exception = null;</span>
<span class="line-modified">425         try {</span>
<span class="line-modified">426             // Direct native access to flattened arrays is not allowed if elements contain oops</span>
<span class="line-modified">427             GetFlattenedArrayElementsWrapper(new ValueWithOops[16]);</span>
<span class="line-modified">428         } catch(Throwable t) {</span>
<span class="line-modified">429             exception = t;</span>
<span class="line-modified">430         }</span>
<span class="line-modified">431         Asserts.assertNotNull(exception, &quot;An IAE should have been thrown&quot;);</span>
<span class="line-modified">432         Asserts.assertTrue(exception instanceof IllegalArgumentException , &quot;Exception should be a IAE&quot;);</span>
<span class="line-modified">433         exception = null;</span>
<span class="line-modified">434         long addr = 0;</span>
<span class="line-modified">435         IntInt[] a2 = new IntInt[16];</span>
<span class="line-modified">436         try {</span>
<span class="line-modified">437             addr = GetFlattenedArrayElementsWrapper(a2);</span>
<span class="line-modified">438         } catch(Throwable t) {</span>
<span class="line-modified">439             exception = t;</span>
<span class="line-modified">440         }</span>
<span class="line-modified">441         Asserts.assertNull(exception, &quot;No exception should have been thrown&quot;);</span>
<span class="line-modified">442         if (exception == null) {</span>
<span class="line-modified">443             ReleaseFlattenedArrayElementsWrapper(a2, addr, 0);</span>
<span class="line-modified">444         }</span>
445     }
<a name="25" id="anc25"></a><span class="line-modified">446 </span>
447     void checkBehaviors() {
<a name="26" id="anc26"></a><span class="line-modified">448         System.out.println(&quot;Check 1&quot;);</span>
<span class="line-modified">449         IntInt[] array = new IntInt[ARRAY_SIZE];</span>
<span class="line-modified">450         int value = getIntFieldAtIndex(array, 1, &quot;i0&quot;, &quot;I&quot;);</span>
<span class="line-modified">451         Asserts.assertEquals(value, 0, &quot;Initial value must be zero&quot;);</span>
<span class="line-modified">452         printArrayInformation(array);</span>
<span class="line-modified">453         int i0_value = 42;</span>
<span class="line-modified">454         int i1_value = -314;</span>
<span class="line-modified">455         initializeIntIntArrayBuffer(array, i0_value, i1_value);</span>
<span class="line-modified">456         System.gc();</span>
<span class="line-modified">457         for (int i = 0; i &lt; array.length; i++) {</span>
<span class="line-modified">458             Asserts.assertEquals(array[i].i0, i0_value, &quot;Bad value of i0 at index &quot; + i);</span>
<span class="line-modified">459             Asserts.assertEquals(array[i].i1, i1_value, &quot;Bad value of i1 at index &quot; + i);</span>
<span class="line-modified">460         }</span>
<span class="line-modified">461         System.out.println(&quot;Check 2&quot;);</span>
<span class="line-modified">462         array = new IntInt[ARRAY_SIZE];</span>
<span class="line-modified">463         i0_value = -194;</span>
<span class="line-modified">464         i1_value = 91;</span>
<span class="line-modified">465         initializeIntIntArrayFields(array, i0_value, i1_value);</span>
<span class="line-modified">466         System.gc();</span>
<span class="line-modified">467         for (int i = 0; i &lt; array.length; i++) {</span>
<span class="line-modified">468             Asserts.assertEquals(array[i].i0, i0_value, &quot;Bad value of i0 at index &quot; + i);</span>
<span class="line-modified">469             Asserts.assertEquals(array[i].i1, i1_value, &quot;Bad value of i1 at index &quot; + i);</span>
<span class="line-modified">470         }</span>
<span class="line-modified">471         System.out.println(&quot;Check 3&quot;);</span>
<span class="line-modified">472         array = new IntInt[ARRAY_SIZE];</span>
<span class="line-modified">473         initializeIntIntArrayJava(array, i0_value, i1_value);</span>
<span class="line-modified">474         System.gc();</span>
<span class="line-modified">475         for (int i = 0; i &lt; array.length; i++) {</span>
<span class="line-modified">476             Asserts.assertEquals(array[i].i0, i0_value, &quot;Bad value of i0 at index &quot; + i);</span>
<span class="line-modified">477             Asserts.assertEquals(array[i].i1, i1_value, &quot;Bad value of i1 at index &quot; + i);</span>
<span class="line-modified">478         }</span>
<span class="line-modified">479         System.out.println(&quot;Check 4&quot;);</span>
<span class="line-modified">480         random = new Random(seed);</span>
<span class="line-modified">481         array = new IntInt[ARRAY_SIZE];</span>
<span class="line-modified">482         for (int i = 0; i &lt; ARRAY_SIZE; i++) {</span>
<span class="line-modified">483             array[i] = new IntInt(random.nextInt(), random.nextInt());</span>
<span class="line-modified">484         }</span>
<span class="line-modified">485         sortIntIntArray(array);</span>
<span class="line-modified">486         System.gc();</span>
<span class="line-modified">487         for (int i = 0; i &lt; array.length - 1; i++) {</span>
<span class="line-modified">488             Asserts.assertLessThanOrEqual(array[i].i0, array[i+1].i0, &quot;Incorrect i0 fields ordering at index &quot; + i);</span>
<span class="line-modified">489             if (array[i].i0 == array[i+1].i0) {</span>
<span class="line-modified">490                 Asserts.assertLessThanOrEqual(array[i].i1, array[i+1].i1, &quot;Incorrect i1 fields ordering at index &quot; + i);</span>
<span class="line-modified">491             }</span>
<span class="line-modified">492         }</span>
<span class="line-modified">493         System.out.println(&quot;Check 5&quot;);</span>
<span class="line-modified">494         random = new Random(seed);</span>
<span class="line-modified">495         array = new IntInt[ARRAY_SIZE];</span>
<span class="line-modified">496         for (int i = 0; i &lt; ARRAY_SIZE; i++) {</span>
<span class="line-modified">497             array[i] = new IntInt(random.nextInt(), random.nextInt());</span>
<span class="line-modified">498         }</span>
<span class="line-modified">499         Arrays.sort(array, new IntIntComparator());</span>
<span class="line-modified">500         System.gc();</span>
<span class="line-modified">501         for (int i = 0; i &lt; array.length - 1; i++) {</span>
<span class="line-modified">502             Asserts.assertLessThanOrEqual(array[i].i0, array[i+1].i0, &quot;Incorrect i0 fields ordering at index &quot; + i);</span>
<span class="line-modified">503             if (array[i].i0 == array[i+1].i0) {</span>
<span class="line-modified">504                 Asserts.assertLessThanOrEqual(array[i].i1, array[i+1].i1, &quot;Incorrect i1 fields ordering at index &quot; + i);</span>
<span class="line-modified">505             }</span>
<span class="line-modified">506         }</span>
<span class="line-modified">507         System.out.println(&quot;Check 6&quot;);</span>
<span class="line-modified">508         Container[] array2 = new Container[ARRAY_SIZE];</span>
<span class="line-modified">509         double d  = 1.23456789;</span>
<span class="line-modified">510         float f = -987.654321f;</span>
<span class="line-modified">511         short s = -512;</span>
<span class="line-modified">512         byte b = 127;</span>
<span class="line-modified">513         Containee c = new Containee(f,s);</span>
<span class="line-modified">514         Container c2 = new Container(d, c, b);</span>
<span class="line-modified">515         initializeContainerArray(array2, d, f, s, b);</span>
<span class="line-modified">516         System.gc();</span>
<span class="line-modified">517         for (int i = 0; i &lt; array2.length; i++) {</span>
<span class="line-modified">518             Asserts.assertEquals(array2[i], c2, &quot;Incorrect value at index &quot; + i);</span>
<span class="line-modified">519             Asserts.assertEquals(array2[i].d, d, &quot;Incorrect d value at index &quot; + i);</span>
<span class="line-modified">520             Asserts.assertEquals(array2[i].c.f, f, &quot;Incorrect f value at index &quot; + i);</span>
<span class="line-modified">521             Asserts.assertEquals(array2[i].c.s, s, &quot;Incorrect s value at index &quot; + i);</span>
<span class="line-modified">522             Asserts.assertEquals(array2[i].b, b, &quot;Incorrect b value at inde &quot; +i);</span>
<span class="line-modified">523         }</span>
<span class="line-modified">524         System.out.println(&quot;Check 7&quot;);</span>
<span class="line-modified">525         f = 19.2837465f;</span>
<span class="line-modified">526         s = 231;</span>
<span class="line-modified">527         updateContainerArray(array2, f, s);</span>
<span class="line-modified">528         System.gc();</span>
<span class="line-modified">529         for (int i = 0; i &lt; array2.length; i++) {</span>
<span class="line-modified">530             Asserts.assertEquals(array2[i].d, d, &quot;Incorrect d value at index &quot; + i);</span>
<span class="line-modified">531             Asserts.assertEquals(array2[i].c.f, f, &quot;Incorrect f value at index &quot; + i);</span>
<span class="line-modified">532             Asserts.assertEquals(array2[i].c.s, s, &quot;Incorrect s value at index &quot; + i);</span>
<span class="line-modified">533             Asserts.assertEquals(array2[i].b, b, &quot;Incorrect b value at inde &quot; +i);</span>
<span class="line-modified">534         }</span>
<span class="line-modified">535         System.out.println(&quot;Check 8&quot;);</span>
<span class="line-modified">536         long l0 = 52467923;</span>
<span class="line-modified">537         long l1= -7854022;</span>
<span class="line-modified">538         long l2 = 230947485;</span>
<span class="line-modified">539         long l3 = -752497024;</span>
<span class="line-modified">540         LongLongLongLong[] array3 = new LongLongLongLong[ARRAY_SIZE/8];</span>
<span class="line-modified">541         initializeLongLongLongLongArray(array3, l0, l1, l2, l3);</span>
<span class="line-modified">542         System.gc();</span>
<span class="line-modified">543         for (int i = 0; i &lt; array3.length; i++) {</span>
<span class="line-modified">544             Asserts.assertEquals(array3[i].l0, l0, &quot;Bad value of l0 at index &quot; + i);</span>
<span class="line-modified">545             Asserts.assertEquals(array3[i].l1, l1, &quot;Bad value of l1 at index &quot; + i);</span>
<span class="line-modified">546             Asserts.assertEquals(array3[i].l2, l2, &quot;Bad value of l2 at index &quot; + i);</span>
<span class="line-modified">547             Asserts.assertEquals(array3[i].l3, l3, &quot;Bad value of l3 at index &quot; + i);</span>
<span class="line-modified">548         }</span>
549     }
550 
551     void initializeIntIntArrayJava(IntInt[] array, int i0, int i1) {
<a name="27" id="anc27"></a><span class="line-modified">552         IntInt ii = new IntInt(i0, i1);</span>
<span class="line-modified">553         for (int i = 0; i &lt; array.length; i++) {</span>
<span class="line-modified">554             array[i] = ii;</span>
<span class="line-modified">555         }</span>
556     }
557 
558     void initializeContainerArrayJava(Container[] array, double d, float f, short s, byte b) {
<a name="28" id="anc28"></a><span class="line-modified">559         Containee c = new Containee(f,s);</span>
<span class="line-modified">560         Container c2 = new Container(d, c, b);</span>
<span class="line-modified">561         for (int i = 0; i &lt; array.length; i++) {</span>
<span class="line-modified">562             array[i] = c2;</span>
<span class="line-modified">563         }</span>
564     }
565 
566     void updateContainerArrayJava(Container[] array, float f, short s) {
<a name="29" id="anc29"></a><span class="line-modified">567         Containee c = new Containee(f, s);</span>
<span class="line-modified">568         for (int i = 0; i &lt; array.length; i++) {</span>
<span class="line-modified">569             array[i] = array[i].setc(c);;</span>
<span class="line-modified">570         }</span>
571     }
572 
573     void initializeLongLongLongLongArrayJava(LongLongLongLong[] array, long l0, long l1, long l2, long l3) {
<a name="30" id="anc30"></a><span class="line-modified">574         LongLongLongLong llll = new LongLongLongLong(l0, l1, l2, l3);</span>
<span class="line-modified">575         for (int i = 0; i &lt; array.length; i++) {</span>
<span class="line-modified">576             array[i] = llll;</span>
<span class="line-modified">577         }</span>
578     }
<a name="31" id="anc31"></a><span class="line-modified">579 </span>
<span class="line-modified">580     void measureInitializationTime(int array_size, int iterations) {</span>
<span class="line-modified">581         System.out.println(&quot;\nInitialization time for IntInt[]:&quot;);</span>
<span class="line-modified">582         long[] start = new long[iterations];</span>
<span class="line-modified">583         long[] end = new long[iterations];</span>
<span class="line-modified">584 </span>
<span class="line-modified">585 </span>
<span class="line-modified">586         System.out.println(&quot;\nJava:&quot;);</span>
<span class="line-modified">587         // Warmup</span>
<span class="line-modified">588         for (int i = 0; i &lt; 10; i++) {</span>
<span class="line-modified">589             IntInt[] array = new IntInt[array_size];</span>
<span class="line-modified">590             initializeIntIntArrayJava(array, 42, -314);</span>
<span class="line-modified">591         }</span>
<span class="line-modified">592         // Measure</span>
<span class="line-modified">593         for (int i = 0; i &lt; iterations; i++) {</span>
<span class="line-modified">594             IntInt[] array = new IntInt[array_size];</span>
<span class="line-modified">595             start[i] = System.nanoTime();</span>
<span class="line-modified">596             initializeIntIntArrayJava(array, 42, -314);</span>
<span class="line-modified">597             end[i] = System.nanoTime();</span>
<span class="line-modified">598         }</span>
<span class="line-modified">599         // Results</span>
<span class="line-modified">600         computeStatistics(start, end);</span>
<span class="line-modified">601 </span>
<span class="line-modified">602         System.out.println(&quot;\nNative(memcpy):&quot;);</span>
<span class="line-modified">603         // Warmup</span>
<span class="line-modified">604         for (int i = 0; i &lt; 10; i++) {</span>
<span class="line-modified">605             IntInt[] array = new IntInt[array_size];</span>
<span class="line-modified">606             initializeIntIntArrayBuffer(array, 42, -314);</span>
<span class="line-modified">607         }</span>
<span class="line-modified">608         // Measure</span>
<span class="line-modified">609         for (int i = 0; i &lt; iterations; i++) {</span>
<span class="line-modified">610             IntInt[] array = new IntInt[array_size];</span>
<span class="line-modified">611             start[i] = System.nanoTime();</span>
<span class="line-modified">612             initializeIntIntArrayBuffer(array, 42, -314);</span>
<span class="line-modified">613             end[i] = System.nanoTime();</span>
<span class="line-modified">614         }</span>
<span class="line-modified">615         // Results</span>
<span class="line-modified">616         computeStatistics(start, end);</span>
<span class="line-modified">617 </span>
<span class="line-modified">618 </span>
<span class="line-modified">619         System.out.println(&quot;\nNative(fields):&quot;);</span>
<span class="line-modified">620         // Warmup</span>
<span class="line-modified">621         for (int i = 0; i &lt; 10; i++) {</span>
<span class="line-modified">622             IntInt[] array = new IntInt[array_size];</span>
<span class="line-modified">623             initializeIntIntArrayFields(array, 42, -314);</span>
<span class="line-modified">624         }</span>
<span class="line-modified">625         // Measure</span>
<span class="line-modified">626         for (int i = 0; i &lt; iterations; i++) {</span>
<span class="line-modified">627             IntInt[] array = new IntInt[array_size];</span>
<span class="line-modified">628             start[i] = System.nanoTime();</span>
<span class="line-modified">629             initializeIntIntArrayFields(array, 42, -314);</span>
<span class="line-modified">630             end[i] = System.nanoTime();</span>
<span class="line-modified">631         }</span>
<span class="line-modified">632         // Results</span>
<span class="line-modified">633         computeStatistics(start, end);</span>
634     }
635 
<a name="32" id="anc32"></a><span class="line-modified">636     void measureInitializationTime2(int array_size, int iterations) {</span>
<span class="line-modified">637         System.out.println(&quot;\nInitialization time for Container[]:&quot;);</span>
<span class="line-modified">638         long[] start = new long[iterations];</span>
<span class="line-modified">639         long[] end = new long[iterations];</span>
<span class="line-modified">640 </span>
<span class="line-modified">641         double d = 0.369852147;</span>
<span class="line-modified">642         float f = -321.654987f;</span>
<span class="line-modified">643         short s = -3579;</span>
<span class="line-modified">644         byte b = 42;</span>
<span class="line-modified">645 </span>
<span class="line-modified">646         System.out.println(&quot;\nJava:&quot;);</span>
<span class="line-modified">647         // Warmup</span>
<span class="line-modified">648         for (int i = 0; i &lt; 10; i++) {</span>
<span class="line-modified">649             Container[] array = new Container[array_size];</span>
<span class="line-modified">650             initializeContainerArrayJava(array, d, f, s, b);</span>
<span class="line-modified">651         }</span>
<span class="line-modified">652         // Measure</span>
<span class="line-modified">653         for (int i = 0; i &lt; iterations; i++) {</span>
<span class="line-modified">654             Container[] array = new Container[array_size];</span>
<span class="line-modified">655             start[i] = System.nanoTime();</span>
<span class="line-modified">656             initializeContainerArrayJava(array, d, f, s, b);</span>
<span class="line-modified">657             end[i] = System.nanoTime();</span>
<span class="line-modified">658         }</span>
<span class="line-modified">659         // Results</span>
<span class="line-modified">660         computeStatistics(start, end);</span>
<span class="line-modified">661 </span>
<span class="line-modified">662         System.out.println(&quot;\nNative:&quot;);</span>
<span class="line-modified">663         // Warmup</span>
<span class="line-modified">664         for (int i = 0; i &lt; 10; i++) {</span>
<span class="line-modified">665             Container[] array = new Container[array_size];</span>
<span class="line-modified">666             initializeContainerArray(array, d, f, s, b);</span>
<span class="line-modified">667         }</span>
<span class="line-modified">668         // Measure</span>
<span class="line-modified">669         for (int i = 0; i &lt; iterations; i++) {</span>
<span class="line-modified">670             Container[] array = new Container[array_size];</span>
<span class="line-modified">671             start[i] = System.nanoTime();</span>
<span class="line-modified">672             initializeContainerArray(array, d, f, s, b);</span>
<span class="line-modified">673             end[i] = System.nanoTime();</span>
<span class="line-modified">674         }</span>
<span class="line-modified">675         // Results</span>
<span class="line-modified">676         computeStatistics(start, end);</span>
677     }
678 
<a name="33" id="anc33"></a><span class="line-modified">679     void measureUpdateTime2(int array_size, int iterations) {</span>
<span class="line-modified">680         System.out.println(&quot;\nUpdating Container[]:&quot;);</span>
<span class="line-modified">681         long[] start = new long[iterations];</span>
<span class="line-modified">682         long[] end = new long[iterations];</span>
<span class="line-modified">683 </span>
<span class="line-modified">684         double d = 0.369852147;</span>
<span class="line-modified">685         float f = -321.654987f;</span>
<span class="line-modified">686         short s = -3579;</span>
<span class="line-modified">687         byte b = 42;</span>
<span class="line-modified">688 </span>
<span class="line-modified">689         Containee c = new Containee(f,s);</span>
<span class="line-modified">690         Container c2 = new Container(d, c, b);</span>
<span class="line-modified">691 </span>
<span class="line-modified">692         System.out.println(&quot;\nJava:&quot;);</span>
<span class="line-modified">693         // Warmup</span>
<span class="line-modified">694         for (int i = 0; i &lt; 10; i++) {</span>
<span class="line-modified">695             Container[] array = new Container[array_size];</span>
<span class="line-modified">696             for (int j = 0; j &lt; array.length; j++) {</span>
<span class="line-modified">697                 array[j] = c2;</span>
<span class="line-modified">698             }</span>
<span class="line-modified">699             updateContainerArrayJava(array, f, s);</span>
<span class="line-modified">700         }</span>
<span class="line-modified">701         // Measure</span>
<span class="line-modified">702         for (int i = 0; i &lt; iterations; i++) {</span>
<span class="line-modified">703             Container[] array = new Container[array_size];</span>
<span class="line-modified">704             for (int j = 0; j &lt; array.length; j++) {</span>
<span class="line-modified">705                 array[i] = c2;</span>
<span class="line-modified">706             }</span>
<span class="line-modified">707             start[i] = System.nanoTime();</span>
<span class="line-modified">708             updateContainerArrayJava(array, f, s);</span>
<span class="line-modified">709             end[i] = System.nanoTime();</span>
<span class="line-modified">710         }</span>
<span class="line-modified">711         // Results</span>
<span class="line-modified">712         computeStatistics(start, end);</span>
<span class="line-modified">713 </span>
<span class="line-modified">714         System.out.println(&quot;\nNative:&quot;);</span>
<span class="line-modified">715         // Warmup</span>
<span class="line-modified">716         for (int i = 0; i &lt; 10; i++) {</span>
<span class="line-modified">717             Container[] array = new Container[array_size];</span>
<span class="line-modified">718             for (int j = 0; j &lt; array.length; j++) {</span>
<span class="line-modified">719                 array[i] = c2;</span>
<span class="line-modified">720             }</span>
<span class="line-modified">721             updateContainerArray(array, f, s);</span>
<span class="line-modified">722         }</span>
<span class="line-modified">723         // Measure</span>
<span class="line-modified">724         for (int i = 0; i &lt; iterations; i++) {</span>
<span class="line-modified">725             Container[] array = new Container[array_size];</span>
<span class="line-modified">726             for (int j = 0; j &lt; array.length; j++) {</span>
<span class="line-modified">727                 array[i] = c2;</span>
<span class="line-modified">728             }</span>
<span class="line-modified">729             start[i] = System.nanoTime();</span>
<span class="line-modified">730             updateContainerArray(array, f, s);</span>
<span class="line-modified">731             end[i] = System.nanoTime();</span>
<span class="line-modified">732         }</span>
<span class="line-modified">733         // Results</span>
<span class="line-modified">734         computeStatistics(start, end);</span>
735     }
<a name="34" id="anc34"></a><span class="line-modified">736 </span>
<span class="line-modified">737     void measureSortingTime(int array_size, int iterations) {</span>
<span class="line-modified">738         System.out.println(&quot;\nSorting time:&quot;);</span>
<span class="line-modified">739         long[] start = new long[iterations];</span>
<span class="line-modified">740         long[] end = new long[iterations];</span>
<span class="line-modified">741 </span>
<span class="line-modified">742         random = new Random(seed);</span>
<span class="line-modified">743         System.out.println(&quot;\nJava:&quot;);</span>
<span class="line-modified">744         IntIntComparator comparator = new IntIntComparator();</span>
<span class="line-modified">745         // Warmup</span>
<span class="line-modified">746         for (int i = 0; i &lt; 10; i++) {</span>
<span class="line-modified">747             IntInt[] array = new IntInt[array_size];</span>
<span class="line-modified">748             array = new IntInt[array_size];</span>
<span class="line-modified">749             for (int j = 0; j &lt; array_size; j++) {</span>
<span class="line-modified">750                 array[j] = new IntInt(random.nextInt(), random.nextInt());</span>
<span class="line-modified">751             }</span>
<span class="line-modified">752             Arrays.sort(array, comparator);</span>
<span class="line-modified">753         }</span>
<span class="line-modified">754         // Measure</span>
<span class="line-modified">755         for (int i = 0; i &lt; iterations; i++) {</span>
<span class="line-modified">756             IntInt[] array = new IntInt[array_size];</span>
<span class="line-modified">757             for (int j = 0; j &lt; array_size; j++) {</span>
<span class="line-modified">758                 array[j] = new IntInt(random.nextInt(), random.nextInt());</span>
<span class="line-modified">759             }</span>
<span class="line-modified">760             start[i] = System.nanoTime();</span>
<span class="line-modified">761             Arrays.sort(array, comparator);</span>
<span class="line-modified">762             end[i] = System.nanoTime();</span>
<span class="line-modified">763         }</span>
<span class="line-modified">764         // Results</span>
<span class="line-modified">765         computeStatistics(start, end);</span>
<span class="line-modified">766 </span>
<span class="line-modified">767         random = new Random(seed);</span>
<span class="line-modified">768         System.out.println(&quot;\nNative:&quot;);</span>
<span class="line-modified">769         // Warmup</span>
<span class="line-modified">770         for (int i = 0; i &lt; 10; i++) {</span>
<span class="line-modified">771             IntInt[] array = new IntInt[array_size];</span>
<span class="line-modified">772             array = new IntInt[array_size];</span>
<span class="line-modified">773             for (int j = 0; j &lt; array_size; j++) {</span>
<span class="line-modified">774                 array[j] = new IntInt(random.nextInt(), random.nextInt());</span>
<span class="line-modified">775             }</span>
<span class="line-modified">776             sortIntIntArray(array);</span>
<span class="line-modified">777         }</span>
<span class="line-modified">778         // Measure</span>
<span class="line-modified">779         for (int i = 0; i &lt; iterations; i++) {</span>
<span class="line-modified">780             IntInt[] array = new IntInt[array_size];</span>
<span class="line-modified">781             for (int j = 0; j &lt; array_size; j++) {</span>
<span class="line-modified">782                 array[j] = new IntInt(random.nextInt(), random.nextInt());</span>
<span class="line-modified">783             }</span>
<span class="line-modified">784             start[i] = System.nanoTime();</span>
<span class="line-modified">785             sortIntIntArray(array);</span>
<span class="line-modified">786             end[i] = System.nanoTime();</span>
<span class="line-modified">787         }</span>
<span class="line-modified">788         // Results</span>
<span class="line-modified">789         computeStatistics(start, end);</span>
790     }
791 
792 
<a name="35" id="anc35"></a><span class="line-modified">793     void measureInitializationTime3(int array_size, int iterations) {</span>
<span class="line-modified">794         System.out.println(&quot;\nInitialization time for LongLongLongLong[]:&quot;);</span>
<span class="line-modified">795         long[] start = new long[iterations];</span>
<span class="line-modified">796         long[] end = new long[iterations];</span>
<span class="line-modified">797 </span>
<span class="line-modified">798         long l0 = 123456;</span>
<span class="line-modified">799         long l1 = -987654;</span>
<span class="line-modified">800         long l2 = 192837;</span>
<span class="line-modified">801         long l3 = -56473829;</span>
<span class="line-modified">802 </span>
<span class="line-modified">803         System.out.println(&quot;\nJava:&quot;);</span>
<span class="line-modified">804         // Warmup</span>
<span class="line-modified">805         for (int i = 0; i &lt; 10; i++) {</span>
<span class="line-modified">806             LongLongLongLong[] array = new LongLongLongLong[array_size];</span>
<span class="line-modified">807             initializeLongLongLongLongArrayJava(array, l0, l1, l2, l3);</span>
<span class="line-modified">808         }</span>
<span class="line-modified">809         // Measure</span>
<span class="line-modified">810         for (int i = 0; i &lt; iterations; i++) {</span>
<span class="line-modified">811             LongLongLongLong[] array = new LongLongLongLong[array_size];</span>
<span class="line-modified">812             start[i] = System.nanoTime();</span>
<span class="line-modified">813             initializeLongLongLongLongArrayJava(array, l0, l1, l2, l3);</span>
<span class="line-modified">814             end[i] = System.nanoTime();</span>
<span class="line-modified">815         }</span>
<span class="line-modified">816         // Results</span>
<span class="line-modified">817         computeStatistics(start, end);</span>
<span class="line-modified">818 </span>
<span class="line-modified">819         System.out.println(&quot;\nNative:&quot;);</span>
<span class="line-modified">820         // Warmup</span>
<span class="line-modified">821         for (int i = 0; i &lt; 10; i++) {</span>
<span class="line-modified">822             LongLongLongLong[] array = new LongLongLongLong[array_size];</span>
<span class="line-modified">823             initializeLongLongLongLongArray(array, l0, l1, l2, l3);</span>
<span class="line-modified">824         }</span>
<span class="line-modified">825         // Measure</span>
<span class="line-modified">826         for (int i = 0; i &lt; iterations; i++) {</span>
<span class="line-modified">827             LongLongLongLong[] array = new LongLongLongLong[array_size];</span>
<span class="line-modified">828             start[i] = System.nanoTime();</span>
<span class="line-modified">829             initializeLongLongLongLongArray(array, l0, l1, l2, l3);</span>
<span class="line-modified">830             end[i] = System.nanoTime();</span>
<span class="line-modified">831         }</span>
<span class="line-modified">832         // Results</span>
<span class="line-modified">833         computeStatistics(start, end);</span>
834     }
<a name="36" id="anc36"></a><span class="line-modified">835 </span>
836     void computeStatistics(long[] start, long[] end) {
<a name="37" id="anc37"></a><span class="line-modified">837         int iterations = start.length;</span>
<span class="line-modified">838         long[] duration = new long[iterations];</span>
<span class="line-modified">839         long sum = 0;</span>
<span class="line-modified">840         long min = end[0] - start[0];</span>
<span class="line-modified">841         long max = min;</span>
<span class="line-modified">842         double var = 0.0;</span>
<span class="line-modified">843         for (int i = 0 ; i &lt; iterations; i++) {</span>
<span class="line-modified">844             duration[i] = end[i] - start[i];</span>
<span class="line-modified">845             if (duration[i] &lt; min) min = duration[i];</span>
<span class="line-modified">846             if (duration[i] &gt; max) max = duration[i];</span>
<span class="line-modified">847             sum += duration[i];</span>
<span class="line-modified">848             double d = (double) duration[i];</span>
<span class="line-modified">849             var += Math.pow(d, 2);</span>
<span class="line-modified">850         }</span>
<span class="line-modified">851         double avg = (sum/iterations) / 1000;</span>
<span class="line-modified">852         double std = (Math.sqrt(var/iterations - Math.pow(sum/iterations, 2))) / 1000;</span>
<span class="line-modified">853         System.out.println(String.format(&quot;Avg: %8.2f us&quot;, avg));</span>
<span class="line-modified">854         System.out.println(String.format(&quot;Std: %8.2f us&quot;, std));</span>
<span class="line-modified">855         System.out.println(String.format(&quot;Min: %8d us&quot;, (min/1000)));</span>
<span class="line-modified">856         System.out.println(String.format(&quot;Max: %8d us&quot;, (max/1000)));</span>
857     }
858 
859     native int GetFlattenedArrayElementSizeWrapper(Object array);
860     native Class GetFlattenedArrayElementClassWrapper(Object array);
861     native long GetFlattenedArrayElementsWrapper(Object array);
862     native void ReleaseFlattenedArrayElementsWrapper(Object array, long addr,int mode);
863     native int GetFieldOffsetInFlattenedLayoutWrapper(Class klass, String name, String signature, boolean flattened);
<a name="38" id="anc38"></a><span class="line-modified">864 </span>
865     native int getIntFieldAtIndex(Object[] array, int index, String fieldName, String FieldSignature);
866     native void printArrayInformation(Object[] array);
867 
868     native void initializeIntIntArrayBuffer(Object[] array, int i0, int i1);
869     native void initializeIntIntArrayFields(Object[] array, int i0, int i1);
870     native void sortIntIntArray(Object[] array);
871 
872     native void initializeContainerArray(Object[] array, double d, float f, short s, byte b);
873     native void updateContainerArray(Object[] array, float f, short s);
874 
875     native void initializeLongLongLongLongArray(Object[] array, long l0, long l1, long l2, long l3);
876 
877     native SubElementSelector createSubElementSelector(Object[] array);
878     native SubElementSelector getSubElementSelector(SubElementSelector selector, Class&lt;?&gt; klass, String name, String signature);
879     native Object getObjectSubElement(Object[] array, SubElementSelector selector, int index);
880     native void setObjectSubElement(Object[] array, SubElementSelector selector, int index, Object value);
881 
882     native short getShortSubElement(Object[] array, SubElementSelector selector, int index);
883     native void setShortSubElement(Object[] array, SubElementSelector selector, int index, short value);
884     native int getIntSubElement(Object[] array, SubElementSelector selector, int index);
885     native void setIntSubElement(Object[] array, SubElementSelector selector, int index, int value);
886 }
<a name="39" id="anc39"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="39" type="hidden" />
</body>
</html>