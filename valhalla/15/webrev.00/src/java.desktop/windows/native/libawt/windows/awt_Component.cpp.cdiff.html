<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff src/java.desktop/windows/native/libawt/windows/awt_Component.cpp</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
  </head>
<body>
<center><a href="WPrinterJob.cpp.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="awt_Component.h.cdiff.html" target="_top">next &gt;</a></center>    <h2>src/java.desktop/windows/native/libawt/windows/awt_Component.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 1,7 ***</span>
  /*
<span class="line-modified">!  * Copyright (c) 1996, 2019, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.  Oracle designates this
<span class="line-new-header">--- 1,7 ---</span>
  /*
<span class="line-modified">!  * Copyright (c) 1996, 2020, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.  Oracle designates this
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1372,11 ***</span>
      switch (switchMessage) {
        case WM_AWT_GETDC:
        {
              HDC hDC;
              // First, release the DCs scheduled for deletion
<span class="line-modified">!             ReleaseDCList(GetHWnd(), passiveDCList);</span>
  
              GetDCReturnStruct *returnStruct = new GetDCReturnStruct;
              returnStruct-&gt;gdiLimitReached = FALSE;
              if (AwtGDIObject::IncrementIfAvailable()) {
                  hDC = ::GetDCEx(GetHWnd(), NULL,
<span class="line-new-header">--- 1372,11 ---</span>
      switch (switchMessage) {
        case WM_AWT_GETDC:
        {
              HDC hDC;
              // First, release the DCs scheduled for deletion
<span class="line-modified">!             ReleaseDCList(passiveDCList);</span>
  
              GetDCReturnStruct *returnStruct = new GetDCReturnStruct;
              returnStruct-&gt;gdiLimitReached = FALSE;
              if (AwtGDIObject::IncrementIfAvailable()) {
                  hDC = ::GetDCEx(GetHWnd(), NULL,
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1400,20 ***</span>
        }
        case WM_AWT_RELEASEDC:
        {
              HDC hDC = (HDC)wParam;
              MoveDCToPassiveList(hDC, GetHWnd());
<span class="line-modified">!             ReleaseDCList(GetHWnd(), passiveDCList);</span>
              mr = mrConsume;
              break;
        }
        case WM_AWT_RELEASE_ALL_DCS:
        {
              // Called during Component destruction.  Gets current list of
              // DC&#39;s associated with Component and releases each DC.
              ReleaseDCList(GetHWnd(), activeDCList);
<span class="line-modified">!             ReleaseDCList(GetHWnd(), passiveDCList);</span>
              mr = mrConsume;
              break;
        }
        case WM_AWT_SHOWCURSOR:
            ::ShowCursor(TRUE);
<span class="line-new-header">--- 1400,20 ---</span>
        }
        case WM_AWT_RELEASEDC:
        {
              HDC hDC = (HDC)wParam;
              MoveDCToPassiveList(hDC, GetHWnd());
<span class="line-modified">!             ReleaseDCList(passiveDCList);</span>
              mr = mrConsume;
              break;
        }
        case WM_AWT_RELEASE_ALL_DCS:
        {
              // Called during Component destruction.  Gets current list of
              // DC&#39;s associated with Component and releases each DC.
              ReleaseDCList(GetHWnd(), activeDCList);
<span class="line-modified">!             ReleaseDCList(passiveDCList);</span>
              mr = mrConsume;
              break;
        }
        case WM_AWT_SHOWCURSOR:
            ::ShowCursor(TRUE);
</pre>
<hr />
<pre>
<span class="line-old-header">*** 7434,10 ***</span>
<span class="line-new-header">--- 7434,23 ---</span>
      }
      listLock.Leave();
      return newListPtr;
  }
  
<span class="line-added">+ /**</span>
<span class="line-added">+  * Remove all DCs from the DC list.  Return the list of those</span>
<span class="line-added">+  * DC&#39;s to the caller (which will then probably want to</span>
<span class="line-added">+  * call ReleaseDC() for the returned DCs).</span>
<span class="line-added">+  */</span>
<span class="line-added">+ DCItem *DCList::RemoveAllDCs()</span>
<span class="line-added">+ {</span>
<span class="line-added">+     listLock.Enter();</span>
<span class="line-added">+     DCItem *newListPtr = head;</span>
<span class="line-added">+     head = NULL;</span>
<span class="line-added">+     listLock.Leave();</span>
<span class="line-added">+     return newListPtr;</span>
<span class="line-added">+ }</span>
  
  /**
   * Realize palettes of all existing HDC objects
   */
  void DCList::RealizePalettes(int screen)
</pre>
<hr />
<pre>
<span class="line-old-header">*** 7456,12 ***</span>
      if ((removedDC = activeDCList.RemoveDC(hDC, hWnd)) != NULL) {
          passiveDCList.AddDCItem(removedDC);
      }
  }
  
<span class="line-modified">! void ReleaseDCList(HWND hwnd, DCList &amp;list) {</span>
<span class="line-removed">-     DCItem *removedDCs = list.RemoveAllDCs(hwnd);</span>
      while (removedDCs) {
          DCItem *tmpDCList = removedDCs;
          DASSERT(::GetObjectType(tmpDCList-&gt;hDC) == OBJ_DC);
          int retValue = ::ReleaseDC(tmpDCList-&gt;hWnd, tmpDCList-&gt;hDC);
          VERIFY(retValue != 0);
<span class="line-new-header">--- 7469,11 ---</span>
      if ((removedDC = activeDCList.RemoveDC(hDC, hWnd)) != NULL) {
          passiveDCList.AddDCItem(removedDC);
      }
  }
  
<span class="line-modified">! static void ReleaseDCList(DCItem *removedDCs) {</span>
      while (removedDCs) {
          DCItem *tmpDCList = removedDCs;
          DASSERT(::GetObjectType(tmpDCList-&gt;hDC) == OBJ_DC);
          int retValue = ::ReleaseDC(tmpDCList-&gt;hWnd, tmpDCList-&gt;hDC);
          VERIFY(retValue != 0);
</pre>
<hr />
<pre>
<span class="line-old-header">*** 7471,5 ***</span>
<span class="line-new-header">--- 7483,13 ---</span>
          }
          removedDCs = removedDCs-&gt;next;
          delete tmpDCList;
      }
  }
<span class="line-added">+ </span>
<span class="line-added">+ void ReleaseDCList(HWND hwnd, DCList &amp;list) {</span>
<span class="line-added">+     ReleaseDCList(list.RemoveAllDCs(hwnd));</span>
<span class="line-added">+ }</span>
<span class="line-added">+ </span>
<span class="line-added">+ void ReleaseDCList(DCList &amp;list) {</span>
<span class="line-added">+     ReleaseDCList(list.RemoveAllDCs());</span>
<span class="line-added">+ }</span>
</pre>
<center><a href="WPrinterJob.cpp.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="awt_Component.h.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>