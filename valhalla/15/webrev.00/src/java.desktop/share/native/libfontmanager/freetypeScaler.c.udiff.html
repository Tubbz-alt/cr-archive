<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff src/java.desktop/share/native/libfontmanager/freetypeScaler.c</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
<body>
<center><a href="../../classes/sun/font/TrueTypeFont.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="../../../unix/classes/sun/awt/X11/XRobotPeer.java.udiff.html" target="_top">next &gt;</a></center>    <h2>src/java.desktop/share/native/libfontmanager/freetypeScaler.c</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -264,11 +264,11 @@</span>
      int version = 35;
      const char* module = &quot;truetype&quot;;
      const char* property = &quot;interpreter-version&quot;;
  
      /* If some one is setting this, don&#39;t override it */
<span class="udiff-line-modified-removed">-     if (props != NULL &amp;&amp; strstr(property, props)) {</span>
<span class="udiff-line-modified-added">+     if (props != NULL &amp;&amp; strstr(props, property)) {</span>
          return;
      }
      /*
       * FT_Property_Set was introduced in 2.4.11.
       * Some older supported Linux OSes may not include it so look
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -834,12 +834,13 @@</span>
       getGlyphImageNativeInternal(
          JNIEnv *env, jobject scaler, jobject font2D,
          jlong pScalerContext, jlong pScaler, jint glyphCode,
          jboolean renderImage) {
  
<span class="udiff-line-added">+     static int PADBYTES = 3;</span>
      int error, imageSize;
<span class="udiff-line-modified-removed">-     UInt16 width, height;</span>
<span class="udiff-line-modified-added">+     UInt16 width, height, rowBytes;</span>
      GlyphInfo *glyphInfo;
      int renderFlags = FT_LOAD_DEFAULT, target;
      FT_GlyphSlot ftglyph;
  
      FTScalerContext* context =
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -921,39 +922,46 @@</span>
          }
      }
  
      if (renderImage) {
          width  = (UInt16) ftglyph-&gt;bitmap.width;
<span class="udiff-line-added">+         rowBytes = width;</span>
<span class="udiff-line-added">+         if (ftglyph-&gt;bitmap.pixel_mode == FT_PIXEL_MODE_LCD) {</span>
<span class="udiff-line-added">+            rowBytes = PADBYTES + width + PADBYTES;</span>
<span class="udiff-line-added">+         }</span>
          height = (UInt16) ftglyph-&gt;bitmap.rows;
              if (width &gt; MAX_GLYPH_DIM || height &gt; MAX_GLYPH_DIM) {
                glyphInfo = getNullGlyphImage();
                return ptr_to_jlong(glyphInfo);
              }
       } else {
          width = 0;
<span class="udiff-line-added">+         rowBytes = 0;</span>
          height = 0;
       }
  
  
<span class="udiff-line-modified-removed">-     imageSize = width*height;</span>
<span class="udiff-line-modified-removed">-     glyphInfo = (GlyphInfo*) malloc(sizeof(GlyphInfo) + imageSize);</span>
<span class="udiff-line-modified-added">+     imageSize = rowBytes*height;</span>
<span class="udiff-line-modified-added">+     glyphInfo = (GlyphInfo*) calloc(sizeof(GlyphInfo) + imageSize, 1);</span>
      if (glyphInfo == NULL) {
          glyphInfo = getNullGlyphImage();
          return ptr_to_jlong(glyphInfo);
      }
      glyphInfo-&gt;cellInfo  = NULL;
      glyphInfo-&gt;managed   = UNMANAGED_GLYPH;
<span class="udiff-line-modified-removed">-     glyphInfo-&gt;rowBytes  = width;</span>
<span class="udiff-line-modified-added">+     glyphInfo-&gt;rowBytes  = rowBytes;</span>
      glyphInfo-&gt;width     = width;
      glyphInfo-&gt;height    = height;
  
      if (renderImage) {
          glyphInfo-&gt;topLeftX  = (float)  ftglyph-&gt;bitmap_left;
          glyphInfo-&gt;topLeftY  = (float) -ftglyph-&gt;bitmap_top;
  
<span class="udiff-line-modified-removed">-         if (ftglyph-&gt;bitmap.pixel_mode ==  FT_PIXEL_MODE_LCD) {</span>
<span class="udiff-line-modified-added">+         if (ftglyph-&gt;bitmap.pixel_mode ==  FT_PIXEL_MODE_LCD &amp;&amp; width &gt; 0) {</span>
              glyphInfo-&gt;width = width/3;
<span class="udiff-line-added">+             glyphInfo-&gt;topLeftX -= 1;</span>
<span class="udiff-line-added">+             glyphInfo-&gt;width += 1;</span>
          } else if (ftglyph-&gt;bitmap.pixel_mode ==  FT_PIXEL_MODE_LCD_V) {
              glyphInfo-&gt;height = glyphInfo-&gt;height/3;
          }
      }
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1006,12 +1014,12 @@</span>
                               height);
          } else if (ftglyph-&gt;bitmap.pixel_mode ==  FT_PIXEL_MODE_LCD) {
              /* 3 bytes per pixel to 3 bytes per pixel */
              CopyFTSubpixelToSubpixel(ftglyph-&gt;bitmap.buffer,
                                       ftglyph-&gt;bitmap.pitch,
<span class="udiff-line-modified-removed">-                                      (void *) glyphInfo-&gt;image,</span>
<span class="udiff-line-modified-removed">-                                      width,</span>
<span class="udiff-line-modified-added">+                                      (void *) (glyphInfo-&gt;image+PADBYTES),</span>
<span class="udiff-line-modified-added">+                                      rowBytes,</span>
                                       width,
                                       height);
          } else if (ftglyph-&gt;bitmap.pixel_mode ==  FT_PIXEL_MODE_LCD_V) {
              /* 3 bytes per pixel to 3 bytes per pixel */
              CopyFTSubpixelVToSubpixel(ftglyph-&gt;bitmap.buffer,
</pre>
<center><a href="../../classes/sun/font/TrueTypeFont.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="../../../unix/classes/sun/awt/X11/XRobotPeer.java.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>