<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/java.desktop/aix/native/libawt_xawt/awt/awt_InputMethod.c</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
  </head>
<body>
<center><a href="../../../../../java.compiler/share/classes/javax/tools/JavaFileManager.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="../../../../macosx/classes/com/apple/laf/AquaComboBoxUI.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/java.desktop/aix/native/libawt_xawt/awt/awt_InputMethod.c</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
   1 /*
<span class="line-modified">   2  * Copyright (c) 1997, 2018, Oracle and/or its affiliates. All rights reserved.</span>
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.  Oracle designates this
   8  * particular file as subject to the &quot;Classpath&quot; exception as provided
   9  * by Oracle in the LICENSE file that accompanied this code.
  10  *
  11  * This code is distributed in the hope that it will be useful, but WITHOUT
  12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  14  * version 2 for more details (a copy is included in the LICENSE file that
  15  * accompanied this code).
  16  *
  17  * You should have received a copy of the GNU General Public License version
  18  * 2 along with this work; if not, write to the Free Software Foundation,
  19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  20  *
  21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  22  * or visit www.oracle.com if you need additional information or have any
</pre>
<hr />
<pre>
 166 #if NeedVarargsPrototypes
 167     XIM /* im */, ...
 168 #endif
 169 );
 170 
 171 static int st_wcslen(wchar_t *string);
 172 static Bool isPreeditStateActive(XIC ic);
 173 static void * buf_insert(void * src, void * insert, int size,
 174                          int src_len, int ins_len, int offset);
 175 static void * handle_buffer(void * source, void * insert,
 176                             int size, int src_len, int ins_len,
 177                             int del_len, int offset);
 178 static void preedit_draw_passive(X11InputMethodData *pX11IMData,
 179                                  XIMPreeditDrawCallbackStruct *pre_draw);
 180 static void resetPassivePreeditText(StatusWindow *statusWindow);
 181 static void draw_caret(StatusWindow *statusWindow, GC gc, int pos);
 182 static int  get_next_attr(int len, unsigned long *attr);
 183 static void draw_preedit(StatusWindow *statusWindow);
 184 static void align_status(StatusWindow *statusWindow);
 185 static void shrink_status(StatusWindow *statusWindow);
<span class="line-removed"> 186 static GC create_gc(Window win, Bool isReverse);</span>
 187 static XFontSet create_fontset(void);
 188 static Bool is_text_available(XIMText * text);
 189 static Bool isNativeIm();
 190 static Window getGrandParent(Window parent);
 191 static void moveStatusWindow(StatusWindow *statusWindow);
 192 static void arrange_window_stack(StatusWindow* statusWindow);
 193 static Window get_current_focus(XIC ic);
 194 
 195 /*
 196  * This function is stolen from /src/solaris/hpi/src/system_md.c
 197  * It is used in setting the time in Java-level InputEvents
 198  */
 199 jlong
 200 awt_util_nowMillisUTC()
 201 {
 202     struct timeval t;
 203     gettimeofday(&amp;t, NULL);
 204     return ((jlong)t.tv_sec) * 1000 + (jlong)(t.tv_usec/1000);
 205 }
 206 
</pre>
<hr />
<pre>
 632     statusWindow-&gt;fontset = fontset;
 633     statusWindow-&gt;parent = parent;
 634     statusWindow-&gt;grandParent = grandParent;
 635     statusWindow-&gt;on  = False;
 636     statusWindow-&gt;x = x;
 637     statusWindow-&gt;y = y;
 638     statusWindow-&gt;width = xwa.width;
 639     statusWindow-&gt;height = xwa.height;
 640     statusWindow-&gt;off_x = off_x;
 641     statusWindow-&gt;off_y = off_y;
 642     statusWindow-&gt;bWidth  = bw;
 643     statusWindow-&gt;statusH = height;
 644     statusWindow-&gt;statusW = width;
 645     statusWindow-&gt;peTextW = 0;
 646     statusWindow-&gt;rootH = xxwa.height;
 647     statusWindow-&gt;rootW = xxwa.width;
 648     statusWindow-&gt;lightGC = XCreateGC(dpy, status, valuemask, &amp;values);
 649     XSetForeground(dpy, statusWindow-&gt;lightGC, light);
 650     statusWindow-&gt;dimGC = XCreateGC(dpy, status, valuemask, &amp;values);
 651     XSetForeground(dpy, statusWindow-&gt;dimGC, dim);
<span class="line-modified"> 652     statusWindow-&gt;fgGC = create_gc(status, FALSE);</span>
 653     XSetForeground(dpy, statusWindow-&gt;fgGC, fg);
<span class="line-modified"> 654     statusWindow-&gt;bgGC = create_gc(status, TRUE);</span>

 655     XSetForeground(dpy, statusWindow-&gt;bgGC, bg);

 656     statusWindow-&gt;status_ready = False;
 657     wcscpy(statusWindow-&gt;status, L&quot;&quot;);
 658     return statusWindow;
 659 }
 660 
 661 /* This method is to turn off or turn on the status window. */
 662 static void onoffStatusWindow(X11InputMethodData* pX11IMData,
 663                                 Window parent,
 664                                 Bool ON){
 665     XWindowAttributes xwa;
 666     Window child;
 667     int x, y;
 668     StatusWindow *statusWindow = NULL;
 669 
 670     if (NULL == pX11IMData ||
 671         NULL == (statusWindow =  pX11IMData-&gt;statusWindow)){
 672         return;
 673     }
 674 
 675     if (ON == False) {
</pre>
<hr />
<pre>
1640     XConfigureWindow(dpy, statusWindow-&gt;w, value_make, &amp;xwc);
1641 }
1642 
1643 static void shrink_status(StatusWindow *statusWindow)
1644 {
1645     int value_make = CWX|CWWidth|CWHeight;
1646     XWindowChanges xwc;
1647 
1648     if (NULL == statusWindow) return;
1649     xwc.width  = statusWindow-&gt;statusW;
1650     xwc.height = statusWindow-&gt;statusH;
1651     statusWindow-&gt;peTextW = 0;
1652     xwc.x = statusWindow-&gt;x - statusWindow-&gt;off_x;
1653     if (xwc.x &lt; 0 ) xwc.x = 0;
1654     if (xwc.x + xwc.width &gt; statusWindow-&gt;rootW){
1655       xwc.x = statusWindow-&gt;rootW - xwc.width;
1656     }
1657     XConfigureWindow(dpy, statusWindow-&gt;w, value_make, &amp;xwc);
1658 }
1659 
<span class="line-removed">1660 static GC create_gc(Window win, Bool isReverse)</span>
<span class="line-removed">1661 {</span>
<span class="line-removed">1662     XGCValues xgcv;</span>
<span class="line-removed">1663     unsigned long mask;</span>
<span class="line-removed">1664     AwtScreenDataPtr defaultScreen;</span>
<span class="line-removed">1665 </span>
<span class="line-removed">1666     defaultScreen = getScreenData(DefaultScreen(dpy));</span>
<span class="line-removed">1667 </span>
<span class="line-removed">1668     mask = (GCForeground | GCBackground );</span>
<span class="line-removed">1669     if (isReverse) {</span>
<span class="line-removed">1670         xgcv.foreground = defaultScreen-&gt;whitepixel;</span>
<span class="line-removed">1671         xgcv.background = defaultScreen-&gt;blackpixel;</span>
<span class="line-removed">1672     } else {</span>
<span class="line-removed">1673         xgcv.foreground = defaultScreen-&gt;blackpixel;</span>
<span class="line-removed">1674         xgcv.background = defaultScreen-&gt;whitepixel;</span>
<span class="line-removed">1675     }</span>
<span class="line-removed">1676     return XCreateGC(dpy, win, mask, &amp;xgcv);</span>
<span class="line-removed">1677 }</span>
<span class="line-removed">1678 </span>
1679 static Bool isNativeIm()
1680 {
1681 #define XIMMODIFIER          &quot;@im=&quot;
1682 #define XIM_SERVER_CATEGORY  &quot;@server=&quot;
1683     char *immodifiers;
1684     char *imserver, *imserverPtr;
1685     Atom imserverAtom;
1686 
1687     if (!(immodifiers = getenv(&quot;XMODIFIERS&quot;))) return True;
1688     if (!(imserver = calloc(1,strlen(immodifiers)+strlen(XIM_SERVER_CATEGORY)+1))) return True;
1689     if (!(immodifiers = strstr(immodifiers,XIMMODIFIER))) return True;
1690     immodifiers += strlen(XIMMODIFIER);
1691     strcpy(imserver,XIM_SERVER_CATEGORY);
1692     imserverPtr = imserver + strlen(imserver);
1693     while(*immodifiers != &#39;@&#39; &amp;&amp; *immodifiers != &#39;\0&#39;) {
1694         *imserverPtr = *immodifiers;
1695         imserverPtr++;
1696         immodifiers++;
1697     }
1698     imserverAtom = XInternAtom(awt_display, imserver, True);
</pre>
</td>
<td>
<hr />
<pre>
   1 /*
<span class="line-modified">   2  * Copyright (c) 1997, 2020, Oracle and/or its affiliates. All rights reserved.</span>
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.  Oracle designates this
   8  * particular file as subject to the &quot;Classpath&quot; exception as provided
   9  * by Oracle in the LICENSE file that accompanied this code.
  10  *
  11  * This code is distributed in the hope that it will be useful, but WITHOUT
  12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  14  * version 2 for more details (a copy is included in the LICENSE file that
  15  * accompanied this code).
  16  *
  17  * You should have received a copy of the GNU General Public License version
  18  * 2 along with this work; if not, write to the Free Software Foundation,
  19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  20  *
  21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  22  * or visit www.oracle.com if you need additional information or have any
</pre>
<hr />
<pre>
 166 #if NeedVarargsPrototypes
 167     XIM /* im */, ...
 168 #endif
 169 );
 170 
 171 static int st_wcslen(wchar_t *string);
 172 static Bool isPreeditStateActive(XIC ic);
 173 static void * buf_insert(void * src, void * insert, int size,
 174                          int src_len, int ins_len, int offset);
 175 static void * handle_buffer(void * source, void * insert,
 176                             int size, int src_len, int ins_len,
 177                             int del_len, int offset);
 178 static void preedit_draw_passive(X11InputMethodData *pX11IMData,
 179                                  XIMPreeditDrawCallbackStruct *pre_draw);
 180 static void resetPassivePreeditText(StatusWindow *statusWindow);
 181 static void draw_caret(StatusWindow *statusWindow, GC gc, int pos);
 182 static int  get_next_attr(int len, unsigned long *attr);
 183 static void draw_preedit(StatusWindow *statusWindow);
 184 static void align_status(StatusWindow *statusWindow);
 185 static void shrink_status(StatusWindow *statusWindow);

 186 static XFontSet create_fontset(void);
 187 static Bool is_text_available(XIMText * text);
 188 static Bool isNativeIm();
 189 static Window getGrandParent(Window parent);
 190 static void moveStatusWindow(StatusWindow *statusWindow);
 191 static void arrange_window_stack(StatusWindow* statusWindow);
 192 static Window get_current_focus(XIC ic);
 193 
 194 /*
 195  * This function is stolen from /src/solaris/hpi/src/system_md.c
 196  * It is used in setting the time in Java-level InputEvents
 197  */
 198 jlong
 199 awt_util_nowMillisUTC()
 200 {
 201     struct timeval t;
 202     gettimeofday(&amp;t, NULL);
 203     return ((jlong)t.tv_sec) * 1000 + (jlong)(t.tv_usec/1000);
 204 }
 205 
</pre>
<hr />
<pre>
 631     statusWindow-&gt;fontset = fontset;
 632     statusWindow-&gt;parent = parent;
 633     statusWindow-&gt;grandParent = grandParent;
 634     statusWindow-&gt;on  = False;
 635     statusWindow-&gt;x = x;
 636     statusWindow-&gt;y = y;
 637     statusWindow-&gt;width = xwa.width;
 638     statusWindow-&gt;height = xwa.height;
 639     statusWindow-&gt;off_x = off_x;
 640     statusWindow-&gt;off_y = off_y;
 641     statusWindow-&gt;bWidth  = bw;
 642     statusWindow-&gt;statusH = height;
 643     statusWindow-&gt;statusW = width;
 644     statusWindow-&gt;peTextW = 0;
 645     statusWindow-&gt;rootH = xxwa.height;
 646     statusWindow-&gt;rootW = xxwa.width;
 647     statusWindow-&gt;lightGC = XCreateGC(dpy, status, valuemask, &amp;values);
 648     XSetForeground(dpy, statusWindow-&gt;lightGC, light);
 649     statusWindow-&gt;dimGC = XCreateGC(dpy, status, valuemask, &amp;values);
 650     XSetForeground(dpy, statusWindow-&gt;dimGC, dim);
<span class="line-modified"> 651     statusWindow-&gt;fgGC = XCreateGC(dpy, status, valuemask, &amp;values);</span>
 652     XSetForeground(dpy, statusWindow-&gt;fgGC, fg);
<span class="line-modified"> 653     XSetBackground(dpy, statusWindow-&gt;fgGC, bg);</span>
<span class="line-added"> 654     statusWindow-&gt;bgGC = XCreateGC(dpy, status, valuemask, &amp;values);</span>
 655     XSetForeground(dpy, statusWindow-&gt;bgGC, bg);
<span class="line-added"> 656     XSetBackground(dpy, statusWindow-&gt;bgGC, fg);</span>
 657     statusWindow-&gt;status_ready = False;
 658     wcscpy(statusWindow-&gt;status, L&quot;&quot;);
 659     return statusWindow;
 660 }
 661 
 662 /* This method is to turn off or turn on the status window. */
 663 static void onoffStatusWindow(X11InputMethodData* pX11IMData,
 664                                 Window parent,
 665                                 Bool ON){
 666     XWindowAttributes xwa;
 667     Window child;
 668     int x, y;
 669     StatusWindow *statusWindow = NULL;
 670 
 671     if (NULL == pX11IMData ||
 672         NULL == (statusWindow =  pX11IMData-&gt;statusWindow)){
 673         return;
 674     }
 675 
 676     if (ON == False) {
</pre>
<hr />
<pre>
1641     XConfigureWindow(dpy, statusWindow-&gt;w, value_make, &amp;xwc);
1642 }
1643 
1644 static void shrink_status(StatusWindow *statusWindow)
1645 {
1646     int value_make = CWX|CWWidth|CWHeight;
1647     XWindowChanges xwc;
1648 
1649     if (NULL == statusWindow) return;
1650     xwc.width  = statusWindow-&gt;statusW;
1651     xwc.height = statusWindow-&gt;statusH;
1652     statusWindow-&gt;peTextW = 0;
1653     xwc.x = statusWindow-&gt;x - statusWindow-&gt;off_x;
1654     if (xwc.x &lt; 0 ) xwc.x = 0;
1655     if (xwc.x + xwc.width &gt; statusWindow-&gt;rootW){
1656       xwc.x = statusWindow-&gt;rootW - xwc.width;
1657     }
1658     XConfigureWindow(dpy, statusWindow-&gt;w, value_make, &amp;xwc);
1659 }
1660 



















1661 static Bool isNativeIm()
1662 {
1663 #define XIMMODIFIER          &quot;@im=&quot;
1664 #define XIM_SERVER_CATEGORY  &quot;@server=&quot;
1665     char *immodifiers;
1666     char *imserver, *imserverPtr;
1667     Atom imserverAtom;
1668 
1669     if (!(immodifiers = getenv(&quot;XMODIFIERS&quot;))) return True;
1670     if (!(imserver = calloc(1,strlen(immodifiers)+strlen(XIM_SERVER_CATEGORY)+1))) return True;
1671     if (!(immodifiers = strstr(immodifiers,XIMMODIFIER))) return True;
1672     immodifiers += strlen(XIMMODIFIER);
1673     strcpy(imserver,XIM_SERVER_CATEGORY);
1674     imserverPtr = imserver + strlen(imserver);
1675     while(*immodifiers != &#39;@&#39; &amp;&amp; *immodifiers != &#39;\0&#39;) {
1676         *imserverPtr = *immodifiers;
1677         imserverPtr++;
1678         immodifiers++;
1679     }
1680     imserverAtom = XInternAtom(awt_display, imserver, True);
</pre>
</td>
</tr>
</table>
<center><a href="../../../../../java.compiler/share/classes/javax/tools/JavaFileManager.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="../../../../macosx/classes/com/apple/laf/AquaComboBoxUI.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>