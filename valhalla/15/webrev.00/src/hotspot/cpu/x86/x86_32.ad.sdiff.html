<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/hotspot/cpu/x86/x86_32.ad</title>
    <link rel="stylesheet" href="../../../../style.css" />
  </head>
<body>
<center><a href="x86.ad.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="x86_64.ad.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/hotspot/cpu/x86/x86_32.ad</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  506   //
  507   __ andl(Address(rsp, 0), 0xffffff2b);
  508   __ popf();
  509   __ bind(exit);
  510 }
  511 
  512 void emit_cmpfp3(MacroAssembler&amp; _masm, Register dst) {
  513   Label done;
  514   __ movl(dst, -1);
  515   __ jcc(Assembler::parity, done);
  516   __ jcc(Assembler::below, done);
  517   __ setb(Assembler::notEqual, dst);
  518   __ movzbl(dst, dst);
  519   __ bind(done);
  520 }
  521 
  522 
  523 //=============================================================================
  524 const RegMask&amp; MachConstantBaseNode::_out_RegMask = RegMask::Empty;
  525 
<span class="line-modified">  526 int Compile::ConstantTable::calculate_table_base_offset() const {</span>
  527   return 0;  // absolute addressing, no offset
  528 }
  529 
  530 bool MachConstantBaseNode::requires_postalloc_expand() const { return false; }
  531 void MachConstantBaseNode::postalloc_expand(GrowableArray &lt;Node *&gt; *nodes, PhaseRegAlloc *ra_) {
  532   ShouldNotReachHere();
  533 }
  534 
  535 void MachConstantBaseNode::emit(CodeBuffer&amp; cbuf, PhaseRegAlloc* ra_) const {
  536   // Empty encoding
  537 }
  538 
  539 uint MachConstantBaseNode::size(PhaseRegAlloc* ra_) const {
  540   return 0;
  541 }
  542 
  543 #ifndef PRODUCT
  544 void MachConstantBaseNode::format(PhaseRegAlloc* ra_, outputStream* st) const {
  545   st-&gt;print(&quot;# MachConstantBaseNode (empty encoding)&quot;);
  546 }
  547 #endif
  548 
  549 
  550 //=============================================================================
  551 #ifndef PRODUCT
  552 void MachPrologNode::format(PhaseRegAlloc* ra_, outputStream* st) const {
  553   Compile* C = ra_-&gt;C;
  554 
<span class="line-modified">  555   int framesize = C-&gt;frame_size_in_bytes();</span>
<span class="line-modified">  556   int bangsize = C-&gt;bang_size_in_bytes();</span>
  557   assert((framesize &amp; (StackAlignmentInBytes-1)) == 0, &quot;frame size not aligned&quot;);
  558   // Remove wordSize for return addr which is already pushed.
  559   framesize -= wordSize;
  560 
<span class="line-modified">  561   if (C-&gt;need_stack_bang(bangsize)) {</span>
  562     framesize -= wordSize;
  563     st-&gt;print(&quot;# stack bang (%d bytes)&quot;, bangsize);
  564     st-&gt;print(&quot;\n\t&quot;);
  565     st-&gt;print(&quot;PUSH   EBP\t# Save EBP&quot;);
  566     if (PreserveFramePointer) {
  567       st-&gt;print(&quot;\n\t&quot;);
  568       st-&gt;print(&quot;MOV    EBP, ESP\t# Save the caller&#39;s SP into EBP&quot;);
  569     }
  570     if (framesize) {
  571       st-&gt;print(&quot;\n\t&quot;);
  572       st-&gt;print(&quot;SUB    ESP, #%d\t# Create frame&quot;,framesize);
  573     }
  574   } else {
  575     st-&gt;print(&quot;SUB    ESP, #%d\t# Create frame&quot;,framesize);
  576     st-&gt;print(&quot;\n\t&quot;);
  577     framesize -= wordSize;
  578     st-&gt;print(&quot;MOV    [ESP + #%d], EBP\t# Save EBP&quot;,framesize);
  579     if (PreserveFramePointer) {
  580       st-&gt;print(&quot;\n\t&quot;);
  581       st-&gt;print(&quot;MOV    EBP, ESP\t# Save the caller&#39;s SP into EBP&quot;);
</pre>
<hr />
<pre>
  601     st-&gt;print(&quot;# verify FPU stack (must be clean on entry)&quot;);
  602   }
  603 
  604 #ifdef ASSERT
  605   if (VerifyStackAtCalls) {
  606     st-&gt;print(&quot;\n\t&quot;);
  607     st-&gt;print(&quot;# stack alignment check&quot;);
  608   }
  609 #endif
  610   st-&gt;cr();
  611 }
  612 #endif
  613 
  614 
  615 void MachPrologNode::emit(CodeBuffer &amp;cbuf, PhaseRegAlloc *ra_) const {
  616   Compile* C = ra_-&gt;C;
  617   MacroAssembler _masm(&amp;cbuf);
  618 
  619   __ verified_entry(C);
  620 
<span class="line-modified">  621   C-&gt;set_frame_complete(cbuf.insts_size());</span>
  622 
  623   if (C-&gt;has_mach_constant_base_node()) {
  624     // NOTE: We set the table base offset here because users might be
  625     // emitted before MachConstantBaseNode.
<span class="line-modified">  626     Compile::ConstantTable&amp; constant_table = C-&gt;constant_table();</span>
  627     constant_table.set_table_base_offset(constant_table.calculate_table_base_offset());
  628   }
  629 }
  630 
  631 uint MachPrologNode::size(PhaseRegAlloc *ra_) const {
  632   return MachNode::size(ra_); // too many variables; just compute it the hard way
  633 }
  634 
  635 int MachPrologNode::reloc() const {
  636   return 0; // a large enough number
  637 }
  638 
  639 //=============================================================================
  640 #ifndef PRODUCT
  641 void MachEpilogNode::format( PhaseRegAlloc *ra_, outputStream* st ) const {
  642   Compile *C = ra_-&gt;C;
<span class="line-modified">  643   int framesize = C-&gt;frame_size_in_bytes();</span>
  644   assert((framesize &amp; (StackAlignmentInBytes-1)) == 0, &quot;frame size not aligned&quot;);
  645   // Remove two words for return addr and rbp,
  646   framesize -= 2*wordSize;
  647 
  648   if (C-&gt;max_vector_size() &gt; 16) {
  649     st-&gt;print(&quot;VZEROUPPER&quot;);
  650     st-&gt;cr(); st-&gt;print(&quot;\t&quot;);
  651   }
  652   if (C-&gt;in_24_bit_fp_mode()) {
  653     st-&gt;print(&quot;FLDCW  standard control word&quot;);
  654     st-&gt;cr(); st-&gt;print(&quot;\t&quot;);
  655   }
  656   if (framesize) {
  657     st-&gt;print(&quot;ADD    ESP,%d\t# Destroy frame&quot;,framesize);
  658     st-&gt;cr(); st-&gt;print(&quot;\t&quot;);
  659   }
  660   st-&gt;print_cr(&quot;POPL   EBP&quot;); st-&gt;print(&quot;\t&quot;);
  661   if (do_polling() &amp;&amp; C-&gt;is_method_compilation()) {
  662     st-&gt;print(&quot;TEST   PollPage,EAX\t! Poll Safepoint&quot;);
  663     st-&gt;cr(); st-&gt;print(&quot;\t&quot;);
  664   }
  665 }
  666 #endif
  667 
  668 void MachEpilogNode::emit(CodeBuffer &amp;cbuf, PhaseRegAlloc *ra_) const {
  669   Compile *C = ra_-&gt;C;
  670   MacroAssembler _masm(&amp;cbuf);
  671 
  672   if (C-&gt;max_vector_size() &gt; 16) {
  673     // Clear upper bits of YMM registers when current compiled code uses
  674     // wide vectors to avoid AVX &lt;-&gt; SSE transition penalty during call.
  675     _masm.vzeroupper();
  676   }
  677   // If method set FPU control word, restore to standard control word
  678   if (C-&gt;in_24_bit_fp_mode()) {
  679     _masm.fldcw(ExternalAddress(StubRoutines::addr_fpu_cntrl_wrd_std()));
  680   }
  681 
<span class="line-modified">  682   int framesize = C-&gt;frame_size_in_bytes();</span>
  683   assert((framesize &amp; (StackAlignmentInBytes-1)) == 0, &quot;frame size not aligned&quot;);
  684   // Remove two words for return addr and rbp,
  685   framesize -= 2*wordSize;
  686 
  687   // Note that VerifyStackAtCalls&#39; Majik cookie does not change the frame size popped here
  688 
  689   if (framesize &gt;= 128) {
  690     emit_opcode(cbuf, 0x81); // add  SP, #framesize
  691     emit_rm(cbuf, 0x3, 0x00, ESP_enc);
  692     emit_d32(cbuf, framesize);
  693   } else if (framesize) {
  694     emit_opcode(cbuf, 0x83); // add  SP, #framesize
  695     emit_rm(cbuf, 0x3, 0x00, ESP_enc);
  696     emit_d8(cbuf, framesize);
  697   }
  698 
  699   emit_opcode(cbuf, 0x58 | EBP_enc);
  700 
  701   if (StackReservedPages &gt; 0 &amp;&amp; C-&gt;has_reserved_stack_access()) {
  702     __ reserved_stack_check();
</pre>
</td>
<td>
<hr />
<pre>
  506   //
  507   __ andl(Address(rsp, 0), 0xffffff2b);
  508   __ popf();
  509   __ bind(exit);
  510 }
  511 
  512 void emit_cmpfp3(MacroAssembler&amp; _masm, Register dst) {
  513   Label done;
  514   __ movl(dst, -1);
  515   __ jcc(Assembler::parity, done);
  516   __ jcc(Assembler::below, done);
  517   __ setb(Assembler::notEqual, dst);
  518   __ movzbl(dst, dst);
  519   __ bind(done);
  520 }
  521 
  522 
  523 //=============================================================================
  524 const RegMask&amp; MachConstantBaseNode::_out_RegMask = RegMask::Empty;
  525 
<span class="line-modified">  526 int ConstantTable::calculate_table_base_offset() const {</span>
  527   return 0;  // absolute addressing, no offset
  528 }
  529 
  530 bool MachConstantBaseNode::requires_postalloc_expand() const { return false; }
  531 void MachConstantBaseNode::postalloc_expand(GrowableArray &lt;Node *&gt; *nodes, PhaseRegAlloc *ra_) {
  532   ShouldNotReachHere();
  533 }
  534 
  535 void MachConstantBaseNode::emit(CodeBuffer&amp; cbuf, PhaseRegAlloc* ra_) const {
  536   // Empty encoding
  537 }
  538 
  539 uint MachConstantBaseNode::size(PhaseRegAlloc* ra_) const {
  540   return 0;
  541 }
  542 
  543 #ifndef PRODUCT
  544 void MachConstantBaseNode::format(PhaseRegAlloc* ra_, outputStream* st) const {
  545   st-&gt;print(&quot;# MachConstantBaseNode (empty encoding)&quot;);
  546 }
  547 #endif
  548 
  549 
  550 //=============================================================================
  551 #ifndef PRODUCT
  552 void MachPrologNode::format(PhaseRegAlloc* ra_, outputStream* st) const {
  553   Compile* C = ra_-&gt;C;
  554 
<span class="line-modified">  555   int framesize = C-&gt;output()-&gt;frame_size_in_bytes();</span>
<span class="line-modified">  556   int bangsize = C-&gt;output()-&gt;bang_size_in_bytes();</span>
  557   assert((framesize &amp; (StackAlignmentInBytes-1)) == 0, &quot;frame size not aligned&quot;);
  558   // Remove wordSize for return addr which is already pushed.
  559   framesize -= wordSize;
  560 
<span class="line-modified">  561   if (C-&gt;output()-&gt;need_stack_bang(bangsize)) {</span>
  562     framesize -= wordSize;
  563     st-&gt;print(&quot;# stack bang (%d bytes)&quot;, bangsize);
  564     st-&gt;print(&quot;\n\t&quot;);
  565     st-&gt;print(&quot;PUSH   EBP\t# Save EBP&quot;);
  566     if (PreserveFramePointer) {
  567       st-&gt;print(&quot;\n\t&quot;);
  568       st-&gt;print(&quot;MOV    EBP, ESP\t# Save the caller&#39;s SP into EBP&quot;);
  569     }
  570     if (framesize) {
  571       st-&gt;print(&quot;\n\t&quot;);
  572       st-&gt;print(&quot;SUB    ESP, #%d\t# Create frame&quot;,framesize);
  573     }
  574   } else {
  575     st-&gt;print(&quot;SUB    ESP, #%d\t# Create frame&quot;,framesize);
  576     st-&gt;print(&quot;\n\t&quot;);
  577     framesize -= wordSize;
  578     st-&gt;print(&quot;MOV    [ESP + #%d], EBP\t# Save EBP&quot;,framesize);
  579     if (PreserveFramePointer) {
  580       st-&gt;print(&quot;\n\t&quot;);
  581       st-&gt;print(&quot;MOV    EBP, ESP\t# Save the caller&#39;s SP into EBP&quot;);
</pre>
<hr />
<pre>
  601     st-&gt;print(&quot;# verify FPU stack (must be clean on entry)&quot;);
  602   }
  603 
  604 #ifdef ASSERT
  605   if (VerifyStackAtCalls) {
  606     st-&gt;print(&quot;\n\t&quot;);
  607     st-&gt;print(&quot;# stack alignment check&quot;);
  608   }
  609 #endif
  610   st-&gt;cr();
  611 }
  612 #endif
  613 
  614 
  615 void MachPrologNode::emit(CodeBuffer &amp;cbuf, PhaseRegAlloc *ra_) const {
  616   Compile* C = ra_-&gt;C;
  617   MacroAssembler _masm(&amp;cbuf);
  618 
  619   __ verified_entry(C);
  620 
<span class="line-modified">  621   C-&gt;output()-&gt;set_frame_complete(cbuf.insts_size());</span>
  622 
  623   if (C-&gt;has_mach_constant_base_node()) {
  624     // NOTE: We set the table base offset here because users might be
  625     // emitted before MachConstantBaseNode.
<span class="line-modified">  626     ConstantTable&amp; constant_table = C-&gt;output()-&gt;constant_table();</span>
  627     constant_table.set_table_base_offset(constant_table.calculate_table_base_offset());
  628   }
  629 }
  630 
  631 uint MachPrologNode::size(PhaseRegAlloc *ra_) const {
  632   return MachNode::size(ra_); // too many variables; just compute it the hard way
  633 }
  634 
  635 int MachPrologNode::reloc() const {
  636   return 0; // a large enough number
  637 }
  638 
  639 //=============================================================================
  640 #ifndef PRODUCT
  641 void MachEpilogNode::format( PhaseRegAlloc *ra_, outputStream* st ) const {
  642   Compile *C = ra_-&gt;C;
<span class="line-modified">  643   int framesize = C-&gt;output()-&gt;frame_size_in_bytes();</span>
  644   assert((framesize &amp; (StackAlignmentInBytes-1)) == 0, &quot;frame size not aligned&quot;);
  645   // Remove two words for return addr and rbp,
  646   framesize -= 2*wordSize;
  647 
  648   if (C-&gt;max_vector_size() &gt; 16) {
  649     st-&gt;print(&quot;VZEROUPPER&quot;);
  650     st-&gt;cr(); st-&gt;print(&quot;\t&quot;);
  651   }
  652   if (C-&gt;in_24_bit_fp_mode()) {
  653     st-&gt;print(&quot;FLDCW  standard control word&quot;);
  654     st-&gt;cr(); st-&gt;print(&quot;\t&quot;);
  655   }
  656   if (framesize) {
  657     st-&gt;print(&quot;ADD    ESP,%d\t# Destroy frame&quot;,framesize);
  658     st-&gt;cr(); st-&gt;print(&quot;\t&quot;);
  659   }
  660   st-&gt;print_cr(&quot;POPL   EBP&quot;); st-&gt;print(&quot;\t&quot;);
  661   if (do_polling() &amp;&amp; C-&gt;is_method_compilation()) {
  662     st-&gt;print(&quot;TEST   PollPage,EAX\t! Poll Safepoint&quot;);
  663     st-&gt;cr(); st-&gt;print(&quot;\t&quot;);
  664   }
  665 }
  666 #endif
  667 
  668 void MachEpilogNode::emit(CodeBuffer &amp;cbuf, PhaseRegAlloc *ra_) const {
  669   Compile *C = ra_-&gt;C;
  670   MacroAssembler _masm(&amp;cbuf);
  671 
  672   if (C-&gt;max_vector_size() &gt; 16) {
  673     // Clear upper bits of YMM registers when current compiled code uses
  674     // wide vectors to avoid AVX &lt;-&gt; SSE transition penalty during call.
  675     _masm.vzeroupper();
  676   }
  677   // If method set FPU control word, restore to standard control word
  678   if (C-&gt;in_24_bit_fp_mode()) {
  679     _masm.fldcw(ExternalAddress(StubRoutines::addr_fpu_cntrl_wrd_std()));
  680   }
  681 
<span class="line-modified">  682   int framesize = C-&gt;output()-&gt;frame_size_in_bytes();</span>
  683   assert((framesize &amp; (StackAlignmentInBytes-1)) == 0, &quot;frame size not aligned&quot;);
  684   // Remove two words for return addr and rbp,
  685   framesize -= 2*wordSize;
  686 
  687   // Note that VerifyStackAtCalls&#39; Majik cookie does not change the frame size popped here
  688 
  689   if (framesize &gt;= 128) {
  690     emit_opcode(cbuf, 0x81); // add  SP, #framesize
  691     emit_rm(cbuf, 0x3, 0x00, ESP_enc);
  692     emit_d32(cbuf, framesize);
  693   } else if (framesize) {
  694     emit_opcode(cbuf, 0x83); // add  SP, #framesize
  695     emit_rm(cbuf, 0x3, 0x00, ESP_enc);
  696     emit_d8(cbuf, framesize);
  697   }
  698 
  699   emit_opcode(cbuf, 0x58 | EBP_enc);
  700 
  701   if (StackReservedPages &gt; 0 &amp;&amp; C-&gt;has_reserved_stack_access()) {
  702     __ reserved_stack_check();
</pre>
</td>
</tr>
</table>
<center><a href="x86.ad.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="x86_64.ad.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>