<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff src/hotspot/cpu/ppc/macroAssembler_ppc.cpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
  </head>
<body>
<center><a href="../arm/macroAssembler_arm.hpp.udiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="macroAssembler_ppc.hpp.udiff.html" target="_top">next &gt;</a></center>    <h2>src/hotspot/cpu/ppc/macroAssembler_ppc.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -31,10 +31,11 @@</span>
  #include &quot;gc/shared/barrierSetAssembler.hpp&quot;
  #include &quot;interpreter/interpreter.hpp&quot;
  #include &quot;memory/resourceArea.hpp&quot;
  #include &quot;nativeInst_ppc.hpp&quot;
  #include &quot;oops/klass.inline.hpp&quot;
<span class="udiff-line-added">+ #include &quot;oops/methodData.hpp&quot;</span>
  #include &quot;prims/methodHandles.hpp&quot;
  #include &quot;runtime/biasedLocking.hpp&quot;
  #include &quot;runtime/icache.hpp&quot;
  #include &quot;runtime/interfaceSupport.inline.hpp&quot;
  #include &quot;runtime/objectMonitor.hpp&quot;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -43,13 +44,10 @@</span>
  #include &quot;runtime/safepointMechanism.hpp&quot;
  #include &quot;runtime/sharedRuntime.hpp&quot;
  #include &quot;runtime/stubRoutines.hpp&quot;
  #include &quot;utilities/macros.hpp&quot;
  #include &quot;utilities/powerOfTwo.hpp&quot;
<span class="udiff-line-removed">- #ifdef COMPILER2</span>
<span class="udiff-line-removed">- #include &quot;opto/intrinsicnode.hpp&quot;</span>
<span class="udiff-line-removed">- #endif</span>
  
  #ifdef PRODUCT
  #define BLOCK_COMMENT(str) // nothing
  #else
  #define BLOCK_COMMENT(str) block_comment(str)
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -3309,556 +3307,10 @@</span>
    bind(done);
  }
  
  /////////////////////////////////////////// String intrinsics ////////////////////////////////////////////
  
<span class="udiff-line-removed">- #ifdef COMPILER2</span>
<span class="udiff-line-removed">- // Intrinsics for CompactStrings</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">- // Compress char[] to byte[] by compressing 16 bytes at once.</span>
<span class="udiff-line-removed">- void MacroAssembler::string_compress_16(Register src, Register dst, Register cnt,</span>
<span class="udiff-line-removed">-                                         Register tmp1, Register tmp2, Register tmp3, Register tmp4, Register tmp5,</span>
<span class="udiff-line-removed">-                                         Label&amp; Lfailure) {</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-   const Register tmp0 = R0;</span>
<span class="udiff-line-removed">-   assert_different_registers(src, dst, cnt, tmp0, tmp1, tmp2, tmp3, tmp4, tmp5);</span>
<span class="udiff-line-removed">-   Label Lloop, Lslow;</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-   // Check if cnt &gt;= 8 (= 16 bytes)</span>
<span class="udiff-line-removed">-   lis(tmp1, 0xFF);                // tmp1 = 0x00FF00FF00FF00FF</span>
<span class="udiff-line-removed">-   srwi_(tmp2, cnt, 3);</span>
<span class="udiff-line-removed">-   beq(CCR0, Lslow);</span>
<span class="udiff-line-removed">-   ori(tmp1, tmp1, 0xFF);</span>
<span class="udiff-line-removed">-   rldimi(tmp1, tmp1, 32, 0);</span>
<span class="udiff-line-removed">-   mtctr(tmp2);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-   // 2x unrolled loop</span>
<span class="udiff-line-removed">-   bind(Lloop);</span>
<span class="udiff-line-removed">-   ld(tmp2, 0, src);               // _0_1_2_3 (Big Endian)</span>
<span class="udiff-line-removed">-   ld(tmp4, 8, src);               // _4_5_6_7</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-   orr(tmp0, tmp2, tmp4);</span>
<span class="udiff-line-removed">-   rldicl(tmp3, tmp2, 6*8, 64-24); // _____1_2</span>
<span class="udiff-line-removed">-   rldimi(tmp2, tmp2, 2*8, 2*8);   // _0_2_3_3</span>
<span class="udiff-line-removed">-   rldicl(tmp5, tmp4, 6*8, 64-24); // _____5_6</span>
<span class="udiff-line-removed">-   rldimi(tmp4, tmp4, 2*8, 2*8);   // _4_6_7_7</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-   andc_(tmp0, tmp0, tmp1);</span>
<span class="udiff-line-removed">-   bne(CCR0, Lfailure);            // Not latin1.</span>
<span class="udiff-line-removed">-   addi(src, src, 16);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-   rlwimi(tmp3, tmp2, 0*8, 24, 31);// _____1_3</span>
<span class="udiff-line-removed">-   srdi(tmp2, tmp2, 3*8);          // ____0_2_</span>
<span class="udiff-line-removed">-   rlwimi(tmp5, tmp4, 0*8, 24, 31);// _____5_7</span>
<span class="udiff-line-removed">-   srdi(tmp4, tmp4, 3*8);          // ____4_6_</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-   orr(tmp2, tmp2, tmp3);          // ____0123</span>
<span class="udiff-line-removed">-   orr(tmp4, tmp4, tmp5);          // ____4567</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-   stw(tmp2, 0, dst);</span>
<span class="udiff-line-removed">-   stw(tmp4, 4, dst);</span>
<span class="udiff-line-removed">-   addi(dst, dst, 8);</span>
<span class="udiff-line-removed">-   bdnz(Lloop);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-   bind(Lslow);                    // Fallback to slow version</span>
<span class="udiff-line-removed">- }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">- // Compress char[] to byte[]. cnt must be positive int.</span>
<span class="udiff-line-removed">- void MacroAssembler::string_compress(Register src, Register dst, Register cnt, Register tmp, Label&amp; Lfailure) {</span>
<span class="udiff-line-removed">-   Label Lloop;</span>
<span class="udiff-line-removed">-   mtctr(cnt);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-   bind(Lloop);</span>
<span class="udiff-line-removed">-   lhz(tmp, 0, src);</span>
<span class="udiff-line-removed">-   cmplwi(CCR0, tmp, 0xff);</span>
<span class="udiff-line-removed">-   bgt(CCR0, Lfailure);            // Not latin1.</span>
<span class="udiff-line-removed">-   addi(src, src, 2);</span>
<span class="udiff-line-removed">-   stb(tmp, 0, dst);</span>
<span class="udiff-line-removed">-   addi(dst, dst, 1);</span>
<span class="udiff-line-removed">-   bdnz(Lloop);</span>
<span class="udiff-line-removed">- }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">- // Inflate byte[] to char[] by inflating 16 bytes at once.</span>
<span class="udiff-line-removed">- void MacroAssembler::string_inflate_16(Register src, Register dst, Register cnt,</span>
<span class="udiff-line-removed">-                                        Register tmp1, Register tmp2, Register tmp3, Register tmp4, Register tmp5) {</span>
<span class="udiff-line-removed">-   const Register tmp0 = R0;</span>
<span class="udiff-line-removed">-   assert_different_registers(src, dst, cnt, tmp0, tmp1, tmp2, tmp3, tmp4, tmp5);</span>
<span class="udiff-line-removed">-   Label Lloop, Lslow;</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-   // Check if cnt &gt;= 8</span>
<span class="udiff-line-removed">-   srwi_(tmp2, cnt, 3);</span>
<span class="udiff-line-removed">-   beq(CCR0, Lslow);</span>
<span class="udiff-line-removed">-   lis(tmp1, 0xFF);                // tmp1 = 0x00FF00FF</span>
<span class="udiff-line-removed">-   ori(tmp1, tmp1, 0xFF);</span>
<span class="udiff-line-removed">-   mtctr(tmp2);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-   // 2x unrolled loop</span>
<span class="udiff-line-removed">-   bind(Lloop);</span>
<span class="udiff-line-removed">-   lwz(tmp2, 0, src);              // ____0123 (Big Endian)</span>
<span class="udiff-line-removed">-   lwz(tmp4, 4, src);              // ____4567</span>
<span class="udiff-line-removed">-   addi(src, src, 8);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-   rldicl(tmp3, tmp2, 7*8, 64-8);  // _______2</span>
<span class="udiff-line-removed">-   rlwimi(tmp2, tmp2, 3*8, 16, 23);// ____0113</span>
<span class="udiff-line-removed">-   rldicl(tmp5, tmp4, 7*8, 64-8);  // _______6</span>
<span class="udiff-line-removed">-   rlwimi(tmp4, tmp4, 3*8, 16, 23);// ____4557</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-   andc(tmp0, tmp2, tmp1);         // ____0_1_</span>
<span class="udiff-line-removed">-   rlwimi(tmp2, tmp3, 2*8, 0, 23); // _____2_3</span>
<span class="udiff-line-removed">-   andc(tmp3, tmp4, tmp1);         // ____4_5_</span>
<span class="udiff-line-removed">-   rlwimi(tmp4, tmp5, 2*8, 0, 23); // _____6_7</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-   rldimi(tmp2, tmp0, 3*8, 0*8);   // _0_1_2_3</span>
<span class="udiff-line-removed">-   rldimi(tmp4, tmp3, 3*8, 0*8);   // _4_5_6_7</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-   std(tmp2, 0, dst);</span>
<span class="udiff-line-removed">-   std(tmp4, 8, dst);</span>
<span class="udiff-line-removed">-   addi(dst, dst, 16);</span>
<span class="udiff-line-removed">-   bdnz(Lloop);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-   bind(Lslow);                    // Fallback to slow version</span>
<span class="udiff-line-removed">- }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">- // Inflate byte[] to char[]. cnt must be positive int.</span>
<span class="udiff-line-removed">- void MacroAssembler::string_inflate(Register src, Register dst, Register cnt, Register tmp) {</span>
<span class="udiff-line-removed">-   Label Lloop;</span>
<span class="udiff-line-removed">-   mtctr(cnt);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-   bind(Lloop);</span>
<span class="udiff-line-removed">-   lbz(tmp, 0, src);</span>
<span class="udiff-line-removed">-   addi(src, src, 1);</span>
<span class="udiff-line-removed">-   sth(tmp, 0, dst);</span>
<span class="udiff-line-removed">-   addi(dst, dst, 2);</span>
<span class="udiff-line-removed">-   bdnz(Lloop);</span>
<span class="udiff-line-removed">- }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">- void MacroAssembler::string_compare(Register str1, Register str2,</span>
<span class="udiff-line-removed">-                                     Register cnt1, Register cnt2,</span>
<span class="udiff-line-removed">-                                     Register tmp1, Register result, int ae) {</span>
<span class="udiff-line-removed">-   const Register tmp0 = R0,</span>
<span class="udiff-line-removed">-                  diff = tmp1;</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-   assert_different_registers(str1, str2, cnt1, cnt2, tmp0, tmp1, result);</span>
<span class="udiff-line-removed">-   Label Ldone, Lslow, Lloop, Lreturn_diff;</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-   // Note: Making use of the fact that compareTo(a, b) == -compareTo(b, a)</span>
<span class="udiff-line-removed">-   // we interchange str1 and str2 in the UL case and negate the result.</span>
<span class="udiff-line-removed">-   // Like this, str1 is always latin1 encoded, except for the UU case.</span>
<span class="udiff-line-removed">-   // In addition, we need 0 (or sign which is 0) extend.</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-   if (ae == StrIntrinsicNode::UU) {</span>
<span class="udiff-line-removed">-     srwi(cnt1, cnt1, 1);</span>
<span class="udiff-line-removed">-   } else {</span>
<span class="udiff-line-removed">-     clrldi(cnt1, cnt1, 32);</span>
<span class="udiff-line-removed">-   }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-   if (ae != StrIntrinsicNode::LL) {</span>
<span class="udiff-line-removed">-     srwi(cnt2, cnt2, 1);</span>
<span class="udiff-line-removed">-   } else {</span>
<span class="udiff-line-removed">-     clrldi(cnt2, cnt2, 32);</span>
<span class="udiff-line-removed">-   }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-   // See if the lengths are different, and calculate min in cnt1.</span>
<span class="udiff-line-removed">-   // Save diff in case we need it for a tie-breaker.</span>
<span class="udiff-line-removed">-   subf_(diff, cnt2, cnt1); // diff = cnt1 - cnt2</span>
<span class="udiff-line-removed">-   // if (diff &gt; 0) { cnt1 = cnt2; }</span>
<span class="udiff-line-removed">-   if (VM_Version::has_isel()) {</span>
<span class="udiff-line-removed">-     isel(cnt1, CCR0, Assembler::greater, /*invert*/ false, cnt2);</span>
<span class="udiff-line-removed">-   } else {</span>
<span class="udiff-line-removed">-     Label Lskip;</span>
<span class="udiff-line-removed">-     blt(CCR0, Lskip);</span>
<span class="udiff-line-removed">-     mr(cnt1, cnt2);</span>
<span class="udiff-line-removed">-     bind(Lskip);</span>
<span class="udiff-line-removed">-   }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-   // Rename registers</span>
<span class="udiff-line-removed">-   Register chr1 = result;</span>
<span class="udiff-line-removed">-   Register chr2 = tmp0;</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-   // Compare multiple characters in fast loop (only implemented for same encoding).</span>
<span class="udiff-line-removed">-   int stride1 = 8, stride2 = 8;</span>
<span class="udiff-line-removed">-   if (ae == StrIntrinsicNode::LL || ae == StrIntrinsicNode::UU) {</span>
<span class="udiff-line-removed">-     int log2_chars_per_iter = (ae == StrIntrinsicNode::LL) ? 3 : 2;</span>
<span class="udiff-line-removed">-     Label Lfastloop, Lskipfast;</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     srwi_(tmp0, cnt1, log2_chars_per_iter);</span>
<span class="udiff-line-removed">-     beq(CCR0, Lskipfast);</span>
<span class="udiff-line-removed">-     rldicl(cnt2, cnt1, 0, 64 - log2_chars_per_iter); // Remaining characters.</span>
<span class="udiff-line-removed">-     li(cnt1, 1 &lt;&lt; log2_chars_per_iter); // Initialize for failure case: Rescan characters from current iteration.</span>
<span class="udiff-line-removed">-     mtctr(tmp0);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     bind(Lfastloop);</span>
<span class="udiff-line-removed">-     ld(chr1, 0, str1);</span>
<span class="udiff-line-removed">-     ld(chr2, 0, str2);</span>
<span class="udiff-line-removed">-     cmpd(CCR0, chr1, chr2);</span>
<span class="udiff-line-removed">-     bne(CCR0, Lslow);</span>
<span class="udiff-line-removed">-     addi(str1, str1, stride1);</span>
<span class="udiff-line-removed">-     addi(str2, str2, stride2);</span>
<span class="udiff-line-removed">-     bdnz(Lfastloop);</span>
<span class="udiff-line-removed">-     mr(cnt1, cnt2); // Remaining characters.</span>
<span class="udiff-line-removed">-     bind(Lskipfast);</span>
<span class="udiff-line-removed">-   }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-   // Loop which searches the first difference character by character.</span>
<span class="udiff-line-removed">-   cmpwi(CCR0, cnt1, 0);</span>
<span class="udiff-line-removed">-   beq(CCR0, Lreturn_diff);</span>
<span class="udiff-line-removed">-   bind(Lslow);</span>
<span class="udiff-line-removed">-   mtctr(cnt1);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-   switch (ae) {</span>
<span class="udiff-line-removed">-     case StrIntrinsicNode::LL: stride1 = 1; stride2 = 1; break;</span>
<span class="udiff-line-removed">-     case StrIntrinsicNode::UL: // fallthru (see comment above)</span>
<span class="udiff-line-removed">-     case StrIntrinsicNode::LU: stride1 = 1; stride2 = 2; break;</span>
<span class="udiff-line-removed">-     case StrIntrinsicNode::UU: stride1 = 2; stride2 = 2; break;</span>
<span class="udiff-line-removed">-     default: ShouldNotReachHere(); break;</span>
<span class="udiff-line-removed">-   }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-   bind(Lloop);</span>
<span class="udiff-line-removed">-   if (stride1 == 1) { lbz(chr1, 0, str1); } else { lhz(chr1, 0, str1); }</span>
<span class="udiff-line-removed">-   if (stride2 == 1) { lbz(chr2, 0, str2); } else { lhz(chr2, 0, str2); }</span>
<span class="udiff-line-removed">-   subf_(result, chr2, chr1); // result = chr1 - chr2</span>
<span class="udiff-line-removed">-   bne(CCR0, Ldone);</span>
<span class="udiff-line-removed">-   addi(str1, str1, stride1);</span>
<span class="udiff-line-removed">-   addi(str2, str2, stride2);</span>
<span class="udiff-line-removed">-   bdnz(Lloop);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-   // If strings are equal up to min length, return the length difference.</span>
<span class="udiff-line-removed">-   bind(Lreturn_diff);</span>
<span class="udiff-line-removed">-   mr(result, diff);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-   // Otherwise, return the difference between the first mismatched chars.</span>
<span class="udiff-line-removed">-   bind(Ldone);</span>
<span class="udiff-line-removed">-   if (ae == StrIntrinsicNode::UL) {</span>
<span class="udiff-line-removed">-     neg(result, result); // Negate result (see note above).</span>
<span class="udiff-line-removed">-   }</span>
<span class="udiff-line-removed">- }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">- void MacroAssembler::array_equals(bool is_array_equ, Register ary1, Register ary2,</span>
<span class="udiff-line-removed">-                                   Register limit, Register tmp1, Register result, bool is_byte) {</span>
<span class="udiff-line-removed">-   const Register tmp0 = R0;</span>
<span class="udiff-line-removed">-   assert_different_registers(ary1, ary2, limit, tmp0, tmp1, result);</span>
<span class="udiff-line-removed">-   Label Ldone, Lskiploop, Lloop, Lfastloop, Lskipfast;</span>
<span class="udiff-line-removed">-   bool limit_needs_shift = false;</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-   if (is_array_equ) {</span>
<span class="udiff-line-removed">-     const int length_offset = arrayOopDesc::length_offset_in_bytes();</span>
<span class="udiff-line-removed">-     const int base_offset   = arrayOopDesc::base_offset_in_bytes(is_byte ? T_BYTE : T_CHAR);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     // Return true if the same array.</span>
<span class="udiff-line-removed">-     cmpd(CCR0, ary1, ary2);</span>
<span class="udiff-line-removed">-     beq(CCR0, Lskiploop);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     // Return false if one of them is NULL.</span>
<span class="udiff-line-removed">-     cmpdi(CCR0, ary1, 0);</span>
<span class="udiff-line-removed">-     cmpdi(CCR1, ary2, 0);</span>
<span class="udiff-line-removed">-     li(result, 0);</span>
<span class="udiff-line-removed">-     cror(CCR0, Assembler::equal, CCR1, Assembler::equal);</span>
<span class="udiff-line-removed">-     beq(CCR0, Ldone);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     // Load the lengths of arrays.</span>
<span class="udiff-line-removed">-     lwz(limit, length_offset, ary1);</span>
<span class="udiff-line-removed">-     lwz(tmp0, length_offset, ary2);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     // Return false if the two arrays are not equal length.</span>
<span class="udiff-line-removed">-     cmpw(CCR0, limit, tmp0);</span>
<span class="udiff-line-removed">-     bne(CCR0, Ldone);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     // Load array addresses.</span>
<span class="udiff-line-removed">-     addi(ary1, ary1, base_offset);</span>
<span class="udiff-line-removed">-     addi(ary2, ary2, base_offset);</span>
<span class="udiff-line-removed">-   } else {</span>
<span class="udiff-line-removed">-     limit_needs_shift = !is_byte;</span>
<span class="udiff-line-removed">-     li(result, 0); // Assume not equal.</span>
<span class="udiff-line-removed">-   }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-   // Rename registers</span>
<span class="udiff-line-removed">-   Register chr1 = tmp0;</span>
<span class="udiff-line-removed">-   Register chr2 = tmp1;</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-   // Compare 8 bytes per iteration in fast loop.</span>
<span class="udiff-line-removed">-   const int log2_chars_per_iter = is_byte ? 3 : 2;</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-   srwi_(tmp0, limit, log2_chars_per_iter + (limit_needs_shift ? 1 : 0));</span>
<span class="udiff-line-removed">-   beq(CCR0, Lskipfast);</span>
<span class="udiff-line-removed">-   mtctr(tmp0);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-   bind(Lfastloop);</span>
<span class="udiff-line-removed">-   ld(chr1, 0, ary1);</span>
<span class="udiff-line-removed">-   ld(chr2, 0, ary2);</span>
<span class="udiff-line-removed">-   addi(ary1, ary1, 8);</span>
<span class="udiff-line-removed">-   addi(ary2, ary2, 8);</span>
<span class="udiff-line-removed">-   cmpd(CCR0, chr1, chr2);</span>
<span class="udiff-line-removed">-   bne(CCR0, Ldone);</span>
<span class="udiff-line-removed">-   bdnz(Lfastloop);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-   bind(Lskipfast);</span>
<span class="udiff-line-removed">-   rldicl_(limit, limit, limit_needs_shift ? 64 - 1 : 0, 64 - log2_chars_per_iter); // Remaining characters.</span>
<span class="udiff-line-removed">-   beq(CCR0, Lskiploop);</span>
<span class="udiff-line-removed">-   mtctr(limit);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-   // Character by character.</span>
<span class="udiff-line-removed">-   bind(Lloop);</span>
<span class="udiff-line-removed">-   if (is_byte) {</span>
<span class="udiff-line-removed">-     lbz(chr1, 0, ary1);</span>
<span class="udiff-line-removed">-     lbz(chr2, 0, ary2);</span>
<span class="udiff-line-removed">-     addi(ary1, ary1, 1);</span>
<span class="udiff-line-removed">-     addi(ary2, ary2, 1);</span>
<span class="udiff-line-removed">-   } else {</span>
<span class="udiff-line-removed">-     lhz(chr1, 0, ary1);</span>
<span class="udiff-line-removed">-     lhz(chr2, 0, ary2);</span>
<span class="udiff-line-removed">-     addi(ary1, ary1, 2);</span>
<span class="udiff-line-removed">-     addi(ary2, ary2, 2);</span>
<span class="udiff-line-removed">-   }</span>
<span class="udiff-line-removed">-   cmpw(CCR0, chr1, chr2);</span>
<span class="udiff-line-removed">-   bne(CCR0, Ldone);</span>
<span class="udiff-line-removed">-   bdnz(Lloop);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-   bind(Lskiploop);</span>
<span class="udiff-line-removed">-   li(result, 1); // All characters are equal.</span>
<span class="udiff-line-removed">-   bind(Ldone);</span>
<span class="udiff-line-removed">- }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">- void MacroAssembler::string_indexof(Register result, Register haystack, Register haycnt,</span>
<span class="udiff-line-removed">-                                     Register needle, ciTypeArray* needle_values, Register needlecnt, int needlecntval,</span>
<span class="udiff-line-removed">-                                     Register tmp1, Register tmp2, Register tmp3, Register tmp4, int ae) {</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-   // Ensure 0&lt;needlecnt&lt;=haycnt in ideal graph as prerequisite!</span>
<span class="udiff-line-removed">-   Label L_TooShort, L_Found, L_NotFound, L_End;</span>
<span class="udiff-line-removed">-   Register last_addr = haycnt, // Kill haycnt at the beginning.</span>
<span class="udiff-line-removed">-   addr      = tmp1,</span>
<span class="udiff-line-removed">-   n_start   = tmp2,</span>
<span class="udiff-line-removed">-   ch1       = tmp3,</span>
<span class="udiff-line-removed">-   ch2       = R0;</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-   assert(ae != StrIntrinsicNode::LU, &quot;Invalid encoding&quot;);</span>
<span class="udiff-line-removed">-   const int h_csize = (ae == StrIntrinsicNode::LL) ? 1 : 2;</span>
<span class="udiff-line-removed">-   const int n_csize = (ae == StrIntrinsicNode::UU) ? 2 : 1;</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-   // **************************************************************************************************</span>
<span class="udiff-line-removed">-   // Prepare for main loop: optimized for needle count &gt;=2, bail out otherwise.</span>
<span class="udiff-line-removed">-   // **************************************************************************************************</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-   // Compute last haystack addr to use if no match gets found.</span>
<span class="udiff-line-removed">-   clrldi(haycnt, haycnt, 32);         // Ensure positive int is valid as 64 bit value.</span>
<span class="udiff-line-removed">-   addi(addr, haystack, -h_csize);     // Accesses use pre-increment.</span>
<span class="udiff-line-removed">-   if (needlecntval == 0) { // variable needlecnt</span>
<span class="udiff-line-removed">-    cmpwi(CCR6, needlecnt, 2);</span>
<span class="udiff-line-removed">-    clrldi(needlecnt, needlecnt, 32);  // Ensure positive int is valid as 64 bit value.</span>
<span class="udiff-line-removed">-    blt(CCR6, L_TooShort);             // Variable needlecnt: handle short needle separately.</span>
<span class="udiff-line-removed">-   }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-   if (n_csize == 2) { lwz(n_start, 0, needle); } else { lhz(n_start, 0, needle); } // Load first 2 characters of needle.</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-   if (needlecntval == 0) { // variable needlecnt</span>
<span class="udiff-line-removed">-    subf(ch1, needlecnt, haycnt);      // Last character index to compare is haycnt-needlecnt.</span>
<span class="udiff-line-removed">-    addi(needlecnt, needlecnt, -2);    // Rest of needle.</span>
<span class="udiff-line-removed">-   } else { // constant needlecnt</span>
<span class="udiff-line-removed">-   guarantee(needlecntval != 1, &quot;IndexOf with single-character needle must be handled separately&quot;);</span>
<span class="udiff-line-removed">-   assert((needlecntval &amp; 0x7fff) == needlecntval, &quot;wrong immediate&quot;);</span>
<span class="udiff-line-removed">-    addi(ch1, haycnt, -needlecntval);  // Last character index to compare is haycnt-needlecnt.</span>
<span class="udiff-line-removed">-    if (needlecntval &gt; 3) { li(needlecnt, needlecntval - 2); } // Rest of needle.</span>
<span class="udiff-line-removed">-   }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-   if (h_csize == 2) { slwi(ch1, ch1, 1); } // Scale to number of bytes.</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-   if (ae ==StrIntrinsicNode::UL) {</span>
<span class="udiff-line-removed">-    srwi(tmp4, n_start, 1*8);          // ___0</span>
<span class="udiff-line-removed">-    rlwimi(n_start, tmp4, 2*8, 0, 23); // _0_1</span>
<span class="udiff-line-removed">-   }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-   add(last_addr, haystack, ch1);      // Point to last address to compare (haystack+2*(haycnt-needlecnt)).</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-   // Main Loop (now we have at least 2 characters).</span>
<span class="udiff-line-removed">-   Label L_OuterLoop, L_InnerLoop, L_FinalCheck, L_Comp1, L_Comp2;</span>
<span class="udiff-line-removed">-   bind(L_OuterLoop); // Search for 1st 2 characters.</span>
<span class="udiff-line-removed">-   Register addr_diff = tmp4;</span>
<span class="udiff-line-removed">-    subf(addr_diff, addr, last_addr);  // Difference between already checked address and last address to check.</span>
<span class="udiff-line-removed">-    addi(addr, addr, h_csize);         // This is the new address we want to use for comparing.</span>
<span class="udiff-line-removed">-    srdi_(ch2, addr_diff, h_csize);</span>
<span class="udiff-line-removed">-    beq(CCR0, L_FinalCheck);           // 2 characters left?</span>
<span class="udiff-line-removed">-    mtctr(ch2);                        // num of characters / 2</span>
<span class="udiff-line-removed">-   bind(L_InnerLoop);                  // Main work horse (2x unrolled search loop)</span>
<span class="udiff-line-removed">-    if (h_csize == 2) {                // Load 2 characters of haystack (ignore alignment).</span>
<span class="udiff-line-removed">-     lwz(ch1, 0, addr);</span>
<span class="udiff-line-removed">-     lwz(ch2, 2, addr);</span>
<span class="udiff-line-removed">-    } else {</span>
<span class="udiff-line-removed">-     lhz(ch1, 0, addr);</span>
<span class="udiff-line-removed">-     lhz(ch2, 1, addr);</span>
<span class="udiff-line-removed">-    }</span>
<span class="udiff-line-removed">-    cmpw(CCR0, ch1, n_start);          // Compare 2 characters (1 would be sufficient but try to reduce branches to CompLoop).</span>
<span class="udiff-line-removed">-    cmpw(CCR1, ch2, n_start);</span>
<span class="udiff-line-removed">-    beq(CCR0, L_Comp1);                // Did we find the needle start?</span>
<span class="udiff-line-removed">-    beq(CCR1, L_Comp2);</span>
<span class="udiff-line-removed">-    addi(addr, addr, 2 * h_csize);</span>
<span class="udiff-line-removed">-    bdnz(L_InnerLoop);</span>
<span class="udiff-line-removed">-   bind(L_FinalCheck);</span>
<span class="udiff-line-removed">-    andi_(addr_diff, addr_diff, h_csize); // Remaining characters not covered by InnerLoop: (num of characters) &amp; 1.</span>
<span class="udiff-line-removed">-    beq(CCR0, L_NotFound);</span>
<span class="udiff-line-removed">-    if (h_csize == 2) { lwz(ch1, 0, addr); } else { lhz(ch1, 0, addr); } // One position left at which we have to compare.</span>
<span class="udiff-line-removed">-    cmpw(CCR1, ch1, n_start);</span>
<span class="udiff-line-removed">-    beq(CCR1, L_Comp1);</span>
<span class="udiff-line-removed">-   bind(L_NotFound);</span>
<span class="udiff-line-removed">-    li(result, -1);                    // not found</span>
<span class="udiff-line-removed">-    b(L_End);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-    // **************************************************************************************************</span>
<span class="udiff-line-removed">-    // Special Case: unfortunately, the variable needle case can be called with needlecnt&lt;2</span>
<span class="udiff-line-removed">-    // **************************************************************************************************</span>
<span class="udiff-line-removed">-   if (needlecntval == 0) {           // We have to handle these cases separately.</span>
<span class="udiff-line-removed">-   Label L_OneCharLoop;</span>
<span class="udiff-line-removed">-   bind(L_TooShort);</span>
<span class="udiff-line-removed">-    mtctr(haycnt);</span>
<span class="udiff-line-removed">-    if (n_csize == 2) { lhz(n_start, 0, needle); } else { lbz(n_start, 0, needle); } // First character of needle</span>
<span class="udiff-line-removed">-   bind(L_OneCharLoop);</span>
<span class="udiff-line-removed">-    if (h_csize == 2) { lhzu(ch1, 2, addr); } else { lbzu(ch1, 1, addr); }</span>
<span class="udiff-line-removed">-    cmpw(CCR1, ch1, n_start);</span>
<span class="udiff-line-removed">-    beq(CCR1, L_Found);               // Did we find the one character needle?</span>
<span class="udiff-line-removed">-    bdnz(L_OneCharLoop);</span>
<span class="udiff-line-removed">-    li(result, -1);                   // Not found.</span>
<span class="udiff-line-removed">-    b(L_End);</span>
<span class="udiff-line-removed">-   }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-   // **************************************************************************************************</span>
<span class="udiff-line-removed">-   // Regular Case Part II: compare rest of needle (first 2 characters have been compared already)</span>
<span class="udiff-line-removed">-   // **************************************************************************************************</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-   // Compare the rest</span>
<span class="udiff-line-removed">-   bind(L_Comp2);</span>
<span class="udiff-line-removed">-    addi(addr, addr, h_csize);        // First comparison has failed, 2nd one hit.</span>
<span class="udiff-line-removed">-   bind(L_Comp1);                     // Addr points to possible needle start.</span>
<span class="udiff-line-removed">-   if (needlecntval != 2) {           // Const needlecnt==2?</span>
<span class="udiff-line-removed">-    if (needlecntval != 3) {</span>
<span class="udiff-line-removed">-     if (needlecntval == 0) { beq(CCR6, L_Found); } // Variable needlecnt==2?</span>
<span class="udiff-line-removed">-     Register n_ind = tmp4,</span>
<span class="udiff-line-removed">-              h_ind = n_ind;</span>
<span class="udiff-line-removed">-     li(n_ind, 2 * n_csize);          // First 2 characters are already compared, use index 2.</span>
<span class="udiff-line-removed">-     mtctr(needlecnt);                // Decremented by 2, still &gt; 0.</span>
<span class="udiff-line-removed">-    Label L_CompLoop;</span>
<span class="udiff-line-removed">-    bind(L_CompLoop);</span>
<span class="udiff-line-removed">-     if (ae ==StrIntrinsicNode::UL) {</span>
<span class="udiff-line-removed">-       h_ind = ch1;</span>
<span class="udiff-line-removed">-       sldi(h_ind, n_ind, 1);</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">-     if (n_csize == 2) { lhzx(ch2, needle, n_ind); } else { lbzx(ch2, needle, n_ind); }</span>
<span class="udiff-line-removed">-     if (h_csize == 2) { lhzx(ch1, addr, h_ind); } else { lbzx(ch1, addr, h_ind); }</span>
<span class="udiff-line-removed">-     cmpw(CCR1, ch1, ch2);</span>
<span class="udiff-line-removed">-     bne(CCR1, L_OuterLoop);</span>
<span class="udiff-line-removed">-     addi(n_ind, n_ind, n_csize);</span>
<span class="udiff-line-removed">-     bdnz(L_CompLoop);</span>
<span class="udiff-line-removed">-    } else { // No loop required if there&#39;s only one needle character left.</span>
<span class="udiff-line-removed">-     if (n_csize == 2) { lhz(ch2, 2 * 2, needle); } else { lbz(ch2, 2 * 1, needle); }</span>
<span class="udiff-line-removed">-     if (h_csize == 2) { lhz(ch1, 2 * 2, addr); } else { lbz(ch1, 2 * 1, addr); }</span>
<span class="udiff-line-removed">-     cmpw(CCR1, ch1, ch2);</span>
<span class="udiff-line-removed">-     bne(CCR1, L_OuterLoop);</span>
<span class="udiff-line-removed">-    }</span>
<span class="udiff-line-removed">-   }</span>
<span class="udiff-line-removed">-   // Return index ...</span>
<span class="udiff-line-removed">-   bind(L_Found);</span>
<span class="udiff-line-removed">-    subf(result, haystack, addr);     // relative to haystack, ...</span>
<span class="udiff-line-removed">-    if (h_csize == 2) { srdi(result, result, 1); } // in characters.</span>
<span class="udiff-line-removed">-   bind(L_End);</span>
<span class="udiff-line-removed">- } // string_indexof</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">- void MacroAssembler::string_indexof_char(Register result, Register haystack, Register haycnt,</span>
<span class="udiff-line-removed">-                                          Register needle, jchar needleChar, Register tmp1, Register tmp2, bool is_byte) {</span>
<span class="udiff-line-removed">-   assert_different_registers(haystack, haycnt, needle, tmp1, tmp2);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-   Label L_InnerLoop, L_FinalCheck, L_Found1, L_Found2, L_NotFound, L_End;</span>
<span class="udiff-line-removed">-   Register addr = tmp1,</span>
<span class="udiff-line-removed">-            ch1 = tmp2,</span>
<span class="udiff-line-removed">-            ch2 = R0;</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-   const int h_csize = is_byte ? 1 : 2;</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">- //4:</span>
<span class="udiff-line-removed">-    srwi_(tmp2, haycnt, 1);   // Shift right by exact_log2(UNROLL_FACTOR).</span>
<span class="udiff-line-removed">-    mr(addr, haystack);</span>
<span class="udiff-line-removed">-    beq(CCR0, L_FinalCheck);</span>
<span class="udiff-line-removed">-    mtctr(tmp2);              // Move to count register.</span>
<span class="udiff-line-removed">- //8:</span>
<span class="udiff-line-removed">-   bind(L_InnerLoop);         // Main work horse (2x unrolled search loop).</span>
<span class="udiff-line-removed">-    if (!is_byte) {</span>
<span class="udiff-line-removed">-     lhz(ch1, 0, addr);</span>
<span class="udiff-line-removed">-     lhz(ch2, 2, addr);</span>
<span class="udiff-line-removed">-    } else {</span>
<span class="udiff-line-removed">-     lbz(ch1, 0, addr);</span>
<span class="udiff-line-removed">-     lbz(ch2, 1, addr);</span>
<span class="udiff-line-removed">-    }</span>
<span class="udiff-line-removed">-    (needle != R0) ? cmpw(CCR0, ch1, needle) : cmplwi(CCR0, ch1, (unsigned int)needleChar);</span>
<span class="udiff-line-removed">-    (needle != R0) ? cmpw(CCR1, ch2, needle) : cmplwi(CCR1, ch2, (unsigned int)needleChar);</span>
<span class="udiff-line-removed">-    beq(CCR0, L_Found1);      // Did we find the needle?</span>
<span class="udiff-line-removed">-    beq(CCR1, L_Found2);</span>
<span class="udiff-line-removed">-    addi(addr, addr, 2 * h_csize);</span>
<span class="udiff-line-removed">-    bdnz(L_InnerLoop);</span>
<span class="udiff-line-removed">- //16:</span>
<span class="udiff-line-removed">-   bind(L_FinalCheck);</span>
<span class="udiff-line-removed">-    andi_(R0, haycnt, 1);</span>
<span class="udiff-line-removed">-    beq(CCR0, L_NotFound);</span>
<span class="udiff-line-removed">-    if (!is_byte) { lhz(ch1, 0, addr); } else { lbz(ch1, 0, addr); } // One position left at which we have to compare.</span>
<span class="udiff-line-removed">-    (needle != R0) ? cmpw(CCR1, ch1, needle) : cmplwi(CCR1, ch1, (unsigned int)needleChar);</span>
<span class="udiff-line-removed">-    beq(CCR1, L_Found1);</span>
<span class="udiff-line-removed">- //21:</span>
<span class="udiff-line-removed">-   bind(L_NotFound);</span>
<span class="udiff-line-removed">-    li(result, -1);           // Not found.</span>
<span class="udiff-line-removed">-    b(L_End);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-   bind(L_Found2);</span>
<span class="udiff-line-removed">-    addi(addr, addr, h_csize);</span>
<span class="udiff-line-removed">- //24:</span>
<span class="udiff-line-removed">-   bind(L_Found1);            // Return index ...</span>
<span class="udiff-line-removed">-    subf(result, haystack, addr); // relative to haystack, ...</span>
<span class="udiff-line-removed">-    if (!is_byte) { srdi(result, result, 1); } // in characters.</span>
<span class="udiff-line-removed">-   bind(L_End);</span>
<span class="udiff-line-removed">- } // string_indexof_char</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">- void MacroAssembler::has_negatives(Register src, Register cnt, Register result,</span>
<span class="udiff-line-removed">-                                    Register tmp1, Register tmp2) {</span>
<span class="udiff-line-removed">-   const Register tmp0 = R0;</span>
<span class="udiff-line-removed">-   assert_different_registers(src, result, cnt, tmp0, tmp1, tmp2);</span>
<span class="udiff-line-removed">-   Label Lfastloop, Lslow, Lloop, Lnoneg, Ldone;</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-   // Check if cnt &gt;= 8 (= 16 bytes)</span>
<span class="udiff-line-removed">-   lis(tmp1, (int)(short)0x8080);  // tmp1 = 0x8080808080808080</span>
<span class="udiff-line-removed">-   srwi_(tmp2, cnt, 4);</span>
<span class="udiff-line-removed">-   li(result, 1);                  // Assume there&#39;s a negative byte.</span>
<span class="udiff-line-removed">-   beq(CCR0, Lslow);</span>
<span class="udiff-line-removed">-   ori(tmp1, tmp1, 0x8080);</span>
<span class="udiff-line-removed">-   rldimi(tmp1, tmp1, 32, 0);</span>
<span class="udiff-line-removed">-   mtctr(tmp2);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-   // 2x unrolled loop</span>
<span class="udiff-line-removed">-   bind(Lfastloop);</span>
<span class="udiff-line-removed">-   ld(tmp2, 0, src);</span>
<span class="udiff-line-removed">-   ld(tmp0, 8, src);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-   orr(tmp0, tmp2, tmp0);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-   and_(tmp0, tmp0, tmp1);</span>
<span class="udiff-line-removed">-   bne(CCR0, Ldone);               // Found negative byte.</span>
<span class="udiff-line-removed">-   addi(src, src, 16);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-   bdnz(Lfastloop);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-   bind(Lslow);                    // Fallback to slow version</span>
<span class="udiff-line-removed">-   rldicl_(tmp0, cnt, 0, 64-4);</span>
<span class="udiff-line-removed">-   beq(CCR0, Lnoneg);</span>
<span class="udiff-line-removed">-   mtctr(tmp0);</span>
<span class="udiff-line-removed">-   bind(Lloop);</span>
<span class="udiff-line-removed">-   lbz(tmp0, 0, src);</span>
<span class="udiff-line-removed">-   addi(src, src, 1);</span>
<span class="udiff-line-removed">-   andi_(tmp0, tmp0, 0x80);</span>
<span class="udiff-line-removed">-   bne(CCR0, Ldone);               // Found negative byte.</span>
<span class="udiff-line-removed">-   bdnz(Lloop);</span>
<span class="udiff-line-removed">-   bind(Lnoneg);</span>
<span class="udiff-line-removed">-   li(result, 0);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-   bind(Ldone);</span>
<span class="udiff-line-removed">- }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">- #endif // Compiler2</span>
<span class="udiff-line-removed">- </span>
  // Helpers for Intrinsic Emitters
  //
  // Revert the byte order of a 32bit value in a register
  //   src: 0x44556677
  //   dst: 0x77665544
</pre>
<center><a href="../arm/macroAssembler_arm.hpp.udiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="macroAssembler_ppc.hpp.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>