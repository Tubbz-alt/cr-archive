<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/hotspot/share/classfile/systemDictionary.cpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
  </head>
<body>
<center><a href="packageEntry.cpp.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="systemDictionary.hpp.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/hotspot/share/classfile/systemDictionary.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 129   JavaValue result(T_OBJECT);
 130   InstanceKlass* class_loader_klass = SystemDictionary::ClassLoader_klass();
 131   JavaCalls::call_static(&amp;result,
 132                          class_loader_klass,
 133                          vmSymbols::getSystemClassLoader_name(),
 134                          vmSymbols::void_classloader_signature(),
 135                          CHECK);
 136 
 137   _java_system_loader = (oop)result.get_jobject();
 138 
 139   JavaCalls::call_static(&amp;result,
 140                          class_loader_klass,
 141                          vmSymbols::getPlatformClassLoader_name(),
 142                          vmSymbols::void_classloader_signature(),
 143                          CHECK);
 144 
 145   _java_platform_loader = (oop)result.get_jobject();
 146 }
 147 
 148 ClassLoaderData* SystemDictionary::register_loader(Handle class_loader) {
<span class="line-modified"> 149   if (class_loader() == NULL) return ClassLoaderData::the_null_class_loader_data();</span>
 150   return ClassLoaderDataGraph::find_or_create(class_loader);
 151 }
 152 
 153 // ----------------------------------------------------------------------------
 154 // Parallel class loading check
 155 
 156 bool SystemDictionary::is_parallelCapable(Handle class_loader) {
 157   if (class_loader.is_null()) return true;
 158   if (AlwaysLockClassLoader) return false;
 159   return java_lang_ClassLoader::parallelCapable(class_loader());
 160 }
 161 // ----------------------------------------------------------------------------
 162 // ParallelDefineClass flag does not apply to bootclass loader
 163 bool SystemDictionary::is_parallelDefine(Handle class_loader) {
 164    if (class_loader.is_null()) return false;
 165    if (AllowParallelDefineClass &amp;&amp; java_lang_ClassLoader::parallelCapable(class_loader())) {
 166      return true;
 167    }
 168    return false;
 169 }
</pre>
<hr />
<pre>
 999 
1000 // Look for a loaded instance or array klass by name.  Do not do any loading.
1001 // return NULL in case of error.
1002 Klass* SystemDictionary::find_instance_or_array_klass(Symbol* class_name,
1003                                                       Handle class_loader,
1004                                                       Handle protection_domain,
1005                                                       TRAPS) {
1006   Klass* k = NULL;
1007   assert(class_name != NULL, &quot;class name must be non NULL&quot;);
1008 
1009   if (Signature::is_array(class_name)) {
1010     // The name refers to an array.  Parse the name.
1011     // dimension and object_key in FieldArrayInfo are assigned as a
1012     // side-effect of this call
1013     SignatureStream ss(class_name, false);
1014     int ndims = ss.skip_array_prefix();  // skip all &#39;[&#39;s
1015     BasicType t = ss.type();
1016     if (t != T_OBJECT &amp;&amp; t != T_VALUETYPE) {
1017       k = Universe::typeArrayKlassObj(t);
1018     } else {
<span class="line-modified">1019       Symbol* obj_class = ss.as_symbol();</span>
<span class="line-removed">1020       k = SystemDictionary::find(obj_class, class_loader, protection_domain, THREAD);</span>
1021     }
1022     if (k != NULL) {
1023       k = k-&gt;array_klass_or_null(ArrayStorageProperties::for_signature(class_name), ndims);
1024     }
1025   } else {
1026     k = find(class_name, class_loader, protection_domain, THREAD);
1027   }
1028   return k;
1029 }
1030 
1031 // Note: this method is much like resolve_from_stream, but
1032 // does not publish the classes via the SystemDictionary.
1033 // Handles unsafe_DefineAnonymousClass and redefineclasses
1034 // RedefinedClasses do not add to the class hierarchy
1035 InstanceKlass* SystemDictionary::parse_stream(Symbol* class_name,
1036                                               Handle class_loader,
1037                                               Handle protection_domain,
1038                                               ClassFileStream* st,
1039                                               const InstanceKlass* unsafe_anonymous_host,
1040                                               GrowableArray&lt;Handle&gt;* cp_patches,
</pre>
<hr />
<pre>
1228   int path_index = ik-&gt;shared_classpath_index();
1229   ClassLoaderData* loader_data = class_loader_data(class_loader);
1230   if (path_index &lt; 0) {
1231     // path_index &lt; 0 indicates that the class is intended for a custom loader
1232     // and should not be loaded by boot/platform/app loaders
1233     if (loader_data-&gt;is_builtin_class_loader_data()) {
1234       return false;
1235     } else {
1236       return true;
1237     }
1238   }
1239   SharedClassPathEntry* ent =
1240             (SharedClassPathEntry*)FileMapInfo::shared_path(path_index);
1241   if (!Universe::is_module_initialized()) {
1242     assert(ent != NULL &amp;&amp; ent-&gt;is_modules_image(),
1243            &quot;Loading non-bootstrap classes before the module system is initialized&quot;);
1244     assert(class_loader.is_null(), &quot;sanity&quot;);
1245     return true;
1246   }
1247   // Get the pkg_entry from the classloader
<span class="line-removed">1248   TempNewSymbol pkg_name = NULL;</span>
1249   PackageEntry* pkg_entry = NULL;
1250   ModuleEntry* mod_entry = NULL;
<span class="line-modified">1251   pkg_name = InstanceKlass::package_from_name(class_name, CHECK_false);</span>
1252   if (pkg_name != NULL) {
1253     if (loader_data != NULL) {
1254       pkg_entry = loader_data-&gt;packages()-&gt;lookup_only(pkg_name);








1255     }
<span class="line-removed">1256     if (pkg_entry != NULL) {</span>
<span class="line-removed">1257       mod_entry = pkg_entry-&gt;module();</span>
<span class="line-removed">1258     }</span>
<span class="line-removed">1259   }</span>
<span class="line-removed">1260 </span>
<span class="line-removed">1261   // If the archived class is from a module that has been patched at runtime,</span>
<span class="line-removed">1262   // the class cannot be loaded from the archive.</span>
<span class="line-removed">1263   if (mod_entry != NULL &amp;&amp; mod_entry-&gt;is_patched()) {</span>
<span class="line-removed">1264     return false;</span>
1265   }
1266 
1267   if (class_loader.is_null()) {
1268     assert(ent != NULL, &quot;Shared class for NULL classloader must have valid SharedClassPathEntry&quot;);
1269     // The NULL classloader can load archived class originated from the
1270     // &quot;modules&quot; jimage and the -Xbootclasspath/a. For class from the
1271     // &quot;modules&quot; jimage, the PackageEntry/ModuleEntry must be defined
1272     // by the NULL classloader.
1273     if (mod_entry != NULL) {
1274       // PackageEntry/ModuleEntry is found in the classloader. Check if the
1275       // ModuleEntry&#39;s location agrees with the archived class&#39; origination.
1276       if (ent-&gt;is_modules_image() &amp;&amp; mod_entry-&gt;location()-&gt;starts_with(&quot;jrt:&quot;)) {
1277         return true; // Module class from the &quot;module&quot; jimage
1278       }
1279     }
1280 
1281     // If the archived class is not from the &quot;module&quot; jimage, the class can be
1282     // loaded by the NULL classloader if
1283     //
1284     // 1. the class is from the unamed package
</pre>
<hr />
<pre>
1286     // 3. or, the class is from an unamed module
1287     if (!ent-&gt;is_modules_image() &amp;&amp; ik-&gt;is_shared_boot_class()) {
1288       // the class is from the -Xbootclasspath/a
1289       if (pkg_name == NULL ||
1290           pkg_entry == NULL ||
1291           pkg_entry-&gt;in_unnamed_module()) {
1292         assert(mod_entry == NULL ||
1293                mod_entry == loader_data-&gt;unnamed_module(),
1294                &quot;the unnamed module is not defined in the classloader&quot;);
1295         return true;
1296       }
1297     }
1298     return false;
1299   } else {
1300     bool res = SystemDictionaryShared::is_shared_class_visible_for_classloader(
1301               ik, class_loader, pkg_name, pkg_entry, mod_entry, CHECK_(false));
1302     return res;
1303   }
1304 }
1305 
<span class="line-modified">1306 InstanceKlass* SystemDictionary::load_shared_class(InstanceKlass* ik,</span>
<span class="line-modified">1307                                                    Handle class_loader,</span>
<span class="line-modified">1308                                                    Handle protection_domain,</span>
<span class="line-modified">1309                                                    const ClassFileStream *cfs,</span>
<span class="line-removed">1310                                                    TRAPS) {</span>
<span class="line-removed">1311   assert(ik != NULL, &quot;sanity&quot;);</span>
<span class="line-removed">1312   assert(!ik-&gt;is_unshareable_info_restored(), &quot;shared class can be loaded only once&quot;);</span>
<span class="line-removed">1313   Symbol* class_name = ik-&gt;name();</span>
1314 
<span class="line-modified">1315   bool visible = is_shared_class_visible(</span>
<span class="line-modified">1316                           class_name, ik, class_loader, CHECK_NULL);</span>
<span class="line-modified">1317   if (!visible) {</span>
<span class="line-modified">1318     return NULL;</span>




1319   }

1320 
<span class="line-modified">1321   // Resolve the superclass and interfaces. They must be the same</span>


1322   // as in dump time, because the layout of &lt;ik&gt; depends on
1323   // the specific layout of ik-&gt;super() and ik-&gt;local_interfaces().
1324   //
1325   // If unexpected superclass or interfaces are found, we cannot
1326   // load &lt;ik&gt; from the shared archive.
1327 
<span class="line-modified">1328   if (ik-&gt;super() != NULL) {</span>
<span class="line-modified">1329     Symbol*  cn = ik-&gt;super()-&gt;name();</span>
<span class="line-modified">1330     Klass *s = resolve_super_or_fail(class_name, cn,</span>
<span class="line-modified">1331                                      class_loader, protection_domain, true, CHECK_NULL);</span>
<span class="line-removed">1332     if (s != ik-&gt;super()) {</span>
<span class="line-removed">1333       // The dynamically resolved super class is not the same as the one we used during dump time,</span>
<span class="line-removed">1334       // so we cannot use ik.</span>
<span class="line-removed">1335       return NULL;</span>
<span class="line-removed">1336     } else {</span>
<span class="line-removed">1337       assert(s-&gt;is_shared(), &quot;must be&quot;);</span>
<span class="line-removed">1338     }</span>
1339   }
1340 
1341   Array&lt;InstanceKlass*&gt;* interfaces = ik-&gt;local_interfaces();
1342   int num_interfaces = interfaces-&gt;length();
1343   for (int index = 0; index &lt; num_interfaces; index++) {
<span class="line-modified">1344     InstanceKlass* k = interfaces-&gt;at(index);</span>
<span class="line-modified">1345     Symbol* name  = k-&gt;name();</span>
<span class="line-removed">1346     Klass* i = resolve_super_or_fail(class_name, name, class_loader, protection_domain, false, CHECK_NULL);</span>
<span class="line-removed">1347     if (k != i) {</span>
<span class="line-removed">1348       // The dynamically resolved interface class is not the same as the one we used during dump time,</span>
<span class="line-removed">1349       // so we cannot use ik.</span>
<span class="line-removed">1350       return NULL;</span>
<span class="line-removed">1351     } else {</span>
<span class="line-removed">1352       assert(i-&gt;is_shared(), &quot;must be&quot;);</span>
1353     }
1354   }
1355 






















1356   InstanceKlass* new_ik = KlassFactory::check_shared_class_file_load_hook(
1357       ik, class_name, class_loader, protection_domain, cfs, CHECK_NULL);
1358   if (new_ik != NULL) {
1359     // The class is changed by CFLH. Return the new class. The shared class is
1360     // not used.
1361     return new_ik;
1362   }
1363 
1364   // Adjust methods to recover missing data.  They need addresses for
1365   // interpreter entry points and their default native method address
1366   // must be reset.
1367 
1368   // Updating methods must be done under a lock so multiple
1369   // threads don&#39;t update these in parallel
1370   //
1371   // Shared classes are all currently loaded by either the bootstrap or
1372   // internal parallel class loaders, so this will never cause a deadlock
1373   // on a custom class loader lock.
1374 
1375   ClassLoaderData* loader_data = ClassLoaderData::class_loader_data(class_loader());
1376   {
1377     HandleMark hm(THREAD);
1378     Handle lockObject = compute_loader_lock_object(class_loader, THREAD);
1379     check_loader_lock_contention(lockObject, THREAD);
1380     ObjectLocker ol(lockObject, THREAD, true);
1381     // prohibited package check assumes all classes loaded from archive call
1382     // restore_unshareable_info which calls ik-&gt;set_package()
1383     ik-&gt;restore_unshareable_info(loader_data, protection_domain, CHECK_NULL);
1384   }
1385 





1386   ik-&gt;print_class_load_logging(loader_data, NULL, NULL);
1387 
1388   // For boot loader, ensure that GetSystemPackage knows that a class in this
1389   // package was loaded.
<span class="line-modified">1390   if (class_loader.is_null()) {</span>
1391     int path_index = ik-&gt;shared_classpath_index();
<span class="line-modified">1392     ResourceMark rm(THREAD);</span>
<span class="line-removed">1393     ClassLoader::add_package(ik-&gt;name()-&gt;as_C_string(), path_index, THREAD);</span>
1394   }
1395 
1396   if (DumpLoadedClassList != NULL &amp;&amp; classlist_file-&gt;is_open()) {
1397     // Only dump the classes that can be stored into CDS archive
1398     if (SystemDictionaryShared::is_sharing_possible(loader_data)) {
1399       ResourceMark rm(THREAD);
1400       classlist_file-&gt;print_cr(&quot;%s&quot;, ik-&gt;name()-&gt;as_C_string());
1401       classlist_file-&gt;flush();
1402     }
1403   }
1404 
1405   // notify a class loaded from shared object
1406   ClassLoadingService::notify_class_loaded(ik, true /* shared class */);
1407 
1408   ik-&gt;set_has_passed_fingerprint_check(false);
1409   if (UseAOT &amp;&amp; ik-&gt;supers_have_passed_fingerprint_checks()) {
1410     uint64_t aot_fp = AOTLoader::get_saved_fingerprint(ik);
1411     uint64_t cds_fp = ik-&gt;get_stored_fingerprint();
1412     if (aot_fp != 0 &amp;&amp; aot_fp == cds_fp) {
1413       // This class matches with a class saved in an AOT library
1414       ik-&gt;set_has_passed_fingerprint_check(true);
1415     } else {
1416       if (log_is_enabled(Info, class, fingerprint)) {
1417         ResourceMark rm(THREAD);
1418         log_info(class, fingerprint)(&quot;%s :  expected = &quot; PTR64_FORMAT &quot; actual = &quot; PTR64_FORMAT, ik-&gt;external_name(), aot_fp, cds_fp);
1419       }
1420     }
1421   }























1422 
<span class="line-modified">1423   return ik;</span>






1424 }
1425 #endif // INCLUDE_CDS
1426 
1427 InstanceKlass* SystemDictionary::load_instance_class(Symbol* class_name, Handle class_loader, TRAPS) {
1428 
1429   if (class_loader.is_null()) {
1430     ResourceMark rm(THREAD);
1431     PackageEntry* pkg_entry = NULL;
1432     bool search_only_bootloader_append = false;
1433     ClassLoaderData *loader_data = class_loader_data(class_loader);
1434 
1435     // Find the package in the boot loader&#39;s package entry table.
<span class="line-modified">1436     TempNewSymbol pkg_name = InstanceKlass::package_from_name(class_name, CHECK_NULL);</span>
1437     if (pkg_name != NULL) {
1438       pkg_entry = loader_data-&gt;packages()-&gt;lookup_only(pkg_name);
1439     }
1440 
1441     // Prior to attempting to load the class, enforce the boot loader&#39;s
1442     // visibility boundaries.
1443     if (!Universe::is_module_initialized()) {
1444       // During bootstrapping, prior to module initialization, any
1445       // class attempting to be loaded must be checked against the
1446       // java.base packages in the boot loader&#39;s PackageEntryTable.
1447       // No class outside of java.base is allowed to be loaded during
1448       // this bootstrapping window.
1449       if (pkg_entry == NULL || pkg_entry-&gt;in_unnamed_module()) {
1450         // Class is either in the unnamed package or in
1451         // a named package within the unnamed module.  Either
1452         // case is outside of java.base, do not attempt to
1453         // load the class post java.base definition.  If
1454         // java.base has not been defined, let the class load
1455         // and its package will be checked later by
1456         // ModuleEntryTable::verify_javabase_packages.
</pre>
<hr />
<pre>
1815   guarantee(VerifyBeforeGC      ||
1816             VerifyDuringGC      ||
1817             VerifyBeforeExit    ||
1818             VerifyDuringStartup ||
1819             VerifyAfterGC, &quot;too expensive&quot;);
1820   #endif
1821 
1822   Dictionary* dictionary = loader_data-&gt;dictionary();
1823   unsigned int d_hash = dictionary-&gt;compute_hash(class_name);
1824   return find_class(d_hash, class_name, dictionary);
1825 }
1826 
1827 
1828 // ----------------------------------------------------------------------------
1829 // Update hierachy. This is done before the new klass has been added to the SystemDictionary. The Recompile_lock
1830 // is held, to ensure that the compiler is not using the class hierachy, and that deoptimization will kick in
1831 // before a new class is used.
1832 
1833 void SystemDictionary::add_to_hierarchy(InstanceKlass* k, TRAPS) {
1834   assert(k != NULL, &quot;just checking&quot;);
<span class="line-modified">1835   assert_locked_or_safepoint(Compile_lock);</span>


1836 
1837   k-&gt;set_init_state(InstanceKlass::loaded);
1838   // make sure init_state store is already done.
1839   // The compiler reads the hierarchy outside of the Compile_lock.
1840   // Access ordering is used to add to hierarchy.
1841 
1842   // Link into hierachy.
1843   k-&gt;append_to_sibling_list();                    // add to superklass/sibling list
1844   k-&gt;process_interfaces(THREAD);                  // handle all &quot;implements&quot; declarations
1845 
1846   // Now flush all code that depended on old class hierarchy.
1847   // Note: must be done *after* linking k into the hierarchy (was bug 12/9/97)
<span class="line-modified">1848   CodeCache::flush_dependents_on(k);</span>


1849 }
1850 
1851 // ----------------------------------------------------------------------------
1852 // GC support
1853 
1854 // Assumes classes in the SystemDictionary are only unloaded at a safepoint
1855 // Note: anonymous classes are not in the SD.
1856 bool SystemDictionary::do_unloading(GCTimer* gc_timer) {
1857 
1858   bool unloading_occurred;
1859   bool is_concurrent = !SafepointSynchronize::is_at_safepoint();
1860   {
1861     GCTraceTime(Debug, gc, phases) t(&quot;ClassLoaderData&quot;, gc_timer);
1862     assert_locked_or_safepoint(ClassLoaderDataGraph_lock);  // caller locks.
1863     // First, mark for unload all ClassLoaderData referencing a dead class loader.
1864     unloading_occurred = ClassLoaderDataGraph::do_unloading();
1865     if (unloading_occurred) {
1866       MutexLocker ml2(is_concurrent ? Module_lock : NULL);
1867       JFR_ONLY(Jfr::on_unloading_classes();)
1868 
</pre>
<hr />
<pre>
1947 
1948 #ifdef ASSERT
1949 bool SystemDictionary::is_well_known_klass(Symbol* class_name) {
1950   int sid;
1951   for (int i = 0; (sid = wk_init_info[i]) != 0; i++) {
1952     Symbol* symbol = vmSymbols::symbol_at((vmSymbols::SID)sid);
1953     if (class_name == symbol) {
1954       return true;
1955     }
1956   }
1957   return false;
1958 }
1959 #endif
1960 
1961 bool SystemDictionary::resolve_wk_klass(WKID id, TRAPS) {
1962   assert(id &gt;= (int)FIRST_WKID &amp;&amp; id &lt; (int)WKID_LIMIT, &quot;oob&quot;);
1963   int sid = wk_init_info[id - FIRST_WKID];
1964   Symbol* symbol = vmSymbols::symbol_at((vmSymbols::SID)sid);
1965   InstanceKlass** klassp = &amp;_well_known_klasses[id];
1966 
<span class="line-modified">1967   if ((*klassp) == NULL) {</span>
<span class="line-modified">1968     Klass* k = resolve_or_fail(symbol, true, CHECK_0);</span>











1969     (*klassp) = InstanceKlass::cast(k);
1970   }
1971   return ((*klassp) != NULL);
1972 }
1973 
1974 void SystemDictionary::resolve_wk_klasses_until(WKID limit_id, WKID &amp;start_id, TRAPS) {
1975   assert((int)start_id &lt;= (int)limit_id, &quot;IDs are out of order!&quot;);
1976   for (int id = (int)start_id; id &lt; (int)limit_id; id++) {
1977     assert(id &gt;= (int)FIRST_WKID &amp;&amp; id &lt; (int)WKID_LIMIT, &quot;oob&quot;);
1978     resolve_wk_klass((WKID)id, CHECK);
1979   }
1980 
1981   // move the starting value forward to the limit:
1982   start_id = limit_id;
1983 }
1984 
1985 void SystemDictionary::resolve_well_known_classes(TRAPS) {
<span class="line-modified">1986   assert(WK_KLASS(Object_klass) == NULL, &quot;well-known classes should only be initialized once&quot;);</span>
1987 
1988   // Create the ModuleEntry for java.base.  This call needs to be done here,
1989   // after vmSymbols::initialize() is called but before any classes are pre-loaded.
1990   ClassLoader::classLoader_init2(CHECK);
1991 
1992   // Preload commonly used klasses
1993   WKID scan = FIRST_WKID;
1994   // first do Object, then String, Class
1995 #if INCLUDE_CDS
1996   if (UseSharedSpaces) {
1997     resolve_wk_klasses_through(WK_KLASS_ENUM_NAME(Object_klass), scan, CHECK);
1998 
1999     // It&#39;s unsafe to access the archived heap regions before they
2000     // are fixed up, so we must do the fixup as early as possible
2001     // before the archived java objects are accessed by functions
2002     // such as java_lang_Class::restore_archived_mirror and
2003     // ConstantPool::restore_unshareable_info (restores the archived
2004     // resolved_references array object).
2005     //
2006     // HeapShared::fixup_mapped_heap_regions() fills the empty
</pre>
<hr />
<pre>
2014     // Initialize the constant pool for the Object_class
2015     assert(Object_klass()-&gt;is_shared(), &quot;must be&quot;);
2016     Object_klass()-&gt;constants()-&gt;restore_unshareable_info(CHECK);
2017     resolve_wk_klasses_through(WK_KLASS_ENUM_NAME(Class_klass), scan, CHECK);
2018   } else
2019 #endif
2020   {
2021     resolve_wk_klasses_through(WK_KLASS_ENUM_NAME(Class_klass), scan, CHECK);
2022   }
2023 
2024   assert(WK_KLASS(Object_klass) != NULL, &quot;well-known classes should now be initialized&quot;);
2025 
2026   java_lang_Object::register_natives(CHECK);
2027 
2028   // Calculate offsets for String and Class classes since they are loaded and
2029   // can be used after this point.
2030   java_lang_String::compute_offsets();
2031   java_lang_Class::compute_offsets();
2032 
2033   // Fixup mirrors for classes loaded before java.lang.Class.
<span class="line-removed">2034   // These calls iterate over the objects currently in the perm gen</span>
<span class="line-removed">2035   // so calling them at this point is matters (not before when there</span>
<span class="line-removed">2036   // are fewer objects and not later after there are more objects</span>
<span class="line-removed">2037   // in the perm gen.</span>
2038   Universe::initialize_basic_type_mirrors(CHECK);
2039   Universe::fixup_mirrors(CHECK);
2040 
2041   // do a bunch more:
2042   resolve_wk_klasses_through(WK_KLASS_ENUM_NAME(Reference_klass), scan, CHECK);
2043 
2044   // Preload ref klasses and set reference types
2045   WK_KLASS(Reference_klass)-&gt;set_reference_type(REF_OTHER);
2046   InstanceRefKlass::update_nonstatic_oop_maps(WK_KLASS(Reference_klass));
2047 
2048   resolve_wk_klasses_through(WK_KLASS_ENUM_NAME(PhantomReference_klass), scan, CHECK);
2049   WK_KLASS(SoftReference_klass)-&gt;set_reference_type(REF_SOFT);
2050   WK_KLASS(WeakReference_klass)-&gt;set_reference_type(REF_WEAK);
2051   WK_KLASS(FinalReference_klass)-&gt;set_reference_type(REF_FINAL);
2052   WK_KLASS(PhantomReference_klass)-&gt;set_reference_type(REF_PHANTOM);
2053 
2054   // JSR 292 classes
2055   WKID jsr292_group_start = WK_KLASS_ENUM_NAME(MethodHandle_klass);
2056   WKID jsr292_group_end   = WK_KLASS_ENUM_NAME(VolatileCallSite_klass);
2057   resolve_wk_klasses_until(jsr292_group_start, scan, CHECK);
2058   resolve_wk_klasses_through(jsr292_group_end, scan, CHECK);
2059   WKID last = WKID_LIMIT;
2060   resolve_wk_klasses_until(last, scan, CHECK);
2061 
2062   _box_klasses[T_BOOLEAN] = WK_KLASS(Boolean_klass);
2063   _box_klasses[T_CHAR]    = WK_KLASS(Character_klass);
2064   _box_klasses[T_FLOAT]   = WK_KLASS(Float_klass);
2065   _box_klasses[T_DOUBLE]  = WK_KLASS(Double_klass);
2066   _box_klasses[T_BYTE]    = WK_KLASS(Byte_klass);
2067   _box_klasses[T_SHORT]   = WK_KLASS(Short_klass);
2068   _box_klasses[T_INT]     = WK_KLASS(Integer_klass);
2069   _box_klasses[T_LONG]    = WK_KLASS(Long_klass);
2070   //_box_klasses[T_OBJECT]  = WK_KLASS(object_klass);
2071   //_box_klasses[T_ARRAY]   = WK_KLASS(object_klass);
2072 
2073 #ifdef ASSERT
2074   if (UseSharedSpaces) {
<span class="line-modified">2075     assert(JvmtiExport::is_early_phase(),</span>
<span class="line-modified">2076            &quot;All well known classes must be resolved in JVMTI early phase&quot;);</span>
2077     for (int i = FIRST_WKID; i &lt; last; i++) {
2078       InstanceKlass* k = _well_known_klasses[i];
2079       assert(k-&gt;is_shared(), &quot;must not be replaced by JVMTI class file load hook&quot;);
2080     }
2081   }
2082 #endif
2083 }
2084 
2085 // Tells if a given klass is a box (wrapper class, such as java.lang.Integer).
2086 // If so, returns the basic type it holds.  If not, returns T_OBJECT.
2087 BasicType SystemDictionary::box_klass_type(Klass* k) {
2088   assert(k != NULL, &quot;&quot;);
2089   for (int i = T_BOOLEAN; i &lt; T_VOID+1; i++) {
2090     if (_box_klasses[i] == k)
2091       return (BasicType)i;
2092   }
2093   return T_OBJECT;
2094 }
2095 
2096 // Constraints on class loaders. The details of the algorithm can be
</pre>
<hr />
<pre>
2512 
2513 // Decide if we can globally cache a lookup of this class, to be returned to any client that asks.
2514 // We must ensure that all class loaders everywhere will reach this class, for any client.
2515 // This is a safe bet for public classes in java.lang, such as Object and String.
2516 // We also include public classes in java.lang.invoke, because they appear frequently in system-level method types.
2517 // Out of an abundance of caution, we do not include any other classes, not even for packages like java.util.
2518 static bool is_always_visible_class(oop mirror) {
2519   Klass* klass = java_lang_Class::as_Klass(mirror);
2520   if (klass-&gt;is_objArray_klass()) {
2521     klass = ObjArrayKlass::cast(klass)-&gt;bottom_klass(); // check element type
2522   }
2523   if (klass-&gt;is_typeArray_klass()) {
2524     return true; // primitive array
2525   }
2526   assert(klass-&gt;is_instance_klass(), &quot;%s&quot;, klass-&gt;external_name());
2527   return klass-&gt;is_public() &amp;&amp;
2528          (InstanceKlass::cast(klass)-&gt;is_same_class_package(SystemDictionary::Object_klass()) ||       // java.lang
2529           InstanceKlass::cast(klass)-&gt;is_same_class_package(SystemDictionary::MethodHandle_klass()));  // java.lang.invoke
2530 }
2531 
<span class="line-modified">2532 // Find or construct the Java mirror (java.lang.Class instance) for a</span>
<span class="line-modified">2533 // for the given field type signature, as interpreted relative to the</span>
2534 // given class loader.  Handles primitives, void, references, arrays,
2535 // and all other reflectable types, except method types.
2536 // N.B.  Code in reflection should use this entry point.
2537 Handle SystemDictionary::find_java_mirror_for_type(Symbol* signature,
2538                                                    Klass* accessing_klass,
2539                                                    Handle class_loader,
2540                                                    Handle protection_domain,
2541                                                    SignatureStream::FailureMode failure_mode,
2542                                                    TRAPS) {
<span class="line-removed">2543   Handle empty;</span>
<span class="line-removed">2544 </span>
2545   assert(accessing_klass == NULL || (class_loader.is_null() &amp;&amp; protection_domain.is_null()),
2546          &quot;one or the other, or perhaps neither&quot;);
2547 
<span class="line-removed">2548   SignatureStream ss(signature, false);</span>
<span class="line-removed">2549 </span>
2550   // What we have here must be a valid field descriptor,
2551   // and all valid field descriptors are supported.
2552   // Produce the same java.lang.Class that reflection reports.
<span class="line-modified">2553   if (ss.is_primitive() || (ss.type() == T_VOID)) {</span>
<span class="line-modified">2554 </span>
<span class="line-modified">2555     // It&#39;s a primitive.  (Void has a primitive mirror too.)</span>
<span class="line-modified">2556     return Handle(THREAD, java_lang_Class::primitive_mirror(ss.type()));</span>
<span class="line-modified">2557 </span>
<span class="line-modified">2558   } else if (ss.is_reference()) {</span>
<span class="line-modified">2559 </span>
<span class="line-modified">2560     // It&#39;s a reference type.</span>
<span class="line-modified">2561     if (accessing_klass != NULL) {</span>
<span class="line-modified">2562       class_loader      = Handle(THREAD, accessing_klass-&gt;class_loader());</span>
<span class="line-removed">2563       protection_domain = Handle(THREAD, accessing_klass-&gt;protection_domain());</span>
<span class="line-removed">2564     }</span>
<span class="line-removed">2565     Klass* constant_type_klass;</span>
<span class="line-removed">2566     if (failure_mode == SignatureStream::ReturnNull) {</span>
<span class="line-removed">2567       constant_type_klass = resolve_or_null(signature, class_loader, protection_domain,</span>
<span class="line-removed">2568                                             CHECK_(empty));</span>
<span class="line-removed">2569     } else {</span>
<span class="line-removed">2570       bool throw_error = (failure_mode == SignatureStream::NCDFError);</span>
<span class="line-removed">2571       constant_type_klass = resolve_or_fail(signature, class_loader, protection_domain,</span>
<span class="line-removed">2572                                             throw_error, CHECK_(empty));</span>
<span class="line-removed">2573     }</span>
<span class="line-removed">2574     if (constant_type_klass == NULL) {</span>
<span class="line-removed">2575       return Handle();  // report failure this way</span>
<span class="line-removed">2576     }</span>
<span class="line-removed">2577     Handle mirror(THREAD, constant_type_klass-&gt;java_mirror());</span>
2578 

2579     // Check accessibility, emulating ConstantPool::verify_constant_pool_resolve.
<span class="line-modified">2580     if (accessing_klass != NULL) {</span>
<span class="line-modified">2581       Klass* sel_klass = constant_type_klass;</span>
2582       bool fold_type_to_class = true;
2583       LinkResolver::check_klass_accessability(accessing_klass, sel_klass,
<span class="line-modified">2584                                               fold_type_to_class, CHECK_(empty));</span>
2585     }
<span class="line-removed">2586 </span>
<span class="line-removed">2587     return mirror;</span>
<span class="line-removed">2588 </span>
2589   }
<span class="line-modified">2590 </span>
<span class="line-removed">2591   // Fall through to an error.</span>
<span class="line-removed">2592   assert(false, &quot;unsupported mirror syntax&quot;);</span>
<span class="line-removed">2593   THROW_MSG_(vmSymbols::java_lang_InternalError(), &quot;unsupported mirror syntax&quot;, empty);</span>
2594 }
2595 
2596 
2597 // Ask Java code to find or construct a java.lang.invoke.MethodType for the given
2598 // signature, as interpreted relative to the given class loader.
2599 // Because of class loader constraints, all method handle usage must be
2600 // consistent with this loader.
2601 Handle SystemDictionary::find_method_handle_type(Symbol* signature,
2602                                                  Klass* accessing_klass,
2603                                                  TRAPS) {
2604   Handle empty;
2605   vmIntrinsics::ID null_iid = vmIntrinsics::_none;  // distinct from all method handle invoker intrinsics
2606   unsigned int hash  = invoke_method_table()-&gt;compute_hash(signature, null_iid);
2607   int          index = invoke_method_table()-&gt;hash_to_index(hash);
2608   SymbolPropertyEntry* spe = invoke_method_table()-&gt;find_entry(index, hash, signature, null_iid);
2609   if (spe != NULL &amp;&amp; spe-&gt;method_type() != NULL) {
2610     assert(java_lang_invoke_MethodType::is_instance(spe-&gt;method_type()), &quot;&quot;);
2611     return Handle(THREAD, spe-&gt;method_type());
2612   } else if (!THREAD-&gt;can_call_java()) {
2613     warning(&quot;SystemDictionary::find_method_handle_type called from compiler thread&quot;);  // FIXME
</pre>
</td>
<td>
<hr />
<pre>
 129   JavaValue result(T_OBJECT);
 130   InstanceKlass* class_loader_klass = SystemDictionary::ClassLoader_klass();
 131   JavaCalls::call_static(&amp;result,
 132                          class_loader_klass,
 133                          vmSymbols::getSystemClassLoader_name(),
 134                          vmSymbols::void_classloader_signature(),
 135                          CHECK);
 136 
 137   _java_system_loader = (oop)result.get_jobject();
 138 
 139   JavaCalls::call_static(&amp;result,
 140                          class_loader_klass,
 141                          vmSymbols::getPlatformClassLoader_name(),
 142                          vmSymbols::void_classloader_signature(),
 143                          CHECK);
 144 
 145   _java_platform_loader = (oop)result.get_jobject();
 146 }
 147 
 148 ClassLoaderData* SystemDictionary::register_loader(Handle class_loader) {
<span class="line-modified"> 149   if (class_loader.is_null()) return ClassLoaderData::the_null_class_loader_data();</span>
 150   return ClassLoaderDataGraph::find_or_create(class_loader);
 151 }
 152 
 153 // ----------------------------------------------------------------------------
 154 // Parallel class loading check
 155 
 156 bool SystemDictionary::is_parallelCapable(Handle class_loader) {
 157   if (class_loader.is_null()) return true;
 158   if (AlwaysLockClassLoader) return false;
 159   return java_lang_ClassLoader::parallelCapable(class_loader());
 160 }
 161 // ----------------------------------------------------------------------------
 162 // ParallelDefineClass flag does not apply to bootclass loader
 163 bool SystemDictionary::is_parallelDefine(Handle class_loader) {
 164    if (class_loader.is_null()) return false;
 165    if (AllowParallelDefineClass &amp;&amp; java_lang_ClassLoader::parallelCapable(class_loader())) {
 166      return true;
 167    }
 168    return false;
 169 }
</pre>
<hr />
<pre>
 999 
1000 // Look for a loaded instance or array klass by name.  Do not do any loading.
1001 // return NULL in case of error.
1002 Klass* SystemDictionary::find_instance_or_array_klass(Symbol* class_name,
1003                                                       Handle class_loader,
1004                                                       Handle protection_domain,
1005                                                       TRAPS) {
1006   Klass* k = NULL;
1007   assert(class_name != NULL, &quot;class name must be non NULL&quot;);
1008 
1009   if (Signature::is_array(class_name)) {
1010     // The name refers to an array.  Parse the name.
1011     // dimension and object_key in FieldArrayInfo are assigned as a
1012     // side-effect of this call
1013     SignatureStream ss(class_name, false);
1014     int ndims = ss.skip_array_prefix();  // skip all &#39;[&#39;s
1015     BasicType t = ss.type();
1016     if (t != T_OBJECT &amp;&amp; t != T_VALUETYPE) {
1017       k = Universe::typeArrayKlassObj(t);
1018     } else {
<span class="line-modified">1019       k = SystemDictionary::find(ss.as_symbol(), class_loader, protection_domain, THREAD);</span>

1020     }
1021     if (k != NULL) {
1022       k = k-&gt;array_klass_or_null(ArrayStorageProperties::for_signature(class_name), ndims);
1023     }
1024   } else {
1025     k = find(class_name, class_loader, protection_domain, THREAD);
1026   }
1027   return k;
1028 }
1029 
1030 // Note: this method is much like resolve_from_stream, but
1031 // does not publish the classes via the SystemDictionary.
1032 // Handles unsafe_DefineAnonymousClass and redefineclasses
1033 // RedefinedClasses do not add to the class hierarchy
1034 InstanceKlass* SystemDictionary::parse_stream(Symbol* class_name,
1035                                               Handle class_loader,
1036                                               Handle protection_domain,
1037                                               ClassFileStream* st,
1038                                               const InstanceKlass* unsafe_anonymous_host,
1039                                               GrowableArray&lt;Handle&gt;* cp_patches,
</pre>
<hr />
<pre>
1227   int path_index = ik-&gt;shared_classpath_index();
1228   ClassLoaderData* loader_data = class_loader_data(class_loader);
1229   if (path_index &lt; 0) {
1230     // path_index &lt; 0 indicates that the class is intended for a custom loader
1231     // and should not be loaded by boot/platform/app loaders
1232     if (loader_data-&gt;is_builtin_class_loader_data()) {
1233       return false;
1234     } else {
1235       return true;
1236     }
1237   }
1238   SharedClassPathEntry* ent =
1239             (SharedClassPathEntry*)FileMapInfo::shared_path(path_index);
1240   if (!Universe::is_module_initialized()) {
1241     assert(ent != NULL &amp;&amp; ent-&gt;is_modules_image(),
1242            &quot;Loading non-bootstrap classes before the module system is initialized&quot;);
1243     assert(class_loader.is_null(), &quot;sanity&quot;);
1244     return true;
1245   }
1246   // Get the pkg_entry from the classloader

1247   PackageEntry* pkg_entry = NULL;
1248   ModuleEntry* mod_entry = NULL;
<span class="line-modified">1249   TempNewSymbol pkg_name = ClassLoader::package_from_class_name(class_name);</span>
1250   if (pkg_name != NULL) {
1251     if (loader_data != NULL) {
1252       pkg_entry = loader_data-&gt;packages()-&gt;lookup_only(pkg_name);
<span class="line-added">1253       if (pkg_entry != NULL) {</span>
<span class="line-added">1254         mod_entry = pkg_entry-&gt;module();</span>
<span class="line-added">1255         // If the archived class is from a module that has been patched at runtime,</span>
<span class="line-added">1256         // the class cannot be loaded from the archive.</span>
<span class="line-added">1257         if (mod_entry != NULL &amp;&amp; mod_entry-&gt;is_patched()) {</span>
<span class="line-added">1258           return false;</span>
<span class="line-added">1259         }</span>
<span class="line-added">1260       }</span>
1261     }









1262   }
1263 
1264   if (class_loader.is_null()) {
1265     assert(ent != NULL, &quot;Shared class for NULL classloader must have valid SharedClassPathEntry&quot;);
1266     // The NULL classloader can load archived class originated from the
1267     // &quot;modules&quot; jimage and the -Xbootclasspath/a. For class from the
1268     // &quot;modules&quot; jimage, the PackageEntry/ModuleEntry must be defined
1269     // by the NULL classloader.
1270     if (mod_entry != NULL) {
1271       // PackageEntry/ModuleEntry is found in the classloader. Check if the
1272       // ModuleEntry&#39;s location agrees with the archived class&#39; origination.
1273       if (ent-&gt;is_modules_image() &amp;&amp; mod_entry-&gt;location()-&gt;starts_with(&quot;jrt:&quot;)) {
1274         return true; // Module class from the &quot;module&quot; jimage
1275       }
1276     }
1277 
1278     // If the archived class is not from the &quot;module&quot; jimage, the class can be
1279     // loaded by the NULL classloader if
1280     //
1281     // 1. the class is from the unamed package
</pre>
<hr />
<pre>
1283     // 3. or, the class is from an unamed module
1284     if (!ent-&gt;is_modules_image() &amp;&amp; ik-&gt;is_shared_boot_class()) {
1285       // the class is from the -Xbootclasspath/a
1286       if (pkg_name == NULL ||
1287           pkg_entry == NULL ||
1288           pkg_entry-&gt;in_unnamed_module()) {
1289         assert(mod_entry == NULL ||
1290                mod_entry == loader_data-&gt;unnamed_module(),
1291                &quot;the unnamed module is not defined in the classloader&quot;);
1292         return true;
1293       }
1294     }
1295     return false;
1296   } else {
1297     bool res = SystemDictionaryShared::is_shared_class_visible_for_classloader(
1298               ik, class_loader, pkg_name, pkg_entry, mod_entry, CHECK_(false));
1299     return res;
1300   }
1301 }
1302 
<span class="line-modified">1303 bool SystemDictionary::check_shared_class_super_type(InstanceKlass* child, InstanceKlass* super_type,</span>
<span class="line-modified">1304                                                      Handle class_loader,  Handle protection_domain,</span>
<span class="line-modified">1305                                                      bool is_superclass, TRAPS) {</span>
<span class="line-modified">1306   assert(super_type-&gt;is_shared(), &quot;must be&quot;);</span>




1307 
<span class="line-modified">1308   Klass *found = resolve_super_or_fail(child-&gt;name(), super_type-&gt;name(),</span>
<span class="line-modified">1309                                        class_loader, protection_domain, is_superclass, CHECK_0);</span>
<span class="line-modified">1310   if (found == super_type) {</span>
<span class="line-modified">1311     return true;</span>
<span class="line-added">1312   } else {</span>
<span class="line-added">1313     // The dynamically resolved super type is not the same as the one we used during dump time,</span>
<span class="line-added">1314     // so we cannot use the child class.</span>
<span class="line-added">1315     return false;</span>
1316   }
<span class="line-added">1317 }</span>
1318 
<span class="line-modified">1319 bool SystemDictionary::check_shared_class_super_types(InstanceKlass* ik, Handle class_loader,</span>
<span class="line-added">1320                                                       Handle protection_domain, TRAPS) {</span>
<span class="line-added">1321   // Check the superclass and interfaces. They must be the same</span>
1322   // as in dump time, because the layout of &lt;ik&gt; depends on
1323   // the specific layout of ik-&gt;super() and ik-&gt;local_interfaces().
1324   //
1325   // If unexpected superclass or interfaces are found, we cannot
1326   // load &lt;ik&gt; from the shared archive.
1327 
<span class="line-modified">1328   if (ik-&gt;super() != NULL &amp;&amp;</span>
<span class="line-modified">1329       !check_shared_class_super_type(ik, InstanceKlass::cast(ik-&gt;super()),</span>
<span class="line-modified">1330                                      class_loader, protection_domain, true, THREAD)) {</span>
<span class="line-modified">1331     return false;</span>







1332   }
1333 
1334   Array&lt;InstanceKlass*&gt;* interfaces = ik-&gt;local_interfaces();
1335   int num_interfaces = interfaces-&gt;length();
1336   for (int index = 0; index &lt; num_interfaces; index++) {
<span class="line-modified">1337     if (!check_shared_class_super_type(ik, interfaces-&gt;at(index), class_loader, protection_domain, false, THREAD)) {</span>
<span class="line-modified">1338       return false;</span>







1339     }
1340   }
1341 
<span class="line-added">1342   return true;</span>
<span class="line-added">1343 }</span>
<span class="line-added">1344 </span>
<span class="line-added">1345 InstanceKlass* SystemDictionary::load_shared_class(InstanceKlass* ik,</span>
<span class="line-added">1346                                                    Handle class_loader,</span>
<span class="line-added">1347                                                    Handle protection_domain,</span>
<span class="line-added">1348                                                    const ClassFileStream *cfs,</span>
<span class="line-added">1349                                                    TRAPS) {</span>
<span class="line-added">1350   assert(ik != NULL, &quot;sanity&quot;);</span>
<span class="line-added">1351   assert(!ik-&gt;is_unshareable_info_restored(), &quot;shared class can be loaded only once&quot;);</span>
<span class="line-added">1352   Symbol* class_name = ik-&gt;name();</span>
<span class="line-added">1353 </span>
<span class="line-added">1354   bool visible = is_shared_class_visible(</span>
<span class="line-added">1355                           class_name, ik, class_loader, CHECK_NULL);</span>
<span class="line-added">1356   if (!visible) {</span>
<span class="line-added">1357     return NULL;</span>
<span class="line-added">1358   }</span>
<span class="line-added">1359 </span>
<span class="line-added">1360   if (!check_shared_class_super_types(ik, class_loader, protection_domain, THREAD)) {</span>
<span class="line-added">1361     return NULL;</span>
<span class="line-added">1362   }</span>
<span class="line-added">1363 </span>
1364   InstanceKlass* new_ik = KlassFactory::check_shared_class_file_load_hook(
1365       ik, class_name, class_loader, protection_domain, cfs, CHECK_NULL);
1366   if (new_ik != NULL) {
1367     // The class is changed by CFLH. Return the new class. The shared class is
1368     // not used.
1369     return new_ik;
1370   }
1371 
1372   // Adjust methods to recover missing data.  They need addresses for
1373   // interpreter entry points and their default native method address
1374   // must be reset.
1375 
1376   // Updating methods must be done under a lock so multiple
1377   // threads don&#39;t update these in parallel
1378   //
1379   // Shared classes are all currently loaded by either the bootstrap or
1380   // internal parallel class loaders, so this will never cause a deadlock
1381   // on a custom class loader lock.
1382 
1383   ClassLoaderData* loader_data = ClassLoaderData::class_loader_data(class_loader());
1384   {
1385     HandleMark hm(THREAD);
1386     Handle lockObject = compute_loader_lock_object(class_loader, THREAD);
1387     check_loader_lock_contention(lockObject, THREAD);
1388     ObjectLocker ol(lockObject, THREAD, true);
1389     // prohibited package check assumes all classes loaded from archive call
1390     // restore_unshareable_info which calls ik-&gt;set_package()
1391     ik-&gt;restore_unshareable_info(loader_data, protection_domain, CHECK_NULL);
1392   }
1393 
<span class="line-added">1394   load_shared_class_misc(ik, loader_data, CHECK_NULL);</span>
<span class="line-added">1395   return ik;</span>
<span class="line-added">1396 }</span>
<span class="line-added">1397 </span>
<span class="line-added">1398 void SystemDictionary::load_shared_class_misc(InstanceKlass* ik, ClassLoaderData* loader_data, TRAPS) {</span>
1399   ik-&gt;print_class_load_logging(loader_data, NULL, NULL);
1400 
1401   // For boot loader, ensure that GetSystemPackage knows that a class in this
1402   // package was loaded.
<span class="line-modified">1403   if (loader_data-&gt;is_the_null_class_loader_data()) {</span>
1404     int path_index = ik-&gt;shared_classpath_index();
<span class="line-modified">1405     ClassLoader::add_package(ik, path_index, THREAD);</span>

1406   }
1407 
1408   if (DumpLoadedClassList != NULL &amp;&amp; classlist_file-&gt;is_open()) {
1409     // Only dump the classes that can be stored into CDS archive
1410     if (SystemDictionaryShared::is_sharing_possible(loader_data)) {
1411       ResourceMark rm(THREAD);
1412       classlist_file-&gt;print_cr(&quot;%s&quot;, ik-&gt;name()-&gt;as_C_string());
1413       classlist_file-&gt;flush();
1414     }
1415   }
1416 
1417   // notify a class loaded from shared object
1418   ClassLoadingService::notify_class_loaded(ik, true /* shared class */);
1419 
1420   ik-&gt;set_has_passed_fingerprint_check(false);
1421   if (UseAOT &amp;&amp; ik-&gt;supers_have_passed_fingerprint_checks()) {
1422     uint64_t aot_fp = AOTLoader::get_saved_fingerprint(ik);
1423     uint64_t cds_fp = ik-&gt;get_stored_fingerprint();
1424     if (aot_fp != 0 &amp;&amp; aot_fp == cds_fp) {
1425       // This class matches with a class saved in an AOT library
1426       ik-&gt;set_has_passed_fingerprint_check(true);
1427     } else {
1428       if (log_is_enabled(Info, class, fingerprint)) {
1429         ResourceMark rm(THREAD);
1430         log_info(class, fingerprint)(&quot;%s :  expected = &quot; PTR64_FORMAT &quot; actual = &quot; PTR64_FORMAT, ik-&gt;external_name(), aot_fp, cds_fp);
1431       }
1432     }
1433   }
<span class="line-added">1434 }</span>
<span class="line-added">1435 </span>
<span class="line-added">1436 void SystemDictionary::quick_resolve(InstanceKlass* klass, ClassLoaderData* loader_data, Handle domain, TRAPS) {</span>
<span class="line-added">1437   assert(!Universe::is_fully_initialized(), &quot;We can make short cuts only during VM initialization&quot;);</span>
<span class="line-added">1438   assert(klass-&gt;is_shared(), &quot;Must be shared class&quot;);</span>
<span class="line-added">1439   if (klass-&gt;class_loader_data() != NULL) {</span>
<span class="line-added">1440     return;</span>
<span class="line-added">1441   }</span>
<span class="line-added">1442 </span>
<span class="line-added">1443   // add super and interfaces first</span>
<span class="line-added">1444   Klass* super = klass-&gt;super();</span>
<span class="line-added">1445   if (super != NULL &amp;&amp; super-&gt;class_loader_data() == NULL) {</span>
<span class="line-added">1446     assert(super-&gt;is_instance_klass(), &quot;Super should be instance klass&quot;);</span>
<span class="line-added">1447     quick_resolve(InstanceKlass::cast(super), loader_data, domain, CHECK);</span>
<span class="line-added">1448   }</span>
<span class="line-added">1449 </span>
<span class="line-added">1450   Array&lt;InstanceKlass*&gt;* ifs = klass-&gt;local_interfaces();</span>
<span class="line-added">1451   for (int i = 0; i &lt; ifs-&gt;length(); i++) {</span>
<span class="line-added">1452     InstanceKlass* ik = ifs-&gt;at(i);</span>
<span class="line-added">1453     if (ik-&gt;class_loader_data()  == NULL) {</span>
<span class="line-added">1454       quick_resolve(ik, loader_data, domain, CHECK);</span>
<span class="line-added">1455     }</span>
<span class="line-added">1456   }</span>
1457 
<span class="line-modified">1458   klass-&gt;restore_unshareable_info(loader_data, domain, THREAD);</span>
<span class="line-added">1459   load_shared_class_misc(klass, loader_data, CHECK);</span>
<span class="line-added">1460   Dictionary* dictionary = loader_data-&gt;dictionary();</span>
<span class="line-added">1461   unsigned int hash = dictionary-&gt;compute_hash(klass-&gt;name());</span>
<span class="line-added">1462   dictionary-&gt;add_klass(hash, klass-&gt;name(), klass);</span>
<span class="line-added">1463   add_to_hierarchy(klass, CHECK);</span>
<span class="line-added">1464   assert(klass-&gt;is_loaded(), &quot;Must be in at least loaded state&quot;);</span>
1465 }
1466 #endif // INCLUDE_CDS
1467 
1468 InstanceKlass* SystemDictionary::load_instance_class(Symbol* class_name, Handle class_loader, TRAPS) {
1469 
1470   if (class_loader.is_null()) {
1471     ResourceMark rm(THREAD);
1472     PackageEntry* pkg_entry = NULL;
1473     bool search_only_bootloader_append = false;
1474     ClassLoaderData *loader_data = class_loader_data(class_loader);
1475 
1476     // Find the package in the boot loader&#39;s package entry table.
<span class="line-modified">1477     TempNewSymbol pkg_name = ClassLoader::package_from_class_name(class_name);</span>
1478     if (pkg_name != NULL) {
1479       pkg_entry = loader_data-&gt;packages()-&gt;lookup_only(pkg_name);
1480     }
1481 
1482     // Prior to attempting to load the class, enforce the boot loader&#39;s
1483     // visibility boundaries.
1484     if (!Universe::is_module_initialized()) {
1485       // During bootstrapping, prior to module initialization, any
1486       // class attempting to be loaded must be checked against the
1487       // java.base packages in the boot loader&#39;s PackageEntryTable.
1488       // No class outside of java.base is allowed to be loaded during
1489       // this bootstrapping window.
1490       if (pkg_entry == NULL || pkg_entry-&gt;in_unnamed_module()) {
1491         // Class is either in the unnamed package or in
1492         // a named package within the unnamed module.  Either
1493         // case is outside of java.base, do not attempt to
1494         // load the class post java.base definition.  If
1495         // java.base has not been defined, let the class load
1496         // and its package will be checked later by
1497         // ModuleEntryTable::verify_javabase_packages.
</pre>
<hr />
<pre>
1856   guarantee(VerifyBeforeGC      ||
1857             VerifyDuringGC      ||
1858             VerifyBeforeExit    ||
1859             VerifyDuringStartup ||
1860             VerifyAfterGC, &quot;too expensive&quot;);
1861   #endif
1862 
1863   Dictionary* dictionary = loader_data-&gt;dictionary();
1864   unsigned int d_hash = dictionary-&gt;compute_hash(class_name);
1865   return find_class(d_hash, class_name, dictionary);
1866 }
1867 
1868 
1869 // ----------------------------------------------------------------------------
1870 // Update hierachy. This is done before the new klass has been added to the SystemDictionary. The Recompile_lock
1871 // is held, to ensure that the compiler is not using the class hierachy, and that deoptimization will kick in
1872 // before a new class is used.
1873 
1874 void SystemDictionary::add_to_hierarchy(InstanceKlass* k, TRAPS) {
1875   assert(k != NULL, &quot;just checking&quot;);
<span class="line-modified">1876   if (Universe::is_fully_initialized()) {</span>
<span class="line-added">1877     assert_locked_or_safepoint(Compile_lock);</span>
<span class="line-added">1878   }</span>
1879 
1880   k-&gt;set_init_state(InstanceKlass::loaded);
1881   // make sure init_state store is already done.
1882   // The compiler reads the hierarchy outside of the Compile_lock.
1883   // Access ordering is used to add to hierarchy.
1884 
1885   // Link into hierachy.
1886   k-&gt;append_to_sibling_list();                    // add to superklass/sibling list
1887   k-&gt;process_interfaces(THREAD);                  // handle all &quot;implements&quot; declarations
1888 
1889   // Now flush all code that depended on old class hierarchy.
1890   // Note: must be done *after* linking k into the hierarchy (was bug 12/9/97)
<span class="line-modified">1891   if (Universe::is_fully_initialized()) {</span>
<span class="line-added">1892     CodeCache::flush_dependents_on(k);</span>
<span class="line-added">1893   }</span>
1894 }
1895 
1896 // ----------------------------------------------------------------------------
1897 // GC support
1898 
1899 // Assumes classes in the SystemDictionary are only unloaded at a safepoint
1900 // Note: anonymous classes are not in the SD.
1901 bool SystemDictionary::do_unloading(GCTimer* gc_timer) {
1902 
1903   bool unloading_occurred;
1904   bool is_concurrent = !SafepointSynchronize::is_at_safepoint();
1905   {
1906     GCTraceTime(Debug, gc, phases) t(&quot;ClassLoaderData&quot;, gc_timer);
1907     assert_locked_or_safepoint(ClassLoaderDataGraph_lock);  // caller locks.
1908     // First, mark for unload all ClassLoaderData referencing a dead class loader.
1909     unloading_occurred = ClassLoaderDataGraph::do_unloading();
1910     if (unloading_occurred) {
1911       MutexLocker ml2(is_concurrent ? Module_lock : NULL);
1912       JFR_ONLY(Jfr::on_unloading_classes();)
1913 
</pre>
<hr />
<pre>
1992 
1993 #ifdef ASSERT
1994 bool SystemDictionary::is_well_known_klass(Symbol* class_name) {
1995   int sid;
1996   for (int i = 0; (sid = wk_init_info[i]) != 0; i++) {
1997     Symbol* symbol = vmSymbols::symbol_at((vmSymbols::SID)sid);
1998     if (class_name == symbol) {
1999       return true;
2000     }
2001   }
2002   return false;
2003 }
2004 #endif
2005 
2006 bool SystemDictionary::resolve_wk_klass(WKID id, TRAPS) {
2007   assert(id &gt;= (int)FIRST_WKID &amp;&amp; id &lt; (int)WKID_LIMIT, &quot;oob&quot;);
2008   int sid = wk_init_info[id - FIRST_WKID];
2009   Symbol* symbol = vmSymbols::symbol_at((vmSymbols::SID)sid);
2010   InstanceKlass** klassp = &amp;_well_known_klasses[id];
2011 
<span class="line-modified">2012 #if INCLUDE_CDS</span>
<span class="line-modified">2013   if (UseSharedSpaces &amp;&amp; !JvmtiExport::should_post_class_prepare()) {</span>
<span class="line-added">2014     InstanceKlass* k = *klassp;</span>
<span class="line-added">2015     assert(k-&gt;is_shared_boot_class(), &quot;must be&quot;);</span>
<span class="line-added">2016 </span>
<span class="line-added">2017     ClassLoaderData* loader_data = ClassLoaderData::the_null_class_loader_data();</span>
<span class="line-added">2018     quick_resolve(k, loader_data, Handle(), CHECK_false);</span>
<span class="line-added">2019     return true;</span>
<span class="line-added">2020   }</span>
<span class="line-added">2021 #endif // INCLUDE_CDS</span>
<span class="line-added">2022 </span>
<span class="line-added">2023   if (!is_wk_klass_loaded(*klassp)) {</span>
<span class="line-added">2024     Klass* k = resolve_or_fail(symbol, true, CHECK_false);</span>
2025     (*klassp) = InstanceKlass::cast(k);
2026   }
2027   return ((*klassp) != NULL);
2028 }
2029 
2030 void SystemDictionary::resolve_wk_klasses_until(WKID limit_id, WKID &amp;start_id, TRAPS) {
2031   assert((int)start_id &lt;= (int)limit_id, &quot;IDs are out of order!&quot;);
2032   for (int id = (int)start_id; id &lt; (int)limit_id; id++) {
2033     assert(id &gt;= (int)FIRST_WKID &amp;&amp; id &lt; (int)WKID_LIMIT, &quot;oob&quot;);
2034     resolve_wk_klass((WKID)id, CHECK);
2035   }
2036 
2037   // move the starting value forward to the limit:
2038   start_id = limit_id;
2039 }
2040 
2041 void SystemDictionary::resolve_well_known_classes(TRAPS) {
<span class="line-modified">2042   assert(!Object_klass_loaded(), &quot;well-known classes should only be initialized once&quot;);</span>
2043 
2044   // Create the ModuleEntry for java.base.  This call needs to be done here,
2045   // after vmSymbols::initialize() is called but before any classes are pre-loaded.
2046   ClassLoader::classLoader_init2(CHECK);
2047 
2048   // Preload commonly used klasses
2049   WKID scan = FIRST_WKID;
2050   // first do Object, then String, Class
2051 #if INCLUDE_CDS
2052   if (UseSharedSpaces) {
2053     resolve_wk_klasses_through(WK_KLASS_ENUM_NAME(Object_klass), scan, CHECK);
2054 
2055     // It&#39;s unsafe to access the archived heap regions before they
2056     // are fixed up, so we must do the fixup as early as possible
2057     // before the archived java objects are accessed by functions
2058     // such as java_lang_Class::restore_archived_mirror and
2059     // ConstantPool::restore_unshareable_info (restores the archived
2060     // resolved_references array object).
2061     //
2062     // HeapShared::fixup_mapped_heap_regions() fills the empty
</pre>
<hr />
<pre>
2070     // Initialize the constant pool for the Object_class
2071     assert(Object_klass()-&gt;is_shared(), &quot;must be&quot;);
2072     Object_klass()-&gt;constants()-&gt;restore_unshareable_info(CHECK);
2073     resolve_wk_klasses_through(WK_KLASS_ENUM_NAME(Class_klass), scan, CHECK);
2074   } else
2075 #endif
2076   {
2077     resolve_wk_klasses_through(WK_KLASS_ENUM_NAME(Class_klass), scan, CHECK);
2078   }
2079 
2080   assert(WK_KLASS(Object_klass) != NULL, &quot;well-known classes should now be initialized&quot;);
2081 
2082   java_lang_Object::register_natives(CHECK);
2083 
2084   // Calculate offsets for String and Class classes since they are loaded and
2085   // can be used after this point.
2086   java_lang_String::compute_offsets();
2087   java_lang_Class::compute_offsets();
2088 
2089   // Fixup mirrors for classes loaded before java.lang.Class.




2090   Universe::initialize_basic_type_mirrors(CHECK);
2091   Universe::fixup_mirrors(CHECK);
2092 
2093   // do a bunch more:
2094   resolve_wk_klasses_through(WK_KLASS_ENUM_NAME(Reference_klass), scan, CHECK);
2095 
2096   // Preload ref klasses and set reference types
2097   WK_KLASS(Reference_klass)-&gt;set_reference_type(REF_OTHER);
2098   InstanceRefKlass::update_nonstatic_oop_maps(WK_KLASS(Reference_klass));
2099 
2100   resolve_wk_klasses_through(WK_KLASS_ENUM_NAME(PhantomReference_klass), scan, CHECK);
2101   WK_KLASS(SoftReference_klass)-&gt;set_reference_type(REF_SOFT);
2102   WK_KLASS(WeakReference_klass)-&gt;set_reference_type(REF_WEAK);
2103   WK_KLASS(FinalReference_klass)-&gt;set_reference_type(REF_FINAL);
2104   WK_KLASS(PhantomReference_klass)-&gt;set_reference_type(REF_PHANTOM);
2105 
2106   // JSR 292 classes
2107   WKID jsr292_group_start = WK_KLASS_ENUM_NAME(MethodHandle_klass);
2108   WKID jsr292_group_end   = WK_KLASS_ENUM_NAME(VolatileCallSite_klass);
2109   resolve_wk_klasses_until(jsr292_group_start, scan, CHECK);
2110   resolve_wk_klasses_through(jsr292_group_end, scan, CHECK);
2111   WKID last = WKID_LIMIT;
2112   resolve_wk_klasses_until(last, scan, CHECK);
2113 
2114   _box_klasses[T_BOOLEAN] = WK_KLASS(Boolean_klass);
2115   _box_klasses[T_CHAR]    = WK_KLASS(Character_klass);
2116   _box_klasses[T_FLOAT]   = WK_KLASS(Float_klass);
2117   _box_klasses[T_DOUBLE]  = WK_KLASS(Double_klass);
2118   _box_klasses[T_BYTE]    = WK_KLASS(Byte_klass);
2119   _box_klasses[T_SHORT]   = WK_KLASS(Short_klass);
2120   _box_klasses[T_INT]     = WK_KLASS(Integer_klass);
2121   _box_klasses[T_LONG]    = WK_KLASS(Long_klass);
2122   //_box_klasses[T_OBJECT]  = WK_KLASS(object_klass);
2123   //_box_klasses[T_ARRAY]   = WK_KLASS(object_klass);
2124 
2125 #ifdef ASSERT
2126   if (UseSharedSpaces) {
<span class="line-modified">2127     JVMTI_ONLY(assert(JvmtiExport::is_early_phase(),</span>
<span class="line-modified">2128                       &quot;All well known classes must be resolved in JVMTI early phase&quot;));</span>
2129     for (int i = FIRST_WKID; i &lt; last; i++) {
2130       InstanceKlass* k = _well_known_klasses[i];
2131       assert(k-&gt;is_shared(), &quot;must not be replaced by JVMTI class file load hook&quot;);
2132     }
2133   }
2134 #endif
2135 }
2136 
2137 // Tells if a given klass is a box (wrapper class, such as java.lang.Integer).
2138 // If so, returns the basic type it holds.  If not, returns T_OBJECT.
2139 BasicType SystemDictionary::box_klass_type(Klass* k) {
2140   assert(k != NULL, &quot;&quot;);
2141   for (int i = T_BOOLEAN; i &lt; T_VOID+1; i++) {
2142     if (_box_klasses[i] == k)
2143       return (BasicType)i;
2144   }
2145   return T_OBJECT;
2146 }
2147 
2148 // Constraints on class loaders. The details of the algorithm can be
</pre>
<hr />
<pre>
2564 
2565 // Decide if we can globally cache a lookup of this class, to be returned to any client that asks.
2566 // We must ensure that all class loaders everywhere will reach this class, for any client.
2567 // This is a safe bet for public classes in java.lang, such as Object and String.
2568 // We also include public classes in java.lang.invoke, because they appear frequently in system-level method types.
2569 // Out of an abundance of caution, we do not include any other classes, not even for packages like java.util.
2570 static bool is_always_visible_class(oop mirror) {
2571   Klass* klass = java_lang_Class::as_Klass(mirror);
2572   if (klass-&gt;is_objArray_klass()) {
2573     klass = ObjArrayKlass::cast(klass)-&gt;bottom_klass(); // check element type
2574   }
2575   if (klass-&gt;is_typeArray_klass()) {
2576     return true; // primitive array
2577   }
2578   assert(klass-&gt;is_instance_klass(), &quot;%s&quot;, klass-&gt;external_name());
2579   return klass-&gt;is_public() &amp;&amp;
2580          (InstanceKlass::cast(klass)-&gt;is_same_class_package(SystemDictionary::Object_klass()) ||       // java.lang
2581           InstanceKlass::cast(klass)-&gt;is_same_class_package(SystemDictionary::MethodHandle_klass()));  // java.lang.invoke
2582 }
2583 
<span class="line-modified">2584 // Find or construct the Java mirror (java.lang.Class instance) for</span>
<span class="line-modified">2585 // the given field type signature, as interpreted relative to the</span>
2586 // given class loader.  Handles primitives, void, references, arrays,
2587 // and all other reflectable types, except method types.
2588 // N.B.  Code in reflection should use this entry point.
2589 Handle SystemDictionary::find_java_mirror_for_type(Symbol* signature,
2590                                                    Klass* accessing_klass,
2591                                                    Handle class_loader,
2592                                                    Handle protection_domain,
2593                                                    SignatureStream::FailureMode failure_mode,
2594                                                    TRAPS) {


2595   assert(accessing_klass == NULL || (class_loader.is_null() &amp;&amp; protection_domain.is_null()),
2596          &quot;one or the other, or perhaps neither&quot;);
2597 


2598   // What we have here must be a valid field descriptor,
2599   // and all valid field descriptors are supported.
2600   // Produce the same java.lang.Class that reflection reports.
<span class="line-modified">2601   if (accessing_klass != NULL) {</span>
<span class="line-modified">2602     class_loader      = Handle(THREAD, accessing_klass-&gt;class_loader());</span>
<span class="line-modified">2603     protection_domain = Handle(THREAD, accessing_klass-&gt;protection_domain());</span>
<span class="line-modified">2604   }</span>
<span class="line-modified">2605   ResolvingSignatureStream ss(signature, class_loader, protection_domain, false);</span>
<span class="line-modified">2606   oop mirror_oop = ss.as_java_mirror(failure_mode, CHECK_NH);</span>
<span class="line-modified">2607   if (mirror_oop == NULL) {</span>
<span class="line-modified">2608     return Handle();  // report failure this way</span>
<span class="line-modified">2609   }</span>
<span class="line-modified">2610   Handle mirror(THREAD, mirror_oop);</span>















2611 
<span class="line-added">2612   if (accessing_klass != NULL) {</span>
2613     // Check accessibility, emulating ConstantPool::verify_constant_pool_resolve.
<span class="line-modified">2614     Klass* sel_klass = java_lang_Class::as_Klass(mirror());</span>
<span class="line-modified">2615     if (sel_klass != NULL) {</span>
2616       bool fold_type_to_class = true;
2617       LinkResolver::check_klass_accessability(accessing_klass, sel_klass,
<span class="line-modified">2618                                               fold_type_to_class, CHECK_NH);</span>
2619     }



2620   }
<span class="line-modified">2621   return mirror;</span>



2622 }
2623 
2624 
2625 // Ask Java code to find or construct a java.lang.invoke.MethodType for the given
2626 // signature, as interpreted relative to the given class loader.
2627 // Because of class loader constraints, all method handle usage must be
2628 // consistent with this loader.
2629 Handle SystemDictionary::find_method_handle_type(Symbol* signature,
2630                                                  Klass* accessing_klass,
2631                                                  TRAPS) {
2632   Handle empty;
2633   vmIntrinsics::ID null_iid = vmIntrinsics::_none;  // distinct from all method handle invoker intrinsics
2634   unsigned int hash  = invoke_method_table()-&gt;compute_hash(signature, null_iid);
2635   int          index = invoke_method_table()-&gt;hash_to_index(hash);
2636   SymbolPropertyEntry* spe = invoke_method_table()-&gt;find_entry(index, hash, signature, null_iid);
2637   if (spe != NULL &amp;&amp; spe-&gt;method_type() != NULL) {
2638     assert(java_lang_invoke_MethodType::is_instance(spe-&gt;method_type()), &quot;&quot;);
2639     return Handle(THREAD, spe-&gt;method_type());
2640   } else if (!THREAD-&gt;can_call_java()) {
2641     warning(&quot;SystemDictionary::find_method_handle_type called from compiler thread&quot;);  // FIXME
</pre>
</td>
</tr>
</table>
<center><a href="packageEntry.cpp.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="systemDictionary.hpp.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>