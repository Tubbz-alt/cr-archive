<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff src/hotspot/share/classfile/systemDictionaryShared.cpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
  </head>
<body>
<center><a href="systemDictionary.hpp.udiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="systemDictionaryShared.hpp.udiff.html" target="_top">next &gt;</a></center>    <h2>src/hotspot/share/classfile/systemDictionaryShared.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -74,18 +74,20 @@</span>
      DTConstraint() : _name(NULL), _from_name(NULL) {}
      DTConstraint(Symbol* n, Symbol* fn) : _name(n), _from_name(fn) {}
    };
  
    InstanceKlass*               _klass;
<span class="udiff-line-added">+   bool                         _failed_verification;</span>
    int                          _id;
    int                          _clsfile_size;
    int                          _clsfile_crc32;
    GrowableArray&lt;DTConstraint&gt;* _verifier_constraints;
    GrowableArray&lt;char&gt;*         _verifier_constraint_flags;
  
    DumpTimeSharedClassInfo() {
      _klass = NULL;
<span class="udiff-line-added">+     _failed_verification = false;</span>
      _id = -1;
      _clsfile_size = -1;
      _clsfile_crc32 = -1;
      _excluded = false;
      _verifier_constraints = NULL;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -122,11 +124,19 @@</span>
      _excluded = true;
    }
  
    bool is_excluded() {
      // _klass may become NULL due to DynamicArchiveBuilder::set_to_null
<span class="udiff-line-modified-removed">-     return _excluded || _klass == NULL;</span>
<span class="udiff-line-modified-added">+     return _excluded || _failed_verification || _klass == NULL;</span>
<span class="udiff-line-added">+   }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+   void set_failed_verification() {</span>
<span class="udiff-line-added">+     _failed_verification = true;</span>
<span class="udiff-line-added">+   }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+   bool failed_verification() {</span>
<span class="udiff-line-added">+     return _failed_verification;</span>
    }
  };
  
  class DumpTimeSharedClassTable: public ResourceHashtable&lt;
    InstanceKlass*,
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -431,13 +441,13 @@</span>
  }
  
  Handle SystemDictionaryShared::get_package_name(Symbol* class_name, TRAPS) {
    ResourceMark rm(THREAD);
    Handle pkgname_string;
<span class="udiff-line-modified-removed">-   char* pkgname = (char*) ClassLoader::package_from_name((const char*) class_name-&gt;as_C_string());</span>
<span class="udiff-line-modified-removed">-   if (pkgname != NULL) { // Package prefix found</span>
<span class="udiff-line-modified-removed">-     StringUtils::replace_no_expand(pkgname, &quot;/&quot;, &quot;.&quot;);</span>
<span class="udiff-line-modified-added">+   Symbol* pkg = ClassLoader::package_from_class_name(class_name);</span>
<span class="udiff-line-modified-added">+   if (pkg != NULL) { // Package prefix found</span>
<span class="udiff-line-modified-added">+     const char* pkgname = pkg-&gt;as_klass_external_name();</span>
      pkgname_string = java_lang_String::create_from_str(pkgname,
                                                         CHECK_(pkgname_string));
    }
    return pkgname_string;
  }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -590,11 +600,11 @@</span>
        //   for fast access by the VM.
        ResourceMark rm;
        ClassLoaderData *loader_data =
                  ClassLoaderData::class_loader_data(class_loader());
        PackageEntryTable* pkgEntryTable = loader_data-&gt;packages();
<span class="udiff-line-modified-removed">-       TempNewSymbol pkg_name = InstanceKlass::package_from_name(class_name, CHECK_(pd));</span>
<span class="udiff-line-modified-added">+       TempNewSymbol pkg_name = ClassLoader::package_from_class_name(class_name);</span>
        if (pkg_name != NULL) {
          PackageEntry* pkg_entry = pkgEntryTable-&gt;lookup_only(pkg_name);
          if (pkg_entry != NULL) {
            ModuleEntry* mod_entry = pkg_entry-&gt;module();
            pd = get_shared_protection_domain(class_loader, mod_entry, THREAD);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -977,11 +987,11 @@</span>
      return false;
    } else {
      bool isnew = _loaded_unregistered_classes.put(name, true);
      assert(isnew, &quot;sanity&quot;);
      MutexLocker mu_r(THREAD, Compile_lock); // add_to_hierarchy asserts this.
<span class="udiff-line-modified-removed">-     SystemDictionary::add_to_hierarchy(k, CHECK_0);</span>
<span class="udiff-line-modified-added">+     SystemDictionary::add_to_hierarchy(k, CHECK_false);</span>
      return true;
    }
  }
  
  // This function is called to resolve the super/interfaces of shared classes for
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1084,10 +1094,14 @@</span>
    }
    if (k-&gt;is_in_error_state()) {
      warn_excluded(k, &quot;In error state&quot;);
      return true;
    }
<span class="udiff-line-added">+   if (k-&gt;has_been_redefined()) {</span>
<span class="udiff-line-added">+     warn_excluded(k, &quot;Has been redefined&quot;);</span>
<span class="udiff-line-added">+     return true;</span>
<span class="udiff-line-added">+   }</span>
    if (k-&gt;shared_classpath_index() &lt; 0 &amp;&amp; is_builtin(k)) {
      // These are classes loaded from unsupported locations (such as those loaded by JVMTI native
      // agent during dump time).
      warn_excluded(k, &quot;Unsupported location&quot;);
      return true;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1106,21 +1120,25 @@</span>
      // support them and make CDS more complicated.
      warn_excluded(k, &quot;JFR event class&quot;);
      return true;
    }
    if (k-&gt;init_state() &lt; InstanceKlass::linked) {
<span class="udiff-line-modified-removed">-     // In static dumping, we will attempt to link all classes. Those that fail to link will</span>
<span class="udiff-line-modified-removed">-     // be marked as in error state.</span>
<span class="udiff-line-modified-removed">-     assert(DynamicDumpSharedSpaces, &quot;must be&quot;);</span>
<span class="udiff-line-modified-added">+     // In CDS dumping, we will attempt to link all classes. Those that fail to link will</span>
<span class="udiff-line-modified-added">+     // be recorded in DumpTimeSharedClassInfo.</span>
<span class="udiff-line-modified-added">+     Arguments::assert_is_dumping_archive();</span>
  
      // TODO -- rethink how this can be handled.
      // We should try to link ik, however, we can&#39;t do it here because
      // 1. We are at VM exit
      // 2. linking a class may cause other classes to be loaded, which means
      //    a custom ClassLoader.loadClass() may be called, at a point where the
      //    class loader doesn&#39;t expect it.
<span class="udiff-line-modified-removed">-     warn_excluded(k, &quot;Not linked&quot;);</span>
<span class="udiff-line-modified-added">+     if (has_class_failed_verification(k)) {</span>
<span class="udiff-line-added">+       warn_excluded(k, &quot;Failed verification&quot;);</span>
<span class="udiff-line-added">+     } else {</span>
<span class="udiff-line-added">+       warn_excluded(k, &quot;Not linked&quot;);</span>
<span class="udiff-line-added">+     }</span>
      return true;
    }
    if (k-&gt;major_version() &lt; 50 /*JAVA_6_VERSION*/) {
      ResourceMark rm;
      log_warning(cds)(&quot;Pre JDK 6 class not supported by CDS: %u.%u %s&quot;,
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1155,14 +1173,14 @@</span>
    DumpTimeSharedClassInfo* info = _dumptime_table-&gt;get(k);
    assert(_no_class_loading_should_happen, &quot;class loading must be disabled&quot;);
    guarantee(info != NULL, &quot;Class %s must be entered into _dumptime_table&quot;, name);
    guarantee(!info-&gt;is_excluded(), &quot;Should not attempt to archive excluded class %s&quot;, name);
    if (is_builtin(k)) {
<span class="udiff-line-modified-removed">-     guarantee(k-&gt;loader_type() != 0,</span>
<span class="udiff-line-modified-added">+     guarantee(!k-&gt;is_shared_unregistered_class(),</span>
                &quot;Class loader type must be set for BUILTIN class %s&quot;, name);
    } else {
<span class="udiff-line-modified-removed">-     guarantee(k-&gt;loader_type() == 0,</span>
<span class="udiff-line-modified-added">+     guarantee(k-&gt;is_shared_unregistered_class(),</span>
                &quot;Class loader type must not be set for UNREGISTERED class %s&quot;, name);
    }
  }
  
  class ExcludeDumpTimeSharedClasses : StackObj {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1185,10 +1203,26 @@</span>
    assert(_no_class_loading_should_happen, &quot;sanity&quot;);
    Arguments::assert_is_dumping_archive();
    return find_or_allocate_info_for(k)-&gt;is_excluded();
  }
  
<span class="udiff-line-added">+ void SystemDictionaryShared::set_class_has_failed_verification(InstanceKlass* ik) {</span>
<span class="udiff-line-added">+   Arguments::assert_is_dumping_archive();</span>
<span class="udiff-line-added">+   find_or_allocate_info_for(ik)-&gt;set_failed_verification();</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ bool SystemDictionaryShared::has_class_failed_verification(InstanceKlass* ik) {</span>
<span class="udiff-line-added">+   Arguments::assert_is_dumping_archive();</span>
<span class="udiff-line-added">+   if (_dumptime_table == NULL) {</span>
<span class="udiff-line-added">+     assert(DynamicDumpSharedSpaces, &quot;sanity&quot;);</span>
<span class="udiff-line-added">+     assert(ik-&gt;is_shared(), &quot;must be a shared class in the static archive&quot;);</span>
<span class="udiff-line-added">+     return false;</span>
<span class="udiff-line-added">+   }</span>
<span class="udiff-line-added">+   DumpTimeSharedClassInfo* p = _dumptime_table-&gt;get(ik);</span>
<span class="udiff-line-added">+   return (p == NULL) ? false : p-&gt;failed_verification();</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
  class IterateDumpTimeSharedClassTable : StackObj {
    MetaspaceClosure *_it;
  public:
    IterateDumpTimeSharedClassTable(MetaspaceClosure* it) : _it(it) {}
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1408,10 +1442,16 @@</span>
      _dynamic_builtin_dictionary.serialize_header(soc);
      _dynamic_unregistered_dictionary.serialize_header(soc);
    }
  }
  
<span class="udiff-line-added">+ void SystemDictionaryShared::serialize_well_known_klasses(SerializeClosure* soc) {</span>
<span class="udiff-line-added">+   for (int i = FIRST_WKID; i &lt; WKID_LIMIT; i++) {</span>
<span class="udiff-line-added">+     soc-&gt;do_ptr((void**)&amp;_well_known_klasses[i]);</span>
<span class="udiff-line-added">+   }</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
  const RunTimeSharedClassInfo*
  SystemDictionaryShared::find_record(RunTimeSharedDictionary* static_dict, RunTimeSharedDictionary* dynamic_dict, Symbol* name) {
    if (!UseSharedSpaces || !name-&gt;is_shared()) {
      // The names of all shared classes must also be a shared Symbol.
      return NULL;
</pre>
<center><a href="systemDictionary.hpp.udiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="systemDictionaryShared.hpp.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>