<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff src/hotspot/share/jvmci/jvmciCompilerToVM.cpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
  </head>
<body>
<center><a href="jvmciCodeInstaller.hpp.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="jvmciCompilerToVMInit.cpp.cdiff.html" target="_top">next &gt;</a></center>    <h2>src/hotspot/share/jvmci/jvmciCompilerToVM.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 26,10 ***</span>
<span class="line-new-header">--- 26,11 ---</span>
  #include &quot;classfile/javaClasses.inline.hpp&quot;
  #include &quot;classfile/stringTable.hpp&quot;
  #include &quot;classfile/symbolTable.hpp&quot;
  #include &quot;code/scopeDesc.hpp&quot;
  #include &quot;compiler/compileBroker.hpp&quot;
<span class="line-added">+ #include &quot;compiler/compilerEvent.hpp&quot;</span>
  #include &quot;compiler/disassembler.hpp&quot;
  #include &quot;interpreter/linkResolver.hpp&quot;
  #include &quot;interpreter/bytecodeStream.hpp&quot;
  #include &quot;jvmci/jvmciCompilerToVM.hpp&quot;
  #include &quot;jvmci/jvmciCodeInstaller.hpp&quot;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 532,37 ***</span>
      class_loader = Handle(THREAD, SystemDictionary::java_system_loader());
      JVMCIENV-&gt;runtime()-&gt;initialize(JVMCIENV);
    }
  
    if (resolve) {
<span class="line-modified">!     resolved_klass = SystemDictionary::resolve_or_null(class_name, class_loader, protection_domain, CHECK_0);</span>
      if (resolved_klass == NULL) {
        JVMCI_THROW_MSG_NULL(ClassNotFoundException, str);
      }
    } else {
      if (Signature::has_envelope(class_name)) {
        // This is a name from a signature.  Strip off the trimmings.
        // Call recursive to keep scope of strippedsym.
        TempNewSymbol strippedsym = Signature::strip_envelope(class_name);
<span class="line-modified">!       resolved_klass = SystemDictionary::find(strippedsym, class_loader, protection_domain, CHECK_0);</span>
      } else if (Signature::is_array(class_name)) {
        SignatureStream ss(class_name, false);
        int ndim = ss.skip_array_prefix();
        if (ss.type() == T_OBJECT) {
          Symbol* strippedsym = ss.as_symbol();
          resolved_klass = SystemDictionary::find(strippedsym,
                                                  class_loader,
                                                  protection_domain,
<span class="line-modified">!                                                 CHECK_0);</span>
          if (!resolved_klass.is_null()) {
<span class="line-modified">!           resolved_klass = resolved_klass-&gt;array_klass(ndim, CHECK_0);</span>
          }
        } else {
<span class="line-modified">!         resolved_klass = TypeArrayKlass::cast(Universe::typeArrayKlassObj(ss.type()))-&gt;array_klass(ndim, CHECK_0);</span>
        }
      } else {
<span class="line-modified">!       resolved_klass = SystemDictionary::find(class_name, class_loader, protection_domain, CHECK_0);</span>
      }
    }
    JVMCIObject result = JVMCIENV-&gt;get_jvmci_type(resolved_klass, JVMCI_CHECK_NULL);
    return JVMCIENV-&gt;get_jobject(result);
  C2V_END
<span class="line-new-header">--- 533,37 ---</span>
      class_loader = Handle(THREAD, SystemDictionary::java_system_loader());
      JVMCIENV-&gt;runtime()-&gt;initialize(JVMCIENV);
    }
  
    if (resolve) {
<span class="line-modified">!     resolved_klass = SystemDictionary::resolve_or_null(class_name, class_loader, protection_domain, CHECK_NULL);</span>
      if (resolved_klass == NULL) {
        JVMCI_THROW_MSG_NULL(ClassNotFoundException, str);
      }
    } else {
      if (Signature::has_envelope(class_name)) {
        // This is a name from a signature.  Strip off the trimmings.
        // Call recursive to keep scope of strippedsym.
        TempNewSymbol strippedsym = Signature::strip_envelope(class_name);
<span class="line-modified">!       resolved_klass = SystemDictionary::find(strippedsym, class_loader, protection_domain, CHECK_NULL);</span>
      } else if (Signature::is_array(class_name)) {
        SignatureStream ss(class_name, false);
        int ndim = ss.skip_array_prefix();
        if (ss.type() == T_OBJECT) {
          Symbol* strippedsym = ss.as_symbol();
          resolved_klass = SystemDictionary::find(strippedsym,
                                                  class_loader,
                                                  protection_domain,
<span class="line-modified">!                                                 CHECK_NULL);</span>
          if (!resolved_klass.is_null()) {
<span class="line-modified">!           resolved_klass = resolved_klass-&gt;array_klass(ndim, CHECK_NULL);</span>
          }
        } else {
<span class="line-modified">!         resolved_klass = TypeArrayKlass::cast(Universe::typeArrayKlassObj(ss.type()))-&gt;array_klass(ndim, CHECK_NULL);</span>
        }
      } else {
<span class="line-modified">!       resolved_klass = SystemDictionary::find(class_name, class_loader, protection_domain, CHECK_NULL);</span>
      }
    }
    JVMCIObject result = JVMCIENV-&gt;get_jvmci_type(resolved_klass, JVMCI_CHECK_NULL);
    return JVMCIENV-&gt;get_jobject(result);
  C2V_END
</pre>
<hr />
<pre>
<span class="line-old-header">*** 702,12 ***</span>
  C2V_VMENTRY_NULL(jobject, resolveFieldInPool, (JNIEnv* env, jobject, jobject jvmci_constant_pool, jint index, jobject jvmci_method, jbyte opcode, jintArray info_handle))
    constantPoolHandle cp(THREAD, JVMCIENV-&gt;asConstantPool(jvmci_constant_pool));
    Bytecodes::Code code = (Bytecodes::Code)(((int) opcode) &amp; 0xFF);
    fieldDescriptor fd;
    methodHandle mh(THREAD, (jvmci_method != NULL) ? JVMCIENV-&gt;asMethod(jvmci_method) : NULL);
<span class="line-modified">!   LinkInfo link_info(cp, index, mh, CHECK_0);</span>
<span class="line-modified">!   LinkResolver::resolve_field(fd, link_info, Bytecodes::java_code(code), false, CHECK_0);</span>
    JVMCIPrimitiveArray info = JVMCIENV-&gt;wrap(info_handle);
    if (info.is_null() || JVMCIENV-&gt;get_length(info) != 3) {
      JVMCI_ERROR_NULL(&quot;info must not be null and have a length of 3&quot;);
    }
    JVMCIENV-&gt;put_int_at(info, 0, fd.access_flags().as_int());
<span class="line-new-header">--- 703,12 ---</span>
  C2V_VMENTRY_NULL(jobject, resolveFieldInPool, (JNIEnv* env, jobject, jobject jvmci_constant_pool, jint index, jobject jvmci_method, jbyte opcode, jintArray info_handle))
    constantPoolHandle cp(THREAD, JVMCIENV-&gt;asConstantPool(jvmci_constant_pool));
    Bytecodes::Code code = (Bytecodes::Code)(((int) opcode) &amp; 0xFF);
    fieldDescriptor fd;
    methodHandle mh(THREAD, (jvmci_method != NULL) ? JVMCIENV-&gt;asMethod(jvmci_method) : NULL);
<span class="line-modified">!   LinkInfo link_info(cp, index, mh, CHECK_NULL);</span>
<span class="line-modified">!   LinkResolver::resolve_field(fd, link_info, Bytecodes::java_code(code), false, CHECK_NULL);</span>
    JVMCIPrimitiveArray info = JVMCIENV-&gt;wrap(info_handle);
    if (info.is_null() || JVMCIENV-&gt;get_length(info) != 3) {
      JVMCI_ERROR_NULL(&quot;info must not be null and have a length of 3&quot;);
    }
    JVMCIENV-&gt;put_int_at(info, 0, fd.access_flags().as_int());
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1823,11 ***</span>
    Handle str = JVMCIENV-&gt;asConstant(JVMCIENV-&gt;wrap(object), JVMCI_CHECK_0);
    if (!java_lang_String::is_instance(str())) {
      return false;
    }
    int len;
<span class="line-modified">!   jchar* name = java_lang_String::as_unicode_string(str(), len, CHECK_0);</span>
    return (StringTable::lookup(name, len) != NULL);
  C2V_END
  
  
  C2V_VMENTRY_NULL(jobject, unboxPrimitive, (JNIEnv* env, jobject, jobject object))
<span class="line-new-header">--- 1824,11 ---</span>
    Handle str = JVMCIENV-&gt;asConstant(JVMCIENV-&gt;wrap(object), JVMCI_CHECK_0);
    if (!java_lang_String::is_instance(str())) {
      return false;
    }
    int len;
<span class="line-modified">!   jchar* name = java_lang_String::as_unicode_string(str(), len, CHECK_false);</span>
    return (StringTable::lookup(name, len) != NULL);
  C2V_END
  
  
  C2V_VMENTRY_NULL(jobject, unboxPrimitive, (JNIEnv* env, jobject, jobject object))
</pre>
<hr />
<pre>
<span class="line-old-header">*** 2626,10 ***</span>
<span class="line-new-header">--- 2627,49 ---</span>
                         vmSymbols::int_void_signature(),
                         &amp;jargs,
                         CHECK);
  }
  
<span class="line-added">+ C2V_VMENTRY_0(jlong, ticksNow, (JNIEnv* env, jobject))</span>
<span class="line-added">+   return CompilerEvent::ticksNow();</span>
<span class="line-added">+ }</span>
<span class="line-added">+ </span>
<span class="line-added">+ C2V_VMENTRY_0(jint, registerCompilerPhases, (JNIEnv* env, jobject, jobjectArray jphases))</span>
<span class="line-added">+ #if INCLUDE_JFR</span>
<span class="line-added">+   if (jphases == NULL) {</span>
<span class="line-added">+     return -1;</span>
<span class="line-added">+   }</span>
<span class="line-added">+   JVMCIObjectArray phases = JVMCIENV-&gt;wrap(jphases);</span>
<span class="line-added">+   int len = JVMCIENV-&gt;get_length(phases);</span>
<span class="line-added">+   GrowableArray&lt;const char*&gt;* jvmci_phase_names = new GrowableArray&lt;const char*&gt;(len);</span>
<span class="line-added">+   for (int i = 0; i &lt; len; i++) {</span>
<span class="line-added">+     JVMCIObject phase = JVMCIENV-&gt;get_object_at(phases, i);</span>
<span class="line-added">+     jvmci_phase_names-&gt;append(strdup(JVMCIENV-&gt;as_utf8_string(phase)));</span>
<span class="line-added">+   }</span>
<span class="line-added">+   return CompilerEvent::PhaseEvent::register_phases(jvmci_phase_names);</span>
<span class="line-added">+ #else</span>
<span class="line-added">+   return -1;</span>
<span class="line-added">+ #endif // !INCLUDE_JFR</span>
<span class="line-added">+ }</span>
<span class="line-added">+ </span>
<span class="line-added">+ C2V_VMENTRY(void, notifyCompilerPhaseEvent, (JNIEnv* env, jobject, jlong startTime, jint phase, jint compileId, jint level))</span>
<span class="line-added">+   EventCompilerPhase event;</span>
<span class="line-added">+   if (event.should_commit()) {</span>
<span class="line-added">+     CompilerEvent::PhaseEvent::post(event, startTime, phase, compileId, level);</span>
<span class="line-added">+   }</span>
<span class="line-added">+ }</span>
<span class="line-added">+ </span>
<span class="line-added">+ C2V_VMENTRY(void, notifyCompilerInliningEvent, (JNIEnv* env, jobject, jint compileId, jobject caller, jobject callee, jboolean succeeded, jstring jmessage, jint bci))</span>
<span class="line-added">+   EventCompilerInlining event;</span>
<span class="line-added">+   if (event.should_commit()) {</span>
<span class="line-added">+     Method* caller_method = JVMCIENV-&gt;asMethod(caller);</span>
<span class="line-added">+     Method* callee_method = JVMCIENV-&gt;asMethod(callee);</span>
<span class="line-added">+     JVMCIObject message = JVMCIENV-&gt;wrap(jmessage);</span>
<span class="line-added">+     CompilerEvent::InlineEvent::post(event, compileId, caller_method, callee_method, succeeded, JVMCIENV-&gt;as_utf8_string(message), bci);</span>
<span class="line-added">+   }</span>
<span class="line-added">+ }</span>
<span class="line-added">+ </span>
  #define CC (char*)  /*cast a literal from (const char*)*/
  #define FN_PTR(f) CAST_FROM_FN_PTR(void*, &amp;(c2v_ ## f))
  
  #define STRING                  &quot;Ljava/lang/String;&quot;
  #define OBJECT                  &quot;Ljava/lang/Object;&quot;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 2773,10 ***</span>
<span class="line-new-header">--- 2813,14 ---</span>
    {CC &quot;getFailedSpeculations&quot;,                        CC &quot;(J[[B)[[B&quot;,                                                                       FN_PTR(getFailedSpeculations)},
    {CC &quot;getFailedSpeculationsAddress&quot;,                 CC &quot;(&quot; HS_RESOLVED_METHOD &quot;)J&quot;,                                                       FN_PTR(getFailedSpeculationsAddress)},
    {CC &quot;releaseFailedSpeculations&quot;,                    CC &quot;(J)V&quot;,                                                                            FN_PTR(releaseFailedSpeculations)},
    {CC &quot;addFailedSpeculation&quot;,                         CC &quot;(J[B)Z&quot;,                                                                          FN_PTR(addFailedSpeculation)},
    {CC &quot;callSystemExit&quot;,                               CC &quot;(I)V&quot;,                                                                            FN_PTR(callSystemExit)},
<span class="line-added">+   {CC &quot;ticksNow&quot;,                                     CC &quot;()J&quot;,                                                                             FN_PTR(ticksNow)},</span>
<span class="line-added">+   {CC &quot;registerCompilerPhases&quot;,                       CC &quot;([&quot; STRING &quot;)I&quot;,                                                                  FN_PTR(registerCompilerPhases)},</span>
<span class="line-added">+   {CC &quot;notifyCompilerPhaseEvent&quot;,                     CC &quot;(JIII)V&quot;,                                                                         FN_PTR(notifyCompilerPhaseEvent)},</span>
<span class="line-added">+   {CC &quot;notifyCompilerInliningEvent&quot;,                  CC &quot;(I&quot; HS_RESOLVED_METHOD HS_RESOLVED_METHOD &quot;ZLjava/lang/String;I)V&quot;,               FN_PTR(notifyCompilerInliningEvent)},</span>
  };
  
  int CompilerToVM::methods_count() {
    return sizeof(methods) / sizeof(JNINativeMethod);
  }
</pre>
<center><a href="jvmciCodeInstaller.hpp.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="jvmciCompilerToVMInit.cpp.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>