<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/hotspot/share/jvmci/jvmciCodeInstaller.cpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
  </head>
<body>
<center><a href="jvmci.cpp.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="jvmciCodeInstaller.hpp.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/hotspot/share/jvmci/jvmciCodeInstaller.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 592 #if INCLUDE_AOT
 593   buffer.set_immutable_PIC(_immutable_pic_compilation);
 594 #endif
 595 
 596   initialize_fields(target, compiled_code, JVMCI_CHECK_OK);
 597   JVMCI::CodeInstallResult result = initialize_buffer(buffer, true, JVMCI_CHECK_OK);
 598   if (result != JVMCI::ok) {
 599     return result;
 600   }
 601 
 602   int stack_slots = _total_frame_size / HeapWordSize; // conversion to words
 603 
 604   if (!jvmci_env()-&gt;isa_HotSpotCompiledNmethod(compiled_code)) {
 605     JVMCIObject stubName = jvmci_env()-&gt;get_HotSpotCompiledCode_name(compiled_code);
 606     if (stubName.is_null()) {
 607       JVMCI_ERROR_OK(&quot;stub should have a name&quot;);
 608     }
 609     char* name = strdup(jvmci_env()-&gt;as_utf8_string(stubName));
 610     cb = RuntimeStub::new_runtime_stub(name,
 611                                        &amp;buffer,
<span class="line-modified"> 612                                        CodeOffsets::frame_never_safe,</span>
 613                                        stack_slots,
 614                                        _debug_recorder-&gt;_oopmaps,
 615                                        false);
 616     result = JVMCI::ok;
 617   } else {
 618     JVMCICompileState* compile_state = (JVMCICompileState*) (address) jvmci_env()-&gt;get_HotSpotCompiledNmethod_compileState(compiled_code);
 619     if (compile_state != NULL) {
 620       jvmci_env()-&gt;set_compile_state(compile_state);
 621     }
 622 
 623     Thread* thread = Thread::current();
 624 
 625     methodHandle method(thread, jvmci_env()-&gt;asMethod(jvmci_env()-&gt;get_HotSpotCompiledNmethod_method(compiled_code)));
 626     jint entry_bci = jvmci_env()-&gt;get_HotSpotCompiledNmethod_entryBCI(compiled_code);
 627     bool has_unsafe_access = jvmci_env()-&gt;get_HotSpotCompiledNmethod_hasUnsafeAccess(compiled_code) == JNI_TRUE;
 628     jint id = jvmci_env()-&gt;get_HotSpotCompiledNmethod_id(compiled_code);
 629     if (id == -1) {
 630       // Make sure a valid compile_id is associated with every compile
 631       id = CompileBroker::assign_compile_id_unlocked(thread, method, entry_bci);
 632       jvmci_env()-&gt;set_HotSpotCompiledNmethod_id(compiled_code, id);
</pre>
<hr />
<pre>
1306     address pc = _instructions-&gt;start() + pc_offset;
1307 
1308     switch (id) {
1309       case UNVERIFIED_ENTRY:
1310         _offsets.set_value(CodeOffsets::Entry, pc_offset);
1311         break;
1312       case VERIFIED_ENTRY:
1313         _offsets.set_value(CodeOffsets::Verified_Entry, pc_offset);
1314         _offsets.set_value(CodeOffsets::Verified_Value_Entry, pc_offset);
1315         _offsets.set_value(CodeOffsets::Verified_Value_Entry_RO, pc_offset);
1316         break;
1317       case OSR_ENTRY:
1318         _offsets.set_value(CodeOffsets::OSR_Entry, pc_offset);
1319         break;
1320       case EXCEPTION_HANDLER_ENTRY:
1321         _offsets.set_value(CodeOffsets::Exceptions, pc_offset);
1322         break;
1323       case DEOPT_HANDLER_ENTRY:
1324         _offsets.set_value(CodeOffsets::Deopt, pc_offset);
1325         break;



1326       case INVOKEVIRTUAL:
1327       case INVOKEINTERFACE:
1328       case INLINE_INVOKE:
1329       case INVOKESTATIC:
1330       case INVOKESPECIAL:
1331         _next_call_type = (MarkId) id;
1332         _invoke_mark_pc = pc;
1333         break;
1334       case POLL_NEAR:
1335       case POLL_FAR:
1336       case POLL_RETURN_NEAR:
1337       case POLL_RETURN_FAR:
1338         pd_relocate_poll(pc, id, JVMCI_CHECK);
1339         break;
1340       case CARD_TABLE_SHIFT:
1341       case CARD_TABLE_ADDRESS:
1342       case HEAP_TOP_ADDRESS:
1343       case HEAP_END_ADDRESS:
1344       case NARROW_KLASS_BASE_ADDRESS:
1345       case NARROW_OOP_BASE_ADDRESS:
</pre>
</td>
<td>
<hr />
<pre>
 592 #if INCLUDE_AOT
 593   buffer.set_immutable_PIC(_immutable_pic_compilation);
 594 #endif
 595 
 596   initialize_fields(target, compiled_code, JVMCI_CHECK_OK);
 597   JVMCI::CodeInstallResult result = initialize_buffer(buffer, true, JVMCI_CHECK_OK);
 598   if (result != JVMCI::ok) {
 599     return result;
 600   }
 601 
 602   int stack_slots = _total_frame_size / HeapWordSize; // conversion to words
 603 
 604   if (!jvmci_env()-&gt;isa_HotSpotCompiledNmethod(compiled_code)) {
 605     JVMCIObject stubName = jvmci_env()-&gt;get_HotSpotCompiledCode_name(compiled_code);
 606     if (stubName.is_null()) {
 607       JVMCI_ERROR_OK(&quot;stub should have a name&quot;);
 608     }
 609     char* name = strdup(jvmci_env()-&gt;as_utf8_string(stubName));
 610     cb = RuntimeStub::new_runtime_stub(name,
 611                                        &amp;buffer,
<span class="line-modified"> 612                                        _offsets.value(CodeOffsets::Frame_Complete),</span>
 613                                        stack_slots,
 614                                        _debug_recorder-&gt;_oopmaps,
 615                                        false);
 616     result = JVMCI::ok;
 617   } else {
 618     JVMCICompileState* compile_state = (JVMCICompileState*) (address) jvmci_env()-&gt;get_HotSpotCompiledNmethod_compileState(compiled_code);
 619     if (compile_state != NULL) {
 620       jvmci_env()-&gt;set_compile_state(compile_state);
 621     }
 622 
 623     Thread* thread = Thread::current();
 624 
 625     methodHandle method(thread, jvmci_env()-&gt;asMethod(jvmci_env()-&gt;get_HotSpotCompiledNmethod_method(compiled_code)));
 626     jint entry_bci = jvmci_env()-&gt;get_HotSpotCompiledNmethod_entryBCI(compiled_code);
 627     bool has_unsafe_access = jvmci_env()-&gt;get_HotSpotCompiledNmethod_hasUnsafeAccess(compiled_code) == JNI_TRUE;
 628     jint id = jvmci_env()-&gt;get_HotSpotCompiledNmethod_id(compiled_code);
 629     if (id == -1) {
 630       // Make sure a valid compile_id is associated with every compile
 631       id = CompileBroker::assign_compile_id_unlocked(thread, method, entry_bci);
 632       jvmci_env()-&gt;set_HotSpotCompiledNmethod_id(compiled_code, id);
</pre>
<hr />
<pre>
1306     address pc = _instructions-&gt;start() + pc_offset;
1307 
1308     switch (id) {
1309       case UNVERIFIED_ENTRY:
1310         _offsets.set_value(CodeOffsets::Entry, pc_offset);
1311         break;
1312       case VERIFIED_ENTRY:
1313         _offsets.set_value(CodeOffsets::Verified_Entry, pc_offset);
1314         _offsets.set_value(CodeOffsets::Verified_Value_Entry, pc_offset);
1315         _offsets.set_value(CodeOffsets::Verified_Value_Entry_RO, pc_offset);
1316         break;
1317       case OSR_ENTRY:
1318         _offsets.set_value(CodeOffsets::OSR_Entry, pc_offset);
1319         break;
1320       case EXCEPTION_HANDLER_ENTRY:
1321         _offsets.set_value(CodeOffsets::Exceptions, pc_offset);
1322         break;
1323       case DEOPT_HANDLER_ENTRY:
1324         _offsets.set_value(CodeOffsets::Deopt, pc_offset);
1325         break;
<span class="line-added">1326       case FRAME_COMPLETE:</span>
<span class="line-added">1327         _offsets.set_value(CodeOffsets::Frame_Complete, pc_offset);</span>
<span class="line-added">1328         break;</span>
1329       case INVOKEVIRTUAL:
1330       case INVOKEINTERFACE:
1331       case INLINE_INVOKE:
1332       case INVOKESTATIC:
1333       case INVOKESPECIAL:
1334         _next_call_type = (MarkId) id;
1335         _invoke_mark_pc = pc;
1336         break;
1337       case POLL_NEAR:
1338       case POLL_FAR:
1339       case POLL_RETURN_NEAR:
1340       case POLL_RETURN_FAR:
1341         pd_relocate_poll(pc, id, JVMCI_CHECK);
1342         break;
1343       case CARD_TABLE_SHIFT:
1344       case CARD_TABLE_ADDRESS:
1345       case HEAP_TOP_ADDRESS:
1346       case HEAP_END_ADDRESS:
1347       case NARROW_KLASS_BASE_ADDRESS:
1348       case NARROW_OOP_BASE_ADDRESS:
</pre>
</td>
</tr>
</table>
<center><a href="jvmci.cpp.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="jvmciCodeInstaller.hpp.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>