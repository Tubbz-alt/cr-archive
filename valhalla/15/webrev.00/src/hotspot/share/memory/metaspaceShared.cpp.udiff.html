<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff src/hotspot/share/memory/metaspaceShared.cpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
  </head>
<body>
<center><a href="memRegion.hpp.udiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="metaspaceShared.hpp.udiff.html" target="_top">next &gt;</a></center>    <h2>src/hotspot/share/memory/metaspaceShared.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -463,10 +463,13 @@</span>
    StringTable::serialize_shared_table_header(soc);
    HeapShared::serialize_subgraph_info_table_header(soc);
    SystemDictionaryShared::serialize_dictionary_headers(soc);
  
    InstanceMirrorKlass::serialize_offsets(soc);
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+   // Dump/restore well known classes (pointers)</span>
<span class="udiff-line-added">+   SystemDictionaryShared::serialize_well_known_klasses(soc);</span>
    soc-&gt;do_tag(--tag);
  
    serialize_cloned_cpp_vtptrs(soc);
    soc-&gt;do_tag(--tag);
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1104,11 +1107,11 @@</span>
    void dump_archive_heap_oopmaps(GrowableArray&lt;MemRegion&gt;* regions,
                                   GrowableArray&lt;ArchiveHeapOopmapInfo&gt;* oopmaps);
    void dump_symbols();
    char* dump_read_only_tables();
    void print_class_stats();
<span class="udiff-line-modified-removed">-   void print_region_stats();</span>
<span class="udiff-line-modified-added">+   void print_region_stats(FileMapInfo* map_info);</span>
    void print_bitmap_region_stats(size_t size, size_t total_size);
    void print_heap_region_stats(GrowableArray&lt;MemRegion&gt; *heap_mem,
                                 const char *name, size_t total_size);
    void relocate_to_default_base_address(CHeapBitMap* ptrmap);
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1390,11 +1393,11 @@</span>
        for (int i = 0; i &lt; _global_klass_objects-&gt;length(); i++) {
          // NOTE -- this requires that the vtable is NOT yet patched, or else we are hosed.
          it-&gt;push(_global_klass_objects-&gt;adr_at(i));
        }
      }
<span class="udiff-line-modified-removed">-     FileMapInfo::metaspace_pointers_do(it);</span>
<span class="udiff-line-modified-added">+     FileMapInfo::metaspace_pointers_do(it, false);</span>
      SystemDictionaryShared::dumptime_classes_do(it);
      Universe::metaspace_pointers_do(it);
      SymbolTable::metaspace_pointers_do(it);
      vmSymbols::metaspace_pointers_do(it);
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1438,10 +1441,12 @@</span>
    char* start = _ro_region.top();
    WriteClosure wc(&amp;_ro_region);
    MetaspaceShared::serialize(&amp;wc);
  
    // Write the bitmaps for patching the archive heap regions
<span class="udiff-line-added">+   _closed_archive_heap_oopmaps = NULL;</span>
<span class="udiff-line-added">+   _open_archive_heap_oopmaps = NULL;</span>
    dump_archive_heap_oopmaps();
  
    return start;
  }
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1587,11 +1592,11 @@</span>
    mapinfo-&gt;set_serialized_data(serialized_data);
    mapinfo-&gt;set_cloned_vtables(cloned_vtables);
    mapinfo-&gt;set_i2i_entry_code_buffers(MetaspaceShared::i2i_entry_code_buffers(),
                                        MetaspaceShared::i2i_entry_code_buffers_size());
    mapinfo-&gt;open_for_write();
<span class="udiff-line-modified-removed">-   MetaspaceShared::write_core_archive_regions(mapinfo);</span>
<span class="udiff-line-modified-added">+   MetaspaceShared::write_core_archive_regions(mapinfo, _closed_archive_heap_oopmaps, _open_archive_heap_oopmaps);</span>
    _total_closed_archive_region_size = mapinfo-&gt;write_archive_heap_regions(
                                          _closed_archive_heap_regions,
                                          _closed_archive_heap_oopmaps,
                                          MetaspaceShared::first_closed_archive_heap_region,
                                          MetaspaceShared::max_closed_archive_heap_region);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1602,14 +1607,13 @@</span>
                                          MetaspaceShared::max_open_archive_heap_region);
  
    mapinfo-&gt;set_final_requested_base((char*)Arguments::default_SharedBaseAddress());
    mapinfo-&gt;set_header_crc(mapinfo-&gt;compute_header_crc());
    mapinfo-&gt;write_header();
<span class="udiff-line-added">+   print_region_stats(mapinfo);</span>
    mapinfo-&gt;close();
  
<span class="udiff-line-removed">-   print_region_stats();</span>
<span class="udiff-line-removed">- </span>
    if (log_is_enabled(Info, cds)) {
      ArchiveCompactor::alloc_stats()-&gt;print_stats(int(_ro_region.used()), int(_rw_region.used()),
                                                   int(_mc_region.used()));
    }
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1626,14 +1630,14 @@</span>
    // which will fail because InstanceKlasses::remove_unshareable_info()
    // has been called. Forget these operations and exit the VM directly.
    vm_direct_exit(0);
  }
  
<span class="udiff-line-modified-removed">- void VM_PopulateDumpSharedSpace::print_region_stats() {</span>
<span class="udiff-line-modified-added">+ void VM_PopulateDumpSharedSpace::print_region_stats(FileMapInfo *map_info) {</span>
    // Print statistics of all the regions
<span class="udiff-line-modified-removed">-   const size_t bitmap_used = ArchivePtrMarker::ptrmap()-&gt;size_in_bytes();</span>
<span class="udiff-line-modified-removed">-   const size_t bitmap_reserved = align_up(bitmap_used, Metaspace::reserve_alignment());</span>
<span class="udiff-line-modified-added">+   const size_t bitmap_used = map_info-&gt;space_at(MetaspaceShared::bm)-&gt;used();</span>
<span class="udiff-line-modified-added">+   const size_t bitmap_reserved = map_info-&gt;space_at(MetaspaceShared::bm)-&gt;used_aligned();</span>
    const size_t total_reserved = _ro_region.reserved()  + _rw_region.reserved() +
                                  _mc_region.reserved()  +
                                  bitmap_reserved +
                                  _total_closed_archive_region_size +
                                  _total_open_archive_region_size;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1671,21 +1675,23 @@</span>
                       name, i, size, size/double(total_size)*100.0, size, p2i(start));
  
    }
  }
  
<span class="udiff-line-modified-removed">- void MetaspaceShared::write_core_archive_regions(FileMapInfo* mapinfo) {</span>
<span class="udiff-line-modified-added">+ void MetaspaceShared::write_core_archive_regions(FileMapInfo* mapinfo,</span>
<span class="udiff-line-added">+                                                  GrowableArray&lt;ArchiveHeapOopmapInfo&gt;* closed_oopmaps,</span>
<span class="udiff-line-added">+                                                  GrowableArray&lt;ArchiveHeapOopmapInfo&gt;* open_oopmaps) {</span>
    // Make sure NUM_CDS_REGIONS (exported in cds.h) agrees with
    // MetaspaceShared::n_regions (internal to hotspot).
    assert(NUM_CDS_REGIONS == MetaspaceShared::n_regions, &quot;sanity&quot;);
  
    // mc contains the trampoline code for method entries, which are patched at run time,
    // so it needs to be read/write.
    write_region(mapinfo, mc, &amp;_mc_region, /*read_only=*/false,/*allow_exec=*/true);
    write_region(mapinfo, rw, &amp;_rw_region, /*read_only=*/false,/*allow_exec=*/false);
    write_region(mapinfo, ro, &amp;_ro_region, /*read_only=*/true, /*allow_exec=*/false);
<span class="udiff-line-modified-removed">-   mapinfo-&gt;write_bitmap_region(ArchivePtrMarker::ptrmap());</span>
<span class="udiff-line-modified-added">+   mapinfo-&gt;write_bitmap_region(ArchivePtrMarker::ptrmap(), closed_oopmaps, open_oopmaps);</span>
  }
  
  void MetaspaceShared::write_region(FileMapInfo* mapinfo, int region_idx, DumpRegion* dump_region, bool read_only,  bool allow_exec) {
    mapinfo-&gt;write_region(region_idx, dump_region-&gt;base(), dump_region-&gt;used(), read_only, allow_exec);
  }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1717,31 +1723,26 @@</span>
    bool made_progress() const { return _made_progress; }
  
    void do_klass(Klass* k) {
      if (k-&gt;is_instance_klass()) {
        InstanceKlass* ik = InstanceKlass::cast(k);
<span class="udiff-line-modified-removed">-       // Link the class to cause the bytecodes to be rewritten and the</span>
<span class="udiff-line-modified-removed">-       // cpcache to be created. Class verification is done according</span>
<span class="udiff-line-modified-removed">-       // to -Xverify setting.</span>
<span class="udiff-line-modified-removed">-       _made_progress |= MetaspaceShared::try_link_class(ik, THREAD);</span>
<span class="udiff-line-modified-removed">-       guarantee(!HAS_PENDING_EXCEPTION, &quot;exception in link_class&quot;);</span>
<span class="udiff-line-modified-removed">- </span>
<span class="udiff-line-modified-removed">-       ik-&gt;constants()-&gt;resolve_class_constants(THREAD);</span>
<span class="udiff-line-modified-removed">-     }</span>
<span class="udiff-line-removed">-   }</span>
<span class="udiff-line-removed">- };</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">- class CheckSharedClassesClosure : public KlassClosure {</span>
<span class="udiff-line-removed">-   bool    _made_progress;</span>
<span class="udiff-line-removed">-  public:</span>
<span class="udiff-line-removed">-   CheckSharedClassesClosure() : _made_progress(false) {}</span>
<span class="udiff-line-modified-added">+       // For dynamic CDS dump, only link classes loaded by the builtin class loaders.</span>
<span class="udiff-line-modified-added">+       bool do_linking = DumpSharedSpaces ? true : !ik-&gt;is_shared_unregistered_class();</span>
<span class="udiff-line-modified-added">+       if (do_linking) {</span>
<span class="udiff-line-modified-added">+         // Link the class to cause the bytecodes to be rewritten and the</span>
<span class="udiff-line-modified-added">+         // cpcache to be created. Class verification is done according</span>
<span class="udiff-line-modified-added">+         // to -Xverify setting.</span>
<span class="udiff-line-modified-added">+         _made_progress |= MetaspaceShared::try_link_class(ik, THREAD);</span>
<span class="udiff-line-modified-added">+         guarantee(!HAS_PENDING_EXCEPTION, &quot;exception in link_class&quot;);</span>
  
<span class="udiff-line-modified-removed">-   void reset()               { _made_progress = false; }</span>
<span class="udiff-line-modified-removed">-   bool made_progress() const { return _made_progress; }</span>
<span class="udiff-line-modified-removed">-   void do_klass(Klass* k) {</span>
<span class="udiff-line-modified-removed">-     if (k-&gt;is_instance_klass() &amp;&amp; InstanceKlass::cast(k)-&gt;check_sharing_error_state()) {</span>
<span class="udiff-line-modified-removed">-       _made_progress = true;</span>
<span class="udiff-line-modified-added">+         if (DumpSharedSpaces) {</span>
<span class="udiff-line-modified-added">+           // The following function is used to resolve all Strings in the statically</span>
<span class="udiff-line-modified-added">+           // dumped classes to archive all the Strings. The archive heap is not supported</span>
<span class="udiff-line-modified-added">+           // for the dynamic archive.</span>
<span class="udiff-line-modified-added">+           ik-&gt;constants()-&gt;resolve_class_constants(THREAD);</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+       }</span>
      }
    }
  };
  
  void MetaspaceShared::link_and_cleanup_shared_classes(TRAPS) {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1751,22 +1752,10 @@</span>
    do {
      link_closure.reset();
      ClassLoaderDataGraph::unlocked_loaded_classes_do(&amp;link_closure);
      guarantee(!HAS_PENDING_EXCEPTION, &quot;exception in link_class&quot;);
    } while (link_closure.made_progress());
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-   if (_has_error_classes) {</span>
<span class="udiff-line-removed">-     // Mark all classes whose super class or interfaces failed verification.</span>
<span class="udiff-line-removed">-     CheckSharedClassesClosure check_closure;</span>
<span class="udiff-line-removed">-     do {</span>
<span class="udiff-line-removed">-       // Not completely sure if we need to do this iteratively. Anyway,</span>
<span class="udiff-line-removed">-       // we should come here only if there are unverifiable classes, which</span>
<span class="udiff-line-removed">-       // shouldn&#39;t happen in normal cases. So better safe than sorry.</span>
<span class="udiff-line-removed">-       check_closure.reset();</span>
<span class="udiff-line-removed">-       ClassLoaderDataGraph::unlocked_loaded_classes_do(&amp;check_closure);</span>
<span class="udiff-line-removed">-     } while (check_closure.made_progress());</span>
<span class="udiff-line-removed">-   }</span>
  }
  
  void MetaspaceShared::prepare_for_dumping() {
    Arguments::check_unsupported_dumping_properties();
    ClassLoader::initialize_shared_path();
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1889,14 +1878,15 @@</span>
    return class_count;
  }
  
  // Returns true if the class&#39;s status has changed
  bool MetaspaceShared::try_link_class(InstanceKlass* ik, TRAPS) {
<span class="udiff-line-modified-removed">-   assert(DumpSharedSpaces, &quot;should only be called during dumping&quot;);</span>
<span class="udiff-line-modified-removed">-   if (ik-&gt;init_state() &lt; InstanceKlass::linked) {</span>
<span class="udiff-line-modified-added">+   Arguments::assert_is_dumping_archive();</span>
<span class="udiff-line-modified-added">+   if (ik-&gt;init_state() &lt; InstanceKlass::linked &amp;&amp;</span>
<span class="udiff-line-added">+       !SystemDictionaryShared::has_class_failed_verification(ik)) {</span>
      bool saved = BytecodeVerificationLocal;
<span class="udiff-line-modified-removed">-     if (ik-&gt;loader_type() == 0 &amp;&amp; ik-&gt;class_loader() == NULL) {</span>
<span class="udiff-line-modified-added">+     if (ik-&gt;is_shared_unregistered_class() &amp;&amp; ik-&gt;class_loader() == NULL) {</span>
        // The verification decision is based on BytecodeVerificationRemote
        // for non-system classes. Since we are using the NULL classloader
        // to load non-system classes for customized class loaders during dumping,
        // we need to temporarily change BytecodeVerificationLocal to be the same as
        // BytecodeVerificationRemote. Note this can cause the parent system
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1908,11 +1898,11 @@</span>
      if (HAS_PENDING_EXCEPTION) {
        ResourceMark rm(THREAD);
        log_warning(cds)(&quot;Preload Warning: Verification failed for %s&quot;,
                      ik-&gt;external_name());
        CLEAR_PENDING_EXCEPTION;
<span class="udiff-line-modified-removed">-       ik-&gt;set_in_error_state();</span>
<span class="udiff-line-modified-added">+       SystemDictionaryShared::set_class_has_failed_verification(ik);</span>
        _has_error_classes = true;
      }
      BytecodeVerificationLocal = saved;
      return true;
    } else {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1946,20 +1936,21 @@</span>
                                                             GrowableArray&lt;ArchiveHeapOopmapInfo&gt;* oopmaps) {
    for (int i=0; i&lt;regions-&gt;length(); i++) {
      ResourceBitMap oopmap = HeapShared::calculate_oopmap(regions-&gt;at(i));
      size_t size_in_bits = oopmap.size();
      size_t size_in_bytes = oopmap.size_in_bytes();
<span class="udiff-line-modified-removed">-     uintptr_t* buffer = (uintptr_t*)_ro_region.allocate(size_in_bytes, sizeof(intptr_t));</span>
<span class="udiff-line-modified-added">+     uintptr_t* buffer = (uintptr_t*)NEW_C_HEAP_ARRAY(char, size_in_bytes, mtInternal);</span>
      oopmap.write_to(buffer, size_in_bytes);
      log_info(cds, heap)(&quot;Oopmap = &quot; INTPTR_FORMAT &quot; (&quot; SIZE_FORMAT_W(6) &quot; bytes) for heap region &quot;
                          INTPTR_FORMAT &quot; (&quot; SIZE_FORMAT_W(8) &quot; bytes)&quot;,
                          p2i(buffer), size_in_bytes,
                          p2i(regions-&gt;at(i).start()), regions-&gt;at(i).byte_size());
  
      ArchiveHeapOopmapInfo info;
      info._oopmap = (address)buffer;
      info._oopmap_size_in_bits = size_in_bits;
<span class="udiff-line-added">+     info._oopmap_size_in_bytes = size_in_bytes;</span>
      oopmaps-&gt;append(info);
    }
  }
  #endif // INCLUDE_CDS_JAVA_HEAP
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -2379,10 +2370,12 @@</span>
    static_mapinfo-&gt;patch_archived_heap_embedded_pointers();
  
    // Close the mapinfo file
    static_mapinfo-&gt;close();
  
<span class="udiff-line-added">+   static_mapinfo-&gt;unmap_region(MetaspaceShared::bm);</span>
<span class="udiff-line-added">+ </span>
    FileMapInfo *dynamic_mapinfo = FileMapInfo::dynamic_info();
    if (dynamic_mapinfo != NULL) {
      intptr_t* buffer = (intptr_t*)dynamic_mapinfo-&gt;serialized_data();
      ReadClosure rc(&amp;buffer);
      SymbolTable::serialize_shared_table_header(&amp;rc, false);
</pre>
<center><a href="memRegion.hpp.udiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="metaspaceShared.hpp.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>