<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/hotspot/share/gc/shenandoah/shenandoahVerifier.cpp</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
<body>
<center><a href="shenandoahVMOperations.hpp.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="shenandoah_globals.hpp.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/hotspot/share/gc/shenandoah/shenandoahVerifier.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 379     verify(r, r-&gt;used() &lt;= r-&gt;capacity(),
 380            &quot;Used cannot be larger than capacity&quot;);
 381 
 382     verify(r, r-&gt;get_shared_allocs() &lt;= r-&gt;capacity(),
 383            &quot;Shared alloc count should not be larger than capacity&quot;);
 384 
 385     verify(r, r-&gt;get_tlab_allocs() &lt;= r-&gt;capacity(),
 386            &quot;TLAB alloc count should not be larger than capacity&quot;);
 387 
 388     verify(r, r-&gt;get_gclab_allocs() &lt;= r-&gt;capacity(),
 389            &quot;GCLAB alloc count should not be larger than capacity&quot;);
 390 
 391     verify(r, r-&gt;get_shared_allocs() + r-&gt;get_tlab_allocs() + r-&gt;get_gclab_allocs() == r-&gt;used(),
 392            &quot;Accurate accounting: shared + TLAB + GCLAB = used&quot;);
 393 
 394     verify(r, !r-&gt;is_empty() || !r-&gt;has_live(),
 395            &quot;Empty regions should not have live data&quot;);
 396 
 397     verify(r, r-&gt;is_cset() == _heap-&gt;collection_set()-&gt;is_in(r),
 398            &quot;Transitional: region flags and collection set agree&quot;);
<span class="line-removed"> 399 </span>
<span class="line-removed"> 400     verify(r, r-&gt;is_empty() || r-&gt;seqnum_first_alloc() != 0,</span>
<span class="line-removed"> 401            &quot;Non-empty regions should have first seqnum set&quot;);</span>
<span class="line-removed"> 402 </span>
<span class="line-removed"> 403     verify(r, r-&gt;is_empty() || (r-&gt;seqnum_first_alloc_mutator() != 0 || r-&gt;seqnum_first_alloc_gc() != 0),</span>
<span class="line-removed"> 404            &quot;Non-empty regions should have first seqnum set to either GC or mutator&quot;);</span>
<span class="line-removed"> 405 </span>
<span class="line-removed"> 406     verify(r, r-&gt;is_empty() || r-&gt;seqnum_last_alloc() != 0,</span>
<span class="line-removed"> 407            &quot;Non-empty regions should have last seqnum set&quot;);</span>
<span class="line-removed"> 408 </span>
<span class="line-removed"> 409     verify(r, r-&gt;is_empty() || (r-&gt;seqnum_last_alloc_mutator() != 0 || r-&gt;seqnum_last_alloc_gc() != 0),</span>
<span class="line-removed"> 410            &quot;Non-empty regions should have last seqnum set to either GC or mutator&quot;);</span>
<span class="line-removed"> 411 </span>
<span class="line-removed"> 412     verify(r, r-&gt;seqnum_first_alloc() &lt;= r-&gt;seqnum_last_alloc(),</span>
<span class="line-removed"> 413            &quot;First seqnum should not be greater than last timestamp&quot;);</span>
<span class="line-removed"> 414 </span>
<span class="line-removed"> 415     verify(r, r-&gt;seqnum_first_alloc_mutator() &lt;= r-&gt;seqnum_last_alloc_mutator(),</span>
<span class="line-removed"> 416            &quot;First mutator seqnum should not be greater than last seqnum&quot;);</span>
<span class="line-removed"> 417 </span>
<span class="line-removed"> 418     verify(r, r-&gt;seqnum_first_alloc_gc() &lt;= r-&gt;seqnum_last_alloc_gc(),</span>
<span class="line-removed"> 419            &quot;First GC seqnum should not be greater than last seqnum&quot;);</span>
 420   }
 421 };
 422 
 423 class ShenandoahVerifierReachableTask : public AbstractGangTask {
 424 private:
 425   const char* _label;
 426   ShenandoahRootVerifier* _verifier;
 427   ShenandoahVerifier::VerifyOptions _options;
 428   ShenandoahHeap* _heap;
 429   ShenandoahLivenessData* _ld;
 430   MarkBitMap* _bitmap;
 431   volatile size_t _processed;
 432 
 433 public:
 434   ShenandoahVerifierReachableTask(MarkBitMap* bitmap,
 435                                   ShenandoahLivenessData* ld,
 436                                   ShenandoahRootVerifier* verifier,
 437                                   const char* label,
 438                                   ShenandoahVerifier::VerifyOptions options) :
 439     AbstractGangTask(&quot;Shenandoah Parallel Verifier Reachable Task&quot;),
</pre>
<hr />
<pre>
 794   log_info(gc)(&quot;Verify %s, Level &quot; INTX_FORMAT &quot; (&quot; SIZE_FORMAT &quot; reachable, &quot; SIZE_FORMAT &quot; marked)&quot;,
 795                label, ShenandoahVerifyLevel, count_reachable, count_marked);
 796 
 797   FREE_C_HEAP_ARRAY(ShenandoahLivenessData, ld);
 798 }
 799 
 800 void ShenandoahVerifier::verify_generic(VerifyOption vo) {
 801   verify_at_safepoint(
 802           &quot;Generic Verification&quot;,
 803           _verify_forwarded_allow,     // conservatively allow forwarded
 804           _verify_marked_disable,      // do not verify marked: lots ot time wasted checking dead allocations
 805           _verify_cset_disable,        // cset may be inconsistent
 806           _verify_liveness_disable,    // no reliable liveness data
 807           _verify_regions_disable,     // no reliable region data
 808           _verify_gcstate_disable,     // no data about gcstate
 809           _verify_all_weak_roots
 810   );
 811 }
 812 
 813 void ShenandoahVerifier::verify_before_concmark() {
<span class="line-removed"> 814   if (_heap-&gt;has_forwarded_objects()) {</span>
 815     verify_at_safepoint(
<span class="line-modified"> 816             &quot;Before Mark&quot;,</span>
<span class="line-modified"> 817             _verify_forwarded_allow,     // may have forwarded references</span>
<span class="line-modified"> 818             _verify_marked_disable,      // do not verify marked: lots ot time wasted checking dead allocations</span>
<span class="line-modified"> 819             _verify_cset_forwarded,      // allow forwarded references to cset</span>
<span class="line-modified"> 820             _verify_liveness_disable,    // no reliable liveness data</span>
<span class="line-modified"> 821             _verify_regions_notrash,     // no trash regions</span>
<span class="line-modified"> 822             _verify_gcstate_forwarded,   // there are forwarded objects</span>
<span class="line-modified"> 823             _verify_all_weak_roots</span>
<span class="line-modified"> 824     );</span>
<span class="line-removed"> 825   } else {</span>
<span class="line-removed"> 826     verify_at_safepoint(</span>
<span class="line-removed"> 827             &quot;Before Mark&quot;,</span>
<span class="line-removed"> 828             _verify_forwarded_none,      // UR should have fixed up</span>
<span class="line-removed"> 829             _verify_marked_disable,      // do not verify marked: lots ot time wasted checking dead allocations</span>
<span class="line-removed"> 830             _verify_cset_none,           // UR should have fixed this</span>
<span class="line-removed"> 831             _verify_liveness_disable,    // no reliable liveness data</span>
<span class="line-removed"> 832             _verify_regions_notrash,     // no trash regions</span>
<span class="line-removed"> 833             _verify_gcstate_stable,      // there are no forwarded objects</span>
<span class="line-removed"> 834             _verify_all_weak_roots</span>
<span class="line-removed"> 835     );</span>
<span class="line-removed"> 836   }</span>
 837 }
 838 
 839 void ShenandoahVerifier::verify_after_concmark() {
 840   verify_at_safepoint(
 841           &quot;After Mark&quot;,
 842           _verify_forwarded_none,      // no forwarded references
 843           _verify_marked_complete,     // bitmaps as precise as we can get
 844           _verify_cset_none,           // no references to cset anymore
 845           _verify_liveness_complete,   // liveness data must be complete here
 846           _verify_regions_disable,     // trash regions not yet recycled
 847           _verify_gcstate_stable,       // mark should have stabilized the heap
 848           _verify_all_weak_roots
 849   );
 850 }
 851 
 852 void ShenandoahVerifier::verify_before_evacuation() {
 853   // Concurrent weak roots are evacuated during concurrent phase
 854   VerifyWeakRoots verify_weak_roots = ShenandoahConcurrentRoots::should_do_concurrent_class_unloading() ?
 855                                       _verify_serial_weak_roots :
 856                                       _verify_all_weak_roots;
</pre>
<hr />
<pre>
 999       oop fwd = (oop) ShenandoahForwarding::get_forwardee_raw_unchecked(obj);
1000       if (obj != fwd) {
1001         ShenandoahAsserts::print_failure(ShenandoahAsserts::_safe_all, obj, p, NULL,
1002                                          &quot;Verify Roots&quot;, &quot;Should not be forwarded&quot;, __FILE__, __LINE__);
1003       }
1004     }
1005   }
1006 
1007 public:
1008   void do_oop(narrowOop* p) { do_oop_work(p); }
1009   void do_oop(oop* p)       { do_oop_work(p); }
1010 };
1011 
1012 class ShenandoahVerifyInToSpaceClosure : public OopClosure {
1013 private:
1014   template &lt;class T&gt;
1015   void do_oop_work(T* p) {
1016     T o = RawAccess&lt;&gt;::oop_load(p);
1017     if (!CompressedOops::is_null(o)) {
1018       oop obj = CompressedOops::decode_not_null(o);
<span class="line-modified">1019       ShenandoahHeap* heap = ShenandoahHeap::heap_no_check();</span>
1020 
1021       if (!heap-&gt;marking_context()-&gt;is_marked(obj)) {
1022         ShenandoahAsserts::print_failure(ShenandoahAsserts::_safe_all, obj, p, NULL,
1023                 &quot;Verify Roots In To-Space&quot;, &quot;Should be marked&quot;, __FILE__, __LINE__);
1024       }
1025 
1026       if (heap-&gt;in_collection_set(obj)) {
1027         ShenandoahAsserts::print_failure(ShenandoahAsserts::_safe_all, obj, p, NULL,
1028                 &quot;Verify Roots In To-Space&quot;, &quot;Should not be in collection set&quot;, __FILE__, __LINE__);
1029       }
1030 
1031       oop fwd = (oop) ShenandoahForwarding::get_forwardee_raw_unchecked(obj);
1032       if (obj != fwd) {
1033         ShenandoahAsserts::print_failure(ShenandoahAsserts::_safe_all, obj, p, NULL,
1034                 &quot;Verify Roots In To-Space&quot;, &quot;Should not be forwarded&quot;, __FILE__, __LINE__);
1035       }
1036     }
1037   }
1038 
1039 public:
</pre>
</td>
<td>
<hr />
<pre>
 379     verify(r, r-&gt;used() &lt;= r-&gt;capacity(),
 380            &quot;Used cannot be larger than capacity&quot;);
 381 
 382     verify(r, r-&gt;get_shared_allocs() &lt;= r-&gt;capacity(),
 383            &quot;Shared alloc count should not be larger than capacity&quot;);
 384 
 385     verify(r, r-&gt;get_tlab_allocs() &lt;= r-&gt;capacity(),
 386            &quot;TLAB alloc count should not be larger than capacity&quot;);
 387 
 388     verify(r, r-&gt;get_gclab_allocs() &lt;= r-&gt;capacity(),
 389            &quot;GCLAB alloc count should not be larger than capacity&quot;);
 390 
 391     verify(r, r-&gt;get_shared_allocs() + r-&gt;get_tlab_allocs() + r-&gt;get_gclab_allocs() == r-&gt;used(),
 392            &quot;Accurate accounting: shared + TLAB + GCLAB = used&quot;);
 393 
 394     verify(r, !r-&gt;is_empty() || !r-&gt;has_live(),
 395            &quot;Empty regions should not have live data&quot;);
 396 
 397     verify(r, r-&gt;is_cset() == _heap-&gt;collection_set()-&gt;is_in(r),
 398            &quot;Transitional: region flags and collection set agree&quot;);





















 399   }
 400 };
 401 
 402 class ShenandoahVerifierReachableTask : public AbstractGangTask {
 403 private:
 404   const char* _label;
 405   ShenandoahRootVerifier* _verifier;
 406   ShenandoahVerifier::VerifyOptions _options;
 407   ShenandoahHeap* _heap;
 408   ShenandoahLivenessData* _ld;
 409   MarkBitMap* _bitmap;
 410   volatile size_t _processed;
 411 
 412 public:
 413   ShenandoahVerifierReachableTask(MarkBitMap* bitmap,
 414                                   ShenandoahLivenessData* ld,
 415                                   ShenandoahRootVerifier* verifier,
 416                                   const char* label,
 417                                   ShenandoahVerifier::VerifyOptions options) :
 418     AbstractGangTask(&quot;Shenandoah Parallel Verifier Reachable Task&quot;),
</pre>
<hr />
<pre>
 773   log_info(gc)(&quot;Verify %s, Level &quot; INTX_FORMAT &quot; (&quot; SIZE_FORMAT &quot; reachable, &quot; SIZE_FORMAT &quot; marked)&quot;,
 774                label, ShenandoahVerifyLevel, count_reachable, count_marked);
 775 
 776   FREE_C_HEAP_ARRAY(ShenandoahLivenessData, ld);
 777 }
 778 
 779 void ShenandoahVerifier::verify_generic(VerifyOption vo) {
 780   verify_at_safepoint(
 781           &quot;Generic Verification&quot;,
 782           _verify_forwarded_allow,     // conservatively allow forwarded
 783           _verify_marked_disable,      // do not verify marked: lots ot time wasted checking dead allocations
 784           _verify_cset_disable,        // cset may be inconsistent
 785           _verify_liveness_disable,    // no reliable liveness data
 786           _verify_regions_disable,     // no reliable region data
 787           _verify_gcstate_disable,     // no data about gcstate
 788           _verify_all_weak_roots
 789   );
 790 }
 791 
 792 void ShenandoahVerifier::verify_before_concmark() {

 793     verify_at_safepoint(
<span class="line-modified"> 794           &quot;Before Mark&quot;,</span>
<span class="line-modified"> 795           _verify_forwarded_none,      // UR should have fixed up</span>
<span class="line-modified"> 796           _verify_marked_disable,      // do not verify marked: lots ot time wasted checking dead allocations</span>
<span class="line-modified"> 797           _verify_cset_none,           // UR should have fixed this</span>
<span class="line-modified"> 798           _verify_liveness_disable,    // no reliable liveness data</span>
<span class="line-modified"> 799           _verify_regions_notrash,     // no trash regions</span>
<span class="line-modified"> 800           _verify_gcstate_stable,      // there are no forwarded objects</span>
<span class="line-modified"> 801           _verify_all_weak_roots</span>
<span class="line-modified"> 802   );</span>












 803 }
 804 
 805 void ShenandoahVerifier::verify_after_concmark() {
 806   verify_at_safepoint(
 807           &quot;After Mark&quot;,
 808           _verify_forwarded_none,      // no forwarded references
 809           _verify_marked_complete,     // bitmaps as precise as we can get
 810           _verify_cset_none,           // no references to cset anymore
 811           _verify_liveness_complete,   // liveness data must be complete here
 812           _verify_regions_disable,     // trash regions not yet recycled
 813           _verify_gcstate_stable,       // mark should have stabilized the heap
 814           _verify_all_weak_roots
 815   );
 816 }
 817 
 818 void ShenandoahVerifier::verify_before_evacuation() {
 819   // Concurrent weak roots are evacuated during concurrent phase
 820   VerifyWeakRoots verify_weak_roots = ShenandoahConcurrentRoots::should_do_concurrent_class_unloading() ?
 821                                       _verify_serial_weak_roots :
 822                                       _verify_all_weak_roots;
</pre>
<hr />
<pre>
 965       oop fwd = (oop) ShenandoahForwarding::get_forwardee_raw_unchecked(obj);
 966       if (obj != fwd) {
 967         ShenandoahAsserts::print_failure(ShenandoahAsserts::_safe_all, obj, p, NULL,
 968                                          &quot;Verify Roots&quot;, &quot;Should not be forwarded&quot;, __FILE__, __LINE__);
 969       }
 970     }
 971   }
 972 
 973 public:
 974   void do_oop(narrowOop* p) { do_oop_work(p); }
 975   void do_oop(oop* p)       { do_oop_work(p); }
 976 };
 977 
 978 class ShenandoahVerifyInToSpaceClosure : public OopClosure {
 979 private:
 980   template &lt;class T&gt;
 981   void do_oop_work(T* p) {
 982     T o = RawAccess&lt;&gt;::oop_load(p);
 983     if (!CompressedOops::is_null(o)) {
 984       oop obj = CompressedOops::decode_not_null(o);
<span class="line-modified"> 985       ShenandoahHeap* heap = ShenandoahHeap::heap();</span>
 986 
 987       if (!heap-&gt;marking_context()-&gt;is_marked(obj)) {
 988         ShenandoahAsserts::print_failure(ShenandoahAsserts::_safe_all, obj, p, NULL,
 989                 &quot;Verify Roots In To-Space&quot;, &quot;Should be marked&quot;, __FILE__, __LINE__);
 990       }
 991 
 992       if (heap-&gt;in_collection_set(obj)) {
 993         ShenandoahAsserts::print_failure(ShenandoahAsserts::_safe_all, obj, p, NULL,
 994                 &quot;Verify Roots In To-Space&quot;, &quot;Should not be in collection set&quot;, __FILE__, __LINE__);
 995       }
 996 
 997       oop fwd = (oop) ShenandoahForwarding::get_forwardee_raw_unchecked(obj);
 998       if (obj != fwd) {
 999         ShenandoahAsserts::print_failure(ShenandoahAsserts::_safe_all, obj, p, NULL,
1000                 &quot;Verify Roots In To-Space&quot;, &quot;Should not be forwarded&quot;, __FILE__, __LINE__);
1001       }
1002     }
1003   }
1004 
1005 public:
</pre>
</td>
</tr>
</table>
<center><a href="shenandoahVMOperations.hpp.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="shenandoah_globals.hpp.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>