<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>New src/hotspot/share/gc/g1/g1CollectedHeap.cpp</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
  <body>
    <pre>
   1 /*
   2  * Copyright (c) 2001, 2020, Oracle and/or its affiliates. All rights reserved.
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.
   8  *
   9  * This code is distributed in the hope that it will be useful, but WITHOUT
  10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  *
  23  */
  24 
  25 #include &quot;precompiled.hpp&quot;
  26 #include &quot;classfile/classLoaderDataGraph.hpp&quot;
  27 #include &quot;classfile/metadataOnStackMark.hpp&quot;
  28 #include &quot;classfile/stringTable.hpp&quot;
  29 #include &quot;code/codeCache.hpp&quot;
  30 #include &quot;code/icBuffer.hpp&quot;
  31 #include &quot;gc/g1/g1Allocator.inline.hpp&quot;
  32 #include &quot;gc/g1/g1Arguments.hpp&quot;
  33 #include &quot;gc/g1/g1BarrierSet.hpp&quot;
  34 #include &quot;gc/g1/g1CardTableEntryClosure.hpp&quot;
  35 #include &quot;gc/g1/g1CollectedHeap.inline.hpp&quot;
  36 #include &quot;gc/g1/g1CollectionSet.hpp&quot;
  37 #include &quot;gc/g1/g1CollectorState.hpp&quot;
  38 #include &quot;gc/g1/g1ConcurrentRefine.hpp&quot;
  39 #include &quot;gc/g1/g1ConcurrentRefineThread.hpp&quot;
  40 #include &quot;gc/g1/g1ConcurrentMarkThread.inline.hpp&quot;
  41 #include &quot;gc/g1/g1DirtyCardQueue.hpp&quot;
  42 #include &quot;gc/g1/g1EvacStats.inline.hpp&quot;
  43 #include &quot;gc/g1/g1FullCollector.hpp&quot;
  44 #include &quot;gc/g1/g1GCPhaseTimes.hpp&quot;
  45 #include &quot;gc/g1/g1HeapSizingPolicy.hpp&quot;
  46 #include &quot;gc/g1/g1HeapTransition.hpp&quot;
  47 #include &quot;gc/g1/g1HeapVerifier.hpp&quot;
  48 #include &quot;gc/g1/g1HotCardCache.hpp&quot;
  49 #include &quot;gc/g1/g1MemoryPool.hpp&quot;
  50 #include &quot;gc/g1/g1OopClosures.inline.hpp&quot;
  51 #include &quot;gc/g1/g1ParallelCleaning.hpp&quot;
  52 #include &quot;gc/g1/g1ParScanThreadState.inline.hpp&quot;
  53 #include &quot;gc/g1/g1Policy.hpp&quot;
  54 #include &quot;gc/g1/g1RedirtyCardsQueue.hpp&quot;
  55 #include &quot;gc/g1/g1RegionToSpaceMapper.hpp&quot;
  56 #include &quot;gc/g1/g1RemSet.hpp&quot;
  57 #include &quot;gc/g1/g1RootClosures.hpp&quot;
  58 #include &quot;gc/g1/g1RootProcessor.hpp&quot;
  59 #include &quot;gc/g1/g1SATBMarkQueueSet.hpp&quot;
  60 #include &quot;gc/g1/g1StringDedup.hpp&quot;
  61 #include &quot;gc/g1/g1ThreadLocalData.hpp&quot;
  62 #include &quot;gc/g1/g1Trace.hpp&quot;
  63 #include &quot;gc/g1/g1YCTypes.hpp&quot;
  64 #include &quot;gc/g1/g1YoungRemSetSamplingThread.hpp&quot;
  65 #include &quot;gc/g1/g1VMOperations.hpp&quot;
  66 #include &quot;gc/g1/heapRegion.inline.hpp&quot;
  67 #include &quot;gc/g1/heapRegionRemSet.hpp&quot;
  68 #include &quot;gc/g1/heapRegionSet.inline.hpp&quot;
  69 #include &quot;gc/shared/concurrentGCBreakpoints.hpp&quot;
  70 #include &quot;gc/shared/gcBehaviours.hpp&quot;
  71 #include &quot;gc/shared/gcHeapSummary.hpp&quot;
  72 #include &quot;gc/shared/gcId.hpp&quot;
  73 #include &quot;gc/shared/gcLocker.hpp&quot;
  74 #include &quot;gc/shared/gcTimer.hpp&quot;
  75 #include &quot;gc/shared/gcTraceTime.inline.hpp&quot;
  76 #include &quot;gc/shared/generationSpec.hpp&quot;
  77 #include &quot;gc/shared/isGCActiveMark.hpp&quot;
  78 #include &quot;gc/shared/locationPrinter.inline.hpp&quot;
  79 #include &quot;gc/shared/oopStorageParState.hpp&quot;
  80 #include &quot;gc/shared/preservedMarks.inline.hpp&quot;
  81 #include &quot;gc/shared/suspendibleThreadSet.hpp&quot;
  82 #include &quot;gc/shared/referenceProcessor.inline.hpp&quot;
  83 #include &quot;gc/shared/taskTerminator.hpp&quot;
  84 #include &quot;gc/shared/taskqueue.inline.hpp&quot;
  85 #include &quot;gc/shared/weakProcessor.inline.hpp&quot;
  86 #include &quot;gc/shared/workerPolicy.hpp&quot;
  87 #include &quot;logging/log.hpp&quot;
  88 #include &quot;memory/allocation.hpp&quot;
  89 #include &quot;memory/iterator.hpp&quot;
  90 #include &quot;memory/resourceArea.hpp&quot;
  91 #include &quot;memory/universe.hpp&quot;
  92 #include &quot;oops/access.inline.hpp&quot;
  93 #include &quot;oops/compressedOops.inline.hpp&quot;
  94 #include &quot;oops/oop.inline.hpp&quot;
  95 #include &quot;runtime/atomic.hpp&quot;
  96 #include &quot;runtime/flags/flagSetting.hpp&quot;
  97 #include &quot;runtime/handles.inline.hpp&quot;
  98 #include &quot;runtime/init.hpp&quot;
  99 #include &quot;runtime/orderAccess.hpp&quot;
 100 #include &quot;runtime/threadSMR.hpp&quot;
 101 #include &quot;runtime/vmThread.hpp&quot;
 102 #include &quot;utilities/align.hpp&quot;
 103 #include &quot;utilities/bitMap.inline.hpp&quot;
 104 #include &quot;utilities/globalDefinitions.hpp&quot;
 105 #include &quot;utilities/stack.inline.hpp&quot;
 106 
 107 size_t G1CollectedHeap::_humongous_object_threshold_in_words = 0;
 108 
 109 // INVARIANTS/NOTES
 110 //
 111 // All allocation activity covered by the G1CollectedHeap interface is
 112 // serialized by acquiring the HeapLock.  This happens in mem_allocate
 113 // and allocate_new_tlab, which are the &quot;entry&quot; points to the
 114 // allocation code from the rest of the JVM.  (Note that this does not
 115 // apply to TLAB allocation, which is not part of this interface: it
 116 // is done by clients of this interface.)
 117 
 118 class RedirtyLoggedCardTableEntryClosure : public G1CardTableEntryClosure {
 119  private:
 120   size_t _num_dirtied;
 121   G1CollectedHeap* _g1h;
 122   G1CardTable* _g1_ct;
 123 
 124   HeapRegion* region_for_card(CardValue* card_ptr) const {
 125     return _g1h-&gt;heap_region_containing(_g1_ct-&gt;addr_for(card_ptr));
 126   }
 127 
 128   bool will_become_free(HeapRegion* hr) const {
 129     // A region will be freed by free_collection_set if the region is in the
 130     // collection set and has not had an evacuation failure.
 131     return _g1h-&gt;is_in_cset(hr) &amp;&amp; !hr-&gt;evacuation_failed();
 132   }
 133 
 134  public:
 135   RedirtyLoggedCardTableEntryClosure(G1CollectedHeap* g1h) : G1CardTableEntryClosure(),
 136     _num_dirtied(0), _g1h(g1h), _g1_ct(g1h-&gt;card_table()) { }
 137 
 138   void do_card_ptr(CardValue* card_ptr, uint worker_id) {
 139     HeapRegion* hr = region_for_card(card_ptr);
 140 
 141     // Should only dirty cards in regions that won&#39;t be freed.
 142     if (!will_become_free(hr)) {
 143       *card_ptr = G1CardTable::dirty_card_val();
 144       _num_dirtied++;
 145     }
 146   }
 147 
 148   size_t num_dirtied()   const { return _num_dirtied; }
 149 };
 150 
 151 
 152 void G1RegionMappingChangedListener::reset_from_card_cache(uint start_idx, size_t num_regions) {
 153   HeapRegionRemSet::invalidate_from_card_cache(start_idx, num_regions);
 154 }
 155 
 156 void G1RegionMappingChangedListener::on_commit(uint start_idx, size_t num_regions, bool zero_filled) {
 157   // The from card cache is not the memory that is actually committed. So we cannot
 158   // take advantage of the zero_filled parameter.
 159   reset_from_card_cache(start_idx, num_regions);
 160 }
 161 
 162 Tickspan G1CollectedHeap::run_task(AbstractGangTask* task) {
 163   Ticks start = Ticks::now();
 164   workers()-&gt;run_task(task, workers()-&gt;active_workers());
 165   return Ticks::now() - start;
 166 }
 167 
 168 HeapRegion* G1CollectedHeap::new_heap_region(uint hrs_index,
 169                                              MemRegion mr) {
 170   return new HeapRegion(hrs_index, bot(), mr);
 171 }
 172 
 173 // Private methods.
 174 
 175 HeapRegion* G1CollectedHeap::new_region(size_t word_size,
 176                                         HeapRegionType type,
 177                                         bool do_expand,
 178                                         uint node_index) {
 179   assert(!is_humongous(word_size) || word_size &lt;= HeapRegion::GrainWords,
 180          &quot;the only time we use this to allocate a humongous region is &quot;
 181          &quot;when we are allocating a single humongous region&quot;);
 182 
 183   HeapRegion* res = _hrm-&gt;allocate_free_region(type, node_index);
 184 
 185   if (res == NULL &amp;&amp; do_expand &amp;&amp; _expand_heap_after_alloc_failure) {
 186     // Currently, only attempts to allocate GC alloc regions set
 187     // do_expand to true. So, we should only reach here during a
 188     // safepoint. If this assumption changes we might have to
 189     // reconsider the use of _expand_heap_after_alloc_failure.
 190     assert(SafepointSynchronize::is_at_safepoint(), &quot;invariant&quot;);
 191 
 192     log_debug(gc, ergo, heap)(&quot;Attempt heap expansion (region allocation request failed). Allocation request: &quot; SIZE_FORMAT &quot;B&quot;,
 193                               word_size * HeapWordSize);
 194 
 195     assert(word_size * HeapWordSize &lt; HeapRegion::GrainBytes,
 196            &quot;This kind of expansion should never be more than one region. Size: &quot; SIZE_FORMAT,
 197            word_size * HeapWordSize);
 198     if (expand_single_region(node_index)) {
 199       // Given that expand_single_region() succeeded in expanding the heap, and we
 200       // always expand the heap by an amount aligned to the heap
 201       // region size, the free list should in theory not be empty.
 202       // In either case allocate_free_region() will check for NULL.
 203       res = _hrm-&gt;allocate_free_region(type, node_index);
 204     } else {
 205       _expand_heap_after_alloc_failure = false;
 206     }
 207   }
 208   return res;
 209 }
 210 
 211 HeapWord*
 212 G1CollectedHeap::humongous_obj_allocate_initialize_regions(uint first,
 213                                                            uint num_regions,
 214                                                            size_t word_size) {
 215   assert(first != G1_NO_HRM_INDEX, &quot;pre-condition&quot;);
 216   assert(is_humongous(word_size), &quot;word_size should be humongous&quot;);
 217   assert(num_regions * HeapRegion::GrainWords &gt;= word_size, &quot;pre-condition&quot;);
 218 
 219   // Index of last region in the series.
 220   uint last = first + num_regions - 1;
 221 
 222   // We need to initialize the region(s) we just discovered. This is
 223   // a bit tricky given that it can happen concurrently with
 224   // refinement threads refining cards on these regions and
 225   // potentially wanting to refine the BOT as they are scanning
 226   // those cards (this can happen shortly after a cleanup; see CR
 227   // 6991377). So we have to set up the region(s) carefully and in
 228   // a specific order.
 229 
 230   // The word size sum of all the regions we will allocate.
 231   size_t word_size_sum = (size_t) num_regions * HeapRegion::GrainWords;
 232   assert(word_size &lt;= word_size_sum, &quot;sanity&quot;);
 233 
 234   // This will be the &quot;starts humongous&quot; region.
 235   HeapRegion* first_hr = region_at(first);
 236   // The header of the new object will be placed at the bottom of
 237   // the first region.
 238   HeapWord* new_obj = first_hr-&gt;bottom();
 239   // This will be the new top of the new object.
 240   HeapWord* obj_top = new_obj + word_size;
 241 
 242   // First, we need to zero the header of the space that we will be
 243   // allocating. When we update top further down, some refinement
 244   // threads might try to scan the region. By zeroing the header we
 245   // ensure that any thread that will try to scan the region will
 246   // come across the zero klass word and bail out.
 247   //
 248   // NOTE: It would not have been correct to have used
 249   // CollectedHeap::fill_with_object() and make the space look like
 250   // an int array. The thread that is doing the allocation will
 251   // later update the object header to a potentially different array
 252   // type and, for a very short period of time, the klass and length
 253   // fields will be inconsistent. This could cause a refinement
 254   // thread to calculate the object size incorrectly.
 255   Copy::fill_to_words(new_obj, oopDesc::header_size(), 0);
 256 
 257   // Next, pad out the unused tail of the last region with filler
 258   // objects, for improved usage accounting.
 259   // How many words we use for filler objects.
 260   size_t word_fill_size = word_size_sum - word_size;
 261 
 262   // How many words memory we &quot;waste&quot; which cannot hold a filler object.
 263   size_t words_not_fillable = 0;
 264 
 265   if (word_fill_size &gt;= min_fill_size()) {
 266     fill_with_objects(obj_top, word_fill_size);
 267   } else if (word_fill_size &gt; 0) {
 268     // We have space to fill, but we cannot fit an object there.
 269     words_not_fillable = word_fill_size;
 270     word_fill_size = 0;
 271   }
 272 
 273   // We will set up the first region as &quot;starts humongous&quot;. This
 274   // will also update the BOT covering all the regions to reflect
 275   // that there is a single object that starts at the bottom of the
 276   // first region.
 277   first_hr-&gt;set_starts_humongous(obj_top, word_fill_size);
 278   _policy-&gt;remset_tracker()-&gt;update_at_allocate(first_hr);
 279   // Then, if there are any, we will set up the &quot;continues
 280   // humongous&quot; regions.
 281   HeapRegion* hr = NULL;
 282   for (uint i = first + 1; i &lt;= last; ++i) {
 283     hr = region_at(i);
 284     hr-&gt;set_continues_humongous(first_hr);
 285     _policy-&gt;remset_tracker()-&gt;update_at_allocate(hr);
 286   }
 287 
 288   // Up to this point no concurrent thread would have been able to
 289   // do any scanning on any region in this series. All the top
 290   // fields still point to bottom, so the intersection between
 291   // [bottom,top] and [card_start,card_end] will be empty. Before we
 292   // update the top fields, we&#39;ll do a storestore to make sure that
 293   // no thread sees the update to top before the zeroing of the
 294   // object header and the BOT initialization.
 295   OrderAccess::storestore();
 296 
 297   // Now, we will update the top fields of the &quot;continues humongous&quot;
 298   // regions except the last one.
 299   for (uint i = first; i &lt; last; ++i) {
 300     hr = region_at(i);
 301     hr-&gt;set_top(hr-&gt;end());
 302   }
 303 
 304   hr = region_at(last);
 305   // If we cannot fit a filler object, we must set top to the end
 306   // of the humongous object, otherwise we cannot iterate the heap
 307   // and the BOT will not be complete.
 308   hr-&gt;set_top(hr-&gt;end() - words_not_fillable);
 309 
 310   assert(hr-&gt;bottom() &lt; obj_top &amp;&amp; obj_top &lt;= hr-&gt;end(),
 311          &quot;obj_top should be in last region&quot;);
 312 
 313   _verifier-&gt;check_bitmaps(&quot;Humongous Region Allocation&quot;, first_hr);
 314 
 315   assert(words_not_fillable == 0 ||
 316          first_hr-&gt;bottom() + word_size_sum - words_not_fillable == hr-&gt;top(),
 317          &quot;Miscalculation in humongous allocation&quot;);
 318 
 319   increase_used((word_size_sum - words_not_fillable) * HeapWordSize);
 320 
 321   for (uint i = first; i &lt;= last; ++i) {
 322     hr = region_at(i);
 323     _humongous_set.add(hr);
 324     _hr_printer.alloc(hr);
 325   }
 326 
 327   return new_obj;
 328 }
 329 
 330 size_t G1CollectedHeap::humongous_obj_size_in_regions(size_t word_size) {
 331   assert(is_humongous(word_size), &quot;Object of size &quot; SIZE_FORMAT &quot; must be humongous here&quot;, word_size);
 332   return align_up(word_size, HeapRegion::GrainWords) / HeapRegion::GrainWords;
 333 }
 334 
 335 // If could fit into free regions w/o expansion, try.
 336 // Otherwise, if can expand, do so.
 337 // Otherwise, if using ex regions might help, try with ex given back.
 338 HeapWord* G1CollectedHeap::humongous_obj_allocate(size_t word_size) {
 339   assert_heap_locked_or_at_safepoint(true /* should_be_vm_thread */);
 340 
 341   _verifier-&gt;verify_region_sets_optional();
 342 
 343   uint first = G1_NO_HRM_INDEX;
 344   uint obj_regions = (uint) humongous_obj_size_in_regions(word_size);
 345 
 346   if (obj_regions == 1) {
 347     // Only one region to allocate, try to use a fast path by directly allocating
 348     // from the free lists. Do not try to expand here, we will potentially do that
 349     // later.
 350     HeapRegion* hr = new_region(word_size, HeapRegionType::Humongous, false /* do_expand */);
 351     if (hr != NULL) {
 352       first = hr-&gt;hrm_index();
 353     }
 354   } else {
 355     // Policy: Try only empty regions (i.e. already committed first). Maybe we
 356     // are lucky enough to find some.
 357     first = _hrm-&gt;find_contiguous_only_empty(obj_regions);
 358     if (first != G1_NO_HRM_INDEX) {
 359       _hrm-&gt;allocate_free_regions_starting_at(first, obj_regions);
 360     }
 361   }
 362 
 363   if (first == G1_NO_HRM_INDEX) {
 364     // Policy: We could not find enough regions for the humongous object in the
 365     // free list. Look through the heap to find a mix of free and uncommitted regions.
 366     // If so, try expansion.
 367     first = _hrm-&gt;find_contiguous_empty_or_unavailable(obj_regions);
 368     if (first != G1_NO_HRM_INDEX) {
 369       // We found something. Make sure these regions are committed, i.e. expand
 370       // the heap. Alternatively we could do a defragmentation GC.
 371       log_debug(gc, ergo, heap)(&quot;Attempt heap expansion (humongous allocation request failed). Allocation request: &quot; SIZE_FORMAT &quot;B&quot;,
 372                                     word_size * HeapWordSize);
 373 
 374       _hrm-&gt;expand_at(first, obj_regions, workers());
 375       policy()-&gt;record_new_heap_size(num_regions());
 376 
 377 #ifdef ASSERT
 378       for (uint i = first; i &lt; first + obj_regions; ++i) {
 379         HeapRegion* hr = region_at(i);
 380         assert(hr-&gt;is_free(), &quot;sanity&quot;);
 381         assert(hr-&gt;is_empty(), &quot;sanity&quot;);
 382         assert(is_on_master_free_list(hr), &quot;sanity&quot;);
 383       }
 384 #endif
 385       _hrm-&gt;allocate_free_regions_starting_at(first, obj_regions);
 386     } else {
 387       // Policy: Potentially trigger a defragmentation GC.
 388     }
 389   }
 390 
 391   HeapWord* result = NULL;
 392   if (first != G1_NO_HRM_INDEX) {
 393     result = humongous_obj_allocate_initialize_regions(first, obj_regions, word_size);
 394     assert(result != NULL, &quot;it should always return a valid result&quot;);
 395 
 396     // A successful humongous object allocation changes the used space
 397     // information of the old generation so we need to recalculate the
 398     // sizes and update the jstat counters here.
 399     g1mm()-&gt;update_sizes();
 400   }
 401 
 402   _verifier-&gt;verify_region_sets_optional();
 403 
 404   return result;
 405 }
 406 
 407 HeapWord* G1CollectedHeap::allocate_new_tlab(size_t min_size,
 408                                              size_t requested_size,
 409                                              size_t* actual_size) {
 410   assert_heap_not_locked_and_not_at_safepoint();
 411   assert(!is_humongous(requested_size), &quot;we do not allow humongous TLABs&quot;);
 412 
 413   return attempt_allocation(min_size, requested_size, actual_size);
 414 }
 415 
 416 HeapWord*
 417 G1CollectedHeap::mem_allocate(size_t word_size,
 418                               bool*  gc_overhead_limit_was_exceeded) {
 419   assert_heap_not_locked_and_not_at_safepoint();
 420 
 421   if (is_humongous(word_size)) {
 422     return attempt_allocation_humongous(word_size);
 423   }
 424   size_t dummy = 0;
 425   return attempt_allocation(word_size, word_size, &amp;dummy);
 426 }
 427 
 428 HeapWord* G1CollectedHeap::attempt_allocation_slow(size_t word_size) {
 429   ResourceMark rm; // For retrieving the thread names in log messages.
 430 
 431   // Make sure you read the note in attempt_allocation_humongous().
 432 
 433   assert_heap_not_locked_and_not_at_safepoint();
 434   assert(!is_humongous(word_size), &quot;attempt_allocation_slow() should not &quot;
 435          &quot;be called for humongous allocation requests&quot;);
 436 
 437   // We should only get here after the first-level allocation attempt
 438   // (attempt_allocation()) failed to allocate.
 439 
 440   // We will loop until a) we manage to successfully perform the
 441   // allocation or b) we successfully schedule a collection which
 442   // fails to perform the allocation. b) is the only case when we&#39;ll
 443   // return NULL.
 444   HeapWord* result = NULL;
 445   for (uint try_count = 1, gclocker_retry_count = 0; /* we&#39;ll return */; try_count += 1) {
 446     bool should_try_gc;
 447     uint gc_count_before;
 448 
 449     {
 450       MutexLocker x(Heap_lock);
 451       result = _allocator-&gt;attempt_allocation_locked(word_size);
 452       if (result != NULL) {
 453         return result;
 454       }
 455 
 456       // If the GCLocker is active and we are bound for a GC, try expanding young gen.
 457       // This is different to when only GCLocker::needs_gc() is set: try to avoid
 458       // waiting because the GCLocker is active to not wait too long.
 459       if (GCLocker::is_active_and_needs_gc() &amp;&amp; policy()-&gt;can_expand_young_list()) {
 460         // No need for an ergo message here, can_expand_young_list() does this when
 461         // it returns true.
 462         result = _allocator-&gt;attempt_allocation_force(word_size);
 463         if (result != NULL) {
 464           return result;
 465         }
 466       }
 467       // Only try a GC if the GCLocker does not signal the need for a GC. Wait until
 468       // the GCLocker initiated GC has been performed and then retry. This includes
 469       // the case when the GC Locker is not active but has not been performed.
 470       should_try_gc = !GCLocker::needs_gc();
 471       // Read the GC count while still holding the Heap_lock.
 472       gc_count_before = total_collections();
 473     }
 474 
 475     if (should_try_gc) {
 476       bool succeeded;
 477       result = do_collection_pause(word_size, gc_count_before, &amp;succeeded,
 478                                    GCCause::_g1_inc_collection_pause);
 479       if (result != NULL) {
 480         assert(succeeded, &quot;only way to get back a non-NULL result&quot;);
 481         log_trace(gc, alloc)(&quot;%s: Successfully scheduled collection returning &quot; PTR_FORMAT,
 482                              Thread::current()-&gt;name(), p2i(result));
 483         return result;
 484       }
 485 
 486       if (succeeded) {
 487         // We successfully scheduled a collection which failed to allocate. No
 488         // point in trying to allocate further. We&#39;ll just return NULL.
 489         log_trace(gc, alloc)(&quot;%s: Successfully scheduled collection failing to allocate &quot;
 490                              SIZE_FORMAT &quot; words&quot;, Thread::current()-&gt;name(), word_size);
 491         return NULL;
 492       }
 493       log_trace(gc, alloc)(&quot;%s: Unsuccessfully scheduled collection allocating &quot; SIZE_FORMAT &quot; words&quot;,
 494                            Thread::current()-&gt;name(), word_size);
 495     } else {
 496       // Failed to schedule a collection.
 497       if (gclocker_retry_count &gt; GCLockerRetryAllocationCount) {
 498         log_warning(gc, alloc)(&quot;%s: Retried waiting for GCLocker too often allocating &quot;
 499                                SIZE_FORMAT &quot; words&quot;, Thread::current()-&gt;name(), word_size);
 500         return NULL;
 501       }
 502       log_trace(gc, alloc)(&quot;%s: Stall until clear&quot;, Thread::current()-&gt;name());
 503       // The GCLocker is either active or the GCLocker initiated
 504       // GC has not yet been performed. Stall until it is and
 505       // then retry the allocation.
 506       GCLocker::stall_until_clear();
 507       gclocker_retry_count += 1;
 508     }
 509 
 510     // We can reach here if we were unsuccessful in scheduling a
 511     // collection (because another thread beat us to it) or if we were
 512     // stalled due to the GC locker. In either can we should retry the
 513     // allocation attempt in case another thread successfully
 514     // performed a collection and reclaimed enough space. We do the
 515     // first attempt (without holding the Heap_lock) here and the
 516     // follow-on attempt will be at the start of the next loop
 517     // iteration (after taking the Heap_lock).
 518     size_t dummy = 0;
 519     result = _allocator-&gt;attempt_allocation(word_size, word_size, &amp;dummy);
 520     if (result != NULL) {
 521       return result;
 522     }
 523 
 524     // Give a warning if we seem to be looping forever.
 525     if ((QueuedAllocationWarningCount &gt; 0) &amp;&amp;
 526         (try_count % QueuedAllocationWarningCount == 0)) {
 527       log_warning(gc, alloc)(&quot;%s:  Retried allocation %u times for &quot; SIZE_FORMAT &quot; words&quot;,
 528                              Thread::current()-&gt;name(), try_count, word_size);
 529     }
 530   }
 531 
 532   ShouldNotReachHere();
 533   return NULL;
 534 }
 535 
 536 void G1CollectedHeap::begin_archive_alloc_range(bool open) {
 537   assert_at_safepoint_on_vm_thread();
 538   if (_archive_allocator == NULL) {
 539     _archive_allocator = G1ArchiveAllocator::create_allocator(this, open);
 540   }
 541 }
 542 
 543 bool G1CollectedHeap::is_archive_alloc_too_large(size_t word_size) {
 544   // Allocations in archive regions cannot be of a size that would be considered
 545   // humongous even for a minimum-sized region, because G1 region sizes/boundaries
 546   // may be different at archive-restore time.
 547   return word_size &gt;= humongous_threshold_for(HeapRegion::min_region_size_in_words());
 548 }
 549 
 550 HeapWord* G1CollectedHeap::archive_mem_allocate(size_t word_size) {
 551   assert_at_safepoint_on_vm_thread();
 552   assert(_archive_allocator != NULL, &quot;_archive_allocator not initialized&quot;);
 553   if (is_archive_alloc_too_large(word_size)) {
 554     return NULL;
 555   }
 556   return _archive_allocator-&gt;archive_mem_allocate(word_size);
 557 }
 558 
 559 void G1CollectedHeap::end_archive_alloc_range(GrowableArray&lt;MemRegion&gt;* ranges,
 560                                               size_t end_alignment_in_bytes) {
 561   assert_at_safepoint_on_vm_thread();
 562   assert(_archive_allocator != NULL, &quot;_archive_allocator not initialized&quot;);
 563 
 564   // Call complete_archive to do the real work, filling in the MemRegion
 565   // array with the archive regions.
 566   _archive_allocator-&gt;complete_archive(ranges, end_alignment_in_bytes);
 567   delete _archive_allocator;
 568   _archive_allocator = NULL;
 569 }
 570 
 571 bool G1CollectedHeap::check_archive_addresses(MemRegion* ranges, size_t count) {
 572   assert(ranges != NULL, &quot;MemRegion array NULL&quot;);
 573   assert(count != 0, &quot;No MemRegions provided&quot;);
 574   MemRegion reserved = _hrm-&gt;reserved();
 575   for (size_t i = 0; i &lt; count; i++) {
 576     if (!reserved.contains(ranges[i].start()) || !reserved.contains(ranges[i].last())) {
 577       return false;
 578     }
 579   }
 580   return true;
 581 }
 582 
 583 bool G1CollectedHeap::alloc_archive_regions(MemRegion* ranges,
 584                                             size_t count,
 585                                             bool open) {
 586   assert(!is_init_completed(), &quot;Expect to be called at JVM init time&quot;);
 587   assert(ranges != NULL, &quot;MemRegion array NULL&quot;);
 588   assert(count != 0, &quot;No MemRegions provided&quot;);
 589   MutexLocker x(Heap_lock);
 590 
 591   MemRegion reserved = _hrm-&gt;reserved();
 592   HeapWord* prev_last_addr = NULL;
 593   HeapRegion* prev_last_region = NULL;
 594 
 595   // Temporarily disable pretouching of heap pages. This interface is used
 596   // when mmap&#39;ing archived heap data in, so pre-touching is wasted.
 597   FlagSetting fs(AlwaysPreTouch, false);
 598 
 599   // Enable archive object checking used by G1MarkSweep. We have to let it know
 600   // about each archive range, so that objects in those ranges aren&#39;t marked.
 601   G1ArchiveAllocator::enable_archive_object_check();
 602 
 603   // For each specified MemRegion range, allocate the corresponding G1
 604   // regions and mark them as archive regions. We expect the ranges
 605   // in ascending starting address order, without overlap.
 606   for (size_t i = 0; i &lt; count; i++) {
 607     MemRegion curr_range = ranges[i];
 608     HeapWord* start_address = curr_range.start();
 609     size_t word_size = curr_range.word_size();
 610     HeapWord* last_address = curr_range.last();
 611     size_t commits = 0;
 612 
 613     guarantee(reserved.contains(start_address) &amp;&amp; reserved.contains(last_address),
 614               &quot;MemRegion outside of heap [&quot; PTR_FORMAT &quot;, &quot; PTR_FORMAT &quot;]&quot;,
 615               p2i(start_address), p2i(last_address));
 616     guarantee(start_address &gt; prev_last_addr,
 617               &quot;Ranges not in ascending order: &quot; PTR_FORMAT &quot; &lt;= &quot; PTR_FORMAT ,
 618               p2i(start_address), p2i(prev_last_addr));
 619     prev_last_addr = last_address;
 620 
 621     // Check for ranges that start in the same G1 region in which the previous
 622     // range ended, and adjust the start address so we don&#39;t try to allocate
 623     // the same region again. If the current range is entirely within that
 624     // region, skip it, just adjusting the recorded top.
 625     HeapRegion* start_region = _hrm-&gt;addr_to_region(start_address);
 626     if ((prev_last_region != NULL) &amp;&amp; (start_region == prev_last_region)) {
 627       start_address = start_region-&gt;end();
 628       if (start_address &gt; last_address) {
 629         increase_used(word_size * HeapWordSize);
 630         start_region-&gt;set_top(last_address + 1);
 631         continue;
 632       }
 633       start_region-&gt;set_top(start_address);
 634       curr_range = MemRegion(start_address, last_address + 1);
 635       start_region = _hrm-&gt;addr_to_region(start_address);
 636     }
 637 
 638     // Perform the actual region allocation, exiting if it fails.
 639     // Then note how much new space we have allocated.
 640     if (!_hrm-&gt;allocate_containing_regions(curr_range, &amp;commits, workers())) {
 641       return false;
 642     }
 643     increase_used(word_size * HeapWordSize);
 644     if (commits != 0) {
 645       log_debug(gc, ergo, heap)(&quot;Attempt heap expansion (allocate archive regions). Total size: &quot; SIZE_FORMAT &quot;B&quot;,
 646                                 HeapRegion::GrainWords * HeapWordSize * commits);
 647 
 648     }
 649 
 650     // Mark each G1 region touched by the range as archive, add it to
 651     // the old set, and set top.
 652     HeapRegion* curr_region = _hrm-&gt;addr_to_region(start_address);
 653     HeapRegion* last_region = _hrm-&gt;addr_to_region(last_address);
 654     prev_last_region = last_region;
 655 
 656     while (curr_region != NULL) {
 657       assert(curr_region-&gt;is_empty() &amp;&amp; !curr_region-&gt;is_pinned(),
 658              &quot;Region already in use (index %u)&quot;, curr_region-&gt;hrm_index());
 659       if (open) {
 660         curr_region-&gt;set_open_archive();
 661       } else {
 662         curr_region-&gt;set_closed_archive();
 663       }
 664       _hr_printer.alloc(curr_region);
 665       _archive_set.add(curr_region);
 666       HeapWord* top;
 667       HeapRegion* next_region;
 668       if (curr_region != last_region) {
 669         top = curr_region-&gt;end();
 670         next_region = _hrm-&gt;next_region_in_heap(curr_region);
 671       } else {
 672         top = last_address + 1;
 673         next_region = NULL;
 674       }
 675       curr_region-&gt;set_top(top);
 676       curr_region = next_region;
 677     }
 678 
 679     // Notify mark-sweep of the archive
 680     G1ArchiveAllocator::set_range_archive(curr_range, open);
 681   }
 682   return true;
 683 }
 684 
 685 void G1CollectedHeap::fill_archive_regions(MemRegion* ranges, size_t count) {
 686   assert(!is_init_completed(), &quot;Expect to be called at JVM init time&quot;);
 687   assert(ranges != NULL, &quot;MemRegion array NULL&quot;);
 688   assert(count != 0, &quot;No MemRegions provided&quot;);
 689   MemRegion reserved = _hrm-&gt;reserved();
 690   HeapWord *prev_last_addr = NULL;
 691   HeapRegion* prev_last_region = NULL;
 692 
 693   // For each MemRegion, create filler objects, if needed, in the G1 regions
 694   // that contain the address range. The address range actually within the
 695   // MemRegion will not be modified. That is assumed to have been initialized
 696   // elsewhere, probably via an mmap of archived heap data.
 697   MutexLocker x(Heap_lock);
 698   for (size_t i = 0; i &lt; count; i++) {
 699     HeapWord* start_address = ranges[i].start();
 700     HeapWord* last_address = ranges[i].last();
 701 
 702     assert(reserved.contains(start_address) &amp;&amp; reserved.contains(last_address),
 703            &quot;MemRegion outside of heap [&quot; PTR_FORMAT &quot;, &quot; PTR_FORMAT &quot;]&quot;,
 704            p2i(start_address), p2i(last_address));
 705     assert(start_address &gt; prev_last_addr,
 706            &quot;Ranges not in ascending order: &quot; PTR_FORMAT &quot; &lt;= &quot; PTR_FORMAT ,
 707            p2i(start_address), p2i(prev_last_addr));
 708 
 709     HeapRegion* start_region = _hrm-&gt;addr_to_region(start_address);
 710     HeapRegion* last_region = _hrm-&gt;addr_to_region(last_address);
 711     HeapWord* bottom_address = start_region-&gt;bottom();
 712 
 713     // Check for a range beginning in the same region in which the
 714     // previous one ended.
 715     if (start_region == prev_last_region) {
 716       bottom_address = prev_last_addr + 1;
 717     }
 718 
 719     // Verify that the regions were all marked as archive regions by
 720     // alloc_archive_regions.
 721     HeapRegion* curr_region = start_region;
 722     while (curr_region != NULL) {
 723       guarantee(curr_region-&gt;is_archive(),
 724                 &quot;Expected archive region at index %u&quot;, curr_region-&gt;hrm_index());
 725       if (curr_region != last_region) {
 726         curr_region = _hrm-&gt;next_region_in_heap(curr_region);
 727       } else {
 728         curr_region = NULL;
 729       }
 730     }
 731 
 732     prev_last_addr = last_address;
 733     prev_last_region = last_region;
 734 
 735     // Fill the memory below the allocated range with dummy object(s),
 736     // if the region bottom does not match the range start, or if the previous
 737     // range ended within the same G1 region, and there is a gap.
 738     if (start_address != bottom_address) {
 739       size_t fill_size = pointer_delta(start_address, bottom_address);
 740       G1CollectedHeap::fill_with_objects(bottom_address, fill_size);
 741       increase_used(fill_size * HeapWordSize);
 742     }
 743   }
 744 }
 745 
 746 inline HeapWord* G1CollectedHeap::attempt_allocation(size_t min_word_size,
 747                                                      size_t desired_word_size,
 748                                                      size_t* actual_word_size) {
 749   assert_heap_not_locked_and_not_at_safepoint();
 750   assert(!is_humongous(desired_word_size), &quot;attempt_allocation() should not &quot;
 751          &quot;be called for humongous allocation requests&quot;);
 752 
 753   HeapWord* result = _allocator-&gt;attempt_allocation(min_word_size, desired_word_size, actual_word_size);
 754 
 755   if (result == NULL) {
 756     *actual_word_size = desired_word_size;
 757     result = attempt_allocation_slow(desired_word_size);
 758   }
 759 
 760   assert_heap_not_locked();
 761   if (result != NULL) {
 762     assert(*actual_word_size != 0, &quot;Actual size must have been set here&quot;);
 763     dirty_young_block(result, *actual_word_size);
 764   } else {
 765     *actual_word_size = 0;
 766   }
 767 
 768   return result;
 769 }
 770 
 771 void G1CollectedHeap::dealloc_archive_regions(MemRegion* ranges, size_t count) {
 772   assert(!is_init_completed(), &quot;Expect to be called at JVM init time&quot;);
 773   assert(ranges != NULL, &quot;MemRegion array NULL&quot;);
 774   assert(count != 0, &quot;No MemRegions provided&quot;);
 775   MemRegion reserved = _hrm-&gt;reserved();
 776   HeapWord* prev_last_addr = NULL;
 777   HeapRegion* prev_last_region = NULL;
 778   size_t size_used = 0;
 779   size_t uncommitted_regions = 0;
 780 
 781   // For each Memregion, free the G1 regions that constitute it, and
 782   // notify mark-sweep that the range is no longer to be considered &#39;archive.&#39;
 783   MutexLocker x(Heap_lock);
 784   for (size_t i = 0; i &lt; count; i++) {
 785     HeapWord* start_address = ranges[i].start();
 786     HeapWord* last_address = ranges[i].last();
 787 
 788     assert(reserved.contains(start_address) &amp;&amp; reserved.contains(last_address),
 789            &quot;MemRegion outside of heap [&quot; PTR_FORMAT &quot;, &quot; PTR_FORMAT &quot;]&quot;,
 790            p2i(start_address), p2i(last_address));
 791     assert(start_address &gt; prev_last_addr,
 792            &quot;Ranges not in ascending order: &quot; PTR_FORMAT &quot; &lt;= &quot; PTR_FORMAT ,
 793            p2i(start_address), p2i(prev_last_addr));
 794     size_used += ranges[i].byte_size();
 795     prev_last_addr = last_address;
 796 
 797     HeapRegion* start_region = _hrm-&gt;addr_to_region(start_address);
 798     HeapRegion* last_region = _hrm-&gt;addr_to_region(last_address);
 799 
 800     // Check for ranges that start in the same G1 region in which the previous
 801     // range ended, and adjust the start address so we don&#39;t try to free
 802     // the same region again. If the current range is entirely within that
 803     // region, skip it.
 804     if (start_region == prev_last_region) {
 805       start_address = start_region-&gt;end();
 806       if (start_address &gt; last_address) {
 807         continue;
 808       }
 809       start_region = _hrm-&gt;addr_to_region(start_address);
 810     }
 811     prev_last_region = last_region;
 812 
 813     // After verifying that each region was marked as an archive region by
 814     // alloc_archive_regions, set it free and empty and uncommit it.
 815     HeapRegion* curr_region = start_region;
 816     while (curr_region != NULL) {
 817       guarantee(curr_region-&gt;is_archive(),
 818                 &quot;Expected archive region at index %u&quot;, curr_region-&gt;hrm_index());
 819       uint curr_index = curr_region-&gt;hrm_index();
 820       _archive_set.remove(curr_region);
 821       curr_region-&gt;set_free();
 822       curr_region-&gt;set_top(curr_region-&gt;bottom());
 823       if (curr_region != last_region) {
 824         curr_region = _hrm-&gt;next_region_in_heap(curr_region);
 825       } else {
 826         curr_region = NULL;
 827       }
 828       _hrm-&gt;shrink_at(curr_index, 1);
 829       uncommitted_regions++;
 830     }
 831 
 832     // Notify mark-sweep that this is no longer an archive range.
 833     G1ArchiveAllocator::clear_range_archive(ranges[i]);
 834   }
 835 
 836   if (uncommitted_regions != 0) {
 837     log_debug(gc, ergo, heap)(&quot;Attempt heap shrinking (uncommitted archive regions). Total size: &quot; SIZE_FORMAT &quot;B&quot;,
 838                               HeapRegion::GrainWords * HeapWordSize * uncommitted_regions);
 839   }
 840   decrease_used(size_used);
 841 }
 842 
 843 oop G1CollectedHeap::materialize_archived_object(oop obj) {
 844   assert(obj != NULL, &quot;archived obj is NULL&quot;);
 845   assert(G1ArchiveAllocator::is_archived_object(obj), &quot;must be archived object&quot;);
 846 
 847   // Loading an archived object makes it strongly reachable. If it is
 848   // loaded during concurrent marking, it must be enqueued to the SATB
 849   // queue, shading the previously white object gray.
 850   G1BarrierSet::enqueue(obj);
 851 
 852   return obj;
 853 }
 854 
 855 HeapWord* G1CollectedHeap::attempt_allocation_humongous(size_t word_size) {
 856   ResourceMark rm; // For retrieving the thread names in log messages.
 857 
 858   // The structure of this method has a lot of similarities to
 859   // attempt_allocation_slow(). The reason these two were not merged
 860   // into a single one is that such a method would require several &quot;if
 861   // allocation is not humongous do this, otherwise do that&quot;
 862   // conditional paths which would obscure its flow. In fact, an early
 863   // version of this code did use a unified method which was harder to
 864   // follow and, as a result, it had subtle bugs that were hard to
 865   // track down. So keeping these two methods separate allows each to
 866   // be more readable. It will be good to keep these two in sync as
 867   // much as possible.
 868 
 869   assert_heap_not_locked_and_not_at_safepoint();
 870   assert(is_humongous(word_size), &quot;attempt_allocation_humongous() &quot;
 871          &quot;should only be called for humongous allocations&quot;);
 872 
 873   // Humongous objects can exhaust the heap quickly, so we should check if we
 874   // need to start a marking cycle at each humongous object allocation. We do
 875   // the check before we do the actual allocation. The reason for doing it
 876   // before the allocation is that we avoid having to keep track of the newly
 877   // allocated memory while we do a GC.
 878   if (policy()-&gt;need_to_start_conc_mark(&quot;concurrent humongous allocation&quot;,
 879                                            word_size)) {
 880     collect(GCCause::_g1_humongous_allocation);
 881   }
 882 
 883   // We will loop until a) we manage to successfully perform the
 884   // allocation or b) we successfully schedule a collection which
 885   // fails to perform the allocation. b) is the only case when we&#39;ll
 886   // return NULL.
 887   HeapWord* result = NULL;
 888   for (uint try_count = 1, gclocker_retry_count = 0; /* we&#39;ll return */; try_count += 1) {
 889     bool should_try_gc;
 890     uint gc_count_before;
 891 
 892 
 893     {
 894       MutexLocker x(Heap_lock);
 895 
 896       // Given that humongous objects are not allocated in young
 897       // regions, we&#39;ll first try to do the allocation without doing a
 898       // collection hoping that there&#39;s enough space in the heap.
 899       result = humongous_obj_allocate(word_size);
 900       if (result != NULL) {
 901         size_t size_in_regions = humongous_obj_size_in_regions(word_size);
 902         policy()-&gt;add_bytes_allocated_in_old_since_last_gc(size_in_regions * HeapRegion::GrainBytes);
 903         return result;
 904       }
 905 
 906       // Only try a GC if the GCLocker does not signal the need for a GC. Wait until
 907       // the GCLocker initiated GC has been performed and then retry. This includes
 908       // the case when the GC Locker is not active but has not been performed.
 909       should_try_gc = !GCLocker::needs_gc();
 910       // Read the GC count while still holding the Heap_lock.
 911       gc_count_before = total_collections();
 912     }
 913 
 914     if (should_try_gc) {
 915       bool succeeded;
 916       result = do_collection_pause(word_size, gc_count_before, &amp;succeeded,
 917                                    GCCause::_g1_humongous_allocation);
 918       if (result != NULL) {
 919         assert(succeeded, &quot;only way to get back a non-NULL result&quot;);
 920         log_trace(gc, alloc)(&quot;%s: Successfully scheduled collection returning &quot; PTR_FORMAT,
 921                              Thread::current()-&gt;name(), p2i(result));
 922         return result;
 923       }
 924 
 925       if (succeeded) {
 926         // We successfully scheduled a collection which failed to allocate. No
 927         // point in trying to allocate further. We&#39;ll just return NULL.
 928         log_trace(gc, alloc)(&quot;%s: Successfully scheduled collection failing to allocate &quot;
 929                              SIZE_FORMAT &quot; words&quot;, Thread::current()-&gt;name(), word_size);
 930         return NULL;
 931       }
 932       log_trace(gc, alloc)(&quot;%s: Unsuccessfully scheduled collection allocating &quot; SIZE_FORMAT &quot;&quot;,
 933                            Thread::current()-&gt;name(), word_size);
 934     } else {
 935       // Failed to schedule a collection.
 936       if (gclocker_retry_count &gt; GCLockerRetryAllocationCount) {
 937         log_warning(gc, alloc)(&quot;%s: Retried waiting for GCLocker too often allocating &quot;
 938                                SIZE_FORMAT &quot; words&quot;, Thread::current()-&gt;name(), word_size);
 939         return NULL;
 940       }
 941       log_trace(gc, alloc)(&quot;%s: Stall until clear&quot;, Thread::current()-&gt;name());
 942       // The GCLocker is either active or the GCLocker initiated
 943       // GC has not yet been performed. Stall until it is and
 944       // then retry the allocation.
 945       GCLocker::stall_until_clear();
 946       gclocker_retry_count += 1;
 947     }
 948 
 949 
 950     // We can reach here if we were unsuccessful in scheduling a
 951     // collection (because another thread beat us to it) or if we were
 952     // stalled due to the GC locker. In either can we should retry the
 953     // allocation attempt in case another thread successfully
 954     // performed a collection and reclaimed enough space.
 955     // Humongous object allocation always needs a lock, so we wait for the retry
 956     // in the next iteration of the loop, unlike for the regular iteration case.
 957     // Give a warning if we seem to be looping forever.
 958 
 959     if ((QueuedAllocationWarningCount &gt; 0) &amp;&amp;
 960         (try_count % QueuedAllocationWarningCount == 0)) {
 961       log_warning(gc, alloc)(&quot;%s: Retried allocation %u times for &quot; SIZE_FORMAT &quot; words&quot;,
 962                              Thread::current()-&gt;name(), try_count, word_size);
 963     }
 964   }
 965 
 966   ShouldNotReachHere();
 967   return NULL;
 968 }
 969 
 970 HeapWord* G1CollectedHeap::attempt_allocation_at_safepoint(size_t word_size,
 971                                                            bool expect_null_mutator_alloc_region) {
 972   assert_at_safepoint_on_vm_thread();
 973   assert(!_allocator-&gt;has_mutator_alloc_region() || !expect_null_mutator_alloc_region,
 974          &quot;the current alloc region was unexpectedly found to be non-NULL&quot;);
 975 
 976   if (!is_humongous(word_size)) {
 977     return _allocator-&gt;attempt_allocation_locked(word_size);
 978   } else {
 979     HeapWord* result = humongous_obj_allocate(word_size);
 980     if (result != NULL &amp;&amp; policy()-&gt;need_to_start_conc_mark(&quot;STW humongous allocation&quot;)) {
 981       collector_state()-&gt;set_initiate_conc_mark_if_possible(true);
 982     }
 983     return result;
 984   }
 985 
 986   ShouldNotReachHere();
 987 }
 988 
 989 class PostCompactionPrinterClosure: public HeapRegionClosure {
 990 private:
 991   G1HRPrinter* _hr_printer;
 992 public:
 993   bool do_heap_region(HeapRegion* hr) {
 994     assert(!hr-&gt;is_young(), &quot;not expecting to find young regions&quot;);
 995     _hr_printer-&gt;post_compaction(hr);
 996     return false;
 997   }
 998 
 999   PostCompactionPrinterClosure(G1HRPrinter* hr_printer)
1000     : _hr_printer(hr_printer) { }
1001 };
1002 
1003 void G1CollectedHeap::print_hrm_post_compaction() {
1004   if (_hr_printer.is_active()) {
1005     PostCompactionPrinterClosure cl(hr_printer());
1006     heap_region_iterate(&amp;cl);
1007   }
1008 }
1009 
1010 void G1CollectedHeap::abort_concurrent_cycle() {
1011   // If we start the compaction before the CM threads finish
1012   // scanning the root regions we might trip them over as we&#39;ll
1013   // be moving objects / updating references. So let&#39;s wait until
1014   // they are done. By telling them to abort, they should complete
1015   // early.
1016   _cm-&gt;root_regions()-&gt;abort();
1017   _cm-&gt;root_regions()-&gt;wait_until_scan_finished();
1018 
1019   // Disable discovery and empty the discovered lists
1020   // for the CM ref processor.
1021   _ref_processor_cm-&gt;disable_discovery();
1022   _ref_processor_cm-&gt;abandon_partial_discovery();
1023   _ref_processor_cm-&gt;verify_no_references_recorded();
1024 
1025   // Abandon current iterations of concurrent marking and concurrent
1026   // refinement, if any are in progress.
1027   concurrent_mark()-&gt;concurrent_cycle_abort();
1028 }
1029 
1030 void G1CollectedHeap::prepare_heap_for_full_collection() {
1031   // Make sure we&#39;ll choose a new allocation region afterwards.
1032   _allocator-&gt;release_mutator_alloc_regions();
1033   _allocator-&gt;abandon_gc_alloc_regions();
1034 
1035   // We may have added regions to the current incremental collection
1036   // set between the last GC or pause and now. We need to clear the
1037   // incremental collection set and then start rebuilding it afresh
1038   // after this full GC.
1039   abandon_collection_set(collection_set());
1040 
1041   tear_down_region_sets(false /* free_list_only */);
1042 
1043   hrm()-&gt;prepare_for_full_collection_start();
1044 }
1045 
1046 void G1CollectedHeap::verify_before_full_collection(bool explicit_gc) {
1047   assert(!GCCause::is_user_requested_gc(gc_cause()) || explicit_gc, &quot;invariant&quot;);
1048   assert_used_and_recalculate_used_equal(this);
1049   _verifier-&gt;verify_region_sets_optional();
1050   _verifier-&gt;verify_before_gc(G1HeapVerifier::G1VerifyFull);
1051   _verifier-&gt;check_bitmaps(&quot;Full GC Start&quot;);
1052 }
1053 
1054 void G1CollectedHeap::prepare_heap_for_mutators() {
1055   hrm()-&gt;prepare_for_full_collection_end();
1056 
1057   // Delete metaspaces for unloaded class loaders and clean up loader_data graph
1058   ClassLoaderDataGraph::purge();
1059   MetaspaceUtils::verify_metrics();
1060 
1061   // Prepare heap for normal collections.
1062   assert(num_free_regions() == 0, &quot;we should not have added any free regions&quot;);
1063   rebuild_region_sets(false /* free_list_only */);
1064   abort_refinement();
1065   resize_heap_if_necessary();
1066 
1067   // Rebuild the strong code root lists for each region
1068   rebuild_strong_code_roots();
1069 
1070   // Purge code root memory
1071   purge_code_root_memory();
1072 
1073   // Start a new incremental collection set for the next pause
1074   start_new_collection_set();
1075 
1076   _allocator-&gt;init_mutator_alloc_regions();
1077 
1078   // Post collection state updates.
1079   MetaspaceGC::compute_new_size();
1080 }
1081 
1082 void G1CollectedHeap::abort_refinement() {
1083   if (_hot_card_cache-&gt;use_cache()) {
1084     _hot_card_cache-&gt;reset_hot_cache();
1085   }
1086 
1087   // Discard all remembered set updates.
1088   G1BarrierSet::dirty_card_queue_set().abandon_logs();
1089   assert(G1BarrierSet::dirty_card_queue_set().num_cards() == 0,
1090          &quot;DCQS should be empty&quot;);
1091 }
1092 
1093 void G1CollectedHeap::verify_after_full_collection() {
1094   _hrm-&gt;verify_optional();
1095   _verifier-&gt;verify_region_sets_optional();
1096   _verifier-&gt;verify_after_gc(G1HeapVerifier::G1VerifyFull);
1097   // Clear the previous marking bitmap, if needed for bitmap verification.
1098   // Note we cannot do this when we clear the next marking bitmap in
1099   // G1ConcurrentMark::abort() above since VerifyDuringGC verifies the
1100   // objects marked during a full GC against the previous bitmap.
1101   // But we need to clear it before calling check_bitmaps below since
1102   // the full GC has compacted objects and updated TAMS but not updated
1103   // the prev bitmap.
1104   if (G1VerifyBitmaps) {
1105     GCTraceTime(Debug, gc) tm(&quot;Clear Prev Bitmap for Verification&quot;);
1106     _cm-&gt;clear_prev_bitmap(workers());
1107   }
1108   // This call implicitly verifies that the next bitmap is clear after Full GC.
1109   _verifier-&gt;check_bitmaps(&quot;Full GC End&quot;);
1110 
1111   // At this point there should be no regions in the
1112   // entire heap tagged as young.
1113   assert(check_young_list_empty(), &quot;young list should be empty at this point&quot;);
1114 
1115   // Note: since we&#39;ve just done a full GC, concurrent
1116   // marking is no longer active. Therefore we need not
1117   // re-enable reference discovery for the CM ref processor.
1118   // That will be done at the start of the next marking cycle.
1119   // We also know that the STW processor should no longer
1120   // discover any new references.
1121   assert(!_ref_processor_stw-&gt;discovery_enabled(), &quot;Postcondition&quot;);
1122   assert(!_ref_processor_cm-&gt;discovery_enabled(), &quot;Postcondition&quot;);
1123   _ref_processor_stw-&gt;verify_no_references_recorded();
1124   _ref_processor_cm-&gt;verify_no_references_recorded();
1125 }
1126 
1127 void G1CollectedHeap::print_heap_after_full_collection(G1HeapTransition* heap_transition) {
1128   // Post collection logging.
1129   // We should do this after we potentially resize the heap so
1130   // that all the COMMIT / UNCOMMIT events are generated before
1131   // the compaction events.
1132   print_hrm_post_compaction();
1133   heap_transition-&gt;print();
1134   print_heap_after_gc();
1135   print_heap_regions();
1136 }
1137 
1138 bool G1CollectedHeap::do_full_collection(bool explicit_gc,
1139                                          bool clear_all_soft_refs) {
1140   assert_at_safepoint_on_vm_thread();
1141 
1142   if (GCLocker::check_active_before_gc()) {
1143     // Full GC was not completed.
1144     return false;
1145   }
1146 
1147   const bool do_clear_all_soft_refs = clear_all_soft_refs ||
1148       soft_ref_policy()-&gt;should_clear_all_soft_refs();
1149 
1150   G1FullCollector collector(this, explicit_gc, do_clear_all_soft_refs);
1151   GCTraceTime(Info, gc) tm(&quot;Pause Full&quot;, NULL, gc_cause(), true);
1152 
1153   collector.prepare_collection();
1154   collector.collect();
1155   collector.complete_collection();
1156 
1157   // Full collection was successfully completed.
1158   return true;
1159 }
1160 
1161 void G1CollectedHeap::do_full_collection(bool clear_all_soft_refs) {
1162   // Currently, there is no facility in the do_full_collection(bool) API to notify
1163   // the caller that the collection did not succeed (e.g., because it was locked
1164   // out by the GC locker). So, right now, we&#39;ll ignore the return value.
1165   bool dummy = do_full_collection(true,                /* explicit_gc */
1166                                   clear_all_soft_refs);
1167 }
1168 
1169 void G1CollectedHeap::resize_heap_if_necessary() {
1170   assert_at_safepoint_on_vm_thread();
1171 
1172   // Capacity, free and used after the GC counted as full regions to
1173   // include the waste in the following calculations.
1174   const size_t capacity_after_gc = capacity();
1175   const size_t used_after_gc = capacity_after_gc - unused_committed_regions_in_bytes();
1176 
1177   // This is enforced in arguments.cpp.
1178   assert(MinHeapFreeRatio &lt;= MaxHeapFreeRatio,
1179          &quot;otherwise the code below doesn&#39;t make sense&quot;);
1180 
1181   // We don&#39;t have floating point command-line arguments
1182   const double minimum_free_percentage = (double) MinHeapFreeRatio / 100.0;
1183   const double maximum_used_percentage = 1.0 - minimum_free_percentage;
1184   const double maximum_free_percentage = (double) MaxHeapFreeRatio / 100.0;
1185   const double minimum_used_percentage = 1.0 - maximum_free_percentage;
1186 
1187   // We have to be careful here as these two calculations can overflow
1188   // 32-bit size_t&#39;s.
1189   double used_after_gc_d = (double) used_after_gc;
1190   double minimum_desired_capacity_d = used_after_gc_d / maximum_used_percentage;
1191   double maximum_desired_capacity_d = used_after_gc_d / minimum_used_percentage;
1192 
1193   // Let&#39;s make sure that they are both under the max heap size, which
1194   // by default will make them fit into a size_t.
1195   double desired_capacity_upper_bound = (double) MaxHeapSize;
1196   minimum_desired_capacity_d = MIN2(minimum_desired_capacity_d,
1197                                     desired_capacity_upper_bound);
1198   maximum_desired_capacity_d = MIN2(maximum_desired_capacity_d,
1199                                     desired_capacity_upper_bound);
1200 
1201   // We can now safely turn them into size_t&#39;s.
1202   size_t minimum_desired_capacity = (size_t) minimum_desired_capacity_d;
1203   size_t maximum_desired_capacity = (size_t) maximum_desired_capacity_d;
1204 
1205   // This assert only makes sense here, before we adjust them
1206   // with respect to the min and max heap size.
1207   assert(minimum_desired_capacity &lt;= maximum_desired_capacity,
1208          &quot;minimum_desired_capacity = &quot; SIZE_FORMAT &quot;, &quot;
1209          &quot;maximum_desired_capacity = &quot; SIZE_FORMAT,
1210          minimum_desired_capacity, maximum_desired_capacity);
1211 
1212   // Should not be greater than the heap max size. No need to adjust
1213   // it with respect to the heap min size as it&#39;s a lower bound (i.e.,
1214   // we&#39;ll try to make the capacity larger than it, not smaller).
1215   minimum_desired_capacity = MIN2(minimum_desired_capacity, MaxHeapSize);
1216   // Should not be less than the heap min size. No need to adjust it
1217   // with respect to the heap max size as it&#39;s an upper bound (i.e.,
1218   // we&#39;ll try to make the capacity smaller than it, not greater).
1219   maximum_desired_capacity =  MAX2(maximum_desired_capacity, MinHeapSize);
1220 
1221   if (capacity_after_gc &lt; minimum_desired_capacity) {
1222     // Don&#39;t expand unless it&#39;s significant
1223     size_t expand_bytes = minimum_desired_capacity - capacity_after_gc;
1224 
1225     log_debug(gc, ergo, heap)(&quot;Attempt heap expansion (capacity lower than min desired capacity). &quot;
1226                               &quot;Capacity: &quot; SIZE_FORMAT &quot;B occupancy: &quot; SIZE_FORMAT &quot;B live: &quot; SIZE_FORMAT &quot;B &quot;
1227                               &quot;min_desired_capacity: &quot; SIZE_FORMAT &quot;B (&quot; UINTX_FORMAT &quot; %%)&quot;,
1228                               capacity_after_gc, used_after_gc, used(), minimum_desired_capacity, MinHeapFreeRatio);
1229 
1230     expand(expand_bytes, _workers);
1231 
1232     // No expansion, now see if we want to shrink
1233   } else if (capacity_after_gc &gt; maximum_desired_capacity) {
1234     // Capacity too large, compute shrinking size
1235     size_t shrink_bytes = capacity_after_gc - maximum_desired_capacity;
1236 
1237     log_debug(gc, ergo, heap)(&quot;Attempt heap shrinking (capacity higher than max desired capacity). &quot;
1238                               &quot;Capacity: &quot; SIZE_FORMAT &quot;B occupancy: &quot; SIZE_FORMAT &quot;B live: &quot; SIZE_FORMAT &quot;B &quot;
1239                               &quot;maximum_desired_capacity: &quot; SIZE_FORMAT &quot;B (&quot; UINTX_FORMAT &quot; %%)&quot;,
1240                               capacity_after_gc, used_after_gc, used(), maximum_desired_capacity, MaxHeapFreeRatio);
1241 
1242     shrink(shrink_bytes);
1243   }
1244 }
1245 
1246 HeapWord* G1CollectedHeap::satisfy_failed_allocation_helper(size_t word_size,
1247                                                             bool do_gc,
1248                                                             bool clear_all_soft_refs,
1249                                                             bool expect_null_mutator_alloc_region,
1250                                                             bool* gc_succeeded) {
1251   *gc_succeeded = true;
1252   // Let&#39;s attempt the allocation first.
1253   HeapWord* result =
1254     attempt_allocation_at_safepoint(word_size,
1255                                     expect_null_mutator_alloc_region);
1256   if (result != NULL) {
1257     return result;
1258   }
1259 
1260   // In a G1 heap, we&#39;re supposed to keep allocation from failing by
1261   // incremental pauses.  Therefore, at least for now, we&#39;ll favor
1262   // expansion over collection.  (This might change in the future if we can
1263   // do something smarter than full collection to satisfy a failed alloc.)
1264   result = expand_and_allocate(word_size);
1265   if (result != NULL) {
1266     return result;
1267   }
1268 
1269   if (do_gc) {
1270     // Expansion didn&#39;t work, we&#39;ll try to do a Full GC.
1271     *gc_succeeded = do_full_collection(false, /* explicit_gc */
1272                                        clear_all_soft_refs);
1273   }
1274 
1275   return NULL;
1276 }
1277 
1278 HeapWord* G1CollectedHeap::satisfy_failed_allocation(size_t word_size,
1279                                                      bool* succeeded) {
1280   assert_at_safepoint_on_vm_thread();
1281 
1282   // Attempts to allocate followed by Full GC.
1283   HeapWord* result =
1284     satisfy_failed_allocation_helper(word_size,
1285                                      true,  /* do_gc */
1286                                      false, /* clear_all_soft_refs */
1287                                      false, /* expect_null_mutator_alloc_region */
1288                                      succeeded);
1289 
1290   if (result != NULL || !*succeeded) {
1291     return result;
1292   }
1293 
1294   // Attempts to allocate followed by Full GC that will collect all soft references.
1295   result = satisfy_failed_allocation_helper(word_size,
1296                                             true, /* do_gc */
1297                                             true, /* clear_all_soft_refs */
1298                                             true, /* expect_null_mutator_alloc_region */
1299                                             succeeded);
1300 
1301   if (result != NULL || !*succeeded) {
1302     return result;
1303   }
1304 
1305   // Attempts to allocate, no GC
1306   result = satisfy_failed_allocation_helper(word_size,
1307                                             false, /* do_gc */
1308                                             false, /* clear_all_soft_refs */
1309                                             true,  /* expect_null_mutator_alloc_region */
1310                                             succeeded);
1311 
1312   if (result != NULL) {
1313     return result;
1314   }
1315 
1316   assert(!soft_ref_policy()-&gt;should_clear_all_soft_refs(),
1317          &quot;Flag should have been handled and cleared prior to this point&quot;);
1318 
1319   // What else?  We might try synchronous finalization later.  If the total
1320   // space available is large enough for the allocation, then a more
1321   // complete compaction phase than we&#39;ve tried so far might be
1322   // appropriate.
1323   return NULL;
1324 }
1325 
1326 // Attempting to expand the heap sufficiently
1327 // to support an allocation of the given &quot;word_size&quot;.  If
1328 // successful, perform the allocation and return the address of the
1329 // allocated block, or else &quot;NULL&quot;.
1330 
1331 HeapWord* G1CollectedHeap::expand_and_allocate(size_t word_size) {
1332   assert_at_safepoint_on_vm_thread();
1333 
1334   _verifier-&gt;verify_region_sets_optional();
1335 
1336   size_t expand_bytes = MAX2(word_size * HeapWordSize, MinHeapDeltaBytes);
1337   log_debug(gc, ergo, heap)(&quot;Attempt heap expansion (allocation request failed). Allocation request: &quot; SIZE_FORMAT &quot;B&quot;,
1338                             word_size * HeapWordSize);
1339 
1340 
1341   if (expand(expand_bytes, _workers)) {
1342     _hrm-&gt;verify_optional();
1343     _verifier-&gt;verify_region_sets_optional();
1344     return attempt_allocation_at_safepoint(word_size,
1345                                            false /* expect_null_mutator_alloc_region */);
1346   }
1347   return NULL;
1348 }
1349 
1350 bool G1CollectedHeap::expand(size_t expand_bytes, WorkGang* pretouch_workers, double* expand_time_ms) {
1351   size_t aligned_expand_bytes = ReservedSpace::page_align_size_up(expand_bytes);
1352   aligned_expand_bytes = align_up(aligned_expand_bytes,
1353                                        HeapRegion::GrainBytes);
1354 
1355   log_debug(gc, ergo, heap)(&quot;Expand the heap. requested expansion amount: &quot; SIZE_FORMAT &quot;B expansion amount: &quot; SIZE_FORMAT &quot;B&quot;,
1356                             expand_bytes, aligned_expand_bytes);
1357 
1358   if (is_maximal_no_gc()) {
1359     log_debug(gc, ergo, heap)(&quot;Did not expand the heap (heap already fully expanded)&quot;);
1360     return false;
1361   }
1362 
1363   double expand_heap_start_time_sec = os::elapsedTime();
1364   uint regions_to_expand = (uint)(aligned_expand_bytes / HeapRegion::GrainBytes);
1365   assert(regions_to_expand &gt; 0, &quot;Must expand by at least one region&quot;);
1366 
1367   uint expanded_by = _hrm-&gt;expand_by(regions_to_expand, pretouch_workers);
1368   if (expand_time_ms != NULL) {
1369     *expand_time_ms = (os::elapsedTime() - expand_heap_start_time_sec) * MILLIUNITS;
1370   }
1371 
1372   if (expanded_by &gt; 0) {
1373     size_t actual_expand_bytes = expanded_by * HeapRegion::GrainBytes;
1374     assert(actual_expand_bytes &lt;= aligned_expand_bytes, &quot;post-condition&quot;);
1375     policy()-&gt;record_new_heap_size(num_regions());
1376   } else {
1377     log_debug(gc, ergo, heap)(&quot;Did not expand the heap (heap expansion operation failed)&quot;);
1378 
1379     // The expansion of the virtual storage space was unsuccessful.
1380     // Let&#39;s see if it was because we ran out of swap.
1381     if (G1ExitOnExpansionFailure &amp;&amp;
1382         _hrm-&gt;available() &gt;= regions_to_expand) {
1383       // We had head room...
1384       vm_exit_out_of_memory(aligned_expand_bytes, OOM_MMAP_ERROR, &quot;G1 heap expansion&quot;);
1385     }
1386   }
1387   return regions_to_expand &gt; 0;
1388 }
1389 
1390 bool G1CollectedHeap::expand_single_region(uint node_index) {
1391   uint expanded_by = _hrm-&gt;expand_on_preferred_node(node_index);
1392 
1393   if (expanded_by == 0) {
1394     assert(is_maximal_no_gc(), &quot;Should be no regions left, available: %u&quot;, _hrm-&gt;available());
1395     log_debug(gc, ergo, heap)(&quot;Did not expand the heap (heap already fully expanded)&quot;);
1396     return false;
1397   }
1398 
1399   policy()-&gt;record_new_heap_size(num_regions());
1400   return true;
1401 }
1402 
1403 void G1CollectedHeap::shrink_helper(size_t shrink_bytes) {
1404   size_t aligned_shrink_bytes =
1405     ReservedSpace::page_align_size_down(shrink_bytes);
1406   aligned_shrink_bytes = align_down(aligned_shrink_bytes,
1407                                          HeapRegion::GrainBytes);
1408   uint num_regions_to_remove = (uint)(shrink_bytes / HeapRegion::GrainBytes);
1409 
1410   uint num_regions_removed = _hrm-&gt;shrink_by(num_regions_to_remove);
1411   size_t shrunk_bytes = num_regions_removed * HeapRegion::GrainBytes;
1412 
1413   log_debug(gc, ergo, heap)(&quot;Shrink the heap. requested shrinking amount: &quot; SIZE_FORMAT &quot;B aligned shrinking amount: &quot; SIZE_FORMAT &quot;B attempted shrinking amount: &quot; SIZE_FORMAT &quot;B&quot;,
1414                             shrink_bytes, aligned_shrink_bytes, shrunk_bytes);
1415   if (num_regions_removed &gt; 0) {
1416     policy()-&gt;record_new_heap_size(num_regions());
1417   } else {
1418     log_debug(gc, ergo, heap)(&quot;Did not expand the heap (heap shrinking operation failed)&quot;);
1419   }
1420 }
1421 
1422 void G1CollectedHeap::shrink(size_t shrink_bytes) {
1423   _verifier-&gt;verify_region_sets_optional();
1424 
1425   // We should only reach here at the end of a Full GC or during Remark which
1426   // means we should not not be holding to any GC alloc regions. The method
1427   // below will make sure of that and do any remaining clean up.
1428   _allocator-&gt;abandon_gc_alloc_regions();
1429 
1430   // Instead of tearing down / rebuilding the free lists here, we
1431   // could instead use the remove_all_pending() method on free_list to
1432   // remove only the ones that we need to remove.
1433   tear_down_region_sets(true /* free_list_only */);
1434   shrink_helper(shrink_bytes);
1435   rebuild_region_sets(true /* free_list_only */);
1436 
1437   _hrm-&gt;verify_optional();
1438   _verifier-&gt;verify_region_sets_optional();
1439 }
1440 
1441 class OldRegionSetChecker : public HeapRegionSetChecker {
1442 public:
1443   void check_mt_safety() {
1444     // Master Old Set MT safety protocol:
1445     // (a) If we&#39;re at a safepoint, operations on the master old set
1446     // should be invoked:
1447     // - by the VM thread (which will serialize them), or
1448     // - by the GC workers while holding the FreeList_lock, if we&#39;re
1449     //   at a safepoint for an evacuation pause (this lock is taken
1450     //   anyway when an GC alloc region is retired so that a new one
1451     //   is allocated from the free list), or
1452     // - by the GC workers while holding the OldSets_lock, if we&#39;re at a
1453     //   safepoint for a cleanup pause.
1454     // (b) If we&#39;re not at a safepoint, operations on the master old set
1455     // should be invoked while holding the Heap_lock.
1456 
1457     if (SafepointSynchronize::is_at_safepoint()) {
1458       guarantee(Thread::current()-&gt;is_VM_thread() ||
1459                 FreeList_lock-&gt;owned_by_self() || OldSets_lock-&gt;owned_by_self(),
1460                 &quot;master old set MT safety protocol at a safepoint&quot;);
1461     } else {
1462       guarantee(Heap_lock-&gt;owned_by_self(), &quot;master old set MT safety protocol outside a safepoint&quot;);
1463     }
1464   }
1465   bool is_correct_type(HeapRegion* hr) { return hr-&gt;is_old(); }
1466   const char* get_description() { return &quot;Old Regions&quot;; }
1467 };
1468 
1469 class ArchiveRegionSetChecker : public HeapRegionSetChecker {
1470 public:
1471   void check_mt_safety() {
1472     guarantee(!Universe::is_fully_initialized() || SafepointSynchronize::is_at_safepoint(),
1473               &quot;May only change archive regions during initialization or safepoint.&quot;);
1474   }
1475   bool is_correct_type(HeapRegion* hr) { return hr-&gt;is_archive(); }
1476   const char* get_description() { return &quot;Archive Regions&quot;; }
1477 };
1478 
1479 class HumongousRegionSetChecker : public HeapRegionSetChecker {
1480 public:
1481   void check_mt_safety() {
1482     // Humongous Set MT safety protocol:
1483     // (a) If we&#39;re at a safepoint, operations on the master humongous
1484     // set should be invoked by either the VM thread (which will
1485     // serialize them) or by the GC workers while holding the
1486     // OldSets_lock.
1487     // (b) If we&#39;re not at a safepoint, operations on the master
1488     // humongous set should be invoked while holding the Heap_lock.
1489 
1490     if (SafepointSynchronize::is_at_safepoint()) {
1491       guarantee(Thread::current()-&gt;is_VM_thread() ||
1492                 OldSets_lock-&gt;owned_by_self(),
1493                 &quot;master humongous set MT safety protocol at a safepoint&quot;);
1494     } else {
1495       guarantee(Heap_lock-&gt;owned_by_self(),
1496                 &quot;master humongous set MT safety protocol outside a safepoint&quot;);
1497     }
1498   }
1499   bool is_correct_type(HeapRegion* hr) { return hr-&gt;is_humongous(); }
1500   const char* get_description() { return &quot;Humongous Regions&quot;; }
1501 };
1502 
1503 G1CollectedHeap::G1CollectedHeap() :
1504   CollectedHeap(),
1505   _young_gen_sampling_thread(NULL),
1506   _workers(NULL),
1507   _card_table(NULL),
1508   _soft_ref_policy(),
1509   _old_set(&quot;Old Region Set&quot;, new OldRegionSetChecker()),
1510   _archive_set(&quot;Archive Region Set&quot;, new ArchiveRegionSetChecker()),
1511   _humongous_set(&quot;Humongous Region Set&quot;, new HumongousRegionSetChecker()),
1512   _bot(NULL),
1513   _listener(),
1514   _numa(G1NUMA::create()),
1515   _hrm(NULL),
1516   _allocator(NULL),
1517   _verifier(NULL),
1518   _summary_bytes_used(0),
1519   _bytes_used_during_gc(0),
1520   _archive_allocator(NULL),
1521   _survivor_evac_stats(&quot;Young&quot;, YoungPLABSize, PLABWeight),
1522   _old_evac_stats(&quot;Old&quot;, OldPLABSize, PLABWeight),
1523   _expand_heap_after_alloc_failure(true),
1524   _g1mm(NULL),
1525   _humongous_reclaim_candidates(),
1526   _has_humongous_reclaim_candidates(false),
1527   _hr_printer(),
1528   _collector_state(),
1529   _old_marking_cycles_started(0),
1530   _old_marking_cycles_completed(0),
1531   _eden(),
1532   _survivor(),
1533   _gc_timer_stw(new (ResourceObj::C_HEAP, mtGC) STWGCTimer()),
1534   _gc_tracer_stw(new (ResourceObj::C_HEAP, mtGC) G1NewTracer()),
1535   _policy(G1Policy::create_policy(_gc_timer_stw)),
1536   _heap_sizing_policy(NULL),
1537   _collection_set(this, _policy),
1538   _hot_card_cache(NULL),
1539   _rem_set(NULL),
1540   _cm(NULL),
1541   _cm_thread(NULL),
1542   _cr(NULL),
1543   _task_queues(NULL),
1544   _evacuation_failed(false),
1545   _evacuation_failed_info_array(NULL),
1546   _preserved_marks_set(true /* in_c_heap */),
1547 #ifndef PRODUCT
1548   _evacuation_failure_alot_for_current_gc(false),
1549   _evacuation_failure_alot_gc_number(0),
1550   _evacuation_failure_alot_count(0),
1551 #endif
1552   _ref_processor_stw(NULL),
1553   _is_alive_closure_stw(this),
1554   _is_subject_to_discovery_stw(this),
1555   _ref_processor_cm(NULL),
1556   _is_alive_closure_cm(this),
1557   _is_subject_to_discovery_cm(this),
1558   _region_attr() {
1559 
1560   _verifier = new G1HeapVerifier(this);
1561 
1562   _allocator = new G1Allocator(this);
1563 
1564   _heap_sizing_policy = G1HeapSizingPolicy::create(this, _policy-&gt;analytics());
1565 
1566   _humongous_object_threshold_in_words = humongous_threshold_for(HeapRegion::GrainWords);
1567 
1568   // Override the default _filler_array_max_size so that no humongous filler
1569   // objects are created.
1570   _filler_array_max_size = _humongous_object_threshold_in_words;
1571 
1572   uint n_queues = ParallelGCThreads;
1573   _task_queues = new RefToScanQueueSet(n_queues);
1574 
1575   _evacuation_failed_info_array = NEW_C_HEAP_ARRAY(EvacuationFailedInfo, n_queues, mtGC);
1576 
1577   for (uint i = 0; i &lt; n_queues; i++) {
1578     RefToScanQueue* q = new RefToScanQueue();
1579     q-&gt;initialize();
1580     _task_queues-&gt;register_queue(i, q);
1581     ::new (&amp;_evacuation_failed_info_array[i]) EvacuationFailedInfo();
1582   }
1583 
1584   // Initialize the G1EvacuationFailureALot counters and flags.
1585   NOT_PRODUCT(reset_evacuation_should_fail();)
1586   _gc_tracer_stw-&gt;initialize();
1587 
1588   guarantee(_task_queues != NULL, &quot;task_queues allocation failure.&quot;);
1589 }
1590 
1591 static size_t actual_reserved_page_size(ReservedSpace rs) {
1592   size_t page_size = os::vm_page_size();
1593   if (UseLargePages) {
1594     // There are two ways to manage large page memory.
1595     // 1. OS supports committing large page memory.
1596     // 2. OS doesn&#39;t support committing large page memory so ReservedSpace manages it.
1597     //    And ReservedSpace calls it &#39;special&#39;. If we failed to set &#39;special&#39;,
1598     //    we reserved memory without large page.
1599     if (os::can_commit_large_page_memory() || rs.special()) {
1600       // An alignment at ReservedSpace comes from preferred page size or
1601       // heap alignment, and if the alignment came from heap alignment, it could be
1602       // larger than large pages size. So need to cap with the large page size.
1603       page_size = MIN2(rs.alignment(), os::large_page_size());
1604     }
1605   }
1606 
1607   return page_size;
1608 }
1609 
1610 G1RegionToSpaceMapper* G1CollectedHeap::create_aux_memory_mapper(const char* description,
1611                                                                  size_t size,
1612                                                                  size_t translation_factor) {
1613   size_t preferred_page_size = os::page_size_for_region_unaligned(size, 1);
1614   // Allocate a new reserved space, preferring to use large pages.
1615   ReservedSpace rs(size, preferred_page_size);
1616   size_t page_size = actual_reserved_page_size(rs);
1617   G1RegionToSpaceMapper* result  =
1618     G1RegionToSpaceMapper::create_mapper(rs,
1619                                          size,
1620                                          page_size,
1621                                          HeapRegion::GrainBytes,
1622                                          translation_factor,
1623                                          mtGC);
1624 
1625   os::trace_page_sizes_for_requested_size(description,
1626                                           size,
1627                                           preferred_page_size,
1628                                           page_size,
1629                                           rs.base(),
1630                                           rs.size());
1631 
1632   return result;
1633 }
1634 
1635 jint G1CollectedHeap::initialize_concurrent_refinement() {
1636   jint ecode = JNI_OK;
1637   _cr = G1ConcurrentRefine::create(&amp;ecode);
1638   return ecode;
1639 }
1640 
1641 jint G1CollectedHeap::initialize_young_gen_sampling_thread() {
1642   _young_gen_sampling_thread = new G1YoungRemSetSamplingThread();
1643   if (_young_gen_sampling_thread-&gt;osthread() == NULL) {
1644     vm_shutdown_during_initialization(&quot;Could not create G1YoungRemSetSamplingThread&quot;);
1645     return JNI_ENOMEM;
1646   }
1647   return JNI_OK;
1648 }
1649 
1650 jint G1CollectedHeap::initialize() {
1651 
1652   // Necessary to satisfy locking discipline assertions.
1653 
1654   MutexLocker x(Heap_lock);
1655 
1656   // While there are no constraints in the GC code that HeapWordSize
1657   // be any particular value, there are multiple other areas in the
1658   // system which believe this to be true (e.g. oop-&gt;object_size in some
1659   // cases incorrectly returns the size in wordSize units rather than
1660   // HeapWordSize).
1661   guarantee(HeapWordSize == wordSize, &quot;HeapWordSize must equal wordSize&quot;);
1662 
1663   size_t init_byte_size = InitialHeapSize;
1664   size_t reserved_byte_size = G1Arguments::heap_reserved_size_bytes();
1665 
1666   // Ensure that the sizes are properly aligned.
1667   Universe::check_alignment(init_byte_size, HeapRegion::GrainBytes, &quot;g1 heap&quot;);
1668   Universe::check_alignment(reserved_byte_size, HeapRegion::GrainBytes, &quot;g1 heap&quot;);
1669   Universe::check_alignment(reserved_byte_size, HeapAlignment, &quot;g1 heap&quot;);
1670 
1671   // Reserve the maximum.
1672 
1673   // When compressed oops are enabled, the preferred heap base
1674   // is calculated by subtracting the requested size from the
1675   // 32Gb boundary and using the result as the base address for
1676   // heap reservation. If the requested size is not aligned to
1677   // HeapRegion::GrainBytes (i.e. the alignment that is passed
1678   // into the ReservedHeapSpace constructor) then the actual
1679   // base of the reserved heap may end up differing from the
1680   // address that was requested (i.e. the preferred heap base).
1681   // If this happens then we could end up using a non-optimal
1682   // compressed oops mode.
1683 
1684   ReservedHeapSpace heap_rs = Universe::reserve_heap(reserved_byte_size,
1685                                                      HeapAlignment);
1686 
1687   initialize_reserved_region(heap_rs);
1688 
1689   // Create the barrier set for the entire reserved region.
1690   G1CardTable* ct = new G1CardTable(heap_rs.region());
1691   ct-&gt;initialize();
1692   G1BarrierSet* bs = new G1BarrierSet(ct);
1693   bs-&gt;initialize();
1694   assert(bs-&gt;is_a(BarrierSet::G1BarrierSet), &quot;sanity&quot;);
1695   BarrierSet::set_barrier_set(bs);
1696   _card_table = ct;
1697 
1698   {
1699     G1SATBMarkQueueSet&amp; satbqs = bs-&gt;satb_mark_queue_set();
1700     satbqs.set_process_completed_buffers_threshold(G1SATBProcessCompletedThreshold);
1701     satbqs.set_buffer_enqueue_threshold_percentage(G1SATBBufferEnqueueingThresholdPercent);
1702   }
1703 
1704   // Create the hot card cache.
1705   _hot_card_cache = new G1HotCardCache(this);
1706 
1707   // Carve out the G1 part of the heap.
1708   ReservedSpace g1_rs = heap_rs.first_part(reserved_byte_size);
1709   size_t page_size = actual_reserved_page_size(heap_rs);
1710   G1RegionToSpaceMapper* heap_storage =
1711     G1RegionToSpaceMapper::create_heap_mapper(g1_rs,
1712                                               g1_rs.size(),
1713                                               page_size,
1714                                               HeapRegion::GrainBytes,
1715                                               1,
1716                                               mtJavaHeap);
1717   if(heap_storage == NULL) {
1718     vm_shutdown_during_initialization(&quot;Could not initialize G1 heap&quot;);
1719     return JNI_ERR;
1720   }
1721 
1722   os::trace_page_sizes(&quot;Heap&quot;,
1723                        MinHeapSize,
1724                        reserved_byte_size,
1725                        page_size,
1726                        heap_rs.base(),
1727                        heap_rs.size());
1728   heap_storage-&gt;set_mapping_changed_listener(&amp;_listener);
1729 
1730   // Create storage for the BOT, card table, card counts table (hot card cache) and the bitmaps.
1731   G1RegionToSpaceMapper* bot_storage =
1732     create_aux_memory_mapper(&quot;Block Offset Table&quot;,
1733                              G1BlockOffsetTable::compute_size(g1_rs.size() / HeapWordSize),
1734                              G1BlockOffsetTable::heap_map_factor());
1735 
1736   G1RegionToSpaceMapper* cardtable_storage =
1737     create_aux_memory_mapper(&quot;Card Table&quot;,
1738                              G1CardTable::compute_size(g1_rs.size() / HeapWordSize),
1739                              G1CardTable::heap_map_factor());
1740 
1741   G1RegionToSpaceMapper* card_counts_storage =
1742     create_aux_memory_mapper(&quot;Card Counts Table&quot;,
1743                              G1CardCounts::compute_size(g1_rs.size() / HeapWordSize),
1744                              G1CardCounts::heap_map_factor());
1745 
1746   size_t bitmap_size = G1CMBitMap::compute_size(g1_rs.size());
1747   G1RegionToSpaceMapper* prev_bitmap_storage =
1748     create_aux_memory_mapper(&quot;Prev Bitmap&quot;, bitmap_size, G1CMBitMap::heap_map_factor());
1749   G1RegionToSpaceMapper* next_bitmap_storage =
1750     create_aux_memory_mapper(&quot;Next Bitmap&quot;, bitmap_size, G1CMBitMap::heap_map_factor());
1751 
1752   _hrm = HeapRegionManager::create_manager(this);
1753 
1754   _hrm-&gt;initialize(heap_storage, prev_bitmap_storage, next_bitmap_storage, bot_storage, cardtable_storage, card_counts_storage);
1755   _card_table-&gt;initialize(cardtable_storage);
1756 
1757   // Do later initialization work for concurrent refinement.
1758   _hot_card_cache-&gt;initialize(card_counts_storage);
1759 
1760   // 6843694 - ensure that the maximum region index can fit
1761   // in the remembered set structures.
1762   const uint max_region_idx = (1U &lt;&lt; (sizeof(RegionIdx_t)*BitsPerByte-1)) - 1;
1763   guarantee((max_regions() - 1) &lt;= max_region_idx, &quot;too many regions&quot;);
1764 
1765   // The G1FromCardCache reserves card with value 0 as &quot;invalid&quot;, so the heap must not
1766   // start within the first card.
1767   guarantee(g1_rs.base() &gt;= (char*)G1CardTable::card_size, &quot;Java heap must not start within the first card.&quot;);
1768   // Also create a G1 rem set.
1769   _rem_set = new G1RemSet(this, _card_table, _hot_card_cache);
1770   _rem_set-&gt;initialize(max_reserved_capacity(), max_regions());
1771 
1772   size_t max_cards_per_region = ((size_t)1 &lt;&lt; (sizeof(CardIdx_t)*BitsPerByte-1)) - 1;
1773   guarantee(HeapRegion::CardsPerRegion &gt; 0, &quot;make sure it&#39;s initialized&quot;);
1774   guarantee(HeapRegion::CardsPerRegion &lt; max_cards_per_region,
1775             &quot;too many cards per region&quot;);
1776 
1777   FreeRegionList::set_unrealistically_long_length(max_expandable_regions() + 1);
1778 
1779   _bot = new G1BlockOffsetTable(reserved_region(), bot_storage);
1780 
1781   {
1782     HeapWord* start = _hrm-&gt;reserved().start();
1783     HeapWord* end = _hrm-&gt;reserved().end();
1784     size_t granularity = HeapRegion::GrainBytes;
1785 
1786     _region_attr.initialize(start, end, granularity);
1787     _humongous_reclaim_candidates.initialize(start, end, granularity);
1788   }
1789 
1790   _workers = new WorkGang(&quot;GC Thread&quot;, ParallelGCThreads,
1791                           true /* are_GC_task_threads */,
1792                           false /* are_ConcurrentGC_threads */);
1793   if (_workers == NULL) {
1794     return JNI_ENOMEM;
1795   }
1796   _workers-&gt;initialize_workers();
1797 
1798   _numa-&gt;set_region_info(HeapRegion::GrainBytes, page_size);
1799 
1800   // Create the G1ConcurrentMark data structure and thread.
1801   // (Must do this late, so that &quot;max_regions&quot; is defined.)
1802   _cm = new G1ConcurrentMark(this, prev_bitmap_storage, next_bitmap_storage);
1803   _cm_thread = _cm-&gt;cm_thread();
1804 
1805   // Now expand into the initial heap size.
1806   if (!expand(init_byte_size, _workers)) {
1807     vm_shutdown_during_initialization(&quot;Failed to allocate initial heap.&quot;);
1808     return JNI_ENOMEM;
1809   }
1810 
1811   // Perform any initialization actions delegated to the policy.
1812   policy()-&gt;init(this, &amp;_collection_set);
1813 
1814   jint ecode = initialize_concurrent_refinement();
1815   if (ecode != JNI_OK) {
1816     return ecode;
1817   }
1818 
1819   ecode = initialize_young_gen_sampling_thread();
1820   if (ecode != JNI_OK) {
1821     return ecode;
1822   }
1823 
1824   {
1825     G1DirtyCardQueueSet&amp; dcqs = G1BarrierSet::dirty_card_queue_set();
1826     dcqs.set_process_cards_threshold(concurrent_refine()-&gt;yellow_zone());
1827     dcqs.set_max_cards(concurrent_refine()-&gt;red_zone());
1828   }
1829 
1830   // Here we allocate the dummy HeapRegion that is required by the
1831   // G1AllocRegion class.
1832   HeapRegion* dummy_region = _hrm-&gt;get_dummy_region();
1833 
1834   // We&#39;ll re-use the same region whether the alloc region will
1835   // require BOT updates or not and, if it doesn&#39;t, then a non-young
1836   // region will complain that it cannot support allocations without
1837   // BOT updates. So we&#39;ll tag the dummy region as eden to avoid that.
1838   dummy_region-&gt;set_eden();
1839   // Make sure it&#39;s full.
1840   dummy_region-&gt;set_top(dummy_region-&gt;end());
1841   G1AllocRegion::setup(this, dummy_region);
1842 
1843   _allocator-&gt;init_mutator_alloc_regions();
1844 
1845   // Do create of the monitoring and management support so that
1846   // values in the heap have been properly initialized.
1847   _g1mm = new G1MonitoringSupport(this);
1848 
1849   G1StringDedup::initialize();
1850 
1851   _preserved_marks_set.init(ParallelGCThreads);
1852 
1853   _collection_set.initialize(max_regions());
1854 
1855   return JNI_OK;
1856 }
1857 
1858 void G1CollectedHeap::stop() {
1859   // Stop all concurrent threads. We do this to make sure these threads
1860   // do not continue to execute and access resources (e.g. logging)
1861   // that are destroyed during shutdown.
1862   _cr-&gt;stop();
1863   _young_gen_sampling_thread-&gt;stop();
1864   _cm_thread-&gt;stop();
1865   if (G1StringDedup::is_enabled()) {
1866     G1StringDedup::stop();
1867   }
1868 }
1869 
1870 void G1CollectedHeap::safepoint_synchronize_begin() {
1871   SuspendibleThreadSet::synchronize();
1872 }
1873 
1874 void G1CollectedHeap::safepoint_synchronize_end() {
1875   SuspendibleThreadSet::desynchronize();
1876 }
1877 
1878 void G1CollectedHeap::post_initialize() {
1879   CollectedHeap::post_initialize();
1880   ref_processing_init();
1881 }
1882 
1883 void G1CollectedHeap::ref_processing_init() {
1884   // Reference processing in G1 currently works as follows:
1885   //
1886   // * There are two reference processor instances. One is
1887   //   used to record and process discovered references
1888   //   during concurrent marking; the other is used to
1889   //   record and process references during STW pauses
1890   //   (both full and incremental).
1891   // * Both ref processors need to &#39;span&#39; the entire heap as
1892   //   the regions in the collection set may be dotted around.
1893   //
1894   // * For the concurrent marking ref processor:
1895   //   * Reference discovery is enabled at initial marking.
1896   //   * Reference discovery is disabled and the discovered
1897   //     references processed etc during remarking.
1898   //   * Reference discovery is MT (see below).
1899   //   * Reference discovery requires a barrier (see below).
1900   //   * Reference processing may or may not be MT
1901   //     (depending on the value of ParallelRefProcEnabled
1902   //     and ParallelGCThreads).
1903   //   * A full GC disables reference discovery by the CM
1904   //     ref processor and abandons any entries on it&#39;s
1905   //     discovered lists.
1906   //
1907   // * For the STW processor:
1908   //   * Non MT discovery is enabled at the start of a full GC.
1909   //   * Processing and enqueueing during a full GC is non-MT.
1910   //   * During a full GC, references are processed after marking.
1911   //
1912   //   * Discovery (may or may not be MT) is enabled at the start
1913   //     of an incremental evacuation pause.
1914   //   * References are processed near the end of a STW evacuation pause.
1915   //   * For both types of GC:
1916   //     * Discovery is atomic - i.e. not concurrent.
1917   //     * Reference discovery will not need a barrier.
1918 
1919   bool mt_processing = ParallelRefProcEnabled &amp;&amp; (ParallelGCThreads &gt; 1);
1920 
1921   // Concurrent Mark ref processor
1922   _ref_processor_cm =
1923     new ReferenceProcessor(&amp;_is_subject_to_discovery_cm,
1924                            mt_processing,                                  // mt processing
1925                            ParallelGCThreads,                              // degree of mt processing
1926                            (ParallelGCThreads &gt; 1) || (ConcGCThreads &gt; 1), // mt discovery
1927                            MAX2(ParallelGCThreads, ConcGCThreads),         // degree of mt discovery
1928                            false,                                          // Reference discovery is not atomic
1929                            &amp;_is_alive_closure_cm,                          // is alive closure
1930                            true);                                          // allow changes to number of processing threads
1931 
1932   // STW ref processor
1933   _ref_processor_stw =
1934     new ReferenceProcessor(&amp;_is_subject_to_discovery_stw,
1935                            mt_processing,                        // mt processing
1936                            ParallelGCThreads,                    // degree of mt processing
1937                            (ParallelGCThreads &gt; 1),              // mt discovery
1938                            ParallelGCThreads,                    // degree of mt discovery
1939                            true,                                 // Reference discovery is atomic
1940                            &amp;_is_alive_closure_stw,               // is alive closure
1941                            true);                                // allow changes to number of processing threads
1942 }
1943 
1944 SoftRefPolicy* G1CollectedHeap::soft_ref_policy() {
1945   return &amp;_soft_ref_policy;
1946 }
1947 
1948 size_t G1CollectedHeap::capacity() const {
1949   return _hrm-&gt;length() * HeapRegion::GrainBytes;
1950 }
1951 
1952 size_t G1CollectedHeap::unused_committed_regions_in_bytes() const {
1953   return _hrm-&gt;total_free_bytes();
1954 }
1955 
1956 void G1CollectedHeap::iterate_hcc_closure(G1CardTableEntryClosure* cl, uint worker_id) {
1957   _hot_card_cache-&gt;drain(cl, worker_id);
1958 }
1959 
1960 // Computes the sum of the storage used by the various regions.
1961 size_t G1CollectedHeap::used() const {
1962   size_t result = _summary_bytes_used + _allocator-&gt;used_in_alloc_regions();
1963   if (_archive_allocator != NULL) {
1964     result += _archive_allocator-&gt;used();
1965   }
1966   return result;
1967 }
1968 
1969 size_t G1CollectedHeap::used_unlocked() const {
1970   return _summary_bytes_used;
1971 }
1972 
1973 class SumUsedClosure: public HeapRegionClosure {
1974   size_t _used;
1975 public:
1976   SumUsedClosure() : _used(0) {}
1977   bool do_heap_region(HeapRegion* r) {
1978     _used += r-&gt;used();
1979     return false;
1980   }
1981   size_t result() { return _used; }
1982 };
1983 
1984 size_t G1CollectedHeap::recalculate_used() const {
1985   SumUsedClosure blk;
1986   heap_region_iterate(&amp;blk);
1987   return blk.result();
1988 }
1989 
1990 bool  G1CollectedHeap::is_user_requested_concurrent_full_gc(GCCause::Cause cause) {
1991   switch (cause) {
1992     case GCCause::_java_lang_system_gc:                 return ExplicitGCInvokesConcurrent;
1993     case GCCause::_dcmd_gc_run:                         return ExplicitGCInvokesConcurrent;
1994     case GCCause::_wb_conc_mark:                        return true;
1995     default :                                           return false;
1996   }
1997 }
1998 
1999 bool G1CollectedHeap::should_do_concurrent_full_gc(GCCause::Cause cause) {
2000   switch (cause) {
2001     case GCCause::_g1_humongous_allocation: return true;
2002     case GCCause::_g1_periodic_collection:  return G1PeriodicGCInvokesConcurrent;
2003     case GCCause::_wb_breakpoint:           return true;
2004     default:                                return is_user_requested_concurrent_full_gc(cause);
2005   }
2006 }
2007 
2008 bool G1CollectedHeap::should_upgrade_to_full_gc(GCCause::Cause cause) {
2009   if (policy()-&gt;force_upgrade_to_full()) {
2010     return true;
2011   } else if (should_do_concurrent_full_gc(_gc_cause)) {
2012     return false;
2013   } else if (has_regions_left_for_allocation()) {
2014     return false;
2015   } else {
2016     return true;
2017   }
2018 }
2019 
2020 #ifndef PRODUCT
2021 void G1CollectedHeap::allocate_dummy_regions() {
2022   // Let&#39;s fill up most of the region
2023   size_t word_size = HeapRegion::GrainWords - 1024;
2024   // And as a result the region we&#39;ll allocate will be humongous.
2025   guarantee(is_humongous(word_size), &quot;sanity&quot;);
2026 
2027   // _filler_array_max_size is set to humongous object threshold
2028   // but temporarily change it to use CollectedHeap::fill_with_object().
2029   SizeTFlagSetting fs(_filler_array_max_size, word_size);
2030 
2031   for (uintx i = 0; i &lt; G1DummyRegionsPerGC; ++i) {
2032     // Let&#39;s use the existing mechanism for the allocation
2033     HeapWord* dummy_obj = humongous_obj_allocate(word_size);
2034     if (dummy_obj != NULL) {
2035       MemRegion mr(dummy_obj, word_size);
2036       CollectedHeap::fill_with_object(mr);
2037     } else {
2038       // If we can&#39;t allocate once, we probably cannot allocate
2039       // again. Let&#39;s get out of the loop.
2040       break;
2041     }
2042   }
2043 }
2044 #endif // !PRODUCT
2045 
2046 void G1CollectedHeap::increment_old_marking_cycles_started() {
2047   assert(_old_marking_cycles_started == _old_marking_cycles_completed ||
2048          _old_marking_cycles_started == _old_marking_cycles_completed + 1,
2049          &quot;Wrong marking cycle count (started: %d, completed: %d)&quot;,
2050          _old_marking_cycles_started, _old_marking_cycles_completed);
2051 
2052   _old_marking_cycles_started++;
2053 }
2054 
2055 void G1CollectedHeap::increment_old_marking_cycles_completed(bool concurrent) {
2056   MonitorLocker ml(G1OldGCCount_lock, Mutex::_no_safepoint_check_flag);
2057 
2058   // We assume that if concurrent == true, then the caller is a
2059   // concurrent thread that was joined the Suspendible Thread
2060   // Set. If there&#39;s ever a cheap way to check this, we should add an
2061   // assert here.
2062 
2063   // Given that this method is called at the end of a Full GC or of a
2064   // concurrent cycle, and those can be nested (i.e., a Full GC can
2065   // interrupt a concurrent cycle), the number of full collections
2066   // completed should be either one (in the case where there was no
2067   // nesting) or two (when a Full GC interrupted a concurrent cycle)
2068   // behind the number of full collections started.
2069 
2070   // This is the case for the inner caller, i.e. a Full GC.
2071   assert(concurrent ||
2072          (_old_marking_cycles_started == _old_marking_cycles_completed + 1) ||
2073          (_old_marking_cycles_started == _old_marking_cycles_completed + 2),
2074          &quot;for inner caller (Full GC): _old_marking_cycles_started = %u &quot;
2075          &quot;is inconsistent with _old_marking_cycles_completed = %u&quot;,
2076          _old_marking_cycles_started, _old_marking_cycles_completed);
2077 
2078   // This is the case for the outer caller, i.e. the concurrent cycle.
2079   assert(!concurrent ||
2080          (_old_marking_cycles_started == _old_marking_cycles_completed + 1),
2081          &quot;for outer caller (concurrent cycle): &quot;
2082          &quot;_old_marking_cycles_started = %u &quot;
2083          &quot;is inconsistent with _old_marking_cycles_completed = %u&quot;,
2084          _old_marking_cycles_started, _old_marking_cycles_completed);
2085 
2086   _old_marking_cycles_completed += 1;
2087 
2088   // We need to clear the &quot;in_progress&quot; flag in the CM thread before
2089   // we wake up any waiters (especially when ExplicitInvokesConcurrent
2090   // is set) so that if a waiter requests another System.gc() it doesn&#39;t
2091   // incorrectly see that a marking cycle is still in progress.
2092   if (concurrent) {
2093     _cm_thread-&gt;set_idle();
2094   }
2095 
2096   // Notify threads waiting in System.gc() (with ExplicitGCInvokesConcurrent)
2097   // for a full GC to finish that their wait is over.
2098   ml.notify_all();
2099 }
2100 
2101 void G1CollectedHeap::collect(GCCause::Cause cause) {
2102   try_collect(cause);
2103 }
2104 
2105 // Return true if (x &lt; y) with allowance for wraparound.
2106 static bool gc_counter_less_than(uint x, uint y) {
2107   return (x - y) &gt; (UINT_MAX/2);
2108 }
2109 
2110 // LOG_COLLECT_CONCURRENTLY(cause, msg, args...)
2111 // Macro so msg printing is format-checked.
2112 #define LOG_COLLECT_CONCURRENTLY(cause, ...)                            \
2113   do {                                                                  \
2114     LogTarget(Trace, gc) LOG_COLLECT_CONCURRENTLY_lt;                   \
2115     if (LOG_COLLECT_CONCURRENTLY_lt.is_enabled()) {                     \
2116       ResourceMark rm; /* For thread name. */                           \
2117       LogStream LOG_COLLECT_CONCURRENTLY_s(&amp;LOG_COLLECT_CONCURRENTLY_lt); \
2118       LOG_COLLECT_CONCURRENTLY_s.print(&quot;%s: Try Collect Concurrently (%s): &quot;, \
2119                                        Thread::current()-&gt;name(),       \
2120                                        GCCause::to_string(cause));      \
2121       LOG_COLLECT_CONCURRENTLY_s.print(__VA_ARGS__);                    \
2122     }                                                                   \
2123   } while (0)
2124 
2125 #define LOG_COLLECT_CONCURRENTLY_COMPLETE(cause, result) \
2126   LOG_COLLECT_CONCURRENTLY(cause, &quot;complete %s&quot;, BOOL_TO_STR(result))
2127 
2128 bool G1CollectedHeap::try_collect_concurrently(GCCause::Cause cause,
2129                                                uint gc_counter,
2130                                                uint old_marking_started_before) {
2131   assert_heap_not_locked();
2132   assert(should_do_concurrent_full_gc(cause),
2133          &quot;Non-concurrent cause %s&quot;, GCCause::to_string(cause));
2134 
2135   for (uint i = 1; true; ++i) {
2136     // Try to schedule an initial-mark evacuation pause that will
2137     // start a concurrent cycle.
2138     LOG_COLLECT_CONCURRENTLY(cause, &quot;attempt %u&quot;, i);
2139     VM_G1TryInitiateConcMark op(gc_counter,
2140                                 cause,
2141                                 policy()-&gt;max_pause_time_ms());
2142     VMThread::execute(&amp;op);
2143 
2144     // Request is trivially finished.
2145     if (cause == GCCause::_g1_periodic_collection) {
2146       LOG_COLLECT_CONCURRENTLY_COMPLETE(cause, op.gc_succeeded());
2147       return op.gc_succeeded();
2148     }
2149 
2150     // If VMOp skipped initiating concurrent marking cycle because
2151     // we&#39;re terminating, then we&#39;re done.
2152     if (op.terminating()) {
2153       LOG_COLLECT_CONCURRENTLY(cause, &quot;skipped: terminating&quot;);
2154       return false;
2155     }
2156 
2157     // Lock to get consistent set of values.
2158     uint old_marking_started_after;
2159     uint old_marking_completed_after;
2160     {
2161       MutexLocker ml(Heap_lock);
2162       // Update gc_counter for retrying VMOp if needed. Captured here to be
2163       // consistent with the values we use below for termination tests.  If
2164       // a retry is needed after a possible wait, and another collection
2165       // occurs in the meantime, it will cause our retry to be skipped and
2166       // we&#39;ll recheck for termination with updated conditions from that
2167       // more recent collection.  That&#39;s what we want, rather than having
2168       // our retry possibly perform an unnecessary collection.
2169       gc_counter = total_collections();
2170       old_marking_started_after = _old_marking_cycles_started;
2171       old_marking_completed_after = _old_marking_cycles_completed;
2172     }
2173 
2174     if (cause == GCCause::_wb_breakpoint) {
2175       if (op.gc_succeeded()) {
2176         LOG_COLLECT_CONCURRENTLY_COMPLETE(cause, true);
2177         return true;
2178       }
2179       // When _wb_breakpoint there can&#39;t be another cycle or deferred.
2180       assert(!op.cycle_already_in_progress(), &quot;invariant&quot;);
2181       assert(!op.whitebox_attached(), &quot;invariant&quot;);
2182       // Concurrent cycle attempt might have been cancelled by some other
2183       // collection, so retry.  Unlike other cases below, we want to retry
2184       // even if cancelled by a STW full collection, because we really want
2185       // to start a concurrent cycle.
2186       if (old_marking_started_before != old_marking_started_after) {
2187         LOG_COLLECT_CONCURRENTLY(cause, &quot;ignoring STW full GC&quot;);
2188         old_marking_started_before = old_marking_started_after;
2189       }
2190     } else if (!GCCause::is_user_requested_gc(cause)) {
2191       // For an &quot;automatic&quot; (not user-requested) collection, we just need to
2192       // ensure that progress is made.
2193       //
2194       // Request is finished if any of
2195       // (1) the VMOp successfully performed a GC,
2196       // (2) a concurrent cycle was already in progress,
2197       // (3) whitebox is controlling concurrent cycles,
2198       // (4) a new cycle was started (by this thread or some other), or
2199       // (5) a Full GC was performed.
2200       // Cases (4) and (5) are detected together by a change to
2201       // _old_marking_cycles_started.
2202       //
2203       // Note that (1) does not imply (4).  If we&#39;re still in the mixed
2204       // phase of an earlier concurrent collection, the request to make the
2205       // collection an initial-mark won&#39;t be honored.  If we don&#39;t check for
2206       // both conditions we&#39;ll spin doing back-to-back collections.
2207       if (op.gc_succeeded() ||
2208           op.cycle_already_in_progress() ||
2209           op.whitebox_attached() ||
2210           (old_marking_started_before != old_marking_started_after)) {
2211         LOG_COLLECT_CONCURRENTLY_COMPLETE(cause, true);
2212         return true;
2213       }
2214     } else {                    // User-requested GC.
2215       // For a user-requested collection, we want to ensure that a complete
2216       // full collection has been performed before returning, but without
2217       // waiting for more than needed.
2218 
2219       // For user-requested GCs (unlike non-UR), a successful VMOp implies a
2220       // new cycle was started.  That&#39;s good, because it&#39;s not clear what we
2221       // should do otherwise.  Trying again just does back to back GCs.
2222       // Can&#39;t wait for someone else to start a cycle.  And returning fails
2223       // to meet the goal of ensuring a full collection was performed.
2224       assert(!op.gc_succeeded() ||
2225              (old_marking_started_before != old_marking_started_after),
2226              &quot;invariant: succeeded %s, started before %u, started after %u&quot;,
2227              BOOL_TO_STR(op.gc_succeeded()),
2228              old_marking_started_before, old_marking_started_after);
2229 
2230       // Request is finished if a full collection (concurrent or stw)
2231       // was started after this request and has completed, e.g.
2232       // started_before &lt; completed_after.
2233       if (gc_counter_less_than(old_marking_started_before,
2234                                old_marking_completed_after)) {
2235         LOG_COLLECT_CONCURRENTLY_COMPLETE(cause, true);
2236         return true;
2237       }
2238 
2239       if (old_marking_started_after != old_marking_completed_after) {
2240         // If there is an in-progress cycle (possibly started by us), then
2241         // wait for that cycle to complete, e.g.
2242         // while completed_now &lt; started_after.
2243         LOG_COLLECT_CONCURRENTLY(cause, &quot;wait&quot;);
2244         MonitorLocker ml(G1OldGCCount_lock);
2245         while (gc_counter_less_than(_old_marking_cycles_completed,
2246                                     old_marking_started_after)) {
2247           ml.wait();
2248         }
2249         // Request is finished if the collection we just waited for was
2250         // started after this request.
2251         if (old_marking_started_before != old_marking_started_after) {
2252           LOG_COLLECT_CONCURRENTLY(cause, &quot;complete after wait&quot;);
2253           return true;
2254         }
2255       }
2256 
2257       // If VMOp was successful then it started a new cycle that the above
2258       // wait &amp;etc should have recognized as finishing this request.  This
2259       // differs from a non-user-request, where gc_succeeded does not imply
2260       // a new cycle was started.
2261       assert(!op.gc_succeeded(), &quot;invariant&quot;);
2262 
2263       if (op.cycle_already_in_progress()) {
2264         // If VMOp failed because a cycle was already in progress, it
2265         // is now complete.  But it didn&#39;t finish this user-requested
2266         // GC, so try again.
2267         LOG_COLLECT_CONCURRENTLY(cause, &quot;retry after in-progress&quot;);
2268         continue;
2269       } else if (op.whitebox_attached()) {
2270         // If WhiteBox wants control, wait for notification of a state
2271         // change in the controller, then try again.  Don&#39;t wait for
2272         // release of control, since collections may complete while in
2273         // control.  Note: This won&#39;t recognize a STW full collection
2274         // while waiting; we can&#39;t wait on multiple monitors.
2275         LOG_COLLECT_CONCURRENTLY(cause, &quot;whitebox control stall&quot;);
2276         MonitorLocker ml(ConcurrentGCBreakpoints::monitor());
2277         if (ConcurrentGCBreakpoints::is_controlled()) {
2278           ml.wait();
2279         }
2280         continue;
2281       }
2282     }
2283 
2284     // Collection failed and should be retried.
2285     assert(op.transient_failure(), &quot;invariant&quot;);
2286 
2287     if (GCLocker::is_active_and_needs_gc()) {
2288       // If GCLocker is active, wait until clear before retrying.
2289       LOG_COLLECT_CONCURRENTLY(cause, &quot;gc-locker stall&quot;);
2290       GCLocker::stall_until_clear();
2291     }
2292 
2293     LOG_COLLECT_CONCURRENTLY(cause, &quot;retry&quot;);
2294   }
2295 }
2296 
2297 bool G1CollectedHeap::try_collect(GCCause::Cause cause) {
2298   assert_heap_not_locked();
2299 
2300   // Lock to get consistent set of values.
2301   uint gc_count_before;
2302   uint full_gc_count_before;
2303   uint old_marking_started_before;
2304   {
2305     MutexLocker ml(Heap_lock);
2306     gc_count_before = total_collections();
2307     full_gc_count_before = total_full_collections();
2308     old_marking_started_before = _old_marking_cycles_started;
2309   }
2310 
2311   if (should_do_concurrent_full_gc(cause)) {
2312     return try_collect_concurrently(cause,
2313                                     gc_count_before,
2314                                     old_marking_started_before);
2315   } else if (GCLocker::should_discard(cause, gc_count_before)) {
2316     // Indicate failure to be consistent with VMOp failure due to
2317     // another collection slipping in after our gc_count but before
2318     // our request is processed.
2319     return false;
2320   } else if (cause == GCCause::_gc_locker || cause == GCCause::_wb_young_gc
2321              DEBUG_ONLY(|| cause == GCCause::_scavenge_alot)) {
2322 
2323     // Schedule a standard evacuation pause. We&#39;re setting word_size
2324     // to 0 which means that we are not requesting a post-GC allocation.
2325     VM_G1CollectForAllocation op(0,     /* word_size */
2326                                  gc_count_before,
2327                                  cause,
2328                                  policy()-&gt;max_pause_time_ms());
2329     VMThread::execute(&amp;op);
2330     return op.gc_succeeded();
2331   } else {
2332     // Schedule a Full GC.
2333     VM_G1CollectFull op(gc_count_before, full_gc_count_before, cause);
2334     VMThread::execute(&amp;op);
2335     return op.gc_succeeded();
2336   }
2337 }
2338 
2339 bool G1CollectedHeap::is_in(const void* p) const {
2340   if (_hrm-&gt;reserved().contains(p)) {
2341     // Given that we know that p is in the reserved space,
2342     // heap_region_containing() should successfully
2343     // return the containing region.
2344     HeapRegion* hr = heap_region_containing(p);
2345     return hr-&gt;is_in(p);
2346   } else {
2347     return false;
2348   }
2349 }
2350 
2351 #ifdef ASSERT
2352 bool G1CollectedHeap::is_in_exact(const void* p) const {
2353   bool contains = reserved_region().contains(p);
2354   bool available = _hrm-&gt;is_available(addr_to_region((HeapWord*)p));
2355   if (contains &amp;&amp; available) {
2356     return true;
2357   } else {
2358     return false;
2359   }
2360 }
2361 #endif
2362 
2363 // Iteration functions.
2364 
2365 // Iterates an ObjectClosure over all objects within a HeapRegion.
2366 
2367 class IterateObjectClosureRegionClosure: public HeapRegionClosure {
2368   ObjectClosure* _cl;
2369 public:
2370   IterateObjectClosureRegionClosure(ObjectClosure* cl) : _cl(cl) {}
2371   bool do_heap_region(HeapRegion* r) {
2372     if (!r-&gt;is_continues_humongous()) {
2373       r-&gt;object_iterate(_cl);
2374     }
2375     return false;
2376   }
2377 };
2378 
2379 void G1CollectedHeap::object_iterate(ObjectClosure* cl) {
2380   IterateObjectClosureRegionClosure blk(cl);
2381   heap_region_iterate(&amp;blk);
2382 }
2383 
2384 void G1CollectedHeap::keep_alive(oop obj) {
2385   G1BarrierSet::enqueue(obj);
2386 }
2387 
2388 void G1CollectedHeap::heap_region_iterate(HeapRegionClosure* cl) const {
2389   _hrm-&gt;iterate(cl);
2390 }
2391 
2392 void G1CollectedHeap::heap_region_par_iterate_from_worker_offset(HeapRegionClosure* cl,
2393                                                                  HeapRegionClaimer *hrclaimer,
2394                                                                  uint worker_id) const {
2395   _hrm-&gt;par_iterate(cl, hrclaimer, hrclaimer-&gt;offset_for_worker(worker_id));
2396 }
2397 
2398 void G1CollectedHeap::heap_region_par_iterate_from_start(HeapRegionClosure* cl,
2399                                                          HeapRegionClaimer *hrclaimer) const {
2400   _hrm-&gt;par_iterate(cl, hrclaimer, 0);
2401 }
2402 
2403 void G1CollectedHeap::collection_set_iterate_all(HeapRegionClosure* cl) {
2404   _collection_set.iterate(cl);
2405 }
2406 
2407 void G1CollectedHeap::collection_set_par_iterate_all(HeapRegionClosure* cl, HeapRegionClaimer* hr_claimer, uint worker_id) {
2408   _collection_set.par_iterate(cl, hr_claimer, worker_id, workers()-&gt;active_workers());
2409 }
2410 
2411 void G1CollectedHeap::collection_set_iterate_increment_from(HeapRegionClosure *cl, HeapRegionClaimer* hr_claimer, uint worker_id) {
2412   _collection_set.iterate_incremental_part_from(cl, hr_claimer, worker_id, workers()-&gt;active_workers());
2413 }
2414 
2415 HeapWord* G1CollectedHeap::block_start(const void* addr) const {
2416   HeapRegion* hr = heap_region_containing(addr);
2417   return hr-&gt;block_start(addr);
2418 }
2419 
2420 bool G1CollectedHeap::block_is_obj(const HeapWord* addr) const {
2421   HeapRegion* hr = heap_region_containing(addr);
2422   return hr-&gt;block_is_obj(addr);
2423 }
2424 
2425 bool G1CollectedHeap::supports_tlab_allocation() const {
2426   return true;
2427 }
2428 
2429 size_t G1CollectedHeap::tlab_capacity(Thread* ignored) const {
2430   return (_policy-&gt;young_list_target_length() - _survivor.length()) * HeapRegion::GrainBytes;
2431 }
2432 
2433 size_t G1CollectedHeap::tlab_used(Thread* ignored) const {
2434   return _eden.length() * HeapRegion::GrainBytes;
2435 }
2436 
2437 // For G1 TLABs should not contain humongous objects, so the maximum TLAB size
2438 // must be equal to the humongous object limit.
2439 size_t G1CollectedHeap::max_tlab_size() const {
2440   return align_down(_humongous_object_threshold_in_words, MinObjAlignment);
2441 }
2442 
2443 size_t G1CollectedHeap::unsafe_max_tlab_alloc(Thread* ignored) const {
2444   return _allocator-&gt;unsafe_max_tlab_alloc();
2445 }
2446 
2447 size_t G1CollectedHeap::max_capacity() const {
2448   return _hrm-&gt;max_expandable_length() * HeapRegion::GrainBytes;
2449 }
2450 
2451 size_t G1CollectedHeap::max_reserved_capacity() const {
2452   return _hrm-&gt;max_length() * HeapRegion::GrainBytes;
2453 }
2454 
2455 jlong G1CollectedHeap::millis_since_last_gc() {
2456   // See the notes in GenCollectedHeap::millis_since_last_gc()
2457   // for more information about the implementation.
2458   jlong ret_val = (os::javaTimeNanos() / NANOSECS_PER_MILLISEC) -
2459                   _policy-&gt;collection_pause_end_millis();
2460   if (ret_val &lt; 0) {
2461     log_warning(gc)(&quot;millis_since_last_gc() would return : &quot; JLONG_FORMAT
2462       &quot;. returning zero instead.&quot;, ret_val);
2463     return 0;
2464   }
2465   return ret_val;
2466 }
2467 
2468 void G1CollectedHeap::deduplicate_string(oop str) {
2469   assert(java_lang_String::is_instance(str), &quot;invariant&quot;);
2470 
2471   if (G1StringDedup::is_enabled()) {
2472     G1StringDedup::deduplicate(str);
2473   }
2474 }
2475 
2476 void G1CollectedHeap::prepare_for_verify() {
2477   _verifier-&gt;prepare_for_verify();
2478 }
2479 
2480 void G1CollectedHeap::verify(VerifyOption vo) {
2481   _verifier-&gt;verify(vo);
2482 }
2483 
2484 bool G1CollectedHeap::supports_concurrent_gc_breakpoints() const {
2485   return true;
2486 }
2487 
2488 bool G1CollectedHeap::is_heterogeneous_heap() const {
2489   return G1Arguments::is_heterogeneous_heap();
2490 }
2491 
2492 class PrintRegionClosure: public HeapRegionClosure {
2493   outputStream* _st;
2494 public:
2495   PrintRegionClosure(outputStream* st) : _st(st) {}
2496   bool do_heap_region(HeapRegion* r) {
2497     r-&gt;print_on(_st);
2498     return false;
2499   }
2500 };
2501 
2502 bool G1CollectedHeap::is_obj_dead_cond(const oop obj,
2503                                        const HeapRegion* hr,
2504                                        const VerifyOption vo) const {
2505   switch (vo) {
2506   case VerifyOption_G1UsePrevMarking: return is_obj_dead(obj, hr);
2507   case VerifyOption_G1UseNextMarking: return is_obj_ill(obj, hr);
2508   case VerifyOption_G1UseFullMarking: return is_obj_dead_full(obj, hr);
2509   default:                            ShouldNotReachHere();
2510   }
2511   return false; // keep some compilers happy
2512 }
2513 
2514 bool G1CollectedHeap::is_obj_dead_cond(const oop obj,
2515                                        const VerifyOption vo) const {
2516   switch (vo) {
2517   case VerifyOption_G1UsePrevMarking: return is_obj_dead(obj);
2518   case VerifyOption_G1UseNextMarking: return is_obj_ill(obj);
2519   case VerifyOption_G1UseFullMarking: return is_obj_dead_full(obj);
2520   default:                            ShouldNotReachHere();
2521   }
2522   return false; // keep some compilers happy
2523 }
2524 
2525 void G1CollectedHeap::print_heap_regions() const {
2526   LogTarget(Trace, gc, heap, region) lt;
2527   if (lt.is_enabled()) {
2528     LogStream ls(lt);
2529     print_regions_on(&amp;ls);
2530   }
2531 }
2532 
2533 void G1CollectedHeap::print_on(outputStream* st) const {
2534   st-&gt;print(&quot; %-20s&quot;, &quot;garbage-first heap&quot;);
2535   st-&gt;print(&quot; total &quot; SIZE_FORMAT &quot;K, used &quot; SIZE_FORMAT &quot;K&quot;,
2536             capacity()/K, used_unlocked()/K);
2537   st-&gt;print(&quot; [&quot; PTR_FORMAT &quot;, &quot; PTR_FORMAT &quot;)&quot;,
2538             p2i(_hrm-&gt;reserved().start()),
2539             p2i(_hrm-&gt;reserved().end()));
2540   st-&gt;cr();
2541   st-&gt;print(&quot;  region size &quot; SIZE_FORMAT &quot;K, &quot;, HeapRegion::GrainBytes / K);
2542   uint young_regions = young_regions_count();
2543   st-&gt;print(&quot;%u young (&quot; SIZE_FORMAT &quot;K), &quot;, young_regions,
2544             (size_t) young_regions * HeapRegion::GrainBytes / K);
2545   uint survivor_regions = survivor_regions_count();
2546   st-&gt;print(&quot;%u survivors (&quot; SIZE_FORMAT &quot;K)&quot;, survivor_regions,
2547             (size_t) survivor_regions * HeapRegion::GrainBytes / K);
2548   st-&gt;cr();
2549   if (_numa-&gt;is_enabled()) {
2550     uint num_nodes = _numa-&gt;num_active_nodes();
2551     st-&gt;print(&quot;  remaining free region(s) on each NUMA node: &quot;);
2552     const int* node_ids = _numa-&gt;node_ids();
2553     for (uint node_index = 0; node_index &lt; num_nodes; node_index++) {
2554       st-&gt;print(&quot;%d=%u &quot;, node_ids[node_index], _hrm-&gt;num_free_regions(node_index));
2555     }
2556     st-&gt;cr();
2557   }
2558   MetaspaceUtils::print_on(st);
2559 }
2560 
2561 void G1CollectedHeap::print_regions_on(outputStream* st) const {
2562   st-&gt;print_cr(&quot;Heap Regions: E=young(eden), S=young(survivor), O=old, &quot;
2563                &quot;HS=humongous(starts), HC=humongous(continues), &quot;
2564                &quot;CS=collection set, F=free, &quot;
2565                &quot;OA=open archive, CA=closed archive, &quot;
2566                &quot;TAMS=top-at-mark-start (previous, next)&quot;);
2567   PrintRegionClosure blk(st);
2568   heap_region_iterate(&amp;blk);
2569 }
2570 
2571 void G1CollectedHeap::print_extended_on(outputStream* st) const {
2572   print_on(st);
2573 
2574   // Print the per-region information.
2575   print_regions_on(st);
2576 }
2577 
2578 void G1CollectedHeap::print_on_error(outputStream* st) const {
2579   this-&gt;CollectedHeap::print_on_error(st);
2580 
2581   if (_cm != NULL) {
2582     st-&gt;cr();
2583     _cm-&gt;print_on_error(st);
2584   }
2585 }
2586 
2587 void G1CollectedHeap::print_gc_threads_on(outputStream* st) const {
2588   workers()-&gt;print_worker_threads_on(st);
2589   _cm_thread-&gt;print_on(st);
2590   st-&gt;cr();
2591   _cm-&gt;print_worker_threads_on(st);
2592   _cr-&gt;print_threads_on(st);
2593   _young_gen_sampling_thread-&gt;print_on(st);
2594   if (G1StringDedup::is_enabled()) {
2595     G1StringDedup::print_worker_threads_on(st);
2596   }
2597 }
2598 
2599 void G1CollectedHeap::gc_threads_do(ThreadClosure* tc) const {
2600   workers()-&gt;threads_do(tc);
2601   tc-&gt;do_thread(_cm_thread);
2602   _cm-&gt;threads_do(tc);
2603   _cr-&gt;threads_do(tc);
2604   tc-&gt;do_thread(_young_gen_sampling_thread);
2605   if (G1StringDedup::is_enabled()) {
2606     G1StringDedup::threads_do(tc);
2607   }
2608 }
2609 
2610 void G1CollectedHeap::print_tracing_info() const {
2611   rem_set()-&gt;print_summary_info();
2612   concurrent_mark()-&gt;print_summary_info();
2613 }
2614 
2615 #ifndef PRODUCT
2616 // Helpful for debugging RSet issues.
2617 
2618 class PrintRSetsClosure : public HeapRegionClosure {
2619 private:
2620   const char* _msg;
2621   size_t _occupied_sum;
2622 
2623 public:
2624   bool do_heap_region(HeapRegion* r) {
2625     HeapRegionRemSet* hrrs = r-&gt;rem_set();
2626     size_t occupied = hrrs-&gt;occupied();
2627     _occupied_sum += occupied;
2628 
2629     tty-&gt;print_cr(&quot;Printing RSet for region &quot; HR_FORMAT, HR_FORMAT_PARAMS(r));
2630     if (occupied == 0) {
2631       tty-&gt;print_cr(&quot;  RSet is empty&quot;);
2632     } else {
2633       hrrs-&gt;print();
2634     }
2635     tty-&gt;print_cr(&quot;----------&quot;);
2636     return false;
2637   }
2638 
2639   PrintRSetsClosure(const char* msg) : _msg(msg), _occupied_sum(0) {
2640     tty-&gt;cr();
2641     tty-&gt;print_cr(&quot;========================================&quot;);
2642     tty-&gt;print_cr(&quot;%s&quot;, msg);
2643     tty-&gt;cr();
2644   }
2645 
2646   ~PrintRSetsClosure() {
2647     tty-&gt;print_cr(&quot;Occupied Sum: &quot; SIZE_FORMAT, _occupied_sum);
2648     tty-&gt;print_cr(&quot;========================================&quot;);
2649     tty-&gt;cr();
2650   }
2651 };
2652 
2653 void G1CollectedHeap::print_cset_rsets() {
2654   PrintRSetsClosure cl(&quot;Printing CSet RSets&quot;);
2655   collection_set_iterate_all(&amp;cl);
2656 }
2657 
2658 void G1CollectedHeap::print_all_rsets() {
2659   PrintRSetsClosure cl(&quot;Printing All RSets&quot;);;
2660   heap_region_iterate(&amp;cl);
2661 }
2662 #endif // PRODUCT
2663 
2664 bool G1CollectedHeap::print_location(outputStream* st, void* addr) const {
2665   return BlockLocationPrinter&lt;G1CollectedHeap&gt;::print_location(st, addr);
2666 }
2667 
2668 G1HeapSummary G1CollectedHeap::create_g1_heap_summary() {
2669 
2670   size_t eden_used_bytes = _eden.used_bytes();
2671   size_t survivor_used_bytes = _survivor.used_bytes();
2672   size_t heap_used = Heap_lock-&gt;owned_by_self() ? used() : used_unlocked();
2673 
2674   size_t eden_capacity_bytes =
2675     (policy()-&gt;young_list_target_length() * HeapRegion::GrainBytes) - survivor_used_bytes;
2676 
2677   VirtualSpaceSummary heap_summary = create_heap_space_summary();
2678   return G1HeapSummary(heap_summary, heap_used, eden_used_bytes,
2679                        eden_capacity_bytes, survivor_used_bytes, num_regions());
2680 }
2681 
2682 G1EvacSummary G1CollectedHeap::create_g1_evac_summary(G1EvacStats* stats) {
2683   return G1EvacSummary(stats-&gt;allocated(), stats-&gt;wasted(), stats-&gt;undo_wasted(),
2684                        stats-&gt;unused(), stats-&gt;used(), stats-&gt;region_end_waste(),
2685                        stats-&gt;regions_filled(), stats-&gt;direct_allocated(),
2686                        stats-&gt;failure_used(), stats-&gt;failure_waste());
2687 }
2688 
2689 void G1CollectedHeap::trace_heap(GCWhen::Type when, const GCTracer* gc_tracer) {
2690   const G1HeapSummary&amp; heap_summary = create_g1_heap_summary();
2691   gc_tracer-&gt;report_gc_heap_summary(when, heap_summary);
2692 
2693   const MetaspaceSummary&amp; metaspace_summary = create_metaspace_summary();
2694   gc_tracer-&gt;report_metaspace_summary(when, metaspace_summary);
2695 }
2696 
2697 G1CollectedHeap* G1CollectedHeap::heap() {
2698   CollectedHeap* heap = Universe::heap();
2699   assert(heap != NULL, &quot;Uninitialized access to G1CollectedHeap::heap()&quot;);
2700   assert(heap-&gt;kind() == CollectedHeap::G1, &quot;Invalid name&quot;);
2701   return (G1CollectedHeap*)heap;
2702 }
2703 
2704 void G1CollectedHeap::gc_prologue(bool full) {
2705   assert(InlineCacheBuffer::is_empty(), &quot;should have cleaned up ICBuffer&quot;);
2706 
2707   // This summary needs to be printed before incrementing total collections.
2708   rem_set()-&gt;print_periodic_summary_info(&quot;Before GC RS summary&quot;, total_collections());
2709 
2710   // Update common counters.
2711   increment_total_collections(full /* full gc */);
2712   if (full || collector_state()-&gt;in_initial_mark_gc()) {
2713     increment_old_marking_cycles_started();
2714   }
2715 
2716   // Fill TLAB&#39;s and such
2717   double start = os::elapsedTime();
2718   ensure_parsability(true);
2719   phase_times()-&gt;record_prepare_tlab_time_ms((os::elapsedTime() - start) * 1000.0);
2720 }
2721 
2722 void G1CollectedHeap::gc_epilogue(bool full) {
2723   // Update common counters.
2724   if (full) {
2725     // Update the number of full collections that have been completed.
2726     increment_old_marking_cycles_completed(false /* concurrent */);
2727   }
2728 
2729   // We are at the end of the GC. Total collections has already been increased.
2730   rem_set()-&gt;print_periodic_summary_info(&quot;After GC RS summary&quot;, total_collections() - 1);
2731 
2732   // FIXME: what is this about?
2733   // I&#39;m ignoring the &quot;fill_newgen()&quot; call if &quot;alloc_event_enabled&quot;
2734   // is set.
2735 #if COMPILER2_OR_JVMCI
2736   assert(DerivedPointerTable::is_empty(), &quot;derived pointer present&quot;);
2737 #endif
2738 
2739   double start = os::elapsedTime();
2740   resize_all_tlabs();
2741   phase_times()-&gt;record_resize_tlab_time_ms((os::elapsedTime() - start) * 1000.0);
2742 
2743   MemoryService::track_memory_usage();
2744   // We have just completed a GC. Update the soft reference
2745   // policy with the new heap occupancy
2746   Universe::update_heap_info_at_gc();
2747 
2748   // Print NUMA statistics.
2749   _numa-&gt;print_statistics();
2750 }
2751 
2752 void G1CollectedHeap::verify_numa_regions(const char* desc) {
2753   LogTarget(Trace, gc, heap, verify) lt;
2754 
2755   if (lt.is_enabled()) {
2756     LogStream ls(lt);
2757     // Iterate all heap regions to print matching between preferred numa id and actual numa id.
2758     G1NodeIndexCheckClosure cl(desc, _numa, &amp;ls);
2759     heap_region_iterate(&amp;cl);
2760   }
2761 }
2762 
2763 HeapWord* G1CollectedHeap::do_collection_pause(size_t word_size,
2764                                                uint gc_count_before,
2765                                                bool* succeeded,
2766                                                GCCause::Cause gc_cause) {
2767   assert_heap_not_locked_and_not_at_safepoint();
2768   VM_G1CollectForAllocation op(word_size,
2769                                gc_count_before,
2770                                gc_cause,
2771                                policy()-&gt;max_pause_time_ms());
2772   VMThread::execute(&amp;op);
2773 
2774   HeapWord* result = op.result();
2775   bool ret_succeeded = op.prologue_succeeded() &amp;&amp; op.gc_succeeded();
2776   assert(result == NULL || ret_succeeded,
2777          &quot;the result should be NULL if the VM did not succeed&quot;);
2778   *succeeded = ret_succeeded;
2779 
2780   assert_heap_not_locked();
2781   return result;
2782 }
2783 
2784 void G1CollectedHeap::do_concurrent_mark() {
2785   MutexLocker x(CGC_lock, Mutex::_no_safepoint_check_flag);
2786   if (!_cm_thread-&gt;in_progress()) {
2787     _cm_thread-&gt;set_started();
2788     CGC_lock-&gt;notify();
2789   }
2790 }
2791 
2792 size_t G1CollectedHeap::pending_card_num() {
2793   struct CountCardsClosure : public ThreadClosure {
2794     size_t _cards;
2795     CountCardsClosure() : _cards(0) {}
2796     virtual void do_thread(Thread* t) {
2797       _cards += G1ThreadLocalData::dirty_card_queue(t).size();
2798     }
2799   } count_from_threads;
2800   Threads::threads_do(&amp;count_from_threads);
2801 
2802   G1DirtyCardQueueSet&amp; dcqs = G1BarrierSet::dirty_card_queue_set();
2803   return dcqs.num_cards() + count_from_threads._cards;
2804 }
2805 
2806 bool G1CollectedHeap::is_potential_eager_reclaim_candidate(HeapRegion* r) const {
2807   // We don&#39;t nominate objects with many remembered set entries, on
2808   // the assumption that such objects are likely still live.
2809   HeapRegionRemSet* rem_set = r-&gt;rem_set();
2810 
2811   return G1EagerReclaimHumongousObjectsWithStaleRefs ?
2812          rem_set-&gt;occupancy_less_or_equal_than(G1RSetSparseRegionEntries) :
2813          G1EagerReclaimHumongousObjects &amp;&amp; rem_set-&gt;is_empty();
2814 }
2815 
2816 #ifndef PRODUCT
2817 void G1CollectedHeap::verify_region_attr_remset_update() {
2818   class VerifyRegionAttrRemSet : public HeapRegionClosure {
2819   public:
2820     virtual bool do_heap_region(HeapRegion* r) {
2821       G1CollectedHeap* g1h = G1CollectedHeap::heap();
2822       bool const needs_remset_update = g1h-&gt;region_attr(r-&gt;bottom()).needs_remset_update();
2823       assert(r-&gt;rem_set()-&gt;is_tracked() == needs_remset_update,
2824              &quot;Region %u remset tracking status (%s) different to region attribute (%s)&quot;,
2825              r-&gt;hrm_index(), BOOL_TO_STR(r-&gt;rem_set()-&gt;is_tracked()), BOOL_TO_STR(needs_remset_update));
2826       return false;
2827     }
2828   } cl;
2829   heap_region_iterate(&amp;cl);
2830 }
2831 #endif
2832 
2833 class VerifyRegionRemSetClosure : public HeapRegionClosure {
2834   public:
2835     bool do_heap_region(HeapRegion* hr) {
2836       if (!hr-&gt;is_archive() &amp;&amp; !hr-&gt;is_continues_humongous()) {
2837         hr-&gt;verify_rem_set();
2838       }
2839       return false;
2840     }
2841 };
2842 
2843 uint G1CollectedHeap::num_task_queues() const {
2844   return _task_queues-&gt;size();
2845 }
2846 
2847 #if TASKQUEUE_STATS
2848 void G1CollectedHeap::print_taskqueue_stats_hdr(outputStream* const st) {
2849   st-&gt;print_raw_cr(&quot;GC Task Stats&quot;);
2850   st-&gt;print_raw(&quot;thr &quot;); TaskQueueStats::print_header(1, st); st-&gt;cr();
2851   st-&gt;print_raw(&quot;--- &quot;); TaskQueueStats::print_header(2, st); st-&gt;cr();
2852 }
2853 
2854 void G1CollectedHeap::print_taskqueue_stats() const {
2855   if (!log_is_enabled(Trace, gc, task, stats)) {
2856     return;
2857   }
2858   Log(gc, task, stats) log;
2859   ResourceMark rm;
2860   LogStream ls(log.trace());
2861   outputStream* st = &amp;ls;
2862 
2863   print_taskqueue_stats_hdr(st);
2864 
2865   TaskQueueStats totals;
2866   const uint n = num_task_queues();
2867   for (uint i = 0; i &lt; n; ++i) {
2868     st-&gt;print(&quot;%3u &quot;, i); task_queue(i)-&gt;stats.print(st); st-&gt;cr();
2869     totals += task_queue(i)-&gt;stats;
2870   }
2871   st-&gt;print_raw(&quot;tot &quot;); totals.print(st); st-&gt;cr();
2872 
2873   DEBUG_ONLY(totals.verify());
2874 }
2875 
2876 void G1CollectedHeap::reset_taskqueue_stats() {
2877   const uint n = num_task_queues();
2878   for (uint i = 0; i &lt; n; ++i) {
2879     task_queue(i)-&gt;stats.reset();
2880   }
2881 }
2882 #endif // TASKQUEUE_STATS
2883 
2884 void G1CollectedHeap::wait_for_root_region_scanning() {
2885   double scan_wait_start = os::elapsedTime();
2886   // We have to wait until the CM threads finish scanning the
2887   // root regions as it&#39;s the only way to ensure that all the
2888   // objects on them have been correctly scanned before we start
2889   // moving them during the GC.
2890   bool waited = _cm-&gt;root_regions()-&gt;wait_until_scan_finished();
2891   double wait_time_ms = 0.0;
2892   if (waited) {
2893     double scan_wait_end = os::elapsedTime();
2894     wait_time_ms = (scan_wait_end - scan_wait_start) * 1000.0;
2895   }
2896   phase_times()-&gt;record_root_region_scan_wait_time(wait_time_ms);
2897 }
2898 
2899 class G1PrintCollectionSetClosure : public HeapRegionClosure {
2900 private:
2901   G1HRPrinter* _hr_printer;
2902 public:
2903   G1PrintCollectionSetClosure(G1HRPrinter* hr_printer) : HeapRegionClosure(), _hr_printer(hr_printer) { }
2904 
2905   virtual bool do_heap_region(HeapRegion* r) {
2906     _hr_printer-&gt;cset(r);
2907     return false;
2908   }
2909 };
2910 
2911 void G1CollectedHeap::start_new_collection_set() {
2912   double start = os::elapsedTime();
2913 
2914   collection_set()-&gt;start_incremental_building();
2915 
2916   clear_region_attr();
2917 
2918   guarantee(_eden.length() == 0, &quot;eden should have been cleared&quot;);
2919   policy()-&gt;transfer_survivors_to_cset(survivor());
2920 
2921   // We redo the verification but now wrt to the new CSet which
2922   // has just got initialized after the previous CSet was freed.
2923   _cm-&gt;verify_no_collection_set_oops();
2924 
2925   phase_times()-&gt;record_start_new_cset_time_ms((os::elapsedTime() - start) * 1000.0);
2926 }
2927 
2928 void G1CollectedHeap::calculate_collection_set(G1EvacuationInfo&amp; evacuation_info, double target_pause_time_ms) {
2929 
2930   _collection_set.finalize_initial_collection_set(target_pause_time_ms, &amp;_survivor);
2931   evacuation_info.set_collectionset_regions(collection_set()-&gt;region_length() +
2932                                             collection_set()-&gt;optional_region_length());
2933 
2934   _cm-&gt;verify_no_collection_set_oops();
2935 
2936   if (_hr_printer.is_active()) {
2937     G1PrintCollectionSetClosure cl(&amp;_hr_printer);
2938     _collection_set.iterate(&amp;cl);
2939     _collection_set.iterate_optional(&amp;cl);
2940   }
2941 }
2942 
2943 G1HeapVerifier::G1VerifyType G1CollectedHeap::young_collection_verify_type() const {
2944   if (collector_state()-&gt;in_initial_mark_gc()) {
2945     return G1HeapVerifier::G1VerifyConcurrentStart;
2946   } else if (collector_state()-&gt;in_young_only_phase()) {
2947     return G1HeapVerifier::G1VerifyYoungNormal;
2948   } else {
2949     return G1HeapVerifier::G1VerifyMixed;
2950   }
2951 }
2952 
2953 void G1CollectedHeap::verify_before_young_collection(G1HeapVerifier::G1VerifyType type) {
2954   if (VerifyRememberedSets) {
2955     log_info(gc, verify)(&quot;[Verifying RemSets before GC]&quot;);
2956     VerifyRegionRemSetClosure v_cl;
2957     heap_region_iterate(&amp;v_cl);
2958   }
2959   _verifier-&gt;verify_before_gc(type);
2960   _verifier-&gt;check_bitmaps(&quot;GC Start&quot;);
2961   verify_numa_regions(&quot;GC Start&quot;);
2962 }
2963 
2964 void G1CollectedHeap::verify_after_young_collection(G1HeapVerifier::G1VerifyType type) {
2965   if (VerifyRememberedSets) {
2966     log_info(gc, verify)(&quot;[Verifying RemSets after GC]&quot;);
2967     VerifyRegionRemSetClosure v_cl;
2968     heap_region_iterate(&amp;v_cl);
2969   }
2970   _verifier-&gt;verify_after_gc(type);
2971   _verifier-&gt;check_bitmaps(&quot;GC End&quot;);
2972   verify_numa_regions(&quot;GC End&quot;);
2973 }
2974 
2975 void G1CollectedHeap::expand_heap_after_young_collection(){
2976   size_t expand_bytes = _heap_sizing_policy-&gt;expansion_amount();
2977   if (expand_bytes &gt; 0) {
2978     // No need for an ergo logging here,
2979     // expansion_amount() does this when it returns a value &gt; 0.
2980     double expand_ms;
2981     if (!expand(expand_bytes, _workers, &amp;expand_ms)) {
2982       // We failed to expand the heap. Cannot do anything about it.
2983     }
2984     phase_times()-&gt;record_expand_heap_time(expand_ms);
2985   }
2986 }
2987 
2988 const char* G1CollectedHeap::young_gc_name() const {
2989   if (collector_state()-&gt;in_initial_mark_gc()) {
2990     return &quot;Pause Young (Concurrent Start)&quot;;
2991   } else if (collector_state()-&gt;in_young_only_phase()) {
2992     if (collector_state()-&gt;in_young_gc_before_mixed()) {
2993       return &quot;Pause Young (Prepare Mixed)&quot;;
2994     } else {
2995       return &quot;Pause Young (Normal)&quot;;
2996     }
2997   } else {
2998     return &quot;Pause Young (Mixed)&quot;;
2999   }
3000 }
3001 
3002 bool G1CollectedHeap::do_collection_pause_at_safepoint(double target_pause_time_ms) {
3003   assert_at_safepoint_on_vm_thread();
3004   guarantee(!is_gc_active(), &quot;collection is not reentrant&quot;);
3005 
3006   if (GCLocker::check_active_before_gc()) {
3007     return false;
3008   }
3009 
3010   do_collection_pause_at_safepoint_helper(target_pause_time_ms);
3011   if (should_upgrade_to_full_gc(gc_cause())) {
3012     log_info(gc, ergo)(&quot;Attempting maximally compacting collection&quot;);
3013     bool result = do_full_collection(false /* explicit gc */,
3014                                      true /* clear_all_soft_refs */);
3015     // do_full_collection only fails if blocked by GC locker, but
3016     // we&#39;ve already checked for that above.
3017     assert(result, &quot;invariant&quot;);
3018   }
3019   return true;
3020 }
3021 
3022 void G1CollectedHeap::do_collection_pause_at_safepoint_helper(double target_pause_time_ms) {
3023   GCIdMark gc_id_mark;
3024 
3025   SvcGCMarker sgcm(SvcGCMarker::MINOR);
3026   ResourceMark rm;
3027 
3028   policy()-&gt;note_gc_start();
3029 
3030   _gc_timer_stw-&gt;register_gc_start();
3031   _gc_tracer_stw-&gt;report_gc_start(gc_cause(), _gc_timer_stw-&gt;gc_start());
3032 
3033   wait_for_root_region_scanning();
3034 
3035   print_heap_before_gc();
3036   print_heap_regions();
3037   trace_heap_before_gc(_gc_tracer_stw);
3038 
3039   _verifier-&gt;verify_region_sets_optional();
3040   _verifier-&gt;verify_dirty_young_regions();
3041 
3042   // We should not be doing initial mark unless the conc mark thread is running
3043   if (!_cm_thread-&gt;should_terminate()) {
3044     // This call will decide whether this pause is an initial-mark
3045     // pause. If it is, in_initial_mark_gc() will return true
3046     // for the duration of this pause.
3047     policy()-&gt;decide_on_conc_mark_initiation();
3048   }
3049 
3050   // We do not allow initial-mark to be piggy-backed on a mixed GC.
3051   assert(!collector_state()-&gt;in_initial_mark_gc() ||
3052          collector_state()-&gt;in_young_only_phase(), &quot;sanity&quot;);
3053   // We also do not allow mixed GCs during marking.
3054   assert(!collector_state()-&gt;mark_or_rebuild_in_progress() || collector_state()-&gt;in_young_only_phase(), &quot;sanity&quot;);
3055 
3056   // Record whether this pause is an initial mark. When the current
3057   // thread has completed its logging output and it&#39;s safe to signal
3058   // the CM thread, the flag&#39;s value in the policy has been reset.
3059   bool should_start_conc_mark = collector_state()-&gt;in_initial_mark_gc();
3060   if (should_start_conc_mark) {
3061     _cm-&gt;gc_tracer_cm()-&gt;set_gc_cause(gc_cause());
3062   }
3063 
3064   // Inner scope for scope based logging, timers, and stats collection
3065   {
3066     G1EvacuationInfo evacuation_info;
3067 
3068     _gc_tracer_stw-&gt;report_yc_type(collector_state()-&gt;yc_type());
3069 
3070     GCTraceCPUTime tcpu;
3071 
3072     GCTraceTime(Info, gc) tm(young_gc_name(), NULL, gc_cause(), true);
3073 
3074     uint active_workers = WorkerPolicy::calc_active_workers(workers()-&gt;total_workers(),
3075                                                             workers()-&gt;active_workers(),
3076                                                             Threads::number_of_non_daemon_threads());
3077     active_workers = workers()-&gt;update_active_workers(active_workers);
3078     log_info(gc,task)(&quot;Using %u workers of %u for evacuation&quot;, active_workers, workers()-&gt;total_workers());
3079 
3080     G1MonitoringScope ms(g1mm(),
3081                          false /* full_gc */,
3082                          collector_state()-&gt;yc_type() == Mixed /* all_memory_pools_affected */);
3083 
3084     G1HeapTransition heap_transition(this);
3085 
3086     {
3087       IsGCActiveMark x;
3088 
3089       gc_prologue(false);
3090 
3091       G1HeapVerifier::G1VerifyType verify_type = young_collection_verify_type();
3092       verify_before_young_collection(verify_type);
3093 
3094       {
3095         // The elapsed time induced by the start time below deliberately elides
3096         // the possible verification above.
3097         double sample_start_time_sec = os::elapsedTime();
3098 
3099         // Please see comment in g1CollectedHeap.hpp and
3100         // G1CollectedHeap::ref_processing_init() to see how
3101         // reference processing currently works in G1.
3102         _ref_processor_stw-&gt;enable_discovery();
3103 
3104         // We want to temporarily turn off discovery by the
3105         // CM ref processor, if necessary, and turn it back on
3106         // on again later if we do. Using a scoped
3107         // NoRefDiscovery object will do this.
3108         NoRefDiscovery no_cm_discovery(_ref_processor_cm);
3109 
3110         policy()-&gt;record_collection_pause_start(sample_start_time_sec);
3111 
3112         // Forget the current allocation region (we might even choose it to be part
3113         // of the collection set!).
3114         _allocator-&gt;release_mutator_alloc_regions();
3115 
3116         calculate_collection_set(evacuation_info, target_pause_time_ms);
3117 
3118         G1RedirtyCardsQueueSet rdcqs(G1BarrierSet::dirty_card_queue_set().allocator());
3119         G1ParScanThreadStateSet per_thread_states(this,
3120                                                   &amp;rdcqs,
3121                                                   workers()-&gt;active_workers(),
3122                                                   collection_set()-&gt;young_region_length(),
3123                                                   collection_set()-&gt;optional_region_length());
3124         pre_evacuate_collection_set(evacuation_info, &amp;per_thread_states);
3125 
3126         // Actually do the work...
3127         evacuate_initial_collection_set(&amp;per_thread_states);
3128 
3129         if (_collection_set.optional_region_length() != 0) {
3130           evacuate_optional_collection_set(&amp;per_thread_states);
3131         }
3132         post_evacuate_collection_set(evacuation_info, &amp;rdcqs, &amp;per_thread_states);
3133 
3134         start_new_collection_set();
3135 
3136         _survivor_evac_stats.adjust_desired_plab_sz();
3137         _old_evac_stats.adjust_desired_plab_sz();
3138 
3139         if (should_start_conc_mark) {
3140           // We have to do this before we notify the CM threads that
3141           // they can start working to make sure that all the
3142           // appropriate initialization is done on the CM object.
3143           concurrent_mark()-&gt;post_initial_mark();
3144           // Note that we don&#39;t actually trigger the CM thread at
3145           // this point. We do that later when we&#39;re sure that
3146           // the current thread has completed its logging output.
3147         }
3148 
3149         allocate_dummy_regions();
3150 
3151         _allocator-&gt;init_mutator_alloc_regions();
3152 
3153         expand_heap_after_young_collection();
3154 
3155         double sample_end_time_sec = os::elapsedTime();
3156         double pause_time_ms = (sample_end_time_sec - sample_start_time_sec) * MILLIUNITS;
3157         policy()-&gt;record_collection_pause_end(pause_time_ms);
3158       }
3159 
3160       verify_after_young_collection(verify_type);
3161 
3162       gc_epilogue(false);
3163     }
3164 
3165     // Print the remainder of the GC log output.
3166     if (evacuation_failed()) {
3167       log_info(gc)(&quot;To-space exhausted&quot;);
3168     }
3169 
3170     policy()-&gt;print_phases();
3171     heap_transition.print();
3172 
3173     _hrm-&gt;verify_optional();
3174     _verifier-&gt;verify_region_sets_optional();
3175 
3176     TASKQUEUE_STATS_ONLY(print_taskqueue_stats());
3177     TASKQUEUE_STATS_ONLY(reset_taskqueue_stats());
3178 
3179     print_heap_after_gc();
3180     print_heap_regions();
3181     trace_heap_after_gc(_gc_tracer_stw);
3182 
3183     // We must call G1MonitoringSupport::update_sizes() in the same scoping level
3184     // as an active TraceMemoryManagerStats object (i.e. before the destructor for the
3185     // TraceMemoryManagerStats is called) so that the G1 memory pools are updated
3186     // before any GC notifications are raised.
3187     g1mm()-&gt;update_sizes();
3188 
3189     _gc_tracer_stw-&gt;report_evacuation_info(&amp;evacuation_info);
3190     _gc_tracer_stw-&gt;report_tenuring_threshold(_policy-&gt;tenuring_threshold());
3191     _gc_timer_stw-&gt;register_gc_end();
3192     _gc_tracer_stw-&gt;report_gc_end(_gc_timer_stw-&gt;gc_end(), _gc_timer_stw-&gt;time_partitions());
3193   }
3194   // It should now be safe to tell the concurrent mark thread to start
3195   // without its logging output interfering with the logging output
3196   // that came from the pause.
3197 
3198   if (should_start_conc_mark) {
3199     // CAUTION: after the doConcurrentMark() call below, the concurrent marking
3200     // thread(s) could be running concurrently with us. Make sure that anything
3201     // after this point does not assume that we are the only GC thread running.
3202     // Note: of course, the actual marking work will not start until the safepoint
3203     // itself is released in SuspendibleThreadSet::desynchronize().
3204     do_concurrent_mark();
3205     ConcurrentGCBreakpoints::notify_idle_to_active();
3206   }
3207 }
3208 
3209 void G1CollectedHeap::remove_self_forwarding_pointers(G1RedirtyCardsQueueSet* rdcqs) {
3210   G1ParRemoveSelfForwardPtrsTask rsfp_task(rdcqs);
3211   workers()-&gt;run_task(&amp;rsfp_task);
3212 }
3213 
3214 void G1CollectedHeap::restore_after_evac_failure(G1RedirtyCardsQueueSet* rdcqs) {
3215   double remove_self_forwards_start = os::elapsedTime();
3216 
3217   remove_self_forwarding_pointers(rdcqs);
3218   _preserved_marks_set.restore(workers());
3219 
3220   phase_times()-&gt;record_evac_fail_remove_self_forwards((os::elapsedTime() - remove_self_forwards_start) * 1000.0);
3221 }
3222 
3223 void G1CollectedHeap::preserve_mark_during_evac_failure(uint worker_id, oop obj, markWord m) {
3224   if (!_evacuation_failed) {
3225     _evacuation_failed = true;
3226   }
3227 
3228   _evacuation_failed_info_array[worker_id].register_copy_failure(obj-&gt;size());
3229   _preserved_marks_set.get(worker_id)-&gt;push_if_necessary(obj, m);
3230 }
3231 
3232 bool G1ParEvacuateFollowersClosure::offer_termination() {
3233   EventGCPhaseParallel event;
3234   G1ParScanThreadState* const pss = par_scan_state();
3235   start_term_time();
3236   const bool res = terminator()-&gt;offer_termination();
3237   end_term_time();
3238   event.commit(GCId::current(), pss-&gt;worker_id(), G1GCPhaseTimes::phase_name(G1GCPhaseTimes::Termination));
3239   return res;
3240 }
3241 
3242 void G1ParEvacuateFollowersClosure::do_void() {
3243   EventGCPhaseParallel event;
3244   G1ParScanThreadState* const pss = par_scan_state();
3245   pss-&gt;trim_queue();
3246   event.commit(GCId::current(), pss-&gt;worker_id(), G1GCPhaseTimes::phase_name(_phase));
3247   do {
3248     EventGCPhaseParallel event;
3249     pss-&gt;steal_and_trim_queue(queues());
3250     event.commit(GCId::current(), pss-&gt;worker_id(), G1GCPhaseTimes::phase_name(_phase));
3251   } while (!offer_termination());
3252 }
3253 
3254 void G1CollectedHeap::complete_cleaning(BoolObjectClosure* is_alive,
3255                                         bool class_unloading_occurred) {
3256   uint num_workers = workers()-&gt;active_workers();
3257   G1ParallelCleaningTask unlink_task(is_alive, num_workers, class_unloading_occurred, false);
3258   workers()-&gt;run_task(&amp;unlink_task);
3259 }
3260 
3261 // Clean string dedup data structures.
3262 // Ideally we would prefer to use a StringDedupCleaningTask here, but we want to
3263 // record the durations of the phases. Hence the almost-copy.
3264 class G1StringDedupCleaningTask : public AbstractGangTask {
3265   BoolObjectClosure* _is_alive;
3266   OopClosure* _keep_alive;
3267   G1GCPhaseTimes* _phase_times;
3268 
3269 public:
3270   G1StringDedupCleaningTask(BoolObjectClosure* is_alive,
3271                             OopClosure* keep_alive,
3272                             G1GCPhaseTimes* phase_times) :
3273     AbstractGangTask(&quot;Partial Cleaning Task&quot;),
3274     _is_alive(is_alive),
3275     _keep_alive(keep_alive),
3276     _phase_times(phase_times)
3277   {
3278     assert(G1StringDedup::is_enabled(), &quot;String deduplication disabled.&quot;);
3279     StringDedup::gc_prologue(true);
3280   }
3281 
3282   ~G1StringDedupCleaningTask() {
3283     StringDedup::gc_epilogue();
3284   }
3285 
3286   void work(uint worker_id) {
3287     StringDedupUnlinkOrOopsDoClosure cl(_is_alive, _keep_alive);
3288     {
3289       G1GCParPhaseTimesTracker x(_phase_times, G1GCPhaseTimes::StringDedupQueueFixup, worker_id);
3290       StringDedupQueue::unlink_or_oops_do(&amp;cl);
3291     }
3292     {
3293       G1GCParPhaseTimesTracker x(_phase_times, G1GCPhaseTimes::StringDedupTableFixup, worker_id);
3294       StringDedupTable::unlink_or_oops_do(&amp;cl, worker_id);
3295     }
3296   }
3297 };
3298 
3299 void G1CollectedHeap::string_dedup_cleaning(BoolObjectClosure* is_alive,
3300                                             OopClosure* keep_alive,
3301                                             G1GCPhaseTimes* phase_times) {
3302   G1StringDedupCleaningTask cl(is_alive, keep_alive, phase_times);
3303   workers()-&gt;run_task(&amp;cl);
3304 }
3305 
3306 class G1RedirtyLoggedCardsTask : public AbstractGangTask {
3307  private:
3308   G1RedirtyCardsQueueSet* _qset;
3309   G1CollectedHeap* _g1h;
3310   BufferNode* volatile _nodes;
3311 
3312   void par_apply(RedirtyLoggedCardTableEntryClosure* cl, uint worker_id) {
3313     size_t buffer_size = _qset-&gt;buffer_size();
3314     BufferNode* next = Atomic::load(&amp;_nodes);
3315     while (next != NULL) {
3316       BufferNode* node = next;
3317       next = Atomic::cmpxchg(&amp;_nodes, node, node-&gt;next());
3318       if (next == node) {
3319         cl-&gt;apply_to_buffer(node, buffer_size, worker_id);
3320         next = node-&gt;next();
3321       }
3322     }
3323   }
3324 
3325  public:
3326   G1RedirtyLoggedCardsTask(G1RedirtyCardsQueueSet* qset, G1CollectedHeap* g1h) :
3327     AbstractGangTask(&quot;Redirty Cards&quot;),
3328     _qset(qset), _g1h(g1h), _nodes(qset-&gt;all_completed_buffers()) { }
3329 
3330   virtual void work(uint worker_id) {
3331     G1GCPhaseTimes* p = _g1h-&gt;phase_times();
3332     G1GCParPhaseTimesTracker x(p, G1GCPhaseTimes::RedirtyCards, worker_id);
3333 
3334     RedirtyLoggedCardTableEntryClosure cl(_g1h);
3335     par_apply(&amp;cl, worker_id);
3336 
3337     p-&gt;record_thread_work_item(G1GCPhaseTimes::RedirtyCards, worker_id, cl.num_dirtied());
3338   }
3339 };
3340 
3341 void G1CollectedHeap::redirty_logged_cards(G1RedirtyCardsQueueSet* rdcqs) {
3342   double redirty_logged_cards_start = os::elapsedTime();
3343 
3344   G1RedirtyLoggedCardsTask redirty_task(rdcqs, this);
3345   workers()-&gt;run_task(&amp;redirty_task);
3346 
3347   G1DirtyCardQueueSet&amp; dcq = G1BarrierSet::dirty_card_queue_set();
3348   dcq.merge_bufferlists(rdcqs);
3349 
3350   phase_times()-&gt;record_redirty_logged_cards_time_ms((os::elapsedTime() - redirty_logged_cards_start) * 1000.0);
3351 }
3352 
3353 // Weak Reference Processing support
3354 
3355 bool G1STWIsAliveClosure::do_object_b(oop p) {
3356   // An object is reachable if it is outside the collection set,
3357   // or is inside and copied.
3358   return !_g1h-&gt;is_in_cset(p) || p-&gt;is_forwarded();
3359 }
3360 
3361 bool G1STWSubjectToDiscoveryClosure::do_object_b(oop obj) {
3362   assert(obj != NULL, &quot;must not be NULL&quot;);
3363   assert(_g1h-&gt;is_in_reserved(obj), &quot;Trying to discover obj &quot; PTR_FORMAT &quot; not in heap&quot;, p2i(obj));
3364   // The areas the CM and STW ref processor manage must be disjoint. The is_in_cset() below
3365   // may falsely indicate that this is not the case here: however the collection set only
3366   // contains old regions when concurrent mark is not running.
3367   return _g1h-&gt;is_in_cset(obj) || _g1h-&gt;heap_region_containing(obj)-&gt;is_survivor();
3368 }
3369 
3370 // Non Copying Keep Alive closure
3371 class G1KeepAliveClosure: public OopClosure {
3372   G1CollectedHeap*_g1h;
3373 public:
3374   G1KeepAliveClosure(G1CollectedHeap* g1h) :_g1h(g1h) {}
3375   void do_oop(narrowOop* p) { guarantee(false, &quot;Not needed&quot;); }
3376   void do_oop(oop* p) {
3377     oop obj = *p;
3378     assert(obj != NULL, &quot;the caller should have filtered out NULL values&quot;);
3379 
3380     const G1HeapRegionAttr region_attr =_g1h-&gt;region_attr(obj);
3381     if (!region_attr.is_in_cset_or_humongous()) {
3382       return;
3383     }
3384     if (region_attr.is_in_cset()) {
3385       assert( obj-&gt;is_forwarded(), &quot;invariant&quot; );
3386       *p = obj-&gt;forwardee();
3387     } else {
3388       assert(!obj-&gt;is_forwarded(), &quot;invariant&quot; );
3389       assert(region_attr.is_humongous(),
3390              &quot;Only allowed G1HeapRegionAttr state is IsHumongous, but is %d&quot;, region_attr.type());
3391      _g1h-&gt;set_humongous_is_live(obj);
3392     }
3393   }
3394 };
3395 
3396 // Copying Keep Alive closure - can be called from both
3397 // serial and parallel code as long as different worker
3398 // threads utilize different G1ParScanThreadState instances
3399 // and different queues.
3400 
3401 class G1CopyingKeepAliveClosure: public OopClosure {
3402   G1CollectedHeap*         _g1h;
3403   G1ParScanThreadState*    _par_scan_state;
3404 
3405 public:
3406   G1CopyingKeepAliveClosure(G1CollectedHeap* g1h,
3407                             G1ParScanThreadState* pss):
3408     _g1h(g1h),
3409     _par_scan_state(pss)
3410   {}
3411 
3412   virtual void do_oop(narrowOop* p) { do_oop_work(p); }
3413   virtual void do_oop(      oop* p) { do_oop_work(p); }
3414 
3415   template &lt;class T&gt; void do_oop_work(T* p) {
3416     oop obj = RawAccess&lt;&gt;::oop_load(p);
3417 
3418     if (_g1h-&gt;is_in_cset_or_humongous(obj)) {
3419       // If the referent object has been forwarded (either copied
3420       // to a new location or to itself in the event of an
3421       // evacuation failure) then we need to update the reference
3422       // field and, if both reference and referent are in the G1
3423       // heap, update the RSet for the referent.
3424       //
3425       // If the referent has not been forwarded then we have to keep
3426       // it alive by policy. Therefore we have copy the referent.
3427       //
3428       // When the queue is drained (after each phase of reference processing)
3429       // the object and it&#39;s followers will be copied, the reference field set
3430       // to point to the new location, and the RSet updated.
3431       _par_scan_state-&gt;push_on_queue(p);
3432     }
3433   }
3434 };
3435 
3436 // Serial drain queue closure. Called as the &#39;complete_gc&#39;
3437 // closure for each discovered list in some of the
3438 // reference processing phases.
3439 
3440 class G1STWDrainQueueClosure: public VoidClosure {
3441 protected:
3442   G1CollectedHeap* _g1h;
3443   G1ParScanThreadState* _par_scan_state;
3444 
3445   G1ParScanThreadState*   par_scan_state() { return _par_scan_state; }
3446 
3447 public:
3448   G1STWDrainQueueClosure(G1CollectedHeap* g1h, G1ParScanThreadState* pss) :
3449     _g1h(g1h),
3450     _par_scan_state(pss)
3451   { }
3452 
3453   void do_void() {
3454     G1ParScanThreadState* const pss = par_scan_state();
3455     pss-&gt;trim_queue();
3456   }
3457 };
3458 
3459 // Parallel Reference Processing closures
3460 
3461 // Implementation of AbstractRefProcTaskExecutor for parallel reference
3462 // processing during G1 evacuation pauses.
3463 
3464 class G1STWRefProcTaskExecutor: public AbstractRefProcTaskExecutor {
3465 private:
3466   G1CollectedHeap*          _g1h;
3467   G1ParScanThreadStateSet*  _pss;
3468   RefToScanQueueSet*        _queues;
3469   WorkGang*                 _workers;
3470 
3471 public:
3472   G1STWRefProcTaskExecutor(G1CollectedHeap* g1h,
3473                            G1ParScanThreadStateSet* per_thread_states,
3474                            WorkGang* workers,
3475                            RefToScanQueueSet *task_queues) :
3476     _g1h(g1h),
3477     _pss(per_thread_states),
3478     _queues(task_queues),
3479     _workers(workers)
3480   {
3481     g1h-&gt;ref_processor_stw()-&gt;set_active_mt_degree(workers-&gt;active_workers());
3482   }
3483 
3484   // Executes the given task using concurrent marking worker threads.
3485   virtual void execute(ProcessTask&amp; task, uint ergo_workers);
3486 };
3487 
3488 // Gang task for possibly parallel reference processing
3489 
3490 class G1STWRefProcTaskProxy: public AbstractGangTask {
3491   typedef AbstractRefProcTaskExecutor::ProcessTask ProcessTask;
3492   ProcessTask&amp;     _proc_task;
3493   G1CollectedHeap* _g1h;
3494   G1ParScanThreadStateSet* _pss;
3495   RefToScanQueueSet* _task_queues;
3496   TaskTerminator* _terminator;
3497 
3498 public:
3499   G1STWRefProcTaskProxy(ProcessTask&amp; proc_task,
3500                         G1CollectedHeap* g1h,
3501                         G1ParScanThreadStateSet* per_thread_states,
3502                         RefToScanQueueSet *task_queues,
3503                         TaskTerminator* terminator) :
3504     AbstractGangTask(&quot;Process reference objects in parallel&quot;),
3505     _proc_task(proc_task),
3506     _g1h(g1h),
3507     _pss(per_thread_states),
3508     _task_queues(task_queues),
3509     _terminator(terminator)
3510   {}
3511 
3512   virtual void work(uint worker_id) {
3513     // The reference processing task executed by a single worker.
3514     ResourceMark rm;
3515     HandleMark   hm;
3516 
3517     G1STWIsAliveClosure is_alive(_g1h);
3518 
3519     G1ParScanThreadState* pss = _pss-&gt;state_for_worker(worker_id);
3520     pss-&gt;set_ref_discoverer(NULL);
3521 
3522     // Keep alive closure.
3523     G1CopyingKeepAliveClosure keep_alive(_g1h, pss);
3524 
3525     // Complete GC closure
3526     G1ParEvacuateFollowersClosure drain_queue(_g1h, pss, _task_queues, _terminator, G1GCPhaseTimes::ObjCopy);
3527 
3528     // Call the reference processing task&#39;s work routine.
3529     _proc_task.work(worker_id, is_alive, keep_alive, drain_queue);
3530 
3531     // Note we cannot assert that the refs array is empty here as not all
3532     // of the processing tasks (specifically phase2 - pp2_work) execute
3533     // the complete_gc closure (which ordinarily would drain the queue) so
3534     // the queue may not be empty.
3535   }
3536 };
3537 
3538 // Driver routine for parallel reference processing.
3539 // Creates an instance of the ref processing gang
3540 // task and has the worker threads execute it.
3541 void G1STWRefProcTaskExecutor::execute(ProcessTask&amp; proc_task, uint ergo_workers) {
3542   assert(_workers != NULL, &quot;Need parallel worker threads.&quot;);
3543 
3544   assert(_workers-&gt;active_workers() &gt;= ergo_workers,
3545          &quot;Ergonomically chosen workers (%u) should be less than or equal to active workers (%u)&quot;,
3546          ergo_workers, _workers-&gt;active_workers());
3547   TaskTerminator terminator(ergo_workers, _queues);
3548   G1STWRefProcTaskProxy proc_task_proxy(proc_task, _g1h, _pss, _queues, &amp;terminator);
3549 
3550   _workers-&gt;run_task(&amp;proc_task_proxy, ergo_workers);
3551 }
3552 
3553 // End of weak reference support closures
3554 
3555 void G1CollectedHeap::process_discovered_references(G1ParScanThreadStateSet* per_thread_states) {
3556   double ref_proc_start = os::elapsedTime();
3557 
3558   ReferenceProcessor* rp = _ref_processor_stw;
3559   assert(rp-&gt;discovery_enabled(), &quot;should have been enabled&quot;);
3560 
3561   // Closure to test whether a referent is alive.
3562   G1STWIsAliveClosure is_alive(this);
3563 
3564   // Even when parallel reference processing is enabled, the processing
3565   // of JNI refs is serial and performed serially by the current thread
3566   // rather than by a worker. The following PSS will be used for processing
3567   // JNI refs.
3568 
3569   // Use only a single queue for this PSS.
3570   G1ParScanThreadState*          pss = per_thread_states-&gt;state_for_worker(0);
3571   pss-&gt;set_ref_discoverer(NULL);
3572   assert(pss-&gt;queue_is_empty(), &quot;pre-condition&quot;);
3573 
3574   // Keep alive closure.
3575   G1CopyingKeepAliveClosure keep_alive(this, pss);
3576 
3577   // Serial Complete GC closure
3578   G1STWDrainQueueClosure drain_queue(this, pss);
3579 
3580   // Setup the soft refs policy...
3581   rp-&gt;setup_policy(false);
3582 
3583   ReferenceProcessorPhaseTimes* pt = phase_times()-&gt;ref_phase_times();
3584 
3585   ReferenceProcessorStats stats;
3586   if (!rp-&gt;processing_is_mt()) {
3587     // Serial reference processing...
3588     stats = rp-&gt;process_discovered_references(&amp;is_alive,
3589                                               &amp;keep_alive,
3590                                               &amp;drain_queue,
3591                                               NULL,
3592                                               pt);
3593   } else {
3594     uint no_of_gc_workers = workers()-&gt;active_workers();
3595 
3596     // Parallel reference processing
3597     assert(no_of_gc_workers &lt;= rp-&gt;max_num_queues(),
3598            &quot;Mismatch between the number of GC workers %u and the maximum number of Reference process queues %u&quot;,
3599            no_of_gc_workers,  rp-&gt;max_num_queues());
3600 
3601     G1STWRefProcTaskExecutor par_task_executor(this, per_thread_states, workers(), _task_queues);
3602     stats = rp-&gt;process_discovered_references(&amp;is_alive,
3603                                               &amp;keep_alive,
3604                                               &amp;drain_queue,
3605                                               &amp;par_task_executor,
3606                                               pt);
3607   }
3608 
3609   _gc_tracer_stw-&gt;report_gc_reference_stats(stats);
3610 
3611   // We have completed copying any necessary live referent objects.
3612   assert(pss-&gt;queue_is_empty(), &quot;both queue and overflow should be empty&quot;);
3613 
3614   make_pending_list_reachable();
3615 
3616   assert(!rp-&gt;discovery_enabled(), &quot;Postcondition&quot;);
3617   rp-&gt;verify_no_references_recorded();
3618 
3619   double ref_proc_time = os::elapsedTime() - ref_proc_start;
3620   phase_times()-&gt;record_ref_proc_time(ref_proc_time * 1000.0);
3621 }
3622 
3623 void G1CollectedHeap::make_pending_list_reachable() {
3624   if (collector_state()-&gt;in_initial_mark_gc()) {
3625     oop pll_head = Universe::reference_pending_list();
3626     if (pll_head != NULL) {
3627       // Any valid worker id is fine here as we are in the VM thread and single-threaded.
3628       _cm-&gt;mark_in_next_bitmap(0 /* worker_id */, pll_head);
3629     }
3630   }
3631 }
3632 
3633 void G1CollectedHeap::merge_per_thread_state_info(G1ParScanThreadStateSet* per_thread_states) {
3634   Ticks start = Ticks::now();
3635   per_thread_states-&gt;flush();
3636   phase_times()-&gt;record_or_add_time_secs(G1GCPhaseTimes::MergePSS, 0 /* worker_id */, (Ticks::now() - start).seconds());
3637 }
3638 
3639 class G1PrepareEvacuationTask : public AbstractGangTask {
3640   class G1PrepareRegionsClosure : public HeapRegionClosure {
3641     G1CollectedHeap* _g1h;
3642     G1PrepareEvacuationTask* _parent_task;
3643     size_t _worker_humongous_total;
3644     size_t _worker_humongous_candidates;
3645 
3646     bool humongous_region_is_candidate(HeapRegion* region) const {
3647       assert(region-&gt;is_starts_humongous(), &quot;Must start a humongous object&quot;);
3648 
3649       oop obj = oop(region-&gt;bottom());
3650 
3651       // Dead objects cannot be eager reclaim candidates. Due to class
3652       // unloading it is unsafe to query their classes so we return early.
3653       if (_g1h-&gt;is_obj_dead(obj, region)) {
3654         return false;
3655       }
3656 
3657       // If we do not have a complete remembered set for the region, then we can
3658       // not be sure that we have all references to it.
3659       if (!region-&gt;rem_set()-&gt;is_complete()) {
3660         return false;
3661       }
3662       // Candidate selection must satisfy the following constraints
3663       // while concurrent marking is in progress:
3664       //
3665       // * In order to maintain SATB invariants, an object must not be
3666       // reclaimed if it was allocated before the start of marking and
3667       // has not had its references scanned.  Such an object must have
3668       // its references (including type metadata) scanned to ensure no
3669       // live objects are missed by the marking process.  Objects
3670       // allocated after the start of concurrent marking don&#39;t need to
3671       // be scanned.
3672       //
3673       // * An object must not be reclaimed if it is on the concurrent
3674       // mark stack.  Objects allocated after the start of concurrent
3675       // marking are never pushed on the mark stack.
3676       //
3677       // Nominating only objects allocated after the start of concurrent
3678       // marking is sufficient to meet both constraints.  This may miss
3679       // some objects that satisfy the constraints, but the marking data
3680       // structures don&#39;t support efficiently performing the needed
3681       // additional tests or scrubbing of the mark stack.
3682       //
3683       // However, we presently only nominate is_typeArray() objects.
3684       // A humongous object containing references induces remembered
3685       // set entries on other regions.  In order to reclaim such an
3686       // object, those remembered sets would need to be cleaned up.
3687       //
3688       // We also treat is_typeArray() objects specially, allowing them
3689       // to be reclaimed even if allocated before the start of
3690       // concurrent mark.  For this we rely on mark stack insertion to
3691       // exclude is_typeArray() objects, preventing reclaiming an object
3692       // that is in the mark stack.  We also rely on the metadata for
3693       // such objects to be built-in and so ensured to be kept live.
3694       // Frequent allocation and drop of large binary blobs is an
3695       // important use case for eager reclaim, and this special handling
3696       // may reduce needed headroom.
3697 
3698       return obj-&gt;is_typeArray() &amp;&amp;
3699              _g1h-&gt;is_potential_eager_reclaim_candidate(region);
3700     }
3701 
3702   public:
3703     G1PrepareRegionsClosure(G1CollectedHeap* g1h, G1PrepareEvacuationTask* parent_task) :
3704       _g1h(g1h),
3705       _parent_task(parent_task),
3706       _worker_humongous_total(0),
3707       _worker_humongous_candidates(0) { }
3708 
3709     ~G1PrepareRegionsClosure() {
3710       _parent_task-&gt;add_humongous_candidates(_worker_humongous_candidates);
3711       _parent_task-&gt;add_humongous_total(_worker_humongous_total);
3712     }
3713 
3714     virtual bool do_heap_region(HeapRegion* hr) {
3715       // First prepare the region for scanning
3716       _g1h-&gt;rem_set()-&gt;prepare_region_for_scan(hr);
3717 
3718       // Now check if region is a humongous candidate
3719       if (!hr-&gt;is_starts_humongous()) {
3720         _g1h-&gt;register_region_with_region_attr(hr);
3721         return false;
3722       }
3723 
3724       uint index = hr-&gt;hrm_index();
3725       if (humongous_region_is_candidate(hr)) {
3726         _g1h-&gt;set_humongous_reclaim_candidate(index, true);
3727         _g1h-&gt;register_humongous_region_with_region_attr(index);
3728         _worker_humongous_candidates++;
3729         // We will later handle the remembered sets of these regions.
3730       } else {
3731         _g1h-&gt;set_humongous_reclaim_candidate(index, false);
3732         _g1h-&gt;register_region_with_region_attr(hr);
3733       }
3734       _worker_humongous_total++;
3735 
3736       return false;
3737     }
3738   };
3739 
3740   G1CollectedHeap* _g1h;
3741   HeapRegionClaimer _claimer;
3742   volatile size_t _humongous_total;
3743   volatile size_t _humongous_candidates;
3744 public:
3745   G1PrepareEvacuationTask(G1CollectedHeap* g1h) :
3746     AbstractGangTask(&quot;Prepare Evacuation&quot;),
3747     _g1h(g1h),
3748     _claimer(_g1h-&gt;workers()-&gt;active_workers()),
3749     _humongous_total(0),
3750     _humongous_candidates(0) { }
3751 
3752   ~G1PrepareEvacuationTask() {
3753     _g1h-&gt;set_has_humongous_reclaim_candidate(_humongous_candidates &gt; 0);
3754   }
3755 
3756   void work(uint worker_id) {
3757     G1PrepareRegionsClosure cl(_g1h, this);
3758     _g1h-&gt;heap_region_par_iterate_from_worker_offset(&amp;cl, &amp;_claimer, worker_id);
3759   }
3760 
3761   void add_humongous_candidates(size_t candidates) {
3762     Atomic::add(&amp;_humongous_candidates, candidates);
3763   }
3764 
3765   void add_humongous_total(size_t total) {
3766     Atomic::add(&amp;_humongous_total, total);
3767   }
3768 
3769   size_t humongous_candidates() {
3770     return _humongous_candidates;
3771   }
3772 
3773   size_t humongous_total() {
3774     return _humongous_total;
3775   }
3776 };
3777 
3778 void G1CollectedHeap::pre_evacuate_collection_set(G1EvacuationInfo&amp; evacuation_info, G1ParScanThreadStateSet* per_thread_states) {
3779   _bytes_used_during_gc = 0;
3780 
3781   _expand_heap_after_alloc_failure = true;
3782   _evacuation_failed = false;
3783 
3784   // Disable the hot card cache.
3785   _hot_card_cache-&gt;reset_hot_cache_claimed_index();
3786   _hot_card_cache-&gt;set_use_cache(false);
3787 
3788   // Initialize the GC alloc regions.
3789   _allocator-&gt;init_gc_alloc_regions(evacuation_info);
3790 
3791   {
3792     Ticks start = Ticks::now();
3793     rem_set()-&gt;prepare_for_scan_heap_roots();
3794     phase_times()-&gt;record_prepare_heap_roots_time_ms((Ticks::now() - start).seconds() * 1000.0);
3795   }
3796 
3797   {
3798     G1PrepareEvacuationTask g1_prep_task(this);
3799     Tickspan task_time = run_task(&amp;g1_prep_task);
3800 
3801     phase_times()-&gt;record_register_regions(task_time.seconds() * 1000.0,
3802                                            g1_prep_task.humongous_total(),
3803                                            g1_prep_task.humongous_candidates());
3804   }
3805 
3806   assert(_verifier-&gt;check_region_attr_table(), &quot;Inconsistency in the region attributes table.&quot;);
3807   _preserved_marks_set.assert_empty();
3808 
3809 #if COMPILER2_OR_JVMCI
3810   DerivedPointerTable::clear();
3811 #endif
3812 
3813   // InitialMark needs claim bits to keep track of the marked-through CLDs.
3814   if (collector_state()-&gt;in_initial_mark_gc()) {
3815     concurrent_mark()-&gt;pre_initial_mark();
3816 
3817     double start_clear_claimed_marks = os::elapsedTime();
3818 
3819     ClassLoaderDataGraph::clear_claimed_marks();
3820 
3821     double recorded_clear_claimed_marks_time_ms = (os::elapsedTime() - start_clear_claimed_marks) * 1000.0;
3822     phase_times()-&gt;record_clear_claimed_marks_time_ms(recorded_clear_claimed_marks_time_ms);
3823   }
3824 
3825   // Should G1EvacuationFailureALot be in effect for this GC?
3826   NOT_PRODUCT(set_evacuation_failure_alot_for_current_gc();)
3827 }
3828 
3829 class G1EvacuateRegionsBaseTask : public AbstractGangTask {
3830 protected:
3831   G1CollectedHeap* _g1h;
3832   G1ParScanThreadStateSet* _per_thread_states;
3833   RefToScanQueueSet* _task_queues;
3834   TaskTerminator _terminator;
3835   uint _num_workers;
3836 
3837   void evacuate_live_objects(G1ParScanThreadState* pss,
3838                              uint worker_id,
3839                              G1GCPhaseTimes::GCParPhases objcopy_phase,
3840                              G1GCPhaseTimes::GCParPhases termination_phase) {
3841     G1GCPhaseTimes* p = _g1h-&gt;phase_times();
3842 
3843     Ticks start = Ticks::now();
3844     G1ParEvacuateFollowersClosure cl(_g1h, pss, _task_queues, &amp;_terminator, objcopy_phase);
3845     cl.do_void();
3846 
3847     assert(pss-&gt;queue_is_empty(), &quot;should be empty&quot;);
3848 
3849     Tickspan evac_time = (Ticks::now() - start);
3850     p-&gt;record_or_add_time_secs(objcopy_phase, worker_id, evac_time.seconds() - cl.term_time());
3851 
3852     if (termination_phase == G1GCPhaseTimes::Termination) {
3853       p-&gt;record_time_secs(termination_phase, worker_id, cl.term_time());
3854       p-&gt;record_thread_work_item(termination_phase, worker_id, cl.term_attempts());
3855     } else {
3856       p-&gt;record_or_add_time_secs(termination_phase, worker_id, cl.term_time());
3857       p-&gt;record_or_add_thread_work_item(termination_phase, worker_id, cl.term_attempts());
3858     }
3859     assert(pss-&gt;trim_ticks().seconds() == 0.0, &quot;Unexpected partial trimming during evacuation&quot;);
3860   }
3861 
3862   virtual void start_work(uint worker_id) { }
3863 
3864   virtual void end_work(uint worker_id) { }
3865 
3866   virtual void scan_roots(G1ParScanThreadState* pss, uint worker_id) = 0;
3867 
3868   virtual void evacuate_live_objects(G1ParScanThreadState* pss, uint worker_id) = 0;
3869 
3870 public:
3871   G1EvacuateRegionsBaseTask(const char* name, G1ParScanThreadStateSet* per_thread_states, RefToScanQueueSet* task_queues, uint num_workers) :
3872     AbstractGangTask(name),
3873     _g1h(G1CollectedHeap::heap()),
3874     _per_thread_states(per_thread_states),
3875     _task_queues(task_queues),
3876     _terminator(num_workers, _task_queues),
3877     _num_workers(num_workers)
3878   { }
3879 
3880   void work(uint worker_id) {
3881     start_work(worker_id);
3882 
3883     {
3884       ResourceMark rm;
3885       HandleMark   hm;
3886 
3887       G1ParScanThreadState* pss = _per_thread_states-&gt;state_for_worker(worker_id);
3888       pss-&gt;set_ref_discoverer(_g1h-&gt;ref_processor_stw());
3889 
3890       scan_roots(pss, worker_id);
3891       evacuate_live_objects(pss, worker_id);
3892     }
3893 
3894     end_work(worker_id);
3895   }
3896 };
3897 
3898 class G1EvacuateRegionsTask : public G1EvacuateRegionsBaseTask {
3899   G1RootProcessor* _root_processor;
3900 
3901   void scan_roots(G1ParScanThreadState* pss, uint worker_id) {
3902     _root_processor-&gt;evacuate_roots(pss, worker_id);
3903     _g1h-&gt;rem_set()-&gt;scan_heap_roots(pss, worker_id, G1GCPhaseTimes::ScanHR, G1GCPhaseTimes::ObjCopy);
3904     _g1h-&gt;rem_set()-&gt;scan_collection_set_regions(pss, worker_id, G1GCPhaseTimes::ScanHR, G1GCPhaseTimes::CodeRoots, G1GCPhaseTimes::ObjCopy);
3905   }
3906 
3907   void evacuate_live_objects(G1ParScanThreadState* pss, uint worker_id) {
3908     G1EvacuateRegionsBaseTask::evacuate_live_objects(pss, worker_id, G1GCPhaseTimes::ObjCopy, G1GCPhaseTimes::Termination);
3909   }
3910 
3911   void start_work(uint worker_id) {
3912     _g1h-&gt;phase_times()-&gt;record_time_secs(G1GCPhaseTimes::GCWorkerStart, worker_id, Ticks::now().seconds());
3913   }
3914 
3915   void end_work(uint worker_id) {
3916     _g1h-&gt;phase_times()-&gt;record_time_secs(G1GCPhaseTimes::GCWorkerEnd, worker_id, Ticks::now().seconds());
3917   }
3918 
3919 public:
3920   G1EvacuateRegionsTask(G1CollectedHeap* g1h,
3921                         G1ParScanThreadStateSet* per_thread_states,
3922                         RefToScanQueueSet* task_queues,
3923                         G1RootProcessor* root_processor,
3924                         uint num_workers) :
3925     G1EvacuateRegionsBaseTask(&quot;G1 Evacuate Regions&quot;, per_thread_states, task_queues, num_workers),
3926     _root_processor(root_processor)
3927   { }
3928 };
3929 
3930 void G1CollectedHeap::evacuate_initial_collection_set(G1ParScanThreadStateSet* per_thread_states) {
3931   G1GCPhaseTimes* p = phase_times();
3932 
3933   {
3934     Ticks start = Ticks::now();
3935     rem_set()-&gt;merge_heap_roots(true /* initial_evacuation */);
3936     p-&gt;record_merge_heap_roots_time((Ticks::now() - start).seconds() * 1000.0);
3937   }
3938 
3939   Tickspan task_time;
3940   const uint num_workers = workers()-&gt;active_workers();
3941 
3942   Ticks start_processing = Ticks::now();
3943   {
3944     G1RootProcessor root_processor(this, num_workers);
3945     G1EvacuateRegionsTask g1_par_task(this, per_thread_states, _task_queues, &amp;root_processor, num_workers);
3946     task_time = run_task(&amp;g1_par_task);
3947     // Closing the inner scope will execute the destructor for the G1RootProcessor object.
3948     // To extract its code root fixup time we measure total time of this scope and
3949     // subtract from the time the WorkGang task took.
3950   }
3951   Tickspan total_processing = Ticks::now() - start_processing;
3952 
3953   p-&gt;record_initial_evac_time(task_time.seconds() * 1000.0);
3954   p-&gt;record_or_add_code_root_fixup_time((total_processing - task_time).seconds() * 1000.0);
3955 }
3956 
3957 class G1EvacuateOptionalRegionsTask : public G1EvacuateRegionsBaseTask {
3958 
3959   void scan_roots(G1ParScanThreadState* pss, uint worker_id) {
3960     _g1h-&gt;rem_set()-&gt;scan_heap_roots(pss, worker_id, G1GCPhaseTimes::OptScanHR, G1GCPhaseTimes::OptObjCopy);
3961     _g1h-&gt;rem_set()-&gt;scan_collection_set_regions(pss, worker_id, G1GCPhaseTimes::OptScanHR, G1GCPhaseTimes::OptCodeRoots, G1GCPhaseTimes::OptObjCopy);
3962   }
3963 
3964   void evacuate_live_objects(G1ParScanThreadState* pss, uint worker_id) {
3965     G1EvacuateRegionsBaseTask::evacuate_live_objects(pss, worker_id, G1GCPhaseTimes::OptObjCopy, G1GCPhaseTimes::OptTermination);
3966   }
3967 
3968 public:
3969   G1EvacuateOptionalRegionsTask(G1ParScanThreadStateSet* per_thread_states,
3970                                 RefToScanQueueSet* queues,
3971                                 uint num_workers) :
3972     G1EvacuateRegionsBaseTask(&quot;G1 Evacuate Optional Regions&quot;, per_thread_states, queues, num_workers) {
3973   }
3974 };
3975 
3976 void G1CollectedHeap::evacuate_next_optional_regions(G1ParScanThreadStateSet* per_thread_states) {
3977   class G1MarkScope : public MarkScope { };
3978 
3979   Tickspan task_time;
3980 
3981   Ticks start_processing = Ticks::now();
3982   {
3983     G1MarkScope code_mark_scope;
3984     G1EvacuateOptionalRegionsTask task(per_thread_states, _task_queues, workers()-&gt;active_workers());
3985     task_time = run_task(&amp;task);
3986     // See comment in evacuate_collection_set() for the reason of the scope.
3987   }
3988   Tickspan total_processing = Ticks::now() - start_processing;
3989 
3990   G1GCPhaseTimes* p = phase_times();
3991   p-&gt;record_or_add_code_root_fixup_time((total_processing - task_time).seconds() * 1000.0);
3992 }
3993 
3994 void G1CollectedHeap::evacuate_optional_collection_set(G1ParScanThreadStateSet* per_thread_states) {
3995   const double gc_start_time_ms = phase_times()-&gt;cur_collection_start_sec() * 1000.0;
3996 
3997   while (!evacuation_failed() &amp;&amp; _collection_set.optional_region_length() &gt; 0) {
3998 
3999     double time_used_ms = os::elapsedTime() * 1000.0 - gc_start_time_ms;
4000     double time_left_ms = MaxGCPauseMillis - time_used_ms;
4001 
4002     if (time_left_ms &lt; 0 ||
4003         !_collection_set.finalize_optional_for_evacuation(time_left_ms * policy()-&gt;optional_evacuation_fraction())) {
4004       log_trace(gc, ergo, cset)(&quot;Skipping evacuation of %u optional regions, no more regions can be evacuated in %.3fms&quot;,
4005                                 _collection_set.optional_region_length(), time_left_ms);
4006       break;
4007     }
4008 
4009     {
4010       Ticks start = Ticks::now();
4011       rem_set()-&gt;merge_heap_roots(false /* initial_evacuation */);
4012       phase_times()-&gt;record_or_add_optional_merge_heap_roots_time((Ticks::now() - start).seconds() * 1000.0);
4013     }
4014 
4015     {
4016       Ticks start = Ticks::now();
4017       evacuate_next_optional_regions(per_thread_states);
4018       phase_times()-&gt;record_or_add_optional_evac_time((Ticks::now() - start).seconds() * 1000.0);
4019     }
4020   }
4021 
4022   _collection_set.abandon_optional_collection_set(per_thread_states);
4023 }
4024 
4025 void G1CollectedHeap::post_evacuate_collection_set(G1EvacuationInfo&amp; evacuation_info,
4026                                                    G1RedirtyCardsQueueSet* rdcqs,
4027                                                    G1ParScanThreadStateSet* per_thread_states) {
4028   G1GCPhaseTimes* p = phase_times();
4029 
4030   rem_set()-&gt;cleanup_after_scan_heap_roots();
4031 
4032   // Process any discovered reference objects - we have
4033   // to do this _before_ we retire the GC alloc regions
4034   // as we may have to copy some &#39;reachable&#39; referent
4035   // objects (and their reachable sub-graphs) that were
4036   // not copied during the pause.
4037   process_discovered_references(per_thread_states);
4038 
4039   G1STWIsAliveClosure is_alive(this);
4040   G1KeepAliveClosure keep_alive(this);
4041 
4042   WeakProcessor::weak_oops_do(workers(), &amp;is_alive, &amp;keep_alive, p-&gt;weak_phase_times());
4043 
4044   if (G1StringDedup::is_enabled()) {
4045     double string_dedup_time_ms = os::elapsedTime();
4046 
4047     string_dedup_cleaning(&amp;is_alive, &amp;keep_alive, p);
4048 
4049     double string_cleanup_time_ms = (os::elapsedTime() - string_dedup_time_ms) * 1000.0;
4050     p-&gt;record_string_deduplication_time(string_cleanup_time_ms);
4051   }
4052 
4053   _allocator-&gt;release_gc_alloc_regions(evacuation_info);
4054 
4055   if (evacuation_failed()) {
4056     restore_after_evac_failure(rdcqs);
4057 
4058     // Reset the G1EvacuationFailureALot counters and flags
4059     NOT_PRODUCT(reset_evacuation_should_fail();)
4060 
4061     double recalculate_used_start = os::elapsedTime();
4062     set_used(recalculate_used());
4063     p-&gt;record_evac_fail_recalc_used_time((os::elapsedTime() - recalculate_used_start) * 1000.0);
4064 
4065     if (_archive_allocator != NULL) {
4066       _archive_allocator-&gt;clear_used();
4067     }
4068     for (uint i = 0; i &lt; ParallelGCThreads; i++) {
4069       if (_evacuation_failed_info_array[i].has_failed()) {
4070         _gc_tracer_stw-&gt;report_evacuation_failed(_evacuation_failed_info_array[i]);
4071       }
4072     }
4073   } else {
4074     // The &quot;used&quot; of the the collection set have already been subtracted
4075     // when they were freed.  Add in the bytes used.
4076     increase_used(_bytes_used_during_gc);
4077   }
4078 
4079   _preserved_marks_set.assert_empty();
4080 
4081   merge_per_thread_state_info(per_thread_states);
4082 
4083   // Reset and re-enable the hot card cache.
4084   // Note the counts for the cards in the regions in the
4085   // collection set are reset when the collection set is freed.
4086   _hot_card_cache-&gt;reset_hot_cache();
4087   _hot_card_cache-&gt;set_use_cache(true);
4088 
4089   purge_code_root_memory();
4090 
4091   redirty_logged_cards(rdcqs);
4092 
4093   free_collection_set(&amp;_collection_set, evacuation_info, per_thread_states-&gt;surviving_young_words());
4094 
4095   eagerly_reclaim_humongous_regions();
4096 
4097   record_obj_copy_mem_stats();
4098 
4099   evacuation_info.set_collectionset_used_before(collection_set()-&gt;bytes_used_before());
4100   evacuation_info.set_bytes_used(_bytes_used_during_gc);
4101 
4102 #if COMPILER2_OR_JVMCI
4103   double start = os::elapsedTime();
4104   DerivedPointerTable::update_pointers();
4105   phase_times()-&gt;record_derived_pointer_table_update_time((os::elapsedTime() - start) * 1000.0);
4106 #endif
4107   policy()-&gt;print_age_table();
4108 }
4109 
4110 void G1CollectedHeap::record_obj_copy_mem_stats() {
4111   policy()-&gt;add_bytes_allocated_in_old_since_last_gc(_old_evac_stats.allocated() * HeapWordSize);
4112 
4113   _gc_tracer_stw-&gt;report_evacuation_statistics(create_g1_evac_summary(&amp;_survivor_evac_stats),
4114                                                create_g1_evac_summary(&amp;_old_evac_stats));
4115 }
4116 
4117 void G1CollectedHeap::free_region(HeapRegion* hr, FreeRegionList* free_list) {
4118   assert(!hr-&gt;is_free(), &quot;the region should not be free&quot;);
4119   assert(!hr-&gt;is_empty(), &quot;the region should not be empty&quot;);
4120   assert(_hrm-&gt;is_available(hr-&gt;hrm_index()), &quot;region should be committed&quot;);
4121 
4122   if (G1VerifyBitmaps) {
4123     MemRegion mr(hr-&gt;bottom(), hr-&gt;end());
4124     concurrent_mark()-&gt;clear_range_in_prev_bitmap(mr);
4125   }
4126 
4127   // Clear the card counts for this region.
4128   // Note: we only need to do this if the region is not young
4129   // (since we don&#39;t refine cards in young regions).
4130   if (!hr-&gt;is_young()) {
4131     _hot_card_cache-&gt;reset_card_counts(hr);
4132   }
4133 
4134   // Reset region metadata to allow reuse.
4135   hr-&gt;hr_clear(true /* clear_space */);
4136   _policy-&gt;remset_tracker()-&gt;update_at_free(hr);
4137 
4138   if (free_list != NULL) {
4139     free_list-&gt;add_ordered(hr);
4140   }
4141 }
4142 
4143 void G1CollectedHeap::free_humongous_region(HeapRegion* hr,
4144                                             FreeRegionList* free_list) {
4145   assert(hr-&gt;is_humongous(), &quot;this is only for humongous regions&quot;);
4146   assert(free_list != NULL, &quot;pre-condition&quot;);
4147   hr-&gt;clear_humongous();
4148   free_region(hr, free_list);
4149 }
4150 
4151 void G1CollectedHeap::remove_from_old_sets(const uint old_regions_removed,
4152                                            const uint humongous_regions_removed) {
4153   if (old_regions_removed &gt; 0 || humongous_regions_removed &gt; 0) {
4154     MutexLocker x(OldSets_lock, Mutex::_no_safepoint_check_flag);
4155     _old_set.bulk_remove(old_regions_removed);
4156     _humongous_set.bulk_remove(humongous_regions_removed);
4157   }
4158 
4159 }
4160 
4161 void G1CollectedHeap::prepend_to_freelist(FreeRegionList* list) {
4162   assert(list != NULL, &quot;list can&#39;t be null&quot;);
4163   if (!list-&gt;is_empty()) {
4164     MutexLocker x(FreeList_lock, Mutex::_no_safepoint_check_flag);
4165     _hrm-&gt;insert_list_into_free_list(list);
4166   }
4167 }
4168 
4169 void G1CollectedHeap::decrement_summary_bytes(size_t bytes) {
4170   decrease_used(bytes);
4171 }
4172 
4173 class G1FreeCollectionSetTask : public AbstractGangTask {
4174   // Helper class to keep statistics for the collection set freeing
4175   class FreeCSetStats {
4176     size_t _before_used_bytes;   // Usage in regions successfully evacutate
4177     size_t _after_used_bytes;    // Usage in regions failing evacuation
4178     size_t _bytes_allocated_in_old_since_last_gc; // Size of young regions turned into old
4179     size_t _failure_used_words;  // Live size in failed regions
4180     size_t _failure_waste_words; // Wasted size in failed regions
4181     size_t _rs_length;           // Remembered set size
4182     uint _regions_freed;         // Number of regions freed
4183   public:
4184     FreeCSetStats() :
4185         _before_used_bytes(0),
4186         _after_used_bytes(0),
4187         _bytes_allocated_in_old_since_last_gc(0),
4188         _failure_used_words(0),
4189         _failure_waste_words(0),
4190         _rs_length(0),
4191         _regions_freed(0) { }
4192 
4193     void merge_stats(FreeCSetStats* other) {
4194       assert(other != NULL, &quot;invariant&quot;);
4195       _before_used_bytes += other-&gt;_before_used_bytes;
4196       _after_used_bytes += other-&gt;_after_used_bytes;
4197       _bytes_allocated_in_old_since_last_gc += other-&gt;_bytes_allocated_in_old_since_last_gc;
4198       _failure_used_words += other-&gt;_failure_used_words;
4199       _failure_waste_words += other-&gt;_failure_waste_words;
4200       _rs_length += other-&gt;_rs_length;
4201       _regions_freed += other-&gt;_regions_freed;
4202     }
4203 
4204     void report(G1CollectedHeap* g1h, G1EvacuationInfo* evacuation_info) {
4205       evacuation_info-&gt;set_regions_freed(_regions_freed);
4206       evacuation_info-&gt;increment_collectionset_used_after(_after_used_bytes);
4207 
4208       g1h-&gt;decrement_summary_bytes(_before_used_bytes);
4209       g1h-&gt;alloc_buffer_stats(G1HeapRegionAttr::Old)-&gt;add_failure_used_and_waste(_failure_used_words, _failure_waste_words);
4210 
4211       G1Policy *policy = g1h-&gt;policy();
4212       policy-&gt;add_bytes_allocated_in_old_since_last_gc(_bytes_allocated_in_old_since_last_gc);
4213       policy-&gt;record_rs_length(_rs_length);
4214       policy-&gt;cset_regions_freed();
4215     }
4216 
4217     void account_failed_region(HeapRegion* r) {
4218       size_t used_words = r-&gt;marked_bytes() / HeapWordSize;
4219       _failure_used_words += used_words;
4220       _failure_waste_words += HeapRegion::GrainWords - used_words;
4221       _after_used_bytes += r-&gt;used();
4222 
4223       // When moving a young gen region to old gen, we &quot;allocate&quot; that whole
4224       // region there. This is in addition to any already evacuated objects.
4225       // Notify the policy about that. Old gen regions do not cause an
4226       // additional allocation: both the objects still in the region and the
4227       // ones already moved are accounted for elsewhere.
4228       if (r-&gt;is_young()) {
4229         _bytes_allocated_in_old_since_last_gc += HeapRegion::GrainBytes;
4230       }
4231     }
4232 
4233     void account_evacuated_region(HeapRegion* r) {
4234       _before_used_bytes += r-&gt;used();
4235       _regions_freed += 1;
4236     }
4237 
4238     void account_rs_length(HeapRegion* r) {
4239       _rs_length += r-&gt;rem_set()-&gt;occupied();
4240     }
4241   };
4242 
4243   // Closure applied to all regions in the collection set.
4244   class FreeCSetClosure : public HeapRegionClosure {
4245     // Helper to send JFR events for regions.
4246     class JFREventForRegion {
4247       EventGCPhaseParallel _event;
4248     public:
4249       JFREventForRegion(HeapRegion* region, uint worker_id) : _event() {
4250         _event.set_gcId(GCId::current());
4251         _event.set_gcWorkerId(worker_id);
4252         if (region-&gt;is_young()) {
4253           _event.set_name(G1GCPhaseTimes::phase_name(G1GCPhaseTimes::YoungFreeCSet));
4254         } else {
4255           _event.set_name(G1GCPhaseTimes::phase_name(G1GCPhaseTimes::NonYoungFreeCSet));
4256         }
4257       }
4258 
4259       ~JFREventForRegion() {
4260         _event.commit();
4261       }
4262     };
4263 
4264     // Helper to do timing for region work.
4265     class TimerForRegion {
4266       Tickspan&amp; _time;
4267       Ticks     _start_time;
4268     public:
4269       TimerForRegion(Tickspan&amp; time) : _time(time), _start_time(Ticks::now()) { }
4270       ~TimerForRegion() {
4271         _time += Ticks::now() - _start_time;
4272       }
4273     };
4274 
4275     // FreeCSetClosure members
4276     G1CollectedHeap* _g1h;
4277     const size_t*    _surviving_young_words;
4278     uint             _worker_id;
4279     Tickspan         _young_time;
4280     Tickspan         _non_young_time;
4281     FreeCSetStats*   _stats;
4282 
4283     void assert_in_cset(HeapRegion* r) {
4284       assert(r-&gt;young_index_in_cset() != 0 &amp;&amp;
4285              (uint)r-&gt;young_index_in_cset() &lt;= _g1h-&gt;collection_set()-&gt;young_region_length(),
4286              &quot;Young index %u is wrong for region %u of type %s with %u young regions&quot;,
4287              r-&gt;young_index_in_cset(), r-&gt;hrm_index(), r-&gt;get_type_str(), _g1h-&gt;collection_set()-&gt;young_region_length());
4288     }
4289 
4290     void handle_evacuated_region(HeapRegion* r) {
4291       assert(!r-&gt;is_empty(), &quot;Region %u is an empty region in the collection set.&quot;, r-&gt;hrm_index());
4292       stats()-&gt;account_evacuated_region(r);
4293 
4294       // Free the region and and its remembered set.
4295       _g1h-&gt;free_region(r, NULL);
4296     }
4297 
4298     void handle_failed_region(HeapRegion* r) {
4299       // Do some allocation statistics accounting. Regions that failed evacuation
4300       // are always made old, so there is no need to update anything in the young
4301       // gen statistics, but we need to update old gen statistics.
4302       stats()-&gt;account_failed_region(r);
4303 
4304       // Update the region state due to the failed evacuation.
4305       r-&gt;handle_evacuation_failure();
4306 
4307       // Add region to old set, need to hold lock.
4308       MutexLocker x(OldSets_lock, Mutex::_no_safepoint_check_flag);
4309       _g1h-&gt;old_set_add(r);
4310     }
4311 
4312     Tickspan&amp; timer_for_region(HeapRegion* r) {
4313       return r-&gt;is_young() ? _young_time : _non_young_time;
4314     }
4315 
4316     FreeCSetStats* stats() {
4317       return _stats;
4318     }
4319   public:
4320     FreeCSetClosure(const size_t* surviving_young_words,
4321                     uint worker_id,
4322                     FreeCSetStats* stats) :
4323         HeapRegionClosure(),
4324         _g1h(G1CollectedHeap::heap()),
4325         _surviving_young_words(surviving_young_words),
4326         _worker_id(worker_id),
4327         _young_time(),
4328         _non_young_time(),
4329         _stats(stats) { }
4330 
4331     virtual bool do_heap_region(HeapRegion* r) {
4332       assert(r-&gt;in_collection_set(), &quot;Invariant: %u missing from CSet&quot;, r-&gt;hrm_index());
4333       JFREventForRegion event(r, _worker_id);
4334       TimerForRegion timer(timer_for_region(r));
4335 
4336       _g1h-&gt;clear_region_attr(r);
4337       stats()-&gt;account_rs_length(r);
4338 
4339       if (r-&gt;is_young()) {
4340         assert_in_cset(r);
4341         r-&gt;record_surv_words_in_group(_surviving_young_words[r-&gt;young_index_in_cset()]);
4342       }
4343 
4344       if (r-&gt;evacuation_failed()) {
4345         handle_failed_region(r);
4346       } else {
4347         handle_evacuated_region(r);
4348       }
4349       assert(!_g1h-&gt;is_on_master_free_list(r), &quot;sanity&quot;);
4350 
4351       return false;
4352     }
4353 
4354     void report_timing(Tickspan parallel_time) {
4355       G1GCPhaseTimes* pt = _g1h-&gt;phase_times();
4356       pt-&gt;record_time_secs(G1GCPhaseTimes::ParFreeCSet, _worker_id, parallel_time.seconds());
4357       if (_young_time.value() &gt; 0) {
4358         pt-&gt;record_time_secs(G1GCPhaseTimes::YoungFreeCSet, _worker_id, _young_time.seconds());
4359       }
4360       if (_non_young_time.value() &gt; 0) {
4361         pt-&gt;record_time_secs(G1GCPhaseTimes::NonYoungFreeCSet, _worker_id, _non_young_time.seconds());
4362       }
4363     }
4364   };
4365 
4366   // G1FreeCollectionSetTask members
4367   G1CollectedHeap*  _g1h;
4368   G1EvacuationInfo* _evacuation_info;
4369   FreeCSetStats*    _worker_stats;
4370   HeapRegionClaimer _claimer;
4371   const size_t*     _surviving_young_words;
4372   uint              _active_workers;
4373 
4374   FreeCSetStats* worker_stats(uint worker) {
4375     return &amp;_worker_stats[worker];
4376   }
4377 
4378   void report_statistics() {
4379     // Merge the accounting
4380     FreeCSetStats total_stats;
4381     for (uint worker = 0; worker &lt; _active_workers; worker++) {
4382       total_stats.merge_stats(worker_stats(worker));
4383     }
4384     total_stats.report(_g1h, _evacuation_info);
4385   }
4386 
4387 public:
4388   G1FreeCollectionSetTask(G1EvacuationInfo* evacuation_info, const size_t* surviving_young_words, uint active_workers) :
4389       AbstractGangTask(&quot;G1 Free Collection Set&quot;),
4390       _g1h(G1CollectedHeap::heap()),
4391       _evacuation_info(evacuation_info),
4392       _worker_stats(NEW_C_HEAP_ARRAY(FreeCSetStats, active_workers, mtGC)),
4393       _claimer(active_workers),
4394       _surviving_young_words(surviving_young_words),
4395       _active_workers(active_workers) {
4396     for (uint worker = 0; worker &lt; active_workers; worker++) {
4397       ::new (&amp;_worker_stats[worker]) FreeCSetStats();
4398     }
4399   }
4400 
4401   ~G1FreeCollectionSetTask() {
4402     Ticks serial_time = Ticks::now();
4403     report_statistics();
4404     for (uint worker = 0; worker &lt; _active_workers; worker++) {
4405       _worker_stats[worker].~FreeCSetStats();
4406     }
4407     FREE_C_HEAP_ARRAY(FreeCSetStats, _worker_stats);
4408     _g1h-&gt;phase_times()-&gt;record_serial_free_cset_time_ms((Ticks::now() - serial_time).seconds() * 1000.0);
4409   }
4410 
4411   virtual void work(uint worker_id) {
4412     EventGCPhaseParallel event;
4413     Ticks start = Ticks::now();
4414     FreeCSetClosure cl(_surviving_young_words, worker_id, worker_stats(worker_id));
4415     _g1h-&gt;collection_set_par_iterate_all(&amp;cl, &amp;_claimer, worker_id);
4416 
4417     // Report the total parallel time along with some more detailed metrics.
4418     cl.report_timing(Ticks::now() - start);
4419     event.commit(GCId::current(), worker_id, G1GCPhaseTimes::phase_name(G1GCPhaseTimes::ParFreeCSet));
4420   }
4421 };
4422 
4423 void G1CollectedHeap::free_collection_set(G1CollectionSet* collection_set, G1EvacuationInfo&amp; evacuation_info, const size_t* surviving_young_words) {
4424   _eden.clear();
4425 
4426   // The free collections set is split up in two tasks, the first
4427   // frees the collection set and records what regions are free,
4428   // and the second one rebuilds the free list. This proved to be
4429   // more efficient than adding a sorted list to another.
4430 
4431   Ticks free_cset_start_time = Ticks::now();
4432   {
4433     uint const num_cs_regions = _collection_set.region_length();
4434     uint const num_workers = clamp(num_cs_regions, 1u, workers()-&gt;active_workers());
4435     G1FreeCollectionSetTask cl(&amp;evacuation_info, surviving_young_words, num_workers);
4436 
4437     log_debug(gc, ergo)(&quot;Running %s using %u workers for collection set length %u (%u)&quot;,
4438                         cl.name(), num_workers, num_cs_regions, num_regions());
4439     workers()-&gt;run_task(&amp;cl, num_workers);
4440   }
4441 
4442   Ticks free_cset_end_time = Ticks::now();
4443   phase_times()-&gt;record_total_free_cset_time_ms((free_cset_end_time - free_cset_start_time).seconds() * 1000.0);
4444 
4445   // Now rebuild the free region list.
4446   hrm()-&gt;rebuild_free_list(workers());
4447   phase_times()-&gt;record_total_rebuild_freelist_time_ms((Ticks::now() - free_cset_end_time).seconds() * 1000.0);
4448 
4449   collection_set-&gt;clear();
4450 }
4451 
4452 class G1FreeHumongousRegionClosure : public HeapRegionClosure {
4453  private:
4454   FreeRegionList* _free_region_list;
4455   HeapRegionSet* _proxy_set;
4456   uint _humongous_objects_reclaimed;
4457   uint _humongous_regions_reclaimed;
4458   size_t _freed_bytes;
4459  public:
4460 
4461   G1FreeHumongousRegionClosure(FreeRegionList* free_region_list) :
4462     _free_region_list(free_region_list), _proxy_set(NULL), _humongous_objects_reclaimed(0), _humongous_regions_reclaimed(0), _freed_bytes(0) {
4463   }
4464 
4465   virtual bool do_heap_region(HeapRegion* r) {
4466     if (!r-&gt;is_starts_humongous()) {
4467       return false;
4468     }
4469 
4470     G1CollectedHeap* g1h = G1CollectedHeap::heap();
4471 
4472     oop obj = (oop)r-&gt;bottom();
4473     G1CMBitMap* next_bitmap = g1h-&gt;concurrent_mark()-&gt;next_mark_bitmap();
4474 
4475     // The following checks whether the humongous object is live are sufficient.
4476     // The main additional check (in addition to having a reference from the roots
4477     // or the young gen) is whether the humongous object has a remembered set entry.
4478     //
4479     // A humongous object cannot be live if there is no remembered set for it
4480     // because:
4481     // - there can be no references from within humongous starts regions referencing
4482     // the object because we never allocate other objects into them.
4483     // (I.e. there are no intra-region references that may be missed by the
4484     // remembered set)
4485     // - as soon there is a remembered set entry to the humongous starts region
4486     // (i.e. it has &quot;escaped&quot; to an old object) this remembered set entry will stay
4487     // until the end of a concurrent mark.
4488     //
4489     // It is not required to check whether the object has been found dead by marking
4490     // or not, in fact it would prevent reclamation within a concurrent cycle, as
4491     // all objects allocated during that time are considered live.
4492     // SATB marking is even more conservative than the remembered set.
4493     // So if at this point in the collection there is no remembered set entry,
4494     // nobody has a reference to it.
4495     // At the start of collection we flush all refinement logs, and remembered sets
4496     // are completely up-to-date wrt to references to the humongous object.
4497     //
4498     // Other implementation considerations:
4499     // - never consider object arrays at this time because they would pose
4500     // considerable effort for cleaning up the the remembered sets. This is
4501     // required because stale remembered sets might reference locations that
4502     // are currently allocated into.
4503     uint region_idx = r-&gt;hrm_index();
4504     if (!g1h-&gt;is_humongous_reclaim_candidate(region_idx) ||
4505         !r-&gt;rem_set()-&gt;is_empty()) {
4506       log_debug(gc, humongous)(&quot;Live humongous region %u object size &quot; SIZE_FORMAT &quot; start &quot; PTR_FORMAT &quot;  with remset &quot; SIZE_FORMAT &quot; code roots &quot; SIZE_FORMAT &quot; is marked %d reclaim candidate %d type array %d&quot;,
4507                                region_idx,
4508                                (size_t)obj-&gt;size() * HeapWordSize,
4509                                p2i(r-&gt;bottom()),
4510                                r-&gt;rem_set()-&gt;occupied(),
4511                                r-&gt;rem_set()-&gt;strong_code_roots_list_length(),
4512                                next_bitmap-&gt;is_marked(r-&gt;bottom()),
4513                                g1h-&gt;is_humongous_reclaim_candidate(region_idx),
4514                                obj-&gt;is_typeArray()
4515                               );
4516       return false;
4517     }
4518 
4519     guarantee(obj-&gt;is_typeArray(),
4520               &quot;Only eagerly reclaiming type arrays is supported, but the object &quot;
4521               PTR_FORMAT &quot; is not.&quot;, p2i(r-&gt;bottom()));
4522 
4523     log_debug(gc, humongous)(&quot;Dead humongous region %u object size &quot; SIZE_FORMAT &quot; start &quot; PTR_FORMAT &quot; with remset &quot; SIZE_FORMAT &quot; code roots &quot; SIZE_FORMAT &quot; is marked %d reclaim candidate %d type array %d&quot;,
4524                              region_idx,
4525                              (size_t)obj-&gt;size() * HeapWordSize,
4526                              p2i(r-&gt;bottom()),
4527                              r-&gt;rem_set()-&gt;occupied(),
4528                              r-&gt;rem_set()-&gt;strong_code_roots_list_length(),
4529                              next_bitmap-&gt;is_marked(r-&gt;bottom()),
4530                              g1h-&gt;is_humongous_reclaim_candidate(region_idx),
4531                              obj-&gt;is_typeArray()
4532                             );
4533 
4534     G1ConcurrentMark* const cm = g1h-&gt;concurrent_mark();
4535     cm-&gt;humongous_object_eagerly_reclaimed(r);
4536     assert(!cm-&gt;is_marked_in_prev_bitmap(obj) &amp;&amp; !cm-&gt;is_marked_in_next_bitmap(obj),
4537            &quot;Eagerly reclaimed humongous region %u should not be marked at all but is in prev %s next %s&quot;,
4538            region_idx,
4539            BOOL_TO_STR(cm-&gt;is_marked_in_prev_bitmap(obj)),
4540            BOOL_TO_STR(cm-&gt;is_marked_in_next_bitmap(obj)));
4541     _humongous_objects_reclaimed++;
4542     do {
4543       HeapRegion* next = g1h-&gt;next_region_in_humongous(r);
4544       _freed_bytes += r-&gt;used();
4545       r-&gt;set_containing_set(NULL);
4546       _humongous_regions_reclaimed++;
4547       g1h-&gt;free_humongous_region(r, _free_region_list);
4548       r = next;
4549     } while (r != NULL);
4550 
4551     return false;
4552   }
4553 
4554   uint humongous_objects_reclaimed() {
4555     return _humongous_objects_reclaimed;
4556   }
4557 
4558   uint humongous_regions_reclaimed() {
4559     return _humongous_regions_reclaimed;
4560   }
4561 
4562   size_t bytes_freed() const {
4563     return _freed_bytes;
4564   }
4565 };
4566 
4567 void G1CollectedHeap::eagerly_reclaim_humongous_regions() {
4568   assert_at_safepoint_on_vm_thread();
4569 
4570   if (!G1EagerReclaimHumongousObjects ||
4571       (!_has_humongous_reclaim_candidates &amp;&amp; !log_is_enabled(Debug, gc, humongous))) {
4572     phase_times()-&gt;record_fast_reclaim_humongous_time_ms(0.0, 0);
4573     return;
4574   }
4575 
4576   double start_time = os::elapsedTime();
4577 
4578   FreeRegionList local_cleanup_list(&quot;Local Humongous Cleanup List&quot;);
4579 
4580   G1FreeHumongousRegionClosure cl(&amp;local_cleanup_list);
4581   heap_region_iterate(&amp;cl);
4582 
4583   remove_from_old_sets(0, cl.humongous_regions_reclaimed());
4584 
4585   G1HRPrinter* hrp = hr_printer();
4586   if (hrp-&gt;is_active()) {
4587     FreeRegionListIterator iter(&amp;local_cleanup_list);
4588     while (iter.more_available()) {
4589       HeapRegion* hr = iter.get_next();
4590       hrp-&gt;cleanup(hr);
4591     }
4592   }
4593 
4594   prepend_to_freelist(&amp;local_cleanup_list);
4595   decrement_summary_bytes(cl.bytes_freed());
4596 
4597   phase_times()-&gt;record_fast_reclaim_humongous_time_ms((os::elapsedTime() - start_time) * 1000.0,
4598                                                        cl.humongous_objects_reclaimed());
4599 }
4600 
4601 class G1AbandonCollectionSetClosure : public HeapRegionClosure {
4602 public:
4603   virtual bool do_heap_region(HeapRegion* r) {
4604     assert(r-&gt;in_collection_set(), &quot;Region %u must have been in collection set&quot;, r-&gt;hrm_index());
4605     G1CollectedHeap::heap()-&gt;clear_region_attr(r);
4606     r-&gt;clear_young_index_in_cset();
4607     return false;
4608   }
4609 };
4610 
4611 void G1CollectedHeap::abandon_collection_set(G1CollectionSet* collection_set) {
4612   G1AbandonCollectionSetClosure cl;
4613   collection_set_iterate_all(&amp;cl);
4614 
4615   collection_set-&gt;clear();
4616   collection_set-&gt;stop_incremental_building();
4617 }
4618 
4619 bool G1CollectedHeap::is_old_gc_alloc_region(HeapRegion* hr) {
4620   return _allocator-&gt;is_retained_old_region(hr);
4621 }
4622 
4623 void G1CollectedHeap::set_region_short_lived_locked(HeapRegion* hr) {
4624   _eden.add(hr);
4625   _policy-&gt;set_region_eden(hr);
4626 }
4627 
4628 #ifdef ASSERT
4629 
4630 class NoYoungRegionsClosure: public HeapRegionClosure {
4631 private:
4632   bool _success;
4633 public:
4634   NoYoungRegionsClosure() : _success(true) { }
4635   bool do_heap_region(HeapRegion* r) {
4636     if (r-&gt;is_young()) {
4637       log_error(gc, verify)(&quot;Region [&quot; PTR_FORMAT &quot;, &quot; PTR_FORMAT &quot;) tagged as young&quot;,
4638                             p2i(r-&gt;bottom()), p2i(r-&gt;end()));
4639       _success = false;
4640     }
4641     return false;
4642   }
4643   bool success() { return _success; }
4644 };
4645 
4646 bool G1CollectedHeap::check_young_list_empty() {
4647   bool ret = (young_regions_count() == 0);
4648 
4649   NoYoungRegionsClosure closure;
4650   heap_region_iterate(&amp;closure);
4651   ret = ret &amp;&amp; closure.success();
4652 
4653   return ret;
4654 }
4655 
4656 #endif // ASSERT
4657 
4658 class TearDownRegionSetsClosure : public HeapRegionClosure {
4659   HeapRegionSet *_old_set;
4660 
4661 public:
4662   TearDownRegionSetsClosure(HeapRegionSet* old_set) : _old_set(old_set) { }
4663 
4664   bool do_heap_region(HeapRegion* r) {
4665     if (r-&gt;is_old()) {
4666       _old_set-&gt;remove(r);
4667     } else if(r-&gt;is_young()) {
4668       r-&gt;uninstall_surv_rate_group();
4669     } else {
4670       // We ignore free regions, we&#39;ll empty the free list afterwards.
4671       // We ignore humongous and archive regions, we&#39;re not tearing down these
4672       // sets.
4673       assert(r-&gt;is_archive() || r-&gt;is_free() || r-&gt;is_humongous(),
4674              &quot;it cannot be another type&quot;);
4675     }
4676     return false;
4677   }
4678 
4679   ~TearDownRegionSetsClosure() {
4680     assert(_old_set-&gt;is_empty(), &quot;post-condition&quot;);
4681   }
4682 };
4683 
4684 void G1CollectedHeap::tear_down_region_sets(bool free_list_only) {
4685   assert_at_safepoint_on_vm_thread();
4686 
4687   if (!free_list_only) {
4688     TearDownRegionSetsClosure cl(&amp;_old_set);
4689     heap_region_iterate(&amp;cl);
4690 
4691     // Note that emptying the _young_list is postponed and instead done as
4692     // the first step when rebuilding the regions sets again. The reason for
4693     // this is that during a full GC string deduplication needs to know if
4694     // a collected region was young or old when the full GC was initiated.
4695   }
4696   _hrm-&gt;remove_all_free_regions();
4697 }
4698 
4699 void G1CollectedHeap::increase_used(size_t bytes) {
4700   _summary_bytes_used += bytes;
4701 }
4702 
4703 void G1CollectedHeap::decrease_used(size_t bytes) {
4704   assert(_summary_bytes_used &gt;= bytes,
4705          &quot;invariant: _summary_bytes_used: &quot; SIZE_FORMAT &quot; should be &gt;= bytes: &quot; SIZE_FORMAT,
4706          _summary_bytes_used, bytes);
4707   _summary_bytes_used -= bytes;
4708 }
4709 
4710 void G1CollectedHeap::set_used(size_t bytes) {
4711   _summary_bytes_used = bytes;
4712 }
4713 
4714 class RebuildRegionSetsClosure : public HeapRegionClosure {
4715 private:
4716   bool _free_list_only;
4717 
4718   HeapRegionSet* _old_set;
4719   HeapRegionManager* _hrm;
4720 
4721   size_t _total_used;
4722 
4723 public:
4724   RebuildRegionSetsClosure(bool free_list_only,
4725                            HeapRegionSet* old_set,
4726                            HeapRegionManager* hrm) :
4727     _free_list_only(free_list_only),
4728     _old_set(old_set), _hrm(hrm), _total_used(0) {
4729     assert(_hrm-&gt;num_free_regions() == 0, &quot;pre-condition&quot;);
4730     if (!free_list_only) {
4731       assert(_old_set-&gt;is_empty(), &quot;pre-condition&quot;);
4732     }
4733   }
4734 
4735   bool do_heap_region(HeapRegion* r) {
4736     if (r-&gt;is_empty()) {
4737       assert(r-&gt;rem_set()-&gt;is_empty(), &quot;Empty regions should have empty remembered sets.&quot;);
4738       // Add free regions to the free list
4739       r-&gt;set_free();
4740       _hrm-&gt;insert_into_free_list(r);
4741     } else if (!_free_list_only) {
4742       assert(r-&gt;rem_set()-&gt;is_empty(), &quot;At this point remembered sets must have been cleared.&quot;);
4743 
4744       if (r-&gt;is_archive() || r-&gt;is_humongous()) {
4745         // We ignore archive and humongous regions. We left these sets unchanged.
4746       } else {
4747         assert(r-&gt;is_young() || r-&gt;is_free() || r-&gt;is_old(), &quot;invariant&quot;);
4748         // We now move all (non-humongous, non-old, non-archive) regions to old gen, and register them as such.
4749         r-&gt;move_to_old();
4750         _old_set-&gt;add(r);
4751       }
4752       _total_used += r-&gt;used();
4753     }
4754 
4755     return false;
4756   }
4757 
4758   size_t total_used() {
4759     return _total_used;
4760   }
4761 };
4762 
4763 void G1CollectedHeap::rebuild_region_sets(bool free_list_only) {
4764   assert_at_safepoint_on_vm_thread();
4765 
4766   if (!free_list_only) {
4767     _eden.clear();
4768     _survivor.clear();
4769   }
4770 
4771   RebuildRegionSetsClosure cl(free_list_only, &amp;_old_set, _hrm);
4772   heap_region_iterate(&amp;cl);
4773 
4774   if (!free_list_only) {
4775     set_used(cl.total_used());
4776     if (_archive_allocator != NULL) {
4777       _archive_allocator-&gt;clear_used();
4778     }
4779   }
4780   assert_used_and_recalculate_used_equal(this);
4781 }
4782 
4783 // Methods for the mutator alloc region
4784 
4785 HeapRegion* G1CollectedHeap::new_mutator_alloc_region(size_t word_size,
4786                                                       bool force,
4787                                                       uint node_index) {
4788   assert_heap_locked_or_at_safepoint(true /* should_be_vm_thread */);
4789   bool should_allocate = policy()-&gt;should_allocate_mutator_region();
4790   if (force || should_allocate) {
4791     HeapRegion* new_alloc_region = new_region(word_size,
4792                                               HeapRegionType::Eden,
4793                                               false /* do_expand */,
4794                                               node_index);
4795     if (new_alloc_region != NULL) {
4796       set_region_short_lived_locked(new_alloc_region);
4797       _hr_printer.alloc(new_alloc_region, !should_allocate);
4798       _verifier-&gt;check_bitmaps(&quot;Mutator Region Allocation&quot;, new_alloc_region);
4799       _policy-&gt;remset_tracker()-&gt;update_at_allocate(new_alloc_region);
4800       return new_alloc_region;
4801     }
4802   }
4803   return NULL;
4804 }
4805 
4806 void G1CollectedHeap::retire_mutator_alloc_region(HeapRegion* alloc_region,
4807                                                   size_t allocated_bytes) {
4808   assert_heap_locked_or_at_safepoint(true /* should_be_vm_thread */);
4809   assert(alloc_region-&gt;is_eden(), &quot;all mutator alloc regions should be eden&quot;);
4810 
4811   collection_set()-&gt;add_eden_region(alloc_region);
4812   increase_used(allocated_bytes);
4813   _eden.add_used_bytes(allocated_bytes);
4814   _hr_printer.retire(alloc_region);
4815 
4816   // We update the eden sizes here, when the region is retired,
4817   // instead of when it&#39;s allocated, since this is the point that its
4818   // used space has been recorded in _summary_bytes_used.
4819   g1mm()-&gt;update_eden_size();
4820 }
4821 
4822 // Methods for the GC alloc regions
4823 
4824 bool G1CollectedHeap::has_more_regions(G1HeapRegionAttr dest) {
4825   if (dest.is_old()) {
4826     return true;
4827   } else {
4828     return survivor_regions_count() &lt; policy()-&gt;max_survivor_regions();
4829   }
4830 }
4831 
4832 HeapRegion* G1CollectedHeap::new_gc_alloc_region(size_t word_size, G1HeapRegionAttr dest, uint node_index) {
4833   assert(FreeList_lock-&gt;owned_by_self(), &quot;pre-condition&quot;);
4834 
4835   if (!has_more_regions(dest)) {
4836     return NULL;
4837   }
4838 
4839   HeapRegionType type;
4840   if (dest.is_young()) {
4841     type = HeapRegionType::Survivor;
4842   } else {
4843     type = HeapRegionType::Old;
4844   }
4845 
4846   HeapRegion* new_alloc_region = new_region(word_size,
4847                                             type,
4848                                             true /* do_expand */,
4849                                             node_index);
4850 
4851   if (new_alloc_region != NULL) {
4852     if (type.is_survivor()) {
4853       new_alloc_region-&gt;set_survivor();
4854       _survivor.add(new_alloc_region);
4855       _verifier-&gt;check_bitmaps(&quot;Survivor Region Allocation&quot;, new_alloc_region);
4856     } else {
4857       new_alloc_region-&gt;set_old();
4858       _verifier-&gt;check_bitmaps(&quot;Old Region Allocation&quot;, new_alloc_region);
4859     }
4860     _policy-&gt;remset_tracker()-&gt;update_at_allocate(new_alloc_region);
4861     register_region_with_region_attr(new_alloc_region);
4862     _hr_printer.alloc(new_alloc_region);
4863     return new_alloc_region;
4864   }
4865   return NULL;
4866 }
4867 
4868 void G1CollectedHeap::retire_gc_alloc_region(HeapRegion* alloc_region,
4869                                              size_t allocated_bytes,
4870                                              G1HeapRegionAttr dest) {
4871   _bytes_used_during_gc += allocated_bytes;
4872   if (dest.is_old()) {
4873     old_set_add(alloc_region);
4874   } else {
4875     assert(dest.is_young(), &quot;Retiring alloc region should be young (%d)&quot;, dest.type());
4876     _survivor.add_used_bytes(allocated_bytes);
4877   }
4878 
4879   bool const during_im = collector_state()-&gt;in_initial_mark_gc();
4880   if (during_im &amp;&amp; allocated_bytes &gt; 0) {
4881     _cm-&gt;root_regions()-&gt;add(alloc_region-&gt;next_top_at_mark_start(), alloc_region-&gt;top());
4882   }
4883   _hr_printer.retire(alloc_region);
4884 }
4885 
4886 HeapRegion* G1CollectedHeap::alloc_highest_free_region() {
4887   bool expanded = false;
4888   uint index = _hrm-&gt;find_highest_free(&amp;expanded);
4889 
4890   if (index != G1_NO_HRM_INDEX) {
4891     if (expanded) {
4892       log_debug(gc, ergo, heap)(&quot;Attempt heap expansion (requested address range outside heap bounds). region size: &quot; SIZE_FORMAT &quot;B&quot;,
4893                                 HeapRegion::GrainWords * HeapWordSize);
4894     }
4895     _hrm-&gt;allocate_free_regions_starting_at(index, 1);
4896     return region_at(index);
4897   }
4898   return NULL;
4899 }
4900 
4901 // Optimized nmethod scanning
4902 
4903 class RegisterNMethodOopClosure: public OopClosure {
4904   G1CollectedHeap* _g1h;
4905   nmethod* _nm;
4906 
4907   template &lt;class T&gt; void do_oop_work(T* p) {
4908     T heap_oop = RawAccess&lt;&gt;::oop_load(p);
4909     if (!CompressedOops::is_null(heap_oop)) {
4910       oop obj = CompressedOops::decode_not_null(heap_oop);
4911       HeapRegion* hr = _g1h-&gt;heap_region_containing(obj);
4912       assert(!hr-&gt;is_continues_humongous(),
4913              &quot;trying to add code root &quot; PTR_FORMAT &quot; in continuation of humongous region &quot; HR_FORMAT
4914              &quot; starting at &quot; HR_FORMAT,
4915              p2i(_nm), HR_FORMAT_PARAMS(hr), HR_FORMAT_PARAMS(hr-&gt;humongous_start_region()));
4916 
4917       // HeapRegion::add_strong_code_root_locked() avoids adding duplicate entries.
4918       hr-&gt;add_strong_code_root_locked(_nm);
4919     }
4920   }
4921 
4922 public:
4923   RegisterNMethodOopClosure(G1CollectedHeap* g1h, nmethod* nm) :
4924     _g1h(g1h), _nm(nm) {}
4925 
4926   void do_oop(oop* p)       { do_oop_work(p); }
4927   void do_oop(narrowOop* p) { do_oop_work(p); }
4928 };
4929 
4930 class UnregisterNMethodOopClosure: public OopClosure {
4931   G1CollectedHeap* _g1h;
4932   nmethod* _nm;
4933 
4934   template &lt;class T&gt; void do_oop_work(T* p) {
4935     T heap_oop = RawAccess&lt;&gt;::oop_load(p);
4936     if (!CompressedOops::is_null(heap_oop)) {
4937       oop obj = CompressedOops::decode_not_null(heap_oop);
4938       HeapRegion* hr = _g1h-&gt;heap_region_containing(obj);
4939       assert(!hr-&gt;is_continues_humongous(),
4940              &quot;trying to remove code root &quot; PTR_FORMAT &quot; in continuation of humongous region &quot; HR_FORMAT
4941              &quot; starting at &quot; HR_FORMAT,
4942              p2i(_nm), HR_FORMAT_PARAMS(hr), HR_FORMAT_PARAMS(hr-&gt;humongous_start_region()));
4943 
4944       hr-&gt;remove_strong_code_root(_nm);
4945     }
4946   }
4947 
4948 public:
4949   UnregisterNMethodOopClosure(G1CollectedHeap* g1h, nmethod* nm) :
4950     _g1h(g1h), _nm(nm) {}
4951 
4952   void do_oop(oop* p)       { do_oop_work(p); }
4953   void do_oop(narrowOop* p) { do_oop_work(p); }
4954 };
4955 
4956 void G1CollectedHeap::register_nmethod(nmethod* nm) {
4957   guarantee(nm != NULL, &quot;sanity&quot;);
4958   RegisterNMethodOopClosure reg_cl(this, nm);
4959   nm-&gt;oops_do(&amp;reg_cl);
4960 }
4961 
4962 void G1CollectedHeap::unregister_nmethod(nmethod* nm) {
4963   guarantee(nm != NULL, &quot;sanity&quot;);
4964   UnregisterNMethodOopClosure reg_cl(this, nm);
4965   nm-&gt;oops_do(&amp;reg_cl, true);
4966 }
4967 
4968 void G1CollectedHeap::purge_code_root_memory() {
4969   double purge_start = os::elapsedTime();
4970   G1CodeRootSet::purge();
4971   double purge_time_ms = (os::elapsedTime() - purge_start) * 1000.0;
4972   phase_times()-&gt;record_strong_code_root_purge_time(purge_time_ms);
4973 }
4974 
4975 class RebuildStrongCodeRootClosure: public CodeBlobClosure {
4976   G1CollectedHeap* _g1h;
4977 
4978 public:
4979   RebuildStrongCodeRootClosure(G1CollectedHeap* g1h) :
4980     _g1h(g1h) {}
4981 
4982   void do_code_blob(CodeBlob* cb) {
4983     nmethod* nm = (cb != NULL) ? cb-&gt;as_nmethod_or_null() : NULL;
4984     if (nm == NULL) {
4985       return;
4986     }
4987 
4988     _g1h-&gt;register_nmethod(nm);
4989   }
4990 };
4991 
4992 void G1CollectedHeap::rebuild_strong_code_roots() {
4993   RebuildStrongCodeRootClosure blob_cl(this);
4994   CodeCache::blobs_do(&amp;blob_cl);
4995 }
4996 
4997 void G1CollectedHeap::initialize_serviceability() {
4998   _g1mm-&gt;initialize_serviceability();
4999 }
5000 
5001 MemoryUsage G1CollectedHeap::memory_usage() {
5002   return _g1mm-&gt;memory_usage();
5003 }
5004 
5005 GrowableArray&lt;GCMemoryManager*&gt; G1CollectedHeap::memory_managers() {
5006   return _g1mm-&gt;memory_managers();
5007 }
5008 
5009 GrowableArray&lt;MemoryPool*&gt; G1CollectedHeap::memory_pools() {
5010   return _g1mm-&gt;memory_pools();
5011 }
    </pre>
  </body>
</html>