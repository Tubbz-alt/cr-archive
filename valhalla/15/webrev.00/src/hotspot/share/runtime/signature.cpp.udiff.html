<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff src/hotspot/share/runtime/signature.cpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
  </head>
<body>
<center><a href="reflection.cpp.udiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="signature.hpp.udiff.html" target="_top">next &gt;</a></center>    <h2>src/hotspot/share/runtime/signature.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -383,11 +383,13 @@</span>
    return ValueKlass::cast(k);
  }
  
  Klass* SignatureStream::as_klass(Handle class_loader, Handle protection_domain,
                                   FailureMode failure_mode, TRAPS) {
<span class="udiff-line-modified-removed">-   if (!is_reference())  return NULL;</span>
<span class="udiff-line-modified-added">+   if (!is_reference()) {</span>
<span class="udiff-line-added">+     return NULL;</span>
<span class="udiff-line-added">+   }</span>
    Symbol* name = as_symbol();
    Klass* k = NULL;
    if (failure_mode == ReturnNull) {
      // Note:  SD::resolve_or_null returns NULL for most failure modes,
      // but not all.  Circularity errors, invalid PDs, etc., throw.
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -411,14 +413,17 @@</span>
    return k;
  }
  
  oop SignatureStream::as_java_mirror(Handle class_loader, Handle protection_domain,
                                      FailureMode failure_mode, TRAPS) {
<span class="udiff-line-modified-removed">-   if (!is_reference())</span>
<span class="udiff-line-modified-added">+   if (!is_reference()) {</span>
      return Universe::java_mirror(type());
<span class="udiff-line-modified-removed">-   Klass* klass = as_klass(class_loader, protection_domain, failure_mode, THREAD);</span>
<span class="udiff-line-modified-removed">-   if (klass == NULL)  return NULL;</span>
<span class="udiff-line-modified-added">+   }</span>
<span class="udiff-line-modified-added">+   Klass* klass = as_klass(class_loader, protection_domain, failure_mode, CHECK_NULL);</span>
<span class="udiff-line-added">+   if (klass == NULL) {</span>
<span class="udiff-line-added">+     return NULL;</span>
<span class="udiff-line-added">+   }</span>
    if (klass-&gt;is_value()) {
      ValueKlass* vk = ValueKlass::cast(InstanceKlass::cast(klass));
      return _type == T_VALUETYPE ? vk-&gt;value_mirror() : vk-&gt;indirect_mirror();
    } else {
      assert(_type != T_VALUETYPE, &quot;must not be value type&quot;);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -430,10 +435,56 @@</span>
    while (!at_return_type()) {
      next();
    }
  }
  
<span class="udiff-line-added">+ ResolvingSignatureStream::ResolvingSignatureStream(Symbol* signature,</span>
<span class="udiff-line-added">+                                                    Handle class_loader,</span>
<span class="udiff-line-added">+                                                    Handle protection_domain,</span>
<span class="udiff-line-added">+                                                    bool is_method)</span>
<span class="udiff-line-added">+   : SignatureStream(signature, is_method),</span>
<span class="udiff-line-added">+     _class_loader(class_loader), _protection_domain(protection_domain)</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+   initialize_load_origin(NULL);</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ ResolvingSignatureStream::ResolvingSignatureStream(Symbol* signature, Klass* load_origin, bool is_method)</span>
<span class="udiff-line-added">+   : SignatureStream(signature, is_method)</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+   assert(load_origin != NULL, &quot;&quot;);</span>
<span class="udiff-line-added">+   initialize_load_origin(load_origin);</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ ResolvingSignatureStream::ResolvingSignatureStream(const Method* method)</span>
<span class="udiff-line-added">+   : SignatureStream(method-&gt;signature(), true)</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+   initialize_load_origin(method-&gt;method_holder());</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ ResolvingSignatureStream::ResolvingSignatureStream(fieldDescriptor&amp; field)</span>
<span class="udiff-line-added">+   : SignatureStream(field.signature(), false)</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+   initialize_load_origin(field.field_holder());</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ void ResolvingSignatureStream::cache_handles(TRAPS) {</span>
<span class="udiff-line-added">+   assert(_load_origin != NULL, &quot;&quot;);</span>
<span class="udiff-line-added">+   _class_loader = Handle(THREAD, _load_origin-&gt;class_loader());</span>
<span class="udiff-line-added">+   _protection_domain = Handle(THREAD, _load_origin-&gt;protection_domain());</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ Klass* ResolvingSignatureStream::as_klass_if_loaded(TRAPS) {</span>
<span class="udiff-line-added">+   Klass* klass = as_klass(CachedOrNull, THREAD);</span>
<span class="udiff-line-added">+   // SD::find does not trigger loading, so there should be no throws</span>
<span class="udiff-line-added">+   // Still, bad things can happen, so we CHECK_NULL and ask callers</span>
<span class="udiff-line-added">+   // to do likewise.</span>
<span class="udiff-line-added">+   if (HAS_PENDING_EXCEPTION) {</span>
<span class="udiff-line-added">+     CLEAR_PENDING_EXCEPTION;</span>
<span class="udiff-line-added">+   }</span>
<span class="udiff-line-added">+   return klass;</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
  #ifdef ASSERT
  extern bool signature_constants_sane(); // called from basic_types_init()
  
  bool signature_constants_sane() {
    // for the lookup table, test every 8-bit code point, and then some:
</pre>
<center><a href="reflection.cpp.udiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="signature.hpp.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>