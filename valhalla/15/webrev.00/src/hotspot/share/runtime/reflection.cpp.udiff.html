<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff src/hotspot/share/runtime/reflection.cpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
  </head>
<body>
<center><a href="os.hpp.udiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="signature.cpp.udiff.html" target="_top">next &gt;</a></center>    <h2>src/hotspot/share/runtime/reflection.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -52,11 +52,15 @@</span>
  #include &quot;runtime/signature.hpp&quot;
  #include &quot;runtime/thread.inline.hpp&quot;
  #include &quot;runtime/vframe.inline.hpp&quot;
  #include &quot;utilities/globalDefinitions.hpp&quot;
  
<span class="udiff-line-modified-removed">- static void trace_class_resolution(const Klass* to_class) {</span>
<span class="udiff-line-modified-added">+ static void trace_class_resolution(oop mirror) {</span>
<span class="udiff-line-added">+   if (mirror == NULL || java_lang_Class::is_primitive(mirror)) {</span>
<span class="udiff-line-added">+     return;</span>
<span class="udiff-line-added">+   }</span>
<span class="udiff-line-added">+   Klass* to_class = java_lang_Class::as_Klass(mirror);</span>
    ResourceMark rm;
    int line_number = -1;
    const char * source_file = NULL;
    Klass* caller = NULL;
    JavaThread* jthread = JavaThread::current();
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -755,96 +759,44 @@</span>
      outer-&gt;external_name(),
      inner-&gt;external_name()
    );
  }
  
<span class="udiff-line-removed">- // Returns Q-mirror if qtype_if_value is true and k is a ValueKlass;</span>
<span class="udiff-line-removed">- // otherwise returns java_mirror or L-mirror for ValueKlass</span>
<span class="udiff-line-removed">- static oop java_mirror(Klass* k, jboolean qtype_if_value) {</span>
<span class="udiff-line-removed">-   if (k-&gt;is_value()) {</span>
<span class="udiff-line-removed">-     ValueKlass* vk = ValueKlass::cast(InstanceKlass::cast(k));</span>
<span class="udiff-line-removed">-     return qtype_if_value ? vk-&gt;value_mirror() : vk-&gt;indirect_mirror();</span>
<span class="udiff-line-removed">-   } else {</span>
<span class="udiff-line-removed">-     return k-&gt;java_mirror();</span>
<span class="udiff-line-removed">-   }</span>
<span class="udiff-line-removed">- }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">- // Utility method converting a single SignatureStream element into java.lang.Class instance</span>
<span class="udiff-line-removed">- static oop get_mirror_from_signature(const methodHandle&amp; method,</span>
<span class="udiff-line-removed">-                                      SignatureStream* ss,</span>
<span class="udiff-line-removed">-                                      TRAPS) {</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-   BasicType bt = ss-&gt;type();</span>
<span class="udiff-line-removed">-   if (is_reference_type(ss-&gt;type())) {</span>
<span class="udiff-line-removed">-     Symbol* name = ss-&gt;as_symbol();</span>
<span class="udiff-line-removed">-     oop loader = method-&gt;method_holder()-&gt;class_loader();</span>
<span class="udiff-line-removed">-     oop protection_domain = method-&gt;method_holder()-&gt;protection_domain();</span>
<span class="udiff-line-removed">-     const Klass* k = SystemDictionary::resolve_or_fail(name,</span>
<span class="udiff-line-removed">-                                                        Handle(THREAD, loader),</span>
<span class="udiff-line-removed">-                                                        Handle(THREAD, protection_domain),</span>
<span class="udiff-line-removed">-                                                        true,</span>
<span class="udiff-line-removed">-                                                        CHECK_NULL);</span>
<span class="udiff-line-removed">-     if (log_is_enabled(Debug, class, resolve)) {</span>
<span class="udiff-line-removed">-       trace_class_resolution(k);</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">-     return java_mirror((Klass*)k, bt == T_VALUETYPE);</span>
<span class="udiff-line-removed">-   }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-   assert(bt != T_VOID || ss-&gt;at_return_type(),</span>
<span class="udiff-line-removed">-     &quot;T_VOID should only appear as return type&quot;);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-   return java_lang_Class::primitive_mirror(bt);</span>
<span class="udiff-line-removed">- }</span>
<span class="udiff-line-removed">- </span>
  static objArrayHandle get_parameter_types(const methodHandle&amp; method,
                                            int parameter_count,
                                            oop* return_type,
                                            TRAPS) {
    // Allocate array holding parameter types (java.lang.Class instances)
    objArrayOop m = oopFactory::new_objArray(SystemDictionary::Class_klass(), parameter_count, CHECK_(objArrayHandle()));
    objArrayHandle mirrors(THREAD, m);
    int index = 0;
    // Collect parameter types
    ResourceMark rm(THREAD);
<span class="udiff-line-modified-removed">-   Symbol*  signature = method-&gt;signature();</span>
<span class="udiff-line-modified-removed">-   SignatureStream ss(signature);</span>
<span class="udiff-line-modified-removed">-   while (!ss.at_return_type()) {</span>
<span class="udiff-line-modified-removed">-     oop mirror = get_mirror_from_signature(method, &amp;ss, CHECK_(objArrayHandle()));</span>
<span class="udiff-line-modified-removed">-     mirrors-&gt;obj_at_put(index++, mirror);</span>
<span class="udiff-line-modified-removed">-     ss.next();</span>
<span class="udiff-line-modified-added">+   for (ResolvingSignatureStream ss(method()); !ss.is_done(); ss.next()) {</span>
<span class="udiff-line-modified-added">+     oop mirror = ss.as_java_mirror(SignatureStream::NCDFError, CHECK_(objArrayHandle()));</span>
<span class="udiff-line-modified-added">+     if (log_is_enabled(Debug, class, resolve)) {</span>
<span class="udiff-line-modified-added">+       trace_class_resolution(mirror);</span>
<span class="udiff-line-modified-added">+     }</span>
<span class="udiff-line-modified-added">+     if (!ss.at_return_type()) {</span>
<span class="udiff-line-added">+       mirrors-&gt;obj_at_put(index++, mirror);</span>
<span class="udiff-line-added">+     } else if (return_type != NULL) {</span>
<span class="udiff-line-added">+       // Collect return type as well</span>
<span class="udiff-line-added">+       assert(ss.at_return_type(), &quot;return type should be present&quot;);</span>
<span class="udiff-line-added">+       *return_type = mirror;</span>
<span class="udiff-line-added">+     }</span>
    }
    assert(index == parameter_count, &quot;invalid parameter count&quot;);
<span class="udiff-line-removed">-   if (return_type != NULL) {</span>
<span class="udiff-line-removed">-     // Collect return type as well</span>
<span class="udiff-line-removed">-     assert(ss.at_return_type(), &quot;return type should be present&quot;);</span>
<span class="udiff-line-removed">-     *return_type = get_mirror_from_signature(method, &amp;ss, CHECK_(objArrayHandle()));</span>
<span class="udiff-line-removed">-   }</span>
    return mirrors;
  }
  
  static objArrayHandle get_exception_types(const methodHandle&amp; method, TRAPS) {
    return method-&gt;resolved_checked_exceptions(THREAD);
  }
  
  static Handle new_type(Symbol* signature, Klass* k, TRAPS) {
<span class="udiff-line-modified-removed">-   SignatureStream ss(signature, false);</span>
<span class="udiff-line-modified-removed">-   // Basic types</span>
<span class="udiff-line-removed">-   BasicType type = ss.type();</span>
<span class="udiff-line-removed">-   if (!ss.is_reference()) {</span>
<span class="udiff-line-removed">-     return Handle(THREAD, Universe::java_mirror(type));</span>
<span class="udiff-line-removed">-   }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-   Klass* result =</span>
<span class="udiff-line-removed">-     SystemDictionary::resolve_or_fail(signature,</span>
<span class="udiff-line-removed">-                                       Handle(THREAD, k-&gt;class_loader()),</span>
<span class="udiff-line-removed">-                                       Handle(THREAD, k-&gt;protection_domain()),</span>
<span class="udiff-line-removed">-                                       true, CHECK_(Handle()));</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-   if (log_is_enabled(Debug, class, resolve)) {</span>
<span class="udiff-line-removed">-     trace_class_resolution(result);</span>
<span class="udiff-line-removed">-   }</span>
<span class="udiff-line-removed">-   oop nt = java_mirror(result, type == T_VALUETYPE);</span>
<span class="udiff-line-modified-added">+   ResolvingSignatureStream ss(signature, k, false);</span>
<span class="udiff-line-modified-added">+   oop nt = ss.as_java_mirror(SignatureStream::NCDFError, CHECK_NH);</span>
    return Handle(THREAD, nt);
  }
  
  
  oop Reflection::new_method(const methodHandle&amp; method, bool for_constant_pool_access, TRAPS) {
</pre>
<center><a href="os.hpp.udiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="signature.cpp.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>