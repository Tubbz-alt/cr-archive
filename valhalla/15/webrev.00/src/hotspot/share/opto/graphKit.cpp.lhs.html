<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames src/hotspot/share/opto/graphKit.cpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
    <script type="text/javascript" src="../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>   1 /*
   2  * Copyright (c) 2001, 2019, Oracle and/or its affiliates. All rights reserved.
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.
   8  *
   9  * This code is distributed in the hope that it will be useful, but WITHOUT
  10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  *
  23  */
  24 
  25 #include &quot;precompiled.hpp&quot;
  26 #include &quot;ci/ciUtilities.hpp&quot;
  27 #include &quot;compiler/compileLog.hpp&quot;
  28 #include &quot;ci/ciValueKlass.hpp&quot;
  29 #include &quot;gc/shared/barrierSet.hpp&quot;
  30 #include &quot;gc/shared/c2/barrierSetC2.hpp&quot;
  31 #include &quot;interpreter/interpreter.hpp&quot;
  32 #include &quot;memory/resourceArea.hpp&quot;
  33 #include &quot;opto/addnode.hpp&quot;
  34 #include &quot;opto/castnode.hpp&quot;
  35 #include &quot;opto/convertnode.hpp&quot;
  36 #include &quot;opto/graphKit.hpp&quot;
  37 #include &quot;opto/idealKit.hpp&quot;
  38 #include &quot;opto/intrinsicnode.hpp&quot;
  39 #include &quot;opto/locknode.hpp&quot;
  40 #include &quot;opto/machnode.hpp&quot;
  41 #include &quot;opto/narrowptrnode.hpp&quot;
  42 #include &quot;opto/opaquenode.hpp&quot;
  43 #include &quot;opto/parse.hpp&quot;
  44 #include &quot;opto/rootnode.hpp&quot;
  45 #include &quot;opto/runtime.hpp&quot;
  46 #include &quot;opto/subtypenode.hpp&quot;
  47 #include &quot;opto/valuetypenode.hpp&quot;
  48 #include &quot;runtime/deoptimization.hpp&quot;
  49 #include &quot;runtime/sharedRuntime.hpp&quot;
  50 #include &quot;utilities/bitMap.inline.hpp&quot;
  51 #include &quot;utilities/powerOfTwo.hpp&quot;
  52 
  53 //----------------------------GraphKit-----------------------------------------
  54 // Main utility constructor.
  55 GraphKit::GraphKit(JVMState* jvms, PhaseGVN* gvn)
  56   : Phase(Phase::Parser),
  57     _env(C-&gt;env()),
  58     _gvn((gvn != NULL) ? *gvn : *C-&gt;initial_gvn()),
  59     _barrier_set(BarrierSet::barrier_set()-&gt;barrier_set_c2())
  60 {
  61   assert(gvn == NULL || !gvn-&gt;is_IterGVN() || gvn-&gt;is_IterGVN()-&gt;delay_transform(), &quot;delay transform should be enabled&quot;);
  62   _exceptions = jvms-&gt;map()-&gt;next_exception();
  63   if (_exceptions != NULL)  jvms-&gt;map()-&gt;set_next_exception(NULL);
  64   set_jvms(jvms);
  65 #ifdef ASSERT
  66   if (_gvn.is_IterGVN() != NULL) {
  67     assert(_gvn.is_IterGVN()-&gt;delay_transform(), &quot;Transformation must be delayed if IterGVN is used&quot;);
  68     // Save the initial size of _for_igvn worklist for verification (see ~GraphKit)
  69     _worklist_size = _gvn.C-&gt;for_igvn()-&gt;size();
  70   }
  71 #endif
  72 }
  73 
  74 // Private constructor for parser.
  75 GraphKit::GraphKit()
  76   : Phase(Phase::Parser),
  77     _env(C-&gt;env()),
  78     _gvn(*C-&gt;initial_gvn()),
  79     _barrier_set(BarrierSet::barrier_set()-&gt;barrier_set_c2())
  80 {
  81   _exceptions = NULL;
  82   set_map(NULL);
  83   debug_only(_sp = -99);
  84   debug_only(set_bci(-99));
  85 }
  86 
  87 
  88 
  89 //---------------------------clean_stack---------------------------------------
  90 // Clear away rubbish from the stack area of the JVM state.
  91 // This destroys any arguments that may be waiting on the stack.
  92 void GraphKit::clean_stack(int from_sp) {
  93   SafePointNode* map      = this-&gt;map();
  94   JVMState*      jvms     = this-&gt;jvms();
  95   int            stk_size = jvms-&gt;stk_size();
  96   int            stkoff   = jvms-&gt;stkoff();
  97   Node*          top      = this-&gt;top();
  98   for (int i = from_sp; i &lt; stk_size; i++) {
  99     if (map-&gt;in(stkoff + i) != top) {
 100       map-&gt;set_req(stkoff + i, top);
 101     }
 102   }
 103 }
 104 
 105 
 106 //--------------------------------sync_jvms-----------------------------------
 107 // Make sure our current jvms agrees with our parse state.
 108 JVMState* GraphKit::sync_jvms() const {
 109   JVMState* jvms = this-&gt;jvms();
 110   jvms-&gt;set_bci(bci());       // Record the new bci in the JVMState
 111   jvms-&gt;set_sp(sp());         // Record the new sp in the JVMState
 112   assert(jvms_in_sync(), &quot;jvms is now in sync&quot;);
 113   return jvms;
 114 }
 115 
 116 //--------------------------------sync_jvms_for_reexecute---------------------
 117 // Make sure our current jvms agrees with our parse state.  This version
 118 // uses the reexecute_sp for reexecuting bytecodes.
 119 JVMState* GraphKit::sync_jvms_for_reexecute() {
 120   JVMState* jvms = this-&gt;jvms();
 121   jvms-&gt;set_bci(bci());          // Record the new bci in the JVMState
 122   jvms-&gt;set_sp(reexecute_sp());  // Record the new sp in the JVMState
 123   return jvms;
 124 }
 125 
 126 #ifdef ASSERT
 127 bool GraphKit::jvms_in_sync() const {
 128   Parse* parse = is_Parse();
 129   if (parse == NULL) {
 130     if (bci() !=      jvms()-&gt;bci())          return false;
 131     if (sp()  != (int)jvms()-&gt;sp())           return false;
 132     return true;
 133   }
 134   if (jvms()-&gt;method() != parse-&gt;method())    return false;
 135   if (jvms()-&gt;bci()    != parse-&gt;bci())       return false;
 136   int jvms_sp = jvms()-&gt;sp();
 137   if (jvms_sp          != parse-&gt;sp())        return false;
 138   int jvms_depth = jvms()-&gt;depth();
 139   if (jvms_depth       != parse-&gt;depth())     return false;
 140   return true;
 141 }
 142 
 143 // Local helper checks for special internal merge points
 144 // used to accumulate and merge exception states.
 145 // They are marked by the region&#39;s in(0) edge being the map itself.
 146 // Such merge points must never &quot;escape&quot; into the parser at large,
 147 // until they have been handed to gvn.transform.
 148 static bool is_hidden_merge(Node* reg) {
 149   if (reg == NULL)  return false;
 150   if (reg-&gt;is_Phi()) {
 151     reg = reg-&gt;in(0);
 152     if (reg == NULL)  return false;
 153   }
 154   return reg-&gt;is_Region() &amp;&amp; reg-&gt;in(0) != NULL &amp;&amp; reg-&gt;in(0)-&gt;is_Root();
 155 }
 156 
 157 void GraphKit::verify_map() const {
 158   if (map() == NULL)  return;  // null map is OK
 159   assert(map()-&gt;req() &lt;= jvms()-&gt;endoff(), &quot;no extra garbage on map&quot;);
 160   assert(!map()-&gt;has_exceptions(),    &quot;call add_exception_states_from 1st&quot;);
 161   assert(!is_hidden_merge(control()), &quot;call use_exception_state, not set_map&quot;);
 162 }
 163 
 164 void GraphKit::verify_exception_state(SafePointNode* ex_map) {
 165   assert(ex_map-&gt;next_exception() == NULL, &quot;not already part of a chain&quot;);
 166   assert(has_saved_ex_oop(ex_map), &quot;every exception state has an ex_oop&quot;);
 167 }
 168 #endif
 169 
 170 //---------------------------stop_and_kill_map---------------------------------
 171 // Set _map to NULL, signalling a stop to further bytecode execution.
 172 // First smash the current map&#39;s control to a constant, to mark it dead.
 173 void GraphKit::stop_and_kill_map() {
 174   SafePointNode* dead_map = stop();
 175   if (dead_map != NULL) {
 176     dead_map-&gt;disconnect_inputs(NULL, C); // Mark the map as killed.
 177     assert(dead_map-&gt;is_killed(), &quot;must be so marked&quot;);
 178   }
 179 }
 180 
 181 
 182 //--------------------------------stopped--------------------------------------
 183 // Tell if _map is NULL, or control is top.
 184 bool GraphKit::stopped() {
 185   if (map() == NULL)           return true;
 186   else if (control() == top()) return true;
 187   else                         return false;
 188 }
 189 
 190 
 191 //-----------------------------has_ex_handler----------------------------------
 192 // Tell if this method or any caller method has exception handlers.
 193 bool GraphKit::has_ex_handler() {
 194   for (JVMState* jvmsp = jvms(); jvmsp != NULL; jvmsp = jvmsp-&gt;caller()) {
 195     if (jvmsp-&gt;has_method() &amp;&amp; jvmsp-&gt;method()-&gt;has_exception_handlers()) {
 196       return true;
 197     }
 198   }
 199   return false;
 200 }
 201 
 202 //------------------------------save_ex_oop------------------------------------
 203 // Save an exception without blowing stack contents or other JVM state.
 204 void GraphKit::set_saved_ex_oop(SafePointNode* ex_map, Node* ex_oop) {
 205   assert(!has_saved_ex_oop(ex_map), &quot;clear ex-oop before setting again&quot;);
 206   ex_map-&gt;add_req(ex_oop);
 207   debug_only(verify_exception_state(ex_map));
 208 }
 209 
 210 inline static Node* common_saved_ex_oop(SafePointNode* ex_map, bool clear_it) {
 211   assert(GraphKit::has_saved_ex_oop(ex_map), &quot;ex_oop must be there&quot;);
 212   Node* ex_oop = ex_map-&gt;in(ex_map-&gt;req()-1);
 213   if (clear_it)  ex_map-&gt;del_req(ex_map-&gt;req()-1);
 214   return ex_oop;
 215 }
 216 
 217 //-----------------------------saved_ex_oop------------------------------------
 218 // Recover a saved exception from its map.
 219 Node* GraphKit::saved_ex_oop(SafePointNode* ex_map) {
 220   return common_saved_ex_oop(ex_map, false);
 221 }
 222 
 223 //--------------------------clear_saved_ex_oop---------------------------------
 224 // Erase a previously saved exception from its map.
 225 Node* GraphKit::clear_saved_ex_oop(SafePointNode* ex_map) {
 226   return common_saved_ex_oop(ex_map, true);
 227 }
 228 
 229 #ifdef ASSERT
 230 //---------------------------has_saved_ex_oop----------------------------------
 231 // Erase a previously saved exception from its map.
 232 bool GraphKit::has_saved_ex_oop(SafePointNode* ex_map) {
 233   return ex_map-&gt;req() == ex_map-&gt;jvms()-&gt;endoff()+1;
 234 }
 235 #endif
 236 
 237 //-------------------------make_exception_state--------------------------------
 238 // Turn the current JVM state into an exception state, appending the ex_oop.
 239 SafePointNode* GraphKit::make_exception_state(Node* ex_oop) {
 240   sync_jvms();
 241   SafePointNode* ex_map = stop();  // do not manipulate this map any more
 242   set_saved_ex_oop(ex_map, ex_oop);
 243   return ex_map;
 244 }
 245 
 246 
 247 //--------------------------add_exception_state--------------------------------
 248 // Add an exception to my list of exceptions.
 249 void GraphKit::add_exception_state(SafePointNode* ex_map) {
 250   if (ex_map == NULL || ex_map-&gt;control() == top()) {
 251     return;
 252   }
 253 #ifdef ASSERT
 254   verify_exception_state(ex_map);
 255   if (has_exceptions()) {
 256     assert(ex_map-&gt;jvms()-&gt;same_calls_as(_exceptions-&gt;jvms()), &quot;all collected exceptions must come from the same place&quot;);
 257   }
 258 #endif
 259 
 260   // If there is already an exception of exactly this type, merge with it.
 261   // In particular, null-checks and other low-level exceptions common up here.
 262   Node*       ex_oop  = saved_ex_oop(ex_map);
 263   const Type* ex_type = _gvn.type(ex_oop);
 264   if (ex_oop == top()) {
 265     // No action needed.
 266     return;
 267   }
 268   assert(ex_type-&gt;isa_instptr(), &quot;exception must be an instance&quot;);
 269   for (SafePointNode* e2 = _exceptions; e2 != NULL; e2 = e2-&gt;next_exception()) {
 270     const Type* ex_type2 = _gvn.type(saved_ex_oop(e2));
 271     // We check sp also because call bytecodes can generate exceptions
 272     // both before and after arguments are popped!
 273     if (ex_type2 == ex_type
 274         &amp;&amp; e2-&gt;_jvms-&gt;sp() == ex_map-&gt;_jvms-&gt;sp()) {
 275       combine_exception_states(ex_map, e2);
 276       return;
 277     }
 278   }
 279 
 280   // No pre-existing exception of the same type.  Chain it on the list.
 281   push_exception_state(ex_map);
 282 }
 283 
 284 //-----------------------add_exception_states_from-----------------------------
 285 void GraphKit::add_exception_states_from(JVMState* jvms) {
 286   SafePointNode* ex_map = jvms-&gt;map()-&gt;next_exception();
 287   if (ex_map != NULL) {
 288     jvms-&gt;map()-&gt;set_next_exception(NULL);
 289     for (SafePointNode* next_map; ex_map != NULL; ex_map = next_map) {
 290       next_map = ex_map-&gt;next_exception();
 291       ex_map-&gt;set_next_exception(NULL);
 292       add_exception_state(ex_map);
 293     }
 294   }
 295 }
 296 
 297 //-----------------------transfer_exceptions_into_jvms-------------------------
 298 JVMState* GraphKit::transfer_exceptions_into_jvms() {
 299   if (map() == NULL) {
 300     // We need a JVMS to carry the exceptions, but the map has gone away.
 301     // Create a scratch JVMS, cloned from any of the exception states...
 302     if (has_exceptions()) {
 303       _map = _exceptions;
 304       _map = clone_map();
 305       _map-&gt;set_next_exception(NULL);
 306       clear_saved_ex_oop(_map);
 307       debug_only(verify_map());
 308     } else {
 309       // ...or created from scratch
 310       JVMState* jvms = new (C) JVMState(_method, NULL);
 311       jvms-&gt;set_bci(_bci);
 312       jvms-&gt;set_sp(_sp);
 313       jvms-&gt;set_map(new SafePointNode(TypeFunc::Parms, jvms));
 314       set_jvms(jvms);
 315       for (uint i = 0; i &lt; map()-&gt;req(); i++)  map()-&gt;init_req(i, top());
 316       set_all_memory(top());
 317       while (map()-&gt;req() &lt; jvms-&gt;endoff())  map()-&gt;add_req(top());
 318     }
 319     // (This is a kludge, in case you didn&#39;t notice.)
 320     set_control(top());
 321   }
 322   JVMState* jvms = sync_jvms();
 323   assert(!jvms-&gt;map()-&gt;has_exceptions(), &quot;no exceptions on this map yet&quot;);
 324   jvms-&gt;map()-&gt;set_next_exception(_exceptions);
 325   _exceptions = NULL;   // done with this set of exceptions
 326   return jvms;
 327 }
 328 
 329 static inline void add_n_reqs(Node* dstphi, Node* srcphi) {
 330   assert(is_hidden_merge(dstphi), &quot;must be a special merge node&quot;);
 331   assert(is_hidden_merge(srcphi), &quot;must be a special merge node&quot;);
 332   uint limit = srcphi-&gt;req();
 333   for (uint i = PhiNode::Input; i &lt; limit; i++) {
 334     dstphi-&gt;add_req(srcphi-&gt;in(i));
 335   }
 336 }
 337 static inline void add_one_req(Node* dstphi, Node* src) {
 338   assert(is_hidden_merge(dstphi), &quot;must be a special merge node&quot;);
 339   assert(!is_hidden_merge(src), &quot;must not be a special merge node&quot;);
 340   dstphi-&gt;add_req(src);
 341 }
 342 
 343 //-----------------------combine_exception_states------------------------------
 344 // This helper function combines exception states by building phis on a
 345 // specially marked state-merging region.  These regions and phis are
 346 // untransformed, and can build up gradually.  The region is marked by
 347 // having a control input of its exception map, rather than NULL.  Such
 348 // regions do not appear except in this function, and in use_exception_state.
 349 void GraphKit::combine_exception_states(SafePointNode* ex_map, SafePointNode* phi_map) {
 350   if (failing())  return;  // dying anyway...
 351   JVMState* ex_jvms = ex_map-&gt;_jvms;
 352   assert(ex_jvms-&gt;same_calls_as(phi_map-&gt;_jvms), &quot;consistent call chains&quot;);
 353   assert(ex_jvms-&gt;stkoff() == phi_map-&gt;_jvms-&gt;stkoff(), &quot;matching locals&quot;);
 354   assert(ex_jvms-&gt;sp() == phi_map-&gt;_jvms-&gt;sp(), &quot;matching stack sizes&quot;);
 355   assert(ex_jvms-&gt;monoff() == phi_map-&gt;_jvms-&gt;monoff(), &quot;matching JVMS&quot;);
 356   assert(ex_jvms-&gt;scloff() == phi_map-&gt;_jvms-&gt;scloff(), &quot;matching scalar replaced objects&quot;);
 357   assert(ex_map-&gt;req() == phi_map-&gt;req(), &quot;matching maps&quot;);
 358   uint tos = ex_jvms-&gt;stkoff() + ex_jvms-&gt;sp();
 359   Node*         hidden_merge_mark = root();
 360   Node*         region  = phi_map-&gt;control();
 361   MergeMemNode* phi_mem = phi_map-&gt;merged_memory();
 362   MergeMemNode* ex_mem  = ex_map-&gt;merged_memory();
 363   if (region-&gt;in(0) != hidden_merge_mark) {
 364     // The control input is not (yet) a specially-marked region in phi_map.
 365     // Make it so, and build some phis.
 366     region = new RegionNode(2);
 367     _gvn.set_type(region, Type::CONTROL);
 368     region-&gt;set_req(0, hidden_merge_mark);  // marks an internal ex-state
 369     region-&gt;init_req(1, phi_map-&gt;control());
 370     phi_map-&gt;set_control(region);
 371     Node* io_phi = PhiNode::make(region, phi_map-&gt;i_o(), Type::ABIO);
 372     record_for_igvn(io_phi);
 373     _gvn.set_type(io_phi, Type::ABIO);
 374     phi_map-&gt;set_i_o(io_phi);
 375     for (MergeMemStream mms(phi_mem); mms.next_non_empty(); ) {
 376       Node* m = mms.memory();
 377       Node* m_phi = PhiNode::make(region, m, Type::MEMORY, mms.adr_type(C));
 378       record_for_igvn(m_phi);
 379       _gvn.set_type(m_phi, Type::MEMORY);
 380       mms.set_memory(m_phi);
 381     }
 382   }
 383 
 384   // Either or both of phi_map and ex_map might already be converted into phis.
 385   Node* ex_control = ex_map-&gt;control();
 386   // if there is special marking on ex_map also, we add multiple edges from src
 387   bool add_multiple = (ex_control-&gt;in(0) == hidden_merge_mark);
 388   // how wide was the destination phi_map, originally?
 389   uint orig_width = region-&gt;req();
 390 
 391   if (add_multiple) {
 392     add_n_reqs(region, ex_control);
 393     add_n_reqs(phi_map-&gt;i_o(), ex_map-&gt;i_o());
 394   } else {
 395     // ex_map has no merges, so we just add single edges everywhere
 396     add_one_req(region, ex_control);
 397     add_one_req(phi_map-&gt;i_o(), ex_map-&gt;i_o());
 398   }
 399   for (MergeMemStream mms(phi_mem, ex_mem); mms.next_non_empty2(); ) {
 400     if (mms.is_empty()) {
 401       // get a copy of the base memory, and patch some inputs into it
 402       const TypePtr* adr_type = mms.adr_type(C);
 403       Node* phi = mms.force_memory()-&gt;as_Phi()-&gt;slice_memory(adr_type);
 404       assert(phi-&gt;as_Phi()-&gt;region() == mms.base_memory()-&gt;in(0), &quot;&quot;);
 405       mms.set_memory(phi);
 406       // Prepare to append interesting stuff onto the newly sliced phi:
 407       while (phi-&gt;req() &gt; orig_width)  phi-&gt;del_req(phi-&gt;req()-1);
 408     }
 409     // Append stuff from ex_map:
 410     if (add_multiple) {
 411       add_n_reqs(mms.memory(), mms.memory2());
 412     } else {
 413       add_one_req(mms.memory(), mms.memory2());
 414     }
 415   }
 416   uint limit = ex_map-&gt;req();
 417   for (uint i = TypeFunc::Parms; i &lt; limit; i++) {
 418     // Skip everything in the JVMS after tos.  (The ex_oop follows.)
 419     if (i == tos)  i = ex_jvms-&gt;monoff();
 420     Node* src = ex_map-&gt;in(i);
 421     Node* dst = phi_map-&gt;in(i);
 422     if (src != dst) {
 423       PhiNode* phi;
 424       if (dst-&gt;in(0) != region) {
 425         dst = phi = PhiNode::make(region, dst, _gvn.type(dst));
 426         record_for_igvn(phi);
 427         _gvn.set_type(phi, phi-&gt;type());
 428         phi_map-&gt;set_req(i, dst);
 429         // Prepare to append interesting stuff onto the new phi:
 430         while (dst-&gt;req() &gt; orig_width)  dst-&gt;del_req(dst-&gt;req()-1);
 431       } else {
 432         assert(dst-&gt;is_Phi(), &quot;nobody else uses a hidden region&quot;);
 433         phi = dst-&gt;as_Phi();
 434       }
 435       if (add_multiple &amp;&amp; src-&gt;in(0) == ex_control) {
 436         // Both are phis.
 437         add_n_reqs(dst, src);
 438       } else {
 439         while (dst-&gt;req() &lt; region-&gt;req())  add_one_req(dst, src);
 440       }
 441       const Type* srctype = _gvn.type(src);
 442       if (phi-&gt;type() != srctype) {
 443         const Type* dsttype = phi-&gt;type()-&gt;meet_speculative(srctype);
 444         if (phi-&gt;type() != dsttype) {
 445           phi-&gt;set_type(dsttype);
 446           _gvn.set_type(phi, dsttype);
 447         }
 448       }
 449     }
 450   }
 451   phi_map-&gt;merge_replaced_nodes_with(ex_map);
 452 }
 453 
 454 //--------------------------use_exception_state--------------------------------
 455 Node* GraphKit::use_exception_state(SafePointNode* phi_map) {
 456   if (failing()) { stop(); return top(); }
 457   Node* region = phi_map-&gt;control();
 458   Node* hidden_merge_mark = root();
 459   assert(phi_map-&gt;jvms()-&gt;map() == phi_map, &quot;sanity: 1-1 relation&quot;);
 460   Node* ex_oop = clear_saved_ex_oop(phi_map);
 461   if (region-&gt;in(0) == hidden_merge_mark) {
 462     // Special marking for internal ex-states.  Process the phis now.
 463     region-&gt;set_req(0, region);  // now it&#39;s an ordinary region
 464     set_jvms(phi_map-&gt;jvms());   // ...so now we can use it as a map
 465     // Note: Setting the jvms also sets the bci and sp.
 466     set_control(_gvn.transform(region));
 467     uint tos = jvms()-&gt;stkoff() + sp();
 468     for (uint i = 1; i &lt; tos; i++) {
 469       Node* x = phi_map-&gt;in(i);
 470       if (x-&gt;in(0) == region) {
 471         assert(x-&gt;is_Phi(), &quot;expected a special phi&quot;);
 472         phi_map-&gt;set_req(i, _gvn.transform(x));
 473       }
 474     }
 475     for (MergeMemStream mms(merged_memory()); mms.next_non_empty(); ) {
 476       Node* x = mms.memory();
 477       if (x-&gt;in(0) == region) {
 478         assert(x-&gt;is_Phi(), &quot;nobody else uses a hidden region&quot;);
 479         mms.set_memory(_gvn.transform(x));
 480       }
 481     }
 482     if (ex_oop-&gt;in(0) == region) {
 483       assert(ex_oop-&gt;is_Phi(), &quot;expected a special phi&quot;);
 484       ex_oop = _gvn.transform(ex_oop);
 485     }
 486   } else {
 487     set_jvms(phi_map-&gt;jvms());
 488   }
 489 
 490   assert(!is_hidden_merge(phi_map-&gt;control()), &quot;hidden ex. states cleared&quot;);
 491   assert(!is_hidden_merge(phi_map-&gt;i_o()), &quot;hidden ex. states cleared&quot;);
 492   return ex_oop;
 493 }
 494 
 495 //---------------------------------java_bc-------------------------------------
 496 Bytecodes::Code GraphKit::java_bc() const {
 497   ciMethod* method = this-&gt;method();
 498   int       bci    = this-&gt;bci();
 499   if (method != NULL &amp;&amp; bci != InvocationEntryBci)
 500     return method-&gt;java_code_at_bci(bci);
 501   else
 502     return Bytecodes::_illegal;
 503 }
 504 
 505 void GraphKit::uncommon_trap_if_should_post_on_exceptions(Deoptimization::DeoptReason reason,
 506                                                           bool must_throw) {
 507     // if the exception capability is set, then we will generate code
 508     // to check the JavaThread.should_post_on_exceptions flag to see
 509     // if we actually need to report exception events (for this
 510     // thread).  If we don&#39;t need to report exception events, we will
 511     // take the normal fast path provided by add_exception_events.  If
 512     // exception event reporting is enabled for this thread, we will
 513     // take the uncommon_trap in the BuildCutout below.
 514 
 515     // first must access the should_post_on_exceptions_flag in this thread&#39;s JavaThread
 516     Node* jthread = _gvn.transform(new ThreadLocalNode());
 517     Node* adr = basic_plus_adr(top(), jthread, in_bytes(JavaThread::should_post_on_exceptions_flag_offset()));
 518     Node* should_post_flag = make_load(control(), adr, TypeInt::INT, T_INT, Compile::AliasIdxRaw, MemNode::unordered);
 519 
 520     // Test the should_post_on_exceptions_flag vs. 0
 521     Node* chk = _gvn.transform( new CmpINode(should_post_flag, intcon(0)) );
 522     Node* tst = _gvn.transform( new BoolNode(chk, BoolTest::eq) );
 523 
 524     // Branch to slow_path if should_post_on_exceptions_flag was true
 525     { BuildCutout unless(this, tst, PROB_MAX);
 526       // Do not try anything fancy if we&#39;re notifying the VM on every throw.
 527       // Cf. case Bytecodes::_athrow in parse2.cpp.
 528       uncommon_trap(reason, Deoptimization::Action_none,
 529                     (ciKlass*)NULL, (char*)NULL, must_throw);
 530     }
 531 
 532 }
 533 
 534 //------------------------------builtin_throw----------------------------------
 535 void GraphKit::builtin_throw(Deoptimization::DeoptReason reason, Node* arg) {
 536   bool must_throw = true;
 537 
 538   if (env()-&gt;jvmti_can_post_on_exceptions()) {
 539     // check if we must post exception events, take uncommon trap if so
 540     uncommon_trap_if_should_post_on_exceptions(reason, must_throw);
 541     // here if should_post_on_exceptions is false
 542     // continue on with the normal codegen
 543   }
 544 
 545   // If this particular condition has not yet happened at this
 546   // bytecode, then use the uncommon trap mechanism, and allow for
 547   // a future recompilation if several traps occur here.
 548   // If the throw is hot, try to use a more complicated inline mechanism
 549   // which keeps execution inside the compiled code.
 550   bool treat_throw_as_hot = false;
 551   ciMethodData* md = method()-&gt;method_data();
 552 
 553   if (ProfileTraps) {
 554     if (too_many_traps(reason)) {
 555       treat_throw_as_hot = true;
 556     }
 557     // (If there is no MDO at all, assume it is early in
 558     // execution, and that any deopts are part of the
 559     // startup transient, and don&#39;t need to be remembered.)
 560 
 561     // Also, if there is a local exception handler, treat all throws
 562     // as hot if there has been at least one in this method.
 563     if (C-&gt;trap_count(reason) != 0
 564         &amp;&amp; method()-&gt;method_data()-&gt;trap_count(reason) != 0
 565         &amp;&amp; has_ex_handler()) {
 566         treat_throw_as_hot = true;
 567     }
 568   }
 569 
 570   // If this throw happens frequently, an uncommon trap might cause
 571   // a performance pothole.  If there is a local exception handler,
 572   // and if this particular bytecode appears to be deoptimizing often,
 573   // let us handle the throw inline, with a preconstructed instance.
 574   // Note:   If the deopt count has blown up, the uncommon trap
 575   // runtime is going to flush this nmethod, not matter what.
 576   if (treat_throw_as_hot
 577       &amp;&amp; (!StackTraceInThrowable || OmitStackTraceInFastThrow)) {
 578     // If the throw is local, we use a pre-existing instance and
 579     // punt on the backtrace.  This would lead to a missing backtrace
 580     // (a repeat of 4292742) if the backtrace object is ever asked
 581     // for its backtrace.
 582     // Fixing this remaining case of 4292742 requires some flavor of
 583     // escape analysis.  Leave that for the future.
 584     ciInstance* ex_obj = NULL;
 585     switch (reason) {
 586     case Deoptimization::Reason_null_check:
 587       ex_obj = env()-&gt;NullPointerException_instance();
 588       break;
 589     case Deoptimization::Reason_div0_check:
 590       ex_obj = env()-&gt;ArithmeticException_instance();
 591       break;
 592     case Deoptimization::Reason_range_check:
 593       ex_obj = env()-&gt;ArrayIndexOutOfBoundsException_instance();
 594       break;
 595     case Deoptimization::Reason_class_check:
 596       if (java_bc() == Bytecodes::_aastore) {
 597         ex_obj = env()-&gt;ArrayStoreException_instance();
 598       } else {
 599         ex_obj = env()-&gt;ClassCastException_instance();
 600       }
 601       break;
 602     default:
 603       break;
 604     }
 605     if (failing()) { stop(); return; }  // exception allocation might fail
 606     if (ex_obj != NULL) {
 607       // Cheat with a preallocated exception object.
 608       if (C-&gt;log() != NULL)
 609         C-&gt;log()-&gt;elem(&quot;hot_throw preallocated=&#39;1&#39; reason=&#39;%s&#39;&quot;,
 610                        Deoptimization::trap_reason_name(reason));
 611       const TypeInstPtr* ex_con  = TypeInstPtr::make(ex_obj);
 612       Node*              ex_node = _gvn.transform(ConNode::make(ex_con));
 613 
 614       // Clear the detail message of the preallocated exception object.
 615       // Weblogic sometimes mutates the detail message of exceptions
 616       // using reflection.
 617       int offset = java_lang_Throwable::get_detailMessage_offset();
 618       const TypePtr* adr_typ = ex_con-&gt;add_offset(offset);
 619 
 620       Node *adr = basic_plus_adr(ex_node, ex_node, offset);
 621       const TypeOopPtr* val_type = TypeOopPtr::make_from_klass(env()-&gt;String_klass());
 622       Node *store = access_store_at(ex_node, adr, adr_typ, null(), val_type, T_OBJECT, IN_HEAP);
 623 
 624       add_exception_state(make_exception_state(ex_node));
 625       return;
 626     }
 627   }
 628 
 629   // %%% Maybe add entry to OptoRuntime which directly throws the exc.?
 630   // It won&#39;t be much cheaper than bailing to the interp., since we&#39;ll
 631   // have to pass up all the debug-info, and the runtime will have to
 632   // create the stack trace.
 633 
 634   // Usual case:  Bail to interpreter.
 635   // Reserve the right to recompile if we haven&#39;t seen anything yet.
 636 
 637   ciMethod* m = Deoptimization::reason_is_speculate(reason) ? C-&gt;method() : NULL;
 638   Deoptimization::DeoptAction action = Deoptimization::Action_maybe_recompile;
 639   if (treat_throw_as_hot
 640       &amp;&amp; (method()-&gt;method_data()-&gt;trap_recompiled_at(bci(), m)
 641           || C-&gt;too_many_traps(reason))) {
 642     // We cannot afford to take more traps here.  Suffer in the interpreter.
 643     if (C-&gt;log() != NULL)
 644       C-&gt;log()-&gt;elem(&quot;hot_throw preallocated=&#39;0&#39; reason=&#39;%s&#39; mcount=&#39;%d&#39;&quot;,
 645                      Deoptimization::trap_reason_name(reason),
 646                      C-&gt;trap_count(reason));
 647     action = Deoptimization::Action_none;
 648   }
 649 
 650   // &quot;must_throw&quot; prunes the JVM state to include only the stack, if there
 651   // are no local exception handlers.  This should cut down on register
 652   // allocation time and code size, by drastically reducing the number
 653   // of in-edges on the call to the uncommon trap.
 654 
 655   uncommon_trap(reason, action, (ciKlass*)NULL, (char*)NULL, must_throw);
 656 }
 657 
 658 
 659 //----------------------------PreserveJVMState---------------------------------
 660 PreserveJVMState::PreserveJVMState(GraphKit* kit, bool clone_map) {
 661   debug_only(kit-&gt;verify_map());
 662   _kit    = kit;
 663   _map    = kit-&gt;map();   // preserve the map
 664   _sp     = kit-&gt;sp();
 665   kit-&gt;set_map(clone_map ? kit-&gt;clone_map() : NULL);
 666 #ifdef ASSERT
 667   _bci    = kit-&gt;bci();
 668   Parse* parser = kit-&gt;is_Parse();
 669   int block = (parser == NULL || parser-&gt;block() == NULL) ? -1 : parser-&gt;block()-&gt;rpo();
 670   _block  = block;
 671 #endif
 672 }
 673 PreserveJVMState::~PreserveJVMState() {
 674   GraphKit* kit = _kit;
 675 #ifdef ASSERT
 676   assert(kit-&gt;bci() == _bci, &quot;bci must not shift&quot;);
 677   Parse* parser = kit-&gt;is_Parse();
 678   int block = (parser == NULL || parser-&gt;block() == NULL) ? -1 : parser-&gt;block()-&gt;rpo();
 679   assert(block == _block,    &quot;block must not shift&quot;);
 680 #endif
 681   kit-&gt;set_map(_map);
 682   kit-&gt;set_sp(_sp);
 683 }
 684 
 685 
 686 //-----------------------------BuildCutout-------------------------------------
 687 BuildCutout::BuildCutout(GraphKit* kit, Node* p, float prob, float cnt)
 688   : PreserveJVMState(kit)
 689 {
 690   assert(p-&gt;is_Con() || p-&gt;is_Bool(), &quot;test must be a bool&quot;);
 691   SafePointNode* outer_map = _map;   // preserved map is caller&#39;s
 692   SafePointNode* inner_map = kit-&gt;map();
 693   IfNode* iff = kit-&gt;create_and_map_if(outer_map-&gt;control(), p, prob, cnt);
 694   outer_map-&gt;set_control(kit-&gt;gvn().transform( new IfTrueNode(iff) ));
 695   inner_map-&gt;set_control(kit-&gt;gvn().transform( new IfFalseNode(iff) ));
 696 }
 697 BuildCutout::~BuildCutout() {
 698   GraphKit* kit = _kit;
 699   assert(kit-&gt;stopped(), &quot;cutout code must stop, throw, return, etc.&quot;);
 700 }
 701 
 702 //---------------------------PreserveReexecuteState----------------------------
 703 PreserveReexecuteState::PreserveReexecuteState(GraphKit* kit) {
 704   assert(!kit-&gt;stopped(), &quot;must call stopped() before&quot;);
 705   _kit    =    kit;
 706   _sp     =    kit-&gt;sp();
 707   _reexecute = kit-&gt;jvms()-&gt;_reexecute;
 708 }
 709 PreserveReexecuteState::~PreserveReexecuteState() {
 710   if (_kit-&gt;stopped()) return;
 711   _kit-&gt;jvms()-&gt;_reexecute = _reexecute;
 712   _kit-&gt;set_sp(_sp);
 713 }
 714 
 715 //------------------------------clone_map--------------------------------------
 716 // Implementation of PreserveJVMState
 717 //
 718 // Only clone_map(...) here. If this function is only used in the
 719 // PreserveJVMState class we may want to get rid of this extra
 720 // function eventually and do it all there.
 721 
 722 SafePointNode* GraphKit::clone_map() {
 723   if (map() == NULL)  return NULL;
 724 
 725   // Clone the memory edge first
 726   Node* mem = MergeMemNode::make(map()-&gt;memory());
 727   gvn().set_type_bottom(mem);
 728 
 729   SafePointNode *clonemap = (SafePointNode*)map()-&gt;clone();
 730   JVMState* jvms = this-&gt;jvms();
 731   JVMState* clonejvms = jvms-&gt;clone_shallow(C);
 732   clonemap-&gt;set_memory(mem);
 733   clonemap-&gt;set_jvms(clonejvms);
 734   clonejvms-&gt;set_map(clonemap);
 735   record_for_igvn(clonemap);
 736   gvn().set_type_bottom(clonemap);
 737   return clonemap;
 738 }
 739 
 740 
 741 //-----------------------------set_map_clone-----------------------------------
 742 void GraphKit::set_map_clone(SafePointNode* m) {
 743   _map = m;
 744   _map = clone_map();
 745   _map-&gt;set_next_exception(NULL);
 746   debug_only(verify_map());
 747 }
 748 
 749 
 750 //----------------------------kill_dead_locals---------------------------------
 751 // Detect any locals which are known to be dead, and force them to top.
 752 void GraphKit::kill_dead_locals() {
 753   // Consult the liveness information for the locals.  If any
 754   // of them are unused, then they can be replaced by top().  This
 755   // should help register allocation time and cut down on the size
 756   // of the deoptimization information.
 757 
 758   // This call is made from many of the bytecode handling
 759   // subroutines called from the Big Switch in do_one_bytecode.
 760   // Every bytecode which might include a slow path is responsible
 761   // for killing its dead locals.  The more consistent we
 762   // are about killing deads, the fewer useless phis will be
 763   // constructed for them at various merge points.
 764 
 765   // bci can be -1 (InvocationEntryBci).  We return the entry
 766   // liveness for the method.
 767 
 768   if (method() == NULL || method()-&gt;code_size() == 0) {
 769     // We are building a graph for a call to a native method.
 770     // All locals are live.
 771     return;
 772   }
 773 
 774   ResourceMark rm;
 775 
 776   // Consult the liveness information for the locals.  If any
 777   // of them are unused, then they can be replaced by top().  This
 778   // should help register allocation time and cut down on the size
 779   // of the deoptimization information.
 780   MethodLivenessResult live_locals = method()-&gt;liveness_at_bci(bci());
 781 
 782   int len = (int)live_locals.size();
 783   assert(len &lt;= jvms()-&gt;loc_size(), &quot;too many live locals&quot;);
 784   for (int local = 0; local &lt; len; local++) {
 785     if (!live_locals.at(local)) {
 786       set_local(local, top());
 787     }
 788   }
 789 }
 790 
 791 #ifdef ASSERT
 792 //-------------------------dead_locals_are_killed------------------------------
 793 // Return true if all dead locals are set to top in the map.
 794 // Used to assert &quot;clean&quot; debug info at various points.
 795 bool GraphKit::dead_locals_are_killed() {
 796   if (method() == NULL || method()-&gt;code_size() == 0) {
 797     // No locals need to be dead, so all is as it should be.
 798     return true;
 799   }
 800 
 801   // Make sure somebody called kill_dead_locals upstream.
 802   ResourceMark rm;
 803   for (JVMState* jvms = this-&gt;jvms(); jvms != NULL; jvms = jvms-&gt;caller()) {
 804     if (jvms-&gt;loc_size() == 0)  continue;  // no locals to consult
 805     SafePointNode* map = jvms-&gt;map();
 806     ciMethod* method = jvms-&gt;method();
 807     int       bci    = jvms-&gt;bci();
 808     if (jvms == this-&gt;jvms()) {
 809       bci = this-&gt;bci();  // it might not yet be synched
 810     }
 811     MethodLivenessResult live_locals = method-&gt;liveness_at_bci(bci);
 812     int len = (int)live_locals.size();
 813     if (!live_locals.is_valid() || len == 0)
 814       // This method is trivial, or is poisoned by a breakpoint.
 815       return true;
 816     assert(len == jvms-&gt;loc_size(), &quot;live map consistent with locals map&quot;);
 817     for (int local = 0; local &lt; len; local++) {
 818       if (!live_locals.at(local) &amp;&amp; map-&gt;local(jvms, local) != top()) {
 819         if (PrintMiscellaneous &amp;&amp; (Verbose || WizardMode)) {
 820           tty-&gt;print_cr(&quot;Zombie local %d: &quot;, local);
 821           jvms-&gt;dump();
 822         }
 823         return false;
 824       }
 825     }
 826   }
 827   return true;
 828 }
 829 
 830 #endif //ASSERT
 831 
 832 // Helper function for enforcing certain bytecodes to reexecute if
 833 // deoptimization happens
 834 static bool should_reexecute_implied_by_bytecode(JVMState *jvms, bool is_anewarray) {
 835   ciMethod* cur_method = jvms-&gt;method();
 836   int       cur_bci   = jvms-&gt;bci();
 837   if (cur_method != NULL &amp;&amp; cur_bci != InvocationEntryBci) {
 838     Bytecodes::Code code = cur_method-&gt;java_code_at_bci(cur_bci);
 839     return Interpreter::bytecode_should_reexecute(code) ||
 840            (is_anewarray &amp;&amp; (code == Bytecodes::_multianewarray));
 841     // Reexecute _multianewarray bytecode which was replaced with
 842     // sequence of [a]newarray. See Parse::do_multianewarray().
 843     //
 844     // Note: interpreter should not have it set since this optimization
 845     // is limited by dimensions and guarded by flag so in some cases
 846     // multianewarray() runtime calls will be generated and
 847     // the bytecode should not be reexecutes (stack will not be reset).
 848   } else {
 849     return false;
 850   }
 851 }
 852 
 853 // Helper function for adding JVMState and debug information to node
 854 void GraphKit::add_safepoint_edges(SafePointNode* call, bool must_throw) {
 855   // Add the safepoint edges to the call (or other safepoint).
 856 
 857   // Make sure dead locals are set to top.  This
 858   // should help register allocation time and cut down on the size
 859   // of the deoptimization information.
 860   assert(dead_locals_are_killed(), &quot;garbage in debug info before safepoint&quot;);
 861 
 862   // Walk the inline list to fill in the correct set of JVMState&#39;s
 863   // Also fill in the associated edges for each JVMState.
 864 
 865   // If the bytecode needs to be reexecuted we need to put
 866   // the arguments back on the stack.
 867   const bool should_reexecute = jvms()-&gt;should_reexecute();
 868   JVMState* youngest_jvms = should_reexecute ? sync_jvms_for_reexecute() : sync_jvms();
 869 
 870   // NOTE: set_bci (called from sync_jvms) might reset the reexecute bit to
 871   // undefined if the bci is different.  This is normal for Parse but it
 872   // should not happen for LibraryCallKit because only one bci is processed.
 873   assert(!is_LibraryCallKit() || (jvms()-&gt;should_reexecute() == should_reexecute),
 874          &quot;in LibraryCallKit the reexecute bit should not change&quot;);
 875 
 876   // If we are guaranteed to throw, we can prune everything but the
 877   // input to the current bytecode.
 878   bool can_prune_locals = false;
 879   uint stack_slots_not_pruned = 0;
 880   int inputs = 0, depth = 0;
 881   if (must_throw) {
 882     assert(method() == youngest_jvms-&gt;method(), &quot;sanity&quot;);
 883     if (compute_stack_effects(inputs, depth)) {
 884       can_prune_locals = true;
 885       stack_slots_not_pruned = inputs;
 886     }
 887   }
 888 
 889   if (env()-&gt;should_retain_local_variables()) {
 890     // At any safepoint, this method can get breakpointed, which would
 891     // then require an immediate deoptimization.
 892     can_prune_locals = false;  // do not prune locals
 893     stack_slots_not_pruned = 0;
 894   }
 895 
 896   // do not scribble on the input jvms
 897   JVMState* out_jvms = youngest_jvms-&gt;clone_deep(C);
 898   call-&gt;set_jvms(out_jvms); // Start jvms list for call node
 899 
 900   // For a known set of bytecodes, the interpreter should reexecute them if
 901   // deoptimization happens. We set the reexecute state for them here
 902   if (out_jvms-&gt;is_reexecute_undefined() &amp;&amp; //don&#39;t change if already specified
 903       should_reexecute_implied_by_bytecode(out_jvms, call-&gt;is_AllocateArray())) {
 904     out_jvms-&gt;set_should_reexecute(true); //NOTE: youngest_jvms not changed
 905   }
 906 
 907   // Presize the call:
 908   DEBUG_ONLY(uint non_debug_edges = call-&gt;req());
 909   call-&gt;add_req_batch(top(), youngest_jvms-&gt;debug_depth());
 910   assert(call-&gt;req() == non_debug_edges + youngest_jvms-&gt;debug_depth(), &quot;&quot;);
 911 
 912   // Set up edges so that the call looks like this:
 913   //  Call [state:] ctl io mem fptr retadr
 914   //       [parms:] parm0 ... parmN
 915   //       [root:]  loc0 ... locN stk0 ... stkSP mon0 obj0 ... monN objN
 916   //    [...mid:]   loc0 ... locN stk0 ... stkSP mon0 obj0 ... monN objN [...]
 917   //       [young:] loc0 ... locN stk0 ... stkSP mon0 obj0 ... monN objN
 918   // Note that caller debug info precedes callee debug info.
 919 
 920   // Fill pointer walks backwards from &quot;young:&quot; to &quot;root:&quot; in the diagram above:
 921   uint debug_ptr = call-&gt;req();
 922 
 923   // Loop over the map input edges associated with jvms, add them
 924   // to the call node, &amp; reset all offsets to match call node array.
 925   for (JVMState* in_jvms = youngest_jvms; in_jvms != NULL; ) {
 926     uint debug_end   = debug_ptr;
 927     uint debug_start = debug_ptr - in_jvms-&gt;debug_size();
 928     debug_ptr = debug_start;  // back up the ptr
 929 
 930     uint p = debug_start;  // walks forward in [debug_start, debug_end)
 931     uint j, k, l;
 932     SafePointNode* in_map = in_jvms-&gt;map();
 933     out_jvms-&gt;set_map(call);
 934 
 935     if (can_prune_locals) {
 936       assert(in_jvms-&gt;method() == out_jvms-&gt;method(), &quot;sanity&quot;);
 937       // If the current throw can reach an exception handler in this JVMS,
 938       // then we must keep everything live that can reach that handler.
 939       // As a quick and dirty approximation, we look for any handlers at all.
 940       if (in_jvms-&gt;method()-&gt;has_exception_handlers()) {
 941         can_prune_locals = false;
 942       }
 943     }
 944 
 945     // Add the Locals
 946     k = in_jvms-&gt;locoff();
 947     l = in_jvms-&gt;loc_size();
 948     out_jvms-&gt;set_locoff(p);
 949     if (!can_prune_locals) {
 950       for (j = 0; j &lt; l; j++)
 951         call-&gt;set_req(p++, in_map-&gt;in(k+j));
 952     } else {
 953       p += l;  // already set to top above by add_req_batch
 954     }
 955 
 956     // Add the Expression Stack
 957     k = in_jvms-&gt;stkoff();
 958     l = in_jvms-&gt;sp();
 959     out_jvms-&gt;set_stkoff(p);
 960     if (!can_prune_locals) {
 961       for (j = 0; j &lt; l; j++)
 962         call-&gt;set_req(p++, in_map-&gt;in(k+j));
 963     } else if (can_prune_locals &amp;&amp; stack_slots_not_pruned != 0) {
 964       // Divide stack into {S0,...,S1}, where S0 is set to top.
 965       uint s1 = stack_slots_not_pruned;
 966       stack_slots_not_pruned = 0;  // for next iteration
 967       if (s1 &gt; l)  s1 = l;
 968       uint s0 = l - s1;
 969       p += s0;  // skip the tops preinstalled by add_req_batch
 970       for (j = s0; j &lt; l; j++)
 971         call-&gt;set_req(p++, in_map-&gt;in(k+j));
 972     } else {
 973       p += l;  // already set to top above by add_req_batch
 974     }
 975 
 976     // Add the Monitors
 977     k = in_jvms-&gt;monoff();
 978     l = in_jvms-&gt;mon_size();
 979     out_jvms-&gt;set_monoff(p);
 980     for (j = 0; j &lt; l; j++)
 981       call-&gt;set_req(p++, in_map-&gt;in(k+j));
 982 
 983     // Copy any scalar object fields.
 984     k = in_jvms-&gt;scloff();
 985     l = in_jvms-&gt;scl_size();
 986     out_jvms-&gt;set_scloff(p);
 987     for (j = 0; j &lt; l; j++)
 988       call-&gt;set_req(p++, in_map-&gt;in(k+j));
 989 
 990     // Finish the new jvms.
 991     out_jvms-&gt;set_endoff(p);
 992 
 993     assert(out_jvms-&gt;endoff()     == debug_end,             &quot;fill ptr must match&quot;);
 994     assert(out_jvms-&gt;depth()      == in_jvms-&gt;depth(),      &quot;depth must match&quot;);
 995     assert(out_jvms-&gt;loc_size()   == in_jvms-&gt;loc_size(),   &quot;size must match&quot;);
 996     assert(out_jvms-&gt;mon_size()   == in_jvms-&gt;mon_size(),   &quot;size must match&quot;);
 997     assert(out_jvms-&gt;scl_size()   == in_jvms-&gt;scl_size(),   &quot;size must match&quot;);
 998     assert(out_jvms-&gt;debug_size() == in_jvms-&gt;debug_size(), &quot;size must match&quot;);
 999 
1000     // Update the two tail pointers in parallel.
1001     out_jvms = out_jvms-&gt;caller();
1002     in_jvms  = in_jvms-&gt;caller();
1003   }
1004 
1005   assert(debug_ptr == non_debug_edges, &quot;debug info must fit exactly&quot;);
1006 
1007   // Test the correctness of JVMState::debug_xxx accessors:
1008   assert(call-&gt;jvms()-&gt;debug_start() == non_debug_edges, &quot;&quot;);
1009   assert(call-&gt;jvms()-&gt;debug_end()   == call-&gt;req(), &quot;&quot;);
1010   assert(call-&gt;jvms()-&gt;debug_depth() == call-&gt;req() - non_debug_edges, &quot;&quot;);
1011 }
1012 
1013 bool GraphKit::compute_stack_effects(int&amp; inputs, int&amp; depth) {
1014   Bytecodes::Code code = java_bc();
1015   if (code == Bytecodes::_wide) {
1016     code = method()-&gt;java_code_at_bci(bci() + 1);
1017   }
1018 
1019   BasicType rtype = T_ILLEGAL;
1020   int       rsize = 0;
1021 
1022   if (code != Bytecodes::_illegal) {
1023     depth = Bytecodes::depth(code); // checkcast=0, athrow=-1
1024     rtype = Bytecodes::result_type(code); // checkcast=P, athrow=V
1025     if (rtype &lt; T_CONFLICT)
1026       rsize = type2size[rtype];
1027   }
1028 
1029   switch (code) {
1030   case Bytecodes::_illegal:
1031     return false;
1032 
1033   case Bytecodes::_ldc:
1034   case Bytecodes::_ldc_w:
1035   case Bytecodes::_ldc2_w:
1036     inputs = 0;
1037     break;
1038 
1039   case Bytecodes::_dup:         inputs = 1;  break;
1040   case Bytecodes::_dup_x1:      inputs = 2;  break;
1041   case Bytecodes::_dup_x2:      inputs = 3;  break;
1042   case Bytecodes::_dup2:        inputs = 2;  break;
1043   case Bytecodes::_dup2_x1:     inputs = 3;  break;
1044   case Bytecodes::_dup2_x2:     inputs = 4;  break;
1045   case Bytecodes::_swap:        inputs = 2;  break;
1046   case Bytecodes::_arraylength: inputs = 1;  break;
1047 
1048   case Bytecodes::_getstatic:
1049   case Bytecodes::_putstatic:
1050   case Bytecodes::_getfield:
1051   case Bytecodes::_putfield:
1052     {
1053       bool ignored_will_link;
1054       ciField* field = method()-&gt;get_field_at_bci(bci(), ignored_will_link);
1055       int      size  = field-&gt;type()-&gt;size();
1056       bool is_get = (depth &gt;= 0), is_static = (depth &amp; 1);
1057       inputs = (is_static ? 0 : 1);
1058       if (is_get) {
1059         depth = size - inputs;
1060       } else {
1061         inputs += size;        // putxxx pops the value from the stack
1062         depth = - inputs;
1063       }
1064     }
1065     break;
1066 
1067   case Bytecodes::_invokevirtual:
1068   case Bytecodes::_invokespecial:
1069   case Bytecodes::_invokestatic:
1070   case Bytecodes::_invokedynamic:
1071   case Bytecodes::_invokeinterface:
1072     {
1073       bool ignored_will_link;
1074       ciSignature* declared_signature = NULL;
1075       ciMethod* ignored_callee = method()-&gt;get_method_at_bci(bci(), ignored_will_link, &amp;declared_signature);
1076       assert(declared_signature != NULL, &quot;cannot be null&quot;);
1077       inputs   = declared_signature-&gt;arg_size_for_bc(code);
1078       int size = declared_signature-&gt;return_type()-&gt;size();
1079       depth = size - inputs;
1080     }
1081     break;
1082 
1083   case Bytecodes::_multianewarray:
1084     {
1085       ciBytecodeStream iter(method());
1086       iter.reset_to_bci(bci());
1087       iter.next();
1088       inputs = iter.get_dimensions();
1089       assert(rsize == 1, &quot;&quot;);
1090       depth = rsize - inputs;
1091     }
1092     break;
1093 
1094   case Bytecodes::_withfield: {
1095     bool ignored_will_link;
1096     ciField* field = method()-&gt;get_field_at_bci(bci(), ignored_will_link);
1097     int      size  = field-&gt;type()-&gt;size();
1098     inputs = size+1;
1099     depth = rsize - inputs;
1100     break;
1101   }
1102 
1103   case Bytecodes::_ireturn:
1104   case Bytecodes::_lreturn:
1105   case Bytecodes::_freturn:
1106   case Bytecodes::_dreturn:
1107   case Bytecodes::_areturn:
1108     assert(rsize == -depth, &quot;&quot;);
1109     inputs = rsize;
1110     break;
1111 
1112   case Bytecodes::_jsr:
1113   case Bytecodes::_jsr_w:
1114     inputs = 0;
1115     depth  = 1;                  // S.B. depth=1, not zero
1116     break;
1117 
1118   default:
1119     // bytecode produces a typed result
1120     inputs = rsize - depth;
1121     assert(inputs &gt;= 0, &quot;&quot;);
1122     break;
1123   }
1124 
1125 #ifdef ASSERT
1126   // spot check
1127   int outputs = depth + inputs;
1128   assert(outputs &gt;= 0, &quot;sanity&quot;);
1129   switch (code) {
1130   case Bytecodes::_checkcast: assert(inputs == 1 &amp;&amp; outputs == 1, &quot;&quot;); break;
1131   case Bytecodes::_athrow:    assert(inputs == 1 &amp;&amp; outputs == 0, &quot;&quot;); break;
1132   case Bytecodes::_aload_0:   assert(inputs == 0 &amp;&amp; outputs == 1, &quot;&quot;); break;
1133   case Bytecodes::_return:    assert(inputs == 0 &amp;&amp; outputs == 0, &quot;&quot;); break;
1134   case Bytecodes::_drem:      assert(inputs == 4 &amp;&amp; outputs == 2, &quot;&quot;); break;
1135   default:                    break;
1136   }
1137 #endif //ASSERT
1138 
1139   return true;
1140 }
1141 
1142 
1143 
1144 //------------------------------basic_plus_adr---------------------------------
1145 Node* GraphKit::basic_plus_adr(Node* base, Node* ptr, Node* offset) {
1146   // short-circuit a common case
1147   if (offset == intcon(0))  return ptr;
1148   return _gvn.transform( new AddPNode(base, ptr, offset) );
1149 }
1150 
1151 Node* GraphKit::ConvI2L(Node* offset) {
1152   // short-circuit a common case
1153   jint offset_con = find_int_con(offset, Type::OffsetBot);
1154   if (offset_con != Type::OffsetBot) {
1155     return longcon((jlong) offset_con);
1156   }
1157   return _gvn.transform( new ConvI2LNode(offset));
1158 }
1159 
1160 Node* GraphKit::ConvI2UL(Node* offset) {
1161   juint offset_con = (juint) find_int_con(offset, Type::OffsetBot);
1162   if (offset_con != (juint) Type::OffsetBot) {
1163     return longcon((julong) offset_con);
1164   }
1165   Node* conv = _gvn.transform( new ConvI2LNode(offset));
1166   Node* mask = _gvn.transform(ConLNode::make((julong) max_juint));
1167   return _gvn.transform( new AndLNode(conv, mask) );
1168 }
1169 
1170 Node* GraphKit::ConvL2I(Node* offset) {
1171   // short-circuit a common case
1172   jlong offset_con = find_long_con(offset, (jlong)Type::OffsetBot);
1173   if (offset_con != (jlong)Type::OffsetBot) {
1174     return intcon((int) offset_con);
1175   }
1176   return _gvn.transform( new ConvL2INode(offset));
1177 }
1178 
1179 //-------------------------load_object_klass-----------------------------------
1180 Node* GraphKit::load_object_klass(Node* obj, bool clear_prop_bits) {
1181   // Special-case a fresh allocation to avoid building nodes:
1182   Node* akls = AllocateNode::Ideal_klass(obj, &amp;_gvn);
1183   if (akls != NULL)  return akls;
1184   Node* k_adr = basic_plus_adr(obj, oopDesc::klass_offset_in_bytes());
1185   return _gvn.transform(LoadKlassNode::make(_gvn, NULL, immutable_memory(), k_adr, TypeInstPtr::KLASS, TypeKlassPtr::OBJECT, clear_prop_bits));
1186 }
1187 
1188 //-------------------------load_array_length-----------------------------------
1189 Node* GraphKit::load_array_length(Node* array) {
1190   // Special-case a fresh allocation to avoid building nodes:
1191   AllocateArrayNode* alloc = AllocateArrayNode::Ideal_array_allocation(array, &amp;_gvn);
1192   Node *alen;
1193   if (alloc == NULL) {
1194     Node *r_adr = basic_plus_adr(array, arrayOopDesc::length_offset_in_bytes());
1195     alen = _gvn.transform( new LoadRangeNode(0, immutable_memory(), r_adr, TypeInt::POS));
1196   } else {
1197     alen = alloc-&gt;Ideal_length();
1198     Node* ccast = alloc-&gt;make_ideal_length(_gvn.type(array)-&gt;is_oopptr(), &amp;_gvn);
1199     if (ccast != alen) {
1200       alen = _gvn.transform(ccast);
1201     }
1202   }
1203   return alen;
1204 }
1205 
1206 //------------------------------do_null_check----------------------------------
1207 // Helper function to do a NULL pointer check.  Returned value is
1208 // the incoming address with NULL casted away.  You are allowed to use the
1209 // not-null value only if you are control dependent on the test.
1210 #ifndef PRODUCT
1211 extern int explicit_null_checks_inserted,
1212            explicit_null_checks_elided;
1213 #endif
1214 Node* GraphKit::null_check_common(Node* value, BasicType type,
1215                                   // optional arguments for variations:
1216                                   bool assert_null,
1217                                   Node* *null_control,
1218                                   bool speculative) {
1219   assert(!assert_null || null_control == NULL, &quot;not both at once&quot;);
1220   if (stopped())  return top();
1221   NOT_PRODUCT(explicit_null_checks_inserted++);
1222 
1223   // Construct NULL check
1224   Node *chk = NULL;
1225   switch(type) {
1226     case T_LONG   : chk = new CmpLNode(value, _gvn.zerocon(T_LONG)); break;
1227     case T_INT    : chk = new CmpINode(value, _gvn.intcon(0)); break;
1228     case T_VALUETYPE : // fall through
1229     case T_ARRAY  : // fall through
1230       type = T_OBJECT;  // simplify further tests
1231     case T_OBJECT : {
1232       const Type *t = _gvn.type( value );
1233 
1234       const TypeOopPtr* tp = t-&gt;isa_oopptr();
1235       if (tp != NULL &amp;&amp; tp-&gt;klass() != NULL &amp;&amp; !tp-&gt;klass()-&gt;is_loaded()
1236           // Only for do_null_check, not any of its siblings:
1237           &amp;&amp; !assert_null &amp;&amp; null_control == NULL) {
1238         // Usually, any field access or invocation on an unloaded oop type
1239         // will simply fail to link, since the statically linked class is
1240         // likely also to be unloaded.  However, in -Xcomp mode, sometimes
1241         // the static class is loaded but the sharper oop type is not.
1242         // Rather than checking for this obscure case in lots of places,
1243         // we simply observe that a null check on an unloaded class
1244         // will always be followed by a nonsense operation, so we
1245         // can just issue the uncommon trap here.
1246         // Our access to the unloaded class will only be correct
1247         // after it has been loaded and initialized, which requires
1248         // a trip through the interpreter.
1249 #ifndef PRODUCT
1250         if (WizardMode) { tty-&gt;print(&quot;Null check of unloaded &quot;); tp-&gt;klass()-&gt;print(); tty-&gt;cr(); }
1251 #endif
1252         uncommon_trap(Deoptimization::Reason_unloaded,
1253                       Deoptimization::Action_reinterpret,
1254                       tp-&gt;klass(), &quot;!loaded&quot;);
1255         return top();
1256       }
1257 
1258       if (assert_null) {
1259         // See if the type is contained in NULL_PTR.
1260         // If so, then the value is already null.
1261         if (t-&gt;higher_equal(TypePtr::NULL_PTR)) {
1262           NOT_PRODUCT(explicit_null_checks_elided++);
1263           return value;           // Elided null assert quickly!
1264         }
1265       } else {
1266         // See if mixing in the NULL pointer changes type.
1267         // If so, then the NULL pointer was not allowed in the original
1268         // type.  In other words, &quot;value&quot; was not-null.
1269         if (t-&gt;meet(TypePtr::NULL_PTR) != t-&gt;remove_speculative()) {
1270           // same as: if (!TypePtr::NULL_PTR-&gt;higher_equal(t)) ...
1271           NOT_PRODUCT(explicit_null_checks_elided++);
1272           return value;           // Elided null check quickly!
1273         }
1274       }
1275       chk = new CmpPNode( value, null() );
1276       break;
1277     }
1278 
1279     default:
1280       fatal(&quot;unexpected type: %s&quot;, type2name(type));
1281   }
1282   assert(chk != NULL, &quot;sanity check&quot;);
1283   chk = _gvn.transform(chk);
1284 
1285   BoolTest::mask btest = assert_null ? BoolTest::eq : BoolTest::ne;
1286   BoolNode *btst = new BoolNode( chk, btest);
1287   Node   *tst = _gvn.transform( btst );
1288 
1289   //-----------
1290   // if peephole optimizations occurred, a prior test existed.
1291   // If a prior test existed, maybe it dominates as we can avoid this test.
1292   if (tst != btst &amp;&amp; type == T_OBJECT) {
1293     // At this point we want to scan up the CFG to see if we can
1294     // find an identical test (and so avoid this test altogether).
1295     Node *cfg = control();
1296     int depth = 0;
1297     while( depth &lt; 16 ) {       // Limit search depth for speed
1298       if( cfg-&gt;Opcode() == Op_IfTrue &amp;&amp;
1299           cfg-&gt;in(0)-&gt;in(1) == tst ) {
1300         // Found prior test.  Use &quot;cast_not_null&quot; to construct an identical
1301         // CastPP (and hence hash to) as already exists for the prior test.
1302         // Return that casted value.
1303         if (assert_null) {
1304           replace_in_map(value, null());
1305           return null();  // do not issue the redundant test
1306         }
1307         Node *oldcontrol = control();
1308         set_control(cfg);
1309         Node *res = cast_not_null(value);
1310         set_control(oldcontrol);
1311         NOT_PRODUCT(explicit_null_checks_elided++);
1312         return res;
1313       }
1314       cfg = IfNode::up_one_dom(cfg, /*linear_only=*/ true);
1315       if (cfg == NULL)  break;  // Quit at region nodes
1316       depth++;
1317     }
1318   }
1319 
1320   //-----------
1321   // Branch to failure if null
1322   float ok_prob = PROB_MAX;  // a priori estimate:  nulls never happen
1323   Deoptimization::DeoptReason reason;
1324   if (assert_null) {
1325     reason = Deoptimization::reason_null_assert(speculative);
1326   } else if (type == T_OBJECT) {
1327     reason = Deoptimization::reason_null_check(speculative);
1328   } else {
1329     reason = Deoptimization::Reason_div0_check;
1330   }
1331   // %%% Since Reason_unhandled is not recorded on a per-bytecode basis,
1332   // ciMethodData::has_trap_at will return a conservative -1 if any
1333   // must-be-null assertion has failed.  This could cause performance
1334   // problems for a method after its first do_null_assert failure.
1335   // Consider using &#39;Reason_class_check&#39; instead?
1336 
1337   // To cause an implicit null check, we set the not-null probability
1338   // to the maximum (PROB_MAX).  For an explicit check the probability
1339   // is set to a smaller value.
1340   if (null_control != NULL || too_many_traps(reason)) {
1341     // probability is less likely
1342     ok_prob =  PROB_LIKELY_MAG(3);
1343   } else if (!assert_null &amp;&amp;
1344              (ImplicitNullCheckThreshold &gt; 0) &amp;&amp;
1345              method() != NULL &amp;&amp;
1346              (method()-&gt;method_data()-&gt;trap_count(reason)
1347               &gt;= (uint)ImplicitNullCheckThreshold)) {
1348     ok_prob =  PROB_LIKELY_MAG(3);
1349   }
1350 
1351   if (null_control != NULL) {
1352     IfNode* iff = create_and_map_if(control(), tst, ok_prob, COUNT_UNKNOWN);
1353     Node* null_true = _gvn.transform( new IfFalseNode(iff));
1354     set_control(      _gvn.transform( new IfTrueNode(iff)));
1355 #ifndef PRODUCT
1356     if (null_true == top()) {
1357       explicit_null_checks_elided++;
1358     }
1359 #endif
1360     (*null_control) = null_true;
1361   } else {
1362     BuildCutout unless(this, tst, ok_prob);
1363     // Check for optimizer eliding test at parse time
1364     if (stopped()) {
1365       // Failure not possible; do not bother making uncommon trap.
1366       NOT_PRODUCT(explicit_null_checks_elided++);
1367     } else if (assert_null) {
1368       uncommon_trap(reason,
1369                     Deoptimization::Action_make_not_entrant,
1370                     NULL, &quot;assert_null&quot;);
1371     } else {
1372       replace_in_map(value, zerocon(type));
1373       builtin_throw(reason);
1374     }
1375   }
1376 
1377   // Must throw exception, fall-thru not possible?
1378   if (stopped()) {
1379     return top();               // No result
1380   }
1381 
1382   if (assert_null) {
1383     // Cast obj to null on this path.
1384     replace_in_map(value, zerocon(type));
1385     return zerocon(type);
1386   }
1387 
1388   // Cast obj to not-null on this path, if there is no null_control.
1389   // (If there is a null_control, a non-null value may come back to haunt us.)
1390   return cast_not_null(value, (null_control == NULL || (*null_control) == top()));
1391 }
1392 
1393 Node* GraphKit::null2default(Node* value, ciValueKlass* vk) {
1394   Node* null_ctl = top();
1395   value = null_check_oop(value, &amp;null_ctl);
1396   if (!null_ctl-&gt;is_top()) {
1397     // Return default value if oop is null
1398     Node* region = new RegionNode(3);
1399     region-&gt;init_req(1, control());
1400     region-&gt;init_req(2, null_ctl);
1401     value = PhiNode::make(region, value, TypeInstPtr::make(TypePtr::BotPTR, vk));
1402     value-&gt;set_req(2, ValueTypeNode::default_oop(gvn(), vk));
1403     set_control(gvn().transform(region));
1404     value = gvn().transform(value);
1405   }
1406   return value;
1407 }
1408 
1409 //------------------------------cast_not_null----------------------------------
1410 // Cast obj to not-null on this path
1411 Node* GraphKit::cast_not_null(Node* obj, bool do_replace_in_map) {
1412   if (obj-&gt;is_ValueType()) {
1413     return obj;
1414   }
1415   Node* cast = NULL;
1416   const Type* t = _gvn.type(obj);
1417   if (t-&gt;make_ptr() != NULL) {
1418     const Type* t_not_null = t-&gt;join_speculative(TypePtr::NOTNULL);
1419     // Object is already not-null?
1420     if (t == t_not_null) {
1421       return obj;
1422     }
1423     cast = ConstraintCastNode::make_cast(Op_CastPP, control(), obj, t_not_null, false);
1424   } else if (t-&gt;isa_int() != NULL) {
1425     cast = ConstraintCastNode::make_cast(Op_CastII, control(), obj, TypeInt::INT, true);
1426   } else if (t-&gt;isa_long() != NULL) {
1427     cast = ConstraintCastNode::make_cast(Op_CastLL, control(), obj, TypeLong::LONG, true);
1428   } else {
1429     fatal(&quot;unexpected type: %s&quot;, type2name(t-&gt;basic_type()));
1430   }
1431   cast = _gvn.transform(cast);
1432 
1433   // Scan for instances of &#39;obj&#39; in the current JVM mapping.
1434   // These instances are known to be not-null after the test.
1435   if (do_replace_in_map) {
1436     replace_in_map(obj, cast);
1437   }
1438   return cast;
1439 }
1440 
1441 // Sometimes in intrinsics, we implicitly know an object is not null
1442 // (there&#39;s no actual null check) so we can cast it to not null. In
1443 // the course of optimizations, the input to the cast can become null.
1444 // In that case that data path will die and we need the control path
1445 // to become dead as well to keep the graph consistent. So we have to
1446 // add a check for null for which one branch can&#39;t be taken. It uses
1447 // an Opaque4 node that will cause the check to be removed after loop
1448 // opts so the test goes away and the compiled code doesn&#39;t execute a
1449 // useless check.
1450 Node* GraphKit::must_be_not_null(Node* value, bool do_replace_in_map) {
1451   if (!TypePtr::NULL_PTR-&gt;higher_equal(_gvn.type(value))) {
1452     return value;
1453   }
1454   Node* chk = _gvn.transform(new CmpPNode(value, null()));
1455   Node *tst = _gvn.transform(new BoolNode(chk, BoolTest::ne));
1456   Node* opaq = _gvn.transform(new Opaque4Node(C, tst, intcon(1)));
1457   IfNode *iff = new IfNode(control(), opaq, PROB_MAX, COUNT_UNKNOWN);
1458   _gvn.set_type(iff, iff-&gt;Value(&amp;_gvn));
1459   Node *if_f = _gvn.transform(new IfFalseNode(iff));
1460   Node *frame = _gvn.transform(new ParmNode(C-&gt;start(), TypeFunc::FramePtr));
1461   Node* halt = _gvn.transform(new HaltNode(if_f, frame, &quot;unexpected null in intrinsic&quot;));
1462   C-&gt;root()-&gt;add_req(halt);
1463   Node *if_t = _gvn.transform(new IfTrueNode(iff));
1464   set_control(if_t);
1465   return cast_not_null(value, do_replace_in_map);
1466 }
1467 
1468 
1469 //--------------------------replace_in_map-------------------------------------
1470 void GraphKit::replace_in_map(Node* old, Node* neww) {
1471   if (old == neww) {
1472     return;
1473   }
1474 
1475   map()-&gt;replace_edge(old, neww);
1476 
1477   // Note: This operation potentially replaces any edge
1478   // on the map.  This includes locals, stack, and monitors
1479   // of the current (innermost) JVM state.
1480 
1481   // don&#39;t let inconsistent types from profiling escape this
1482   // method
1483 
1484   const Type* told = _gvn.type(old);
1485   const Type* tnew = _gvn.type(neww);
1486 
1487   if (!tnew-&gt;higher_equal(told)) {
1488     return;
1489   }
1490 
1491   map()-&gt;record_replaced_node(old, neww);
1492 }
1493 
1494 
1495 //=============================================================================
1496 //--------------------------------memory---------------------------------------
1497 Node* GraphKit::memory(uint alias_idx) {
1498   MergeMemNode* mem = merged_memory();
1499   Node* p = mem-&gt;memory_at(alias_idx);
1500   _gvn.set_type(p, Type::MEMORY);  // must be mapped
1501   return p;
1502 }
1503 
1504 //-----------------------------reset_memory------------------------------------
1505 Node* GraphKit::reset_memory() {
1506   Node* mem = map()-&gt;memory();
1507   // do not use this node for any more parsing!
1508   debug_only( map()-&gt;set_memory((Node*)NULL) );
1509   return _gvn.transform( mem );
1510 }
1511 
1512 //------------------------------set_all_memory---------------------------------
1513 void GraphKit::set_all_memory(Node* newmem) {
1514   Node* mergemem = MergeMemNode::make(newmem);
1515   gvn().set_type_bottom(mergemem);
1516   map()-&gt;set_memory(mergemem);
1517 }
1518 
1519 //------------------------------set_all_memory_call----------------------------
1520 void GraphKit::set_all_memory_call(Node* call, bool separate_io_proj) {
1521   Node* newmem = _gvn.transform( new ProjNode(call, TypeFunc::Memory, separate_io_proj) );
1522   set_all_memory(newmem);
1523 }
1524 
1525 //=============================================================================
1526 //
1527 // parser factory methods for MemNodes
1528 //
1529 // These are layered on top of the factory methods in LoadNode and StoreNode,
1530 // and integrate with the parser&#39;s memory state and _gvn engine.
1531 //
1532 
1533 // factory methods in &quot;int adr_idx&quot;
1534 Node* GraphKit::make_load(Node* ctl, Node* adr, const Type* t, BasicType bt,
1535                           int adr_idx,
1536                           MemNode::MemOrd mo,
1537                           LoadNode::ControlDependency control_dependency,
1538                           bool require_atomic_access,
1539                           bool unaligned,
1540                           bool mismatched,
1541                           bool unsafe,
1542                           uint8_t barrier_data) {
1543   assert(adr_idx != Compile::AliasIdxTop, &quot;use other make_load factory&quot; );
1544   const TypePtr* adr_type = NULL; // debug-mode-only argument
1545   debug_only(adr_type = C-&gt;get_adr_type(adr_idx));
1546   Node* mem = memory(adr_idx);
1547   Node* ld;
1548   if (require_atomic_access &amp;&amp; bt == T_LONG) {
1549     ld = LoadLNode::make_atomic(ctl, mem, adr, adr_type, t, mo, control_dependency, unaligned, mismatched, unsafe, barrier_data);
1550   } else if (require_atomic_access &amp;&amp; bt == T_DOUBLE) {
1551     ld = LoadDNode::make_atomic(ctl, mem, adr, adr_type, t, mo, control_dependency, unaligned, mismatched, unsafe, barrier_data);
1552   } else {
1553     ld = LoadNode::make(_gvn, ctl, mem, adr, adr_type, t, bt, mo, control_dependency, unaligned, mismatched, unsafe, barrier_data);
1554   }
1555   ld = _gvn.transform(ld);
1556 
1557   if (((bt == T_OBJECT || bt == T_VALUETYPE) &amp;&amp; C-&gt;do_escape_analysis()) || C-&gt;eliminate_boxing()) {
1558     // Improve graph before escape analysis and boxing elimination.
1559     record_for_igvn(ld);
1560   }
1561   return ld;
1562 }
1563 
1564 Node* GraphKit::store_to_memory(Node* ctl, Node* adr, Node *val, BasicType bt,
1565                                 int adr_idx,
1566                                 MemNode::MemOrd mo,
1567                                 bool require_atomic_access,
1568                                 bool unaligned,
1569                                 bool mismatched,
1570                                 bool unsafe) {
1571   assert(adr_idx != Compile::AliasIdxTop, &quot;use other store_to_memory factory&quot; );
1572   const TypePtr* adr_type = NULL;
1573   debug_only(adr_type = C-&gt;get_adr_type(adr_idx));
1574   Node *mem = memory(adr_idx);
1575   Node* st;
1576   if (require_atomic_access &amp;&amp; bt == T_LONG) {
1577     st = StoreLNode::make_atomic(ctl, mem, adr, adr_type, val, mo);
1578   } else if (require_atomic_access &amp;&amp; bt == T_DOUBLE) {
1579     st = StoreDNode::make_atomic(ctl, mem, adr, adr_type, val, mo);
1580   } else {
1581     st = StoreNode::make(_gvn, ctl, mem, adr, adr_type, val, bt, mo);
1582   }
1583   if (unaligned) {
1584     st-&gt;as_Store()-&gt;set_unaligned_access();
1585   }
1586   if (mismatched) {
1587     st-&gt;as_Store()-&gt;set_mismatched_access();
1588   }
1589   if (unsafe) {
1590     st-&gt;as_Store()-&gt;set_unsafe_access();
1591   }
1592   st = _gvn.transform(st);
1593   set_memory(st, adr_idx);
1594   // Back-to-back stores can only remove intermediate store with DU info
1595   // so push on worklist for optimizer.
1596   if (mem-&gt;req() &gt; MemNode::Address &amp;&amp; adr == mem-&gt;in(MemNode::Address))
1597     record_for_igvn(st);
1598 
1599   return st;
1600 }
1601 
1602 Node* GraphKit::access_store_at(Node* obj,
1603                                 Node* adr,
1604                                 const TypePtr* adr_type,
1605                                 Node* val,
1606                                 const Type* val_type,
1607                                 BasicType bt,
1608                                 DecoratorSet decorators,
1609                                 bool safe_for_replace) {
1610   // Transformation of a value which could be NULL pointer (CastPP #NULL)
1611   // could be delayed during Parse (for example, in adjust_map_after_if()).
1612   // Execute transformation here to avoid barrier generation in such case.
1613   if (_gvn.type(val) == TypePtr::NULL_PTR) {
1614     val = _gvn.makecon(TypePtr::NULL_PTR);
1615   }
1616 
1617   if (stopped()) {
1618     return top(); // Dead path ?
1619   }
1620 
1621   assert(val != NULL, &quot;not dead path&quot;);
1622   if (val-&gt;is_ValueType()) {
1623     // Store to non-flattened field. Buffer the inline type and make sure
1624     // the store is re-executed if the allocation triggers deoptimization.
1625     PreserveReexecuteState preexecs(this);
1626     jvms()-&gt;set_should_reexecute(true);
1627     val = val-&gt;as_ValueType()-&gt;allocate(this, safe_for_replace)-&gt;get_oop();
1628   }
1629 
1630   C2AccessValuePtr addr(adr, adr_type);
1631   C2AccessValue value(val, val_type);
1632   C2ParseAccess access(this, decorators | C2_WRITE_ACCESS, bt, obj, addr);
1633   if (access.is_raw()) {
1634     return _barrier_set-&gt;BarrierSetC2::store_at(access, value);
1635   } else {
1636     return _barrier_set-&gt;store_at(access, value);
1637   }
1638 }
1639 
1640 Node* GraphKit::access_load_at(Node* obj,   // containing obj
1641                                Node* adr,   // actual adress to store val at
1642                                const TypePtr* adr_type,
1643                                const Type* val_type,
1644                                BasicType bt,
1645                                DecoratorSet decorators,
1646                                Node* ctl) {
1647   if (stopped()) {
1648     return top(); // Dead path ?
1649   }
1650 
1651   C2AccessValuePtr addr(adr, adr_type);
1652   C2ParseAccess access(this, decorators | C2_READ_ACCESS, bt, obj, addr, ctl);
1653   if (access.is_raw()) {
1654     return _barrier_set-&gt;BarrierSetC2::load_at(access, val_type);
1655   } else {
1656     return _barrier_set-&gt;load_at(access, val_type);
1657   }
1658 }
1659 
1660 Node* GraphKit::access_load(Node* adr,   // actual adress to load val at
1661                             const Type* val_type,
1662                             BasicType bt,
1663                             DecoratorSet decorators) {
1664   if (stopped()) {
1665     return top(); // Dead path ?
1666   }
1667 
1668   C2AccessValuePtr addr(adr, NULL);
1669   C2ParseAccess access(this, decorators | C2_READ_ACCESS, bt, NULL, addr);
1670   if (access.is_raw()) {
1671     return _barrier_set-&gt;BarrierSetC2::load_at(access, val_type);
1672   } else {
1673     return _barrier_set-&gt;load_at(access, val_type);
1674   }
1675 }
1676 
1677 Node* GraphKit::access_atomic_cmpxchg_val_at(Node* obj,
1678                                              Node* adr,
1679                                              const TypePtr* adr_type,
1680                                              int alias_idx,
1681                                              Node* expected_val,
1682                                              Node* new_val,
1683                                              const Type* value_type,
1684                                              BasicType bt,
1685                                              DecoratorSet decorators) {
1686   C2AccessValuePtr addr(adr, adr_type);
1687   C2AtomicParseAccess access(this, decorators | C2_READ_ACCESS | C2_WRITE_ACCESS,
1688                         bt, obj, addr, alias_idx);
1689   if (access.is_raw()) {
1690     return _barrier_set-&gt;BarrierSetC2::atomic_cmpxchg_val_at(access, expected_val, new_val, value_type);
1691   } else {
1692     return _barrier_set-&gt;atomic_cmpxchg_val_at(access, expected_val, new_val, value_type);
1693   }
1694 }
1695 
1696 Node* GraphKit::access_atomic_cmpxchg_bool_at(Node* obj,
1697                                               Node* adr,
1698                                               const TypePtr* adr_type,
1699                                               int alias_idx,
1700                                               Node* expected_val,
1701                                               Node* new_val,
1702                                               const Type* value_type,
1703                                               BasicType bt,
1704                                               DecoratorSet decorators) {
1705   C2AccessValuePtr addr(adr, adr_type);
1706   C2AtomicParseAccess access(this, decorators | C2_READ_ACCESS | C2_WRITE_ACCESS,
1707                         bt, obj, addr, alias_idx);
1708   if (access.is_raw()) {
1709     return _barrier_set-&gt;BarrierSetC2::atomic_cmpxchg_bool_at(access, expected_val, new_val, value_type);
1710   } else {
1711     return _barrier_set-&gt;atomic_cmpxchg_bool_at(access, expected_val, new_val, value_type);
1712   }
1713 }
1714 
1715 Node* GraphKit::access_atomic_xchg_at(Node* obj,
1716                                       Node* adr,
1717                                       const TypePtr* adr_type,
1718                                       int alias_idx,
1719                                       Node* new_val,
1720                                       const Type* value_type,
1721                                       BasicType bt,
1722                                       DecoratorSet decorators) {
1723   C2AccessValuePtr addr(adr, adr_type);
1724   C2AtomicParseAccess access(this, decorators | C2_READ_ACCESS | C2_WRITE_ACCESS,
1725                         bt, obj, addr, alias_idx);
1726   if (access.is_raw()) {
1727     return _barrier_set-&gt;BarrierSetC2::atomic_xchg_at(access, new_val, value_type);
1728   } else {
1729     return _barrier_set-&gt;atomic_xchg_at(access, new_val, value_type);
1730   }
1731 }
1732 
1733 Node* GraphKit::access_atomic_add_at(Node* obj,
1734                                      Node* adr,
1735                                      const TypePtr* adr_type,
1736                                      int alias_idx,
1737                                      Node* new_val,
1738                                      const Type* value_type,
1739                                      BasicType bt,
1740                                      DecoratorSet decorators) {
1741   C2AccessValuePtr addr(adr, adr_type);
1742   C2AtomicParseAccess access(this, decorators | C2_READ_ACCESS | C2_WRITE_ACCESS, bt, obj, addr, alias_idx);
1743   if (access.is_raw()) {
1744     return _barrier_set-&gt;BarrierSetC2::atomic_add_at(access, new_val, value_type);
1745   } else {
1746     return _barrier_set-&gt;atomic_add_at(access, new_val, value_type);
1747   }
1748 }
1749 
1750 void GraphKit::access_clone(Node* src_base, Node* dst_base, Node* countx, bool is_array) {
1751   return _barrier_set-&gt;clone(this, src_base, dst_base, countx, is_array);
1752 }
1753 
1754 //-------------------------array_element_address-------------------------
1755 Node* GraphKit::array_element_address(Node* ary, Node* idx, BasicType elembt,
1756                                       const TypeInt* sizetype, Node* ctrl) {
1757   uint shift  = exact_log2(type2aelembytes(elembt));
1758   ciKlass* arytype_klass = _gvn.type(ary)-&gt;is_aryptr()-&gt;klass();
1759   if (arytype_klass != NULL &amp;&amp; arytype_klass-&gt;is_value_array_klass()) {
1760     ciValueArrayKlass* vak = arytype_klass-&gt;as_value_array_klass();
1761     shift = vak-&gt;log2_element_size();
1762   }
1763   uint header = arrayOopDesc::base_offset_in_bytes(elembt);
1764 
1765   // short-circuit a common case (saves lots of confusing waste motion)
1766   jint idx_con = find_int_con(idx, -1);
1767   if (idx_con &gt;= 0) {
1768     intptr_t offset = header + ((intptr_t)idx_con &lt;&lt; shift);
1769     return basic_plus_adr(ary, offset);
1770   }
1771 
1772   // must be correct type for alignment purposes
1773   Node* base  = basic_plus_adr(ary, header);
1774   idx = Compile::conv_I2X_index(&amp;_gvn, idx, sizetype, ctrl);
1775   Node* scale = _gvn.transform( new LShiftXNode(idx, intcon(shift)) );
1776   return basic_plus_adr(ary, base, scale);
1777 }
1778 
1779 //-------------------------load_array_element-------------------------
1780 Node* GraphKit::load_array_element(Node* ctl, Node* ary, Node* idx, const TypeAryPtr* arytype) {
1781   const Type* elemtype = arytype-&gt;elem();
1782   BasicType elembt = elemtype-&gt;array_element_basic_type();
1783   assert(elembt != T_VALUETYPE, &quot;value types are not supported by this method&quot;);
1784   Node* adr = array_element_address(ary, idx, elembt, arytype-&gt;size());
1785   if (elembt == T_NARROWOOP) {
1786     elembt = T_OBJECT; // To satisfy switch in LoadNode::make()
1787   }
1788   Node* ld = make_load(ctl, adr, elemtype, elembt, arytype, MemNode::unordered);
1789   return ld;
1790 }
1791 
1792 //-------------------------set_arguments_for_java_call-------------------------
1793 // Arguments (pre-popped from the stack) are taken from the JVMS.
1794 void GraphKit::set_arguments_for_java_call(CallJavaNode* call, bool is_late_inline) {
1795   PreserveReexecuteState preexecs(this);
1796   if (EnableValhalla) {
1797     // Make sure the call is re-executed, if buffering of value type arguments triggers deoptimization
1798     jvms()-&gt;set_should_reexecute(true);
1799     int arg_size = method()-&gt;get_declared_signature_at_bci(bci())-&gt;arg_size_for_bc(java_bc());
1800     inc_sp(arg_size);
1801   }
1802   // Add the call arguments
1803   const TypeTuple* domain = call-&gt;tf()-&gt;domain_sig();
1804   ExtendedSignature sig_cc = ExtendedSignature(call-&gt;method()-&gt;get_sig_cc(), SigEntryFilter());
1805   uint nargs = domain-&gt;cnt();
1806   for (uint i = TypeFunc::Parms, idx = TypeFunc::Parms; i &lt; nargs; i++) {
1807     Node* arg = argument(i-TypeFunc::Parms);
1808     const Type* t = domain-&gt;field_at(i);
1809     if (call-&gt;method()-&gt;has_scalarized_args() &amp;&amp; t-&gt;is_valuetypeptr() &amp;&amp; !t-&gt;maybe_null()) {
1810       // We don&#39;t pass value type arguments by reference but instead pass each field of the value type
1811       ValueTypeNode* vt = arg-&gt;as_ValueType();
1812       vt-&gt;pass_fields(this, call, sig_cc, idx);
1813       // If a value type argument is passed as fields, attach the Method* to the call site
1814       // to be able to access the extended signature later via attached_method_before_pc().
1815       // For example, see CompiledMethod::preserve_callee_argument_oops().
1816       call-&gt;set_override_symbolic_info(true);
1817       continue;
1818     } else if (arg-&gt;is_ValueType()) {
1819       // Pass value type argument via oop to callee
1820       if (is_late_inline) {
1821         arg = ValueTypePtrNode::make_from_value_type(this, arg-&gt;as_ValueType());
1822       } else {
1823         arg = arg-&gt;as_ValueType()-&gt;allocate(this)-&gt;get_oop();
1824       }
1825     }
1826     call-&gt;init_req(idx++, arg);
1827     // Skip reserved arguments
1828     BasicType bt = t-&gt;basic_type();
1829     while (SigEntry::next_is_reserved(sig_cc, bt, true)) {
1830       call-&gt;init_req(idx++, top());
1831       if (type2size[bt] == 2) {
1832         call-&gt;init_req(idx++, top());
1833       }
1834     }
1835   }
1836 }
1837 
1838 //---------------------------set_edges_for_java_call---------------------------
1839 // Connect a newly created call into the current JVMS.
1840 // A return value node (if any) is returned from set_edges_for_java_call.
1841 void GraphKit::set_edges_for_java_call(CallJavaNode* call, bool must_throw, bool separate_io_proj) {
1842 
1843   // Add the predefined inputs:
1844   call-&gt;init_req( TypeFunc::Control, control() );
1845   call-&gt;init_req( TypeFunc::I_O    , i_o() );
1846   call-&gt;init_req( TypeFunc::Memory , reset_memory() );
1847   call-&gt;init_req( TypeFunc::FramePtr, frameptr() );
1848   call-&gt;init_req( TypeFunc::ReturnAdr, top() );
1849 
1850   add_safepoint_edges(call, must_throw);
1851 
1852   Node* xcall = _gvn.transform(call);
1853 
1854   if (xcall == top()) {
1855     set_control(top());
1856     return;
1857   }
1858   assert(xcall == call, &quot;call identity is stable&quot;);
1859 
1860   // Re-use the current map to produce the result.
1861 
1862   set_control(_gvn.transform(new ProjNode(call, TypeFunc::Control)));
1863   set_i_o(    _gvn.transform(new ProjNode(call, TypeFunc::I_O    , separate_io_proj)));
1864   set_all_memory_call(xcall, separate_io_proj);
1865 
1866   //return xcall;   // no need, caller already has it
1867 }
1868 
1869 Node* GraphKit::set_results_for_java_call(CallJavaNode* call, bool separate_io_proj, bool deoptimize) {
1870   if (stopped())  return top();  // maybe the call folded up?
1871 
1872   // Note:  Since any out-of-line call can produce an exception,
1873   // we always insert an I_O projection from the call into the result.
1874 
1875   make_slow_call_ex(call, env()-&gt;Throwable_klass(), separate_io_proj, deoptimize);
1876 
1877   if (separate_io_proj) {
1878     // The caller requested separate projections be used by the fall
1879     // through and exceptional paths, so replace the projections for
1880     // the fall through path.
1881     set_i_o(_gvn.transform( new ProjNode(call, TypeFunc::I_O) ));
1882     set_all_memory(_gvn.transform( new ProjNode(call, TypeFunc::Memory) ));
1883   }
1884 
1885   // Capture the return value, if any.
1886   Node* ret;
1887   if (call-&gt;method() == NULL || call-&gt;method()-&gt;return_type()-&gt;basic_type() == T_VOID) {
1888     ret = top();
1889   } else if (call-&gt;tf()-&gt;returns_value_type_as_fields()) {
1890     // Return of multiple values (value type fields): we create a
1891     // ValueType node, each field is a projection from the call.
1892     ciValueKlass* vk = call-&gt;method()-&gt;return_type()-&gt;as_value_klass();
1893     const Array&lt;SigEntry&gt;* sig_array = vk-&gt;extended_sig();
1894     GrowableArray&lt;SigEntry&gt; sig = GrowableArray&lt;SigEntry&gt;(sig_array-&gt;length());
1895     sig.appendAll(sig_array);
1896     ExtendedSignature sig_cc = ExtendedSignature(&amp;sig, SigEntryFilter());
1897     uint base_input = TypeFunc::Parms + 1;
1898     ret = ValueTypeNode::make_from_multi(this, call, sig_cc, vk, base_input, false);
1899   } else {
1900     ret = _gvn.transform(new ProjNode(call, TypeFunc::Parms));
1901   }
1902 
1903   return ret;
1904 }
1905 
1906 //--------------------set_predefined_input_for_runtime_call--------------------
1907 // Reading and setting the memory state is way conservative here.
1908 // The real problem is that I am not doing real Type analysis on memory,
1909 // so I cannot distinguish card mark stores from other stores.  Across a GC
1910 // point the Store Barrier and the card mark memory has to agree.  I cannot
1911 // have a card mark store and its barrier split across the GC point from
1912 // either above or below.  Here I get that to happen by reading ALL of memory.
1913 // A better answer would be to separate out card marks from other memory.
1914 // For now, return the input memory state, so that it can be reused
1915 // after the call, if this call has restricted memory effects.
1916 Node* GraphKit::set_predefined_input_for_runtime_call(SafePointNode* call, Node* narrow_mem) {
1917   // Set fixed predefined input arguments
1918   Node* memory = reset_memory();
1919   Node* m = narrow_mem == NULL ? memory : narrow_mem;
1920   call-&gt;init_req( TypeFunc::Control,   control()  );
1921   call-&gt;init_req( TypeFunc::I_O,       top()      ); // does no i/o
1922   call-&gt;init_req( TypeFunc::Memory,    m          ); // may gc ptrs
1923   call-&gt;init_req( TypeFunc::FramePtr,  frameptr() );
1924   call-&gt;init_req( TypeFunc::ReturnAdr, top()      );
1925   return memory;
1926 }
1927 
1928 //-------------------set_predefined_output_for_runtime_call--------------------
1929 // Set control and memory (not i_o) from the call.
1930 // If keep_mem is not NULL, use it for the output state,
1931 // except for the RawPtr output of the call, if hook_mem is TypeRawPtr::BOTTOM.
1932 // If hook_mem is NULL, this call produces no memory effects at all.
1933 // If hook_mem is a Java-visible memory slice (such as arraycopy operands),
1934 // then only that memory slice is taken from the call.
1935 // In the last case, we must put an appropriate memory barrier before
1936 // the call, so as to create the correct anti-dependencies on loads
1937 // preceding the call.
1938 void GraphKit::set_predefined_output_for_runtime_call(Node* call,
1939                                                       Node* keep_mem,
1940                                                       const TypePtr* hook_mem) {
1941   // no i/o
1942   set_control(_gvn.transform( new ProjNode(call,TypeFunc::Control) ));
1943   if (keep_mem) {
1944     // First clone the existing memory state
1945     set_all_memory(keep_mem);
1946     if (hook_mem != NULL) {
1947       // Make memory for the call
1948       Node* mem = _gvn.transform( new ProjNode(call, TypeFunc::Memory) );
1949       // Set the RawPtr memory state only.  This covers all the heap top/GC stuff
1950       // We also use hook_mem to extract specific effects from arraycopy stubs.
1951       set_memory(mem, hook_mem);
1952     }
1953     // ...else the call has NO memory effects.
1954 
1955     // Make sure the call advertises its memory effects precisely.
1956     // This lets us build accurate anti-dependences in gcm.cpp.
1957     assert(C-&gt;alias_type(call-&gt;adr_type()) == C-&gt;alias_type(hook_mem),
1958            &quot;call node must be constructed correctly&quot;);
1959   } else {
1960     assert(hook_mem == NULL, &quot;&quot;);
1961     // This is not a &quot;slow path&quot; call; all memory comes from the call.
1962     set_all_memory_call(call);
1963   }
1964 }
1965 
1966 // Keep track of MergeMems feeding into other MergeMems
1967 static void add_mergemem_users_to_worklist(Unique_Node_List&amp; wl, Node* mem) {
1968   if (!mem-&gt;is_MergeMem()) {
1969     return;
1970   }
1971   for (SimpleDUIterator i(mem); i.has_next(); i.next()) {
1972     Node* use = i.get();
1973     if (use-&gt;is_MergeMem()) {
1974       wl.push(use);
1975     }
1976   }
1977 }
1978 
1979 // Replace the call with the current state of the kit.
1980 void GraphKit::replace_call(CallNode* call, Node* result, bool do_replaced_nodes) {
1981   JVMState* ejvms = NULL;
1982   if (has_exceptions()) {
1983     ejvms = transfer_exceptions_into_jvms();
1984   }
1985 
1986   ReplacedNodes replaced_nodes = map()-&gt;replaced_nodes();
1987   ReplacedNodes replaced_nodes_exception;
1988   Node* ex_ctl = top();
1989 
1990   SafePointNode* final_state = stop();
1991 
1992   // Find all the needed outputs of this call
1993   CallProjections* callprojs = call-&gt;extract_projections(true);
1994 
1995   Unique_Node_List wl;
1996   Node* init_mem = call-&gt;in(TypeFunc::Memory);
1997   Node* final_mem = final_state-&gt;in(TypeFunc::Memory);
1998   Node* final_ctl = final_state-&gt;in(TypeFunc::Control);
1999   Node* final_io = final_state-&gt;in(TypeFunc::I_O);
2000 
2001   // Replace all the old call edges with the edges from the inlining result
2002   if (callprojs-&gt;fallthrough_catchproj != NULL) {
2003     C-&gt;gvn_replace_by(callprojs-&gt;fallthrough_catchproj, final_ctl);
2004   }
2005   if (callprojs-&gt;fallthrough_memproj != NULL) {
2006     if (final_mem-&gt;is_MergeMem()) {
2007       // Parser&#39;s exits MergeMem was not transformed but may be optimized
2008       final_mem = _gvn.transform(final_mem);
2009     }
2010     C-&gt;gvn_replace_by(callprojs-&gt;fallthrough_memproj,   final_mem);
2011     add_mergemem_users_to_worklist(wl, final_mem);
2012   }
2013   if (callprojs-&gt;fallthrough_ioproj != NULL) {
2014     C-&gt;gvn_replace_by(callprojs-&gt;fallthrough_ioproj,    final_io);
2015   }
2016 
2017   // Replace the result with the new result if it exists and is used
2018   if (callprojs-&gt;resproj[0] != NULL &amp;&amp; result != NULL) {
2019     assert(callprojs-&gt;nb_resproj == 1, &quot;unexpected number of results&quot;);
2020     C-&gt;gvn_replace_by(callprojs-&gt;resproj[0], result);
2021   }
2022 
2023   if (ejvms == NULL) {
2024     // No exception edges to simply kill off those paths
2025     if (callprojs-&gt;catchall_catchproj != NULL) {
2026       C-&gt;gvn_replace_by(callprojs-&gt;catchall_catchproj, C-&gt;top());
2027     }
2028     if (callprojs-&gt;catchall_memproj != NULL) {
2029       C-&gt;gvn_replace_by(callprojs-&gt;catchall_memproj,   C-&gt;top());
2030     }
2031     if (callprojs-&gt;catchall_ioproj != NULL) {
2032       C-&gt;gvn_replace_by(callprojs-&gt;catchall_ioproj,    C-&gt;top());
2033     }
2034     // Replace the old exception object with top
2035     if (callprojs-&gt;exobj != NULL) {
2036       C-&gt;gvn_replace_by(callprojs-&gt;exobj, C-&gt;top());
2037     }
2038   } else {
2039     GraphKit ekit(ejvms);
2040 
2041     // Load my combined exception state into the kit, with all phis transformed:
2042     SafePointNode* ex_map = ekit.combine_and_pop_all_exception_states();
2043     replaced_nodes_exception = ex_map-&gt;replaced_nodes();
2044 
2045     Node* ex_oop = ekit.use_exception_state(ex_map);
2046 
2047     if (callprojs-&gt;catchall_catchproj != NULL) {
2048       C-&gt;gvn_replace_by(callprojs-&gt;catchall_catchproj, ekit.control());
2049       ex_ctl = ekit.control();
2050     }
2051     if (callprojs-&gt;catchall_memproj != NULL) {
2052       Node* ex_mem = ekit.reset_memory();
2053       C-&gt;gvn_replace_by(callprojs-&gt;catchall_memproj,   ex_mem);
2054       add_mergemem_users_to_worklist(wl, ex_mem);
2055     }
2056     if (callprojs-&gt;catchall_ioproj != NULL) {
2057       C-&gt;gvn_replace_by(callprojs-&gt;catchall_ioproj,    ekit.i_o());
2058     }
2059 
2060     // Replace the old exception object with the newly created one
2061     if (callprojs-&gt;exobj != NULL) {
2062       C-&gt;gvn_replace_by(callprojs-&gt;exobj, ex_oop);
2063     }
2064   }
2065 
2066   // Disconnect the call from the graph
2067   call-&gt;disconnect_inputs(NULL, C);
2068   C-&gt;gvn_replace_by(call, C-&gt;top());
2069 
2070   // Clean up any MergeMems that feed other MergeMems since the
2071   // optimizer doesn&#39;t like that.
2072   while (wl.size() &gt; 0) {
2073     _gvn.transform(wl.pop());
2074   }
2075 
2076   if (callprojs-&gt;fallthrough_catchproj != NULL &amp;&amp; !final_ctl-&gt;is_top() &amp;&amp; do_replaced_nodes) {
2077     replaced_nodes.apply(C, final_ctl);
2078   }
2079   if (!ex_ctl-&gt;is_top() &amp;&amp; do_replaced_nodes) {
2080     replaced_nodes_exception.apply(C, ex_ctl);
2081   }
2082 }
2083 
2084 
2085 //------------------------------increment_counter------------------------------
2086 // for statistics: increment a VM counter by 1
2087 
2088 void GraphKit::increment_counter(address counter_addr) {
2089   Node* adr1 = makecon(TypeRawPtr::make(counter_addr));
2090   increment_counter(adr1);
2091 }
2092 
2093 void GraphKit::increment_counter(Node* counter_addr) {
2094   int adr_type = Compile::AliasIdxRaw;
2095   Node* ctrl = control();
2096   Node* cnt  = make_load(ctrl, counter_addr, TypeInt::INT, T_INT, adr_type, MemNode::unordered);
2097   Node* incr = _gvn.transform(new AddINode(cnt, _gvn.intcon(1)));
2098   store_to_memory(ctrl, counter_addr, incr, T_INT, adr_type, MemNode::unordered);
2099 }
2100 
2101 
2102 //------------------------------uncommon_trap----------------------------------
2103 // Bail out to the interpreter in mid-method.  Implemented by calling the
2104 // uncommon_trap blob.  This helper function inserts a runtime call with the
2105 // right debug info.
2106 void GraphKit::uncommon_trap(int trap_request,
2107                              ciKlass* klass, const char* comment,
2108                              bool must_throw,
2109                              bool keep_exact_action) {
2110   if (failing())  stop();
2111   if (stopped())  return; // trap reachable?
2112 
2113   // Note:  If ProfileTraps is true, and if a deopt. actually
2114   // occurs here, the runtime will make sure an MDO exists.  There is
2115   // no need to call method()-&gt;ensure_method_data() at this point.
2116 
2117   // Set the stack pointer to the right value for reexecution:
2118   set_sp(reexecute_sp());
2119 
2120 #ifdef ASSERT
2121   if (!must_throw) {
2122     // Make sure the stack has at least enough depth to execute
2123     // the current bytecode.
2124     int inputs, ignored_depth;
2125     if (compute_stack_effects(inputs, ignored_depth)) {
2126       assert(sp() &gt;= inputs, &quot;must have enough JVMS stack to execute %s: sp=%d, inputs=%d&quot;,
2127              Bytecodes::name(java_bc()), sp(), inputs);
2128     }
2129   }
2130 #endif
2131 
2132   Deoptimization::DeoptReason reason = Deoptimization::trap_request_reason(trap_request);
2133   Deoptimization::DeoptAction action = Deoptimization::trap_request_action(trap_request);
2134 
2135   switch (action) {
2136   case Deoptimization::Action_maybe_recompile:
2137   case Deoptimization::Action_reinterpret:
2138     // Temporary fix for 6529811 to allow virtual calls to be sure they
2139     // get the chance to go from mono-&gt;bi-&gt;mega
2140     if (!keep_exact_action &amp;&amp;
2141         Deoptimization::trap_request_index(trap_request) &lt; 0 &amp;&amp;
2142         too_many_recompiles(reason)) {
2143       // This BCI is causing too many recompilations.
2144       if (C-&gt;log() != NULL) {
2145         C-&gt;log()-&gt;elem(&quot;observe that=&#39;trap_action_change&#39; reason=&#39;%s&#39; from=&#39;%s&#39; to=&#39;none&#39;&quot;,
2146                 Deoptimization::trap_reason_name(reason),
2147                 Deoptimization::trap_action_name(action));
2148       }
2149       action = Deoptimization::Action_none;
2150       trap_request = Deoptimization::make_trap_request(reason, action);
2151     } else {
2152       C-&gt;set_trap_can_recompile(true);
2153     }
2154     break;
2155   case Deoptimization::Action_make_not_entrant:
2156     C-&gt;set_trap_can_recompile(true);
2157     break;
2158   case Deoptimization::Action_none:
2159   case Deoptimization::Action_make_not_compilable:
2160     break;
2161   default:
2162 #ifdef ASSERT
2163     fatal(&quot;unknown action %d: %s&quot;, action, Deoptimization::trap_action_name(action));
2164 #endif
2165     break;
2166   }
2167 
2168   if (TraceOptoParse) {
2169     char buf[100];
2170     tty-&gt;print_cr(&quot;Uncommon trap %s at bci:%d&quot;,
2171                   Deoptimization::format_trap_request(buf, sizeof(buf),
2172                                                       trap_request), bci());
2173   }
2174 
2175   CompileLog* log = C-&gt;log();
2176   if (log != NULL) {
2177     int kid = (klass == NULL)? -1: log-&gt;identify(klass);
2178     log-&gt;begin_elem(&quot;uncommon_trap bci=&#39;%d&#39;&quot;, bci());
2179     char buf[100];
2180     log-&gt;print(&quot; %s&quot;, Deoptimization::format_trap_request(buf, sizeof(buf),
2181                                                           trap_request));
2182     if (kid &gt;= 0)         log-&gt;print(&quot; klass=&#39;%d&#39;&quot;, kid);
2183     if (comment != NULL)  log-&gt;print(&quot; comment=&#39;%s&#39;&quot;, comment);
2184     log-&gt;end_elem();
2185   }
2186 
2187   // Make sure any guarding test views this path as very unlikely
2188   Node *i0 = control()-&gt;in(0);
2189   if (i0 != NULL &amp;&amp; i0-&gt;is_If()) {        // Found a guarding if test?
2190     IfNode *iff = i0-&gt;as_If();
2191     float f = iff-&gt;_prob;   // Get prob
2192     if (control()-&gt;Opcode() == Op_IfTrue) {
2193       if (f &gt; PROB_UNLIKELY_MAG(4))
2194         iff-&gt;_prob = PROB_MIN;
2195     } else {
2196       if (f &lt; PROB_LIKELY_MAG(4))
2197         iff-&gt;_prob = PROB_MAX;
2198     }
2199   }
2200 
2201   // Clear out dead values from the debug info.
2202   kill_dead_locals();
2203 
2204   // Now insert the uncommon trap subroutine call
2205   address call_addr = SharedRuntime::uncommon_trap_blob()-&gt;entry_point();
2206   const TypePtr* no_memory_effects = NULL;
2207   // Pass the index of the class to be loaded
2208   Node* call = make_runtime_call(RC_NO_LEAF | RC_UNCOMMON |
2209                                  (must_throw ? RC_MUST_THROW : 0),
2210                                  OptoRuntime::uncommon_trap_Type(),
2211                                  call_addr, &quot;uncommon_trap&quot;, no_memory_effects,
2212                                  intcon(trap_request));
2213   assert(call-&gt;as_CallStaticJava()-&gt;uncommon_trap_request() == trap_request,
2214          &quot;must extract request correctly from the graph&quot;);
2215   assert(trap_request != 0, &quot;zero value reserved by uncommon_trap_request&quot;);
2216 
2217   call-&gt;set_req(TypeFunc::ReturnAdr, returnadr());
2218   // The debug info is the only real input to this call.
2219 
2220   // Halt-and-catch fire here.  The above call should never return!
2221   HaltNode* halt = new HaltNode(control(), frameptr(), &quot;uncommon trap returned which should never happen&quot;);
2222   _gvn.set_type_bottom(halt);
2223   root()-&gt;add_req(halt);
2224 
2225   stop_and_kill_map();
2226 }
2227 
2228 
2229 //--------------------------just_allocated_object------------------------------
2230 // Report the object that was just allocated.
2231 // It must be the case that there are no intervening safepoints.
2232 // We use this to determine if an object is so &quot;fresh&quot; that
2233 // it does not require card marks.
2234 Node* GraphKit::just_allocated_object(Node* current_control) {
2235   Node* ctrl = current_control;
2236   // Object::&lt;init&gt; is invoked after allocation, most of invoke nodes
2237   // will be reduced, but a region node is kept in parse time, we check
2238   // the pattern and skip the region node if it degraded to a copy.
2239   if (ctrl != NULL &amp;&amp; ctrl-&gt;is_Region() &amp;&amp; ctrl-&gt;req() == 2 &amp;&amp;
2240       ctrl-&gt;as_Region()-&gt;is_copy()) {
2241     ctrl = ctrl-&gt;as_Region()-&gt;is_copy();
2242   }
2243   if (C-&gt;recent_alloc_ctl() == ctrl) {
2244    return C-&gt;recent_alloc_obj();
2245   }
2246   return NULL;
2247 }
2248 
2249 
2250 /**
2251  * Record profiling data exact_kls for Node n with the type system so
2252  * that it can propagate it (speculation)
2253  *
2254  * @param n          node that the type applies to
2255  * @param exact_kls  type from profiling
2256  * @param maybe_null did profiling see null?
2257  *
2258  * @return           node with improved type
2259  */
2260 Node* GraphKit::record_profile_for_speculation(Node* n, ciKlass* exact_kls, ProfilePtrKind ptr_kind) {
2261   const Type* current_type = _gvn.type(n);
2262   assert(UseTypeSpeculation, &quot;type speculation must be on&quot;);
2263 
2264   const TypePtr* speculative = current_type-&gt;speculative();
2265 
2266   // Should the klass from the profile be recorded in the speculative type?
2267   if (current_type-&gt;would_improve_type(exact_kls, jvms()-&gt;depth())) {
2268     const TypeKlassPtr* tklass = TypeKlassPtr::make(exact_kls);
2269     const TypeOopPtr* xtype = tklass-&gt;as_instance_type();
2270     assert(xtype-&gt;klass_is_exact(), &quot;Should be exact&quot;);
2271     // Any reason to believe n is not null (from this profiling or a previous one)?
2272     assert(ptr_kind != ProfileAlwaysNull, &quot;impossible here&quot;);
2273     const TypePtr* ptr = (ptr_kind == ProfileMaybeNull &amp;&amp; current_type-&gt;speculative_maybe_null()) ? TypePtr::BOTTOM : TypePtr::NOTNULL;
2274     // record the new speculative type&#39;s depth
2275     speculative = xtype-&gt;cast_to_ptr_type(ptr-&gt;ptr())-&gt;is_ptr();
2276     speculative = speculative-&gt;with_inline_depth(jvms()-&gt;depth());
2277   } else if (current_type-&gt;would_improve_ptr(ptr_kind)) {
2278     // Profiling report that null was never seen so we can change the
2279     // speculative type to non null ptr.
2280     if (ptr_kind == ProfileAlwaysNull) {
2281       speculative = TypePtr::NULL_PTR;
2282     } else {
2283       assert(ptr_kind == ProfileNeverNull, &quot;nothing else is an improvement&quot;);
2284       const TypePtr* ptr = TypePtr::NOTNULL;
2285       if (speculative != NULL) {
2286         speculative = speculative-&gt;cast_to_ptr_type(ptr-&gt;ptr())-&gt;is_ptr();
2287       } else {
2288         speculative = ptr;
2289       }
2290     }
2291   }
2292 
2293   if (speculative != current_type-&gt;speculative()) {
2294     // Build a type with a speculative type (what we think we know
2295     // about the type but will need a guard when we use it)
2296     const TypeOopPtr* spec_type = TypeOopPtr::make(TypePtr::BotPTR, Type::Offset::bottom, TypeOopPtr::InstanceBot, speculative);
2297     // We&#39;re changing the type, we need a new CheckCast node to carry
2298     // the new type. The new type depends on the control: what
2299     // profiling tells us is only valid from here as far as we can
2300     // tell.
2301     Node* cast = new CheckCastPPNode(control(), n, current_type-&gt;remove_speculative()-&gt;join_speculative(spec_type));
2302     cast = _gvn.transform(cast);
2303     replace_in_map(n, cast);
2304     n = cast;
2305   }
2306 
2307   return n;
2308 }
2309 
2310 /**
2311  * Record profiling data from receiver profiling at an invoke with the
2312  * type system so that it can propagate it (speculation)
2313  *
2314  * @param n  receiver node
2315  *
2316  * @return   node with improved type
2317  */
2318 Node* GraphKit::record_profiled_receiver_for_speculation(Node* n) {
2319   if (!UseTypeSpeculation) {
2320     return n;
2321   }
2322   ciKlass* exact_kls = profile_has_unique_klass();
2323   ProfilePtrKind ptr_kind = ProfileMaybeNull;
2324   if ((java_bc() == Bytecodes::_checkcast ||
2325        java_bc() == Bytecodes::_instanceof ||
2326        java_bc() == Bytecodes::_aastore) &amp;&amp;
2327       method()-&gt;method_data()-&gt;is_mature()) {
2328     ciProfileData* data = method()-&gt;method_data()-&gt;bci_to_data(bci());
2329     if (data != NULL) {
2330       if (java_bc() == Bytecodes::_aastore) {
2331         ciKlass* array_type = NULL;
2332         ciKlass* element_type = NULL;
2333         ProfilePtrKind element_ptr = ProfileMaybeNull;
2334         bool flat_array = true;
2335         bool null_free_array = true;
2336         method()-&gt;array_access_profiled_type(bci(), array_type, element_type, element_ptr, flat_array, null_free_array);
2337         exact_kls = element_type;
2338         ptr_kind = element_ptr;
2339       } else {
2340         if (!data-&gt;as_BitData()-&gt;null_seen()) {
2341           ptr_kind = ProfileNeverNull;
2342         } else {
2343           assert(data-&gt;is_ReceiverTypeData(), &quot;bad profile data type&quot;);
2344           ciReceiverTypeData* call = (ciReceiverTypeData*)data-&gt;as_ReceiverTypeData();
2345           uint i = 0;
2346           for (; i &lt; call-&gt;row_limit(); i++) {
2347             ciKlass* receiver = call-&gt;receiver(i);
2348             if (receiver != NULL) {
2349               break;
2350             }
2351           }
2352           ptr_kind = (i == call-&gt;row_limit()) ? ProfileAlwaysNull : ProfileMaybeNull;
2353         }
2354       }
2355     }
2356   }
2357   return record_profile_for_speculation(n, exact_kls, ptr_kind);
2358 }
2359 
2360 /**
2361  * Record profiling data from argument profiling at an invoke with the
2362  * type system so that it can propagate it (speculation)
2363  *
2364  * @param dest_method  target method for the call
2365  * @param bc           what invoke bytecode is this?
2366  */
2367 void GraphKit::record_profiled_arguments_for_speculation(ciMethod* dest_method, Bytecodes::Code bc) {
2368   if (!UseTypeSpeculation) {
2369     return;
2370   }
2371   const TypeFunc* tf    = TypeFunc::make(dest_method);
2372   int             nargs = tf-&gt;domain_sig()-&gt;cnt() - TypeFunc::Parms;
2373   int skip = Bytecodes::has_receiver(bc) ? 1 : 0;
2374   for (int j = skip, i = 0; j &lt; nargs &amp;&amp; i &lt; TypeProfileArgsLimit; j++) {
2375     const Type *targ = tf-&gt;domain_sig()-&gt;field_at(j + TypeFunc::Parms);
2376     if (is_reference_type(targ-&gt;basic_type())) {
2377       ProfilePtrKind ptr_kind = ProfileMaybeNull;
2378       ciKlass* better_type = NULL;
2379       if (method()-&gt;argument_profiled_type(bci(), i, better_type, ptr_kind)) {
2380         record_profile_for_speculation(argument(j), better_type, ptr_kind);
2381       }
2382       i++;
2383     }
2384   }
2385 }
2386 
2387 /**
2388  * Record profiling data from parameter profiling at an invoke with
2389  * the type system so that it can propagate it (speculation)
2390  */
2391 void GraphKit::record_profiled_parameters_for_speculation() {
2392   if (!UseTypeSpeculation) {
2393     return;
2394   }
2395   for (int i = 0, j = 0; i &lt; method()-&gt;arg_size() ; i++) {
2396     if (_gvn.type(local(i))-&gt;isa_oopptr()) {
2397       ProfilePtrKind ptr_kind = ProfileMaybeNull;
2398       ciKlass* better_type = NULL;
2399       if (method()-&gt;parameter_profiled_type(j, better_type, ptr_kind)) {
2400         record_profile_for_speculation(local(i), better_type, ptr_kind);
2401       }
2402       j++;
2403     }
2404   }
2405 }
2406 
2407 /**
2408  * Record profiling data from return value profiling at an invoke with
2409  * the type system so that it can propagate it (speculation)
2410  */
2411 void GraphKit::record_profiled_return_for_speculation() {
2412   if (!UseTypeSpeculation) {
2413     return;
2414   }
2415   ProfilePtrKind ptr_kind = ProfileMaybeNull;
2416   ciKlass* better_type = NULL;
2417   if (method()-&gt;return_profiled_type(bci(), better_type, ptr_kind)) {
2418     // If profiling reports a single type for the return value,
2419     // feed it to the type system so it can propagate it as a
2420     // speculative type
2421     record_profile_for_speculation(stack(sp()-1), better_type, ptr_kind);
2422   }
2423 }
2424 
2425 void GraphKit::round_double_result(ciMethod* dest_method) {
2426   if (Matcher::strict_fp_requires_explicit_rounding) {
2427     // If a strict caller invokes a non-strict callee, round a double result.
2428     // A non-strict method may return a double value which has an extended exponent,
2429     // but this must not be visible in a caller which is strict.
2430     BasicType result_type = dest_method-&gt;return_type()-&gt;basic_type();
2431     assert(method() != NULL, &quot;must have caller context&quot;);
2432     if( result_type == T_DOUBLE &amp;&amp; method()-&gt;is_strict() &amp;&amp; !dest_method-&gt;is_strict() ) {
2433       // Destination method&#39;s return value is on top of stack
2434       // dstore_rounding() does gvn.transform
2435       Node *result = pop_pair();
2436       result = dstore_rounding(result);
2437       push_pair(result);
2438     }
2439   }
2440 }
2441 
2442 void GraphKit::round_double_arguments(ciMethod* dest_method) {
2443   if (Matcher::strict_fp_requires_explicit_rounding) {
2444     // (Note:  TypeFunc::make has a cache that makes this fast.)
2445     const TypeFunc* tf    = TypeFunc::make(dest_method);
2446     int             nargs = tf-&gt;domain_sig()-&gt;cnt() - TypeFunc::Parms;
2447     for (int j = 0; j &lt; nargs; j++) {
2448       const Type *targ = tf-&gt;domain_sig()-&gt;field_at(j + TypeFunc::Parms);
2449       if (targ-&gt;basic_type() == T_DOUBLE) {
2450         // If any parameters are doubles, they must be rounded before
2451         // the call, dstore_rounding does gvn.transform
2452         Node *arg = argument(j);
2453         arg = dstore_rounding(arg);
2454         set_argument(j, arg);
2455       }
2456     }
2457   }
2458 }
2459 
2460 // rounding for strict float precision conformance
2461 Node* GraphKit::precision_rounding(Node* n) {
2462   if (Matcher::strict_fp_requires_explicit_rounding) {
2463 #ifdef IA32
2464     if (_method-&gt;flags().is_strict() &amp;&amp; UseSSE == 0) {
2465       return _gvn.transform(new RoundFloatNode(0, n));
2466     }
2467 #else
2468     Unimplemented();
2469 #endif // IA32
2470   }
2471   return n;
2472 }
2473 
2474 // rounding for strict double precision conformance
2475 Node* GraphKit::dprecision_rounding(Node *n) {
2476   if (Matcher::strict_fp_requires_explicit_rounding) {
2477 #ifdef IA32
2478     if (_method-&gt;flags().is_strict() &amp;&amp; UseSSE &lt; 2) {
2479       return _gvn.transform(new RoundDoubleNode(0, n));
2480     }
2481 #else
2482     Unimplemented();
2483 #endif // IA32
2484   }
2485   return n;
2486 }
2487 
2488 // rounding for non-strict double stores
2489 Node* GraphKit::dstore_rounding(Node* n) {
2490   if (Matcher::strict_fp_requires_explicit_rounding) {
2491 #ifdef IA32
2492     if (UseSSE &lt; 2) {
2493       return _gvn.transform(new RoundDoubleNode(0, n));
2494     }
2495 #else
2496     Unimplemented();
2497 #endif // IA32
2498   }
2499   return n;
2500 }
2501 
2502 //=============================================================================
2503 // Generate a fast path/slow path idiom.  Graph looks like:
2504 // [foo] indicates that &#39;foo&#39; is a parameter
2505 //
2506 //              [in]     NULL
2507 //                 \    /
2508 //                  CmpP
2509 //                  Bool ne
2510 //                   If
2511 //                  /  \
2512 //              True    False-&lt;2&gt;
2513 //              / |
2514 //             /  cast_not_null
2515 //           Load  |    |   ^
2516 //        [fast_test]   |   |
2517 // gvn to   opt_test    |   |
2518 //          /    \      |  &lt;1&gt;
2519 //      True     False  |
2520 //        |         \\  |
2521 //   [slow_call]     \[fast_result]
2522 //    Ctl   Val       \      \
2523 //     |               \      \
2524 //    Catch       &lt;1&gt;   \      \
2525 //   /    \        ^     \      \
2526 //  Ex    No_Ex    |      \      \
2527 //  |       \   \  |       \ &lt;2&gt;  \
2528 //  ...      \  [slow_res] |  |    \   [null_result]
2529 //            \         \--+--+---  |  |
2530 //             \           | /    \ | /
2531 //              --------Region     Phi
2532 //
2533 //=============================================================================
2534 // Code is structured as a series of driver functions all called &#39;do_XXX&#39; that
2535 // call a set of helper functions.  Helper functions first, then drivers.
2536 
2537 //------------------------------null_check_oop---------------------------------
2538 // Null check oop.  Set null-path control into Region in slot 3.
2539 // Make a cast-not-nullness use the other not-null control.  Return cast.
2540 Node* GraphKit::null_check_oop(Node* value, Node* *null_control,
2541                                bool never_see_null,
2542                                bool safe_for_replace,
2543                                bool speculative) {
2544   // Initial NULL check taken path
2545   (*null_control) = top();
2546   Node* cast = null_check_common(value, T_OBJECT, false, null_control, speculative);
2547 
2548   // Generate uncommon_trap:
2549   if (never_see_null &amp;&amp; (*null_control) != top()) {
2550     // If we see an unexpected null at a check-cast we record it and force a
2551     // recompile; the offending check-cast will be compiled to handle NULLs.
2552     // If we see more than one offending BCI, then all checkcasts in the
2553     // method will be compiled to handle NULLs.
2554     PreserveJVMState pjvms(this);
2555     set_control(*null_control);
2556     replace_in_map(value, null());
2557     Deoptimization::DeoptReason reason = Deoptimization::reason_null_check(speculative);
2558     uncommon_trap(reason,
2559                   Deoptimization::Action_make_not_entrant);
2560     (*null_control) = top();    // NULL path is dead
2561   }
2562   if ((*null_control) == top() &amp;&amp; safe_for_replace) {
2563     replace_in_map(value, cast);
2564   }
2565 
2566   // Cast away null-ness on the result
2567   return cast;
2568 }
2569 
2570 //------------------------------opt_iff----------------------------------------
2571 // Optimize the fast-check IfNode.  Set the fast-path region slot 2.
2572 // Return slow-path control.
2573 Node* GraphKit::opt_iff(Node* region, Node* iff) {
2574   IfNode *opt_iff = _gvn.transform(iff)-&gt;as_If();
2575 
2576   // Fast path taken; set region slot 2
2577   Node *fast_taken = _gvn.transform( new IfFalseNode(opt_iff) );
2578   region-&gt;init_req(2,fast_taken); // Capture fast-control
2579 
2580   // Fast path not-taken, i.e. slow path
2581   Node *slow_taken = _gvn.transform( new IfTrueNode(opt_iff) );
2582   return slow_taken;
2583 }
2584 
2585 //-----------------------------make_runtime_call-------------------------------
2586 Node* GraphKit::make_runtime_call(int flags,
2587                                   const TypeFunc* call_type, address call_addr,
2588                                   const char* call_name,
2589                                   const TypePtr* adr_type,
2590                                   // The following parms are all optional.
2591                                   // The first NULL ends the list.
2592                                   Node* parm0, Node* parm1,
2593                                   Node* parm2, Node* parm3,
2594                                   Node* parm4, Node* parm5,
2595                                   Node* parm6, Node* parm7) {
2596   assert(call_addr != NULL, &quot;must not call NULL targets&quot;);
2597 
2598   // Slow-path call
2599   bool is_leaf = !(flags &amp; RC_NO_LEAF);
2600   bool has_io  = (!is_leaf &amp;&amp; !(flags &amp; RC_NO_IO));
2601   if (call_name == NULL) {
2602     assert(!is_leaf, &quot;must supply name for leaf&quot;);
2603     call_name = OptoRuntime::stub_name(call_addr);
2604   }
2605   CallNode* call;
2606   if (!is_leaf) {
2607     call = new CallStaticJavaNode(call_type, call_addr, call_name,
2608                                            bci(), adr_type);
2609   } else if (flags &amp; RC_NO_FP) {
2610     call = new CallLeafNoFPNode(call_type, call_addr, call_name, adr_type);
2611   } else {
2612     call = new CallLeafNode(call_type, call_addr, call_name, adr_type);
2613   }
2614 
2615   // The following is similar to set_edges_for_java_call,
2616   // except that the memory effects of the call are restricted to AliasIdxRaw.
2617 
2618   // Slow path call has no side-effects, uses few values
2619   bool wide_in  = !(flags &amp; RC_NARROW_MEM);
2620   bool wide_out = (C-&gt;get_alias_index(adr_type) == Compile::AliasIdxBot);
2621 
2622   Node* prev_mem = NULL;
2623   if (wide_in) {
2624     prev_mem = set_predefined_input_for_runtime_call(call);
2625   } else {
2626     assert(!wide_out, &quot;narrow in =&gt; narrow out&quot;);
2627     Node* narrow_mem = memory(adr_type);
2628     prev_mem = set_predefined_input_for_runtime_call(call, narrow_mem);
2629   }
2630 
2631   // Hook each parm in order.  Stop looking at the first NULL.
2632   if (parm0 != NULL) { call-&gt;init_req(TypeFunc::Parms+0, parm0);
2633   if (parm1 != NULL) { call-&gt;init_req(TypeFunc::Parms+1, parm1);
2634   if (parm2 != NULL) { call-&gt;init_req(TypeFunc::Parms+2, parm2);
2635   if (parm3 != NULL) { call-&gt;init_req(TypeFunc::Parms+3, parm3);
2636   if (parm4 != NULL) { call-&gt;init_req(TypeFunc::Parms+4, parm4);
2637   if (parm5 != NULL) { call-&gt;init_req(TypeFunc::Parms+5, parm5);
2638   if (parm6 != NULL) { call-&gt;init_req(TypeFunc::Parms+6, parm6);
2639   if (parm7 != NULL) { call-&gt;init_req(TypeFunc::Parms+7, parm7);
2640     /* close each nested if ===&gt; */  } } } } } } } }
2641   assert(call-&gt;in(call-&gt;req()-1) != NULL, &quot;must initialize all parms&quot;);
2642 
2643   if (!is_leaf) {
2644     // Non-leaves can block and take safepoints:
2645     add_safepoint_edges(call, ((flags &amp; RC_MUST_THROW) != 0));
2646   }
2647   // Non-leaves can throw exceptions:
2648   if (has_io) {
2649     call-&gt;set_req(TypeFunc::I_O, i_o());
2650   }
2651 
2652   if (flags &amp; RC_UNCOMMON) {
2653     // Set the count to a tiny probability.  Cf. Estimate_Block_Frequency.
2654     // (An &quot;if&quot; probability corresponds roughly to an unconditional count.
2655     // Sort of.)
2656     call-&gt;set_cnt(PROB_UNLIKELY_MAG(4));
2657   }
2658 
2659   Node* c = _gvn.transform(call);
2660   assert(c == call, &quot;cannot disappear&quot;);
2661 
2662   if (wide_out) {
2663     // Slow path call has full side-effects.
2664     set_predefined_output_for_runtime_call(call);
2665   } else {
2666     // Slow path call has few side-effects, and/or sets few values.
2667     set_predefined_output_for_runtime_call(call, prev_mem, adr_type);
2668   }
2669 
2670   if (has_io) {
2671     set_i_o(_gvn.transform(new ProjNode(call, TypeFunc::I_O)));
2672   }
2673   return call;
2674 
2675 }
2676 
2677 //------------------------------merge_memory-----------------------------------
2678 // Merge memory from one path into the current memory state.
2679 void GraphKit::merge_memory(Node* new_mem, Node* region, int new_path) {
2680   for (MergeMemStream mms(merged_memory(), new_mem-&gt;as_MergeMem()); mms.next_non_empty2(); ) {
2681     Node* old_slice = mms.force_memory();
2682     Node* new_slice = mms.memory2();
2683     if (old_slice != new_slice) {
2684       PhiNode* phi;
2685       if (old_slice-&gt;is_Phi() &amp;&amp; old_slice-&gt;as_Phi()-&gt;region() == region) {
2686         if (mms.is_empty()) {
2687           // clone base memory Phi&#39;s inputs for this memory slice
2688           assert(old_slice == mms.base_memory(), &quot;sanity&quot;);
2689           phi = PhiNode::make(region, NULL, Type::MEMORY, mms.adr_type(C));
2690           _gvn.set_type(phi, Type::MEMORY);
2691           for (uint i = 1; i &lt; phi-&gt;req(); i++) {
2692             phi-&gt;init_req(i, old_slice-&gt;in(i));
2693           }
2694         } else {
2695           phi = old_slice-&gt;as_Phi(); // Phi was generated already
2696         }
2697       } else {
2698         phi = PhiNode::make(region, old_slice, Type::MEMORY, mms.adr_type(C));
2699         _gvn.set_type(phi, Type::MEMORY);
2700       }
2701       phi-&gt;set_req(new_path, new_slice);
2702       mms.set_memory(phi);
2703     }
2704   }
2705 }
2706 
2707 //------------------------------make_slow_call_ex------------------------------
2708 // Make the exception handler hookups for the slow call
2709 void GraphKit::make_slow_call_ex(Node* call, ciInstanceKlass* ex_klass, bool separate_io_proj, bool deoptimize) {
2710   if (stopped())  return;
2711 
2712   // Make a catch node with just two handlers:  fall-through and catch-all
2713   Node* i_o  = _gvn.transform( new ProjNode(call, TypeFunc::I_O, separate_io_proj) );
2714   Node* catc = _gvn.transform( new CatchNode(control(), i_o, 2) );
2715   Node* norm = _gvn.transform( new CatchProjNode(catc, CatchProjNode::fall_through_index, CatchProjNode::no_handler_bci) );
2716   Node* excp = _gvn.transform( new CatchProjNode(catc, CatchProjNode::catch_all_index,    CatchProjNode::no_handler_bci) );
2717 
2718   { PreserveJVMState pjvms(this);
2719     set_control(excp);
2720     set_i_o(i_o);
2721 
2722     if (excp != top()) {
2723       if (deoptimize) {
2724         // Deoptimize if an exception is caught. Don&#39;t construct exception state in this case.
2725         uncommon_trap(Deoptimization::Reason_unhandled,
2726                       Deoptimization::Action_none);
2727       } else {
2728         // Create an exception state also.
2729         // Use an exact type if the caller has a specific exception.
2730         const Type* ex_type = TypeOopPtr::make_from_klass_unique(ex_klass)-&gt;cast_to_ptr_type(TypePtr::NotNull);
2731         Node*       ex_oop  = new CreateExNode(ex_type, control(), i_o);
2732         add_exception_state(make_exception_state(_gvn.transform(ex_oop)));
2733       }
2734     }
2735   }
2736 
2737   // Get the no-exception control from the CatchNode.
2738   set_control(norm);
2739 }
2740 
2741 static IfNode* gen_subtype_check_compare(Node* ctrl, Node* in1, Node* in2, BoolTest::mask test, float p, PhaseGVN&amp; gvn, BasicType bt) {
2742   Node* cmp = NULL;
2743   switch(bt) {
2744   case T_INT: cmp = new CmpINode(in1, in2); break;
2745   case T_ADDRESS: cmp = new CmpPNode(in1, in2); break;
2746   default: fatal(&quot;unexpected comparison type %s&quot;, type2name(bt));
2747   }
2748   gvn.transform(cmp);
2749   Node* bol = gvn.transform(new BoolNode(cmp, test));
2750   IfNode* iff = new IfNode(ctrl, bol, p, COUNT_UNKNOWN);
2751   gvn.transform(iff);
2752   if (!bol-&gt;is_Con()) gvn.record_for_igvn(iff);
2753   return iff;
2754 }
2755 
<a name="1" id="anc1"></a><span class="line-removed">2756 // Find the memory state for the secondary super type cache load when</span>
<span class="line-removed">2757 // a subtype check is expanded at macro expansion time. That field is</span>
<span class="line-removed">2758 // mutable so should not use immutable memory but</span>
<span class="line-removed">2759 // PartialSubtypeCheckNode that might modify it doesn&#39;t produce a new</span>
<span class="line-removed">2760 // memory state so bottom memory is the most accurate memory state to</span>
<span class="line-removed">2761 // hook the load with. This follows the implementation used when the</span>
<span class="line-removed">2762 // subtype check is expanded at parse time.</span>
<span class="line-removed">2763 static Node* find_bottom_mem(Node* ctrl, Compile* C) {</span>
<span class="line-removed">2764   const TypePtr* adr_type = TypeKlassPtr::make(TypePtr::NotNull, C-&gt;env()-&gt;Object_klass(), Type::Offset::bottom, false);</span>
<span class="line-removed">2765   Node_Stack stack(0);</span>
<span class="line-removed">2766   VectorSet seen(Thread::current()-&gt;resource_area());</span>
<span class="line-removed">2767 </span>
<span class="line-removed">2768   Node* c = ctrl;</span>
<span class="line-removed">2769   Node* mem = NULL;</span>
<span class="line-removed">2770   uint iter = 0;</span>
<span class="line-removed">2771   do {</span>
<span class="line-removed">2772     iter++;</span>
<span class="line-removed">2773     assert(iter &lt; C-&gt;live_nodes(), &quot;infinite loop&quot;);</span>
<span class="line-removed">2774     if (c-&gt;is_Region()) {</span>
<span class="line-removed">2775       for (DUIterator_Fast imax, i = c-&gt;fast_outs(imax); i &lt; imax &amp;&amp; mem == NULL; i++) {</span>
<span class="line-removed">2776         Node* u = c-&gt;fast_out(i);</span>
<span class="line-removed">2777         if (u-&gt;is_Phi() &amp;&amp; u-&gt;bottom_type() == Type::MEMORY &amp;&amp;</span>
<span class="line-removed">2778             (u-&gt;adr_type() == TypePtr::BOTTOM || u-&gt;adr_type() == adr_type)) {</span>
<span class="line-removed">2779           mem = u;</span>
<span class="line-removed">2780         }</span>
<span class="line-removed">2781       }</span>
<span class="line-removed">2782       if (mem == NULL) {</span>
<span class="line-removed">2783         if (!seen.test_set(c-&gt;_idx)) {</span>
<span class="line-removed">2784           stack.push(c, 2);</span>
<span class="line-removed">2785           c = c-&gt;in(1);</span>
<span class="line-removed">2786         } else {</span>
<span class="line-removed">2787           Node* phi = NULL;</span>
<span class="line-removed">2788           uint idx = 0;</span>
<span class="line-removed">2789           for (;;) {</span>
<span class="line-removed">2790             phi = stack.node();</span>
<span class="line-removed">2791             idx = stack.index();</span>
<span class="line-removed">2792             if (idx &lt; phi-&gt;req()) {</span>
<span class="line-removed">2793               break;</span>
<span class="line-removed">2794             }</span>
<span class="line-removed">2795             stack.pop();</span>
<span class="line-removed">2796           }</span>
<span class="line-removed">2797           c = phi-&gt;in(idx);</span>
<span class="line-removed">2798           stack.set_index(idx+1);</span>
<span class="line-removed">2799         }</span>
<span class="line-removed">2800       }</span>
<span class="line-removed">2801     } else if (c-&gt;is_Proj() &amp;&amp; c-&gt;in(0)-&gt;adr_type() == TypePtr::BOTTOM) {</span>
<span class="line-removed">2802       for (DUIterator_Fast imax, i = c-&gt;in(0)-&gt;fast_outs(imax); i &lt; imax; i++) {</span>
<span class="line-removed">2803         Node* u = c-&gt;in(0)-&gt;fast_out(i);</span>
<span class="line-removed">2804         if (u-&gt;bottom_type() == Type::MEMORY &amp;&amp; u-&gt;as_Proj()-&gt;_is_io_use == c-&gt;as_Proj()-&gt;_is_io_use) {</span>
<span class="line-removed">2805           assert(mem == NULL, &quot;&quot;);</span>
<span class="line-removed">2806           mem = u;</span>
<span class="line-removed">2807         }</span>
<span class="line-removed">2808       }</span>
<span class="line-removed">2809     } else if (c-&gt;is_CatchProj() &amp;&amp; c-&gt;in(0)-&gt;in(0)-&gt;in(0)-&gt;adr_type() == TypePtr::BOTTOM) {</span>
<span class="line-removed">2810       Node* call = c-&gt;in(0)-&gt;in(0)-&gt;in(0);</span>
<span class="line-removed">2811       assert(call-&gt;is_Call(), &quot;CatchProj with no call?&quot;);</span>
<span class="line-removed">2812       CallProjections* projs = call-&gt;as_Call()-&gt;extract_projections(false, false);</span>
<span class="line-removed">2813       if (projs-&gt;catchall_memproj == NULL) {</span>
<span class="line-removed">2814         mem = projs-&gt;fallthrough_memproj;</span>
<span class="line-removed">2815       } else if (c == projs-&gt;fallthrough_catchproj) {</span>
<span class="line-removed">2816         mem = projs-&gt;fallthrough_memproj;</span>
<span class="line-removed">2817       } else {</span>
<span class="line-removed">2818         assert(c == projs-&gt;catchall_catchproj, &quot;strange control&quot;);</span>
<span class="line-removed">2819         mem = projs-&gt;catchall_memproj;</span>
<span class="line-removed">2820       }</span>
<span class="line-removed">2821     } else {</span>
<span class="line-removed">2822       assert(!c-&gt;is_Start(), &quot;should stop before start&quot;);</span>
<span class="line-removed">2823       c = c-&gt;in(0);</span>
<span class="line-removed">2824     }</span>
<span class="line-removed">2825   } while (mem == NULL);</span>
<span class="line-removed">2826   return mem;</span>
<span class="line-removed">2827 }</span>
<span class="line-removed">2828 </span>
2829 //-------------------------------gen_subtype_check-----------------------------
2830 // Generate a subtyping check.  Takes as input the subtype and supertype.
2831 // Returns 2 values: sets the default control() to the true path and returns
2832 // the false path.  Only reads invariant memory; sets no (visible) memory.
2833 // The PartialSubtypeCheckNode sets the hidden 1-word cache in the encoding
2834 // but that&#39;s not exposed to the optimizer.  This call also doesn&#39;t take in an
2835 // Object; if you wish to check an Object you need to load the Object&#39;s class
2836 // prior to coming here.
2837 Node* Phase::gen_subtype_check(Node* subklass, Node* superklass, Node** ctrl, Node* mem, PhaseGVN&amp; gvn) {
2838   Compile* C = gvn.C;
2839   if ((*ctrl)-&gt;is_top()) {
2840     return C-&gt;top();
2841   }
2842 
2843   // Fast check for identical types, perhaps identical constants.
2844   // The types can even be identical non-constants, in cases
2845   // involving Array.newInstance, Object.clone, etc.
2846   if (subklass == superklass)
2847     return C-&gt;top();             // false path is dead; no test needed.
2848 
2849   if (gvn.type(superklass)-&gt;singleton()) {
2850     ciKlass* superk = gvn.type(superklass)-&gt;is_klassptr()-&gt;klass();
2851     ciKlass* subk   = gvn.type(subklass)-&gt;is_klassptr()-&gt;klass();
2852 
2853     // In the common case of an exact superklass, try to fold up the
2854     // test before generating code.  You may ask, why not just generate
2855     // the code and then let it fold up?  The answer is that the generated
2856     // code will necessarily include null checks, which do not always
2857     // completely fold away.  If they are also needless, then they turn
2858     // into a performance loss.  Example:
2859     //    Foo[] fa = blah(); Foo x = fa[0]; fa[1] = x;
2860     // Here, the type of &#39;fa&#39; is often exact, so the store check
2861     // of fa[1]=x will fold up, without testing the nullness of x.
2862     switch (C-&gt;static_subtype_check(superk, subk)) {
2863     case Compile::SSC_always_false:
2864       {
2865         Node* always_fail = *ctrl;
2866         *ctrl = gvn.C-&gt;top();
2867         return always_fail;
2868       }
2869     case Compile::SSC_always_true:
2870       return C-&gt;top();
2871     case Compile::SSC_easy_test:
2872       {
2873         // Just do a direct pointer compare and be done.
2874         IfNode* iff = gen_subtype_check_compare(*ctrl, subklass, superklass, BoolTest::eq, PROB_STATIC_FREQUENT, gvn, T_ADDRESS);
2875         *ctrl = gvn.transform(new IfTrueNode(iff));
2876         return gvn.transform(new IfFalseNode(iff));
2877       }
2878     case Compile::SSC_full_test:
2879       break;
2880     default:
2881       ShouldNotReachHere();
2882     }
2883   }
2884 
2885   // %%% Possible further optimization:  Even if the superklass is not exact,
2886   // if the subklass is the unique subtype of the superklass, the check
2887   // will always succeed.  We could leave a dependency behind to ensure this.
2888 
2889   // First load the super-klass&#39;s check-offset
2890   Node *p1 = gvn.transform(new AddPNode(superklass, superklass, gvn.MakeConX(in_bytes(Klass::super_check_offset_offset()))));
2891   Node* m = C-&gt;immutable_memory();
2892   Node *chk_off = gvn.transform(new LoadINode(NULL, m, p1, gvn.type(p1)-&gt;is_ptr(), TypeInt::INT, MemNode::unordered));
2893   int cacheoff_con = in_bytes(Klass::secondary_super_cache_offset());
2894   bool might_be_cache = (gvn.find_int_con(chk_off, cacheoff_con) == cacheoff_con);
2895 
2896   // Load from the sub-klass&#39;s super-class display list, or a 1-word cache of
2897   // the secondary superclass list, or a failing value with a sentinel offset
2898   // if the super-klass is an interface or exceptionally deep in the Java
2899   // hierarchy and we have to scan the secondary superclass list the hard way.
2900   // Worst-case type is a little odd: NULL is allowed as a result (usually
2901   // klass loads can never produce a NULL).
2902   Node *chk_off_X = chk_off;
2903 #ifdef _LP64
2904   chk_off_X = gvn.transform(new ConvI2LNode(chk_off_X));
2905 #endif
2906   Node *p2 = gvn.transform(new AddPNode(subklass,subklass,chk_off_X));
2907   // For some types like interfaces the following loadKlass is from a 1-word
2908   // cache which is mutable so can&#39;t use immutable memory.  Other
2909   // types load from the super-class display table which is immutable.
2910   Node *kmem = C-&gt;immutable_memory();
<a name="2" id="anc2"></a><span class="line-modified">2911   if (might_be_cache) {</span>
<span class="line-modified">2912     assert((C-&gt;get_alias_index(TypeKlassPtr::make(TypePtr::NotNull, C-&gt;env()-&gt;Object_klass(), Type::Offset::bottom, false)) ==</span>
<span class="line-modified">2913             C-&gt;get_alias_index(gvn.type(p2)-&gt;is_ptr())), &quot;&quot;);</span>
<span class="line-modified">2914     if (mem == NULL) {</span>
<span class="line-modified">2915       mem = find_bottom_mem(*ctrl, C);</span>
<span class="line-modified">2916     }</span>
2917     kmem = mem-&gt;is_MergeMem() ? mem-&gt;as_MergeMem()-&gt;memory_at(C-&gt;get_alias_index(gvn.type(p2)-&gt;is_ptr())) : mem;
2918   }
2919   Node *nkls = gvn.transform(LoadKlassNode::make(gvn, NULL, kmem, p2, gvn.type(p2)-&gt;is_ptr(), TypeKlassPtr::OBJECT_OR_NULL));
2920 
2921   // Compile speed common case: ARE a subtype and we canNOT fail
2922   if( superklass == nkls )
2923     return C-&gt;top();             // false path is dead; no test needed.
2924 
2925   // See if we get an immediate positive hit.  Happens roughly 83% of the
2926   // time.  Test to see if the value loaded just previously from the subklass
2927   // is exactly the superklass.
2928   IfNode *iff1 = gen_subtype_check_compare(*ctrl, superklass, nkls, BoolTest::eq, PROB_LIKELY(0.83f), gvn, T_ADDRESS);
2929   Node *iftrue1 = gvn.transform( new IfTrueNode (iff1));
2930   *ctrl = gvn.transform(new IfFalseNode(iff1));
2931 
2932   // Compile speed common case: Check for being deterministic right now.  If
2933   // chk_off is a constant and not equal to cacheoff then we are NOT a
2934   // subklass.  In this case we need exactly the 1 test above and we can
2935   // return those results immediately.
2936   if (!might_be_cache) {
2937     Node* not_subtype_ctrl = *ctrl;
2938     *ctrl = iftrue1; // We need exactly the 1 test above
2939     return not_subtype_ctrl;
2940   }
2941 
2942   // Gather the various success &amp; failures here
2943   RegionNode *r_ok_subtype = new RegionNode(4);
2944   gvn.record_for_igvn(r_ok_subtype);
2945   RegionNode *r_not_subtype = new RegionNode(3);
2946   gvn.record_for_igvn(r_not_subtype);
2947 
2948   r_ok_subtype-&gt;init_req(1, iftrue1);
2949 
2950   // Check for immediate negative hit.  Happens roughly 11% of the time (which
2951   // is roughly 63% of the remaining cases).  Test to see if the loaded
2952   // check-offset points into the subklass display list or the 1-element
2953   // cache.  If it points to the display (and NOT the cache) and the display
2954   // missed then it&#39;s not a subtype.
2955   Node *cacheoff = gvn.intcon(cacheoff_con);
2956   IfNode *iff2 = gen_subtype_check_compare(*ctrl, chk_off, cacheoff, BoolTest::ne, PROB_LIKELY(0.63f), gvn, T_INT);
2957   r_not_subtype-&gt;init_req(1, gvn.transform(new IfTrueNode (iff2)));
2958   *ctrl = gvn.transform(new IfFalseNode(iff2));
2959 
2960   // Check for self.  Very rare to get here, but it is taken 1/3 the time.
2961   // No performance impact (too rare) but allows sharing of secondary arrays
2962   // which has some footprint reduction.
2963   IfNode *iff3 = gen_subtype_check_compare(*ctrl, subklass, superklass, BoolTest::eq, PROB_LIKELY(0.36f), gvn, T_ADDRESS);
2964   r_ok_subtype-&gt;init_req(2, gvn.transform(new IfTrueNode(iff3)));
2965   *ctrl = gvn.transform(new IfFalseNode(iff3));
2966 
2967   // -- Roads not taken here: --
2968   // We could also have chosen to perform the self-check at the beginning
2969   // of this code sequence, as the assembler does.  This would not pay off
2970   // the same way, since the optimizer, unlike the assembler, can perform
2971   // static type analysis to fold away many successful self-checks.
2972   // Non-foldable self checks work better here in second position, because
2973   // the initial primary superclass check subsumes a self-check for most
2974   // types.  An exception would be a secondary type like array-of-interface,
2975   // which does not appear in its own primary supertype display.
2976   // Finally, we could have chosen to move the self-check into the
2977   // PartialSubtypeCheckNode, and from there out-of-line in a platform
2978   // dependent manner.  But it is worthwhile to have the check here,
2979   // where it can be perhaps be optimized.  The cost in code space is
2980   // small (register compare, branch).
2981 
2982   // Now do a linear scan of the secondary super-klass array.  Again, no real
2983   // performance impact (too rare) but it&#39;s gotta be done.
2984   // Since the code is rarely used, there is no penalty for moving it
2985   // out of line, and it can only improve I-cache density.
2986   // The decision to inline or out-of-line this final check is platform
2987   // dependent, and is found in the AD file definition of PartialSubtypeCheck.
2988   Node* psc = gvn.transform(
2989     new PartialSubtypeCheckNode(*ctrl, subklass, superklass));
2990 
2991   IfNode *iff4 = gen_subtype_check_compare(*ctrl, psc, gvn.zerocon(T_OBJECT), BoolTest::ne, PROB_FAIR, gvn, T_ADDRESS);
2992   r_not_subtype-&gt;init_req(2, gvn.transform(new IfTrueNode (iff4)));
2993   r_ok_subtype -&gt;init_req(3, gvn.transform(new IfFalseNode(iff4)));
2994 
2995   // Return false path; set default control to true path.
2996   *ctrl = gvn.transform(r_ok_subtype);
2997   return gvn.transform(r_not_subtype);
2998 }
2999 
3000 Node* GraphKit::gen_subtype_check(Node* obj_or_subklass, Node* superklass) {
3001   const Type* sub_t = _gvn.type(obj_or_subklass);
3002   if (sub_t-&gt;isa_valuetype()) {
3003     obj_or_subklass = makecon(TypeKlassPtr::make(sub_t-&gt;value_klass()));
3004   }
3005   if (ExpandSubTypeCheckAtParseTime) {
3006     MergeMemNode* mem = merged_memory();
3007     Node* ctrl = control();
3008     Node* subklass = obj_or_subklass;
3009     if (!sub_t-&gt;isa_klassptr()) {
3010       subklass = load_object_klass(obj_or_subklass);
3011     }
3012     Node* n = Phase::gen_subtype_check(subklass, superklass, &amp;ctrl, mem, _gvn);
3013     set_control(ctrl);
3014     return n;
3015   }
3016 
3017   Node* check = _gvn.transform(new SubTypeCheckNode(C, obj_or_subklass, superklass));
3018   Node* bol = _gvn.transform(new BoolNode(check, BoolTest::eq));
3019   IfNode* iff = create_and_xform_if(control(), bol, PROB_STATIC_FREQUENT, COUNT_UNKNOWN);
3020   set_control(_gvn.transform(new IfTrueNode(iff)));
3021   return _gvn.transform(new IfFalseNode(iff));
3022 }
3023 
3024 // Profile-driven exact type check:
3025 Node* GraphKit::type_check_receiver(Node* receiver, ciKlass* klass,
3026                                     float prob,
3027                                     Node* *casted_receiver) {
3028   const TypeKlassPtr* tklass = TypeKlassPtr::make(klass);
3029   Node* recv_klass = load_object_klass(receiver);
3030   Node* fail = type_check(recv_klass, tklass, prob);
3031   const TypeOopPtr* recv_xtype = tklass-&gt;as_instance_type();
3032   assert(recv_xtype-&gt;klass_is_exact(), &quot;&quot;);
3033 
3034   // Subsume downstream occurrences of receiver with a cast to
3035   // recv_xtype, since now we know what the type will be.
3036   Node* cast = new CheckCastPPNode(control(), receiver, recv_xtype);
3037   Node* res = _gvn.transform(cast);
3038   if (recv_xtype-&gt;is_valuetypeptr() &amp;&amp; recv_xtype-&gt;value_klass()-&gt;is_scalarizable()) {
3039     assert(!gvn().type(res)-&gt;maybe_null(), &quot;receiver should never be null&quot;);
3040     res = ValueTypeNode::make_from_oop(this, res, recv_xtype-&gt;value_klass());
3041   }
3042 
3043   (*casted_receiver) = res;
3044   // (User must make the replace_in_map call.)
3045 
3046   return fail;
3047 }
3048 
3049 Node* GraphKit::type_check(Node* recv_klass, const TypeKlassPtr* tklass,
3050                            float prob) {
3051   Node* want_klass = makecon(tklass);
3052   Node* cmp = _gvn.transform( new CmpPNode(recv_klass, want_klass));
3053   Node* bol = _gvn.transform( new BoolNode(cmp, BoolTest::eq) );
3054   IfNode* iff = create_and_xform_if(control(), bol, prob, COUNT_UNKNOWN);
3055   set_control(  _gvn.transform( new IfTrueNode (iff)));
3056   Node* fail = _gvn.transform( new IfFalseNode(iff));
3057   return fail;
3058 }
3059 
3060 //------------------------------subtype_check_receiver-------------------------
3061 Node* GraphKit::subtype_check_receiver(Node* receiver, ciKlass* klass,
3062                                        Node** casted_receiver) {
3063   const TypeKlassPtr* tklass = TypeKlassPtr::make(klass);
3064   Node* want_klass = makecon(tklass);
3065 
3066   Node* slow_ctl = gen_subtype_check(receiver, want_klass);
3067 
3068   // Cast receiver after successful check
3069   const TypeOopPtr* recv_type = tklass-&gt;cast_to_exactness(false)-&gt;is_klassptr()-&gt;as_instance_type();
3070   Node* cast = new CheckCastPPNode(control(), receiver, recv_type);
3071   (*casted_receiver) = _gvn.transform(cast);
3072 
3073   return slow_ctl;
3074 }
3075 
3076 //------------------------------seems_never_null-------------------------------
3077 // Use null_seen information if it is available from the profile.
3078 // If we see an unexpected null at a type check we record it and force a
3079 // recompile; the offending check will be recompiled to handle NULLs.
3080 // If we see several offending BCIs, then all checks in the
3081 // method will be recompiled.
3082 bool GraphKit::seems_never_null(Node* obj, ciProfileData* data, bool&amp; speculating) {
3083   speculating = !_gvn.type(obj)-&gt;speculative_maybe_null();
3084   Deoptimization::DeoptReason reason = Deoptimization::reason_null_check(speculating);
3085   if (UncommonNullCast               // Cutout for this technique
3086       &amp;&amp; obj != null()               // And not the -Xcomp stupid case?
3087       &amp;&amp; !too_many_traps(reason)
3088       ) {
3089     if (speculating) {
3090       return true;
3091     }
3092     if (data == NULL)
3093       // Edge case:  no mature data.  Be optimistic here.
3094       return true;
3095     // If the profile has not seen a null, assume it won&#39;t happen.
3096     assert(java_bc() == Bytecodes::_checkcast ||
3097            java_bc() == Bytecodes::_instanceof ||
3098            java_bc() == Bytecodes::_aastore, &quot;MDO must collect null_seen bit here&quot;);
3099     if (java_bc() == Bytecodes::_aastore) {
3100       return ((ciArrayLoadStoreData*)data-&gt;as_ArrayLoadStoreData())-&gt;element()-&gt;ptr_kind() == ProfileNeverNull;
3101     }
3102     return !data-&gt;as_BitData()-&gt;null_seen();
3103   }
3104   speculating = false;
3105   return false;
3106 }
3107 
3108 void GraphKit::guard_klass_being_initialized(Node* klass) {
3109   int init_state_off = in_bytes(InstanceKlass::init_state_offset());
3110   Node* adr = basic_plus_adr(top(), klass, init_state_off);
3111   Node* init_state = LoadNode::make(_gvn, NULL, immutable_memory(), adr,
3112                                     adr-&gt;bottom_type()-&gt;is_ptr(), TypeInt::BYTE,
3113                                     T_BYTE, MemNode::unordered);
3114   init_state = _gvn.transform(init_state);
3115 
3116   Node* being_initialized_state = makecon(TypeInt::make(InstanceKlass::being_initialized));
3117 
3118   Node* chk = _gvn.transform(new CmpINode(being_initialized_state, init_state));
3119   Node* tst = _gvn.transform(new BoolNode(chk, BoolTest::eq));
3120 
3121   { BuildCutout unless(this, tst, PROB_MAX);
3122     uncommon_trap(Deoptimization::Reason_initialized, Deoptimization::Action_reinterpret);
3123   }
3124 }
3125 
3126 void GraphKit::guard_init_thread(Node* klass) {
3127   int init_thread_off = in_bytes(InstanceKlass::init_thread_offset());
3128   Node* adr = basic_plus_adr(top(), klass, init_thread_off);
3129 
3130   Node* init_thread = LoadNode::make(_gvn, NULL, immutable_memory(), adr,
3131                                      adr-&gt;bottom_type()-&gt;is_ptr(), TypePtr::NOTNULL,
3132                                      T_ADDRESS, MemNode::unordered);
3133   init_thread = _gvn.transform(init_thread);
3134 
3135   Node* cur_thread = _gvn.transform(new ThreadLocalNode());
3136 
3137   Node* chk = _gvn.transform(new CmpPNode(cur_thread, init_thread));
3138   Node* tst = _gvn.transform(new BoolNode(chk, BoolTest::eq));
3139 
3140   { BuildCutout unless(this, tst, PROB_MAX);
3141     uncommon_trap(Deoptimization::Reason_uninitialized, Deoptimization::Action_none);
3142   }
3143 }
3144 
3145 void GraphKit::clinit_barrier(ciInstanceKlass* ik, ciMethod* context) {
3146   if (ik-&gt;is_being_initialized()) {
3147     if (C-&gt;needs_clinit_barrier(ik, context)) {
3148       Node* klass = makecon(TypeKlassPtr::make(ik));
3149       guard_klass_being_initialized(klass);
3150       guard_init_thread(klass);
3151       insert_mem_bar(Op_MemBarCPUOrder);
3152     }
3153   } else if (ik-&gt;is_initialized()) {
3154     return; // no barrier needed
3155   } else {
3156     uncommon_trap(Deoptimization::Reason_uninitialized,
3157                   Deoptimization::Action_reinterpret,
3158                   NULL);
3159   }
3160 }
3161 
3162 //------------------------maybe_cast_profiled_receiver-------------------------
3163 // If the profile has seen exactly one type, narrow to exactly that type.
3164 // Subsequent type checks will always fold up.
3165 Node* GraphKit::maybe_cast_profiled_receiver(Node* not_null_obj,
3166                                              ciKlass* require_klass,
3167                                              ciKlass* spec_klass,
3168                                              bool safe_for_replace) {
3169   if (!UseTypeProfile || !TypeProfileCasts) return NULL;
3170 
3171   Deoptimization::DeoptReason reason = Deoptimization::reason_class_check(spec_klass != NULL);
3172 
3173   // Make sure we haven&#39;t already deoptimized from this tactic.
3174   if (too_many_traps_or_recompiles(reason))
3175     return NULL;
3176 
3177   // (No, this isn&#39;t a call, but it&#39;s enough like a virtual call
3178   // to use the same ciMethod accessor to get the profile info...)
3179   // If we have a speculative type use it instead of profiling (which
3180   // may not help us)
3181   ciKlass* exact_kls = spec_klass;
3182   if (exact_kls == NULL) {
3183     if (java_bc() == Bytecodes::_aastore) {
3184       ciKlass* array_type = NULL;
3185       ciKlass* element_type = NULL;
3186       ProfilePtrKind element_ptr = ProfileMaybeNull;
3187       bool flat_array = true;
3188       bool null_free_array = true;
3189       method()-&gt;array_access_profiled_type(bci(), array_type, element_type, element_ptr, flat_array, null_free_array);
3190       exact_kls = element_type;
3191     } else {
3192       exact_kls = profile_has_unique_klass();
3193     }
3194   }
3195   if (exact_kls != NULL) {// no cast failures here
3196     if (require_klass == NULL ||
3197         C-&gt;static_subtype_check(require_klass, exact_kls) == Compile::SSC_always_true) {
3198       // If we narrow the type to match what the type profile sees or
3199       // the speculative type, we can then remove the rest of the
3200       // cast.
3201       // This is a win, even if the exact_kls is very specific,
3202       // because downstream operations, such as method calls,
3203       // will often benefit from the sharper type.
3204       Node* exact_obj = not_null_obj; // will get updated in place...
3205       Node* slow_ctl  = type_check_receiver(exact_obj, exact_kls, 1.0,
3206                                             &amp;exact_obj);
3207       { PreserveJVMState pjvms(this);
3208         set_control(slow_ctl);
3209         uncommon_trap_exact(reason, Deoptimization::Action_maybe_recompile);
3210       }
3211       if (safe_for_replace) {
3212         replace_in_map(not_null_obj, exact_obj);
3213       }
3214       return exact_obj;
3215     }
3216     // assert(ssc == Compile::SSC_always_true)... except maybe the profile lied to us.
3217   }
3218 
3219   return NULL;
3220 }
3221 
3222 /**
3223  * Cast obj to type and emit guard unless we had too many traps here
3224  * already
3225  *
3226  * @param obj       node being casted
3227  * @param type      type to cast the node to
3228  * @param not_null  true if we know node cannot be null
3229  */
3230 Node* GraphKit::maybe_cast_profiled_obj(Node* obj,
3231                                         ciKlass* type,
3232                                         bool not_null) {
3233   if (stopped()) {
3234     return obj;
3235   }
3236 
3237   // type == NULL if profiling tells us this object is always null
3238   if (type != NULL) {
3239     Deoptimization::DeoptReason class_reason = Deoptimization::Reason_speculate_class_check;
3240     Deoptimization::DeoptReason null_reason = Deoptimization::Reason_speculate_null_check;
3241 
3242     if (!too_many_traps_or_recompiles(null_reason) &amp;&amp;
3243         !too_many_traps_or_recompiles(class_reason)) {
3244       Node* not_null_obj = NULL;
3245       // not_null is true if we know the object is not null and
3246       // there&#39;s no need for a null check
3247       if (!not_null) {
3248         Node* null_ctl = top();
3249         not_null_obj = null_check_oop(obj, &amp;null_ctl, true, true, true);
3250         assert(null_ctl-&gt;is_top(), &quot;no null control here&quot;);
3251       } else {
3252         not_null_obj = obj;
3253       }
3254 
3255       Node* exact_obj = not_null_obj;
3256       ciKlass* exact_kls = type;
3257       Node* slow_ctl  = type_check_receiver(exact_obj, exact_kls, 1.0,
3258                                             &amp;exact_obj);
3259       {
3260         PreserveJVMState pjvms(this);
3261         set_control(slow_ctl);
3262         uncommon_trap_exact(class_reason, Deoptimization::Action_maybe_recompile);
3263       }
3264       replace_in_map(not_null_obj, exact_obj);
3265       obj = exact_obj;
3266     }
3267   } else {
3268     if (!too_many_traps_or_recompiles(Deoptimization::Reason_null_assert)) {
3269       Node* exact_obj = null_assert(obj);
3270       replace_in_map(obj, exact_obj);
3271       obj = exact_obj;
3272     }
3273   }
3274   return obj;
3275 }
3276 
3277 //-------------------------------gen_instanceof--------------------------------
3278 // Generate an instance-of idiom.  Used by both the instance-of bytecode
3279 // and the reflective instance-of call.
3280 Node* GraphKit::gen_instanceof(Node* obj, Node* superklass, bool safe_for_replace) {
3281   kill_dead_locals();           // Benefit all the uncommon traps
3282   assert( !stopped(), &quot;dead parse path should be checked in callers&quot; );
3283   assert(!TypePtr::NULL_PTR-&gt;higher_equal(_gvn.type(superklass)-&gt;is_klassptr()),
3284          &quot;must check for not-null not-dead klass in callers&quot;);
3285 
3286   // Make the merge point
3287   enum { _obj_path = 1, _fail_path, _null_path, PATH_LIMIT };
3288   RegionNode* region = new RegionNode(PATH_LIMIT);
3289   Node*       phi    = new PhiNode(region, TypeInt::BOOL);
3290   C-&gt;set_has_split_ifs(true); // Has chance for split-if optimization
3291 
3292   ciProfileData* data = NULL;
3293   if (java_bc() == Bytecodes::_instanceof) {  // Only for the bytecode
3294     data = method()-&gt;method_data()-&gt;bci_to_data(bci());
3295   }
3296   bool speculative_not_null = false;
3297   bool never_see_null = (ProfileDynamicTypes  // aggressive use of profile
3298                          &amp;&amp; seems_never_null(obj, data, speculative_not_null));
3299   bool is_value = obj-&gt;is_ValueType();
3300 
3301   // Null check; get casted pointer; set region slot 3
3302   Node* null_ctl = top();
3303   Node* not_null_obj = is_value ? obj : null_check_oop(obj, &amp;null_ctl, never_see_null, safe_for_replace, speculative_not_null);
3304 
3305   // If not_null_obj is dead, only null-path is taken
3306   if (stopped()) {              // Doing instance-of on a NULL?
3307     set_control(null_ctl);
3308     return intcon(0);
3309   }
3310   region-&gt;init_req(_null_path, null_ctl);
3311   phi   -&gt;init_req(_null_path, intcon(0)); // Set null path value
3312   if (null_ctl == top()) {
3313     // Do this eagerly, so that pattern matches like is_diamond_phi
3314     // will work even during parsing.
3315     assert(_null_path == PATH_LIMIT-1, &quot;delete last&quot;);
3316     region-&gt;del_req(_null_path);
3317     phi   -&gt;del_req(_null_path);
3318   }
3319 
3320   // Do we know the type check always succeed?
3321   if (!is_value) {
3322     bool known_statically = false;
3323     if (_gvn.type(superklass)-&gt;singleton()) {
3324       ciKlass* superk = _gvn.type(superklass)-&gt;is_klassptr()-&gt;klass();
3325       ciKlass* subk = _gvn.type(obj)-&gt;is_oopptr()-&gt;klass();
3326       if (subk != NULL &amp;&amp; subk-&gt;is_loaded()) {
3327         int static_res = C-&gt;static_subtype_check(superk, subk);
3328         known_statically = (static_res == Compile::SSC_always_true || static_res == Compile::SSC_always_false);
3329       }
3330     }
3331 
3332     if (!known_statically) {
3333       const TypeOopPtr* obj_type = _gvn.type(obj)-&gt;is_oopptr();
3334       // We may not have profiling here or it may not help us. If we
3335       // have a speculative type use it to perform an exact cast.
3336       ciKlass* spec_obj_type = obj_type-&gt;speculative_type();
3337       if (spec_obj_type != NULL || (ProfileDynamicTypes &amp;&amp; data != NULL)) {
3338         Node* cast_obj = maybe_cast_profiled_receiver(not_null_obj, NULL, spec_obj_type, safe_for_replace);
3339         if (stopped()) {            // Profile disagrees with this path.
3340           set_control(null_ctl);    // Null is the only remaining possibility.
3341           return intcon(0);
3342         }
3343         if (cast_obj != NULL &amp;&amp;
3344             // A value that&#39;s sometimes null is not something we can optimize well
3345             !(cast_obj-&gt;is_ValueType() &amp;&amp; null_ctl != top())) {
3346           not_null_obj = cast_obj;
3347           is_value = not_null_obj-&gt;is_ValueType();
3348         }
3349       }
3350     }
3351   }
3352 
3353   // Generate the subtype check
3354   Node* not_subtype_ctrl = gen_subtype_check(not_null_obj, superklass);
3355 
3356   // Plug in the success path to the general merge in slot 1.
3357   region-&gt;init_req(_obj_path, control());
3358   phi   -&gt;init_req(_obj_path, intcon(1));
3359 
3360   // Plug in the failing path to the general merge in slot 2.
3361   region-&gt;init_req(_fail_path, not_subtype_ctrl);
3362   phi   -&gt;init_req(_fail_path, intcon(0));
3363 
3364   // Return final merged results
3365   set_control( _gvn.transform(region) );
3366   record_for_igvn(region);
3367 
3368   // If we know the type check always succeeds then we don&#39;t use the
3369   // profiling data at this bytecode. Don&#39;t lose it, feed it to the
3370   // type system as a speculative type.
3371   if (safe_for_replace &amp;&amp; !is_value) {
3372     Node* casted_obj = record_profiled_receiver_for_speculation(obj);
3373     replace_in_map(obj, casted_obj);
3374   }
3375 
3376   return _gvn.transform(phi);
3377 }
3378 
3379 //-------------------------------gen_checkcast---------------------------------
3380 // Generate a checkcast idiom.  Used by both the checkcast bytecode and the
3381 // array store bytecode.  Stack must be as-if BEFORE doing the bytecode so the
3382 // uncommon-trap paths work.  Adjust stack after this call.
3383 // If failure_control is supplied and not null, it is filled in with
3384 // the control edge for the cast failure.  Otherwise, an appropriate
3385 // uncommon trap or exception is thrown.
3386 Node* GraphKit::gen_checkcast(Node *obj, Node* superklass, Node* *failure_control, bool never_null) {
3387   kill_dead_locals();           // Benefit all the uncommon traps
3388   const TypeKlassPtr* tk = _gvn.type(superklass)-&gt;is_klassptr();
3389   const TypeOopPtr* toop = TypeOopPtr::make_from_klass(tk-&gt;klass());
3390   assert(!never_null || toop-&gt;is_valuetypeptr(), &quot;must be a value type pointer&quot;);
3391   bool is_value = obj-&gt;is_ValueType();
3392 
3393   // Fast cutout:  Check the case that the cast is vacuously true.
3394   // This detects the common cases where the test will short-circuit
3395   // away completely.  We do this before we perform the null check,
3396   // because if the test is going to turn into zero code, we don&#39;t
3397   // want a residual null check left around.  (Causes a slowdown,
3398   // for example, in some objArray manipulations, such as a[i]=a[j].)
3399   if (tk-&gt;singleton()) {
3400     ciKlass* klass = NULL;
3401     if (is_value) {
3402       klass = _gvn.type(obj)-&gt;value_klass();
3403     } else {
3404       const TypeOopPtr* objtp = _gvn.type(obj)-&gt;isa_oopptr();
3405       if (objtp != NULL) {
3406         klass = objtp-&gt;klass();
3407       }
3408     }
3409     if (klass != NULL) {
3410       switch (C-&gt;static_subtype_check(tk-&gt;klass(), klass)) {
3411       case Compile::SSC_always_true:
3412         // If we know the type check always succeed then we don&#39;t use
3413         // the profiling data at this bytecode. Don&#39;t lose it, feed it
3414         // to the type system as a speculative type.
3415         if (!is_value) {
3416           obj = record_profiled_receiver_for_speculation(obj);
3417           if (never_null) {
3418             obj = null_check(obj);
3419           }
3420           if (toop-&gt;is_valuetypeptr() &amp;&amp; toop-&gt;value_klass()-&gt;is_scalarizable() &amp;&amp; !gvn().type(obj)-&gt;maybe_null()) {
3421             obj = ValueTypeNode::make_from_oop(this, obj, toop-&gt;value_klass());
3422           }
3423         }
3424         return obj;
3425       case Compile::SSC_always_false:
3426         if (is_value || never_null) {
3427           if (!is_value) {
3428             null_check(obj);
3429           }
3430           // Value type is never null. Always throw an exception.
3431           builtin_throw(Deoptimization::Reason_class_check, makecon(TypeKlassPtr::make(klass)));
3432           return top();
3433         } else {
3434           // It needs a null check because a null will *pass* the cast check.
3435           return null_assert(obj);
3436         }
3437       }
3438     }
3439   }
3440 
3441   ciProfileData* data = NULL;
3442   bool safe_for_replace = false;
3443   if (failure_control == NULL) {        // use MDO in regular case only
3444     assert(java_bc() == Bytecodes::_aastore ||
3445            java_bc() == Bytecodes::_checkcast,
3446            &quot;interpreter profiles type checks only for these BCs&quot;);
3447     if (method()-&gt;method_data()-&gt;is_mature()) {
3448       data = method()-&gt;method_data()-&gt;bci_to_data(bci());
3449     }
3450     safe_for_replace = true;
3451   }
3452 
3453   // Make the merge point
3454   enum { _obj_path = 1, _null_path, PATH_LIMIT };
3455   RegionNode* region = new RegionNode(PATH_LIMIT);
3456   Node*       phi    = new PhiNode(region, toop);
3457   _gvn.set_type(region, Type::CONTROL);
3458   _gvn.set_type(phi, toop);
3459 
3460   C-&gt;set_has_split_ifs(true); // Has chance for split-if optimization
3461 
3462   // Use null-cast information if it is available
3463   bool speculative_not_null = false;
3464   bool never_see_null = ((failure_control == NULL)  // regular case only
3465                          &amp;&amp; seems_never_null(obj, data, speculative_not_null));
3466 
3467   // Null check; get casted pointer; set region slot 3
3468   Node* null_ctl = top();
3469   Node* not_null_obj = NULL;
3470   if (is_value) {
3471     not_null_obj = obj;
3472   } else if (never_null) {
3473     not_null_obj = null_check(obj);
3474   } else {
3475     not_null_obj = null_check_oop(obj, &amp;null_ctl, never_see_null, safe_for_replace, speculative_not_null);
3476   }
3477 
3478   // If not_null_obj is dead, only null-path is taken
3479   if (stopped()) {              // Doing instance-of on a NULL?
3480     set_control(null_ctl);
3481     return null();
3482   }
3483   region-&gt;init_req(_null_path, null_ctl);
3484   phi   -&gt;init_req(_null_path, null());  // Set null path value
3485   if (null_ctl == top()) {
3486     // Do this eagerly, so that pattern matches like is_diamond_phi
3487     // will work even during parsing.
3488     assert(_null_path == PATH_LIMIT-1, &quot;delete last&quot;);
3489     region-&gt;del_req(_null_path);
3490     phi   -&gt;del_req(_null_path);
3491   }
3492 
3493   Node* cast_obj = NULL;
3494   if (!is_value &amp;&amp; tk-&gt;klass_is_exact()) {
3495     // The following optimization tries to statically cast the speculative type of the object
3496     // (for example obtained during profiling) to the type of the superklass and then do a
3497     // dynamic check that the type of the object is what we expect. To work correctly
3498     // for checkcast and aastore the type of superklass should be exact.
3499     const TypeOopPtr* obj_type = _gvn.type(obj)-&gt;is_oopptr();
3500     // We may not have profiling here or it may not help us. If we have
3501     // a speculative type use it to perform an exact cast.
3502     ciKlass* spec_obj_type = obj_type-&gt;speculative_type();
3503     if (spec_obj_type != NULL || data != NULL) {
3504       cast_obj = maybe_cast_profiled_receiver(not_null_obj, tk-&gt;klass(), spec_obj_type, safe_for_replace);
3505       if (cast_obj != NULL &amp;&amp; cast_obj-&gt;is_ValueType()) {
3506         if (null_ctl != top()) {
3507           cast_obj = NULL; // A value that&#39;s sometimes null is not something we can optimize well
3508         } else {
3509           return cast_obj;
3510         }
3511       }
3512       if (cast_obj != NULL) {
3513         if (failure_control != NULL) // failure is now impossible
3514           (*failure_control) = top();
3515         // adjust the type of the phi to the exact klass:
3516         phi-&gt;raise_bottom_type(_gvn.type(cast_obj)-&gt;meet_speculative(TypePtr::NULL_PTR));
3517       }
3518     }
3519   }
3520 
3521   if (cast_obj == NULL) {
3522     // Generate the subtype check
3523     Node* not_subtype_ctrl = gen_subtype_check(not_null_obj, superklass);
3524 
3525     // Plug in success path into the merge
3526     cast_obj = is_value ? not_null_obj : _gvn.transform(new CheckCastPPNode(control(), not_null_obj, toop));
3527     // Failure path ends in uncommon trap (or may be dead - failure impossible)
3528     if (failure_control == NULL) {
3529       if (not_subtype_ctrl != top()) { // If failure is possible
3530         PreserveJVMState pjvms(this);
3531         set_control(not_subtype_ctrl);
3532         Node* obj_klass = NULL;
3533         if (is_value) {
3534           obj_klass = makecon(TypeKlassPtr::make(_gvn.type(not_null_obj)-&gt;value_klass()));
3535         } else {
3536           obj_klass = load_object_klass(not_null_obj);
3537         }
3538         builtin_throw(Deoptimization::Reason_class_check, obj_klass);
3539       }
3540     } else {
3541       (*failure_control) = not_subtype_ctrl;
3542     }
3543   }
3544 
3545   region-&gt;init_req(_obj_path, control());
3546   phi   -&gt;init_req(_obj_path, cast_obj);
3547 
3548   // A merge of NULL or Casted-NotNull obj
3549   Node* res = _gvn.transform(phi);
3550 
3551   // Note I do NOT always &#39;replace_in_map(obj,result)&#39; here.
3552   //  if( tk-&gt;klass()-&gt;can_be_primary_super()  )
3553     // This means that if I successfully store an Object into an array-of-String
3554     // I &#39;forget&#39; that the Object is really now known to be a String.  I have to
3555     // do this because we don&#39;t have true union types for interfaces - if I store
3556     // a Baz into an array-of-Interface and then tell the optimizer it&#39;s an
3557     // Interface, I forget that it&#39;s also a Baz and cannot do Baz-like field
3558     // references to it.  FIX THIS WHEN UNION TYPES APPEAR!
3559   //  replace_in_map( obj, res );
3560 
3561   // Return final merged results
3562   set_control( _gvn.transform(region) );
3563   record_for_igvn(region);
3564 
3565   bool not_null_free = !toop-&gt;can_be_value_type();
3566   bool not_flattenable = !ValueArrayFlatten || not_null_free || (toop-&gt;is_valuetypeptr() &amp;&amp; !toop-&gt;value_klass()-&gt;flatten_array());
3567   if (EnableValhalla &amp;&amp; not_flattenable) {
3568     // Check if obj has been loaded from an array
3569     obj = obj-&gt;isa_DecodeN() ? obj-&gt;in(1) : obj;
3570     Node* array = NULL;
3571     if (obj-&gt;isa_Load()) {
3572       Node* address = obj-&gt;in(MemNode::Address);
3573       if (address-&gt;isa_AddP()) {
3574         array = address-&gt;as_AddP()-&gt;in(AddPNode::Base);
3575       }
3576     } else if (obj-&gt;is_Phi()) {
3577       Node* region = obj-&gt;in(0);
3578       if (region-&gt;req() == 3 &amp;&amp; region-&gt;in(1) != NULL &amp;&amp; region-&gt;in(1)-&gt;in(0) != NULL) {
3579         IfNode* iff = region-&gt;in(1)-&gt;in(0)-&gt;isa_If();
3580         if (iff != NULL) {
3581           iff-&gt;is_flattened_array_check(&amp;_gvn, array);
3582         }
3583       }
3584     }
3585     if (array != NULL) {
3586       const TypeAryPtr* ary_t = _gvn.type(array)-&gt;isa_aryptr();
3587       if (ary_t != NULL) {
3588         if (!ary_t-&gt;is_not_null_free() &amp;&amp; not_null_free) {
3589           // Casting array element to a non-inline-type, mark array as not null-free.
3590           Node* cast = _gvn.transform(new CheckCastPPNode(control(), array, ary_t-&gt;cast_to_not_null_free()));
3591           replace_in_map(array, cast);
3592         } else if (!ary_t-&gt;is_not_flat()) {
3593           // Casting array element to a non-flattenable type, mark array as not flat.
3594           Node* cast = _gvn.transform(new CheckCastPPNode(control(), array, ary_t-&gt;cast_to_not_flat()));
3595           replace_in_map(array, cast);
3596         }
3597       }
3598     }
3599   }
3600 
3601   if (!is_value) {
3602     res = record_profiled_receiver_for_speculation(res);
3603     if (toop-&gt;is_valuetypeptr() &amp;&amp; toop-&gt;value_klass()-&gt;is_scalarizable() &amp;&amp; !gvn().type(res)-&gt;maybe_null()) {
3604       res = ValueTypeNode::make_from_oop(this, res, toop-&gt;value_klass());
3605     }
3606   }
3607   return res;
3608 }
3609 
3610 Node* GraphKit::is_always_locked(Node* obj) {
3611   Node* mark_addr = basic_plus_adr(obj, oopDesc::mark_offset_in_bytes());
3612   Node* mark = make_load(NULL, mark_addr, TypeX_X, TypeX_X-&gt;basic_type(), MemNode::unordered);
3613   Node* mask = _gvn.MakeConX(markWord::always_locked_pattern);
3614   Node* andx = _gvn.transform(new AndXNode(mark, mask));
3615   Node* cmp = _gvn.transform(new CmpXNode(andx, mask));
3616   return _gvn.transform(new BoolNode(cmp, BoolTest::eq));
3617 }
3618 
3619 Node* GraphKit::is_value_mirror(Node* mirror) {
3620   Node* p = basic_plus_adr(mirror, java_lang_Class::inline_mirror_offset_in_bytes());
3621   Node* inline_mirror = access_load_at(mirror, p, _gvn.type(p)-&gt;is_ptr(), TypeInstPtr::MIRROR-&gt;cast_to_ptr_type(TypePtr::BotPTR), T_OBJECT, IN_HEAP);
3622   Node* cmp = _gvn.transform(new CmpPNode(mirror, inline_mirror));
3623   return _gvn.transform(new BoolNode(cmp, BoolTest::eq));
3624 }
3625 
3626 // Check if &#39;ary&#39; is a null-free value type array
3627 Node* GraphKit::gen_null_free_array_check(Node* ary) {
3628   assert(EnableValhalla, &quot;should only be used if value types are enabled&quot;);
3629   // Extract null free property from klass pointer
3630   Node* k_adr = basic_plus_adr(ary, oopDesc::klass_offset_in_bytes());
3631   const TypePtr* k_adr_type = k_adr-&gt;bottom_type()-&gt;isa_ptr();
3632   Node* klass = NULL;
3633   if (k_adr_type-&gt;is_ptr_to_narrowklass()) {
3634     klass = _gvn.transform(new LoadNKlassNode(NULL, immutable_memory(), k_adr, TypeInstPtr::KLASS, TypeKlassPtr::OBJECT-&gt;make_narrowklass(), MemNode::unordered, true));
3635   } else {
3636     klass = _gvn.transform(new LoadKlassNode(NULL, immutable_memory(), k_adr, TypeInstPtr::KLASS, TypeKlassPtr::OBJECT, MemNode::unordered, true));
3637   }
3638   Node* null_free = _gvn.transform(new GetNullFreePropertyNode(klass));
3639   Node* cmp = NULL;
3640   if (_gvn.type(klass)-&gt;isa_klassptr()) {
3641     cmp = _gvn.transform(new CmpLNode(null_free, zerocon(T_LONG)));
3642   } else {
3643     cmp = _gvn.transform(new CmpINode(null_free, zerocon(T_INT)));
3644   }
3645   return _gvn.transform(new BoolNode(cmp, BoolTest::eq));
3646 }
3647 
3648 Node* GraphKit::gen_flattened_array_test(Node* ary) {
3649   assert(EnableValhalla, &quot;should only be used if value types are enabled&quot;);
3650   // Extract flattened property from klass pointer
3651   Node* k_adr = basic_plus_adr(ary, oopDesc::klass_offset_in_bytes());
3652   const TypePtr* k_adr_type = k_adr-&gt;bottom_type()-&gt;isa_ptr();
3653   Node* klass = NULL;
3654   if (k_adr_type-&gt;is_ptr_to_narrowklass()) {
3655     klass = _gvn.transform(new LoadNKlassNode(NULL, immutable_memory(), k_adr, TypeInstPtr::KLASS, TypeKlassPtr::OBJECT-&gt;make_narrowklass(), MemNode::unordered, true));
3656   } else {
3657     klass = _gvn.transform(new LoadKlassNode(NULL, immutable_memory(), k_adr, TypeInstPtr::KLASS, TypeKlassPtr::OBJECT, MemNode::unordered, true));
3658   }
3659   return _gvn.transform(new GetFlattenedPropertyNode(klass));
3660 }
3661 
3662 // Deoptimize if &#39;ary&#39; is a null-free value type array and &#39;val&#39; is null
3663 Node* GraphKit::gen_value_array_null_guard(Node* ary, Node* val, int nargs, bool safe_for_replace) {
3664   const Type* val_t = _gvn.type(val);
3665   if (val-&gt;is_ValueType() || !TypePtr::NULL_PTR-&gt;higher_equal(val_t)) {
3666     return ary; // Never null
3667   }
3668   RegionNode* region = new RegionNode(3);
3669   Node* null_ctl = top();
3670   null_check_oop(val, &amp;null_ctl);
3671   if (null_ctl != top()) {
3672     PreserveJVMState pjvms(this);
3673     set_control(null_ctl);
3674     // Deoptimize if null-free array
3675     Node* bol = gen_null_free_array_check(ary);
3676     { BuildCutout unless(this, bol, PROB_MAX);
3677       inc_sp(nargs);
3678       uncommon_trap(Deoptimization::Reason_null_check,
3679                     Deoptimization::Action_none);
3680     }
3681     region-&gt;init_req(1, control());
3682   }
3683   region-&gt;init_req(2, control());
3684   set_control(_gvn.transform(region));
3685   record_for_igvn(region);
3686   const TypeAryPtr* ary_t = _gvn.type(ary)-&gt;is_aryptr();
3687   if (val_t == TypePtr::NULL_PTR &amp;&amp; !ary_t-&gt;is_not_null_free()) {
3688     // Since we were just successfully storing null, the array can&#39;t be null free.
3689     ary_t = ary_t-&gt;cast_to_not_null_free();
3690     Node* cast = _gvn.transform(new CheckCastPPNode(control(), ary, ary_t));
3691     if (safe_for_replace) {
3692       replace_in_map(ary, cast);
3693     }
3694     ary = cast;
3695   }
3696   return ary;
3697 }
3698 
3699 Node* GraphKit::load_lh_array_tag(Node* kls) {
3700   Node* lhp = basic_plus_adr(kls, in_bytes(Klass::layout_helper_offset()));
3701   Node* layout_val = _gvn.transform(LoadNode::make(_gvn, NULL, immutable_memory(), lhp, lhp-&gt;bottom_type()-&gt;is_ptr(), TypeInt::INT, T_INT, MemNode::unordered));
3702 
3703   return _gvn.transform(new RShiftINode(layout_val, intcon(Klass::_lh_array_tag_shift)));
3704 }
3705 
3706 
3707 Node* GraphKit::gen_lh_array_test(Node* kls, unsigned int lh_value) {
3708   Node* layout_val = load_lh_array_tag(kls);
3709   Node* cmp = _gvn.transform(new CmpINode(layout_val, intcon(lh_value)));
3710   return cmp;
3711 }
3712 
3713 
3714 //------------------------------next_monitor-----------------------------------
3715 // What number should be given to the next monitor?
3716 int GraphKit::next_monitor() {
3717   int current = jvms()-&gt;monitor_depth()* C-&gt;sync_stack_slots();
3718   int next = current + C-&gt;sync_stack_slots();
3719   // Keep the toplevel high water mark current:
3720   if (C-&gt;fixed_slots() &lt; next)  C-&gt;set_fixed_slots(next);
3721   return current;
3722 }
3723 
3724 //------------------------------insert_mem_bar---------------------------------
3725 // Memory barrier to avoid floating things around
3726 // The membar serves as a pinch point between both control and all memory slices.
3727 Node* GraphKit::insert_mem_bar(int opcode, Node* precedent) {
3728   MemBarNode* mb = MemBarNode::make(C, opcode, Compile::AliasIdxBot, precedent);
3729   mb-&gt;init_req(TypeFunc::Control, control());
3730   mb-&gt;init_req(TypeFunc::Memory,  reset_memory());
3731   Node* membar = _gvn.transform(mb);
3732   set_control(_gvn.transform(new ProjNode(membar, TypeFunc::Control)));
3733   set_all_memory_call(membar);
3734   return membar;
3735 }
3736 
3737 //-------------------------insert_mem_bar_volatile----------------------------
3738 // Memory barrier to avoid floating things around
3739 // The membar serves as a pinch point between both control and memory(alias_idx).
3740 // If you want to make a pinch point on all memory slices, do not use this
3741 // function (even with AliasIdxBot); use insert_mem_bar() instead.
3742 Node* GraphKit::insert_mem_bar_volatile(int opcode, int alias_idx, Node* precedent) {
3743   // When Parse::do_put_xxx updates a volatile field, it appends a series
3744   // of MemBarVolatile nodes, one for *each* volatile field alias category.
3745   // The first membar is on the same memory slice as the field store opcode.
3746   // This forces the membar to follow the store.  (Bug 6500685 broke this.)
3747   // All the other membars (for other volatile slices, including AliasIdxBot,
3748   // which stands for all unknown volatile slices) are control-dependent
3749   // on the first membar.  This prevents later volatile loads or stores
3750   // from sliding up past the just-emitted store.
3751 
3752   MemBarNode* mb = MemBarNode::make(C, opcode, alias_idx, precedent);
3753   mb-&gt;set_req(TypeFunc::Control,control());
3754   if (alias_idx == Compile::AliasIdxBot) {
3755     mb-&gt;set_req(TypeFunc::Memory, merged_memory()-&gt;base_memory());
3756   } else {
3757     assert(!(opcode == Op_Initialize &amp;&amp; alias_idx != Compile::AliasIdxRaw), &quot;fix caller&quot;);
3758     mb-&gt;set_req(TypeFunc::Memory, memory(alias_idx));
3759   }
3760   Node* membar = _gvn.transform(mb);
3761   set_control(_gvn.transform(new ProjNode(membar, TypeFunc::Control)));
3762   if (alias_idx == Compile::AliasIdxBot) {
3763     merged_memory()-&gt;set_base_memory(_gvn.transform(new ProjNode(membar, TypeFunc::Memory)));
3764   } else {
3765     set_memory(_gvn.transform(new ProjNode(membar, TypeFunc::Memory)),alias_idx);
3766   }
3767   return membar;
3768 }
3769 
3770 //------------------------------shared_lock------------------------------------
3771 // Emit locking code.
3772 FastLockNode* GraphKit::shared_lock(Node* obj) {
3773   // bci is either a monitorenter bc or InvocationEntryBci
3774   // %%% SynchronizationEntryBCI is redundant; use InvocationEntryBci in interfaces
3775   assert(SynchronizationEntryBCI == InvocationEntryBci, &quot;&quot;);
3776 
3777   if( !GenerateSynchronizationCode )
3778     return NULL;                // Not locking things?
3779 
3780   if (stopped())                // Dead monitor?
3781     return NULL;
3782 
3783   assert(dead_locals_are_killed(), &quot;should kill locals before sync. point&quot;);
3784 
3785   // Box the stack location
3786   Node* box = _gvn.transform(new BoxLockNode(next_monitor()));
3787   Node* mem = reset_memory();
3788 
3789   FastLockNode * flock = _gvn.transform(new FastLockNode(0, obj, box) )-&gt;as_FastLock();
3790   if (UseBiasedLocking &amp;&amp; PrintPreciseBiasedLockingStatistics) {
3791     // Create the counters for this fast lock.
3792     flock-&gt;create_lock_counter(sync_jvms()); // sync_jvms used to get current bci
3793   }
3794 
3795   // Create the rtm counters for this fast lock if needed.
3796   flock-&gt;create_rtm_lock_counter(sync_jvms()); // sync_jvms used to get current bci
3797 
3798   // Add monitor to debug info for the slow path.  If we block inside the
3799   // slow path and de-opt, we need the monitor hanging around
3800   map()-&gt;push_monitor( flock );
3801 
3802   const TypeFunc *tf = LockNode::lock_type();
3803   LockNode *lock = new LockNode(C, tf);
3804 
3805   lock-&gt;init_req( TypeFunc::Control, control() );
3806   lock-&gt;init_req( TypeFunc::Memory , mem );
3807   lock-&gt;init_req( TypeFunc::I_O    , top() )     ;   // does no i/o
3808   lock-&gt;init_req( TypeFunc::FramePtr, frameptr() );
3809   lock-&gt;init_req( TypeFunc::ReturnAdr, top() );
3810 
3811   lock-&gt;init_req(TypeFunc::Parms + 0, obj);
3812   lock-&gt;init_req(TypeFunc::Parms + 1, box);
3813   lock-&gt;init_req(TypeFunc::Parms + 2, flock);
3814   add_safepoint_edges(lock);
3815 
3816   lock = _gvn.transform( lock )-&gt;as_Lock();
3817 
3818   // lock has no side-effects, sets few values
3819   set_predefined_output_for_runtime_call(lock, mem, TypeRawPtr::BOTTOM);
3820 
3821   insert_mem_bar(Op_MemBarAcquireLock);
3822 
3823   // Add this to the worklist so that the lock can be eliminated
3824   record_for_igvn(lock);
3825 
3826 #ifndef PRODUCT
3827   if (PrintLockStatistics) {
3828     // Update the counter for this lock.  Don&#39;t bother using an atomic
3829     // operation since we don&#39;t require absolute accuracy.
3830     lock-&gt;create_lock_counter(map()-&gt;jvms());
3831     increment_counter(lock-&gt;counter()-&gt;addr());
3832   }
3833 #endif
3834 
3835   return flock;
3836 }
3837 
3838 
3839 //------------------------------shared_unlock----------------------------------
3840 // Emit unlocking code.
3841 void GraphKit::shared_unlock(Node* box, Node* obj) {
3842   // bci is either a monitorenter bc or InvocationEntryBci
3843   // %%% SynchronizationEntryBCI is redundant; use InvocationEntryBci in interfaces
3844   assert(SynchronizationEntryBCI == InvocationEntryBci, &quot;&quot;);
3845 
3846   if( !GenerateSynchronizationCode )
3847     return;
3848   if (stopped()) {               // Dead monitor?
3849     map()-&gt;pop_monitor();        // Kill monitor from debug info
3850     return;
3851   }
3852   assert(!obj-&gt;is_ValueTypeBase(), &quot;should not unlock on value type&quot;);
3853 
3854   // Memory barrier to avoid floating things down past the locked region
3855   insert_mem_bar(Op_MemBarReleaseLock);
3856 
3857   const TypeFunc *tf = OptoRuntime::complete_monitor_exit_Type();
3858   UnlockNode *unlock = new UnlockNode(C, tf);
3859 #ifdef ASSERT
3860   unlock-&gt;set_dbg_jvms(sync_jvms());
3861 #endif
3862   uint raw_idx = Compile::AliasIdxRaw;
3863   unlock-&gt;init_req( TypeFunc::Control, control() );
3864   unlock-&gt;init_req( TypeFunc::Memory , memory(raw_idx) );
3865   unlock-&gt;init_req( TypeFunc::I_O    , top() )     ;   // does no i/o
3866   unlock-&gt;init_req( TypeFunc::FramePtr, frameptr() );
3867   unlock-&gt;init_req( TypeFunc::ReturnAdr, top() );
3868 
3869   unlock-&gt;init_req(TypeFunc::Parms + 0, obj);
3870   unlock-&gt;init_req(TypeFunc::Parms + 1, box);
3871   unlock = _gvn.transform(unlock)-&gt;as_Unlock();
3872 
3873   Node* mem = reset_memory();
3874 
3875   // unlock has no side-effects, sets few values
3876   set_predefined_output_for_runtime_call(unlock, mem, TypeRawPtr::BOTTOM);
3877 
3878   // Kill monitor from debug info
3879   map()-&gt;pop_monitor( );
3880 }
3881 
3882 //-------------------------------get_layout_helper-----------------------------
3883 // If the given klass is a constant or known to be an array,
3884 // fetch the constant layout helper value into constant_value
3885 // and return (Node*)NULL.  Otherwise, load the non-constant
3886 // layout helper value, and return the node which represents it.
3887 // This two-faced routine is useful because allocation sites
3888 // almost always feature constant types.
3889 Node* GraphKit::get_layout_helper(Node* klass_node, jint&amp; constant_value) {
3890   const TypeKlassPtr* inst_klass = _gvn.type(klass_node)-&gt;isa_klassptr();
3891   if (!StressReflectiveCode &amp;&amp; inst_klass != NULL) {
3892     ciKlass* klass = inst_klass-&gt;klass();
3893     assert(klass != NULL, &quot;klass should not be NULL&quot;);
3894     bool    xklass = inst_klass-&gt;klass_is_exact();
3895     bool can_be_flattened = false;
3896     if (ValueArrayFlatten &amp;&amp; klass-&gt;is_obj_array_klass()) {
3897       ciKlass* elem = klass-&gt;as_obj_array_klass()-&gt;element_klass();
3898       can_be_flattened = elem-&gt;is_java_lang_Object() || elem-&gt;is_interface() || (elem-&gt;is_valuetype() &amp;&amp; !klass-&gt;as_array_klass()-&gt;storage_properties().is_null_free());
3899     }
3900     if (xklass || (klass-&gt;is_array_klass() &amp;&amp; !can_be_flattened)) {
3901       jint lhelper = klass-&gt;layout_helper();
3902       if (lhelper != Klass::_lh_neutral_value) {
3903         constant_value = lhelper;
3904         return (Node*) NULL;
3905       }
3906     }
3907   }
3908   constant_value = Klass::_lh_neutral_value;  // put in a known value
3909   Node* lhp = basic_plus_adr(klass_node, klass_node, in_bytes(Klass::layout_helper_offset()));
3910   return make_load(NULL, lhp, TypeInt::INT, T_INT, MemNode::unordered);
3911 }
3912 
3913 // We just put in an allocate/initialize with a big raw-memory effect.
3914 // Hook selected additional alias categories on the initialization.
3915 static void hook_memory_on_init(GraphKit&amp; kit, int alias_idx,
3916                                 MergeMemNode* init_in_merge,
3917                                 Node* init_out_raw) {
3918   DEBUG_ONLY(Node* init_in_raw = init_in_merge-&gt;base_memory());
3919   assert(init_in_merge-&gt;memory_at(alias_idx) == init_in_raw, &quot;&quot;);
3920 
3921   Node* prevmem = kit.memory(alias_idx);
3922   init_in_merge-&gt;set_memory_at(alias_idx, prevmem);
3923   kit.set_memory(init_out_raw, alias_idx);
3924 }
3925 
3926 //---------------------------set_output_for_allocation-------------------------
3927 Node* GraphKit::set_output_for_allocation(AllocateNode* alloc,
3928                                           const TypeOopPtr* oop_type,
3929                                           bool deoptimize_on_exception) {
3930   int rawidx = Compile::AliasIdxRaw;
3931   alloc-&gt;set_req( TypeFunc::FramePtr, frameptr() );
3932   add_safepoint_edges(alloc);
3933   Node* allocx = _gvn.transform(alloc);
3934   set_control( _gvn.transform(new ProjNode(allocx, TypeFunc::Control) ) );
3935   // create memory projection for i_o
3936   set_memory ( _gvn.transform( new ProjNode(allocx, TypeFunc::Memory, true) ), rawidx );
3937   make_slow_call_ex(allocx, env()-&gt;Throwable_klass(), true, deoptimize_on_exception);
3938 
3939   // create a memory projection as for the normal control path
3940   Node* malloc = _gvn.transform(new ProjNode(allocx, TypeFunc::Memory));
3941   set_memory(malloc, rawidx);
3942 
3943   // a normal slow-call doesn&#39;t change i_o, but an allocation does
3944   // we create a separate i_o projection for the normal control path
3945   set_i_o(_gvn.transform( new ProjNode(allocx, TypeFunc::I_O, false) ) );
3946   Node* rawoop = _gvn.transform( new ProjNode(allocx, TypeFunc::Parms) );
3947 
3948   // put in an initialization barrier
3949   InitializeNode* init = insert_mem_bar_volatile(Op_Initialize, rawidx,
3950                                                  rawoop)-&gt;as_Initialize();
3951   assert(alloc-&gt;initialization() == init,  &quot;2-way macro link must work&quot;);
3952   assert(init -&gt;allocation()     == alloc, &quot;2-way macro link must work&quot;);
3953   {
3954     // Extract memory strands which may participate in the new object&#39;s
3955     // initialization, and source them from the new InitializeNode.
3956     // This will allow us to observe initializations when they occur,
3957     // and link them properly (as a group) to the InitializeNode.
3958     assert(init-&gt;in(InitializeNode::Memory) == malloc, &quot;&quot;);
3959     MergeMemNode* minit_in = MergeMemNode::make(malloc);
3960     init-&gt;set_req(InitializeNode::Memory, minit_in);
3961     record_for_igvn(minit_in); // fold it up later, if possible
3962     _gvn.set_type(minit_in, Type::MEMORY);
3963     Node* minit_out = memory(rawidx);
3964     assert(minit_out-&gt;is_Proj() &amp;&amp; minit_out-&gt;in(0) == init, &quot;&quot;);
3965     // Add an edge in the MergeMem for the header fields so an access
3966     // to one of those has correct memory state
3967     set_memory(minit_out, C-&gt;get_alias_index(oop_type-&gt;add_offset(oopDesc::mark_offset_in_bytes())));
3968     set_memory(minit_out, C-&gt;get_alias_index(oop_type-&gt;add_offset(oopDesc::klass_offset_in_bytes())));
3969     if (oop_type-&gt;isa_aryptr()) {
3970       const TypeAryPtr* arytype = oop_type-&gt;is_aryptr();
3971       if (arytype-&gt;klass()-&gt;is_value_array_klass()) {
3972         // Initially all flattened array accesses share a single slice
3973         // but that changes after parsing. Prepare the memory graph so
3974         // it can optimize flattened array accesses properly once they
3975         // don&#39;t share a single slice.
3976         assert(C-&gt;flattened_accesses_share_alias(), &quot;should be set at parse time&quot;);
3977         C-&gt;set_flattened_accesses_share_alias(false);
3978         ciValueArrayKlass* vak = arytype-&gt;klass()-&gt;as_value_array_klass();
3979         ciValueKlass* vk = vak-&gt;element_klass()-&gt;as_value_klass();
3980         for (int i = 0, len = vk-&gt;nof_nonstatic_fields(); i &lt; len; i++) {
3981           ciField* field = vk-&gt;nonstatic_field_at(i);
3982           if (field-&gt;offset() &gt;= TrackedInitializationLimit * HeapWordSize)
3983             continue;  // do not bother to track really large numbers of fields
3984           int off_in_vt = field-&gt;offset() - vk-&gt;first_field_offset();
3985           const TypePtr* adr_type = arytype-&gt;with_field_offset(off_in_vt)-&gt;add_offset(Type::OffsetBot);
3986           int fieldidx = C-&gt;get_alias_index(adr_type, true);
3987           hook_memory_on_init(*this, fieldidx, minit_in, minit_out);
3988         }
3989         C-&gt;set_flattened_accesses_share_alias(true);
3990         hook_memory_on_init(*this, C-&gt;get_alias_index(TypeAryPtr::VALUES), minit_in, minit_out);
3991       } else {
3992         const TypePtr* telemref = oop_type-&gt;add_offset(Type::OffsetBot);
3993         int            elemidx  = C-&gt;get_alias_index(telemref);
3994         hook_memory_on_init(*this, elemidx, minit_in, minit_out);
3995       }
3996     } else if (oop_type-&gt;isa_instptr()) {
3997       set_memory(minit_out, C-&gt;get_alias_index(oop_type)); // mark word
3998       ciInstanceKlass* ik = oop_type-&gt;klass()-&gt;as_instance_klass();
3999       for (int i = 0, len = ik-&gt;nof_nonstatic_fields(); i &lt; len; i++) {
4000         ciField* field = ik-&gt;nonstatic_field_at(i);
4001         if (field-&gt;offset() &gt;= TrackedInitializationLimit * HeapWordSize)
4002           continue;  // do not bother to track really large numbers of fields
4003         // Find (or create) the alias category for this field:
4004         int fieldidx = C-&gt;alias_type(field)-&gt;index();
4005         hook_memory_on_init(*this, fieldidx, minit_in, minit_out);
4006       }
4007     }
4008   }
4009 
4010   // Cast raw oop to the real thing...
4011   Node* javaoop = new CheckCastPPNode(control(), rawoop, oop_type);
4012   javaoop = _gvn.transform(javaoop);
4013   C-&gt;set_recent_alloc(control(), javaoop);
4014   assert(just_allocated_object(control()) == javaoop, &quot;just allocated&quot;);
4015 
4016 #ifdef ASSERT
4017   { // Verify that the AllocateNode::Ideal_allocation recognizers work:
4018     assert(AllocateNode::Ideal_allocation(rawoop, &amp;_gvn) == alloc,
4019            &quot;Ideal_allocation works&quot;);
4020     assert(AllocateNode::Ideal_allocation(javaoop, &amp;_gvn) == alloc,
4021            &quot;Ideal_allocation works&quot;);
4022     if (alloc-&gt;is_AllocateArray()) {
4023       assert(AllocateArrayNode::Ideal_array_allocation(rawoop, &amp;_gvn) == alloc-&gt;as_AllocateArray(),
4024              &quot;Ideal_allocation works&quot;);
4025       assert(AllocateArrayNode::Ideal_array_allocation(javaoop, &amp;_gvn) == alloc-&gt;as_AllocateArray(),
4026              &quot;Ideal_allocation works&quot;);
4027     } else {
4028       assert(alloc-&gt;in(AllocateNode::ALength)-&gt;is_top(), &quot;no length, please&quot;);
4029     }
4030   }
4031 #endif //ASSERT
4032 
4033   return javaoop;
4034 }
4035 
4036 //---------------------------new_instance--------------------------------------
4037 // This routine takes a klass_node which may be constant (for a static type)
4038 // or may be non-constant (for reflective code).  It will work equally well
4039 // for either, and the graph will fold nicely if the optimizer later reduces
4040 // the type to a constant.
4041 // The optional arguments are for specialized use by intrinsics:
4042 //  - If &#39;extra_slow_test&#39; if not null is an extra condition for the slow-path.
4043 //  - If &#39;return_size_val&#39;, report the the total object size to the caller.
4044 //  - deoptimize_on_exception controls how Java exceptions are handled (rethrow vs deoptimize)
4045 Node* GraphKit::new_instance(Node* klass_node,
4046                              Node* extra_slow_test,
4047                              Node* *return_size_val,
4048                              bool deoptimize_on_exception,
4049                              ValueTypeBaseNode* value_node) {
4050   // Compute size in doublewords
4051   // The size is always an integral number of doublewords, represented
4052   // as a positive bytewise size stored in the klass&#39;s layout_helper.
4053   // The layout_helper also encodes (in a low bit) the need for a slow path.
4054   jint  layout_con = Klass::_lh_neutral_value;
4055   Node* layout_val = get_layout_helper(klass_node, layout_con);
4056   bool  layout_is_con = (layout_val == NULL);
4057 
4058   if (extra_slow_test == NULL)  extra_slow_test = intcon(0);
4059   // Generate the initial go-slow test.  It&#39;s either ALWAYS (return a
4060   // Node for 1) or NEVER (return a NULL) or perhaps (in the reflective
4061   // case) a computed value derived from the layout_helper.
4062   Node* initial_slow_test = NULL;
4063   if (layout_is_con) {
4064     assert(!StressReflectiveCode, &quot;stress mode does not use these paths&quot;);
4065     bool must_go_slow = Klass::layout_helper_needs_slow_path(layout_con);
4066     initial_slow_test = must_go_slow ? intcon(1) : extra_slow_test;
4067   } else {   // reflective case
4068     // This reflective path is used by Unsafe.allocateInstance.
4069     // (It may be stress-tested by specifying StressReflectiveCode.)
4070     // Basically, we want to get into the VM is there&#39;s an illegal argument.
4071     Node* bit = intcon(Klass::_lh_instance_slow_path_bit);
4072     initial_slow_test = _gvn.transform( new AndINode(layout_val, bit) );
4073     if (extra_slow_test != intcon(0)) {
4074       initial_slow_test = _gvn.transform( new OrINode(initial_slow_test, extra_slow_test) );
4075     }
4076     // (Macro-expander will further convert this to a Bool, if necessary.)
4077   }
4078 
4079   // Find the size in bytes.  This is easy; it&#39;s the layout_helper.
4080   // The size value must be valid even if the slow path is taken.
4081   Node* size = NULL;
4082   if (layout_is_con) {
4083     size = MakeConX(Klass::layout_helper_size_in_bytes(layout_con));
4084   } else {   // reflective case
4085     // This reflective path is used by clone and Unsafe.allocateInstance.
4086     size = ConvI2X(layout_val);
4087 
4088     // Clear the low bits to extract layout_helper_size_in_bytes:
4089     assert((int)Klass::_lh_instance_slow_path_bit &lt; BytesPerLong, &quot;clear bit&quot;);
4090     Node* mask = MakeConX(~ (intptr_t)right_n_bits(LogBytesPerLong));
4091     size = _gvn.transform( new AndXNode(size, mask) );
4092   }
4093   if (return_size_val != NULL) {
4094     (*return_size_val) = size;
4095   }
4096 
4097   // This is a precise notnull oop of the klass.
4098   // (Actually, it need not be precise if this is a reflective allocation.)
4099   // It&#39;s what we cast the result to.
4100   const TypeKlassPtr* tklass = _gvn.type(klass_node)-&gt;isa_klassptr();
4101   if (!tklass)  tklass = TypeKlassPtr::OBJECT;
4102   const TypeOopPtr* oop_type = tklass-&gt;as_instance_type();
4103 
4104   // Now generate allocation code
4105 
4106   // The entire memory state is needed for slow path of the allocation
4107   // since GC and deoptimization can happen.
4108   Node *mem = reset_memory();
4109   set_all_memory(mem); // Create new memory state
4110 
4111   AllocateNode* alloc = new AllocateNode(C, AllocateNode::alloc_type(Type::TOP),
4112                                          control(), mem, i_o(),
4113                                          size, klass_node,
4114                                          initial_slow_test, value_node);
4115 
4116   return set_output_for_allocation(alloc, oop_type, deoptimize_on_exception);
4117 }
4118 
4119 // With compressed oops, the 64 bit init value for non flattened value
4120 // arrays is built from 2 32 bit compressed oops
4121 static Node* raw_default_for_coops(Node* default_value, GraphKit&amp; kit) {
4122   Node* lower = kit.gvn().transform(new CastP2XNode(kit.control(), default_value));
4123   Node* upper = kit.gvn().transform(new LShiftLNode(lower, kit.intcon(32)));
4124   return kit.gvn().transform(new OrLNode(lower, upper));
4125 }
4126 
4127 //-------------------------------new_array-------------------------------------
4128 // helper for newarray and anewarray
4129 // The &#39;length&#39; parameter is (obviously) the length of the array.
4130 // See comments on new_instance for the meaning of the other arguments.
4131 Node* GraphKit::new_array(Node* klass_node,     // array klass (maybe variable)
4132                           Node* length,         // number of array elements
4133                           int   nargs,          // number of arguments to push back for uncommon trap
4134                           Node* *return_size_val,
4135                           bool deoptimize_on_exception,
4136                           Node* elem_mirror) {
4137   jint  layout_con = Klass::_lh_neutral_value;
4138   Node* layout_val = get_layout_helper(klass_node, layout_con);
4139   bool  layout_is_con = (layout_val == NULL);
4140 
4141   if (!layout_is_con &amp;&amp; !StressReflectiveCode &amp;&amp;
4142       !too_many_traps(Deoptimization::Reason_class_check)) {
4143     // This is a reflective array creation site.
4144     // Optimistically assume that it is a subtype of Object[],
4145     // so that we can fold up all the address arithmetic.
4146     layout_con = Klass::array_layout_helper(T_OBJECT);
4147     Node* cmp_lh = _gvn.transform( new CmpINode(layout_val, intcon(layout_con)) );
4148     Node* bol_lh = _gvn.transform( new BoolNode(cmp_lh, BoolTest::eq) );
4149     { BuildCutout unless(this, bol_lh, PROB_MAX);
4150       inc_sp(nargs);
4151       uncommon_trap(Deoptimization::Reason_class_check,
4152                     Deoptimization::Action_maybe_recompile);
4153     }
4154     layout_val = NULL;
4155     layout_is_con = true;
4156   }
4157 
4158   // Generate the initial go-slow test.  Make sure we do not overflow
4159   // if length is huge (near 2Gig) or negative!  We do not need
4160   // exact double-words here, just a close approximation of needed
4161   // double-words.  We can&#39;t add any offset or rounding bits, lest we
4162   // take a size -1 of bytes and make it positive.  Use an unsigned
4163   // compare, so negative sizes look hugely positive.
4164   int fast_size_limit = FastAllocateSizeLimit;
4165   if (layout_is_con) {
4166     assert(!StressReflectiveCode, &quot;stress mode does not use these paths&quot;);
4167     // Increase the size limit if we have exact knowledge of array type.
4168     int log2_esize = Klass::layout_helper_log2_element_size(layout_con);
4169     fast_size_limit &lt;&lt;= MAX2(LogBytesPerLong - log2_esize, 0);
4170   }
4171 
4172   Node* initial_slow_cmp  = _gvn.transform( new CmpUNode( length, intcon( fast_size_limit ) ) );
4173   Node* initial_slow_test = _gvn.transform( new BoolNode( initial_slow_cmp, BoolTest::gt ) );
4174 
4175   // --- Size Computation ---
4176   // array_size = round_to_heap(array_header + (length &lt;&lt; elem_shift));
4177   // where round_to_heap(x) == align_to(x, MinObjAlignmentInBytes)
4178   // and align_to(x, y) == ((x + y-1) &amp; ~(y-1))
4179   // The rounding mask is strength-reduced, if possible.
4180   int round_mask = MinObjAlignmentInBytes - 1;
4181   Node* header_size = NULL;
4182   int   header_size_min  = arrayOopDesc::base_offset_in_bytes(T_BYTE);
4183   // (T_BYTE has the weakest alignment and size restrictions...)
4184   if (layout_is_con) {
4185     int       hsize  = Klass::layout_helper_header_size(layout_con);
4186     int       eshift = Klass::layout_helper_log2_element_size(layout_con);
4187     bool is_value_array = Klass::layout_helper_is_valueArray(layout_con);
4188     if ((round_mask &amp; ~right_n_bits(eshift)) == 0)
4189       round_mask = 0;  // strength-reduce it if it goes away completely
4190     assert(is_value_array || (hsize &amp; right_n_bits(eshift)) == 0, &quot;hsize is pre-rounded&quot;);
4191     assert(header_size_min &lt;= hsize, &quot;generic minimum is smallest&quot;);
4192     header_size_min = hsize;
4193     header_size = intcon(hsize + round_mask);
4194   } else {
4195     Node* hss   = intcon(Klass::_lh_header_size_shift);
4196     Node* hsm   = intcon(Klass::_lh_header_size_mask);
4197     Node* hsize = _gvn.transform( new URShiftINode(layout_val, hss) );
4198     hsize       = _gvn.transform( new AndINode(hsize, hsm) );
4199     Node* mask  = intcon(round_mask);
4200     header_size = _gvn.transform( new AddINode(hsize, mask) );
4201   }
4202 
4203   Node* elem_shift = NULL;
4204   if (layout_is_con) {
4205     int eshift = Klass::layout_helper_log2_element_size(layout_con);
4206     if (eshift != 0)
4207       elem_shift = intcon(eshift);
4208   } else {
4209     // There is no need to mask or shift this value.
4210     // The semantics of LShiftINode include an implicit mask to 0x1F.
4211     assert(Klass::_lh_log2_element_size_shift == 0, &quot;use shift in place&quot;);
4212     elem_shift = layout_val;
4213   }
4214 
4215   // Transition to native address size for all offset calculations:
4216   Node* lengthx = ConvI2X(length);
4217   Node* headerx = ConvI2X(header_size);
4218 #ifdef _LP64
4219   { const TypeInt* tilen = _gvn.find_int_type(length);
4220     if (tilen != NULL &amp;&amp; tilen-&gt;_lo &lt; 0) {
4221       // Add a manual constraint to a positive range.  Cf. array_element_address.
4222       jint size_max = fast_size_limit;
4223       if (size_max &gt; tilen-&gt;_hi)  size_max = tilen-&gt;_hi;
4224       const TypeInt* tlcon = TypeInt::make(0, size_max, Type::WidenMin);
4225 
4226       // Only do a narrow I2L conversion if the range check passed.
4227       IfNode* iff = new IfNode(control(), initial_slow_test, PROB_MIN, COUNT_UNKNOWN);
4228       _gvn.transform(iff);
4229       RegionNode* region = new RegionNode(3);
4230       _gvn.set_type(region, Type::CONTROL);
4231       lengthx = new PhiNode(region, TypeLong::LONG);
4232       _gvn.set_type(lengthx, TypeLong::LONG);
4233 
4234       // Range check passed. Use ConvI2L node with narrow type.
4235       Node* passed = IfFalse(iff);
4236       region-&gt;init_req(1, passed);
4237       // Make I2L conversion control dependent to prevent it from
4238       // floating above the range check during loop optimizations.
4239       lengthx-&gt;init_req(1, C-&gt;constrained_convI2L(&amp;_gvn, length, tlcon, passed));
4240 
4241       // Range check failed. Use ConvI2L with wide type because length may be invalid.
4242       region-&gt;init_req(2, IfTrue(iff));
4243       lengthx-&gt;init_req(2, ConvI2X(length));
4244 
4245       set_control(region);
4246       record_for_igvn(region);
4247       record_for_igvn(lengthx);
4248     }
4249   }
4250 #endif
4251 
4252   // Combine header size (plus rounding) and body size.  Then round down.
4253   // This computation cannot overflow, because it is used only in two
4254   // places, one where the length is sharply limited, and the other
4255   // after a successful allocation.
4256   Node* abody = lengthx;
4257   if (elem_shift != NULL)
4258     abody     = _gvn.transform( new LShiftXNode(lengthx, elem_shift) );
4259   Node* size  = _gvn.transform( new AddXNode(headerx, abody) );
4260   if (round_mask != 0) {
4261     Node* mask = MakeConX(~round_mask);
4262     size       = _gvn.transform( new AndXNode(size, mask) );
4263   }
4264   // else if round_mask == 0, the size computation is self-rounding
4265 
4266   if (return_size_val != NULL) {
4267     // This is the size
4268     (*return_size_val) = size;
4269   }
4270 
4271   // Now generate allocation code
4272 
4273   // The entire memory state is needed for slow path of the allocation
4274   // since GC and deoptimization can happen.
4275   Node *mem = reset_memory();
4276   set_all_memory(mem); // Create new memory state
4277 
4278   if (initial_slow_test-&gt;is_Bool()) {
4279     // Hide it behind a CMoveI, or else PhaseIdealLoop::split_up will get sick.
4280     initial_slow_test = initial_slow_test-&gt;as_Bool()-&gt;as_int_value(&amp;_gvn);
4281   }
4282 
4283   const TypeOopPtr* ary_type = _gvn.type(klass_node)-&gt;is_klassptr()-&gt;as_instance_type();
4284   const TypeAryPtr* ary_ptr = ary_type-&gt;isa_aryptr();
4285   const Type* elem = NULL;
4286   ciKlass* elem_klass = NULL;
4287 
4288   // Compute default value and storage properties for value type arrays:
4289   // - null-ok:              MyValue.box[] (ciObjArrayKlass &quot;[LMyValue&quot;)
4290   // - null-free:            MyValue.val[] (ciObjArrayKlass &quot;[QMyValue&quot;)
4291   // - null-free, flattened: MyValue.val[] (ciValueArrayKlass &quot;[QMyValue&quot;)
4292   Node* storage_properties = NULL;
4293   Node* default_value = NULL;
4294   Node* raw_default_value = NULL;
4295   int props_shift = UseCompressedClassPointers ? oopDesc::narrow_storage_props_shift : oopDesc::wide_storage_props_shift;
4296   if (ary_ptr != NULL &amp;&amp; ary_ptr-&gt;klass_is_exact()) {
4297     // Array type is known
4298     elem = ary_ptr-&gt;elem();
4299     ciArrayKlass* ary_klass = ary_ptr-&gt;klass()-&gt;as_array_klass();
4300     elem_klass = ary_klass-&gt;element_klass();
4301 
4302     ArrayStorageProperties props = ary_klass-&gt;storage_properties();
4303     if (!props.is_empty() &amp;&amp; elem_klass-&gt;is_valuetype()) {
4304       if (props.is_null_free() &amp;&amp; !props.is_flattened()) {
4305         default_value = ValueTypeNode::default_oop(gvn(), elem_klass-&gt;as_value_klass());
4306         if (elem-&gt;isa_narrowoop()) {
4307           default_value = _gvn.transform(new EncodePNode(default_value, elem));
4308           raw_default_value = raw_default_for_coops(default_value, *this);
4309         } else {
4310           raw_default_value = _gvn.transform(new CastP2XNode(control(), default_value));
4311         }
4312       }
4313       storage_properties = MakeConX(props.encode&lt;NOT_LP64(jint) LP64_ONLY(jlong)&gt;(props_shift));
4314     }
4315   }
4316 
4317   if (EnableValhalla &amp;&amp; (elem == NULL || (elem_klass != NULL &amp;&amp; (elem_klass-&gt;is_java_lang_Object() || elem_klass-&gt;is_valuetype()) &amp;&amp;
4318                                           !ary_type-&gt;klass_is_exact()))) {
4319     // Array type is not known, compute default value and storage properties for initialization.
4320     assert(default_value == NULL &amp;&amp; raw_default_value == NULL &amp;&amp; storage_properties == NULL, &quot;shouldn&#39;t be set yet&quot;);
4321     assert(elem_mirror != NULL, &quot;should not be null&quot;);
4322 
4323     Node* r = new RegionNode(4);
4324     default_value = new PhiNode(r, TypeInstPtr::BOTTOM);
4325     storage_properties = new PhiNode(r, TypeX_X);
4326 
4327     Node* empty     = MakeConX(ArrayStorageProperties::empty.encode&lt;NOT_LP64(jint) LP64_ONLY(jlong)&gt;(props_shift));
4328     Node* null_free = MakeConX(ArrayStorageProperties::null_free.encode&lt;NOT_LP64(jint) LP64_ONLY(jlong)&gt;(props_shift));
4329     Node* flat      = MakeConX(ArrayStorageProperties::flattened_and_null_free.encode&lt;NOT_LP64(jint) LP64_ONLY(jlong)&gt;(props_shift));
4330 
4331     // Check if element mirror is a value mirror
4332     IfNode* iff = create_and_map_if(control(), is_value_mirror(elem_mirror), PROB_FAIR, COUNT_UNKNOWN);
4333 
4334     // Not a value mirror but a box mirror or not a value type array, initialize with all zero
4335     r-&gt;init_req(1, _gvn.transform(new IfFalseNode(iff)));
4336     default_value-&gt;init_req(1, null());
4337     storage_properties-&gt;init_req(1, empty);
4338 
4339     // Value mirror (= null-free), check if flattened
4340     set_control(_gvn.transform(new IfTrueNode(iff)));
4341     Node* cmp = gen_lh_array_test(klass_node, Klass::_lh_array_tag_vt_value);
4342     Node* bol = _gvn.transform(new BoolNode(cmp, BoolTest::eq));
4343     iff = create_and_map_if(control(), bol, PROB_FAIR, COUNT_UNKNOWN);
4344 
4345     // Flattened, initialize with all zero
4346     r-&gt;init_req(2, _gvn.transform(new IfTrueNode(iff)));
4347     default_value-&gt;init_req(2, null());
4348     storage_properties-&gt;init_req(2, flat);
4349 
4350     // Non-flattened, initialize with the default value
4351     set_control(_gvn.transform(new IfFalseNode(iff)));
4352     Node* p = basic_plus_adr(klass_node, in_bytes(ArrayKlass::element_klass_offset()));
4353     Node* eklass = _gvn.transform(LoadKlassNode::make(_gvn, control(), immutable_memory(), p, TypeInstPtr::KLASS));
4354     Node* adr_fixed_block_addr = basic_plus_adr(eklass, in_bytes(InstanceKlass::adr_valueklass_fixed_block_offset()));
4355     Node* adr_fixed_block = make_load(control(), adr_fixed_block_addr, TypeRawPtr::NOTNULL, T_ADDRESS, MemNode::unordered);
4356     Node* default_value_offset_addr = basic_plus_adr(adr_fixed_block, in_bytes(ValueKlass::default_value_offset_offset()));
4357     Node* default_value_offset = make_load(control(), default_value_offset_addr, TypeInt::INT, T_INT, MemNode::unordered);
4358     Node* default_value_addr = basic_plus_adr(elem_mirror, ConvI2X(default_value_offset));
4359     Node* val = access_load_at(elem_mirror, default_value_addr, _gvn.type(default_value_addr)-&gt;is_ptr(), TypeInstPtr::BOTTOM, T_OBJECT, IN_HEAP);
4360     r-&gt;init_req(3, control());
4361     default_value-&gt;init_req(3, val);
4362     storage_properties-&gt;init_req(3, null_free);
4363 
4364     set_control(_gvn.transform(r));
4365     default_value = _gvn.transform(default_value);
4366     storage_properties = _gvn.transform(storage_properties);
4367     if (UseCompressedOops) {
4368       default_value = _gvn.transform(new EncodePNode(default_value, default_value-&gt;bottom_type()-&gt;make_narrowoop()));
4369       raw_default_value = raw_default_for_coops(default_value, *this);
4370     } else {
4371       raw_default_value = _gvn.transform(new CastP2XNode(control(), default_value));
4372     }
4373   }
4374 
4375   // Create the AllocateArrayNode and its result projections
4376   AllocateArrayNode* alloc = new AllocateArrayNode(C, AllocateArrayNode::alloc_type(TypeInt::INT),
4377                                                    control(), mem, i_o(),
4378                                                    size, klass_node,
4379                                                    initial_slow_test,
4380                                                    length, default_value,
4381                                                    raw_default_value,
4382                                                    storage_properties);
4383 
4384   // Cast to correct type.  Note that the klass_node may be constant or not,
4385   // and in the latter case the actual array type will be inexact also.
4386   // (This happens via a non-constant argument to inline_native_newArray.)
4387   // In any case, the value of klass_node provides the desired array type.
4388   const TypeInt* length_type = _gvn.find_int_type(length);
4389   if (ary_type-&gt;isa_aryptr() &amp;&amp; length_type != NULL) {
4390     // Try to get a better type than POS for the size
4391     ary_type = ary_type-&gt;is_aryptr()-&gt;cast_to_size(length_type);
4392   }
4393 
4394   Node* javaoop = set_output_for_allocation(alloc, ary_type, deoptimize_on_exception);
4395 
4396   // Cast length on remaining path to be as narrow as possible
4397   if (map()-&gt;find_edge(length) &gt;= 0) {
4398     Node* ccast = alloc-&gt;make_ideal_length(ary_type, &amp;_gvn);
4399     if (ccast != length) {
4400       _gvn.set_type_bottom(ccast);
4401       record_for_igvn(ccast);
4402       replace_in_map(length, ccast);
4403     }
4404   }
4405 
4406   return javaoop;
4407 }
4408 
4409 // The following &quot;Ideal_foo&quot; functions are placed here because they recognize
4410 // the graph shapes created by the functions immediately above.
4411 
4412 //---------------------------Ideal_allocation----------------------------------
4413 // Given an oop pointer or raw pointer, see if it feeds from an AllocateNode.
4414 AllocateNode* AllocateNode::Ideal_allocation(Node* ptr, PhaseTransform* phase) {
4415   if (ptr == NULL) {     // reduce dumb test in callers
4416     return NULL;
4417   }
4418 
4419   BarrierSetC2* bs = BarrierSet::barrier_set()-&gt;barrier_set_c2();
4420   ptr = bs-&gt;step_over_gc_barrier(ptr);
4421 
4422   if (ptr-&gt;is_CheckCastPP()) { // strip only one raw-to-oop cast
4423     ptr = ptr-&gt;in(1);
4424     if (ptr == NULL) return NULL;
4425   }
4426   // Return NULL for allocations with several casts:
4427   //   j.l.reflect.Array.newInstance(jobject, jint)
4428   //   Object.clone()
4429   // to keep more precise type from last cast.
4430   if (ptr-&gt;is_Proj()) {
4431     Node* allo = ptr-&gt;in(0);
4432     if (allo != NULL &amp;&amp; allo-&gt;is_Allocate()) {
4433       return allo-&gt;as_Allocate();
4434     }
4435   }
4436   // Report failure to match.
4437   return NULL;
4438 }
4439 
4440 // Fancy version which also strips off an offset (and reports it to caller).
4441 AllocateNode* AllocateNode::Ideal_allocation(Node* ptr, PhaseTransform* phase,
4442                                              intptr_t&amp; offset) {
4443   Node* base = AddPNode::Ideal_base_and_offset(ptr, phase, offset);
4444   if (base == NULL)  return NULL;
4445   return Ideal_allocation(base, phase);
4446 }
4447 
4448 // Trace Initialize &lt;- Proj[Parm] &lt;- Allocate
4449 AllocateNode* InitializeNode::allocation() {
4450   Node* rawoop = in(InitializeNode::RawAddress);
4451   if (rawoop-&gt;is_Proj()) {
4452     Node* alloc = rawoop-&gt;in(0);
4453     if (alloc-&gt;is_Allocate()) {
4454       return alloc-&gt;as_Allocate();
4455     }
4456   }
4457   return NULL;
4458 }
4459 
4460 // Trace Allocate -&gt; Proj[Parm] -&gt; Initialize
4461 InitializeNode* AllocateNode::initialization() {
4462   ProjNode* rawoop = proj_out_or_null(AllocateNode::RawAddress);
4463   if (rawoop == NULL)  return NULL;
4464   for (DUIterator_Fast imax, i = rawoop-&gt;fast_outs(imax); i &lt; imax; i++) {
4465     Node* init = rawoop-&gt;fast_out(i);
4466     if (init-&gt;is_Initialize()) {
4467       assert(init-&gt;as_Initialize()-&gt;allocation() == this, &quot;2-way link&quot;);
4468       return init-&gt;as_Initialize();
4469     }
4470   }
4471   return NULL;
4472 }
4473 
4474 //----------------------------- loop predicates ---------------------------
4475 
4476 //------------------------------add_predicate_impl----------------------------
<a name="3" id="anc3"></a><span class="line-modified">4477 void GraphKit::add_predicate_impl(Deoptimization::DeoptReason reason, int nargs) {</span>
4478   // Too many traps seen?
4479   if (too_many_traps(reason)) {
4480 #ifdef ASSERT
4481     if (TraceLoopPredicate) {
4482       int tc = C-&gt;trap_count(reason);
4483       tty-&gt;print(&quot;too many traps=%s tcount=%d in &quot;,
4484                     Deoptimization::trap_reason_name(reason), tc);
4485       method()-&gt;print(); // which method has too many predicate traps
4486       tty-&gt;cr();
4487     }
4488 #endif
4489     // We cannot afford to take more traps here,
4490     // do not generate predicate.
4491     return;
4492   }
4493 
4494   Node *cont    = _gvn.intcon(1);
4495   Node* opq     = _gvn.transform(new Opaque1Node(C, cont));
4496   Node *bol     = _gvn.transform(new Conv2BNode(opq));
4497   IfNode* iff   = create_and_map_if(control(), bol, PROB_MAX, COUNT_UNKNOWN);
4498   Node* iffalse = _gvn.transform(new IfFalseNode(iff));
4499   C-&gt;add_predicate_opaq(opq);
4500   {
4501     PreserveJVMState pjvms(this);
4502     set_control(iffalse);
4503     inc_sp(nargs);
4504     uncommon_trap(reason, Deoptimization::Action_maybe_recompile);
4505   }
4506   Node* iftrue = _gvn.transform(new IfTrueNode(iff));
4507   set_control(iftrue);
4508 }
4509 
4510 //------------------------------add_predicate---------------------------------
<a name="4" id="anc4"></a><span class="line-modified">4511 void GraphKit::add_predicate(int nargs) {</span>



4512   if (UseLoopPredicate) {
<a name="5" id="anc5"></a><span class="line-modified">4513     add_predicate_impl(Deoptimization::Reason_predicate, nargs);</span>
4514   }
4515   if (UseProfiledLoopPredicate) {
<a name="6" id="anc6"></a><span class="line-modified">4516     add_predicate_impl(Deoptimization::Reason_profile_predicate, nargs);</span>
4517   }
4518   // loop&#39;s limit check predicate should be near the loop.
<a name="7" id="anc7"></a><span class="line-modified">4519   add_predicate_impl(Deoptimization::Reason_loop_limit_check, nargs);</span>
4520 }
4521 
4522 void GraphKit::sync_kit(IdealKit&amp; ideal) {
4523   set_all_memory(ideal.merged_memory());
4524   set_i_o(ideal.i_o());
4525   set_control(ideal.ctrl());
4526 }
4527 
4528 void GraphKit::final_sync(IdealKit&amp; ideal) {
4529   // Final sync IdealKit and graphKit.
4530   sync_kit(ideal);
4531 }
4532 
4533 Node* GraphKit::load_String_length(Node* str, bool set_ctrl) {
4534   Node* len = load_array_length(load_String_value(str, set_ctrl));
4535   Node* coder = load_String_coder(str, set_ctrl);
4536   // Divide length by 2 if coder is UTF16
4537   return _gvn.transform(new RShiftINode(len, coder));
4538 }
4539 
4540 Node* GraphKit::load_String_value(Node* str, bool set_ctrl) {
4541   int value_offset = java_lang_String::value_offset_in_bytes();
4542   const TypeInstPtr* string_type = TypeInstPtr::make(TypePtr::NotNull, C-&gt;env()-&gt;String_klass(),
4543                                                      false, NULL, Type::Offset(0), false);
4544   const TypePtr* value_field_type = string_type-&gt;add_offset(value_offset);
4545   const TypeAryPtr* value_type = TypeAryPtr::make(TypePtr::NotNull,
4546                                                   TypeAry::make(TypeInt::BYTE, TypeInt::POS, false, true, true),
4547                                                   ciTypeArrayKlass::make(T_BYTE), true, Type::Offset(0));
4548   Node* p = basic_plus_adr(str, str, value_offset);
4549   Node* load = access_load_at(str, p, value_field_type, value_type, T_OBJECT,
4550                               IN_HEAP | (set_ctrl ? C2_CONTROL_DEPENDENT_LOAD : 0) | MO_UNORDERED);
4551   return load;
4552 }
4553 
4554 Node* GraphKit::load_String_coder(Node* str, bool set_ctrl) {
4555   if (!CompactStrings) {
4556     return intcon(java_lang_String::CODER_UTF16);
4557   }
4558   int coder_offset = java_lang_String::coder_offset_in_bytes();
4559   const TypeInstPtr* string_type = TypeInstPtr::make(TypePtr::NotNull, C-&gt;env()-&gt;String_klass(),
4560                                                      false, NULL, Type::Offset(0), false);
4561   const TypePtr* coder_field_type = string_type-&gt;add_offset(coder_offset);
4562 
4563   Node* p = basic_plus_adr(str, str, coder_offset);
4564   Node* load = access_load_at(str, p, coder_field_type, TypeInt::BYTE, T_BYTE,
4565                               IN_HEAP | (set_ctrl ? C2_CONTROL_DEPENDENT_LOAD : 0) | MO_UNORDERED);
4566   return load;
4567 }
4568 
4569 void GraphKit::store_String_value(Node* str, Node* value) {
4570   int value_offset = java_lang_String::value_offset_in_bytes();
4571   const TypeInstPtr* string_type = TypeInstPtr::make(TypePtr::NotNull, C-&gt;env()-&gt;String_klass(),
4572                                                      false, NULL, Type::Offset(0), false);
4573   const TypePtr* value_field_type = string_type-&gt;add_offset(value_offset);
4574 
4575   access_store_at(str,  basic_plus_adr(str, value_offset), value_field_type,
4576                   value, TypeAryPtr::BYTES, T_OBJECT, IN_HEAP | MO_UNORDERED);
4577 }
4578 
4579 void GraphKit::store_String_coder(Node* str, Node* value) {
4580   int coder_offset = java_lang_String::coder_offset_in_bytes();
4581   const TypeInstPtr* string_type = TypeInstPtr::make(TypePtr::NotNull, C-&gt;env()-&gt;String_klass(),
4582                                                      false, NULL, Type::Offset(0), false);
4583   const TypePtr* coder_field_type = string_type-&gt;add_offset(coder_offset);
4584 
4585   access_store_at(str, basic_plus_adr(str, coder_offset), coder_field_type,
4586                   value, TypeInt::BYTE, T_BYTE, IN_HEAP | MO_UNORDERED);
4587 }
4588 
4589 // Capture src and dst memory state with a MergeMemNode
4590 Node* GraphKit::capture_memory(const TypePtr* src_type, const TypePtr* dst_type) {
4591   if (src_type == dst_type) {
4592     // Types are equal, we don&#39;t need a MergeMemNode
4593     return memory(src_type);
4594   }
4595   MergeMemNode* merge = MergeMemNode::make(map()-&gt;memory());
4596   record_for_igvn(merge); // fold it up later, if possible
4597   int src_idx = C-&gt;get_alias_index(src_type);
4598   int dst_idx = C-&gt;get_alias_index(dst_type);
4599   merge-&gt;set_memory_at(src_idx, memory(src_idx));
4600   merge-&gt;set_memory_at(dst_idx, memory(dst_idx));
4601   return merge;
4602 }
4603 
4604 Node* GraphKit::compress_string(Node* src, const TypeAryPtr* src_type, Node* dst, Node* count) {
4605   assert(Matcher::match_rule_supported(Op_StrCompressedCopy), &quot;Intrinsic not supported&quot;);
4606   assert(src_type == TypeAryPtr::BYTES || src_type == TypeAryPtr::CHARS, &quot;invalid source type&quot;);
4607   // If input and output memory types differ, capture both states to preserve
4608   // the dependency between preceding and subsequent loads/stores.
4609   // For example, the following program:
4610   //  StoreB
4611   //  compress_string
4612   //  LoadB
4613   // has this memory graph (use-&gt;def):
4614   //  LoadB -&gt; compress_string -&gt; CharMem
4615   //             ... -&gt; StoreB -&gt; ByteMem
4616   // The intrinsic hides the dependency between LoadB and StoreB, causing
4617   // the load to read from memory not containing the result of the StoreB.
4618   // The correct memory graph should look like this:
4619   //  LoadB -&gt; compress_string -&gt; MergeMem(CharMem, StoreB(ByteMem))
4620   Node* mem = capture_memory(src_type, TypeAryPtr::BYTES);
4621   StrCompressedCopyNode* str = new StrCompressedCopyNode(control(), mem, src, dst, count);
4622   Node* res_mem = _gvn.transform(new SCMemProjNode(str));
4623   set_memory(res_mem, TypeAryPtr::BYTES);
4624   return str;
4625 }
4626 
4627 void GraphKit::inflate_string(Node* src, Node* dst, const TypeAryPtr* dst_type, Node* count) {
4628   assert(Matcher::match_rule_supported(Op_StrInflatedCopy), &quot;Intrinsic not supported&quot;);
4629   assert(dst_type == TypeAryPtr::BYTES || dst_type == TypeAryPtr::CHARS, &quot;invalid dest type&quot;);
4630   // Capture src and dst memory (see comment in &#39;compress_string&#39;).
4631   Node* mem = capture_memory(TypeAryPtr::BYTES, dst_type);
4632   StrInflatedCopyNode* str = new StrInflatedCopyNode(control(), mem, src, dst, count);
4633   set_memory(_gvn.transform(str), dst_type);
4634 }
4635 
4636 void GraphKit::inflate_string_slow(Node* src, Node* dst, Node* start, Node* count) {
4637   /**
4638    * int i_char = start;
4639    * for (int i_byte = 0; i_byte &lt; count; i_byte++) {
4640    *   dst[i_char++] = (char)(src[i_byte] &amp; 0xff);
4641    * }
4642    */
<a name="8" id="anc8"></a><span class="line-modified">4643   add_predicate();</span>
4644   RegionNode* head = new RegionNode(3);
4645   head-&gt;init_req(1, control());
4646   gvn().set_type(head, Type::CONTROL);
4647   record_for_igvn(head);
4648 
4649   Node* i_byte = new PhiNode(head, TypeInt::INT);
4650   i_byte-&gt;init_req(1, intcon(0));
4651   gvn().set_type(i_byte, TypeInt::INT);
4652   record_for_igvn(i_byte);
4653 
4654   Node* i_char = new PhiNode(head, TypeInt::INT);
4655   i_char-&gt;init_req(1, start);
4656   gvn().set_type(i_char, TypeInt::INT);
4657   record_for_igvn(i_char);
4658 
4659   Node* mem = PhiNode::make(head, memory(TypeAryPtr::BYTES), Type::MEMORY, TypeAryPtr::BYTES);
4660   gvn().set_type(mem, Type::MEMORY);
4661   record_for_igvn(mem);
4662   set_control(head);
4663   set_memory(mem, TypeAryPtr::BYTES);
4664   Node* ch = load_array_element(control(), src, i_byte, TypeAryPtr::BYTES);
4665   Node* st = store_to_memory(control(), array_element_address(dst, i_char, T_BYTE),
4666                              AndI(ch, intcon(0xff)), T_CHAR, TypeAryPtr::BYTES, MemNode::unordered,
4667                              false, false, true /* mismatched */);
4668 
4669   IfNode* iff = create_and_map_if(head, Bool(CmpI(i_byte, count), BoolTest::lt), PROB_FAIR, COUNT_UNKNOWN);
4670   head-&gt;init_req(2, IfTrue(iff));
4671   mem-&gt;init_req(2, st);
4672   i_byte-&gt;init_req(2, AddI(i_byte, intcon(1)));
4673   i_char-&gt;init_req(2, AddI(i_char, intcon(2)));
4674 
4675   set_control(IfFalse(iff));
4676   set_memory(st, TypeAryPtr::BYTES);
4677 }
4678 
4679 Node* GraphKit::make_constant_from_field(ciField* field, Node* obj) {
4680   if (!field-&gt;is_constant()) {
4681     return NULL; // Field not marked as constant.
4682   }
4683   ciInstance* holder = NULL;
4684   if (!field-&gt;is_static()) {
4685     ciObject* const_oop = obj-&gt;bottom_type()-&gt;is_oopptr()-&gt;const_oop();
4686     if (const_oop != NULL &amp;&amp; const_oop-&gt;is_instance()) {
4687       holder = const_oop-&gt;as_instance();
4688     }
4689   }
4690   const Type* con_type = Type::make_constant_from_field(field, holder, field-&gt;layout_type(),
4691                                                         /*is_unsigned_load=*/false);
4692   if (con_type != NULL) {
4693     Node* con = makecon(con_type);
4694     if (field-&gt;layout_type() == T_VALUETYPE &amp;&amp; field-&gt;type()-&gt;as_value_klass()-&gt;is_scalarizable() &amp;&amp; !con_type-&gt;maybe_null()) {
4695       // Load value type from constant oop
4696       con = ValueTypeNode::make_from_oop(this, con, field-&gt;type()-&gt;as_value_klass());
4697     }
4698     return con;
4699   }
4700   return NULL;
4701 }
4702 
4703 //---------------------------load_mirror_from_klass----------------------------
4704 // Given a klass oop, load its java mirror (a java.lang.Class oop).
4705 Node* GraphKit::load_mirror_from_klass(Node* klass) {
4706   Node* p = basic_plus_adr(klass, in_bytes(Klass::java_mirror_offset()));
4707   Node* load = make_load(NULL, p, TypeRawPtr::NOTNULL, T_ADDRESS, MemNode::unordered);
4708   // mirror = ((OopHandle)mirror)-&gt;resolve();
4709   return access_load(load, TypeInstPtr::MIRROR, T_OBJECT, IN_NATIVE);
4710 }
<a name="9" id="anc9"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="9" type="hidden" />
</body>
</html>