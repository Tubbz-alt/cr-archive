<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Old src/hotspot/share/opto/parse2.cpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
  </head>
  <body>
    <pre>
   1 /*
   2  * Copyright (c) 1998, 2019, Oracle and/or its affiliates. All rights reserved.
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.
   8  *
   9  * This code is distributed in the hope that it will be useful, but WITHOUT
  10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  *
  23  */
  24 
  25 #include &quot;precompiled.hpp&quot;
  26 #include &quot;ci/ciMethodData.hpp&quot;
  27 #include &quot;classfile/systemDictionary.hpp&quot;
  28 #include &quot;classfile/vmSymbols.hpp&quot;
  29 #include &quot;compiler/compileLog.hpp&quot;
  30 #include &quot;interpreter/linkResolver.hpp&quot;
  31 #include &quot;memory/resourceArea.hpp&quot;
  32 #include &quot;memory/universe.hpp&quot;
  33 #include &quot;oops/oop.inline.hpp&quot;
  34 #include &quot;opto/addnode.hpp&quot;
  35 #include &quot;opto/castnode.hpp&quot;
  36 #include &quot;opto/convertnode.hpp&quot;
  37 #include &quot;opto/divnode.hpp&quot;
  38 #include &quot;opto/idealGraphPrinter.hpp&quot;
  39 #include &quot;opto/idealKit.hpp&quot;
  40 #include &quot;opto/matcher.hpp&quot;
  41 #include &quot;opto/memnode.hpp&quot;
  42 #include &quot;opto/mulnode.hpp&quot;
  43 #include &quot;opto/opaquenode.hpp&quot;
  44 #include &quot;opto/parse.hpp&quot;
  45 #include &quot;opto/runtime.hpp&quot;
  46 #include &quot;opto/valuetypenode.hpp&quot;
  47 #include &quot;runtime/deoptimization.hpp&quot;
  48 #include &quot;runtime/sharedRuntime.hpp&quot;
  49 
  50 #ifndef PRODUCT
  51 extern int explicit_null_checks_inserted,
  52            explicit_null_checks_elided;
  53 #endif
  54 
  55 Node* Parse::record_profile_for_speculation_at_array_load(Node* ld) {
  56   // Feed unused profile data to type speculation
  57   if (UseTypeSpeculation &amp;&amp; UseArrayLoadStoreProfile) {
  58     ciKlass* array_type = NULL;
  59     ciKlass* element_type = NULL;
  60     ProfilePtrKind element_ptr = ProfileMaybeNull;
  61     bool flat_array = true;
  62     bool null_free_array = true;
  63     method()-&gt;array_access_profiled_type(bci(), array_type, element_type, element_ptr, flat_array, null_free_array);
  64     if (element_type != NULL || element_ptr != ProfileMaybeNull) {
  65       ld = record_profile_for_speculation(ld, element_type, element_ptr);
  66     }
  67   }
  68   return ld;
  69 }
  70 
  71 
  72 //---------------------------------array_load----------------------------------
  73 void Parse::array_load(BasicType bt) {
  74   const Type* elemtype = Type::TOP;
  75   Node* adr = array_addressing(bt, 0, elemtype);
  76   if (stopped())  return;     // guaranteed null or range check
  77 
  78   Node* idx = pop();
  79   Node* ary = pop();
  80 
  81   // Handle value type arrays
  82   const TypeOopPtr* elemptr = elemtype-&gt;make_oopptr();
  83   const TypeAryPtr* ary_t = _gvn.type(ary)-&gt;is_aryptr();
  84   if (elemtype-&gt;isa_valuetype() != NULL) {
  85     C-&gt;set_flattened_accesses();
  86     // Load from flattened value type array
  87     Node* vt = ValueTypeNode::make_from_flattened(this, elemtype-&gt;value_klass(), ary, adr);
  88     push(vt);
  89     return;
  90   } else if (elemptr != NULL &amp;&amp; elemptr-&gt;is_valuetypeptr() &amp;&amp; !elemptr-&gt;maybe_null()) {
  91     // Load from non-flattened but flattenable value type array (elements can never be null)
  92     bt = T_VALUETYPE;
  93   } else if (!ary_t-&gt;is_not_flat()) {
  94     assert(is_reference_type(bt), &quot;&quot;);
  95     // Cannot statically determine if array is flattened, emit runtime check
  96     assert(ValueArrayFlatten &amp;&amp; elemptr-&gt;can_be_value_type() &amp;&amp; !ary_t-&gt;klass_is_exact() &amp;&amp; !ary_t-&gt;is_not_null_free() &amp;&amp;
  97            (!elemptr-&gt;is_valuetypeptr() || elemptr-&gt;value_klass()-&gt;flatten_array()), &quot;array can&#39;t be flattened&quot;);
  98     Node* ctl = control();
  99     IdealKit ideal(this);
 100     IdealVariable res(ideal);
 101     ideal.declarations_done();
 102     Node* flattened = gen_flattened_array_test(ary);
 103     ideal.if_then(flattened, BoolTest::ne, zerocon(flattened-&gt;bottom_type()-&gt;basic_type())); {
 104       // flattened
 105       sync_kit(ideal);
 106       if (elemptr-&gt;is_valuetypeptr()) {
 107         // Element type is known, cast and load from flattened representation
 108         ciValueKlass* vk = elemptr-&gt;value_klass();
 109         assert(vk-&gt;flatten_array() &amp;&amp; elemptr-&gt;maybe_null(), &quot;must be a flattenable and nullable array&quot;);
 110         ciArrayKlass* array_klass = ciArrayKlass::make(vk, /* never_null */ true);
 111         const TypeAryPtr* arytype = TypeOopPtr::make_from_klass(array_klass)-&gt;isa_aryptr();
 112         Node* cast = _gvn.transform(new CheckCastPPNode(control(), ary, arytype));
 113         Node* casted_adr = array_element_address(cast, idx, T_VALUETYPE, ary_t-&gt;size(), control());
 114         // Re-execute flattened array load if buffering triggers deoptimization
 115         PreserveReexecuteState preexecs(this);
 116         jvms()-&gt;set_should_reexecute(true);
 117         inc_sp(2);
 118         Node* vt = ValueTypeNode::make_from_flattened(this, vk, cast, casted_adr)-&gt;allocate(this, false)-&gt;get_oop();
 119         ideal.set(res, vt);
 120         ideal.sync_kit(this);
 121       } else {
 122         Node* kls = load_object_klass(ary);
 123         // Element type is unknown, emit runtime call
 124         Node* k_adr = basic_plus_adr(kls, in_bytes(ArrayKlass::element_klass_offset()));
 125         Node* elem_klass = _gvn.transform(LoadKlassNode::make(_gvn, NULL, immutable_memory(), k_adr, TypeInstPtr::KLASS));
 126         Node* obj_size  = NULL;
 127         kill_dead_locals();
 128         // Re-execute flattened array load if buffering triggers deoptimization
 129         PreserveReexecuteState preexecs(this);
 130         jvms()-&gt;set_bci(_bci);
 131         jvms()-&gt;set_should_reexecute(true);
 132         inc_sp(2);
 133         Node* alloc_obj = new_instance(elem_klass, NULL, &amp;obj_size, /*deoptimize_on_exception=*/true);
 134 
 135         AllocateNode* alloc = AllocateNode::Ideal_allocation(alloc_obj, &amp;_gvn);
 136         assert(alloc-&gt;maybe_set_complete(&amp;_gvn), &quot;&quot;);
 137         alloc-&gt;initialization()-&gt;set_complete_with_arraycopy();
 138 
 139         // This membar keeps this access to an unknown flattened array
 140         // correctly ordered with other unknown and known flattened
 141         // array accesses.
 142         insert_mem_bar_volatile(Op_MemBarCPUOrder, C-&gt;get_alias_index(TypeAryPtr::VALUES));
 143 
 144         BarrierSetC2* bs = BarrierSet::barrier_set()-&gt;barrier_set_c2();
 145         // Unknown value type might contain reference fields
 146         if (!bs-&gt;array_copy_requires_gc_barriers(false, T_OBJECT, false, BarrierSetC2::Parsing)) {
 147           int base_off = sizeof(instanceOopDesc);
 148           Node* dst_base = basic_plus_adr(alloc_obj, base_off);
 149           Node* countx = obj_size;
 150           countx = _gvn.transform(new SubXNode(countx, MakeConX(base_off)));
 151           countx = _gvn.transform(new URShiftXNode(countx, intcon(LogBytesPerLong)));
 152 
 153           assert(Klass::_lh_log2_element_size_shift == 0, &quot;use shift in place&quot;);
 154           Node* lhp = basic_plus_adr(kls, in_bytes(Klass::layout_helper_offset()));
 155           Node* elem_shift = make_load(NULL, lhp, TypeInt::INT, T_INT, MemNode::unordered);
 156           uint header = arrayOopDesc::base_offset_in_bytes(T_VALUETYPE);
 157           Node* base  = basic_plus_adr(ary, header);
 158           idx = Compile::conv_I2X_index(&amp;_gvn, idx, TypeInt::POS, control());
 159           Node* scale = _gvn.transform(new LShiftXNode(idx, elem_shift));
 160           Node* adr = basic_plus_adr(ary, base, scale);
 161 
 162           access_clone(adr, dst_base, countx, false);
 163         } else {
 164           ideal.sync_kit(this);
 165           ideal.make_leaf_call(OptoRuntime::load_unknown_value_Type(),
 166                                CAST_FROM_FN_PTR(address, OptoRuntime::load_unknown_value),
 167                                &quot;load_unknown_value&quot;,
 168                                ary, idx, alloc_obj);
 169           sync_kit(ideal);
 170         }
 171 
 172         // This makes sure no other thread sees a partially initialized buffered value
 173         insert_mem_bar_volatile(Op_MemBarStoreStore, Compile::AliasIdxRaw, alloc-&gt;proj_out_or_null(AllocateNode::RawAddress));
 174 
 175         // Same as MemBarCPUOrder above: keep this unknown flattened
 176         // array access correctly ordered with other flattened array
 177         // access
 178         insert_mem_bar_volatile(Op_MemBarCPUOrder, C-&gt;get_alias_index(TypeAryPtr::VALUES));
 179 
 180         // Prevent any use of the newly allocated value before it is
 181         // fully initialized
 182         alloc_obj = new CastPPNode(alloc_obj, _gvn.type(alloc_obj), true);
 183         alloc_obj-&gt;set_req(0, control());
 184         alloc_obj = _gvn.transform(alloc_obj);
 185 
 186         const Type* unknown_value = TypeInstPtr::BOTTOM-&gt;cast_to_flat_array();
 187 
 188         alloc_obj = _gvn.transform(new CheckCastPPNode(control(), alloc_obj, unknown_value));
 189 
 190         ideal.sync_kit(this);
 191 
 192         ideal.set(res, alloc_obj);
 193       }
 194     } ideal.else_(); {
 195       // non-flattened
 196       sync_kit(ideal);
 197       const TypeAryPtr* adr_type = TypeAryPtr::get_array_body_type(bt);
 198       Node* ld = access_load_at(ary, adr, adr_type, elemptr, bt,
 199                                 IN_HEAP | IS_ARRAY | C2_CONTROL_DEPENDENT_LOAD, ctl);
 200       ideal.sync_kit(this);
 201       ideal.set(res, ld);
 202     } ideal.end_if();
 203     sync_kit(ideal);
 204     Node* ld = _gvn.transform(ideal.value(res));
 205     ld = record_profile_for_speculation_at_array_load(ld);
 206     push_node(bt, ld);
 207     return;
 208   }
 209 
 210   if (elemtype == TypeInt::BOOL) {
 211     bt = T_BOOLEAN;
 212   }
 213   const TypeAryPtr* adr_type = TypeAryPtr::get_array_body_type(bt);
 214   Node* ld = access_load_at(ary, adr, adr_type, elemtype, bt,
 215                             IN_HEAP | IS_ARRAY | C2_CONTROL_DEPENDENT_LOAD);
 216   if (bt == T_VALUETYPE) {
 217     // Loading a non-flattened (but flattenable) value type from an array
 218     assert(!gvn().type(ld)-&gt;maybe_null(), &quot;value type array elements should never be null&quot;);
 219     if (elemptr-&gt;value_klass()-&gt;is_scalarizable()) {
 220       ld = ValueTypeNode::make_from_oop(this, ld, elemptr-&gt;value_klass());
 221     }
 222   }
 223   if (!ld-&gt;is_ValueType()) {
 224     ld = record_profile_for_speculation_at_array_load(ld);
 225   }
 226 
 227   push_node(bt, ld);
 228 }
 229 
 230 
 231 //--------------------------------array_store----------------------------------
 232 void Parse::array_store(BasicType bt) {
 233   const Type* elemtype = Type::TOP;
 234   Node* adr = array_addressing(bt, type2size[bt], elemtype);
 235   if (stopped())  return;     // guaranteed null or range check
 236   Node* cast_val = NULL;
 237   if (bt == T_OBJECT) {
 238     cast_val = array_store_check();
 239     if (stopped()) return;
 240   }
 241   Node* val = pop_node(bt); // Value to store
 242   Node* idx = pop();        // Index in the array
 243   Node* ary = pop();        // The array itself
 244 
 245   const TypeAryPtr* ary_t = _gvn.type(ary)-&gt;is_aryptr();
 246   const TypeAryPtr* adr_type = TypeAryPtr::get_array_body_type(bt);
 247 
 248   if (elemtype == TypeInt::BOOL) {
 249     bt = T_BOOLEAN;
 250   } else if (bt == T_OBJECT) {
 251     elemtype = elemtype-&gt;make_oopptr();
 252     const Type* tval = _gvn.type(cast_val);
 253     // We may have lost type information for &#39;val&#39; here due to the casts
 254     // emitted by the array_store_check code (see JDK-6312651)
 255     // TODO Remove this code once JDK-6312651 is in.
 256     const Type* tval_init = _gvn.type(val);
 257     bool can_be_value_type = tval-&gt;isa_valuetype() || (tval != TypePtr::NULL_PTR &amp;&amp; tval_init-&gt;is_oopptr()-&gt;can_be_value_type() &amp;&amp; tval-&gt;is_oopptr()-&gt;can_be_value_type());
 258     bool not_flattenable = !can_be_value_type || ((tval_init-&gt;is_valuetypeptr() || tval_init-&gt;isa_valuetype()) &amp;&amp; !tval_init-&gt;value_klass()-&gt;flatten_array());
 259 
 260     if (!ary_t-&gt;is_not_null_free() &amp;&amp; !can_be_value_type &amp;&amp; (!tval-&gt;maybe_null() || !tval_init-&gt;maybe_null())) {
 261       // Storing a non-inline-type, mark array as not null-free.
 262       // This is only legal for non-null stores because the array_store_check passes for null.
 263       ary_t = ary_t-&gt;cast_to_not_null_free();
 264       Node* cast = _gvn.transform(new CheckCastPPNode(control(), ary, ary_t));
 265       replace_in_map(ary, cast);
 266       ary = cast;
 267     } else if (!ary_t-&gt;is_not_flat() &amp;&amp; not_flattenable) {
 268       // Storing a non-flattenable value, mark array as not flat.
 269       ary_t = ary_t-&gt;cast_to_not_flat();
 270       if (tval != TypePtr::NULL_PTR) {
 271         // For NULL, this transformation is only valid after the null guard below
 272         Node* cast = _gvn.transform(new CheckCastPPNode(control(), ary, ary_t));
 273         replace_in_map(ary, cast);
 274         ary = cast;
 275       }
 276     }
 277 
 278     if (ary_t-&gt;elem()-&gt;isa_valuetype() != NULL) {
 279       // Store to flattened value type array
 280       C-&gt;set_flattened_accesses();
 281       if (!cast_val-&gt;is_ValueType()) {
 282         inc_sp(3);
 283         cast_val = null_check(cast_val);
 284         if (stopped()) return;
 285         dec_sp(3);
 286         cast_val = ValueTypeNode::make_from_oop(this, cast_val, ary_t-&gt;elem()-&gt;value_klass());
 287       }
 288       // Re-execute flattened array store if buffering triggers deoptimization
 289       PreserveReexecuteState preexecs(this);
 290       inc_sp(3);
 291       jvms()-&gt;set_should_reexecute(true);
 292       cast_val-&gt;as_ValueType()-&gt;store_flattened(this, ary, adr, NULL, 0, MO_UNORDERED | IN_HEAP | IS_ARRAY);
 293       return;
 294     } else if (elemtype-&gt;is_valuetypeptr() &amp;&amp; !elemtype-&gt;maybe_null()) {
 295       // Store to non-flattened but flattenable value type array (elements can never be null)
 296       if (!cast_val-&gt;is_ValueType() &amp;&amp; tval-&gt;maybe_null()) {
 297         inc_sp(3);
 298         cast_val = null_check(cast_val);
 299         if (stopped()) return;
 300         dec_sp(3);
 301       }
 302     } else if (!ary_t-&gt;is_not_flat()) {
 303       // Array might be flattened, emit runtime checks
 304       assert(ValueArrayFlatten &amp;&amp; !not_flattenable &amp;&amp; elemtype-&gt;is_oopptr()-&gt;can_be_value_type() &amp;&amp;
 305              !ary_t-&gt;klass_is_exact() &amp;&amp; !ary_t-&gt;is_not_null_free(), &quot;array can&#39;t be flattened&quot;);
 306       IdealKit ideal(this);
 307       Node* flattened = gen_flattened_array_test(ary);
 308       ideal.if_then(flattened, BoolTest::ne, zerocon(flattened-&gt;bottom_type()-&gt;basic_type())); {
 309         Node* val = cast_val;
 310         // flattened
 311         if (!val-&gt;is_ValueType() &amp;&amp; tval-&gt;maybe_null()) {
 312           // Add null check
 313           sync_kit(ideal);
 314           Node* null_ctl = top();
 315           val = null_check_oop(val, &amp;null_ctl);
 316           if (null_ctl != top()) {
 317             PreserveJVMState pjvms(this);
 318             inc_sp(3);
 319             set_control(null_ctl);
 320             uncommon_trap(Deoptimization::Reason_null_check, Deoptimization::Action_none);
 321             dec_sp(3);
 322           }
 323           ideal.sync_kit(this);
 324         }
 325         // Try to determine the value klass
 326         ciValueKlass* vk = NULL;
 327         if (tval-&gt;isa_valuetype() || tval-&gt;is_valuetypeptr()) {
 328           vk = tval-&gt;value_klass();
 329         } else if (tval_init-&gt;isa_valuetype() || tval_init-&gt;is_valuetypeptr()) {
 330           vk = tval_init-&gt;value_klass();
 331         } else if (elemtype-&gt;is_valuetypeptr()) {
 332           vk = elemtype-&gt;value_klass();
 333         }
 334         Node* casted_ary = ary;
 335         if (vk != NULL &amp;&amp; !stopped()) {
 336           // Element type is known, cast and store to flattened representation
 337           sync_kit(ideal);
 338           assert(vk-&gt;flatten_array() &amp;&amp; elemtype-&gt;maybe_null(), &quot;must be a flattenable and nullable array&quot;);
 339           ciArrayKlass* array_klass = ciArrayKlass::make(vk, /* never_null */ true);
 340           const TypeAryPtr* arytype = TypeOopPtr::make_from_klass(array_klass)-&gt;isa_aryptr();
 341           casted_ary = _gvn.transform(new CheckCastPPNode(control(), casted_ary, arytype));
 342           Node* casted_adr = array_element_address(casted_ary, idx, T_OBJECT, arytype-&gt;size(), control());
 343           if (!val-&gt;is_ValueType()) {
 344             assert(!gvn().type(val)-&gt;maybe_null(), &quot;value type array elements should never be null&quot;);
 345             val = ValueTypeNode::make_from_oop(this, val, vk);
 346           }
 347           // Re-execute flattened array store if buffering triggers deoptimization
 348           PreserveReexecuteState preexecs(this);
 349           inc_sp(3);
 350           jvms()-&gt;set_should_reexecute(true);
 351           val-&gt;as_ValueType()-&gt;store_flattened(this, casted_ary, casted_adr, NULL, 0, MO_UNORDERED | IN_HEAP | IS_ARRAY);
 352           ideal.sync_kit(this);
 353         } else if (!ideal.ctrl()-&gt;is_top()) {
 354           // Element type is unknown, emit runtime call
 355           sync_kit(ideal);
 356 
 357           // This membar keeps this access to an unknown flattened
 358           // array correctly ordered with other unknown and known
 359           // flattened array accesses.
 360           insert_mem_bar_volatile(Op_MemBarCPUOrder, C-&gt;get_alias_index(TypeAryPtr::VALUES));
 361           ideal.sync_kit(this);
 362 
 363           ideal.make_leaf_call(OptoRuntime::store_unknown_value_Type(),
 364                                CAST_FROM_FN_PTR(address, OptoRuntime::store_unknown_value),
 365                                &quot;store_unknown_value&quot;,
 366                                val, casted_ary, idx);
 367 
 368           sync_kit(ideal);
 369           // Same as MemBarCPUOrder above: keep this unknown
 370           // flattened array access correctly ordered with other
 371           // flattened array accesses.
 372           insert_mem_bar_volatile(Op_MemBarCPUOrder, C-&gt;get_alias_index(TypeAryPtr::VALUES));
 373           ideal.sync_kit(this);
 374         }
 375       }
 376       ideal.else_();
 377       {
 378         // non-flattened
 379         sync_kit(ideal);
 380         gen_value_array_null_guard(ary, cast_val, 3);
 381         inc_sp(3);
 382         access_store_at(ary, adr, adr_type, cast_val, elemtype, bt, MO_UNORDERED | IN_HEAP | IS_ARRAY, false);
 383         dec_sp(3);
 384         ideal.sync_kit(this);
 385       }
 386       ideal.end_if();
 387       sync_kit(ideal);
 388       return;
 389     } else if (!ary_t-&gt;is_not_null_free()) {
 390       // Array is not flattened but may be null free
 391       assert(elemtype-&gt;is_oopptr()-&gt;can_be_value_type() &amp;&amp; !ary_t-&gt;klass_is_exact(), &quot;array can&#39;t be null free&quot;);
 392       ary = gen_value_array_null_guard(ary, cast_val, 3, true);
 393     }
 394   }
 395   inc_sp(3);
 396   access_store_at(ary, adr, adr_type, val, elemtype, bt, MO_UNORDERED | IN_HEAP | IS_ARRAY);
 397   dec_sp(3);
 398 }
 399 
 400 
 401 //------------------------------array_addressing-------------------------------
 402 // Pull array and index from the stack.  Compute pointer-to-element.
 403 Node* Parse::array_addressing(BasicType type, int vals, const Type*&amp; elemtype) {
 404   Node *idx   = peek(0+vals);   // Get from stack without popping
 405   Node *ary   = peek(1+vals);   // in case of exception
 406 
 407   // Null check the array base, with correct stack contents
 408   ary = null_check(ary, T_ARRAY);
 409   // Compile-time detect of null-exception?
 410   if (stopped())  return top();
 411 
 412   const TypeAryPtr* arytype  = _gvn.type(ary)-&gt;is_aryptr();
 413   const TypeInt*    sizetype = arytype-&gt;size();
 414   elemtype = arytype-&gt;elem();
 415 
 416   if (UseUniqueSubclasses) {
 417     const Type* el = elemtype-&gt;make_ptr();
 418     if (el &amp;&amp; el-&gt;isa_instptr()) {
 419       const TypeInstPtr* toop = el-&gt;is_instptr();
 420       if (toop-&gt;klass()-&gt;as_instance_klass()-&gt;unique_concrete_subklass()) {
 421         // If we load from &quot;AbstractClass[]&quot; we must see &quot;ConcreteSubClass&quot;.
 422         const Type* subklass = Type::get_const_type(toop-&gt;klass());
 423         elemtype = subklass-&gt;join_speculative(el);
 424       }
 425     }
 426   }
 427 
 428   // Check for big class initializers with all constant offsets
 429   // feeding into a known-size array.
 430   const TypeInt* idxtype = _gvn.type(idx)-&gt;is_int();
 431   // See if the highest idx value is less than the lowest array bound,
 432   // and if the idx value cannot be negative:
 433   bool need_range_check = true;
 434   if (idxtype-&gt;_hi &lt; sizetype-&gt;_lo &amp;&amp; idxtype-&gt;_lo &gt;= 0) {
 435     need_range_check = false;
 436     if (C-&gt;log() != NULL)   C-&gt;log()-&gt;elem(&quot;observe that=&#39;!need_range_check&#39;&quot;);
 437   }
 438 
 439   ciKlass * arytype_klass = arytype-&gt;klass();
 440   if ((arytype_klass != NULL) &amp;&amp; (!arytype_klass-&gt;is_loaded())) {
 441     // Only fails for some -Xcomp runs
 442     // The class is unloaded.  We have to run this bytecode in the interpreter.
 443     uncommon_trap(Deoptimization::Reason_unloaded,
 444                   Deoptimization::Action_reinterpret,
 445                   arytype-&gt;klass(), &quot;!loaded array&quot;);
 446     return top();
 447   }
 448 
 449   // Do the range check
 450   if (GenerateRangeChecks &amp;&amp; need_range_check) {
 451     Node* tst;
 452     if (sizetype-&gt;_hi &lt;= 0) {
 453       // The greatest array bound is negative, so we can conclude that we&#39;re
 454       // compiling unreachable code, but the unsigned compare trick used below
 455       // only works with non-negative lengths.  Instead, hack &quot;tst&quot; to be zero so
 456       // the uncommon_trap path will always be taken.
 457       tst = _gvn.intcon(0);
 458     } else {
 459       // Range is constant in array-oop, so we can use the original state of mem
 460       Node* len = load_array_length(ary);
 461 
 462       // Test length vs index (standard trick using unsigned compare)
 463       Node* chk = _gvn.transform( new CmpUNode(idx, len) );
 464       BoolTest::mask btest = BoolTest::lt;
 465       tst = _gvn.transform( new BoolNode(chk, btest) );
 466     }
 467     RangeCheckNode* rc = new RangeCheckNode(control(), tst, PROB_MAX, COUNT_UNKNOWN);
 468     _gvn.set_type(rc, rc-&gt;Value(&amp;_gvn));
 469     if (!tst-&gt;is_Con()) {
 470       record_for_igvn(rc);
 471     }
 472     set_control(_gvn.transform(new IfTrueNode(rc)));
 473     // Branch to failure if out of bounds
 474     {
 475       PreserveJVMState pjvms(this);
 476       set_control(_gvn.transform(new IfFalseNode(rc)));
 477       if (C-&gt;allow_range_check_smearing()) {
 478         // Do not use builtin_throw, since range checks are sometimes
 479         // made more stringent by an optimistic transformation.
 480         // This creates &quot;tentative&quot; range checks at this point,
 481         // which are not guaranteed to throw exceptions.
 482         // See IfNode::Ideal, is_range_check, adjust_check.
 483         uncommon_trap(Deoptimization::Reason_range_check,
 484                       Deoptimization::Action_make_not_entrant,
 485                       NULL, &quot;range_check&quot;);
 486       } else {
 487         // If we have already recompiled with the range-check-widening
 488         // heroic optimization turned off, then we must really be throwing
 489         // range check exceptions.
 490         builtin_throw(Deoptimization::Reason_range_check, idx);
 491       }
 492     }
 493   }
 494   // Check for always knowing you are throwing a range-check exception
 495   if (stopped())  return top();
 496 
 497   // This could be an access to a value array. We can&#39;t tell if it&#39;s
 498   // flat or not. Speculating it&#39;s not leads to a much simpler graph
 499   // shape. Check profiling.
 500   // For aastore, by the time we&#39;re here, the array store check should
 501   // have already taken advantage of profiling to cast the array to an
 502   // exact type reported by profiling
 503   const TypeOopPtr* elemptr = elemtype-&gt;make_oopptr();
 504   if (elemtype-&gt;isa_valuetype() == NULL &amp;&amp;
 505       (elemptr == NULL || !elemptr-&gt;is_valuetypeptr() || elemptr-&gt;maybe_null()) &amp;&amp;
 506       !arytype-&gt;is_not_flat()) {
 507     assert(is_reference_type(type), &quot;Only references&quot;);
 508     // First check the speculative type
 509     Deoptimization::DeoptReason reason = Deoptimization::Reason_speculate_class_check;
 510     ciKlass* array_type = arytype-&gt;speculative_type();
 511     if (too_many_traps_or_recompiles(reason) || array_type == NULL) {
 512       // No speculative type, check profile data at this bci
 513       array_type = NULL;
 514       reason = Deoptimization::Reason_class_check;
 515       if (UseArrayLoadStoreProfile &amp;&amp; !too_many_traps_or_recompiles(reason)) {
 516         ciKlass* element_type = NULL;
 517         ProfilePtrKind element_ptr = ProfileMaybeNull;
 518         bool flat_array = true;
 519         bool null_free_array = true;
 520         method()-&gt;array_access_profiled_type(bci(), array_type, element_type, element_ptr, flat_array, null_free_array);
 521       }
 522     }
 523     if (array_type != NULL) {
 524       // Speculate that this array has the exact type reported by profile data
 525       Node* better_ary = NULL;
 526       Node* slow_ctl = type_check_receiver(ary, array_type, 1.0, &amp;better_ary);
 527       { PreserveJVMState pjvms(this);
 528         set_control(slow_ctl);
 529         uncommon_trap_exact(reason, Deoptimization::Action_maybe_recompile);
 530       }
 531       replace_in_map(ary, better_ary);
 532       ary = better_ary;
 533       arytype  = _gvn.type(ary)-&gt;is_aryptr();
 534       elemtype = arytype-&gt;elem();
 535     }
 536   } else if (UseTypeSpeculation &amp;&amp; UseArrayLoadStoreProfile) {
 537     // No need to speculate: feed profile data at this bci for the
 538     // array to type speculation
 539     ciKlass* array_type = NULL;
 540     ciKlass* element_type = NULL;
 541     ProfilePtrKind element_ptr = ProfileMaybeNull;
 542     bool flat_array = true;
 543     bool null_free_array = true;
 544     method()-&gt;array_access_profiled_type(bci(), array_type, element_type, element_ptr, flat_array, null_free_array);
 545     if (array_type != NULL) {
 546       record_profile_for_speculation(ary, array_type, ProfileMaybeNull);
 547     }
 548   }
 549 
 550   // We have no exact array type from profile data. Check profile data
 551   // for a non null free or non flat array. Non null free implies non
 552   // flat so check this one first. Speculating on a non null free
 553   // array doesn&#39;t help aaload but could be profitable for a
 554   // subsequent aastore.
 555   elemptr = elemtype-&gt;make_oopptr();
 556   if (!arytype-&gt;is_not_null_free() &amp;&amp;
 557       elemtype-&gt;isa_valuetype() == NULL &amp;&amp;
 558       (elemptr == NULL || !elemptr-&gt;is_valuetypeptr()) &amp;&amp;
 559       UseArrayLoadStoreProfile) {
 560     assert(is_reference_type(type), &quot;&quot;);
 561     bool null_free_array = true;
 562     Deoptimization::DeoptReason reason = Deoptimization::Reason_none;
 563     if (arytype-&gt;speculative() != NULL &amp;&amp;
 564         arytype-&gt;speculative()-&gt;is_aryptr()-&gt;is_not_null_free() &amp;&amp;
 565         !too_many_traps_or_recompiles(Deoptimization::Reason_speculate_class_check)) {
 566       null_free_array = false;
 567       reason = Deoptimization::Reason_speculate_class_check;
 568     } else if (!too_many_traps_or_recompiles(Deoptimization::Reason_class_check)) {
 569       ciKlass* array_type = NULL;
 570       ciKlass* element_type = NULL;
 571       ProfilePtrKind element_ptr = ProfileMaybeNull;
 572       bool flat_array = true;
 573       method()-&gt;array_access_profiled_type(bci(), array_type, element_type, element_ptr, flat_array, null_free_array);
 574       reason = Deoptimization::Reason_class_check;
 575     }
 576     if (!null_free_array) {
 577       Node* tst = gen_null_free_array_check(ary);
 578       {
 579         BuildCutout unless(this, tst, PROB_MAX);
 580         uncommon_trap_exact(reason, Deoptimization::Action_maybe_recompile);
 581       }
 582       Node* better_ary = _gvn.transform(new CheckCastPPNode(control(), ary, arytype-&gt;cast_to_not_null_free()));
 583       replace_in_map(ary, better_ary);
 584       ary = better_ary;
 585       arytype  = _gvn.type(ary)-&gt;is_aryptr();
 586     }
 587   }
 588 
 589   if (!arytype-&gt;is_not_flat() &amp;&amp; elemtype-&gt;isa_valuetype() == NULL) {
 590     assert(is_reference_type(type), &quot;&quot;);
 591     bool flat_array = true;
 592     Deoptimization::DeoptReason reason = Deoptimization::Reason_none;
 593     if (arytype-&gt;speculative() != NULL &amp;&amp;
 594         arytype-&gt;speculative()-&gt;is_aryptr()-&gt;is_not_flat() &amp;&amp;
 595         !too_many_traps_or_recompiles(Deoptimization::Reason_speculate_class_check)) {
 596       flat_array = false;
 597       reason = Deoptimization::Reason_speculate_class_check;
 598     } else if (UseArrayLoadStoreProfile &amp;&amp; !too_many_traps_or_recompiles(reason)) {
 599       ciKlass* array_type = NULL;
 600       ciKlass* element_type = NULL;
 601       ProfilePtrKind element_ptr = ProfileMaybeNull;
 602       bool null_free_array = true;
 603       method()-&gt;array_access_profiled_type(bci(), array_type, element_type, element_ptr, flat_array, null_free_array);
 604       reason = Deoptimization::Reason_class_check;
 605     }
 606     if (!flat_array) {
 607       Node* flattened = gen_flattened_array_test(ary);
 608       Node* chk = NULL;
 609       if (_gvn.type(flattened)-&gt;isa_int()) {
 610         chk = _gvn.transform(new CmpINode(flattened, intcon(0)));
 611       } else {
 612         assert(_gvn.type(flattened)-&gt;isa_long(), &quot;flattened property is int or long&quot;);
 613         chk = _gvn.transform(new CmpLNode(flattened, longcon(0)));
 614       }
 615       Node* tst = _gvn.transform(new BoolNode(chk, BoolTest::eq));
 616       {
 617         BuildCutout unless(this, tst, PROB_MAX);
 618         uncommon_trap_exact(reason, Deoptimization::Action_maybe_recompile);
 619       }
 620       Node* better_ary = _gvn.transform(new CheckCastPPNode(control(), ary, arytype-&gt;cast_to_not_flat()));
 621       replace_in_map(ary, better_ary);
 622       ary = better_ary;
 623       arytype  = _gvn.type(ary)-&gt;is_aryptr();
 624     }
 625   }
 626 
 627   // Make array address computation control dependent to prevent it
 628   // from floating above the range check during loop optimizations.
 629   Node* ptr = array_element_address(ary, idx, type, sizetype, control());
 630   assert(ptr != top(), &quot;top should go hand-in-hand with stopped&quot;);
 631 
 632   return ptr;
 633 }
 634 
 635 
 636 // returns IfNode
 637 IfNode* Parse::jump_if_fork_int(Node* a, Node* b, BoolTest::mask mask, float prob, float cnt) {
 638   Node   *cmp = _gvn.transform(new CmpINode(a, b)); // two cases: shiftcount &gt; 32 and shiftcount &lt;= 32
 639   Node   *tst = _gvn.transform(new BoolNode(cmp, mask));
 640   IfNode *iff = create_and_map_if(control(), tst, prob, cnt);
 641   return iff;
 642 }
 643 
 644 // return Region node
 645 Node* Parse::jump_if_join(Node* iffalse, Node* iftrue) {
 646   Node *region  = new RegionNode(3); // 2 results
 647   record_for_igvn(region);
 648   region-&gt;init_req(1, iffalse);
 649   region-&gt;init_req(2, iftrue );
 650   _gvn.set_type(region, Type::CONTROL);
 651   region = _gvn.transform(region);
 652   set_control (region);
 653   return region;
 654 }
 655 
 656 // sentinel value for the target bci to mark never taken branches
 657 // (according to profiling)
 658 static const int never_reached = INT_MAX;
 659 
 660 //------------------------------helper for tableswitch-------------------------
 661 void Parse::jump_if_true_fork(IfNode *iff, int dest_bci_if_true, int prof_table_index, bool unc) {
 662   // True branch, use existing map info
 663   { PreserveJVMState pjvms(this);
 664     Node *iftrue  = _gvn.transform( new IfTrueNode (iff) );
 665     set_control( iftrue );
 666     if (unc) {
 667       repush_if_args();
 668       uncommon_trap(Deoptimization::Reason_unstable_if,
 669                     Deoptimization::Action_reinterpret,
 670                     NULL,
 671                     &quot;taken always&quot;);
 672     } else {
 673       assert(dest_bci_if_true != never_reached, &quot;inconsistent dest&quot;);
 674       profile_switch_case(prof_table_index);
 675       merge_new_path(dest_bci_if_true);
 676     }
 677   }
 678 
 679   // False branch
 680   Node *iffalse = _gvn.transform( new IfFalseNode(iff) );
 681   set_control( iffalse );
 682 }
 683 
 684 void Parse::jump_if_false_fork(IfNode *iff, int dest_bci_if_true, int prof_table_index, bool unc) {
 685   // True branch, use existing map info
 686   { PreserveJVMState pjvms(this);
 687     Node *iffalse  = _gvn.transform( new IfFalseNode (iff) );
 688     set_control( iffalse );
 689     if (unc) {
 690       repush_if_args();
 691       uncommon_trap(Deoptimization::Reason_unstable_if,
 692                     Deoptimization::Action_reinterpret,
 693                     NULL,
 694                     &quot;taken never&quot;);
 695     } else {
 696       assert(dest_bci_if_true != never_reached, &quot;inconsistent dest&quot;);
 697       profile_switch_case(prof_table_index);
 698       merge_new_path(dest_bci_if_true);
 699     }
 700   }
 701 
 702   // False branch
 703   Node *iftrue = _gvn.transform( new IfTrueNode(iff) );
 704   set_control( iftrue );
 705 }
 706 
 707 void Parse::jump_if_always_fork(int dest_bci, int prof_table_index, bool unc) {
 708   // False branch, use existing map and control()
 709   if (unc) {
 710     repush_if_args();
 711     uncommon_trap(Deoptimization::Reason_unstable_if,
 712                   Deoptimization::Action_reinterpret,
 713                   NULL,
 714                   &quot;taken never&quot;);
 715   } else {
 716     assert(dest_bci != never_reached, &quot;inconsistent dest&quot;);
 717     profile_switch_case(prof_table_index);
 718     merge_new_path(dest_bci);
 719   }
 720 }
 721 
 722 
 723 extern &quot;C&quot; {
 724   static int jint_cmp(const void *i, const void *j) {
 725     int a = *(jint *)i;
 726     int b = *(jint *)j;
 727     return a &gt; b ? 1 : a &lt; b ? -1 : 0;
 728   }
 729 }
 730 
 731 
 732 // Default value for methodData switch indexing. Must be a negative value to avoid
 733 // conflict with any legal switch index.
 734 #define NullTableIndex -1
 735 
 736 class SwitchRange : public StackObj {
 737   // a range of integers coupled with a bci destination
 738   jint _lo;                     // inclusive lower limit
 739   jint _hi;                     // inclusive upper limit
 740   int _dest;
 741   int _table_index;             // index into method data table
 742   float _cnt;                   // how many times this range was hit according to profiling
 743 
 744 public:
 745   jint lo() const              { return _lo;   }
 746   jint hi() const              { return _hi;   }
 747   int  dest() const            { return _dest; }
 748   int  table_index() const     { return _table_index; }
 749   bool is_singleton() const    { return _lo == _hi; }
 750   float cnt() const            { return _cnt; }
 751 
 752   void setRange(jint lo, jint hi, int dest, int table_index, float cnt) {
 753     assert(lo &lt;= hi, &quot;must be a non-empty range&quot;);
 754     _lo = lo, _hi = hi; _dest = dest; _table_index = table_index; _cnt = cnt;
 755     assert(_cnt &gt;= 0, &quot;&quot;);
 756   }
 757   bool adjoinRange(jint lo, jint hi, int dest, int table_index, float cnt, bool trim_ranges) {
 758     assert(lo &lt;= hi, &quot;must be a non-empty range&quot;);
 759     if (lo == _hi+1 &amp;&amp; table_index == _table_index) {
 760       // see merge_ranges() comment below
 761       if (trim_ranges) {
 762         if (cnt == 0) {
 763           if (_cnt != 0) {
 764             return false;
 765           }
 766           if (dest != _dest) {
 767             _dest = never_reached;
 768           }
 769         } else {
 770           if (_cnt == 0) {
 771             return false;
 772           }
 773           if (dest != _dest) {
 774             return false;
 775           }
 776         }
 777       } else {
 778         if (dest != _dest) {
 779           return false;
 780         }
 781       }
 782       _hi = hi;
 783       _cnt += cnt;
 784       return true;
 785     }
 786     return false;
 787   }
 788 
 789   void set (jint value, int dest, int table_index, float cnt) {
 790     setRange(value, value, dest, table_index, cnt);
 791   }
 792   bool adjoin(jint value, int dest, int table_index, float cnt, bool trim_ranges) {
 793     return adjoinRange(value, value, dest, table_index, cnt, trim_ranges);
 794   }
 795   bool adjoin(SwitchRange&amp; other) {
 796     return adjoinRange(other._lo, other._hi, other._dest, other._table_index, other._cnt, false);
 797   }
 798 
 799   void print() {
 800     if (is_singleton())
 801       tty-&gt;print(&quot; {%d}=&gt;%d (cnt=%f)&quot;, lo(), dest(), cnt());
 802     else if (lo() == min_jint)
 803       tty-&gt;print(&quot; {..%d}=&gt;%d (cnt=%f)&quot;, hi(), dest(), cnt());
 804     else if (hi() == max_jint)
 805       tty-&gt;print(&quot; {%d..}=&gt;%d (cnt=%f)&quot;, lo(), dest(), cnt());
 806     else
 807       tty-&gt;print(&quot; {%d..%d}=&gt;%d (cnt=%f)&quot;, lo(), hi(), dest(), cnt());
 808   }
 809 };
 810 
 811 // We try to minimize the number of ranges and the size of the taken
 812 // ones using profiling data. When ranges are created,
 813 // SwitchRange::adjoinRange() only allows 2 adjoining ranges to merge
 814 // if both were never hit or both were hit to build longer unreached
 815 // ranges. Here, we now merge adjoining ranges with the same
 816 // destination and finally set destination of unreached ranges to the
 817 // special value never_reached because it can help minimize the number
 818 // of tests that are necessary.
 819 //
 820 // For instance:
 821 // [0, 1] to target1 sometimes taken
 822 // [1, 2] to target1 never taken
 823 // [2, 3] to target2 never taken
 824 // would lead to:
 825 // [0, 1] to target1 sometimes taken
 826 // [1, 3] never taken
 827 //
 828 // (first 2 ranges to target1 are not merged)
 829 static void merge_ranges(SwitchRange* ranges, int&amp; rp) {
 830   if (rp == 0) {
 831     return;
 832   }
 833   int shift = 0;
 834   for (int j = 0; j &lt; rp; j++) {
 835     SwitchRange&amp; r1 = ranges[j-shift];
 836     SwitchRange&amp; r2 = ranges[j+1];
 837     if (r1.adjoin(r2)) {
 838       shift++;
 839     } else if (shift &gt; 0) {
 840       ranges[j+1-shift] = r2;
 841     }
 842   }
 843   rp -= shift;
 844   for (int j = 0; j &lt;= rp; j++) {
 845     SwitchRange&amp; r = ranges[j];
 846     if (r.cnt() == 0 &amp;&amp; r.dest() != never_reached) {
 847       r.setRange(r.lo(), r.hi(), never_reached, r.table_index(), r.cnt());
 848     }
 849   }
 850 }
 851 
 852 //-------------------------------do_tableswitch--------------------------------
 853 void Parse::do_tableswitch() {
 854   Node* lookup = pop();
 855   // Get information about tableswitch
 856   int default_dest = iter().get_dest_table(0);
 857   int lo_index     = iter().get_int_table(1);
 858   int hi_index     = iter().get_int_table(2);
 859   int len          = hi_index - lo_index + 1;
 860 
 861   if (len &lt; 1) {
 862     // If this is a backward branch, add safepoint
 863     maybe_add_safepoint(default_dest);
 864     merge(default_dest);
 865     return;
 866   }
 867 
 868   ciMethodData* methodData = method()-&gt;method_data();
 869   ciMultiBranchData* profile = NULL;
 870   if (methodData-&gt;is_mature() &amp;&amp; UseSwitchProfiling) {
 871     ciProfileData* data = methodData-&gt;bci_to_data(bci());
 872     if (data != NULL &amp;&amp; data-&gt;is_MultiBranchData()) {
 873       profile = (ciMultiBranchData*)data;
 874     }
 875   }
 876   bool trim_ranges = !method_data_update() &amp;&amp; !C-&gt;too_many_traps(method(), bci(), Deoptimization::Reason_unstable_if);
 877 
 878   // generate decision tree, using trichotomy when possible
 879   int rnum = len+2;
 880   bool makes_backward_branch = false;
 881   SwitchRange* ranges = NEW_RESOURCE_ARRAY(SwitchRange, rnum);
 882   int rp = -1;
 883   if (lo_index != min_jint) {
 884     uint cnt = 1;
 885     if (profile != NULL) {
 886       cnt = profile-&gt;default_count() / (hi_index != max_jint ? 2 : 1);
 887     }
 888     ranges[++rp].setRange(min_jint, lo_index-1, default_dest, NullTableIndex, cnt);
 889   }
 890   for (int j = 0; j &lt; len; j++) {
 891     jint match_int = lo_index+j;
 892     int  dest      = iter().get_dest_table(j+3);
 893     makes_backward_branch |= (dest &lt;= bci());
 894     int  table_index = method_data_update() ? j : NullTableIndex;
 895     uint cnt = 1;
 896     if (profile != NULL) {
 897       cnt = profile-&gt;count_at(j);
 898     }
 899     if (rp &lt; 0 || !ranges[rp].adjoin(match_int, dest, table_index, cnt, trim_ranges)) {
 900       ranges[++rp].set(match_int, dest, table_index, cnt);
 901     }
 902   }
 903   jint highest = lo_index+(len-1);
 904   assert(ranges[rp].hi() == highest, &quot;&quot;);
 905   if (highest != max_jint) {
 906     uint cnt = 1;
 907     if (profile != NULL) {
 908       cnt = profile-&gt;default_count() / (lo_index != min_jint ? 2 : 1);
 909     }
 910     if (!ranges[rp].adjoinRange(highest+1, max_jint, default_dest, NullTableIndex, cnt, trim_ranges)) {
 911       ranges[++rp].setRange(highest+1, max_jint, default_dest, NullTableIndex, cnt);
 912     }
 913   }
 914   assert(rp &lt; len+2, &quot;not too many ranges&quot;);
 915 
 916   if (trim_ranges) {
 917     merge_ranges(ranges, rp);
 918   }
 919 
 920   // Safepoint in case if backward branch observed
 921   if( makes_backward_branch &amp;&amp; UseLoopSafepoints )
 922     add_safepoint();
 923 
 924   jump_switch_ranges(lookup, &amp;ranges[0], &amp;ranges[rp]);
 925 }
 926 
 927 
 928 //------------------------------do_lookupswitch--------------------------------
 929 void Parse::do_lookupswitch() {
 930   Node *lookup = pop();         // lookup value
 931   // Get information about lookupswitch
 932   int default_dest = iter().get_dest_table(0);
 933   int len          = iter().get_int_table(1);
 934 
 935   if (len &lt; 1) {    // If this is a backward branch, add safepoint
 936     maybe_add_safepoint(default_dest);
 937     merge(default_dest);
 938     return;
 939   }
 940 
 941   ciMethodData* methodData = method()-&gt;method_data();
 942   ciMultiBranchData* profile = NULL;
 943   if (methodData-&gt;is_mature() &amp;&amp; UseSwitchProfiling) {
 944     ciProfileData* data = methodData-&gt;bci_to_data(bci());
 945     if (data != NULL &amp;&amp; data-&gt;is_MultiBranchData()) {
 946       profile = (ciMultiBranchData*)data;
 947     }
 948   }
 949   bool trim_ranges = !method_data_update() &amp;&amp; !C-&gt;too_many_traps(method(), bci(), Deoptimization::Reason_unstable_if);
 950 
 951   // generate decision tree, using trichotomy when possible
 952   jint* table = NEW_RESOURCE_ARRAY(jint, len*3);
 953   {
 954     for (int j = 0; j &lt; len; j++) {
 955       table[3*j+0] = iter().get_int_table(2+2*j);
 956       table[3*j+1] = iter().get_dest_table(2+2*j+1);
 957       table[3*j+2] = profile == NULL ? 1 : profile-&gt;count_at(j);
 958     }
 959     qsort(table, len, 3*sizeof(table[0]), jint_cmp);
 960   }
 961 
 962   float defaults = 0;
 963   jint prev = min_jint;
 964   for (int j = 0; j &lt; len; j++) {
 965     jint match_int = table[3*j+0];
 966     if (match_int != prev) {
 967       defaults += (float)match_int - prev;
 968     }
 969     prev = match_int+1;
 970   }
 971   if (prev-1 != max_jint) {
 972     defaults += (float)max_jint - prev + 1;
 973   }
 974   float default_cnt = 1;
 975   if (profile != NULL) {
 976     default_cnt = profile-&gt;default_count()/defaults;
 977   }
 978 
 979   int rnum = len*2+1;
 980   bool makes_backward_branch = false;
 981   SwitchRange* ranges = NEW_RESOURCE_ARRAY(SwitchRange, rnum);
 982   int rp = -1;
 983   for (int j = 0; j &lt; len; j++) {
 984     jint match_int   = table[3*j+0];
 985     int  dest        = table[3*j+1];
 986     int  cnt         = table[3*j+2];
 987     int  next_lo     = rp &lt; 0 ? min_jint : ranges[rp].hi()+1;
 988     int  table_index = method_data_update() ? j : NullTableIndex;
 989     makes_backward_branch |= (dest &lt;= bci());
 990     float c = default_cnt * ((float)match_int - next_lo);
 991     if (match_int != next_lo &amp;&amp; (rp &lt; 0 || !ranges[rp].adjoinRange(next_lo, match_int-1, default_dest, NullTableIndex, c, trim_ranges))) {
 992       assert(default_dest != never_reached, &quot;sentinel value for dead destinations&quot;);
 993       ranges[++rp].setRange(next_lo, match_int-1, default_dest, NullTableIndex, c);
 994     }
 995     if (rp &lt; 0 || !ranges[rp].adjoin(match_int, dest, table_index, cnt, trim_ranges)) {
 996       assert(dest != never_reached, &quot;sentinel value for dead destinations&quot;);
 997       ranges[++rp].set(match_int, dest, table_index, cnt);
 998     }
 999   }
1000   jint highest = table[3*(len-1)];
1001   assert(ranges[rp].hi() == highest, &quot;&quot;);
1002   if (highest != max_jint &amp;&amp;
1003       !ranges[rp].adjoinRange(highest+1, max_jint, default_dest, NullTableIndex, default_cnt * ((float)max_jint - highest), trim_ranges)) {
1004     ranges[++rp].setRange(highest+1, max_jint, default_dest, NullTableIndex, default_cnt * ((float)max_jint - highest));
1005   }
1006   assert(rp &lt; rnum, &quot;not too many ranges&quot;);
1007 
1008   if (trim_ranges) {
1009     merge_ranges(ranges, rp);
1010   }
1011 
1012   // Safepoint in case backward branch observed
1013   if (makes_backward_branch &amp;&amp; UseLoopSafepoints)
1014     add_safepoint();
1015 
1016   jump_switch_ranges(lookup, &amp;ranges[0], &amp;ranges[rp]);
1017 }
1018 
1019 static float if_prob(float taken_cnt, float total_cnt) {
1020   assert(taken_cnt &lt;= total_cnt, &quot;&quot;);
1021   if (total_cnt == 0) {
1022     return PROB_FAIR;
1023   }
1024   float p = taken_cnt / total_cnt;
1025   return clamp(p, PROB_MIN, PROB_MAX);
1026 }
1027 
1028 static float if_cnt(float cnt) {
1029   if (cnt == 0) {
1030     return COUNT_UNKNOWN;
1031   }
1032   return cnt;
1033 }
1034 
1035 static float sum_of_cnts(SwitchRange *lo, SwitchRange *hi) {
1036   float total_cnt = 0;
1037   for (SwitchRange* sr = lo; sr &lt;= hi; sr++) {
1038     total_cnt += sr-&gt;cnt();
1039   }
1040   return total_cnt;
1041 }
1042 
1043 class SwitchRanges : public ResourceObj {
1044 public:
1045   SwitchRange* _lo;
1046   SwitchRange* _hi;
1047   SwitchRange* _mid;
1048   float _cost;
1049 
1050   enum {
1051     Start,
1052     LeftDone,
1053     RightDone,
1054     Done
1055   } _state;
1056 
1057   SwitchRanges(SwitchRange *lo, SwitchRange *hi)
1058     : _lo(lo), _hi(hi), _mid(NULL),
1059       _cost(0), _state(Start) {
1060   }
1061 
1062   SwitchRanges()
1063     : _lo(NULL), _hi(NULL), _mid(NULL),
1064       _cost(0), _state(Start) {}
1065 };
1066 
1067 // Estimate cost of performing a binary search on lo..hi
1068 static float compute_tree_cost(SwitchRange *lo, SwitchRange *hi, float total_cnt) {
1069   GrowableArray&lt;SwitchRanges&gt; tree;
1070   SwitchRanges root(lo, hi);
1071   tree.push(root);
1072 
1073   float cost = 0;
1074   do {
1075     SwitchRanges&amp; r = *tree.adr_at(tree.length()-1);
1076     if (r._hi != r._lo) {
1077       if (r._mid == NULL) {
1078         float r_cnt = sum_of_cnts(r._lo, r._hi);
1079 
1080         if (r_cnt == 0) {
1081           tree.pop();
1082           cost = 0;
1083           continue;
1084         }
1085 
1086         SwitchRange* mid = NULL;
1087         mid = r._lo;
1088         for (float cnt = 0; ; ) {
1089           assert(mid &lt;= r._hi, &quot;out of bounds&quot;);
1090           cnt += mid-&gt;cnt();
1091           if (cnt &gt; r_cnt / 2) {
1092             break;
1093           }
1094           mid++;
1095         }
1096         assert(mid &lt;= r._hi, &quot;out of bounds&quot;);
1097         r._mid = mid;
1098         r._cost = r_cnt / total_cnt;
1099       }
1100       r._cost += cost;
1101       if (r._state &lt; SwitchRanges::LeftDone &amp;&amp; r._mid &gt; r._lo) {
1102         cost = 0;
1103         r._state = SwitchRanges::LeftDone;
1104         tree.push(SwitchRanges(r._lo, r._mid-1));
1105       } else if (r._state &lt; SwitchRanges::RightDone) {
1106         cost = 0;
1107         r._state = SwitchRanges::RightDone;
1108         tree.push(SwitchRanges(r._mid == r._lo ? r._mid+1 : r._mid, r._hi));
1109       } else {
1110         tree.pop();
1111         cost = r._cost;
1112       }
1113     } else {
1114       tree.pop();
1115       cost = r._cost;
1116     }
1117   } while (tree.length() &gt; 0);
1118 
1119 
1120   return cost;
1121 }
1122 
1123 // It sometimes pays off to test most common ranges before the binary search
1124 void Parse::linear_search_switch_ranges(Node* key_val, SwitchRange*&amp; lo, SwitchRange*&amp; hi) {
1125   uint nr = hi - lo + 1;
1126   float total_cnt = sum_of_cnts(lo, hi);
1127 
1128   float min = compute_tree_cost(lo, hi, total_cnt);
1129   float extra = 1;
1130   float sub = 0;
1131 
1132   SwitchRange* array1 = lo;
1133   SwitchRange* array2 = NEW_RESOURCE_ARRAY(SwitchRange, nr);
1134 
1135   SwitchRange* ranges = NULL;
1136 
1137   while (nr &gt;= 2) {
1138     assert(lo == array1 || lo == array2, &quot;one the 2 already allocated arrays&quot;);
1139     ranges = (lo == array1) ? array2 : array1;
1140 
1141     // Find highest frequency range
1142     SwitchRange* candidate = lo;
1143     for (SwitchRange* sr = lo+1; sr &lt;= hi; sr++) {
1144       if (sr-&gt;cnt() &gt; candidate-&gt;cnt()) {
1145         candidate = sr;
1146       }
1147     }
1148     SwitchRange most_freq = *candidate;
1149     if (most_freq.cnt() == 0) {
1150       break;
1151     }
1152 
1153     // Copy remaining ranges into another array
1154     int shift = 0;
1155     for (uint i = 0; i &lt; nr; i++) {
1156       SwitchRange* sr = &amp;lo[i];
1157       if (sr != candidate) {
1158         ranges[i-shift] = *sr;
1159       } else {
1160         shift++;
1161         if (i &gt; 0 &amp;&amp; i &lt; nr-1) {
1162           SwitchRange prev = lo[i-1];
1163           prev.setRange(prev.lo(), sr-&gt;hi(), prev.dest(), prev.table_index(), prev.cnt());
1164           if (prev.adjoin(lo[i+1])) {
1165             shift++;
1166             i++;
1167           }
1168           ranges[i-shift] = prev;
1169         }
1170       }
1171     }
1172     nr -= shift;
1173 
1174     // Evaluate cost of testing the most common range and performing a
1175     // binary search on the other ranges
1176     float cost = extra + compute_tree_cost(&amp;ranges[0], &amp;ranges[nr-1], total_cnt);
1177     if (cost &gt;= min) {
1178       break;
1179     }
1180     // swap arrays
1181     lo = &amp;ranges[0];
1182     hi = &amp;ranges[nr-1];
1183 
1184     // It pays off: emit the test for the most common range
1185     assert(most_freq.cnt() &gt; 0, &quot;must be taken&quot;);
1186     Node* val = _gvn.transform(new SubINode(key_val, _gvn.intcon(most_freq.lo())));
1187     Node* cmp = _gvn.transform(new CmpUNode(val, _gvn.intcon(most_freq.hi() - most_freq.lo())));
1188     Node* tst = _gvn.transform(new BoolNode(cmp, BoolTest::le));
1189     IfNode* iff = create_and_map_if(control(), tst, if_prob(most_freq.cnt(), total_cnt), if_cnt(most_freq.cnt()));
1190     jump_if_true_fork(iff, most_freq.dest(), most_freq.table_index(), false);
1191 
1192     sub += most_freq.cnt() / total_cnt;
1193     extra += 1 - sub;
1194     min = cost;
1195   }
1196 }
1197 
1198 //----------------------------create_jump_tables-------------------------------
1199 bool Parse::create_jump_tables(Node* key_val, SwitchRange* lo, SwitchRange* hi) {
1200   // Are jumptables enabled
1201   if (!UseJumpTables)  return false;
1202 
1203   // Are jumptables supported
1204   if (!Matcher::has_match_rule(Op_Jump))  return false;
1205 
1206   // Don&#39;t make jump table if profiling
1207   if (method_data_update())  return false;
1208 
1209   bool trim_ranges = !C-&gt;too_many_traps(method(), bci(), Deoptimization::Reason_unstable_if);
1210 
1211   // Decide if a guard is needed to lop off big ranges at either (or
1212   // both) end(s) of the input set. We&#39;ll call this the default target
1213   // even though we can&#39;t be sure that it is the true &quot;default&quot;.
1214 
1215   bool needs_guard = false;
1216   int default_dest;
1217   int64_t total_outlier_size = 0;
1218   int64_t hi_size = ((int64_t)hi-&gt;hi()) - ((int64_t)hi-&gt;lo()) + 1;
1219   int64_t lo_size = ((int64_t)lo-&gt;hi()) - ((int64_t)lo-&gt;lo()) + 1;
1220 
1221   if (lo-&gt;dest() == hi-&gt;dest()) {
1222     total_outlier_size = hi_size + lo_size;
1223     default_dest = lo-&gt;dest();
1224   } else if (lo_size &gt; hi_size) {
1225     total_outlier_size = lo_size;
1226     default_dest = lo-&gt;dest();
1227   } else {
1228     total_outlier_size = hi_size;
1229     default_dest = hi-&gt;dest();
1230   }
1231 
1232   float total = sum_of_cnts(lo, hi);
1233   float cost = compute_tree_cost(lo, hi, total);
1234 
1235   // If a guard test will eliminate very sparse end ranges, then
1236   // it is worth the cost of an extra jump.
1237   float trimmed_cnt = 0;
1238   if (total_outlier_size &gt; (MaxJumpTableSparseness * 4)) {
1239     needs_guard = true;
1240     if (default_dest == lo-&gt;dest()) {
1241       trimmed_cnt += lo-&gt;cnt();
1242       lo++;
1243     }
1244     if (default_dest == hi-&gt;dest()) {
1245       trimmed_cnt += hi-&gt;cnt();
1246       hi--;
1247     }
1248   }
1249 
1250   // Find the total number of cases and ranges
1251   int64_t num_cases = ((int64_t)hi-&gt;hi()) - ((int64_t)lo-&gt;lo()) + 1;
1252   int num_range = hi - lo + 1;
1253 
1254   // Don&#39;t create table if: too large, too small, or too sparse.
1255   if (num_cases &gt; MaxJumpTableSize)
1256     return false;
1257   if (UseSwitchProfiling) {
1258     // MinJumpTableSize is set so with a well balanced binary tree,
1259     // when the number of ranges is MinJumpTableSize, it&#39;s cheaper to
1260     // go through a JumpNode that a tree of IfNodes. Average cost of a
1261     // tree of IfNodes with MinJumpTableSize is
1262     // log2f(MinJumpTableSize) comparisons. So if the cost computed
1263     // from profile data is less than log2f(MinJumpTableSize) then
1264     // going with the binary search is cheaper.
1265     if (cost &lt; log2f(MinJumpTableSize)) {
1266       return false;
1267     }
1268   } else {
1269     if (num_cases &lt; MinJumpTableSize)
1270       return false;
1271   }
1272   if (num_cases &gt; (MaxJumpTableSparseness * num_range))
1273     return false;
1274 
1275   // Normalize table lookups to zero
1276   int lowval = lo-&gt;lo();
1277   key_val = _gvn.transform( new SubINode(key_val, _gvn.intcon(lowval)) );
1278 
1279   // Generate a guard to protect against input keyvals that aren&#39;t
1280   // in the switch domain.
1281   if (needs_guard) {
1282     Node*   size = _gvn.intcon(num_cases);
1283     Node*   cmp = _gvn.transform(new CmpUNode(key_val, size));
1284     Node*   tst = _gvn.transform(new BoolNode(cmp, BoolTest::ge));
1285     IfNode* iff = create_and_map_if(control(), tst, if_prob(trimmed_cnt, total), if_cnt(trimmed_cnt));
1286     jump_if_true_fork(iff, default_dest, NullTableIndex, trim_ranges &amp;&amp; trimmed_cnt == 0);
1287 
1288     total -= trimmed_cnt;
1289   }
1290 
1291   // Create an ideal node JumpTable that has projections
1292   // of all possible ranges for a switch statement
1293   // The key_val input must be converted to a pointer offset and scaled.
1294   // Compare Parse::array_addressing above.
1295 
1296   // Clean the 32-bit int into a real 64-bit offset.
1297   // Otherwise, the jint value 0 might turn into an offset of 0x0800000000.
1298   const TypeInt* ikeytype = TypeInt::make(0, num_cases, Type::WidenMin);
1299   // Make I2L conversion control dependent to prevent it from
1300   // floating above the range check during loop optimizations.
1301   key_val = C-&gt;conv_I2X_index(&amp;_gvn, key_val, ikeytype, control());
1302 
1303   // Shift the value by wordsize so we have an index into the table, rather
1304   // than a switch value
1305   Node *shiftWord = _gvn.MakeConX(wordSize);
1306   key_val = _gvn.transform( new MulXNode( key_val, shiftWord));
1307 
1308   // Create the JumpNode
1309   Arena* arena = C-&gt;comp_arena();
1310   float* probs = (float*)arena-&gt;Amalloc(sizeof(float)*num_cases);
1311   int i = 0;
1312   if (total == 0) {
1313     for (SwitchRange* r = lo; r &lt;= hi; r++) {
1314       for (int64_t j = r-&gt;lo(); j &lt;= r-&gt;hi(); j++, i++) {
1315         probs[i] = 1.0F / num_cases;
1316       }
1317     }
1318   } else {
1319     for (SwitchRange* r = lo; r &lt;= hi; r++) {
1320       float prob = r-&gt;cnt()/total;
1321       for (int64_t j = r-&gt;lo(); j &lt;= r-&gt;hi(); j++, i++) {
1322         probs[i] = prob / (r-&gt;hi() - r-&gt;lo() + 1);
1323       }
1324     }
1325   }
1326 
1327   ciMethodData* methodData = method()-&gt;method_data();
1328   ciMultiBranchData* profile = NULL;
1329   if (methodData-&gt;is_mature()) {
1330     ciProfileData* data = methodData-&gt;bci_to_data(bci());
1331     if (data != NULL &amp;&amp; data-&gt;is_MultiBranchData()) {
1332       profile = (ciMultiBranchData*)data;
1333     }
1334   }
1335 
1336   Node* jtn = _gvn.transform(new JumpNode(control(), key_val, num_cases, probs, profile == NULL ? COUNT_UNKNOWN : total));
1337 
1338   // These are the switch destinations hanging off the jumpnode
1339   i = 0;
1340   for (SwitchRange* r = lo; r &lt;= hi; r++) {
1341     for (int64_t j = r-&gt;lo(); j &lt;= r-&gt;hi(); j++, i++) {
1342       Node* input = _gvn.transform(new JumpProjNode(jtn, i, r-&gt;dest(), (int)(j - lowval)));
1343       {
1344         PreserveJVMState pjvms(this);
1345         set_control(input);
1346         jump_if_always_fork(r-&gt;dest(), r-&gt;table_index(), trim_ranges &amp;&amp; r-&gt;cnt() == 0);
1347       }
1348     }
1349   }
1350   assert(i == num_cases, &quot;miscount of cases&quot;);
1351   stop_and_kill_map();  // no more uses for this JVMS
1352   return true;
1353 }
1354 
1355 //----------------------------jump_switch_ranges-------------------------------
1356 void Parse::jump_switch_ranges(Node* key_val, SwitchRange *lo, SwitchRange *hi, int switch_depth) {
1357   Block* switch_block = block();
1358   bool trim_ranges = !method_data_update() &amp;&amp; !C-&gt;too_many_traps(method(), bci(), Deoptimization::Reason_unstable_if);
1359 
1360   if (switch_depth == 0) {
1361     // Do special processing for the top-level call.
1362     assert(lo-&gt;lo() == min_jint, &quot;initial range must exhaust Type::INT&quot;);
1363     assert(hi-&gt;hi() == max_jint, &quot;initial range must exhaust Type::INT&quot;);
1364 
1365     // Decrement pred-numbers for the unique set of nodes.
1366 #ifdef ASSERT
1367     if (!trim_ranges) {
1368       // Ensure that the block&#39;s successors are a (duplicate-free) set.
1369       int successors_counted = 0;  // block occurrences in [hi..lo]
1370       int unique_successors = switch_block-&gt;num_successors();
1371       for (int i = 0; i &lt; unique_successors; i++) {
1372         Block* target = switch_block-&gt;successor_at(i);
1373 
1374         // Check that the set of successors is the same in both places.
1375         int successors_found = 0;
1376         for (SwitchRange* p = lo; p &lt;= hi; p++) {
1377           if (p-&gt;dest() == target-&gt;start())  successors_found++;
1378         }
1379         assert(successors_found &gt; 0, &quot;successor must be known&quot;);
1380         successors_counted += successors_found;
1381       }
1382       assert(successors_counted == (hi-lo)+1, &quot;no unexpected successors&quot;);
1383     }
1384 #endif
1385 
1386     // Maybe prune the inputs, based on the type of key_val.
1387     jint min_val = min_jint;
1388     jint max_val = max_jint;
1389     const TypeInt* ti = key_val-&gt;bottom_type()-&gt;isa_int();
1390     if (ti != NULL) {
1391       min_val = ti-&gt;_lo;
1392       max_val = ti-&gt;_hi;
1393       assert(min_val &lt;= max_val, &quot;invalid int type&quot;);
1394     }
1395     while (lo-&gt;hi() &lt; min_val) {
1396       lo++;
1397     }
1398     if (lo-&gt;lo() &lt; min_val)  {
1399       lo-&gt;setRange(min_val, lo-&gt;hi(), lo-&gt;dest(), lo-&gt;table_index(), lo-&gt;cnt());
1400     }
1401     while (hi-&gt;lo() &gt; max_val) {
1402       hi--;
1403     }
1404     if (hi-&gt;hi() &gt; max_val) {
1405       hi-&gt;setRange(hi-&gt;lo(), max_val, hi-&gt;dest(), hi-&gt;table_index(), hi-&gt;cnt());
1406     }
1407 
1408     linear_search_switch_ranges(key_val, lo, hi);
1409   }
1410 
1411 #ifndef PRODUCT
1412   if (switch_depth == 0) {
1413     _max_switch_depth = 0;
1414     _est_switch_depth = log2_intptr((hi-lo+1)-1)+1;
1415   }
1416 #endif
1417 
1418   assert(lo &lt;= hi, &quot;must be a non-empty set of ranges&quot;);
1419   if (lo == hi) {
1420     jump_if_always_fork(lo-&gt;dest(), lo-&gt;table_index(), trim_ranges &amp;&amp; lo-&gt;cnt() == 0);
1421   } else {
1422     assert(lo-&gt;hi() == (lo+1)-&gt;lo()-1, &quot;contiguous ranges&quot;);
1423     assert(hi-&gt;lo() == (hi-1)-&gt;hi()+1, &quot;contiguous ranges&quot;);
1424 
1425     if (create_jump_tables(key_val, lo, hi)) return;
1426 
1427     SwitchRange* mid = NULL;
1428     float total_cnt = sum_of_cnts(lo, hi);
1429 
1430     int nr = hi - lo + 1;
1431     if (UseSwitchProfiling) {
1432       // Don&#39;t keep the binary search tree balanced: pick up mid point
1433       // that split frequencies in half.
1434       float cnt = 0;
1435       for (SwitchRange* sr = lo; sr &lt;= hi; sr++) {
1436         cnt += sr-&gt;cnt();
1437         if (cnt &gt;= total_cnt / 2) {
1438           mid = sr;
1439           break;
1440         }
1441       }
1442     } else {
1443       mid = lo + nr/2;
1444 
1445       // if there is an easy choice, pivot at a singleton:
1446       if (nr &gt; 3 &amp;&amp; !mid-&gt;is_singleton() &amp;&amp; (mid-1)-&gt;is_singleton())  mid--;
1447 
1448       assert(lo &lt; mid &amp;&amp; mid &lt;= hi, &quot;good pivot choice&quot;);
1449       assert(nr != 2 || mid == hi,   &quot;should pick higher of 2&quot;);
1450       assert(nr != 3 || mid == hi-1, &quot;should pick middle of 3&quot;);
1451     }
1452 
1453 
1454     Node *test_val = _gvn.intcon(mid == lo ? mid-&gt;hi() : mid-&gt;lo());
1455 
1456     if (mid-&gt;is_singleton()) {
1457       IfNode *iff_ne = jump_if_fork_int(key_val, test_val, BoolTest::ne, 1-if_prob(mid-&gt;cnt(), total_cnt), if_cnt(mid-&gt;cnt()));
1458       jump_if_false_fork(iff_ne, mid-&gt;dest(), mid-&gt;table_index(), trim_ranges &amp;&amp; mid-&gt;cnt() == 0);
1459 
1460       // Special Case:  If there are exactly three ranges, and the high
1461       // and low range each go to the same place, omit the &quot;gt&quot; test,
1462       // since it will not discriminate anything.
1463       bool eq_test_only = (hi == lo+2 &amp;&amp; hi-&gt;dest() == lo-&gt;dest() &amp;&amp; mid == hi-1) || mid == lo;
1464 
1465       // if there is a higher range, test for it and process it:
1466       if (mid &lt; hi &amp;&amp; !eq_test_only) {
1467         // two comparisons of same values--should enable 1 test for 2 branches
1468         // Use BoolTest::lt instead of BoolTest::gt
1469         float cnt = sum_of_cnts(lo, mid-1);
1470         IfNode *iff_lt  = jump_if_fork_int(key_val, test_val, BoolTest::lt, if_prob(cnt, total_cnt), if_cnt(cnt));
1471         Node   *iftrue  = _gvn.transform( new IfTrueNode(iff_lt) );
1472         Node   *iffalse = _gvn.transform( new IfFalseNode(iff_lt) );
1473         { PreserveJVMState pjvms(this);
1474           set_control(iffalse);
1475           jump_switch_ranges(key_val, mid+1, hi, switch_depth+1);
1476         }
1477         set_control(iftrue);
1478       }
1479 
1480     } else {
1481       // mid is a range, not a singleton, so treat mid..hi as a unit
1482       float cnt = sum_of_cnts(mid == lo ? mid+1 : mid, hi);
1483       IfNode *iff_ge = jump_if_fork_int(key_val, test_val, mid == lo ? BoolTest::gt : BoolTest::ge, if_prob(cnt, total_cnt), if_cnt(cnt));
1484 
1485       // if there is a higher range, test for it and process it:
1486       if (mid == hi) {
1487         jump_if_true_fork(iff_ge, mid-&gt;dest(), mid-&gt;table_index(), trim_ranges &amp;&amp; cnt == 0);
1488       } else {
1489         Node *iftrue  = _gvn.transform( new IfTrueNode(iff_ge) );
1490         Node *iffalse = _gvn.transform( new IfFalseNode(iff_ge) );
1491         { PreserveJVMState pjvms(this);
1492           set_control(iftrue);
1493           jump_switch_ranges(key_val, mid == lo ? mid+1 : mid, hi, switch_depth+1);
1494         }
1495         set_control(iffalse);
1496       }
1497     }
1498 
1499     // in any case, process the lower range
1500     if (mid == lo) {
1501       if (mid-&gt;is_singleton()) {
1502         jump_switch_ranges(key_val, lo+1, hi, switch_depth+1);
1503       } else {
1504         jump_if_always_fork(lo-&gt;dest(), lo-&gt;table_index(), trim_ranges &amp;&amp; lo-&gt;cnt() == 0);
1505       }
1506     } else {
1507       jump_switch_ranges(key_val, lo, mid-1, switch_depth+1);
1508     }
1509   }
1510 
1511   // Decrease pred_count for each successor after all is done.
1512   if (switch_depth == 0) {
1513     int unique_successors = switch_block-&gt;num_successors();
1514     for (int i = 0; i &lt; unique_successors; i++) {
1515       Block* target = switch_block-&gt;successor_at(i);
1516       // Throw away the pre-allocated path for each unique successor.
1517       target-&gt;next_path_num();
1518     }
1519   }
1520 
1521 #ifndef PRODUCT
1522   _max_switch_depth = MAX2(switch_depth, _max_switch_depth);
1523   if (TraceOptoParse &amp;&amp; Verbose &amp;&amp; WizardMode &amp;&amp; switch_depth == 0) {
1524     SwitchRange* r;
1525     int nsing = 0;
1526     for( r = lo; r &lt;= hi; r++ ) {
1527       if( r-&gt;is_singleton() )  nsing++;
1528     }
1529     tty-&gt;print(&quot;&gt;&gt;&gt; &quot;);
1530     _method-&gt;print_short_name();
1531     tty-&gt;print_cr(&quot; switch decision tree&quot;);
1532     tty-&gt;print_cr(&quot;    %d ranges (%d singletons), max_depth=%d, est_depth=%d&quot;,
1533                   (int) (hi-lo+1), nsing, _max_switch_depth, _est_switch_depth);
1534     if (_max_switch_depth &gt; _est_switch_depth) {
1535       tty-&gt;print_cr(&quot;******** BAD SWITCH DEPTH ********&quot;);
1536     }
1537     tty-&gt;print(&quot;   &quot;);
1538     for( r = lo; r &lt;= hi; r++ ) {
1539       r-&gt;print();
1540     }
1541     tty-&gt;cr();
1542   }
1543 #endif
1544 }
1545 
1546 void Parse::modf() {
1547   Node *f2 = pop();
1548   Node *f1 = pop();
1549   Node* c = make_runtime_call(RC_LEAF, OptoRuntime::modf_Type(),
1550                               CAST_FROM_FN_PTR(address, SharedRuntime::frem),
1551                               &quot;frem&quot;, NULL, //no memory effects
1552                               f1, f2);
1553   Node* res = _gvn.transform(new ProjNode(c, TypeFunc::Parms + 0));
1554 
1555   push(res);
1556 }
1557 
1558 void Parse::modd() {
1559   Node *d2 = pop_pair();
1560   Node *d1 = pop_pair();
1561   Node* c = make_runtime_call(RC_LEAF, OptoRuntime::Math_DD_D_Type(),
1562                               CAST_FROM_FN_PTR(address, SharedRuntime::drem),
1563                               &quot;drem&quot;, NULL, //no memory effects
1564                               d1, top(), d2, top());
1565   Node* res_d   = _gvn.transform(new ProjNode(c, TypeFunc::Parms + 0));
1566 
1567 #ifdef ASSERT
1568   Node* res_top = _gvn.transform(new ProjNode(c, TypeFunc::Parms + 1));
1569   assert(res_top == top(), &quot;second value must be top&quot;);
1570 #endif
1571 
1572   push_pair(res_d);
1573 }
1574 
1575 void Parse::l2f() {
1576   Node* f2 = pop();
1577   Node* f1 = pop();
1578   Node* c = make_runtime_call(RC_LEAF, OptoRuntime::l2f_Type(),
1579                               CAST_FROM_FN_PTR(address, SharedRuntime::l2f),
1580                               &quot;l2f&quot;, NULL, //no memory effects
1581                               f1, f2);
1582   Node* res = _gvn.transform(new ProjNode(c, TypeFunc::Parms + 0));
1583 
1584   push(res);
1585 }
1586 
1587 void Parse::do_irem() {
1588   // Must keep both values on the expression-stack during null-check
1589   zero_check_int(peek());
1590   // Compile-time detect of null-exception?
1591   if (stopped())  return;
1592 
1593   Node* b = pop();
1594   Node* a = pop();
1595 
1596   const Type *t = _gvn.type(b);
1597   if (t != Type::TOP) {
1598     const TypeInt *ti = t-&gt;is_int();
1599     if (ti-&gt;is_con()) {
1600       int divisor = ti-&gt;get_con();
1601       // check for positive power of 2
1602       if (divisor &gt; 0 &amp;&amp;
1603           (divisor &amp; ~(divisor-1)) == divisor) {
1604         // yes !
1605         Node *mask = _gvn.intcon((divisor - 1));
1606         // Sigh, must handle negative dividends
1607         Node *zero = _gvn.intcon(0);
1608         IfNode *ifff = jump_if_fork_int(a, zero, BoolTest::lt, PROB_FAIR, COUNT_UNKNOWN);
1609         Node *iff = _gvn.transform( new IfFalseNode(ifff) );
1610         Node *ift = _gvn.transform( new IfTrueNode (ifff) );
1611         Node *reg = jump_if_join(ift, iff);
1612         Node *phi = PhiNode::make(reg, NULL, TypeInt::INT);
1613         // Negative path; negate/and/negate
1614         Node *neg = _gvn.transform( new SubINode(zero, a) );
1615         Node *andn= _gvn.transform( new AndINode(neg, mask) );
1616         Node *negn= _gvn.transform( new SubINode(zero, andn) );
1617         phi-&gt;init_req(1, negn);
1618         // Fast positive case
1619         Node *andx = _gvn.transform( new AndINode(a, mask) );
1620         phi-&gt;init_req(2, andx);
1621         // Push the merge
1622         push( _gvn.transform(phi) );
1623         return;
1624       }
1625     }
1626   }
1627   // Default case
1628   push( _gvn.transform( new ModINode(control(),a,b) ) );
1629 }
1630 
1631 // Handle jsr and jsr_w bytecode
1632 void Parse::do_jsr() {
1633   assert(bc() == Bytecodes::_jsr || bc() == Bytecodes::_jsr_w, &quot;wrong bytecode&quot;);
1634 
1635   // Store information about current state, tagged with new _jsr_bci
1636   int return_bci = iter().next_bci();
1637   int jsr_bci    = (bc() == Bytecodes::_jsr) ? iter().get_dest() : iter().get_far_dest();
1638 
1639   // Update method data
1640   profile_taken_branch(jsr_bci);
1641 
1642   // The way we do things now, there is only one successor block
1643   // for the jsr, because the target code is cloned by ciTypeFlow.
1644   Block* target = successor_for_bci(jsr_bci);
1645 
1646   // What got pushed?
1647   const Type* ret_addr = target-&gt;peek();
1648   assert(ret_addr-&gt;singleton(), &quot;must be a constant (cloned jsr body)&quot;);
1649 
1650   // Effect on jsr on stack
1651   push(_gvn.makecon(ret_addr));
1652 
1653   // Flow to the jsr.
1654   merge(jsr_bci);
1655 }
1656 
1657 // Handle ret bytecode
1658 void Parse::do_ret() {
1659   // Find to whom we return.
1660   assert(block()-&gt;num_successors() == 1, &quot;a ret can only go one place now&quot;);
1661   Block* target = block()-&gt;successor_at(0);
1662   assert(!target-&gt;is_ready(), &quot;our arrival must be expected&quot;);
1663   profile_ret(target-&gt;flow()-&gt;start());
1664   int pnum = target-&gt;next_path_num();
1665   merge_common(target, pnum);
1666 }
1667 
1668 static bool has_injected_profile(BoolTest::mask btest, Node* test, int&amp; taken, int&amp; not_taken) {
1669   if (btest != BoolTest::eq &amp;&amp; btest != BoolTest::ne) {
1670     // Only ::eq and ::ne are supported for profile injection.
1671     return false;
1672   }
1673   if (test-&gt;is_Cmp() &amp;&amp;
1674       test-&gt;in(1)-&gt;Opcode() == Op_ProfileBoolean) {
1675     ProfileBooleanNode* profile = (ProfileBooleanNode*)test-&gt;in(1);
1676     int false_cnt = profile-&gt;false_count();
1677     int  true_cnt = profile-&gt;true_count();
1678 
1679     // Counts matching depends on the actual test operation (::eq or ::ne).
1680     // No need to scale the counts because profile injection was designed
1681     // to feed exact counts into VM.
1682     taken     = (btest == BoolTest::eq) ? false_cnt :  true_cnt;
1683     not_taken = (btest == BoolTest::eq) ?  true_cnt : false_cnt;
1684 
1685     profile-&gt;consume();
1686     return true;
1687   }
1688   return false;
1689 }
1690 //--------------------------dynamic_branch_prediction--------------------------
1691 // Try to gather dynamic branch prediction behavior.  Return a probability
1692 // of the branch being taken and set the &quot;cnt&quot; field.  Returns a -1.0
1693 // if we need to use static prediction for some reason.
1694 float Parse::dynamic_branch_prediction(float &amp;cnt, BoolTest::mask btest, Node* test) {
1695   ResourceMark rm;
1696 
1697   cnt  = COUNT_UNKNOWN;
1698 
1699   int     taken = 0;
1700   int not_taken = 0;
1701 
1702   bool use_mdo = !has_injected_profile(btest, test, taken, not_taken);
1703 
1704   if (use_mdo) {
1705     // Use MethodData information if it is available
1706     // FIXME: free the ProfileData structure
1707     ciMethodData* methodData = method()-&gt;method_data();
1708     if (!methodData-&gt;is_mature())  return PROB_UNKNOWN;
1709     ciProfileData* data = methodData-&gt;bci_to_data(bci());
1710     if (data == NULL) {
1711       return PROB_UNKNOWN;
1712     }
1713     if (!data-&gt;is_JumpData())  return PROB_UNKNOWN;
1714 
1715     // get taken and not taken values
1716     taken = data-&gt;as_JumpData()-&gt;taken();
1717     not_taken = 0;
1718     if (data-&gt;is_BranchData()) {
1719       not_taken = data-&gt;as_BranchData()-&gt;not_taken();
1720     }
1721 
1722     // scale the counts to be commensurate with invocation counts:
1723     taken = method()-&gt;scale_count(taken);
1724     not_taken = method()-&gt;scale_count(not_taken);
1725   }
1726 
1727   // Give up if too few (or too many, in which case the sum will overflow) counts to be meaningful.
1728   // We also check that individual counters are positive first, otherwise the sum can become positive.
1729   if (taken &lt; 0 || not_taken &lt; 0 || taken + not_taken &lt; 40) {
1730     if (C-&gt;log() != NULL) {
1731       C-&gt;log()-&gt;elem(&quot;branch target_bci=&#39;%d&#39; taken=&#39;%d&#39; not_taken=&#39;%d&#39;&quot;, iter().get_dest(), taken, not_taken);
1732     }
1733     return PROB_UNKNOWN;
1734   }
1735 
1736   // Compute frequency that we arrive here
1737   float sum = taken + not_taken;
1738   // Adjust, if this block is a cloned private block but the
1739   // Jump counts are shared.  Taken the private counts for
1740   // just this path instead of the shared counts.
1741   if( block()-&gt;count() &gt; 0 )
1742     sum = block()-&gt;count();
1743   cnt = sum / FreqCountInvocations;
1744 
1745   // Pin probability to sane limits
1746   float prob;
1747   if( !taken )
1748     prob = (0+PROB_MIN) / 2;
1749   else if( !not_taken )
1750     prob = (1+PROB_MAX) / 2;
1751   else {                         // Compute probability of true path
1752     prob = (float)taken / (float)(taken + not_taken);
1753     if (prob &gt; PROB_MAX)  prob = PROB_MAX;
1754     if (prob &lt; PROB_MIN)   prob = PROB_MIN;
1755   }
1756 
1757   assert((cnt &gt; 0.0f) &amp;&amp; (prob &gt; 0.0f),
1758          &quot;Bad frequency assignment in if&quot;);
1759 
1760   if (C-&gt;log() != NULL) {
1761     const char* prob_str = NULL;
1762     if (prob &gt;= PROB_MAX)  prob_str = (prob == PROB_MAX) ? &quot;max&quot; : &quot;always&quot;;
1763     if (prob &lt;= PROB_MIN)  prob_str = (prob == PROB_MIN) ? &quot;min&quot; : &quot;never&quot;;
1764     char prob_str_buf[30];
1765     if (prob_str == NULL) {
1766       jio_snprintf(prob_str_buf, sizeof(prob_str_buf), &quot;%20.2f&quot;, prob);
1767       prob_str = prob_str_buf;
1768     }
1769     C-&gt;log()-&gt;elem(&quot;branch target_bci=&#39;%d&#39; taken=&#39;%d&#39; not_taken=&#39;%d&#39; cnt=&#39;%f&#39; prob=&#39;%s&#39;&quot;,
1770                    iter().get_dest(), taken, not_taken, cnt, prob_str);
1771   }
1772   return prob;
1773 }
1774 
1775 //-----------------------------branch_prediction-------------------------------
1776 float Parse::branch_prediction(float&amp; cnt,
1777                                BoolTest::mask btest,
1778                                int target_bci,
1779                                Node* test) {
1780   float prob = dynamic_branch_prediction(cnt, btest, test);
1781   // If prob is unknown, switch to static prediction
1782   if (prob != PROB_UNKNOWN)  return prob;
1783 
1784   prob = PROB_FAIR;                   // Set default value
1785   if (btest == BoolTest::eq)          // Exactly equal test?
1786     prob = PROB_STATIC_INFREQUENT;    // Assume its relatively infrequent
1787   else if (btest == BoolTest::ne)
1788     prob = PROB_STATIC_FREQUENT;      // Assume its relatively frequent
1789 
1790   // If this is a conditional test guarding a backwards branch,
1791   // assume its a loop-back edge.  Make it a likely taken branch.
1792   if (target_bci &lt; bci()) {
1793     if (is_osr_parse()) {    // Could be a hot OSR&#39;d loop; force deopt
1794       // Since it&#39;s an OSR, we probably have profile data, but since
1795       // branch_prediction returned PROB_UNKNOWN, the counts are too small.
1796       // Let&#39;s make a special check here for completely zero counts.
1797       ciMethodData* methodData = method()-&gt;method_data();
1798       if (!methodData-&gt;is_empty()) {
1799         ciProfileData* data = methodData-&gt;bci_to_data(bci());
1800         // Only stop for truly zero counts, which mean an unknown part
1801         // of the OSR-ed method, and we want to deopt to gather more stats.
1802         // If you have ANY counts, then this loop is simply &#39;cold&#39; relative
1803         // to the OSR loop.
1804         if (data == NULL ||
1805             (data-&gt;as_BranchData()-&gt;taken() +  data-&gt;as_BranchData()-&gt;not_taken() == 0)) {
1806           // This is the only way to return PROB_UNKNOWN:
1807           return PROB_UNKNOWN;
1808         }
1809       }
1810     }
1811     prob = PROB_STATIC_FREQUENT;     // Likely to take backwards branch
1812   }
1813 
1814   assert(prob != PROB_UNKNOWN, &quot;must have some guess at this point&quot;);
1815   return prob;
1816 }
1817 
1818 // The magic constants are chosen so as to match the output of
1819 // branch_prediction() when the profile reports a zero taken count.
1820 // It is important to distinguish zero counts unambiguously, because
1821 // some branches (e.g., _213_javac.Assembler.eliminate) validly produce
1822 // very small but nonzero probabilities, which if confused with zero
1823 // counts would keep the program recompiling indefinitely.
1824 bool Parse::seems_never_taken(float prob) const {
1825   return prob &lt; PROB_MIN;
1826 }
1827 
1828 // True if the comparison seems to be the kind that will not change its
1829 // statistics from true to false.  See comments in adjust_map_after_if.
1830 // This question is only asked along paths which are already
1831 // classifed as untaken (by seems_never_taken), so really,
1832 // if a path is never taken, its controlling comparison is
1833 // already acting in a stable fashion.  If the comparison
1834 // seems stable, we will put an expensive uncommon trap
1835 // on the untaken path.
1836 bool Parse::seems_stable_comparison() const {
1837   if (C-&gt;too_many_traps(method(), bci(), Deoptimization::Reason_unstable_if)) {
1838     return false;
1839   }
1840   return true;
1841 }
1842 
1843 //-------------------------------repush_if_args--------------------------------
1844 // Push arguments of an &quot;if&quot; bytecode back onto the stack by adjusting _sp.
1845 inline int Parse::repush_if_args() {
1846   if (PrintOpto &amp;&amp; WizardMode) {
1847     tty-&gt;print(&quot;defending against excessive implicit null exceptions on %s @%d in &quot;,
1848                Bytecodes::name(iter().cur_bc()), iter().cur_bci());
1849     method()-&gt;print_name(); tty-&gt;cr();
1850   }
1851   int bc_depth = - Bytecodes::depth(iter().cur_bc());
1852   assert(bc_depth == 1 || bc_depth == 2, &quot;only two kinds of branches&quot;);
1853   DEBUG_ONLY(sync_jvms());   // argument(n) requires a synced jvms
1854   assert(argument(0) != NULL, &quot;must exist&quot;);
1855   assert(bc_depth == 1 || argument(1) != NULL, &quot;two must exist&quot;);
1856   inc_sp(bc_depth);
1857   return bc_depth;
1858 }
1859 
1860 //----------------------------------do_ifnull----------------------------------
1861 void Parse::do_ifnull(BoolTest::mask btest, Node *c) {
1862   int target_bci = iter().get_dest();
1863 
1864   Block* branch_block = successor_for_bci(target_bci);
1865   Block* next_block   = successor_for_bci(iter().next_bci());
1866 
1867   float cnt;
1868   float prob = branch_prediction(cnt, btest, target_bci, c);
1869   if (prob == PROB_UNKNOWN) {
1870     // (An earlier version of do_ifnull omitted this trap for OSR methods.)
1871     if (PrintOpto &amp;&amp; Verbose) {
1872       tty-&gt;print_cr(&quot;Never-taken edge stops compilation at bci %d&quot;, bci());
1873     }
1874     repush_if_args(); // to gather stats on loop
1875     // We need to mark this branch as taken so that if we recompile we will
1876     // see that it is possible. In the tiered system the interpreter doesn&#39;t
1877     // do profiling and by the time we get to the lower tier from the interpreter
1878     // the path may be cold again. Make sure it doesn&#39;t look untaken
1879     profile_taken_branch(target_bci, !ProfileInterpreter);
1880     uncommon_trap(Deoptimization::Reason_unreached,
1881                   Deoptimization::Action_reinterpret,
1882                   NULL, &quot;cold&quot;);
1883     if (C-&gt;eliminate_boxing()) {
1884       // Mark the successor blocks as parsed
1885       branch_block-&gt;next_path_num();
1886       next_block-&gt;next_path_num();
1887     }
1888     return;
1889   }
1890 
1891   NOT_PRODUCT(explicit_null_checks_inserted++);
1892 
1893   // Generate real control flow
1894   Node   *tst = _gvn.transform( new BoolNode( c, btest ) );
1895 
1896   // Sanity check the probability value
1897   assert(prob &gt; 0.0f,&quot;Bad probability in Parser&quot;);
1898  // Need xform to put node in hash table
1899   IfNode *iff = create_and_xform_if( control(), tst, prob, cnt );
1900   assert(iff-&gt;_prob &gt; 0.0f,&quot;Optimizer made bad probability in parser&quot;);
1901   // True branch
1902   { PreserveJVMState pjvms(this);
1903     Node* iftrue  = _gvn.transform( new IfTrueNode (iff) );
1904     set_control(iftrue);
1905 
1906     if (stopped()) {            // Path is dead?
1907       NOT_PRODUCT(explicit_null_checks_elided++);
1908       if (C-&gt;eliminate_boxing()) {
1909         // Mark the successor block as parsed
1910         branch_block-&gt;next_path_num();
1911       }
1912     } else {                    // Path is live.
1913       // Update method data
1914       profile_taken_branch(target_bci);
1915       adjust_map_after_if(btest, c, prob, branch_block);
1916       if (!stopped()) {
1917         merge(target_bci);
1918       }
1919     }
1920   }
1921 
1922   // False branch
1923   Node* iffalse = _gvn.transform( new IfFalseNode(iff) );
1924   set_control(iffalse);
1925 
1926   if (stopped()) {              // Path is dead?
1927     NOT_PRODUCT(explicit_null_checks_elided++);
1928     if (C-&gt;eliminate_boxing()) {
1929       // Mark the successor block as parsed
1930       next_block-&gt;next_path_num();
1931     }
1932   } else  {                     // Path is live.
1933     // Update method data
1934     profile_not_taken_branch();
1935     adjust_map_after_if(BoolTest(btest).negate(), c, 1.0-prob, next_block);
1936   }
1937 }
1938 
1939 //------------------------------------do_if------------------------------------
1940 void Parse::do_if(BoolTest::mask btest, Node* c, bool new_path, Node** ctrl_taken) {
1941   int target_bci = iter().get_dest();
1942 
1943   Block* branch_block = successor_for_bci(target_bci);
1944   Block* next_block   = successor_for_bci(iter().next_bci());
1945 
1946   float cnt;
1947   float prob = branch_prediction(cnt, btest, target_bci, c);
1948   float untaken_prob = 1.0 - prob;
1949 
1950   if (prob == PROB_UNKNOWN) {
1951     if (PrintOpto &amp;&amp; Verbose) {
1952       tty-&gt;print_cr(&quot;Never-taken edge stops compilation at bci %d&quot;, bci());
1953     }
1954     repush_if_args(); // to gather stats on loop
1955     // We need to mark this branch as taken so that if we recompile we will
1956     // see that it is possible. In the tiered system the interpreter doesn&#39;t
1957     // do profiling and by the time we get to the lower tier from the interpreter
1958     // the path may be cold again. Make sure it doesn&#39;t look untaken
1959     profile_taken_branch(target_bci, !ProfileInterpreter);
1960     uncommon_trap(Deoptimization::Reason_unreached,
1961                   Deoptimization::Action_reinterpret,
1962                   NULL, &quot;cold&quot;);
1963     if (C-&gt;eliminate_boxing()) {
1964       // Mark the successor blocks as parsed
1965       branch_block-&gt;next_path_num();
1966       next_block-&gt;next_path_num();
1967     }
1968     return;
1969   }
1970 
1971   // Sanity check the probability value
1972   assert(0.0f &lt; prob &amp;&amp; prob &lt; 1.0f,&quot;Bad probability in Parser&quot;);
1973 
1974   bool taken_if_true = true;
1975   // Convert BoolTest to canonical form:
1976   if (!BoolTest(btest).is_canonical()) {
1977     btest         = BoolTest(btest).negate();
1978     taken_if_true = false;
1979     // prob is NOT updated here; it remains the probability of the taken
1980     // path (as opposed to the prob of the path guarded by an &#39;IfTrueNode&#39;).
1981   }
1982   assert(btest != BoolTest::eq, &quot;!= is the only canonical exact test&quot;);
1983 
1984   Node* tst0 = new BoolNode(c, btest);
1985   Node* tst = _gvn.transform(tst0);
1986   BoolTest::mask taken_btest   = BoolTest::illegal;
1987   BoolTest::mask untaken_btest = BoolTest::illegal;
1988 
1989   if (tst-&gt;is_Bool()) {
1990     // Refresh c from the transformed bool node, since it may be
1991     // simpler than the original c.  Also re-canonicalize btest.
1992     // This wins when (Bool ne (Conv2B p) 0) =&gt; (Bool ne (CmpP p NULL)).
1993     // That can arise from statements like: if (x instanceof C) ...
1994     if (tst != tst0) {
1995       // Canonicalize one more time since transform can change it.
1996       btest = tst-&gt;as_Bool()-&gt;_test._test;
1997       if (!BoolTest(btest).is_canonical()) {
1998         // Reverse edges one more time...
1999         tst   = _gvn.transform( tst-&gt;as_Bool()-&gt;negate(&amp;_gvn) );
2000         btest = tst-&gt;as_Bool()-&gt;_test._test;
2001         assert(BoolTest(btest).is_canonical(), &quot;sanity&quot;);
2002         taken_if_true = !taken_if_true;
2003       }
2004       c = tst-&gt;in(1);
2005     }
2006     BoolTest::mask neg_btest = BoolTest(btest).negate();
2007     taken_btest   = taken_if_true ?     btest : neg_btest;
2008     untaken_btest = taken_if_true ? neg_btest :     btest;
2009   }
2010 
2011   // Generate real control flow
2012   float true_prob = (taken_if_true ? prob : untaken_prob);
2013   IfNode* iff = create_and_map_if(control(), tst, true_prob, cnt);
2014   assert(iff-&gt;_prob &gt; 0.0f,&quot;Optimizer made bad probability in parser&quot;);
2015   Node* taken_branch   = new IfTrueNode(iff);
2016   Node* untaken_branch = new IfFalseNode(iff);
2017   if (!taken_if_true) {  // Finish conversion to canonical form
2018     Node* tmp      = taken_branch;
2019     taken_branch   = untaken_branch;
2020     untaken_branch = tmp;
2021   }
2022 
2023   // Branch is taken:
2024   { PreserveJVMState pjvms(this);
2025     taken_branch = _gvn.transform(taken_branch);
2026     set_control(taken_branch);
2027 
2028     if (stopped()) {
2029       if (C-&gt;eliminate_boxing() &amp;&amp; !new_path) {
2030         // Mark the successor block as parsed (if we haven&#39;t created a new path)
2031         branch_block-&gt;next_path_num();
2032       }
2033     } else {
2034       // Update method data
2035       profile_taken_branch(target_bci);
2036       adjust_map_after_if(taken_btest, c, prob, branch_block);
2037       if (!stopped()) {
2038         if (new_path) {
2039           // Merge by using a new path
2040           merge_new_path(target_bci);
2041         } else if (ctrl_taken != NULL) {
2042           // Don&#39;t merge but save taken branch to be wired by caller
2043           *ctrl_taken = control();
2044         } else {
2045           merge(target_bci);
2046         }
2047       }
2048     }
2049   }
2050 
2051   untaken_branch = _gvn.transform(untaken_branch);
2052   set_control(untaken_branch);
2053 
2054   // Branch not taken.
2055   if (stopped() &amp;&amp; ctrl_taken == NULL) {
2056     if (C-&gt;eliminate_boxing()) {
2057       // Mark the successor block as parsed (if caller does not re-wire control flow)
2058       next_block-&gt;next_path_num();
2059     }
2060   } else {
2061     // Update method data
2062     profile_not_taken_branch();
2063     adjust_map_after_if(untaken_btest, c, untaken_prob, next_block);
2064   }
2065 }
2066 
2067 void Parse::do_acmp(BoolTest::mask btest, Node* a, Node* b) {
2068   ciMethod* subst_method = ciEnv::current()-&gt;ValueBootstrapMethods_klass()-&gt;find_method(ciSymbol::isSubstitutable_name(), ciSymbol::object_object_boolean_signature());
2069   // If current method is ValueBootstrapMethods::isSubstitutable(),
2070   // compile the acmp as a regular pointer comparison otherwise we
2071   // could call ValueBootstrapMethods::isSubstitutable() back
2072   if (!EnableValhalla || (method() == subst_method)) {
2073     Node* cmp = CmpP(a, b);
2074     cmp = optimize_cmp_with_klass(cmp);
2075     do_if(btest, cmp);
2076     return;
2077   }
2078 
2079   // Allocate value type operands and re-execute on deoptimization
2080   if (a-&gt;is_ValueType()) {
2081     PreserveReexecuteState preexecs(this);
2082     inc_sp(2);
2083     jvms()-&gt;set_should_reexecute(true);
2084     a = a-&gt;as_ValueType()-&gt;allocate(this)-&gt;get_oop();
2085   }
2086   if (b-&gt;is_ValueType()) {
2087     PreserveReexecuteState preexecs(this);
2088     inc_sp(2);
2089     jvms()-&gt;set_should_reexecute(true);
2090     b = b-&gt;as_ValueType()-&gt;allocate(this)-&gt;get_oop();
2091   }
2092 
2093   // First, do a normal pointer comparison
2094   const TypeOopPtr* ta = _gvn.type(a)-&gt;isa_oopptr();
2095   const TypeOopPtr* tb = _gvn.type(b)-&gt;isa_oopptr();
2096   Node* cmp = CmpP(a, b);
2097   cmp = optimize_cmp_with_klass(cmp);
2098   if (ta == NULL || !ta-&gt;can_be_value_type() ||
2099       tb == NULL || !tb-&gt;can_be_value_type()) {
2100     // This is sufficient, if one of the operands can&#39;t be a value type
2101     do_if(btest, cmp);
2102     return;
2103   }
2104   Node* eq_region = NULL;
2105   if (btest == BoolTest::eq) {
2106     do_if(btest, cmp, true);
2107     if (stopped()) {
2108       return;
2109     }
2110   } else {
2111     assert(btest == BoolTest::ne, &quot;only eq or ne&quot;);
2112     Node* is_not_equal = NULL;
2113     eq_region = new RegionNode(3);
2114     {
2115       PreserveJVMState pjvms(this);
2116       do_if(btest, cmp, false, &amp;is_not_equal);
2117       if (!stopped()) {
2118         eq_region-&gt;init_req(1, control());
2119       }
2120     }
2121     if (is_not_equal == NULL || is_not_equal-&gt;is_top()) {
2122       record_for_igvn(eq_region);
2123       set_control(_gvn.transform(eq_region));
2124       return;
2125     }
2126     set_control(is_not_equal);
2127   }
2128 
2129   // Pointers are not equal, check if first operand is non-null
2130   Node* ne_region = new RegionNode(6);
2131   inc_sp(2);
2132   Node* null_ctl = top();
2133   Node* not_null_a = null_check_oop(a, &amp;null_ctl, !too_many_traps(Deoptimization::Reason_null_check), false, false);
2134   dec_sp(2);
2135   ne_region-&gt;init_req(1, null_ctl);
2136   if (stopped()) {
2137     record_for_igvn(ne_region);
2138     set_control(_gvn.transform(ne_region));
2139     if (btest == BoolTest::ne) {
2140       {
2141         PreserveJVMState pjvms(this);
2142         int target_bci = iter().get_dest();
2143         merge(target_bci);
2144       }
2145       record_for_igvn(eq_region);
2146       set_control(_gvn.transform(eq_region));
2147     }
2148     return;
2149   }
2150 
2151   // First operand is non-null, check if it is a value type
2152   Node* is_value = is_always_locked(not_null_a);
2153   IfNode* is_value_iff = create_and_map_if(control(), is_value, PROB_FAIR, COUNT_UNKNOWN);
2154   Node* not_value = _gvn.transform(new IfFalseNode(is_value_iff));
2155   ne_region-&gt;init_req(2, not_value);
2156   set_control(_gvn.transform(new IfTrueNode(is_value_iff)));
2157 
2158   // The first operand is a value type, check if the second operand is non-null
2159   inc_sp(2);
2160   null_ctl = top();
2161   Node* not_null_b = null_check_oop(b, &amp;null_ctl, !too_many_traps(Deoptimization::Reason_null_check), false, false);
2162   dec_sp(2);
2163   ne_region-&gt;init_req(3, null_ctl);
2164   if (stopped()) {
2165     record_for_igvn(ne_region);
2166     set_control(_gvn.transform(ne_region));
2167     if (btest == BoolTest::ne) {
2168       {
2169         PreserveJVMState pjvms(this);
2170         int target_bci = iter().get_dest();
2171         merge(target_bci);
2172       }
2173       record_for_igvn(eq_region);
2174       set_control(_gvn.transform(eq_region));
2175     }
2176     return;
2177   }
2178 
2179   // Check if both operands are of the same class. We don&#39;t need to clear the array property
2180   // bits in the klass pointer for the cmp because we know that the first operand is a value type.
2181   Node* kls_a = load_object_klass(not_null_a, /* clear_prop_bits = */ false);
2182   Node* kls_b = load_object_klass(not_null_b, /* clear_prop_bits = */ false);
2183   Node* kls_cmp = CmpP(kls_a, kls_b);
2184   Node* kls_bol = _gvn.transform(new BoolNode(kls_cmp, BoolTest::ne));
2185   IfNode* kls_iff = create_and_map_if(control(), kls_bol, PROB_FAIR, COUNT_UNKNOWN);
2186   Node* kls_ne = _gvn.transform(new IfTrueNode(kls_iff));
2187   set_control(_gvn.transform(new IfFalseNode(kls_iff)));
2188   ne_region-&gt;init_req(4, kls_ne);
2189 
2190   if (stopped()) {
2191     record_for_igvn(ne_region);
2192     set_control(_gvn.transform(ne_region));
2193     if (btest == BoolTest::ne) {
2194       {
2195         PreserveJVMState pjvms(this);
2196         int target_bci = iter().get_dest();
2197         merge(target_bci);
2198       }
2199       record_for_igvn(eq_region);
2200       set_control(_gvn.transform(eq_region));
2201     }
2202     return;
2203   }
2204 
2205   // Both operands are values types of the same class, we need to perform a
2206   // substitutability test. Delegate to ValueBootstrapMethods::isSubstitutable().
2207   Node* ne_io_phi = PhiNode::make(ne_region, i_o());
2208   Node* mem = reset_memory();
2209   Node* ne_mem_phi = PhiNode::make(ne_region, mem);
2210 
2211   Node* eq_io_phi = NULL;
2212   Node* eq_mem_phi = NULL;
2213   if (eq_region != NULL) {
2214     eq_io_phi = PhiNode::make(eq_region, i_o());
2215     eq_mem_phi = PhiNode::make(eq_region, mem);
2216   }
2217 
2218   set_all_memory(mem);
2219 
2220   kill_dead_locals();
2221   CallStaticJavaNode *call = new CallStaticJavaNode(C, TypeFunc::make(subst_method), SharedRuntime::get_resolve_static_call_stub(), subst_method, bci());
2222   call-&gt;set_override_symbolic_info(true);
2223   call-&gt;init_req(TypeFunc::Parms, not_null_a);
2224   call-&gt;init_req(TypeFunc::Parms+1, not_null_b);
2225   inc_sp(2);
2226   set_edges_for_java_call(call, false, false);
2227   Node* ret = set_results_for_java_call(call, false, true);
2228   dec_sp(2);
2229 
2230   // Test the return value of ValueBootstrapMethods::isSubstitutable()
2231   Node* subst_cmp = _gvn.transform(new CmpINode(ret, intcon(1)));
2232   Node* ctl = C-&gt;top();
2233   if (btest == BoolTest::eq) {
2234     PreserveJVMState pjvms(this);
2235     do_if(btest, subst_cmp);
2236     if (!stopped()) {
2237       ctl = control();
2238     }
2239   } else {
2240     assert(btest == BoolTest::ne, &quot;only eq or ne&quot;);
2241     PreserveJVMState pjvms(this);
2242     do_if(btest, subst_cmp, false, &amp;ctl);
2243     if (!stopped()) {
2244       eq_region-&gt;init_req(2, control());
2245       eq_io_phi-&gt;init_req(2, i_o());
2246       eq_mem_phi-&gt;init_req(2, reset_memory());
2247     }
2248   }
2249   ne_region-&gt;init_req(5, ctl);
2250   ne_io_phi-&gt;init_req(5, i_o());
2251   ne_mem_phi-&gt;init_req(5, reset_memory());
2252 
2253   record_for_igvn(ne_region);
2254   set_control(_gvn.transform(ne_region));
2255   set_i_o(_gvn.transform(ne_io_phi));
2256   set_all_memory(_gvn.transform(ne_mem_phi));
2257 
2258   if (btest == BoolTest::ne) {
2259     {
2260       PreserveJVMState pjvms(this);
2261       int target_bci = iter().get_dest();
2262       merge(target_bci);
2263     }
2264 
2265     record_for_igvn(eq_region);
2266     set_control(_gvn.transform(eq_region));
2267     set_i_o(_gvn.transform(eq_io_phi));
2268     set_all_memory(_gvn.transform(eq_mem_phi));
2269   }
2270 }
2271 
2272 bool Parse::path_is_suitable_for_uncommon_trap(float prob) const {
2273   // Don&#39;t want to speculate on uncommon traps when running with -Xcomp
2274   if (!UseInterpreter) {
2275     return false;
2276   }
2277   return (seems_never_taken(prob) &amp;&amp; seems_stable_comparison());
2278 }
2279 
2280 void Parse::maybe_add_predicate_after_if(Block* path) {
2281   if (path-&gt;is_SEL_head() &amp;&amp; path-&gt;preds_parsed() == 0) {
2282     // Add predicates at bci of if dominating the loop so traps can be
2283     // recorded on the if&#39;s profile data
2284     int bc_depth = repush_if_args();
2285     add_predicate();
2286     dec_sp(bc_depth);
2287     path-&gt;set_has_predicates();
2288   }
2289 }
2290 
2291 
2292 //----------------------------adjust_map_after_if------------------------------
2293 // Adjust the JVM state to reflect the result of taking this path.
2294 // Basically, it means inspecting the CmpNode controlling this
2295 // branch, seeing how it constrains a tested value, and then
2296 // deciding if it&#39;s worth our while to encode this constraint
2297 // as graph nodes in the current abstract interpretation map.
2298 void Parse::adjust_map_after_if(BoolTest::mask btest, Node* c, float prob, Block* path) {
2299   if (!c-&gt;is_Cmp()) {
2300     maybe_add_predicate_after_if(path);
2301     return;
2302   }
2303 
2304   if (stopped() || btest == BoolTest::illegal) {
2305     return;                             // nothing to do
2306   }
2307 
2308   bool is_fallthrough = (path == successor_for_bci(iter().next_bci()));
2309 
2310   if (path_is_suitable_for_uncommon_trap(prob)) {
2311     repush_if_args();
2312     uncommon_trap(Deoptimization::Reason_unstable_if,
2313                   Deoptimization::Action_reinterpret,
2314                   NULL,
2315                   (is_fallthrough ? &quot;taken always&quot; : &quot;taken never&quot;));
2316     return;
2317   }
2318 
2319   Node* val = c-&gt;in(1);
2320   Node* con = c-&gt;in(2);
2321   const Type* tcon = _gvn.type(con);
2322   const Type* tval = _gvn.type(val);
2323   bool have_con = tcon-&gt;singleton();
2324   if (tval-&gt;singleton()) {
2325     if (!have_con) {
2326       // Swap, so constant is in con.
2327       con  = val;
2328       tcon = tval;
2329       val  = c-&gt;in(2);
2330       tval = _gvn.type(val);
2331       btest = BoolTest(btest).commute();
2332       have_con = true;
2333     } else {
2334       // Do we have two constants?  Then leave well enough alone.
2335       have_con = false;
2336     }
2337   }
2338   if (!have_con) {                        // remaining adjustments need a con
2339     maybe_add_predicate_after_if(path);
2340     return;
2341   }
2342 
2343   sharpen_type_after_if(btest, con, tcon, val, tval);
2344   maybe_add_predicate_after_if(path);
2345 }
2346 
2347 
2348 static Node* extract_obj_from_klass_load(PhaseGVN* gvn, Node* n) {
2349   Node* ldk;
2350   if (n-&gt;is_DecodeNKlass()) {
2351     if (n-&gt;in(1)-&gt;Opcode() != Op_LoadNKlass) {
2352       return NULL;
2353     } else {
2354       ldk = n-&gt;in(1);
2355     }
2356   } else if (n-&gt;Opcode() != Op_LoadKlass) {
2357     return NULL;
2358   } else {
2359     ldk = n;
2360   }
2361   assert(ldk != NULL &amp;&amp; ldk-&gt;is_Load(), &quot;should have found a LoadKlass or LoadNKlass node&quot;);
2362 
2363   Node* adr = ldk-&gt;in(MemNode::Address);
2364   intptr_t off = 0;
2365   Node* obj = AddPNode::Ideal_base_and_offset(adr, gvn, off);
2366   if (obj == NULL || off != oopDesc::klass_offset_in_bytes()) // loading oopDesc::_klass?
2367     return NULL;
2368   const TypePtr* tp = gvn-&gt;type(obj)-&gt;is_ptr();
2369   if (tp == NULL || !(tp-&gt;isa_instptr() || tp-&gt;isa_aryptr())) // is obj a Java object ptr?
2370     return NULL;
2371 
2372   return obj;
2373 }
2374 
2375 void Parse::sharpen_type_after_if(BoolTest::mask btest,
2376                                   Node* con, const Type* tcon,
2377                                   Node* val, const Type* tval) {
2378   // Look for opportunities to sharpen the type of a node
2379   // whose klass is compared with a constant klass.
2380   if (btest == BoolTest::eq &amp;&amp; tcon-&gt;isa_klassptr()) {
2381     Node* obj = extract_obj_from_klass_load(&amp;_gvn, val);
2382     const TypeOopPtr* con_type = tcon-&gt;isa_klassptr()-&gt;as_instance_type();
2383     if (obj != NULL &amp;&amp; (con_type-&gt;isa_instptr() || con_type-&gt;isa_aryptr())) {
2384        // Found:
2385        //   Bool(CmpP(LoadKlass(obj._klass), ConP(Foo.klass)), [eq])
2386        // or the narrowOop equivalent.
2387        const Type* obj_type = _gvn.type(obj);
2388        const TypeOopPtr* tboth = obj_type-&gt;join_speculative(con_type)-&gt;isa_oopptr();
2389        if (tboth != NULL &amp;&amp; tboth-&gt;klass_is_exact() &amp;&amp; tboth != obj_type &amp;&amp;
2390            tboth-&gt;higher_equal(obj_type)) {
2391           // obj has to be of the exact type Foo if the CmpP succeeds.
2392           int obj_in_map = map()-&gt;find_edge(obj);
2393           JVMState* jvms = this-&gt;jvms();
2394           if (obj_in_map &gt;= 0 &amp;&amp;
2395               (jvms-&gt;is_loc(obj_in_map) || jvms-&gt;is_stk(obj_in_map))) {
2396             TypeNode* ccast = new CheckCastPPNode(control(), obj, tboth);
2397             const Type* tcc = ccast-&gt;as_Type()-&gt;type();
2398             assert(tcc != obj_type &amp;&amp; tcc-&gt;higher_equal(obj_type), &quot;must improve&quot;);
2399             // Delay transform() call to allow recovery of pre-cast value
2400             // at the control merge.
2401             _gvn.set_type_bottom(ccast);
2402             record_for_igvn(ccast);
2403             // Here&#39;s the payoff.
2404             replace_in_map(obj, ccast);
2405           }
2406        }
2407     }
2408   }
2409 
2410   int val_in_map = map()-&gt;find_edge(val);
2411   if (val_in_map &lt; 0)  return;          // replace_in_map would be useless
2412   {
2413     JVMState* jvms = this-&gt;jvms();
2414     if (!(jvms-&gt;is_loc(val_in_map) ||
2415           jvms-&gt;is_stk(val_in_map)))
2416       return;                           // again, it would be useless
2417   }
2418 
2419   // Check for a comparison to a constant, and &quot;know&quot; that the compared
2420   // value is constrained on this path.
2421   assert(tcon-&gt;singleton(), &quot;&quot;);
2422   ConstraintCastNode* ccast = NULL;
2423   Node* cast = NULL;
2424 
2425   switch (btest) {
2426   case BoolTest::eq:                    // Constant test?
2427     {
2428       const Type* tboth = tcon-&gt;join_speculative(tval);
2429       if (tboth == tval)  break;        // Nothing to gain.
2430       if (tcon-&gt;isa_int()) {
2431         ccast = new CastIINode(val, tboth);
2432       } else if (tcon == TypePtr::NULL_PTR) {
2433         // Cast to null, but keep the pointer identity temporarily live.
2434         ccast = new CastPPNode(val, tboth);
2435       } else {
2436         const TypeF* tf = tcon-&gt;isa_float_constant();
2437         const TypeD* td = tcon-&gt;isa_double_constant();
2438         // Exclude tests vs float/double 0 as these could be
2439         // either +0 or -0.  Just because you are equal to +0
2440         // doesn&#39;t mean you ARE +0!
2441         // Note, following code also replaces Long and Oop values.
2442         if ((!tf || tf-&gt;_f != 0.0) &amp;&amp;
2443             (!td || td-&gt;_d != 0.0))
2444           cast = con;                   // Replace non-constant val by con.
2445       }
2446     }
2447     break;
2448 
2449   case BoolTest::ne:
2450     if (tcon == TypePtr::NULL_PTR) {
2451       cast = cast_not_null(val, false);
2452     }
2453     break;
2454 
2455   default:
2456     // (At this point we could record int range types with CastII.)
2457     break;
2458   }
2459 
2460   if (ccast != NULL) {
2461     const Type* tcc = ccast-&gt;as_Type()-&gt;type();
2462     assert(tcc != tval &amp;&amp; tcc-&gt;higher_equal(tval), &quot;must improve&quot;);
2463     // Delay transform() call to allow recovery of pre-cast value
2464     // at the control merge.
2465     ccast-&gt;set_req(0, control());
2466     _gvn.set_type_bottom(ccast);
2467     record_for_igvn(ccast);
2468     cast = ccast;
2469   }
2470 
2471   if (cast != NULL) {                   // Here&#39;s the payoff.
2472     replace_in_map(val, cast);
2473   }
2474 }
2475 
2476 /**
2477  * Use speculative type to optimize CmpP node: if comparison is
2478  * against the low level class, cast the object to the speculative
2479  * type if any. CmpP should then go away.
2480  *
2481  * @param c  expected CmpP node
2482  * @return   result of CmpP on object casted to speculative type
2483  *
2484  */
2485 Node* Parse::optimize_cmp_with_klass(Node* c) {
2486   // If this is transformed by the _gvn to a comparison with the low
2487   // level klass then we may be able to use speculation
2488   if (c-&gt;Opcode() == Op_CmpP &amp;&amp;
2489       (c-&gt;in(1)-&gt;Opcode() == Op_LoadKlass || c-&gt;in(1)-&gt;Opcode() == Op_DecodeNKlass) &amp;&amp;
2490       c-&gt;in(2)-&gt;is_Con()) {
2491     Node* load_klass = NULL;
2492     Node* decode = NULL;
2493     if (c-&gt;in(1)-&gt;Opcode() == Op_DecodeNKlass) {
2494       decode = c-&gt;in(1);
2495       load_klass = c-&gt;in(1)-&gt;in(1);
2496     } else {
2497       load_klass = c-&gt;in(1);
2498     }
2499     if (load_klass-&gt;in(2)-&gt;is_AddP()) {
2500       Node* addp = load_klass-&gt;in(2);
2501       Node* obj = addp-&gt;in(AddPNode::Address);
2502       const TypeOopPtr* obj_type = _gvn.type(obj)-&gt;is_oopptr();
2503       if (obj_type-&gt;speculative_type_not_null() != NULL) {
2504         ciKlass* k = obj_type-&gt;speculative_type();
2505         inc_sp(2);
2506         obj = maybe_cast_profiled_obj(obj, k);
2507         dec_sp(2);
2508         if (obj-&gt;is_ValueType()) {
2509           assert(obj-&gt;as_ValueType()-&gt;is_allocated(&amp;_gvn), &quot;must be allocated&quot;);
2510           obj = obj-&gt;as_ValueType()-&gt;get_oop();
2511         }
2512         // Make the CmpP use the casted obj
2513         addp = basic_plus_adr(obj, addp-&gt;in(AddPNode::Offset));
2514         load_klass = load_klass-&gt;clone();
2515         load_klass-&gt;set_req(2, addp);
2516         load_klass = _gvn.transform(load_klass);
2517         if (decode != NULL) {
2518           decode = decode-&gt;clone();
2519           decode-&gt;set_req(1, load_klass);
2520           load_klass = _gvn.transform(decode);
2521         }
2522         c = c-&gt;clone();
2523         c-&gt;set_req(1, load_klass);
2524         c = _gvn.transform(c);
2525       }
2526     }
2527   }
2528   return c;
2529 }
2530 
2531 //------------------------------do_one_bytecode--------------------------------
2532 // Parse this bytecode, and alter the Parsers JVM-&gt;Node mapping
2533 void Parse::do_one_bytecode() {
2534   Node *a, *b, *c, *d;          // Handy temps
2535   BoolTest::mask btest;
2536   int i;
2537 
2538   assert(!has_exceptions(), &quot;bytecode entry state must be clear of throws&quot;);
2539 
2540   if (C-&gt;check_node_count(NodeLimitFudgeFactor * 5,
2541                           &quot;out of nodes parsing method&quot;)) {
2542     return;
2543   }
2544 
2545 #ifdef ASSERT
2546   // for setting breakpoints
2547   if (TraceOptoParse) {
2548     tty-&gt;print(&quot; @&quot;);
2549     dump_bci(bci());
2550     tty-&gt;cr();
2551   }
2552 #endif
2553 
2554   switch (bc()) {
2555   case Bytecodes::_nop:
2556     // do nothing
2557     break;
2558   case Bytecodes::_lconst_0:
2559     push_pair(longcon(0));
2560     break;
2561 
2562   case Bytecodes::_lconst_1:
2563     push_pair(longcon(1));
2564     break;
2565 
2566   case Bytecodes::_fconst_0:
2567     push(zerocon(T_FLOAT));
2568     break;
2569 
2570   case Bytecodes::_fconst_1:
2571     push(makecon(TypeF::ONE));
2572     break;
2573 
2574   case Bytecodes::_fconst_2:
2575     push(makecon(TypeF::make(2.0f)));
2576     break;
2577 
2578   case Bytecodes::_dconst_0:
2579     push_pair(zerocon(T_DOUBLE));
2580     break;
2581 
2582   case Bytecodes::_dconst_1:
2583     push_pair(makecon(TypeD::ONE));
2584     break;
2585 
2586   case Bytecodes::_iconst_m1:push(intcon(-1)); break;
2587   case Bytecodes::_iconst_0: push(intcon( 0)); break;
2588   case Bytecodes::_iconst_1: push(intcon( 1)); break;
2589   case Bytecodes::_iconst_2: push(intcon( 2)); break;
2590   case Bytecodes::_iconst_3: push(intcon( 3)); break;
2591   case Bytecodes::_iconst_4: push(intcon( 4)); break;
2592   case Bytecodes::_iconst_5: push(intcon( 5)); break;
2593   case Bytecodes::_bipush:   push(intcon(iter().get_constant_u1())); break;
2594   case Bytecodes::_sipush:   push(intcon(iter().get_constant_u2())); break;
2595   case Bytecodes::_aconst_null: push(null());  break;
2596   case Bytecodes::_ldc:
2597   case Bytecodes::_ldc_w:
2598   case Bytecodes::_ldc2_w:
2599     // If the constant is unresolved, run this BC once in the interpreter.
2600     {
2601       ciConstant constant = iter().get_constant();
2602       if (!constant.is_valid() ||
2603           (constant.basic_type() == T_OBJECT &amp;&amp;
2604            !constant.as_object()-&gt;is_loaded())) {
2605         int index = iter().get_constant_pool_index();
2606         constantTag tag = iter().get_constant_pool_tag(index);
2607         uncommon_trap(Deoptimization::make_trap_request
2608                       (Deoptimization::Reason_unloaded,
2609                        Deoptimization::Action_reinterpret,
2610                        index),
2611                       NULL, tag.internal_name());
2612         break;
2613       }
2614       assert(constant.basic_type() != T_OBJECT || constant.as_object()-&gt;is_instance(),
2615              &quot;must be java_mirror of klass&quot;);
2616       const Type* con_type = Type::make_from_constant(constant);
2617       if (con_type != NULL) {
2618         push_node(con_type-&gt;basic_type(), makecon(con_type));
2619       }
2620     }
2621 
2622     break;
2623 
2624   case Bytecodes::_aload_0:
2625     push( local(0) );
2626     break;
2627   case Bytecodes::_aload_1:
2628     push( local(1) );
2629     break;
2630   case Bytecodes::_aload_2:
2631     push( local(2) );
2632     break;
2633   case Bytecodes::_aload_3:
2634     push( local(3) );
2635     break;
2636   case Bytecodes::_aload:
2637     push( local(iter().get_index()) );
2638     break;
2639 
2640   case Bytecodes::_fload_0:
2641   case Bytecodes::_iload_0:
2642     push( local(0) );
2643     break;
2644   case Bytecodes::_fload_1:
2645   case Bytecodes::_iload_1:
2646     push( local(1) );
2647     break;
2648   case Bytecodes::_fload_2:
2649   case Bytecodes::_iload_2:
2650     push( local(2) );
2651     break;
2652   case Bytecodes::_fload_3:
2653   case Bytecodes::_iload_3:
2654     push( local(3) );
2655     break;
2656   case Bytecodes::_fload:
2657   case Bytecodes::_iload:
2658     push( local(iter().get_index()) );
2659     break;
2660   case Bytecodes::_lload_0:
2661     push_pair_local( 0 );
2662     break;
2663   case Bytecodes::_lload_1:
2664     push_pair_local( 1 );
2665     break;
2666   case Bytecodes::_lload_2:
2667     push_pair_local( 2 );
2668     break;
2669   case Bytecodes::_lload_3:
2670     push_pair_local( 3 );
2671     break;
2672   case Bytecodes::_lload:
2673     push_pair_local( iter().get_index() );
2674     break;
2675 
2676   case Bytecodes::_dload_0:
2677     push_pair_local(0);
2678     break;
2679   case Bytecodes::_dload_1:
2680     push_pair_local(1);
2681     break;
2682   case Bytecodes::_dload_2:
2683     push_pair_local(2);
2684     break;
2685   case Bytecodes::_dload_3:
2686     push_pair_local(3);
2687     break;
2688   case Bytecodes::_dload:
2689     push_pair_local(iter().get_index());
2690     break;
2691   case Bytecodes::_fstore_0:
2692   case Bytecodes::_istore_0:
2693   case Bytecodes::_astore_0:
2694     set_local( 0, pop() );
2695     break;
2696   case Bytecodes::_fstore_1:
2697   case Bytecodes::_istore_1:
2698   case Bytecodes::_astore_1:
2699     set_local( 1, pop() );
2700     break;
2701   case Bytecodes::_fstore_2:
2702   case Bytecodes::_istore_2:
2703   case Bytecodes::_astore_2:
2704     set_local( 2, pop() );
2705     break;
2706   case Bytecodes::_fstore_3:
2707   case Bytecodes::_istore_3:
2708   case Bytecodes::_astore_3:
2709     set_local( 3, pop() );
2710     break;
2711   case Bytecodes::_fstore:
2712   case Bytecodes::_istore:
2713   case Bytecodes::_astore:
2714     set_local( iter().get_index(), pop() );
2715     break;
2716   // long stores
2717   case Bytecodes::_lstore_0:
2718     set_pair_local( 0, pop_pair() );
2719     break;
2720   case Bytecodes::_lstore_1:
2721     set_pair_local( 1, pop_pair() );
2722     break;
2723   case Bytecodes::_lstore_2:
2724     set_pair_local( 2, pop_pair() );
2725     break;
2726   case Bytecodes::_lstore_3:
2727     set_pair_local( 3, pop_pair() );
2728     break;
2729   case Bytecodes::_lstore:
2730     set_pair_local( iter().get_index(), pop_pair() );
2731     break;
2732 
2733   // double stores
2734   case Bytecodes::_dstore_0:
2735     set_pair_local( 0, dstore_rounding(pop_pair()) );
2736     break;
2737   case Bytecodes::_dstore_1:
2738     set_pair_local( 1, dstore_rounding(pop_pair()) );
2739     break;
2740   case Bytecodes::_dstore_2:
2741     set_pair_local( 2, dstore_rounding(pop_pair()) );
2742     break;
2743   case Bytecodes::_dstore_3:
2744     set_pair_local( 3, dstore_rounding(pop_pair()) );
2745     break;
2746   case Bytecodes::_dstore:
2747     set_pair_local( iter().get_index(), dstore_rounding(pop_pair()) );
2748     break;
2749 
2750   case Bytecodes::_pop:  dec_sp(1);   break;
2751   case Bytecodes::_pop2: dec_sp(2);   break;
2752   case Bytecodes::_swap:
2753     a = pop();
2754     b = pop();
2755     push(a);
2756     push(b);
2757     break;
2758   case Bytecodes::_dup:
2759     a = pop();
2760     push(a);
2761     push(a);
2762     break;
2763   case Bytecodes::_dup_x1:
2764     a = pop();
2765     b = pop();
2766     push( a );
2767     push( b );
2768     push( a );
2769     break;
2770   case Bytecodes::_dup_x2:
2771     a = pop();
2772     b = pop();
2773     c = pop();
2774     push( a );
2775     push( c );
2776     push( b );
2777     push( a );
2778     break;
2779   case Bytecodes::_dup2:
2780     a = pop();
2781     b = pop();
2782     push( b );
2783     push( a );
2784     push( b );
2785     push( a );
2786     break;
2787 
2788   case Bytecodes::_dup2_x1:
2789     // before: .. c, b, a
2790     // after:  .. b, a, c, b, a
2791     // not tested
2792     a = pop();
2793     b = pop();
2794     c = pop();
2795     push( b );
2796     push( a );
2797     push( c );
2798     push( b );
2799     push( a );
2800     break;
2801   case Bytecodes::_dup2_x2:
2802     // before: .. d, c, b, a
2803     // after:  .. b, a, d, c, b, a
2804     // not tested
2805     a = pop();
2806     b = pop();
2807     c = pop();
2808     d = pop();
2809     push( b );
2810     push( a );
2811     push( d );
2812     push( c );
2813     push( b );
2814     push( a );
2815     break;
2816 
2817   case Bytecodes::_arraylength: {
2818     // Must do null-check with value on expression stack
2819     Node *ary = null_check(peek(), T_ARRAY);
2820     // Compile-time detect of null-exception?
2821     if (stopped())  return;
2822     a = pop();
2823     push(load_array_length(a));
2824     break;
2825   }
2826 
2827   case Bytecodes::_baload:  array_load(T_BYTE);    break;
2828   case Bytecodes::_caload:  array_load(T_CHAR);    break;
2829   case Bytecodes::_iaload:  array_load(T_INT);     break;
2830   case Bytecodes::_saload:  array_load(T_SHORT);   break;
2831   case Bytecodes::_faload:  array_load(T_FLOAT);   break;
2832   case Bytecodes::_aaload:  array_load(T_OBJECT);  break;
2833   case Bytecodes::_laload:  array_load(T_LONG);    break;
2834   case Bytecodes::_daload:  array_load(T_DOUBLE);  break;
2835   case Bytecodes::_bastore: array_store(T_BYTE);   break;
2836   case Bytecodes::_castore: array_store(T_CHAR);   break;
2837   case Bytecodes::_iastore: array_store(T_INT);    break;
2838   case Bytecodes::_sastore: array_store(T_SHORT);  break;
2839   case Bytecodes::_fastore: array_store(T_FLOAT);  break;
2840   case Bytecodes::_aastore: array_store(T_OBJECT); break;
2841   case Bytecodes::_lastore: array_store(T_LONG);   break;
2842   case Bytecodes::_dastore: array_store(T_DOUBLE); break;
2843 
2844   case Bytecodes::_getfield:
2845     do_getfield();
2846     break;
2847 
2848   case Bytecodes::_getstatic:
2849     do_getstatic();
2850     break;
2851 
2852   case Bytecodes::_putfield:
2853     do_putfield();
2854     break;
2855 
2856   case Bytecodes::_putstatic:
2857     do_putstatic();
2858     break;
2859 
2860   case Bytecodes::_irem:
2861     do_irem();
2862     break;
2863   case Bytecodes::_idiv:
2864     // Must keep both values on the expression-stack during null-check
2865     zero_check_int(peek());
2866     // Compile-time detect of null-exception?
2867     if (stopped())  return;
2868     b = pop();
2869     a = pop();
2870     push( _gvn.transform( new DivINode(control(),a,b) ) );
2871     break;
2872   case Bytecodes::_imul:
2873     b = pop(); a = pop();
2874     push( _gvn.transform( new MulINode(a,b) ) );
2875     break;
2876   case Bytecodes::_iadd:
2877     b = pop(); a = pop();
2878     push( _gvn.transform( new AddINode(a,b) ) );
2879     break;
2880   case Bytecodes::_ineg:
2881     a = pop();
2882     push( _gvn.transform( new SubINode(_gvn.intcon(0),a)) );
2883     break;
2884   case Bytecodes::_isub:
2885     b = pop(); a = pop();
2886     push( _gvn.transform( new SubINode(a,b) ) );
2887     break;
2888   case Bytecodes::_iand:
2889     b = pop(); a = pop();
2890     push( _gvn.transform( new AndINode(a,b) ) );
2891     break;
2892   case Bytecodes::_ior:
2893     b = pop(); a = pop();
2894     push( _gvn.transform( new OrINode(a,b) ) );
2895     break;
2896   case Bytecodes::_ixor:
2897     b = pop(); a = pop();
2898     push( _gvn.transform( new XorINode(a,b) ) );
2899     break;
2900   case Bytecodes::_ishl:
2901     b = pop(); a = pop();
2902     push( _gvn.transform( new LShiftINode(a,b) ) );
2903     break;
2904   case Bytecodes::_ishr:
2905     b = pop(); a = pop();
2906     push( _gvn.transform( new RShiftINode(a,b) ) );
2907     break;
2908   case Bytecodes::_iushr:
2909     b = pop(); a = pop();
2910     push( _gvn.transform( new URShiftINode(a,b) ) );
2911     break;
2912 
2913   case Bytecodes::_fneg:
2914     a = pop();
2915     b = _gvn.transform(new NegFNode (a));
2916     push(b);
2917     break;
2918 
2919   case Bytecodes::_fsub:
2920     b = pop();
2921     a = pop();
2922     c = _gvn.transform( new SubFNode(a,b) );
2923     d = precision_rounding(c);
2924     push( d );
2925     break;
2926 
2927   case Bytecodes::_fadd:
2928     b = pop();
2929     a = pop();
2930     c = _gvn.transform( new AddFNode(a,b) );
2931     d = precision_rounding(c);
2932     push( d );
2933     break;
2934 
2935   case Bytecodes::_fmul:
2936     b = pop();
2937     a = pop();
2938     c = _gvn.transform( new MulFNode(a,b) );
2939     d = precision_rounding(c);
2940     push( d );
2941     break;
2942 
2943   case Bytecodes::_fdiv:
2944     b = pop();
2945     a = pop();
2946     c = _gvn.transform( new DivFNode(0,a,b) );
2947     d = precision_rounding(c);
2948     push( d );
2949     break;
2950 
2951   case Bytecodes::_frem:
2952     if (Matcher::has_match_rule(Op_ModF)) {
2953       // Generate a ModF node.
2954       b = pop();
2955       a = pop();
2956       c = _gvn.transform( new ModFNode(0,a,b) );
2957       d = precision_rounding(c);
2958       push( d );
2959     }
2960     else {
2961       // Generate a call.
2962       modf();
2963     }
2964     break;
2965 
2966   case Bytecodes::_fcmpl:
2967     b = pop();
2968     a = pop();
2969     c = _gvn.transform( new CmpF3Node( a, b));
2970     push(c);
2971     break;
2972   case Bytecodes::_fcmpg:
2973     b = pop();
2974     a = pop();
2975 
2976     // Same as fcmpl but need to flip the unordered case.  Swap the inputs,
2977     // which negates the result sign except for unordered.  Flip the unordered
2978     // as well by using CmpF3 which implements unordered-lesser instead of
2979     // unordered-greater semantics.  Finally, commute the result bits.  Result
2980     // is same as using a CmpF3Greater except we did it with CmpF3 alone.
2981     c = _gvn.transform( new CmpF3Node( b, a));
2982     c = _gvn.transform( new SubINode(_gvn.intcon(0),c) );
2983     push(c);
2984     break;
2985 
2986   case Bytecodes::_f2i:
2987     a = pop();
2988     push(_gvn.transform(new ConvF2INode(a)));
2989     break;
2990 
2991   case Bytecodes::_d2i:
2992     a = pop_pair();
2993     b = _gvn.transform(new ConvD2INode(a));
2994     push( b );
2995     break;
2996 
2997   case Bytecodes::_f2d:
2998     a = pop();
2999     b = _gvn.transform( new ConvF2DNode(a));
3000     push_pair( b );
3001     break;
3002 
3003   case Bytecodes::_d2f:
3004     a = pop_pair();
3005     b = _gvn.transform( new ConvD2FNode(a));
3006     // This breaks _227_mtrt (speed &amp; correctness) and _222_mpegaudio (speed)
3007     //b = _gvn.transform(new RoundFloatNode(0, b) );
3008     push( b );
3009     break;
3010 
3011   case Bytecodes::_l2f:
3012     if (Matcher::convL2FSupported()) {
3013       a = pop_pair();
3014       b = _gvn.transform( new ConvL2FNode(a));
3015       // For i486.ad, FILD doesn&#39;t restrict precision to 24 or 53 bits.
3016       // Rather than storing the result into an FP register then pushing
3017       // out to memory to round, the machine instruction that implements
3018       // ConvL2D is responsible for rounding.
3019       // c = precision_rounding(b);
3020       c = _gvn.transform(b);
3021       push(c);
3022     } else {
3023       l2f();
3024     }
3025     break;
3026 
3027   case Bytecodes::_l2d:
3028     a = pop_pair();
3029     b = _gvn.transform( new ConvL2DNode(a));
3030     // For i486.ad, rounding is always necessary (see _l2f above).
3031     // c = dprecision_rounding(b);
3032     c = _gvn.transform(b);
3033     push_pair(c);
3034     break;
3035 
3036   case Bytecodes::_f2l:
3037     a = pop();
3038     b = _gvn.transform( new ConvF2LNode(a));
3039     push_pair(b);
3040     break;
3041 
3042   case Bytecodes::_d2l:
3043     a = pop_pair();
3044     b = _gvn.transform( new ConvD2LNode(a));
3045     push_pair(b);
3046     break;
3047 
3048   case Bytecodes::_dsub:
3049     b = pop_pair();
3050     a = pop_pair();
3051     c = _gvn.transform( new SubDNode(a,b) );
3052     d = dprecision_rounding(c);
3053     push_pair( d );
3054     break;
3055 
3056   case Bytecodes::_dadd:
3057     b = pop_pair();
3058     a = pop_pair();
3059     c = _gvn.transform( new AddDNode(a,b) );
3060     d = dprecision_rounding(c);
3061     push_pair( d );
3062     break;
3063 
3064   case Bytecodes::_dmul:
3065     b = pop_pair();
3066     a = pop_pair();
3067     c = _gvn.transform( new MulDNode(a,b) );
3068     d = dprecision_rounding(c);
3069     push_pair( d );
3070     break;
3071 
3072   case Bytecodes::_ddiv:
3073     b = pop_pair();
3074     a = pop_pair();
3075     c = _gvn.transform( new DivDNode(0,a,b) );
3076     d = dprecision_rounding(c);
3077     push_pair( d );
3078     break;
3079 
3080   case Bytecodes::_dneg:
3081     a = pop_pair();
3082     b = _gvn.transform(new NegDNode (a));
3083     push_pair(b);
3084     break;
3085 
3086   case Bytecodes::_drem:
3087     if (Matcher::has_match_rule(Op_ModD)) {
3088       // Generate a ModD node.
3089       b = pop_pair();
3090       a = pop_pair();
3091       // a % b
3092 
3093       c = _gvn.transform( new ModDNode(0,a,b) );
3094       d = dprecision_rounding(c);
3095       push_pair( d );
3096     }
3097     else {
3098       // Generate a call.
3099       modd();
3100     }
3101     break;
3102 
3103   case Bytecodes::_dcmpl:
3104     b = pop_pair();
3105     a = pop_pair();
3106     c = _gvn.transform( new CmpD3Node( a, b));
3107     push(c);
3108     break;
3109 
3110   case Bytecodes::_dcmpg:
3111     b = pop_pair();
3112     a = pop_pair();
3113     // Same as dcmpl but need to flip the unordered case.
3114     // Commute the inputs, which negates the result sign except for unordered.
3115     // Flip the unordered as well by using CmpD3 which implements
3116     // unordered-lesser instead of unordered-greater semantics.
3117     // Finally, negate the result bits.  Result is same as using a
3118     // CmpD3Greater except we did it with CmpD3 alone.
3119     c = _gvn.transform( new CmpD3Node( b, a));
3120     c = _gvn.transform( new SubINode(_gvn.intcon(0),c) );
3121     push(c);
3122     break;
3123 
3124 
3125     // Note for longs -&gt; lo word is on TOS, hi word is on TOS - 1
3126   case Bytecodes::_land:
3127     b = pop_pair();
3128     a = pop_pair();
3129     c = _gvn.transform( new AndLNode(a,b) );
3130     push_pair(c);
3131     break;
3132   case Bytecodes::_lor:
3133     b = pop_pair();
3134     a = pop_pair();
3135     c = _gvn.transform( new OrLNode(a,b) );
3136     push_pair(c);
3137     break;
3138   case Bytecodes::_lxor:
3139     b = pop_pair();
3140     a = pop_pair();
3141     c = _gvn.transform( new XorLNode(a,b) );
3142     push_pair(c);
3143     break;
3144 
3145   case Bytecodes::_lshl:
3146     b = pop();                  // the shift count
3147     a = pop_pair();             // value to be shifted
3148     c = _gvn.transform( new LShiftLNode(a,b) );
3149     push_pair(c);
3150     break;
3151   case Bytecodes::_lshr:
3152     b = pop();                  // the shift count
3153     a = pop_pair();             // value to be shifted
3154     c = _gvn.transform( new RShiftLNode(a,b) );
3155     push_pair(c);
3156     break;
3157   case Bytecodes::_lushr:
3158     b = pop();                  // the shift count
3159     a = pop_pair();             // value to be shifted
3160     c = _gvn.transform( new URShiftLNode(a,b) );
3161     push_pair(c);
3162     break;
3163   case Bytecodes::_lmul:
3164     b = pop_pair();
3165     a = pop_pair();
3166     c = _gvn.transform( new MulLNode(a,b) );
3167     push_pair(c);
3168     break;
3169 
3170   case Bytecodes::_lrem:
3171     // Must keep both values on the expression-stack during null-check
3172     assert(peek(0) == top(), &quot;long word order&quot;);
3173     zero_check_long(peek(1));
3174     // Compile-time detect of null-exception?
3175     if (stopped())  return;
3176     b = pop_pair();
3177     a = pop_pair();
3178     c = _gvn.transform( new ModLNode(control(),a,b) );
3179     push_pair(c);
3180     break;
3181 
3182   case Bytecodes::_ldiv:
3183     // Must keep both values on the expression-stack during null-check
3184     assert(peek(0) == top(), &quot;long word order&quot;);
3185     zero_check_long(peek(1));
3186     // Compile-time detect of null-exception?
3187     if (stopped())  return;
3188     b = pop_pair();
3189     a = pop_pair();
3190     c = _gvn.transform( new DivLNode(control(),a,b) );
3191     push_pair(c);
3192     break;
3193 
3194   case Bytecodes::_ladd:
3195     b = pop_pair();
3196     a = pop_pair();
3197     c = _gvn.transform( new AddLNode(a,b) );
3198     push_pair(c);
3199     break;
3200   case Bytecodes::_lsub:
3201     b = pop_pair();
3202     a = pop_pair();
3203     c = _gvn.transform( new SubLNode(a,b) );
3204     push_pair(c);
3205     break;
3206   case Bytecodes::_lcmp:
3207     // Safepoints are now inserted _before_ branches.  The long-compare
3208     // bytecode painfully produces a 3-way value (-1,0,+1) which requires a
3209     // slew of control flow.  These are usually followed by a CmpI vs zero and
3210     // a branch; this pattern then optimizes to the obvious long-compare and
3211     // branch.  However, if the branch is backwards there&#39;s a Safepoint
3212     // inserted.  The inserted Safepoint captures the JVM state at the
3213     // pre-branch point, i.e. it captures the 3-way value.  Thus if a
3214     // long-compare is used to control a loop the debug info will force
3215     // computation of the 3-way value, even though the generated code uses a
3216     // long-compare and branch.  We try to rectify the situation by inserting
3217     // a SafePoint here and have it dominate and kill the safepoint added at a
3218     // following backwards branch.  At this point the JVM state merely holds 2
3219     // longs but not the 3-way value.
3220     if( UseLoopSafepoints ) {
3221       switch( iter().next_bc() ) {
3222       case Bytecodes::_ifgt:
3223       case Bytecodes::_iflt:
3224       case Bytecodes::_ifge:
3225       case Bytecodes::_ifle:
3226       case Bytecodes::_ifne:
3227       case Bytecodes::_ifeq:
3228         // If this is a backwards branch in the bytecodes, add Safepoint
3229         maybe_add_safepoint(iter().next_get_dest());
3230       default:
3231         break;
3232       }
3233     }
3234     b = pop_pair();
3235     a = pop_pair();
3236     c = _gvn.transform( new CmpL3Node( a, b ));
3237     push(c);
3238     break;
3239 
3240   case Bytecodes::_lneg:
3241     a = pop_pair();
3242     b = _gvn.transform( new SubLNode(longcon(0),a));
3243     push_pair(b);
3244     break;
3245   case Bytecodes::_l2i:
3246     a = pop_pair();
3247     push( _gvn.transform( new ConvL2INode(a)));
3248     break;
3249   case Bytecodes::_i2l:
3250     a = pop();
3251     b = _gvn.transform( new ConvI2LNode(a));
3252     push_pair(b);
3253     break;
3254   case Bytecodes::_i2b:
3255     // Sign extend
3256     a = pop();
3257     a = _gvn.transform( new LShiftINode(a,_gvn.intcon(24)) );
3258     a = _gvn.transform( new RShiftINode(a,_gvn.intcon(24)) );
3259     push( a );
3260     break;
3261   case Bytecodes::_i2s:
3262     a = pop();
3263     a = _gvn.transform( new LShiftINode(a,_gvn.intcon(16)) );
3264     a = _gvn.transform( new RShiftINode(a,_gvn.intcon(16)) );
3265     push( a );
3266     break;
3267   case Bytecodes::_i2c:
3268     a = pop();
3269     push( _gvn.transform( new AndINode(a,_gvn.intcon(0xFFFF)) ) );
3270     break;
3271 
3272   case Bytecodes::_i2f:
3273     a = pop();
3274     b = _gvn.transform( new ConvI2FNode(a) ) ;
3275     c = precision_rounding(b);
3276     push (b);
3277     break;
3278 
3279   case Bytecodes::_i2d:
3280     a = pop();
3281     b = _gvn.transform( new ConvI2DNode(a));
3282     push_pair(b);
3283     break;
3284 
3285   case Bytecodes::_iinc:        // Increment local
3286     i = iter().get_index();     // Get local index
3287     set_local( i, _gvn.transform( new AddINode( _gvn.intcon(iter().get_iinc_con()), local(i) ) ) );
3288     break;
3289 
3290   // Exit points of synchronized methods must have an unlock node
3291   case Bytecodes::_return:
3292     return_current(NULL);
3293     break;
3294 
3295   case Bytecodes::_ireturn:
3296   case Bytecodes::_areturn:
3297   case Bytecodes::_freturn:
3298     return_current(pop());
3299     break;
3300   case Bytecodes::_lreturn:
3301     return_current(pop_pair());
3302     break;
3303   case Bytecodes::_dreturn:
3304     return_current(pop_pair());
3305     break;
3306 
3307   case Bytecodes::_athrow:
3308     // null exception oop throws NULL pointer exception
3309     null_check(peek());
3310     if (stopped())  return;
3311     // Hook the thrown exception directly to subsequent handlers.
3312     if (BailoutToInterpreterForThrows) {
3313       // Keep method interpreted from now on.
3314       uncommon_trap(Deoptimization::Reason_unhandled,
3315                     Deoptimization::Action_make_not_compilable);
3316       return;
3317     }
3318     if (env()-&gt;jvmti_can_post_on_exceptions()) {
3319       // check if we must post exception events, take uncommon trap if so (with must_throw = false)
3320       uncommon_trap_if_should_post_on_exceptions(Deoptimization::Reason_unhandled, false);
3321     }
3322     // Here if either can_post_on_exceptions or should_post_on_exceptions is false
3323     add_exception_state(make_exception_state(peek()));
3324     break;
3325 
3326   case Bytecodes::_goto:   // fall through
3327   case Bytecodes::_goto_w: {
3328     int target_bci = (bc() == Bytecodes::_goto) ? iter().get_dest() : iter().get_far_dest();
3329 
3330     // If this is a backwards branch in the bytecodes, add Safepoint
3331     maybe_add_safepoint(target_bci);
3332 
3333     // Update method data
3334     profile_taken_branch(target_bci);
3335 
3336     // Merge the current control into the target basic block
3337     merge(target_bci);
3338 
3339     // See if we can get some profile data and hand it off to the next block
3340     Block *target_block = block()-&gt;successor_for_bci(target_bci);
3341     if (target_block-&gt;pred_count() != 1)  break;
3342     ciMethodData* methodData = method()-&gt;method_data();
3343     if (!methodData-&gt;is_mature())  break;
3344     ciProfileData* data = methodData-&gt;bci_to_data(bci());
3345     assert(data != NULL &amp;&amp; data-&gt;is_JumpData(), &quot;need JumpData for taken branch&quot;);
3346     int taken = ((ciJumpData*)data)-&gt;taken();
3347     taken = method()-&gt;scale_count(taken);
3348     target_block-&gt;set_count(taken);
3349     break;
3350   }
3351 
3352   case Bytecodes::_ifnull:    btest = BoolTest::eq; goto handle_if_null;
3353   case Bytecodes::_ifnonnull: btest = BoolTest::ne; goto handle_if_null;
3354   handle_if_null:
3355     // If this is a backwards branch in the bytecodes, add Safepoint
3356     maybe_add_safepoint(iter().get_dest());
3357     a = null();
3358     b = pop();
3359     if (b-&gt;is_ValueType()) {
3360       // Return constant false because &#39;b&#39; is always non-null
3361       c = _gvn.makecon(TypeInt::CC_GT);
3362     } else {
3363       if (!_gvn.type(b)-&gt;speculative_maybe_null() &amp;&amp;
3364           !too_many_traps(Deoptimization::Reason_speculate_null_check)) {
3365         inc_sp(1);
3366         Node* null_ctl = top();
3367         b = null_check_oop(b, &amp;null_ctl, true, true, true);
3368         assert(null_ctl-&gt;is_top(), &quot;no null control here&quot;);
3369         dec_sp(1);
3370       } else if (_gvn.type(b)-&gt;speculative_always_null() &amp;&amp;
3371                  !too_many_traps(Deoptimization::Reason_speculate_null_assert)) {
3372         inc_sp(1);
3373         b = null_assert(b);
3374         dec_sp(1);
3375       }
3376       c = _gvn.transform( new CmpPNode(b, a) );
3377     }
3378     do_ifnull(btest, c);
3379     break;
3380 
3381   case Bytecodes::_if_acmpeq: btest = BoolTest::eq; goto handle_if_acmp;
3382   case Bytecodes::_if_acmpne: btest = BoolTest::ne; goto handle_if_acmp;
3383   handle_if_acmp:
3384     // If this is a backwards branch in the bytecodes, add Safepoint
3385     maybe_add_safepoint(iter().get_dest());
3386     a = pop();
3387     b = pop();
3388     do_acmp(btest, a, b);
3389     break;
3390 
3391   case Bytecodes::_ifeq: btest = BoolTest::eq; goto handle_ifxx;
3392   case Bytecodes::_ifne: btest = BoolTest::ne; goto handle_ifxx;
3393   case Bytecodes::_iflt: btest = BoolTest::lt; goto handle_ifxx;
3394   case Bytecodes::_ifle: btest = BoolTest::le; goto handle_ifxx;
3395   case Bytecodes::_ifgt: btest = BoolTest::gt; goto handle_ifxx;
3396   case Bytecodes::_ifge: btest = BoolTest::ge; goto handle_ifxx;
3397   handle_ifxx:
3398     // If this is a backwards branch in the bytecodes, add Safepoint
3399     maybe_add_safepoint(iter().get_dest());
3400     a = _gvn.intcon(0);
3401     b = pop();
3402     c = _gvn.transform( new CmpINode(b, a) );
3403     do_if(btest, c);
3404     break;
3405 
3406   case Bytecodes::_if_icmpeq: btest = BoolTest::eq; goto handle_if_icmp;
3407   case Bytecodes::_if_icmpne: btest = BoolTest::ne; goto handle_if_icmp;
3408   case Bytecodes::_if_icmplt: btest = BoolTest::lt; goto handle_if_icmp;
3409   case Bytecodes::_if_icmple: btest = BoolTest::le; goto handle_if_icmp;
3410   case Bytecodes::_if_icmpgt: btest = BoolTest::gt; goto handle_if_icmp;
3411   case Bytecodes::_if_icmpge: btest = BoolTest::ge; goto handle_if_icmp;
3412   handle_if_icmp:
3413     // If this is a backwards branch in the bytecodes, add Safepoint
3414     maybe_add_safepoint(iter().get_dest());
3415     a = pop();
3416     b = pop();
3417     c = _gvn.transform( new CmpINode( b, a ) );
3418     do_if(btest, c);
3419     break;
3420 
3421   case Bytecodes::_tableswitch:
3422     do_tableswitch();
3423     break;
3424 
3425   case Bytecodes::_lookupswitch:
3426     do_lookupswitch();
3427     break;
3428 
3429   case Bytecodes::_invokestatic:
3430   case Bytecodes::_invokedynamic:
3431   case Bytecodes::_invokespecial:
3432   case Bytecodes::_invokevirtual:
3433   case Bytecodes::_invokeinterface:
3434     do_call();
3435     break;
3436   case Bytecodes::_checkcast:
3437     do_checkcast();
3438     break;
3439   case Bytecodes::_instanceof:
3440     do_instanceof();
3441     break;
3442   case Bytecodes::_anewarray:
3443     do_newarray();
3444     break;
3445   case Bytecodes::_newarray:
3446     do_newarray((BasicType)iter().get_index());
3447     break;
3448   case Bytecodes::_multianewarray:
3449     do_multianewarray();
3450     break;
3451   case Bytecodes::_new:
3452     do_new();
3453     break;
3454   case Bytecodes::_defaultvalue:
3455     do_defaultvalue();
3456     break;
3457   case Bytecodes::_withfield:
3458     do_withfield();
3459     break;
3460 
3461   case Bytecodes::_jsr:
3462   case Bytecodes::_jsr_w:
3463     do_jsr();
3464     break;
3465 
3466   case Bytecodes::_ret:
3467     do_ret();
3468     break;
3469 
3470 
3471   case Bytecodes::_monitorenter:
3472     do_monitor_enter();
3473     break;
3474 
3475   case Bytecodes::_monitorexit:
3476     do_monitor_exit();
3477     break;
3478 
3479   case Bytecodes::_breakpoint:
3480     // Breakpoint set concurrently to compile
3481     // %%% use an uncommon trap?
3482     C-&gt;record_failure(&quot;breakpoint in method&quot;);
3483     return;
3484 
3485   default:
3486 #ifndef PRODUCT
3487     map()-&gt;dump(99);
3488 #endif
3489     tty-&gt;print(&quot;\nUnhandled bytecode %s\n&quot;, Bytecodes::name(bc()) );
3490     ShouldNotReachHere();
3491   }
3492 
3493 #ifndef PRODUCT
3494   IdealGraphPrinter *printer = C-&gt;printer();
3495   if (printer &amp;&amp; printer-&gt;should_print(1)) {
3496     char buffer[256];
3497     jio_snprintf(buffer, sizeof(buffer), &quot;Bytecode %d: %s&quot;, bci(), Bytecodes::name(bc()));
3498     bool old = printer-&gt;traverse_outs();
3499     printer-&gt;set_traverse_outs(true);
3500     printer-&gt;print_method(buffer, 4);
3501     printer-&gt;set_traverse_outs(old);
3502   }
3503 #endif
3504 }
    </pre>
  </body>
</html>