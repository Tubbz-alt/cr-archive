<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames src/hotspot/share/oops/instanceKlass.cpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
    <script type="text/javascript" src="../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>   1 /*
   2  * Copyright (c) 1997, 2020, Oracle and/or its affiliates. All rights reserved.
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.
   8  *
   9  * This code is distributed in the hope that it will be useful, but WITHOUT
  10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  *
  23  */
  24 
  25 #include &quot;precompiled.hpp&quot;
  26 #include &quot;jvm.h&quot;
  27 #include &quot;aot/aotLoader.hpp&quot;
  28 #include &quot;classfile/classFileParser.hpp&quot;
  29 #include &quot;classfile/classFileStream.hpp&quot;
  30 #include &quot;classfile/classLoader.hpp&quot;
  31 #include &quot;classfile/classLoaderData.inline.hpp&quot;
  32 #include &quot;classfile/javaClasses.hpp&quot;
  33 #include &quot;classfile/moduleEntry.hpp&quot;
  34 #include &quot;classfile/symbolTable.hpp&quot;
  35 #include &quot;classfile/systemDictionary.hpp&quot;
  36 #include &quot;classfile/systemDictionaryShared.hpp&quot;
  37 #include &quot;classfile/verifier.hpp&quot;
  38 #include &quot;classfile/vmSymbols.hpp&quot;
  39 #include &quot;code/dependencyContext.hpp&quot;
  40 #include &quot;compiler/compileBroker.hpp&quot;
  41 #include &quot;gc/shared/collectedHeap.inline.hpp&quot;
  42 #include &quot;interpreter/oopMapCache.hpp&quot;
  43 #include &quot;interpreter/rewriter.hpp&quot;
  44 #include &quot;jvmtifiles/jvmti.h&quot;
  45 #include &quot;logging/log.hpp&quot;
  46 #include &quot;logging/logMessage.hpp&quot;
  47 #include &quot;logging/logStream.hpp&quot;
  48 #include &quot;memory/allocation.inline.hpp&quot;
  49 #include &quot;memory/iterator.inline.hpp&quot;
  50 #include &quot;memory/metadataFactory.hpp&quot;
  51 #include &quot;memory/metaspaceClosure.hpp&quot;
  52 #include &quot;memory/metaspaceShared.hpp&quot;
  53 #include &quot;memory/oopFactory.hpp&quot;
  54 #include &quot;memory/resourceArea.hpp&quot;
  55 #include &quot;memory/universe.hpp&quot;
  56 #include &quot;oops/fieldStreams.inline.hpp&quot;
  57 #include &quot;oops/constantPool.hpp&quot;
  58 #include &quot;oops/instanceClassLoaderKlass.hpp&quot;
  59 #include &quot;oops/instanceKlass.inline.hpp&quot;
  60 #include &quot;oops/instanceMirrorKlass.hpp&quot;
  61 #include &quot;oops/instanceOop.hpp&quot;
  62 #include &quot;oops/klass.inline.hpp&quot;
  63 #include &quot;oops/method.hpp&quot;
  64 #include &quot;oops/oop.inline.hpp&quot;
  65 #include &quot;oops/recordComponent.hpp&quot;
  66 #include &quot;oops/symbol.hpp&quot;
  67 #include &quot;oops/valueKlass.hpp&quot;
  68 #include &quot;prims/jvmtiExport.hpp&quot;
  69 #include &quot;prims/jvmtiRedefineClasses.hpp&quot;
  70 #include &quot;prims/jvmtiThreadState.hpp&quot;
  71 #include &quot;prims/methodComparator.hpp&quot;
  72 #include &quot;runtime/atomic.hpp&quot;
  73 #include &quot;runtime/biasedLocking.hpp&quot;
  74 #include &quot;runtime/fieldDescriptor.inline.hpp&quot;
  75 #include &quot;runtime/handles.inline.hpp&quot;
  76 #include &quot;runtime/javaCalls.hpp&quot;
  77 #include &quot;runtime/mutexLocker.hpp&quot;
  78 #include &quot;runtime/orderAccess.hpp&quot;
  79 #include &quot;runtime/thread.inline.hpp&quot;
  80 #include &quot;services/classLoadingService.hpp&quot;
  81 #include &quot;services/threadService.hpp&quot;
  82 #include &quot;utilities/dtrace.hpp&quot;
  83 #include &quot;utilities/events.hpp&quot;
  84 #include &quot;utilities/macros.hpp&quot;
  85 #include &quot;utilities/stringUtils.hpp&quot;
  86 #ifdef COMPILER1
  87 #include &quot;c1/c1_Compiler.hpp&quot;
  88 #endif
  89 #if INCLUDE_JFR
  90 #include &quot;jfr/jfrEvents.hpp&quot;
  91 #endif
  92 
  93 
  94 #ifdef DTRACE_ENABLED
  95 
  96 
  97 #define HOTSPOT_CLASS_INITIALIZATION_required HOTSPOT_CLASS_INITIALIZATION_REQUIRED
  98 #define HOTSPOT_CLASS_INITIALIZATION_recursive HOTSPOT_CLASS_INITIALIZATION_RECURSIVE
  99 #define HOTSPOT_CLASS_INITIALIZATION_concurrent HOTSPOT_CLASS_INITIALIZATION_CONCURRENT
 100 #define HOTSPOT_CLASS_INITIALIZATION_erroneous HOTSPOT_CLASS_INITIALIZATION_ERRONEOUS
 101 #define HOTSPOT_CLASS_INITIALIZATION_super__failed HOTSPOT_CLASS_INITIALIZATION_SUPER_FAILED
 102 #define HOTSPOT_CLASS_INITIALIZATION_clinit HOTSPOT_CLASS_INITIALIZATION_CLINIT
 103 #define HOTSPOT_CLASS_INITIALIZATION_error HOTSPOT_CLASS_INITIALIZATION_ERROR
 104 #define HOTSPOT_CLASS_INITIALIZATION_end HOTSPOT_CLASS_INITIALIZATION_END
 105 #define DTRACE_CLASSINIT_PROBE(type, thread_type)                \
 106   {                                                              \
 107     char* data = NULL;                                           \
 108     int len = 0;                                                 \
 109     Symbol* clss_name = name();                                  \
 110     if (clss_name != NULL) {                                     \
 111       data = (char*)clss_name-&gt;bytes();                          \
 112       len = clss_name-&gt;utf8_length();                            \
 113     }                                                            \
 114     HOTSPOT_CLASS_INITIALIZATION_##type(                         \
 115       data, len, (void*)class_loader(), thread_type);            \
 116   }
 117 
 118 #define DTRACE_CLASSINIT_PROBE_WAIT(type, thread_type, wait)     \
 119   {                                                              \
 120     char* data = NULL;                                           \
 121     int len = 0;                                                 \
 122     Symbol* clss_name = name();                                  \
 123     if (clss_name != NULL) {                                     \
 124       data = (char*)clss_name-&gt;bytes();                          \
 125       len = clss_name-&gt;utf8_length();                            \
 126     }                                                            \
 127     HOTSPOT_CLASS_INITIALIZATION_##type(                         \
 128       data, len, (void*)class_loader(), thread_type, wait);      \
 129   }
 130 
 131 #else //  ndef DTRACE_ENABLED
 132 
 133 #define DTRACE_CLASSINIT_PROBE(type, thread_type)
 134 #define DTRACE_CLASSINIT_PROBE_WAIT(type, thread_type, wait)
 135 
 136 #endif //  ndef DTRACE_ENABLED
 137 
 138 static inline bool is_class_loader(const Symbol* class_name,
 139                                    const ClassFileParser&amp; parser) {
 140   assert(class_name != NULL, &quot;invariant&quot;);
 141 
 142   if (class_name == vmSymbols::java_lang_ClassLoader()) {
 143     return true;
 144   }
 145 
 146   if (SystemDictionary::ClassLoader_klass_loaded()) {
 147     const Klass* const super_klass = parser.super_klass();
 148     if (super_klass != NULL) {
 149       if (super_klass-&gt;is_subtype_of(SystemDictionary::ClassLoader_klass())) {
 150         return true;
 151       }
 152     }
 153   }
 154   return false;
 155 }
 156 
 157 // called to verify that k is a member of this nest
 158 bool InstanceKlass::has_nest_member(InstanceKlass* k, TRAPS) const {
 159   if (_nest_members == NULL || _nest_members == Universe::the_empty_short_array()) {
 160     if (log_is_enabled(Trace, class, nestmates)) {
 161       ResourceMark rm(THREAD);
 162       log_trace(class, nestmates)(&quot;Checked nest membership of %s in non-nest-host class %s&quot;,
 163                                   k-&gt;external_name(), this-&gt;external_name());
 164     }
 165     return false;
 166   }
 167 
 168   if (log_is_enabled(Trace, class, nestmates)) {
 169     ResourceMark rm(THREAD);
 170     log_trace(class, nestmates)(&quot;Checking nest membership of %s in %s&quot;,
 171                                 k-&gt;external_name(), this-&gt;external_name());
 172   }
 173 
 174   // Check for a resolved cp entry , else fall back to a name check.
 175   // We don&#39;t want to resolve any class other than the one being checked.
 176   for (int i = 0; i &lt; _nest_members-&gt;length(); i++) {
 177     int cp_index = _nest_members-&gt;at(i);
 178     if (_constants-&gt;tag_at(cp_index).is_klass()) {
 179       Klass* k2 = _constants-&gt;klass_at(cp_index, CHECK_false);
 180       if (k2 == k) {
 181         log_trace(class, nestmates)(&quot;- class is listed at nest_members[%d] =&gt; cp[%d]&quot;, i, cp_index);
 182         return true;
 183       }
 184     }
 185     else {
 186       Symbol* name = _constants-&gt;klass_name_at(cp_index);
 187       if (name == k-&gt;name()) {
 188         log_trace(class, nestmates)(&quot;- Found it at nest_members[%d] =&gt; cp[%d]&quot;, i, cp_index);
 189 
 190         // Names match so check actual klass - this may trigger class loading if
 191         // it doesn&#39;t match (though that should be impossible). But to be safe we
 192         // have to check for a compiler thread executing here.
 193         if (!THREAD-&gt;can_call_java() &amp;&amp; !_constants-&gt;tag_at(cp_index).is_klass()) {
 194           log_trace(class, nestmates)(&quot;- validation required resolution in an unsuitable thread&quot;);
 195           return false;
 196         }
 197 
 198         Klass* k2 = _constants-&gt;klass_at(cp_index, CHECK_false);
 199         if (k2 == k) {
 200           log_trace(class, nestmates)(&quot;- class is listed as a nest member&quot;);
 201           return true;
 202         }
 203         else {
 204           // same name but different klass!
 205           log_trace(class, nestmates)(&quot; - klass comparison failed!&quot;);
 206           // can&#39;t have two names the same, so we&#39;re done
 207           return false;
 208         }
 209       }
 210     }
 211   }
 212   log_trace(class, nestmates)(&quot;- class is NOT a nest member!&quot;);
 213   return false;
 214 }
 215 
 216 // Return nest-host class, resolving, validating and saving it if needed.
 217 // In cases where this is called from a thread that can not do classloading
 218 // (such as a native JIT thread) then we simply return NULL, which in turn
 219 // causes the access check to return false. Such code will retry the access
 220 // from a more suitable environment later.
 221 InstanceKlass* InstanceKlass::nest_host(Symbol* validationException, TRAPS) {
 222   InstanceKlass* nest_host_k = _nest_host;
 223   if (nest_host_k == NULL) {
 224     // need to resolve and save our nest-host class. This could be attempted
 225     // concurrently but as the result is idempotent and we don&#39;t use the class
 226     // then we do not need any synchronization beyond what is implicitly used
 227     // during class loading.
 228     if (_nest_host_index != 0) { // we have a real nest_host
 229       // Before trying to resolve check if we&#39;re in a suitable context
 230       if (!THREAD-&gt;can_call_java() &amp;&amp; !_constants-&gt;tag_at(_nest_host_index).is_klass()) {
 231         if (log_is_enabled(Trace, class, nestmates)) {
 232           ResourceMark rm(THREAD);
 233           log_trace(class, nestmates)(&quot;Rejected resolution of nest-host of %s in unsuitable thread&quot;,
 234                                       this-&gt;external_name());
 235         }
 236         return NULL;
 237       }
 238 
 239       if (log_is_enabled(Trace, class, nestmates)) {
 240         ResourceMark rm(THREAD);
 241         log_trace(class, nestmates)(&quot;Resolving nest-host of %s using cp entry for %s&quot;,
 242                                     this-&gt;external_name(),
 243                                     _constants-&gt;klass_name_at(_nest_host_index)-&gt;as_C_string());
 244       }
 245 
 246       Klass* k = _constants-&gt;klass_at(_nest_host_index, THREAD);
 247       if (HAS_PENDING_EXCEPTION) {
 248         Handle exc_h = Handle(THREAD, PENDING_EXCEPTION);
 249         if (exc_h-&gt;is_a(SystemDictionary::NoClassDefFoundError_klass())) {
 250           // throw a new CDNFE with the original as its cause, and a clear msg
 251           ResourceMark rm(THREAD);
 252           char buf[200];
 253           CLEAR_PENDING_EXCEPTION;
 254           jio_snprintf(buf, sizeof(buf),
 255                        &quot;Unable to load nest-host class (%s) of %s&quot;,
 256                        _constants-&gt;klass_name_at(_nest_host_index)-&gt;as_C_string(),
 257                        this-&gt;external_name());
 258           log_trace(class, nestmates)(&quot;%s - NoClassDefFoundError&quot;, buf);
 259           THROW_MSG_CAUSE_NULL(vmSymbols::java_lang_NoClassDefFoundError(), buf, exc_h);
 260         }
 261         // All other exceptions pass through (OOME, StackOverflowError, LinkageErrors etc).
 262         return NULL;
 263       }
 264 
 265       // A valid nest-host is an instance class in the current package that lists this
 266       // class as a nest member. If any of these conditions are not met we post the
 267       // requested exception type (if any) and return NULL
 268 
 269       const char* error = NULL;
 270 
 271       // JVMS 5.4.4 indicates package check comes first
 272       if (is_same_class_package(k)) {
 273 
 274         // Now check actual membership. We can&#39;t be a member if our &quot;host&quot; is
 275         // not an instance class.
 276         if (k-&gt;is_instance_klass()) {
 277           nest_host_k = InstanceKlass::cast(k);
 278 
 279           bool is_member = nest_host_k-&gt;has_nest_member(this, CHECK_NULL);
 280           if (is_member) {
 281             // save resolved nest-host value
 282             _nest_host = nest_host_k;
 283 
 284             if (log_is_enabled(Trace, class, nestmates)) {
 285               ResourceMark rm(THREAD);
 286               log_trace(class, nestmates)(&quot;Resolved nest-host of %s to %s&quot;,
 287                                           this-&gt;external_name(), k-&gt;external_name());
 288             }
 289             return nest_host_k;
 290           }
 291         }
 292         error = &quot;current type is not listed as a nest member&quot;;
 293       } else {
 294         error = &quot;types are in different packages&quot;;
 295       }
 296 
 297       if (log_is_enabled(Trace, class, nestmates)) {
 298         ResourceMark rm(THREAD);
 299         log_trace(class, nestmates)
 300           (&quot;Type %s (loader: %s) is not a nest member of &quot;
 301            &quot;resolved type %s (loader: %s): %s&quot;,
 302            this-&gt;external_name(),
 303            this-&gt;class_loader_data()-&gt;loader_name_and_id(),
 304            k-&gt;external_name(),
 305            k-&gt;class_loader_data()-&gt;loader_name_and_id(),
 306            error);
 307       }
 308 
 309       if (validationException != NULL &amp;&amp; THREAD-&gt;can_call_java()) {
 310         ResourceMark rm(THREAD);
 311         Exceptions::fthrow(THREAD_AND_LOCATION,
 312                            validationException,
 313                            &quot;Type %s (loader: %s) is not a nest member of %s (loader: %s): %s&quot;,
 314                            this-&gt;external_name(),
 315                            this-&gt;class_loader_data()-&gt;loader_name_and_id(),
 316                            k-&gt;external_name(),
 317                            k-&gt;class_loader_data()-&gt;loader_name_and_id(),
 318                            error
 319                            );
 320       }
 321       return NULL;
 322     } else {
 323       if (log_is_enabled(Trace, class, nestmates)) {
 324         ResourceMark rm(THREAD);
 325         log_trace(class, nestmates)(&quot;Type %s is not part of a nest: setting nest-host to self&quot;,
 326                                     this-&gt;external_name());
 327       }
 328       // save resolved nest-host value
 329       return (_nest_host = this);
 330     }
 331   }
 332   return nest_host_k;
 333 }
 334 
 335 // check if &#39;this&#39; and k are nestmates (same nest_host), or k is our nest_host,
 336 // or we are k&#39;s nest_host - all of which is covered by comparing the two
 337 // resolved_nest_hosts
 338 bool InstanceKlass::has_nestmate_access_to(InstanceKlass* k, TRAPS) {
 339 
 340   assert(this != k, &quot;this should be handled by higher-level code&quot;);
 341 
 342   // Per JVMS 5.4.4 we first resolve and validate the current class, then
 343   // the target class k. Resolution exceptions will be passed on by upper
 344   // layers. IncompatibleClassChangeErrors from membership validation failures
 345   // will also be passed through.
 346 
 347   Symbol* icce = vmSymbols::java_lang_IncompatibleClassChangeError();
 348   InstanceKlass* cur_host = nest_host(icce, CHECK_false);
 349   if (cur_host == NULL) {
 350     return false;
 351   }
 352 
 353   Klass* k_nest_host = k-&gt;nest_host(icce, CHECK_false);
 354   if (k_nest_host == NULL) {
 355     return false;
 356   }
 357 
 358   bool access = (cur_host == k_nest_host);
 359 
 360   if (log_is_enabled(Trace, class, nestmates)) {
 361     ResourceMark rm(THREAD);
 362     log_trace(class, nestmates)(&quot;Class %s does %shave nestmate access to %s&quot;,
 363                                 this-&gt;external_name(),
 364                                 access ? &quot;&quot; : &quot;NOT &quot;,
 365                                 k-&gt;external_name());
 366   }
 367 
 368   return access;
 369 }
 370 
 371 InstanceKlass* InstanceKlass::allocate_instance_klass(const ClassFileParser&amp; parser, TRAPS) {
 372   const int size = InstanceKlass::size(parser.vtable_size(),
 373                                        parser.itable_size(),
 374                                        nonstatic_oop_map_size(parser.total_oop_map_count()),
 375                                        parser.is_interface(),
 376                                        parser.is_unsafe_anonymous(),
 377                                        should_store_fingerprint(parser.is_unsafe_anonymous()),
 378                                        parser.has_flattenable_fields() ? parser.java_fields_count() : 0,
 379                                        parser.is_value_type());
 380 
 381   const Symbol* const class_name = parser.class_name();
 382   assert(class_name != NULL, &quot;invariant&quot;);
 383   ClassLoaderData* loader_data = parser.loader_data();
 384   assert(loader_data != NULL, &quot;invariant&quot;);
 385 
 386   InstanceKlass* ik;
 387 
 388   // Allocation
 389   if (REF_NONE == parser.reference_type()) {
 390     if (class_name == vmSymbols::java_lang_Class()) {
 391       // mirror
 392       ik = new (loader_data, size, THREAD) InstanceMirrorKlass(parser);
 393     } else if (is_class_loader(class_name, parser)) {
 394       // class loader
 395       ik = new (loader_data, size, THREAD) InstanceClassLoaderKlass(parser);
 396     } else if (parser.is_value_type()) {
 397       // value type
 398       ik = new (loader_data, size, THREAD) ValueKlass(parser);
 399     } else {
 400       // normal
 401       ik = new (loader_data, size, THREAD) InstanceKlass(parser, InstanceKlass::_misc_kind_other);
 402     }
 403   } else {
 404     // reference
 405     ik = new (loader_data, size, THREAD) InstanceRefKlass(parser);
 406   }
 407 
 408   // Check for pending exception before adding to the loader data and incrementing
 409   // class count.  Can get OOM here.
 410   if (HAS_PENDING_EXCEPTION) {
 411     return NULL;
 412   }
 413 
 414 #ifdef ASSERT
 415   assert(ik-&gt;size() == size, &quot;&quot;);
 416   ik-&gt;bounds_check((address) ik-&gt;start_of_vtable(), false, size);
 417   ik-&gt;bounds_check((address) ik-&gt;start_of_itable(), false, size);
 418   ik-&gt;bounds_check((address) ik-&gt;end_of_itable(), true, size);
 419   ik-&gt;bounds_check((address) ik-&gt;end_of_nonstatic_oop_maps(), true, size);
 420 #endif //ASSERT
 421   return ik;
 422 }
 423 
 424 #ifndef PRODUCT
 425 bool InstanceKlass::bounds_check(address addr, bool edge_ok, intptr_t size_in_bytes) const {
 426   const char* bad = NULL;
 427   address end = NULL;
 428   if (addr &lt; (address)this) {
 429     bad = &quot;before&quot;;
 430   } else if (addr == (address)this) {
 431     if (edge_ok)  return true;
 432     bad = &quot;just before&quot;;
 433   } else if (addr == (end = (address)this + sizeof(intptr_t) * (size_in_bytes &lt; 0 ? size() : size_in_bytes))) {
 434     if (edge_ok)  return true;
 435     bad = &quot;just after&quot;;
 436   } else if (addr &gt; end) {
 437     bad = &quot;after&quot;;
 438   } else {
 439     return true;
 440   }
 441   tty-&gt;print_cr(&quot;%s object bounds: &quot; INTPTR_FORMAT &quot; [&quot; INTPTR_FORMAT &quot;..&quot; INTPTR_FORMAT &quot;]&quot;,
 442       bad, (intptr_t)addr, (intptr_t)this, (intptr_t)end);
 443   Verbose = WizardMode = true; this-&gt;print(); //@@
 444   return false;
 445 }
 446 #endif //PRODUCT
 447 
 448 // copy method ordering from resource area to Metaspace
 449 void InstanceKlass::copy_method_ordering(const intArray* m, TRAPS) {
 450   if (m != NULL) {
 451     // allocate a new array and copy contents (memcpy?)
 452     _method_ordering = MetadataFactory::new_array&lt;int&gt;(class_loader_data(), m-&gt;length(), CHECK);
 453     for (int i = 0; i &lt; m-&gt;length(); i++) {
 454       _method_ordering-&gt;at_put(i, m-&gt;at(i));
 455     }
 456   } else {
 457     _method_ordering = Universe::the_empty_int_array();
 458   }
 459 }
 460 
 461 // create a new array of vtable_indices for default methods
 462 Array&lt;int&gt;* InstanceKlass::create_new_default_vtable_indices(int len, TRAPS) {
 463   Array&lt;int&gt;* vtable_indices = MetadataFactory::new_array&lt;int&gt;(class_loader_data(), len, CHECK_NULL);
 464   assert(default_vtable_indices() == NULL, &quot;only create once&quot;);
 465   set_default_vtable_indices(vtable_indices);
 466   return vtable_indices;
 467 }
 468 
 469 InstanceKlass::InstanceKlass(const ClassFileParser&amp; parser, unsigned kind, KlassID id) :
 470   Klass(id),
 471   _nest_members(NULL),
 472   _nest_host_index(0),
 473   _nest_host(NULL),
 474   _record_components(NULL),
 475   _static_field_size(parser.static_field_size()),
 476   _nonstatic_oop_map_size(nonstatic_oop_map_size(parser.total_oop_map_count())),
 477   _itable_len(parser.itable_size()),
 478   _init_thread(NULL),
 479   _init_state(allocated),
 480   _reference_type(parser.reference_type()),
 481   _value_field_klasses(NULL),
 482   _adr_valueklass_fixed_block(NULL)
 483 {
 484   set_vtable_length(parser.vtable_size());
 485   set_kind(kind);
 486   set_access_flags(parser.access_flags());
 487   set_is_unsafe_anonymous(parser.is_unsafe_anonymous());
 488   set_layout_helper(Klass::instance_layout_helper(parser.layout_size(),
 489                                                     false));
 490     if (parser.has_flattenable_fields()) {
 491       set_has_value_fields();
 492     }
 493     _java_fields_count = parser.java_fields_count();
 494 
 495     assert(NULL == _methods, &quot;underlying memory not zeroed?&quot;);
 496     assert(is_instance_klass(), &quot;is layout incorrect?&quot;);
 497     assert(size_helper() == parser.layout_size(), &quot;incorrect size_helper?&quot;);
 498 
 499   if (Arguments::is_dumping_archive()) {
 500       SystemDictionaryShared::init_dumptime_info(this);
 501     }
 502 
 503   // Set biased locking bit for all instances of this class; it will be
 504   // cleared if revocation occurs too often for this type
 505   if (UseBiasedLocking &amp;&amp; BiasedLocking::enabled()) {
 506     set_prototype_header(markWord::biased_locking_prototype());
 507   }
 508   if (has_value_fields()) {
 509     _value_field_klasses = (const Klass**) adr_value_fields_klasses();
 510   }
 511 }
 512 
 513 void InstanceKlass::deallocate_methods(ClassLoaderData* loader_data,
 514                                        Array&lt;Method*&gt;* methods) {
 515   if (methods != NULL &amp;&amp; methods != Universe::the_empty_method_array() &amp;&amp;
 516       !methods-&gt;is_shared()) {
 517     for (int i = 0; i &lt; methods-&gt;length(); i++) {
 518       Method* method = methods-&gt;at(i);
 519       if (method == NULL) continue;  // maybe null if error processing
 520       // Only want to delete methods that are not executing for RedefineClasses.
 521       // The previous version will point to them so they&#39;re not totally dangling
 522       assert (!method-&gt;on_stack(), &quot;shouldn&#39;t be called with methods on stack&quot;);
 523       MetadataFactory::free_metadata(loader_data, method);
 524     }
 525     MetadataFactory::free_array&lt;Method*&gt;(loader_data, methods);
 526   }
 527 }
 528 
 529 void InstanceKlass::deallocate_interfaces(ClassLoaderData* loader_data,
 530                                           const Klass* super_klass,
 531                                           Array&lt;InstanceKlass*&gt;* local_interfaces,
 532                                           Array&lt;InstanceKlass*&gt;* transitive_interfaces) {
 533   // Only deallocate transitive interfaces if not empty, same as super class
 534   // or same as local interfaces.  See code in parseClassFile.
 535   Array&lt;InstanceKlass*&gt;* ti = transitive_interfaces;
 536   if (ti != Universe::the_empty_instance_klass_array() &amp;&amp; ti != local_interfaces) {
 537     // check that the interfaces don&#39;t come from super class
 538     Array&lt;InstanceKlass*&gt;* sti = (super_klass == NULL) ? NULL :
 539                     InstanceKlass::cast(super_klass)-&gt;transitive_interfaces();
 540     if (ti != sti &amp;&amp; ti != NULL &amp;&amp; !ti-&gt;is_shared()) {
 541       MetadataFactory::free_array&lt;InstanceKlass*&gt;(loader_data, ti);
 542     }
 543   }
 544 
 545   // local interfaces can be empty
 546   if (local_interfaces != Universe::the_empty_instance_klass_array() &amp;&amp;
 547       local_interfaces != NULL &amp;&amp; !local_interfaces-&gt;is_shared()) {
 548     MetadataFactory::free_array&lt;InstanceKlass*&gt;(loader_data, local_interfaces);
 549   }
 550 }
 551 
 552 void InstanceKlass::deallocate_record_components(ClassLoaderData* loader_data,
 553                                                  Array&lt;RecordComponent*&gt;* record_components) {
 554   if (record_components != NULL &amp;&amp; !record_components-&gt;is_shared()) {
 555     for (int i = 0; i &lt; record_components-&gt;length(); i++) {
 556       RecordComponent* record_component = record_components-&gt;at(i);
 557       MetadataFactory::free_metadata(loader_data, record_component);
 558     }
 559     MetadataFactory::free_array&lt;RecordComponent*&gt;(loader_data, record_components);
 560   }
 561 }
 562 
 563 // This function deallocates the metadata and C heap pointers that the
 564 // InstanceKlass points to.
 565 void InstanceKlass::deallocate_contents(ClassLoaderData* loader_data) {
 566 
 567   // Orphan the mirror first, CMS thinks it&#39;s still live.
 568   if (java_mirror() != NULL) {
 569     java_lang_Class::set_klass(java_mirror(), NULL);
 570   }
 571 
 572   // Also remove mirror from handles
 573   loader_data-&gt;remove_handle(_java_mirror);
 574 
 575   // Need to take this class off the class loader data list.
 576   loader_data-&gt;remove_class(this);
 577 
 578   // The array_klass for this class is created later, after error handling.
 579   // For class redefinition, we keep the original class so this scratch class
 580   // doesn&#39;t have an array class.  Either way, assert that there is nothing
 581   // to deallocate.
 582   assert(array_klasses() == NULL, &quot;array classes shouldn&#39;t be created for this class yet&quot;);
 583 
 584   // Release C heap allocated data that this might point to, which includes
 585   // reference counting symbol names.
 586   release_C_heap_structures();
 587 
 588   deallocate_methods(loader_data, methods());
 589   set_methods(NULL);
 590 
 591   deallocate_record_components(loader_data, record_components());
 592   set_record_components(NULL);
 593 
 594   if (method_ordering() != NULL &amp;&amp;
 595       method_ordering() != Universe::the_empty_int_array() &amp;&amp;
 596       !method_ordering()-&gt;is_shared()) {
 597     MetadataFactory::free_array&lt;int&gt;(loader_data, method_ordering());
 598   }
 599   set_method_ordering(NULL);
 600 
 601   // default methods can be empty
 602   if (default_methods() != NULL &amp;&amp;
 603       default_methods() != Universe::the_empty_method_array() &amp;&amp;
 604       !default_methods()-&gt;is_shared()) {
 605     MetadataFactory::free_array&lt;Method*&gt;(loader_data, default_methods());
 606   }
 607   // Do NOT deallocate the default methods, they are owned by superinterfaces.
 608   set_default_methods(NULL);
 609 
 610   // default methods vtable indices can be empty
 611   if (default_vtable_indices() != NULL &amp;&amp;
 612       !default_vtable_indices()-&gt;is_shared()) {
 613     MetadataFactory::free_array&lt;int&gt;(loader_data, default_vtable_indices());
 614   }
 615   set_default_vtable_indices(NULL);
 616 
 617 
 618   // This array is in Klass, but remove it with the InstanceKlass since
 619   // this place would be the only caller and it can share memory with transitive
 620   // interfaces.
 621   if (secondary_supers() != NULL &amp;&amp;
 622       secondary_supers() != Universe::the_empty_klass_array() &amp;&amp;
 623       // see comments in compute_secondary_supers about the following cast
 624       (address)(secondary_supers()) != (address)(transitive_interfaces()) &amp;&amp;
 625       !secondary_supers()-&gt;is_shared()) {
 626     MetadataFactory::free_array&lt;Klass*&gt;(loader_data, secondary_supers());
 627   }
 628   set_secondary_supers(NULL);
 629 
 630   deallocate_interfaces(loader_data, super(), local_interfaces(), transitive_interfaces());
 631   set_transitive_interfaces(NULL);
 632   set_local_interfaces(NULL);
 633 
 634   if (fields() != NULL &amp;&amp; !fields()-&gt;is_shared()) {
 635     MetadataFactory::free_array&lt;jushort&gt;(loader_data, fields());
 636   }
 637   set_fields(NULL, 0);
 638 
 639   // If a method from a redefined class is using this constant pool, don&#39;t
 640   // delete it, yet.  The new class&#39;s previous version will point to this.
 641   if (constants() != NULL) {
 642     assert (!constants()-&gt;on_stack(), &quot;shouldn&#39;t be called if anything is onstack&quot;);
 643     if (!constants()-&gt;is_shared()) {
 644       MetadataFactory::free_metadata(loader_data, constants());
 645     }
 646     // Delete any cached resolution errors for the constant pool
 647     SystemDictionary::delete_resolution_error(constants());
 648 
 649     set_constants(NULL);
 650   }
 651 
 652   if (inner_classes() != NULL &amp;&amp;
 653       inner_classes() != Universe::the_empty_short_array() &amp;&amp;
 654       !inner_classes()-&gt;is_shared()) {
 655     MetadataFactory::free_array&lt;jushort&gt;(loader_data, inner_classes());
 656   }
 657   set_inner_classes(NULL);
 658 
 659   if (nest_members() != NULL &amp;&amp;
 660       nest_members() != Universe::the_empty_short_array() &amp;&amp;
 661       !nest_members()-&gt;is_shared()) {
 662     MetadataFactory::free_array&lt;jushort&gt;(loader_data, nest_members());
 663   }
 664   set_nest_members(NULL);
 665 
 666   // We should deallocate the Annotations instance if it&#39;s not in shared spaces.
 667   if (annotations() != NULL &amp;&amp; !annotations()-&gt;is_shared()) {
 668     MetadataFactory::free_metadata(loader_data, annotations());
 669   }
 670   set_annotations(NULL);
 671 
 672   if (Arguments::is_dumping_archive()) {
 673     SystemDictionaryShared::remove_dumptime_info(this);
 674   }
 675 }
 676 
 677 bool InstanceKlass::should_be_initialized() const {
 678   return !is_initialized();
 679 }
 680 
 681 klassItable InstanceKlass::itable() const {
 682   return klassItable(const_cast&lt;InstanceKlass*&gt;(this));
 683 }
 684 
 685 void InstanceKlass::eager_initialize(Thread *thread) {
 686   if (!EagerInitialization) return;
 687 
 688   if (this-&gt;is_not_initialized()) {
 689     // abort if the the class has a class initializer
 690     if (this-&gt;class_initializer() != NULL) return;
 691 
 692     // abort if it is java.lang.Object (initialization is handled in genesis)
 693     Klass* super_klass = super();
 694     if (super_klass == NULL) return;
 695 
 696     // abort if the super class should be initialized
 697     if (!InstanceKlass::cast(super_klass)-&gt;is_initialized()) return;
 698 
 699     // call body to expose the this pointer
 700     eager_initialize_impl();
 701   }
 702 }
 703 
 704 // JVMTI spec thinks there are signers and protection domain in the
 705 // instanceKlass.  These accessors pretend these fields are there.
 706 // The hprof specification also thinks these fields are in InstanceKlass.
 707 oop InstanceKlass::protection_domain() const {
 708   // return the protection_domain from the mirror
 709   return java_lang_Class::protection_domain(java_mirror());
 710 }
 711 
 712 // To remove these from requires an incompatible change and CCC request.
 713 objArrayOop InstanceKlass::signers() const {
 714   // return the signers from the mirror
 715   return java_lang_Class::signers(java_mirror());
 716 }
 717 
 718 oop InstanceKlass::init_lock() const {
 719   // return the init lock from the mirror
 720   oop lock = java_lang_Class::init_lock(java_mirror());
 721   // Prevent reordering with any access of initialization state
 722   OrderAccess::loadload();
 723   assert((oop)lock != NULL || !is_not_initialized(), // initialized or in_error state
 724          &quot;only fully initialized state can have a null lock&quot;);
 725   return lock;
 726 }
 727 
 728 // Set the initialization lock to null so the object can be GC&#39;ed.  Any racing
 729 // threads to get this lock will see a null lock and will not lock.
 730 // That&#39;s okay because they all check for initialized state after getting
 731 // the lock and return.
 732 void InstanceKlass::fence_and_clear_init_lock() {
 733   // make sure previous stores are all done, notably the init_state.
 734   OrderAccess::storestore();
 735   java_lang_Class::set_init_lock(java_mirror(), NULL);
 736   assert(!is_not_initialized(), &quot;class must be initialized now&quot;);
 737 }
 738 
 739 void InstanceKlass::eager_initialize_impl() {
 740   EXCEPTION_MARK;
 741   HandleMark hm(THREAD);
 742   Handle h_init_lock(THREAD, init_lock());
 743   ObjectLocker ol(h_init_lock, THREAD, h_init_lock() != NULL);
 744 
 745   // abort if someone beat us to the initialization
 746   if (!is_not_initialized()) return;  // note: not equivalent to is_initialized()
 747 
 748   ClassState old_state = init_state();
 749   link_class_impl(THREAD);
 750   if (HAS_PENDING_EXCEPTION) {
 751     CLEAR_PENDING_EXCEPTION;
 752     // Abort if linking the class throws an exception.
 753 
 754     // Use a test to avoid redundantly resetting the state if there&#39;s
 755     // no change.  Set_init_state() asserts that state changes make
 756     // progress, whereas here we might just be spinning in place.
 757     if (old_state != _init_state)
 758       set_init_state(old_state);
 759   } else {
 760     // linking successfull, mark class as initialized
 761     set_init_state(fully_initialized);
 762     fence_and_clear_init_lock();
 763     // trace
 764     if (log_is_enabled(Info, class, init)) {
 765       ResourceMark rm(THREAD);
 766       log_info(class, init)(&quot;[Initialized %s without side effects]&quot;, external_name());
 767     }
 768   }
 769 }
 770 
 771 
 772 // See &quot;The Virtual Machine Specification&quot; section 2.16.5 for a detailed explanation of the class initialization
 773 // process. The step comments refers to the procedure described in that section.
 774 // Note: implementation moved to static method to expose the this pointer.
 775 void InstanceKlass::initialize(TRAPS) {
 776   if (this-&gt;should_be_initialized()) {
 777     initialize_impl(CHECK);
 778     // Note: at this point the class may be initialized
 779     //       OR it may be in the state of being initialized
 780     //       in case of recursive initialization!
 781   } else {
 782     assert(is_initialized(), &quot;sanity check&quot;);
 783   }
 784 }
 785 
 786 
 787 bool InstanceKlass::verify_code(TRAPS) {
 788   // 1) Verify the bytecodes
 789   return Verifier::verify(this, should_verify_class(), THREAD);
 790 }
 791 
 792 void InstanceKlass::link_class(TRAPS) {
 793   assert(is_loaded(), &quot;must be loaded&quot;);
 794   if (!is_linked()) {
 795     link_class_impl(CHECK);
 796   }
 797 }
 798 
 799 // Called to verify that a class can link during initialization, without
 800 // throwing a VerifyError.
 801 bool InstanceKlass::link_class_or_fail(TRAPS) {
 802   assert(is_loaded(), &quot;must be loaded&quot;);
 803   if (!is_linked()) {
 804     link_class_impl(CHECK_false);
 805   }
 806   return is_linked();
 807 }
 808 
 809 bool InstanceKlass::link_class_impl(TRAPS) {
<a name="1" id="anc1"></a><span class="line-modified"> 810   if (DumpSharedSpaces &amp;&amp; is_in_error_state()) {</span>
 811     // This is for CDS dumping phase only -- we use the in_error_state to indicate that
 812     // the class has failed verification. Throwing the NoClassDefFoundError here is just
 813     // a convenient way to stop repeat attempts to verify the same (bad) class.
 814     //
 815     // Note that the NoClassDefFoundError is not part of the JLS, and should not be thrown
 816     // if we are executing Java code. This is not a problem for CDS dumping phase since
 817     // it doesn&#39;t execute any Java code.
 818     ResourceMark rm(THREAD);
 819     Exceptions::fthrow(THREAD_AND_LOCATION,
 820                        vmSymbols::java_lang_NoClassDefFoundError(),
 821                        &quot;Class %s, or one of its supertypes, failed class initialization&quot;,
 822                        external_name());
 823     return false;
 824   }
 825   // return if already verified
 826   if (is_linked()) {
 827     return true;
 828   }
 829 
 830   // Timing
 831   // timer handles recursion
 832   assert(THREAD-&gt;is_Java_thread(), &quot;non-JavaThread in link_class_impl&quot;);
 833   JavaThread* jt = (JavaThread*)THREAD;
 834 
 835   // link super class before linking this class
 836   Klass* super_klass = super();
 837   if (super_klass != NULL) {
 838     if (super_klass-&gt;is_interface()) {  // check if super class is an interface
 839       ResourceMark rm(THREAD);
 840       Exceptions::fthrow(
 841         THREAD_AND_LOCATION,
 842         vmSymbols::java_lang_IncompatibleClassChangeError(),
 843         &quot;class %s has interface %s as super class&quot;,
 844         external_name(),
 845         super_klass-&gt;external_name()
 846       );
 847       return false;
 848     }
 849 
 850     InstanceKlass* ik_super = InstanceKlass::cast(super_klass);
 851     ik_super-&gt;link_class_impl(CHECK_false);
 852   }
 853 
 854   // link all interfaces implemented by this class before linking this class
 855   Array&lt;InstanceKlass*&gt;* interfaces = local_interfaces();
 856   int num_interfaces = interfaces-&gt;length();
 857   for (int index = 0; index &lt; num_interfaces; index++) {
 858     InstanceKlass* interk = interfaces-&gt;at(index);
 859     interk-&gt;link_class_impl(CHECK_false);
 860   }
 861 
 862 
 863   // If a class declares a method that uses a value class as an argument
 864   // type or return value type, this value class must be loaded during the
 865   // linking of this class because size and properties of the value class
 866   // must be known in order to be able to perform value type optimizations.
 867   // The implementation below is an approximation of this rule, the code
 868   // iterates over all methods of the current class (including overridden
 869   // methods), not only the methods declared by this class. This
 870   // approximation makes the code simpler, and doesn&#39;t change the semantic
 871   // because classes declaring methods overridden by the current class are
 872   // linked (and have performed their own pre-loading) before the linking
 873   // of the current class.
 874   // This is also the moment to detect potential mismatch between the
 875   // ValueTypes attribute and the kind of the class effectively loaded.
 876 
 877 
 878   // Note:
 879   // Value class types used for flattenable fields are loaded during
 880   // the loading phase (see ClassFileParser::post_process_parsed_stream()).
 881   // Value class types used as element types for array creation
 882   // are not pre-loaded. Their loading is triggered by either anewarray
 883   // or multianewarray bytecodes.
 884 
 885   // Could it be possible to do the following processing only if the
 886   // class uses value types?
 887   {
 888     ResourceMark rm(THREAD);
 889     for (int i = 0; i &lt; methods()-&gt;length(); i++) {
 890       Method* m = methods()-&gt;at(i);
 891       for (SignatureStream ss(m-&gt;signature()); !ss.is_done(); ss.next()) {
 892         if (ss.is_reference()) {
 893           if (ss.is_array()) {
 894             ss.skip_array_prefix();
 895           }
 896           if (ss.type() == T_VALUETYPE) {
 897             Symbol* symb = ss.as_symbol();
 898 
 899             oop loader = class_loader();
 900             oop protection_domain = this-&gt;protection_domain();
 901             Klass* klass = SystemDictionary::resolve_or_fail(symb,
 902                                                              Handle(THREAD, loader), Handle(THREAD, protection_domain), true,
 903                                                              CHECK_false);
 904             if (klass == NULL) {
 905               THROW_(vmSymbols::java_lang_LinkageError(), false);
 906             }
 907             if (!klass-&gt;is_value()) {
 908               Exceptions::fthrow(
 909                 THREAD_AND_LOCATION,
 910                 vmSymbols::java_lang_IncompatibleClassChangeError(),
 911                 &quot;class %s is not an inline type&quot;,
 912                 klass-&gt;external_name());
 913             }
 914           }
 915         }
 916       }
 917     }
 918   }
 919 
 920   // in case the class is linked in the process of linking its superclasses
 921   if (is_linked()) {
 922     return true;
 923   }
 924 
 925   // trace only the link time for this klass that includes
 926   // the verification time
 927   PerfClassTraceTime vmtimer(ClassLoader::perf_class_link_time(),
 928                              ClassLoader::perf_class_link_selftime(),
 929                              ClassLoader::perf_classes_linked(),
 930                              jt-&gt;get_thread_stat()-&gt;perf_recursion_counts_addr(),
 931                              jt-&gt;get_thread_stat()-&gt;perf_timers_addr(),
 932                              PerfClassTraceTime::CLASS_LINK);
 933 
 934   // verification &amp; rewriting
 935   {
 936     HandleMark hm(THREAD);
 937     Handle h_init_lock(THREAD, init_lock());
 938     ObjectLocker ol(h_init_lock, THREAD, h_init_lock() != NULL);
 939     // rewritten will have been set if loader constraint error found
 940     // on an earlier link attempt
 941     // don&#39;t verify or rewrite if already rewritten
 942     //
 943 
 944     if (!is_linked()) {
 945       if (!is_rewritten()) {
 946         {
 947           bool verify_ok = verify_code(THREAD);
 948           if (!verify_ok) {
 949             return false;
 950           }
 951         }
 952 
 953         // Just in case a side-effect of verify linked this class already
 954         // (which can sometimes happen since the verifier loads classes
 955         // using custom class loaders, which are free to initialize things)
 956         if (is_linked()) {
 957           return true;
 958         }
 959 
 960         // also sets rewritten
 961         rewrite_class(CHECK_false);
 962       } else if (is_shared()) {
 963         SystemDictionaryShared::check_verification_constraints(this, CHECK_false);
 964       }
 965 
 966       // relocate jsrs and link methods after they are all rewritten
 967       link_methods(CHECK_false);
 968 
 969       // Initialize the vtable and interface table after
 970       // methods have been rewritten since rewrite may
 971       // fabricate new Method*s.
 972       // also does loader constraint checking
 973       //
 974       // initialize_vtable and initialize_itable need to be rerun for
 975       // a shared class if the class is not loaded by the NULL classloader.
 976       ClassLoaderData * loader_data = class_loader_data();
 977       if (!(is_shared() &amp;&amp;
 978             loader_data-&gt;is_the_null_class_loader_data())) {
 979         vtable().initialize_vtable(true, CHECK_false);
 980         itable().initialize_itable(true, CHECK_false);
 981       }
 982 #ifdef ASSERT
 983       else {
 984         vtable().verify(tty, true);
 985         // In case itable verification is ever added.
 986         // itable().verify(tty, true);
 987       }
 988 #endif
 989 
 990       set_init_state(linked);
 991       if (JvmtiExport::should_post_class_prepare()) {
 992         Thread *thread = THREAD;
 993         assert(thread-&gt;is_Java_thread(), &quot;thread-&gt;is_Java_thread()&quot;);
 994         JvmtiExport::post_class_prepare((JavaThread *) thread, this);
 995       }
 996     }
 997   }
 998   return true;
 999 }
1000 
1001 // Rewrite the byte codes of all of the methods of a class.
1002 // The rewriter must be called exactly once. Rewriting must happen after
1003 // verification but before the first method of the class is executed.
1004 void InstanceKlass::rewrite_class(TRAPS) {
1005   assert(is_loaded(), &quot;must be loaded&quot;);
1006   if (is_rewritten()) {
1007     assert(is_shared(), &quot;rewriting an unshared class?&quot;);
1008     return;
1009   }
1010   Rewriter::rewrite(this, CHECK);
1011   set_rewritten();
1012 }
1013 
1014 // Now relocate and link method entry points after class is rewritten.
1015 // This is outside is_rewritten flag. In case of an exception, it can be
1016 // executed more than once.
1017 void InstanceKlass::link_methods(TRAPS) {
1018   int len = methods()-&gt;length();
1019   for (int i = len-1; i &gt;= 0; i--) {
1020     methodHandle m(THREAD, methods()-&gt;at(i));
1021 
1022     // Set up method entry points for compiler and interpreter    .
1023     m-&gt;link_method(m, CHECK);
1024   }
1025 }
1026 
1027 // Eagerly initialize superinterfaces that declare default methods (concrete instance: any access)
1028 void InstanceKlass::initialize_super_interfaces(TRAPS) {
1029   assert (has_nonstatic_concrete_methods(), &quot;caller should have checked this&quot;);
1030   for (int i = 0; i &lt; local_interfaces()-&gt;length(); ++i) {
1031     InstanceKlass* ik = local_interfaces()-&gt;at(i);
1032 
1033     // Initialization is depth first search ie. we start with top of the inheritance tree
1034     // has_nonstatic_concrete_methods drives searching superinterfaces since it
1035     // means has_nonstatic_concrete_methods in its superinterface hierarchy
1036     if (ik-&gt;has_nonstatic_concrete_methods()) {
1037       ik-&gt;initialize_super_interfaces(CHECK);
1038     }
1039 
1040     // Only initialize() interfaces that &quot;declare&quot; concrete methods.
1041     if (ik-&gt;should_be_initialized() &amp;&amp; ik-&gt;declares_nonstatic_concrete_methods()) {
1042       ik-&gt;initialize(CHECK);
1043     }
1044   }
1045 }
1046 
1047 void InstanceKlass::initialize_impl(TRAPS) {
1048   HandleMark hm(THREAD);
1049 
1050   // Make sure klass is linked (verified) before initialization
1051   // A class could already be verified, since it has been reflected upon.
1052   link_class(CHECK);
1053 
1054   DTRACE_CLASSINIT_PROBE(required, -1);
1055 
1056   bool wait = false;
1057 
1058   assert(THREAD-&gt;is_Java_thread(), &quot;non-JavaThread in initialize_impl&quot;);
1059   JavaThread* jt = (JavaThread*)THREAD;
1060 
1061   // refer to the JVM book page 47 for description of steps
1062   // Step 1
1063   {
1064     Handle h_init_lock(THREAD, init_lock());
1065     ObjectLocker ol(h_init_lock, THREAD, h_init_lock() != NULL);
1066 
1067     // Step 2
1068     // If we were to use wait() instead of waitInterruptibly() then
1069     // we might end up throwing IE from link/symbol resolution sites
1070     // that aren&#39;t expected to throw.  This would wreak havoc.  See 6320309.
1071     while (is_being_initialized() &amp;&amp; !is_reentrant_initialization(jt)) {
1072       wait = true;
1073       jt-&gt;set_class_to_be_initialized(this);
1074       ol.wait_uninterruptibly(jt);
1075       jt-&gt;set_class_to_be_initialized(NULL);
1076     }
1077 
1078     // Step 3
1079     if (is_being_initialized() &amp;&amp; is_reentrant_initialization(jt)) {
1080       DTRACE_CLASSINIT_PROBE_WAIT(recursive, -1, wait);
1081       return;
1082     }
1083 
1084     // Step 4
1085     if (is_initialized()) {
1086       DTRACE_CLASSINIT_PROBE_WAIT(concurrent, -1, wait);
1087       return;
1088     }
1089 
1090     // Step 5
1091     if (is_in_error_state()) {
1092       DTRACE_CLASSINIT_PROBE_WAIT(erroneous, -1, wait);
1093       ResourceMark rm(THREAD);
1094       const char* desc = &quot;Could not initialize class &quot;;
1095       const char* className = external_name();
1096       size_t msglen = strlen(desc) + strlen(className) + 1;
1097       char* message = NEW_RESOURCE_ARRAY(char, msglen);
1098       if (NULL == message) {
1099         // Out of memory: can&#39;t create detailed error message
1100           THROW_MSG(vmSymbols::java_lang_NoClassDefFoundError(), className);
1101       } else {
1102         jio_snprintf(message, msglen, &quot;%s%s&quot;, desc, className);
1103           THROW_MSG(vmSymbols::java_lang_NoClassDefFoundError(), message);
1104       }
1105     }
1106 
1107     // Step 6
1108     set_init_state(being_initialized);
1109     set_init_thread(jt);
1110   }
1111 
1112   // Step 7
1113   // Next, if C is a class rather than an interface, initialize it&#39;s super class and super
1114   // interfaces.
1115   if (!is_interface()) {
1116     Klass* super_klass = super();
1117     if (super_klass != NULL &amp;&amp; super_klass-&gt;should_be_initialized()) {
1118       super_klass-&gt;initialize(THREAD);
1119     }
1120     // If C implements any interface that declares a non-static, concrete method,
1121     // the initialization of C triggers initialization of its super interfaces.
1122     // Only need to recurse if has_nonstatic_concrete_methods which includes declaring and
1123     // having a superinterface that declares, non-static, concrete methods
1124     if (!HAS_PENDING_EXCEPTION &amp;&amp; has_nonstatic_concrete_methods()) {
1125       initialize_super_interfaces(THREAD);
1126     }
1127 
1128     // If any exceptions, complete abruptly, throwing the same exception as above.
1129     if (HAS_PENDING_EXCEPTION) {
1130       Handle e(THREAD, PENDING_EXCEPTION);
1131       CLEAR_PENDING_EXCEPTION;
1132       {
1133         EXCEPTION_MARK;
1134         // Locks object, set state, and notify all waiting threads
1135         set_initialization_state_and_notify(initialization_error, THREAD);
1136         CLEAR_PENDING_EXCEPTION;
1137       }
1138       DTRACE_CLASSINIT_PROBE_WAIT(super__failed, -1, wait);
1139       THROW_OOP(e());
1140     }
1141   }
1142 
1143   // Step 8
1144   // Initialize classes of flattenable fields
1145   {
1146     for (AllFieldStream fs(this); !fs.done(); fs.next()) {
1147       if (fs.is_flattenable()) {
1148         Klass* klass = this-&gt;get_value_field_klass_or_null(fs.index());
1149         if (klass == NULL) {
1150           assert(fs.access_flags().is_static() &amp;&amp; fs.access_flags().is_flattenable(),
1151               &quot;Otherwise should have been pre-loaded&quot;);
1152           klass = SystemDictionary::resolve_or_fail(field_signature(fs.index())-&gt;fundamental_name(THREAD),
1153               Handle(THREAD, class_loader()),
1154               Handle(THREAD, protection_domain()),
1155               true, CHECK);
1156           if (klass == NULL) {
1157             THROW(vmSymbols::java_lang_NoClassDefFoundError());
1158           }
1159           if (!klass-&gt;is_value()) {
1160             THROW(vmSymbols::java_lang_IncompatibleClassChangeError());
1161           }
1162           this-&gt;set_value_field_klass(fs.index(), klass);
1163         }
1164         InstanceKlass::cast(klass)-&gt;initialize(CHECK);
1165         if (fs.access_flags().is_static()) {
1166           if (java_mirror()-&gt;obj_field(fs.offset()) == NULL) {
1167             java_mirror()-&gt;obj_field_put(fs.offset(), ValueKlass::cast(klass)-&gt;default_value());
1168           }
1169         }
1170       }
1171     }
1172   }
1173 
1174 
1175   // Look for aot compiled methods for this klass, including class initializer.
1176   AOTLoader::load_for_klass(this, THREAD);
1177 
1178   // Step 9
1179   {
1180     DTRACE_CLASSINIT_PROBE_WAIT(clinit, -1, wait);
1181     // Timer includes any side effects of class initialization (resolution,
1182     // etc), but not recursive entry into call_class_initializer().
1183     PerfClassTraceTime timer(ClassLoader::perf_class_init_time(),
1184                              ClassLoader::perf_class_init_selftime(),
1185                              ClassLoader::perf_classes_inited(),
1186                              jt-&gt;get_thread_stat()-&gt;perf_recursion_counts_addr(),
1187                              jt-&gt;get_thread_stat()-&gt;perf_timers_addr(),
1188                              PerfClassTraceTime::CLASS_CLINIT);
1189     call_class_initializer(THREAD);
1190   }
1191 
1192   // Step 10
1193   if (!HAS_PENDING_EXCEPTION) {
1194     set_initialization_state_and_notify(fully_initialized, CHECK);
1195     {
1196       debug_only(vtable().verify(tty, true);)
1197     }
1198   }
1199   else {
1200     // Step 11 and 12
1201     Handle e(THREAD, PENDING_EXCEPTION);
1202     CLEAR_PENDING_EXCEPTION;
1203     // JVMTI has already reported the pending exception
1204     // JVMTI internal flag reset is needed in order to report ExceptionInInitializerError
1205     JvmtiExport::clear_detected_exception(jt);
1206     {
1207       EXCEPTION_MARK;
1208       set_initialization_state_and_notify(initialization_error, THREAD);
1209       CLEAR_PENDING_EXCEPTION;   // ignore any exception thrown, class initialization error is thrown below
1210       // JVMTI has already reported the pending exception
1211       // JVMTI internal flag reset is needed in order to report ExceptionInInitializerError
1212       JvmtiExport::clear_detected_exception(jt);
1213     }
1214     DTRACE_CLASSINIT_PROBE_WAIT(error, -1, wait);
1215     if (e-&gt;is_a(SystemDictionary::Error_klass())) {
1216       THROW_OOP(e());
1217     } else {
1218       JavaCallArguments args(e);
1219       THROW_ARG(vmSymbols::java_lang_ExceptionInInitializerError(),
1220                 vmSymbols::throwable_void_signature(),
1221                 &amp;args);
1222     }
1223   }
1224   DTRACE_CLASSINIT_PROBE_WAIT(end, -1, wait);
1225 }
1226 
1227 
1228 void InstanceKlass::set_initialization_state_and_notify(ClassState state, TRAPS) {
1229   Handle h_init_lock(THREAD, init_lock());
1230   if (h_init_lock() != NULL) {
1231     ObjectLocker ol(h_init_lock, THREAD);
1232     set_init_thread(NULL); // reset _init_thread before changing _init_state
1233     set_init_state(state);
1234     fence_and_clear_init_lock();
1235     ol.notify_all(CHECK);
1236   } else {
1237     assert(h_init_lock() != NULL, &quot;The initialization state should never be set twice&quot;);
1238     set_init_thread(NULL); // reset _init_thread before changing _init_state
1239     set_init_state(state);
1240   }
1241 }
1242 
1243 Klass* InstanceKlass::implementor() const {
1244   Klass* volatile* k = adr_implementor();
1245   if (k == NULL) {
1246     return NULL;
1247   } else {
1248     // This load races with inserts, and therefore needs acquire.
1249     Klass* kls = Atomic::load_acquire(k);
1250     if (kls != NULL &amp;&amp; !kls-&gt;is_loader_alive()) {
1251       return NULL;  // don&#39;t return unloaded class
1252     } else {
1253       return kls;
1254     }
1255   }
1256 }
1257 
1258 
1259 void InstanceKlass::set_implementor(Klass* k) {
1260   assert_locked_or_safepoint(Compile_lock);
1261   assert(is_interface(), &quot;not interface&quot;);
1262   Klass* volatile* addr = adr_implementor();
1263   assert(addr != NULL, &quot;null addr&quot;);
1264   if (addr != NULL) {
1265     Atomic::release_store(addr, k);
1266   }
1267 }
1268 
1269 int  InstanceKlass::nof_implementors() const {
1270   Klass* k = implementor();
1271   if (k == NULL) {
1272     return 0;
1273   } else if (k != this) {
1274     return 1;
1275   } else {
1276     return 2;
1277   }
1278 }
1279 
1280 // The embedded _implementor field can only record one implementor.
1281 // When there are more than one implementors, the _implementor field
1282 // is set to the interface Klass* itself. Following are the possible
1283 // values for the _implementor field:
1284 //   NULL                  - no implementor
1285 //   implementor Klass*    - one implementor
1286 //   self                  - more than one implementor
1287 //
1288 // The _implementor field only exists for interfaces.
1289 void InstanceKlass::add_implementor(Klass* k) {
<a name="2" id="anc2"></a><span class="line-modified">1290   assert_lock_strong(Compile_lock);</span>


1291   assert(is_interface(), &quot;not interface&quot;);
1292   // Filter out my subinterfaces.
1293   // (Note: Interfaces are never on the subklass list.)
1294   if (InstanceKlass::cast(k)-&gt;is_interface()) return;
1295 
1296   // Filter out subclasses whose supers already implement me.
1297   // (Note: CHA must walk subclasses of direct implementors
1298   // in order to locate indirect implementors.)
1299   Klass* sk = k-&gt;super();
1300   if (sk != NULL &amp;&amp; InstanceKlass::cast(sk)-&gt;implements_interface(this))
1301     // We only need to check one immediate superclass, since the
1302     // implements_interface query looks at transitive_interfaces.
1303     // Any supers of the super have the same (or fewer) transitive_interfaces.
1304     return;
1305 
1306   Klass* ik = implementor();
1307   if (ik == NULL) {
1308     set_implementor(k);
1309   } else if (ik != this &amp;&amp; ik != k) {
1310     // There is already an implementor. Use itself as an indicator of
1311     // more than one implementors.
1312     set_implementor(this);
1313   }
1314 
1315   // The implementor also implements the transitive_interfaces
1316   for (int index = 0; index &lt; local_interfaces()-&gt;length(); index++) {
1317     InstanceKlass::cast(local_interfaces()-&gt;at(index))-&gt;add_implementor(k);
1318   }
1319 }
1320 
1321 void InstanceKlass::init_implementor() {
1322   if (is_interface()) {
1323     set_implementor(NULL);
1324   }
1325 }
1326 
1327 
1328 void InstanceKlass::process_interfaces(Thread *thread) {
1329   // link this class into the implementors list of every interface it implements
1330   for (int i = local_interfaces()-&gt;length() - 1; i &gt;= 0; i--) {
1331     assert(local_interfaces()-&gt;at(i)-&gt;is_klass(), &quot;must be a klass&quot;);
1332     InstanceKlass* interf = InstanceKlass::cast(local_interfaces()-&gt;at(i));
1333     assert(interf-&gt;is_interface(), &quot;expected interface&quot;);
1334     interf-&gt;add_implementor(this);
1335   }
1336 }
1337 
1338 bool InstanceKlass::can_be_primary_super_slow() const {
1339   if (is_interface())
1340     return false;
1341   else
1342     return Klass::can_be_primary_super_slow();
1343 }
1344 
1345 GrowableArray&lt;Klass*&gt;* InstanceKlass::compute_secondary_supers(int num_extra_slots,
1346                                                                Array&lt;InstanceKlass*&gt;* transitive_interfaces) {
1347   // The secondaries are the implemented interfaces.
1348   Array&lt;InstanceKlass*&gt;* interfaces = transitive_interfaces;
1349   int num_secondaries = num_extra_slots + interfaces-&gt;length();
1350   if (num_secondaries == 0) {
1351     // Must share this for correct bootstrapping!
1352     set_secondary_supers(Universe::the_empty_klass_array());
1353     return NULL;
1354   } else if (num_extra_slots == 0) {
1355     // The secondary super list is exactly the same as the transitive interfaces, so
1356     // let&#39;s use it instead of making a copy.
1357     // Redefine classes has to be careful not to delete this!
1358     // We need the cast because Array&lt;Klass*&gt; is NOT a supertype of Array&lt;InstanceKlass*&gt;,
1359     // (but it&#39;s safe to do here because we won&#39;t write into _secondary_supers from this point on).
1360     set_secondary_supers((Array&lt;Klass*&gt;*)(address)interfaces);
1361     return NULL;
1362   } else {
1363     // Copy transitive interfaces to a temporary growable array to be constructed
1364     // into the secondary super list with extra slots.
1365     GrowableArray&lt;Klass*&gt;* secondaries = new GrowableArray&lt;Klass*&gt;(interfaces-&gt;length());
1366     for (int i = 0; i &lt; interfaces-&gt;length(); i++) {
1367       secondaries-&gt;push(interfaces-&gt;at(i));
1368     }
1369     return secondaries;
1370   }
1371 }
1372 
1373 bool InstanceKlass::implements_interface(Klass* k) const {
1374   if (this == k) return true;
1375   assert(k-&gt;is_interface(), &quot;should be an interface class&quot;);
1376   for (int i = 0; i &lt; transitive_interfaces()-&gt;length(); i++) {
1377     if (transitive_interfaces()-&gt;at(i) == k) {
1378       return true;
1379     }
1380   }
1381   return false;
1382 }
1383 
1384 bool InstanceKlass::is_same_or_direct_interface(Klass *k) const {
1385   // Verify direct super interface
1386   if (this == k) return true;
1387   assert(k-&gt;is_interface(), &quot;should be an interface class&quot;);
1388   for (int i = 0; i &lt; local_interfaces()-&gt;length(); i++) {
1389     if (local_interfaces()-&gt;at(i) == k) {
1390       return true;
1391     }
1392   }
1393   return false;
1394 }
1395 
1396 objArrayOop InstanceKlass::allocate_objArray(int n, int length, TRAPS) {
1397   check_array_allocation_length(length, arrayOopDesc::max_array_length(T_OBJECT), CHECK_NULL);
1398   int size = objArrayOopDesc::object_size(length);
1399   Klass* ak = array_klass(n, CHECK_NULL);
1400   objArrayOop o = (objArrayOop)Universe::heap()-&gt;array_allocate(ak, size, length,
1401                                                                 /* do_zero */ true, CHECK_NULL);
1402   return o;
1403 }
1404 
1405 instanceOop InstanceKlass::register_finalizer(instanceOop i, TRAPS) {
1406   if (TraceFinalizerRegistration) {
1407     tty-&gt;print(&quot;Registered &quot;);
1408     i-&gt;print_value_on(tty);
1409     tty-&gt;print_cr(&quot; (&quot; INTPTR_FORMAT &quot;) as finalizable&quot;, p2i(i));
1410   }
1411   instanceHandle h_i(THREAD, i);
1412   // Pass the handle as argument, JavaCalls::call expects oop as jobjects
1413   JavaValue result(T_VOID);
1414   JavaCallArguments args(h_i);
1415   methodHandle mh (THREAD, Universe::finalizer_register_method());
1416   JavaCalls::call(&amp;result, mh, &amp;args, CHECK_NULL);
1417   return h_i();
1418 }
1419 
1420 instanceOop InstanceKlass::allocate_instance(TRAPS) {
1421   bool has_finalizer_flag = has_finalizer(); // Query before possible GC
1422   int size = size_helper();  // Query before forming handle.
1423 
1424   instanceOop i;
1425 
1426   i = (instanceOop)Universe::heap()-&gt;obj_allocate(this, size, CHECK_NULL);
1427   if (has_finalizer_flag &amp;&amp; !RegisterFinalizersAtInit) {
1428     i = register_finalizer(i, CHECK_NULL);
1429   }
1430   return i;
1431 }
1432 
1433 instanceHandle InstanceKlass::allocate_instance_handle(TRAPS) {
1434   return instanceHandle(THREAD, allocate_instance(THREAD));
1435 }
1436 
1437 void InstanceKlass::check_valid_for_instantiation(bool throwError, TRAPS) {
1438   if (is_interface() || is_abstract()) {
1439     ResourceMark rm(THREAD);
1440     THROW_MSG(throwError ? vmSymbols::java_lang_InstantiationError()
1441               : vmSymbols::java_lang_InstantiationException(), external_name());
1442   }
1443   if (this == SystemDictionary::Class_klass()) {
1444     ResourceMark rm(THREAD);
1445     THROW_MSG(throwError ? vmSymbols::java_lang_IllegalAccessError()
1446               : vmSymbols::java_lang_IllegalAccessException(), external_name());
1447   }
1448 }
1449 
1450 Klass* InstanceKlass::array_klass_impl(ArrayStorageProperties storage_props, bool or_null, int n, TRAPS) {
1451   assert(storage_props.is_empty(), &quot;Unexpected&quot;);
1452   // Need load-acquire for lock-free read
1453   if (array_klasses_acquire() == NULL) {
1454     if (or_null) return NULL;
1455 
1456     ResourceMark rm(THREAD);
1457     JavaThread *jt = (JavaThread *)THREAD;
1458     {
1459       // Atomic creation of array_klasses
1460       MutexLocker ma(THREAD, MultiArray_lock);
1461 
1462       // Check if update has already taken place
1463       if (array_klasses() == NULL) {
1464         Klass*    k = ObjArrayKlass::allocate_objArray_klass(storage_props, 1, this, CHECK_NULL);
1465         // use &#39;release&#39; to pair with lock-free load
1466         release_set_array_klasses(k);
1467       }
1468     }
1469   }
1470   // _this will always be set at this point
1471   ObjArrayKlass* oak = (ObjArrayKlass*)array_klasses();
1472   if (or_null) {
1473     return oak-&gt;array_klass_or_null(storage_props, n);
1474   }
1475   return oak-&gt;array_klass(storage_props, n, THREAD);
1476 }
1477 
1478 Klass* InstanceKlass::array_klass_impl(ArrayStorageProperties storage_props, bool or_null, TRAPS) {
1479   return array_klass_impl(storage_props, or_null, 1, THREAD);
1480 }
1481 
1482 static int call_class_initializer_counter = 0;   // for debugging
1483 
1484 Method* InstanceKlass::class_initializer() const {
1485   Method* clinit = find_method(
1486       vmSymbols::class_initializer_name(), vmSymbols::void_method_signature());
1487   if (clinit != NULL &amp;&amp; clinit-&gt;is_class_initializer()) {
1488     return clinit;
1489   }
1490   return NULL;
1491 }
1492 
1493 void InstanceKlass::call_class_initializer(TRAPS) {
1494   if (ReplayCompiles &amp;&amp;
1495       (ReplaySuppressInitializers == 1 ||
1496        (ReplaySuppressInitializers &gt;= 2 &amp;&amp; class_loader() != NULL))) {
1497     // Hide the existence of the initializer for the purpose of replaying the compile
1498     return;
1499   }
1500 
1501   methodHandle h_method(THREAD, class_initializer());
1502   assert(!is_initialized(), &quot;we cannot initialize twice&quot;);
1503   LogTarget(Info, class, init) lt;
1504   if (lt.is_enabled()) {
1505     ResourceMark rm(THREAD);
1506     LogStream ls(lt);
1507     ls.print(&quot;%d Initializing &quot;, call_class_initializer_counter++);
1508     name()-&gt;print_value_on(&amp;ls);
1509     ls.print_cr(&quot;%s (&quot; INTPTR_FORMAT &quot;)&quot;, h_method() == NULL ? &quot;(no method)&quot; : &quot;&quot;, p2i(this));
1510   }
1511   if (h_method() != NULL) {
1512     JavaCallArguments args; // No arguments
1513     JavaValue result(T_VOID);
1514     JavaCalls::call(&amp;result, h_method, &amp;args, CHECK); // Static call (no args)
1515   }
1516 }
1517 
1518 
1519 void InstanceKlass::mask_for(const methodHandle&amp; method, int bci,
1520   InterpreterOopMap* entry_for) {
1521   // Lazily create the _oop_map_cache at first request
1522   // Lock-free access requires load_acquire.
1523   OopMapCache* oop_map_cache = Atomic::load_acquire(&amp;_oop_map_cache);
1524   if (oop_map_cache == NULL) {
1525     MutexLocker x(OopMapCacheAlloc_lock,  Mutex::_no_safepoint_check_flag);
1526     // Check if _oop_map_cache was allocated while we were waiting for this lock
1527     if ((oop_map_cache = _oop_map_cache) == NULL) {
1528       oop_map_cache = new OopMapCache();
1529       // Ensure _oop_map_cache is stable, since it is examined without a lock
1530       Atomic::release_store(&amp;_oop_map_cache, oop_map_cache);
1531     }
1532   }
1533   // _oop_map_cache is constant after init; lookup below does its own locking.
1534   oop_map_cache-&gt;lookup(method, bci, entry_for);
1535 }
1536 
1537 bool InstanceKlass::find_local_field(Symbol* name, Symbol* sig, fieldDescriptor* fd) const {
1538   for (JavaFieldStream fs(this); !fs.done(); fs.next()) {
1539     Symbol* f_name = fs.name();
1540     Symbol* f_sig  = fs.signature();
1541     if (f_name == name &amp;&amp; f_sig == sig) {
1542       fd-&gt;reinitialize(const_cast&lt;InstanceKlass*&gt;(this), fs.index());
1543       return true;
1544     }
1545   }
1546   return false;
1547 }
1548 
1549 
1550 Klass* InstanceKlass::find_interface_field(Symbol* name, Symbol* sig, fieldDescriptor* fd) const {
1551   const int n = local_interfaces()-&gt;length();
1552   for (int i = 0; i &lt; n; i++) {
1553     Klass* intf1 = local_interfaces()-&gt;at(i);
1554     assert(intf1-&gt;is_interface(), &quot;just checking type&quot;);
1555     // search for field in current interface
1556     if (InstanceKlass::cast(intf1)-&gt;find_local_field(name, sig, fd)) {
1557       assert(fd-&gt;is_static(), &quot;interface field must be static&quot;);
1558       return intf1;
1559     }
1560     // search for field in direct superinterfaces
1561     Klass* intf2 = InstanceKlass::cast(intf1)-&gt;find_interface_field(name, sig, fd);
1562     if (intf2 != NULL) return intf2;
1563   }
1564   // otherwise field lookup fails
1565   return NULL;
1566 }
1567 
1568 
1569 Klass* InstanceKlass::find_field(Symbol* name, Symbol* sig, fieldDescriptor* fd) const {
1570   // search order according to newest JVM spec (5.4.3.2, p.167).
1571   // 1) search for field in current klass
1572   if (find_local_field(name, sig, fd)) {
1573     return const_cast&lt;InstanceKlass*&gt;(this);
1574   }
1575   // 2) search for field recursively in direct superinterfaces
1576   { Klass* intf = find_interface_field(name, sig, fd);
1577     if (intf != NULL) return intf;
1578   }
1579   // 3) apply field lookup recursively if superclass exists
1580   { Klass* supr = super();
1581     if (supr != NULL) return InstanceKlass::cast(supr)-&gt;find_field(name, sig, fd);
1582   }
1583   // 4) otherwise field lookup fails
1584   return NULL;
1585 }
1586 
1587 
1588 Klass* InstanceKlass::find_field(Symbol* name, Symbol* sig, bool is_static, fieldDescriptor* fd) const {
1589   // search order according to newest JVM spec (5.4.3.2, p.167).
1590   // 1) search for field in current klass
1591   if (find_local_field(name, sig, fd)) {
1592     if (fd-&gt;is_static() == is_static) return const_cast&lt;InstanceKlass*&gt;(this);
1593   }
1594   // 2) search for field recursively in direct superinterfaces
1595   if (is_static) {
1596     Klass* intf = find_interface_field(name, sig, fd);
1597     if (intf != NULL) return intf;
1598   }
1599   // 3) apply field lookup recursively if superclass exists
1600   { Klass* supr = super();
1601     if (supr != NULL) return InstanceKlass::cast(supr)-&gt;find_field(name, sig, is_static, fd);
1602   }
1603   // 4) otherwise field lookup fails
1604   return NULL;
1605 }
1606 
1607 bool InstanceKlass::contains_field_offset(int offset) {
1608   if (this-&gt;is_value()) {
1609     ValueKlass* vk = ValueKlass::cast(this);
1610     return offset &gt;= vk-&gt;first_field_offset() &amp;&amp; offset &lt; (vk-&gt;first_field_offset() + vk-&gt;get_exact_size_in_bytes());
1611   } else {
1612     fieldDescriptor fd;
1613     return find_field_from_offset(offset, false, &amp;fd);
1614   }
1615 }
1616 
1617 bool InstanceKlass::find_local_field_from_offset(int offset, bool is_static, fieldDescriptor* fd) const {
1618   for (JavaFieldStream fs(this); !fs.done(); fs.next()) {
1619     if (fs.offset() == offset) {
1620       fd-&gt;reinitialize(const_cast&lt;InstanceKlass*&gt;(this), fs.index());
1621       if (fd-&gt;is_static() == is_static) return true;
1622     }
1623   }
1624   return false;
1625 }
1626 
1627 
1628 bool InstanceKlass::find_field_from_offset(int offset, bool is_static, fieldDescriptor* fd) const {
1629   Klass* klass = const_cast&lt;InstanceKlass*&gt;(this);
1630   while (klass != NULL) {
1631     if (InstanceKlass::cast(klass)-&gt;find_local_field_from_offset(offset, is_static, fd)) {
1632       return true;
1633     }
1634     klass = klass-&gt;super();
1635   }
1636   return false;
1637 }
1638 
1639 
1640 void InstanceKlass::methods_do(void f(Method* method)) {
1641   // Methods aren&#39;t stable until they are loaded.  This can be read outside
1642   // a lock through the ClassLoaderData for profiling
1643   if (!is_loaded()) {
1644     return;
1645   }
1646 
1647   int len = methods()-&gt;length();
1648   for (int index = 0; index &lt; len; index++) {
1649     Method* m = methods()-&gt;at(index);
1650     assert(m-&gt;is_method(), &quot;must be method&quot;);
1651     f(m);
1652   }
1653 }
1654 
1655 
1656 void InstanceKlass::do_local_static_fields(FieldClosure* cl) {
1657   for (JavaFieldStream fs(this); !fs.done(); fs.next()) {
1658     if (fs.access_flags().is_static()) {
1659       fieldDescriptor&amp; fd = fs.field_descriptor();
1660       cl-&gt;do_field(&amp;fd);
1661     }
1662   }
1663 }
1664 
1665 
1666 void InstanceKlass::do_local_static_fields(void f(fieldDescriptor*, Handle, TRAPS), Handle mirror, TRAPS) {
1667   for (JavaFieldStream fs(this); !fs.done(); fs.next()) {
1668     if (fs.access_flags().is_static()) {
1669       fieldDescriptor&amp; fd = fs.field_descriptor();
1670       f(&amp;fd, mirror, CHECK);
1671     }
1672   }
1673 }
1674 
1675 
1676 static int compare_fields_by_offset(int* a, int* b) {
1677   return a[0] - b[0];
1678 }
1679 
1680 void InstanceKlass::do_nonstatic_fields(FieldClosure* cl) {
1681   InstanceKlass* super = superklass();
1682   if (super != NULL) {
1683     super-&gt;do_nonstatic_fields(cl);
1684   }
1685   fieldDescriptor fd;
1686   int length = java_fields_count();
1687   // In DebugInfo nonstatic fields are sorted by offset.
1688   int* fields_sorted = NEW_C_HEAP_ARRAY(int, 2*(length+1), mtClass);
1689   int j = 0;
1690   for (int i = 0; i &lt; length; i += 1) {
1691     fd.reinitialize(this, i);
1692     if (!fd.is_static()) {
1693       fields_sorted[j + 0] = fd.offset();
1694       fields_sorted[j + 1] = i;
1695       j += 2;
1696     }
1697   }
1698   if (j &gt; 0) {
1699     length = j;
1700     // _sort_Fn is defined in growableArray.hpp.
1701     qsort(fields_sorted, length/2, 2*sizeof(int), (_sort_Fn)compare_fields_by_offset);
1702     for (int i = 0; i &lt; length; i += 2) {
1703       fd.reinitialize(this, fields_sorted[i + 1]);
1704       assert(!fd.is_static() &amp;&amp; fd.offset() == fields_sorted[i], &quot;only nonstatic fields&quot;);
1705       cl-&gt;do_field(&amp;fd);
1706     }
1707   }
1708   FREE_C_HEAP_ARRAY(int, fields_sorted);
1709 }
1710 
1711 
1712 void InstanceKlass::array_klasses_do(void f(Klass* k)) {
1713   if (array_klasses() != NULL)
1714     ArrayKlass::cast(array_klasses())-&gt;array_klasses_do(f);
1715 }
1716 
1717 #ifdef ASSERT
1718 static int linear_search(const Array&lt;Method*&gt;* methods,
1719                          const Symbol* name,
1720                          const Symbol* signature) {
1721   const int len = methods-&gt;length();
1722   for (int index = 0; index &lt; len; index++) {
1723     const Method* const m = methods-&gt;at(index);
1724     assert(m-&gt;is_method(), &quot;must be method&quot;);
1725     if (m-&gt;signature() == signature &amp;&amp; m-&gt;name() == name) {
1726        return index;
1727     }
1728   }
1729   return -1;
1730 }
1731 #endif
1732 
1733 bool InstanceKlass::_disable_method_binary_search = false;
1734 
1735 NOINLINE int linear_search(const Array&lt;Method*&gt;* methods, const Symbol* name) {
1736   int len = methods-&gt;length();
1737   int l = 0;
1738   int h = len - 1;
1739   while (l &lt;= h) {
1740     Method* m = methods-&gt;at(l);
1741     if (m-&gt;name() == name) {
1742       return l;
1743     }
1744     l++;
1745   }
1746   return -1;
1747 }
1748 
1749 inline int InstanceKlass::quick_search(const Array&lt;Method*&gt;* methods, const Symbol* name) {
1750   if (_disable_method_binary_search) {
1751     assert(DynamicDumpSharedSpaces, &quot;must be&quot;);
1752     // At the final stage of dynamic dumping, the methods array may not be sorted
1753     // by ascending addresses of their names, so we can&#39;t use binary search anymore.
1754     // However, methods with the same name are still laid out consecutively inside the
1755     // methods array, so let&#39;s look for the first one that matches.
1756     return linear_search(methods, name);
1757   }
1758 
1759   int len = methods-&gt;length();
1760   int l = 0;
1761   int h = len - 1;
1762 
1763   // methods are sorted by ascending addresses of their names, so do binary search
1764   while (l &lt;= h) {
1765     int mid = (l + h) &gt;&gt; 1;
1766     Method* m = methods-&gt;at(mid);
1767     assert(m-&gt;is_method(), &quot;must be method&quot;);
1768     int res = m-&gt;name()-&gt;fast_compare(name);
1769     if (res == 0) {
1770       return mid;
1771     } else if (res &lt; 0) {
1772       l = mid + 1;
1773     } else {
1774       h = mid - 1;
1775     }
1776   }
1777   return -1;
1778 }
1779 
1780 // find_method looks up the name/signature in the local methods array
1781 Method* InstanceKlass::find_method(const Symbol* name,
1782                                    const Symbol* signature) const {
1783   return find_method_impl(name, signature, find_overpass, find_static, find_private);
1784 }
1785 
1786 Method* InstanceKlass::find_method_impl(const Symbol* name,
1787                                         const Symbol* signature,
1788                                         OverpassLookupMode overpass_mode,
1789                                         StaticLookupMode static_mode,
1790                                         PrivateLookupMode private_mode) const {
1791   return InstanceKlass::find_method_impl(methods(),
1792                                          name,
1793                                          signature,
1794                                          overpass_mode,
1795                                          static_mode,
1796                                          private_mode);
1797 }
1798 
1799 // find_instance_method looks up the name/signature in the local methods array
1800 // and skips over static methods
1801 Method* InstanceKlass::find_instance_method(const Array&lt;Method*&gt;* methods,
1802                                             const Symbol* name,
1803                                             const Symbol* signature,
1804                                             PrivateLookupMode private_mode) {
1805   Method* const meth = InstanceKlass::find_method_impl(methods,
1806                                                  name,
1807                                                  signature,
1808                                                  find_overpass,
1809                                                  skip_static,
1810                                                  private_mode);
1811   assert(((meth == NULL) || !meth-&gt;is_static()),
1812     &quot;find_instance_method should have skipped statics&quot;);
1813   return meth;
1814 }
1815 
1816 // find_instance_method looks up the name/signature in the local methods array
1817 // and skips over static methods
1818 Method* InstanceKlass::find_instance_method(const Symbol* name,
1819                                             const Symbol* signature,
1820                                             PrivateLookupMode private_mode) const {
1821   return InstanceKlass::find_instance_method(methods(), name, signature, private_mode);
1822 }
1823 
1824 // Find looks up the name/signature in the local methods array
1825 // and filters on the overpass, static and private flags
1826 // This returns the first one found
1827 // note that the local methods array can have up to one overpass, one static
1828 // and one instance (private or not) with the same name/signature
1829 Method* InstanceKlass::find_local_method(const Symbol* name,
1830                                          const Symbol* signature,
1831                                          OverpassLookupMode overpass_mode,
1832                                          StaticLookupMode static_mode,
1833                                          PrivateLookupMode private_mode) const {
1834   return InstanceKlass::find_method_impl(methods(),
1835                                          name,
1836                                          signature,
1837                                          overpass_mode,
1838                                          static_mode,
1839                                          private_mode);
1840 }
1841 
1842 // Find looks up the name/signature in the local methods array
1843 // and filters on the overpass, static and private flags
1844 // This returns the first one found
1845 // note that the local methods array can have up to one overpass, one static
1846 // and one instance (private or not) with the same name/signature
1847 Method* InstanceKlass::find_local_method(const Array&lt;Method*&gt;* methods,
1848                                          const Symbol* name,
1849                                          const Symbol* signature,
1850                                          OverpassLookupMode overpass_mode,
1851                                          StaticLookupMode static_mode,
1852                                          PrivateLookupMode private_mode) {
1853   return InstanceKlass::find_method_impl(methods,
1854                                          name,
1855                                          signature,
1856                                          overpass_mode,
1857                                          static_mode,
1858                                          private_mode);
1859 }
1860 
1861 Method* InstanceKlass::find_method(const Array&lt;Method*&gt;* methods,
1862                                    const Symbol* name,
1863                                    const Symbol* signature) {
1864   return InstanceKlass::find_method_impl(methods,
1865                                          name,
1866                                          signature,
1867                                          find_overpass,
1868                                          find_static,
1869                                          find_private);
1870 }
1871 
1872 Method* InstanceKlass::find_method_impl(const Array&lt;Method*&gt;* methods,
1873                                         const Symbol* name,
1874                                         const Symbol* signature,
1875                                         OverpassLookupMode overpass_mode,
1876                                         StaticLookupMode static_mode,
1877                                         PrivateLookupMode private_mode) {
1878   int hit = find_method_index(methods, name, signature, overpass_mode, static_mode, private_mode);
1879   return hit &gt;= 0 ? methods-&gt;at(hit): NULL;
1880 }
1881 
1882 // true if method matches signature and conforms to skipping_X conditions.
1883 static bool method_matches(const Method* m,
1884                            const Symbol* signature,
1885                            bool skipping_overpass,
1886                            bool skipping_static,
1887                            bool skipping_private) {
1888   return ((m-&gt;signature() == signature) &amp;&amp;
1889     (!skipping_overpass || !m-&gt;is_overpass()) &amp;&amp;
1890     (!skipping_static || !m-&gt;is_static()) &amp;&amp;
1891     (!skipping_private || !m-&gt;is_private()));
1892 }
1893 
1894 // Used directly for default_methods to find the index into the
1895 // default_vtable_indices, and indirectly by find_method
1896 // find_method_index looks in the local methods array to return the index
1897 // of the matching name/signature. If, overpass methods are being ignored,
1898 // the search continues to find a potential non-overpass match.  This capability
1899 // is important during method resolution to prefer a static method, for example,
1900 // over an overpass method.
1901 // There is the possibility in any _method&#39;s array to have the same name/signature
1902 // for a static method, an overpass method and a local instance method
1903 // To correctly catch a given method, the search criteria may need
1904 // to explicitly skip the other two. For local instance methods, it
1905 // is often necessary to skip private methods
1906 int InstanceKlass::find_method_index(const Array&lt;Method*&gt;* methods,
1907                                      const Symbol* name,
1908                                      const Symbol* signature,
1909                                      OverpassLookupMode overpass_mode,
1910                                      StaticLookupMode static_mode,
1911                                      PrivateLookupMode private_mode) {
1912   const bool skipping_overpass = (overpass_mode == skip_overpass);
1913   const bool skipping_static = (static_mode == skip_static);
1914   const bool skipping_private = (private_mode == skip_private);
1915   const int hit = quick_search(methods, name);
1916   if (hit != -1) {
1917     const Method* const m = methods-&gt;at(hit);
1918 
1919     // Do linear search to find matching signature.  First, quick check
1920     // for common case, ignoring overpasses if requested.
1921     if (method_matches(m, signature, skipping_overpass, skipping_static, skipping_private)) {
1922       return hit;
1923     }
1924 
1925     // search downwards through overloaded methods
1926     int i;
1927     for (i = hit - 1; i &gt;= 0; --i) {
1928         const Method* const m = methods-&gt;at(i);
1929         assert(m-&gt;is_method(), &quot;must be method&quot;);
1930         if (m-&gt;name() != name) {
1931           break;
1932         }
1933         if (method_matches(m, signature, skipping_overpass, skipping_static, skipping_private)) {
1934           return i;
1935         }
1936     }
1937     // search upwards
1938     for (i = hit + 1; i &lt; methods-&gt;length(); ++i) {
1939         const Method* const m = methods-&gt;at(i);
1940         assert(m-&gt;is_method(), &quot;must be method&quot;);
1941         if (m-&gt;name() != name) {
1942           break;
1943         }
1944         if (method_matches(m, signature, skipping_overpass, skipping_static, skipping_private)) {
1945           return i;
1946         }
1947     }
1948     // not found
1949 #ifdef ASSERT
1950     const int index = (skipping_overpass || skipping_static || skipping_private) ? -1 :
1951       linear_search(methods, name, signature);
1952     assert(-1 == index, &quot;binary search should have found entry %d&quot;, index);
1953 #endif
1954   }
1955   return -1;
1956 }
1957 
1958 int InstanceKlass::find_method_by_name(const Symbol* name, int* end) const {
1959   return find_method_by_name(methods(), name, end);
1960 }
1961 
1962 int InstanceKlass::find_method_by_name(const Array&lt;Method*&gt;* methods,
1963                                        const Symbol* name,
1964                                        int* end_ptr) {
1965   assert(end_ptr != NULL, &quot;just checking&quot;);
1966   int start = quick_search(methods, name);
1967   int end = start + 1;
1968   if (start != -1) {
1969     while (start - 1 &gt;= 0 &amp;&amp; (methods-&gt;at(start - 1))-&gt;name() == name) --start;
1970     while (end &lt; methods-&gt;length() &amp;&amp; (methods-&gt;at(end))-&gt;name() == name) ++end;
1971     *end_ptr = end;
1972     return start;
1973   }
1974   return -1;
1975 }
1976 
1977 // uncached_lookup_method searches both the local class methods array and all
1978 // superclasses methods arrays, skipping any overpass methods in superclasses,
1979 // and possibly skipping private methods.
1980 Method* InstanceKlass::uncached_lookup_method(const Symbol* name,
1981                                               const Symbol* signature,
1982                                               OverpassLookupMode overpass_mode,
1983                                               PrivateLookupMode private_mode) const {
1984   OverpassLookupMode overpass_local_mode = overpass_mode;
1985   const Klass* klass = this;
1986   while (klass != NULL) {
1987     Method* const method = InstanceKlass::cast(klass)-&gt;find_method_impl(name,
1988                                                                         signature,
1989                                                                         overpass_local_mode,
1990                                                                         find_static,
1991                                                                         private_mode);
1992     if (method != NULL) {
1993       return method;
1994     }
1995     if (name == vmSymbols::object_initializer_name()) {
1996       break;  // &lt;init&gt; is never inherited, not even as a static factory
1997     }
1998     klass = klass-&gt;super();
1999     overpass_local_mode = skip_overpass;   // Always ignore overpass methods in superclasses
2000   }
2001   return NULL;
2002 }
2003 
2004 #ifdef ASSERT
2005 // search through class hierarchy and return true if this class or
2006 // one of the superclasses was redefined
2007 bool InstanceKlass::has_redefined_this_or_super() const {
2008   const Klass* klass = this;
2009   while (klass != NULL) {
2010     if (InstanceKlass::cast(klass)-&gt;has_been_redefined()) {
2011       return true;
2012     }
2013     klass = klass-&gt;super();
2014   }
2015   return false;
2016 }
2017 #endif
2018 
2019 // lookup a method in the default methods list then in all transitive interfaces
2020 // Do NOT return private or static methods
2021 Method* InstanceKlass::lookup_method_in_ordered_interfaces(Symbol* name,
2022                                                          Symbol* signature) const {
2023   Method* m = NULL;
2024   if (default_methods() != NULL) {
2025     m = find_method(default_methods(), name, signature);
2026   }
2027   // Look up interfaces
2028   if (m == NULL) {
2029     m = lookup_method_in_all_interfaces(name, signature, find_defaults);
2030   }
2031   return m;
2032 }
2033 
2034 // lookup a method in all the interfaces that this class implements
2035 // Do NOT return private or static methods, new in JDK8 which are not externally visible
2036 // They should only be found in the initial InterfaceMethodRef
2037 Method* InstanceKlass::lookup_method_in_all_interfaces(Symbol* name,
2038                                                        Symbol* signature,
2039                                                        DefaultsLookupMode defaults_mode) const {
2040   Array&lt;InstanceKlass*&gt;* all_ifs = transitive_interfaces();
2041   int num_ifs = all_ifs-&gt;length();
2042   InstanceKlass *ik = NULL;
2043   for (int i = 0; i &lt; num_ifs; i++) {
2044     ik = all_ifs-&gt;at(i);
2045     Method* m = ik-&gt;lookup_method(name, signature);
2046     if (m != NULL &amp;&amp; m-&gt;is_public() &amp;&amp; !m-&gt;is_static() &amp;&amp;
2047         ((defaults_mode != skip_defaults) || !m-&gt;is_default_method())) {
2048       return m;
2049     }
2050   }
2051   return NULL;
2052 }
2053 
2054 /* jni_id_for_impl for jfieldIds only */
2055 JNIid* InstanceKlass::jni_id_for_impl(int offset) {
2056   MutexLocker ml(JfieldIdCreation_lock);
2057   // Retry lookup after we got the lock
2058   JNIid* probe = jni_ids() == NULL ? NULL : jni_ids()-&gt;find(offset);
2059   if (probe == NULL) {
2060     // Slow case, allocate new static field identifier
2061     probe = new JNIid(this, offset, jni_ids());
2062     set_jni_ids(probe);
2063   }
2064   return probe;
2065 }
2066 
2067 
2068 /* jni_id_for for jfieldIds only */
2069 JNIid* InstanceKlass::jni_id_for(int offset) {
2070   JNIid* probe = jni_ids() == NULL ? NULL : jni_ids()-&gt;find(offset);
2071   if (probe == NULL) {
2072     probe = jni_id_for_impl(offset);
2073   }
2074   return probe;
2075 }
2076 
2077 u2 InstanceKlass::enclosing_method_data(int offset) const {
2078   const Array&lt;jushort&gt;* const inner_class_list = inner_classes();
2079   if (inner_class_list == NULL) {
2080     return 0;
2081   }
2082   const int length = inner_class_list-&gt;length();
2083   if (length % inner_class_next_offset == 0) {
2084     return 0;
2085   }
2086   const int index = length - enclosing_method_attribute_size;
2087   assert(offset &lt; enclosing_method_attribute_size, &quot;invalid offset&quot;);
2088   return inner_class_list-&gt;at(index + offset);
2089 }
2090 
2091 void InstanceKlass::set_enclosing_method_indices(u2 class_index,
2092                                                  u2 method_index) {
2093   Array&lt;jushort&gt;* inner_class_list = inner_classes();
2094   assert (inner_class_list != NULL, &quot;_inner_classes list is not set up&quot;);
2095   int length = inner_class_list-&gt;length();
2096   if (length % inner_class_next_offset == enclosing_method_attribute_size) {
2097     int index = length - enclosing_method_attribute_size;
2098     inner_class_list-&gt;at_put(
2099       index + enclosing_method_class_index_offset, class_index);
2100     inner_class_list-&gt;at_put(
2101       index + enclosing_method_method_index_offset, method_index);
2102   }
2103 }
2104 
2105 // Lookup or create a jmethodID.
2106 // This code is called by the VMThread and JavaThreads so the
2107 // locking has to be done very carefully to avoid deadlocks
2108 // and/or other cache consistency problems.
2109 //
2110 jmethodID InstanceKlass::get_jmethod_id(const methodHandle&amp; method_h) {
2111   size_t idnum = (size_t)method_h-&gt;method_idnum();
2112   jmethodID* jmeths = methods_jmethod_ids_acquire();
2113   size_t length = 0;
2114   jmethodID id = NULL;
2115 
2116   // We use a double-check locking idiom here because this cache is
2117   // performance sensitive. In the normal system, this cache only
2118   // transitions from NULL to non-NULL which is safe because we use
2119   // release_set_methods_jmethod_ids() to advertise the new cache.
2120   // A partially constructed cache should never be seen by a racing
2121   // thread. We also use release_store() to save a new jmethodID
2122   // in the cache so a partially constructed jmethodID should never be
2123   // seen either. Cache reads of existing jmethodIDs proceed without a
2124   // lock, but cache writes of a new jmethodID requires uniqueness and
2125   // creation of the cache itself requires no leaks so a lock is
2126   // generally acquired in those two cases.
2127   //
2128   // If the RedefineClasses() API has been used, then this cache can
2129   // grow and we&#39;ll have transitions from non-NULL to bigger non-NULL.
2130   // Cache creation requires no leaks and we require safety between all
2131   // cache accesses and freeing of the old cache so a lock is generally
2132   // acquired when the RedefineClasses() API has been used.
2133 
2134   if (jmeths != NULL) {
2135     // the cache already exists
2136     if (!idnum_can_increment()) {
2137       // the cache can&#39;t grow so we can just get the current values
2138       get_jmethod_id_length_value(jmeths, idnum, &amp;length, &amp;id);
2139     } else {
2140       // cache can grow so we have to be more careful
2141       if (Threads::number_of_threads() == 0 ||
2142           SafepointSynchronize::is_at_safepoint()) {
2143         // we&#39;re single threaded or at a safepoint - no locking needed
2144         get_jmethod_id_length_value(jmeths, idnum, &amp;length, &amp;id);
2145       } else {
2146         MutexLocker ml(JmethodIdCreation_lock, Mutex::_no_safepoint_check_flag);
2147         get_jmethod_id_length_value(jmeths, idnum, &amp;length, &amp;id);
2148       }
2149     }
2150   }
2151   // implied else:
2152   // we need to allocate a cache so default length and id values are good
2153 
2154   if (jmeths == NULL ||   // no cache yet
2155       length &lt;= idnum ||  // cache is too short
2156       id == NULL) {       // cache doesn&#39;t contain entry
2157 
2158     // This function can be called by the VMThread so we have to do all
2159     // things that might block on a safepoint before grabbing the lock.
2160     // Otherwise, we can deadlock with the VMThread or have a cache
2161     // consistency issue. These vars keep track of what we might have
2162     // to free after the lock is dropped.
2163     jmethodID  to_dealloc_id     = NULL;
2164     jmethodID* to_dealloc_jmeths = NULL;
2165 
2166     // may not allocate new_jmeths or use it if we allocate it
2167     jmethodID* new_jmeths = NULL;
2168     if (length &lt;= idnum) {
2169       // allocate a new cache that might be used
2170       size_t size = MAX2(idnum+1, (size_t)idnum_allocated_count());
2171       new_jmeths = NEW_C_HEAP_ARRAY(jmethodID, size+1, mtClass);
2172       memset(new_jmeths, 0, (size+1)*sizeof(jmethodID));
2173       // cache size is stored in element[0], other elements offset by one
2174       new_jmeths[0] = (jmethodID)size;
2175     }
2176 
2177     // allocate a new jmethodID that might be used
2178     jmethodID new_id = NULL;
2179     if (method_h-&gt;is_old() &amp;&amp; !method_h-&gt;is_obsolete()) {
2180       // The method passed in is old (but not obsolete), we need to use the current version
2181       Method* current_method = method_with_idnum((int)idnum);
2182       assert(current_method != NULL, &quot;old and but not obsolete, so should exist&quot;);
2183       new_id = Method::make_jmethod_id(class_loader_data(), current_method);
2184     } else {
2185       // It is the current version of the method or an obsolete method,
2186       // use the version passed in
2187       new_id = Method::make_jmethod_id(class_loader_data(), method_h());
2188     }
2189 
2190     if (Threads::number_of_threads() == 0 ||
2191         SafepointSynchronize::is_at_safepoint()) {
2192       // we&#39;re single threaded or at a safepoint - no locking needed
2193       id = get_jmethod_id_fetch_or_update(idnum, new_id, new_jmeths,
2194                                           &amp;to_dealloc_id, &amp;to_dealloc_jmeths);
2195     } else {
2196       MutexLocker ml(JmethodIdCreation_lock, Mutex::_no_safepoint_check_flag);
2197       id = get_jmethod_id_fetch_or_update(idnum, new_id, new_jmeths,
2198                                           &amp;to_dealloc_id, &amp;to_dealloc_jmeths);
2199     }
2200 
2201     // The lock has been dropped so we can free resources.
2202     // Free up either the old cache or the new cache if we allocated one.
2203     if (to_dealloc_jmeths != NULL) {
2204       FreeHeap(to_dealloc_jmeths);
2205     }
2206     // free up the new ID since it wasn&#39;t needed
2207     if (to_dealloc_id != NULL) {
2208       Method::destroy_jmethod_id(class_loader_data(), to_dealloc_id);
2209     }
2210   }
2211   return id;
2212 }
2213 
2214 // Figure out how many jmethodIDs haven&#39;t been allocated, and make
2215 // sure space for them is pre-allocated.  This makes getting all
2216 // method ids much, much faster with classes with more than 8
2217 // methods, and has a *substantial* effect on performance with jvmti
2218 // code that loads all jmethodIDs for all classes.
2219 void InstanceKlass::ensure_space_for_methodids(int start_offset) {
2220   int new_jmeths = 0;
2221   int length = methods()-&gt;length();
2222   for (int index = start_offset; index &lt; length; index++) {
2223     Method* m = methods()-&gt;at(index);
2224     jmethodID id = m-&gt;find_jmethod_id_or_null();
2225     if (id == NULL) {
2226       new_jmeths++;
2227     }
2228   }
2229   if (new_jmeths != 0) {
2230     Method::ensure_jmethod_ids(class_loader_data(), new_jmeths);
2231   }
2232 }
2233 
2234 // Common code to fetch the jmethodID from the cache or update the
2235 // cache with the new jmethodID. This function should never do anything
2236 // that causes the caller to go to a safepoint or we can deadlock with
2237 // the VMThread or have cache consistency issues.
2238 //
2239 jmethodID InstanceKlass::get_jmethod_id_fetch_or_update(
2240             size_t idnum, jmethodID new_id,
2241             jmethodID* new_jmeths, jmethodID* to_dealloc_id_p,
2242             jmethodID** to_dealloc_jmeths_p) {
2243   assert(new_id != NULL, &quot;sanity check&quot;);
2244   assert(to_dealloc_id_p != NULL, &quot;sanity check&quot;);
2245   assert(to_dealloc_jmeths_p != NULL, &quot;sanity check&quot;);
2246   assert(Threads::number_of_threads() == 0 ||
2247          SafepointSynchronize::is_at_safepoint() ||
2248          JmethodIdCreation_lock-&gt;owned_by_self(), &quot;sanity check&quot;);
2249 
2250   // reacquire the cache - we are locked, single threaded or at a safepoint
2251   jmethodID* jmeths = methods_jmethod_ids_acquire();
2252   jmethodID  id     = NULL;
2253   size_t     length = 0;
2254 
2255   if (jmeths == NULL ||                         // no cache yet
2256       (length = (size_t)jmeths[0]) &lt;= idnum) {  // cache is too short
2257     if (jmeths != NULL) {
2258       // copy any existing entries from the old cache
2259       for (size_t index = 0; index &lt; length; index++) {
2260         new_jmeths[index+1] = jmeths[index+1];
2261       }
2262       *to_dealloc_jmeths_p = jmeths;  // save old cache for later delete
2263     }
2264     release_set_methods_jmethod_ids(jmeths = new_jmeths);
2265   } else {
2266     // fetch jmethodID (if any) from the existing cache
2267     id = jmeths[idnum+1];
2268     *to_dealloc_jmeths_p = new_jmeths;  // save new cache for later delete
2269   }
2270   if (id == NULL) {
2271     // No matching jmethodID in the existing cache or we have a new
2272     // cache or we just grew the cache. This cache write is done here
2273     // by the first thread to win the foot race because a jmethodID
2274     // needs to be unique once it is generally available.
2275     id = new_id;
2276 
2277     // The jmethodID cache can be read while unlocked so we have to
2278     // make sure the new jmethodID is complete before installing it
2279     // in the cache.
2280     Atomic::release_store(&amp;jmeths[idnum+1], id);
2281   } else {
2282     *to_dealloc_id_p = new_id; // save new id for later delete
2283   }
2284   return id;
2285 }
2286 
2287 
2288 // Common code to get the jmethodID cache length and the jmethodID
2289 // value at index idnum if there is one.
2290 //
2291 void InstanceKlass::get_jmethod_id_length_value(jmethodID* cache,
2292        size_t idnum, size_t *length_p, jmethodID* id_p) {
2293   assert(cache != NULL, &quot;sanity check&quot;);
2294   assert(length_p != NULL, &quot;sanity check&quot;);
2295   assert(id_p != NULL, &quot;sanity check&quot;);
2296 
2297   // cache size is stored in element[0], other elements offset by one
2298   *length_p = (size_t)cache[0];
2299   if (*length_p &lt;= idnum) {  // cache is too short
2300     *id_p = NULL;
2301   } else {
2302     *id_p = cache[idnum+1];  // fetch jmethodID (if any)
2303   }
2304 }
2305 
2306 
2307 // Lookup a jmethodID, NULL if not found.  Do no blocking, no allocations, no handles
2308 jmethodID InstanceKlass::jmethod_id_or_null(Method* method) {
2309   size_t idnum = (size_t)method-&gt;method_idnum();
2310   jmethodID* jmeths = methods_jmethod_ids_acquire();
2311   size_t length;                                // length assigned as debugging crumb
2312   jmethodID id = NULL;
2313   if (jmeths != NULL &amp;&amp;                         // If there is a cache
2314       (length = (size_t)jmeths[0]) &gt; idnum) {   // and if it is long enough,
2315     id = jmeths[idnum+1];                       // Look up the id (may be NULL)
2316   }
2317   return id;
2318 }
2319 
2320 inline DependencyContext InstanceKlass::dependencies() {
2321   DependencyContext dep_context(&amp;_dep_context, &amp;_dep_context_last_cleaned);
2322   return dep_context;
2323 }
2324 
2325 int InstanceKlass::mark_dependent_nmethods(KlassDepChange&amp; changes) {
2326   return dependencies().mark_dependent_nmethods(changes);
2327 }
2328 
2329 void InstanceKlass::add_dependent_nmethod(nmethod* nm) {
2330   dependencies().add_dependent_nmethod(nm);
2331 }
2332 
2333 void InstanceKlass::remove_dependent_nmethod(nmethod* nm) {
2334   dependencies().remove_dependent_nmethod(nm);
2335 }
2336 
2337 void InstanceKlass::clean_dependency_context() {
2338   dependencies().clean_unloading_dependents();
2339 }
2340 
2341 #ifndef PRODUCT
2342 void InstanceKlass::print_dependent_nmethods(bool verbose) {
2343   dependencies().print_dependent_nmethods(verbose);
2344 }
2345 
2346 bool InstanceKlass::is_dependent_nmethod(nmethod* nm) {
2347   return dependencies().is_dependent_nmethod(nm);
2348 }
2349 #endif //PRODUCT
2350 
2351 void InstanceKlass::clean_weak_instanceklass_links() {
2352   clean_implementors_list();
2353   clean_method_data();
2354 }
2355 
2356 void InstanceKlass::clean_implementors_list() {
2357   assert(is_loader_alive(), &quot;this klass should be live&quot;);
2358   if (is_interface()) {
2359     assert (ClassUnloading, &quot;only called for ClassUnloading&quot;);
2360     for (;;) {
2361       // Use load_acquire due to competing with inserts
2362       Klass* impl = Atomic::load_acquire(adr_implementor());
2363       if (impl != NULL &amp;&amp; !impl-&gt;is_loader_alive()) {
2364         // NULL this field, might be an unloaded klass or NULL
2365         Klass* volatile* klass = adr_implementor();
2366         if (Atomic::cmpxchg(klass, impl, (Klass*)NULL) == impl) {
2367           // Successfully unlinking implementor.
2368           if (log_is_enabled(Trace, class, unload)) {
2369             ResourceMark rm;
2370             log_trace(class, unload)(&quot;unlinking class (implementor): %s&quot;, impl-&gt;external_name());
2371           }
2372           return;
2373         }
2374       } else {
2375         return;
2376       }
2377     }
2378   }
2379 }
2380 
2381 void InstanceKlass::clean_method_data() {
2382   for (int m = 0; m &lt; methods()-&gt;length(); m++) {
2383     MethodData* mdo = methods()-&gt;at(m)-&gt;method_data();
2384     if (mdo != NULL) {
2385       MutexLocker ml(SafepointSynchronize::is_at_safepoint() ? NULL : mdo-&gt;extra_data_lock());
2386       mdo-&gt;clean_method_data(/*always_clean*/false);
2387     }
2388   }
2389 }
2390 
2391 bool InstanceKlass::supers_have_passed_fingerprint_checks() {
2392   if (java_super() != NULL &amp;&amp; !java_super()-&gt;has_passed_fingerprint_check()) {
2393     ResourceMark rm;
2394     log_trace(class, fingerprint)(&quot;%s : super %s not fingerprinted&quot;, external_name(), java_super()-&gt;external_name());
2395     return false;
2396   }
2397 
2398   Array&lt;InstanceKlass*&gt;* local_interfaces = this-&gt;local_interfaces();
2399   if (local_interfaces != NULL) {
2400     int length = local_interfaces-&gt;length();
2401     for (int i = 0; i &lt; length; i++) {
2402       InstanceKlass* intf = local_interfaces-&gt;at(i);
2403       if (!intf-&gt;has_passed_fingerprint_check()) {
2404         ResourceMark rm;
2405         log_trace(class, fingerprint)(&quot;%s : interface %s not fingerprinted&quot;, external_name(), intf-&gt;external_name());
2406         return false;
2407       }
2408     }
2409   }
2410 
2411   return true;
2412 }
2413 
2414 bool InstanceKlass::should_store_fingerprint(bool is_unsafe_anonymous) {
2415 #if INCLUDE_AOT
2416   // We store the fingerprint into the InstanceKlass only in the following 2 cases:
2417   if (CalculateClassFingerprint) {
2418     // (1) We are running AOT to generate a shared library.
2419     return true;
2420   }
2421   if (Arguments::is_dumping_archive()) {
2422     // (2) We are running -Xshare:dump or -XX:ArchiveClassesAtExit to create a shared archive
2423     return true;
2424   }
2425   if (UseAOT &amp;&amp; is_unsafe_anonymous) {
2426     // (3) We are using AOT code from a shared library and see an unsafe anonymous class
2427     return true;
2428   }
2429 #endif
2430 
2431   // In all other cases we might set the _misc_has_passed_fingerprint_check bit,
2432   // but do not store the 64-bit fingerprint to save space.
2433   return false;
2434 }
2435 
2436 bool InstanceKlass::has_stored_fingerprint() const {
2437 #if INCLUDE_AOT
2438   return should_store_fingerprint() || is_shared();
2439 #else
2440   return false;
2441 #endif
2442 }
2443 
2444 uint64_t InstanceKlass::get_stored_fingerprint() const {
2445   address adr = adr_fingerprint();
2446   if (adr != NULL) {
2447     return (uint64_t)Bytes::get_native_u8(adr); // adr may not be 64-bit aligned
2448   }
2449   return 0;
2450 }
2451 
2452 void InstanceKlass::store_fingerprint(uint64_t fingerprint) {
2453   address adr = adr_fingerprint();
2454   if (adr != NULL) {
2455     Bytes::put_native_u8(adr, (u8)fingerprint); // adr may not be 64-bit aligned
2456 
2457     ResourceMark rm;
2458     log_trace(class, fingerprint)(&quot;stored as &quot; PTR64_FORMAT &quot; for class %s&quot;, fingerprint, external_name());
2459   }
2460 }
2461 
2462 void InstanceKlass::metaspace_pointers_do(MetaspaceClosure* it) {
2463   Klass::metaspace_pointers_do(it);
2464 
2465   if (log_is_enabled(Trace, cds)) {
2466     ResourceMark rm;
2467     log_trace(cds)(&quot;Iter(InstanceKlass): %p (%s)&quot;, this, external_name());
2468   }
2469 
2470   it-&gt;push(&amp;_annotations);
2471   it-&gt;push((Klass**)&amp;_array_klasses);
2472   it-&gt;push(&amp;_constants);
2473   it-&gt;push(&amp;_inner_classes);
2474   it-&gt;push(&amp;_array_name);
2475 #if INCLUDE_JVMTI
2476   it-&gt;push(&amp;_previous_versions);
2477 #endif
2478   it-&gt;push(&amp;_methods);
2479   it-&gt;push(&amp;_default_methods);
2480   it-&gt;push(&amp;_local_interfaces);
2481   it-&gt;push(&amp;_transitive_interfaces);
2482   it-&gt;push(&amp;_method_ordering);
2483   it-&gt;push(&amp;_default_vtable_indices);
2484   it-&gt;push(&amp;_fields);
2485 
2486   if (itable_length() &gt; 0) {
2487     itableOffsetEntry* ioe = (itableOffsetEntry*)start_of_itable();
2488     int method_table_offset_in_words = ioe-&gt;offset()/wordSize;
2489     int nof_interfaces = (method_table_offset_in_words - itable_offset_in_words())
2490                          / itableOffsetEntry::size();
2491 
2492     for (int i = 0; i &lt; nof_interfaces; i ++, ioe ++) {
2493       if (ioe-&gt;interface_klass() != NULL) {
2494         it-&gt;push(ioe-&gt;interface_klass_addr());
2495         itableMethodEntry* ime = ioe-&gt;first_method_entry(this);
2496         int n = klassItable::method_count_for_interface(ioe-&gt;interface_klass());
2497         for (int index = 0; index &lt; n; index ++) {
2498           it-&gt;push(ime[index].method_addr());
2499         }
2500       }
2501     }
2502   }
2503 
2504   it-&gt;push(&amp;_nest_members);
2505   it-&gt;push(&amp;_record_components);
2506 }
2507 
2508 void InstanceKlass::remove_unshareable_info() {
2509   Klass::remove_unshareable_info();
2510 
<a name="3" id="anc3"></a><span class="line-modified">2511   if (is_in_error_state()) {</span>
2512     // Classes are attempted to link during dumping and may fail,
2513     // but these classes are still in the dictionary and class list in CLD.
<a name="4" id="anc4"></a><span class="line-modified">2514     // Check in_error state first because in_error is &gt; linked state, so</span>
<span class="line-removed">2515     // is_linked() is true.</span>
<span class="line-removed">2516     // If there&#39;s a linking error, there is nothing else to remove.</span>
2517     return;
2518   }
2519 
2520   // Reset to the &#39;allocated&#39; state to prevent any premature accessing to
2521   // a shared class at runtime while the class is still being loaded and
2522   // restored. A class&#39; init_state is set to &#39;loaded&#39; at runtime when it&#39;s
2523   // being added to class hierarchy (see SystemDictionary:::add_to_hierarchy()).
2524   _init_state = allocated;
2525 
2526   { // Otherwise this needs to take out the Compile_lock.
2527     assert(SafepointSynchronize::is_at_safepoint(), &quot;only called at safepoint&quot;);
2528     init_implementor();
2529   }
2530 
2531   constants()-&gt;remove_unshareable_info();
2532 
2533   for (int i = 0; i &lt; methods()-&gt;length(); i++) {
2534     Method* m = methods()-&gt;at(i);
2535     m-&gt;remove_unshareable_info();
2536   }
2537 
2538   // do array classes also.
2539   if (array_klasses() != NULL) {
2540     array_klasses()-&gt;remove_unshareable_info();
2541   }
2542 
2543   // These are not allocated from metaspace. They are safe to set to NULL.
2544   _source_debug_extension = NULL;
2545   _dep_context = NULL;
2546   _osr_nmethods_head = NULL;
2547 #if INCLUDE_JVMTI
2548   _breakpoints = NULL;
2549   _previous_versions = NULL;
2550   _cached_class_file = NULL;
2551   _jvmti_cached_class_field_map = NULL;
2552 #endif
2553 
2554   _init_thread = NULL;
2555   _methods_jmethod_ids = NULL;
2556   _jni_ids = NULL;
2557   _oop_map_cache = NULL;
2558   // clear _nest_host to ensure re-load at runtime
2559   _nest_host = NULL;
2560   _package_entry = NULL;
2561   _dep_context_last_cleaned = 0;
2562 }
2563 
2564 void InstanceKlass::remove_java_mirror() {
2565   Klass::remove_java_mirror();
2566 
2567   // do array classes also.
2568   if (array_klasses() != NULL) {
2569     array_klasses()-&gt;remove_java_mirror();
2570   }
2571 }
2572 
2573 void InstanceKlass::restore_unshareable_info(ClassLoaderData* loader_data, Handle protection_domain, TRAPS) {
2574   // SystemDictionary::add_to_hierarchy() sets the init_state to loaded
2575   // before the InstanceKlass is added to the SystemDictionary. Make
2576   // sure the current state is &lt;loaded.
2577   assert(!is_loaded(), &quot;invalid init state&quot;);
2578   set_package(loader_data, CHECK);
2579   Klass::restore_unshareable_info(loader_data, protection_domain, CHECK);
2580 
2581   if (is_value()) {
2582     ValueKlass::cast(this)-&gt;initialize_calling_convention(CHECK);
2583   }
2584 
2585   Array&lt;Method*&gt;* methods = this-&gt;methods();
2586   int num_methods = methods-&gt;length();
2587   for (int index = 0; index &lt; num_methods; ++index) {
2588     methods-&gt;at(index)-&gt;restore_unshareable_info(CHECK);
2589   }
2590   if (JvmtiExport::has_redefined_a_class()) {
2591     // Reinitialize vtable because RedefineClasses may have changed some
2592     // entries in this vtable for super classes so the CDS vtable might
2593     // point to old or obsolete entries.  RedefineClasses doesn&#39;t fix up
2594     // vtables in the shared system dictionary, only the main one.
2595     // It also redefines the itable too so fix that too.
2596     vtable().initialize_vtable(false, CHECK);
2597     itable().initialize_itable(false, CHECK);
2598   }
2599 
2600   // restore constant pool resolved references
2601   constants()-&gt;restore_unshareable_info(CHECK);
2602 
2603   if (array_klasses() != NULL) {
2604     // Array classes have null protection domain.
2605     // --&gt; see ArrayKlass::complete_create_array_klass()
2606     array_klasses()-&gt;restore_unshareable_info(ClassLoaderData::the_null_class_loader_data(), Handle(), CHECK);
2607   }
2608 
2609   // Initialize current biased locking state.
2610   if (UseBiasedLocking &amp;&amp; BiasedLocking::enabled() &amp;&amp; !is_value()) {
2611     set_prototype_header(markWord::biased_locking_prototype());
2612   }
2613 }
2614 
<a name="5" id="anc5"></a><span class="line-modified">2615 // returns true IFF is_in_error_state() has been changed as a result of this call.</span>
<span class="line-removed">2616 bool InstanceKlass::check_sharing_error_state() {</span>
<span class="line-removed">2617   assert(DumpSharedSpaces, &quot;should only be called during dumping&quot;);</span>
<span class="line-removed">2618   bool old_state = is_in_error_state();</span>
<span class="line-removed">2619 </span>
<span class="line-removed">2620   if (!is_in_error_state()) {</span>
<span class="line-removed">2621     bool bad = false;</span>
<span class="line-removed">2622     for (InstanceKlass* sup = java_super(); sup; sup = sup-&gt;java_super()) {</span>
<span class="line-removed">2623       if (sup-&gt;is_in_error_state()) {</span>
<span class="line-removed">2624         bad = true;</span>
<span class="line-removed">2625         break;</span>
<span class="line-removed">2626       }</span>
<span class="line-removed">2627     }</span>
<span class="line-removed">2628     if (!bad) {</span>
<span class="line-removed">2629       Array&lt;InstanceKlass*&gt;* interfaces = transitive_interfaces();</span>
<span class="line-removed">2630       for (int i = 0; i &lt; interfaces-&gt;length(); i++) {</span>
<span class="line-removed">2631         InstanceKlass* iface = interfaces-&gt;at(i);</span>
<span class="line-removed">2632         if (iface-&gt;is_in_error_state()) {</span>
<span class="line-removed">2633           bad = true;</span>
<span class="line-removed">2634           break;</span>
<span class="line-removed">2635         }</span>
<span class="line-removed">2636       }</span>
<span class="line-removed">2637     }</span>
<span class="line-removed">2638 </span>
<span class="line-removed">2639     if (bad) {</span>
<span class="line-removed">2640       set_in_error_state();</span>
<span class="line-removed">2641     }</span>
<span class="line-removed">2642   }</span>
<span class="line-removed">2643 </span>
<span class="line-removed">2644   return (old_state != is_in_error_state());</span>
<span class="line-removed">2645 }</span>
<span class="line-removed">2646 </span>
<span class="line-removed">2647 void InstanceKlass::set_class_loader_type(s2 loader_type) {</span>
2648   switch (loader_type) {
2649   case ClassLoader::BOOT_LOADER:
2650     _misc_flags |= _misc_is_shared_boot_class;
2651     break;
2652   case ClassLoader::PLATFORM_LOADER:
2653     _misc_flags |= _misc_is_shared_platform_class;
2654     break;
2655   case ClassLoader::APP_LOADER:
2656     _misc_flags |= _misc_is_shared_app_class;
2657     break;
2658   default:
2659     ShouldNotReachHere();
2660     break;
2661   }
2662 }
2663 
2664 #if INCLUDE_JVMTI
2665 static void clear_all_breakpoints(Method* m) {
2666   m-&gt;clear_all_breakpoints();
2667 }
2668 #endif
2669 
2670 void InstanceKlass::unload_class(InstanceKlass* ik) {
2671   // Release dependencies.
2672   ik-&gt;dependencies().remove_all_dependents();
2673 
2674   // notify the debugger
2675   if (JvmtiExport::should_post_class_unload()) {
2676     JvmtiExport::post_class_unload(ik);
2677   }
2678 
2679   // notify ClassLoadingService of class unload
2680   ClassLoadingService::notify_class_unloaded(ik);
2681 
2682   if (Arguments::is_dumping_archive()) {
2683     SystemDictionaryShared::remove_dumptime_info(ik);
2684   }
2685 
2686   if (log_is_enabled(Info, class, unload)) {
2687     ResourceMark rm;
2688     log_info(class, unload)(&quot;unloading class %s &quot; INTPTR_FORMAT, ik-&gt;external_name(), p2i(ik));
2689   }
2690 
2691   Events::log_class_unloading(Thread::current(), ik);
2692 
2693 #if INCLUDE_JFR
2694   assert(ik != NULL, &quot;invariant&quot;);
2695   EventClassUnload event;
2696   event.set_unloadedClass(ik);
2697   event.set_definingClassLoader(ik-&gt;class_loader_data());
2698   event.commit();
2699 #endif
2700 }
2701 
2702 static void method_release_C_heap_structures(Method* m) {
2703   m-&gt;release_C_heap_structures();
2704 }
2705 
2706 void InstanceKlass::release_C_heap_structures(InstanceKlass* ik) {
2707   // Clean up C heap
2708   ik-&gt;release_C_heap_structures();
2709   ik-&gt;constants()-&gt;release_C_heap_structures();
2710 
2711   // Deallocate and call destructors for MDO mutexes
2712   ik-&gt;methods_do(method_release_C_heap_structures);
2713 
2714 }
2715 
2716 void InstanceKlass::release_C_heap_structures() {
2717   // Can&#39;t release the constant pool here because the constant pool can be
2718   // deallocated separately from the InstanceKlass for default methods and
2719   // redefine classes.
2720 
2721   // Deallocate oop map cache
2722   if (_oop_map_cache != NULL) {
2723     delete _oop_map_cache;
2724     _oop_map_cache = NULL;
2725   }
2726 
2727   // Deallocate JNI identifiers for jfieldIDs
2728   JNIid::deallocate(jni_ids());
2729   set_jni_ids(NULL);
2730 
2731   jmethodID* jmeths = methods_jmethod_ids_acquire();
2732   if (jmeths != (jmethodID*)NULL) {
2733     release_set_methods_jmethod_ids(NULL);
2734     FreeHeap(jmeths);
2735   }
2736 
2737   assert(_dep_context == NULL,
2738          &quot;dependencies should already be cleaned&quot;);
2739 
2740 #if INCLUDE_JVMTI
2741   // Deallocate breakpoint records
2742   if (breakpoints() != 0x0) {
2743     methods_do(clear_all_breakpoints);
2744     assert(breakpoints() == 0x0, &quot;should have cleared breakpoints&quot;);
2745   }
2746 
2747   // deallocate the cached class file
2748   if (_cached_class_file != NULL) {
2749     os::free(_cached_class_file);
2750     _cached_class_file = NULL;
2751   }
2752 #endif
2753 
2754   // Decrement symbol reference counts associated with the unloaded class.
2755   if (_name != NULL) _name-&gt;decrement_refcount();
2756   // unreference array name derived from this class name (arrays of an unloaded
2757   // class can&#39;t be referenced anymore).
2758   if (_array_name != NULL)  _array_name-&gt;decrement_refcount();
2759   if (_value_types != NULL) {
2760     for (int i = 0; i &lt; _value_types-&gt;length(); i++) {
2761       Symbol* s = _value_types-&gt;at(i)._class_name;
2762       if (s != NULL) {
2763         s-&gt;decrement_refcount();
2764       }
2765     }
2766   }
2767   FREE_C_HEAP_ARRAY(char, _source_debug_extension);
2768 }
2769 
2770 void InstanceKlass::set_source_debug_extension(const char* array, int length) {
2771   if (array == NULL) {
2772     _source_debug_extension = NULL;
2773   } else {
2774     // Adding one to the attribute length in order to store a null terminator
2775     // character could cause an overflow because the attribute length is
2776     // already coded with an u4 in the classfile, but in practice, it&#39;s
2777     // unlikely to happen.
2778     assert((length+1) &gt; length, &quot;Overflow checking&quot;);
2779     char* sde = NEW_C_HEAP_ARRAY(char, (length + 1), mtClass);
2780     for (int i = 0; i &lt; length; i++) {
2781       sde[i] = array[i];
2782     }
2783     sde[length] = &#39;\0&#39;;
2784     _source_debug_extension = sde;
2785   }
2786 }
2787 
2788 const char* InstanceKlass::signature_name() const {
2789   return signature_name_of(is_value() ? JVM_SIGNATURE_VALUETYPE : JVM_SIGNATURE_CLASS);
2790 }
2791 
2792 const char* InstanceKlass::signature_name_of(char c) const {
2793   int hash_len = 0;
2794   char hash_buf[40];
2795 
2796   // If this is an unsafe anonymous class, append a hash to make the name unique
2797   if (is_unsafe_anonymous()) {
2798     intptr_t hash = (java_mirror() != NULL) ? java_mirror()-&gt;identity_hash() : 0;
2799     jio_snprintf(hash_buf, sizeof(hash_buf), &quot;/&quot; UINTX_FORMAT, (uintx)hash);
2800     hash_len = (int)strlen(hash_buf);
2801   }
2802 
2803   // Get the internal name as a c string
2804   const char* src = (const char*) (name()-&gt;as_C_string());
2805   const int src_length = (int)strlen(src);
2806 
2807   char* dest = NEW_RESOURCE_ARRAY(char, src_length + hash_len + 3);
2808 
2809   // Add L or Q as type indicator
2810   int dest_index = 0;
2811   dest[dest_index++] = c;
2812 
2813   // Add the actual class name
2814   for (int src_index = 0; src_index &lt; src_length; ) {
2815     dest[dest_index++] = src[src_index++];
2816   }
2817 
2818   // If we have a hash, append it
2819   for (int hash_index = 0; hash_index &lt; hash_len; ) {
2820     dest[dest_index++] = hash_buf[hash_index++];
2821   }
2822 
2823   // Add the semicolon and the NULL
2824   dest[dest_index++] = JVM_SIGNATURE_ENDCLASS;
2825   dest[dest_index] = &#39;\0&#39;;
2826   return dest;
2827 }
2828 
<a name="6" id="anc6"></a><span class="line-removed">2829 // Used to obtain the package name from a fully qualified class name.</span>
<span class="line-removed">2830 Symbol* InstanceKlass::package_from_name(const Symbol* name, TRAPS) {</span>
<span class="line-removed">2831   if (name == NULL) {</span>
<span class="line-removed">2832     return NULL;</span>
<span class="line-removed">2833   } else {</span>
<span class="line-removed">2834     if (name-&gt;utf8_length() &lt;= 0) {</span>
<span class="line-removed">2835       return NULL;</span>
<span class="line-removed">2836     }</span>
<span class="line-removed">2837     ResourceMark rm(THREAD);</span>
<span class="line-removed">2838     const char* package_name = ClassLoader::package_from_name((const char*) name-&gt;as_C_string());</span>
<span class="line-removed">2839     if (package_name == NULL) {</span>
<span class="line-removed">2840       return NULL;</span>
<span class="line-removed">2841     }</span>
<span class="line-removed">2842     Symbol* pkg_name = SymbolTable::new_symbol(package_name);</span>
<span class="line-removed">2843     return pkg_name;</span>
<span class="line-removed">2844   }</span>
<span class="line-removed">2845 }</span>
<span class="line-removed">2846 </span>
2847 ModuleEntry* InstanceKlass::module() const {
2848   // For an unsafe anonymous class return the host class&#39; module
2849   if (is_unsafe_anonymous()) {
2850     assert(unsafe_anonymous_host() != NULL, &quot;unsafe anonymous class must have a host class&quot;);
2851     return unsafe_anonymous_host()-&gt;module();
2852   }
2853 
2854   // Class is in a named package
2855   if (!in_unnamed_package()) {
2856     return _package_entry-&gt;module();
2857   }
2858 
2859   // Class is in an unnamed package, return its loader&#39;s unnamed module
2860   return class_loader_data()-&gt;unnamed_module();
2861 }
2862 
2863 void InstanceKlass::set_package(ClassLoaderData* loader_data, TRAPS) {
2864 
2865   // ensure java/ packages only loaded by boot or platform builtin loaders
2866   check_prohibited_package(name(), loader_data, CHECK);
2867 
<a name="7" id="anc7"></a><span class="line-modified">2868   TempNewSymbol pkg_name = package_from_name(name(), CHECK);</span>
2869 
2870   if (pkg_name != NULL &amp;&amp; loader_data != NULL) {
2871 
2872     // Find in class loader&#39;s package entry table.
2873     _package_entry = loader_data-&gt;packages()-&gt;lookup_only(pkg_name);
2874 
2875     // If the package name is not found in the loader&#39;s package
2876     // entry table, it is an indication that the package has not
2877     // been defined. Consider it defined within the unnamed module.
2878     if (_package_entry == NULL) {
2879       ResourceMark rm(THREAD);
2880 
2881       if (!ModuleEntryTable::javabase_defined()) {
2882         // Before java.base is defined during bootstrapping, define all packages in
2883         // the java.base module.  If a non-java.base package is erroneously placed
2884         // in the java.base module it will be caught later when java.base
2885         // is defined by ModuleEntryTable::verify_javabase_packages check.
2886         assert(ModuleEntryTable::javabase_moduleEntry() != NULL, JAVA_BASE_NAME &quot; module is NULL&quot;);
2887         _package_entry = loader_data-&gt;packages()-&gt;lookup(pkg_name, ModuleEntryTable::javabase_moduleEntry());
2888       } else {
2889         assert(loader_data-&gt;unnamed_module() != NULL, &quot;unnamed module is NULL&quot;);
2890         _package_entry = loader_data-&gt;packages()-&gt;lookup(pkg_name,
2891                                                          loader_data-&gt;unnamed_module());
2892       }
2893 
2894       // A package should have been successfully created
2895       assert(_package_entry != NULL, &quot;Package entry for class %s not found, loader %s&quot;,
2896              name()-&gt;as_C_string(), loader_data-&gt;loader_name_and_id());
2897     }
2898 
2899     if (log_is_enabled(Debug, module)) {
2900       ResourceMark rm(THREAD);
2901       ModuleEntry* m = _package_entry-&gt;module();
2902       log_trace(module)(&quot;Setting package: class: %s, package: %s, loader: %s, module: %s&quot;,
2903                         external_name(),
2904                         pkg_name-&gt;as_C_string(),
2905                         loader_data-&gt;loader_name_and_id(),
2906                         (m-&gt;is_named() ? m-&gt;name()-&gt;as_C_string() : UNNAMED_MODULE));
2907     }
2908   } else {
2909     ResourceMark rm(THREAD);
2910     log_trace(module)(&quot;Setting package: class: %s, package: unnamed, loader: %s, module: %s&quot;,
2911                       external_name(),
2912                       (loader_data != NULL) ? loader_data-&gt;loader_name_and_id() : &quot;NULL&quot;,
2913                       UNNAMED_MODULE);
2914   }
2915 }
2916 
2917 
2918 // different versions of is_same_class_package
2919 
2920 bool InstanceKlass::is_same_class_package(const Klass* class2) const {
2921   oop classloader1 = this-&gt;class_loader();
2922   PackageEntry* classpkg1 = this-&gt;package();
2923   if (class2-&gt;is_objArray_klass()) {
2924     class2 = ObjArrayKlass::cast(class2)-&gt;bottom_klass();
2925   }
2926 
2927   oop classloader2;
2928   PackageEntry* classpkg2;
2929   if (class2-&gt;is_instance_klass()) {
2930     classloader2 = class2-&gt;class_loader();
2931     classpkg2 = class2-&gt;package();
2932   } else {
2933     assert(class2-&gt;is_typeArray_klass(), &quot;should be type array&quot;);
2934     classloader2 = NULL;
2935     classpkg2 = NULL;
2936   }
2937 
2938   // Same package is determined by comparing class loader
2939   // and package entries. Both must be the same. This rule
2940   // applies even to classes that are defined in the unnamed
2941   // package, they still must have the same class loader.
2942   if ((classloader1 == classloader2) &amp;&amp; (classpkg1 == classpkg2)) {
2943     return true;
2944   }
2945 
2946   return false;
2947 }
2948 
2949 // return true if this class and other_class are in the same package. Classloader
2950 // and classname information is enough to determine a class&#39;s package
2951 bool InstanceKlass::is_same_class_package(oop other_class_loader,
2952                                           const Symbol* other_class_name) const {
2953   if (class_loader() != other_class_loader) {
2954     return false;
2955   }
2956   if (name()-&gt;fast_compare(other_class_name) == 0) {
2957      return true;
2958   }
2959 
2960   {
2961     ResourceMark rm;
2962 
2963     bool bad_class_name = false;
<a name="8" id="anc8"></a><span class="line-modified">2964     const char* other_pkg =</span>
<span class="line-removed">2965       ClassLoader::package_from_name((const char*) other_class_name-&gt;as_C_string(), &amp;bad_class_name);</span>
2966     if (bad_class_name) {
2967       return false;
2968     }
<a name="9" id="anc9"></a><span class="line-modified">2969     // Check that package_from_name() returns NULL, not &quot;&quot;, if there is no package.</span>
<span class="line-modified">2970     assert(other_pkg == NULL || strlen(other_pkg) &gt; 0, &quot;package name is empty string&quot;);</span>
2971 
2972     const Symbol* const this_package_name =
2973       this-&gt;package() != NULL ? this-&gt;package()-&gt;name() : NULL;
2974 
2975     if (this_package_name == NULL || other_pkg == NULL) {
2976       // One of the two doesn&#39;t have a package.  Only return true if the other
2977       // one also doesn&#39;t have a package.
<a name="10" id="anc10"></a><span class="line-modified">2978       return (const char*)this_package_name == other_pkg;</span>
2979     }
2980 
2981     // Check if package is identical
<a name="11" id="anc11"></a><span class="line-modified">2982     return this_package_name-&gt;equals(other_pkg);</span>
2983   }
2984 }
2985 
2986 // Returns true iff super_method can be overridden by a method in targetclassname
2987 // See JLS 3rd edition 8.4.6.1
2988 // Assumes name-signature match
2989 // &quot;this&quot; is InstanceKlass of super_method which must exist
2990 // note that the InstanceKlass of the method in the targetclassname has not always been created yet
2991 bool InstanceKlass::is_override(const methodHandle&amp; super_method, Handle targetclassloader, Symbol* targetclassname, TRAPS) {
2992    // Private methods can not be overridden
2993    if (super_method-&gt;is_private()) {
2994      return false;
2995    }
2996    // If super method is accessible, then override
2997    if ((super_method-&gt;is_protected()) ||
2998        (super_method-&gt;is_public())) {
2999      return true;
3000    }
3001    // Package-private methods are not inherited outside of package
3002    assert(super_method-&gt;is_package_private(), &quot;must be package private&quot;);
3003    return(is_same_class_package(targetclassloader(), targetclassname));
3004 }
3005 
3006 // Only boot and platform class loaders can define classes in &quot;java/&quot; packages.
3007 void InstanceKlass::check_prohibited_package(Symbol* class_name,
3008                                              ClassLoaderData* loader_data,
3009                                              TRAPS) {
3010   if (!loader_data-&gt;is_boot_class_loader_data() &amp;&amp;
3011       !loader_data-&gt;is_platform_class_loader_data() &amp;&amp;
3012       class_name != NULL) {
3013     ResourceMark rm(THREAD);
3014     char* name = class_name-&gt;as_C_string();
3015     if (strncmp(name, JAVAPKG, JAVAPKG_LEN) == 0 &amp;&amp; name[JAVAPKG_LEN] == &#39;/&#39;) {
<a name="12" id="anc12"></a><span class="line-modified">3016       TempNewSymbol pkg_name = InstanceKlass::package_from_name(class_name, CHECK);</span>
3017       assert(pkg_name != NULL, &quot;Error in parsing package name starting with &#39;java/&#39;&quot;);
3018       name = pkg_name-&gt;as_C_string();
3019       const char* class_loader_name = loader_data-&gt;loader_name_and_id();
3020       StringUtils::replace_no_expand(name, &quot;/&quot;, &quot;.&quot;);
3021       const char* msg_text1 = &quot;Class loader (instance of): &quot;;
3022       const char* msg_text2 = &quot; tried to load prohibited package name: &quot;;
3023       size_t len = strlen(msg_text1) + strlen(class_loader_name) + strlen(msg_text2) + strlen(name) + 1;
3024       char* message = NEW_RESOURCE_ARRAY_IN_THREAD(THREAD, char, len);
3025       jio_snprintf(message, len, &quot;%s%s%s%s&quot;, msg_text1, class_loader_name, msg_text2, name);
3026       THROW_MSG(vmSymbols::java_lang_SecurityException(), message);
3027     }
3028   }
3029   return;
3030 }
3031 
3032 bool InstanceKlass::find_inner_classes_attr(int* ooff, int* noff, TRAPS) const {
3033   constantPoolHandle i_cp(THREAD, constants());
3034   for (InnerClassesIterator iter(this); !iter.done(); iter.next()) {
3035     int ioff = iter.inner_class_info_index();
3036     if (ioff != 0) {
3037       // Check to see if the name matches the class we&#39;re looking for
3038       // before attempting to find the class.
3039       if (i_cp-&gt;klass_name_at_matches(this, ioff)) {
3040         Klass* inner_klass = i_cp-&gt;klass_at(ioff, CHECK_false);
3041         if (this == inner_klass) {
3042           *ooff = iter.outer_class_info_index();
3043           *noff = iter.inner_name_index();
3044           return true;
3045         }
3046       }
3047     }
3048   }
3049   return false;
3050 }
3051 
3052 InstanceKlass* InstanceKlass::compute_enclosing_class(bool* inner_is_member, TRAPS) const {
3053   InstanceKlass* outer_klass = NULL;
3054   *inner_is_member = false;
3055   int ooff = 0, noff = 0;
3056   bool has_inner_classes_attr = find_inner_classes_attr(&amp;ooff, &amp;noff, THREAD);
3057   if (has_inner_classes_attr) {
3058     constantPoolHandle i_cp(THREAD, constants());
3059     if (ooff != 0) {
3060       Klass* ok = i_cp-&gt;klass_at(ooff, CHECK_NULL);
3061       outer_klass = InstanceKlass::cast(ok);
3062       *inner_is_member = true;
3063     }
3064     if (NULL == outer_klass) {
3065       // It may be unsafe anonymous; try for that.
3066       int encl_method_class_idx = enclosing_method_class_index();
3067       if (encl_method_class_idx != 0) {
3068         Klass* ok = i_cp-&gt;klass_at(encl_method_class_idx, CHECK_NULL);
3069         outer_klass = InstanceKlass::cast(ok);
3070         *inner_is_member = false;
3071       }
3072     }
3073   }
3074 
3075   // If no inner class attribute found for this class.
3076   if (NULL == outer_klass) return NULL;
3077 
3078   // Throws an exception if outer klass has not declared k as an inner klass
3079   // We need evidence that each klass knows about the other, or else
3080   // the system could allow a spoof of an inner class to gain access rights.
3081   Reflection::check_for_inner_class(outer_klass, this, *inner_is_member, CHECK_NULL);
3082   return outer_klass;
3083 }
3084 
3085 jint InstanceKlass::compute_modifier_flags(TRAPS) const {
3086   jint access = access_flags().as_int();
3087 
3088   // But check if it happens to be member class.
3089   InnerClassesIterator iter(this);
3090   for (; !iter.done(); iter.next()) {
3091     int ioff = iter.inner_class_info_index();
3092     // Inner class attribute can be zero, skip it.
3093     // Strange but true:  JVM spec. allows null inner class refs.
3094     if (ioff == 0) continue;
3095 
3096     // only look at classes that are already loaded
3097     // since we are looking for the flags for our self.
3098     Symbol* inner_name = constants()-&gt;klass_name_at(ioff);
3099     if (name() == inner_name) {
3100       // This is really a member class.
3101       access = iter.inner_access_flags();
3102       break;
3103     }
3104   }
3105   // Remember to strip ACC_SUPER bit
3106   return (access &amp; (~JVM_ACC_SUPER)) &amp; JVM_ACC_WRITTEN_FLAGS;
3107 }
3108 
3109 jint InstanceKlass::jvmti_class_status() const {
3110   jint result = 0;
3111 
3112   if (is_linked()) {
3113     result |= JVMTI_CLASS_STATUS_VERIFIED | JVMTI_CLASS_STATUS_PREPARED;
3114   }
3115 
3116   if (is_initialized()) {
3117     assert(is_linked(), &quot;Class status is not consistent&quot;);
3118     result |= JVMTI_CLASS_STATUS_INITIALIZED;
3119   }
3120   if (is_in_error_state()) {
3121     result |= JVMTI_CLASS_STATUS_ERROR;
3122   }
3123   return result;
3124 }
3125 
3126 Method* InstanceKlass::method_at_itable(Klass* holder, int index, TRAPS) {
3127   itableOffsetEntry* ioe = (itableOffsetEntry*)start_of_itable();
3128   int method_table_offset_in_words = ioe-&gt;offset()/wordSize;
3129   int nof_interfaces = (method_table_offset_in_words - itable_offset_in_words())
3130                        / itableOffsetEntry::size();
3131 
3132   for (int cnt = 0 ; ; cnt ++, ioe ++) {
3133     // If the interface isn&#39;t implemented by the receiver class,
3134     // the VM should throw IncompatibleClassChangeError.
3135     if (cnt &gt;= nof_interfaces) {
3136       ResourceMark rm(THREAD);
3137       stringStream ss;
3138       bool same_module = (module() == holder-&gt;module());
3139       ss.print(&quot;Receiver class %s does not implement &quot;
3140                &quot;the interface %s defining the method to be called &quot;
3141                &quot;(%s%s%s)&quot;,
3142                external_name(), holder-&gt;external_name(),
3143                (same_module) ? joint_in_module_of_loader(holder) : class_in_module_of_loader(),
3144                (same_module) ? &quot;&quot; : &quot;; &quot;,
3145                (same_module) ? &quot;&quot; : holder-&gt;class_in_module_of_loader());
3146       THROW_MSG_NULL(vmSymbols::java_lang_IncompatibleClassChangeError(), ss.as_string());
3147     }
3148 
3149     Klass* ik = ioe-&gt;interface_klass();
3150     if (ik == holder) break;
3151   }
3152 
3153   itableMethodEntry* ime = ioe-&gt;first_method_entry(this);
3154   Method* m = ime[index].method();
3155   if (m == NULL) {
3156     THROW_NULL(vmSymbols::java_lang_AbstractMethodError());
3157   }
3158   return m;
3159 }
3160 
3161 
3162 #if INCLUDE_JVMTI
3163 // update default_methods for redefineclasses for methods that are
3164 // not yet in the vtable due to concurrent subclass define and superinterface
3165 // redefinition
3166 // Note: those in the vtable, should have been updated via adjust_method_entries
3167 void InstanceKlass::adjust_default_methods(bool* trace_name_printed) {
3168   // search the default_methods for uses of either obsolete or EMCP methods
3169   if (default_methods() != NULL) {
3170     for (int index = 0; index &lt; default_methods()-&gt;length(); index ++) {
3171       Method* old_method = default_methods()-&gt;at(index);
3172       if (old_method == NULL || !old_method-&gt;is_old()) {
3173         continue; // skip uninteresting entries
3174       }
3175       assert(!old_method-&gt;is_deleted(), &quot;default methods may not be deleted&quot;);
3176       Method* new_method = old_method-&gt;get_new_method();
3177       default_methods()-&gt;at_put(index, new_method);
3178 
3179       if (log_is_enabled(Info, redefine, class, update)) {
3180         ResourceMark rm;
3181         if (!(*trace_name_printed)) {
3182           log_info(redefine, class, update)
3183             (&quot;adjust: klassname=%s default methods from name=%s&quot;,
3184              external_name(), old_method-&gt;method_holder()-&gt;external_name());
3185           *trace_name_printed = true;
3186         }
3187         log_debug(redefine, class, update, vtables)
3188           (&quot;default method update: %s(%s) &quot;,
3189            new_method-&gt;name()-&gt;as_C_string(), new_method-&gt;signature()-&gt;as_C_string());
3190       }
3191     }
3192   }
3193 }
3194 #endif // INCLUDE_JVMTI
3195 
3196 // On-stack replacement stuff
3197 void InstanceKlass::add_osr_nmethod(nmethod* n) {
3198   assert_lock_strong(CompiledMethod_lock);
3199 #ifndef PRODUCT
3200   if (TieredCompilation) {
3201       nmethod * prev = lookup_osr_nmethod(n-&gt;method(), n-&gt;osr_entry_bci(), n-&gt;comp_level(), true);
3202       assert(prev == NULL || !prev-&gt;is_in_use(),
3203       &quot;redundunt OSR recompilation detected. memory leak in CodeCache!&quot;);
3204   }
3205 #endif
3206   // only one compilation can be active
3207   {
3208     assert(n-&gt;is_osr_method(), &quot;wrong kind of nmethod&quot;);
3209     n-&gt;set_osr_link(osr_nmethods_head());
3210     set_osr_nmethods_head(n);
3211     // Raise the highest osr level if necessary
3212     if (TieredCompilation) {
3213       Method* m = n-&gt;method();
3214       m-&gt;set_highest_osr_comp_level(MAX2(m-&gt;highest_osr_comp_level(), n-&gt;comp_level()));
3215     }
3216   }
3217 
3218   // Get rid of the osr methods for the same bci that have lower levels.
3219   if (TieredCompilation) {
3220     for (int l = CompLevel_limited_profile; l &lt; n-&gt;comp_level(); l++) {
3221       nmethod *inv = lookup_osr_nmethod(n-&gt;method(), n-&gt;osr_entry_bci(), l, true);
3222       if (inv != NULL &amp;&amp; inv-&gt;is_in_use()) {
3223         inv-&gt;make_not_entrant();
3224       }
3225     }
3226   }
3227 }
3228 
3229 // Remove osr nmethod from the list. Return true if found and removed.
3230 bool InstanceKlass::remove_osr_nmethod(nmethod* n) {
3231   // This is a short non-blocking critical region, so the no safepoint check is ok.
3232   MutexLocker ml(CompiledMethod_lock-&gt;owned_by_self() ? NULL : CompiledMethod_lock
3233                  , Mutex::_no_safepoint_check_flag);
3234   assert(n-&gt;is_osr_method(), &quot;wrong kind of nmethod&quot;);
3235   nmethod* last = NULL;
3236   nmethod* cur  = osr_nmethods_head();
3237   int max_level = CompLevel_none;  // Find the max comp level excluding n
3238   Method* m = n-&gt;method();
3239   // Search for match
3240   bool found = false;
3241   while(cur != NULL &amp;&amp; cur != n) {
3242     if (TieredCompilation &amp;&amp; m == cur-&gt;method()) {
3243       // Find max level before n
3244       max_level = MAX2(max_level, cur-&gt;comp_level());
3245     }
3246     last = cur;
3247     cur = cur-&gt;osr_link();
3248   }
3249   nmethod* next = NULL;
3250   if (cur == n) {
3251     found = true;
3252     next = cur-&gt;osr_link();
3253     if (last == NULL) {
3254       // Remove first element
3255       set_osr_nmethods_head(next);
3256     } else {
3257       last-&gt;set_osr_link(next);
3258     }
3259   }
3260   n-&gt;set_osr_link(NULL);
3261   if (TieredCompilation) {
3262     cur = next;
3263     while (cur != NULL) {
3264       // Find max level after n
3265       if (m == cur-&gt;method()) {
3266         max_level = MAX2(max_level, cur-&gt;comp_level());
3267       }
3268       cur = cur-&gt;osr_link();
3269     }
3270     m-&gt;set_highest_osr_comp_level(max_level);
3271   }
3272   return found;
3273 }
3274 
3275 int InstanceKlass::mark_osr_nmethods(const Method* m) {
3276   MutexLocker ml(CompiledMethod_lock-&gt;owned_by_self() ? NULL : CompiledMethod_lock,
3277                  Mutex::_no_safepoint_check_flag);
3278   nmethod* osr = osr_nmethods_head();
3279   int found = 0;
3280   while (osr != NULL) {
3281     assert(osr-&gt;is_osr_method(), &quot;wrong kind of nmethod found in chain&quot;);
3282     if (osr-&gt;method() == m) {
3283       osr-&gt;mark_for_deoptimization();
3284       found++;
3285     }
3286     osr = osr-&gt;osr_link();
3287   }
3288   return found;
3289 }
3290 
3291 nmethod* InstanceKlass::lookup_osr_nmethod(const Method* m, int bci, int comp_level, bool match_level) const {
3292   MutexLocker ml(CompiledMethod_lock-&gt;owned_by_self() ? NULL : CompiledMethod_lock,
3293                  Mutex::_no_safepoint_check_flag);
3294   nmethod* osr = osr_nmethods_head();
3295   nmethod* best = NULL;
3296   while (osr != NULL) {
3297     assert(osr-&gt;is_osr_method(), &quot;wrong kind of nmethod found in chain&quot;);
3298     // There can be a time when a c1 osr method exists but we are waiting
3299     // for a c2 version. When c2 completes its osr nmethod we will trash
3300     // the c1 version and only be able to find the c2 version. However
3301     // while we overflow in the c1 code at back branches we don&#39;t want to
3302     // try and switch to the same code as we are already running
3303 
3304     if (osr-&gt;method() == m &amp;&amp;
3305         (bci == InvocationEntryBci || osr-&gt;osr_entry_bci() == bci)) {
3306       if (match_level) {
3307         if (osr-&gt;comp_level() == comp_level) {
3308           // Found a match - return it.
3309           return osr;
3310         }
3311       } else {
3312         if (best == NULL || (osr-&gt;comp_level() &gt; best-&gt;comp_level())) {
3313           if (osr-&gt;comp_level() == CompLevel_highest_tier) {
3314             // Found the best possible - return it.
3315             return osr;
3316           }
3317           best = osr;
3318         }
3319       }
3320     }
3321     osr = osr-&gt;osr_link();
3322   }
3323 
3324   assert(match_level == false || best == NULL, &quot;shouldn&#39;t pick up anything if match_level is set&quot;);
3325   if (best != NULL &amp;&amp; best-&gt;comp_level() &gt;= comp_level) {
3326     return best;
3327   }
3328   return NULL;
3329 }
3330 
3331 // -----------------------------------------------------------------------------------------------------
3332 // Printing
3333 
3334 #ifndef PRODUCT
3335 
3336 #define BULLET  &quot; - &quot;
3337 
3338 static const char* state_names[] = {
3339   &quot;allocated&quot;, &quot;loaded&quot;, &quot;linked&quot;, &quot;being_initialized&quot;, &quot;fully_initialized&quot;, &quot;initialization_error&quot;
3340 };
3341 
3342 static void print_vtable(address self, intptr_t* start, int len, outputStream* st) {
3343   ResourceMark rm;
3344   int* forward_refs = NEW_RESOURCE_ARRAY(int, len);
3345   for (int i = 0; i &lt; len; i++)  forward_refs[i] = 0;
3346   for (int i = 0; i &lt; len; i++) {
3347     intptr_t e = start[i];
3348     st-&gt;print(&quot;%d : &quot; INTPTR_FORMAT, i, e);
3349     if (forward_refs[i] != 0) {
3350       int from = forward_refs[i];
3351       int off = (int) start[from];
3352       st-&gt;print(&quot; (offset %d &lt;= [%d])&quot;, off, from);
3353     }
3354     if (MetaspaceObj::is_valid((Metadata*)e)) {
3355       st-&gt;print(&quot; &quot;);
3356       ((Metadata*)e)-&gt;print_value_on(st);
3357     } else if (self != NULL &amp;&amp; e &gt; 0 &amp;&amp; e &lt; 0x10000) {
3358       address location = self + e;
3359       int index = (int)((intptr_t*)location - start);
3360       st-&gt;print(&quot; (offset %d =&gt; [%d])&quot;, (int)e, index);
3361       if (index &gt;= 0 &amp;&amp; index &lt; len)
3362         forward_refs[index] = i;
3363     }
3364     st-&gt;cr();
3365   }
3366 }
3367 
3368 static void print_vtable(vtableEntry* start, int len, outputStream* st) {
3369   return print_vtable(NULL, reinterpret_cast&lt;intptr_t*&gt;(start), len, st);
3370 }
3371 
3372 template&lt;typename T&gt;
3373  static void print_array_on(outputStream* st, Array&lt;T&gt;* array) {
3374    if (array == NULL) { st-&gt;print_cr(&quot;NULL&quot;); return; }
3375    array-&gt;print_value_on(st); st-&gt;cr();
3376    if (Verbose || WizardMode) {
3377      for (int i = 0; i &lt; array-&gt;length(); i++) {
3378        st-&gt;print(&quot;%d : &quot;, i); array-&gt;at(i)-&gt;print_value_on(st); st-&gt;cr();
3379      }
3380    }
3381  }
3382 
3383 static void print_array_on(outputStream* st, Array&lt;int&gt;* array) {
3384   if (array == NULL) { st-&gt;print_cr(&quot;NULL&quot;); return; }
3385   array-&gt;print_value_on(st); st-&gt;cr();
3386   if (Verbose || WizardMode) {
3387     for (int i = 0; i &lt; array-&gt;length(); i++) {
3388       st-&gt;print(&quot;%d : %d&quot;, i, array-&gt;at(i)); st-&gt;cr();
3389     }
3390   }
3391 }
3392 
3393 void InstanceKlass::print_on(outputStream* st) const {
3394   assert(is_klass(), &quot;must be klass&quot;);
3395   Klass::print_on(st);
3396 
3397   st-&gt;print(BULLET&quot;instance size:     %d&quot;, size_helper());                        st-&gt;cr();
3398   st-&gt;print(BULLET&quot;klass size:        %d&quot;, size());                               st-&gt;cr();
3399   st-&gt;print(BULLET&quot;access:            &quot;); access_flags().print_on(st);            st-&gt;cr();
3400   st-&gt;print(BULLET&quot;misc flags:        0x%x&quot;, _misc_flags);                        st-&gt;cr();
3401   st-&gt;print(BULLET&quot;state:             &quot;); st-&gt;print_cr(&quot;%s&quot;, state_names[_init_state]);
3402   st-&gt;print(BULLET&quot;name:              &quot;); name()-&gt;print_value_on(st);             st-&gt;cr();
3403   st-&gt;print(BULLET&quot;super:             &quot;); Metadata::print_value_on_maybe_null(st, super()); st-&gt;cr();
3404   st-&gt;print(BULLET&quot;sub:               &quot;);
3405   Klass* sub = subklass();
3406   int n;
3407   for (n = 0; sub != NULL; n++, sub = sub-&gt;next_sibling()) {
3408     if (n &lt; MaxSubklassPrintSize) {
3409       sub-&gt;print_value_on(st);
3410       st-&gt;print(&quot;   &quot;);
3411     }
3412   }
3413   if (n &gt;= MaxSubklassPrintSize) st-&gt;print(&quot;(&quot; INTX_FORMAT &quot; more klasses...)&quot;, n - MaxSubklassPrintSize);
3414   st-&gt;cr();
3415 
3416   if (is_interface()) {
3417     st-&gt;print_cr(BULLET&quot;nof implementors:  %d&quot;, nof_implementors());
3418     if (nof_implementors() == 1) {
3419       st-&gt;print_cr(BULLET&quot;implementor:    &quot;);
3420       st-&gt;print(&quot;   &quot;);
3421       implementor()-&gt;print_value_on(st);
3422       st-&gt;cr();
3423     }
3424   }
3425 
3426   st-&gt;print(BULLET&quot;arrays:            &quot;); Metadata::print_value_on_maybe_null(st, array_klasses()); st-&gt;cr();
3427   st-&gt;print(BULLET&quot;methods:           &quot;); print_array_on(st, methods());
3428   st-&gt;print(BULLET&quot;method ordering:   &quot;); print_array_on(st, method_ordering());
3429   st-&gt;print(BULLET&quot;default_methods:   &quot;); print_array_on(st, default_methods());
3430   if (default_vtable_indices() != NULL) {
3431     st-&gt;print(BULLET&quot;default vtable indices:   &quot;); print_array_on(st, default_vtable_indices());
3432   }
3433   st-&gt;print(BULLET&quot;local interfaces:  &quot;); print_array_on(st, local_interfaces());
3434   st-&gt;print(BULLET&quot;trans. interfaces: &quot;); print_array_on(st, transitive_interfaces());
3435   st-&gt;print(BULLET&quot;constants:         &quot;); constants()-&gt;print_value_on(st);         st-&gt;cr();
3436   if (class_loader_data() != NULL) {
3437     st-&gt;print(BULLET&quot;class loader data:  &quot;);
3438     class_loader_data()-&gt;print_value_on(st);
3439     st-&gt;cr();
3440   }
3441   st-&gt;print(BULLET&quot;unsafe anonymous host class:        &quot;); Metadata::print_value_on_maybe_null(st, unsafe_anonymous_host()); st-&gt;cr();
3442   if (source_file_name() != NULL) {
3443     st-&gt;print(BULLET&quot;source file:       &quot;);
3444     source_file_name()-&gt;print_value_on(st);
3445     st-&gt;cr();
3446   }
3447   if (source_debug_extension() != NULL) {
3448     st-&gt;print(BULLET&quot;source debug extension:       &quot;);
3449     st-&gt;print(&quot;%s&quot;, source_debug_extension());
3450     st-&gt;cr();
3451   }
3452   st-&gt;print(BULLET&quot;class annotations:       &quot;); class_annotations()-&gt;print_value_on(st); st-&gt;cr();
3453   st-&gt;print(BULLET&quot;class type annotations:  &quot;); class_type_annotations()-&gt;print_value_on(st); st-&gt;cr();
3454   st-&gt;print(BULLET&quot;field annotations:       &quot;); fields_annotations()-&gt;print_value_on(st); st-&gt;cr();
3455   st-&gt;print(BULLET&quot;field type annotations:  &quot;); fields_type_annotations()-&gt;print_value_on(st); st-&gt;cr();
3456   {
3457     bool have_pv = false;
3458     // previous versions are linked together through the InstanceKlass
3459     for (InstanceKlass* pv_node = previous_versions();
3460          pv_node != NULL;
3461          pv_node = pv_node-&gt;previous_versions()) {
3462       if (!have_pv)
3463         st-&gt;print(BULLET&quot;previous version:  &quot;);
3464       have_pv = true;
3465       pv_node-&gt;constants()-&gt;print_value_on(st);
3466     }
3467     if (have_pv) st-&gt;cr();
3468   }
3469 
3470   if (generic_signature() != NULL) {
3471     st-&gt;print(BULLET&quot;generic signature: &quot;);
3472     generic_signature()-&gt;print_value_on(st);
3473     st-&gt;cr();
3474   }
3475   st-&gt;print(BULLET&quot;inner classes:     &quot;); inner_classes()-&gt;print_value_on(st);     st-&gt;cr();
3476   st-&gt;print(BULLET&quot;nest members:     &quot;); nest_members()-&gt;print_value_on(st);     st-&gt;cr();
3477   if (record_components() != NULL) {
3478     st-&gt;print(BULLET&quot;record components:     &quot;); record_components()-&gt;print_value_on(st);     st-&gt;cr();
3479   }
3480   if (java_mirror() != NULL) {
3481     st-&gt;print(BULLET&quot;java mirror:       &quot;);
3482     java_mirror()-&gt;print_value_on(st);
3483     st-&gt;cr();
3484   } else {
3485     st-&gt;print_cr(BULLET&quot;java mirror:       NULL&quot;);
3486   }
3487   st-&gt;print(BULLET&quot;vtable length      %d  (start addr: &quot; INTPTR_FORMAT &quot;)&quot;, vtable_length(), p2i(start_of_vtable())); st-&gt;cr();
3488   if (vtable_length() &gt; 0 &amp;&amp; (Verbose || WizardMode))  print_vtable(start_of_vtable(), vtable_length(), st);
3489   st-&gt;print(BULLET&quot;itable length      %d (start addr: &quot; INTPTR_FORMAT &quot;)&quot;, itable_length(), p2i(start_of_itable())); st-&gt;cr();
3490   if (itable_length() &gt; 0 &amp;&amp; (Verbose || WizardMode))  print_vtable(NULL, start_of_itable(), itable_length(), st);
3491   st-&gt;print_cr(BULLET&quot;---- static fields (%d words):&quot;, static_field_size());
3492   FieldPrinter print_static_field(st);
3493   ((InstanceKlass*)this)-&gt;do_local_static_fields(&amp;print_static_field);
3494   st-&gt;print_cr(BULLET&quot;---- non-static fields (%d words):&quot;, nonstatic_field_size());
3495   FieldPrinter print_nonstatic_field(st);
3496   InstanceKlass* ik = const_cast&lt;InstanceKlass*&gt;(this);
3497   ik-&gt;do_nonstatic_fields(&amp;print_nonstatic_field);
3498 
3499   st-&gt;print(BULLET&quot;non-static oop maps: &quot;);
3500   OopMapBlock* map     = start_of_nonstatic_oop_maps();
3501   OopMapBlock* end_map = map + nonstatic_oop_map_count();
3502   while (map &lt; end_map) {
3503     st-&gt;print(&quot;%d-%d &quot;, map-&gt;offset(), map-&gt;offset() + heapOopSize*(map-&gt;count() - 1));
3504     map++;
3505   }
3506   st-&gt;cr();
3507 }
3508 
3509 #endif //PRODUCT
3510 
3511 void InstanceKlass::print_value_on(outputStream* st) const {
3512   assert(is_klass(), &quot;must be klass&quot;);
3513   if (Verbose || WizardMode)  access_flags().print_on(st);
3514   name()-&gt;print_value_on(st);
3515 }
3516 
3517 #ifndef PRODUCT
3518 
3519 void FieldPrinter::do_field(fieldDescriptor* fd) {
3520   _st-&gt;print(BULLET);
3521    if (_obj == NULL) {
3522      fd-&gt;print_on(_st);
3523      _st-&gt;cr();
3524    } else {
3525      fd-&gt;print_on_for(_st, _obj);
3526      _st-&gt;cr();
3527    }
3528 }
3529 
3530 
3531 void InstanceKlass::oop_print_on(oop obj, outputStream* st) {
3532   Klass::oop_print_on(obj, st);
3533 
3534   if (this == SystemDictionary::String_klass()) {
3535     typeArrayOop value  = java_lang_String::value(obj);
3536     juint        length = java_lang_String::length(obj);
3537     if (value != NULL &amp;&amp;
3538         value-&gt;is_typeArray() &amp;&amp;
3539         length &lt;= (juint) value-&gt;length()) {
3540       st-&gt;print(BULLET&quot;string: &quot;);
3541       java_lang_String::print(obj, st);
3542       st-&gt;cr();
3543       if (!WizardMode)  return;  // that is enough
3544     }
3545   }
3546 
3547   st-&gt;print_cr(BULLET&quot;---- fields (total size %d words):&quot;, oop_size(obj));
3548   FieldPrinter print_field(st, obj);
3549   do_nonstatic_fields(&amp;print_field);
3550 
3551   if (this == SystemDictionary::Class_klass()) {
3552     st-&gt;print(BULLET&quot;signature: &quot;);
3553     java_lang_Class::print_signature(obj, st);
3554     st-&gt;cr();
3555     Klass* mirrored_klass = java_lang_Class::as_Klass(obj);
3556     st-&gt;print(BULLET&quot;fake entry for mirror: &quot;);
3557     Metadata::print_value_on_maybe_null(st, mirrored_klass);
3558     st-&gt;cr();
3559     Klass* array_klass = java_lang_Class::array_klass_acquire(obj);
3560     st-&gt;print(BULLET&quot;fake entry for array: &quot;);
3561     Metadata::print_value_on_maybe_null(st, array_klass);
3562     st-&gt;cr();
3563     st-&gt;print_cr(BULLET&quot;fake entry for oop_size: %d&quot;, java_lang_Class::oop_size(obj));
3564     st-&gt;print_cr(BULLET&quot;fake entry for static_oop_field_count: %d&quot;, java_lang_Class::static_oop_field_count(obj));
3565     Klass* real_klass = java_lang_Class::as_Klass(obj);
3566     if (real_klass != NULL &amp;&amp; real_klass-&gt;is_instance_klass()) {
3567       InstanceKlass::cast(real_klass)-&gt;do_local_static_fields(&amp;print_field);
3568     }
3569   } else if (this == SystemDictionary::MethodType_klass()) {
3570     st-&gt;print(BULLET&quot;signature: &quot;);
3571     java_lang_invoke_MethodType::print_signature(obj, st);
3572     st-&gt;cr();
3573   }
3574 }
3575 
3576 bool InstanceKlass::verify_itable_index(int i) {
3577   int method_count = klassItable::method_count_for_interface(this);
3578   assert(i &gt;= 0 &amp;&amp; i &lt; method_count, &quot;index out of bounds&quot;);
3579   return true;
3580 }
3581 
3582 #endif //PRODUCT
3583 
3584 void InstanceKlass::oop_print_value_on(oop obj, outputStream* st) {
3585   st-&gt;print(&quot;a &quot;);
3586   name()-&gt;print_value_on(st);
3587   obj-&gt;print_address_on(st);
3588   if (this == SystemDictionary::String_klass()
3589       &amp;&amp; java_lang_String::value(obj) != NULL) {
3590     ResourceMark rm;
3591     int len = java_lang_String::length(obj);
3592     int plen = (len &lt; 24 ? len : 12);
3593     char* str = java_lang_String::as_utf8_string(obj, 0, plen);
3594     st-&gt;print(&quot; = \&quot;%s\&quot;&quot;, str);
3595     if (len &gt; plen)
3596       st-&gt;print(&quot;...[%d]&quot;, len);
3597   } else if (this == SystemDictionary::Class_klass()) {
3598     Klass* k = java_lang_Class::as_Klass(obj);
3599     st-&gt;print(&quot; = &quot;);
3600     if (k != NULL) {
3601       k-&gt;print_value_on(st);
3602     } else {
3603       const char* tname = type2name(java_lang_Class::primitive_type(obj));
3604       st-&gt;print(&quot;%s&quot;, tname ? tname : &quot;type?&quot;);
3605     }
3606   } else if (this == SystemDictionary::MethodType_klass()) {
3607     st-&gt;print(&quot; = &quot;);
3608     java_lang_invoke_MethodType::print_signature(obj, st);
3609   } else if (java_lang_boxing_object::is_instance(obj)) {
3610     st-&gt;print(&quot; = &quot;);
3611     java_lang_boxing_object::print(obj, st);
3612   } else if (this == SystemDictionary::LambdaForm_klass()) {
3613     oop vmentry = java_lang_invoke_LambdaForm::vmentry(obj);
3614     if (vmentry != NULL) {
3615       st-&gt;print(&quot; =&gt; &quot;);
3616       vmentry-&gt;print_value_on(st);
3617     }
3618   } else if (this == SystemDictionary::MemberName_klass()) {
3619     Metadata* vmtarget = java_lang_invoke_MemberName::vmtarget(obj);
3620     if (vmtarget != NULL) {
3621       st-&gt;print(&quot; = &quot;);
3622       vmtarget-&gt;print_value_on(st);
3623     } else {
3624       java_lang_invoke_MemberName::clazz(obj)-&gt;print_value_on(st);
3625       st-&gt;print(&quot;.&quot;);
3626       java_lang_invoke_MemberName::name(obj)-&gt;print_value_on(st);
3627     }
3628   }
3629 }
3630 
3631 const char* InstanceKlass::internal_name() const {
3632   return external_name();
3633 }
3634 
3635 void InstanceKlass::print_class_load_logging(ClassLoaderData* loader_data,
3636                                              const char* module_name,
3637                                              const ClassFileStream* cfs) const {
3638   if (!log_is_enabled(Info, class, load)) {
3639     return;
3640   }
3641 
3642   ResourceMark rm;
3643   LogMessage(class, load) msg;
3644   stringStream info_stream;
3645 
3646   // Name and class hierarchy info
3647   info_stream.print(&quot;%s&quot;, external_name());
3648 
3649   // Source
3650   if (cfs != NULL) {
3651     if (cfs-&gt;source() != NULL) {
3652       if (module_name != NULL) {
3653         // When the boot loader created the stream, it didn&#39;t know the module name
3654         // yet. Let&#39;s format it now.
3655         if (cfs-&gt;from_boot_loader_modules_image()) {
3656           info_stream.print(&quot; source: jrt:/%s&quot;, module_name);
3657         } else {
3658           info_stream.print(&quot; source: %s&quot;, cfs-&gt;source());
3659         }
3660       } else {
3661         info_stream.print(&quot; source: %s&quot;, cfs-&gt;source());
3662       }
3663     } else if (loader_data == ClassLoaderData::the_null_class_loader_data()) {
3664       Thread* THREAD = Thread::current();
3665       Klass* caller =
3666             THREAD-&gt;is_Java_thread()
3667                 ? ((JavaThread*)THREAD)-&gt;security_get_caller_class(1)
3668                 : NULL;
3669       // caller can be NULL, for example, during a JVMTI VM_Init hook
3670       if (caller != NULL) {
3671         info_stream.print(&quot; source: instance of %s&quot;, caller-&gt;external_name());
3672       } else {
3673         // source is unknown
3674       }
3675     } else {
3676       oop class_loader = loader_data-&gt;class_loader();
3677       info_stream.print(&quot; source: %s&quot;, class_loader-&gt;klass()-&gt;external_name());
3678     }
3679   } else {
3680     assert(this-&gt;is_shared(), &quot;must be&quot;);
3681     if (MetaspaceShared::is_shared_dynamic((void*)this)) {
3682       info_stream.print(&quot; source: shared objects file (top)&quot;);
3683     } else {
3684       info_stream.print(&quot; source: shared objects file&quot;);
3685     }
3686   }
3687 
3688   msg.info(&quot;%s&quot;, info_stream.as_string());
3689 
3690   if (log_is_enabled(Debug, class, load)) {
3691     stringStream debug_stream;
3692 
3693     // Class hierarchy info
3694     debug_stream.print(&quot; klass: &quot; INTPTR_FORMAT &quot; super: &quot; INTPTR_FORMAT,
3695                        p2i(this),  p2i(superklass()));
3696 
3697     // Interfaces
3698     if (local_interfaces() != NULL &amp;&amp; local_interfaces()-&gt;length() &gt; 0) {
3699       debug_stream.print(&quot; interfaces:&quot;);
3700       int length = local_interfaces()-&gt;length();
3701       for (int i = 0; i &lt; length; i++) {
3702         debug_stream.print(&quot; &quot; INTPTR_FORMAT,
3703                            p2i(InstanceKlass::cast(local_interfaces()-&gt;at(i))));
3704       }
3705     }
3706 
3707     // Class loader
3708     debug_stream.print(&quot; loader: [&quot;);
3709     loader_data-&gt;print_value_on(&amp;debug_stream);
3710     debug_stream.print(&quot;]&quot;);
3711 
3712     // Classfile checksum
3713     if (cfs) {
3714       debug_stream.print(&quot; bytes: %d checksum: %08x&quot;,
3715                          cfs-&gt;length(),
3716                          ClassLoader::crc32(0, (const char*)cfs-&gt;buffer(),
3717                          cfs-&gt;length()));
3718     }
3719 
3720     msg.debug(&quot;%s&quot;, debug_stream.as_string());
3721   }
3722 }
3723 
3724 // Verification
3725 
3726 class VerifyFieldClosure: public BasicOopIterateClosure {
3727  protected:
3728   template &lt;class T&gt; void do_oop_work(T* p) {
3729     oop obj = RawAccess&lt;&gt;::oop_load(p);
3730     if (!oopDesc::is_oop_or_null(obj)) {
3731       tty-&gt;print_cr(&quot;Failed: &quot; PTR_FORMAT &quot; -&gt; &quot; PTR_FORMAT, p2i(p), p2i(obj));
3732       Universe::print_on(tty);
3733       guarantee(false, &quot;boom&quot;);
3734     }
3735   }
3736  public:
3737   virtual void do_oop(oop* p)       { VerifyFieldClosure::do_oop_work(p); }
3738   virtual void do_oop(narrowOop* p) { VerifyFieldClosure::do_oop_work(p); }
3739 };
3740 
3741 void InstanceKlass::verify_on(outputStream* st) {
3742 #ifndef PRODUCT
3743   // Avoid redundant verifies, this really should be in product.
3744   if (_verify_count == Universe::verify_count()) return;
3745   _verify_count = Universe::verify_count();
3746 #endif
3747 
3748   // Verify Klass
3749   Klass::verify_on(st);
3750 
3751   // Verify that klass is present in ClassLoaderData
3752   guarantee(class_loader_data()-&gt;contains_klass(this),
3753             &quot;this class isn&#39;t found in class loader data&quot;);
3754 
3755   // Verify vtables
3756   if (is_linked()) {
3757     // $$$ This used to be done only for m/s collections.  Doing it
3758     // always seemed a valid generalization.  (DLD -- 6/00)
3759     vtable().verify(st);
3760   }
3761 
3762   // Verify first subklass
3763   if (subklass() != NULL) {
3764     guarantee(subklass()-&gt;is_klass(), &quot;should be klass&quot;);
3765   }
3766 
3767   // Verify siblings
3768   Klass* super = this-&gt;super();
3769   Klass* sib = next_sibling();
3770   if (sib != NULL) {
3771     if (sib == this) {
3772       fatal(&quot;subclass points to itself &quot; PTR_FORMAT, p2i(sib));
3773     }
3774 
3775     guarantee(sib-&gt;is_klass(), &quot;should be klass&quot;);
3776     guarantee(sib-&gt;super() == super, &quot;siblings should have same superklass&quot;);
3777   }
3778 
3779   // Verify local interfaces
3780   if (local_interfaces()) {
3781     Array&lt;InstanceKlass*&gt;* local_interfaces = this-&gt;local_interfaces();
3782     for (int j = 0; j &lt; local_interfaces-&gt;length(); j++) {
3783       InstanceKlass* e = local_interfaces-&gt;at(j);
3784       guarantee(e-&gt;is_klass() &amp;&amp; e-&gt;is_interface(), &quot;invalid local interface&quot;);
3785     }
3786   }
3787 
3788   // Verify transitive interfaces
3789   if (transitive_interfaces() != NULL) {
3790     Array&lt;InstanceKlass*&gt;* transitive_interfaces = this-&gt;transitive_interfaces();
3791     for (int j = 0; j &lt; transitive_interfaces-&gt;length(); j++) {
3792       InstanceKlass* e = transitive_interfaces-&gt;at(j);
3793       guarantee(e-&gt;is_klass() &amp;&amp; e-&gt;is_interface(), &quot;invalid transitive interface&quot;);
3794     }
3795   }
3796 
3797   // Verify methods
3798   if (methods() != NULL) {
3799     Array&lt;Method*&gt;* methods = this-&gt;methods();
3800     for (int j = 0; j &lt; methods-&gt;length(); j++) {
3801       guarantee(methods-&gt;at(j)-&gt;is_method(), &quot;non-method in methods array&quot;);
3802     }
3803     for (int j = 0; j &lt; methods-&gt;length() - 1; j++) {
3804       Method* m1 = methods-&gt;at(j);
3805       Method* m2 = methods-&gt;at(j + 1);
3806       guarantee(m1-&gt;name()-&gt;fast_compare(m2-&gt;name()) &lt;= 0, &quot;methods not sorted correctly&quot;);
3807     }
3808   }
3809 
3810   // Verify method ordering
3811   if (method_ordering() != NULL) {
3812     Array&lt;int&gt;* method_ordering = this-&gt;method_ordering();
3813     int length = method_ordering-&gt;length();
3814     if (JvmtiExport::can_maintain_original_method_order() ||
3815         ((UseSharedSpaces || Arguments::is_dumping_archive()) &amp;&amp; length != 0)) {
3816       guarantee(length == methods()-&gt;length(), &quot;invalid method ordering length&quot;);
3817       jlong sum = 0;
3818       for (int j = 0; j &lt; length; j++) {
3819         int original_index = method_ordering-&gt;at(j);
3820         guarantee(original_index &gt;= 0, &quot;invalid method ordering index&quot;);
3821         guarantee(original_index &lt; length, &quot;invalid method ordering index&quot;);
3822         sum += original_index;
3823       }
3824       // Verify sum of indices 0,1,...,length-1
3825       guarantee(sum == ((jlong)length*(length-1))/2, &quot;invalid method ordering sum&quot;);
3826     } else {
3827       guarantee(length == 0, &quot;invalid method ordering length&quot;);
3828     }
3829   }
3830 
3831   // Verify default methods
3832   if (default_methods() != NULL) {
3833     Array&lt;Method*&gt;* methods = this-&gt;default_methods();
3834     for (int j = 0; j &lt; methods-&gt;length(); j++) {
3835       guarantee(methods-&gt;at(j)-&gt;is_method(), &quot;non-method in methods array&quot;);
3836     }
3837     for (int j = 0; j &lt; methods-&gt;length() - 1; j++) {
3838       Method* m1 = methods-&gt;at(j);
3839       Method* m2 = methods-&gt;at(j + 1);
3840       guarantee(m1-&gt;name()-&gt;fast_compare(m2-&gt;name()) &lt;= 0, &quot;methods not sorted correctly&quot;);
3841     }
3842   }
3843 
3844   // Verify JNI static field identifiers
3845   if (jni_ids() != NULL) {
3846     jni_ids()-&gt;verify(this);
3847   }
3848 
3849   // Verify other fields
3850   if (array_klasses() != NULL) {
3851     guarantee(array_klasses()-&gt;is_klass(), &quot;should be klass&quot;);
3852   }
3853   if (constants() != NULL) {
3854     guarantee(constants()-&gt;is_constantPool(), &quot;should be constant pool&quot;);
3855   }
3856   const Klass* anonymous_host = unsafe_anonymous_host();
3857   if (anonymous_host != NULL) {
3858     guarantee(anonymous_host-&gt;is_klass(), &quot;should be klass&quot;);
3859   }
3860 }
3861 
3862 void InstanceKlass::oop_verify_on(oop obj, outputStream* st) {
3863   Klass::oop_verify_on(obj, st);
3864   VerifyFieldClosure blk;
3865   obj-&gt;oop_iterate(&amp;blk);
3866 }
3867 
3868 
3869 // JNIid class for jfieldIDs only
3870 // Note to reviewers:
3871 // These JNI functions are just moved over to column 1 and not changed
3872 // in the compressed oops workspace.
3873 JNIid::JNIid(Klass* holder, int offset, JNIid* next) {
3874   _holder = holder;
3875   _offset = offset;
3876   _next = next;
3877   debug_only(_is_static_field_id = false;)
3878 }
3879 
3880 
3881 JNIid* JNIid::find(int offset) {
3882   JNIid* current = this;
3883   while (current != NULL) {
3884     if (current-&gt;offset() == offset) return current;
3885     current = current-&gt;next();
3886   }
3887   return NULL;
3888 }
3889 
3890 void JNIid::deallocate(JNIid* current) {
3891   while (current != NULL) {
3892     JNIid* next = current-&gt;next();
3893     delete current;
3894     current = next;
3895   }
3896 }
3897 
3898 
3899 void JNIid::verify(Klass* holder) {
3900   int first_field_offset  = InstanceMirrorKlass::offset_of_static_fields();
3901   int end_field_offset;
3902   end_field_offset = first_field_offset + (InstanceKlass::cast(holder)-&gt;static_field_size() * wordSize);
3903 
3904   JNIid* current = this;
3905   while (current != NULL) {
3906     guarantee(current-&gt;holder() == holder, &quot;Invalid klass in JNIid&quot;);
3907 #ifdef ASSERT
3908     int o = current-&gt;offset();
3909     if (current-&gt;is_static_field_id()) {
3910       guarantee(o &gt;= first_field_offset  &amp;&amp; o &lt; end_field_offset,  &quot;Invalid static field offset in JNIid&quot;);
3911     }
3912 #endif
3913     current = current-&gt;next();
3914   }
3915 }
3916 
3917 void InstanceKlass::set_init_state(ClassState state) {
3918 #ifdef ASSERT
3919   bool good_state = is_shared() ? (_init_state &lt;= state)
3920                                                : (_init_state &lt; state);
3921   assert(good_state || state == allocated, &quot;illegal state transition&quot;);
3922 #endif
3923   assert(_init_thread == NULL, &quot;should be cleared before state change&quot;);
3924   _init_state = (u1)state;
3925 }
3926 
3927 #if INCLUDE_JVMTI
3928 
3929 // RedefineClasses() support for previous versions
3930 
3931 // Globally, there is at least one previous version of a class to walk
3932 // during class unloading, which is saved because old methods in the class
3933 // are still running.   Otherwise the previous version list is cleaned up.
3934 bool InstanceKlass::_has_previous_versions = false;
3935 
3936 // Returns true if there are previous versions of a class for class
3937 // unloading only. Also resets the flag to false. purge_previous_version
3938 // will set the flag to true if there are any left, i.e., if there&#39;s any
3939 // work to do for next time. This is to avoid the expensive code cache
3940 // walk in CLDG::clean_deallocate_lists().
3941 bool InstanceKlass::has_previous_versions_and_reset() {
3942   bool ret = _has_previous_versions;
3943   log_trace(redefine, class, iklass, purge)(&quot;Class unloading: has_previous_versions = %s&quot;,
3944      ret ? &quot;true&quot; : &quot;false&quot;);
3945   _has_previous_versions = false;
3946   return ret;
3947 }
3948 
3949 // Purge previous versions before adding new previous versions of the class and
3950 // during class unloading.
3951 void InstanceKlass::purge_previous_version_list() {
3952   assert(SafepointSynchronize::is_at_safepoint(), &quot;only called at safepoint&quot;);
3953   assert(has_been_redefined(), &quot;Should only be called for main class&quot;);
3954 
3955   // Quick exit.
3956   if (previous_versions() == NULL) {
3957     return;
3958   }
3959 
3960   // This klass has previous versions so see what we can cleanup
3961   // while it is safe to do so.
3962 
3963   int deleted_count = 0;    // leave debugging breadcrumbs
3964   int live_count = 0;
3965   ClassLoaderData* loader_data = class_loader_data();
3966   assert(loader_data != NULL, &quot;should never be null&quot;);
3967 
3968   ResourceMark rm;
3969   log_trace(redefine, class, iklass, purge)(&quot;%s: previous versions&quot;, external_name());
3970 
3971   // previous versions are linked together through the InstanceKlass
3972   InstanceKlass* pv_node = previous_versions();
3973   InstanceKlass* last = this;
3974   int version = 0;
3975 
3976   // check the previous versions list
3977   for (; pv_node != NULL; ) {
3978 
3979     ConstantPool* pvcp = pv_node-&gt;constants();
3980     assert(pvcp != NULL, &quot;cp ref was unexpectedly cleared&quot;);
3981 
3982     if (!pvcp-&gt;on_stack()) {
3983       // If the constant pool isn&#39;t on stack, none of the methods
3984       // are executing.  Unlink this previous_version.
3985       // The previous version InstanceKlass is on the ClassLoaderData deallocate list
3986       // so will be deallocated during the next phase of class unloading.
3987       log_trace(redefine, class, iklass, purge)
3988         (&quot;previous version &quot; INTPTR_FORMAT &quot; is dead.&quot;, p2i(pv_node));
3989       // For debugging purposes.
3990       pv_node-&gt;set_is_scratch_class();
3991       // Unlink from previous version list.
3992       assert(pv_node-&gt;class_loader_data() == loader_data, &quot;wrong loader_data&quot;);
3993       InstanceKlass* next = pv_node-&gt;previous_versions();
3994       pv_node-&gt;link_previous_versions(NULL);   // point next to NULL
3995       last-&gt;link_previous_versions(next);
3996       // Add to the deallocate list after unlinking
3997       loader_data-&gt;add_to_deallocate_list(pv_node);
3998       pv_node = next;
3999       deleted_count++;
4000       version++;
4001       continue;
4002     } else {
4003       log_trace(redefine, class, iklass, purge)(&quot;previous version &quot; INTPTR_FORMAT &quot; is alive&quot;, p2i(pv_node));
4004       assert(pvcp-&gt;pool_holder() != NULL, &quot;Constant pool with no holder&quot;);
4005       guarantee (!loader_data-&gt;is_unloading(), &quot;unloaded classes can&#39;t be on the stack&quot;);
4006       live_count++;
4007       // found a previous version for next time we do class unloading
4008       _has_previous_versions = true;
4009     }
4010 
4011     // At least one method is live in this previous version.
4012     // Reset dead EMCP methods not to get breakpoints.
4013     // All methods are deallocated when all of the methods for this class are no
4014     // longer running.
4015     Array&lt;Method*&gt;* method_refs = pv_node-&gt;methods();
4016     if (method_refs != NULL) {
4017       log_trace(redefine, class, iklass, purge)(&quot;previous methods length=%d&quot;, method_refs-&gt;length());
4018       for (int j = 0; j &lt; method_refs-&gt;length(); j++) {
4019         Method* method = method_refs-&gt;at(j);
4020 
4021         if (!method-&gt;on_stack()) {
4022           // no breakpoints for non-running methods
4023           if (method-&gt;is_running_emcp()) {
4024             method-&gt;set_running_emcp(false);
4025           }
4026         } else {
4027           assert (method-&gt;is_obsolete() || method-&gt;is_running_emcp(),
4028                   &quot;emcp method cannot run after emcp bit is cleared&quot;);
4029           log_trace(redefine, class, iklass, purge)
4030             (&quot;purge: %s(%s): prev method @%d in version @%d is alive&quot;,
4031              method-&gt;name()-&gt;as_C_string(), method-&gt;signature()-&gt;as_C_string(), j, version);
4032         }
4033       }
4034     }
4035     // next previous version
4036     last = pv_node;
4037     pv_node = pv_node-&gt;previous_versions();
4038     version++;
4039   }
4040   log_trace(redefine, class, iklass, purge)
4041     (&quot;previous version stats: live=%d, deleted=%d&quot;, live_count, deleted_count);
4042 }
4043 
4044 void InstanceKlass::mark_newly_obsolete_methods(Array&lt;Method*&gt;* old_methods,
4045                                                 int emcp_method_count) {
4046   int obsolete_method_count = old_methods-&gt;length() - emcp_method_count;
4047 
4048   if (emcp_method_count != 0 &amp;&amp; obsolete_method_count != 0 &amp;&amp;
4049       _previous_versions != NULL) {
4050     // We have a mix of obsolete and EMCP methods so we have to
4051     // clear out any matching EMCP method entries the hard way.
4052     int local_count = 0;
4053     for (int i = 0; i &lt; old_methods-&gt;length(); i++) {
4054       Method* old_method = old_methods-&gt;at(i);
4055       if (old_method-&gt;is_obsolete()) {
4056         // only obsolete methods are interesting
4057         Symbol* m_name = old_method-&gt;name();
4058         Symbol* m_signature = old_method-&gt;signature();
4059 
4060         // previous versions are linked together through the InstanceKlass
4061         int j = 0;
4062         for (InstanceKlass* prev_version = _previous_versions;
4063              prev_version != NULL;
4064              prev_version = prev_version-&gt;previous_versions(), j++) {
4065 
4066           Array&lt;Method*&gt;* method_refs = prev_version-&gt;methods();
4067           for (int k = 0; k &lt; method_refs-&gt;length(); k++) {
4068             Method* method = method_refs-&gt;at(k);
4069 
4070             if (!method-&gt;is_obsolete() &amp;&amp;
4071                 method-&gt;name() == m_name &amp;&amp;
4072                 method-&gt;signature() == m_signature) {
4073               // The current RedefineClasses() call has made all EMCP
4074               // versions of this method obsolete so mark it as obsolete
4075               log_trace(redefine, class, iklass, add)
4076                 (&quot;%s(%s): flush obsolete method @%d in version @%d&quot;,
4077                  m_name-&gt;as_C_string(), m_signature-&gt;as_C_string(), k, j);
4078 
4079               method-&gt;set_is_obsolete();
4080               break;
4081             }
4082           }
4083 
4084           // The previous loop may not find a matching EMCP method, but
4085           // that doesn&#39;t mean that we can optimize and not go any
4086           // further back in the PreviousVersion generations. The EMCP
4087           // method for this generation could have already been made obsolete,
4088           // but there still may be an older EMCP method that has not
4089           // been made obsolete.
4090         }
4091 
4092         if (++local_count &gt;= obsolete_method_count) {
4093           // no more obsolete methods so bail out now
4094           break;
4095         }
4096       }
4097     }
4098   }
4099 }
4100 
4101 // Save the scratch_class as the previous version if any of the methods are running.
4102 // The previous_versions are used to set breakpoints in EMCP methods and they are
4103 // also used to clean MethodData links to redefined methods that are no longer running.
4104 void InstanceKlass::add_previous_version(InstanceKlass* scratch_class,
4105                                          int emcp_method_count) {
4106   assert(Thread::current()-&gt;is_VM_thread(),
4107          &quot;only VMThread can add previous versions&quot;);
4108 
4109   ResourceMark rm;
4110   log_trace(redefine, class, iklass, add)
4111     (&quot;adding previous version ref for %s, EMCP_cnt=%d&quot;, scratch_class-&gt;external_name(), emcp_method_count);
4112 
4113   // Clean out old previous versions for this class
4114   purge_previous_version_list();
4115 
4116   // Mark newly obsolete methods in remaining previous versions.  An EMCP method from
4117   // a previous redefinition may be made obsolete by this redefinition.
4118   Array&lt;Method*&gt;* old_methods = scratch_class-&gt;methods();
4119   mark_newly_obsolete_methods(old_methods, emcp_method_count);
4120 
4121   // If the constant pool for this previous version of the class
4122   // is not marked as being on the stack, then none of the methods
4123   // in this previous version of the class are on the stack so
4124   // we don&#39;t need to add this as a previous version.
4125   ConstantPool* cp_ref = scratch_class-&gt;constants();
4126   if (!cp_ref-&gt;on_stack()) {
4127     log_trace(redefine, class, iklass, add)(&quot;scratch class not added; no methods are running&quot;);
4128     // For debugging purposes.
4129     scratch_class-&gt;set_is_scratch_class();
4130     scratch_class-&gt;class_loader_data()-&gt;add_to_deallocate_list(scratch_class);
4131     return;
4132   }
4133 
4134   if (emcp_method_count != 0) {
4135     // At least one method is still running, check for EMCP methods
4136     for (int i = 0; i &lt; old_methods-&gt;length(); i++) {
4137       Method* old_method = old_methods-&gt;at(i);
4138       if (!old_method-&gt;is_obsolete() &amp;&amp; old_method-&gt;on_stack()) {
4139         // if EMCP method (not obsolete) is on the stack, mark as EMCP so that
4140         // we can add breakpoints for it.
4141 
4142         // We set the method-&gt;on_stack bit during safepoints for class redefinition
4143         // and use this bit to set the is_running_emcp bit.
4144         // After the safepoint, the on_stack bit is cleared and the running emcp
4145         // method may exit.   If so, we would set a breakpoint in a method that
4146         // is never reached, but this won&#39;t be noticeable to the programmer.
4147         old_method-&gt;set_running_emcp(true);
4148         log_trace(redefine, class, iklass, add)
4149           (&quot;EMCP method %s is on_stack &quot; INTPTR_FORMAT, old_method-&gt;name_and_sig_as_C_string(), p2i(old_method));
4150       } else if (!old_method-&gt;is_obsolete()) {
4151         log_trace(redefine, class, iklass, add)
4152           (&quot;EMCP method %s is NOT on_stack &quot; INTPTR_FORMAT, old_method-&gt;name_and_sig_as_C_string(), p2i(old_method));
4153       }
4154     }
4155   }
4156 
4157   // Add previous version if any methods are still running.
4158   // Set has_previous_version flag for processing during class unloading.
4159   _has_previous_versions = true;
4160   log_trace(redefine, class, iklass, add) (&quot;scratch class added; one of its methods is on_stack.&quot;);
4161   assert(scratch_class-&gt;previous_versions() == NULL, &quot;shouldn&#39;t have a previous version&quot;);
4162   scratch_class-&gt;link_previous_versions(previous_versions());
4163   link_previous_versions(scratch_class);
4164 } // end add_previous_version()
4165 
4166 #endif // INCLUDE_JVMTI
4167 
4168 Method* InstanceKlass::method_with_idnum(int idnum) {
4169   Method* m = NULL;
4170   if (idnum &lt; methods()-&gt;length()) {
4171     m = methods()-&gt;at(idnum);
4172   }
4173   if (m == NULL || m-&gt;method_idnum() != idnum) {
4174     for (int index = 0; index &lt; methods()-&gt;length(); ++index) {
4175       m = methods()-&gt;at(index);
4176       if (m-&gt;method_idnum() == idnum) {
4177         return m;
4178       }
4179     }
4180     // None found, return null for the caller to handle.
4181     return NULL;
4182   }
4183   return m;
4184 }
4185 
4186 
4187 Method* InstanceKlass::method_with_orig_idnum(int idnum) {
4188   if (idnum &gt;= methods()-&gt;length()) {
4189     return NULL;
4190   }
4191   Method* m = methods()-&gt;at(idnum);
4192   if (m != NULL &amp;&amp; m-&gt;orig_method_idnum() == idnum) {
4193     return m;
4194   }
4195   // Obsolete method idnum does not match the original idnum
4196   for (int index = 0; index &lt; methods()-&gt;length(); ++index) {
4197     m = methods()-&gt;at(index);
4198     if (m-&gt;orig_method_idnum() == idnum) {
4199       return m;
4200     }
4201   }
4202   // None found, return null for the caller to handle.
4203   return NULL;
4204 }
4205 
4206 
4207 Method* InstanceKlass::method_with_orig_idnum(int idnum, int version) {
4208   InstanceKlass* holder = get_klass_version(version);
4209   if (holder == NULL) {
4210     return NULL; // The version of klass is gone, no method is found
4211   }
4212   Method* method = holder-&gt;method_with_orig_idnum(idnum);
4213   return method;
4214 }
4215 
4216 #if INCLUDE_JVMTI
4217 JvmtiCachedClassFileData* InstanceKlass::get_cached_class_file() {
4218   return _cached_class_file;
4219 }
4220 
4221 jint InstanceKlass::get_cached_class_file_len() {
4222   return VM_RedefineClasses::get_cached_class_file_len(_cached_class_file);
4223 }
4224 
4225 unsigned char * InstanceKlass::get_cached_class_file_bytes() {
4226   return VM_RedefineClasses::get_cached_class_file_bytes(_cached_class_file);
4227 }
4228 #endif
4229 
4230 #define THROW_DVT_ERROR(s) \
4231   Exceptions::fthrow(THREAD_AND_LOCATION, vmSymbols::java_lang_IncompatibleClassChangeError(), \
4232       &quot;ValueCapableClass class &#39;%s&#39; %s&quot;, external_name(),(s)); \
4233       return
<a name="13" id="anc13"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="13" type="hidden" />
</body>
</html>