<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/hotspot/share/oops/instanceKlass.cpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
  </head>
<body>
<center><a href="arrayKlass.cpp.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="instanceKlass.hpp.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/hotspot/share/oops/instanceKlass.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 790 }
 791 
 792 void InstanceKlass::link_class(TRAPS) {
 793   assert(is_loaded(), &quot;must be loaded&quot;);
 794   if (!is_linked()) {
 795     link_class_impl(CHECK);
 796   }
 797 }
 798 
 799 // Called to verify that a class can link during initialization, without
 800 // throwing a VerifyError.
 801 bool InstanceKlass::link_class_or_fail(TRAPS) {
 802   assert(is_loaded(), &quot;must be loaded&quot;);
 803   if (!is_linked()) {
 804     link_class_impl(CHECK_false);
 805   }
 806   return is_linked();
 807 }
 808 
 809 bool InstanceKlass::link_class_impl(TRAPS) {
<span class="line-modified"> 810   if (DumpSharedSpaces &amp;&amp; is_in_error_state()) {</span>
 811     // This is for CDS dumping phase only -- we use the in_error_state to indicate that
 812     // the class has failed verification. Throwing the NoClassDefFoundError here is just
 813     // a convenient way to stop repeat attempts to verify the same (bad) class.
 814     //
 815     // Note that the NoClassDefFoundError is not part of the JLS, and should not be thrown
 816     // if we are executing Java code. This is not a problem for CDS dumping phase since
 817     // it doesn&#39;t execute any Java code.
 818     ResourceMark rm(THREAD);
 819     Exceptions::fthrow(THREAD_AND_LOCATION,
 820                        vmSymbols::java_lang_NoClassDefFoundError(),
 821                        &quot;Class %s, or one of its supertypes, failed class initialization&quot;,
 822                        external_name());
 823     return false;
 824   }
 825   // return if already verified
 826   if (is_linked()) {
 827     return true;
 828   }
 829 
 830   // Timing
</pre>
<hr />
<pre>
1270   Klass* k = implementor();
1271   if (k == NULL) {
1272     return 0;
1273   } else if (k != this) {
1274     return 1;
1275   } else {
1276     return 2;
1277   }
1278 }
1279 
1280 // The embedded _implementor field can only record one implementor.
1281 // When there are more than one implementors, the _implementor field
1282 // is set to the interface Klass* itself. Following are the possible
1283 // values for the _implementor field:
1284 //   NULL                  - no implementor
1285 //   implementor Klass*    - one implementor
1286 //   self                  - more than one implementor
1287 //
1288 // The _implementor field only exists for interfaces.
1289 void InstanceKlass::add_implementor(Klass* k) {
<span class="line-modified">1290   assert_lock_strong(Compile_lock);</span>


1291   assert(is_interface(), &quot;not interface&quot;);
1292   // Filter out my subinterfaces.
1293   // (Note: Interfaces are never on the subklass list.)
1294   if (InstanceKlass::cast(k)-&gt;is_interface()) return;
1295 
1296   // Filter out subclasses whose supers already implement me.
1297   // (Note: CHA must walk subclasses of direct implementors
1298   // in order to locate indirect implementors.)
1299   Klass* sk = k-&gt;super();
1300   if (sk != NULL &amp;&amp; InstanceKlass::cast(sk)-&gt;implements_interface(this))
1301     // We only need to check one immediate superclass, since the
1302     // implements_interface query looks at transitive_interfaces.
1303     // Any supers of the super have the same (or fewer) transitive_interfaces.
1304     return;
1305 
1306   Klass* ik = implementor();
1307   if (ik == NULL) {
1308     set_implementor(k);
1309   } else if (ik != this &amp;&amp; ik != k) {
1310     // There is already an implementor. Use itself as an indicator of
</pre>
<hr />
<pre>
2491 
2492     for (int i = 0; i &lt; nof_interfaces; i ++, ioe ++) {
2493       if (ioe-&gt;interface_klass() != NULL) {
2494         it-&gt;push(ioe-&gt;interface_klass_addr());
2495         itableMethodEntry* ime = ioe-&gt;first_method_entry(this);
2496         int n = klassItable::method_count_for_interface(ioe-&gt;interface_klass());
2497         for (int index = 0; index &lt; n; index ++) {
2498           it-&gt;push(ime[index].method_addr());
2499         }
2500       }
2501     }
2502   }
2503 
2504   it-&gt;push(&amp;_nest_members);
2505   it-&gt;push(&amp;_record_components);
2506 }
2507 
2508 void InstanceKlass::remove_unshareable_info() {
2509   Klass::remove_unshareable_info();
2510 
<span class="line-modified">2511   if (is_in_error_state()) {</span>
2512     // Classes are attempted to link during dumping and may fail,
2513     // but these classes are still in the dictionary and class list in CLD.
<span class="line-modified">2514     // Check in_error state first because in_error is &gt; linked state, so</span>
<span class="line-removed">2515     // is_linked() is true.</span>
<span class="line-removed">2516     // If there&#39;s a linking error, there is nothing else to remove.</span>
2517     return;
2518   }
2519 
2520   // Reset to the &#39;allocated&#39; state to prevent any premature accessing to
2521   // a shared class at runtime while the class is still being loaded and
2522   // restored. A class&#39; init_state is set to &#39;loaded&#39; at runtime when it&#39;s
2523   // being added to class hierarchy (see SystemDictionary:::add_to_hierarchy()).
2524   _init_state = allocated;
2525 
2526   { // Otherwise this needs to take out the Compile_lock.
2527     assert(SafepointSynchronize::is_at_safepoint(), &quot;only called at safepoint&quot;);
2528     init_implementor();
2529   }
2530 
2531   constants()-&gt;remove_unshareable_info();
2532 
2533   for (int i = 0; i &lt; methods()-&gt;length(); i++) {
2534     Method* m = methods()-&gt;at(i);
2535     m-&gt;remove_unshareable_info();
2536   }
</pre>
<hr />
<pre>
2595     // It also redefines the itable too so fix that too.
2596     vtable().initialize_vtable(false, CHECK);
2597     itable().initialize_itable(false, CHECK);
2598   }
2599 
2600   // restore constant pool resolved references
2601   constants()-&gt;restore_unshareable_info(CHECK);
2602 
2603   if (array_klasses() != NULL) {
2604     // Array classes have null protection domain.
2605     // --&gt; see ArrayKlass::complete_create_array_klass()
2606     array_klasses()-&gt;restore_unshareable_info(ClassLoaderData::the_null_class_loader_data(), Handle(), CHECK);
2607   }
2608 
2609   // Initialize current biased locking state.
2610   if (UseBiasedLocking &amp;&amp; BiasedLocking::enabled() &amp;&amp; !is_value()) {
2611     set_prototype_header(markWord::biased_locking_prototype());
2612   }
2613 }
2614 
<span class="line-modified">2615 // returns true IFF is_in_error_state() has been changed as a result of this call.</span>
<span class="line-removed">2616 bool InstanceKlass::check_sharing_error_state() {</span>
<span class="line-removed">2617   assert(DumpSharedSpaces, &quot;should only be called during dumping&quot;);</span>
<span class="line-removed">2618   bool old_state = is_in_error_state();</span>
<span class="line-removed">2619 </span>
<span class="line-removed">2620   if (!is_in_error_state()) {</span>
<span class="line-removed">2621     bool bad = false;</span>
<span class="line-removed">2622     for (InstanceKlass* sup = java_super(); sup; sup = sup-&gt;java_super()) {</span>
<span class="line-removed">2623       if (sup-&gt;is_in_error_state()) {</span>
<span class="line-removed">2624         bad = true;</span>
<span class="line-removed">2625         break;</span>
<span class="line-removed">2626       }</span>
<span class="line-removed">2627     }</span>
<span class="line-removed">2628     if (!bad) {</span>
<span class="line-removed">2629       Array&lt;InstanceKlass*&gt;* interfaces = transitive_interfaces();</span>
<span class="line-removed">2630       for (int i = 0; i &lt; interfaces-&gt;length(); i++) {</span>
<span class="line-removed">2631         InstanceKlass* iface = interfaces-&gt;at(i);</span>
<span class="line-removed">2632         if (iface-&gt;is_in_error_state()) {</span>
<span class="line-removed">2633           bad = true;</span>
<span class="line-removed">2634           break;</span>
<span class="line-removed">2635         }</span>
<span class="line-removed">2636       }</span>
<span class="line-removed">2637     }</span>
<span class="line-removed">2638 </span>
<span class="line-removed">2639     if (bad) {</span>
<span class="line-removed">2640       set_in_error_state();</span>
<span class="line-removed">2641     }</span>
<span class="line-removed">2642   }</span>
<span class="line-removed">2643 </span>
<span class="line-removed">2644   return (old_state != is_in_error_state());</span>
<span class="line-removed">2645 }</span>
<span class="line-removed">2646 </span>
<span class="line-removed">2647 void InstanceKlass::set_class_loader_type(s2 loader_type) {</span>
2648   switch (loader_type) {
2649   case ClassLoader::BOOT_LOADER:
2650     _misc_flags |= _misc_is_shared_boot_class;
2651     break;
2652   case ClassLoader::PLATFORM_LOADER:
2653     _misc_flags |= _misc_is_shared_platform_class;
2654     break;
2655   case ClassLoader::APP_LOADER:
2656     _misc_flags |= _misc_is_shared_app_class;
2657     break;
2658   default:
2659     ShouldNotReachHere();
2660     break;
2661   }
2662 }
2663 
2664 #if INCLUDE_JVMTI
2665 static void clear_all_breakpoints(Method* m) {
2666   m-&gt;clear_all_breakpoints();
2667 }
</pre>
<hr />
<pre>
2809   // Add L or Q as type indicator
2810   int dest_index = 0;
2811   dest[dest_index++] = c;
2812 
2813   // Add the actual class name
2814   for (int src_index = 0; src_index &lt; src_length; ) {
2815     dest[dest_index++] = src[src_index++];
2816   }
2817 
2818   // If we have a hash, append it
2819   for (int hash_index = 0; hash_index &lt; hash_len; ) {
2820     dest[dest_index++] = hash_buf[hash_index++];
2821   }
2822 
2823   // Add the semicolon and the NULL
2824   dest[dest_index++] = JVM_SIGNATURE_ENDCLASS;
2825   dest[dest_index] = &#39;\0&#39;;
2826   return dest;
2827 }
2828 
<span class="line-removed">2829 // Used to obtain the package name from a fully qualified class name.</span>
<span class="line-removed">2830 Symbol* InstanceKlass::package_from_name(const Symbol* name, TRAPS) {</span>
<span class="line-removed">2831   if (name == NULL) {</span>
<span class="line-removed">2832     return NULL;</span>
<span class="line-removed">2833   } else {</span>
<span class="line-removed">2834     if (name-&gt;utf8_length() &lt;= 0) {</span>
<span class="line-removed">2835       return NULL;</span>
<span class="line-removed">2836     }</span>
<span class="line-removed">2837     ResourceMark rm(THREAD);</span>
<span class="line-removed">2838     const char* package_name = ClassLoader::package_from_name((const char*) name-&gt;as_C_string());</span>
<span class="line-removed">2839     if (package_name == NULL) {</span>
<span class="line-removed">2840       return NULL;</span>
<span class="line-removed">2841     }</span>
<span class="line-removed">2842     Symbol* pkg_name = SymbolTable::new_symbol(package_name);</span>
<span class="line-removed">2843     return pkg_name;</span>
<span class="line-removed">2844   }</span>
<span class="line-removed">2845 }</span>
<span class="line-removed">2846 </span>
2847 ModuleEntry* InstanceKlass::module() const {
2848   // For an unsafe anonymous class return the host class&#39; module
2849   if (is_unsafe_anonymous()) {
2850     assert(unsafe_anonymous_host() != NULL, &quot;unsafe anonymous class must have a host class&quot;);
2851     return unsafe_anonymous_host()-&gt;module();
2852   }
2853 
2854   // Class is in a named package
2855   if (!in_unnamed_package()) {
2856     return _package_entry-&gt;module();
2857   }
2858 
2859   // Class is in an unnamed package, return its loader&#39;s unnamed module
2860   return class_loader_data()-&gt;unnamed_module();
2861 }
2862 
2863 void InstanceKlass::set_package(ClassLoaderData* loader_data, TRAPS) {
2864 
2865   // ensure java/ packages only loaded by boot or platform builtin loaders
2866   check_prohibited_package(name(), loader_data, CHECK);
2867 
<span class="line-modified">2868   TempNewSymbol pkg_name = package_from_name(name(), CHECK);</span>
2869 
2870   if (pkg_name != NULL &amp;&amp; loader_data != NULL) {
2871 
2872     // Find in class loader&#39;s package entry table.
2873     _package_entry = loader_data-&gt;packages()-&gt;lookup_only(pkg_name);
2874 
2875     // If the package name is not found in the loader&#39;s package
2876     // entry table, it is an indication that the package has not
2877     // been defined. Consider it defined within the unnamed module.
2878     if (_package_entry == NULL) {
2879       ResourceMark rm(THREAD);
2880 
2881       if (!ModuleEntryTable::javabase_defined()) {
2882         // Before java.base is defined during bootstrapping, define all packages in
2883         // the java.base module.  If a non-java.base package is erroneously placed
2884         // in the java.base module it will be caught later when java.base
2885         // is defined by ModuleEntryTable::verify_javabase_packages check.
2886         assert(ModuleEntryTable::javabase_moduleEntry() != NULL, JAVA_BASE_NAME &quot; module is NULL&quot;);
2887         _package_entry = loader_data-&gt;packages()-&gt;lookup(pkg_name, ModuleEntryTable::javabase_moduleEntry());
2888       } else {
</pre>
<hr />
<pre>
2944   }
2945 
2946   return false;
2947 }
2948 
2949 // return true if this class and other_class are in the same package. Classloader
2950 // and classname information is enough to determine a class&#39;s package
2951 bool InstanceKlass::is_same_class_package(oop other_class_loader,
2952                                           const Symbol* other_class_name) const {
2953   if (class_loader() != other_class_loader) {
2954     return false;
2955   }
2956   if (name()-&gt;fast_compare(other_class_name) == 0) {
2957      return true;
2958   }
2959 
2960   {
2961     ResourceMark rm;
2962 
2963     bool bad_class_name = false;
<span class="line-modified">2964     const char* other_pkg =</span>
<span class="line-removed">2965       ClassLoader::package_from_name((const char*) other_class_name-&gt;as_C_string(), &amp;bad_class_name);</span>
2966     if (bad_class_name) {
2967       return false;
2968     }
<span class="line-modified">2969     // Check that package_from_name() returns NULL, not &quot;&quot;, if there is no package.</span>
<span class="line-modified">2970     assert(other_pkg == NULL || strlen(other_pkg) &gt; 0, &quot;package name is empty string&quot;);</span>
2971 
2972     const Symbol* const this_package_name =
2973       this-&gt;package() != NULL ? this-&gt;package()-&gt;name() : NULL;
2974 
2975     if (this_package_name == NULL || other_pkg == NULL) {
2976       // One of the two doesn&#39;t have a package.  Only return true if the other
2977       // one also doesn&#39;t have a package.
<span class="line-modified">2978       return (const char*)this_package_name == other_pkg;</span>
2979     }
2980 
2981     // Check if package is identical
<span class="line-modified">2982     return this_package_name-&gt;equals(other_pkg);</span>
2983   }
2984 }
2985 
2986 // Returns true iff super_method can be overridden by a method in targetclassname
2987 // See JLS 3rd edition 8.4.6.1
2988 // Assumes name-signature match
2989 // &quot;this&quot; is InstanceKlass of super_method which must exist
2990 // note that the InstanceKlass of the method in the targetclassname has not always been created yet
2991 bool InstanceKlass::is_override(const methodHandle&amp; super_method, Handle targetclassloader, Symbol* targetclassname, TRAPS) {
2992    // Private methods can not be overridden
2993    if (super_method-&gt;is_private()) {
2994      return false;
2995    }
2996    // If super method is accessible, then override
2997    if ((super_method-&gt;is_protected()) ||
2998        (super_method-&gt;is_public())) {
2999      return true;
3000    }
3001    // Package-private methods are not inherited outside of package
3002    assert(super_method-&gt;is_package_private(), &quot;must be package private&quot;);
3003    return(is_same_class_package(targetclassloader(), targetclassname));
3004 }
3005 
3006 // Only boot and platform class loaders can define classes in &quot;java/&quot; packages.
3007 void InstanceKlass::check_prohibited_package(Symbol* class_name,
3008                                              ClassLoaderData* loader_data,
3009                                              TRAPS) {
3010   if (!loader_data-&gt;is_boot_class_loader_data() &amp;&amp;
3011       !loader_data-&gt;is_platform_class_loader_data() &amp;&amp;
3012       class_name != NULL) {
3013     ResourceMark rm(THREAD);
3014     char* name = class_name-&gt;as_C_string();
3015     if (strncmp(name, JAVAPKG, JAVAPKG_LEN) == 0 &amp;&amp; name[JAVAPKG_LEN] == &#39;/&#39;) {
<span class="line-modified">3016       TempNewSymbol pkg_name = InstanceKlass::package_from_name(class_name, CHECK);</span>
3017       assert(pkg_name != NULL, &quot;Error in parsing package name starting with &#39;java/&#39;&quot;);
3018       name = pkg_name-&gt;as_C_string();
3019       const char* class_loader_name = loader_data-&gt;loader_name_and_id();
3020       StringUtils::replace_no_expand(name, &quot;/&quot;, &quot;.&quot;);
3021       const char* msg_text1 = &quot;Class loader (instance of): &quot;;
3022       const char* msg_text2 = &quot; tried to load prohibited package name: &quot;;
3023       size_t len = strlen(msg_text1) + strlen(class_loader_name) + strlen(msg_text2) + strlen(name) + 1;
3024       char* message = NEW_RESOURCE_ARRAY_IN_THREAD(THREAD, char, len);
3025       jio_snprintf(message, len, &quot;%s%s%s%s&quot;, msg_text1, class_loader_name, msg_text2, name);
3026       THROW_MSG(vmSymbols::java_lang_SecurityException(), message);
3027     }
3028   }
3029   return;
3030 }
3031 
3032 bool InstanceKlass::find_inner_classes_attr(int* ooff, int* noff, TRAPS) const {
3033   constantPoolHandle i_cp(THREAD, constants());
3034   for (InnerClassesIterator iter(this); !iter.done(); iter.next()) {
3035     int ioff = iter.inner_class_info_index();
3036     if (ioff != 0) {
</pre>
</td>
<td>
<hr />
<pre>
 790 }
 791 
 792 void InstanceKlass::link_class(TRAPS) {
 793   assert(is_loaded(), &quot;must be loaded&quot;);
 794   if (!is_linked()) {
 795     link_class_impl(CHECK);
 796   }
 797 }
 798 
 799 // Called to verify that a class can link during initialization, without
 800 // throwing a VerifyError.
 801 bool InstanceKlass::link_class_or_fail(TRAPS) {
 802   assert(is_loaded(), &quot;must be loaded&quot;);
 803   if (!is_linked()) {
 804     link_class_impl(CHECK_false);
 805   }
 806   return is_linked();
 807 }
 808 
 809 bool InstanceKlass::link_class_impl(TRAPS) {
<span class="line-modified"> 810   if (DumpSharedSpaces &amp;&amp; SystemDictionaryShared::has_class_failed_verification(this)) {</span>
 811     // This is for CDS dumping phase only -- we use the in_error_state to indicate that
 812     // the class has failed verification. Throwing the NoClassDefFoundError here is just
 813     // a convenient way to stop repeat attempts to verify the same (bad) class.
 814     //
 815     // Note that the NoClassDefFoundError is not part of the JLS, and should not be thrown
 816     // if we are executing Java code. This is not a problem for CDS dumping phase since
 817     // it doesn&#39;t execute any Java code.
 818     ResourceMark rm(THREAD);
 819     Exceptions::fthrow(THREAD_AND_LOCATION,
 820                        vmSymbols::java_lang_NoClassDefFoundError(),
 821                        &quot;Class %s, or one of its supertypes, failed class initialization&quot;,
 822                        external_name());
 823     return false;
 824   }
 825   // return if already verified
 826   if (is_linked()) {
 827     return true;
 828   }
 829 
 830   // Timing
</pre>
<hr />
<pre>
1270   Klass* k = implementor();
1271   if (k == NULL) {
1272     return 0;
1273   } else if (k != this) {
1274     return 1;
1275   } else {
1276     return 2;
1277   }
1278 }
1279 
1280 // The embedded _implementor field can only record one implementor.
1281 // When there are more than one implementors, the _implementor field
1282 // is set to the interface Klass* itself. Following are the possible
1283 // values for the _implementor field:
1284 //   NULL                  - no implementor
1285 //   implementor Klass*    - one implementor
1286 //   self                  - more than one implementor
1287 //
1288 // The _implementor field only exists for interfaces.
1289 void InstanceKlass::add_implementor(Klass* k) {
<span class="line-modified">1290   if (Universe::is_fully_initialized()) {</span>
<span class="line-added">1291     assert_lock_strong(Compile_lock);</span>
<span class="line-added">1292   }</span>
1293   assert(is_interface(), &quot;not interface&quot;);
1294   // Filter out my subinterfaces.
1295   // (Note: Interfaces are never on the subklass list.)
1296   if (InstanceKlass::cast(k)-&gt;is_interface()) return;
1297 
1298   // Filter out subclasses whose supers already implement me.
1299   // (Note: CHA must walk subclasses of direct implementors
1300   // in order to locate indirect implementors.)
1301   Klass* sk = k-&gt;super();
1302   if (sk != NULL &amp;&amp; InstanceKlass::cast(sk)-&gt;implements_interface(this))
1303     // We only need to check one immediate superclass, since the
1304     // implements_interface query looks at transitive_interfaces.
1305     // Any supers of the super have the same (or fewer) transitive_interfaces.
1306     return;
1307 
1308   Klass* ik = implementor();
1309   if (ik == NULL) {
1310     set_implementor(k);
1311   } else if (ik != this &amp;&amp; ik != k) {
1312     // There is already an implementor. Use itself as an indicator of
</pre>
<hr />
<pre>
2493 
2494     for (int i = 0; i &lt; nof_interfaces; i ++, ioe ++) {
2495       if (ioe-&gt;interface_klass() != NULL) {
2496         it-&gt;push(ioe-&gt;interface_klass_addr());
2497         itableMethodEntry* ime = ioe-&gt;first_method_entry(this);
2498         int n = klassItable::method_count_for_interface(ioe-&gt;interface_klass());
2499         for (int index = 0; index &lt; n; index ++) {
2500           it-&gt;push(ime[index].method_addr());
2501         }
2502       }
2503     }
2504   }
2505 
2506   it-&gt;push(&amp;_nest_members);
2507   it-&gt;push(&amp;_record_components);
2508 }
2509 
2510 void InstanceKlass::remove_unshareable_info() {
2511   Klass::remove_unshareable_info();
2512 
<span class="line-modified">2513   if (SystemDictionaryShared::has_class_failed_verification(this)) {</span>
2514     // Classes are attempted to link during dumping and may fail,
2515     // but these classes are still in the dictionary and class list in CLD.
<span class="line-modified">2516     // If the class has failed verification, there is nothing else to remove.</span>


2517     return;
2518   }
2519 
2520   // Reset to the &#39;allocated&#39; state to prevent any premature accessing to
2521   // a shared class at runtime while the class is still being loaded and
2522   // restored. A class&#39; init_state is set to &#39;loaded&#39; at runtime when it&#39;s
2523   // being added to class hierarchy (see SystemDictionary:::add_to_hierarchy()).
2524   _init_state = allocated;
2525 
2526   { // Otherwise this needs to take out the Compile_lock.
2527     assert(SafepointSynchronize::is_at_safepoint(), &quot;only called at safepoint&quot;);
2528     init_implementor();
2529   }
2530 
2531   constants()-&gt;remove_unshareable_info();
2532 
2533   for (int i = 0; i &lt; methods()-&gt;length(); i++) {
2534     Method* m = methods()-&gt;at(i);
2535     m-&gt;remove_unshareable_info();
2536   }
</pre>
<hr />
<pre>
2595     // It also redefines the itable too so fix that too.
2596     vtable().initialize_vtable(false, CHECK);
2597     itable().initialize_itable(false, CHECK);
2598   }
2599 
2600   // restore constant pool resolved references
2601   constants()-&gt;restore_unshareable_info(CHECK);
2602 
2603   if (array_klasses() != NULL) {
2604     // Array classes have null protection domain.
2605     // --&gt; see ArrayKlass::complete_create_array_klass()
2606     array_klasses()-&gt;restore_unshareable_info(ClassLoaderData::the_null_class_loader_data(), Handle(), CHECK);
2607   }
2608 
2609   // Initialize current biased locking state.
2610   if (UseBiasedLocking &amp;&amp; BiasedLocking::enabled() &amp;&amp; !is_value()) {
2611     set_prototype_header(markWord::biased_locking_prototype());
2612   }
2613 }
2614 
<span class="line-modified">2615 void InstanceKlass::set_shared_class_loader_type(s2 loader_type) {</span>
































2616   switch (loader_type) {
2617   case ClassLoader::BOOT_LOADER:
2618     _misc_flags |= _misc_is_shared_boot_class;
2619     break;
2620   case ClassLoader::PLATFORM_LOADER:
2621     _misc_flags |= _misc_is_shared_platform_class;
2622     break;
2623   case ClassLoader::APP_LOADER:
2624     _misc_flags |= _misc_is_shared_app_class;
2625     break;
2626   default:
2627     ShouldNotReachHere();
2628     break;
2629   }
2630 }
2631 
2632 #if INCLUDE_JVMTI
2633 static void clear_all_breakpoints(Method* m) {
2634   m-&gt;clear_all_breakpoints();
2635 }
</pre>
<hr />
<pre>
2777   // Add L or Q as type indicator
2778   int dest_index = 0;
2779   dest[dest_index++] = c;
2780 
2781   // Add the actual class name
2782   for (int src_index = 0; src_index &lt; src_length; ) {
2783     dest[dest_index++] = src[src_index++];
2784   }
2785 
2786   // If we have a hash, append it
2787   for (int hash_index = 0; hash_index &lt; hash_len; ) {
2788     dest[dest_index++] = hash_buf[hash_index++];
2789   }
2790 
2791   // Add the semicolon and the NULL
2792   dest[dest_index++] = JVM_SIGNATURE_ENDCLASS;
2793   dest[dest_index] = &#39;\0&#39;;
2794   return dest;
2795 }
2796 


















2797 ModuleEntry* InstanceKlass::module() const {
2798   // For an unsafe anonymous class return the host class&#39; module
2799   if (is_unsafe_anonymous()) {
2800     assert(unsafe_anonymous_host() != NULL, &quot;unsafe anonymous class must have a host class&quot;);
2801     return unsafe_anonymous_host()-&gt;module();
2802   }
2803 
2804   // Class is in a named package
2805   if (!in_unnamed_package()) {
2806     return _package_entry-&gt;module();
2807   }
2808 
2809   // Class is in an unnamed package, return its loader&#39;s unnamed module
2810   return class_loader_data()-&gt;unnamed_module();
2811 }
2812 
2813 void InstanceKlass::set_package(ClassLoaderData* loader_data, TRAPS) {
2814 
2815   // ensure java/ packages only loaded by boot or platform builtin loaders
2816   check_prohibited_package(name(), loader_data, CHECK);
2817 
<span class="line-modified">2818   TempNewSymbol pkg_name = ClassLoader::package_from_class_name(name());</span>
2819 
2820   if (pkg_name != NULL &amp;&amp; loader_data != NULL) {
2821 
2822     // Find in class loader&#39;s package entry table.
2823     _package_entry = loader_data-&gt;packages()-&gt;lookup_only(pkg_name);
2824 
2825     // If the package name is not found in the loader&#39;s package
2826     // entry table, it is an indication that the package has not
2827     // been defined. Consider it defined within the unnamed module.
2828     if (_package_entry == NULL) {
2829       ResourceMark rm(THREAD);
2830 
2831       if (!ModuleEntryTable::javabase_defined()) {
2832         // Before java.base is defined during bootstrapping, define all packages in
2833         // the java.base module.  If a non-java.base package is erroneously placed
2834         // in the java.base module it will be caught later when java.base
2835         // is defined by ModuleEntryTable::verify_javabase_packages check.
2836         assert(ModuleEntryTable::javabase_moduleEntry() != NULL, JAVA_BASE_NAME &quot; module is NULL&quot;);
2837         _package_entry = loader_data-&gt;packages()-&gt;lookup(pkg_name, ModuleEntryTable::javabase_moduleEntry());
2838       } else {
</pre>
<hr />
<pre>
2894   }
2895 
2896   return false;
2897 }
2898 
2899 // return true if this class and other_class are in the same package. Classloader
2900 // and classname information is enough to determine a class&#39;s package
2901 bool InstanceKlass::is_same_class_package(oop other_class_loader,
2902                                           const Symbol* other_class_name) const {
2903   if (class_loader() != other_class_loader) {
2904     return false;
2905   }
2906   if (name()-&gt;fast_compare(other_class_name) == 0) {
2907      return true;
2908   }
2909 
2910   {
2911     ResourceMark rm;
2912 
2913     bool bad_class_name = false;
<span class="line-modified">2914     TempNewSymbol other_pkg = ClassLoader::package_from_class_name(other_class_name, &amp;bad_class_name);</span>

2915     if (bad_class_name) {
2916       return false;
2917     }
<span class="line-modified">2918     // Check that package_from_class_name() returns NULL, not &quot;&quot;, if there is no package.</span>
<span class="line-modified">2919     assert(other_pkg == NULL || other_pkg-&gt;utf8_length() &gt; 0, &quot;package name is empty string&quot;);</span>
2920 
2921     const Symbol* const this_package_name =
2922       this-&gt;package() != NULL ? this-&gt;package()-&gt;name() : NULL;
2923 
2924     if (this_package_name == NULL || other_pkg == NULL) {
2925       // One of the two doesn&#39;t have a package.  Only return true if the other
2926       // one also doesn&#39;t have a package.
<span class="line-modified">2927       return this_package_name == other_pkg;</span>
2928     }
2929 
2930     // Check if package is identical
<span class="line-modified">2931     return this_package_name-&gt;fast_compare(other_pkg) == 0;</span>
2932   }
2933 }
2934 
2935 // Returns true iff super_method can be overridden by a method in targetclassname
2936 // See JLS 3rd edition 8.4.6.1
2937 // Assumes name-signature match
2938 // &quot;this&quot; is InstanceKlass of super_method which must exist
2939 // note that the InstanceKlass of the method in the targetclassname has not always been created yet
2940 bool InstanceKlass::is_override(const methodHandle&amp; super_method, Handle targetclassloader, Symbol* targetclassname, TRAPS) {
2941    // Private methods can not be overridden
2942    if (super_method-&gt;is_private()) {
2943      return false;
2944    }
2945    // If super method is accessible, then override
2946    if ((super_method-&gt;is_protected()) ||
2947        (super_method-&gt;is_public())) {
2948      return true;
2949    }
2950    // Package-private methods are not inherited outside of package
2951    assert(super_method-&gt;is_package_private(), &quot;must be package private&quot;);
2952    return(is_same_class_package(targetclassloader(), targetclassname));
2953 }
2954 
2955 // Only boot and platform class loaders can define classes in &quot;java/&quot; packages.
2956 void InstanceKlass::check_prohibited_package(Symbol* class_name,
2957                                              ClassLoaderData* loader_data,
2958                                              TRAPS) {
2959   if (!loader_data-&gt;is_boot_class_loader_data() &amp;&amp;
2960       !loader_data-&gt;is_platform_class_loader_data() &amp;&amp;
2961       class_name != NULL) {
2962     ResourceMark rm(THREAD);
2963     char* name = class_name-&gt;as_C_string();
2964     if (strncmp(name, JAVAPKG, JAVAPKG_LEN) == 0 &amp;&amp; name[JAVAPKG_LEN] == &#39;/&#39;) {
<span class="line-modified">2965       TempNewSymbol pkg_name = ClassLoader::package_from_class_name(class_name);</span>
2966       assert(pkg_name != NULL, &quot;Error in parsing package name starting with &#39;java/&#39;&quot;);
2967       name = pkg_name-&gt;as_C_string();
2968       const char* class_loader_name = loader_data-&gt;loader_name_and_id();
2969       StringUtils::replace_no_expand(name, &quot;/&quot;, &quot;.&quot;);
2970       const char* msg_text1 = &quot;Class loader (instance of): &quot;;
2971       const char* msg_text2 = &quot; tried to load prohibited package name: &quot;;
2972       size_t len = strlen(msg_text1) + strlen(class_loader_name) + strlen(msg_text2) + strlen(name) + 1;
2973       char* message = NEW_RESOURCE_ARRAY_IN_THREAD(THREAD, char, len);
2974       jio_snprintf(message, len, &quot;%s%s%s%s&quot;, msg_text1, class_loader_name, msg_text2, name);
2975       THROW_MSG(vmSymbols::java_lang_SecurityException(), message);
2976     }
2977   }
2978   return;
2979 }
2980 
2981 bool InstanceKlass::find_inner_classes_attr(int* ooff, int* noff, TRAPS) const {
2982   constantPoolHandle i_cp(THREAD, constants());
2983   for (InnerClassesIterator iter(this); !iter.done(); iter.next()) {
2984     int ioff = iter.inner_class_info_index();
2985     if (ioff != 0) {
</pre>
</td>
</tr>
</table>
<center><a href="arrayKlass.cpp.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="instanceKlass.hpp.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>