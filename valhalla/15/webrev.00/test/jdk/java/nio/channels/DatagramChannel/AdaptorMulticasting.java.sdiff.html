<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff test/jdk/java/nio/channels/DatagramChannel/AdaptorMulticasting.java</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
  </head>
<body>
<center><a href="../../../net/httpclient/whitebox/java.net.http/jdk/internal/net/http/FlowTest.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="../../../security/KeyAgreement/KeyAgreementTest.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>test/jdk/java/nio/channels/DatagramChannel/AdaptorMulticasting.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 26  * @summary Test DatagramChannel socket adaptor as a MulticastSocket
 27  * @library /test/lib
 28  * @build jdk.test.lib.NetworkConfiguration
 29  *        jdk.test.lib.net.IPSupport
 30  * @run main AdaptorMulticasting
 31  * @run main/othervm -Djava.net.preferIPv4Stack=true AdaptorMulticasting
 32  */
 33 
 34 import java.io.IOException;
 35 import java.net.DatagramPacket;
 36 import java.net.InetAddress;
 37 import java.net.InetSocketAddress;
 38 import java.net.MulticastSocket;
 39 import java.net.NetworkInterface;
 40 import java.net.ProtocolFamily;
 41 import java.net.SocketAddress;
 42 import java.net.SocketException;
 43 import java.net.SocketTimeoutException;
 44 import java.net.SocketOption;
 45 import java.nio.channels.DatagramChannel;

 46 import java.util.List;
 47 import java.util.stream.Collectors;
 48 import static java.net.StandardSocketOptions.*;
 49 import static java.net.StandardProtocolFamily.*;
 50 
 51 import jdk.test.lib.NetworkConfiguration;
 52 import jdk.test.lib.net.IPSupport;
 53 
 54 public class AdaptorMulticasting {
 55     static final ProtocolFamily UNSPEC = () -&gt; &quot;UNSPEC&quot;;
 56 
 57     public static void main(String[] args) throws IOException {
 58         IPSupport.throwSkippedExceptionIfNonOperational();
 59 
 60         // IPv4 and IPv6 interfaces that support multicasting
 61         NetworkConfiguration config = NetworkConfiguration.probe();
 62         List&lt;NetworkInterface&gt; ip4MulticastInterfaces = config.ip4MulticastInterfaces()
 63                 .collect(Collectors.toList());
 64         List&lt;NetworkInterface&gt; ip6MulticastInterfaces = config.ip6MulticastInterfaces()
 65                 .collect(Collectors.toList());
</pre>
<hr />
<pre>
410         s.send(p, (byte) 1);
411 
412         // receive message
413         s.setSoTimeout(0);
414         p = new DatagramPacket(new byte[1024], 100);
415         s.receive(p);
416 
417         assertTrue(p.getLength() == message.length);
418         assertTrue(p.getPort() == s.getLocalPort());
419     }
420 
421     /**
422      * Send a datagram to the given multicast group and check that it is not
423      * received.
424      */
425     static void testSendNoReceive(MulticastSocket s, InetAddress group) throws IOException {
426         // outgoing multicast interface needs to be set
427         assertTrue(s.getOption(IP_MULTICAST_IF) != null);
428 
429         SocketAddress target = new InetSocketAddress(group, s.getLocalPort());
<span class="line-modified">430         byte[] message = &quot;hello&quot;.getBytes(&quot;UTF-8&quot;);</span>


431 
432         // send datagram to multicast group
433         DatagramPacket p = new DatagramPacket(message, message.length);
434         p.setSocketAddress(target);
435         s.send(p, (byte) 1);
436 
437         // datagram should not be received
438         s.setSoTimeout(500);
439         p = new DatagramPacket(new byte[1024], 100);
<span class="line-modified">440         try {</span>
<span class="line-modified">441             s.receive(p);</span>
<span class="line-modified">442             assertTrue(false);</span>
<span class="line-modified">443         } catch (SocketTimeoutException expected) { }</span>








444     }
445 
446 
447     static void assertTrue(boolean e) {
448         if (!e) throw new RuntimeException();
449     }
450 
451     interface ThrowableRunnable {
452         void run() throws Exception;
453     }
454 
455     static void assertThrows(Class&lt;?&gt; exceptionClass, ThrowableRunnable task) {
456         try {
457             task.run();
458             throw new RuntimeException(&quot;Exception not thrown&quot;);
459         } catch (Exception e) {
460             if (!exceptionClass.isInstance(e)) {
461                 throw new RuntimeException(&quot;expected: &quot; + exceptionClass + &quot;, actual: &quot; + e);
462             }
463         }
</pre>
</td>
<td>
<hr />
<pre>
 26  * @summary Test DatagramChannel socket adaptor as a MulticastSocket
 27  * @library /test/lib
 28  * @build jdk.test.lib.NetworkConfiguration
 29  *        jdk.test.lib.net.IPSupport
 30  * @run main AdaptorMulticasting
 31  * @run main/othervm -Djava.net.preferIPv4Stack=true AdaptorMulticasting
 32  */
 33 
 34 import java.io.IOException;
 35 import java.net.DatagramPacket;
 36 import java.net.InetAddress;
 37 import java.net.InetSocketAddress;
 38 import java.net.MulticastSocket;
 39 import java.net.NetworkInterface;
 40 import java.net.ProtocolFamily;
 41 import java.net.SocketAddress;
 42 import java.net.SocketException;
 43 import java.net.SocketTimeoutException;
 44 import java.net.SocketOption;
 45 import java.nio.channels.DatagramChannel;
<span class="line-added"> 46 import java.util.Arrays;</span>
 47 import java.util.List;
 48 import java.util.stream.Collectors;
 49 import static java.net.StandardSocketOptions.*;
 50 import static java.net.StandardProtocolFamily.*;
 51 
 52 import jdk.test.lib.NetworkConfiguration;
 53 import jdk.test.lib.net.IPSupport;
 54 
 55 public class AdaptorMulticasting {
 56     static final ProtocolFamily UNSPEC = () -&gt; &quot;UNSPEC&quot;;
 57 
 58     public static void main(String[] args) throws IOException {
 59         IPSupport.throwSkippedExceptionIfNonOperational();
 60 
 61         // IPv4 and IPv6 interfaces that support multicasting
 62         NetworkConfiguration config = NetworkConfiguration.probe();
 63         List&lt;NetworkInterface&gt; ip4MulticastInterfaces = config.ip4MulticastInterfaces()
 64                 .collect(Collectors.toList());
 65         List&lt;NetworkInterface&gt; ip6MulticastInterfaces = config.ip6MulticastInterfaces()
 66                 .collect(Collectors.toList());
</pre>
<hr />
<pre>
411         s.send(p, (byte) 1);
412 
413         // receive message
414         s.setSoTimeout(0);
415         p = new DatagramPacket(new byte[1024], 100);
416         s.receive(p);
417 
418         assertTrue(p.getLength() == message.length);
419         assertTrue(p.getPort() == s.getLocalPort());
420     }
421 
422     /**
423      * Send a datagram to the given multicast group and check that it is not
424      * received.
425      */
426     static void testSendNoReceive(MulticastSocket s, InetAddress group) throws IOException {
427         // outgoing multicast interface needs to be set
428         assertTrue(s.getOption(IP_MULTICAST_IF) != null);
429 
430         SocketAddress target = new InetSocketAddress(group, s.getLocalPort());
<span class="line-modified">431         long nano = System.nanoTime();</span>
<span class="line-added">432         String text = nano + &quot;: hello&quot;;</span>
<span class="line-added">433         byte[] message = text.getBytes(&quot;UTF-8&quot;);</span>
434 
435         // send datagram to multicast group
436         DatagramPacket p = new DatagramPacket(message, message.length);
437         p.setSocketAddress(target);
438         s.send(p, (byte) 1);
439 
440         // datagram should not be received
441         s.setSoTimeout(500);
442         p = new DatagramPacket(new byte[1024], 100);
<span class="line-modified">443         while (true) {</span>
<span class="line-modified">444             try {</span>
<span class="line-modified">445                 s.receive(p);</span>
<span class="line-modified">446                 if (Arrays.equals(p.getData(), p.getOffset(), p.getLength(), message, 0, message.length)) {</span>
<span class="line-added">447                     throw new RuntimeException(&quot;message shouldn&#39;t have been received&quot;);</span>
<span class="line-added">448                 } else {</span>
<span class="line-added">449                     System.out.println(&quot;Received unexpected message from &quot; + p.getSocketAddress());</span>
<span class="line-added">450                 }</span>
<span class="line-added">451             } catch (SocketTimeoutException expected) {</span>
<span class="line-added">452                 break;</span>
<span class="line-added">453             }</span>
<span class="line-added">454         }</span>
455     }
456 
457 
458     static void assertTrue(boolean e) {
459         if (!e) throw new RuntimeException();
460     }
461 
462     interface ThrowableRunnable {
463         void run() throws Exception;
464     }
465 
466     static void assertThrows(Class&lt;?&gt; exceptionClass, ThrowableRunnable task) {
467         try {
468             task.run();
469             throw new RuntimeException(&quot;Exception not thrown&quot;);
470         } catch (Exception e) {
471             if (!exceptionClass.isInstance(e)) {
472                 throw new RuntimeException(&quot;expected: &quot; + exceptionClass + &quot;, actual: &quot; + e);
473             }
474         }
</pre>
</td>
</tr>
</table>
<center><a href="../../../net/httpclient/whitebox/java.net.http/jdk/internal/net/http/FlowTest.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="../../../security/KeyAgreement/KeyAgreementTest.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>