<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff test/jdk/jdk/jfr/api/consumer/streaming/TestCrossProcessStreaming.java</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
  </head>
<body>
<center><a href="../../../../internal/platform/docker/MetricsMemoryTester.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="TestProcess.java.udiff.html" target="_top">next &gt;</a></center>    <h2>test/jdk/jdk/jfr/api/consumer/streaming/TestCrossProcessStreaming.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -1,7 +1,7 @@</span>
  /*
<span class="udiff-line-modified-removed">-  * Copyright (c) 2019, Oracle and/or its affiliates. All rights reserved.</span>
<span class="udiff-line-modified-added">+  * Copyright (c) 2019, 2020, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.  Oracle designates this
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -20,27 +20,28 @@</span>
   *
   * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
   * or visit www.oracle.com if you need additional information or have any
   * questions.
   */
<span class="udiff-line-removed">- </span>
  package jdk.jfr.api.consumer.streaming;
  
  import java.nio.file.Files;
  import java.nio.file.Path;
  import java.nio.file.Paths;
  import java.time.Duration;
  import java.time.Instant;
  import java.util.concurrent.CountDownLatch;
  import java.util.concurrent.TimeUnit;
  import java.util.concurrent.atomic.AtomicInteger;
<span class="udiff-line-added">+ import java.util.concurrent.atomic.AtomicReference;</span>
  
<span class="udiff-line-removed">- import com.sun.tools.attach.VirtualMachine;</span>
  import jdk.jfr.Event;
<span class="udiff-line-added">+ import jdk.jfr.Name;</span>
  import jdk.jfr.Recording;
  import jdk.jfr.consumer.EventStream;
  import jdk.test.lib.Asserts;
<span class="udiff-line-added">+ import jdk.test.lib.jfr.StreamingUtils;</span>
  import jdk.test.lib.process.ProcessTools;
  
  /**
   * @test
   * @summary Test scenario where JFR event producer is in a different process
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -51,150 +52,116 @@</span>
   * @modules jdk.attach
   *          jdk.jfr
   * @run main jdk.jfr.api.consumer.streaming.TestCrossProcessStreaming
   */
  
<span class="udiff-line-added">+ // Test Sequence:</span>
<span class="udiff-line-added">+ // 1. Main starts a child process &quot;Event-Producer&quot;</span>
<span class="udiff-line-added">+ // 2. Producer process produces TestEvent1 (first batch).</span>
<span class="udiff-line-added">+ // 3. Main process consumes the event stream until pre-defined number of events is consumed.</span>
<span class="udiff-line-added">+ // 4. Main process signals to child process to start producing the 2nd batch of events (TestEvent2).</span>
<span class="udiff-line-added">+ // 5. The second batch is produced for pre-defined number of flush intervals.</span>
<span class="udiff-line-added">+ // 6. Once the main process detects the pre-defined number of flush intervals, it signals</span>
<span class="udiff-line-added">+ //    to the producer process to exit.</span>
<span class="udiff-line-added">+ // 7. Producer process communicates the number of events in 2nd batch then exits.</span>
<span class="udiff-line-added">+ // 8. Main process verifies that number of events in 2nd batch arrived as expected, and that</span>
<span class="udiff-line-added">+ //    producer process exited w/o error.</span>
<span class="udiff-line-added">+ //</span>
<span class="udiff-line-added">+ //    The sequence of steps 2-5 ensures that the stream can be consumed simultaneously</span>
<span class="udiff-line-added">+ //    as the producer process is producing events.</span>
  public class TestCrossProcessStreaming {
<span class="udiff-line-modified-removed">-     static String MAIN_STARTED_TOKEN = &quot;MAIN_STARTED&quot;;</span>
<span class="udiff-line-modified-removed">- </span>
<span class="udiff-line-removed">-     public static class TestEvent extends Event {</span>
<span class="udiff-line-modified-added">+     @Name(&quot;Batch1&quot;)</span>
<span class="udiff-line-modified-added">+     public static class TestEvent1 extends Event {</span>
      }
<span class="udiff-line-modified-removed">- </span>
<span class="udiff-line-modified-added">+     @Name(&quot;Batch2&quot;)</span>
<span class="udiff-line-added">+     public static class TestEvent2 extends Event {</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+     @Name(&quot;Result&quot;)</span>
      public static class ResultEvent extends Event {
<span class="udiff-line-modified-removed">-         int nrOfEventsProduced;</span>
<span class="udiff-line-modified-added">+         int batch1Count;</span>
<span class="udiff-line-added">+         int batch2Count;</span>
      }
  
<span class="udiff-line-modified-removed">-     public static class EventProducer {</span>
<span class="udiff-line-modified-removed">-         public static void main(String... args) throws Exception {</span>
<span class="udiff-line-modified-removed">-             CrossProcessSynchronizer sync = new CrossProcessSynchronizer();</span>
<span class="udiff-line-modified-removed">-             log(MAIN_STARTED_TOKEN);</span>
<span class="udiff-line-modified-removed">- </span>
<span class="udiff-line-modified-removed">-             long pid = ProcessHandle.current().pid();</span>
<span class="udiff-line-modified-removed">-             int nrOfEvents = 0;</span>
<span class="udiff-line-modified-removed">-             boolean exitRequested = false;</span>
<span class="udiff-line-modified-removed">-             while (!exitRequested) {</span>
<span class="udiff-line-modified-removed">-                 TestEvent e = new TestEvent();</span>
<span class="udiff-line-modified-removed">-                 e.commit();</span>
<span class="udiff-line-removed">-                 nrOfEvents++;</span>
<span class="udiff-line-removed">-                 if (nrOfEvents % 1000 == 0) {</span>
<span class="udiff-line-removed">-                     Thread.sleep(100);</span>
<span class="udiff-line-removed">-                     exitRequested = CrossProcessSynchronizer.exitRequested(pid);</span>
<span class="udiff-line-removed">-                 }</span>
<span class="udiff-line-removed">-             }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-             ResultEvent re = new ResultEvent();</span>
<span class="udiff-line-removed">-             re.nrOfEventsProduced = nrOfEvents;</span>
<span class="udiff-line-removed">-             re.commit();</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-             log(&quot;Number of TestEvents generated: &quot; + nrOfEvents);</span>
<span class="udiff-line-modified-added">+     public static void main(String... args) throws Exception {</span>
<span class="udiff-line-modified-added">+         Process process = EventProducer.start();</span>
<span class="udiff-line-modified-added">+         Path repo = StreamingUtils.getJfrRepository(process);</span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-modified-added">+         // Consume 1000 events in a first batch</span>
<span class="udiff-line-modified-added">+         CountDownLatch consumed = new CountDownLatch(1000);</span>
<span class="udiff-line-modified-added">+         try (EventStream es = EventStream.openRepository(repo)) {</span>
<span class="udiff-line-modified-added">+             es.onEvent(&quot;Batch1&quot;, e -&gt; consumed.countDown());</span>
<span class="udiff-line-modified-added">+             es.setStartTime(Instant.EPOCH); // read from start</span>
<span class="udiff-line-modified-added">+             es.startAsync();</span>
<span class="udiff-line-modified-added">+             consumed.await();</span>
          }
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- </span>
  
<span class="udiff-line-modified-removed">-     static class CrossProcessSynchronizer {</span>
<span class="udiff-line-removed">-         static void requestExit(long pid) throws Exception {</span>
<span class="udiff-line-removed">-             Files.createFile(file(pid));</span>
<span class="udiff-line-removed">-        }</span>
<span class="udiff-line-modified-added">+         signal(&quot;second-batch&quot;);</span>
  
<span class="udiff-line-modified-removed">-         static boolean exitRequested(long pid) throws Exception {</span>
<span class="udiff-line-modified-removed">-             return Files.exists(file(pid));</span>
<span class="udiff-line-modified-added">+         // Consume events until &#39;exit&#39; signal.</span>
<span class="udiff-line-modified-added">+         AtomicInteger total = new AtomicInteger();</span>
<span class="udiff-line-added">+         AtomicInteger produced = new AtomicInteger(-1);</span>
<span class="udiff-line-added">+         AtomicReference&lt;Exception&gt; exception = new AtomicReference();</span>
<span class="udiff-line-added">+         try (EventStream es = EventStream.openRepository(repo)) {</span>
<span class="udiff-line-added">+             es.onEvent(&quot;Batch2&quot;, e -&gt; {</span>
<span class="udiff-line-added">+                     try {</span>
<span class="udiff-line-added">+                         if (total.incrementAndGet() == 1000)  {</span>
<span class="udiff-line-added">+                             signal(&quot;exit&quot;);</span>
<span class="udiff-line-added">+                         }</span>
<span class="udiff-line-added">+                     } catch (Exception exc) {</span>
<span class="udiff-line-added">+                         exception.set(exc);</span>
<span class="udiff-line-added">+                     }</span>
<span class="udiff-line-added">+             });</span>
<span class="udiff-line-added">+             es.onEvent(&quot;Result&quot;,e -&gt; {</span>
<span class="udiff-line-added">+                 produced.set(e.getInt(&quot;batch2Count&quot;));</span>
<span class="udiff-line-added">+                 es.close();</span>
<span class="udiff-line-added">+             });</span>
<span class="udiff-line-added">+             es.setStartTime(Instant.EPOCH);</span>
<span class="udiff-line-added">+             es.start();</span>
          }
<span class="udiff-line-added">+         process.waitFor();</span>
  
<span class="udiff-line-modified-removed">-         static Path file(long pid) {</span>
<span class="udiff-line-modified-removed">-             return Paths.get(&quot;.&quot;, &quot;exit-requested-&quot; + pid);</span>
<span class="udiff-line-modified-added">+         if (exception.get() != null) {</span>
<span class="udiff-line-modified-added">+             throw exception.get();</span>
          }
<span class="udiff-line-added">+         Asserts.assertEquals(process.exitValue(), 0, &quot;Incorrect exit value&quot;);</span>
<span class="udiff-line-added">+         Asserts.assertEquals(total.get(), produced.get(), &quot;Missing events&quot;);</span>
      }
  
<span class="udiff-line-modified-removed">- </span>
<span class="udiff-line-modified-removed">-     static class ConsumedEvents {</span>
<span class="udiff-line-modified-removed">-         AtomicInteger total = new AtomicInteger(0);</span>
<span class="udiff-line-modified-removed">-         AtomicInteger whileProducerAlive = new AtomicInteger(0);</span>
<span class="udiff-line-modified-removed">-         AtomicInteger produced = new AtomicInteger(-1);</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     public static void main(String... args) throws Exception {</span>
<span class="udiff-line-removed">-         Process p = startProducerProcess(&quot;normal&quot;);</span>
<span class="udiff-line-removed">-         String repo = getJfrRepository(p);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-         ConsumedEvents ce = consumeEvents(p, repo);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-         p.waitFor();</span>
<span class="udiff-line-removed">-         Asserts.assertEquals(p.exitValue(), 0,</span>
<span class="udiff-line-removed">-                              &quot;Process exited abnormally, exitValue = &quot; + p.exitValue());</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-         Asserts.assertEquals(ce.total.get(), ce.produced.get(), &quot;Some events were lost&quot;);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-         // Expected that some portion of events emitted by the producer are delivered</span>
<span class="udiff-line-removed">-         // to the consumer while producer is still alive, at least one event for certain.</span>
<span class="udiff-line-removed">-         // Assertion below is disabled due to: JDK-8235206</span>
<span class="udiff-line-removed">-         // Asserts.assertLTE(1, ce.whileProducerAlive.get(),</span>
<span class="udiff-line-removed">-         //                   &quot;Too few events are delivered while producer is alive&quot;);</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     static Process startProducerProcess(String extraParam) throws Exception {</span>
<span class="udiff-line-removed">-         ProcessBuilder pb =</span>
<span class="udiff-line-removed">-             ProcessTools.createJavaProcessBuilder(false,</span>
<span class="udiff-line-removed">-                                                   &quot;-XX:StartFlightRecording&quot;,</span>
<span class="udiff-line-removed">-                                                   EventProducer.class.getName(),</span>
<span class="udiff-line-removed">-                                                   extraParam);</span>
<span class="udiff-line-removed">-         Process p = ProcessTools.startProcess(&quot;Event-Producer&quot;, pb,</span>
<span class="udiff-line-removed">-                                               line -&gt; line.equals(MAIN_STARTED_TOKEN),</span>
<span class="udiff-line-removed">-                                               0, TimeUnit.SECONDS);</span>
<span class="udiff-line-removed">-         return p;</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     static String getJfrRepository(Process p) throws Exception {</span>
<span class="udiff-line-removed">-         String repo = null;</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-         // It may take little bit of time for the observed process to set the property after</span>
<span class="udiff-line-removed">-         // the process starts, therefore read the property in a loop.</span>
<span class="udiff-line-removed">-         while (repo == null) {</span>
<span class="udiff-line-removed">-             VirtualMachine vm = VirtualMachine.attach(String.valueOf(p.pid()));</span>
<span class="udiff-line-removed">-             repo = vm.getSystemProperties().getProperty(&quot;jdk.jfr.repository&quot;);</span>
<span class="udiff-line-removed">-             vm.detach();</span>
<span class="udiff-line-modified-added">+     static class EventProducer {</span>
<span class="udiff-line-modified-added">+         static Process start() throws Exception {</span>
<span class="udiff-line-modified-added">+             String[] args = {&quot;-XX:StartFlightRecording&quot;, EventProducer.class.getName()};</span>
<span class="udiff-line-modified-added">+             ProcessBuilder pb = ProcessTools.createJavaProcessBuilder(false, args);</span>
<span class="udiff-line-modified-added">+             return ProcessTools.startProcess(&quot;Event-Producer&quot;, pb);</span>
          }
  
<span class="udiff-line-modified-removed">-         log(&quot;JFR repository = &quot; + repo);</span>
<span class="udiff-line-modified-removed">-         return repo;</span>
<span class="udiff-line-modified-removed">-     }</span>
<span class="udiff-line-modified-removed">- </span>
<span class="udiff-line-modified-removed">-     static ConsumedEvents consumeEvents(Process p, String repo) throws Exception {</span>
<span class="udiff-line-modified-removed">-         ConsumedEvents result = new ConsumedEvents();</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-         // wait for couple of JFR stream flushes before concluding the test</span>
<span class="udiff-line-removed">-         CountDownLatch flushed = new CountDownLatch(2);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-         // consume events produced by another process via event stream</span>
<span class="udiff-line-removed">-         try (EventStream es = EventStream.openRepository(Paths.get(repo))) {</span>
<span class="udiff-line-removed">-                 es.onEvent(TestEvent.class.getName(),</span>
<span class="udiff-line-removed">-                            e -&gt; {</span>
<span class="udiff-line-removed">-                                result.total.incrementAndGet();</span>
<span class="udiff-line-removed">-                                if (p.isAlive()) {</span>
<span class="udiff-line-removed">-                                    result.whileProducerAlive.incrementAndGet();</span>
<span class="udiff-line-removed">-                                }</span>
<span class="udiff-line-removed">-                            });</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-                 es.onEvent(ResultEvent.class.getName(),</span>
<span class="udiff-line-removed">-                            e -&gt; result.produced.set(e.getInt(&quot;nrOfEventsProduced&quot;)));</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-                 es.onFlush( () -&gt; flushed.countDown() );</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-                 // Setting start time to the beginning of the Epoch is a good way to start</span>
<span class="udiff-line-removed">-                 // reading the stream from the very beginning.</span>
<span class="udiff-line-removed">-                 es.setStartTime(Instant.EPOCH);</span>
<span class="udiff-line-removed">-                 es.startAsync();</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-                 // await for certain number of flush events before concluding the test case</span>
<span class="udiff-line-removed">-                 flushed.await();</span>
<span class="udiff-line-removed">-                 CrossProcessSynchronizer.requestExit(p.pid());</span>
<span class="udiff-line-modified-added">+         public static void main(String... args) throws Exception {</span>
<span class="udiff-line-modified-added">+             ResultEvent rs = new ResultEvent();</span>
<span class="udiff-line-modified-added">+             rs.batch1Count = emit(TestEvent1.class, &quot;second-batch&quot;);</span>
<span class="udiff-line-modified-added">+             rs.batch2Count = emit(TestEvent2.class, &quot;exit&quot;);</span>
<span class="udiff-line-modified-added">+             rs.commit();</span>
<span class="udiff-line-modified-added">+         }</span>
  
<span class="udiff-line-modified-removed">-                 es.awaitTermination();</span>
<span class="udiff-line-modified-added">+         static int emit(Class&lt;? extends Event&gt; eventClass, String termination) throws Exception {</span>
<span class="udiff-line-added">+             int count = 0;</span>
<span class="udiff-line-added">+             while (true) {</span>
<span class="udiff-line-added">+                 Event event = eventClass.getConstructor().newInstance();</span>
<span class="udiff-line-added">+                 event.commit();</span>
<span class="udiff-line-added">+                 count++;</span>
<span class="udiff-line-added">+                 if (count % 1000 == 0) {</span>
<span class="udiff-line-added">+                     Thread.sleep(100);</span>
<span class="udiff-line-added">+                     if (signalCheck(termination)) {</span>
<span class="udiff-line-added">+                         System.out.println(&quot;Events generated: &quot; + count);</span>
<span class="udiff-line-added">+                         return count;</span>
<span class="udiff-line-added">+                     }</span>
<span class="udiff-line-added">+                 }</span>
              }
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+     }</span>
  
<span class="udiff-line-modified-removed">-         return result;</span>
<span class="udiff-line-modified-added">+     static void signal(String name) throws Exception {</span>
<span class="udiff-line-added">+         Files.createFile(Paths.get(&quot;.&quot;, name));</span>
      }
  
<span class="udiff-line-modified-removed">-     private static final void log(String msg) {</span>
<span class="udiff-line-modified-removed">-         System.out.println(msg);</span>
<span class="udiff-line-modified-added">+     static boolean signalCheck(String name) throws Exception {</span>
<span class="udiff-line-modified-added">+         return Files.exists(Paths.get(&quot;.&quot;, name));</span>
      }
  }
</pre>
<center><a href="../../../../internal/platform/docker/MetricsMemoryTester.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="TestProcess.java.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>