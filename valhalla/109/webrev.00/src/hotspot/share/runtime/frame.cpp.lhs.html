<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames src/hotspot/share/runtime/frame.cpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
    <script type="text/javascript" src="../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>   1 /*
   2  * Copyright (c) 1997, 2020, Oracle and/or its affiliates. All rights reserved.
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.
   8  *
   9  * This code is distributed in the hope that it will be useful, but WITHOUT
  10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  *
  23  */
  24 
  25 #include &quot;precompiled.hpp&quot;
  26 #include &quot;classfile/moduleEntry.hpp&quot;
  27 #include &quot;code/codeCache.hpp&quot;
  28 #include &quot;code/vmreg.inline.hpp&quot;
  29 #include &quot;compiler/abstractCompiler.hpp&quot;
  30 #include &quot;compiler/disassembler.hpp&quot;
  31 #include &quot;gc/shared/collectedHeap.inline.hpp&quot;
  32 #include &quot;interpreter/interpreter.hpp&quot;
  33 #include &quot;interpreter/oopMapCache.hpp&quot;
  34 #include &quot;memory/resourceArea.hpp&quot;
  35 #include &quot;memory/universe.hpp&quot;
  36 #include &quot;oops/markWord.hpp&quot;
  37 #include &quot;oops/method.hpp&quot;
  38 #include &quot;oops/methodData.hpp&quot;
  39 #include &quot;oops/oop.inline.hpp&quot;
<a name="1" id="anc1"></a><span class="line-modified">  40 #include &quot;oops/valueKlass.hpp&quot;</span>
  41 #include &quot;oops/verifyOopClosure.hpp&quot;
  42 #include &quot;prims/methodHandles.hpp&quot;
  43 #include &quot;runtime/frame.inline.hpp&quot;
  44 #include &quot;runtime/handles.inline.hpp&quot;
  45 #include &quot;runtime/javaCalls.hpp&quot;
  46 #include &quot;runtime/monitorChunk.hpp&quot;
  47 #include &quot;runtime/os.hpp&quot;
  48 #include &quot;runtime/sharedRuntime.hpp&quot;
  49 #include &quot;runtime/signature.hpp&quot;
  50 #include &quot;runtime/stubCodeGenerator.hpp&quot;
  51 #include &quot;runtime/stubRoutines.hpp&quot;
  52 #include &quot;runtime/thread.inline.hpp&quot;
  53 #include &quot;utilities/debug.hpp&quot;
  54 #include &quot;utilities/decoder.hpp&quot;
  55 #include &quot;utilities/formatBuffer.hpp&quot;
  56 #ifdef COMPILER1
  57 #include &quot;c1/c1_Runtime1.hpp&quot;
  58 #endif
  59 
  60 RegisterMap::RegisterMap(JavaThread *thread, bool update_map) {
  61   _thread         = thread;
  62   _update_map     = update_map;
  63   clear();
  64   debug_only(_update_for_id = NULL;)
  65 #ifndef PRODUCT
  66   for (int i = 0; i &lt; reg_count ; i++ ) _location[i] = NULL;
  67 #endif /* PRODUCT */
  68 }
  69 
  70 RegisterMap::RegisterMap(const RegisterMap* map) {
  71   assert(map != this, &quot;bad initialization parameter&quot;);
  72   assert(map != NULL, &quot;RegisterMap must be present&quot;);
  73   _thread                = map-&gt;thread();
  74   _update_map            = map-&gt;update_map();
  75   _include_argument_oops = map-&gt;include_argument_oops();
  76   debug_only(_update_for_id = map-&gt;_update_for_id;)
  77   pd_initialize_from(map);
  78   if (update_map()) {
  79     for(int i = 0; i &lt; location_valid_size; i++) {
  80       LocationValidType bits = !update_map() ? 0 : map-&gt;_location_valid[i];
  81       _location_valid[i] = bits;
  82       // for whichever bits are set, pull in the corresponding map-&gt;_location
  83       int j = i*location_valid_type_size;
  84       while (bits != 0) {
  85         if ((bits &amp; 1) != 0) {
  86           assert(0 &lt;= j &amp;&amp; j &lt; reg_count, &quot;range check&quot;);
  87           _location[j] = map-&gt;_location[j];
  88         }
  89         bits &gt;&gt;= 1;
  90         j += 1;
  91       }
  92     }
  93   }
  94 }
  95 
  96 void RegisterMap::clear() {
  97   set_include_argument_oops(true);
  98   if (_update_map) {
  99     for(int i = 0; i &lt; location_valid_size; i++) {
 100       _location_valid[i] = 0;
 101     }
 102     pd_clear();
 103   } else {
 104     pd_initialize();
 105   }
 106 }
 107 
 108 #ifndef PRODUCT
 109 
 110 void RegisterMap::print_on(outputStream* st) const {
 111   st-&gt;print_cr(&quot;Register map&quot;);
 112   for(int i = 0; i &lt; reg_count; i++) {
 113 
 114     VMReg r = VMRegImpl::as_VMReg(i);
 115     intptr_t* src = (intptr_t*) location(r);
 116     if (src != NULL) {
 117 
 118       r-&gt;print_on(st);
 119       st-&gt;print(&quot; [&quot; INTPTR_FORMAT &quot;] = &quot;, p2i(src));
 120       if (((uintptr_t)src &amp; (sizeof(*src)-1)) != 0) {
 121         st-&gt;print_cr(&quot;&lt;misaligned&gt;&quot;);
 122       } else {
 123         st-&gt;print_cr(INTPTR_FORMAT, *src);
 124       }
 125     }
 126   }
 127 }
 128 
 129 void RegisterMap::print() const {
 130   print_on(tty);
 131 }
 132 
 133 #endif
 134 // This returns the pc that if you were in the debugger you&#39;d see. Not
 135 // the idealized value in the frame object. This undoes the magic conversion
 136 // that happens for deoptimized frames. In addition it makes the value the
 137 // hardware would want to see in the native frame. The only user (at this point)
 138 // is deoptimization. It likely no one else should ever use it.
 139 
 140 address frame::raw_pc() const {
 141   if (is_deoptimized_frame()) {
 142     CompiledMethod* cm = cb()-&gt;as_compiled_method_or_null();
 143     if (cm-&gt;is_method_handle_return(pc()))
 144       return cm-&gt;deopt_mh_handler_begin() - pc_return_offset;
 145     else
 146       return cm-&gt;deopt_handler_begin() - pc_return_offset;
 147   } else {
 148     return (pc() - pc_return_offset);
 149   }
 150 }
 151 
 152 // Change the pc in a frame object. This does not change the actual pc in
 153 // actual frame. To do that use patch_pc.
 154 //
 155 void frame::set_pc(address   newpc ) {
 156 #ifdef ASSERT
 157   if (_cb != NULL &amp;&amp; _cb-&gt;is_nmethod()) {
 158     assert(!((nmethod*)_cb)-&gt;is_deopt_pc(_pc), &quot;invariant violation&quot;);
 159   }
 160 #endif // ASSERT
 161 
 162   // Unsafe to use the is_deoptimzed tester after changing pc
 163   _deopt_state = unknown;
 164   _pc = newpc;
 165   _cb = CodeCache::find_blob_unsafe(_pc);
 166 
 167 }
 168 
 169 // type testers
 170 bool frame::is_ignored_frame() const {
 171   return false;  // FIXME: some LambdaForm frames should be ignored
 172 }
 173 bool frame::is_deoptimized_frame() const {
 174   assert(_deopt_state != unknown, &quot;not answerable&quot;);
 175   return _deopt_state == is_deoptimized;
 176 }
 177 
 178 bool frame::is_native_frame() const {
 179   return (_cb != NULL &amp;&amp;
 180           _cb-&gt;is_nmethod() &amp;&amp;
 181           ((nmethod*)_cb)-&gt;is_native_method());
 182 }
 183 
 184 bool frame::is_java_frame() const {
 185   if (is_interpreted_frame()) return true;
 186   if (is_compiled_frame())    return true;
 187   return false;
 188 }
 189 
 190 
 191 bool frame::is_compiled_frame() const {
 192   if (_cb != NULL &amp;&amp;
 193       _cb-&gt;is_compiled() &amp;&amp;
 194       ((CompiledMethod*)_cb)-&gt;is_java_method()) {
 195     return true;
 196   }
 197   return false;
 198 }
 199 
 200 
 201 bool frame::is_runtime_frame() const {
 202   return (_cb != NULL &amp;&amp; _cb-&gt;is_runtime_stub());
 203 }
 204 
 205 bool frame::is_safepoint_blob_frame() const {
 206   return (_cb != NULL &amp;&amp; _cb-&gt;is_safepoint_stub());
 207 }
 208 
 209 // testers
 210 
 211 bool frame::is_first_java_frame() const {
 212   RegisterMap map(JavaThread::current(), false); // No update
 213   frame s;
 214   for (s = sender(&amp;map); !(s.is_java_frame() || s.is_first_frame()); s = s.sender(&amp;map));
 215   return s.is_first_frame();
 216 }
 217 
 218 
 219 bool frame::entry_frame_is_first() const {
 220   return entry_frame_call_wrapper()-&gt;is_first_frame();
 221 }
 222 
 223 JavaCallWrapper* frame::entry_frame_call_wrapper_if_safe(JavaThread* thread) const {
 224   JavaCallWrapper** jcw = entry_frame_call_wrapper_addr();
 225   address addr = (address) jcw;
 226 
 227   // addr must be within the usable part of the stack
 228   if (thread-&gt;is_in_usable_stack(addr)) {
 229     return *jcw;
 230   }
 231 
 232   return NULL;
 233 }
 234 
 235 bool frame::is_entry_frame_valid(JavaThread* thread) const {
 236   // Validate the JavaCallWrapper an entry frame must have
 237   address jcw = (address)entry_frame_call_wrapper();
 238   if (!thread-&gt;is_in_stack_range_excl(jcw, (address)fp())) {
 239     return false;
 240   }
 241 
 242   // Validate sp saved in the java frame anchor
 243   JavaFrameAnchor* jfa = entry_frame_call_wrapper()-&gt;anchor();
 244   return (jfa-&gt;last_Java_sp() &gt; sp());
 245 }
 246 
 247 bool frame::should_be_deoptimized() const {
 248   if (_deopt_state == is_deoptimized ||
 249       !is_compiled_frame() ) return false;
 250   assert(_cb != NULL &amp;&amp; _cb-&gt;is_compiled(), &quot;must be an nmethod&quot;);
 251   CompiledMethod* nm = (CompiledMethod *)_cb;
 252   if (TraceDependencies) {
 253     tty-&gt;print(&quot;checking (%s) &quot;, nm-&gt;is_marked_for_deoptimization() ? &quot;true&quot; : &quot;false&quot;);
 254     nm-&gt;print_value_on(tty);
 255     tty-&gt;cr();
 256   }
 257 
 258   if( !nm-&gt;is_marked_for_deoptimization() )
 259     return false;
 260 
 261   // If at the return point, then the frame has already been popped, and
 262   // only the return needs to be executed. Don&#39;t deoptimize here.
 263   return !nm-&gt;is_at_poll_return(pc());
 264 }
 265 
 266 bool frame::can_be_deoptimized() const {
 267   if (!is_compiled_frame()) return false;
 268   CompiledMethod* nm = (CompiledMethod*)_cb;
 269 
 270   if( !nm-&gt;can_be_deoptimized() )
 271     return false;
 272 
 273   return !nm-&gt;is_at_poll_return(pc());
 274 }
 275 
 276 void frame::deoptimize(JavaThread* thread) {
 277   assert(thread-&gt;frame_anchor()-&gt;has_last_Java_frame() &amp;&amp;
 278          thread-&gt;frame_anchor()-&gt;walkable(), &quot;must be&quot;);
 279   // Schedule deoptimization of an nmethod activation with this frame.
 280   assert(_cb != NULL &amp;&amp; _cb-&gt;is_compiled(), &quot;must be&quot;);
 281 
 282   // If the call site is a MethodHandle call site use the MH deopt
 283   // handler.
 284   CompiledMethod* cm = (CompiledMethod*) _cb;
 285   address deopt = cm-&gt;is_method_handle_return(pc()) ?
 286                         cm-&gt;deopt_mh_handler_begin() :
 287                         cm-&gt;deopt_handler_begin();
 288 
 289   // Save the original pc before we patch in the new one
 290   cm-&gt;set_original_pc(this, pc());
 291 
 292 #ifdef COMPILER1
 293   if (cm-&gt;is_compiled_by_c1() &amp;&amp; cm-&gt;method()-&gt;has_scalarized_args() &amp;&amp;
 294       pc() &lt; cm-&gt;verified_value_entry_point()) {
 295     // The VEP and VVEP(RO) of C1-compiled methods call into the runtime to buffer scalarized value
 296     // type args. We can&#39;t deoptimize at that point because the buffers have not yet been initialized.
 297     // Also, if the method is synchronized, we first need to acquire the lock.
 298     // Don&#39;t patch the return pc to delay deoptimization until we enter the method body (the check
 299     // addedin LIRGenerator::do_Base will detect the pending deoptimization by checking the original_pc).
 300 #ifdef ASSERT
 301     NativeCall* call = nativeCall_before(this-&gt;pc());
 302     address dest = call-&gt;destination();
 303     assert(dest == Runtime1::entry_for(Runtime1::buffer_value_args_no_receiver_id) ||
 304            dest == Runtime1::entry_for(Runtime1::buffer_value_args_id), &quot;unexpected safepoint in entry point&quot;);
 305 #endif
 306     return;
 307   }
 308 #endif
 309 
 310   patch_pc(thread, deopt);
 311 
 312 #ifdef ASSERT
 313   {
 314     RegisterMap map(thread, false);
 315     frame check = thread-&gt;last_frame();
 316     while (id() != check.id()) {
 317       check = check.sender(&amp;map);
 318     }
 319     assert(check.is_deoptimized_frame(), &quot;missed deopt&quot;);
 320   }
 321 #endif // ASSERT
 322 }
 323 
 324 frame frame::java_sender() const {
 325   RegisterMap map(JavaThread::current(), false);
 326   frame s;
 327   for (s = sender(&amp;map); !(s.is_java_frame() || s.is_first_frame()); s = s.sender(&amp;map)) ;
 328   guarantee(s.is_java_frame(), &quot;tried to get caller of first java frame&quot;);
 329   return s;
 330 }
 331 
 332 frame frame::real_sender(RegisterMap* map) const {
 333   frame result = sender(map);
 334   while (result.is_runtime_frame() ||
 335          result.is_ignored_frame()) {
 336     result = result.sender(map);
 337   }
 338   return result;
 339 }
 340 
 341 // Interpreter frames
 342 
 343 
 344 void frame::interpreter_frame_set_locals(intptr_t* locs)  {
 345   assert(is_interpreted_frame(), &quot;Not an interpreted frame&quot;);
 346   *interpreter_frame_locals_addr() = locs;
 347 }
 348 
 349 Method* frame::interpreter_frame_method() const {
 350   assert(is_interpreted_frame(), &quot;interpreted frame expected&quot;);
 351   Method* m = *interpreter_frame_method_addr();
 352   assert(m-&gt;is_method(), &quot;not a Method*&quot;);
 353   return m;
 354 }
 355 
 356 void frame::interpreter_frame_set_method(Method* method) {
 357   assert(is_interpreted_frame(), &quot;interpreted frame expected&quot;);
 358   *interpreter_frame_method_addr() = method;
 359 }
 360 
 361 void frame::interpreter_frame_set_mirror(oop mirror) {
 362   assert(is_interpreted_frame(), &quot;interpreted frame expected&quot;);
 363   *interpreter_frame_mirror_addr() = mirror;
 364 }
 365 
 366 jint frame::interpreter_frame_bci() const {
 367   assert(is_interpreted_frame(), &quot;interpreted frame expected&quot;);
 368   address bcp = interpreter_frame_bcp();
 369   return interpreter_frame_method()-&gt;bci_from(bcp);
 370 }
 371 
 372 address frame::interpreter_frame_bcp() const {
 373   assert(is_interpreted_frame(), &quot;interpreted frame expected&quot;);
 374   address bcp = (address)*interpreter_frame_bcp_addr();
 375   return interpreter_frame_method()-&gt;bcp_from(bcp);
 376 }
 377 
 378 void frame::interpreter_frame_set_bcp(address bcp) {
 379   assert(is_interpreted_frame(), &quot;interpreted frame expected&quot;);
 380   *interpreter_frame_bcp_addr() = (intptr_t)bcp;
 381 }
 382 
 383 address frame::interpreter_frame_mdp() const {
 384   assert(ProfileInterpreter, &quot;must be profiling interpreter&quot;);
 385   assert(is_interpreted_frame(), &quot;interpreted frame expected&quot;);
 386   return (address)*interpreter_frame_mdp_addr();
 387 }
 388 
 389 void frame::interpreter_frame_set_mdp(address mdp) {
 390   assert(is_interpreted_frame(), &quot;interpreted frame expected&quot;);
 391   assert(ProfileInterpreter, &quot;must be profiling interpreter&quot;);
 392   *interpreter_frame_mdp_addr() = (intptr_t)mdp;
 393 }
 394 
 395 BasicObjectLock* frame::next_monitor_in_interpreter_frame(BasicObjectLock* current) const {
 396   assert(is_interpreted_frame(), &quot;Not an interpreted frame&quot;);
 397 #ifdef ASSERT
 398   interpreter_frame_verify_monitor(current);
 399 #endif
 400   BasicObjectLock* next = (BasicObjectLock*) (((intptr_t*) current) + interpreter_frame_monitor_size());
 401   return next;
 402 }
 403 
 404 BasicObjectLock* frame::previous_monitor_in_interpreter_frame(BasicObjectLock* current) const {
 405   assert(is_interpreted_frame(), &quot;Not an interpreted frame&quot;);
 406 #ifdef ASSERT
 407 //   // This verification needs to be checked before being enabled
 408 //   interpreter_frame_verify_monitor(current);
 409 #endif
 410   BasicObjectLock* previous = (BasicObjectLock*) (((intptr_t*) current) - interpreter_frame_monitor_size());
 411   return previous;
 412 }
 413 
 414 // Interpreter locals and expression stack locations.
 415 
 416 intptr_t* frame::interpreter_frame_local_at(int index) const {
 417   const int n = Interpreter::local_offset_in_bytes(index)/wordSize;
 418   return &amp;((*interpreter_frame_locals_addr())[n]);
 419 }
 420 
 421 intptr_t* frame::interpreter_frame_expression_stack_at(jint offset) const {
 422   const int i = offset * interpreter_frame_expression_stack_direction();
 423   const int n = i * Interpreter::stackElementWords;
 424   return &amp;(interpreter_frame_expression_stack()[n]);
 425 }
 426 
 427 jint frame::interpreter_frame_expression_stack_size() const {
 428   // Number of elements on the interpreter expression stack
 429   // Callers should span by stackElementWords
 430   int element_size = Interpreter::stackElementWords;
 431   size_t stack_size = 0;
 432   if (frame::interpreter_frame_expression_stack_direction() &lt; 0) {
 433     stack_size = (interpreter_frame_expression_stack() -
 434                   interpreter_frame_tos_address() + 1)/element_size;
 435   } else {
 436     stack_size = (interpreter_frame_tos_address() -
 437                   interpreter_frame_expression_stack() + 1)/element_size;
 438   }
 439   assert( stack_size &lt;= (size_t)max_jint, &quot;stack size too big&quot;);
 440   return ((jint)stack_size);
 441 }
 442 
 443 
 444 // (frame::interpreter_frame_sender_sp accessor is in frame_&lt;arch&gt;.cpp)
 445 
 446 const char* frame::print_name() const {
 447   if (is_native_frame())      return &quot;Native&quot;;
 448   if (is_interpreted_frame()) return &quot;Interpreted&quot;;
 449   if (is_compiled_frame()) {
 450     if (is_deoptimized_frame()) return &quot;Deoptimized&quot;;
 451     return &quot;Compiled&quot;;
 452   }
 453   if (sp() == NULL)            return &quot;Empty&quot;;
 454   return &quot;C&quot;;
 455 }
 456 
 457 void frame::print_value_on(outputStream* st, JavaThread *thread) const {
 458   NOT_PRODUCT(address begin = pc()-40;)
 459   NOT_PRODUCT(address end   = NULL;)
 460 
 461   st-&gt;print(&quot;%s frame (sp=&quot; INTPTR_FORMAT &quot; unextended sp=&quot; INTPTR_FORMAT, print_name(), p2i(sp()), p2i(unextended_sp()));
 462   if (sp() != NULL)
 463     st-&gt;print(&quot;, fp=&quot; INTPTR_FORMAT &quot;, real_fp=&quot; INTPTR_FORMAT &quot;, pc=&quot; INTPTR_FORMAT,
 464               p2i(fp()), p2i(real_fp()), p2i(pc()));
 465 
 466   if (StubRoutines::contains(pc())) {
 467     st-&gt;print_cr(&quot;)&quot;);
 468     st-&gt;print(&quot;(&quot;);
 469     StubCodeDesc* desc = StubCodeDesc::desc_for(pc());
 470     st-&gt;print(&quot;~Stub::%s&quot;, desc-&gt;name());
 471     NOT_PRODUCT(begin = desc-&gt;begin(); end = desc-&gt;end();)
 472   } else if (Interpreter::contains(pc())) {
 473     st-&gt;print_cr(&quot;)&quot;);
 474     st-&gt;print(&quot;(&quot;);
 475     InterpreterCodelet* desc = Interpreter::codelet_containing(pc());
 476     if (desc != NULL) {
 477       st-&gt;print(&quot;~&quot;);
 478       desc-&gt;print_on(st);
 479       NOT_PRODUCT(begin = desc-&gt;code_begin(); end = desc-&gt;code_end();)
 480     } else {
 481       st-&gt;print(&quot;~interpreter&quot;);
 482     }
 483   }
 484   st-&gt;print_cr(&quot;)&quot;);
 485 
 486   if (_cb != NULL) {
 487     st-&gt;print(&quot;     &quot;);
 488     _cb-&gt;print_value_on(st);
 489     st-&gt;cr();
 490 #ifndef PRODUCT
 491     if (end == NULL) {
 492       begin = _cb-&gt;code_begin();
 493       end   = _cb-&gt;code_end();
 494     }
 495 #endif
 496   }
 497   NOT_PRODUCT(if (WizardMode &amp;&amp; Verbose) Disassembler::decode(begin, end);)
 498 }
 499 
 500 
 501 void frame::print_on(outputStream* st) const {
 502   print_value_on(st,NULL);
 503   if (is_interpreted_frame()) {
 504     interpreter_frame_print_on(st);
 505   }
 506 }
 507 
 508 
 509 void frame::interpreter_frame_print_on(outputStream* st) const {
 510 #ifndef PRODUCT
 511   assert(is_interpreted_frame(), &quot;Not an interpreted frame&quot;);
 512   jint i;
 513   for (i = 0; i &lt; interpreter_frame_method()-&gt;max_locals(); i++ ) {
 514     intptr_t x = *interpreter_frame_local_at(i);
 515     st-&gt;print(&quot; - local  [&quot; INTPTR_FORMAT &quot;]&quot;, x);
 516     st-&gt;fill_to(23);
 517     st-&gt;print_cr(&quot;; #%d&quot;, i);
 518   }
 519   for (i = interpreter_frame_expression_stack_size() - 1; i &gt;= 0; --i ) {
 520     intptr_t x = *interpreter_frame_expression_stack_at(i);
 521     st-&gt;print(&quot; - stack  [&quot; INTPTR_FORMAT &quot;]&quot;, x);
 522     st-&gt;fill_to(23);
 523     st-&gt;print_cr(&quot;; #%d&quot;, i);
 524   }
 525   // locks for synchronization
 526   for (BasicObjectLock* current = interpreter_frame_monitor_end();
 527        current &lt; interpreter_frame_monitor_begin();
 528        current = next_monitor_in_interpreter_frame(current)) {
 529     st-&gt;print(&quot; - obj    [&quot;);
 530     current-&gt;obj()-&gt;print_value_on(st);
 531     st-&gt;print_cr(&quot;]&quot;);
 532     st-&gt;print(&quot; - lock   [&quot;);
 533     current-&gt;lock()-&gt;print_on(st);
 534     st-&gt;print_cr(&quot;]&quot;);
 535   }
 536   // monitor
 537   st-&gt;print_cr(&quot; - monitor[&quot; INTPTR_FORMAT &quot;]&quot;, p2i(interpreter_frame_monitor_begin()));
 538   // bcp
 539   st-&gt;print(&quot; - bcp    [&quot; INTPTR_FORMAT &quot;]&quot;, p2i(interpreter_frame_bcp()));
 540   st-&gt;fill_to(23);
 541   st-&gt;print_cr(&quot;; @%d&quot;, interpreter_frame_bci());
 542   // locals
 543   st-&gt;print_cr(&quot; - locals [&quot; INTPTR_FORMAT &quot;]&quot;, p2i(interpreter_frame_local_at(0)));
 544   // method
 545   st-&gt;print(&quot; - method [&quot; INTPTR_FORMAT &quot;]&quot;, p2i(interpreter_frame_method()));
 546   st-&gt;fill_to(23);
 547   st-&gt;print(&quot;; &quot;);
 548   interpreter_frame_method()-&gt;print_name(st);
 549   st-&gt;cr();
 550 #endif
 551 }
 552 
 553 // Print whether the frame is in the VM or OS indicating a HotSpot problem.
 554 // Otherwise, it&#39;s likely a bug in the native library that the Java code calls,
 555 // hopefully indicating where to submit bugs.
 556 void frame::print_C_frame(outputStream* st, char* buf, int buflen, address pc) {
 557   // C/C++ frame
 558   bool in_vm = os::address_is_in_vm(pc);
 559   st-&gt;print(in_vm ? &quot;V&quot; : &quot;C&quot;);
 560 
 561   int offset;
 562   bool found;
 563 
 564   // libname
 565   found = os::dll_address_to_library_name(pc, buf, buflen, &amp;offset);
 566   if (found) {
 567     // skip directory names
 568     const char *p1, *p2;
 569     p1 = buf;
 570     int len = (int)strlen(os::file_separator());
 571     while ((p2 = strstr(p1, os::file_separator())) != NULL) p1 = p2 + len;
 572     st-&gt;print(&quot;  [%s+0x%x]&quot;, p1, offset);
 573   } else {
 574     st-&gt;print(&quot;  &quot; PTR_FORMAT, p2i(pc));
 575   }
 576 
 577   found = os::dll_address_to_function_name(pc, buf, buflen, &amp;offset);
 578   if (found) {
 579     st-&gt;print(&quot;  %s+0x%x&quot;, buf, offset);
 580   }
 581 }
 582 
 583 // frame::print_on_error() is called by fatal error handler. Notice that we may
 584 // crash inside this function if stack frame is corrupted. The fatal error
 585 // handler can catch and handle the crash. Here we assume the frame is valid.
 586 //
 587 // First letter indicates type of the frame:
 588 //    J: Java frame (compiled)
 589 //    A: Java frame (aot compiled)
 590 //    j: Java frame (interpreted)
 591 //    V: VM frame (C/C++)
 592 //    v: Other frames running VM generated code (e.g. stubs, adapters, etc.)
 593 //    C: C/C++ frame
 594 //
 595 // We don&#39;t need detailed frame type as that in frame::print_name(). &quot;C&quot;
 596 // suggests the problem is in user lib; everything else is likely a VM bug.
 597 
 598 void frame::print_on_error(outputStream* st, char* buf, int buflen, bool verbose) const {
 599   if (_cb != NULL) {
 600     if (Interpreter::contains(pc())) {
 601       Method* m = this-&gt;interpreter_frame_method();
 602       if (m != NULL) {
 603         m-&gt;name_and_sig_as_C_string(buf, buflen);
 604         st-&gt;print(&quot;j  %s&quot;, buf);
 605         st-&gt;print(&quot;+%d&quot;, this-&gt;interpreter_frame_bci());
 606         ModuleEntry* module = m-&gt;method_holder()-&gt;module();
 607         if (module-&gt;is_named()) {
 608           module-&gt;name()-&gt;as_C_string(buf, buflen);
 609           st-&gt;print(&quot; %s&quot;, buf);
 610           if (module-&gt;version() != NULL) {
 611             module-&gt;version()-&gt;as_C_string(buf, buflen);
 612             st-&gt;print(&quot;@%s&quot;, buf);
 613           }
 614         }
 615       } else {
 616         st-&gt;print(&quot;j  &quot; PTR_FORMAT, p2i(pc()));
 617       }
 618     } else if (StubRoutines::contains(pc())) {
 619       StubCodeDesc* desc = StubCodeDesc::desc_for(pc());
 620       if (desc != NULL) {
 621         st-&gt;print(&quot;v  ~StubRoutines::%s&quot;, desc-&gt;name());
 622       } else {
 623         st-&gt;print(&quot;v  ~StubRoutines::&quot; PTR_FORMAT, p2i(pc()));
 624       }
 625     } else if (_cb-&gt;is_buffer_blob()) {
 626       st-&gt;print(&quot;v  ~BufferBlob::%s&quot;, ((BufferBlob *)_cb)-&gt;name());
 627     } else if (_cb-&gt;is_compiled()) {
 628       CompiledMethod* cm = (CompiledMethod*)_cb;
 629       Method* m = cm-&gt;method();
 630       if (m != NULL) {
 631         if (cm-&gt;is_aot()) {
 632           st-&gt;print(&quot;A %d &quot;, cm-&gt;compile_id());
 633         } else if (cm-&gt;is_nmethod()) {
 634           nmethod* nm = cm-&gt;as_nmethod();
 635           st-&gt;print(&quot;J %d%s&quot;, nm-&gt;compile_id(), (nm-&gt;is_osr_method() ? &quot;%&quot; : &quot;&quot;));
 636           st-&gt;print(&quot; %s&quot;, nm-&gt;compiler_name());
 637         }
 638         m-&gt;name_and_sig_as_C_string(buf, buflen);
 639         st-&gt;print(&quot; %s&quot;, buf);
 640         ModuleEntry* module = m-&gt;method_holder()-&gt;module();
 641         if (module-&gt;is_named()) {
 642           module-&gt;name()-&gt;as_C_string(buf, buflen);
 643           st-&gt;print(&quot; %s&quot;, buf);
 644           if (module-&gt;version() != NULL) {
 645             module-&gt;version()-&gt;as_C_string(buf, buflen);
 646             st-&gt;print(&quot;@%s&quot;, buf);
 647           }
 648         }
 649         st-&gt;print(&quot; (%d bytes) @ &quot; PTR_FORMAT &quot; [&quot; PTR_FORMAT &quot;+&quot; INTPTR_FORMAT &quot;]&quot;,
 650                   m-&gt;code_size(), p2i(_pc), p2i(_cb-&gt;code_begin()), _pc - _cb-&gt;code_begin());
 651 #if INCLUDE_JVMCI
 652         if (cm-&gt;is_nmethod()) {
 653           nmethod* nm = cm-&gt;as_nmethod();
 654           const char* jvmciName = nm-&gt;jvmci_name();
 655           if (jvmciName != NULL) {
 656             st-&gt;print(&quot; (%s)&quot;, jvmciName);
 657           }
 658         }
 659 #endif
 660       } else {
 661         st-&gt;print(&quot;J  &quot; PTR_FORMAT, p2i(pc()));
 662       }
 663     } else if (_cb-&gt;is_runtime_stub()) {
 664       st-&gt;print(&quot;v  ~RuntimeStub::%s&quot;, ((RuntimeStub *)_cb)-&gt;name());
 665     } else if (_cb-&gt;is_deoptimization_stub()) {
 666       st-&gt;print(&quot;v  ~DeoptimizationBlob&quot;);
 667     } else if (_cb-&gt;is_exception_stub()) {
 668       st-&gt;print(&quot;v  ~ExceptionBlob&quot;);
 669     } else if (_cb-&gt;is_safepoint_stub()) {
 670       st-&gt;print(&quot;v  ~SafepointBlob&quot;);
 671     } else if (_cb-&gt;is_adapter_blob()) {
 672       st-&gt;print(&quot;v  ~AdapterBlob&quot;);
 673     } else if (_cb-&gt;is_vtable_blob()) {
 674       st-&gt;print(&quot;v  ~VtableBlob&quot;);
 675     } else if (_cb-&gt;is_method_handles_adapter_blob()) {
 676       st-&gt;print(&quot;v  ~MethodHandlesAdapterBlob&quot;);
 677     } else if (_cb-&gt;is_uncommon_trap_stub()) {
 678       st-&gt;print(&quot;v  ~UncommonTrapBlob&quot;);
 679     } else {
 680       st-&gt;print(&quot;v  blob &quot; PTR_FORMAT, p2i(pc()));
 681     }
 682   } else {
 683     print_C_frame(st, buf, buflen, pc());
 684   }
 685 }
 686 
 687 
 688 /*
 689   The interpreter_frame_expression_stack_at method in the case of SPARC needs the
 690   max_stack value of the method in order to compute the expression stack address.
 691   It uses the Method* in order to get the max_stack value but during GC this
 692   Method* value saved on the frame is changed by reverse_and_push and hence cannot
 693   be used. So we save the max_stack value in the FrameClosure object and pass it
 694   down to the interpreter_frame_expression_stack_at method
 695 */
 696 class InterpreterFrameClosure : public OffsetClosure {
 697  private:
 698   frame* _fr;
 699   OopClosure* _f;
 700   int    _max_locals;
 701   int    _max_stack;
 702 
 703  public:
 704   InterpreterFrameClosure(frame* fr, int max_locals, int max_stack,
 705                           OopClosure* f, BufferedValueClosure* bvt_f) {
 706     _fr         = fr;
 707     _max_locals = max_locals;
 708     _max_stack  = max_stack;
 709     _f          = f;
 710   }
 711 
 712   void offset_do(int offset) {
 713     oop* addr;
 714     if (offset &lt; _max_locals) {
 715       addr = (oop*) _fr-&gt;interpreter_frame_local_at(offset);
 716       assert((intptr_t*)addr &gt;= _fr-&gt;sp(), &quot;must be inside the frame&quot;);
 717       if (_f != NULL) {
 718         _f-&gt;do_oop(addr);
 719       }
 720     } else {
 721       addr = (oop*) _fr-&gt;interpreter_frame_expression_stack_at((offset - _max_locals));
 722       // In case of exceptions, the expression stack is invalid and the esp will be reset to express
 723       // this condition. Therefore, we call f only if addr is &#39;inside&#39; the stack (i.e., addr &gt;= esp for Intel).
 724       bool in_stack;
 725       if (frame::interpreter_frame_expression_stack_direction() &gt; 0) {
 726         in_stack = (intptr_t*)addr &lt;= _fr-&gt;interpreter_frame_tos_address();
 727       } else {
 728         in_stack = (intptr_t*)addr &gt;= _fr-&gt;interpreter_frame_tos_address();
 729       }
 730       if (in_stack) {
 731         if (_f != NULL) {
 732           _f-&gt;do_oop(addr);
 733         }
 734       }
 735     }
 736   }
 737 
 738   int max_locals()  { return _max_locals; }
 739   frame* fr()       { return _fr; }
 740 };
 741 
 742 
 743 class InterpretedArgumentOopFinder: public SignatureIterator {
 744  private:
 745   OopClosure* _f;        // Closure to invoke
 746   int    _offset;        // TOS-relative offset, decremented with each argument
 747   bool   _has_receiver;  // true if the callee has a receiver
 748   frame* _fr;
 749 
 750   friend class SignatureIterator;  // so do_parameters_on can call do_type
 751   void do_type(BasicType type) {
 752     _offset -= parameter_type_word_count(type);
 753     if (is_reference_type(type)) oop_offset_do();
 754    }
 755 
 756   void oop_offset_do() {
 757     oop* addr;
 758     addr = (oop*)_fr-&gt;interpreter_frame_tos_at(_offset);
 759     _f-&gt;do_oop(addr);
 760   }
 761 
 762  public:
 763   InterpretedArgumentOopFinder(Symbol* signature, bool has_receiver, frame* fr, OopClosure* f) : SignatureIterator(signature), _has_receiver(has_receiver) {
 764     // compute size of arguments
 765     int args_size = ArgumentSizeComputer(signature).size() + (has_receiver ? 1 : 0);
 766     assert(!fr-&gt;is_interpreted_frame() ||
 767            args_size &lt;= fr-&gt;interpreter_frame_expression_stack_size(),
 768             &quot;args cannot be on stack anymore&quot;);
 769     // initialize InterpretedArgumentOopFinder
 770     _f         = f;
 771     _fr        = fr;
 772     _offset    = args_size;
 773   }
 774 
 775   void oops_do() {
 776     if (_has_receiver) {
 777       --_offset;
 778       oop_offset_do();
 779     }
 780     do_parameters_on(this);
 781   }
 782 };
 783 
 784 
 785 // Entry frame has following form (n arguments)
 786 //         +-----------+
 787 //   sp -&gt; |  last arg |
 788 //         +-----------+
 789 //         :    :::    :
 790 //         +-----------+
 791 // (sp+n)-&gt;|  first arg|
 792 //         +-----------+
 793 
 794 
 795 
 796 // visits and GC&#39;s all the arguments in entry frame
 797 class EntryFrameOopFinder: public SignatureIterator {
 798  private:
 799   bool   _is_static;
 800   int    _offset;
 801   frame* _fr;
 802   OopClosure* _f;
 803 
 804   friend class SignatureIterator;  // so do_parameters_on can call do_type
 805   void do_type(BasicType type) {
 806     // decrement offset before processing the type
 807     _offset -= parameter_type_word_count(type);
 808     assert (_offset &gt;= 0, &quot;illegal offset&quot;);
 809     if (is_reference_type(type))  oop_at_offset_do(_offset);
 810  }
 811 
 812   void oop_at_offset_do(int offset) {
 813     assert (offset &gt;= 0, &quot;illegal offset&quot;);
 814     oop* addr = (oop*) _fr-&gt;entry_frame_argument_at(offset);
 815     _f-&gt;do_oop(addr);
 816   }
 817 
 818  public:
 819   EntryFrameOopFinder(frame* frame, Symbol* signature, bool is_static) : SignatureIterator(signature) {
 820     _f = NULL; // will be set later
 821     _fr = frame;
 822     _is_static = is_static;
 823     _offset = ArgumentSizeComputer(signature).size();  // pre-decremented down to zero
 824   }
 825 
 826   void arguments_do(OopClosure* f) {
 827     _f = f;
 828     if (!_is_static)  oop_at_offset_do(_offset); // do the receiver
 829     do_parameters_on(this);
 830   }
 831 
 832 };
 833 
 834 oop* frame::interpreter_callee_receiver_addr(Symbol* signature) {
 835   ArgumentSizeComputer asc(signature);
 836   int size = asc.size();
 837   return (oop *)interpreter_frame_tos_at(size);
 838 }
 839 
 840 
 841 void frame::oops_interpreted_do(OopClosure* f, const RegisterMap* map, bool query_oop_map_cache) {
 842   assert(is_interpreted_frame(), &quot;Not an interpreted frame&quot;);
 843   assert(map != NULL, &quot;map must be set&quot;);
 844   Thread *thread = Thread::current();
 845   methodHandle m (thread, interpreter_frame_method());
 846   jint      bci = interpreter_frame_bci();
 847 
 848   assert(!Universe::heap()-&gt;is_in(m()),
 849           &quot;must be valid oop&quot;);
 850   assert(m-&gt;is_method(), &quot;checking frame value&quot;);
 851   assert((m-&gt;is_native() &amp;&amp; bci == 0)  ||
 852          (!m-&gt;is_native() &amp;&amp; bci &gt;= 0 &amp;&amp; bci &lt; m-&gt;code_size()),
 853          &quot;invalid bci value&quot;);
 854 
 855   // Handle the monitor elements in the activation
 856   for (
 857     BasicObjectLock* current = interpreter_frame_monitor_end();
 858     current &lt; interpreter_frame_monitor_begin();
 859     current = next_monitor_in_interpreter_frame(current)
 860   ) {
 861 #ifdef ASSERT
 862     interpreter_frame_verify_monitor(current);
 863 #endif
 864     current-&gt;oops_do(f);
 865   }
 866 
 867   if (m-&gt;is_native()) {
 868     f-&gt;do_oop(interpreter_frame_temp_oop_addr());
 869   }
 870 
 871   // The method pointer in the frame might be the only path to the method&#39;s
 872   // klass, and the klass needs to be kept alive while executing. The GCs
 873   // don&#39;t trace through method pointers, so the mirror of the method&#39;s klass
 874   // is installed as a GC root.
 875   f-&gt;do_oop(interpreter_frame_mirror_addr());
 876 
 877   int max_locals = m-&gt;is_native() ? m-&gt;size_of_parameters() : m-&gt;max_locals();
 878 
 879   Symbol* signature = NULL;
 880   bool has_receiver = false;
 881 
 882   // Process a callee&#39;s arguments if we are at a call site
 883   // (i.e., if we are at an invoke bytecode)
 884   // This is used sometimes for calling into the VM, not for another
 885   // interpreted or compiled frame.
 886   if (!m-&gt;is_native()) {
 887     Bytecode_invoke call = Bytecode_invoke_check(m, bci);
 888     if (call.is_valid()) {
 889       signature = call.signature();
 890       has_receiver = call.has_receiver();
 891       if (map-&gt;include_argument_oops() &amp;&amp;
 892           interpreter_frame_expression_stack_size() &gt; 0) {
 893         ResourceMark rm(thread);  // is this right ???
 894         // we are at a call site &amp; the expression stack is not empty
 895         // =&gt; process callee&#39;s arguments
 896         //
 897         // Note: The expression stack can be empty if an exception
 898         //       occurred during method resolution/execution. In all
 899         //       cases we empty the expression stack completely be-
 900         //       fore handling the exception (the exception handling
 901         //       code in the interpreter calls a blocking runtime
 902         //       routine which can cause this code to be executed).
 903         //       (was bug gri 7/27/98)
 904         oops_interpreted_arguments_do(signature, has_receiver, f);
 905       }
 906     }
 907   }
 908 
 909   InterpreterFrameClosure blk(this, max_locals, m-&gt;max_stack(), f, NULL);
 910 
 911   // process locals &amp; expression stack
 912   InterpreterOopMap mask;
 913   if (query_oop_map_cache) {
 914     m-&gt;mask_for(bci, &amp;mask);
 915   } else {
 916     OopMapCache::compute_one_oop_map(m, bci, &amp;mask);
 917   }
 918   mask.iterate_oop(&amp;blk);
 919 }
 920 
 921 void frame::buffered_values_interpreted_do(BufferedValueClosure* f) {
 922   assert(is_interpreted_frame(), &quot;Not an interpreted frame&quot;);
 923   Thread *thread = Thread::current();
 924   methodHandle m (thread, interpreter_frame_method());
 925   jint      bci = interpreter_frame_bci();
 926 
 927   assert(m-&gt;is_method(), &quot;checking frame value&quot;);
 928   assert(!m-&gt;is_native() &amp;&amp; bci &gt;= 0 &amp;&amp; bci &lt; m-&gt;code_size(),
 929          &quot;invalid bci value&quot;);
 930 
 931   InterpreterFrameClosure blk(this, m-&gt;max_locals(), m-&gt;max_stack(), NULL, f);
 932 
 933   // process locals &amp; expression stack
 934   InterpreterOopMap mask;
 935   m-&gt;mask_for(bci, &amp;mask);
 936   mask.iterate_oop(&amp;blk);
 937 }
 938 
 939 void frame::oops_interpreted_arguments_do(Symbol* signature, bool has_receiver, OopClosure* f) {
 940   InterpretedArgumentOopFinder finder(signature, has_receiver, this, f);
 941   finder.oops_do();
 942 }
 943 
 944 void frame::oops_code_blob_do(OopClosure* f, CodeBlobClosure* cf, const RegisterMap* reg_map) {
 945   assert(_cb != NULL, &quot;sanity check&quot;);
 946   if (_cb-&gt;oop_maps() != NULL) {
 947     OopMapSet::oops_do(this, reg_map, f);
 948 
 949     // Preserve potential arguments for a callee. We handle this by dispatching
 950     // on the codeblob. For c2i, we do
 951     if (reg_map-&gt;include_argument_oops()) {
 952       _cb-&gt;preserve_callee_argument_oops(*this, reg_map, f);
 953     }
 954   }
 955   // In cases where perm gen is collected, GC will want to mark
 956   // oops referenced from nmethods active on thread stacks so as to
 957   // prevent them from being collected. However, this visit should be
 958   // restricted to certain phases of the collection only. The
 959   // closure decides how it wants nmethods to be traced.
 960   if (cf != NULL)
 961     cf-&gt;do_code_blob(_cb);
 962 }
 963 
 964 class CompiledArgumentOopFinder: public SignatureIterator {
 965  protected:
 966   OopClosure*     _f;
 967   int             _offset;        // the current offset, incremented with each argument
 968   bool            _has_receiver;  // true if the callee has a receiver
 969   bool            _has_appendix;  // true if the call has an appendix
 970   frame           _fr;
 971   RegisterMap*    _reg_map;
 972   int             _arg_size;
 973   VMRegPair*      _regs;        // VMReg list of arguments
 974 
 975   friend class SignatureIterator;  // so do_parameters_on can call do_type
 976   void do_type(BasicType type) {
 977     if (is_reference_type(type))  handle_oop_offset();
 978     _offset += parameter_type_word_count(type);
 979   }
 980 
 981   virtual void handle_oop_offset() {
 982     // Extract low order register number from register array.
 983     // In LP64-land, the high-order bits are valid but unhelpful.
 984     assert(_offset &lt; _arg_size, &quot;out of bounds&quot;);
 985     VMReg reg = _regs[_offset].first();
 986     oop *loc = _fr.oopmapreg_to_location(reg, _reg_map);
 987     _f-&gt;do_oop(loc);
 988   }
 989 
 990  public:
 991   CompiledArgumentOopFinder(Symbol* signature, bool has_receiver, bool has_appendix, OopClosure* f, frame fr, const RegisterMap* reg_map)
 992     : SignatureIterator(signature) {
 993 
 994     // initialize CompiledArgumentOopFinder
 995     _f         = f;
 996     _offset    = 0;
 997     _has_receiver = has_receiver;
 998     _has_appendix = has_appendix;
 999     _fr        = fr;
1000     _reg_map   = (RegisterMap*)reg_map;
1001     _regs = SharedRuntime::find_callee_arguments(signature, has_receiver, has_appendix, &amp;_arg_size);
1002   }
1003 
1004   void oops_do() {
1005     if (_has_receiver) {
1006       handle_oop_offset();
1007       _offset++;
1008     }
1009     do_parameters_on(this);
1010     if (_has_appendix) {
1011       handle_oop_offset();
1012       _offset++;
1013     }
1014   }
1015 };
1016 
1017 void frame::oops_compiled_arguments_do(Symbol* signature, bool has_receiver, bool has_appendix,
1018                                        const RegisterMap* reg_map, OopClosure* f) {
1019   ResourceMark rm;
1020   CompiledArgumentOopFinder finder(signature, has_receiver, has_appendix, f, *this, reg_map);
1021   finder.oops_do();
1022 }
1023 
1024 
1025 // Get receiver out of callers frame, i.e. find parameter 0 in callers
1026 // frame.  Consult ADLC for where parameter 0 is to be found.  Then
1027 // check local reg_map for it being a callee-save register or argument
1028 // register, both of which are saved in the local frame.  If not found
1029 // there, it must be an in-stack argument of the caller.
1030 // Note: caller.sp() points to callee-arguments
1031 oop frame::retrieve_receiver(RegisterMap* reg_map) {
1032   frame caller = *this;
1033 
1034   // First consult the ADLC on where it puts parameter 0 for this signature.
1035   VMReg reg = SharedRuntime::name_for_receiver();
1036   oop* oop_adr = caller.oopmapreg_to_location(reg, reg_map);
1037   if (oop_adr == NULL) {
1038     guarantee(oop_adr != NULL, &quot;bad register save location&quot;);
1039     return NULL;
1040   }
1041   oop r = *oop_adr;
1042   assert(Universe::heap()-&gt;is_in_or_null(r), &quot;bad receiver: &quot; INTPTR_FORMAT &quot; (&quot; INTX_FORMAT &quot;)&quot;, p2i(r), p2i(r));
1043   return r;
1044 }
1045 
1046 
1047 BasicLock* frame::get_native_monitor() {
1048   nmethod* nm = (nmethod*)_cb;
1049   assert(_cb != NULL &amp;&amp; _cb-&gt;is_nmethod() &amp;&amp; nm-&gt;method()-&gt;is_native(),
1050          &quot;Should not call this unless it&#39;s a native nmethod&quot;);
1051   int byte_offset = in_bytes(nm-&gt;native_basic_lock_sp_offset());
1052   assert(byte_offset &gt;= 0, &quot;should not see invalid offset&quot;);
1053   return (BasicLock*) &amp;sp()[byte_offset / wordSize];
1054 }
1055 
1056 oop frame::get_native_receiver() {
1057   nmethod* nm = (nmethod*)_cb;
1058   assert(_cb != NULL &amp;&amp; _cb-&gt;is_nmethod() &amp;&amp; nm-&gt;method()-&gt;is_native(),
1059          &quot;Should not call this unless it&#39;s a native nmethod&quot;);
1060   int byte_offset = in_bytes(nm-&gt;native_receiver_sp_offset());
1061   assert(byte_offset &gt;= 0, &quot;should not see invalid offset&quot;);
1062   oop owner = ((oop*) sp())[byte_offset / wordSize];
1063   assert( Universe::heap()-&gt;is_in(owner), &quot;bad receiver&quot; );
1064   return owner;
1065 }
1066 
1067 void frame::oops_entry_do(OopClosure* f, const RegisterMap* map) {
1068   assert(map != NULL, &quot;map must be set&quot;);
1069   if (map-&gt;include_argument_oops()) {
1070     // must collect argument oops, as nobody else is doing it
1071     Thread *thread = Thread::current();
1072     methodHandle m (thread, entry_frame_call_wrapper()-&gt;callee_method());
1073     EntryFrameOopFinder finder(this, m-&gt;signature(), m-&gt;is_static());
1074     finder.arguments_do(f);
1075   }
1076   // Traverse the Handle Block saved in the entry frame
1077   entry_frame_call_wrapper()-&gt;oops_do(f);
1078 }
1079 
1080 
1081 void frame::oops_do_internal(OopClosure* f, CodeBlobClosure* cf, RegisterMap* map, bool use_interpreter_oop_map_cache) {
1082 #ifndef PRODUCT
1083   // simulate GC crash here to dump java thread in error report
1084   if (CrashGCForDumpingJavaThread) {
1085     char *t = NULL;
1086     *t = &#39;c&#39;;
1087   }
1088 #endif
1089   if (is_interpreted_frame()) {
1090     oops_interpreted_do(f, map, use_interpreter_oop_map_cache);
1091   } else if (is_entry_frame()) {
1092     oops_entry_do(f, map);
1093   } else if (CodeCache::contains(pc())) {
1094     oops_code_blob_do(f, cf, map);
1095   } else {
1096     ShouldNotReachHere();
1097   }
1098 }
1099 
1100 void frame::nmethods_do(CodeBlobClosure* cf) {
1101   if (_cb != NULL &amp;&amp; _cb-&gt;is_nmethod()) {
1102     cf-&gt;do_code_blob(_cb);
1103   }
1104 }
1105 
1106 
1107 // Call f closure on the interpreted Method*s in the stack.
1108 void frame::metadata_do(MetadataClosure* f) {
1109   ResourceMark rm;
1110   if (is_interpreted_frame()) {
1111     Method* m = this-&gt;interpreter_frame_method();
1112     assert(m != NULL, &quot;expecting a method in this frame&quot;);
1113     f-&gt;do_metadata(m);
1114   }
1115 }
1116 
1117 void frame::verify(const RegisterMap* map) {
1118   // for now make sure receiver type is correct
1119   if (is_interpreted_frame()) {
1120     Method* method = interpreter_frame_method();
1121     guarantee(method-&gt;is_method(), &quot;method is wrong in frame::verify&quot;);
1122     if (!method-&gt;is_static()) {
1123       // fetch the receiver
1124       oop* p = (oop*) interpreter_frame_local_at(0);
1125       // make sure we have the right receiver type
1126     }
1127   }
1128 #if COMPILER2_OR_JVMCI
1129   assert(DerivedPointerTable::is_empty(), &quot;must be empty before verify&quot;);
1130 #endif
1131   oops_do_internal(&amp;VerifyOopClosure::verify_oop, NULL, (RegisterMap*)map, false);
1132 }
1133 
1134 
1135 #ifdef ASSERT
1136 bool frame::verify_return_pc(address x) {
1137   if (StubRoutines::returns_to_call_stub(x)) {
1138     return true;
1139   }
1140   if (CodeCache::contains(x)) {
1141     return true;
1142   }
1143   if (Interpreter::contains(x)) {
1144     return true;
1145   }
1146   return false;
1147 }
1148 #endif
1149 
1150 #ifdef ASSERT
1151 void frame::interpreter_frame_verify_monitor(BasicObjectLock* value) const {
1152   assert(is_interpreted_frame(), &quot;Not an interpreted frame&quot;);
1153   // verify that the value is in the right part of the frame
1154   address low_mark  = (address) interpreter_frame_monitor_end();
1155   address high_mark = (address) interpreter_frame_monitor_begin();
1156   address current   = (address) value;
1157 
1158   const int monitor_size = frame::interpreter_frame_monitor_size();
1159   guarantee((high_mark - current) % monitor_size  ==  0         , &quot;Misaligned top of BasicObjectLock*&quot;);
1160   guarantee( high_mark &gt; current                                , &quot;Current BasicObjectLock* higher than high_mark&quot;);
1161 
1162   guarantee((current - low_mark) % monitor_size  ==  0         , &quot;Misaligned bottom of BasicObjectLock*&quot;);
1163   guarantee( current &gt;= low_mark                               , &quot;Current BasicObjectLock* below than low_mark&quot;);
1164 }
1165 #endif
1166 
1167 #ifndef PRODUCT
1168 void frame::describe(FrameValues&amp; values, int frame_no) {
1169   // boundaries: sp and the &#39;real&#39; frame pointer
1170   values.describe(-1, sp(), err_msg(&quot;sp for #%d&quot;, frame_no), 1);
1171   intptr_t* frame_pointer = real_fp(); // Note: may differ from fp()
1172 
1173   // print frame info at the highest boundary
1174   intptr_t* info_address = MAX2(sp(), frame_pointer);
1175 
1176   if (info_address != frame_pointer) {
1177     // print frame_pointer explicitly if not marked by the frame info
1178     values.describe(-1, frame_pointer, err_msg(&quot;frame pointer for #%d&quot;, frame_no), 1);
1179   }
1180 
1181   if (is_entry_frame() || is_compiled_frame() || is_interpreted_frame() || is_native_frame()) {
1182     // Label values common to most frames
1183     values.describe(-1, unextended_sp(), err_msg(&quot;unextended_sp for #%d&quot;, frame_no));
1184   }
1185 
1186   if (is_interpreted_frame()) {
1187     Method* m = interpreter_frame_method();
1188     int bci = interpreter_frame_bci();
1189 
1190     // Label the method and current bci
1191     values.describe(-1, info_address,
1192                     FormatBuffer&lt;1024&gt;(&quot;#%d method %s @ %d&quot;, frame_no, m-&gt;name_and_sig_as_C_string(), bci), 2);
1193     values.describe(-1, info_address,
1194                     err_msg(&quot;- %d locals %d max stack&quot;, m-&gt;max_locals(), m-&gt;max_stack()), 1);
1195     if (m-&gt;max_locals() &gt; 0) {
1196       intptr_t* l0 = interpreter_frame_local_at(0);
1197       intptr_t* ln = interpreter_frame_local_at(m-&gt;max_locals() - 1);
1198       values.describe(-1, MAX2(l0, ln), err_msg(&quot;locals for #%d&quot;, frame_no), 1);
1199       // Report each local and mark as owned by this frame
1200       for (int l = 0; l &lt; m-&gt;max_locals(); l++) {
1201         intptr_t* l0 = interpreter_frame_local_at(l);
1202         values.describe(frame_no, l0, err_msg(&quot;local %d&quot;, l));
1203       }
1204     }
1205 
1206     // Compute the actual expression stack size
1207     InterpreterOopMap mask;
1208     OopMapCache::compute_one_oop_map(methodHandle(Thread::current(), m), bci, &amp;mask);
1209     intptr_t* tos = NULL;
1210     // Report each stack element and mark as owned by this frame
1211     for (int e = 0; e &lt; mask.expression_stack_size(); e++) {
1212       tos = MAX2(tos, interpreter_frame_expression_stack_at(e));
1213       values.describe(frame_no, interpreter_frame_expression_stack_at(e),
1214                       err_msg(&quot;stack %d&quot;, e));
1215     }
1216     if (tos != NULL) {
1217       values.describe(-1, tos, err_msg(&quot;expression stack for #%d&quot;, frame_no), 1);
1218     }
1219     if (interpreter_frame_monitor_begin() != interpreter_frame_monitor_end()) {
1220       values.describe(frame_no, (intptr_t*)interpreter_frame_monitor_begin(), &quot;monitors begin&quot;);
1221       values.describe(frame_no, (intptr_t*)interpreter_frame_monitor_end(), &quot;monitors end&quot;);
1222     }
1223   } else if (is_entry_frame()) {
1224     // For now just label the frame
1225     values.describe(-1, info_address, err_msg(&quot;#%d entry frame&quot;, frame_no), 2);
1226   } else if (is_compiled_frame()) {
1227     // For now just label the frame
1228     CompiledMethod* cm = (CompiledMethod*)cb();
1229     values.describe(-1, info_address,
1230                     FormatBuffer&lt;1024&gt;(&quot;#%d nmethod &quot; INTPTR_FORMAT &quot; for method %s%s%s&quot;, frame_no,
1231                                        p2i(cm),
1232                                        (cm-&gt;is_aot() ? &quot;A &quot;: &quot;J &quot;),
1233                                        cm-&gt;method()-&gt;name_and_sig_as_C_string(),
1234                                        (_deopt_state == is_deoptimized) ?
1235                                        &quot; (deoptimized)&quot; :
1236                                        ((_deopt_state == unknown) ? &quot; (state unknown)&quot; : &quot;&quot;)),
1237                     2);
1238   } else if (is_native_frame()) {
1239     // For now just label the frame
1240     nmethod* nm = cb()-&gt;as_nmethod_or_null();
1241     values.describe(-1, info_address,
1242                     FormatBuffer&lt;1024&gt;(&quot;#%d nmethod &quot; INTPTR_FORMAT &quot; for native method %s&quot;, frame_no,
1243                                        p2i(nm), nm-&gt;method()-&gt;name_and_sig_as_C_string()), 2);
1244   } else {
1245     // provide default info if not handled before
1246     char *info = (char *) &quot;special frame&quot;;
1247     if ((_cb != NULL) &amp;&amp;
1248         (_cb-&gt;name() != NULL)) {
1249       info = (char *)_cb-&gt;name();
1250     }
1251     values.describe(-1, info_address, err_msg(&quot;#%d &lt;%s&gt;&quot;, frame_no, info), 2);
1252   }
1253 
1254   // platform dependent additional data
1255   describe_pd(values, frame_no);
1256 }
1257 
1258 #endif
1259 
1260 
1261 //-----------------------------------------------------------------------------------
1262 // StackFrameStream implementation
1263 
1264 StackFrameStream::StackFrameStream(JavaThread *thread, bool update) : _reg_map(thread, update) {
1265   assert(thread-&gt;has_last_Java_frame(), &quot;sanity check&quot;);
1266   _fr = thread-&gt;last_frame();
1267   _is_done = false;
1268 }
1269 
1270 
1271 #ifndef PRODUCT
1272 
1273 void FrameValues::describe(int owner, intptr_t* location, const char* description, int priority) {
1274   FrameValue fv;
1275   fv.location = location;
1276   fv.owner = owner;
1277   fv.priority = priority;
1278   fv.description = NEW_RESOURCE_ARRAY(char, strlen(description) + 1);
1279   strcpy(fv.description, description);
1280   _values.append(fv);
1281 }
1282 
1283 
1284 #ifdef ASSERT
1285 void FrameValues::validate() {
1286   _values.sort(compare);
1287   bool error = false;
1288   FrameValue prev;
1289   prev.owner = -1;
1290   for (int i = _values.length() - 1; i &gt;= 0; i--) {
1291     FrameValue fv = _values.at(i);
1292     if (fv.owner == -1) continue;
1293     if (prev.owner == -1) {
1294       prev = fv;
1295       continue;
1296     }
1297     if (prev.location == fv.location) {
1298       if (fv.owner != prev.owner) {
1299         tty-&gt;print_cr(&quot;overlapping storage&quot;);
1300         tty-&gt;print_cr(&quot; &quot; INTPTR_FORMAT &quot;: &quot; INTPTR_FORMAT &quot; %s&quot;, p2i(prev.location), *prev.location, prev.description);
1301         tty-&gt;print_cr(&quot; &quot; INTPTR_FORMAT &quot;: &quot; INTPTR_FORMAT &quot; %s&quot;, p2i(fv.location), *fv.location, fv.description);
1302         error = true;
1303       }
1304     } else {
1305       prev = fv;
1306     }
1307   }
1308   assert(!error, &quot;invalid layout&quot;);
1309 }
1310 #endif // ASSERT
1311 
1312 void FrameValues::print(JavaThread* thread) {
1313   _values.sort(compare);
1314 
1315   // Sometimes values like the fp can be invalid values if the
1316   // register map wasn&#39;t updated during the walk.  Trim out values
1317   // that aren&#39;t actually in the stack of the thread.
1318   int min_index = 0;
1319   int max_index = _values.length() - 1;
1320   intptr_t* v0 = _values.at(min_index).location;
1321   intptr_t* v1 = _values.at(max_index).location;
1322 
1323   if (thread == Thread::current()) {
1324     while (!thread-&gt;is_in_live_stack((address)v0)) {
1325       v0 = _values.at(++min_index).location;
1326     }
1327     while (!thread-&gt;is_in_live_stack((address)v1)) {
1328       v1 = _values.at(--max_index).location;
1329     }
1330   } else {
1331     while (!thread-&gt;is_in_full_stack((address)v0)) {
1332       v0 = _values.at(++min_index).location;
1333     }
1334     while (!thread-&gt;is_in_full_stack((address)v1)) {
1335       v1 = _values.at(--max_index).location;
1336     }
1337   }
1338   intptr_t* min = MIN2(v0, v1);
1339   intptr_t* max = MAX2(v0, v1);
1340   intptr_t* cur = max;
1341   intptr_t* last = NULL;
1342   for (int i = max_index; i &gt;= min_index; i--) {
1343     FrameValue fv = _values.at(i);
1344     while (cur &gt; fv.location) {
1345       tty-&gt;print_cr(&quot; &quot; INTPTR_FORMAT &quot;: &quot; INTPTR_FORMAT, p2i(cur), *cur);
1346       cur--;
1347     }
1348     if (last == fv.location) {
1349       const char* spacer = &quot;          &quot; LP64_ONLY(&quot;        &quot;);
1350       tty-&gt;print_cr(&quot; %s  %s %s&quot;, spacer, spacer, fv.description);
1351     } else {
1352       tty-&gt;print_cr(&quot; &quot; INTPTR_FORMAT &quot;: &quot; INTPTR_FORMAT &quot; %s&quot;, p2i(fv.location), *fv.location, fv.description);
1353       last = fv.location;
1354       cur--;
1355     }
1356   }
1357 }
1358 
1359 #endif // ndef PRODUCT
<a name="2" id="anc2"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="2" type="hidden" />
</body>
</html>