<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/hotspot/share/runtime/safepoint.cpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
  </head>
<body>
<center><a href="biasedLocking.cpp.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="synchronizer.cpp.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/hotspot/share/runtime/safepoint.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
   1 /*
<span class="line-modified">   2  * Copyright (c) 1997, 2019, Oracle and/or its affiliates. All rights reserved.</span>
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.
   8  *
   9  * This code is distributed in the hope that it will be useful, but WITHOUT
  10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  *
</pre>
<hr />
<pre>
 124 SafepointStateTracker::SafepointStateTracker(uint64_t safepoint_id, bool at_safepoint)
 125   : _safepoint_id(safepoint_id), _at_safepoint(at_safepoint) {}
 126 
 127 bool SafepointStateTracker::safepoint_state_changed() {
 128   return _safepoint_id != SafepointSynchronize::safepoint_id() ||
 129     _at_safepoint != SafepointSynchronize::is_at_safepoint();
 130 }
 131 
 132 // --------------------------------------------------------------------------------------------------
 133 // Implementation of Safepoint begin/end
 134 
 135 SafepointSynchronize::SynchronizeState volatile SafepointSynchronize::_state = SafepointSynchronize::_not_synchronized;
 136 int SafepointSynchronize::_waiting_to_block = 0;
 137 volatile uint64_t SafepointSynchronize::_safepoint_counter = 0;
 138 uint64_t SafepointSynchronize::_safepoint_id = 0;
 139 const uint64_t SafepointSynchronize::InactiveSafepointCounter = 0;
 140 int SafepointSynchronize::_current_jni_active_count = 0;
 141 
 142 WaitBarrier* SafepointSynchronize::_wait_barrier;
 143 
<span class="line-removed"> 144 static volatile bool PageArmed = false;        // safepoint polling page is RO|RW vs PROT_NONE</span>
 145 static bool timeout_error_printed = false;
 146 
 147 // Statistic related
 148 static jlong _safepoint_begin_time = 0;
 149 static volatile int _nof_threads_hit_polling_page = 0;
 150 
 151 void SafepointSynchronize::init(Thread* vmthread) {
 152   // WaitBarrier should never be destroyed since we will have
 153   // threads waiting on it while exiting.
 154   _wait_barrier = new WaitBarrier(vmthread);
 155   SafepointTracing::init();
 156 }
 157 
 158 void SafepointSynchronize::increment_jni_active_count() {
 159   assert(Thread::current()-&gt;is_VM_thread(), &quot;Only VM thread may increment&quot;);
 160   ++_current_jni_active_count;
 161 }
 162 
 163 void SafepointSynchronize::decrement_waiting_to_block() {
 164   assert(_waiting_to_block &gt; 0, &quot;sanity check&quot;);
</pre>
<hr />
<pre>
 234   *p_prev = NULL;
 235 
 236   DEBUG_ONLY(assert_list_is_valid(tss_head, still_running);)
 237 
 238   *initial_running = still_running;
 239 
 240   // If there is no thread still running, we are already done.
 241   if (still_running &lt;= 0) {
 242     assert(tss_head == NULL, &quot;Must be empty&quot;);
 243     return 1;
 244   }
 245 
 246   int iterations = 1; // The first iteration is above.
 247   int64_t start_time = os::javaTimeNanos();
 248 
 249   do {
 250     // Check if this has taken too long:
 251     if (SafepointTimeout &amp;&amp; safepoint_limit_time &lt; os::javaTimeNanos()) {
 252       print_safepoint_timeout();
 253     }
<span class="line-removed"> 254     if (int(iterations) == -1) { // overflow - something is wrong.</span>
<span class="line-removed"> 255       // We can only overflow here when we are using global</span>
<span class="line-removed"> 256       // polling pages. We keep this guarantee in its original</span>
<span class="line-removed"> 257       // form so that searches of the bug database for this</span>
<span class="line-removed"> 258       // failure mode find the right bugs.</span>
<span class="line-removed"> 259       guarantee (!PageArmed, &quot;invariant&quot;);</span>
<span class="line-removed"> 260     }</span>
 261 
 262     p_prev = &amp;tss_head;
 263     ThreadSafepointState *cur_tss = tss_head;
 264     while (cur_tss != NULL) {
 265       assert(cur_tss-&gt;is_running(), &quot;Illegal initial state&quot;);
 266       if (thread_not_running(cur_tss)) {
 267         --still_running;
 268         *p_prev = NULL;
 269         ThreadSafepointState *tmp = cur_tss;
 270         cur_tss = cur_tss-&gt;get_next();
 271         tmp-&gt;set_next(NULL);
 272       } else {
 273         *p_prev = cur_tss;
 274         p_prev = cur_tss-&gt;next_ptr();
 275         cur_tss = cur_tss-&gt;get_next();
 276       }
 277     }
 278 
 279     DEBUG_ONLY(assert_list_is_valid(tss_head, still_running);)
 280 
 281     if (still_running &gt; 0) {
 282       back_off(start_time);
 283     }
 284 
 285     iterations++;
 286   } while (still_running &gt; 0);
 287 
 288   assert(tss_head == NULL, &quot;Must be empty&quot;);
 289 
 290   return iterations;
 291 }
 292 
 293 void SafepointSynchronize::arm_safepoint() {
 294   // Begin the process of bringing the system to a safepoint.
 295   // Java threads can be in several different states and are
 296   // stopped by different mechanisms:
 297   //
 298   //  1. Running interpreted
 299   //     When executing branching/returning byte codes interpreter
 300   //     checks if the poll is armed, if so blocks in SS::block().
<span class="line-removed"> 301   //     When using global polling the interpreter dispatch table</span>
<span class="line-removed"> 302   //     is changed to force it to check for a safepoint condition</span>
<span class="line-removed"> 303   //     between bytecodes.</span>
 304   //  2. Running in native code
 305   //     When returning from the native code, a Java thread must check
 306   //     the safepoint _state to see if we must block.  If the
 307   //     VM thread sees a Java thread in native, it does
 308   //     not wait for this thread to block.  The order of the memory
 309   //     writes and reads of both the safepoint state and the Java
 310   //     threads state is critical.  In order to guarantee that the
 311   //     memory writes are serialized with respect to each other,
 312   //     the VM thread issues a memory barrier instruction.
 313   //  3. Running compiled Code
 314   //     Compiled code reads the local polling page that
 315   //     is set to fault if we are trying to get to a safepoint.
 316   //  4. Blocked
 317   //     A thread which is blocked will not be allowed to return from the
 318   //     block condition until the safepoint operation is complete.
 319   //  5. In VM or Transitioning between states
 320   //     If a Java thread is currently running in the VM or transitioning
 321   //     between states, the safepointing code will poll the thread state
 322   //     until the thread blocks itself when it attempts transitions to a
 323   //     new state or locking a safepoint checked monitor.
 324 
 325   // We must never miss a thread with correct safepoint id, so we must make sure we arm
 326   // the wait barrier for the next safepoint id/counter.
 327   // Arming must be done after resetting _current_jni_active_count, _waiting_to_block.
 328   _wait_barrier-&gt;arm(static_cast&lt;int&gt;(_safepoint_counter + 1));
 329 
 330   assert((_safepoint_counter &amp; 0x1) == 0, &quot;must be even&quot;);
 331   // The store to _safepoint_counter must happen after any stores in arming.
 332   Atomic::release_store(&amp;_safepoint_counter, _safepoint_counter + 1);
 333 
 334   // We are synchronizing
 335   OrderAccess::storestore(); // Ordered with _safepoint_counter
 336   _state = _synchronizing;
 337 
<span class="line-modified"> 338   if (SafepointMechanism::uses_thread_local_poll()) {</span>
<span class="line-modified"> 339     // Arming the per thread poll while having _state != _not_synchronized means safepointing</span>
<span class="line-modified"> 340     log_trace(safepoint)(&quot;Setting thread local yield flag for threads&quot;);</span>
<span class="line-modified"> 341     OrderAccess::storestore(); // storestore, global state -&gt; local state</span>
<span class="line-modified"> 342     for (JavaThreadIteratorWithHandle jtiwh; JavaThread *cur = jtiwh.next(); ) {</span>
<span class="line-modified"> 343       // Make sure the threads start polling, it is time to yield.</span>
<span class="line-removed"> 344       SafepointMechanism::arm_local_poll(cur);</span>
<span class="line-removed"> 345     }</span>
 346   }
<span class="line-modified"> 347   OrderAccess::fence(); // storestore|storeload, global state -&gt; local state</span>
<span class="line-removed"> 348 </span>
<span class="line-removed"> 349   if (SafepointMechanism::uses_global_page_poll()) {</span>
<span class="line-removed"> 350     // Make interpreter safepoint aware</span>
<span class="line-removed"> 351     Interpreter::notice_safepoints();</span>
<span class="line-removed"> 352 </span>
<span class="line-removed"> 353     // Make polling safepoint aware</span>
<span class="line-removed"> 354     guarantee (!PageArmed, &quot;invariant&quot;) ;</span>
<span class="line-removed"> 355     PageArmed = true;</span>
<span class="line-removed"> 356     os::make_polling_page_unreadable();</span>
 357   }
 358 }
 359 
 360 // Roll all threads forward to a safepoint and suspend them all
 361 void SafepointSynchronize::begin() {
 362   assert(Thread::current()-&gt;is_VM_thread(), &quot;Only VM thread may execute a safepoint&quot;);
 363 
 364   EventSafepointBegin begin_event;
 365   SafepointTracing::begin(VMThread::vm_op_type());
 366 
 367   Universe::heap()-&gt;safepoint_synchronize_begin();
 368 
 369   // By getting the Threads_lock, we assure that no threads are about to start or
 370   // exit. It is released again in SafepointSynchronize::end().
 371   Threads_lock-&gt;lock();
 372 
 373   assert( _state == _not_synchronized, &quot;trying to safepoint synchronize with wrong state&quot;);
 374 
 375   int nof_threads = Threads::number_of_threads();
 376 
</pre>
<hr />
<pre>
 448 
 449   post_safepoint_begin_event(begin_event, _safepoint_id, nof_threads, _current_jni_active_count);
 450   SafepointTracing::cleanup();
 451 }
 452 
 453 void SafepointSynchronize::disarm_safepoint() {
 454   uint64_t active_safepoint_counter = _safepoint_counter;
 455   {
 456     JavaThreadIteratorWithHandle jtiwh;
 457 #ifdef ASSERT
 458     // A pending_exception cannot be installed during a safepoint.  The threads
 459     // may install an async exception after they come back from a safepoint into
 460     // pending_exception after they unblock.  But that should happen later.
 461     for (; JavaThread *cur = jtiwh.next(); ) {
 462       assert (!(cur-&gt;has_pending_exception() &amp;&amp;
 463                 cur-&gt;safepoint_state()-&gt;is_at_poll_safepoint()),
 464               &quot;safepoint installed a pending exception&quot;);
 465     }
 466 #endif // ASSERT
 467 
<span class="line-removed"> 468     if (SafepointMechanism::uses_global_page_poll()) {</span>
<span class="line-removed"> 469       guarantee (PageArmed, &quot;invariant&quot;);</span>
<span class="line-removed"> 470       // Make polling safepoint aware</span>
<span class="line-removed"> 471       os::make_polling_page_readable();</span>
<span class="line-removed"> 472       PageArmed = false;</span>
<span class="line-removed"> 473       // Remove safepoint check from interpreter</span>
<span class="line-removed"> 474       Interpreter::ignore_safepoints();</span>
<span class="line-removed"> 475     }</span>
<span class="line-removed"> 476 </span>
 477     OrderAccess::fence(); // keep read and write of _state from floating up
 478     assert(_state == _synchronized, &quot;must be synchronized before ending safepoint synchronization&quot;);
 479 
 480     // Change state first to _not_synchronized.
 481     // No threads should see _synchronized when running.
 482     _state = _not_synchronized;
 483 
 484     // Set the next dormant (even) safepoint id.
 485     assert((_safepoint_counter &amp; 0x1) == 1, &quot;must be odd&quot;);
 486     Atomic::release_store(&amp;_safepoint_counter, _safepoint_counter + 1);
 487 
 488     OrderAccess::fence(); // Keep the local state from floating up.
 489 
 490     jtiwh.rewind();
 491     for (; JavaThread *current = jtiwh.next(); ) {
 492       // Clear the visited flag to ensure that the critical counts are collected properly.
 493       DEBUG_ONLY(current-&gt;reset_visited_for_critical_count(active_safepoint_counter);)
 494       ThreadSafepointState* cur_state = current-&gt;safepoint_state();
 495       assert(!cur_state-&gt;is_running(), &quot;Thread not suspended at safepoint&quot;);
 496       cur_state-&gt;restart(); // TSS _running
 497       assert(cur_state-&gt;is_running(), &quot;safepoint state has not been reset&quot;);
<span class="line-removed"> 498 </span>
<span class="line-removed"> 499       SafepointMechanism::disarm_if_needed(current, false /* NO release */);</span>
 500     }
 501   } // ~JavaThreadIteratorWithHandle
 502 
 503   // Release threads lock, so threads can be created/destroyed again.
 504   Threads_lock-&gt;unlock();
 505 
 506   // Wake threads after local state is correctly set.
 507   _wait_barrier-&gt;disarm();
 508 }
 509 
 510 // Wake up all threads, so they are ready to resume execution after the safepoint
 511 // operation has been carried out
 512 void SafepointSynchronize::end() {
 513   assert(Threads_lock-&gt;owned_by_self(), &quot;must hold Threads_lock&quot;);
 514   EventSafepointEnd event;
 515   assert(Thread::current()-&gt;is_VM_thread(), &quot;Only VM thread can execute a safepoint&quot;);
 516 
 517   disarm_safepoint();
 518 
 519   Universe::heap()-&gt;safepoint_synchronize_end();
</pre>
<hr />
<pre>
 720 }
 721 
 722 static bool safepoint_safe_with(JavaThread *thread, JavaThreadState state) {
 723   switch(state) {
 724   case _thread_in_native:
 725     // native threads are safe if they have no java stack or have walkable stack
 726     return !thread-&gt;has_last_Java_frame() || thread-&gt;frame_anchor()-&gt;walkable();
 727 
 728   case _thread_blocked:
 729     // On wait_barrier or blocked.
 730     // Blocked threads should already have walkable stack.
 731     assert(!thread-&gt;has_last_Java_frame() || thread-&gt;frame_anchor()-&gt;walkable(), &quot;blocked and not walkable&quot;);
 732     return true;
 733 
 734   default:
 735     return false;
 736   }
 737 }
 738 
 739 bool SafepointSynchronize::handshake_safe(JavaThread *thread) {
<span class="line-removed"> 740   assert(Thread::current()-&gt;is_VM_thread(), &quot;Must be VMThread&quot;);</span>
 741   if (thread-&gt;is_ext_suspended() || thread-&gt;is_terminated()) {
 742     return true;
 743   }
 744   JavaThreadState stable_state;
 745   if (try_stable_load_state(&amp;stable_state, thread, InactiveSafepointCounter)) {
 746     return safepoint_safe_with(thread, stable_state);
 747   }
 748   return false;
 749 }
 750 
 751 // See if the thread is running inside a lazy critical native and
 752 // update the thread critical count if so.  Also set a suspend flag to
 753 // cause the native wrapper to return into the JVM to do the unlock
 754 // once the native finishes.
 755 static void check_for_lazy_critical_native(JavaThread *thread, JavaThreadState state) {
 756   if (state == _thread_in_native &amp;&amp;
 757       thread-&gt;has_last_Java_frame() &amp;&amp;
 758       thread-&gt;frame_anchor()-&gt;walkable()) {
 759     // This thread might be in a critical native nmethod so look at
 760     // the top of the stack and increment the critical count if it
</pre>
<hr />
<pre>
 862   // async exception is checked in check_special_condition_for_native_trans().
 863 
 864   if (state != _thread_blocked_trans &amp;&amp;
 865       state != _thread_in_vm_trans &amp;&amp;
 866       thread-&gt;has_special_runtime_exit_condition()) {
 867     thread-&gt;handle_special_runtime_exit_condition(
 868       !thread-&gt;is_at_poll_safepoint() &amp;&amp; (state != _thread_in_native_trans));
 869   }
 870 
 871   // cross_modify_fence is done by SafepointMechanism::block_if_requested_slow
 872   // which is the only caller here.
 873 }
 874 
 875 // ------------------------------------------------------------------------------------------------------
 876 // Exception handlers
 877 
 878 
 879 void SafepointSynchronize::handle_polling_page_exception(JavaThread *thread) {
 880   assert(thread-&gt;is_Java_thread(), &quot;polling reference encountered by VM thread&quot;);
 881   assert(thread-&gt;thread_state() == _thread_in_Java, &quot;should come from Java code&quot;);
<span class="line-removed"> 882   if (!SafepointMechanism::uses_thread_local_poll()) {</span>
<span class="line-removed"> 883     assert(SafepointSynchronize::is_synchronizing(), &quot;polling encountered outside safepoint synchronization&quot;);</span>
<span class="line-removed"> 884   }</span>
 885 
 886   if (log_is_enabled(Info, safepoint, stats)) {
 887     Atomic::inc(&amp;_nof_threads_hit_polling_page);
 888   }
 889 
 890   ThreadSafepointState* state = thread-&gt;safepoint_state();
 891 
 892   state-&gt;handle_polling_page_exception();
 893 }
 894 
 895 
 896 void SafepointSynchronize::print_safepoint_timeout() {
 897   if (!timeout_error_printed) {
 898     timeout_error_printed = true;
 899     // Print out the thread info which didn&#39;t reach the safepoint for debugging
 900     // purposes (useful when there are lots of threads in the debugger).
 901     LogTarget(Warning, safepoint) lt;
 902     if (lt.is_enabled()) {
 903       ResourceMark rm;
 904       LogStream ls(lt);
</pre>
<hr />
<pre>
1033 void ThreadSafepointState::restart() {
1034   assert(_safepoint_safe, &quot;Must be safe before unsafe&quot;);
1035   _safepoint_safe = false;
1036 }
1037 
1038 void ThreadSafepointState::print_on(outputStream *st) const {
1039   const char *s = _safepoint_safe ? &quot;_at_safepoint&quot; : &quot;_running&quot;;
1040 
1041   st-&gt;print_cr(&quot;Thread: &quot; INTPTR_FORMAT
1042               &quot;  [0x%2x] State: %s _at_poll_safepoint %d&quot;,
1043                p2i(_thread), _thread-&gt;osthread()-&gt;thread_id(), s, _at_poll_safepoint);
1044 
1045   _thread-&gt;print_thread_state_on(st);
1046 }
1047 
1048 // ---------------------------------------------------------------------------------------------------------------------
1049 
1050 // Block the thread at poll or poll return for safepoint/handshake.
1051 void ThreadSafepointState::handle_polling_page_exception() {
1052 
<span class="line-removed">1053   // If we&#39;re using a global poll, then the thread should not be</span>
<span class="line-removed">1054   // marked as safepoint safe yet.</span>
<span class="line-removed">1055   assert(!SafepointMechanism::uses_global_page_poll() || !_safepoint_safe,</span>
<span class="line-removed">1056          &quot;polling page exception on thread safepoint safe&quot;);</span>
<span class="line-removed">1057 </span>
1058   // Step 1: Find the nmethod from the return address
1059   address real_return_addr = thread()-&gt;saved_exception_pc();
1060 
1061   CodeBlob *cb = CodeCache::find_blob(real_return_addr);
1062   assert(cb != NULL &amp;&amp; cb-&gt;is_compiled(), &quot;return address should be in nmethod&quot;);
1063   CompiledMethod* nm = (CompiledMethod*)cb;
1064 
1065   // Find frame of caller
1066   frame stub_fr = thread()-&gt;last_frame();
1067   CodeBlob* stub_cb = stub_fr.cb();
1068   assert(stub_cb-&gt;is_safepoint_stub(), &quot;must be a safepoint stub&quot;);
1069   RegisterMap map(thread(), true);
1070   frame caller_fr = stub_fr.sender(&amp;map);
1071 
1072   // Should only be poll_return or poll
1073   assert( nm-&gt;is_at_poll_or_poll_return(real_return_addr), &quot;should not be at call&quot; );
1074 
1075   // This is a poll immediately before a return. The exception handling code
1076   // has already had the effect of causing the return to occur, so the execution
1077   // will continue immediately after the call. In addition, the oopmap at the
</pre>
</td>
<td>
<hr />
<pre>
   1 /*
<span class="line-modified">   2  * Copyright (c) 1997, 2020, Oracle and/or its affiliates. All rights reserved.</span>
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.
   8  *
   9  * This code is distributed in the hope that it will be useful, but WITHOUT
  10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  *
</pre>
<hr />
<pre>
 124 SafepointStateTracker::SafepointStateTracker(uint64_t safepoint_id, bool at_safepoint)
 125   : _safepoint_id(safepoint_id), _at_safepoint(at_safepoint) {}
 126 
 127 bool SafepointStateTracker::safepoint_state_changed() {
 128   return _safepoint_id != SafepointSynchronize::safepoint_id() ||
 129     _at_safepoint != SafepointSynchronize::is_at_safepoint();
 130 }
 131 
 132 // --------------------------------------------------------------------------------------------------
 133 // Implementation of Safepoint begin/end
 134 
 135 SafepointSynchronize::SynchronizeState volatile SafepointSynchronize::_state = SafepointSynchronize::_not_synchronized;
 136 int SafepointSynchronize::_waiting_to_block = 0;
 137 volatile uint64_t SafepointSynchronize::_safepoint_counter = 0;
 138 uint64_t SafepointSynchronize::_safepoint_id = 0;
 139 const uint64_t SafepointSynchronize::InactiveSafepointCounter = 0;
 140 int SafepointSynchronize::_current_jni_active_count = 0;
 141 
 142 WaitBarrier* SafepointSynchronize::_wait_barrier;
 143 

 144 static bool timeout_error_printed = false;
 145 
 146 // Statistic related
 147 static jlong _safepoint_begin_time = 0;
 148 static volatile int _nof_threads_hit_polling_page = 0;
 149 
 150 void SafepointSynchronize::init(Thread* vmthread) {
 151   // WaitBarrier should never be destroyed since we will have
 152   // threads waiting on it while exiting.
 153   _wait_barrier = new WaitBarrier(vmthread);
 154   SafepointTracing::init();
 155 }
 156 
 157 void SafepointSynchronize::increment_jni_active_count() {
 158   assert(Thread::current()-&gt;is_VM_thread(), &quot;Only VM thread may increment&quot;);
 159   ++_current_jni_active_count;
 160 }
 161 
 162 void SafepointSynchronize::decrement_waiting_to_block() {
 163   assert(_waiting_to_block &gt; 0, &quot;sanity check&quot;);
</pre>
<hr />
<pre>
 233   *p_prev = NULL;
 234 
 235   DEBUG_ONLY(assert_list_is_valid(tss_head, still_running);)
 236 
 237   *initial_running = still_running;
 238 
 239   // If there is no thread still running, we are already done.
 240   if (still_running &lt;= 0) {
 241     assert(tss_head == NULL, &quot;Must be empty&quot;);
 242     return 1;
 243   }
 244 
 245   int iterations = 1; // The first iteration is above.
 246   int64_t start_time = os::javaTimeNanos();
 247 
 248   do {
 249     // Check if this has taken too long:
 250     if (SafepointTimeout &amp;&amp; safepoint_limit_time &lt; os::javaTimeNanos()) {
 251       print_safepoint_timeout();
 252     }







 253 
 254     p_prev = &amp;tss_head;
 255     ThreadSafepointState *cur_tss = tss_head;
 256     while (cur_tss != NULL) {
 257       assert(cur_tss-&gt;is_running(), &quot;Illegal initial state&quot;);
 258       if (thread_not_running(cur_tss)) {
 259         --still_running;
 260         *p_prev = NULL;
 261         ThreadSafepointState *tmp = cur_tss;
 262         cur_tss = cur_tss-&gt;get_next();
 263         tmp-&gt;set_next(NULL);
 264       } else {
 265         *p_prev = cur_tss;
 266         p_prev = cur_tss-&gt;next_ptr();
 267         cur_tss = cur_tss-&gt;get_next();
 268       }
 269     }
 270 
 271     DEBUG_ONLY(assert_list_is_valid(tss_head, still_running);)
 272 
 273     if (still_running &gt; 0) {
 274       back_off(start_time);
 275     }
 276 
 277     iterations++;
 278   } while (still_running &gt; 0);
 279 
 280   assert(tss_head == NULL, &quot;Must be empty&quot;);
 281 
 282   return iterations;
 283 }
 284 
 285 void SafepointSynchronize::arm_safepoint() {
 286   // Begin the process of bringing the system to a safepoint.
 287   // Java threads can be in several different states and are
 288   // stopped by different mechanisms:
 289   //
 290   //  1. Running interpreted
 291   //     When executing branching/returning byte codes interpreter
 292   //     checks if the poll is armed, if so blocks in SS::block().



 293   //  2. Running in native code
 294   //     When returning from the native code, a Java thread must check
 295   //     the safepoint _state to see if we must block.  If the
 296   //     VM thread sees a Java thread in native, it does
 297   //     not wait for this thread to block.  The order of the memory
 298   //     writes and reads of both the safepoint state and the Java
 299   //     threads state is critical.  In order to guarantee that the
 300   //     memory writes are serialized with respect to each other,
 301   //     the VM thread issues a memory barrier instruction.
 302   //  3. Running compiled Code
 303   //     Compiled code reads the local polling page that
 304   //     is set to fault if we are trying to get to a safepoint.
 305   //  4. Blocked
 306   //     A thread which is blocked will not be allowed to return from the
 307   //     block condition until the safepoint operation is complete.
 308   //  5. In VM or Transitioning between states
 309   //     If a Java thread is currently running in the VM or transitioning
 310   //     between states, the safepointing code will poll the thread state
 311   //     until the thread blocks itself when it attempts transitions to a
 312   //     new state or locking a safepoint checked monitor.
 313 
 314   // We must never miss a thread with correct safepoint id, so we must make sure we arm
 315   // the wait barrier for the next safepoint id/counter.
 316   // Arming must be done after resetting _current_jni_active_count, _waiting_to_block.
 317   _wait_barrier-&gt;arm(static_cast&lt;int&gt;(_safepoint_counter + 1));
 318 
 319   assert((_safepoint_counter &amp; 0x1) == 0, &quot;must be even&quot;);
 320   // The store to _safepoint_counter must happen after any stores in arming.
 321   Atomic::release_store(&amp;_safepoint_counter, _safepoint_counter + 1);
 322 
 323   // We are synchronizing
 324   OrderAccess::storestore(); // Ordered with _safepoint_counter
 325   _state = _synchronizing;
 326 
<span class="line-modified"> 327   // Arming the per thread poll while having _state != _not_synchronized means safepointing</span>
<span class="line-modified"> 328   log_trace(safepoint)(&quot;Setting thread local yield flag for threads&quot;);</span>
<span class="line-modified"> 329   OrderAccess::storestore(); // storestore, global state -&gt; local state</span>
<span class="line-modified"> 330   for (JavaThreadIteratorWithHandle jtiwh; JavaThread *cur = jtiwh.next(); ) {</span>
<span class="line-modified"> 331     // Make sure the threads start polling, it is time to yield.</span>
<span class="line-modified"> 332     SafepointMechanism::arm_local_poll(cur);</span>


 333   }
<span class="line-modified"> 334 </span>









 335   OrderAccess::fence(); // storestore|storeload, global state -&gt; local state
 336 }
 337 
 338 // Roll all threads forward to a safepoint and suspend them all
 339 void SafepointSynchronize::begin() {
 340   assert(Thread::current()-&gt;is_VM_thread(), &quot;Only VM thread may execute a safepoint&quot;);
 341 
 342   EventSafepointBegin begin_event;
 343   SafepointTracing::begin(VMThread::vm_op_type());
 344 
 345   Universe::heap()-&gt;safepoint_synchronize_begin();
 346 
 347   // By getting the Threads_lock, we assure that no threads are about to start or
 348   // exit. It is released again in SafepointSynchronize::end().
 349   Threads_lock-&gt;lock();
 350 
 351   assert( _state == _not_synchronized, &quot;trying to safepoint synchronize with wrong state&quot;);
 352 
 353   int nof_threads = Threads::number_of_threads();
 354 
</pre>
<hr />
<pre>
 426 
 427   post_safepoint_begin_event(begin_event, _safepoint_id, nof_threads, _current_jni_active_count);
 428   SafepointTracing::cleanup();
 429 }
 430 
 431 void SafepointSynchronize::disarm_safepoint() {
 432   uint64_t active_safepoint_counter = _safepoint_counter;
 433   {
 434     JavaThreadIteratorWithHandle jtiwh;
 435 #ifdef ASSERT
 436     // A pending_exception cannot be installed during a safepoint.  The threads
 437     // may install an async exception after they come back from a safepoint into
 438     // pending_exception after they unblock.  But that should happen later.
 439     for (; JavaThread *cur = jtiwh.next(); ) {
 440       assert (!(cur-&gt;has_pending_exception() &amp;&amp;
 441                 cur-&gt;safepoint_state()-&gt;is_at_poll_safepoint()),
 442               &quot;safepoint installed a pending exception&quot;);
 443     }
 444 #endif // ASSERT
 445 









 446     OrderAccess::fence(); // keep read and write of _state from floating up
 447     assert(_state == _synchronized, &quot;must be synchronized before ending safepoint synchronization&quot;);
 448 
 449     // Change state first to _not_synchronized.
 450     // No threads should see _synchronized when running.
 451     _state = _not_synchronized;
 452 
 453     // Set the next dormant (even) safepoint id.
 454     assert((_safepoint_counter &amp; 0x1) == 1, &quot;must be odd&quot;);
 455     Atomic::release_store(&amp;_safepoint_counter, _safepoint_counter + 1);
 456 
 457     OrderAccess::fence(); // Keep the local state from floating up.
 458 
 459     jtiwh.rewind();
 460     for (; JavaThread *current = jtiwh.next(); ) {
 461       // Clear the visited flag to ensure that the critical counts are collected properly.
 462       DEBUG_ONLY(current-&gt;reset_visited_for_critical_count(active_safepoint_counter);)
 463       ThreadSafepointState* cur_state = current-&gt;safepoint_state();
 464       assert(!cur_state-&gt;is_running(), &quot;Thread not suspended at safepoint&quot;);
 465       cur_state-&gt;restart(); // TSS _running
 466       assert(cur_state-&gt;is_running(), &quot;safepoint state has not been reset&quot;);


 467     }
 468   } // ~JavaThreadIteratorWithHandle
 469 
 470   // Release threads lock, so threads can be created/destroyed again.
 471   Threads_lock-&gt;unlock();
 472 
 473   // Wake threads after local state is correctly set.
 474   _wait_barrier-&gt;disarm();
 475 }
 476 
 477 // Wake up all threads, so they are ready to resume execution after the safepoint
 478 // operation has been carried out
 479 void SafepointSynchronize::end() {
 480   assert(Threads_lock-&gt;owned_by_self(), &quot;must hold Threads_lock&quot;);
 481   EventSafepointEnd event;
 482   assert(Thread::current()-&gt;is_VM_thread(), &quot;Only VM thread can execute a safepoint&quot;);
 483 
 484   disarm_safepoint();
 485 
 486   Universe::heap()-&gt;safepoint_synchronize_end();
</pre>
<hr />
<pre>
 687 }
 688 
 689 static bool safepoint_safe_with(JavaThread *thread, JavaThreadState state) {
 690   switch(state) {
 691   case _thread_in_native:
 692     // native threads are safe if they have no java stack or have walkable stack
 693     return !thread-&gt;has_last_Java_frame() || thread-&gt;frame_anchor()-&gt;walkable();
 694 
 695   case _thread_blocked:
 696     // On wait_barrier or blocked.
 697     // Blocked threads should already have walkable stack.
 698     assert(!thread-&gt;has_last_Java_frame() || thread-&gt;frame_anchor()-&gt;walkable(), &quot;blocked and not walkable&quot;);
 699     return true;
 700 
 701   default:
 702     return false;
 703   }
 704 }
 705 
 706 bool SafepointSynchronize::handshake_safe(JavaThread *thread) {

 707   if (thread-&gt;is_ext_suspended() || thread-&gt;is_terminated()) {
 708     return true;
 709   }
 710   JavaThreadState stable_state;
 711   if (try_stable_load_state(&amp;stable_state, thread, InactiveSafepointCounter)) {
 712     return safepoint_safe_with(thread, stable_state);
 713   }
 714   return false;
 715 }
 716 
 717 // See if the thread is running inside a lazy critical native and
 718 // update the thread critical count if so.  Also set a suspend flag to
 719 // cause the native wrapper to return into the JVM to do the unlock
 720 // once the native finishes.
 721 static void check_for_lazy_critical_native(JavaThread *thread, JavaThreadState state) {
 722   if (state == _thread_in_native &amp;&amp;
 723       thread-&gt;has_last_Java_frame() &amp;&amp;
 724       thread-&gt;frame_anchor()-&gt;walkable()) {
 725     // This thread might be in a critical native nmethod so look at
 726     // the top of the stack and increment the critical count if it
</pre>
<hr />
<pre>
 828   // async exception is checked in check_special_condition_for_native_trans().
 829 
 830   if (state != _thread_blocked_trans &amp;&amp;
 831       state != _thread_in_vm_trans &amp;&amp;
 832       thread-&gt;has_special_runtime_exit_condition()) {
 833     thread-&gt;handle_special_runtime_exit_condition(
 834       !thread-&gt;is_at_poll_safepoint() &amp;&amp; (state != _thread_in_native_trans));
 835   }
 836 
 837   // cross_modify_fence is done by SafepointMechanism::block_if_requested_slow
 838   // which is the only caller here.
 839 }
 840 
 841 // ------------------------------------------------------------------------------------------------------
 842 // Exception handlers
 843 
 844 
 845 void SafepointSynchronize::handle_polling_page_exception(JavaThread *thread) {
 846   assert(thread-&gt;is_Java_thread(), &quot;polling reference encountered by VM thread&quot;);
 847   assert(thread-&gt;thread_state() == _thread_in_Java, &quot;should come from Java code&quot;);



 848 
 849   if (log_is_enabled(Info, safepoint, stats)) {
 850     Atomic::inc(&amp;_nof_threads_hit_polling_page);
 851   }
 852 
 853   ThreadSafepointState* state = thread-&gt;safepoint_state();
 854 
 855   state-&gt;handle_polling_page_exception();
 856 }
 857 
 858 
 859 void SafepointSynchronize::print_safepoint_timeout() {
 860   if (!timeout_error_printed) {
 861     timeout_error_printed = true;
 862     // Print out the thread info which didn&#39;t reach the safepoint for debugging
 863     // purposes (useful when there are lots of threads in the debugger).
 864     LogTarget(Warning, safepoint) lt;
 865     if (lt.is_enabled()) {
 866       ResourceMark rm;
 867       LogStream ls(lt);
</pre>
<hr />
<pre>
 996 void ThreadSafepointState::restart() {
 997   assert(_safepoint_safe, &quot;Must be safe before unsafe&quot;);
 998   _safepoint_safe = false;
 999 }
1000 
1001 void ThreadSafepointState::print_on(outputStream *st) const {
1002   const char *s = _safepoint_safe ? &quot;_at_safepoint&quot; : &quot;_running&quot;;
1003 
1004   st-&gt;print_cr(&quot;Thread: &quot; INTPTR_FORMAT
1005               &quot;  [0x%2x] State: %s _at_poll_safepoint %d&quot;,
1006                p2i(_thread), _thread-&gt;osthread()-&gt;thread_id(), s, _at_poll_safepoint);
1007 
1008   _thread-&gt;print_thread_state_on(st);
1009 }
1010 
1011 // ---------------------------------------------------------------------------------------------------------------------
1012 
1013 // Block the thread at poll or poll return for safepoint/handshake.
1014 void ThreadSafepointState::handle_polling_page_exception() {
1015 





1016   // Step 1: Find the nmethod from the return address
1017   address real_return_addr = thread()-&gt;saved_exception_pc();
1018 
1019   CodeBlob *cb = CodeCache::find_blob(real_return_addr);
1020   assert(cb != NULL &amp;&amp; cb-&gt;is_compiled(), &quot;return address should be in nmethod&quot;);
1021   CompiledMethod* nm = (CompiledMethod*)cb;
1022 
1023   // Find frame of caller
1024   frame stub_fr = thread()-&gt;last_frame();
1025   CodeBlob* stub_cb = stub_fr.cb();
1026   assert(stub_cb-&gt;is_safepoint_stub(), &quot;must be a safepoint stub&quot;);
1027   RegisterMap map(thread(), true);
1028   frame caller_fr = stub_fr.sender(&amp;map);
1029 
1030   // Should only be poll_return or poll
1031   assert( nm-&gt;is_at_poll_or_poll_return(real_return_addr), &quot;should not be at call&quot; );
1032 
1033   // This is a poll immediately before a return. The exception handling code
1034   // has already had the effect of causing the return to occur, so the execution
1035   // will continue immediately after the call. In addition, the oopmap at the
</pre>
</td>
</tr>
</table>
<center><a href="biasedLocking.cpp.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="synchronizer.cpp.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>