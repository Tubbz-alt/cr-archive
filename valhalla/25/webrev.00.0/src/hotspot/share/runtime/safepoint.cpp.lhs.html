<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames src/hotspot/share/runtime/safepoint.cpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
    <script type="text/javascript" src="../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>   1 /*
<a name="1" id="anc1"></a><span class="line-modified">   2  * Copyright (c) 1997, 2019, Oracle and/or its affiliates. All rights reserved.</span>
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.
   8  *
   9  * This code is distributed in the hope that it will be useful, but WITHOUT
  10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  *
  23  */
  24 
  25 #include &quot;precompiled.hpp&quot;
  26 #include &quot;classfile/classLoaderDataGraph.inline.hpp&quot;
  27 #include &quot;classfile/dictionary.hpp&quot;
  28 #include &quot;classfile/stringTable.hpp&quot;
  29 #include &quot;classfile/symbolTable.hpp&quot;
  30 #include &quot;classfile/systemDictionary.hpp&quot;
  31 #include &quot;code/codeCache.hpp&quot;
  32 #include &quot;code/icBuffer.hpp&quot;
  33 #include &quot;code/nmethod.hpp&quot;
  34 #include &quot;code/pcDesc.hpp&quot;
  35 #include &quot;code/scopeDesc.hpp&quot;
  36 #include &quot;compiler/compilationPolicy.hpp&quot;
  37 #include &quot;gc/shared/collectedHeap.hpp&quot;
  38 #include &quot;gc/shared/gcLocker.hpp&quot;
  39 #include &quot;gc/shared/oopStorage.hpp&quot;
  40 #include &quot;gc/shared/strongRootsScope.hpp&quot;
  41 #include &quot;gc/shared/workgroup.hpp&quot;
  42 #include &quot;interpreter/interpreter.hpp&quot;
  43 #include &quot;jfr/jfrEvents.hpp&quot;
  44 #include &quot;logging/log.hpp&quot;
  45 #include &quot;logging/logStream.hpp&quot;
  46 #include &quot;memory/resourceArea.hpp&quot;
  47 #include &quot;memory/universe.hpp&quot;
  48 #include &quot;oops/oop.inline.hpp&quot;
  49 #include &quot;oops/symbol.hpp&quot;
  50 #include &quot;oops/valueKlass.hpp&quot;
  51 #include &quot;runtime/atomic.hpp&quot;
  52 #include &quot;runtime/deoptimization.hpp&quot;
  53 #include &quot;runtime/frame.inline.hpp&quot;
  54 #include &quot;runtime/handles.inline.hpp&quot;
  55 #include &quot;runtime/interfaceSupport.inline.hpp&quot;
  56 #include &quot;runtime/mutexLocker.hpp&quot;
  57 #include &quot;runtime/orderAccess.hpp&quot;
  58 #include &quot;runtime/osThread.hpp&quot;
  59 #include &quot;runtime/safepoint.hpp&quot;
  60 #include &quot;runtime/safepointMechanism.inline.hpp&quot;
  61 #include &quot;runtime/signature.hpp&quot;
  62 #include &quot;runtime/stubCodeGenerator.hpp&quot;
  63 #include &quot;runtime/stubRoutines.hpp&quot;
  64 #include &quot;runtime/sweeper.hpp&quot;
  65 #include &quot;runtime/synchronizer.hpp&quot;
  66 #include &quot;runtime/thread.inline.hpp&quot;
  67 #include &quot;runtime/threadSMR.hpp&quot;
  68 #include &quot;runtime/timerTrace.hpp&quot;
  69 #include &quot;services/runtimeService.hpp&quot;
  70 #include &quot;utilities/events.hpp&quot;
  71 #include &quot;utilities/macros.hpp&quot;
  72 
  73 static void post_safepoint_begin_event(EventSafepointBegin&amp; event,
  74                                        uint64_t safepoint_id,
  75                                        int thread_count,
  76                                        int critical_thread_count) {
  77   if (event.should_commit()) {
  78     event.set_safepointId(safepoint_id);
  79     event.set_totalThreadCount(thread_count);
  80     event.set_jniCriticalThreadCount(critical_thread_count);
  81     event.commit();
  82   }
  83 }
  84 
  85 static void post_safepoint_cleanup_event(EventSafepointCleanup&amp; event, uint64_t safepoint_id) {
  86   if (event.should_commit()) {
  87     event.set_safepointId(safepoint_id);
  88     event.commit();
  89   }
  90 }
  91 
  92 static void post_safepoint_synchronize_event(EventSafepointStateSynchronization&amp; event,
  93                                              uint64_t safepoint_id,
  94                                              int initial_number_of_threads,
  95                                              int threads_waiting_to_block,
  96                                              uint64_t iterations) {
  97   if (event.should_commit()) {
  98     event.set_safepointId(safepoint_id);
  99     event.set_initialThreadCount(initial_number_of_threads);
 100     event.set_runningThreadCount(threads_waiting_to_block);
 101     event.set_iterations(iterations);
 102     event.commit();
 103   }
 104 }
 105 
 106 static void post_safepoint_cleanup_task_event(EventSafepointCleanupTask&amp; event,
 107                                               uint64_t safepoint_id,
 108                                               const char* name) {
 109   if (event.should_commit()) {
 110     event.set_safepointId(safepoint_id);
 111     event.set_name(name);
 112     event.commit();
 113   }
 114 }
 115 
 116 static void post_safepoint_end_event(EventSafepointEnd&amp; event, uint64_t safepoint_id) {
 117   if (event.should_commit()) {
 118     event.set_safepointId(safepoint_id);
 119     event.commit();
 120   }
 121 }
 122 
 123 // SafepointCheck
 124 SafepointStateTracker::SafepointStateTracker(uint64_t safepoint_id, bool at_safepoint)
 125   : _safepoint_id(safepoint_id), _at_safepoint(at_safepoint) {}
 126 
 127 bool SafepointStateTracker::safepoint_state_changed() {
 128   return _safepoint_id != SafepointSynchronize::safepoint_id() ||
 129     _at_safepoint != SafepointSynchronize::is_at_safepoint();
 130 }
 131 
 132 // --------------------------------------------------------------------------------------------------
 133 // Implementation of Safepoint begin/end
 134 
 135 SafepointSynchronize::SynchronizeState volatile SafepointSynchronize::_state = SafepointSynchronize::_not_synchronized;
 136 int SafepointSynchronize::_waiting_to_block = 0;
 137 volatile uint64_t SafepointSynchronize::_safepoint_counter = 0;
 138 uint64_t SafepointSynchronize::_safepoint_id = 0;
 139 const uint64_t SafepointSynchronize::InactiveSafepointCounter = 0;
 140 int SafepointSynchronize::_current_jni_active_count = 0;
 141 
 142 WaitBarrier* SafepointSynchronize::_wait_barrier;
 143 
<a name="2" id="anc2"></a><span class="line-removed"> 144 static volatile bool PageArmed = false;        // safepoint polling page is RO|RW vs PROT_NONE</span>
 145 static bool timeout_error_printed = false;
 146 
 147 // Statistic related
 148 static jlong _safepoint_begin_time = 0;
 149 static volatile int _nof_threads_hit_polling_page = 0;
 150 
 151 void SafepointSynchronize::init(Thread* vmthread) {
 152   // WaitBarrier should never be destroyed since we will have
 153   // threads waiting on it while exiting.
 154   _wait_barrier = new WaitBarrier(vmthread);
 155   SafepointTracing::init();
 156 }
 157 
 158 void SafepointSynchronize::increment_jni_active_count() {
 159   assert(Thread::current()-&gt;is_VM_thread(), &quot;Only VM thread may increment&quot;);
 160   ++_current_jni_active_count;
 161 }
 162 
 163 void SafepointSynchronize::decrement_waiting_to_block() {
 164   assert(_waiting_to_block &gt; 0, &quot;sanity check&quot;);
 165   assert(Thread::current()-&gt;is_VM_thread(), &quot;Only VM thread may decrement&quot;);
 166   --_waiting_to_block;
 167 }
 168 
 169 bool SafepointSynchronize::thread_not_running(ThreadSafepointState *cur_state) {
 170   if (!cur_state-&gt;is_running()) {
 171     return true;
 172   }
 173   cur_state-&gt;examine_state_of_thread(SafepointSynchronize::safepoint_counter());
 174   if (!cur_state-&gt;is_running()) {
 175     return true;
 176   }
 177   LogTarget(Trace, safepoint) lt;
 178   if (lt.is_enabled()) {
 179     ResourceMark rm;
 180     LogStream ls(lt);
 181     cur_state-&gt;print_on(&amp;ls);
 182   }
 183   return false;
 184 }
 185 
 186 #ifdef ASSERT
 187 static void assert_list_is_valid(const ThreadSafepointState* tss_head, int still_running) {
 188   int a = 0;
 189   const ThreadSafepointState *tmp_tss = tss_head;
 190   while (tmp_tss != NULL) {
 191     ++a;
 192     assert(tmp_tss-&gt;is_running(), &quot;Illegal initial state&quot;);
 193     tmp_tss = tmp_tss-&gt;get_next();
 194   }
 195   assert(a == still_running, &quot;Must be the same&quot;);
 196 }
 197 #endif // ASSERT
 198 
 199 static void back_off(int64_t start_time) {
 200   // We start with fine-grained nanosleeping until a millisecond has
 201   // passed, at which point we resort to plain naked_short_sleep.
 202   if (os::javaTimeNanos() - start_time &lt; NANOSECS_PER_MILLISEC) {
 203     os::naked_short_nanosleep(10 * (NANOUNITS / MICROUNITS));
 204   } else {
 205     os::naked_short_sleep(1);
 206   }
 207 }
 208 
 209 int SafepointSynchronize::synchronize_threads(jlong safepoint_limit_time, int nof_threads, int* initial_running)
 210 {
 211   JavaThreadIteratorWithHandle jtiwh;
 212 
 213 #ifdef ASSERT
 214   for (; JavaThread *cur = jtiwh.next(); ) {
 215     assert(cur-&gt;safepoint_state()-&gt;is_running(), &quot;Illegal initial state&quot;);
 216   }
 217   jtiwh.rewind();
 218 #endif // ASSERT
 219 
 220   // Iterate through all threads until it has been determined how to stop them all at a safepoint.
 221   int still_running = nof_threads;
 222   ThreadSafepointState *tss_head = NULL;
 223   ThreadSafepointState **p_prev = &amp;tss_head;
 224   for (; JavaThread *cur = jtiwh.next(); ) {
 225     ThreadSafepointState *cur_tss = cur-&gt;safepoint_state();
 226     assert(cur_tss-&gt;get_next() == NULL, &quot;Must be NULL&quot;);
 227     if (thread_not_running(cur_tss)) {
 228       --still_running;
 229     } else {
 230       *p_prev = cur_tss;
 231       p_prev = cur_tss-&gt;next_ptr();
 232     }
 233   }
 234   *p_prev = NULL;
 235 
 236   DEBUG_ONLY(assert_list_is_valid(tss_head, still_running);)
 237 
 238   *initial_running = still_running;
 239 
 240   // If there is no thread still running, we are already done.
 241   if (still_running &lt;= 0) {
 242     assert(tss_head == NULL, &quot;Must be empty&quot;);
 243     return 1;
 244   }
 245 
 246   int iterations = 1; // The first iteration is above.
 247   int64_t start_time = os::javaTimeNanos();
 248 
 249   do {
 250     // Check if this has taken too long:
 251     if (SafepointTimeout &amp;&amp; safepoint_limit_time &lt; os::javaTimeNanos()) {
 252       print_safepoint_timeout();
 253     }
<a name="3" id="anc3"></a><span class="line-removed"> 254     if (int(iterations) == -1) { // overflow - something is wrong.</span>
<span class="line-removed"> 255       // We can only overflow here when we are using global</span>
<span class="line-removed"> 256       // polling pages. We keep this guarantee in its original</span>
<span class="line-removed"> 257       // form so that searches of the bug database for this</span>
<span class="line-removed"> 258       // failure mode find the right bugs.</span>
<span class="line-removed"> 259       guarantee (!PageArmed, &quot;invariant&quot;);</span>
<span class="line-removed"> 260     }</span>
 261 
 262     p_prev = &amp;tss_head;
 263     ThreadSafepointState *cur_tss = tss_head;
 264     while (cur_tss != NULL) {
 265       assert(cur_tss-&gt;is_running(), &quot;Illegal initial state&quot;);
 266       if (thread_not_running(cur_tss)) {
 267         --still_running;
 268         *p_prev = NULL;
 269         ThreadSafepointState *tmp = cur_tss;
 270         cur_tss = cur_tss-&gt;get_next();
 271         tmp-&gt;set_next(NULL);
 272       } else {
 273         *p_prev = cur_tss;
 274         p_prev = cur_tss-&gt;next_ptr();
 275         cur_tss = cur_tss-&gt;get_next();
 276       }
 277     }
 278 
 279     DEBUG_ONLY(assert_list_is_valid(tss_head, still_running);)
 280 
 281     if (still_running &gt; 0) {
 282       back_off(start_time);
 283     }
 284 
 285     iterations++;
 286   } while (still_running &gt; 0);
 287 
 288   assert(tss_head == NULL, &quot;Must be empty&quot;);
 289 
 290   return iterations;
 291 }
 292 
 293 void SafepointSynchronize::arm_safepoint() {
 294   // Begin the process of bringing the system to a safepoint.
 295   // Java threads can be in several different states and are
 296   // stopped by different mechanisms:
 297   //
 298   //  1. Running interpreted
 299   //     When executing branching/returning byte codes interpreter
 300   //     checks if the poll is armed, if so blocks in SS::block().
<a name="4" id="anc4"></a><span class="line-removed"> 301   //     When using global polling the interpreter dispatch table</span>
<span class="line-removed"> 302   //     is changed to force it to check for a safepoint condition</span>
<span class="line-removed"> 303   //     between bytecodes.</span>
 304   //  2. Running in native code
 305   //     When returning from the native code, a Java thread must check
 306   //     the safepoint _state to see if we must block.  If the
 307   //     VM thread sees a Java thread in native, it does
 308   //     not wait for this thread to block.  The order of the memory
 309   //     writes and reads of both the safepoint state and the Java
 310   //     threads state is critical.  In order to guarantee that the
 311   //     memory writes are serialized with respect to each other,
 312   //     the VM thread issues a memory barrier instruction.
 313   //  3. Running compiled Code
 314   //     Compiled code reads the local polling page that
 315   //     is set to fault if we are trying to get to a safepoint.
 316   //  4. Blocked
 317   //     A thread which is blocked will not be allowed to return from the
 318   //     block condition until the safepoint operation is complete.
 319   //  5. In VM or Transitioning between states
 320   //     If a Java thread is currently running in the VM or transitioning
 321   //     between states, the safepointing code will poll the thread state
 322   //     until the thread blocks itself when it attempts transitions to a
 323   //     new state or locking a safepoint checked monitor.
 324 
 325   // We must never miss a thread with correct safepoint id, so we must make sure we arm
 326   // the wait barrier for the next safepoint id/counter.
 327   // Arming must be done after resetting _current_jni_active_count, _waiting_to_block.
 328   _wait_barrier-&gt;arm(static_cast&lt;int&gt;(_safepoint_counter + 1));
 329 
 330   assert((_safepoint_counter &amp; 0x1) == 0, &quot;must be even&quot;);
 331   // The store to _safepoint_counter must happen after any stores in arming.
 332   Atomic::release_store(&amp;_safepoint_counter, _safepoint_counter + 1);
 333 
 334   // We are synchronizing
 335   OrderAccess::storestore(); // Ordered with _safepoint_counter
 336   _state = _synchronizing;
 337 
<a name="5" id="anc5"></a><span class="line-modified"> 338   if (SafepointMechanism::uses_thread_local_poll()) {</span>
<span class="line-modified"> 339     // Arming the per thread poll while having _state != _not_synchronized means safepointing</span>
<span class="line-modified"> 340     log_trace(safepoint)(&quot;Setting thread local yield flag for threads&quot;);</span>
<span class="line-modified"> 341     OrderAccess::storestore(); // storestore, global state -&gt; local state</span>
<span class="line-modified"> 342     for (JavaThreadIteratorWithHandle jtiwh; JavaThread *cur = jtiwh.next(); ) {</span>
<span class="line-modified"> 343       // Make sure the threads start polling, it is time to yield.</span>
<span class="line-removed"> 344       SafepointMechanism::arm_local_poll(cur);</span>
<span class="line-removed"> 345     }</span>
 346   }
<a name="6" id="anc6"></a><span class="line-modified"> 347   OrderAccess::fence(); // storestore|storeload, global state -&gt; local state</span>
<span class="line-removed"> 348 </span>
<span class="line-removed"> 349   if (SafepointMechanism::uses_global_page_poll()) {</span>
<span class="line-removed"> 350     // Make interpreter safepoint aware</span>
<span class="line-removed"> 351     Interpreter::notice_safepoints();</span>
<span class="line-removed"> 352 </span>
<span class="line-removed"> 353     // Make polling safepoint aware</span>
<span class="line-removed"> 354     guarantee (!PageArmed, &quot;invariant&quot;) ;</span>
<span class="line-removed"> 355     PageArmed = true;</span>
<span class="line-removed"> 356     os::make_polling_page_unreadable();</span>
 357   }
 358 }
 359 
 360 // Roll all threads forward to a safepoint and suspend them all
 361 void SafepointSynchronize::begin() {
 362   assert(Thread::current()-&gt;is_VM_thread(), &quot;Only VM thread may execute a safepoint&quot;);
 363 
 364   EventSafepointBegin begin_event;
 365   SafepointTracing::begin(VMThread::vm_op_type());
 366 
 367   Universe::heap()-&gt;safepoint_synchronize_begin();
 368 
 369   // By getting the Threads_lock, we assure that no threads are about to start or
 370   // exit. It is released again in SafepointSynchronize::end().
 371   Threads_lock-&gt;lock();
 372 
 373   assert( _state == _not_synchronized, &quot;trying to safepoint synchronize with wrong state&quot;);
 374 
 375   int nof_threads = Threads::number_of_threads();
 376 
 377   _nof_threads_hit_polling_page = 0;
 378 
 379   log_debug(safepoint)(&quot;Safepoint synchronization initiated using %s wait barrier. (%d threads)&quot;, _wait_barrier-&gt;description(), nof_threads);
 380 
 381   // Reset the count of active JNI critical threads
 382   _current_jni_active_count = 0;
 383 
 384   // Set number of threads to wait for
 385   _waiting_to_block = nof_threads;
 386 
 387   jlong safepoint_limit_time = 0;
 388   if (SafepointTimeout) {
 389     // Set the limit time, so that it can be compared to see if this has taken
 390     // too long to complete.
 391     safepoint_limit_time = SafepointTracing::start_of_safepoint() + (jlong)SafepointTimeoutDelay * (NANOUNITS / MILLIUNITS);
 392     timeout_error_printed = false;
 393   }
 394 
 395   EventSafepointStateSynchronization sync_event;
 396   int initial_running = 0;
 397 
 398   // Arms the safepoint, _current_jni_active_count and _waiting_to_block must be set before.
 399   arm_safepoint();
 400 
 401   // Will spin until all threads are safe.
 402   int iterations = synchronize_threads(safepoint_limit_time, nof_threads, &amp;initial_running);
 403   assert(_waiting_to_block == 0, &quot;No thread should be running&quot;);
 404 
 405 #ifndef PRODUCT
 406   if (safepoint_limit_time != 0) {
 407     jlong current_time = os::javaTimeNanos();
 408     if (safepoint_limit_time &lt; current_time) {
 409       log_warning(safepoint)(&quot;# SafepointSynchronize: Finished after &quot;
 410                     INT64_FORMAT_W(6) &quot; ms&quot;,
 411                     (int64_t)(current_time - SafepointTracing::start_of_safepoint()) / (NANOUNITS / MILLIUNITS));
 412     }
 413   }
 414 #endif
 415 
 416   assert(Threads_lock-&gt;owned_by_self(), &quot;must hold Threads_lock&quot;);
 417 
 418   // Record state
 419   _state = _synchronized;
 420 
 421   OrderAccess::fence();
 422 
 423   // Set the new id
 424   ++_safepoint_id;
 425 
 426 #ifdef ASSERT
 427   // Make sure all the threads were visited.
 428   for (JavaThreadIteratorWithHandle jtiwh; JavaThread *cur = jtiwh.next(); ) {
 429     assert(cur-&gt;was_visited_for_critical_count(_safepoint_counter), &quot;missed a thread&quot;);
 430   }
 431 #endif // ASSERT
 432 
 433   // Update the count of active JNI critical regions
 434   GCLocker::set_jni_lock_count(_current_jni_active_count);
 435 
 436   post_safepoint_synchronize_event(sync_event,
 437                                    _safepoint_id,
 438                                    initial_running,
 439                                    _waiting_to_block, iterations);
 440 
 441   SafepointTracing::synchronized(nof_threads, initial_running, _nof_threads_hit_polling_page);
 442 
 443   // We do the safepoint cleanup first since a GC related safepoint
 444   // needs cleanup to be completed before running the GC op.
 445   EventSafepointCleanup cleanup_event;
 446   do_cleanup_tasks();
 447   post_safepoint_cleanup_event(cleanup_event, _safepoint_id);
 448 
 449   post_safepoint_begin_event(begin_event, _safepoint_id, nof_threads, _current_jni_active_count);
 450   SafepointTracing::cleanup();
 451 }
 452 
 453 void SafepointSynchronize::disarm_safepoint() {
 454   uint64_t active_safepoint_counter = _safepoint_counter;
 455   {
 456     JavaThreadIteratorWithHandle jtiwh;
 457 #ifdef ASSERT
 458     // A pending_exception cannot be installed during a safepoint.  The threads
 459     // may install an async exception after they come back from a safepoint into
 460     // pending_exception after they unblock.  But that should happen later.
 461     for (; JavaThread *cur = jtiwh.next(); ) {
 462       assert (!(cur-&gt;has_pending_exception() &amp;&amp;
 463                 cur-&gt;safepoint_state()-&gt;is_at_poll_safepoint()),
 464               &quot;safepoint installed a pending exception&quot;);
 465     }
 466 #endif // ASSERT
 467 
<a name="7" id="anc7"></a><span class="line-removed"> 468     if (SafepointMechanism::uses_global_page_poll()) {</span>
<span class="line-removed"> 469       guarantee (PageArmed, &quot;invariant&quot;);</span>
<span class="line-removed"> 470       // Make polling safepoint aware</span>
<span class="line-removed"> 471       os::make_polling_page_readable();</span>
<span class="line-removed"> 472       PageArmed = false;</span>
<span class="line-removed"> 473       // Remove safepoint check from interpreter</span>
<span class="line-removed"> 474       Interpreter::ignore_safepoints();</span>
<span class="line-removed"> 475     }</span>
<span class="line-removed"> 476 </span>
 477     OrderAccess::fence(); // keep read and write of _state from floating up
 478     assert(_state == _synchronized, &quot;must be synchronized before ending safepoint synchronization&quot;);
 479 
 480     // Change state first to _not_synchronized.
 481     // No threads should see _synchronized when running.
 482     _state = _not_synchronized;
 483 
 484     // Set the next dormant (even) safepoint id.
 485     assert((_safepoint_counter &amp; 0x1) == 1, &quot;must be odd&quot;);
 486     Atomic::release_store(&amp;_safepoint_counter, _safepoint_counter + 1);
 487 
 488     OrderAccess::fence(); // Keep the local state from floating up.
 489 
 490     jtiwh.rewind();
 491     for (; JavaThread *current = jtiwh.next(); ) {
 492       // Clear the visited flag to ensure that the critical counts are collected properly.
 493       DEBUG_ONLY(current-&gt;reset_visited_for_critical_count(active_safepoint_counter);)
 494       ThreadSafepointState* cur_state = current-&gt;safepoint_state();
 495       assert(!cur_state-&gt;is_running(), &quot;Thread not suspended at safepoint&quot;);
 496       cur_state-&gt;restart(); // TSS _running
 497       assert(cur_state-&gt;is_running(), &quot;safepoint state has not been reset&quot;);
<a name="8" id="anc8"></a><span class="line-removed"> 498 </span>
<span class="line-removed"> 499       SafepointMechanism::disarm_if_needed(current, false /* NO release */);</span>
 500     }
 501   } // ~JavaThreadIteratorWithHandle
 502 
 503   // Release threads lock, so threads can be created/destroyed again.
 504   Threads_lock-&gt;unlock();
 505 
 506   // Wake threads after local state is correctly set.
 507   _wait_barrier-&gt;disarm();
 508 }
 509 
 510 // Wake up all threads, so they are ready to resume execution after the safepoint
 511 // operation has been carried out
 512 void SafepointSynchronize::end() {
 513   assert(Threads_lock-&gt;owned_by_self(), &quot;must hold Threads_lock&quot;);
 514   EventSafepointEnd event;
 515   assert(Thread::current()-&gt;is_VM_thread(), &quot;Only VM thread can execute a safepoint&quot;);
 516 
 517   disarm_safepoint();
 518 
 519   Universe::heap()-&gt;safepoint_synchronize_end();
 520 
 521   SafepointTracing::end();
 522 
 523   post_safepoint_end_event(event, safepoint_id());
 524 }
 525 
 526 bool SafepointSynchronize::is_cleanup_needed() {
 527   // Need a safepoint if there are many monitors to deflate.
 528   if (ObjectSynchronizer::is_cleanup_needed()) return true;
 529   // Need a safepoint if some inline cache buffers is non-empty
 530   if (!InlineCacheBuffer::is_empty()) return true;
 531   if (StringTable::needs_rehashing()) return true;
 532   if (SymbolTable::needs_rehashing()) return true;
 533   return false;
 534 }
 535 
 536 bool SafepointSynchronize::is_forced_cleanup_needed() {
 537   return ObjectSynchronizer::needs_monitor_scavenge();
 538 }
 539 
 540 class ParallelSPCleanupThreadClosure : public ThreadClosure {
 541 private:
 542   CodeBlobClosure* _nmethod_cl;
 543   DeflateMonitorCounters* _counters;
 544 
 545 public:
 546   ParallelSPCleanupThreadClosure(DeflateMonitorCounters* counters) :
 547     _nmethod_cl(UseCodeAging ? NMethodSweeper::prepare_reset_hotness_counters() : NULL),
 548     _counters(counters) {}
 549 
 550   void do_thread(Thread* thread) {
 551     ObjectSynchronizer::deflate_thread_local_monitors(thread, _counters);
 552     if (_nmethod_cl != NULL &amp;&amp; thread-&gt;is_Java_thread() &amp;&amp;
 553         ! thread-&gt;is_Code_cache_sweeper_thread()) {
 554       JavaThread* jt = (JavaThread*) thread;
 555       jt-&gt;nmethods_do(_nmethod_cl);
 556     }
 557   }
 558 };
 559 
 560 class ParallelSPCleanupTask : public AbstractGangTask {
 561 private:
 562   SubTasksDone _subtasks;
 563   ParallelSPCleanupThreadClosure _cleanup_threads_cl;
 564   uint _num_workers;
 565   DeflateMonitorCounters* _counters;
 566 public:
 567   ParallelSPCleanupTask(uint num_workers, DeflateMonitorCounters* counters) :
 568     AbstractGangTask(&quot;Parallel Safepoint Cleanup&quot;),
 569     _subtasks(SubTasksDone(SafepointSynchronize::SAFEPOINT_CLEANUP_NUM_TASKS)),
 570     _cleanup_threads_cl(ParallelSPCleanupThreadClosure(counters)),
 571     _num_workers(num_workers),
 572     _counters(counters) {}
 573 
 574   void work(uint worker_id) {
 575     uint64_t safepoint_id = SafepointSynchronize::safepoint_id();
 576     // All threads deflate monitors and mark nmethods (if necessary).
 577     Threads::possibly_parallel_threads_do(true, &amp;_cleanup_threads_cl);
 578 
 579     if (_subtasks.try_claim_task(SafepointSynchronize::SAFEPOINT_CLEANUP_DEFLATE_MONITORS)) {
 580       const char* name = &quot;deflating global idle monitors&quot;;
 581       EventSafepointCleanupTask event;
 582       TraceTime timer(name, TRACETIME_LOG(Info, safepoint, cleanup));
 583       ObjectSynchronizer::deflate_idle_monitors(_counters);
 584 
 585       post_safepoint_cleanup_task_event(event, safepoint_id, name);
 586     }
 587 
 588     if (_subtasks.try_claim_task(SafepointSynchronize::SAFEPOINT_CLEANUP_UPDATE_INLINE_CACHES)) {
 589       const char* name = &quot;updating inline caches&quot;;
 590       EventSafepointCleanupTask event;
 591       TraceTime timer(name, TRACETIME_LOG(Info, safepoint, cleanup));
 592       InlineCacheBuffer::update_inline_caches();
 593 
 594       post_safepoint_cleanup_task_event(event, safepoint_id, name);
 595     }
 596 
 597     if (_subtasks.try_claim_task(SafepointSynchronize::SAFEPOINT_CLEANUP_COMPILATION_POLICY)) {
 598       const char* name = &quot;compilation policy safepoint handler&quot;;
 599       EventSafepointCleanupTask event;
 600       TraceTime timer(name, TRACETIME_LOG(Info, safepoint, cleanup));
 601       CompilationPolicy::policy()-&gt;do_safepoint_work();
 602 
 603       post_safepoint_cleanup_task_event(event, safepoint_id, name);
 604     }
 605 
 606     if (_subtasks.try_claim_task(SafepointSynchronize::SAFEPOINT_CLEANUP_SYMBOL_TABLE_REHASH)) {
 607       if (SymbolTable::needs_rehashing()) {
 608         const char* name = &quot;rehashing symbol table&quot;;
 609         EventSafepointCleanupTask event;
 610         TraceTime timer(name, TRACETIME_LOG(Info, safepoint, cleanup));
 611         SymbolTable::rehash_table();
 612 
 613         post_safepoint_cleanup_task_event(event, safepoint_id, name);
 614       }
 615     }
 616 
 617     if (_subtasks.try_claim_task(SafepointSynchronize::SAFEPOINT_CLEANUP_STRING_TABLE_REHASH)) {
 618       if (StringTable::needs_rehashing()) {
 619         const char* name = &quot;rehashing string table&quot;;
 620         EventSafepointCleanupTask event;
 621         TraceTime timer(name, TRACETIME_LOG(Info, safepoint, cleanup));
 622         StringTable::rehash_table();
 623 
 624         post_safepoint_cleanup_task_event(event, safepoint_id, name);
 625       }
 626     }
 627 
 628     if (_subtasks.try_claim_task(SafepointSynchronize::SAFEPOINT_CLEANUP_SYSTEM_DICTIONARY_RESIZE)) {
 629       if (Dictionary::does_any_dictionary_needs_resizing()) {
 630         const char* name = &quot;resizing system dictionaries&quot;;
 631         EventSafepointCleanupTask event;
 632         TraceTime timer(name, TRACETIME_LOG(Info, safepoint, cleanup));
 633         ClassLoaderDataGraph::resize_dictionaries();
 634 
 635         post_safepoint_cleanup_task_event(event, safepoint_id, name);
 636       }
 637     }
 638 
 639     if (_subtasks.try_claim_task(SafepointSynchronize::SAFEPOINT_CLEANUP_REQUEST_OOPSTORAGE_CLEANUP)) {
 640       // Don&#39;t bother reporting event or time for this very short operation.
 641       // To have any utility we&#39;d also want to report whether needed.
 642       OopStorage::trigger_cleanup_if_needed();
 643     }
 644 
 645     _subtasks.all_tasks_completed(_num_workers);
 646   }
 647 };
 648 
 649 // Various cleaning tasks that should be done periodically at safepoints.
 650 void SafepointSynchronize::do_cleanup_tasks() {
 651 
 652   TraceTime timer(&quot;safepoint cleanup tasks&quot;, TRACETIME_LOG(Info, safepoint, cleanup));
 653 
 654   // Prepare for monitor deflation.
 655   DeflateMonitorCounters deflate_counters;
 656   ObjectSynchronizer::prepare_deflate_idle_monitors(&amp;deflate_counters);
 657 
 658   CollectedHeap* heap = Universe::heap();
 659   assert(heap != NULL, &quot;heap not initialized yet?&quot;);
 660   WorkGang* cleanup_workers = heap-&gt;get_safepoint_workers();
 661   if (cleanup_workers != NULL) {
 662     // Parallel cleanup using GC provided thread pool.
 663     uint num_cleanup_workers = cleanup_workers-&gt;active_workers();
 664     ParallelSPCleanupTask cleanup(num_cleanup_workers, &amp;deflate_counters);
 665     StrongRootsScope srs(num_cleanup_workers);
 666     cleanup_workers-&gt;run_task(&amp;cleanup);
 667   } else {
 668     // Serial cleanup using VMThread.
 669     ParallelSPCleanupTask cleanup(1, &amp;deflate_counters);
 670     StrongRootsScope srs(1);
 671     cleanup.work(0);
 672   }
 673 
 674   // Needs to be done single threaded by the VMThread.  This walks
 675   // the thread stacks looking for references to metadata before
 676   // deciding to remove it from the metaspaces.
 677   if (ClassLoaderDataGraph::should_clean_metaspaces_and_reset()) {
 678     const char* name = &quot;cleanup live ClassLoaderData metaspaces&quot;;
 679     TraceTime timer(name, TRACETIME_LOG(Info, safepoint, cleanup));
 680     ClassLoaderDataGraph::walk_metadata_and_clean_metaspaces();
 681   }
 682 
 683   // Finish monitor deflation.
 684   ObjectSynchronizer::finish_deflate_idle_monitors(&amp;deflate_counters);
 685 
 686   assert(InlineCacheBuffer::is_empty(), &quot;should have cleaned up ICBuffer&quot;);
 687 }
 688 
 689 // Methods for determining if a JavaThread is safepoint safe.
 690 
 691 // False means unsafe with undetermined state.
 692 // True means a determined state, but it may be an unsafe state.
 693 // If called from a non-safepoint context safepoint_count MUST be InactiveSafepointCounter.
 694 bool SafepointSynchronize::try_stable_load_state(JavaThreadState *state, JavaThread *thread, uint64_t safepoint_count) {
 695   assert((safepoint_count != InactiveSafepointCounter &amp;&amp;
 696           Thread::current() == (Thread*)VMThread::vm_thread() &amp;&amp;
 697           SafepointSynchronize::_state != _not_synchronized)
 698          || safepoint_count == InactiveSafepointCounter, &quot;Invalid check&quot;);
 699 
 700   // To handle the thread_blocked state on the backedge of the WaitBarrier from
 701   // previous safepoint and reading the reset value (0/InactiveSafepointCounter) we
 702   // re-read state after we read thread safepoint id. The JavaThread changes its
 703   // thread state from thread_blocked before resetting safepoint id to 0.
 704   // This guarantees the second read will be from an updated thread state. It can
 705   // either be different state making this an unsafe state or it can see blocked
 706   // again. When we see blocked twice with a 0 safepoint id, either:
 707   // - It is normally blocked, e.g. on Mutex, TBIVM.
 708   // - It was in SS:block(), looped around to SS:block() and is blocked on the WaitBarrier.
 709   // - It was in SS:block() but now on a Mutex.
 710   // All of these cases are safe.
 711 
 712   *state = thread-&gt;thread_state();
 713   OrderAccess::loadload();
 714   uint64_t sid = thread-&gt;safepoint_state()-&gt;get_safepoint_id();  // Load acquire
 715   if (sid != InactiveSafepointCounter &amp;&amp; sid != safepoint_count) {
 716     // In an old safepoint, state not relevant.
 717     return false;
 718   }
 719   return *state == thread-&gt;thread_state();
 720 }
 721 
 722 static bool safepoint_safe_with(JavaThread *thread, JavaThreadState state) {
 723   switch(state) {
 724   case _thread_in_native:
 725     // native threads are safe if they have no java stack or have walkable stack
 726     return !thread-&gt;has_last_Java_frame() || thread-&gt;frame_anchor()-&gt;walkable();
 727 
 728   case _thread_blocked:
 729     // On wait_barrier or blocked.
 730     // Blocked threads should already have walkable stack.
 731     assert(!thread-&gt;has_last_Java_frame() || thread-&gt;frame_anchor()-&gt;walkable(), &quot;blocked and not walkable&quot;);
 732     return true;
 733 
 734   default:
 735     return false;
 736   }
 737 }
 738 
 739 bool SafepointSynchronize::handshake_safe(JavaThread *thread) {
<a name="9" id="anc9"></a><span class="line-removed"> 740   assert(Thread::current()-&gt;is_VM_thread(), &quot;Must be VMThread&quot;);</span>
 741   if (thread-&gt;is_ext_suspended() || thread-&gt;is_terminated()) {
 742     return true;
 743   }
 744   JavaThreadState stable_state;
 745   if (try_stable_load_state(&amp;stable_state, thread, InactiveSafepointCounter)) {
 746     return safepoint_safe_with(thread, stable_state);
 747   }
 748   return false;
 749 }
 750 
 751 // See if the thread is running inside a lazy critical native and
 752 // update the thread critical count if so.  Also set a suspend flag to
 753 // cause the native wrapper to return into the JVM to do the unlock
 754 // once the native finishes.
 755 static void check_for_lazy_critical_native(JavaThread *thread, JavaThreadState state) {
 756   if (state == _thread_in_native &amp;&amp;
 757       thread-&gt;has_last_Java_frame() &amp;&amp;
 758       thread-&gt;frame_anchor()-&gt;walkable()) {
 759     // This thread might be in a critical native nmethod so look at
 760     // the top of the stack and increment the critical count if it
 761     // is.
 762     frame wrapper_frame = thread-&gt;last_frame();
 763     CodeBlob* stub_cb = wrapper_frame.cb();
 764     if (stub_cb != NULL &amp;&amp;
 765         stub_cb-&gt;is_nmethod() &amp;&amp;
 766         stub_cb-&gt;as_nmethod_or_null()-&gt;is_lazy_critical_native()) {
 767       // A thread could potentially be in a critical native across
 768       // more than one safepoint, so only update the critical state on
 769       // the first one.  When it returns it will perform the unlock.
 770       if (!thread-&gt;do_critical_native_unlock()) {
 771 #ifdef ASSERT
 772         if (!thread-&gt;in_critical()) {
 773           GCLocker::increment_debug_jni_lock_count();
 774         }
 775 #endif
 776         thread-&gt;enter_critical();
 777         // Make sure the native wrapper calls back on return to
 778         // perform the needed critical unlock.
 779         thread-&gt;set_critical_native_unlock();
 780       }
 781     }
 782   }
 783 }
 784 
 785 // -------------------------------------------------------------------------------------------------------
 786 // Implementation of Safepoint blocking point
 787 
 788 void SafepointSynchronize::block(JavaThread *thread) {
 789   assert(thread != NULL, &quot;thread must be set&quot;);
 790   assert(thread-&gt;is_Java_thread(), &quot;not a Java thread&quot;);
 791 
 792   // Threads shouldn&#39;t block if they are in the middle of printing, but...
 793   ttyLocker::break_tty_lock_for_safepoint(os::current_thread_id());
 794 
 795   // Only bail from the block() call if the thread is gone from the
 796   // thread list; starting to exit should still block.
 797   if (thread-&gt;is_terminated()) {
 798      // block current thread if we come here from native code when VM is gone
 799      thread-&gt;block_if_vm_exited();
 800 
 801      // otherwise do nothing
 802      return;
 803   }
 804 
 805   JavaThreadState state = thread-&gt;thread_state();
 806   thread-&gt;frame_anchor()-&gt;make_walkable(thread);
 807 
 808   uint64_t safepoint_id = SafepointSynchronize::safepoint_counter();
 809   // Check that we have a valid thread_state at this point
 810   switch(state) {
 811     case _thread_in_vm_trans:
 812     case _thread_in_Java:        // From compiled code
 813     case _thread_in_native_trans:
 814     case _thread_blocked_trans:
 815     case _thread_new_trans:
 816 
 817       // We have no idea where the VMThread is, it might even be at next safepoint.
 818       // So we can miss this poll, but stop at next.
 819 
 820       // Load dependent store, it must not pass loading of safepoint_id.
 821       thread-&gt;safepoint_state()-&gt;set_safepoint_id(safepoint_id); // Release store
 822 
 823       // This part we can skip if we notice we miss or are in a future safepoint.
 824       OrderAccess::storestore();
 825       // Load in wait barrier should not float up
 826       thread-&gt;set_thread_state_fence(_thread_blocked);
 827 
 828       _wait_barrier-&gt;wait(static_cast&lt;int&gt;(safepoint_id));
 829       assert(_state != _synchronized, &quot;Can&#39;t be&quot;);
 830 
 831       // If barrier is disarmed stop store from floating above loads in barrier.
 832       OrderAccess::loadstore();
 833       thread-&gt;set_thread_state(state);
 834 
 835       // Then we reset the safepoint id to inactive.
 836       thread-&gt;safepoint_state()-&gt;reset_safepoint_id(); // Release store
 837 
 838       OrderAccess::fence();
 839 
 840       break;
 841 
 842     default:
 843      fatal(&quot;Illegal threadstate encountered: %d&quot;, state);
 844   }
 845   guarantee(thread-&gt;safepoint_state()-&gt;get_safepoint_id() == InactiveSafepointCounter,
 846             &quot;The safepoint id should be set only in block path&quot;);
 847 
 848   // Check for pending. async. exceptions or suspends - except if the
 849   // thread was blocked inside the VM. has_special_runtime_exit_condition()
 850   // is called last since it grabs a lock and we only want to do that when
 851   // we must.
 852   //
 853   // Note: we never deliver an async exception at a polling point as the
 854   // compiler may not have an exception handler for it. The polling
 855   // code will notice the async and deoptimize and the exception will
 856   // be delivered. (Polling at a return point is ok though). Sure is
 857   // a lot of bother for a deprecated feature...
 858   //
 859   // We don&#39;t deliver an async exception if the thread state is
 860   // _thread_in_native_trans so JNI functions won&#39;t be called with
 861   // a surprising pending exception. If the thread state is going back to java,
 862   // async exception is checked in check_special_condition_for_native_trans().
 863 
 864   if (state != _thread_blocked_trans &amp;&amp;
 865       state != _thread_in_vm_trans &amp;&amp;
 866       thread-&gt;has_special_runtime_exit_condition()) {
 867     thread-&gt;handle_special_runtime_exit_condition(
 868       !thread-&gt;is_at_poll_safepoint() &amp;&amp; (state != _thread_in_native_trans));
 869   }
 870 
 871   // cross_modify_fence is done by SafepointMechanism::block_if_requested_slow
 872   // which is the only caller here.
 873 }
 874 
 875 // ------------------------------------------------------------------------------------------------------
 876 // Exception handlers
 877 
 878 
 879 void SafepointSynchronize::handle_polling_page_exception(JavaThread *thread) {
 880   assert(thread-&gt;is_Java_thread(), &quot;polling reference encountered by VM thread&quot;);
 881   assert(thread-&gt;thread_state() == _thread_in_Java, &quot;should come from Java code&quot;);
<a name="10" id="anc10"></a><span class="line-removed"> 882   if (!SafepointMechanism::uses_thread_local_poll()) {</span>
<span class="line-removed"> 883     assert(SafepointSynchronize::is_synchronizing(), &quot;polling encountered outside safepoint synchronization&quot;);</span>
<span class="line-removed"> 884   }</span>
 885 
 886   if (log_is_enabled(Info, safepoint, stats)) {
 887     Atomic::inc(&amp;_nof_threads_hit_polling_page);
 888   }
 889 
 890   ThreadSafepointState* state = thread-&gt;safepoint_state();
 891 
 892   state-&gt;handle_polling_page_exception();
 893 }
 894 
 895 
 896 void SafepointSynchronize::print_safepoint_timeout() {
 897   if (!timeout_error_printed) {
 898     timeout_error_printed = true;
 899     // Print out the thread info which didn&#39;t reach the safepoint for debugging
 900     // purposes (useful when there are lots of threads in the debugger).
 901     LogTarget(Warning, safepoint) lt;
 902     if (lt.is_enabled()) {
 903       ResourceMark rm;
 904       LogStream ls(lt);
 905 
 906       ls.cr();
 907       ls.print_cr(&quot;# SafepointSynchronize::begin: Timeout detected:&quot;);
 908       ls.print_cr(&quot;# SafepointSynchronize::begin: Timed out while spinning to reach a safepoint.&quot;);
 909       ls.print_cr(&quot;# SafepointSynchronize::begin: Threads which did not reach the safepoint:&quot;);
 910       for (JavaThreadIteratorWithHandle jtiwh; JavaThread *cur_thread = jtiwh.next(); ) {
 911         if (cur_thread-&gt;safepoint_state()-&gt;is_running()) {
 912           ls.print(&quot;# &quot;);
 913           cur_thread-&gt;print_on(&amp;ls);
 914           ls.cr();
 915         }
 916       }
 917       ls.print_cr(&quot;# SafepointSynchronize::begin: (End of list)&quot;);
 918     }
 919   }
 920 
 921   // To debug the long safepoint, specify both AbortVMOnSafepointTimeout &amp;
 922   // ShowMessageBoxOnError.
 923   if (AbortVMOnSafepointTimeout) {
 924     // Send the blocking thread a signal to terminate and write an error file.
 925     for (JavaThreadIteratorWithHandle jtiwh; JavaThread *cur_thread = jtiwh.next(); ) {
 926       if (cur_thread-&gt;safepoint_state()-&gt;is_running()) {
 927         if (!os::signal_thread(cur_thread, SIGILL, &quot;blocking a safepoint&quot;)) {
 928           break; // Could not send signal. Report fatal error.
 929         }
 930         // Give cur_thread a chance to report the error and terminate the VM.
 931         os::naked_sleep(3000);
 932       }
 933     }
 934     fatal(&quot;Safepoint sync time longer than &quot; INTX_FORMAT &quot;ms detected when executing %s.&quot;,
 935           SafepointTimeoutDelay, VMThread::vm_operation()-&gt;name());
 936   }
 937 }
 938 
 939 // -------------------------------------------------------------------------------------------------------
 940 // Implementation of ThreadSafepointState
 941 
 942 ThreadSafepointState::ThreadSafepointState(JavaThread *thread)
 943   : _at_poll_safepoint(false), _thread(thread), _safepoint_safe(false),
 944     _safepoint_id(SafepointSynchronize::InactiveSafepointCounter), _next(NULL) {
 945 }
 946 
 947 void ThreadSafepointState::create(JavaThread *thread) {
 948   ThreadSafepointState *state = new ThreadSafepointState(thread);
 949   thread-&gt;set_safepoint_state(state);
 950 }
 951 
 952 void ThreadSafepointState::destroy(JavaThread *thread) {
 953   if (thread-&gt;safepoint_state()) {
 954     delete(thread-&gt;safepoint_state());
 955     thread-&gt;set_safepoint_state(NULL);
 956   }
 957 }
 958 
 959 uint64_t ThreadSafepointState::get_safepoint_id() const {
 960   return Atomic::load_acquire(&amp;_safepoint_id);
 961 }
 962 
 963 void ThreadSafepointState::reset_safepoint_id() {
 964   Atomic::release_store(&amp;_safepoint_id, SafepointSynchronize::InactiveSafepointCounter);
 965 }
 966 
 967 void ThreadSafepointState::set_safepoint_id(uint64_t safepoint_id) {
 968   Atomic::release_store(&amp;_safepoint_id, safepoint_id);
 969 }
 970 
 971 void ThreadSafepointState::examine_state_of_thread(uint64_t safepoint_count) {
 972   assert(is_running(), &quot;better be running or just have hit safepoint poll&quot;);
 973 
 974   JavaThreadState stable_state;
 975   if (!SafepointSynchronize::try_stable_load_state(&amp;stable_state, _thread, safepoint_count)) {
 976     // We could not get stable state of the JavaThread.
 977     // Consider it running and just return.
 978     return;
 979   }
 980 
 981   // Check for a thread that is suspended. Note that thread resume tries
 982   // to grab the Threads_lock which we own here, so a thread cannot be
 983   // resumed during safepoint synchronization.
 984 
 985   // We check to see if this thread is suspended without locking to
 986   // avoid deadlocking with a third thread that is waiting for this
 987   // thread to be suspended. The third thread can notice the safepoint
 988   // that we&#39;re trying to start at the beginning of its SR_lock-&gt;wait()
 989   // call. If that happens, then the third thread will block on the
 990   // safepoint while still holding the underlying SR_lock. We won&#39;t be
 991   // able to get the SR_lock and we&#39;ll deadlock.
 992   //
 993   // We don&#39;t need to grab the SR_lock here for two reasons:
 994   // 1) The suspend flags are both volatile and are set with an
 995   //    Atomic::cmpxchg() call so we should see the suspended
 996   //    state right away.
 997   // 2) We&#39;re being called from the safepoint polling loop; if
 998   //    we don&#39;t see the suspended state on this iteration, then
 999   //    we&#39;ll come around again.
1000   //
1001   bool is_suspended = _thread-&gt;is_ext_suspended();
1002   if (is_suspended) {
1003     account_safe_thread();
1004     return;
1005   }
1006 
1007   if (safepoint_safe_with(_thread, stable_state)) {
1008     check_for_lazy_critical_native(_thread, stable_state);
1009     account_safe_thread();
1010     return;
1011   }
1012 
1013   // All other thread states will continue to run until they
1014   // transition and self-block in state _blocked
1015   // Safepoint polling in compiled code causes the Java threads to do the same.
1016   // Note: new threads may require a malloc so they must be allowed to finish
1017 
1018   assert(is_running(), &quot;examine_state_of_thread on non-running thread&quot;);
1019   return;
1020 }
1021 
1022 void ThreadSafepointState::account_safe_thread() {
1023   SafepointSynchronize::decrement_waiting_to_block();
1024   if (_thread-&gt;in_critical()) {
1025     // Notice that this thread is in a critical section
1026     SafepointSynchronize::increment_jni_active_count();
1027   }
1028   DEBUG_ONLY(_thread-&gt;set_visited_for_critical_count(SafepointSynchronize::safepoint_counter());)
1029   assert(!_safepoint_safe, &quot;Must be unsafe before safe&quot;);
1030   _safepoint_safe = true;
1031 }
1032 
1033 void ThreadSafepointState::restart() {
1034   assert(_safepoint_safe, &quot;Must be safe before unsafe&quot;);
1035   _safepoint_safe = false;
1036 }
1037 
1038 void ThreadSafepointState::print_on(outputStream *st) const {
1039   const char *s = _safepoint_safe ? &quot;_at_safepoint&quot; : &quot;_running&quot;;
1040 
1041   st-&gt;print_cr(&quot;Thread: &quot; INTPTR_FORMAT
1042               &quot;  [0x%2x] State: %s _at_poll_safepoint %d&quot;,
1043                p2i(_thread), _thread-&gt;osthread()-&gt;thread_id(), s, _at_poll_safepoint);
1044 
1045   _thread-&gt;print_thread_state_on(st);
1046 }
1047 
1048 // ---------------------------------------------------------------------------------------------------------------------
1049 
1050 // Block the thread at poll or poll return for safepoint/handshake.
1051 void ThreadSafepointState::handle_polling_page_exception() {
1052 
<a name="11" id="anc11"></a><span class="line-removed">1053   // If we&#39;re using a global poll, then the thread should not be</span>
<span class="line-removed">1054   // marked as safepoint safe yet.</span>
<span class="line-removed">1055   assert(!SafepointMechanism::uses_global_page_poll() || !_safepoint_safe,</span>
<span class="line-removed">1056          &quot;polling page exception on thread safepoint safe&quot;);</span>
<span class="line-removed">1057 </span>
1058   // Step 1: Find the nmethod from the return address
1059   address real_return_addr = thread()-&gt;saved_exception_pc();
1060 
1061   CodeBlob *cb = CodeCache::find_blob(real_return_addr);
1062   assert(cb != NULL &amp;&amp; cb-&gt;is_compiled(), &quot;return address should be in nmethod&quot;);
1063   CompiledMethod* nm = (CompiledMethod*)cb;
1064 
1065   // Find frame of caller
1066   frame stub_fr = thread()-&gt;last_frame();
1067   CodeBlob* stub_cb = stub_fr.cb();
1068   assert(stub_cb-&gt;is_safepoint_stub(), &quot;must be a safepoint stub&quot;);
1069   RegisterMap map(thread(), true);
1070   frame caller_fr = stub_fr.sender(&amp;map);
1071 
1072   // Should only be poll_return or poll
1073   assert( nm-&gt;is_at_poll_or_poll_return(real_return_addr), &quot;should not be at call&quot; );
1074 
1075   // This is a poll immediately before a return. The exception handling code
1076   // has already had the effect of causing the return to occur, so the execution
1077   // will continue immediately after the call. In addition, the oopmap at the
1078   // return point does not mark the return value as an oop (if it is), so
1079   // it needs a handle here to be updated.
1080   if( nm-&gt;is_at_poll_return(real_return_addr) ) {
1081     ResourceMark rm;
1082     // See if return type is an oop.
1083     Method* method = nm-&gt;method();
1084     bool return_oop = method-&gt;is_returning_oop();
1085 
1086     GrowableArray&lt;Handle&gt; return_values;
1087     ValueKlass* vk = NULL;
1088 
1089     if (return_oop &amp;&amp; ValueTypeReturnedAsFields) {
1090       SignatureStream ss(method-&gt;signature());
1091       while (!ss.at_return_type()) {
1092         ss.next();
1093       }
1094       if (ss.type() == T_VALUETYPE) {
1095         // Check if value type is returned as fields
1096         vk = ValueKlass::returned_value_klass(map);
1097         if (vk != NULL) {
1098           // We&#39;re at a safepoint at the return of a method that returns
1099           // multiple values. We must make sure we preserve the oop values
1100           // across the safepoint.
1101           assert(vk == method-&gt;returned_value_type(thread()), &quot;bad value klass&quot;);
1102           vk-&gt;save_oop_fields(map, return_values);
1103           return_oop = false;
1104         }
1105       }
1106     }
1107 
1108     if (return_oop) {
1109       // The oop result has been saved on the stack together with all
1110       // the other registers. In order to preserve it over GCs we need
1111       // to keep it in a handle.
1112       oop result = caller_fr.saved_oop_result(&amp;map);
1113       assert(oopDesc::is_oop_or_null(result), &quot;must be oop&quot;);
1114       return_values.push(Handle(thread(), result));
1115       assert(Universe::heap()-&gt;is_in_or_null(result), &quot;must be heap pointer&quot;);
1116     }
1117 
1118     // Block the thread
1119     SafepointMechanism::block_if_requested(thread());
1120 
1121     // restore oop result, if any
1122     if (return_oop) {
1123       assert(return_values.length() == 1, &quot;only one return value&quot;);
1124       caller_fr.set_saved_oop_result(&amp;map, return_values.pop()());
1125     } else if (vk != NULL) {
1126       vk-&gt;restore_oop_results(map, return_values);
1127     }
1128   }
1129 
1130   // This is a safepoint poll. Verify the return address and block.
1131   else {
1132     set_at_poll_safepoint(true);
1133 
1134     // verify the blob built the &quot;return address&quot; correctly
1135     assert(real_return_addr == caller_fr.pc(), &quot;must match&quot;);
1136 
1137     // Block the thread
1138     SafepointMechanism::block_if_requested(thread());
1139     set_at_poll_safepoint(false);
1140 
1141     // If we have a pending async exception deoptimize the frame
1142     // as otherwise we may never deliver it.
1143     if (thread()-&gt;has_async_condition()) {
1144       ThreadInVMfromJavaNoAsyncException __tiv(thread());
1145       Deoptimization::deoptimize_frame(thread(), caller_fr.id());
1146     }
1147 
1148     // If an exception has been installed we must check for a pending deoptimization
1149     // Deoptimize frame if exception has been thrown.
1150 
1151     if (thread()-&gt;has_pending_exception() ) {
1152       RegisterMap map(thread(), true);
1153       frame caller_fr = stub_fr.sender(&amp;map);
1154       if (caller_fr.is_deoptimized_frame()) {
1155         // The exception patch will destroy registers that are still
1156         // live and will be needed during deoptimization. Defer the
1157         // Async exception should have deferred the exception until the
1158         // next safepoint which will be detected when we get into
1159         // the interpreter so if we have an exception now things
1160         // are messed up.
1161 
1162         fatal(&quot;Exception installed and deoptimization is pending&quot;);
1163       }
1164     }
1165   }
1166 }
1167 
1168 
1169 // -------------------------------------------------------------------------------------------------------
1170 // Implementation of SafepointTracing
1171 
1172 jlong SafepointTracing::_last_safepoint_begin_time_ns = 0;
1173 jlong SafepointTracing::_last_safepoint_sync_time_ns = 0;
1174 jlong SafepointTracing::_last_safepoint_cleanup_time_ns = 0;
1175 jlong SafepointTracing::_last_safepoint_end_time_ns = 0;
1176 jlong SafepointTracing::_last_app_time_ns = 0;
1177 int SafepointTracing::_nof_threads = 0;
1178 int SafepointTracing::_nof_running = 0;
1179 int SafepointTracing::_page_trap = 0;
1180 VM_Operation::VMOp_Type SafepointTracing::_current_type;
1181 jlong     SafepointTracing::_max_sync_time = 0;
1182 jlong     SafepointTracing::_max_vmop_time = 0;
1183 uint64_t  SafepointTracing::_op_count[VM_Operation::VMOp_Terminating] = {0};
1184 
1185 void SafepointTracing::init() {
1186   // Application start
1187   _last_safepoint_end_time_ns = os::javaTimeNanos();
1188 }
1189 
1190 // Helper method to print the header.
1191 static void print_header(outputStream* st) {
1192   // The number of spaces is significant here, and should match the format
1193   // specifiers in print_statistics().
1194 
1195   st-&gt;print(&quot;VM Operation                 &quot;
1196             &quot;[ threads: total initial_running ]&quot;
1197             &quot;[ time:       sync    cleanup       vmop      total ]&quot;);
1198 
1199   st-&gt;print_cr(&quot; page_trap_count&quot;);
1200 }
1201 
1202 // This prints a nice table.  To get the statistics to not shift due to the logging uptime
1203 // decorator, use the option as: -Xlog:safepoint+stats:[outputfile]:none
1204 void SafepointTracing::statistics_log() {
1205   LogTarget(Info, safepoint, stats) lt;
1206   assert (lt.is_enabled(), &quot;should only be called when printing statistics is enabled&quot;);
1207   LogStream ls(lt);
1208 
1209   static int _cur_stat_index = 0;
1210 
1211   // Print header every 30 entries
1212   if ((_cur_stat_index % 30) == 0) {
1213     print_header(&amp;ls);
1214     _cur_stat_index = 1;  // wrap
1215   } else {
1216     _cur_stat_index++;
1217   }
1218 
1219   ls.print(&quot;%-28s [       &quot;
1220            INT32_FORMAT_W(8) &quot;        &quot; INT32_FORMAT_W(8) &quot; &quot;
1221            &quot;]&quot;,
1222            VM_Operation::name(_current_type),
1223            _nof_threads,
1224            _nof_running);
1225   ls.print(&quot;[       &quot;
1226            INT64_FORMAT_W(10) &quot; &quot; INT64_FORMAT_W(10) &quot; &quot;
1227            INT64_FORMAT_W(10) &quot; &quot; INT64_FORMAT_W(10) &quot; ]&quot;,
1228            (int64_t)(_last_safepoint_sync_time_ns - _last_safepoint_begin_time_ns),
1229            (int64_t)(_last_safepoint_cleanup_time_ns - _last_safepoint_sync_time_ns),
1230            (int64_t)(_last_safepoint_end_time_ns - _last_safepoint_cleanup_time_ns),
1231            (int64_t)(_last_safepoint_end_time_ns - _last_safepoint_begin_time_ns));
1232 
1233   ls.print_cr(INT32_FORMAT_W(16), _page_trap);
1234 }
1235 
1236 // This method will be called when VM exits. This tries to summarize the sampling.
1237 // Current thread may already be deleted, so don&#39;t use ResourceMark.
1238 void SafepointTracing::statistics_exit_log() {
1239   if (!log_is_enabled(Info, safepoint, stats)) {
1240     return;
1241   }
1242   for (int index = 0; index &lt; VM_Operation::VMOp_Terminating; index++) {
1243     if (_op_count[index] != 0) {
1244       log_info(safepoint, stats)(&quot;%-28s&quot; UINT64_FORMAT_W(10), VM_Operation::name(index),
1245                _op_count[index]);
1246     }
1247   }
1248 
1249   log_info(safepoint, stats)(&quot;VM operations coalesced during safepoint &quot; INT64_FORMAT,
1250                               VMThread::get_coalesced_count());
1251   log_info(safepoint, stats)(&quot;Maximum sync time  &quot; INT64_FORMAT&quot; ns&quot;,
1252                               (int64_t)(_max_sync_time));
1253   log_info(safepoint, stats)(&quot;Maximum vm operation time (except for Exit VM operation)  &quot;
1254                               INT64_FORMAT &quot; ns&quot;,
1255                               (int64_t)(_max_vmop_time));
1256 }
1257 
1258 void SafepointTracing::begin(VM_Operation::VMOp_Type type) {
1259   _op_count[type]++;
1260   _current_type = type;
1261 
1262   // update the time stamp to begin recording safepoint time
1263   _last_safepoint_begin_time_ns = os::javaTimeNanos();
1264   _last_safepoint_sync_time_ns = 0;
1265   _last_safepoint_cleanup_time_ns = 0;
1266 
1267   _last_app_time_ns = _last_safepoint_begin_time_ns - _last_safepoint_end_time_ns;
1268   _last_safepoint_end_time_ns = 0;
1269 
1270   RuntimeService::record_safepoint_begin(_last_app_time_ns);
1271 }
1272 
1273 void SafepointTracing::synchronized(int nof_threads, int nof_running, int traps) {
1274   _last_safepoint_sync_time_ns = os::javaTimeNanos();
1275   _nof_threads = nof_threads;
1276   _nof_running = nof_running;
1277   _page_trap   = traps;
1278   RuntimeService::record_safepoint_synchronized(_last_safepoint_sync_time_ns - _last_safepoint_begin_time_ns);
1279 }
1280 
1281 void SafepointTracing::cleanup() {
1282   _last_safepoint_cleanup_time_ns = os::javaTimeNanos();
1283 }
1284 
1285 void SafepointTracing::end() {
1286   _last_safepoint_end_time_ns = os::javaTimeNanos();
1287 
1288   if (_max_sync_time &lt; (_last_safepoint_sync_time_ns - _last_safepoint_begin_time_ns)) {
1289     _max_sync_time = _last_safepoint_sync_time_ns - _last_safepoint_begin_time_ns;
1290   }
1291   if (_max_vmop_time &lt; (_last_safepoint_end_time_ns - _last_safepoint_sync_time_ns)) {
1292     _max_vmop_time = _last_safepoint_end_time_ns - _last_safepoint_sync_time_ns;
1293   }
1294   if (log_is_enabled(Info, safepoint, stats)) {
1295     statistics_log();
1296   }
1297 
1298   log_info(safepoint)(
1299      &quot;Safepoint \&quot;%s\&quot;, &quot;
1300      &quot;Time since last: &quot; JLONG_FORMAT &quot; ns, &quot;
1301      &quot;Reaching safepoint: &quot; JLONG_FORMAT &quot; ns, &quot;
1302      &quot;At safepoint: &quot; JLONG_FORMAT &quot; ns, &quot;
1303      &quot;Total: &quot; JLONG_FORMAT &quot; ns&quot;,
1304       VM_Operation::name(_current_type),
1305       _last_app_time_ns,
1306       _last_safepoint_cleanup_time_ns - _last_safepoint_begin_time_ns,
1307       _last_safepoint_end_time_ns     - _last_safepoint_cleanup_time_ns,
1308       _last_safepoint_end_time_ns     - _last_safepoint_begin_time_ns
1309      );
1310 
1311   RuntimeService::record_safepoint_end(_last_safepoint_end_time_ns - _last_safepoint_cleanup_time_ns);
1312 }
<a name="12" id="anc12"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="12" type="hidden" />
</body>
</html>