<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff src/hotspot/share/gc/shenandoah/c2/shenandoahSupport.cpp</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
  </head>
<body>
<center><a href="shenandoahBarrierSetC2.cpp.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="../shenandoahBarrierSet.hpp.cdiff.html" target="_top">next &gt;</a></center>    <h2>src/hotspot/share/gc/shenandoah/c2/shenandoahSupport.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 857,12 ***</span>
    phase-&gt;lazy_replace(outer, new_outer);
    phase-&gt;lazy_replace(le, new_le);
    inner-&gt;clear_strip_mined();
  }
  
<span class="line-modified">! void ShenandoahBarrierC2Support::test_heap_stable(Node*&amp; ctrl, Node* raw_mem, Node*&amp; heap_stable_ctrl,</span>
<span class="line-modified">!                                                   PhaseIdealLoop* phase) {</span>
    IdealLoopTree* loop = phase-&gt;get_loop(ctrl);
    Node* thread = new ThreadLocalNode();
    phase-&gt;register_new_node(thread, ctrl);
    Node* offset = phase-&gt;igvn().MakeConX(in_bytes(ShenandoahThreadLocalData::gc_state_offset()));
    phase-&gt;set_ctrl(offset, phase-&gt;C-&gt;root());
<span class="line-new-header">--- 857,12 ---</span>
    phase-&gt;lazy_replace(outer, new_outer);
    phase-&gt;lazy_replace(le, new_le);
    inner-&gt;clear_strip_mined();
  }
  
<span class="line-modified">! void ShenandoahBarrierC2Support::test_heap_state(Node*&amp; ctrl, Node* raw_mem, Node*&amp; heap_stable_ctrl,</span>
<span class="line-modified">!                                                  PhaseIdealLoop* phase, int flags) {</span>
    IdealLoopTree* loop = phase-&gt;get_loop(ctrl);
    Node* thread = new ThreadLocalNode();
    phase-&gt;register_new_node(thread, ctrl);
    Node* offset = phase-&gt;igvn().MakeConX(in_bytes(ShenandoahThreadLocalData::gc_state_offset()));
    phase-&gt;set_ctrl(offset, phase-&gt;C-&gt;root());
</pre>
<hr />
<pre>
<span class="line-old-header">*** 872,11 ***</span>
    const TypePtr* gc_state_adr_type = NULL; // debug-mode-only argument
    debug_only(gc_state_adr_type = phase-&gt;C-&gt;get_adr_type(gc_state_idx));
  
    Node* gc_state = new LoadBNode(ctrl, raw_mem, gc_state_addr, gc_state_adr_type, TypeInt::BYTE, MemNode::unordered);
    phase-&gt;register_new_node(gc_state, ctrl);
<span class="line-modified">!   Node* heap_stable_and = new AndINode(gc_state, phase-&gt;igvn().intcon(ShenandoahHeap::HAS_FORWARDED));</span>
    phase-&gt;register_new_node(heap_stable_and, ctrl);
    Node* heap_stable_cmp = new CmpINode(heap_stable_and, phase-&gt;igvn().zerocon(T_INT));
    phase-&gt;register_new_node(heap_stable_cmp, ctrl);
    Node* heap_stable_test = new BoolNode(heap_stable_cmp, BoolTest::ne);
    phase-&gt;register_new_node(heap_stable_test, ctrl);
<span class="line-new-header">--- 872,11 ---</span>
    const TypePtr* gc_state_adr_type = NULL; // debug-mode-only argument
    debug_only(gc_state_adr_type = phase-&gt;C-&gt;get_adr_type(gc_state_idx));
  
    Node* gc_state = new LoadBNode(ctrl, raw_mem, gc_state_addr, gc_state_adr_type, TypeInt::BYTE, MemNode::unordered);
    phase-&gt;register_new_node(gc_state, ctrl);
<span class="line-modified">!   Node* heap_stable_and = new AndINode(gc_state, phase-&gt;igvn().intcon(flags));</span>
    phase-&gt;register_new_node(heap_stable_and, ctrl);
    Node* heap_stable_cmp = new CmpINode(heap_stable_and, phase-&gt;igvn().zerocon(T_INT));
    phase-&gt;register_new_node(heap_stable_cmp, ctrl);
    Node* heap_stable_test = new BoolNode(heap_stable_cmp, BoolTest::ne);
    phase-&gt;register_new_node(heap_stable_test, ctrl);
</pre>
<hr />
<pre>
<span class="line-old-header">*** 886,11 ***</span>
    heap_stable_ctrl = new IfFalseNode(heap_stable_iff);
    phase-&gt;register_control(heap_stable_ctrl, loop, heap_stable_iff);
    ctrl = new IfTrueNode(heap_stable_iff);
    phase-&gt;register_control(ctrl, loop, heap_stable_iff);
  
<span class="line-modified">!   assert(is_heap_stable_test(heap_stable_iff), &quot;Should match the shape&quot;);</span>
  }
  
  void ShenandoahBarrierC2Support::test_null(Node*&amp; ctrl, Node* val, Node*&amp; null_ctrl, PhaseIdealLoop* phase) {
    const Type* val_t = phase-&gt;igvn().type(val);
    if (val_t-&gt;meet(TypePtr::NULL_PTR) == val_t) {
<span class="line-new-header">--- 886,11 ---</span>
    heap_stable_ctrl = new IfFalseNode(heap_stable_iff);
    phase-&gt;register_control(heap_stable_ctrl, loop, heap_stable_iff);
    ctrl = new IfTrueNode(heap_stable_iff);
    phase-&gt;register_control(ctrl, loop, heap_stable_iff);
  
<span class="line-modified">!   assert(is_heap_state_test(heap_stable_iff, flags), &quot;Should match the shape&quot;);</span>
  }
  
  void ShenandoahBarrierC2Support::test_null(Node*&amp; ctrl, Node* val, Node*&amp; null_ctrl, PhaseIdealLoop* phase) {
    const Type* val_t = phase-&gt;igvn().type(val);
    if (val_t-&gt;meet(TypePtr::NULL_PTR) == val_t) {
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1432,11 ***</span>
      Node* region = new RegionNode(PATH_LIMIT);
      Node* val_phi = new PhiNode(region, uncasted_val-&gt;bottom_type()-&gt;is_oopptr());
      Node* raw_mem_phi = PhiNode::make(region, raw_mem, Type::MEMORY, TypeRawPtr::BOTTOM);
  
      // Stable path.
<span class="line-modified">!     test_heap_stable(ctrl, raw_mem, heap_stable_ctrl, phase);</span>
      IfNode* heap_stable_iff = heap_stable_ctrl-&gt;in(0)-&gt;as_If();
  
      // Heap stable case
      region-&gt;init_req(_heap_stable, heap_stable_ctrl);
      val_phi-&gt;init_req(_heap_stable, uncasted_val);
<span class="line-new-header">--- 1432,11 ---</span>
      Node* region = new RegionNode(PATH_LIMIT);
      Node* val_phi = new PhiNode(region, uncasted_val-&gt;bottom_type()-&gt;is_oopptr());
      Node* raw_mem_phi = PhiNode::make(region, raw_mem, Type::MEMORY, TypeRawPtr::BOTTOM);
  
      // Stable path.
<span class="line-modified">!     test_heap_state(ctrl, raw_mem, heap_stable_ctrl, phase, ShenandoahHeap::HAS_FORWARDED);</span>
      IfNode* heap_stable_iff = heap_stable_ctrl-&gt;in(0)-&gt;as_If();
  
      // Heap stable case
      region-&gt;init_req(_heap_stable, heap_stable_ctrl);
      val_phi-&gt;init_req(_heap_stable, uncasted_val);
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1603,11 ***</span>
      enum { _fast_path = 1, _slow_path, _null_path, PATH_LIMIT2 };
      Node* region2 = new RegionNode(PATH_LIMIT2);
      Node* phi2 = PhiNode::make(region2, raw_mem, Type::MEMORY, TypeRawPtr::BOTTOM);
  
      // Stable path.
<span class="line-modified">!     test_heap_stable(ctrl, raw_mem, heap_stable_ctrl, phase);</span>
      region-&gt;init_req(_heap_stable, heap_stable_ctrl);
      phi-&gt;init_req(_heap_stable, raw_mem);
  
      // Null path
      Node* reg2_ctrl = NULL;
<span class="line-new-header">--- 1603,11 ---</span>
      enum { _fast_path = 1, _slow_path, _null_path, PATH_LIMIT2 };
      Node* region2 = new RegionNode(PATH_LIMIT2);
      Node* phi2 = PhiNode::make(region2, raw_mem, Type::MEMORY, TypeRawPtr::BOTTOM);
  
      // Stable path.
<span class="line-modified">!     test_heap_state(ctrl, raw_mem, heap_stable_ctrl, phase, ShenandoahHeap::MARKING);</span>
      region-&gt;init_req(_heap_stable, heap_stable_ctrl);
      phi-&gt;init_req(_heap_stable, raw_mem);
  
      // Null path
      Node* reg2_ctrl = NULL;
</pre>
<center><a href="shenandoahBarrierSetC2.cpp.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="../shenandoahBarrierSet.hpp.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>