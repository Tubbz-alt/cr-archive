<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/hotspot/share/gc/shenandoah/c2/shenandoahSupport.cpp</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
  </head>
<body>
<center><a href="shenandoahBarrierSetC2.cpp.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="../shenandoahBarrierSet.hpp.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/hotspot/share/gc/shenandoah/c2/shenandoahSupport.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 842 void ShenandoahBarrierC2Support::follow_barrier_uses(Node* n, Node* ctrl, Unique_Node_List&amp; uses, PhaseIdealLoop* phase) {
 843   for (DUIterator_Fast imax, i = n-&gt;fast_outs(imax); i &lt; imax; i++) {
 844     Node* u = n-&gt;fast_out(i);
 845     if (!u-&gt;is_CFG() &amp;&amp; phase-&gt;get_ctrl(u) == ctrl &amp;&amp; (!u-&gt;is_Phi() || !u-&gt;in(0)-&gt;is_Loop() || u-&gt;in(LoopNode::LoopBackControl) != n)) {
 846       uses.push(u);
 847     }
 848   }
 849 }
 850 
 851 static void hide_strip_mined_loop(OuterStripMinedLoopNode* outer, CountedLoopNode* inner, PhaseIdealLoop* phase) {
 852   OuterStripMinedLoopEndNode* le = inner-&gt;outer_loop_end();
 853   Node* new_outer = new LoopNode(outer-&gt;in(LoopNode::EntryControl), outer-&gt;in(LoopNode::LoopBackControl));
 854   phase-&gt;register_control(new_outer, phase-&gt;get_loop(outer), outer-&gt;in(LoopNode::EntryControl));
 855   Node* new_le = new IfNode(le-&gt;in(0), le-&gt;in(1), le-&gt;_prob, le-&gt;_fcnt);
 856   phase-&gt;register_control(new_le, phase-&gt;get_loop(le), le-&gt;in(0));
 857   phase-&gt;lazy_replace(outer, new_outer);
 858   phase-&gt;lazy_replace(le, new_le);
 859   inner-&gt;clear_strip_mined();
 860 }
 861 
<span class="line-modified"> 862 void ShenandoahBarrierC2Support::test_heap_stable(Node*&amp; ctrl, Node* raw_mem, Node*&amp; heap_stable_ctrl,</span>
<span class="line-modified"> 863                                                   PhaseIdealLoop* phase) {</span>
 864   IdealLoopTree* loop = phase-&gt;get_loop(ctrl);
 865   Node* thread = new ThreadLocalNode();
 866   phase-&gt;register_new_node(thread, ctrl);
 867   Node* offset = phase-&gt;igvn().MakeConX(in_bytes(ShenandoahThreadLocalData::gc_state_offset()));
 868   phase-&gt;set_ctrl(offset, phase-&gt;C-&gt;root());
 869   Node* gc_state_addr = new AddPNode(phase-&gt;C-&gt;top(), thread, offset);
 870   phase-&gt;register_new_node(gc_state_addr, ctrl);
 871   uint gc_state_idx = Compile::AliasIdxRaw;
 872   const TypePtr* gc_state_adr_type = NULL; // debug-mode-only argument
 873   debug_only(gc_state_adr_type = phase-&gt;C-&gt;get_adr_type(gc_state_idx));
 874 
 875   Node* gc_state = new LoadBNode(ctrl, raw_mem, gc_state_addr, gc_state_adr_type, TypeInt::BYTE, MemNode::unordered);
 876   phase-&gt;register_new_node(gc_state, ctrl);
<span class="line-modified"> 877   Node* heap_stable_and = new AndINode(gc_state, phase-&gt;igvn().intcon(ShenandoahHeap::HAS_FORWARDED));</span>
 878   phase-&gt;register_new_node(heap_stable_and, ctrl);
 879   Node* heap_stable_cmp = new CmpINode(heap_stable_and, phase-&gt;igvn().zerocon(T_INT));
 880   phase-&gt;register_new_node(heap_stable_cmp, ctrl);
 881   Node* heap_stable_test = new BoolNode(heap_stable_cmp, BoolTest::ne);
 882   phase-&gt;register_new_node(heap_stable_test, ctrl);
 883   IfNode* heap_stable_iff = new IfNode(ctrl, heap_stable_test, PROB_UNLIKELY(0.999), COUNT_UNKNOWN);
 884   phase-&gt;register_control(heap_stable_iff, loop, ctrl);
 885 
 886   heap_stable_ctrl = new IfFalseNode(heap_stable_iff);
 887   phase-&gt;register_control(heap_stable_ctrl, loop, heap_stable_iff);
 888   ctrl = new IfTrueNode(heap_stable_iff);
 889   phase-&gt;register_control(ctrl, loop, heap_stable_iff);
 890 
<span class="line-modified"> 891   assert(is_heap_stable_test(heap_stable_iff), &quot;Should match the shape&quot;);</span>
 892 }
 893 
 894 void ShenandoahBarrierC2Support::test_null(Node*&amp; ctrl, Node* val, Node*&amp; null_ctrl, PhaseIdealLoop* phase) {
 895   const Type* val_t = phase-&gt;igvn().type(val);
 896   if (val_t-&gt;meet(TypePtr::NULL_PTR) == val_t) {
 897     IdealLoopTree* loop = phase-&gt;get_loop(ctrl);
 898     Node* null_cmp = new CmpPNode(val, phase-&gt;igvn().zerocon(T_OBJECT));
 899     phase-&gt;register_new_node(null_cmp, ctrl);
 900     Node* null_test = new BoolNode(null_cmp, BoolTest::ne);
 901     phase-&gt;register_new_node(null_test, ctrl);
 902     IfNode* null_iff = new IfNode(ctrl, null_test, PROB_LIKELY(0.999), COUNT_UNKNOWN);
 903     phase-&gt;register_control(null_iff, loop, ctrl);
 904     ctrl = new IfTrueNode(null_iff);
 905     phase-&gt;register_control(ctrl, loop, null_iff);
 906     null_ctrl = new IfFalseNode(null_iff);
 907     phase-&gt;register_control(null_ctrl, loop, null_iff);
 908   }
 909 }
 910 
 911 Node* ShenandoahBarrierC2Support::clone_null_check(Node*&amp; c, Node* val, Node* unc_ctrl, PhaseIdealLoop* phase) {
</pre>
<hr />
<pre>
1417       }
1418     }
1419 
1420     Node* uncasted_val = val;
1421     if (unc != NULL) {
1422       uncasted_val = val-&gt;in(1);
1423     }
1424 
1425     Node* heap_stable_ctrl = NULL;
1426     Node* null_ctrl = NULL;
1427 
1428     assert(val-&gt;bottom_type()-&gt;make_oopptr(), &quot;need oop&quot;);
1429     assert(val-&gt;bottom_type()-&gt;make_oopptr()-&gt;const_oop() == NULL, &quot;expect non-constant&quot;);
1430 
1431     enum { _heap_stable = 1, _not_cset, _evac_path, _null_path, PATH_LIMIT };
1432     Node* region = new RegionNode(PATH_LIMIT);
1433     Node* val_phi = new PhiNode(region, uncasted_val-&gt;bottom_type()-&gt;is_oopptr());
1434     Node* raw_mem_phi = PhiNode::make(region, raw_mem, Type::MEMORY, TypeRawPtr::BOTTOM);
1435 
1436     // Stable path.
<span class="line-modified">1437     test_heap_stable(ctrl, raw_mem, heap_stable_ctrl, phase);</span>
1438     IfNode* heap_stable_iff = heap_stable_ctrl-&gt;in(0)-&gt;as_If();
1439 
1440     // Heap stable case
1441     region-&gt;init_req(_heap_stable, heap_stable_ctrl);
1442     val_phi-&gt;init_req(_heap_stable, uncasted_val);
1443     raw_mem_phi-&gt;init_req(_heap_stable, raw_mem);
1444 
1445     Node* reg2_ctrl = NULL;
1446     // Null case
1447     test_null(ctrl, val, null_ctrl, phase);
1448     if (null_ctrl != NULL) {
1449       reg2_ctrl = null_ctrl-&gt;in(0);
1450       region-&gt;init_req(_null_path, null_ctrl);
1451       val_phi-&gt;init_req(_null_path, uncasted_val);
1452       raw_mem_phi-&gt;init_req(_null_path, raw_mem);
1453     } else {
1454       region-&gt;del_req(_null_path);
1455       val_phi-&gt;del_req(_null_path);
1456       raw_mem_phi-&gt;del_req(_null_path);
1457     }
</pre>
<hr />
<pre>
1588     }
1589 
1590     Node* init_ctrl = ctrl;
1591     IdealLoopTree* loop = phase-&gt;get_loop(ctrl);
1592     Node* raw_mem = fixer.find_mem(ctrl, barrier);
1593     Node* init_raw_mem = raw_mem;
1594     Node* raw_mem_for_ctrl = fixer.find_mem(ctrl, NULL);
1595     Node* heap_stable_ctrl = NULL;
1596     Node* null_ctrl = NULL;
1597     uint last = phase-&gt;C-&gt;unique();
1598 
1599     enum { _heap_stable = 1, _heap_unstable, PATH_LIMIT };
1600     Node* region = new RegionNode(PATH_LIMIT);
1601     Node* phi = PhiNode::make(region, raw_mem, Type::MEMORY, TypeRawPtr::BOTTOM);
1602 
1603     enum { _fast_path = 1, _slow_path, _null_path, PATH_LIMIT2 };
1604     Node* region2 = new RegionNode(PATH_LIMIT2);
1605     Node* phi2 = PhiNode::make(region2, raw_mem, Type::MEMORY, TypeRawPtr::BOTTOM);
1606 
1607     // Stable path.
<span class="line-modified">1608     test_heap_stable(ctrl, raw_mem, heap_stable_ctrl, phase);</span>
1609     region-&gt;init_req(_heap_stable, heap_stable_ctrl);
1610     phi-&gt;init_req(_heap_stable, raw_mem);
1611 
1612     // Null path
1613     Node* reg2_ctrl = NULL;
1614     test_null(ctrl, pre_val, null_ctrl, phase);
1615     if (null_ctrl != NULL) {
1616       reg2_ctrl = null_ctrl-&gt;in(0);
1617       region2-&gt;init_req(_null_path, null_ctrl);
1618       phi2-&gt;init_req(_null_path, raw_mem);
1619     } else {
1620       region2-&gt;del_req(_null_path);
1621       phi2-&gt;del_req(_null_path);
1622     }
1623 
1624     const int index_offset = in_bytes(ShenandoahThreadLocalData::satb_mark_queue_index_offset());
1625     const int buffer_offset = in_bytes(ShenandoahThreadLocalData::satb_mark_queue_buffer_offset());
1626     Node* thread = new ThreadLocalNode();
1627     phase-&gt;register_new_node(thread, ctrl);
1628     Node* buffer_adr = new AddPNode(phase-&gt;C-&gt;top(), thread, phase-&gt;igvn().MakeConX(buffer_offset));
</pre>
</td>
<td>
<hr />
<pre>
 842 void ShenandoahBarrierC2Support::follow_barrier_uses(Node* n, Node* ctrl, Unique_Node_List&amp; uses, PhaseIdealLoop* phase) {
 843   for (DUIterator_Fast imax, i = n-&gt;fast_outs(imax); i &lt; imax; i++) {
 844     Node* u = n-&gt;fast_out(i);
 845     if (!u-&gt;is_CFG() &amp;&amp; phase-&gt;get_ctrl(u) == ctrl &amp;&amp; (!u-&gt;is_Phi() || !u-&gt;in(0)-&gt;is_Loop() || u-&gt;in(LoopNode::LoopBackControl) != n)) {
 846       uses.push(u);
 847     }
 848   }
 849 }
 850 
 851 static void hide_strip_mined_loop(OuterStripMinedLoopNode* outer, CountedLoopNode* inner, PhaseIdealLoop* phase) {
 852   OuterStripMinedLoopEndNode* le = inner-&gt;outer_loop_end();
 853   Node* new_outer = new LoopNode(outer-&gt;in(LoopNode::EntryControl), outer-&gt;in(LoopNode::LoopBackControl));
 854   phase-&gt;register_control(new_outer, phase-&gt;get_loop(outer), outer-&gt;in(LoopNode::EntryControl));
 855   Node* new_le = new IfNode(le-&gt;in(0), le-&gt;in(1), le-&gt;_prob, le-&gt;_fcnt);
 856   phase-&gt;register_control(new_le, phase-&gt;get_loop(le), le-&gt;in(0));
 857   phase-&gt;lazy_replace(outer, new_outer);
 858   phase-&gt;lazy_replace(le, new_le);
 859   inner-&gt;clear_strip_mined();
 860 }
 861 
<span class="line-modified"> 862 void ShenandoahBarrierC2Support::test_heap_state(Node*&amp; ctrl, Node* raw_mem, Node*&amp; heap_stable_ctrl,</span>
<span class="line-modified"> 863                                                  PhaseIdealLoop* phase, int flags) {</span>
 864   IdealLoopTree* loop = phase-&gt;get_loop(ctrl);
 865   Node* thread = new ThreadLocalNode();
 866   phase-&gt;register_new_node(thread, ctrl);
 867   Node* offset = phase-&gt;igvn().MakeConX(in_bytes(ShenandoahThreadLocalData::gc_state_offset()));
 868   phase-&gt;set_ctrl(offset, phase-&gt;C-&gt;root());
 869   Node* gc_state_addr = new AddPNode(phase-&gt;C-&gt;top(), thread, offset);
 870   phase-&gt;register_new_node(gc_state_addr, ctrl);
 871   uint gc_state_idx = Compile::AliasIdxRaw;
 872   const TypePtr* gc_state_adr_type = NULL; // debug-mode-only argument
 873   debug_only(gc_state_adr_type = phase-&gt;C-&gt;get_adr_type(gc_state_idx));
 874 
 875   Node* gc_state = new LoadBNode(ctrl, raw_mem, gc_state_addr, gc_state_adr_type, TypeInt::BYTE, MemNode::unordered);
 876   phase-&gt;register_new_node(gc_state, ctrl);
<span class="line-modified"> 877   Node* heap_stable_and = new AndINode(gc_state, phase-&gt;igvn().intcon(flags));</span>
 878   phase-&gt;register_new_node(heap_stable_and, ctrl);
 879   Node* heap_stable_cmp = new CmpINode(heap_stable_and, phase-&gt;igvn().zerocon(T_INT));
 880   phase-&gt;register_new_node(heap_stable_cmp, ctrl);
 881   Node* heap_stable_test = new BoolNode(heap_stable_cmp, BoolTest::ne);
 882   phase-&gt;register_new_node(heap_stable_test, ctrl);
 883   IfNode* heap_stable_iff = new IfNode(ctrl, heap_stable_test, PROB_UNLIKELY(0.999), COUNT_UNKNOWN);
 884   phase-&gt;register_control(heap_stable_iff, loop, ctrl);
 885 
 886   heap_stable_ctrl = new IfFalseNode(heap_stable_iff);
 887   phase-&gt;register_control(heap_stable_ctrl, loop, heap_stable_iff);
 888   ctrl = new IfTrueNode(heap_stable_iff);
 889   phase-&gt;register_control(ctrl, loop, heap_stable_iff);
 890 
<span class="line-modified"> 891   assert(is_heap_state_test(heap_stable_iff, flags), &quot;Should match the shape&quot;);</span>
 892 }
 893 
 894 void ShenandoahBarrierC2Support::test_null(Node*&amp; ctrl, Node* val, Node*&amp; null_ctrl, PhaseIdealLoop* phase) {
 895   const Type* val_t = phase-&gt;igvn().type(val);
 896   if (val_t-&gt;meet(TypePtr::NULL_PTR) == val_t) {
 897     IdealLoopTree* loop = phase-&gt;get_loop(ctrl);
 898     Node* null_cmp = new CmpPNode(val, phase-&gt;igvn().zerocon(T_OBJECT));
 899     phase-&gt;register_new_node(null_cmp, ctrl);
 900     Node* null_test = new BoolNode(null_cmp, BoolTest::ne);
 901     phase-&gt;register_new_node(null_test, ctrl);
 902     IfNode* null_iff = new IfNode(ctrl, null_test, PROB_LIKELY(0.999), COUNT_UNKNOWN);
 903     phase-&gt;register_control(null_iff, loop, ctrl);
 904     ctrl = new IfTrueNode(null_iff);
 905     phase-&gt;register_control(ctrl, loop, null_iff);
 906     null_ctrl = new IfFalseNode(null_iff);
 907     phase-&gt;register_control(null_ctrl, loop, null_iff);
 908   }
 909 }
 910 
 911 Node* ShenandoahBarrierC2Support::clone_null_check(Node*&amp; c, Node* val, Node* unc_ctrl, PhaseIdealLoop* phase) {
</pre>
<hr />
<pre>
1417       }
1418     }
1419 
1420     Node* uncasted_val = val;
1421     if (unc != NULL) {
1422       uncasted_val = val-&gt;in(1);
1423     }
1424 
1425     Node* heap_stable_ctrl = NULL;
1426     Node* null_ctrl = NULL;
1427 
1428     assert(val-&gt;bottom_type()-&gt;make_oopptr(), &quot;need oop&quot;);
1429     assert(val-&gt;bottom_type()-&gt;make_oopptr()-&gt;const_oop() == NULL, &quot;expect non-constant&quot;);
1430 
1431     enum { _heap_stable = 1, _not_cset, _evac_path, _null_path, PATH_LIMIT };
1432     Node* region = new RegionNode(PATH_LIMIT);
1433     Node* val_phi = new PhiNode(region, uncasted_val-&gt;bottom_type()-&gt;is_oopptr());
1434     Node* raw_mem_phi = PhiNode::make(region, raw_mem, Type::MEMORY, TypeRawPtr::BOTTOM);
1435 
1436     // Stable path.
<span class="line-modified">1437     test_heap_state(ctrl, raw_mem, heap_stable_ctrl, phase, ShenandoahHeap::HAS_FORWARDED);</span>
1438     IfNode* heap_stable_iff = heap_stable_ctrl-&gt;in(0)-&gt;as_If();
1439 
1440     // Heap stable case
1441     region-&gt;init_req(_heap_stable, heap_stable_ctrl);
1442     val_phi-&gt;init_req(_heap_stable, uncasted_val);
1443     raw_mem_phi-&gt;init_req(_heap_stable, raw_mem);
1444 
1445     Node* reg2_ctrl = NULL;
1446     // Null case
1447     test_null(ctrl, val, null_ctrl, phase);
1448     if (null_ctrl != NULL) {
1449       reg2_ctrl = null_ctrl-&gt;in(0);
1450       region-&gt;init_req(_null_path, null_ctrl);
1451       val_phi-&gt;init_req(_null_path, uncasted_val);
1452       raw_mem_phi-&gt;init_req(_null_path, raw_mem);
1453     } else {
1454       region-&gt;del_req(_null_path);
1455       val_phi-&gt;del_req(_null_path);
1456       raw_mem_phi-&gt;del_req(_null_path);
1457     }
</pre>
<hr />
<pre>
1588     }
1589 
1590     Node* init_ctrl = ctrl;
1591     IdealLoopTree* loop = phase-&gt;get_loop(ctrl);
1592     Node* raw_mem = fixer.find_mem(ctrl, barrier);
1593     Node* init_raw_mem = raw_mem;
1594     Node* raw_mem_for_ctrl = fixer.find_mem(ctrl, NULL);
1595     Node* heap_stable_ctrl = NULL;
1596     Node* null_ctrl = NULL;
1597     uint last = phase-&gt;C-&gt;unique();
1598 
1599     enum { _heap_stable = 1, _heap_unstable, PATH_LIMIT };
1600     Node* region = new RegionNode(PATH_LIMIT);
1601     Node* phi = PhiNode::make(region, raw_mem, Type::MEMORY, TypeRawPtr::BOTTOM);
1602 
1603     enum { _fast_path = 1, _slow_path, _null_path, PATH_LIMIT2 };
1604     Node* region2 = new RegionNode(PATH_LIMIT2);
1605     Node* phi2 = PhiNode::make(region2, raw_mem, Type::MEMORY, TypeRawPtr::BOTTOM);
1606 
1607     // Stable path.
<span class="line-modified">1608     test_heap_state(ctrl, raw_mem, heap_stable_ctrl, phase, ShenandoahHeap::MARKING);</span>
1609     region-&gt;init_req(_heap_stable, heap_stable_ctrl);
1610     phi-&gt;init_req(_heap_stable, raw_mem);
1611 
1612     // Null path
1613     Node* reg2_ctrl = NULL;
1614     test_null(ctrl, pre_val, null_ctrl, phase);
1615     if (null_ctrl != NULL) {
1616       reg2_ctrl = null_ctrl-&gt;in(0);
1617       region2-&gt;init_req(_null_path, null_ctrl);
1618       phi2-&gt;init_req(_null_path, raw_mem);
1619     } else {
1620       region2-&gt;del_req(_null_path);
1621       phi2-&gt;del_req(_null_path);
1622     }
1623 
1624     const int index_offset = in_bytes(ShenandoahThreadLocalData::satb_mark_queue_index_offset());
1625     const int buffer_offset = in_bytes(ShenandoahThreadLocalData::satb_mark_queue_buffer_offset());
1626     Node* thread = new ThreadLocalNode();
1627     phase-&gt;register_new_node(thread, ctrl);
1628     Node* buffer_adr = new AddPNode(phase-&gt;C-&gt;top(), thread, phase-&gt;igvn().MakeConX(buffer_offset));
</pre>
</td>
</tr>
</table>
<center><a href="shenandoahBarrierSetC2.cpp.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="../shenandoahBarrierSet.hpp.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>