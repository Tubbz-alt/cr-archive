<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff src/hotspot/cpu/x86/x86_64.ad</title>
    <link rel="stylesheet" href="../../../../style.css" />
  </head>
<body>
<center><a href="x86_32.ad.udiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="../../share/adlc/formssel.cpp.udiff.html" target="_top">next &gt;</a></center>    <h2>src/hotspot/cpu/x86/x86_64.ad</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -1,7 +1,7 @@</span>
  //
<span class="udiff-line-modified-removed">- // Copyright (c) 2003, 2019, Oracle and/or its affiliates. All rights reserved.</span>
<span class="udiff-line-modified-added">+ // Copyright (c) 2003, 2020, Oracle and/or its affiliates. All rights reserved.</span>
  // DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  //
  // This code is free software; you can redistribute it and/or modify it
  // under the terms of the GNU General Public License version 2 only, as
  // published by the Free Software Foundation.
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -457,17 +457,10 @@</span>
    int offset = 13; // movq r10,#addr; callq (r10)
    offset += clear_avx_size();
    return offset;
  }
  
<span class="udiff-line-removed">- // Indicate if the safepoint node needs the polling page as an input,</span>
<span class="udiff-line-removed">- // it does if the polling page is more than disp32 away.</span>
<span class="udiff-line-removed">- bool SafePointNode::needs_polling_address_input()</span>
<span class="udiff-line-removed">- {</span>
<span class="udiff-line-removed">-   return SafepointMechanism::uses_thread_local_poll() || Assembler::is_polling_page_far();</span>
<span class="udiff-line-removed">- }</span>
<span class="udiff-line-removed">- </span>
  //
  // Compute padding required for nodes which need alignment
  //
  
  // The address of the call instruction needs to be 4-byte aligned to
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -934,22 +927,13 @@</span>
    }
  
    st-&gt;print_cr(&quot;popq    rbp&quot;);
    if (do_polling() &amp;&amp; C-&gt;is_method_compilation()) {
      st-&gt;print(&quot;\t&quot;);
<span class="udiff-line-modified-removed">-     if (SafepointMechanism::uses_thread_local_poll()) {</span>
<span class="udiff-line-modified-removed">-       st-&gt;print_cr(&quot;movq    rscratch1, poll_offset[r15_thread] #polling_page_address\n\t&quot;</span>
<span class="udiff-line-modified-removed">-                    &quot;testl   rax, [rscratch1]\t&quot;</span>
<span class="udiff-line-removed">-                    &quot;# Safepoint: poll for GC&quot;);</span>
<span class="udiff-line-removed">-     } else if (Assembler::is_polling_page_far()) {</span>
<span class="udiff-line-removed">-       st-&gt;print_cr(&quot;movq    rscratch1, #polling_page_address\n\t&quot;</span>
<span class="udiff-line-removed">-                    &quot;testl   rax, [rscratch1]\t&quot;</span>
<span class="udiff-line-removed">-                    &quot;# Safepoint: poll for GC&quot;);</span>
<span class="udiff-line-removed">-     } else {</span>
<span class="udiff-line-removed">-       st-&gt;print_cr(&quot;testl   rax, [rip + #offset_to_poll_page]\t&quot;</span>
<span class="udiff-line-removed">-                    &quot;# Safepoint: poll for GC&quot;);</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-modified-added">+     st-&gt;print_cr(&quot;movq    rscratch1, poll_offset[r15_thread] #polling_page_address\n\t&quot;</span>
<span class="udiff-line-modified-added">+                  &quot;testl   rax, [rscratch1]\t&quot;</span>
<span class="udiff-line-modified-added">+                  &quot;# Safepoint: poll for GC&quot;);</span>
    }
  }
  #endif
  
  void MachEpilogNode::emit(CodeBuffer&amp; cbuf, PhaseRegAlloc* ra_) const
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -971,24 +955,13 @@</span>
      __ reserved_stack_check();
    }
  
    if (do_polling() &amp;&amp; C-&gt;is_method_compilation()) {
      MacroAssembler _masm(&amp;cbuf);
<span class="udiff-line-modified-removed">-     if (SafepointMechanism::uses_thread_local_poll()) {</span>
<span class="udiff-line-modified-removed">-       __ movq(rscratch1, Address(r15_thread, Thread::polling_page_offset()));</span>
<span class="udiff-line-modified-removed">-       __ relocate(relocInfo::poll_return_type);</span>
<span class="udiff-line-removed">-       __ testl(rax, Address(rscratch1, 0));</span>
<span class="udiff-line-removed">-     } else {</span>
<span class="udiff-line-removed">-       AddressLiteral polling_page(os::get_polling_page(), relocInfo::poll_return_type);</span>
<span class="udiff-line-removed">-       if (Assembler::is_polling_page_far()) {</span>
<span class="udiff-line-removed">-         __ lea(rscratch1, polling_page);</span>
<span class="udiff-line-removed">-         __ relocate(relocInfo::poll_return_type);</span>
<span class="udiff-line-removed">-         __ testl(rax, Address(rscratch1, 0));</span>
<span class="udiff-line-removed">-       } else {</span>
<span class="udiff-line-removed">-         __ testl(rax, polling_page);</span>
<span class="udiff-line-removed">-       }</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-modified-added">+     __ movq(rscratch1, Address(r15_thread, Thread::polling_page_offset()));</span>
<span class="udiff-line-modified-added">+     __ relocate(relocInfo::poll_return_type);</span>
<span class="udiff-line-modified-added">+     __ testl(rax, Address(rscratch1, 0));</span>
    }
  }
  
  int MachEpilogNode::reloc() const
  {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -998,15 +971,10 @@</span>
  const Pipeline* MachEpilogNode::pipeline() const
  {
    return MachNode::pipeline_class();
  }
  
<span class="udiff-line-removed">- int MachEpilogNode::safepoint_offset() const</span>
<span class="udiff-line-removed">- {</span>
<span class="udiff-line-removed">-   return 0;</span>
<span class="udiff-line-removed">- }</span>
<span class="udiff-line-removed">- </span>
  //=============================================================================
  
  enum RC {
    rc_bad,
    rc_int,
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -12720,45 +12688,12 @@</span>
  %}
  
  
  // ============================================================================
  // Safepoint Instructions
<span class="udiff-line-removed">- instruct safePoint_poll(rFlagsReg cr)</span>
<span class="udiff-line-removed">- %{</span>
<span class="udiff-line-removed">-   predicate(!Assembler::is_polling_page_far() &amp;&amp; SafepointMechanism::uses_global_page_poll());</span>
<span class="udiff-line-removed">-   match(SafePoint);</span>
<span class="udiff-line-removed">-   effect(KILL cr);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-   format %{ &quot;testl   rax, [rip + #offset_to_poll_page]\t&quot;</span>
<span class="udiff-line-removed">-             &quot;# Safepoint: poll for GC&quot; %}</span>
<span class="udiff-line-removed">-   ins_cost(125);</span>
<span class="udiff-line-removed">-   ins_encode %{</span>
<span class="udiff-line-removed">-     AddressLiteral addr(os::get_polling_page(), relocInfo::poll_type);</span>
<span class="udiff-line-removed">-     __ testl(rax, addr);</span>
<span class="udiff-line-removed">-   %}</span>
<span class="udiff-line-removed">-   ins_pipe(ialu_reg_mem);</span>
<span class="udiff-line-removed">- %}</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">- instruct safePoint_poll_far(rFlagsReg cr, rRegP poll)</span>
<span class="udiff-line-removed">- %{</span>
<span class="udiff-line-removed">-   predicate(Assembler::is_polling_page_far() &amp;&amp; SafepointMechanism::uses_global_page_poll());</span>
<span class="udiff-line-removed">-   match(SafePoint poll);</span>
<span class="udiff-line-removed">-   effect(KILL cr, USE poll);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-   format %{ &quot;testl   rax, [$poll]\t&quot;</span>
<span class="udiff-line-removed">-             &quot;# Safepoint: poll for GC&quot; %}</span>
<span class="udiff-line-removed">-   ins_cost(125);</span>
<span class="udiff-line-removed">-   ins_encode %{</span>
<span class="udiff-line-removed">-     __ relocate(relocInfo::poll_type);</span>
<span class="udiff-line-removed">-     __ testl(rax, Address($poll$$Register, 0));</span>
<span class="udiff-line-removed">-   %}</span>
<span class="udiff-line-removed">-   ins_pipe(ialu_reg_mem);</span>
<span class="udiff-line-removed">- %}</span>
<span class="udiff-line-removed">- </span>
  instruct safePoint_poll_tls(rFlagsReg cr, rRegP poll)
  %{
<span class="udiff-line-removed">-   predicate(SafepointMechanism::uses_thread_local_poll());</span>
    match(SafePoint poll);
    effect(KILL cr, USE poll);
  
    format %{ &quot;testl   rax, [$poll]\t&quot;
              &quot;# Safepoint: poll for GC&quot; %}
</pre>
<center><a href="x86_32.ad.udiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="../../share/adlc/formssel.cpp.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>