<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames src/hotspot/cpu/x86/interp_masm_x86.cpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
    <script type="text/javascript" src="../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>   1 /*
   2  * Copyright (c) 1997, 2020, Oracle and/or its affiliates. All rights reserved.
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.
   8  *
   9  * This code is distributed in the hope that it will be useful, but WITHOUT
  10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  *
  23  */
  24 
  25 #include &quot;precompiled.hpp&quot;
  26 #include &quot;interp_masm_x86.hpp&quot;
  27 #include &quot;interpreter/interpreter.hpp&quot;
  28 #include &quot;interpreter/interpreterRuntime.hpp&quot;
  29 #include &quot;logging/log.hpp&quot;
  30 #include &quot;oops/arrayOop.hpp&quot;
  31 #include &quot;oops/markWord.hpp&quot;
  32 #include &quot;oops/methodData.hpp&quot;
  33 #include &quot;oops/method.hpp&quot;
  34 #include &quot;oops/valueKlass.hpp&quot;
  35 #include &quot;prims/jvmtiExport.hpp&quot;
  36 #include &quot;prims/jvmtiThreadState.hpp&quot;
  37 #include &quot;runtime/basicLock.hpp&quot;
  38 #include &quot;runtime/biasedLocking.hpp&quot;
  39 #include &quot;runtime/frame.inline.hpp&quot;
  40 #include &quot;runtime/safepointMechanism.hpp&quot;
  41 #include &quot;runtime/sharedRuntime.hpp&quot;
  42 #include &quot;runtime/thread.inline.hpp&quot;
  43 #include &quot;utilities/powerOfTwo.hpp&quot;
  44 
  45 // Implementation of InterpreterMacroAssembler
  46 
  47 void InterpreterMacroAssembler::jump_to_entry(address entry) {
  48   assert(entry, &quot;Entry must have been generated by now&quot;);
  49   jump(RuntimeAddress(entry));
  50 }
  51 
  52 void InterpreterMacroAssembler::profile_obj_type(Register obj, const Address&amp; mdo_addr) {
  53   Label update, next, none;
  54 
  55   interp_verify_oop(obj, atos);
  56 
  57   testptr(obj, obj);
  58   jccb(Assembler::notZero, update);
  59   orptr(mdo_addr, TypeEntries::null_seen);
  60   jmpb(next);
  61 
  62   bind(update);
  63   load_klass(obj, obj);
  64 
  65   xorptr(obj, mdo_addr);
  66   testptr(obj, TypeEntries::type_klass_mask);
  67   jccb(Assembler::zero, next); // klass seen before, nothing to
  68                                // do. The unknown bit may have been
  69                                // set already but no need to check.
  70 
  71   testptr(obj, TypeEntries::type_unknown);
  72   jccb(Assembler::notZero, next); // already unknown. Nothing to do anymore.
  73 
  74   cmpptr(mdo_addr, 0);
  75   jccb(Assembler::equal, none);
  76   cmpptr(mdo_addr, TypeEntries::null_seen);
  77   jccb(Assembler::equal, none);
  78   // There is a chance that the checks above (re-reading profiling
  79   // data from memory) fail if another thread has just set the
  80   // profiling to this obj&#39;s klass
  81   xorptr(obj, mdo_addr);
  82   testptr(obj, TypeEntries::type_klass_mask);
  83   jccb(Assembler::zero, next);
  84 
  85   // different than before. Cannot keep accurate profile.
  86   orptr(mdo_addr, TypeEntries::type_unknown);
  87   jmpb(next);
  88 
  89   bind(none);
  90   // first time here. Set profile type.
  91   movptr(mdo_addr, obj);
  92 
  93   bind(next);
  94 }
  95 
  96 void InterpreterMacroAssembler::profile_arguments_type(Register mdp, Register callee, Register tmp, bool is_virtual) {
  97   if (!ProfileInterpreter) {
  98     return;
  99   }
 100 
 101   if (MethodData::profile_arguments() || MethodData::profile_return()) {
 102     Label profile_continue;
 103 
 104     test_method_data_pointer(mdp, profile_continue);
 105 
 106     int off_to_start = is_virtual ? in_bytes(VirtualCallData::virtual_call_data_size()) : in_bytes(CounterData::counter_data_size());
 107 
 108     cmpb(Address(mdp, in_bytes(DataLayout::tag_offset()) - off_to_start), is_virtual ? DataLayout::virtual_call_type_data_tag : DataLayout::call_type_data_tag);
 109     jcc(Assembler::notEqual, profile_continue);
 110 
 111     if (MethodData::profile_arguments()) {
 112       Label done;
 113       int off_to_args = in_bytes(TypeEntriesAtCall::args_data_offset());
 114       addptr(mdp, off_to_args);
 115 
 116       for (int i = 0; i &lt; TypeProfileArgsLimit; i++) {
 117         if (i &gt; 0 || MethodData::profile_return()) {
 118           // If return value type is profiled we may have no argument to profile
 119           movptr(tmp, Address(mdp, in_bytes(TypeEntriesAtCall::cell_count_offset())-off_to_args));
 120           subl(tmp, i*TypeStackSlotEntries::per_arg_count());
 121           cmpl(tmp, TypeStackSlotEntries::per_arg_count());
 122           jcc(Assembler::less, done);
 123         }
 124         movptr(tmp, Address(callee, Method::const_offset()));
 125         load_unsigned_short(tmp, Address(tmp, ConstMethod::size_of_parameters_offset()));
 126         // stack offset o (zero based) from the start of the argument
 127         // list, for n arguments translates into offset n - o - 1 from
 128         // the end of the argument list
 129         subptr(tmp, Address(mdp, in_bytes(TypeEntriesAtCall::stack_slot_offset(i))-off_to_args));
 130         subl(tmp, 1);
 131         Address arg_addr = argument_address(tmp);
 132         movptr(tmp, arg_addr);
 133 
 134         Address mdo_arg_addr(mdp, in_bytes(TypeEntriesAtCall::argument_type_offset(i))-off_to_args);
 135         profile_obj_type(tmp, mdo_arg_addr);
 136 
 137         int to_add = in_bytes(TypeStackSlotEntries::per_arg_size());
 138         addptr(mdp, to_add);
 139         off_to_args += to_add;
 140       }
 141 
 142       if (MethodData::profile_return()) {
 143         movptr(tmp, Address(mdp, in_bytes(TypeEntriesAtCall::cell_count_offset())-off_to_args));
 144         subl(tmp, TypeProfileArgsLimit*TypeStackSlotEntries::per_arg_count());
 145       }
 146 
 147       bind(done);
 148 
 149       if (MethodData::profile_return()) {
 150         // We&#39;re right after the type profile for the last
 151         // argument. tmp is the number of cells left in the
 152         // CallTypeData/VirtualCallTypeData to reach its end. Non null
 153         // if there&#39;s a return to profile.
 154         assert(SingleTypeEntry::static_cell_count() &lt; TypeStackSlotEntries::per_arg_count(), &quot;can&#39;t move past ret type&quot;);
 155         shll(tmp, exact_log2(DataLayout::cell_size));
 156         addptr(mdp, tmp);
 157       }
 158       movptr(Address(rbp, frame::interpreter_frame_mdp_offset * wordSize), mdp);
 159     } else {
 160       assert(MethodData::profile_return(), &quot;either profile call args or call ret&quot;);
 161       update_mdp_by_constant(mdp, in_bytes(TypeEntriesAtCall::return_only_size()));
 162     }
 163 
 164     // mdp points right after the end of the
 165     // CallTypeData/VirtualCallTypeData, right after the cells for the
 166     // return value type if there&#39;s one
 167 
 168     bind(profile_continue);
 169   }
 170 }
 171 
 172 void InterpreterMacroAssembler::profile_return_type(Register mdp, Register ret, Register tmp) {
 173   assert_different_registers(mdp, ret, tmp, _bcp_register);
 174   if (ProfileInterpreter &amp;&amp; MethodData::profile_return()) {
 175     Label profile_continue;
 176 
 177     test_method_data_pointer(mdp, profile_continue);
 178 
 179     if (MethodData::profile_return_jsr292_only()) {
 180       assert(Method::intrinsic_id_size_in_bytes() == 2, &quot;assuming Method::_intrinsic_id is u2&quot;);
 181 
 182       // If we don&#39;t profile all invoke bytecodes we must make sure
 183       // it&#39;s a bytecode we indeed profile. We can&#39;t go back to the
 184       // begining of the ProfileData we intend to update to check its
 185       // type because we&#39;re right after it and we don&#39;t known its
 186       // length
 187       Label do_profile;
 188       cmpb(Address(_bcp_register, 0), Bytecodes::_invokedynamic);
 189       jcc(Assembler::equal, do_profile);
 190       cmpb(Address(_bcp_register, 0), Bytecodes::_invokehandle);
 191       jcc(Assembler::equal, do_profile);
 192       get_method(tmp);
 193       cmpw(Address(tmp, Method::intrinsic_id_offset_in_bytes()), vmIntrinsics::_compiledLambdaForm);
 194       jcc(Assembler::notEqual, profile_continue);
 195 
 196       bind(do_profile);
 197     }
 198 
 199     Address mdo_ret_addr(mdp, -in_bytes(SingleTypeEntry::size()));
 200     mov(tmp, ret);
 201     profile_obj_type(tmp, mdo_ret_addr);
 202 
 203     bind(profile_continue);
 204   }
 205 }
 206 
 207 void InterpreterMacroAssembler::profile_parameters_type(Register mdp, Register tmp1, Register tmp2) {
 208   if (ProfileInterpreter &amp;&amp; MethodData::profile_parameters()) {
 209     Label profile_continue;
 210 
 211     test_method_data_pointer(mdp, profile_continue);
 212 
 213     // Load the offset of the area within the MDO used for
 214     // parameters. If it&#39;s negative we&#39;re not profiling any parameters
 215     movl(tmp1, Address(mdp, in_bytes(MethodData::parameters_type_data_di_offset()) - in_bytes(MethodData::data_offset())));
 216     testl(tmp1, tmp1);
 217     jcc(Assembler::negative, profile_continue);
 218 
 219     // Compute a pointer to the area for parameters from the offset
 220     // and move the pointer to the slot for the last
 221     // parameters. Collect profiling from last parameter down.
 222     // mdo start + parameters offset + array length - 1
 223     addptr(mdp, tmp1);
 224     movptr(tmp1, Address(mdp, ArrayData::array_len_offset()));
 225     decrement(tmp1, TypeStackSlotEntries::per_arg_count());
 226 
 227     Label loop;
 228     bind(loop);
 229 
 230     int off_base = in_bytes(ParametersTypeData::stack_slot_offset(0));
 231     int type_base = in_bytes(ParametersTypeData::type_offset(0));
 232     Address::ScaleFactor per_arg_scale = Address::times(DataLayout::cell_size);
 233     Address arg_off(mdp, tmp1, per_arg_scale, off_base);
 234     Address arg_type(mdp, tmp1, per_arg_scale, type_base);
 235 
 236     // load offset on the stack from the slot for this parameter
 237     movptr(tmp2, arg_off);
 238     negptr(tmp2);
 239     // read the parameter from the local area
 240     movptr(tmp2, Address(_locals_register, tmp2, Interpreter::stackElementScale()));
 241 
 242     // profile the parameter
 243     profile_obj_type(tmp2, arg_type);
 244 
 245     // go to next parameter
 246     decrement(tmp1, TypeStackSlotEntries::per_arg_count());
 247     jcc(Assembler::positive, loop);
 248 
 249     bind(profile_continue);
 250   }
 251 }
 252 
 253 void InterpreterMacroAssembler::call_VM_leaf_base(address entry_point,
 254                                                   int number_of_arguments) {
 255   // interpreter specific
 256   //
 257   // Note: No need to save/restore bcp &amp; locals registers
 258   //       since these are callee saved registers and no blocking/
 259   //       GC can happen in leaf calls.
 260   // Further Note: DO NOT save/restore bcp/locals. If a caller has
 261   // already saved them so that it can use rsi/rdi as temporaries
 262   // then a save/restore here will DESTROY the copy the caller
 263   // saved! There used to be a save_bcp() that only happened in
 264   // the ASSERT path (no restore_bcp). Which caused bizarre failures
 265   // when jvm built with ASSERTs.
 266 #ifdef ASSERT
 267   {
 268     Label L;
 269     cmpptr(Address(rbp, frame::interpreter_frame_last_sp_offset * wordSize), (int32_t)NULL_WORD);
 270     jcc(Assembler::equal, L);
 271     stop(&quot;InterpreterMacroAssembler::call_VM_leaf_base:&quot;
 272          &quot; last_sp != NULL&quot;);
 273     bind(L);
 274   }
 275 #endif
 276   // super call
 277   MacroAssembler::call_VM_leaf_base(entry_point, number_of_arguments);
 278   // interpreter specific
 279   // LP64: Used to ASSERT that r13/r14 were equal to frame&#39;s bcp/locals
 280   // but since they may not have been saved (and we don&#39;t want to
 281   // save them here (see note above) the assert is invalid.
 282 }
 283 
 284 void InterpreterMacroAssembler::call_VM_base(Register oop_result,
 285                                              Register java_thread,
 286                                              Register last_java_sp,
 287                                              address  entry_point,
 288                                              int      number_of_arguments,
 289                                              bool     check_exceptions) {
 290   // interpreter specific
 291   //
 292   // Note: Could avoid restoring locals ptr (callee saved) - however doesn&#39;t
 293   //       really make a difference for these runtime calls, since they are
 294   //       slow anyway. Btw., bcp must be saved/restored since it may change
 295   //       due to GC.
 296   NOT_LP64(assert(java_thread == noreg , &quot;not expecting a precomputed java thread&quot;);)
 297   save_bcp();
 298 #ifdef ASSERT
 299   {
 300     Label L;
 301     cmpptr(Address(rbp, frame::interpreter_frame_last_sp_offset * wordSize), (int32_t)NULL_WORD);
 302     jcc(Assembler::equal, L);
 303     stop(&quot;InterpreterMacroAssembler::call_VM_base:&quot;
 304          &quot; last_sp != NULL&quot;);
 305     bind(L);
 306   }
 307 #endif /* ASSERT */
 308   // super call
 309   MacroAssembler::call_VM_base(oop_result, noreg, last_java_sp,
 310                                entry_point, number_of_arguments,
 311                                check_exceptions);
 312   // interpreter specific
 313   restore_bcp();
 314   restore_locals();
 315 }
 316 
 317 void InterpreterMacroAssembler::check_and_handle_popframe(Register java_thread) {
 318   if (JvmtiExport::can_pop_frame()) {
 319     Label L;
 320     // Initiate popframe handling only if it is not already being
 321     // processed.  If the flag has the popframe_processing bit set, it
 322     // means that this code is called *during* popframe handling - we
 323     // don&#39;t want to reenter.
 324     // This method is only called just after the call into the vm in
 325     // call_VM_base, so the arg registers are available.
 326     Register pop_cond = NOT_LP64(java_thread) // Not clear if any other register is available on 32 bit
 327                         LP64_ONLY(c_rarg0);
 328     movl(pop_cond, Address(java_thread, JavaThread::popframe_condition_offset()));
 329     testl(pop_cond, JavaThread::popframe_pending_bit);
 330     jcc(Assembler::zero, L);
 331     testl(pop_cond, JavaThread::popframe_processing_bit);
 332     jcc(Assembler::notZero, L);
 333     // Call Interpreter::remove_activation_preserving_args_entry() to get the
 334     // address of the same-named entrypoint in the generated interpreter code.
 335     call_VM_leaf(CAST_FROM_FN_PTR(address, Interpreter::remove_activation_preserving_args_entry));
 336     jmp(rax);
 337     bind(L);
 338     NOT_LP64(get_thread(java_thread);)
 339   }
 340 }
 341 
 342 void InterpreterMacroAssembler::load_earlyret_value(TosState state) {
 343   Register thread = LP64_ONLY(r15_thread) NOT_LP64(rcx);
 344   NOT_LP64(get_thread(thread);)
 345   movptr(rcx, Address(thread, JavaThread::jvmti_thread_state_offset()));
 346   const Address tos_addr(rcx, JvmtiThreadState::earlyret_tos_offset());
 347   const Address oop_addr(rcx, JvmtiThreadState::earlyret_oop_offset());
 348   const Address val_addr(rcx, JvmtiThreadState::earlyret_value_offset());
 349 #ifdef _LP64
 350   switch (state) {
 351     case atos: movptr(rax, oop_addr);
 352                movptr(oop_addr, (int32_t)NULL_WORD);
 353                interp_verify_oop(rax, state);         break;
 354     case ltos: movptr(rax, val_addr);                 break;
 355     case btos:                                   // fall through
 356     case ztos:                                   // fall through
 357     case ctos:                                   // fall through
 358     case stos:                                   // fall through
 359     case itos: movl(rax, val_addr);                 break;
 360     case ftos: load_float(val_addr);                break;
 361     case dtos: load_double(val_addr);               break;
 362     case vtos: /* nothing to do */                  break;
 363     default  : ShouldNotReachHere();
 364   }
 365   // Clean up tos value in the thread object
 366   movl(tos_addr,  (int) ilgl);
 367   movl(val_addr,  (int32_t) NULL_WORD);
 368 #else
 369   const Address val_addr1(rcx, JvmtiThreadState::earlyret_value_offset()
 370                              + in_ByteSize(wordSize));
 371   switch (state) {
 372     case atos: movptr(rax, oop_addr);
 373                movptr(oop_addr, NULL_WORD);
 374                interp_verify_oop(rax, state);         break;
 375     case ltos:
 376                movl(rdx, val_addr1);               // fall through
 377     case btos:                                     // fall through
 378     case ztos:                                     // fall through
 379     case ctos:                                     // fall through
 380     case stos:                                     // fall through
 381     case itos: movl(rax, val_addr);                   break;
 382     case ftos: load_float(val_addr);                  break;
 383     case dtos: load_double(val_addr);                 break;
 384     case vtos: /* nothing to do */                    break;
 385     default  : ShouldNotReachHere();
 386   }
 387 #endif // _LP64
 388   // Clean up tos value in the thread object
 389   movl(tos_addr,  (int32_t) ilgl);
 390   movptr(val_addr,  NULL_WORD);
 391   NOT_LP64(movptr(val_addr1, NULL_WORD);)
 392 }
 393 
 394 
 395 void InterpreterMacroAssembler::check_and_handle_earlyret(Register java_thread) {
 396   if (JvmtiExport::can_force_early_return()) {
 397     Label L;
 398     Register tmp = LP64_ONLY(c_rarg0) NOT_LP64(java_thread);
 399     Register rthread = LP64_ONLY(r15_thread) NOT_LP64(java_thread);
 400 
 401     movptr(tmp, Address(rthread, JavaThread::jvmti_thread_state_offset()));
 402     testptr(tmp, tmp);
 403     jcc(Assembler::zero, L); // if (thread-&gt;jvmti_thread_state() == NULL) exit;
 404 
 405     // Initiate earlyret handling only if it is not already being processed.
 406     // If the flag has the earlyret_processing bit set, it means that this code
 407     // is called *during* earlyret handling - we don&#39;t want to reenter.
 408     movl(tmp, Address(tmp, JvmtiThreadState::earlyret_state_offset()));
 409     cmpl(tmp, JvmtiThreadState::earlyret_pending);
 410     jcc(Assembler::notEqual, L);
 411 
 412     // Call Interpreter::remove_activation_early_entry() to get the address of the
 413     // same-named entrypoint in the generated interpreter code.
 414     NOT_LP64(get_thread(java_thread);)
 415     movptr(tmp, Address(rthread, JavaThread::jvmti_thread_state_offset()));
 416 #ifdef _LP64
 417     movl(tmp, Address(tmp, JvmtiThreadState::earlyret_tos_offset()));
 418     call_VM_leaf(CAST_FROM_FN_PTR(address, Interpreter::remove_activation_early_entry), tmp);
 419 #else
 420     pushl(Address(tmp, JvmtiThreadState::earlyret_tos_offset()));
 421     call_VM_leaf(CAST_FROM_FN_PTR(address, Interpreter::remove_activation_early_entry), 1);
 422 #endif // _LP64
 423     jmp(rax);
 424     bind(L);
 425     NOT_LP64(get_thread(java_thread);)
 426   }
 427 }
 428 
 429 void InterpreterMacroAssembler::get_unsigned_2_byte_index_at_bcp(Register reg, int bcp_offset) {
 430   assert(bcp_offset &gt;= 0, &quot;bcp is still pointing to start of bytecode&quot;);
 431   load_unsigned_short(reg, Address(_bcp_register, bcp_offset));
 432   bswapl(reg);
 433   shrl(reg, 16);
 434 }
 435 
 436 void InterpreterMacroAssembler::get_cache_index_at_bcp(Register index,
 437                                                        int bcp_offset,
 438                                                        size_t index_size) {
 439   assert(bcp_offset &gt; 0, &quot;bcp is still pointing to start of bytecode&quot;);
 440   if (index_size == sizeof(u2)) {
 441     load_unsigned_short(index, Address(_bcp_register, bcp_offset));
 442   } else if (index_size == sizeof(u4)) {
 443     movl(index, Address(_bcp_register, bcp_offset));
 444     // Check if the secondary index definition is still ~x, otherwise
 445     // we have to change the following assembler code to calculate the
 446     // plain index.
 447     assert(ConstantPool::decode_invokedynamic_index(~123) == 123, &quot;else change next line&quot;);
 448     notl(index);  // convert to plain index
 449   } else if (index_size == sizeof(u1)) {
 450     load_unsigned_byte(index, Address(_bcp_register, bcp_offset));
 451   } else {
 452     ShouldNotReachHere();
 453   }
 454 }
 455 
 456 void InterpreterMacroAssembler::get_cache_and_index_at_bcp(Register cache,
 457                                                            Register index,
 458                                                            int bcp_offset,
 459                                                            size_t index_size) {
 460   assert_different_registers(cache, index);
 461   get_cache_index_at_bcp(index, bcp_offset, index_size);
 462   movptr(cache, Address(rbp, frame::interpreter_frame_cache_offset * wordSize));
 463   assert(sizeof(ConstantPoolCacheEntry) == 4 * wordSize, &quot;adjust code below&quot;);
 464   // convert from field index to ConstantPoolCacheEntry index
 465   assert(exact_log2(in_words(ConstantPoolCacheEntry::size())) == 2, &quot;else change next line&quot;);
 466   shll(index, 2);
 467 }
 468 
 469 void InterpreterMacroAssembler::get_cache_and_index_and_bytecode_at_bcp(Register cache,
 470                                                                         Register index,
 471                                                                         Register bytecode,
 472                                                                         int byte_no,
 473                                                                         int bcp_offset,
 474                                                                         size_t index_size) {
 475   get_cache_and_index_at_bcp(cache, index, bcp_offset, index_size);
 476   // We use a 32-bit load here since the layout of 64-bit words on
 477   // little-endian machines allow us that.
 478   movl(bytecode, Address(cache, index, Address::times_ptr, ConstantPoolCache::base_offset() + ConstantPoolCacheEntry::indices_offset()));
 479   const int shift_count = (1 + byte_no) * BitsPerByte;
 480   assert((byte_no == TemplateTable::f1_byte &amp;&amp; shift_count == ConstantPoolCacheEntry::bytecode_1_shift) ||
 481          (byte_no == TemplateTable::f2_byte &amp;&amp; shift_count == ConstantPoolCacheEntry::bytecode_2_shift),
 482          &quot;correct shift count&quot;);
 483   shrl(bytecode, shift_count);
 484   assert(ConstantPoolCacheEntry::bytecode_1_mask == ConstantPoolCacheEntry::bytecode_2_mask, &quot;common mask&quot;);
 485   andl(bytecode, ConstantPoolCacheEntry::bytecode_1_mask);
 486 }
 487 
 488 void InterpreterMacroAssembler::get_cache_entry_pointer_at_bcp(Register cache,
 489                                                                Register tmp,
 490                                                                int bcp_offset,
 491                                                                size_t index_size) {
 492   assert_different_registers(cache, tmp);
 493 
 494   get_cache_index_at_bcp(tmp, bcp_offset, index_size);
 495   assert(sizeof(ConstantPoolCacheEntry) == 4 * wordSize, &quot;adjust code below&quot;);
 496   // convert from field index to ConstantPoolCacheEntry index
 497   // and from word offset to byte offset
 498   assert(exact_log2(in_bytes(ConstantPoolCacheEntry::size_in_bytes())) == 2 + LogBytesPerWord, &quot;else change next line&quot;);
 499   shll(tmp, 2 + LogBytesPerWord);
 500   movptr(cache, Address(rbp, frame::interpreter_frame_cache_offset * wordSize));
 501   // skip past the header
 502   addptr(cache, in_bytes(ConstantPoolCache::base_offset()));
 503   addptr(cache, tmp);  // construct pointer to cache entry
 504 }
 505 
 506 // Load object from cpool-&gt;resolved_references(index)
 507 void InterpreterMacroAssembler::load_resolved_reference_at_index(Register result,
 508                                                                  Register index,
 509                                                                  Register tmp) {
 510   assert_different_registers(result, index);
 511 
 512   get_constant_pool(result);
 513   // load pointer for resolved_references[] objArray
 514   movptr(result, Address(result, ConstantPool::cache_offset_in_bytes()));
 515   movptr(result, Address(result, ConstantPoolCache::resolved_references_offset_in_bytes()));
 516   resolve_oop_handle(result, tmp);
 517   load_heap_oop(result, Address(result, index,
 518                                 UseCompressedOops ? Address::times_4 : Address::times_ptr,
 519                                 arrayOopDesc::base_offset_in_bytes(T_OBJECT)), tmp);
 520 }
 521 
 522 // load cpool-&gt;resolved_klass_at(index)
 523 void InterpreterMacroAssembler::load_resolved_klass_at_index(Register klass,
 524                                                              Register cpool,
 525                                                              Register index) {
 526   assert_different_registers(cpool, index);
 527 
 528   movw(index, Address(cpool, index, Address::times_ptr, sizeof(ConstantPool)));
 529   Register resolved_klasses = cpool;
 530   movptr(resolved_klasses, Address(cpool, ConstantPool::resolved_klasses_offset_in_bytes()));
 531   movptr(klass, Address(resolved_klasses, index, Address::times_ptr, Array&lt;Klass*&gt;::base_offset_in_bytes()));
 532 }
 533 
 534 void InterpreterMacroAssembler::load_resolved_method_at_index(int byte_no,
 535                                                               Register method,
 536                                                               Register cache,
 537                                                               Register index) {
 538   assert_different_registers(cache, index);
 539 
 540   const int method_offset = in_bytes(
 541     ConstantPoolCache::base_offset() +
 542       ((byte_no == TemplateTable::f2_byte)
 543        ? ConstantPoolCacheEntry::f2_offset()
 544        : ConstantPoolCacheEntry::f1_offset()));
 545 
 546   movptr(method, Address(cache, index, Address::times_ptr, method_offset)); // get f1 Method*
 547 }
 548 
 549 // Generate a subtype check: branch to ok_is_subtype if sub_klass is a
 550 // subtype of super_klass.
 551 //
 552 // Args:
 553 //      rax: superklass
 554 //      Rsub_klass: subklass
 555 //
 556 // Kills:
 557 //      rcx, rdi
 558 void InterpreterMacroAssembler::gen_subtype_check(Register Rsub_klass,
 559                                                   Label&amp; ok_is_subtype,
 560                                                   bool profile) {
 561   assert(Rsub_klass != rax, &quot;rax holds superklass&quot;);
 562   LP64_ONLY(assert(Rsub_klass != r14, &quot;r14 holds locals&quot;);)
 563   LP64_ONLY(assert(Rsub_klass != r13, &quot;r13 holds bcp&quot;);)
 564   assert(Rsub_klass != rcx, &quot;rcx holds 2ndary super array length&quot;);
 565   assert(Rsub_klass != rdi, &quot;rdi holds 2ndary super array scan ptr&quot;);
 566 
 567   // Profile the not-null value&#39;s klass.
 568   if (profile) {
 569     profile_typecheck(rcx, Rsub_klass, rdi); // blows rcx, reloads rdi
 570   }
 571 
 572   // Do the check.
 573   check_klass_subtype(Rsub_klass, rax, rcx, ok_is_subtype); // blows rcx
 574 
 575   // Profile the failure of the check.
 576   if (profile) {
 577     profile_typecheck_failed(rcx); // blows rcx
 578   }
 579 }
 580 
 581 
 582 #ifndef _LP64
 583 void InterpreterMacroAssembler::f2ieee() {
 584   if (IEEEPrecision) {
 585     fstp_s(Address(rsp, 0));
 586     fld_s(Address(rsp, 0));
 587   }
 588 }
 589 
 590 
 591 void InterpreterMacroAssembler::d2ieee() {
 592   if (IEEEPrecision) {
 593     fstp_d(Address(rsp, 0));
 594     fld_d(Address(rsp, 0));
 595   }
 596 }
 597 #endif // _LP64
 598 
 599 // Java Expression Stack
 600 
 601 void InterpreterMacroAssembler::pop_ptr(Register r) {
 602   pop(r);
 603 }
 604 
 605 void InterpreterMacroAssembler::push_ptr(Register r) {
 606   push(r);
 607 }
 608 
 609 void InterpreterMacroAssembler::push_i(Register r) {
 610   push(r);
 611 }
 612 
 613 void InterpreterMacroAssembler::push_f(XMMRegister r) {
 614   subptr(rsp, wordSize);
 615   movflt(Address(rsp, 0), r);
 616 }
 617 
 618 void InterpreterMacroAssembler::pop_f(XMMRegister r) {
 619   movflt(r, Address(rsp, 0));
 620   addptr(rsp, wordSize);
 621 }
 622 
 623 void InterpreterMacroAssembler::push_d(XMMRegister r) {
 624   subptr(rsp, 2 * wordSize);
 625   movdbl(Address(rsp, 0), r);
 626 }
 627 
 628 void InterpreterMacroAssembler::pop_d(XMMRegister r) {
 629   movdbl(r, Address(rsp, 0));
 630   addptr(rsp, 2 * Interpreter::stackElementSize);
 631 }
 632 
 633 #ifdef _LP64
 634 void InterpreterMacroAssembler::pop_i(Register r) {
 635   // XXX can&#39;t use pop currently, upper half non clean
 636   movl(r, Address(rsp, 0));
 637   addptr(rsp, wordSize);
 638 }
 639 
 640 void InterpreterMacroAssembler::pop_l(Register r) {
 641   movq(r, Address(rsp, 0));
 642   addptr(rsp, 2 * Interpreter::stackElementSize);
 643 }
 644 
 645 void InterpreterMacroAssembler::push_l(Register r) {
 646   subptr(rsp, 2 * wordSize);
 647   movptr(Address(rsp, Interpreter::expr_offset_in_bytes(0)), r         );
 648   movptr(Address(rsp, Interpreter::expr_offset_in_bytes(1)), NULL_WORD );
 649 }
 650 
 651 void InterpreterMacroAssembler::pop(TosState state) {
 652   switch (state) {
 653   case atos: pop_ptr();                 break;
 654   case btos:
 655   case ztos:
 656   case ctos:
 657   case stos:
 658   case itos: pop_i();                   break;
 659   case ltos: pop_l();                   break;
 660   case ftos: pop_f(xmm0);               break;
 661   case dtos: pop_d(xmm0);               break;
 662   case vtos: /* nothing to do */        break;
 663   default:   ShouldNotReachHere();
 664   }
 665   interp_verify_oop(rax, state);
 666 }
 667 
 668 void InterpreterMacroAssembler::push(TosState state) {
 669   interp_verify_oop(rax, state);
 670   switch (state) {
 671   case atos: push_ptr();                break;
 672   case btos:
 673   case ztos:
 674   case ctos:
 675   case stos:
 676   case itos: push_i();                  break;
 677   case ltos: push_l();                  break;
 678   case ftos: push_f(xmm0);              break;
 679   case dtos: push_d(xmm0);              break;
 680   case vtos: /* nothing to do */        break;
 681   default  : ShouldNotReachHere();
 682   }
 683 }
 684 #else
 685 void InterpreterMacroAssembler::pop_i(Register r) {
 686   pop(r);
 687 }
 688 
 689 void InterpreterMacroAssembler::pop_l(Register lo, Register hi) {
 690   pop(lo);
 691   pop(hi);
 692 }
 693 
 694 void InterpreterMacroAssembler::pop_f() {
 695   fld_s(Address(rsp, 0));
 696   addptr(rsp, 1 * wordSize);
 697 }
 698 
 699 void InterpreterMacroAssembler::pop_d() {
 700   fld_d(Address(rsp, 0));
 701   addptr(rsp, 2 * wordSize);
 702 }
 703 
 704 
 705 void InterpreterMacroAssembler::pop(TosState state) {
 706   switch (state) {
 707     case atos: pop_ptr(rax);                                 break;
 708     case btos:                                               // fall through
 709     case ztos:                                               // fall through
 710     case ctos:                                               // fall through
 711     case stos:                                               // fall through
 712     case itos: pop_i(rax);                                   break;
 713     case ltos: pop_l(rax, rdx);                              break;
 714     case ftos:
 715       if (UseSSE &gt;= 1) {
 716         pop_f(xmm0);
 717       } else {
 718         pop_f();
 719       }
 720       break;
 721     case dtos:
 722       if (UseSSE &gt;= 2) {
 723         pop_d(xmm0);
 724       } else {
 725         pop_d();
 726       }
 727       break;
 728     case vtos: /* nothing to do */                           break;
 729     default  : ShouldNotReachHere();
 730   }
 731   interp_verify_oop(rax, state);
 732 }
 733 
 734 
 735 void InterpreterMacroAssembler::push_l(Register lo, Register hi) {
 736   push(hi);
 737   push(lo);
 738 }
 739 
 740 void InterpreterMacroAssembler::push_f() {
 741   // Do not schedule for no AGI! Never write beyond rsp!
 742   subptr(rsp, 1 * wordSize);
 743   fstp_s(Address(rsp, 0));
 744 }
 745 
 746 void InterpreterMacroAssembler::push_d() {
 747   // Do not schedule for no AGI! Never write beyond rsp!
 748   subptr(rsp, 2 * wordSize);
 749   fstp_d(Address(rsp, 0));
 750 }
 751 
 752 
 753 void InterpreterMacroAssembler::push(TosState state) {
 754   interp_verify_oop(rax, state);
 755   switch (state) {
 756     case atos: push_ptr(rax); break;
 757     case btos:                                               // fall through
 758     case ztos:                                               // fall through
 759     case ctos:                                               // fall through
 760     case stos:                                               // fall through
 761     case itos: push_i(rax);                                    break;
 762     case ltos: push_l(rax, rdx);                               break;
 763     case ftos:
 764       if (UseSSE &gt;= 1) {
 765         push_f(xmm0);
 766       } else {
 767         push_f();
 768       }
 769       break;
 770     case dtos:
 771       if (UseSSE &gt;= 2) {
 772         push_d(xmm0);
 773       } else {
 774         push_d();
 775       }
 776       break;
 777     case vtos: /* nothing to do */                             break;
 778     default  : ShouldNotReachHere();
 779   }
 780 }
 781 #endif // _LP64
 782 
 783 
 784 // Helpers for swap and dup
 785 void InterpreterMacroAssembler::load_ptr(int n, Register val) {
 786   movptr(val, Address(rsp, Interpreter::expr_offset_in_bytes(n)));
 787 }
 788 
 789 void InterpreterMacroAssembler::store_ptr(int n, Register val) {
 790   movptr(Address(rsp, Interpreter::expr_offset_in_bytes(n)), val);
 791 }
 792 
 793 
 794 void InterpreterMacroAssembler::prepare_to_jump_from_interpreted() {
 795   // set sender sp
 796   lea(_bcp_register, Address(rsp, wordSize));
 797   // record last_sp
 798   movptr(Address(rbp, frame::interpreter_frame_last_sp_offset * wordSize), _bcp_register);
 799 }
 800 
 801 
 802 // Jump to from_interpreted entry of a call unless single stepping is possible
 803 // in this thread in which case we must call the i2i entry
 804 void InterpreterMacroAssembler::jump_from_interpreted(Register method, Register temp) {
 805   prepare_to_jump_from_interpreted();
 806 
 807   if (JvmtiExport::can_post_interpreter_events()) {
 808     Label run_compiled_code;
 809     // JVMTI events, such as single-stepping, are implemented partly by avoiding running
 810     // compiled code in threads for which the event is enabled.  Check here for
 811     // interp_only_mode if these events CAN be enabled.
 812     // interp_only is an int, on little endian it is sufficient to test the byte only
 813     // Is a cmpl faster?
 814     LP64_ONLY(temp = r15_thread;)
 815     NOT_LP64(get_thread(temp);)
 816     cmpb(Address(temp, JavaThread::interp_only_mode_offset()), 0);
 817     jccb(Assembler::zero, run_compiled_code);
 818     jmp(Address(method, Method::interpreter_entry_offset()));
 819     bind(run_compiled_code);
 820   }
 821 
 822   jmp(Address(method, Method::from_interpreted_offset()));
 823 }
 824 
 825 // The following two routines provide a hook so that an implementation
 826 // can schedule the dispatch in two parts.  x86 does not do this.
 827 void InterpreterMacroAssembler::dispatch_prolog(TosState state, int step) {
 828   // Nothing x86 specific to be done here
 829 }
 830 
 831 void InterpreterMacroAssembler::dispatch_epilog(TosState state, int step) {
 832   dispatch_next(state, step);
 833 }
 834 
 835 void InterpreterMacroAssembler::dispatch_base(TosState state,
 836                                               address* table,
 837                                               bool verifyoop,
 838                                               bool generate_poll) {
 839   verify_FPU(1, state);
 840   if (VerifyActivationFrameSize) {
 841     Label L;
 842     mov(rcx, rbp);
 843     subptr(rcx, rsp);
 844     int32_t min_frame_size =
 845       (frame::link_offset - frame::interpreter_frame_initial_sp_offset) *
 846       wordSize;
 847     cmpptr(rcx, (int32_t)min_frame_size);
 848     jcc(Assembler::greaterEqual, L);
 849     stop(&quot;broken stack frame&quot;);
 850     bind(L);
 851   }
 852   if (verifyoop) {
 853     interp_verify_oop(rax, state);
 854   }
 855 
 856   address* const safepoint_table = Interpreter::safept_table(state);
 857 #ifdef _LP64
 858   Label no_safepoint, dispatch;
<a name="1" id="anc1"></a><span class="line-modified"> 859   if (table != safepoint_table &amp;&amp; generate_poll) {</span>
 860     NOT_PRODUCT(block_comment(&quot;Thread-local Safepoint poll&quot;));
 861     testb(Address(r15_thread, Thread::polling_page_offset()), SafepointMechanism::poll_bit());
 862 
 863     jccb(Assembler::zero, no_safepoint);
 864     lea(rscratch1, ExternalAddress((address)safepoint_table));
 865     jmpb(dispatch);
 866   }
 867 
 868   bind(no_safepoint);
 869   lea(rscratch1, ExternalAddress((address)table));
 870   bind(dispatch);
 871   jmp(Address(rscratch1, rbx, Address::times_8));
 872 
 873 #else
 874   Address index(noreg, rbx, Address::times_ptr);
<a name="2" id="anc2"></a><span class="line-modified"> 875   if (table != safepoint_table &amp;&amp; generate_poll) {</span>
 876     NOT_PRODUCT(block_comment(&quot;Thread-local Safepoint poll&quot;));
 877     Label no_safepoint;
 878     const Register thread = rcx;
 879     get_thread(thread);
 880     testb(Address(thread, Thread::polling_page_offset()), SafepointMechanism::poll_bit());
 881 
 882     jccb(Assembler::zero, no_safepoint);
 883     ArrayAddress dispatch_addr(ExternalAddress((address)safepoint_table), index);
 884     jump(dispatch_addr);
 885     bind(no_safepoint);
 886   }
 887 
 888   {
 889     ArrayAddress dispatch_addr(ExternalAddress((address)table), index);
 890     jump(dispatch_addr);
 891   }
 892 #endif // _LP64
 893 }
 894 
 895 void InterpreterMacroAssembler::dispatch_only(TosState state, bool generate_poll) {
 896   dispatch_base(state, Interpreter::dispatch_table(state), true, generate_poll);
 897 }
 898 
 899 void InterpreterMacroAssembler::dispatch_only_normal(TosState state) {
 900   dispatch_base(state, Interpreter::normal_table(state));
 901 }
 902 
 903 void InterpreterMacroAssembler::dispatch_only_noverify(TosState state) {
 904   dispatch_base(state, Interpreter::normal_table(state), false);
 905 }
 906 
 907 
 908 void InterpreterMacroAssembler::dispatch_next(TosState state, int step, bool generate_poll) {
 909   // load next bytecode (load before advancing _bcp_register to prevent AGI)
 910   load_unsigned_byte(rbx, Address(_bcp_register, step));
 911   // advance _bcp_register
 912   increment(_bcp_register, step);
 913   dispatch_base(state, Interpreter::dispatch_table(state), true, generate_poll);
 914 }
 915 
 916 void InterpreterMacroAssembler::dispatch_via(TosState state, address* table) {
 917   // load current bytecode
 918   load_unsigned_byte(rbx, Address(_bcp_register, 0));
 919   dispatch_base(state, table);
 920 }
 921 
 922 void InterpreterMacroAssembler::narrow(Register result) {
 923 
 924   // Get method-&gt;_constMethod-&gt;_result_type
 925   movptr(rcx, Address(rbp, frame::interpreter_frame_method_offset * wordSize));
 926   movptr(rcx, Address(rcx, Method::const_offset()));
 927   load_unsigned_byte(rcx, Address(rcx, ConstMethod::result_type_offset()));
 928 
 929   Label done, notBool, notByte, notChar;
 930 
 931   // common case first
 932   cmpl(rcx, T_INT);
 933   jcc(Assembler::equal, done);
 934 
 935   // mask integer result to narrower return type.
 936   cmpl(rcx, T_BOOLEAN);
 937   jcc(Assembler::notEqual, notBool);
 938   andl(result, 0x1);
 939   jmp(done);
 940 
 941   bind(notBool);
 942   cmpl(rcx, T_BYTE);
 943   jcc(Assembler::notEqual, notByte);
 944   LP64_ONLY(movsbl(result, result);)
 945   NOT_LP64(shll(result, 24);)      // truncate upper 24 bits
 946   NOT_LP64(sarl(result, 24);)      // and sign-extend byte
 947   jmp(done);
 948 
 949   bind(notByte);
 950   cmpl(rcx, T_CHAR);
 951   jcc(Assembler::notEqual, notChar);
 952   LP64_ONLY(movzwl(result, result);)
 953   NOT_LP64(andl(result, 0xFFFF);)  // truncate upper 16 bits
 954   jmp(done);
 955 
 956   bind(notChar);
 957   // cmpl(rcx, T_SHORT);  // all that&#39;s left
 958   // jcc(Assembler::notEqual, done);
 959   LP64_ONLY(movswl(result, result);)
 960   NOT_LP64(shll(result, 16);)      // truncate upper 16 bits
 961   NOT_LP64(sarl(result, 16);)      // and sign-extend short
 962 
 963   // Nothing to do for T_INT
 964   bind(done);
 965 }
 966 
 967 // remove activation
 968 //
 969 // Unlock the receiver if this is a synchronized method.
 970 // Unlock any Java monitors from syncronized blocks.
 971 // Remove the activation from the stack.
 972 //
 973 // If there are locked Java monitors
 974 //    If throw_monitor_exception
 975 //       throws IllegalMonitorStateException
 976 //    Else if install_monitor_exception
 977 //       installs IllegalMonitorStateException
 978 //    Else
 979 //       no error processing
 980 void InterpreterMacroAssembler::remove_activation(
 981         TosState state,
 982         Register ret_addr,
 983         bool throw_monitor_exception,
 984         bool install_monitor_exception,
 985         bool notify_jvmdi) {
 986   // Note: Registers rdx xmm0 may be in use for the
 987   // result check if synchronized method
 988   Label unlocked, unlock, no_unlock;
 989 
 990   const Register rthread = LP64_ONLY(r15_thread) NOT_LP64(rcx);
 991   const Register robj    = LP64_ONLY(c_rarg1) NOT_LP64(rdx);
 992   const Register rmon    = LP64_ONLY(c_rarg1) NOT_LP64(rcx);
 993                               // monitor pointers need different register
 994                               // because rdx may have the result in it
 995   NOT_LP64(get_thread(rcx);)
 996 
 997   // get the value of _do_not_unlock_if_synchronized into rdx
 998   const Address do_not_unlock_if_synchronized(rthread,
 999     in_bytes(JavaThread::do_not_unlock_if_synchronized_offset()));
1000   movbool(rbx, do_not_unlock_if_synchronized);
1001   movbool(do_not_unlock_if_synchronized, false); // reset the flag
1002 
1003   // get method access flags
1004   movptr(rcx, Address(rbp, frame::interpreter_frame_method_offset * wordSize));
1005   movl(rcx, Address(rcx, Method::access_flags_offset()));
1006   testl(rcx, JVM_ACC_SYNCHRONIZED);
1007   jcc(Assembler::zero, unlocked);
1008 
1009   // Don&#39;t unlock anything if the _do_not_unlock_if_synchronized flag
1010   // is set.
1011   testbool(rbx);
1012   jcc(Assembler::notZero, no_unlock);
1013 
1014   // unlock monitor
1015   push(state); // save result
1016 
1017   // BasicObjectLock will be first in list, since this is a
1018   // synchronized method. However, need to check that the object has
1019   // not been unlocked by an explicit monitorexit bytecode.
1020   const Address monitor(rbp, frame::interpreter_frame_initial_sp_offset *
1021                         wordSize - (int) sizeof(BasicObjectLock));
1022   // We use c_rarg1/rdx so that if we go slow path it will be the correct
1023   // register for unlock_object to pass to VM directly
1024   lea(robj, monitor); // address of first monitor
1025 
1026   movptr(rax, Address(robj, BasicObjectLock::obj_offset_in_bytes()));
1027   testptr(rax, rax);
1028   jcc(Assembler::notZero, unlock);
1029 
1030   pop(state);
1031   if (throw_monitor_exception) {
1032     // Entry already unlocked, need to throw exception
1033     NOT_LP64(empty_FPU_stack();)  // remove possible return value from FPU-stack, otherwise stack could overflow
1034     call_VM(noreg, CAST_FROM_FN_PTR(address,
1035                    InterpreterRuntime::throw_illegal_monitor_state_exception));
1036     should_not_reach_here();
1037   } else {
1038     // Monitor already unlocked during a stack unroll. If requested,
1039     // install an illegal_monitor_state_exception.  Continue with
1040     // stack unrolling.
1041     if (install_monitor_exception) {
1042       NOT_LP64(empty_FPU_stack();)
1043       call_VM(noreg, CAST_FROM_FN_PTR(address,
1044                      InterpreterRuntime::new_illegal_monitor_state_exception));
1045     }
1046     jmp(unlocked);
1047   }
1048 
1049   bind(unlock);
1050   unlock_object(robj);
1051   pop(state);
1052 
1053   // Check that for block-structured locking (i.e., that all locked
1054   // objects has been unlocked)
1055   bind(unlocked);
1056 
1057   // rax, rdx: Might contain return value
1058 
1059   // Check that all monitors are unlocked
1060   {
1061     Label loop, exception, entry, restart;
1062     const int entry_size = frame::interpreter_frame_monitor_size() * wordSize;
1063     const Address monitor_block_top(
1064         rbp, frame::interpreter_frame_monitor_block_top_offset * wordSize);
1065     const Address monitor_block_bot(
1066         rbp, frame::interpreter_frame_initial_sp_offset * wordSize);
1067 
1068     bind(restart);
1069     // We use c_rarg1 so that if we go slow path it will be the correct
1070     // register for unlock_object to pass to VM directly
1071     movptr(rmon, monitor_block_top); // points to current entry, starting
1072                                   // with top-most entry
1073     lea(rbx, monitor_block_bot);  // points to word before bottom of
1074                                   // monitor block
1075     jmp(entry);
1076 
1077     // Entry already locked, need to throw exception
1078     bind(exception);
1079 
1080     if (throw_monitor_exception) {
1081       // Throw exception
1082       NOT_LP64(empty_FPU_stack();)
1083       MacroAssembler::call_VM(noreg,
1084                               CAST_FROM_FN_PTR(address, InterpreterRuntime::
1085                                    throw_illegal_monitor_state_exception));
1086       should_not_reach_here();
1087     } else {
1088       // Stack unrolling. Unlock object and install illegal_monitor_exception.
1089       // Unlock does not block, so don&#39;t have to worry about the frame.
1090       // We don&#39;t have to preserve c_rarg1 since we are going to throw an exception.
1091 
1092       push(state);
1093       mov(robj, rmon);   // nop if robj and rmon are the same
1094       unlock_object(robj);
1095       pop(state);
1096 
1097       if (install_monitor_exception) {
1098         NOT_LP64(empty_FPU_stack();)
1099         call_VM(noreg, CAST_FROM_FN_PTR(address,
1100                                         InterpreterRuntime::
1101                                         new_illegal_monitor_state_exception));
1102       }
1103 
1104       jmp(restart);
1105     }
1106 
1107     bind(loop);
1108     // check if current entry is used
1109     cmpptr(Address(rmon, BasicObjectLock::obj_offset_in_bytes()), (int32_t) NULL);
1110     jcc(Assembler::notEqual, exception);
1111 
1112     addptr(rmon, entry_size); // otherwise advance to next entry
1113     bind(entry);
1114     cmpptr(rmon, rbx); // check if bottom reached
1115     jcc(Assembler::notEqual, loop); // if not at bottom then check this entry
1116   }
1117 
1118   bind(no_unlock);
1119 
1120   // jvmti support
1121   if (notify_jvmdi) {
1122     notify_method_exit(state, NotifyJVMTI);    // preserve TOSCA
1123   } else {
1124     notify_method_exit(state, SkipNotifyJVMTI); // preserve TOSCA
1125   }
1126 
1127   if (StackReservedPages &gt; 0) {
1128     movptr(rbx,
1129                Address(rbp, frame::interpreter_frame_sender_sp_offset * wordSize));
1130     // testing if reserved zone needs to be re-enabled
1131     Register rthread = LP64_ONLY(r15_thread) NOT_LP64(rcx);
1132     Label no_reserved_zone_enabling;
1133 
1134     NOT_LP64(get_thread(rthread);)
1135 
1136     cmpl(Address(rthread, JavaThread::stack_guard_state_offset()), JavaThread::stack_guard_enabled);
1137     jcc(Assembler::equal, no_reserved_zone_enabling);
1138 
1139     cmpptr(rbx, Address(rthread, JavaThread::reserved_stack_activation_offset()));
1140     jcc(Assembler::lessEqual, no_reserved_zone_enabling);
1141 
1142     call_VM_leaf(
1143       CAST_FROM_FN_PTR(address, SharedRuntime::enable_stack_reserved_zone), rthread);
1144     call_VM(noreg, CAST_FROM_FN_PTR(address,
1145                    InterpreterRuntime::throw_delayed_StackOverflowError));
1146     should_not_reach_here();
1147 
1148     bind(no_reserved_zone_enabling);
1149   }
1150 
1151   // remove activation
1152   // get sender sp
1153   movptr(rbx,
1154          Address(rbp, frame::interpreter_frame_sender_sp_offset * wordSize));
1155 
1156   if (state == atos &amp;&amp; ValueTypeReturnedAsFields) {
1157     Label skip;
1158     // Test if the return type is a value type
1159     movptr(rdi, Address(rbp, frame::interpreter_frame_method_offset * wordSize));
1160     movptr(rdi, Address(rdi, Method::const_offset()));
1161     load_unsigned_byte(rdi, Address(rdi, ConstMethod::result_type_offset()));
1162     cmpl(rdi, T_VALUETYPE);
1163     jcc(Assembler::notEqual, skip);
1164 
1165     // We are returning a value type, load its fields into registers
1166 #ifndef _LP64
1167     super_call_VM_leaf(StubRoutines::load_value_type_fields_in_regs());
1168 #else
1169     // Load fields from a buffered value with a value class specific handler
1170     load_klass(rdi, rax);
1171     movptr(rdi, Address(rdi, InstanceKlass::adr_valueklass_fixed_block_offset()));
1172     movptr(rdi, Address(rdi, ValueKlass::unpack_handler_offset()));
1173 
1174     testptr(rdi, rdi);
1175     jcc(Assembler::equal, skip);
1176 
1177     call(rdi);
1178 #endif
1179     // call above kills the value in rbx. Reload it.
1180     movptr(rbx, Address(rbp, frame::interpreter_frame_sender_sp_offset * wordSize));
1181     bind(skip);
1182   }
1183   leave();                           // remove frame anchor
1184   pop(ret_addr);                     // get return address
1185   mov(rsp, rbx);                     // set sp to sender sp
1186 }
1187 
1188 void InterpreterMacroAssembler::get_method_counters(Register method,
1189                                                     Register mcs, Label&amp; skip) {
1190   Label has_counters;
1191   movptr(mcs, Address(method, Method::method_counters_offset()));
1192   testptr(mcs, mcs);
1193   jcc(Assembler::notZero, has_counters);
1194   call_VM(noreg, CAST_FROM_FN_PTR(address,
1195           InterpreterRuntime::build_method_counters), method);
1196   movptr(mcs, Address(method,Method::method_counters_offset()));
1197   testptr(mcs, mcs);
1198   jcc(Assembler::zero, skip); // No MethodCounters allocated, OutOfMemory
1199   bind(has_counters);
1200 }
1201 
1202 void InterpreterMacroAssembler::allocate_instance(Register klass, Register new_obj,
1203                                                   Register t1, Register t2,
1204                                                   bool clear_fields, Label&amp; alloc_failed) {
1205   MacroAssembler::allocate_instance(klass, new_obj, t1, t2, clear_fields, alloc_failed);
1206   {
1207     SkipIfEqual skip_if(this, &amp;DTraceAllocProbes, 0);
1208     // Trigger dtrace event for fastpath
1209     push(atos);
1210     call_VM_leaf(CAST_FROM_FN_PTR(address, SharedRuntime::dtrace_object_alloc), new_obj);
1211     pop(atos);
1212   }
1213 }
1214 
1215 
1216 void InterpreterMacroAssembler::read_flattened_field(Register holder_klass,
1217                                                      Register field_index, Register field_offset,
1218                                                      Register obj) {
1219   Label alloc_failed, empty_value, done;
1220   const Register src = field_offset;
1221   const Register alloc_temp = LP64_ONLY(rscratch1) NOT_LP64(rsi);
1222   const Register dst_temp   = LP64_ONLY(rscratch2) NOT_LP64(rdi);
1223   assert_different_registers(obj, holder_klass, field_index, field_offset, dst_temp);
1224 
1225   // Grap the inline field klass
1226   push(holder_klass);
1227   const Register field_klass = holder_klass;
1228   get_value_field_klass(holder_klass, field_index, field_klass);
1229 
1230   //check for empty value klass
1231   test_klass_is_empty_value(field_klass, dst_temp, empty_value);
1232 
1233   // allocate buffer
1234   push(obj); // save holder
1235   allocate_instance(field_klass, obj, alloc_temp, dst_temp, false, alloc_failed);
1236 
1237   // Have an oop instance buffer, copy into it
1238   data_for_oop(obj, dst_temp, field_klass);
1239   pop(alloc_temp);             // restore holder
1240   lea(src, Address(alloc_temp, field_offset));
1241   // call_VM_leaf, clobbers a few regs, save restore new obj
1242   push(obj);
1243   access_value_copy(IS_DEST_UNINITIALIZED, src, dst_temp, field_klass);
1244   pop(obj);
1245   pop(holder_klass);
1246   jmp(done);
1247 
1248   bind(empty_value);
1249   get_empty_value_oop(field_klass, dst_temp, obj);
1250   pop(holder_klass);
1251   jmp(done);
1252 
1253   bind(alloc_failed);
1254   pop(obj);
1255   pop(holder_klass);
1256   call_VM(obj, CAST_FROM_FN_PTR(address, InterpreterRuntime::read_flattened_field),
1257           obj, field_index, holder_klass);
1258 
1259   bind(done);
1260 }
1261 
1262 void InterpreterMacroAssembler::read_flattened_element(Register array, Register index,
1263                                                        Register t1, Register t2,
1264                                                        Register obj) {
1265   assert_different_registers(array, index, t1, t2);
1266   Label alloc_failed, empty_value, done;
1267   const Register array_klass = t2;
1268   const Register elem_klass = t1;
1269   const Register alloc_temp = LP64_ONLY(rscratch1) NOT_LP64(rsi);
1270   const Register dst_temp   = LP64_ONLY(rscratch2) NOT_LP64(rdi);
1271 
1272   // load in array-&gt;klass()-&gt;element_klass()
1273   load_klass(array_klass, array);
1274   movptr(elem_klass, Address(array_klass, ArrayKlass::element_klass_offset()));
1275 
1276   //check for empty value klass
1277   test_klass_is_empty_value(elem_klass, dst_temp, empty_value);
1278 
1279   // calc source into &quot;array_klass&quot; and free up some regs
1280   const Register src = array_klass;
1281   push(index); // preserve index reg in case alloc_failed
1282   data_for_value_array_index(array, array_klass, index, src);
1283 
1284   allocate_instance(elem_klass, obj, alloc_temp, dst_temp, false, alloc_failed);
1285   // Have an oop instance buffer, copy into it
1286   store_ptr(0, obj); // preserve obj (overwrite index, no longer needed)
1287   data_for_oop(obj, dst_temp, elem_klass);
1288   access_value_copy(IS_DEST_UNINITIALIZED, src, dst_temp, elem_klass);
1289   pop(obj);
1290   jmp(done);
1291 
1292   bind(empty_value);
1293   get_empty_value_oop(elem_klass, dst_temp, obj);
1294   jmp(done);
1295 
1296   bind(alloc_failed);
1297   pop(index);
1298   if (array == c_rarg2) {
1299     mov(elem_klass, array);
1300     array = elem_klass;
1301   }
1302   call_VM(obj, CAST_FROM_FN_PTR(address, InterpreterRuntime::value_array_load), array, index);
1303 
1304   bind(done);
1305 }
1306 
1307 
1308 // Lock object
1309 //
1310 // Args:
1311 //      rdx, c_rarg1: BasicObjectLock to be used for locking
1312 //
1313 // Kills:
1314 //      rax, rbx
1315 void InterpreterMacroAssembler::lock_object(Register lock_reg) {
1316   assert(lock_reg == LP64_ONLY(c_rarg1) NOT_LP64(rdx),
1317          &quot;The argument is only for looks. It must be c_rarg1&quot;);
1318 
1319   if (UseHeavyMonitors) {
1320     call_VM(noreg,
1321             CAST_FROM_FN_PTR(address, InterpreterRuntime::monitorenter),
1322             lock_reg);
1323   } else {
1324     Label done;
1325 
1326     const Register swap_reg = rax; // Must use rax for cmpxchg instruction
1327     const Register tmp_reg = rbx; // Will be passed to biased_locking_enter to avoid a
1328                                   // problematic case where tmp_reg = no_reg.
1329     const Register obj_reg = LP64_ONLY(c_rarg3) NOT_LP64(rcx); // Will contain the oop
1330 
1331     const int obj_offset = BasicObjectLock::obj_offset_in_bytes();
1332     const int lock_offset = BasicObjectLock::lock_offset_in_bytes ();
1333     const int mark_offset = lock_offset +
1334                             BasicLock::displaced_header_offset_in_bytes();
1335 
1336     Label slow_case;
1337 
1338     // Load object pointer into obj_reg
1339     movptr(obj_reg, Address(lock_reg, obj_offset));
1340 
1341     if (UseBiasedLocking) {
1342       biased_locking_enter(lock_reg, obj_reg, swap_reg, tmp_reg, false, done, &amp;slow_case);
1343     }
1344 
1345     // Load immediate 1 into swap_reg %rax
1346     movl(swap_reg, (int32_t)1);
1347 
1348     // Load (object-&gt;mark() | 1) into swap_reg %rax
1349     orptr(swap_reg, Address(obj_reg, oopDesc::mark_offset_in_bytes()));
1350     if (EnableValhalla &amp;&amp; !UseBiasedLocking) {
1351       // For slow path is_always_locked, using biased, which is never natural for !UseBiasLocking
1352       andptr(swap_reg, ~((int) markWord::biased_lock_bit_in_place));
1353     }
1354 
1355     // Save (object-&gt;mark() | 1) into BasicLock&#39;s displaced header
1356     movptr(Address(lock_reg, mark_offset), swap_reg);
1357 
1358     assert(lock_offset == 0,
1359            &quot;displaced header must be first word in BasicObjectLock&quot;);
1360 
1361     lock();
1362     cmpxchgptr(lock_reg, Address(obj_reg, oopDesc::mark_offset_in_bytes()));
1363     if (PrintBiasedLockingStatistics) {
1364       cond_inc32(Assembler::zero,
1365                  ExternalAddress((address) BiasedLocking::fast_path_entry_count_addr()));
1366     }
1367     jcc(Assembler::zero, done);
1368 
1369     const int zero_bits = LP64_ONLY(7) NOT_LP64(3);
1370 
1371     // Test if the oopMark is an obvious stack pointer, i.e.,
1372     //  1) (mark &amp; zero_bits) == 0, and
1373     //  2) rsp &lt;= mark &lt; mark + os::pagesize()
1374     //
1375     // These 3 tests can be done by evaluating the following
1376     // expression: ((mark - rsp) &amp; (zero_bits - os::vm_page_size())),
1377     // assuming both stack pointer and pagesize have their
1378     // least significant bits clear.
1379     // NOTE: the oopMark is in swap_reg %rax as the result of cmpxchg
1380     subptr(swap_reg, rsp);
1381     andptr(swap_reg, zero_bits - os::vm_page_size());
1382 
1383     // Save the test result, for recursive case, the result is zero
1384     movptr(Address(lock_reg, mark_offset), swap_reg);
1385 
1386     if (PrintBiasedLockingStatistics) {
1387       cond_inc32(Assembler::zero,
1388                  ExternalAddress((address) BiasedLocking::fast_path_entry_count_addr()));
1389     }
1390     jcc(Assembler::zero, done);
1391 
1392     bind(slow_case);
1393 
1394     // Call the runtime routine for slow case
1395     call_VM(noreg,
1396             CAST_FROM_FN_PTR(address, InterpreterRuntime::monitorenter),
1397             lock_reg);
1398 
1399     bind(done);
1400   }
1401 }
1402 
1403 
1404 // Unlocks an object. Used in monitorexit bytecode and
1405 // remove_activation.  Throws an IllegalMonitorException if object is
1406 // not locked by current thread.
1407 //
1408 // Args:
1409 //      rdx, c_rarg1: BasicObjectLock for lock
1410 //
1411 // Kills:
1412 //      rax
1413 //      c_rarg0, c_rarg1, c_rarg2, c_rarg3, ... (param regs)
1414 //      rscratch1 (scratch reg)
1415 // rax, rbx, rcx, rdx
1416 void InterpreterMacroAssembler::unlock_object(Register lock_reg) {
1417   assert(lock_reg == LP64_ONLY(c_rarg1) NOT_LP64(rdx),
1418          &quot;The argument is only for looks. It must be c_rarg1&quot;);
1419 
1420   if (UseHeavyMonitors) {
1421     call_VM(noreg,
1422             CAST_FROM_FN_PTR(address, InterpreterRuntime::monitorexit),
1423             lock_reg);
1424   } else {
1425     Label done;
1426 
1427     const Register swap_reg   = rax;  // Must use rax for cmpxchg instruction
1428     const Register header_reg = LP64_ONLY(c_rarg2) NOT_LP64(rbx);  // Will contain the old oopMark
1429     const Register obj_reg    = LP64_ONLY(c_rarg3) NOT_LP64(rcx);  // Will contain the oop
1430 
1431     save_bcp(); // Save in case of exception
1432 
1433     // Convert from BasicObjectLock structure to object and BasicLock
1434     // structure Store the BasicLock address into %rax
1435     lea(swap_reg, Address(lock_reg, BasicObjectLock::lock_offset_in_bytes()));
1436 
1437     // Load oop into obj_reg(%c_rarg3)
1438     movptr(obj_reg, Address(lock_reg, BasicObjectLock::obj_offset_in_bytes()));
1439 
1440     // Free entry
1441     movptr(Address(lock_reg, BasicObjectLock::obj_offset_in_bytes()), (int32_t)NULL_WORD);
1442 
1443     if (UseBiasedLocking) {
1444       biased_locking_exit(obj_reg, header_reg, done);
1445     }
1446 
1447     // Load the old header from BasicLock structure
1448     movptr(header_reg, Address(swap_reg,
1449                                BasicLock::displaced_header_offset_in_bytes()));
1450 
1451     // Test for recursion
1452     testptr(header_reg, header_reg);
1453 
1454     // zero for recursive case
1455     jcc(Assembler::zero, done);
1456 
1457     // Atomic swap back the old header
1458     lock();
1459     cmpxchgptr(header_reg, Address(obj_reg, oopDesc::mark_offset_in_bytes()));
1460 
1461     // zero for simple unlock of a stack-lock case
1462     jcc(Assembler::zero, done);
1463 
1464     // Call the runtime routine for slow case.
1465     movptr(Address(lock_reg, BasicObjectLock::obj_offset_in_bytes()),
1466          obj_reg); // restore obj
1467     call_VM(noreg,
1468             CAST_FROM_FN_PTR(address, InterpreterRuntime::monitorexit),
1469             lock_reg);
1470 
1471     bind(done);
1472 
1473     restore_bcp();
1474   }
1475 }
1476 
1477 void InterpreterMacroAssembler::test_method_data_pointer(Register mdp,
1478                                                          Label&amp; zero_continue) {
1479   assert(ProfileInterpreter, &quot;must be profiling interpreter&quot;);
1480   movptr(mdp, Address(rbp, frame::interpreter_frame_mdp_offset * wordSize));
1481   testptr(mdp, mdp);
1482   jcc(Assembler::zero, zero_continue);
1483 }
1484 
1485 
1486 // Set the method data pointer for the current bcp.
1487 void InterpreterMacroAssembler::set_method_data_pointer_for_bcp() {
1488   assert(ProfileInterpreter, &quot;must be profiling interpreter&quot;);
1489   Label set_mdp;
1490   push(rax);
1491   push(rbx);
1492 
1493   get_method(rbx);
1494   // Test MDO to avoid the call if it is NULL.
1495   movptr(rax, Address(rbx, in_bytes(Method::method_data_offset())));
1496   testptr(rax, rax);
1497   jcc(Assembler::zero, set_mdp);
1498   // rbx: method
1499   // _bcp_register: bcp
1500   call_VM_leaf(CAST_FROM_FN_PTR(address, InterpreterRuntime::bcp_to_di), rbx, _bcp_register);
1501   // rax: mdi
1502   // mdo is guaranteed to be non-zero here, we checked for it before the call.
1503   movptr(rbx, Address(rbx, in_bytes(Method::method_data_offset())));
1504   addptr(rbx, in_bytes(MethodData::data_offset()));
1505   addptr(rax, rbx);
1506   bind(set_mdp);
1507   movptr(Address(rbp, frame::interpreter_frame_mdp_offset * wordSize), rax);
1508   pop(rbx);
1509   pop(rax);
1510 }
1511 
1512 void InterpreterMacroAssembler::verify_method_data_pointer() {
1513   assert(ProfileInterpreter, &quot;must be profiling interpreter&quot;);
1514 #ifdef ASSERT
1515   Label verify_continue;
1516   push(rax);
1517   push(rbx);
1518   Register arg3_reg = LP64_ONLY(c_rarg3) NOT_LP64(rcx);
1519   Register arg2_reg = LP64_ONLY(c_rarg2) NOT_LP64(rdx);
1520   push(arg3_reg);
1521   push(arg2_reg);
1522   test_method_data_pointer(arg3_reg, verify_continue); // If mdp is zero, continue
1523   get_method(rbx);
1524 
1525   // If the mdp is valid, it will point to a DataLayout header which is
1526   // consistent with the bcp.  The converse is highly probable also.
1527   load_unsigned_short(arg2_reg,
1528                       Address(arg3_reg, in_bytes(DataLayout::bci_offset())));
1529   addptr(arg2_reg, Address(rbx, Method::const_offset()));
1530   lea(arg2_reg, Address(arg2_reg, ConstMethod::codes_offset()));
1531   cmpptr(arg2_reg, _bcp_register);
1532   jcc(Assembler::equal, verify_continue);
1533   // rbx: method
1534   // _bcp_register: bcp
1535   // c_rarg3: mdp
1536   call_VM_leaf(CAST_FROM_FN_PTR(address, InterpreterRuntime::verify_mdp),
1537                rbx, _bcp_register, arg3_reg);
1538   bind(verify_continue);
1539   pop(arg2_reg);
1540   pop(arg3_reg);
1541   pop(rbx);
1542   pop(rax);
1543 #endif // ASSERT
1544 }
1545 
1546 
1547 void InterpreterMacroAssembler::set_mdp_data_at(Register mdp_in,
1548                                                 int constant,
1549                                                 Register value) {
1550   assert(ProfileInterpreter, &quot;must be profiling interpreter&quot;);
1551   Address data(mdp_in, constant);
1552   movptr(data, value);
1553 }
1554 
1555 
1556 void InterpreterMacroAssembler::increment_mdp_data_at(Register mdp_in,
1557                                                       int constant,
1558                                                       bool decrement) {
1559   // Counter address
1560   Address data(mdp_in, constant);
1561 
1562   increment_mdp_data_at(data, decrement);
1563 }
1564 
1565 void InterpreterMacroAssembler::increment_mdp_data_at(Address data,
1566                                                       bool decrement) {
1567   assert(ProfileInterpreter, &quot;must be profiling interpreter&quot;);
1568   // %%% this does 64bit counters at best it is wasting space
1569   // at worst it is a rare bug when counters overflow
1570 
1571   if (decrement) {
1572     // Decrement the register.  Set condition codes.
1573     addptr(data, (int32_t) -DataLayout::counter_increment);
1574     // If the decrement causes the counter to overflow, stay negative
1575     Label L;
1576     jcc(Assembler::negative, L);
1577     addptr(data, (int32_t) DataLayout::counter_increment);
1578     bind(L);
1579   } else {
1580     assert(DataLayout::counter_increment == 1,
1581            &quot;flow-free idiom only works with 1&quot;);
1582     // Increment the register.  Set carry flag.
1583     addptr(data, DataLayout::counter_increment);
1584     // If the increment causes the counter to overflow, pull back by 1.
1585     sbbptr(data, (int32_t)0);
1586   }
1587 }
1588 
1589 
1590 void InterpreterMacroAssembler::increment_mdp_data_at(Register mdp_in,
1591                                                       Register reg,
1592                                                       int constant,
1593                                                       bool decrement) {
1594   Address data(mdp_in, reg, Address::times_1, constant);
1595 
1596   increment_mdp_data_at(data, decrement);
1597 }
1598 
1599 void InterpreterMacroAssembler::set_mdp_flag_at(Register mdp_in,
1600                                                 int flag_byte_constant) {
1601   assert(ProfileInterpreter, &quot;must be profiling interpreter&quot;);
1602   int header_offset = in_bytes(DataLayout::flags_offset());
1603   int header_bits = flag_byte_constant;
1604   // Set the flag
1605   orb(Address(mdp_in, header_offset), header_bits);
1606 }
1607 
1608 
1609 
1610 void InterpreterMacroAssembler::test_mdp_data_at(Register mdp_in,
1611                                                  int offset,
1612                                                  Register value,
1613                                                  Register test_value_out,
1614                                                  Label&amp; not_equal_continue) {
1615   assert(ProfileInterpreter, &quot;must be profiling interpreter&quot;);
1616   if (test_value_out == noreg) {
1617     cmpptr(value, Address(mdp_in, offset));
1618   } else {
1619     // Put the test value into a register, so caller can use it:
1620     movptr(test_value_out, Address(mdp_in, offset));
1621     cmpptr(test_value_out, value);
1622   }
1623   jcc(Assembler::notEqual, not_equal_continue);
1624 }
1625 
1626 
1627 void InterpreterMacroAssembler::update_mdp_by_offset(Register mdp_in,
1628                                                      int offset_of_disp) {
1629   assert(ProfileInterpreter, &quot;must be profiling interpreter&quot;);
1630   Address disp_address(mdp_in, offset_of_disp);
1631   addptr(mdp_in, disp_address);
1632   movptr(Address(rbp, frame::interpreter_frame_mdp_offset * wordSize), mdp_in);
1633 }
1634 
1635 
1636 void InterpreterMacroAssembler::update_mdp_by_offset(Register mdp_in,
1637                                                      Register reg,
1638                                                      int offset_of_disp) {
1639   assert(ProfileInterpreter, &quot;must be profiling interpreter&quot;);
1640   Address disp_address(mdp_in, reg, Address::times_1, offset_of_disp);
1641   addptr(mdp_in, disp_address);
1642   movptr(Address(rbp, frame::interpreter_frame_mdp_offset * wordSize), mdp_in);
1643 }
1644 
1645 
1646 void InterpreterMacroAssembler::update_mdp_by_constant(Register mdp_in,
1647                                                        int constant) {
1648   assert(ProfileInterpreter, &quot;must be profiling interpreter&quot;);
1649   addptr(mdp_in, constant);
1650   movptr(Address(rbp, frame::interpreter_frame_mdp_offset * wordSize), mdp_in);
1651 }
1652 
1653 
1654 void InterpreterMacroAssembler::update_mdp_for_ret(Register return_bci) {
1655   assert(ProfileInterpreter, &quot;must be profiling interpreter&quot;);
1656   push(return_bci); // save/restore across call_VM
1657   call_VM(noreg,
1658           CAST_FROM_FN_PTR(address, InterpreterRuntime::update_mdp_for_ret),
1659           return_bci);
1660   pop(return_bci);
1661 }
1662 
1663 
1664 void InterpreterMacroAssembler::profile_taken_branch(Register mdp,
1665                                                      Register bumped_count) {
1666   if (ProfileInterpreter) {
1667     Label profile_continue;
1668 
1669     // If no method data exists, go to profile_continue.
1670     // Otherwise, assign to mdp
1671     test_method_data_pointer(mdp, profile_continue);
1672 
1673     // We are taking a branch.  Increment the taken count.
1674     // We inline increment_mdp_data_at to return bumped_count in a register
1675     //increment_mdp_data_at(mdp, in_bytes(JumpData::taken_offset()));
1676     Address data(mdp, in_bytes(JumpData::taken_offset()));
1677     movptr(bumped_count, data);
1678     assert(DataLayout::counter_increment == 1,
1679             &quot;flow-free idiom only works with 1&quot;);
1680     addptr(bumped_count, DataLayout::counter_increment);
1681     sbbptr(bumped_count, 0);
1682     movptr(data, bumped_count); // Store back out
1683 
1684     // The method data pointer needs to be updated to reflect the new target.
1685     update_mdp_by_offset(mdp, in_bytes(JumpData::displacement_offset()));
1686     bind(profile_continue);
1687   }
1688 }
1689 
1690 
1691 void InterpreterMacroAssembler::profile_not_taken_branch(Register mdp) {
1692   if (ProfileInterpreter) {
1693     Label profile_continue;
1694 
1695     // If no method data exists, go to profile_continue.
1696     test_method_data_pointer(mdp, profile_continue);
1697 
1698     // We are taking a branch.  Increment the not taken count.
1699     increment_mdp_data_at(mdp, in_bytes(BranchData::not_taken_offset()));
1700 
1701     // The method data pointer needs to be updated to correspond to
1702     // the next bytecode
1703     update_mdp_by_constant(mdp, in_bytes(BranchData::branch_data_size()));
1704     bind(profile_continue);
1705   }
1706 }
1707 
1708 void InterpreterMacroAssembler::profile_call(Register mdp) {
1709   if (ProfileInterpreter) {
1710     Label profile_continue;
1711 
1712     // If no method data exists, go to profile_continue.
1713     test_method_data_pointer(mdp, profile_continue);
1714 
1715     // We are making a call.  Increment the count.
1716     increment_mdp_data_at(mdp, in_bytes(CounterData::count_offset()));
1717 
1718     // The method data pointer needs to be updated to reflect the new target.
1719     update_mdp_by_constant(mdp, in_bytes(CounterData::counter_data_size()));
1720     bind(profile_continue);
1721   }
1722 }
1723 
1724 
1725 void InterpreterMacroAssembler::profile_final_call(Register mdp) {
1726   if (ProfileInterpreter) {
1727     Label profile_continue;
1728 
1729     // If no method data exists, go to profile_continue.
1730     test_method_data_pointer(mdp, profile_continue);
1731 
1732     // We are making a call.  Increment the count.
1733     increment_mdp_data_at(mdp, in_bytes(CounterData::count_offset()));
1734 
1735     // The method data pointer needs to be updated to reflect the new target.
1736     update_mdp_by_constant(mdp,
1737                            in_bytes(VirtualCallData::
1738                                     virtual_call_data_size()));
1739     bind(profile_continue);
1740   }
1741 }
1742 
1743 
1744 void InterpreterMacroAssembler::profile_virtual_call(Register receiver,
1745                                                      Register mdp,
1746                                                      Register reg2,
1747                                                      bool receiver_can_be_null) {
1748   if (ProfileInterpreter) {
1749     Label profile_continue;
1750 
1751     // If no method data exists, go to profile_continue.
1752     test_method_data_pointer(mdp, profile_continue);
1753 
1754     Label skip_receiver_profile;
1755     if (receiver_can_be_null) {
1756       Label not_null;
1757       testptr(receiver, receiver);
1758       jccb(Assembler::notZero, not_null);
1759       // We are making a call.  Increment the count for null receiver.
1760       increment_mdp_data_at(mdp, in_bytes(CounterData::count_offset()));
1761       jmp(skip_receiver_profile);
1762       bind(not_null);
1763     }
1764 
1765     // Record the receiver type.
1766     record_klass_in_profile(receiver, mdp, reg2, true);
1767     bind(skip_receiver_profile);
1768 
1769     // The method data pointer needs to be updated to reflect the new target.
1770     update_mdp_by_constant(mdp, in_bytes(VirtualCallData::virtual_call_data_size()));
1771     bind(profile_continue);
1772   }
1773 }
1774 
1775 // This routine creates a state machine for updating the multi-row
1776 // type profile at a virtual call site (or other type-sensitive bytecode).
1777 // The machine visits each row (of receiver/count) until the receiver type
1778 // is found, or until it runs out of rows.  At the same time, it remembers
1779 // the location of the first empty row.  (An empty row records null for its
1780 // receiver, and can be allocated for a newly-observed receiver type.)
1781 // Because there are two degrees of freedom in the state, a simple linear
1782 // search will not work; it must be a decision tree.  Hence this helper
1783 // function is recursive, to generate the required tree structured code.
1784 // It&#39;s the interpreter, so we are trading off code space for speed.
1785 // See below for example code.
1786 void InterpreterMacroAssembler::record_klass_in_profile_helper(
1787                                         Register receiver, Register mdp,
1788                                         Register reg2, int start_row,
1789                                         Label&amp; done, bool is_virtual_call) {
1790   if (TypeProfileWidth == 0) {
1791     if (is_virtual_call) {
1792       increment_mdp_data_at(mdp, in_bytes(CounterData::count_offset()));
1793     }
1794 #if INCLUDE_JVMCI
1795     else if (EnableJVMCI) {
1796       increment_mdp_data_at(mdp, in_bytes(ReceiverTypeData::nonprofiled_receiver_count_offset()));
1797     }
1798 #endif // INCLUDE_JVMCI
1799   } else {
1800     int non_profiled_offset = -1;
1801     if (is_virtual_call) {
1802       non_profiled_offset = in_bytes(CounterData::count_offset());
1803     }
1804 #if INCLUDE_JVMCI
1805     else if (EnableJVMCI) {
1806       non_profiled_offset = in_bytes(ReceiverTypeData::nonprofiled_receiver_count_offset());
1807     }
1808 #endif // INCLUDE_JVMCI
1809 
1810     record_item_in_profile_helper(receiver, mdp, reg2, 0, done, TypeProfileWidth,
1811         &amp;VirtualCallData::receiver_offset, &amp;VirtualCallData::receiver_count_offset, non_profiled_offset);
1812   }
1813 }
1814 
1815 void InterpreterMacroAssembler::record_item_in_profile_helper(Register item, Register mdp,
1816                                         Register reg2, int start_row, Label&amp; done, int total_rows,
1817                                         OffsetFunction item_offset_fn, OffsetFunction item_count_offset_fn,
1818                                         int non_profiled_offset) {
1819   int last_row = total_rows - 1;
1820   assert(start_row &lt;= last_row, &quot;must be work left to do&quot;);
1821   // Test this row for both the item and for null.
1822   // Take any of three different outcomes:
1823   //   1. found item =&gt; increment count and goto done
1824   //   2. found null =&gt; keep looking for case 1, maybe allocate this cell
1825   //   3. found something else =&gt; keep looking for cases 1 and 2
1826   // Case 3 is handled by a recursive call.
1827   for (int row = start_row; row &lt;= last_row; row++) {
1828     Label next_test;
1829     bool test_for_null_also = (row == start_row);
1830 
1831     // See if the item is item[n].
1832     int item_offset = in_bytes(item_offset_fn(row));
1833     test_mdp_data_at(mdp, item_offset, item,
1834                      (test_for_null_also ? reg2 : noreg),
1835                      next_test);
1836     // (Reg2 now contains the item from the CallData.)
1837 
1838     // The item is item[n].  Increment count[n].
1839     int count_offset = in_bytes(item_count_offset_fn(row));
1840     increment_mdp_data_at(mdp, count_offset);
1841     jmp(done);
1842     bind(next_test);
1843 
1844     if (test_for_null_also) {
1845       // Failed the equality check on item[n]...  Test for null.
1846       testptr(reg2, reg2);
1847       if (start_row == last_row) {
1848         // The only thing left to do is handle the null case.
1849         if (non_profiled_offset &gt;= 0) {
1850           Label found_null;
1851           jccb(Assembler::zero, found_null);
1852           // Item did not match any saved item and there is no empty row for it.
1853           // Increment total counter to indicate polymorphic case.
1854           increment_mdp_data_at(mdp, non_profiled_offset);
1855           jmp(done);
1856           bind(found_null);
1857         } else {
1858           jcc(Assembler::notZero, done);
1859         }
1860         break;
1861       }
1862       Label found_null;
1863       // Since null is rare, make it be the branch-taken case.
1864       jcc(Assembler::zero, found_null);
1865 
1866       // Put all the &quot;Case 3&quot; tests here.
1867       record_item_in_profile_helper(item, mdp, reg2, start_row + 1, done, total_rows,
1868         item_offset_fn, item_count_offset_fn, non_profiled_offset);
1869 
1870       // Found a null.  Keep searching for a matching item,
1871       // but remember that this is an empty (unused) slot.
1872       bind(found_null);
1873     }
1874   }
1875 
1876   // In the fall-through case, we found no matching item, but we
1877   // observed the item[start_row] is NULL.
1878 
1879   // Fill in the item field and increment the count.
1880   int item_offset = in_bytes(item_offset_fn(start_row));
1881   set_mdp_data_at(mdp, item_offset, item);
1882   int count_offset = in_bytes(item_count_offset_fn(start_row));
1883   movl(reg2, DataLayout::counter_increment);
1884   set_mdp_data_at(mdp, count_offset, reg2);
1885   if (start_row &gt; 0) {
1886     jmp(done);
1887   }
1888 }
1889 
1890 // Example state machine code for three profile rows:
1891 //   // main copy of decision tree, rooted at row[1]
1892 //   if (row[0].rec == rec) { row[0].incr(); goto done; }
1893 //   if (row[0].rec != NULL) {
1894 //     // inner copy of decision tree, rooted at row[1]
1895 //     if (row[1].rec == rec) { row[1].incr(); goto done; }
1896 //     if (row[1].rec != NULL) {
1897 //       // degenerate decision tree, rooted at row[2]
1898 //       if (row[2].rec == rec) { row[2].incr(); goto done; }
1899 //       if (row[2].rec != NULL) { count.incr(); goto done; } // overflow
1900 //       row[2].init(rec); goto done;
1901 //     } else {
1902 //       // remember row[1] is empty
1903 //       if (row[2].rec == rec) { row[2].incr(); goto done; }
1904 //       row[1].init(rec); goto done;
1905 //     }
1906 //   } else {
1907 //     // remember row[0] is empty
1908 //     if (row[1].rec == rec) { row[1].incr(); goto done; }
1909 //     if (row[2].rec == rec) { row[2].incr(); goto done; }
1910 //     row[0].init(rec); goto done;
1911 //   }
1912 //   done:
1913 
1914 void InterpreterMacroAssembler::record_klass_in_profile(Register receiver,
1915                                                         Register mdp, Register reg2,
1916                                                         bool is_virtual_call) {
1917   assert(ProfileInterpreter, &quot;must be profiling&quot;);
1918   Label done;
1919 
1920   record_klass_in_profile_helper(receiver, mdp, reg2, 0, done, is_virtual_call);
1921 
1922   bind (done);
1923 }
1924 
1925 void InterpreterMacroAssembler::profile_ret(Register return_bci,
1926                                             Register mdp) {
1927   if (ProfileInterpreter) {
1928     Label profile_continue;
1929     uint row;
1930 
1931     // If no method data exists, go to profile_continue.
1932     test_method_data_pointer(mdp, profile_continue);
1933 
1934     // Update the total ret count.
1935     increment_mdp_data_at(mdp, in_bytes(CounterData::count_offset()));
1936 
1937     for (row = 0; row &lt; RetData::row_limit(); row++) {
1938       Label next_test;
1939 
1940       // See if return_bci is equal to bci[n]:
1941       test_mdp_data_at(mdp,
1942                        in_bytes(RetData::bci_offset(row)),
1943                        return_bci, noreg,
1944                        next_test);
1945 
1946       // return_bci is equal to bci[n].  Increment the count.
1947       increment_mdp_data_at(mdp, in_bytes(RetData::bci_count_offset(row)));
1948 
1949       // The method data pointer needs to be updated to reflect the new target.
1950       update_mdp_by_offset(mdp,
1951                            in_bytes(RetData::bci_displacement_offset(row)));
1952       jmp(profile_continue);
1953       bind(next_test);
1954     }
1955 
1956     update_mdp_for_ret(return_bci);
1957 
1958     bind(profile_continue);
1959   }
1960 }
1961 
1962 
1963 void InterpreterMacroAssembler::profile_null_seen(Register mdp) {
1964   if (ProfileInterpreter) {
1965     Label profile_continue;
1966 
1967     // If no method data exists, go to profile_continue.
1968     test_method_data_pointer(mdp, profile_continue);
1969 
1970     set_mdp_flag_at(mdp, BitData::null_seen_byte_constant());
1971 
1972     // The method data pointer needs to be updated.
1973     int mdp_delta = in_bytes(BitData::bit_data_size());
1974     if (TypeProfileCasts) {
1975       mdp_delta = in_bytes(VirtualCallData::virtual_call_data_size());
1976     }
1977     update_mdp_by_constant(mdp, mdp_delta);
1978 
1979     bind(profile_continue);
1980   }
1981 }
1982 
1983 
1984 void InterpreterMacroAssembler::profile_typecheck_failed(Register mdp) {
1985   if (ProfileInterpreter &amp;&amp; TypeProfileCasts) {
1986     Label profile_continue;
1987 
1988     // If no method data exists, go to profile_continue.
1989     test_method_data_pointer(mdp, profile_continue);
1990 
1991     int count_offset = in_bytes(CounterData::count_offset());
1992     // Back up the address, since we have already bumped the mdp.
1993     count_offset -= in_bytes(VirtualCallData::virtual_call_data_size());
1994 
1995     // *Decrement* the counter.  We expect to see zero or small negatives.
1996     increment_mdp_data_at(mdp, count_offset, true);
1997 
1998     bind (profile_continue);
1999   }
2000 }
2001 
2002 
2003 void InterpreterMacroAssembler::profile_typecheck(Register mdp, Register klass, Register reg2) {
2004   if (ProfileInterpreter) {
2005     Label profile_continue;
2006 
2007     // If no method data exists, go to profile_continue.
2008     test_method_data_pointer(mdp, profile_continue);
2009 
2010     // The method data pointer needs to be updated.
2011     int mdp_delta = in_bytes(BitData::bit_data_size());
2012     if (TypeProfileCasts) {
2013       mdp_delta = in_bytes(VirtualCallData::virtual_call_data_size());
2014 
2015       // Record the object type.
2016       record_klass_in_profile(klass, mdp, reg2, false);
2017       NOT_LP64(assert(reg2 == rdi, &quot;we know how to fix this blown reg&quot;);)
2018       NOT_LP64(restore_locals();)         // Restore EDI
2019     }
2020     update_mdp_by_constant(mdp, mdp_delta);
2021 
2022     bind(profile_continue);
2023   }
2024 }
2025 
2026 
2027 void InterpreterMacroAssembler::profile_switch_default(Register mdp) {
2028   if (ProfileInterpreter) {
2029     Label profile_continue;
2030 
2031     // If no method data exists, go to profile_continue.
2032     test_method_data_pointer(mdp, profile_continue);
2033 
2034     // Update the default case count
2035     increment_mdp_data_at(mdp,
2036                           in_bytes(MultiBranchData::default_count_offset()));
2037 
2038     // The method data pointer needs to be updated.
2039     update_mdp_by_offset(mdp,
2040                          in_bytes(MultiBranchData::
2041                                   default_displacement_offset()));
2042 
2043     bind(profile_continue);
2044   }
2045 }
2046 
2047 
2048 void InterpreterMacroAssembler::profile_switch_case(Register index,
2049                                                     Register mdp,
2050                                                     Register reg2) {
2051   if (ProfileInterpreter) {
2052     Label profile_continue;
2053 
2054     // If no method data exists, go to profile_continue.
2055     test_method_data_pointer(mdp, profile_continue);
2056 
2057     // Build the base (index * per_case_size_in_bytes()) +
2058     // case_array_offset_in_bytes()
2059     movl(reg2, in_bytes(MultiBranchData::per_case_size()));
2060     imulptr(index, reg2); // XXX l ?
2061     addptr(index, in_bytes(MultiBranchData::case_array_offset())); // XXX l ?
2062 
2063     // Update the case count
2064     increment_mdp_data_at(mdp,
2065                           index,
2066                           in_bytes(MultiBranchData::relative_count_offset()));
2067 
2068     // The method data pointer needs to be updated.
2069     update_mdp_by_offset(mdp,
2070                          index,
2071                          in_bytes(MultiBranchData::
2072                                   relative_displacement_offset()));
2073 
2074     bind(profile_continue);
2075   }
2076 }
2077 
2078 void InterpreterMacroAssembler::profile_array(Register mdp,
2079                                               Register array,
2080                                               Register tmp) {
2081   if (ProfileInterpreter) {
2082     Label profile_continue;
2083 
2084     // If no method data exists, go to profile_continue.
2085     test_method_data_pointer(mdp, profile_continue);
2086 
2087     mov(tmp, array);
2088     profile_obj_type(tmp, Address(mdp, in_bytes(ArrayLoadStoreData::array_offset())));
2089 
2090     Label not_flat;
2091     test_non_flattened_array_oop(array, tmp, not_flat);
2092 
2093     set_mdp_flag_at(mdp, ArrayLoadStoreData::flat_array_byte_constant());
2094 
2095     bind(not_flat);
2096 
2097     Label not_null_free;
2098     test_non_null_free_array_oop(array, tmp, not_null_free);
2099 
2100     set_mdp_flag_at(mdp, ArrayLoadStoreData::null_free_array_byte_constant());
2101 
2102     bind(not_null_free);
2103 
2104     bind(profile_continue);
2105   }
2106 }
2107 
2108 void InterpreterMacroAssembler::profile_element(Register mdp,
2109                                                 Register element,
2110                                                 Register tmp) {
2111   if (ProfileInterpreter) {
2112     Label profile_continue;
2113 
2114     // If no method data exists, go to profile_continue.
2115     test_method_data_pointer(mdp, profile_continue);
2116 
2117     mov(tmp, element);
2118     profile_obj_type(tmp, Address(mdp, in_bytes(ArrayLoadStoreData::element_offset())));
2119 
2120     // The method data pointer needs to be updated.
2121     update_mdp_by_constant(mdp, in_bytes(ArrayLoadStoreData::array_load_store_data_size()));
2122 
2123     bind(profile_continue);
2124   }
2125 }
2126 
2127 void InterpreterMacroAssembler::_interp_verify_oop(Register reg, TosState state, const char* file, int line) {
2128   if (state == atos) {
2129     MacroAssembler::_verify_oop(reg, &quot;broken oop&quot;, file, line);
2130   }
2131 }
2132 
2133 void InterpreterMacroAssembler::verify_FPU(int stack_depth, TosState state) {
2134 #ifndef _LP64
2135   if ((state == ftos &amp;&amp; UseSSE &lt; 1) ||
2136       (state == dtos &amp;&amp; UseSSE &lt; 2)) {
2137     MacroAssembler::verify_FPU(stack_depth);
2138   }
2139 #endif
2140 }
2141 
2142 // Jump if ((*counter_addr += increment) &amp; mask) satisfies the condition.
2143 void InterpreterMacroAssembler::increment_mask_and_jump(Address counter_addr,
2144                                                         int increment, Address mask,
2145                                                         Register scratch, bool preloaded,
2146                                                         Condition cond, Label* where) {
2147   if (!preloaded) {
2148     movl(scratch, counter_addr);
2149   }
2150   incrementl(scratch, increment);
2151   movl(counter_addr, scratch);
2152   andl(scratch, mask);
2153   if (where != NULL) {
2154     jcc(cond, *where);
2155   }
2156 }
2157 
2158 void InterpreterMacroAssembler::notify_method_entry() {
2159   // Whenever JVMTI is interp_only_mode, method entry/exit events are sent to
2160   // track stack depth.  If it is possible to enter interp_only_mode we add
2161   // the code to check if the event should be sent.
2162   Register rthread = LP64_ONLY(r15_thread) NOT_LP64(rcx);
2163   Register rarg = LP64_ONLY(c_rarg1) NOT_LP64(rbx);
2164   if (JvmtiExport::can_post_interpreter_events()) {
2165     Label L;
2166     NOT_LP64(get_thread(rthread);)
2167     movl(rdx, Address(rthread, JavaThread::interp_only_mode_offset()));
2168     testl(rdx, rdx);
2169     jcc(Assembler::zero, L);
2170     call_VM(noreg, CAST_FROM_FN_PTR(address,
2171                                     InterpreterRuntime::post_method_entry));
2172     bind(L);
2173   }
2174 
2175   {
2176     SkipIfEqual skip(this, &amp;DTraceMethodProbes, false);
2177     NOT_LP64(get_thread(rthread);)
2178     get_method(rarg);
2179     call_VM_leaf(CAST_FROM_FN_PTR(address, SharedRuntime::dtrace_method_entry),
2180                  rthread, rarg);
2181   }
2182 
2183   // RedefineClasses() tracing support for obsolete method entry
2184   if (log_is_enabled(Trace, redefine, class, obsolete)) {
2185     NOT_LP64(get_thread(rthread);)
2186     get_method(rarg);
2187     call_VM_leaf(
2188       CAST_FROM_FN_PTR(address, SharedRuntime::rc_trace_method_entry),
2189       rthread, rarg);
2190   }
2191 }
2192 
2193 
2194 void InterpreterMacroAssembler::notify_method_exit(
2195     TosState state, NotifyMethodExitMode mode) {
2196   // Whenever JVMTI is interp_only_mode, method entry/exit events are sent to
2197   // track stack depth.  If it is possible to enter interp_only_mode we add
2198   // the code to check if the event should be sent.
2199   Register rthread = LP64_ONLY(r15_thread) NOT_LP64(rcx);
2200   Register rarg = LP64_ONLY(c_rarg1) NOT_LP64(rbx);
2201   if (mode == NotifyJVMTI &amp;&amp; JvmtiExport::can_post_interpreter_events()) {
2202     Label L;
2203     // Note: frame::interpreter_frame_result has a dependency on how the
2204     // method result is saved across the call to post_method_exit. If this
2205     // is changed then the interpreter_frame_result implementation will
2206     // need to be updated too.
2207 
2208     // template interpreter will leave the result on the top of the stack.
2209     push(state);
2210     NOT_LP64(get_thread(rthread);)
2211     movl(rdx, Address(rthread, JavaThread::interp_only_mode_offset()));
2212     testl(rdx, rdx);
2213     jcc(Assembler::zero, L);
2214     call_VM(noreg,
2215             CAST_FROM_FN_PTR(address, InterpreterRuntime::post_method_exit));
2216     bind(L);
2217     pop(state);
2218   }
2219 
2220   {
2221     SkipIfEqual skip(this, &amp;DTraceMethodProbes, false);
2222     push(state);
2223     NOT_LP64(get_thread(rthread);)
2224     get_method(rarg);
2225     call_VM_leaf(CAST_FROM_FN_PTR(address, SharedRuntime::dtrace_method_exit),
2226                  rthread, rarg);
2227     pop(state);
2228   }
2229 }
<a name="3" id="anc3"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="3" type="hidden" />
</body>
</html>