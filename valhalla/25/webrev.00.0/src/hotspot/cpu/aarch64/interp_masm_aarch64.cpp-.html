<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Old src/hotspot/cpu/aarch64/interp_masm_aarch64.cpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
  </head>
  <body>
    <pre>
   1 /*
   2  * Copyright (c) 2003, 2018, Oracle and/or its affiliates. All rights reserved.
   3  * Copyright (c) 2014, Red Hat Inc. All rights reserved.
   4  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   5  *
   6  * This code is free software; you can redistribute it and/or modify it
   7  * under the terms of the GNU General Public License version 2 only, as
   8  * published by the Free Software Foundation.
   9  *
  10  * This code is distributed in the hope that it will be useful, but WITHOUT
  11  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  12  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  13  * version 2 for more details (a copy is included in the LICENSE file that
  14  * accompanied this code).
  15  *
  16  * You should have received a copy of the GNU General Public License version
  17  * 2 along with this work; if not, write to the Free Software Foundation,
  18  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  19  *
  20  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  21  * or visit www.oracle.com if you need additional information or have any
  22  * questions.
  23  *
  24  */
  25 
  26 #include &quot;precompiled.hpp&quot;
  27 #include &quot;asm/macroAssembler.inline.hpp&quot;
  28 #include &quot;gc/shared/barrierSet.hpp&quot;
  29 #include &quot;gc/shared/barrierSetAssembler.hpp&quot;
  30 #include &quot;interp_masm_aarch64.hpp&quot;
  31 #include &quot;interpreter/interpreter.hpp&quot;
  32 #include &quot;interpreter/interpreterRuntime.hpp&quot;
  33 #include &quot;logging/log.hpp&quot;
  34 #include &quot;oops/arrayOop.hpp&quot;
  35 #include &quot;oops/markWord.hpp&quot;
  36 #include &quot;oops/method.hpp&quot;
  37 #include &quot;oops/methodData.hpp&quot;
  38 #include &quot;oops/valueKlass.hpp&quot;
  39 #include &quot;prims/jvmtiExport.hpp&quot;
  40 #include &quot;prims/jvmtiThreadState.hpp&quot;
  41 #include &quot;runtime/basicLock.hpp&quot;
  42 #include &quot;runtime/biasedLocking.hpp&quot;
  43 #include &quot;runtime/frame.inline.hpp&quot;
  44 #include &quot;runtime/safepointMechanism.hpp&quot;
  45 #include &quot;runtime/sharedRuntime.hpp&quot;
  46 #include &quot;runtime/thread.inline.hpp&quot;
  47 #include &quot;utilities/powerOfTwo.hpp&quot;
  48 
  49 void InterpreterMacroAssembler::narrow(Register result) {
  50 
  51   // Get method-&gt;_constMethod-&gt;_result_type
  52   ldr(rscratch1, Address(rfp, frame::interpreter_frame_method_offset * wordSize));
  53   ldr(rscratch1, Address(rscratch1, Method::const_offset()));
  54   ldrb(rscratch1, Address(rscratch1, ConstMethod::result_type_offset()));
  55 
  56   Label done, notBool, notByte, notChar;
  57 
  58   // common case first
  59   cmpw(rscratch1, T_INT);
  60   br(Assembler::EQ, done);
  61 
  62   // mask integer result to narrower return type.
  63   cmpw(rscratch1, T_BOOLEAN);
  64   br(Assembler::NE, notBool);
  65   andw(result, result, 0x1);
  66   b(done);
  67 
  68   bind(notBool);
  69   cmpw(rscratch1, T_BYTE);
  70   br(Assembler::NE, notByte);
  71   sbfx(result, result, 0, 8);
  72   b(done);
  73 
  74   bind(notByte);
  75   cmpw(rscratch1, T_CHAR);
  76   br(Assembler::NE, notChar);
  77   ubfx(result, result, 0, 16);  // truncate upper 16 bits
  78   b(done);
  79 
  80   bind(notChar);
  81   sbfx(result, result, 0, 16);     // sign-extend short
  82 
  83   // Nothing to do for T_INT
  84   bind(done);
  85 }
  86 
  87 void InterpreterMacroAssembler::jump_to_entry(address entry) {
  88   assert(entry, &quot;Entry must have been generated by now&quot;);
  89   b(entry);
  90 }
  91 
  92 void InterpreterMacroAssembler::check_and_handle_popframe(Register java_thread) {
  93   if (JvmtiExport::can_pop_frame()) {
  94     Label L;
  95     // Initiate popframe handling only if it is not already being
  96     // processed.  If the flag has the popframe_processing bit set, it
  97     // means that this code is called *during* popframe handling - we
  98     // don&#39;t want to reenter.
  99     // This method is only called just after the call into the vm in
 100     // call_VM_base, so the arg registers are available.
 101     ldrw(rscratch1, Address(rthread, JavaThread::popframe_condition_offset()));
 102     tbz(rscratch1, exact_log2(JavaThread::popframe_pending_bit), L);
 103     tbnz(rscratch1, exact_log2(JavaThread::popframe_processing_bit), L);
 104     // Call Interpreter::remove_activation_preserving_args_entry() to get the
 105     // address of the same-named entrypoint in the generated interpreter code.
 106     call_VM_leaf(CAST_FROM_FN_PTR(address, Interpreter::remove_activation_preserving_args_entry));
 107     br(r0);
 108     bind(L);
 109   }
 110 }
 111 
 112 
 113 void InterpreterMacroAssembler::load_earlyret_value(TosState state) {
 114   ldr(r2, Address(rthread, JavaThread::jvmti_thread_state_offset()));
 115   const Address tos_addr(r2, JvmtiThreadState::earlyret_tos_offset());
 116   const Address oop_addr(r2, JvmtiThreadState::earlyret_oop_offset());
 117   const Address val_addr(r2, JvmtiThreadState::earlyret_value_offset());
 118   switch (state) {
 119     case atos: ldr(r0, oop_addr);
 120                str(zr, oop_addr);
 121                verify_oop(r0, state);               break;
 122     case ltos: ldr(r0, val_addr);                   break;
 123     case btos:                                   // fall through
 124     case ztos:                                   // fall through
 125     case ctos:                                   // fall through
 126     case stos:                                   // fall through
 127     case itos: ldrw(r0, val_addr);                  break;
 128     case ftos: ldrs(v0, val_addr);                  break;
 129     case dtos: ldrd(v0, val_addr);                  break;
 130     case vtos: /* nothing to do */                  break;
 131     default  : ShouldNotReachHere();
 132   }
 133   // Clean up tos value in the thread object
 134   movw(rscratch1, (int) ilgl);
 135   strw(rscratch1, tos_addr);
 136   strw(zr, val_addr);
 137 }
 138 
 139 
 140 void InterpreterMacroAssembler::check_and_handle_earlyret(Register java_thread) {
 141   if (JvmtiExport::can_force_early_return()) {
 142     Label L;
 143     ldr(rscratch1, Address(rthread, JavaThread::jvmti_thread_state_offset()));
 144     cbz(rscratch1, L); // if (thread-&gt;jvmti_thread_state() == NULL) exit;
 145 
 146     // Initiate earlyret handling only if it is not already being processed.
 147     // If the flag has the earlyret_processing bit set, it means that this code
 148     // is called *during* earlyret handling - we don&#39;t want to reenter.
 149     ldrw(rscratch1, Address(rscratch1, JvmtiThreadState::earlyret_state_offset()));
 150     cmpw(rscratch1, JvmtiThreadState::earlyret_pending);
 151     br(Assembler::NE, L);
 152 
 153     // Call Interpreter::remove_activation_early_entry() to get the address of the
 154     // same-named entrypoint in the generated interpreter code.
 155     ldr(rscratch1, Address(rthread, JavaThread::jvmti_thread_state_offset()));
 156     ldrw(rscratch1, Address(rscratch1, JvmtiThreadState::earlyret_tos_offset()));
 157     call_VM_leaf(CAST_FROM_FN_PTR(address, Interpreter::remove_activation_early_entry), rscratch1);
 158     br(r0);
 159     bind(L);
 160   }
 161 }
 162 
 163 void InterpreterMacroAssembler::get_unsigned_2_byte_index_at_bcp(
 164   Register reg,
 165   int bcp_offset) {
 166   assert(bcp_offset &gt;= 0, &quot;bcp is still pointing to start of bytecode&quot;);
 167   ldrh(reg, Address(rbcp, bcp_offset));
 168   rev16(reg, reg);
 169 }
 170 
 171 void InterpreterMacroAssembler::get_dispatch() {
 172   unsigned long offset;
 173   adrp(rdispatch, ExternalAddress((address)Interpreter::dispatch_table()), offset);
 174   lea(rdispatch, Address(rdispatch, offset));
 175 }
 176 
 177 void InterpreterMacroAssembler::get_cache_index_at_bcp(Register index,
 178                                                        int bcp_offset,
 179                                                        size_t index_size) {
 180   assert(bcp_offset &gt; 0, &quot;bcp is still pointing to start of bytecode&quot;);
 181   if (index_size == sizeof(u2)) {
 182     load_unsigned_short(index, Address(rbcp, bcp_offset));
 183   } else if (index_size == sizeof(u4)) {
 184     // assert(EnableInvokeDynamic, &quot;giant index used only for JSR 292&quot;);
 185     ldrw(index, Address(rbcp, bcp_offset));
 186     // Check if the secondary index definition is still ~x, otherwise
 187     // we have to change the following assembler code to calculate the
 188     // plain index.
 189     assert(ConstantPool::decode_invokedynamic_index(~123) == 123, &quot;else change next line&quot;);
 190     eonw(index, index, zr);  // convert to plain index
 191   } else if (index_size == sizeof(u1)) {
 192     load_unsigned_byte(index, Address(rbcp, bcp_offset));
 193   } else {
 194     ShouldNotReachHere();
 195   }
 196 }
 197 
 198 // Return
 199 // Rindex: index into constant pool
 200 // Rcache: address of cache entry - ConstantPoolCache::base_offset()
 201 //
 202 // A caller must add ConstantPoolCache::base_offset() to Rcache to get
 203 // the true address of the cache entry.
 204 //
 205 void InterpreterMacroAssembler::get_cache_and_index_at_bcp(Register cache,
 206                                                            Register index,
 207                                                            int bcp_offset,
 208                                                            size_t index_size) {
 209   assert_different_registers(cache, index);
 210   assert_different_registers(cache, rcpool);
 211   get_cache_index_at_bcp(index, bcp_offset, index_size);
 212   assert(sizeof(ConstantPoolCacheEntry) == 4 * wordSize, &quot;adjust code below&quot;);
 213   // convert from field index to ConstantPoolCacheEntry
 214   // aarch64 already has the cache in rcpool so there is no need to
 215   // install it in cache. instead we pre-add the indexed offset to
 216   // rcpool and return it in cache. All clients of this method need to
 217   // be modified accordingly.
 218   add(cache, rcpool, index, Assembler::LSL, 5);
 219 }
 220 
 221 
 222 void InterpreterMacroAssembler::get_cache_and_index_and_bytecode_at_bcp(Register cache,
 223                                                                         Register index,
 224                                                                         Register bytecode,
 225                                                                         int byte_no,
 226                                                                         int bcp_offset,
 227                                                                         size_t index_size) {
 228   get_cache_and_index_at_bcp(cache, index, bcp_offset, index_size);
 229   // We use a 32-bit load here since the layout of 64-bit words on
 230   // little-endian machines allow us that.
 231   // n.b. unlike x86 cache already includes the index offset
 232   lea(bytecode, Address(cache,
 233                          ConstantPoolCache::base_offset()
 234                          + ConstantPoolCacheEntry::indices_offset()));
 235   ldarw(bytecode, bytecode);
 236   const int shift_count = (1 + byte_no) * BitsPerByte;
 237   ubfx(bytecode, bytecode, shift_count, BitsPerByte);
 238 }
 239 
 240 void InterpreterMacroAssembler::get_cache_entry_pointer_at_bcp(Register cache,
 241                                                                Register tmp,
 242                                                                int bcp_offset,
 243                                                                size_t index_size) {
 244   assert(cache != tmp, &quot;must use different register&quot;);
 245   get_cache_index_at_bcp(tmp, bcp_offset, index_size);
 246   assert(sizeof(ConstantPoolCacheEntry) == 4 * wordSize, &quot;adjust code below&quot;);
 247   // convert from field index to ConstantPoolCacheEntry index
 248   // and from word offset to byte offset
 249   assert(exact_log2(in_bytes(ConstantPoolCacheEntry::size_in_bytes())) == 2 + LogBytesPerWord, &quot;else change next line&quot;);
 250   ldr(cache, Address(rfp, frame::interpreter_frame_cache_offset * wordSize));
 251   // skip past the header
 252   add(cache, cache, in_bytes(ConstantPoolCache::base_offset()));
 253   add(cache, cache, tmp, Assembler::LSL, 2 + LogBytesPerWord);  // construct pointer to cache entry
 254 }
 255 
 256 void InterpreterMacroAssembler::get_method_counters(Register method,
 257                                                     Register mcs, Label&amp; skip) {
 258   Label has_counters;
 259   ldr(mcs, Address(method, Method::method_counters_offset()));
 260   cbnz(mcs, has_counters);
 261   call_VM(noreg, CAST_FROM_FN_PTR(address,
 262           InterpreterRuntime::build_method_counters), method);
 263   ldr(mcs, Address(method, Method::method_counters_offset()));
 264   cbz(mcs, skip); // No MethodCounters allocated, OutOfMemory
 265   bind(has_counters);
 266 }
 267 
 268 // Load object from cpool-&gt;resolved_references(index)
 269 void InterpreterMacroAssembler::load_resolved_reference_at_index(
 270                                            Register result, Register index, Register tmp) {
 271   assert_different_registers(result, index);
 272 
 273   get_constant_pool(result);
 274   // load pointer for resolved_references[] objArray
 275   ldr(result, Address(result, ConstantPool::cache_offset_in_bytes()));
 276   ldr(result, Address(result, ConstantPoolCache::resolved_references_offset_in_bytes()));
 277   resolve_oop_handle(result, tmp);
 278   // Add in the index
 279   add(index, index, arrayOopDesc::base_offset_in_bytes(T_OBJECT) &gt;&gt; LogBytesPerHeapOop);
 280   load_heap_oop(result, Address(result, index, Address::uxtw(LogBytesPerHeapOop)));
 281 }
 282 
 283 void InterpreterMacroAssembler::load_resolved_klass_at_offset(
 284                              Register cpool, Register index, Register klass, Register temp) {
 285   add(temp, cpool, index, LSL, LogBytesPerWord);
 286   ldrh(temp, Address(temp, sizeof(ConstantPool))); // temp = resolved_klass_index
 287   ldr(klass, Address(cpool,  ConstantPool::resolved_klasses_offset_in_bytes())); // klass = cpool-&gt;_resolved_klasses
 288   add(klass, klass, temp, LSL, LogBytesPerWord);
 289   ldr(klass, Address(klass, Array&lt;Klass*&gt;::base_offset_in_bytes()));
 290 }
 291 
 292 void InterpreterMacroAssembler::load_resolved_method_at_index(int byte_no,
 293                                                               Register method,
 294                                                               Register cache) {
 295   const int method_offset = in_bytes(
 296     ConstantPoolCache::base_offset() +
 297       ((byte_no == TemplateTable::f2_byte)
 298        ? ConstantPoolCacheEntry::f2_offset()
 299        : ConstantPoolCacheEntry::f1_offset()));
 300 
 301   ldr(method, Address(cache, method_offset)); // get f1 Method*
 302 }
 303 
 304 // Generate a subtype check: branch to ok_is_subtype if sub_klass is a
 305 // subtype of super_klass.
 306 //
 307 // Args:
 308 //      r0: superklass
 309 //      Rsub_klass: subklass
 310 //
 311 // Kills:
 312 //      r2, r5
 313 void InterpreterMacroAssembler::gen_subtype_check(Register Rsub_klass,
 314                                                   Label&amp; ok_is_subtype) {
 315   assert(Rsub_klass != r0, &quot;r0 holds superklass&quot;);
 316   assert(Rsub_klass != r2, &quot;r2 holds 2ndary super array length&quot;);
 317   assert(Rsub_klass != r5, &quot;r5 holds 2ndary super array scan ptr&quot;);
 318 
 319   // Profile the not-null value&#39;s klass.
 320   profile_typecheck(r2, Rsub_klass, r5); // blows r2, reloads r5
 321 
 322   // Do the check.
 323   check_klass_subtype(Rsub_klass, r0, r2, ok_is_subtype); // blows r2
 324 
 325   // Profile the failure of the check.
 326   profile_typecheck_failed(r2); // blows r2
 327 }
 328 
 329 // Java Expression Stack
 330 
 331 void InterpreterMacroAssembler::pop_ptr(Register r) {
 332   ldr(r, post(esp, wordSize));
 333 }
 334 
 335 void InterpreterMacroAssembler::pop_i(Register r) {
 336   ldrw(r, post(esp, wordSize));
 337 }
 338 
 339 void InterpreterMacroAssembler::pop_l(Register r) {
 340   ldr(r, post(esp, 2 * Interpreter::stackElementSize));
 341 }
 342 
 343 void InterpreterMacroAssembler::push_ptr(Register r) {
 344   str(r, pre(esp, -wordSize));
 345  }
 346 
 347 void InterpreterMacroAssembler::push_i(Register r) {
 348   str(r, pre(esp, -wordSize));
 349 }
 350 
 351 void InterpreterMacroAssembler::push_l(Register r) {
 352   str(zr, pre(esp, -wordSize));
 353   str(r, pre(esp, - wordSize));
 354 }
 355 
 356 void InterpreterMacroAssembler::pop_f(FloatRegister r) {
 357   ldrs(r, post(esp, wordSize));
 358 }
 359 
 360 void InterpreterMacroAssembler::pop_d(FloatRegister r) {
 361   ldrd(r, post(esp, 2 * Interpreter::stackElementSize));
 362 }
 363 
 364 void InterpreterMacroAssembler::push_f(FloatRegister r) {
 365   strs(r, pre(esp, -wordSize));
 366 }
 367 
 368 void InterpreterMacroAssembler::push_d(FloatRegister r) {
 369   strd(r, pre(esp, 2* -wordSize));
 370 }
 371 
 372 void InterpreterMacroAssembler::pop(TosState state) {
 373   switch (state) {
 374   case atos: pop_ptr();                 break;
 375   case btos:
 376   case ztos:
 377   case ctos:
 378   case stos:
 379   case itos: pop_i();                   break;
 380   case ltos: pop_l();                   break;
 381   case ftos: pop_f();                   break;
 382   case dtos: pop_d();                   break;
 383   case vtos: /* nothing to do */        break;
 384   default:   ShouldNotReachHere();
 385   }
 386   verify_oop(r0, state);
 387 }
 388 
 389 void InterpreterMacroAssembler::push(TosState state) {
 390   verify_oop(r0, state);
 391   switch (state) {
 392   case atos: push_ptr();                break;
 393   case btos:
 394   case ztos:
 395   case ctos:
 396   case stos:
 397   case itos: push_i();                  break;
 398   case ltos: push_l();                  break;
 399   case ftos: push_f();                  break;
 400   case dtos: push_d();                  break;
 401   case vtos: /* nothing to do */        break;
 402   default  : ShouldNotReachHere();
 403   }
 404 }
 405 
 406 // Helpers for swap and dup
 407 void InterpreterMacroAssembler::load_ptr(int n, Register val) {
 408   ldr(val, Address(esp, Interpreter::expr_offset_in_bytes(n)));
 409 }
 410 
 411 void InterpreterMacroAssembler::store_ptr(int n, Register val) {
 412   str(val, Address(esp, Interpreter::expr_offset_in_bytes(n)));
 413 }
 414 
 415 void InterpreterMacroAssembler::load_float(Address src) {
 416   ldrs(v0, src);
 417 }
 418 
 419 void InterpreterMacroAssembler::load_double(Address src) {
 420   ldrd(v0, src);
 421 }
 422 
 423 void InterpreterMacroAssembler::prepare_to_jump_from_interpreted() {
 424   // set sender sp
 425   mov(r13, sp);
 426   // record last_sp
 427   str(esp, Address(rfp, frame::interpreter_frame_last_sp_offset * wordSize));
 428 }
 429 
 430 // Jump to from_interpreted entry of a call unless single stepping is possible
 431 // in this thread in which case we must call the i2i entry
 432 void InterpreterMacroAssembler::jump_from_interpreted(Register method, Register temp) {
 433   prepare_to_jump_from_interpreted();
 434 
 435   if (JvmtiExport::can_post_interpreter_events()) {
 436     Label run_compiled_code;
 437     // JVMTI events, such as single-stepping, are implemented partly by avoiding running
 438     // compiled code in threads for which the event is enabled.  Check here for
 439     // interp_only_mode if these events CAN be enabled.
 440     ldrw(rscratch1, Address(rthread, JavaThread::interp_only_mode_offset()));
 441     cbzw(rscratch1, run_compiled_code);
 442     ldr(rscratch1, Address(method, Method::interpreter_entry_offset()));
 443     br(rscratch1);
 444     bind(run_compiled_code);
 445   }
 446 
 447   ldr(rscratch1, Address(method, Method::from_interpreted_offset()));
 448   br(rscratch1);
 449 }
 450 
 451 // The following two routines provide a hook so that an implementation
 452 // can schedule the dispatch in two parts.  amd64 does not do this.
 453 void InterpreterMacroAssembler::dispatch_prolog(TosState state, int step) {
 454 }
 455 
 456 void InterpreterMacroAssembler::dispatch_epilog(TosState state, int step) {
 457     dispatch_next(state, step);
 458 }
 459 
 460 void InterpreterMacroAssembler::dispatch_base(TosState state,
 461                                               address* table,
 462                                               bool verifyoop,
 463                                               bool generate_poll) {
 464   if (VerifyActivationFrameSize) {
 465     Unimplemented();
 466   }
 467   if (verifyoop) {
 468     verify_oop(r0, state);
 469   }
 470 
 471   Label safepoint;
 472   address* const safepoint_table = Interpreter::safept_table(state);
 473   bool needs_thread_local_poll = generate_poll &amp;&amp;
 474     SafepointMechanism::uses_thread_local_poll() &amp;&amp; table != safepoint_table;
 475 
 476   if (needs_thread_local_poll) {
 477     NOT_PRODUCT(block_comment(&quot;Thread-local Safepoint poll&quot;));
 478     ldr(rscratch2, Address(rthread, Thread::polling_page_offset()));
 479     tbnz(rscratch2, exact_log2(SafepointMechanism::poll_bit()), safepoint);
 480   }
 481 
 482   if (table == Interpreter::dispatch_table(state)) {
 483     addw(rscratch2, rscratch1, Interpreter::distance_from_dispatch_table(state));
 484     ldr(rscratch2, Address(rdispatch, rscratch2, Address::uxtw(3)));
 485   } else {
 486     mov(rscratch2, (address)table);
 487     ldr(rscratch2, Address(rscratch2, rscratch1, Address::uxtw(3)));
 488   }
 489   br(rscratch2);
 490 
 491   if (needs_thread_local_poll) {
 492     bind(safepoint);
 493     lea(rscratch2, ExternalAddress((address)safepoint_table));
 494     ldr(rscratch2, Address(rscratch2, rscratch1, Address::uxtw(3)));
 495     br(rscratch2);
 496   }
 497 }
 498 
 499 void InterpreterMacroAssembler::dispatch_only(TosState state, bool generate_poll) {
 500   dispatch_base(state, Interpreter::dispatch_table(state), true, generate_poll);
 501 }
 502 
 503 void InterpreterMacroAssembler::dispatch_only_normal(TosState state) {
 504   dispatch_base(state, Interpreter::normal_table(state));
 505 }
 506 
 507 void InterpreterMacroAssembler::dispatch_only_noverify(TosState state) {
 508   dispatch_base(state, Interpreter::normal_table(state), false);
 509 }
 510 
 511 
 512 void InterpreterMacroAssembler::dispatch_next(TosState state, int step, bool generate_poll) {
 513   // load next bytecode
 514   ldrb(rscratch1, Address(pre(rbcp, step)));
 515   dispatch_base(state, Interpreter::dispatch_table(state), generate_poll);
 516 }
 517 
 518 void InterpreterMacroAssembler::dispatch_via(TosState state, address* table) {
 519   // load current bytecode
 520   ldrb(rscratch1, Address(rbcp, 0));
 521   dispatch_base(state, table);
 522 }
 523 
 524 // remove activation
 525 //
 526 // Unlock the receiver if this is a synchronized method.
 527 // Unlock any Java monitors from syncronized blocks.
 528 // Remove the activation from the stack.
 529 //
 530 // If there are locked Java monitors
 531 //    If throw_monitor_exception
 532 //       throws IllegalMonitorStateException
 533 //    Else if install_monitor_exception
 534 //       installs IllegalMonitorStateException
 535 //    Else
 536 //       no error processing
 537 void InterpreterMacroAssembler::remove_activation(
 538         TosState state,
 539         bool throw_monitor_exception,
 540         bool install_monitor_exception,
 541         bool notify_jvmdi) {
 542   // Note: Registers r3 xmm0 may be in use for the
 543   // result check if synchronized method
 544   Label unlocked, unlock, no_unlock;
 545 
 546   // get the value of _do_not_unlock_if_synchronized into r3
 547   const Address do_not_unlock_if_synchronized(rthread,
 548     in_bytes(JavaThread::do_not_unlock_if_synchronized_offset()));
 549   ldrb(r3, do_not_unlock_if_synchronized);
 550   strb(zr, do_not_unlock_if_synchronized); // reset the flag
 551 
 552  // get method access flags
 553   ldr(r1, Address(rfp, frame::interpreter_frame_method_offset * wordSize));
 554   ldr(r2, Address(r1, Method::access_flags_offset()));
 555   tbz(r2, exact_log2(JVM_ACC_SYNCHRONIZED), unlocked);
 556 
 557   // Don&#39;t unlock anything if the _do_not_unlock_if_synchronized flag
 558   // is set.
 559   cbnz(r3, no_unlock);
 560 
 561   // unlock monitor
 562   push(state); // save result
 563 
 564   // BasicObjectLock will be first in list, since this is a
 565   // synchronized method. However, need to check that the object has
 566   // not been unlocked by an explicit monitorexit bytecode.
 567   const Address monitor(rfp, frame::interpreter_frame_initial_sp_offset *
 568                         wordSize - (int) sizeof(BasicObjectLock));
 569   // We use c_rarg1 so that if we go slow path it will be the correct
 570   // register for unlock_object to pass to VM directly
 571   lea(c_rarg1, monitor); // address of first monitor
 572 
 573   ldr(r0, Address(c_rarg1, BasicObjectLock::obj_offset_in_bytes()));
 574   cbnz(r0, unlock);
 575 
 576   pop(state);
 577   if (throw_monitor_exception) {
 578     // Entry already unlocked, need to throw exception
 579     call_VM(noreg, CAST_FROM_FN_PTR(address,
 580                    InterpreterRuntime::throw_illegal_monitor_state_exception));
 581     should_not_reach_here();
 582   } else {
 583     // Monitor already unlocked during a stack unroll. If requested,
 584     // install an illegal_monitor_state_exception.  Continue with
 585     // stack unrolling.
 586     if (install_monitor_exception) {
 587       call_VM(noreg, CAST_FROM_FN_PTR(address,
 588                      InterpreterRuntime::new_illegal_monitor_state_exception));
 589     }
 590     b(unlocked);
 591   }
 592 
 593   bind(unlock);
 594   unlock_object(c_rarg1);
 595   pop(state);
 596 
 597   // Check that for block-structured locking (i.e., that all locked
 598   // objects has been unlocked)
 599   bind(unlocked);
 600 
 601   // r0: Might contain return value
 602 
 603   // Check that all monitors are unlocked
 604   {
 605     Label loop, exception, entry, restart;
 606     const int entry_size = frame::interpreter_frame_monitor_size() * wordSize;
 607     const Address monitor_block_top(
 608         rfp, frame::interpreter_frame_monitor_block_top_offset * wordSize);
 609     const Address monitor_block_bot(
 610         rfp, frame::interpreter_frame_initial_sp_offset * wordSize);
 611 
 612     bind(restart);
 613     // We use c_rarg1 so that if we go slow path it will be the correct
 614     // register for unlock_object to pass to VM directly
 615     ldr(c_rarg1, monitor_block_top); // points to current entry, starting
 616                                      // with top-most entry
 617     lea(r19, monitor_block_bot);  // points to word before bottom of
 618                                   // monitor block
 619     b(entry);
 620 
 621     // Entry already locked, need to throw exception
 622     bind(exception);
 623 
 624     if (throw_monitor_exception) {
 625       // Throw exception
 626       MacroAssembler::call_VM(noreg,
 627                               CAST_FROM_FN_PTR(address, InterpreterRuntime::
 628                                    throw_illegal_monitor_state_exception));
 629       should_not_reach_here();
 630     } else {
 631       // Stack unrolling. Unlock object and install illegal_monitor_exception.
 632       // Unlock does not block, so don&#39;t have to worry about the frame.
 633       // We don&#39;t have to preserve c_rarg1 since we are going to throw an exception.
 634 
 635       push(state);
 636       unlock_object(c_rarg1);
 637       pop(state);
 638 
 639       if (install_monitor_exception) {
 640         call_VM(noreg, CAST_FROM_FN_PTR(address,
 641                                         InterpreterRuntime::
 642                                         new_illegal_monitor_state_exception));
 643       }
 644 
 645       b(restart);
 646     }
 647 
 648     bind(loop);
 649     // check if current entry is used
 650     ldr(rscratch1, Address(c_rarg1, BasicObjectLock::obj_offset_in_bytes()));
 651     cbnz(rscratch1, exception);
 652 
 653     add(c_rarg1, c_rarg1, entry_size); // otherwise advance to next entry
 654     bind(entry);
 655     cmp(c_rarg1, r19); // check if bottom reached
 656     br(Assembler::NE, loop); // if not at bottom then check this entry
 657   }
 658 
 659   bind(no_unlock);
 660 
 661   // jvmti support
 662   if (notify_jvmdi) {
 663     notify_method_exit(state, NotifyJVMTI);    // preserve TOSCA
 664   } else {
 665     notify_method_exit(state, SkipNotifyJVMTI); // preserve TOSCA
 666   }
 667 
 668   // remove activation
 669   // get sender esp
 670   ldr(esp,
 671       Address(rfp, frame::interpreter_frame_sender_sp_offset * wordSize));
 672 
 673   if (StackReservedPages &gt; 0) {
 674     // testing if reserved zone needs to be re-enabled
 675     Label no_reserved_zone_enabling;
 676 
 677     ldr(rscratch1, Address(rthread, JavaThread::reserved_stack_activation_offset()));
 678     cmp(esp, rscratch1);
 679     br(Assembler::LS, no_reserved_zone_enabling);
 680 
 681     call_VM_leaf(
 682       CAST_FROM_FN_PTR(address, SharedRuntime::enable_stack_reserved_zone), rthread);
 683     call_VM(noreg, CAST_FROM_FN_PTR(address,
 684                    InterpreterRuntime::throw_delayed_StackOverflowError));
 685     should_not_reach_here();
 686 
 687     bind(no_reserved_zone_enabling);
 688   }
 689 
 690 
 691   if (state == atos &amp;&amp; ValueTypeReturnedAsFields) {
 692     Label skip;
 693     // Test if the return type is a value type
 694     ldr(rscratch1, Address(rfp, frame::interpreter_frame_method_offset * wordSize));
 695     ldr(rscratch1, Address(rscratch1, Method::const_offset()));
 696     ldrb(rscratch1, Address(rscratch1, ConstMethod::result_type_offset()));
 697     cmpw(rscratch1, (u1) T_VALUETYPE);
 698     br(Assembler::NE, skip);
 699 
 700     // We are returning a value type, load its fields into registers
 701     // Load fields from a buffered value with a value class specific handler
 702 
 703     load_klass(rscratch1 /*dst*/, r0 /*src*/);
 704     ldr(rscratch1, Address(rscratch1, InstanceKlass::adr_valueklass_fixed_block_offset()));
 705     ldr(rscratch1, Address(rscratch1, ValueKlass::unpack_handler_offset()));
 706     cbz(rscratch1, skip);
 707 
 708     blr(rscratch1);
 709 
 710     // call above kills the value in r1. Reload it.
 711     ldr(r1, Address(rfp, frame::interpreter_frame_sender_sp_offset * wordSize));
 712     bind(skip);
 713   }
 714 
 715 
 716   // remove frame anchor
 717   leave();
 718   // If we&#39;re returning to interpreted code we will shortly be
 719   // adjusting SP to allow some space for ESP.  If we&#39;re returning to
 720   // compiled code the saved sender SP was saved in sender_sp, so this
 721   // restores it.
 722   andr(sp, esp, -16);
 723 }
 724 
 725 // Lock object
 726 //
 727 // Args:
 728 //      c_rarg1: BasicObjectLock to be used for locking
 729 //
 730 // Kills:
 731 //      r0
 732 //      c_rarg0, c_rarg1, c_rarg2, c_rarg3, .. (param regs)
 733 //      rscratch1, rscratch2 (scratch regs)
 734 void InterpreterMacroAssembler::lock_object(Register lock_reg)
 735 {
 736   assert(lock_reg == c_rarg1, &quot;The argument is only for looks. It must be c_rarg1&quot;);
 737   if (UseHeavyMonitors) {
 738     call_VM(noreg,
 739             CAST_FROM_FN_PTR(address, InterpreterRuntime::monitorenter),
 740             lock_reg);
 741   } else {
 742     Label done;
 743 
 744     const Register swap_reg = r0;
 745     const Register tmp = c_rarg2;
 746     const Register obj_reg = c_rarg3; // Will contain the oop
 747 
 748     const int obj_offset = BasicObjectLock::obj_offset_in_bytes();
 749     const int lock_offset = BasicObjectLock::lock_offset_in_bytes ();
 750     const int mark_offset = lock_offset +
 751                             BasicLock::displaced_header_offset_in_bytes();
 752 
 753     Label slow_case;
 754 
 755     // Load object pointer into obj_reg %c_rarg3
 756     ldr(obj_reg, Address(lock_reg, obj_offset));
 757 
 758     if (UseBiasedLocking) {
 759       biased_locking_enter(lock_reg, obj_reg, swap_reg, tmp, false, done, &amp;slow_case);
 760     }
 761 
 762     // Load (object-&gt;mark() | 1) into swap_reg
 763     ldr(rscratch1, Address(obj_reg, oopDesc::mark_offset_in_bytes()));
 764     orr(swap_reg, rscratch1, 1);
 765 
 766     // Save (object-&gt;mark() | 1) into BasicLock&#39;s displaced header
 767     str(swap_reg, Address(lock_reg, mark_offset));
 768 
 769     if (EnableValhalla &amp;&amp; !UseBiasedLocking) {
 770       // For slow path is_always_locked, using biased, which is never natural for !UseBiasLocking
 771       andr(swap_reg, swap_reg, ~((int) markWord::biased_lock_bit_in_place));
 772     }
 773 
 774     assert(lock_offset == 0,
 775            &quot;displached header must be first word in BasicObjectLock&quot;);
 776 
 777     Label fail;
 778     if (PrintBiasedLockingStatistics) {
 779       Label fast;
 780       cmpxchg_obj_header(swap_reg, lock_reg, obj_reg, rscratch1, fast, &amp;fail);
 781       bind(fast);
 782       atomic_incw(Address((address)BiasedLocking::fast_path_entry_count_addr()),
 783                   rscratch2, rscratch1, tmp);
 784       b(done);
 785       bind(fail);
 786     } else {
 787       cmpxchg_obj_header(swap_reg, lock_reg, obj_reg, rscratch1, done, /*fallthrough*/NULL);
 788     }
 789 
 790     // Test if the oopMark is an obvious stack pointer, i.e.,
 791     //  1) (mark &amp; 7) == 0, and
 792     //  2) rsp &lt;= mark &lt; mark + os::pagesize()
 793     //
 794     // These 3 tests can be done by evaluating the following
 795     // expression: ((mark - rsp) &amp; (7 - os::vm_page_size())),
 796     // assuming both stack pointer and pagesize have their
 797     // least significant 3 bits clear.
 798     // NOTE: the oopMark is in swap_reg %r0 as the result of cmpxchg
 799     // NOTE2: aarch64 does not like to subtract sp from rn so take a
 800     // copy
 801     mov(rscratch1, sp);
 802     sub(swap_reg, swap_reg, rscratch1);
 803     ands(swap_reg, swap_reg, (unsigned long)(7 - os::vm_page_size()));
 804 
 805     // Save the test result, for recursive case, the result is zero
 806     str(swap_reg, Address(lock_reg, mark_offset));
 807 
 808     if (PrintBiasedLockingStatistics) {
 809       br(Assembler::NE, slow_case);
 810       atomic_incw(Address((address)BiasedLocking::fast_path_entry_count_addr()),
 811                   rscratch2, rscratch1, tmp);
 812     }
 813     br(Assembler::EQ, done);
 814 
 815     bind(slow_case);
 816 
 817     // Call the runtime routine for slow case
 818     call_VM(noreg,
 819             CAST_FROM_FN_PTR(address, InterpreterRuntime::monitorenter),
 820             lock_reg);
 821 
 822     bind(done);
 823   }
 824 }
 825 
 826 
 827 // Unlocks an object. Used in monitorexit bytecode and
 828 // remove_activation.  Throws an IllegalMonitorException if object is
 829 // not locked by current thread.
 830 //
 831 // Args:
 832 //      c_rarg1: BasicObjectLock for lock
 833 //
 834 // Kills:
 835 //      r0
 836 //      c_rarg0, c_rarg1, c_rarg2, c_rarg3, ... (param regs)
 837 //      rscratch1, rscratch2 (scratch regs)
 838 void InterpreterMacroAssembler::unlock_object(Register lock_reg)
 839 {
 840   assert(lock_reg == c_rarg1, &quot;The argument is only for looks. It must be rarg1&quot;);
 841 
 842   if (UseHeavyMonitors) {
 843     call_VM(noreg,
 844             CAST_FROM_FN_PTR(address, InterpreterRuntime::monitorexit),
 845             lock_reg);
 846   } else {
 847     Label done;
 848 
 849     const Register swap_reg   = r0;
 850     const Register header_reg = c_rarg2;  // Will contain the old oopMark
 851     const Register obj_reg    = c_rarg3;  // Will contain the oop
 852 
 853     save_bcp(); // Save in case of exception
 854 
 855     // Convert from BasicObjectLock structure to object and BasicLock
 856     // structure Store the BasicLock address into %r0
 857     lea(swap_reg, Address(lock_reg, BasicObjectLock::lock_offset_in_bytes()));
 858 
 859     // Load oop into obj_reg(%c_rarg3)
 860     ldr(obj_reg, Address(lock_reg, BasicObjectLock::obj_offset_in_bytes()));
 861 
 862     // Free entry
 863     str(zr, Address(lock_reg, BasicObjectLock::obj_offset_in_bytes()));
 864 
 865     if (UseBiasedLocking) {
 866       biased_locking_exit(obj_reg, header_reg, done);
 867     }
 868 
 869     // Load the old header from BasicLock structure
 870     ldr(header_reg, Address(swap_reg,
 871                             BasicLock::displaced_header_offset_in_bytes()));
 872 
 873     // Test for recursion
 874     cbz(header_reg, done);
 875 
 876     // Atomic swap back the old header
 877     cmpxchg_obj_header(swap_reg, header_reg, obj_reg, rscratch1, done, /*fallthrough*/NULL);
 878 
 879     // Call the runtime routine for slow case.
 880     str(obj_reg, Address(lock_reg, BasicObjectLock::obj_offset_in_bytes())); // restore obj
 881     call_VM(noreg,
 882             CAST_FROM_FN_PTR(address, InterpreterRuntime::monitorexit),
 883             lock_reg);
 884 
 885     bind(done);
 886 
 887     restore_bcp();
 888   }
 889 }
 890 
 891 void InterpreterMacroAssembler::test_method_data_pointer(Register mdp,
 892                                                          Label&amp; zero_continue) {
 893   assert(ProfileInterpreter, &quot;must be profiling interpreter&quot;);
 894   ldr(mdp, Address(rfp, frame::interpreter_frame_mdp_offset * wordSize));
 895   cbz(mdp, zero_continue);
 896 }
 897 
 898 // Set the method data pointer for the current bcp.
 899 void InterpreterMacroAssembler::set_method_data_pointer_for_bcp() {
 900   assert(ProfileInterpreter, &quot;must be profiling interpreter&quot;);
 901   Label set_mdp;
 902   stp(r0, r1, Address(pre(sp, -2 * wordSize)));
 903 
 904   // Test MDO to avoid the call if it is NULL.
 905   ldr(r0, Address(rmethod, in_bytes(Method::method_data_offset())));
 906   cbz(r0, set_mdp);
 907   call_VM_leaf(CAST_FROM_FN_PTR(address, InterpreterRuntime::bcp_to_di), rmethod, rbcp);
 908   // r0: mdi
 909   // mdo is guaranteed to be non-zero here, we checked for it before the call.
 910   ldr(r1, Address(rmethod, in_bytes(Method::method_data_offset())));
 911   lea(r1, Address(r1, in_bytes(MethodData::data_offset())));
 912   add(r0, r1, r0);
 913   str(r0, Address(rfp, frame::interpreter_frame_mdp_offset * wordSize));
 914   bind(set_mdp);
 915   ldp(r0, r1, Address(post(sp, 2 * wordSize)));
 916 }
 917 
 918 void InterpreterMacroAssembler::verify_method_data_pointer() {
 919   assert(ProfileInterpreter, &quot;must be profiling interpreter&quot;);
 920 #ifdef ASSERT
 921   Label verify_continue;
 922   stp(r0, r1, Address(pre(sp, -2 * wordSize)));
 923   stp(r2, r3, Address(pre(sp, -2 * wordSize)));
 924   test_method_data_pointer(r3, verify_continue); // If mdp is zero, continue
 925   get_method(r1);
 926 
 927   // If the mdp is valid, it will point to a DataLayout header which is
 928   // consistent with the bcp.  The converse is highly probable also.
 929   ldrsh(r2, Address(r3, in_bytes(DataLayout::bci_offset())));
 930   ldr(rscratch1, Address(r1, Method::const_offset()));
 931   add(r2, r2, rscratch1, Assembler::LSL);
 932   lea(r2, Address(r2, ConstMethod::codes_offset()));
 933   cmp(r2, rbcp);
 934   br(Assembler::EQ, verify_continue);
 935   // r1: method
 936   // rbcp: bcp // rbcp == 22
 937   // r3: mdp
 938   call_VM_leaf(CAST_FROM_FN_PTR(address, InterpreterRuntime::verify_mdp),
 939                r1, rbcp, r3);
 940   bind(verify_continue);
 941   ldp(r2, r3, Address(post(sp, 2 * wordSize)));
 942   ldp(r0, r1, Address(post(sp, 2 * wordSize)));
 943 #endif // ASSERT
 944 }
 945 
 946 
 947 void InterpreterMacroAssembler::set_mdp_data_at(Register mdp_in,
 948                                                 int constant,
 949                                                 Register value) {
 950   assert(ProfileInterpreter, &quot;must be profiling interpreter&quot;);
 951   Address data(mdp_in, constant);
 952   str(value, data);
 953 }
 954 
 955 
 956 void InterpreterMacroAssembler::increment_mdp_data_at(Register mdp_in,
 957                                                       int constant,
 958                                                       bool decrement) {
 959   increment_mdp_data_at(mdp_in, noreg, constant, decrement);
 960 }
 961 
 962 void InterpreterMacroAssembler::increment_mdp_data_at(Register mdp_in,
 963                                                       Register reg,
 964                                                       int constant,
 965                                                       bool decrement) {
 966   assert(ProfileInterpreter, &quot;must be profiling interpreter&quot;);
 967   // %%% this does 64bit counters at best it is wasting space
 968   // at worst it is a rare bug when counters overflow
 969 
 970   assert_different_registers(rscratch2, rscratch1, mdp_in, reg);
 971 
 972   Address addr1(mdp_in, constant);
 973   Address addr2(rscratch2, reg, Address::lsl(0));
 974   Address &amp;addr = addr1;
 975   if (reg != noreg) {
 976     lea(rscratch2, addr1);
 977     addr = addr2;
 978   }
 979 
 980   if (decrement) {
 981     // Decrement the register.  Set condition codes.
 982     // Intel does this
 983     // addptr(data, (int32_t) -DataLayout::counter_increment);
 984     // If the decrement causes the counter to overflow, stay negative
 985     // Label L;
 986     // jcc(Assembler::negative, L);
 987     // addptr(data, (int32_t) DataLayout::counter_increment);
 988     // so we do this
 989     ldr(rscratch1, addr);
 990     subs(rscratch1, rscratch1, (unsigned)DataLayout::counter_increment);
 991     Label L;
 992     br(Assembler::LO, L);       // skip store if counter underflow
 993     str(rscratch1, addr);
 994     bind(L);
 995   } else {
 996     assert(DataLayout::counter_increment == 1,
 997            &quot;flow-free idiom only works with 1&quot;);
 998     // Intel does this
 999     // Increment the register.  Set carry flag.
1000     // addptr(data, DataLayout::counter_increment);
1001     // If the increment causes the counter to overflow, pull back by 1.
1002     // sbbptr(data, (int32_t)0);
1003     // so we do this
1004     ldr(rscratch1, addr);
1005     adds(rscratch1, rscratch1, DataLayout::counter_increment);
1006     Label L;
1007     br(Assembler::CS, L);       // skip store if counter overflow
1008     str(rscratch1, addr);
1009     bind(L);
1010   }
1011 }
1012 
1013 void InterpreterMacroAssembler::set_mdp_flag_at(Register mdp_in,
1014                                                 int flag_byte_constant) {
1015   assert(ProfileInterpreter, &quot;must be profiling interpreter&quot;);
1016   int flags_offset = in_bytes(DataLayout::flags_offset());
1017   // Set the flag
1018   ldrb(rscratch1, Address(mdp_in, flags_offset));
1019   orr(rscratch1, rscratch1, flag_byte_constant);
1020   strb(rscratch1, Address(mdp_in, flags_offset));
1021 }
1022 
1023 
1024 void InterpreterMacroAssembler::test_mdp_data_at(Register mdp_in,
1025                                                  int offset,
1026                                                  Register value,
1027                                                  Register test_value_out,
1028                                                  Label&amp; not_equal_continue) {
1029   assert(ProfileInterpreter, &quot;must be profiling interpreter&quot;);
1030   if (test_value_out == noreg) {
1031     ldr(rscratch1, Address(mdp_in, offset));
1032     cmp(value, rscratch1);
1033   } else {
1034     // Put the test value into a register, so caller can use it:
1035     ldr(test_value_out, Address(mdp_in, offset));
1036     cmp(value, test_value_out);
1037   }
1038   br(Assembler::NE, not_equal_continue);
1039 }
1040 
1041 
1042 void InterpreterMacroAssembler::update_mdp_by_offset(Register mdp_in,
1043                                                      int offset_of_disp) {
1044   assert(ProfileInterpreter, &quot;must be profiling interpreter&quot;);
1045   ldr(rscratch1, Address(mdp_in, offset_of_disp));
1046   add(mdp_in, mdp_in, rscratch1, LSL);
1047   str(mdp_in, Address(rfp, frame::interpreter_frame_mdp_offset * wordSize));
1048 }
1049 
1050 
1051 void InterpreterMacroAssembler::update_mdp_by_offset(Register mdp_in,
1052                                                      Register reg,
1053                                                      int offset_of_disp) {
1054   assert(ProfileInterpreter, &quot;must be profiling interpreter&quot;);
1055   lea(rscratch1, Address(mdp_in, offset_of_disp));
1056   ldr(rscratch1, Address(rscratch1, reg, Address::lsl(0)));
1057   add(mdp_in, mdp_in, rscratch1, LSL);
1058   str(mdp_in, Address(rfp, frame::interpreter_frame_mdp_offset * wordSize));
1059 }
1060 
1061 
1062 void InterpreterMacroAssembler::update_mdp_by_constant(Register mdp_in,
1063                                                        int constant) {
1064   assert(ProfileInterpreter, &quot;must be profiling interpreter&quot;);
1065   add(mdp_in, mdp_in, (unsigned)constant);
1066   str(mdp_in, Address(rfp, frame::interpreter_frame_mdp_offset * wordSize));
1067 }
1068 
1069 
1070 void InterpreterMacroAssembler::update_mdp_for_ret(Register return_bci) {
1071   assert(ProfileInterpreter, &quot;must be profiling interpreter&quot;);
1072   // save/restore across call_VM
1073   stp(zr, return_bci, Address(pre(sp, -2 * wordSize)));
1074   call_VM(noreg,
1075           CAST_FROM_FN_PTR(address, InterpreterRuntime::update_mdp_for_ret),
1076           return_bci);
1077   ldp(zr, return_bci, Address(post(sp, 2 * wordSize)));
1078 }
1079 
1080 
1081 void InterpreterMacroAssembler::profile_taken_branch(Register mdp,
1082                                                      Register bumped_count) {
1083   if (ProfileInterpreter) {
1084     Label profile_continue;
1085 
1086     // If no method data exists, go to profile_continue.
1087     // Otherwise, assign to mdp
1088     test_method_data_pointer(mdp, profile_continue);
1089 
1090     // We are taking a branch.  Increment the taken count.
1091     // We inline increment_mdp_data_at to return bumped_count in a register
1092     //increment_mdp_data_at(mdp, in_bytes(JumpData::taken_offset()));
1093     Address data(mdp, in_bytes(JumpData::taken_offset()));
1094     ldr(bumped_count, data);
1095     assert(DataLayout::counter_increment == 1,
1096             &quot;flow-free idiom only works with 1&quot;);
1097     // Intel does this to catch overflow
1098     // addptr(bumped_count, DataLayout::counter_increment);
1099     // sbbptr(bumped_count, 0);
1100     // so we do this
1101     adds(bumped_count, bumped_count, DataLayout::counter_increment);
1102     Label L;
1103     br(Assembler::CS, L);       // skip store if counter overflow
1104     str(bumped_count, data);
1105     bind(L);
1106     // The method data pointer needs to be updated to reflect the new target.
1107     update_mdp_by_offset(mdp, in_bytes(JumpData::displacement_offset()));
1108     bind(profile_continue);
1109   }
1110 }
1111 
1112 
1113 void InterpreterMacroAssembler::profile_not_taken_branch(Register mdp) {
1114   if (ProfileInterpreter) {
1115     Label profile_continue;
1116 
1117     // If no method data exists, go to profile_continue.
1118     test_method_data_pointer(mdp, profile_continue);
1119 
1120     // We are taking a branch.  Increment the not taken count.
1121     increment_mdp_data_at(mdp, in_bytes(BranchData::not_taken_offset()));
1122 
1123     // The method data pointer needs to be updated to correspond to
1124     // the next bytecode
1125     update_mdp_by_constant(mdp, in_bytes(BranchData::branch_data_size()));
1126     bind(profile_continue);
1127   }
1128 }
1129 
1130 
1131 void InterpreterMacroAssembler::profile_call(Register mdp) {
1132   if (ProfileInterpreter) {
1133     Label profile_continue;
1134 
1135     // If no method data exists, go to profile_continue.
1136     test_method_data_pointer(mdp, profile_continue);
1137 
1138     // We are making a call.  Increment the count.
1139     increment_mdp_data_at(mdp, in_bytes(CounterData::count_offset()));
1140 
1141     // The method data pointer needs to be updated to reflect the new target.
1142     update_mdp_by_constant(mdp, in_bytes(CounterData::counter_data_size()));
1143     bind(profile_continue);
1144   }
1145 }
1146 
1147 void InterpreterMacroAssembler::profile_final_call(Register mdp) {
1148   if (ProfileInterpreter) {
1149     Label profile_continue;
1150 
1151     // If no method data exists, go to profile_continue.
1152     test_method_data_pointer(mdp, profile_continue);
1153 
1154     // We are making a call.  Increment the count.
1155     increment_mdp_data_at(mdp, in_bytes(CounterData::count_offset()));
1156 
1157     // The method data pointer needs to be updated to reflect the new target.
1158     update_mdp_by_constant(mdp,
1159                            in_bytes(VirtualCallData::
1160                                     virtual_call_data_size()));
1161     bind(profile_continue);
1162   }
1163 }
1164 
1165 
1166 void InterpreterMacroAssembler::profile_virtual_call(Register receiver,
1167                                                      Register mdp,
1168                                                      Register reg2,
1169                                                      bool receiver_can_be_null) {
1170   if (ProfileInterpreter) {
1171     Label profile_continue;
1172 
1173     // If no method data exists, go to profile_continue.
1174     test_method_data_pointer(mdp, profile_continue);
1175 
1176     Label skip_receiver_profile;
1177     if (receiver_can_be_null) {
1178       Label not_null;
1179       // We are making a call.  Increment the count for null receiver.
1180       increment_mdp_data_at(mdp, in_bytes(CounterData::count_offset()));
1181       b(skip_receiver_profile);
1182       bind(not_null);
1183     }
1184 
1185     // Record the receiver type.
1186     record_klass_in_profile(receiver, mdp, reg2, true);
1187     bind(skip_receiver_profile);
1188 
1189     // The method data pointer needs to be updated to reflect the new target.
1190     update_mdp_by_constant(mdp, in_bytes(VirtualCallData::virtual_call_data_size()));
1191     bind(profile_continue);
1192   }
1193 }
1194 
1195 // This routine creates a state machine for updating the multi-row
1196 // type profile at a virtual call site (or other type-sensitive bytecode).
1197 // The machine visits each row (of receiver/count) until the receiver type
1198 // is found, or until it runs out of rows.  At the same time, it remembers
1199 // the location of the first empty row.  (An empty row records null for its
1200 // receiver, and can be allocated for a newly-observed receiver type.)
1201 // Because there are two degrees of freedom in the state, a simple linear
1202 // search will not work; it must be a decision tree.  Hence this helper
1203 // function is recursive, to generate the required tree structured code.
1204 // It&#39;s the interpreter, so we are trading off code space for speed.
1205 // See below for example code.
1206 void InterpreterMacroAssembler::record_klass_in_profile_helper(
1207                                         Register receiver, Register mdp,
1208                                         Register reg2, int start_row,
1209                                         Label&amp; done, bool is_virtual_call) {
1210   if (TypeProfileWidth == 0) {
1211     if (is_virtual_call) {
1212       increment_mdp_data_at(mdp, in_bytes(CounterData::count_offset()));
1213     }
1214 #if INCLUDE_JVMCI
1215     else if (EnableJVMCI) {
1216       increment_mdp_data_at(mdp, in_bytes(ReceiverTypeData::nonprofiled_receiver_count_offset()));
1217     }
1218 #endif // INCLUDE_JVMCI
1219   } else {
1220     int non_profiled_offset = -1;
1221     if (is_virtual_call) {
1222       non_profiled_offset = in_bytes(CounterData::count_offset());
1223     }
1224 #if INCLUDE_JVMCI
1225     else if (EnableJVMCI) {
1226       non_profiled_offset = in_bytes(ReceiverTypeData::nonprofiled_receiver_count_offset());
1227     }
1228 #endif // INCLUDE_JVMCI
1229 
1230     record_item_in_profile_helper(receiver, mdp, reg2, 0, done, TypeProfileWidth,
1231         &amp;VirtualCallData::receiver_offset, &amp;VirtualCallData::receiver_count_offset, non_profiled_offset);
1232   }
1233 }
1234 
1235 void InterpreterMacroAssembler::record_item_in_profile_helper(Register item, Register mdp,
1236                                         Register reg2, int start_row, Label&amp; done, int total_rows,
1237                                         OffsetFunction item_offset_fn, OffsetFunction item_count_offset_fn,
1238                                         int non_profiled_offset) {
1239   int last_row = total_rows - 1;
1240   assert(start_row &lt;= last_row, &quot;must be work left to do&quot;);
1241   // Test this row for both the item and for null.
1242   // Take any of three different outcomes:
1243   //   1. found item =&gt; increment count and goto done
1244   //   2. found null =&gt; keep looking for case 1, maybe allocate this cell
1245   //   3. found something else =&gt; keep looking for cases 1 and 2
1246   // Case 3 is handled by a recursive call.
1247   for (int row = start_row; row &lt;= last_row; row++) {
1248     Label next_test;
1249     bool test_for_null_also = (row == start_row);
1250 
1251     // See if the item is item[n].
1252     int item_offset = in_bytes(item_offset_fn(row));
1253     test_mdp_data_at(mdp, item_offset, item,
1254                      (test_for_null_also ? reg2 : noreg),
1255                      next_test);
1256     // (Reg2 now contains the item from the CallData.)
1257 
1258     // The item is item[n].  Increment count[n].
1259     int count_offset = in_bytes(item_count_offset_fn(row));
1260     increment_mdp_data_at(mdp, count_offset);
1261     b(done);
1262     bind(next_test);
1263 
1264     if (test_for_null_also) {
1265       Label found_null;
1266       // Failed the equality check on item[n]...  Test for null.
1267       if (start_row == last_row) {
1268         // The only thing left to do is handle the null case.
1269         if (non_profiled_offset &gt;= 0) {
1270           cbz(reg2, found_null);
1271           // Item did not match any saved item and there is no empty row for it.
1272           // Increment total counter to indicate polymorphic case.
1273           increment_mdp_data_at(mdp, non_profiled_offset);
1274           b(done);
1275           bind(found_null);
1276         } else {
1277           cbnz(reg2, done);
1278         }
1279         break;
1280       }
1281       // Since null is rare, make it be the branch-taken case.
1282       cbz(reg2, found_null);
1283 
1284       // Put all the &quot;Case 3&quot; tests here.
1285       record_item_in_profile_helper(item, mdp, reg2, start_row + 1, done, total_rows,
1286         item_offset_fn, item_count_offset_fn, non_profiled_offset);
1287 
1288       // Found a null.  Keep searching for a matching item,
1289       // but remember that this is an empty (unused) slot.
1290       bind(found_null);
1291     }
1292   }
1293 
1294   // In the fall-through case, we found no matching item, but we
1295   // observed the item[start_row] is NULL.
1296 
1297   // Fill in the item field and increment the count.
1298   int item_offset = in_bytes(item_offset_fn(start_row));
1299   set_mdp_data_at(mdp, item_offset, item);
1300   int count_offset = in_bytes(item_count_offset_fn(start_row));
1301   mov(reg2, DataLayout::counter_increment);
1302   set_mdp_data_at(mdp, count_offset, reg2);
1303   if (start_row &gt; 0) {
1304     b(done);
1305   }
1306 }
1307 
1308 // Example state machine code for three profile rows:
1309 //   // main copy of decision tree, rooted at row[1]
1310 //   if (row[0].rec == rec) { row[0].incr(); goto done; }
1311 //   if (row[0].rec != NULL) {
1312 //     // inner copy of decision tree, rooted at row[1]
1313 //     if (row[1].rec == rec) { row[1].incr(); goto done; }
1314 //     if (row[1].rec != NULL) {
1315 //       // degenerate decision tree, rooted at row[2]
1316 //       if (row[2].rec == rec) { row[2].incr(); goto done; }
1317 //       if (row[2].rec != NULL) { count.incr(); goto done; } // overflow
1318 //       row[2].init(rec); goto done;
1319 //     } else {
1320 //       // remember row[1] is empty
1321 //       if (row[2].rec == rec) { row[2].incr(); goto done; }
1322 //       row[1].init(rec); goto done;
1323 //     }
1324 //   } else {
1325 //     // remember row[0] is empty
1326 //     if (row[1].rec == rec) { row[1].incr(); goto done; }
1327 //     if (row[2].rec == rec) { row[2].incr(); goto done; }
1328 //     row[0].init(rec); goto done;
1329 //   }
1330 //   done:
1331 
1332 void InterpreterMacroAssembler::record_klass_in_profile(Register receiver,
1333                                                         Register mdp, Register reg2,
1334                                                         bool is_virtual_call) {
1335   assert(ProfileInterpreter, &quot;must be profiling&quot;);
1336   Label done;
1337 
1338   record_klass_in_profile_helper(receiver, mdp, reg2, 0, done, is_virtual_call);
1339 
1340   bind (done);
1341 }
1342 
1343 void InterpreterMacroAssembler::profile_ret(Register return_bci,
1344                                             Register mdp) {
1345   if (ProfileInterpreter) {
1346     Label profile_continue;
1347     uint row;
1348 
1349     // If no method data exists, go to profile_continue.
1350     test_method_data_pointer(mdp, profile_continue);
1351 
1352     // Update the total ret count.
1353     increment_mdp_data_at(mdp, in_bytes(CounterData::count_offset()));
1354 
1355     for (row = 0; row &lt; RetData::row_limit(); row++) {
1356       Label next_test;
1357 
1358       // See if return_bci is equal to bci[n]:
1359       test_mdp_data_at(mdp,
1360                        in_bytes(RetData::bci_offset(row)),
1361                        return_bci, noreg,
1362                        next_test);
1363 
1364       // return_bci is equal to bci[n].  Increment the count.
1365       increment_mdp_data_at(mdp, in_bytes(RetData::bci_count_offset(row)));
1366 
1367       // The method data pointer needs to be updated to reflect the new target.
1368       update_mdp_by_offset(mdp,
1369                            in_bytes(RetData::bci_displacement_offset(row)));
1370       b(profile_continue);
1371       bind(next_test);
1372     }
1373 
1374     update_mdp_for_ret(return_bci);
1375 
1376     bind(profile_continue);
1377   }
1378 }
1379 
1380 void InterpreterMacroAssembler::profile_null_seen(Register mdp) {
1381   if (ProfileInterpreter) {
1382     Label profile_continue;
1383 
1384     // If no method data exists, go to profile_continue.
1385     test_method_data_pointer(mdp, profile_continue);
1386 
1387     set_mdp_flag_at(mdp, BitData::null_seen_byte_constant());
1388 
1389     // The method data pointer needs to be updated.
1390     int mdp_delta = in_bytes(BitData::bit_data_size());
1391     if (TypeProfileCasts) {
1392       mdp_delta = in_bytes(VirtualCallData::virtual_call_data_size());
1393     }
1394     update_mdp_by_constant(mdp, mdp_delta);
1395 
1396     bind(profile_continue);
1397   }
1398 }
1399 
1400 void InterpreterMacroAssembler::profile_typecheck_failed(Register mdp) {
1401   if (ProfileInterpreter &amp;&amp; TypeProfileCasts) {
1402     Label profile_continue;
1403 
1404     // If no method data exists, go to profile_continue.
1405     test_method_data_pointer(mdp, profile_continue);
1406 
1407     int count_offset = in_bytes(CounterData::count_offset());
1408     // Back up the address, since we have already bumped the mdp.
1409     count_offset -= in_bytes(VirtualCallData::virtual_call_data_size());
1410 
1411     // *Decrement* the counter.  We expect to see zero or small negatives.
1412     increment_mdp_data_at(mdp, count_offset, true);
1413 
1414     bind (profile_continue);
1415   }
1416 }
1417 
1418 void InterpreterMacroAssembler::profile_typecheck(Register mdp, Register klass, Register reg2) {
1419   if (ProfileInterpreter) {
1420     Label profile_continue;
1421 
1422     // If no method data exists, go to profile_continue.
1423     test_method_data_pointer(mdp, profile_continue);
1424 
1425     // The method data pointer needs to be updated.
1426     int mdp_delta = in_bytes(BitData::bit_data_size());
1427     if (TypeProfileCasts) {
1428       mdp_delta = in_bytes(VirtualCallData::virtual_call_data_size());
1429 
1430       // Record the object type.
1431       record_klass_in_profile(klass, mdp, reg2, false);
1432     }
1433     update_mdp_by_constant(mdp, mdp_delta);
1434 
1435     bind(profile_continue);
1436   }
1437 }
1438 
1439 void InterpreterMacroAssembler::profile_switch_default(Register mdp) {
1440   if (ProfileInterpreter) {
1441     Label profile_continue;
1442 
1443     // If no method data exists, go to profile_continue.
1444     test_method_data_pointer(mdp, profile_continue);
1445 
1446     // Update the default case count
1447     increment_mdp_data_at(mdp,
1448                           in_bytes(MultiBranchData::default_count_offset()));
1449 
1450     // The method data pointer needs to be updated.
1451     update_mdp_by_offset(mdp,
1452                          in_bytes(MultiBranchData::
1453                                   default_displacement_offset()));
1454 
1455     bind(profile_continue);
1456   }
1457 }
1458 
1459 void InterpreterMacroAssembler::profile_switch_case(Register index,
1460                                                     Register mdp,
1461                                                     Register reg2) {
1462   if (ProfileInterpreter) {
1463     Label profile_continue;
1464 
1465     // If no method data exists, go to profile_continue.
1466     test_method_data_pointer(mdp, profile_continue);
1467 
1468     // Build the base (index * per_case_size_in_bytes()) +
1469     // case_array_offset_in_bytes()
1470     movw(reg2, in_bytes(MultiBranchData::per_case_size()));
1471     movw(rscratch1, in_bytes(MultiBranchData::case_array_offset()));
1472     Assembler::maddw(index, index, reg2, rscratch1);
1473 
1474     // Update the case count
1475     increment_mdp_data_at(mdp,
1476                           index,
1477                           in_bytes(MultiBranchData::relative_count_offset()));
1478 
1479     // The method data pointer needs to be updated.
1480     update_mdp_by_offset(mdp,
1481                          index,
1482                          in_bytes(MultiBranchData::
1483                                   relative_displacement_offset()));
1484 
1485     bind(profile_continue);
1486   }
1487 }
1488 
1489 void InterpreterMacroAssembler::verify_oop(Register reg, TosState state) {
1490   if (state == atos) {
1491     MacroAssembler::verify_oop(reg);
1492   }
1493 }
1494 
1495 void InterpreterMacroAssembler::verify_FPU(int stack_depth, TosState state) { ; }
1496 
1497 
1498 void InterpreterMacroAssembler::notify_method_entry() {
1499   // Whenever JVMTI is interp_only_mode, method entry/exit events are sent to
1500   // track stack depth.  If it is possible to enter interp_only_mode we add
1501   // the code to check if the event should be sent.
1502   if (JvmtiExport::can_post_interpreter_events()) {
1503     Label L;
1504     ldrw(r3, Address(rthread, JavaThread::interp_only_mode_offset()));
1505     cbzw(r3, L);
1506     call_VM(noreg, CAST_FROM_FN_PTR(address,
1507                                     InterpreterRuntime::post_method_entry));
1508     bind(L);
1509   }
1510 
1511   {
1512     SkipIfEqual skip(this, &amp;DTraceMethodProbes, false);
1513     get_method(c_rarg1);
1514     call_VM_leaf(CAST_FROM_FN_PTR(address, SharedRuntime::dtrace_method_entry),
1515                  rthread, c_rarg1);
1516   }
1517 
1518   // RedefineClasses() tracing support for obsolete method entry
1519   if (log_is_enabled(Trace, redefine, class, obsolete)) {
1520     get_method(c_rarg1);
1521     call_VM_leaf(
1522       CAST_FROM_FN_PTR(address, SharedRuntime::rc_trace_method_entry),
1523       rthread, c_rarg1);
1524   }
1525 
1526  }
1527 
1528 
1529 void InterpreterMacroAssembler::notify_method_exit(
1530     TosState state, NotifyMethodExitMode mode) {
1531   // Whenever JVMTI is interp_only_mode, method entry/exit events are sent to
1532   // track stack depth.  If it is possible to enter interp_only_mode we add
1533   // the code to check if the event should be sent.
1534   if (mode == NotifyJVMTI &amp;&amp; JvmtiExport::can_post_interpreter_events()) {
1535     Label L;
1536     // Note: frame::interpreter_frame_result has a dependency on how the
1537     // method result is saved across the call to post_method_exit. If this
1538     // is changed then the interpreter_frame_result implementation will
1539     // need to be updated too.
1540 
1541     // template interpreter will leave the result on the top of the stack.
1542     push(state);
1543     ldrw(r3, Address(rthread, JavaThread::interp_only_mode_offset()));
1544     cbz(r3, L);
1545     call_VM(noreg,
1546             CAST_FROM_FN_PTR(address, InterpreterRuntime::post_method_exit));
1547     bind(L);
1548     pop(state);
1549   }
1550 
1551   {
1552     SkipIfEqual skip(this, &amp;DTraceMethodProbes, false);
1553     push(state);
1554     get_method(c_rarg1);
1555     call_VM_leaf(CAST_FROM_FN_PTR(address, SharedRuntime::dtrace_method_exit),
1556                  rthread, c_rarg1);
1557     pop(state);
1558   }
1559 }
1560 
1561 
1562 // Jump if ((*counter_addr += increment) &amp; mask) satisfies the condition.
1563 void InterpreterMacroAssembler::increment_mask_and_jump(Address counter_addr,
1564                                                         int increment, Address mask,
1565                                                         Register scratch, Register scratch2,
1566                                                         bool preloaded, Condition cond,
1567                                                         Label* where) {
1568   if (!preloaded) {
1569     ldrw(scratch, counter_addr);
1570   }
1571   add(scratch, scratch, increment);
1572   strw(scratch, counter_addr);
1573   ldrw(scratch2, mask);
1574   ands(scratch, scratch, scratch2);
1575   br(cond, *where);
1576 }
1577 
1578 void InterpreterMacroAssembler::call_VM_leaf_base(address entry_point,
1579                                                   int number_of_arguments) {
1580   // interpreter specific
1581   //
1582   // Note: No need to save/restore rbcp &amp; rlocals pointer since these
1583   //       are callee saved registers and no blocking/ GC can happen
1584   //       in leaf calls.
1585 #ifdef ASSERT
1586   {
1587     Label L;
1588     ldr(rscratch1, Address(rfp, frame::interpreter_frame_last_sp_offset * wordSize));
1589     cbz(rscratch1, L);
1590     stop(&quot;InterpreterMacroAssembler::call_VM_leaf_base:&quot;
1591          &quot; last_sp != NULL&quot;);
1592     bind(L);
1593   }
1594 #endif /* ASSERT */
1595   // super call
1596   MacroAssembler::call_VM_leaf_base(entry_point, number_of_arguments);
1597 }
1598 
1599 void InterpreterMacroAssembler::call_VM_base(Register oop_result,
1600                                              Register java_thread,
1601                                              Register last_java_sp,
1602                                              address  entry_point,
1603                                              int      number_of_arguments,
1604                                              bool     check_exceptions) {
1605   // interpreter specific
1606   //
1607   // Note: Could avoid restoring locals ptr (callee saved) - however doesn&#39;t
1608   //       really make a difference for these runtime calls, since they are
1609   //       slow anyway. Btw., bcp must be saved/restored since it may change
1610   //       due to GC.
1611   // assert(java_thread == noreg , &quot;not expecting a precomputed java thread&quot;);
1612   save_bcp();
1613 #ifdef ASSERT
1614   {
1615     Label L;
1616     ldr(rscratch1, Address(rfp, frame::interpreter_frame_last_sp_offset * wordSize));
1617     cbz(rscratch1, L);
1618     stop(&quot;InterpreterMacroAssembler::call_VM_leaf_base:&quot;
1619          &quot; last_sp != NULL&quot;);
1620     bind(L);
1621   }
1622 #endif /* ASSERT */
1623   // super call
1624   MacroAssembler::call_VM_base(oop_result, noreg, last_java_sp,
1625                                entry_point, number_of_arguments,
1626                      check_exceptions);
1627 // interpreter specific
1628   restore_bcp();
1629   restore_locals();
1630 }
1631 
1632 void InterpreterMacroAssembler::profile_obj_type(Register obj, const Address&amp; mdo_addr) {
1633   assert_different_registers(obj, rscratch1);
1634   Label update, next, none;
1635 
1636   verify_oop(obj);
1637 
1638   cbnz(obj, update);
1639   orptr(mdo_addr, TypeEntries::null_seen);
1640   b(next);
1641 
1642   bind(update);
1643   load_klass(obj, obj);
1644 
1645   ldr(rscratch1, mdo_addr);
1646   eor(obj, obj, rscratch1);
1647   tst(obj, TypeEntries::type_klass_mask);
1648   br(Assembler::EQ, next); // klass seen before, nothing to
1649                            // do. The unknown bit may have been
1650                            // set already but no need to check.
1651 
1652   tbnz(obj, exact_log2(TypeEntries::type_unknown), next);
1653   // already unknown. Nothing to do anymore.
1654 
1655   ldr(rscratch1, mdo_addr);
1656   cbz(rscratch1, none);
1657   cmp(rscratch1, (u1)TypeEntries::null_seen);
1658   br(Assembler::EQ, none);
1659   // There is a chance that the checks above (re-reading profiling
1660   // data from memory) fail if another thread has just set the
1661   // profiling to this obj&#39;s klass
1662   ldr(rscratch1, mdo_addr);
1663   eor(obj, obj, rscratch1);
1664   tst(obj, TypeEntries::type_klass_mask);
1665   br(Assembler::EQ, next);
1666 
1667   // different than before. Cannot keep accurate profile.
1668   orptr(mdo_addr, TypeEntries::type_unknown);
1669   b(next);
1670 
1671   bind(none);
1672   // first time here. Set profile type.
1673   str(obj, mdo_addr);
1674 
1675   bind(next);
1676 }
1677 
1678 void InterpreterMacroAssembler::profile_arguments_type(Register mdp, Register callee, Register tmp, bool is_virtual) {
1679   if (!ProfileInterpreter) {
1680     return;
1681   }
1682 
1683   if (MethodData::profile_arguments() || MethodData::profile_return()) {
1684     Label profile_continue;
1685 
1686     test_method_data_pointer(mdp, profile_continue);
1687 
1688     int off_to_start = is_virtual ? in_bytes(VirtualCallData::virtual_call_data_size()) : in_bytes(CounterData::counter_data_size());
1689 
1690     ldrb(rscratch1, Address(mdp, in_bytes(DataLayout::tag_offset()) - off_to_start));
1691     cmp(rscratch1, u1(is_virtual ? DataLayout::virtual_call_type_data_tag : DataLayout::call_type_data_tag));
1692     br(Assembler::NE, profile_continue);
1693 
1694     if (MethodData::profile_arguments()) {
1695       Label done;
1696       int off_to_args = in_bytes(TypeEntriesAtCall::args_data_offset());
1697 
1698       for (int i = 0; i &lt; TypeProfileArgsLimit; i++) {
1699         if (i &gt; 0 || MethodData::profile_return()) {
1700           // If return value type is profiled we may have no argument to profile
1701           ldr(tmp, Address(mdp, in_bytes(TypeEntriesAtCall::cell_count_offset())));
1702           sub(tmp, tmp, i*TypeStackSlotEntries::per_arg_count());
1703           cmp(tmp, (u1)TypeStackSlotEntries::per_arg_count());
1704           add(rscratch1, mdp, off_to_args);
1705           br(Assembler::LT, done);
1706         }
1707         ldr(tmp, Address(callee, Method::const_offset()));
1708         load_unsigned_short(tmp, Address(tmp, ConstMethod::size_of_parameters_offset()));
1709         // stack offset o (zero based) from the start of the argument
1710         // list, for n arguments translates into offset n - o - 1 from
1711         // the end of the argument list
1712         ldr(rscratch1, Address(mdp, in_bytes(TypeEntriesAtCall::stack_slot_offset(i))));
1713         sub(tmp, tmp, rscratch1);
1714         sub(tmp, tmp, 1);
1715         Address arg_addr = argument_address(tmp);
1716         ldr(tmp, arg_addr);
1717 
1718         Address mdo_arg_addr(mdp, in_bytes(TypeEntriesAtCall::argument_type_offset(i)));
1719         profile_obj_type(tmp, mdo_arg_addr);
1720 
1721         int to_add = in_bytes(TypeStackSlotEntries::per_arg_size());
1722         off_to_args += to_add;
1723       }
1724 
1725       if (MethodData::profile_return()) {
1726         ldr(tmp, Address(mdp, in_bytes(TypeEntriesAtCall::cell_count_offset())));
1727         sub(tmp, tmp, TypeProfileArgsLimit*TypeStackSlotEntries::per_arg_count());
1728       }
1729 
1730       add(rscratch1, mdp, off_to_args);
1731       bind(done);
1732       mov(mdp, rscratch1);
1733 
1734       if (MethodData::profile_return()) {
1735         // We&#39;re right after the type profile for the last
1736         // argument. tmp is the number of cells left in the
1737         // CallTypeData/VirtualCallTypeData to reach its end. Non null
1738         // if there&#39;s a return to profile.
1739         assert(SingleTypeEntry::static_cell_count() &lt; TypeStackSlotEntries::per_arg_count(), &quot;can&#39;t move past ret type&quot;);
1740         add(mdp, mdp, tmp, LSL, exact_log2(DataLayout::cell_size));
1741       }
1742       str(mdp, Address(rfp, frame::interpreter_frame_mdp_offset * wordSize));
1743     } else {
1744       assert(MethodData::profile_return(), &quot;either profile call args or call ret&quot;);
1745       update_mdp_by_constant(mdp, in_bytes(TypeEntriesAtCall::return_only_size()));
1746     }
1747 
1748     // mdp points right after the end of the
1749     // CallTypeData/VirtualCallTypeData, right after the cells for the
1750     // return value type if there&#39;s one
1751 
1752     bind(profile_continue);
1753   }
1754 }
1755 
1756 void InterpreterMacroAssembler::profile_return_type(Register mdp, Register ret, Register tmp) {
1757   assert_different_registers(mdp, ret, tmp, rbcp);
1758   if (ProfileInterpreter &amp;&amp; MethodData::profile_return()) {
1759     Label profile_continue, done;
1760 
1761     test_method_data_pointer(mdp, profile_continue);
1762 
1763     if (MethodData::profile_return_jsr292_only()) {
1764       assert(Method::intrinsic_id_size_in_bytes() == 2, &quot;assuming Method::_intrinsic_id is u2&quot;);
1765 
1766       // If we don&#39;t profile all invoke bytecodes we must make sure
1767       // it&#39;s a bytecode we indeed profile. We can&#39;t go back to the
1768       // begining of the ProfileData we intend to update to check its
1769       // type because we&#39;re right after it and we don&#39;t known its
1770       // length
1771       Label do_profile;
1772       ldrb(rscratch1, Address(rbcp, 0));
1773       cmp(rscratch1, (u1)Bytecodes::_invokedynamic);
1774       br(Assembler::EQ, do_profile);
1775       cmp(rscratch1, (u1)Bytecodes::_invokehandle);
1776       br(Assembler::EQ, do_profile);
1777       get_method(tmp);
1778       ldrh(rscratch1, Address(tmp, Method::intrinsic_id_offset_in_bytes()));
1779       subs(zr, rscratch1, vmIntrinsics::_compiledLambdaForm);
1780       br(Assembler::NE, profile_continue);
1781 
1782       bind(do_profile);
1783     }
1784 
1785     Address mdo_ret_addr(mdp, -in_bytes(SingleTypeEntry::size()));
1786     mov(tmp, ret);
1787     profile_obj_type(tmp, mdo_ret_addr);
1788 
1789     bind(profile_continue);
1790   }
1791 }
1792 
1793 void InterpreterMacroAssembler::profile_parameters_type(Register mdp, Register tmp1, Register tmp2) {
1794   assert_different_registers(rscratch1, rscratch2, mdp, tmp1, tmp2);
1795   if (ProfileInterpreter &amp;&amp; MethodData::profile_parameters()) {
1796     Label profile_continue, done;
1797 
1798     test_method_data_pointer(mdp, profile_continue);
1799 
1800     // Load the offset of the area within the MDO used for
1801     // parameters. If it&#39;s negative we&#39;re not profiling any parameters
1802     ldrw(tmp1, Address(mdp, in_bytes(MethodData::parameters_type_data_di_offset()) - in_bytes(MethodData::data_offset())));
1803     tbnz(tmp1, 31, profile_continue);  // i.e. sign bit set
1804 
1805     // Compute a pointer to the area for parameters from the offset
1806     // and move the pointer to the slot for the last
1807     // parameters. Collect profiling from last parameter down.
1808     // mdo start + parameters offset + array length - 1
1809     add(mdp, mdp, tmp1);
1810     ldr(tmp1, Address(mdp, ArrayData::array_len_offset()));
1811     sub(tmp1, tmp1, TypeStackSlotEntries::per_arg_count());
1812 
1813     Label loop;
1814     bind(loop);
1815 
1816     int off_base = in_bytes(ParametersTypeData::stack_slot_offset(0));
1817     int type_base = in_bytes(ParametersTypeData::type_offset(0));
1818     int per_arg_scale = exact_log2(DataLayout::cell_size);
1819     add(rscratch1, mdp, off_base);
1820     add(rscratch2, mdp, type_base);
1821 
1822     Address arg_off(rscratch1, tmp1, Address::lsl(per_arg_scale));
1823     Address arg_type(rscratch2, tmp1, Address::lsl(per_arg_scale));
1824 
1825     // load offset on the stack from the slot for this parameter
1826     ldr(tmp2, arg_off);
1827     neg(tmp2, tmp2);
1828     // read the parameter from the local area
1829     ldr(tmp2, Address(rlocals, tmp2, Address::lsl(Interpreter::logStackElementSize)));
1830 
1831     // profile the parameter
1832     profile_obj_type(tmp2, arg_type);
1833 
1834     // go to next parameter
1835     subs(tmp1, tmp1, TypeStackSlotEntries::per_arg_count());
1836     br(Assembler::GE, loop);
1837 
1838     bind(profile_continue);
1839   }
1840 }
    </pre>
  </body>
</html>