<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames src/hotspot/share/classfile/verifier.cpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
    <script type="text/javascript" src="../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>   1 /*
   2  * Copyright (c) 1998, 2020, Oracle and/or its affiliates. All rights reserved.
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.
   8  *
   9  * This code is distributed in the hope that it will be useful, but WITHOUT
  10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  *
  23  */
  24 
  25 #include &quot;precompiled.hpp&quot;
  26 #include &quot;jvm.h&quot;
  27 #include &quot;classfile/classFileStream.hpp&quot;
  28 #include &quot;classfile/classLoader.hpp&quot;
  29 #include &quot;classfile/javaClasses.hpp&quot;
  30 #include &quot;classfile/stackMapTable.hpp&quot;
  31 #include &quot;classfile/stackMapFrame.hpp&quot;
  32 #include &quot;classfile/stackMapTableFormat.hpp&quot;
  33 #include &quot;classfile/symbolTable.hpp&quot;
  34 #include &quot;classfile/systemDictionary.hpp&quot;
  35 #include &quot;classfile/verifier.hpp&quot;
  36 #include &quot;classfile/vmSymbols.hpp&quot;
  37 #include &quot;interpreter/bytecodes.hpp&quot;
  38 #include &quot;interpreter/bytecodeStream.hpp&quot;
  39 #include &quot;logging/log.hpp&quot;
  40 #include &quot;logging/logStream.hpp&quot;
  41 #include &quot;memory/oopFactory.hpp&quot;
  42 #include &quot;memory/resourceArea.hpp&quot;
  43 #include &quot;memory/universe.hpp&quot;
  44 #include &quot;oops/constantPool.inline.hpp&quot;
  45 #include &quot;oops/instanceKlass.hpp&quot;
  46 #include &quot;oops/oop.inline.hpp&quot;
  47 #include &quot;oops/typeArrayOop.hpp&quot;
  48 #include &quot;runtime/fieldDescriptor.hpp&quot;
  49 #include &quot;runtime/handles.inline.hpp&quot;
  50 #include &quot;runtime/interfaceSupport.inline.hpp&quot;
  51 #include &quot;runtime/javaCalls.hpp&quot;
  52 #include &quot;runtime/jniHandles.inline.hpp&quot;
  53 #include &quot;runtime/os.hpp&quot;
  54 #include &quot;runtime/safepointVerifiers.hpp&quot;
  55 #include &quot;runtime/thread.hpp&quot;
  56 #include &quot;services/threadService.hpp&quot;
  57 #include &quot;utilities/align.hpp&quot;
  58 #include &quot;utilities/bytes.hpp&quot;
  59 
  60 #define NOFAILOVER_MAJOR_VERSION                       51
  61 #define NONZERO_PADDING_BYTES_IN_SWITCH_MAJOR_VERSION  51
  62 #define STATIC_METHOD_IN_INTERFACE_MAJOR_VERSION       52
  63 #define INLINE_TYPE_MAJOR_VERSION                       56
  64 #define MAX_ARRAY_DIMENSIONS 255
  65 
  66 // Access to external entry for VerifyClassForMajorVersion - old byte code verifier
  67 
  68 extern &quot;C&quot; {
  69   typedef jboolean (*verify_byte_codes_fn_t)(JNIEnv *, jclass, char *, jint, jint);
  70 }
  71 
  72 static verify_byte_codes_fn_t volatile _verify_byte_codes_fn = NULL;
  73 
  74 static verify_byte_codes_fn_t verify_byte_codes_fn() {
  75 
  76   if (_verify_byte_codes_fn != NULL)
  77     return _verify_byte_codes_fn;
  78 
  79   MutexLocker locker(Verify_lock);
  80 
  81   if (_verify_byte_codes_fn != NULL)
  82     return _verify_byte_codes_fn;
  83 
  84   // Load verify dll
  85   char buffer[JVM_MAXPATHLEN];
  86   char ebuf[1024];
  87   if (!os::dll_locate_lib(buffer, sizeof(buffer), Arguments::get_dll_dir(), &quot;verify&quot;))
  88     return NULL; // Caller will throw VerifyError
  89 
  90   void *lib_handle = os::dll_load(buffer, ebuf, sizeof(ebuf));
  91   if (lib_handle == NULL)
  92     return NULL; // Caller will throw VerifyError
  93 
  94   void *fn = os::dll_lookup(lib_handle, &quot;VerifyClassForMajorVersion&quot;);
  95   if (fn == NULL)
  96     return NULL; // Caller will throw VerifyError
  97 
  98   return _verify_byte_codes_fn = CAST_TO_FN_PTR(verify_byte_codes_fn_t, fn);
  99 }
 100 
 101 
 102 // Methods in Verifier
 103 
 104 bool Verifier::should_verify_for(oop class_loader, bool should_verify_class) {
 105   return (class_loader == NULL || !should_verify_class) ?
 106     BytecodeVerificationLocal : BytecodeVerificationRemote;
 107 }
 108 
 109 bool Verifier::relax_access_for(oop loader) {
 110   bool trusted = java_lang_ClassLoader::is_trusted_loader(loader);
 111   bool need_verify =
 112     // verifyAll
 113     (BytecodeVerificationLocal &amp;&amp; BytecodeVerificationRemote) ||
 114     // verifyRemote
 115     (!BytecodeVerificationLocal &amp;&amp; BytecodeVerificationRemote &amp;&amp; !trusted);
 116   return !need_verify;
 117 }
 118 
 119 void Verifier::trace_class_resolution(Klass* resolve_class, InstanceKlass* verify_class) {
 120   assert(verify_class != NULL, &quot;Unexpected null verify_class&quot;);
 121   ResourceMark rm;
 122   Symbol* s = verify_class-&gt;source_file_name();
 123   const char* source_file = (s != NULL ? s-&gt;as_C_string() : NULL);
 124   const char* verify = verify_class-&gt;external_name();
 125   const char* resolve = resolve_class-&gt;external_name();
 126   // print in a single call to reduce interleaving between threads
 127   if (source_file != NULL) {
 128     log_debug(class, resolve)(&quot;%s %s %s (verification)&quot;, verify, resolve, source_file);
 129   } else {
 130     log_debug(class, resolve)(&quot;%s %s (verification)&quot;, verify, resolve);
 131   }
 132 }
 133 
 134 // Prints the end-verification message to the appropriate output.
 135 void Verifier::log_end_verification(outputStream* st, const char* klassName, Symbol* exception_name, TRAPS) {
 136   if (HAS_PENDING_EXCEPTION) {
 137     st-&gt;print(&quot;Verification for %s has&quot;, klassName);
<a name="1" id="anc1"></a><span class="line-modified"> 138     oop message = java_lang_Throwable::message(PENDING_EXCEPTION);</span>
<span class="line-added"> 139     if (message != NULL) {</span>
<span class="line-added"> 140       char* ex_msg = java_lang_String::as_utf8_string(message);</span>
<span class="line-added"> 141       st-&gt;print_cr(&quot; exception pending &#39;%s %s&#39;&quot;,</span>
<span class="line-added"> 142                  PENDING_EXCEPTION-&gt;klass()-&gt;external_name(), ex_msg);</span>
<span class="line-added"> 143     } else {</span>
<span class="line-added"> 144       st-&gt;print_cr(&quot; exception pending %s &quot;,</span>
 145                  PENDING_EXCEPTION-&gt;klass()-&gt;external_name());
<a name="2" id="anc2"></a><span class="line-added"> 146     }</span>
 147   } else if (exception_name != NULL) {
 148     st-&gt;print_cr(&quot;Verification for %s failed&quot;, klassName);
 149   }
 150   st-&gt;print_cr(&quot;End class verification for: %s&quot;, klassName);
 151 }
 152 
 153 bool Verifier::verify(InstanceKlass* klass, bool should_verify_class, TRAPS) {
 154   HandleMark hm(THREAD);
 155   ResourceMark rm(THREAD);
 156 
 157   // Eagerly allocate the identity hash code for a klass. This is a fallout
 158   // from 6320749 and 8059924: hash code generator is not supposed to be called
 159   // during the safepoint, but it allows to sneak the hashcode in during
 160   // verification. Without this eager hashcode generation, we may end up
 161   // installing the hashcode during some other operation, which may be at
 162   // safepoint -- blowing up the checks. It was previously done as the side
 163   // effect (sic!) for external_name(), but instead of doing that, we opt to
 164   // explicitly push the hashcode in here. This is signify the following block
 165   // is IMPORTANT:
 166   if (klass-&gt;java_mirror() != NULL) {
 167     klass-&gt;java_mirror()-&gt;identity_hash();
 168   }
 169 
 170   if (!is_eligible_for_verification(klass, should_verify_class)) {
 171     return true;
 172   }
 173 
 174   // Timer includes any side effects of class verification (resolution,
 175   // etc), but not recursive calls to Verifier::verify().
 176   JavaThread* jt = (JavaThread*)THREAD;
 177   PerfClassTraceTime timer(ClassLoader::perf_class_verify_time(),
 178                            ClassLoader::perf_class_verify_selftime(),
 179                            ClassLoader::perf_classes_verified(),
 180                            jt-&gt;get_thread_stat()-&gt;perf_recursion_counts_addr(),
 181                            jt-&gt;get_thread_stat()-&gt;perf_timers_addr(),
 182                            PerfClassTraceTime::CLASS_VERIFY);
 183 
 184   // If the class should be verified, first see if we can use the split
 185   // verifier.  If not, or if verification fails and can failover, then
 186   // call the inference verifier.
 187   Symbol* exception_name = NULL;
 188   const size_t message_buffer_len = klass-&gt;name()-&gt;utf8_length() + 1024;
 189   char* message_buffer = NULL;
 190   char* exception_message = NULL;
 191 
 192   log_info(class, init)(&quot;Start class verification for: %s&quot;, klass-&gt;external_name());
 193   if (klass-&gt;major_version() &gt;= STACKMAP_ATTRIBUTE_MAJOR_VERSION) {
 194     ClassVerifier split_verifier(klass, THREAD);
 195     split_verifier.verify_class(THREAD);
 196     exception_name = split_verifier.result();
 197 
 198     // If DumpSharedSpaces is set then don&#39;t fall back to the old verifier on
 199     // verification failure. If a class fails verification with the split verifier,
 200     // it might fail the CDS runtime verifier constraint check. In that case, we
 201     // don&#39;t want to share the class. We only archive classes that pass the split
 202     // verifier.
 203     bool can_failover = !DumpSharedSpaces &amp;&amp;
 204       klass-&gt;major_version() &lt; NOFAILOVER_MAJOR_VERSION;
 205 
 206     if (can_failover &amp;&amp; !HAS_PENDING_EXCEPTION &amp;&amp;  // Split verifier doesn&#39;t set PENDING_EXCEPTION for failure
 207         (exception_name == vmSymbols::java_lang_VerifyError() ||
 208          exception_name == vmSymbols::java_lang_ClassFormatError())) {
 209       log_info(verification)(&quot;Fail over class verification to old verifier for: %s&quot;, klass-&gt;external_name());
 210       log_info(class, init)(&quot;Fail over class verification to old verifier for: %s&quot;, klass-&gt;external_name());
 211       message_buffer = NEW_RESOURCE_ARRAY(char, message_buffer_len);
 212       exception_message = message_buffer;
 213       exception_name = inference_verify(
 214         klass, message_buffer, message_buffer_len, THREAD);
 215     }
 216     if (exception_name != NULL) {
 217       exception_message = split_verifier.exception_message();
 218     }
 219   } else {
 220     message_buffer = NEW_RESOURCE_ARRAY(char, message_buffer_len);
 221     exception_message = message_buffer;
 222     exception_name = inference_verify(
 223         klass, message_buffer, message_buffer_len, THREAD);
 224   }
 225 
 226   LogTarget(Info, class, init) lt1;
 227   if (lt1.is_enabled()) {
 228     LogStream ls(lt1);
 229     log_end_verification(&amp;ls, klass-&gt;external_name(), exception_name, THREAD);
 230   }
 231   LogTarget(Info, verification) lt2;
 232   if (lt2.is_enabled()) {
 233     LogStream ls(lt2);
 234     log_end_verification(&amp;ls, klass-&gt;external_name(), exception_name, THREAD);
 235   }
 236 
 237   if (HAS_PENDING_EXCEPTION) {
 238     return false; // use the existing exception
 239   } else if (exception_name == NULL) {
 240     return true; // verification succeeded
 241   } else { // VerifyError or ClassFormatError to be created and thrown
 242     Klass* kls =
 243       SystemDictionary::resolve_or_fail(exception_name, true, CHECK_false);
 244     if (log_is_enabled(Debug, class, resolve)) {
 245       Verifier::trace_class_resolution(kls, klass);
 246     }
 247 
 248     while (kls != NULL) {
 249       if (kls == klass) {
 250         // If the class being verified is the exception we&#39;re creating
 251         // or one of it&#39;s superclasses, we&#39;re in trouble and are going
 252         // to infinitely recurse when we try to initialize the exception.
 253         // So bail out here by throwing the preallocated VM error.
 254         THROW_OOP_(Universe::virtual_machine_error_instance(), false);
 255       }
 256       kls = kls-&gt;super();
 257     }
 258     if (message_buffer != NULL) {
 259       message_buffer[message_buffer_len - 1] = &#39;\0&#39;; // just to be sure
 260     }
 261     assert(exception_message != NULL, &quot;&quot;);
 262     THROW_MSG_(exception_name, exception_message, false);
 263   }
 264 }
 265 
 266 bool Verifier::is_eligible_for_verification(InstanceKlass* klass, bool should_verify_class) {
 267   Symbol* name = klass-&gt;name();
 268   Klass* refl_magic_klass = SystemDictionary::reflect_MagicAccessorImpl_klass();
 269 
 270   bool is_reflect = refl_magic_klass != NULL &amp;&amp; klass-&gt;is_subtype_of(refl_magic_klass);
 271 
 272   return (should_verify_for(klass-&gt;class_loader(), should_verify_class) &amp;&amp;
 273     // return if the class is a bootstrapping class
 274     // or defineClass specified not to verify by default (flags override passed arg)
 275     // We need to skip the following four for bootstrapping
 276     name != vmSymbols::java_lang_Object() &amp;&amp;
 277     name != vmSymbols::java_lang_Class() &amp;&amp;
 278     name != vmSymbols::java_lang_String() &amp;&amp;
 279     name != vmSymbols::java_lang_Throwable() &amp;&amp;
 280 
 281     // Can not verify the bytecodes for shared classes because they have
 282     // already been rewritten to contain constant pool cache indices,
 283     // which the verifier can&#39;t understand.
 284     // Shared classes shouldn&#39;t have stackmaps either.
 285     !klass-&gt;is_shared() &amp;&amp;
 286 
 287     // As of the fix for 4486457 we disable verification for all of the
 288     // dynamically-generated bytecodes associated with the 1.4
 289     // reflection implementation, not just those associated with
 290     // jdk/internal/reflect/SerializationConstructorAccessor.
 291     // NOTE: this is called too early in the bootstrapping process to be
 292     // guarded by Universe::is_gte_jdk14x_version().
 293     // Also for lambda generated code, gte jdk8
 294     (!is_reflect));
 295 }
 296 
 297 Symbol* Verifier::inference_verify(
 298     InstanceKlass* klass, char* message, size_t message_len, TRAPS) {
 299   JavaThread* thread = (JavaThread*)THREAD;
 300   JNIEnv *env = thread-&gt;jni_environment();
 301 
 302   verify_byte_codes_fn_t verify_func = verify_byte_codes_fn();
 303 
 304   if (verify_func == NULL) {
 305     jio_snprintf(message, message_len, &quot;Could not link verifier&quot;);
 306     return vmSymbols::java_lang_VerifyError();
 307   }
 308 
 309   ResourceMark rm(THREAD);
 310   log_info(verification)(&quot;Verifying class %s with old format&quot;, klass-&gt;external_name());
 311 
 312   jclass cls = (jclass) JNIHandles::make_local(env, klass-&gt;java_mirror());
 313   jint result;
 314 
 315   {
 316     HandleMark hm(thread);
 317     ThreadToNativeFromVM ttn(thread);
 318     // ThreadToNativeFromVM takes care of changing thread_state, so safepoint
 319     // code knows that we have left the VM
 320 
 321     result = (*verify_func)(env, cls, message, (int)message_len, klass-&gt;major_version());
 322   }
 323 
 324   JNIHandles::destroy_local(cls);
 325 
 326   // These numbers are chosen so that VerifyClassCodes interface doesn&#39;t need
 327   // to be changed (still return jboolean (unsigned char)), and result is
 328   // 1 when verification is passed.
 329   if (result == 0) {
 330     return vmSymbols::java_lang_VerifyError();
 331   } else if (result == 1) {
 332     return NULL; // verified.
 333   } else if (result == 2) {
 334     THROW_MSG_(vmSymbols::java_lang_OutOfMemoryError(), message, NULL);
 335   } else if (result == 3) {
 336     return vmSymbols::java_lang_ClassFormatError();
 337   } else {
 338     ShouldNotReachHere();
 339     return NULL;
 340   }
 341 }
 342 
 343 TypeOrigin TypeOrigin::null() {
 344   return TypeOrigin();
 345 }
 346 TypeOrigin TypeOrigin::local(u2 index, StackMapFrame* frame) {
 347   assert(frame != NULL, &quot;Must have a frame&quot;);
 348   return TypeOrigin(CF_LOCALS, index, StackMapFrame::copy(frame),
 349      frame-&gt;local_at(index));
 350 }
 351 TypeOrigin TypeOrigin::stack(u2 index, StackMapFrame* frame) {
 352   assert(frame != NULL, &quot;Must have a frame&quot;);
 353   return TypeOrigin(CF_STACK, index, StackMapFrame::copy(frame),
 354       frame-&gt;stack_at(index));
 355 }
 356 TypeOrigin TypeOrigin::sm_local(u2 index, StackMapFrame* frame) {
 357   assert(frame != NULL, &quot;Must have a frame&quot;);
 358   return TypeOrigin(SM_LOCALS, index, StackMapFrame::copy(frame),
 359       frame-&gt;local_at(index));
 360 }
 361 TypeOrigin TypeOrigin::sm_stack(u2 index, StackMapFrame* frame) {
 362   assert(frame != NULL, &quot;Must have a frame&quot;);
 363   return TypeOrigin(SM_STACK, index, StackMapFrame::copy(frame),
 364       frame-&gt;stack_at(index));
 365 }
 366 TypeOrigin TypeOrigin::bad_index(u2 index) {
 367   return TypeOrigin(BAD_INDEX, index, NULL, VerificationType::bogus_type());
 368 }
 369 TypeOrigin TypeOrigin::cp(u2 index, VerificationType vt) {
 370   return TypeOrigin(CONST_POOL, index, NULL, vt);
 371 }
 372 TypeOrigin TypeOrigin::signature(VerificationType vt) {
 373   return TypeOrigin(SIG, 0, NULL, vt);
 374 }
 375 TypeOrigin TypeOrigin::implicit(VerificationType t) {
 376   return TypeOrigin(IMPLICIT, 0, NULL, t);
 377 }
 378 TypeOrigin TypeOrigin::frame(StackMapFrame* frame) {
 379   return TypeOrigin(FRAME_ONLY, 0, StackMapFrame::copy(frame),
 380                     VerificationType::bogus_type());
 381 }
 382 
 383 void TypeOrigin::reset_frame() {
 384   if (_frame != NULL) {
 385     _frame-&gt;restore();
 386   }
 387 }
 388 
 389 void TypeOrigin::details(outputStream* ss) const {
 390   _type.print_on(ss);
 391   switch (_origin) {
 392     case CF_LOCALS:
 393       ss-&gt;print(&quot; (current frame, locals[%d])&quot;, _index);
 394       break;
 395     case CF_STACK:
 396       ss-&gt;print(&quot; (current frame, stack[%d])&quot;, _index);
 397       break;
 398     case SM_LOCALS:
 399       ss-&gt;print(&quot; (stack map, locals[%d])&quot;, _index);
 400       break;
 401     case SM_STACK:
 402       ss-&gt;print(&quot; (stack map, stack[%d])&quot;, _index);
 403       break;
 404     case CONST_POOL:
 405       ss-&gt;print(&quot; (constant pool %d)&quot;, _index);
 406       break;
 407     case SIG:
 408       ss-&gt;print(&quot; (from method signature)&quot;);
 409       break;
 410     case IMPLICIT:
 411     case FRAME_ONLY:
 412     case NONE:
 413     default:
 414       ;
 415   }
 416 }
 417 
 418 #ifdef ASSERT
 419 void TypeOrigin::print_on(outputStream* str) const {
 420   str-&gt;print(&quot;{%d,%d,%p:&quot;, _origin, _index, _frame);
 421   if (_frame != NULL) {
 422     _frame-&gt;print_on(str);
 423   } else {
 424     str-&gt;print(&quot;null&quot;);
 425   }
 426   str-&gt;print(&quot;,&quot;);
 427   _type.print_on(str);
 428   str-&gt;print(&quot;}&quot;);
 429 }
 430 #endif
 431 
 432 void ErrorContext::details(outputStream* ss, const Method* method) const {
 433   if (is_valid()) {
 434     ss-&gt;cr();
 435     ss-&gt;print_cr(&quot;Exception Details:&quot;);
 436     location_details(ss, method);
 437     reason_details(ss);
 438     frame_details(ss);
 439     bytecode_details(ss, method);
 440     handler_details(ss, method);
 441     stackmap_details(ss, method);
 442   }
 443 }
 444 
 445 void ErrorContext::reason_details(outputStream* ss) const {
 446   streamIndentor si(ss);
 447   ss-&gt;indent().print_cr(&quot;Reason:&quot;);
 448   streamIndentor si2(ss);
 449   ss-&gt;indent().print(&quot;%s&quot;, &quot;&quot;);
 450   switch (_fault) {
 451     case INVALID_BYTECODE:
 452       ss-&gt;print(&quot;Error exists in the bytecode&quot;);
 453       break;
 454     case WRONG_TYPE:
 455       if (_expected.is_valid()) {
 456         ss-&gt;print(&quot;Type &quot;);
 457         _type.details(ss);
 458         ss-&gt;print(&quot; is not assignable to &quot;);
 459         _expected.details(ss);
 460       } else {
 461         ss-&gt;print(&quot;Invalid type: &quot;);
 462         _type.details(ss);
 463       }
 464       break;
 465     case FLAGS_MISMATCH:
 466       if (_expected.is_valid()) {
 467         ss-&gt;print(&quot;Current frame&#39;s flags are not assignable &quot;
 468                   &quot;to stack map frame&#39;s.&quot;);
 469       } else {
 470         ss-&gt;print(&quot;Current frame&#39;s flags are invalid in this context.&quot;);
 471       }
 472       break;
 473     case BAD_CP_INDEX:
 474       ss-&gt;print(&quot;Constant pool index %d is invalid&quot;, _type.index());
 475       break;
 476     case BAD_LOCAL_INDEX:
 477       ss-&gt;print(&quot;Local index %d is invalid&quot;, _type.index());
 478       break;
 479     case LOCALS_SIZE_MISMATCH:
 480       ss-&gt;print(&quot;Current frame&#39;s local size doesn&#39;t match stackmap.&quot;);
 481       break;
 482     case STACK_SIZE_MISMATCH:
 483       ss-&gt;print(&quot;Current frame&#39;s stack size doesn&#39;t match stackmap.&quot;);
 484       break;
 485     case STACK_OVERFLOW:
 486       ss-&gt;print(&quot;Exceeded max stack size.&quot;);
 487       break;
 488     case STACK_UNDERFLOW:
 489       ss-&gt;print(&quot;Attempt to pop empty stack.&quot;);
 490       break;
 491     case MISSING_STACKMAP:
 492       ss-&gt;print(&quot;Expected stackmap frame at this location.&quot;);
 493       break;
 494     case BAD_STACKMAP:
 495       ss-&gt;print(&quot;Invalid stackmap specification.&quot;);
 496       break;
 497     case WRONG_INLINE_TYPE:
 498       ss-&gt;print(&quot;Type &quot;);
 499       _type.details(ss);
 500       ss-&gt;print(&quot; and type &quot;);
 501       _expected.details(ss);
 502       ss-&gt;print(&quot; must be identical inline types.&quot;);
 503       break;
 504     case UNKNOWN:
 505     default:
 506       ShouldNotReachHere();
 507       ss-&gt;print_cr(&quot;Unknown&quot;);
 508   }
 509   ss-&gt;cr();
 510 }
 511 
 512 void ErrorContext::location_details(outputStream* ss, const Method* method) const {
 513   if (_bci != -1 &amp;&amp; method != NULL) {
 514     streamIndentor si(ss);
 515     const char* bytecode_name = &quot;&lt;invalid&gt;&quot;;
 516     if (method-&gt;validate_bci(_bci) != -1) {
 517       Bytecodes::Code code = Bytecodes::code_or_bp_at(method-&gt;bcp_from(_bci));
 518       if (Bytecodes::is_defined(code)) {
 519           bytecode_name = Bytecodes::name(code);
 520       } else {
 521           bytecode_name = &quot;&lt;illegal&gt;&quot;;
 522       }
 523     }
 524     InstanceKlass* ik = method-&gt;method_holder();
 525     ss-&gt;indent().print_cr(&quot;Location:&quot;);
 526     streamIndentor si2(ss);
 527     ss-&gt;indent().print_cr(&quot;%s.%s%s @%d: %s&quot;,
 528         ik-&gt;name()-&gt;as_C_string(), method-&gt;name()-&gt;as_C_string(),
 529         method-&gt;signature()-&gt;as_C_string(), _bci, bytecode_name);
 530   }
 531 }
 532 
 533 void ErrorContext::frame_details(outputStream* ss) const {
 534   streamIndentor si(ss);
 535   if (_type.is_valid() &amp;&amp; _type.frame() != NULL) {
 536     ss-&gt;indent().print_cr(&quot;Current Frame:&quot;);
 537     streamIndentor si2(ss);
 538     _type.frame()-&gt;print_on(ss);
 539   }
 540   if (_expected.is_valid() &amp;&amp; _expected.frame() != NULL) {
 541     ss-&gt;indent().print_cr(&quot;Stackmap Frame:&quot;);
 542     streamIndentor si2(ss);
 543     _expected.frame()-&gt;print_on(ss);
 544   }
 545 }
 546 
 547 void ErrorContext::bytecode_details(outputStream* ss, const Method* method) const {
 548   if (method != NULL) {
 549     streamIndentor si(ss);
 550     ss-&gt;indent().print_cr(&quot;Bytecode:&quot;);
 551     streamIndentor si2(ss);
 552     ss-&gt;print_data(method-&gt;code_base(), method-&gt;code_size(), false);
 553   }
 554 }
 555 
 556 void ErrorContext::handler_details(outputStream* ss, const Method* method) const {
 557   if (method != NULL) {
 558     streamIndentor si(ss);
 559     ExceptionTable table(method);
 560     if (table.length() &gt; 0) {
 561       ss-&gt;indent().print_cr(&quot;Exception Handler Table:&quot;);
 562       streamIndentor si2(ss);
 563       for (int i = 0; i &lt; table.length(); ++i) {
 564         ss-&gt;indent().print_cr(&quot;bci [%d, %d] =&gt; handler: %d&quot;, table.start_pc(i),
 565             table.end_pc(i), table.handler_pc(i));
 566       }
 567     }
 568   }
 569 }
 570 
 571 void ErrorContext::stackmap_details(outputStream* ss, const Method* method) const {
 572   if (method != NULL &amp;&amp; method-&gt;has_stackmap_table()) {
 573     streamIndentor si(ss);
 574     ss-&gt;indent().print_cr(&quot;Stackmap Table:&quot;);
 575     Array&lt;u1&gt;* data = method-&gt;stackmap_data();
 576     stack_map_table* sm_table =
 577         stack_map_table::at((address)data-&gt;adr_at(0));
 578     stack_map_frame* sm_frame = sm_table-&gt;entries();
 579     streamIndentor si2(ss);
 580     int current_offset = -1;
 581     address end_of_sm_table = (address)sm_table + method-&gt;stackmap_data()-&gt;length();
 582     for (u2 i = 0; i &lt; sm_table-&gt;number_of_entries(); ++i) {
 583       ss-&gt;indent();
 584       if (!sm_frame-&gt;verify((address)sm_frame, end_of_sm_table)) {
 585         sm_frame-&gt;print_truncated(ss, current_offset);
 586         return;
 587       }
 588       sm_frame-&gt;print_on(ss, current_offset);
 589       ss-&gt;cr();
 590       current_offset += sm_frame-&gt;offset_delta();
 591       sm_frame = sm_frame-&gt;next();
 592     }
 593   }
 594 }
 595 
 596 // Methods in ClassVerifier
 597 
 598 VerificationType reference_or_inline_type(InstanceKlass* klass) {
 599   if (klass-&gt;is_inline_klass()) {
 600     return VerificationType::inline_type(klass-&gt;name());
 601   } else {
 602     return VerificationType::reference_type(klass-&gt;name());
 603   }
 604 }
 605 
 606 ClassVerifier::ClassVerifier(
 607     InstanceKlass* klass, TRAPS)
 608     : _thread(THREAD), _previous_symbol(NULL), _symbols(NULL), _exception_type(NULL),
 609       _message(NULL), _method_signatures_table(NULL), _klass(klass) {
 610   _this_type = reference_or_inline_type(klass);
 611 }
 612 
 613 ClassVerifier::~ClassVerifier() {
 614   // Decrement the reference count for any symbols created.
 615   if (_symbols != NULL) {
 616     for (int i = 0; i &lt; _symbols-&gt;length(); i++) {
 617       Symbol* s = _symbols-&gt;at(i);
 618       s-&gt;decrement_refcount();
 619     }
 620   }
 621 }
 622 
 623 VerificationType ClassVerifier::object_type() const {
 624   return VerificationType::reference_type(vmSymbols::java_lang_Object());
 625 }
 626 
 627 TypeOrigin ClassVerifier::ref_ctx(const char* sig) {
 628   VerificationType vt = VerificationType::reference_type(
 629                          create_temporary_symbol(sig, (int)strlen(sig)));
 630   return TypeOrigin::implicit(vt);
 631 }
 632 
 633 void ClassVerifier::verify_class(TRAPS) {
 634   log_info(verification)(&quot;Verifying class %s with new format&quot;, _klass-&gt;external_name());
 635 
 636   // Either verifying both local and remote classes or just remote classes.
 637   assert(BytecodeVerificationRemote, &quot;Should not be here&quot;);
 638 
 639   // Create hash table containing method signatures.
 640   method_signatures_table_type method_signatures_table;
 641   set_method_signatures_table(&amp;method_signatures_table);
 642 
 643   Array&lt;Method*&gt;* methods = _klass-&gt;methods();
 644   int num_methods = methods-&gt;length();
 645 
 646   for (int index = 0; index &lt; num_methods; index++) {
 647     // Check for recursive re-verification before each method.
 648     if (was_recursively_verified())  return;
 649 
 650     Method* m = methods-&gt;at(index);
 651     if (m-&gt;is_native() || m-&gt;is_abstract() || m-&gt;is_overpass()) {
 652       // If m is native or abstract, skip it.  It is checked in class file
 653       // parser that methods do not override a final method.  Overpass methods
 654       // are trusted since the VM generates them.
 655       continue;
 656     }
 657     verify_method(methodHandle(THREAD, m), CHECK_VERIFY(this));
 658   }
 659 
 660   if (was_recursively_verified()){
 661     log_info(verification)(&quot;Recursive verification detected for: %s&quot;, _klass-&gt;external_name());
 662     log_info(class, init)(&quot;Recursive verification detected for: %s&quot;,
 663                         _klass-&gt;external_name());
 664   }
 665 }
 666 
 667 // Translate the signature entries into verification types and save them in
 668 // the growable array.  Also, save the count of arguments.
 669 void ClassVerifier::translate_signature(Symbol* const method_sig,
 670                                         sig_as_verification_types* sig_verif_types,
 671                                         TRAPS) {
 672   SignatureStream sig_stream(method_sig);
 673   VerificationType sig_type[2];
 674   int sig_i = 0;
 675   GrowableArray&lt;VerificationType&gt;* verif_types = sig_verif_types-&gt;sig_verif_types();
 676 
 677   // Translate the signature arguments into verification types.
 678   while (!sig_stream.at_return_type()) {
 679     int n = change_sig_to_verificationType(&amp;sig_stream, sig_type);
 680     assert(n &lt;= 2, &quot;Unexpected signature type&quot;);
 681 
 682     // Store verification type(s).  Longs and Doubles each have two verificationTypes.
 683     for (int x = 0; x &lt; n; x++) {
 684       verif_types-&gt;push(sig_type[x]);
 685     }
 686     sig_i += n;
 687     sig_stream.next();
 688   }
 689 
 690   // Set final arg count, not including the return type.  The final arg count will
 691   // be compared with sig_verify_types&#39; length to see if there is a return type.
 692   sig_verif_types-&gt;set_num_args(sig_i);
 693 
 694   // Store verification type(s) for the return type, if there is one.
 695   if (sig_stream.type() != T_VOID) {
 696     int n = change_sig_to_verificationType(&amp;sig_stream, sig_type);
 697     assert(n &lt;= 2, &quot;Unexpected signature return type&quot;);
 698     for (int y = 0; y &lt; n; y++) {
 699       verif_types-&gt;push(sig_type[y]);
 700     }
 701   }
 702 }
 703 
 704 void ClassVerifier::create_method_sig_entry(sig_as_verification_types* sig_verif_types,
 705                                             int sig_index, TRAPS) {
 706   // Translate the signature into verification types.
 707   ConstantPool* cp = _klass-&gt;constants();
 708   Symbol* const method_sig = cp-&gt;symbol_at(sig_index);
 709   translate_signature(method_sig, sig_verif_types, CHECK_VERIFY(this));
 710 
 711   // Add the list of this signature&#39;s verification types to the table.
 712   bool is_unique = method_signatures_table()-&gt;put(sig_index, sig_verif_types);
 713   assert(is_unique, &quot;Duplicate entries in method_signature_table&quot;);
 714 }
 715 
 716 void ClassVerifier::verify_method(const methodHandle&amp; m, TRAPS) {
 717   HandleMark hm(THREAD);
 718   _method = m;   // initialize _method
 719   log_info(verification)(&quot;Verifying method %s&quot;, m-&gt;name_and_sig_as_C_string());
 720 
 721 // For clang, the only good constant format string is a literal constant format string.
 722 #define bad_type_msg &quot;Bad type on operand stack in %s&quot;
 723 
 724   int32_t max_stack = m-&gt;verifier_max_stack();
 725   int32_t max_locals = m-&gt;max_locals();
 726   constantPoolHandle cp(THREAD, m-&gt;constants());
 727 
 728   // Method signature was checked in ClassFileParser.
 729   assert(SignatureVerifier::is_valid_method_signature(m-&gt;signature()),
 730          &quot;Invalid method signature&quot;);
 731 
 732   // Initial stack map frame: offset is 0, stack is initially empty.
 733   StackMapFrame current_frame(max_locals, max_stack, this);
 734   // Set initial locals
 735   VerificationType return_type = current_frame.set_locals_from_arg(
 736     m, current_type(), CHECK_VERIFY(this));
 737 
 738   int32_t stackmap_index = 0; // index to the stackmap array
 739 
 740   u4 code_length = m-&gt;code_size();
 741 
 742   // Scan the bytecode and map each instruction&#39;s start offset to a number.
 743   char* code_data = generate_code_data(m, code_length, CHECK_VERIFY(this));
 744 
 745   int ex_min = code_length;
 746   int ex_max = -1;
 747   // Look through each item on the exception table. Each of the fields must refer
 748   // to a legal instruction.
 749   if (was_recursively_verified()) return;
 750   verify_exception_handler_table(
 751     code_length, code_data, ex_min, ex_max, CHECK_VERIFY(this));
 752 
 753   // Look through each entry on the local variable table and make sure
 754   // its range of code array offsets is valid. (4169817)
 755   if (m-&gt;has_localvariable_table()) {
 756     verify_local_variable_table(code_length, code_data, CHECK_VERIFY(this));
 757   }
 758 
 759   Array&lt;u1&gt;* stackmap_data = m-&gt;stackmap_data();
 760   StackMapStream stream(stackmap_data);
 761   StackMapReader reader(this, &amp;stream, code_data, code_length, THREAD);
 762   StackMapTable stackmap_table(&amp;reader, &amp;current_frame, max_locals, max_stack,
 763                                code_data, code_length, CHECK_VERIFY(this));
 764 
 765   LogTarget(Debug, verification) lt;
 766   if (lt.is_enabled()) {
 767     ResourceMark rm(THREAD);
 768     LogStream ls(lt);
 769     stackmap_table.print_on(&amp;ls);
 770   }
 771 
 772   RawBytecodeStream bcs(m);
 773 
 774   // Scan the byte code linearly from the start to the end
 775   bool no_control_flow = false; // Set to true when there is no direct control
 776                                 // flow from current instruction to the next
 777                                 // instruction in sequence
 778 
 779   Bytecodes::Code opcode;
 780   while (!bcs.is_last_bytecode()) {
 781     // Check for recursive re-verification before each bytecode.
 782     if (was_recursively_verified())  return;
 783 
 784     opcode = bcs.raw_next();
 785     u2 bci = bcs.bci();
 786 
 787     // Set current frame&#39;s offset to bci
 788     current_frame.set_offset(bci);
 789     current_frame.set_mark();
 790 
 791     // Make sure every offset in stackmap table point to the beginning to
 792     // an instruction. Match current_frame to stackmap_table entry with
 793     // the same offset if exists.
 794     stackmap_index = verify_stackmap_table(
 795       stackmap_index, bci, &amp;current_frame, &amp;stackmap_table,
 796       no_control_flow, CHECK_VERIFY(this));
 797 
 798 
 799     bool this_uninit = false;  // Set to true when invokespecial &lt;init&gt; initialized &#39;this&#39;
 800     bool verified_exc_handlers = false;
 801 
 802     // Merge with the next instruction
 803     {
 804       u2 index;
 805       int target;
 806       VerificationType type, type2;
 807       VerificationType atype;
 808 
 809       LogTarget(Debug, verification) lt;
 810       if (lt.is_enabled()) {
 811         ResourceMark rm(THREAD);
 812         LogStream ls(lt);
 813         current_frame.print_on(&amp;ls);
 814         lt.print(&quot;offset = %d,  opcode = %s&quot;, bci,
 815                  opcode == Bytecodes::_illegal ? &quot;illegal&quot; : Bytecodes::name(opcode));
 816       }
 817 
 818       // Make sure wide instruction is in correct format
 819       if (bcs.is_wide()) {
 820         if (opcode != Bytecodes::_iinc   &amp;&amp; opcode != Bytecodes::_iload  &amp;&amp;
 821             opcode != Bytecodes::_aload  &amp;&amp; opcode != Bytecodes::_lload  &amp;&amp;
 822             opcode != Bytecodes::_istore &amp;&amp; opcode != Bytecodes::_astore &amp;&amp;
 823             opcode != Bytecodes::_lstore &amp;&amp; opcode != Bytecodes::_fload  &amp;&amp;
 824             opcode != Bytecodes::_dload  &amp;&amp; opcode != Bytecodes::_fstore &amp;&amp;
 825             opcode != Bytecodes::_dstore) {
 826           /* Unreachable?  RawBytecodeStream&#39;s raw_next() returns &#39;illegal&#39;
 827            * if we encounter a wide instruction that modifies an invalid
 828            * opcode (not one of the ones listed above) */
 829           verify_error(ErrorContext::bad_code(bci), &quot;Bad wide instruction&quot;);
 830           return;
 831         }
 832       }
 833 
 834       // Look for possible jump target in exception handlers and see if it
 835       // matches current_frame.  Do this check here for astore*, dstore*,
 836       // fstore*, istore*, and lstore* opcodes because they can change the type
 837       // state by adding a local.  JVM Spec says that the incoming type state
 838       // should be used for this check.  So, do the check here before a possible
 839       // local is added to the type state.
 840       if (Bytecodes::is_store_into_local(opcode) &amp;&amp; bci &gt;= ex_min &amp;&amp; bci &lt; ex_max) {
 841         if (was_recursively_verified()) return;
 842         verify_exception_handler_targets(
 843           bci, this_uninit, &amp;current_frame, &amp;stackmap_table, CHECK_VERIFY(this));
 844         verified_exc_handlers = true;
 845       }
 846 
 847       if (was_recursively_verified()) return;
 848 
 849       switch (opcode) {
 850         case Bytecodes::_nop :
 851           no_control_flow = false; break;
 852         case Bytecodes::_aconst_null :
 853           current_frame.push_stack(
 854             VerificationType::null_type(), CHECK_VERIFY(this));
 855           no_control_flow = false; break;
 856         case Bytecodes::_iconst_m1 :
 857         case Bytecodes::_iconst_0 :
 858         case Bytecodes::_iconst_1 :
 859         case Bytecodes::_iconst_2 :
 860         case Bytecodes::_iconst_3 :
 861         case Bytecodes::_iconst_4 :
 862         case Bytecodes::_iconst_5 :
 863           current_frame.push_stack(
 864             VerificationType::integer_type(), CHECK_VERIFY(this));
 865           no_control_flow = false; break;
 866         case Bytecodes::_lconst_0 :
 867         case Bytecodes::_lconst_1 :
 868           current_frame.push_stack_2(
 869             VerificationType::long_type(),
 870             VerificationType::long2_type(), CHECK_VERIFY(this));
 871           no_control_flow = false; break;
 872         case Bytecodes::_fconst_0 :
 873         case Bytecodes::_fconst_1 :
 874         case Bytecodes::_fconst_2 :
 875           current_frame.push_stack(
 876             VerificationType::float_type(), CHECK_VERIFY(this));
 877           no_control_flow = false; break;
 878         case Bytecodes::_dconst_0 :
 879         case Bytecodes::_dconst_1 :
 880           current_frame.push_stack_2(
 881             VerificationType::double_type(),
 882             VerificationType::double2_type(), CHECK_VERIFY(this));
 883           no_control_flow = false; break;
 884         case Bytecodes::_sipush :
 885         case Bytecodes::_bipush :
 886           current_frame.push_stack(
 887             VerificationType::integer_type(), CHECK_VERIFY(this));
 888           no_control_flow = false; break;
 889         case Bytecodes::_ldc :
 890           verify_ldc(
 891             opcode, bcs.get_index_u1(), &amp;current_frame,
 892             cp, bci, CHECK_VERIFY(this));
 893           no_control_flow = false; break;
 894         case Bytecodes::_ldc_w :
 895         case Bytecodes::_ldc2_w :
 896           verify_ldc(
 897             opcode, bcs.get_index_u2(), &amp;current_frame,
 898             cp, bci, CHECK_VERIFY(this));
 899           no_control_flow = false; break;
 900         case Bytecodes::_iload :
 901           verify_iload(bcs.get_index(), &amp;current_frame, CHECK_VERIFY(this));
 902           no_control_flow = false; break;
 903         case Bytecodes::_iload_0 :
 904         case Bytecodes::_iload_1 :
 905         case Bytecodes::_iload_2 :
 906         case Bytecodes::_iload_3 :
 907           index = opcode - Bytecodes::_iload_0;
 908           verify_iload(index, &amp;current_frame, CHECK_VERIFY(this));
 909           no_control_flow = false; break;
 910         case Bytecodes::_lload :
 911           verify_lload(bcs.get_index(), &amp;current_frame, CHECK_VERIFY(this));
 912           no_control_flow = false; break;
 913         case Bytecodes::_lload_0 :
 914         case Bytecodes::_lload_1 :
 915         case Bytecodes::_lload_2 :
 916         case Bytecodes::_lload_3 :
 917           index = opcode - Bytecodes::_lload_0;
 918           verify_lload(index, &amp;current_frame, CHECK_VERIFY(this));
 919           no_control_flow = false; break;
 920         case Bytecodes::_fload :
 921           verify_fload(bcs.get_index(), &amp;current_frame, CHECK_VERIFY(this));
 922           no_control_flow = false; break;
 923         case Bytecodes::_fload_0 :
 924         case Bytecodes::_fload_1 :
 925         case Bytecodes::_fload_2 :
 926         case Bytecodes::_fload_3 :
 927           index = opcode - Bytecodes::_fload_0;
 928           verify_fload(index, &amp;current_frame, CHECK_VERIFY(this));
 929           no_control_flow = false; break;
 930         case Bytecodes::_dload :
 931           verify_dload(bcs.get_index(), &amp;current_frame, CHECK_VERIFY(this));
 932           no_control_flow = false; break;
 933         case Bytecodes::_dload_0 :
 934         case Bytecodes::_dload_1 :
 935         case Bytecodes::_dload_2 :
 936         case Bytecodes::_dload_3 :
 937           index = opcode - Bytecodes::_dload_0;
 938           verify_dload(index, &amp;current_frame, CHECK_VERIFY(this));
 939           no_control_flow = false; break;
 940         case Bytecodes::_aload :
 941           verify_aload(bcs.get_index(), &amp;current_frame, CHECK_VERIFY(this));
 942           no_control_flow = false; break;
 943         case Bytecodes::_aload_0 :
 944         case Bytecodes::_aload_1 :
 945         case Bytecodes::_aload_2 :
 946         case Bytecodes::_aload_3 :
 947           index = opcode - Bytecodes::_aload_0;
 948           verify_aload(index, &amp;current_frame, CHECK_VERIFY(this));
 949           no_control_flow = false; break;
 950         case Bytecodes::_iaload :
 951           type = current_frame.pop_stack(
 952             VerificationType::integer_type(), CHECK_VERIFY(this));
 953           atype = current_frame.pop_stack(
 954             VerificationType::reference_check(), CHECK_VERIFY(this));
 955           if (!atype.is_int_array()) {
 956             verify_error(ErrorContext::bad_type(bci,
 957                 current_frame.stack_top_ctx(), ref_ctx(&quot;[I&quot;)),
 958                 bad_type_msg, &quot;iaload&quot;);
 959             return;
 960           }
 961           current_frame.push_stack(
 962             VerificationType::integer_type(), CHECK_VERIFY(this));
 963           no_control_flow = false; break;
 964         case Bytecodes::_baload :
 965           type = current_frame.pop_stack(
 966             VerificationType::integer_type(), CHECK_VERIFY(this));
 967           atype = current_frame.pop_stack(
 968             VerificationType::reference_check(), CHECK_VERIFY(this));
 969           if (!atype.is_bool_array() &amp;&amp; !atype.is_byte_array()) {
 970             verify_error(
 971                 ErrorContext::bad_type(bci, current_frame.stack_top_ctx()),
 972                 bad_type_msg, &quot;baload&quot;);
 973             return;
 974           }
 975           current_frame.push_stack(
 976             VerificationType::integer_type(), CHECK_VERIFY(this));
 977           no_control_flow = false; break;
 978         case Bytecodes::_caload :
 979           type = current_frame.pop_stack(
 980             VerificationType::integer_type(), CHECK_VERIFY(this));
 981           atype = current_frame.pop_stack(
 982             VerificationType::reference_check(), CHECK_VERIFY(this));
 983           if (!atype.is_char_array()) {
 984             verify_error(ErrorContext::bad_type(bci,
 985                 current_frame.stack_top_ctx(), ref_ctx(&quot;[C&quot;)),
 986                 bad_type_msg, &quot;caload&quot;);
 987             return;
 988           }
 989           current_frame.push_stack(
 990             VerificationType::integer_type(), CHECK_VERIFY(this));
 991           no_control_flow = false; break;
 992         case Bytecodes::_saload :
 993           type = current_frame.pop_stack(
 994             VerificationType::integer_type(), CHECK_VERIFY(this));
 995           atype = current_frame.pop_stack(
 996             VerificationType::reference_check(), CHECK_VERIFY(this));
 997           if (!atype.is_short_array()) {
 998             verify_error(ErrorContext::bad_type(bci,
 999                 current_frame.stack_top_ctx(), ref_ctx(&quot;[S&quot;)),
1000                 bad_type_msg, &quot;saload&quot;);
1001             return;
1002           }
1003           current_frame.push_stack(
1004             VerificationType::integer_type(), CHECK_VERIFY(this));
1005           no_control_flow = false; break;
1006         case Bytecodes::_laload :
1007           type = current_frame.pop_stack(
1008             VerificationType::integer_type(), CHECK_VERIFY(this));
1009           atype = current_frame.pop_stack(
1010             VerificationType::reference_check(), CHECK_VERIFY(this));
1011           if (!atype.is_long_array()) {
1012             verify_error(ErrorContext::bad_type(bci,
1013                 current_frame.stack_top_ctx(), ref_ctx(&quot;[J&quot;)),
1014                 bad_type_msg, &quot;laload&quot;);
1015             return;
1016           }
1017           current_frame.push_stack_2(
1018             VerificationType::long_type(),
1019             VerificationType::long2_type(), CHECK_VERIFY(this));
1020           no_control_flow = false; break;
1021         case Bytecodes::_faload :
1022           type = current_frame.pop_stack(
1023             VerificationType::integer_type(), CHECK_VERIFY(this));
1024           atype = current_frame.pop_stack(
1025             VerificationType::reference_check(), CHECK_VERIFY(this));
1026           if (!atype.is_float_array()) {
1027             verify_error(ErrorContext::bad_type(bci,
1028                 current_frame.stack_top_ctx(), ref_ctx(&quot;[F&quot;)),
1029                 bad_type_msg, &quot;faload&quot;);
1030             return;
1031           }
1032           current_frame.push_stack(
1033             VerificationType::float_type(), CHECK_VERIFY(this));
1034           no_control_flow = false; break;
1035         case Bytecodes::_daload :
1036           type = current_frame.pop_stack(
1037             VerificationType::integer_type(), CHECK_VERIFY(this));
1038           atype = current_frame.pop_stack(
1039             VerificationType::reference_check(), CHECK_VERIFY(this));
1040           if (!atype.is_double_array()) {
1041             verify_error(ErrorContext::bad_type(bci,
1042                 current_frame.stack_top_ctx(), ref_ctx(&quot;[D&quot;)),
1043                 bad_type_msg, &quot;daload&quot;);
1044             return;
1045           }
1046           current_frame.push_stack_2(
1047             VerificationType::double_type(),
1048             VerificationType::double2_type(), CHECK_VERIFY(this));
1049           no_control_flow = false; break;
1050         case Bytecodes::_aaload : {
1051           type = current_frame.pop_stack(
1052             VerificationType::integer_type(), CHECK_VERIFY(this));
1053           atype = current_frame.pop_stack(
1054             VerificationType::reference_check(), CHECK_VERIFY(this));
1055           if (!atype.is_nonscalar_array()) {
1056             verify_error(ErrorContext::bad_type(bci,
1057                 current_frame.stack_top_ctx(),
1058                 TypeOrigin::implicit(VerificationType::reference_check())),
1059                 bad_type_msg, &quot;aaload&quot;);
1060             return;
1061           }
1062           if (atype.is_null()) {
1063             current_frame.push_stack(
1064               VerificationType::null_type(), CHECK_VERIFY(this));
1065           } else {
1066             VerificationType component =
1067               atype.get_component(this, CHECK_VERIFY(this));
1068             current_frame.push_stack(component, CHECK_VERIFY(this));
1069           }
1070           no_control_flow = false; break;
1071         }
1072         case Bytecodes::_istore :
1073           verify_istore(bcs.get_index(), &amp;current_frame, CHECK_VERIFY(this));
1074           no_control_flow = false; break;
1075         case Bytecodes::_istore_0 :
1076         case Bytecodes::_istore_1 :
1077         case Bytecodes::_istore_2 :
1078         case Bytecodes::_istore_3 :
1079           index = opcode - Bytecodes::_istore_0;
1080           verify_istore(index, &amp;current_frame, CHECK_VERIFY(this));
1081           no_control_flow = false; break;
1082         case Bytecodes::_lstore :
1083           verify_lstore(bcs.get_index(), &amp;current_frame, CHECK_VERIFY(this));
1084           no_control_flow = false; break;
1085         case Bytecodes::_lstore_0 :
1086         case Bytecodes::_lstore_1 :
1087         case Bytecodes::_lstore_2 :
1088         case Bytecodes::_lstore_3 :
1089           index = opcode - Bytecodes::_lstore_0;
1090           verify_lstore(index, &amp;current_frame, CHECK_VERIFY(this));
1091           no_control_flow = false; break;
1092         case Bytecodes::_fstore :
1093           verify_fstore(bcs.get_index(), &amp;current_frame, CHECK_VERIFY(this));
1094           no_control_flow = false; break;
1095         case Bytecodes::_fstore_0 :
1096         case Bytecodes::_fstore_1 :
1097         case Bytecodes::_fstore_2 :
1098         case Bytecodes::_fstore_3 :
1099           index = opcode - Bytecodes::_fstore_0;
1100           verify_fstore(index, &amp;current_frame, CHECK_VERIFY(this));
1101           no_control_flow = false; break;
1102         case Bytecodes::_dstore :
1103           verify_dstore(bcs.get_index(), &amp;current_frame, CHECK_VERIFY(this));
1104           no_control_flow = false; break;
1105         case Bytecodes::_dstore_0 :
1106         case Bytecodes::_dstore_1 :
1107         case Bytecodes::_dstore_2 :
1108         case Bytecodes::_dstore_3 :
1109           index = opcode - Bytecodes::_dstore_0;
1110           verify_dstore(index, &amp;current_frame, CHECK_VERIFY(this));
1111           no_control_flow = false; break;
1112         case Bytecodes::_astore :
1113           verify_astore(bcs.get_index(), &amp;current_frame, CHECK_VERIFY(this));
1114           no_control_flow = false; break;
1115         case Bytecodes::_astore_0 :
1116         case Bytecodes::_astore_1 :
1117         case Bytecodes::_astore_2 :
1118         case Bytecodes::_astore_3 :
1119           index = opcode - Bytecodes::_astore_0;
1120           verify_astore(index, &amp;current_frame, CHECK_VERIFY(this));
1121           no_control_flow = false; break;
1122         case Bytecodes::_iastore :
1123           type = current_frame.pop_stack(
1124             VerificationType::integer_type(), CHECK_VERIFY(this));
1125           type2 = current_frame.pop_stack(
1126             VerificationType::integer_type(), CHECK_VERIFY(this));
1127           atype = current_frame.pop_stack(
1128             VerificationType::reference_check(), CHECK_VERIFY(this));
1129           if (!atype.is_int_array()) {
1130             verify_error(ErrorContext::bad_type(bci,
1131                 current_frame.stack_top_ctx(), ref_ctx(&quot;[I&quot;)),
1132                 bad_type_msg, &quot;iastore&quot;);
1133             return;
1134           }
1135           no_control_flow = false; break;
1136         case Bytecodes::_bastore :
1137           type = current_frame.pop_stack(
1138             VerificationType::integer_type(), CHECK_VERIFY(this));
1139           type2 = current_frame.pop_stack(
1140             VerificationType::integer_type(), CHECK_VERIFY(this));
1141           atype = current_frame.pop_stack(
1142             VerificationType::reference_check(), CHECK_VERIFY(this));
1143           if (!atype.is_bool_array() &amp;&amp; !atype.is_byte_array()) {
1144             verify_error(
1145                 ErrorContext::bad_type(bci, current_frame.stack_top_ctx()),
1146                 bad_type_msg, &quot;bastore&quot;);
1147             return;
1148           }
1149           no_control_flow = false; break;
1150         case Bytecodes::_castore :
1151           current_frame.pop_stack(
1152             VerificationType::integer_type(), CHECK_VERIFY(this));
1153           current_frame.pop_stack(
1154             VerificationType::integer_type(), CHECK_VERIFY(this));
1155           atype = current_frame.pop_stack(
1156             VerificationType::reference_check(), CHECK_VERIFY(this));
1157           if (!atype.is_char_array()) {
1158             verify_error(ErrorContext::bad_type(bci,
1159                 current_frame.stack_top_ctx(), ref_ctx(&quot;[C&quot;)),
1160                 bad_type_msg, &quot;castore&quot;);
1161             return;
1162           }
1163           no_control_flow = false; break;
1164         case Bytecodes::_sastore :
1165           current_frame.pop_stack(
1166             VerificationType::integer_type(), CHECK_VERIFY(this));
1167           current_frame.pop_stack(
1168             VerificationType::integer_type(), CHECK_VERIFY(this));
1169           atype = current_frame.pop_stack(
1170             VerificationType::reference_check(), CHECK_VERIFY(this));
1171           if (!atype.is_short_array()) {
1172             verify_error(ErrorContext::bad_type(bci,
1173                 current_frame.stack_top_ctx(), ref_ctx(&quot;[S&quot;)),
1174                 bad_type_msg, &quot;sastore&quot;);
1175             return;
1176           }
1177           no_control_flow = false; break;
1178         case Bytecodes::_lastore :
1179           current_frame.pop_stack_2(
1180             VerificationType::long2_type(),
1181             VerificationType::long_type(), CHECK_VERIFY(this));
1182           current_frame.pop_stack(
1183             VerificationType::integer_type(), CHECK_VERIFY(this));
1184           atype = current_frame.pop_stack(
1185             VerificationType::reference_check(), CHECK_VERIFY(this));
1186           if (!atype.is_long_array()) {
1187             verify_error(ErrorContext::bad_type(bci,
1188                 current_frame.stack_top_ctx(), ref_ctx(&quot;[J&quot;)),
1189                 bad_type_msg, &quot;lastore&quot;);
1190             return;
1191           }
1192           no_control_flow = false; break;
1193         case Bytecodes::_fastore :
1194           current_frame.pop_stack(
1195             VerificationType::float_type(), CHECK_VERIFY(this));
1196           current_frame.pop_stack
1197             (VerificationType::integer_type(), CHECK_VERIFY(this));
1198           atype = current_frame.pop_stack(
1199             VerificationType::reference_check(), CHECK_VERIFY(this));
1200           if (!atype.is_float_array()) {
1201             verify_error(ErrorContext::bad_type(bci,
1202                 current_frame.stack_top_ctx(), ref_ctx(&quot;[F&quot;)),
1203                 bad_type_msg, &quot;fastore&quot;);
1204             return;
1205           }
1206           no_control_flow = false; break;
1207         case Bytecodes::_dastore :
1208           current_frame.pop_stack_2(
1209             VerificationType::double2_type(),
1210             VerificationType::double_type(), CHECK_VERIFY(this));
1211           current_frame.pop_stack(
1212             VerificationType::integer_type(), CHECK_VERIFY(this));
1213           atype = current_frame.pop_stack(
1214             VerificationType::reference_check(), CHECK_VERIFY(this));
1215           if (!atype.is_double_array()) {
1216             verify_error(ErrorContext::bad_type(bci,
1217                 current_frame.stack_top_ctx(), ref_ctx(&quot;[D&quot;)),
1218                 bad_type_msg, &quot;dastore&quot;);
1219             return;
1220           }
1221           no_control_flow = false; break;
1222         case Bytecodes::_aastore :
1223           type = current_frame.pop_stack(object_type(), CHECK_VERIFY(this));
1224           type2 = current_frame.pop_stack(
1225             VerificationType::integer_type(), CHECK_VERIFY(this));
1226           atype = current_frame.pop_stack(
1227             VerificationType::reference_check(), CHECK_VERIFY(this));
1228           // more type-checking is done at runtime
1229           if (!atype.is_nonscalar_array()) {
1230             verify_error(ErrorContext::bad_type(bci,
1231                 current_frame.stack_top_ctx(),
1232                 TypeOrigin::implicit(VerificationType::reference_check())),
1233                 bad_type_msg, &quot;aastore&quot;);
1234             return;
1235           }
1236           // 4938384: relaxed constraint in JVMS 3nd edition.
1237           no_control_flow = false; break;
1238         case Bytecodes::_pop :
1239           current_frame.pop_stack(
1240             VerificationType::category1_check(), CHECK_VERIFY(this));
1241           no_control_flow = false; break;
1242         case Bytecodes::_pop2 :
1243           type = current_frame.pop_stack(CHECK_VERIFY(this));
1244           if (type.is_category1()) {
1245             current_frame.pop_stack(
1246               VerificationType::category1_check(), CHECK_VERIFY(this));
1247           } else if (type.is_category2_2nd()) {
1248             current_frame.pop_stack(
1249               VerificationType::category2_check(), CHECK_VERIFY(this));
1250           } else {
1251             /* Unreachable? Would need a category2_1st on TOS
1252              * which does not appear possible. */
1253             verify_error(
1254                 ErrorContext::bad_type(bci, current_frame.stack_top_ctx()),
1255                 bad_type_msg, &quot;pop2&quot;);
1256             return;
1257           }
1258           no_control_flow = false; break;
1259         case Bytecodes::_dup :
1260           type = current_frame.pop_stack(
1261             VerificationType::category1_check(), CHECK_VERIFY(this));
1262           current_frame.push_stack(type, CHECK_VERIFY(this));
1263           current_frame.push_stack(type, CHECK_VERIFY(this));
1264           no_control_flow = false; break;
1265         case Bytecodes::_dup_x1 :
1266           type = current_frame.pop_stack(
1267             VerificationType::category1_check(), CHECK_VERIFY(this));
1268           type2 = current_frame.pop_stack(
1269             VerificationType::category1_check(), CHECK_VERIFY(this));
1270           current_frame.push_stack(type, CHECK_VERIFY(this));
1271           current_frame.push_stack(type2, CHECK_VERIFY(this));
1272           current_frame.push_stack(type, CHECK_VERIFY(this));
1273           no_control_flow = false; break;
1274         case Bytecodes::_dup_x2 :
1275         {
1276           VerificationType type3;
1277           type = current_frame.pop_stack(
1278             VerificationType::category1_check(), CHECK_VERIFY(this));
1279           type2 = current_frame.pop_stack(CHECK_VERIFY(this));
1280           if (type2.is_category1()) {
1281             type3 = current_frame.pop_stack(
1282               VerificationType::category1_check(), CHECK_VERIFY(this));
1283           } else if (type2.is_category2_2nd()) {
1284             type3 = current_frame.pop_stack(
1285               VerificationType::category2_check(), CHECK_VERIFY(this));
1286           } else {
1287             /* Unreachable? Would need a category2_1st at stack depth 2 with
1288              * a category1 on TOS which does not appear possible. */
1289             verify_error(ErrorContext::bad_type(
1290                 bci, current_frame.stack_top_ctx()), bad_type_msg, &quot;dup_x2&quot;);
1291             return;
1292           }
1293           current_frame.push_stack(type, CHECK_VERIFY(this));
1294           current_frame.push_stack(type3, CHECK_VERIFY(this));
1295           current_frame.push_stack(type2, CHECK_VERIFY(this));
1296           current_frame.push_stack(type, CHECK_VERIFY(this));
1297           no_control_flow = false; break;
1298         }
1299         case Bytecodes::_dup2 :
1300           type = current_frame.pop_stack(CHECK_VERIFY(this));
1301           if (type.is_category1()) {
1302             type2 = current_frame.pop_stack(
1303               VerificationType::category1_check(), CHECK_VERIFY(this));
1304           } else if (type.is_category2_2nd()) {
1305             type2 = current_frame.pop_stack(
1306               VerificationType::category2_check(), CHECK_VERIFY(this));
1307           } else {
1308             /* Unreachable?  Would need a category2_1st on TOS which does not
1309              * appear possible. */
1310             verify_error(
1311                 ErrorContext::bad_type(bci, current_frame.stack_top_ctx()),
1312                 bad_type_msg, &quot;dup2&quot;);
1313             return;
1314           }
1315           current_frame.push_stack(type2, CHECK_VERIFY(this));
1316           current_frame.push_stack(type, CHECK_VERIFY(this));
1317           current_frame.push_stack(type2, CHECK_VERIFY(this));
1318           current_frame.push_stack(type, CHECK_VERIFY(this));
1319           no_control_flow = false; break;
1320         case Bytecodes::_dup2_x1 :
1321         {
1322           VerificationType type3;
1323           type = current_frame.pop_stack(CHECK_VERIFY(this));
1324           if (type.is_category1()) {
1325             type2 = current_frame.pop_stack(
1326               VerificationType::category1_check(), CHECK_VERIFY(this));
1327           } else if (type.is_category2_2nd()) {
1328             type2 = current_frame.pop_stack(
1329               VerificationType::category2_check(), CHECK_VERIFY(this));
1330           } else {
1331             /* Unreachable?  Would need a category2_1st on TOS which does
1332              * not appear possible. */
1333             verify_error(
1334                 ErrorContext::bad_type(bci, current_frame.stack_top_ctx()),
1335                 bad_type_msg, &quot;dup2_x1&quot;);
1336             return;
1337           }
1338           type3 = current_frame.pop_stack(
1339             VerificationType::category1_check(), CHECK_VERIFY(this));
1340           current_frame.push_stack(type2, CHECK_VERIFY(this));
1341           current_frame.push_stack(type, CHECK_VERIFY(this));
1342           current_frame.push_stack(type3, CHECK_VERIFY(this));
1343           current_frame.push_stack(type2, CHECK_VERIFY(this));
1344           current_frame.push_stack(type, CHECK_VERIFY(this));
1345           no_control_flow = false; break;
1346         }
1347         case Bytecodes::_dup2_x2 :
1348         {
1349           VerificationType type3, type4;
1350           type = current_frame.pop_stack(CHECK_VERIFY(this));
1351           if (type.is_category1()) {
1352             type2 = current_frame.pop_stack(
1353               VerificationType::category1_check(), CHECK_VERIFY(this));
1354           } else if (type.is_category2_2nd()) {
1355             type2 = current_frame.pop_stack(
1356               VerificationType::category2_check(), CHECK_VERIFY(this));
1357           } else {
1358             /* Unreachable?  Would need a category2_1st on TOS which does
1359              * not appear possible. */
1360             verify_error(
1361                 ErrorContext::bad_type(bci, current_frame.stack_top_ctx()),
1362                 bad_type_msg, &quot;dup2_x2&quot;);
1363             return;
1364           }
1365           type3 = current_frame.pop_stack(CHECK_VERIFY(this));
1366           if (type3.is_category1()) {
1367             type4 = current_frame.pop_stack(
1368               VerificationType::category1_check(), CHECK_VERIFY(this));
1369           } else if (type3.is_category2_2nd()) {
1370             type4 = current_frame.pop_stack(
1371               VerificationType::category2_check(), CHECK_VERIFY(this));
1372           } else {
1373             /* Unreachable?  Would need a category2_1st on TOS after popping
1374              * a long/double or two category 1&#39;s, which does not
1375              * appear possible. */
1376             verify_error(
1377                 ErrorContext::bad_type(bci, current_frame.stack_top_ctx()),
1378                 bad_type_msg, &quot;dup2_x2&quot;);
1379             return;
1380           }
1381           current_frame.push_stack(type2, CHECK_VERIFY(this));
1382           current_frame.push_stack(type, CHECK_VERIFY(this));
1383           current_frame.push_stack(type4, CHECK_VERIFY(this));
1384           current_frame.push_stack(type3, CHECK_VERIFY(this));
1385           current_frame.push_stack(type2, CHECK_VERIFY(this));
1386           current_frame.push_stack(type, CHECK_VERIFY(this));
1387           no_control_flow = false; break;
1388         }
1389         case Bytecodes::_swap :
1390           type = current_frame.pop_stack(
1391             VerificationType::category1_check(), CHECK_VERIFY(this));
1392           type2 = current_frame.pop_stack(
1393             VerificationType::category1_check(), CHECK_VERIFY(this));
1394           current_frame.push_stack(type, CHECK_VERIFY(this));
1395           current_frame.push_stack(type2, CHECK_VERIFY(this));
1396           no_control_flow = false; break;
1397         case Bytecodes::_iadd :
1398         case Bytecodes::_isub :
1399         case Bytecodes::_imul :
1400         case Bytecodes::_idiv :
1401         case Bytecodes::_irem :
1402         case Bytecodes::_ishl :
1403         case Bytecodes::_ishr :
1404         case Bytecodes::_iushr :
1405         case Bytecodes::_ior :
1406         case Bytecodes::_ixor :
1407         case Bytecodes::_iand :
1408           current_frame.pop_stack(
1409             VerificationType::integer_type(), CHECK_VERIFY(this));
1410           // fall through
1411         case Bytecodes::_ineg :
1412           current_frame.pop_stack(
1413             VerificationType::integer_type(), CHECK_VERIFY(this));
1414           current_frame.push_stack(
1415             VerificationType::integer_type(), CHECK_VERIFY(this));
1416           no_control_flow = false; break;
1417         case Bytecodes::_ladd :
1418         case Bytecodes::_lsub :
1419         case Bytecodes::_lmul :
1420         case Bytecodes::_ldiv :
1421         case Bytecodes::_lrem :
1422         case Bytecodes::_land :
1423         case Bytecodes::_lor :
1424         case Bytecodes::_lxor :
1425           current_frame.pop_stack_2(
1426             VerificationType::long2_type(),
1427             VerificationType::long_type(), CHECK_VERIFY(this));
1428           // fall through
1429         case Bytecodes::_lneg :
1430           current_frame.pop_stack_2(
1431             VerificationType::long2_type(),
1432             VerificationType::long_type(), CHECK_VERIFY(this));
1433           current_frame.push_stack_2(
1434             VerificationType::long_type(),
1435             VerificationType::long2_type(), CHECK_VERIFY(this));
1436           no_control_flow = false; break;
1437         case Bytecodes::_lshl :
1438         case Bytecodes::_lshr :
1439         case Bytecodes::_lushr :
1440           current_frame.pop_stack(
1441             VerificationType::integer_type(), CHECK_VERIFY(this));
1442           current_frame.pop_stack_2(
1443             VerificationType::long2_type(),
1444             VerificationType::long_type(), CHECK_VERIFY(this));
1445           current_frame.push_stack_2(
1446             VerificationType::long_type(),
1447             VerificationType::long2_type(), CHECK_VERIFY(this));
1448           no_control_flow = false; break;
1449         case Bytecodes::_fadd :
1450         case Bytecodes::_fsub :
1451         case Bytecodes::_fmul :
1452         case Bytecodes::_fdiv :
1453         case Bytecodes::_frem :
1454           current_frame.pop_stack(
1455             VerificationType::float_type(), CHECK_VERIFY(this));
1456           // fall through
1457         case Bytecodes::_fneg :
1458           current_frame.pop_stack(
1459             VerificationType::float_type(), CHECK_VERIFY(this));
1460           current_frame.push_stack(
1461             VerificationType::float_type(), CHECK_VERIFY(this));
1462           no_control_flow = false; break;
1463         case Bytecodes::_dadd :
1464         case Bytecodes::_dsub :
1465         case Bytecodes::_dmul :
1466         case Bytecodes::_ddiv :
1467         case Bytecodes::_drem :
1468           current_frame.pop_stack_2(
1469             VerificationType::double2_type(),
1470             VerificationType::double_type(), CHECK_VERIFY(this));
1471           // fall through
1472         case Bytecodes::_dneg :
1473           current_frame.pop_stack_2(
1474             VerificationType::double2_type(),
1475             VerificationType::double_type(), CHECK_VERIFY(this));
1476           current_frame.push_stack_2(
1477             VerificationType::double_type(),
1478             VerificationType::double2_type(), CHECK_VERIFY(this));
1479           no_control_flow = false; break;
1480         case Bytecodes::_iinc :
1481           verify_iinc(bcs.get_index(), &amp;current_frame, CHECK_VERIFY(this));
1482           no_control_flow = false; break;
1483         case Bytecodes::_i2l :
1484           type = current_frame.pop_stack(
1485             VerificationType::integer_type(), CHECK_VERIFY(this));
1486           current_frame.push_stack_2(
1487             VerificationType::long_type(),
1488             VerificationType::long2_type(), CHECK_VERIFY(this));
1489           no_control_flow = false; break;
1490        case Bytecodes::_l2i :
1491           current_frame.pop_stack_2(
1492             VerificationType::long2_type(),
1493             VerificationType::long_type(), CHECK_VERIFY(this));
1494           current_frame.push_stack(
1495             VerificationType::integer_type(), CHECK_VERIFY(this));
1496           no_control_flow = false; break;
1497         case Bytecodes::_i2f :
1498           current_frame.pop_stack(
1499             VerificationType::integer_type(), CHECK_VERIFY(this));
1500           current_frame.push_stack(
1501             VerificationType::float_type(), CHECK_VERIFY(this));
1502           no_control_flow = false; break;
1503         case Bytecodes::_i2d :
1504           current_frame.pop_stack(
1505             VerificationType::integer_type(), CHECK_VERIFY(this));
1506           current_frame.push_stack_2(
1507             VerificationType::double_type(),
1508             VerificationType::double2_type(), CHECK_VERIFY(this));
1509           no_control_flow = false; break;
1510         case Bytecodes::_l2f :
1511           current_frame.pop_stack_2(
1512             VerificationType::long2_type(),
1513             VerificationType::long_type(), CHECK_VERIFY(this));
1514           current_frame.push_stack(
1515             VerificationType::float_type(), CHECK_VERIFY(this));
1516           no_control_flow = false; break;
1517         case Bytecodes::_l2d :
1518           current_frame.pop_stack_2(
1519             VerificationType::long2_type(),
1520             VerificationType::long_type(), CHECK_VERIFY(this));
1521           current_frame.push_stack_2(
1522             VerificationType::double_type(),
1523             VerificationType::double2_type(), CHECK_VERIFY(this));
1524           no_control_flow = false; break;
1525         case Bytecodes::_f2i :
1526           current_frame.pop_stack(
1527             VerificationType::float_type(), CHECK_VERIFY(this));
1528           current_frame.push_stack(
1529             VerificationType::integer_type(), CHECK_VERIFY(this));
1530           no_control_flow = false; break;
1531         case Bytecodes::_f2l :
1532           current_frame.pop_stack(
1533             VerificationType::float_type(), CHECK_VERIFY(this));
1534           current_frame.push_stack_2(
1535             VerificationType::long_type(),
1536             VerificationType::long2_type(), CHECK_VERIFY(this));
1537           no_control_flow = false; break;
1538         case Bytecodes::_f2d :
1539           current_frame.pop_stack(
1540             VerificationType::float_type(), CHECK_VERIFY(this));
1541           current_frame.push_stack_2(
1542             VerificationType::double_type(),
1543             VerificationType::double2_type(), CHECK_VERIFY(this));
1544           no_control_flow = false; break;
1545         case Bytecodes::_d2i :
1546           current_frame.pop_stack_2(
1547             VerificationType::double2_type(),
1548             VerificationType::double_type(), CHECK_VERIFY(this));
1549           current_frame.push_stack(
1550             VerificationType::integer_type(), CHECK_VERIFY(this));
1551           no_control_flow = false; break;
1552         case Bytecodes::_d2l :
1553           current_frame.pop_stack_2(
1554             VerificationType::double2_type(),
1555             VerificationType::double_type(), CHECK_VERIFY(this));
1556           current_frame.push_stack_2(
1557             VerificationType::long_type(),
1558             VerificationType::long2_type(), CHECK_VERIFY(this));
1559           no_control_flow = false; break;
1560         case Bytecodes::_d2f :
1561           current_frame.pop_stack_2(
1562             VerificationType::double2_type(),
1563             VerificationType::double_type(), CHECK_VERIFY(this));
1564           current_frame.push_stack(
1565             VerificationType::float_type(), CHECK_VERIFY(this));
1566           no_control_flow = false; break;
1567         case Bytecodes::_i2b :
1568         case Bytecodes::_i2c :
1569         case Bytecodes::_i2s :
1570           current_frame.pop_stack(
1571             VerificationType::integer_type(), CHECK_VERIFY(this));
1572           current_frame.push_stack(
1573             VerificationType::integer_type(), CHECK_VERIFY(this));
1574           no_control_flow = false; break;
1575         case Bytecodes::_lcmp :
1576           current_frame.pop_stack_2(
1577             VerificationType::long2_type(),
1578             VerificationType::long_type(), CHECK_VERIFY(this));
1579           current_frame.pop_stack_2(
1580             VerificationType::long2_type(),
1581             VerificationType::long_type(), CHECK_VERIFY(this));
1582           current_frame.push_stack(
1583             VerificationType::integer_type(), CHECK_VERIFY(this));
1584           no_control_flow = false; break;
1585         case Bytecodes::_fcmpl :
1586         case Bytecodes::_fcmpg :
1587           current_frame.pop_stack(
1588             VerificationType::float_type(), CHECK_VERIFY(this));
1589           current_frame.pop_stack(
1590             VerificationType::float_type(), CHECK_VERIFY(this));
1591           current_frame.push_stack(
1592             VerificationType::integer_type(), CHECK_VERIFY(this));
1593           no_control_flow = false; break;
1594         case Bytecodes::_dcmpl :
1595         case Bytecodes::_dcmpg :
1596           current_frame.pop_stack_2(
1597             VerificationType::double2_type(),
1598             VerificationType::double_type(), CHECK_VERIFY(this));
1599           current_frame.pop_stack_2(
1600             VerificationType::double2_type(),
1601             VerificationType::double_type(), CHECK_VERIFY(this));
1602           current_frame.push_stack(
1603             VerificationType::integer_type(), CHECK_VERIFY(this));
1604           no_control_flow = false; break;
1605         case Bytecodes::_if_icmpeq:
1606         case Bytecodes::_if_icmpne:
1607         case Bytecodes::_if_icmplt:
1608         case Bytecodes::_if_icmpge:
1609         case Bytecodes::_if_icmpgt:
1610         case Bytecodes::_if_icmple:
1611           current_frame.pop_stack(
1612             VerificationType::integer_type(), CHECK_VERIFY(this));
1613           // fall through
1614         case Bytecodes::_ifeq:
1615         case Bytecodes::_ifne:
1616         case Bytecodes::_iflt:
1617         case Bytecodes::_ifge:
1618         case Bytecodes::_ifgt:
1619         case Bytecodes::_ifle:
1620           current_frame.pop_stack(
1621             VerificationType::integer_type(), CHECK_VERIFY(this));
1622           target = bcs.dest();
1623           stackmap_table.check_jump_target(
1624             &amp;current_frame, target, CHECK_VERIFY(this));
1625           no_control_flow = false; break;
1626         case Bytecodes::_if_acmpeq :
1627         case Bytecodes::_if_acmpne :
1628           current_frame.pop_stack(
1629             VerificationType::nonscalar_check(), CHECK_VERIFY(this));
1630           // fall through
1631         case Bytecodes::_ifnull :
1632         case Bytecodes::_ifnonnull :
1633           current_frame.pop_stack(
1634             VerificationType::nonscalar_check(), CHECK_VERIFY(this));
1635           target = bcs.dest();
1636           stackmap_table.check_jump_target
1637             (&amp;current_frame, target, CHECK_VERIFY(this));
1638           no_control_flow = false; break;
1639         case Bytecodes::_goto :
1640           target = bcs.dest();
1641           stackmap_table.check_jump_target(
1642             &amp;current_frame, target, CHECK_VERIFY(this));
1643           no_control_flow = true; break;
1644         case Bytecodes::_goto_w :
1645           target = bcs.dest_w();
1646           stackmap_table.check_jump_target(
1647             &amp;current_frame, target, CHECK_VERIFY(this));
1648           no_control_flow = true; break;
1649         case Bytecodes::_tableswitch :
1650         case Bytecodes::_lookupswitch :
1651           verify_switch(
1652             &amp;bcs, code_length, code_data, &amp;current_frame,
1653             &amp;stackmap_table, CHECK_VERIFY(this));
1654           no_control_flow = true; break;
1655         case Bytecodes::_ireturn :
1656           type = current_frame.pop_stack(
1657             VerificationType::integer_type(), CHECK_VERIFY(this));
1658           verify_return_value(return_type, type, bci,
1659                               &amp;current_frame, CHECK_VERIFY(this));
1660           no_control_flow = true; break;
1661         case Bytecodes::_lreturn :
1662           type2 = current_frame.pop_stack(
1663             VerificationType::long2_type(), CHECK_VERIFY(this));
1664           type = current_frame.pop_stack(
1665             VerificationType::long_type(), CHECK_VERIFY(this));
1666           verify_return_value(return_type, type, bci,
1667                               &amp;current_frame, CHECK_VERIFY(this));
1668           no_control_flow = true; break;
1669         case Bytecodes::_freturn :
1670           type = current_frame.pop_stack(
1671             VerificationType::float_type(), CHECK_VERIFY(this));
1672           verify_return_value(return_type, type, bci,
1673                               &amp;current_frame, CHECK_VERIFY(this));
1674           no_control_flow = true; break;
1675         case Bytecodes::_dreturn :
1676           type2 = current_frame.pop_stack(
1677             VerificationType::double2_type(),  CHECK_VERIFY(this));
1678           type = current_frame.pop_stack(
1679             VerificationType::double_type(), CHECK_VERIFY(this));
1680           verify_return_value(return_type, type, bci,
1681                               &amp;current_frame, CHECK_VERIFY(this));
1682           no_control_flow = true; break;
1683         case Bytecodes::_areturn :
1684           type = current_frame.pop_stack(
1685             VerificationType::nonscalar_check(), CHECK_VERIFY(this));
1686           verify_return_value(return_type, type, bci,
1687                               &amp;current_frame, CHECK_VERIFY(this));
1688           no_control_flow = true; break;
1689         case Bytecodes::_return :
1690           if (return_type != VerificationType::bogus_type()) {
1691             verify_error(ErrorContext::bad_code(bci),
1692                          &quot;Method expects a return value&quot;);
1693             return;
1694           }
1695           // Make sure &quot;this&quot; has been initialized if current method is an
1696           // &lt;init&gt;.
1697           if (_method-&gt;is_object_constructor() &amp;&amp;
1698               current_frame.flag_this_uninit()) {
1699             verify_error(ErrorContext::bad_code(bci),
1700                          &quot;Constructor must call super() or this() &quot;
1701                          &quot;before return&quot;);
1702             return;
1703           }
1704           no_control_flow = true; break;
1705         case Bytecodes::_getstatic :
1706         case Bytecodes::_putstatic :
1707           // pass TRUE, operand can be an array type for getstatic/putstatic.
1708           verify_field_instructions(
1709             &amp;bcs, &amp;current_frame, cp, true, CHECK_VERIFY(this));
1710           no_control_flow = false; break;
1711         case Bytecodes::_getfield :
1712         case Bytecodes::_putfield :
1713           // pass FALSE, operand can&#39;t be an array type for getfield/putfield.
1714           verify_field_instructions(
1715             &amp;bcs, &amp;current_frame, cp, false, CHECK_VERIFY(this));
1716           no_control_flow = false; break;
1717         case Bytecodes::_withfield :
1718           if (_klass-&gt;major_version() &lt; INLINE_TYPE_MAJOR_VERSION) {
1719             class_format_error(
1720               &quot;withfield not supported by this class file version (%d.%d), class %s&quot;,
1721               _klass-&gt;major_version(), _klass-&gt;minor_version(), _klass-&gt;external_name());
1722             return;
1723           }
1724           // pass FALSE, operand can&#39;t be an array type for withfield.
1725           verify_field_instructions(
1726             &amp;bcs, &amp;current_frame, cp, false, CHECK_VERIFY(this));
1727           no_control_flow = false; break;
1728         case Bytecodes::_invokevirtual :
1729         case Bytecodes::_invokespecial :
1730         case Bytecodes::_invokestatic :
1731         case Bytecodes::_invokeinterface :
1732         case Bytecodes::_invokedynamic :
1733           verify_invoke_instructions(
1734             &amp;bcs, code_length, &amp;current_frame, (bci &gt;= ex_min &amp;&amp; bci &lt; ex_max),
1735             &amp;this_uninit, cp, &amp;stackmap_table, CHECK_VERIFY(this));
1736           no_control_flow = false; break;
1737         case Bytecodes::_new :
1738         {
1739           index = bcs.get_index_u2();
1740           verify_cp_class_type(bci, index, cp, CHECK_VERIFY(this));
1741           VerificationType new_class_type =
1742             cp_index_to_type(index, cp, CHECK_VERIFY(this));
1743           if (!new_class_type.is_object()) {
1744             verify_error(ErrorContext::bad_type(bci,
1745                 TypeOrigin::cp(index, new_class_type)),
1746                 &quot;Illegal new instruction&quot;);
1747             return;
1748           }
1749           type = VerificationType::uninitialized_type(bci);
1750           current_frame.push_stack(type, CHECK_VERIFY(this));
1751           no_control_flow = false; break;
1752         }
1753         case Bytecodes::_defaultvalue :
1754         {
1755           if (_klass-&gt;major_version() &lt; INLINE_TYPE_MAJOR_VERSION) {
1756             class_format_error(
1757               &quot;defaultvalue not supported by this class file version (%d.%d), class %s&quot;,
1758               _klass-&gt;major_version(), _klass-&gt;minor_version(), _klass-&gt;external_name());
1759             return;
1760           }
1761           index = bcs.get_index_u2();
1762           verify_cp_class_type(bci, index, cp, CHECK_VERIFY(this));
1763           VerificationType ref_type = cp_index_to_type(index, cp, CHECK_VERIFY(this));
1764           if (!ref_type.is_object()) {
1765             verify_error(ErrorContext::bad_type(bci,
1766                 TypeOrigin::cp(index, ref_type)),
1767                 &quot;Illegal defaultvalue instruction&quot;);
1768             return;
1769           }
1770           VerificationType inline_type =
1771             VerificationType::change_ref_to_inline_type(ref_type);
1772           current_frame.push_stack(inline_type, CHECK_VERIFY(this));
1773           no_control_flow = false; break;
1774         }
1775         case Bytecodes::_newarray :
1776           type = get_newarray_type(bcs.get_index(), bci, CHECK_VERIFY(this));
1777           current_frame.pop_stack(
1778             VerificationType::integer_type(),  CHECK_VERIFY(this));
1779           current_frame.push_stack(type, CHECK_VERIFY(this));
1780           no_control_flow = false; break;
1781         case Bytecodes::_anewarray :
1782           verify_anewarray(
1783             bci, bcs.get_index_u2(), cp, &amp;current_frame, CHECK_VERIFY(this));
1784           no_control_flow = false; break;
1785         case Bytecodes::_arraylength :
1786           type = current_frame.pop_stack(
1787             VerificationType::reference_check(), CHECK_VERIFY(this));
1788           if (!(type.is_null() || type.is_array())) {
1789             verify_error(ErrorContext::bad_type(
1790                 bci, current_frame.stack_top_ctx()),
1791                 bad_type_msg, &quot;arraylength&quot;);
1792           }
1793           current_frame.push_stack(
1794             VerificationType::integer_type(), CHECK_VERIFY(this));
1795           no_control_flow = false; break;
1796         case Bytecodes::_checkcast :
1797         {
1798           index = bcs.get_index_u2();
1799           verify_cp_class_type(bci, index, cp, CHECK_VERIFY(this));
1800           current_frame.pop_stack(object_type(), CHECK_VERIFY(this));
1801           VerificationType klass_type = cp_index_to_type(
1802             index, cp, CHECK_VERIFY(this));
1803           current_frame.push_stack(klass_type, CHECK_VERIFY(this));
1804           no_control_flow = false; break;
1805         }
1806         case Bytecodes::_instanceof : {
1807           index = bcs.get_index_u2();
1808           verify_cp_class_type(bci, index, cp, CHECK_VERIFY(this));
1809           current_frame.pop_stack(object_type(), CHECK_VERIFY(this));
1810           current_frame.push_stack(
1811             VerificationType::integer_type(), CHECK_VERIFY(this));
1812           no_control_flow = false; break;
1813         }
1814         case Bytecodes::_monitorenter :
1815         case Bytecodes::_monitorexit : {
1816           VerificationType ref = current_frame.pop_stack(
1817             VerificationType::nonscalar_check(), CHECK_VERIFY(this));
1818           no_control_flow = false; break;
1819         }
1820         case Bytecodes::_multianewarray :
1821         {
1822           index = bcs.get_index_u2();
1823           u2 dim = *(bcs.bcp()+3);
1824           verify_cp_class_type(bci, index, cp, CHECK_VERIFY(this));
1825           VerificationType new_array_type =
1826             cp_index_to_type(index, cp, CHECK_VERIFY(this));
1827           if (!new_array_type.is_array()) {
1828             verify_error(ErrorContext::bad_type(bci,
1829                 TypeOrigin::cp(index, new_array_type)),
1830                 &quot;Illegal constant pool index in multianewarray instruction&quot;);
1831             return;
1832           }
1833           if (dim &lt; 1 || new_array_type.dimensions() &lt; dim) {
1834             verify_error(ErrorContext::bad_code(bci),
1835                 &quot;Illegal dimension in multianewarray instruction: %d&quot;, dim);
1836             return;
1837           }
1838           for (int i = 0; i &lt; dim; i++) {
1839             current_frame.pop_stack(
1840               VerificationType::integer_type(), CHECK_VERIFY(this));
1841           }
1842           current_frame.push_stack(new_array_type, CHECK_VERIFY(this));
1843           no_control_flow = false; break;
1844         }
1845         case Bytecodes::_athrow :
1846           type = VerificationType::reference_type(
1847             vmSymbols::java_lang_Throwable());
1848           current_frame.pop_stack(type, CHECK_VERIFY(this));
1849           no_control_flow = true; break;
1850         default:
1851           // We only need to check the valid bytecodes in class file.
1852           // And jsr and ret are not in the new class file format in JDK1.5.
1853           verify_error(ErrorContext::bad_code(bci),
1854               &quot;Bad instruction: %02x&quot;, opcode);
1855           no_control_flow = false;
1856           return;
1857       }  // end switch
1858     }  // end Merge with the next instruction
1859 
1860     // Look for possible jump target in exception handlers and see if it matches
1861     // current_frame.  Don&#39;t do this check if it has already been done (for
1862     // ([a,d,f,i,l]store* opcodes).  This check cannot be done earlier because
1863     // opcodes, such as invokespecial, may set the this_uninit flag.
1864     assert(!(verified_exc_handlers &amp;&amp; this_uninit),
1865       &quot;Exception handler targets got verified before this_uninit got set&quot;);
1866     if (!verified_exc_handlers &amp;&amp; bci &gt;= ex_min &amp;&amp; bci &lt; ex_max) {
1867       if (was_recursively_verified()) return;
1868       verify_exception_handler_targets(
1869         bci, this_uninit, &amp;current_frame, &amp;stackmap_table, CHECK_VERIFY(this));
1870     }
1871   } // end while
1872 
1873   // Make sure that control flow does not fall through end of the method
1874   if (!no_control_flow) {
1875     verify_error(ErrorContext::bad_code(code_length),
1876         &quot;Control flow falls through code end&quot;);
1877     return;
1878   }
1879 }
1880 
1881 #undef bad_type_message
1882 
1883 char* ClassVerifier::generate_code_data(const methodHandle&amp; m, u4 code_length, TRAPS) {
1884   char* code_data = NEW_RESOURCE_ARRAY(char, code_length);
1885   memset(code_data, 0, sizeof(char) * code_length);
1886   RawBytecodeStream bcs(m);
1887 
1888   while (!bcs.is_last_bytecode()) {
1889     if (bcs.raw_next() != Bytecodes::_illegal) {
1890       int bci = bcs.bci();
1891       if (bcs.raw_code() == Bytecodes::_new) {
1892         code_data[bci] = NEW_OFFSET;
1893       } else {
1894         code_data[bci] = BYTECODE_OFFSET;
1895       }
1896     } else {
1897       verify_error(ErrorContext::bad_code(bcs.bci()), &quot;Bad instruction&quot;);
1898       return NULL;
1899     }
1900   }
1901 
1902   return code_data;
1903 }
1904 
1905 // Since this method references the constant pool, call was_recursively_verified()
1906 // before calling this method to make sure a prior class load did not cause the
1907 // current class to get verified.
1908 void ClassVerifier::verify_exception_handler_table(u4 code_length, char* code_data, int&amp; min, int&amp; max, TRAPS) {
1909   ExceptionTable exhandlers(_method());
1910   int exlength = exhandlers.length();
1911   constantPoolHandle cp (THREAD, _method-&gt;constants());
1912 
1913   for(int i = 0; i &lt; exlength; i++) {
1914     u2 start_pc = exhandlers.start_pc(i);
1915     u2 end_pc = exhandlers.end_pc(i);
1916     u2 handler_pc = exhandlers.handler_pc(i);
1917     if (start_pc &gt;= code_length || code_data[start_pc] == 0) {
1918       class_format_error(&quot;Illegal exception table start_pc %d&quot;, start_pc);
1919       return;
1920     }
1921     if (end_pc != code_length) {   // special case: end_pc == code_length
1922       if (end_pc &gt; code_length || code_data[end_pc] == 0) {
1923         class_format_error(&quot;Illegal exception table end_pc %d&quot;, end_pc);
1924         return;
1925       }
1926     }
1927     if (handler_pc &gt;= code_length || code_data[handler_pc] == 0) {
1928       class_format_error(&quot;Illegal exception table handler_pc %d&quot;, handler_pc);
1929       return;
1930     }
1931     int catch_type_index = exhandlers.catch_type_index(i);
1932     if (catch_type_index != 0) {
1933       VerificationType catch_type = cp_index_to_type(
1934         catch_type_index, cp, CHECK_VERIFY(this));
1935       VerificationType throwable =
1936         VerificationType::reference_type(vmSymbols::java_lang_Throwable());
1937       bool is_subclass = throwable.is_assignable_from(
1938         catch_type, this, false, CHECK_VERIFY(this));
1939       if (!is_subclass) {
1940         // 4286534: should throw VerifyError according to recent spec change
1941         verify_error(ErrorContext::bad_type(handler_pc,
1942             TypeOrigin::cp(catch_type_index, catch_type),
1943             TypeOrigin::implicit(throwable)),
1944             &quot;Catch type is not a subclass &quot;
1945             &quot;of Throwable in exception handler %d&quot;, handler_pc);
1946         return;
1947       }
1948     }
1949     if (start_pc &lt; min) min = start_pc;
1950     if (end_pc &gt; max) max = end_pc;
1951   }
1952 }
1953 
1954 void ClassVerifier::verify_local_variable_table(u4 code_length, char* code_data, TRAPS) {
1955   int localvariable_table_length = _method-&gt;localvariable_table_length();
1956   if (localvariable_table_length &gt; 0) {
1957     LocalVariableTableElement* table = _method-&gt;localvariable_table_start();
1958     for (int i = 0; i &lt; localvariable_table_length; i++) {
1959       u2 start_bci = table[i].start_bci;
1960       u2 length = table[i].length;
1961 
1962       if (start_bci &gt;= code_length || code_data[start_bci] == 0) {
1963         class_format_error(
1964           &quot;Illegal local variable table start_pc %d&quot;, start_bci);
1965         return;
1966       }
1967       u4 end_bci = (u4)(start_bci + length);
1968       if (end_bci != code_length) {
1969         if (end_bci &gt;= code_length || code_data[end_bci] == 0) {
1970           class_format_error( &quot;Illegal local variable table length %d&quot;, length);
1971           return;
1972         }
1973       }
1974     }
1975   }
1976 }
1977 
1978 u2 ClassVerifier::verify_stackmap_table(u2 stackmap_index, u2 bci,
1979                                         StackMapFrame* current_frame,
1980                                         StackMapTable* stackmap_table,
1981                                         bool no_control_flow, TRAPS) {
1982   if (stackmap_index &lt; stackmap_table-&gt;get_frame_count()) {
1983     u2 this_offset = stackmap_table-&gt;get_offset(stackmap_index);
1984     if (no_control_flow &amp;&amp; this_offset &gt; bci) {
1985       verify_error(ErrorContext::missing_stackmap(bci),
1986                    &quot;Expecting a stack map frame&quot;);
1987       return 0;
1988     }
1989     if (this_offset == bci) {
1990       ErrorContext ctx;
1991       // See if current stack map can be assigned to the frame in table.
1992       // current_frame is the stackmap frame got from the last instruction.
1993       // If matched, current_frame will be updated by this method.
1994       bool matches = stackmap_table-&gt;match_stackmap(
1995         current_frame, this_offset, stackmap_index,
1996         !no_control_flow, true, &amp;ctx, CHECK_VERIFY_(this, 0));
1997       if (!matches) {
1998         // report type error
1999         verify_error(ctx, &quot;Instruction type does not match stack map&quot;);
2000         return 0;
2001       }
2002       stackmap_index++;
2003     } else if (this_offset &lt; bci) {
2004       // current_offset should have met this_offset.
2005       class_format_error(&quot;Bad stack map offset %d&quot;, this_offset);
2006       return 0;
2007     }
2008   } else if (no_control_flow) {
2009     verify_error(ErrorContext::bad_code(bci), &quot;Expecting a stack map frame&quot;);
2010     return 0;
2011   }
2012   return stackmap_index;
2013 }
2014 
2015 // Since this method references the constant pool, call was_recursively_verified()
2016 // before calling this method to make sure a prior class load did not cause the
2017 // current class to get verified.
2018 void ClassVerifier::verify_exception_handler_targets(u2 bci, bool this_uninit,
2019                                                      StackMapFrame* current_frame,
2020                                                      StackMapTable* stackmap_table, TRAPS) {
2021   constantPoolHandle cp (THREAD, _method-&gt;constants());
2022   ExceptionTable exhandlers(_method());
2023   int exlength = exhandlers.length();
2024   for(int i = 0; i &lt; exlength; i++) {
2025     u2 start_pc = exhandlers.start_pc(i);
2026     u2 end_pc = exhandlers.end_pc(i);
2027     u2 handler_pc = exhandlers.handler_pc(i);
2028     int catch_type_index = exhandlers.catch_type_index(i);
2029     if(bci &gt;= start_pc &amp;&amp; bci &lt; end_pc) {
2030       u1 flags = current_frame-&gt;flags();
2031       if (this_uninit) {  flags |= FLAG_THIS_UNINIT; }
2032       StackMapFrame* new_frame = current_frame-&gt;frame_in_exception_handler(flags);
2033       if (catch_type_index != 0) {
2034         if (was_recursively_verified()) return;
2035         // We know that this index refers to a subclass of Throwable
2036         VerificationType catch_type = cp_index_to_type(
2037           catch_type_index, cp, CHECK_VERIFY(this));
2038         new_frame-&gt;push_stack(catch_type, CHECK_VERIFY(this));
2039       } else {
2040         VerificationType throwable =
2041           VerificationType::reference_type(vmSymbols::java_lang_Throwable());
2042         new_frame-&gt;push_stack(throwable, CHECK_VERIFY(this));
2043       }
2044       ErrorContext ctx;
2045       bool matches = stackmap_table-&gt;match_stackmap(
2046         new_frame, handler_pc, true, false, &amp;ctx, CHECK_VERIFY(this));
2047       if (!matches) {
2048         verify_error(ctx, &quot;Stack map does not match the one at &quot;
2049             &quot;exception handler %d&quot;, handler_pc);
2050         return;
2051       }
2052     }
2053   }
2054 }
2055 
2056 void ClassVerifier::verify_cp_index(
2057     u2 bci, const constantPoolHandle&amp; cp, int index, TRAPS) {
2058   int nconstants = cp-&gt;length();
2059   if ((index &lt;= 0) || (index &gt;= nconstants)) {
2060     verify_error(ErrorContext::bad_cp_index(bci, index),
2061         &quot;Illegal constant pool index %d in class %s&quot;,
2062         index, cp-&gt;pool_holder()-&gt;external_name());
2063     return;
2064   }
2065 }
2066 
2067 void ClassVerifier::verify_cp_type(
2068     u2 bci, int index, const constantPoolHandle&amp; cp, unsigned int types, TRAPS) {
2069 
2070   // In some situations, bytecode rewriting may occur while we&#39;re verifying.
2071   // In this case, a constant pool cache exists and some indices refer to that
2072   // instead.  Be sure we don&#39;t pick up such indices by accident.
2073   // We must check was_recursively_verified() before we get here.
2074   guarantee(cp-&gt;cache() == NULL, &quot;not rewritten yet&quot;);
2075 
2076   verify_cp_index(bci, cp, index, CHECK_VERIFY(this));
2077   unsigned int tag = cp-&gt;tag_at(index).value();
2078 
2079   if ((types &amp; (1 &lt;&lt; tag)) == 0) {
2080     verify_error(ErrorContext::bad_cp_index(bci, index),
2081       &quot;Illegal type at constant pool entry %d in class %s&quot;,
2082       index, cp-&gt;pool_holder()-&gt;external_name());
2083     return;
2084   }
2085 }
2086 
2087 void ClassVerifier::verify_cp_class_type(
2088     u2 bci, int index, const constantPoolHandle&amp; cp, TRAPS) {
2089   verify_cp_index(bci, cp, index, CHECK_VERIFY(this));
2090   constantTag tag = cp-&gt;tag_at(index);
2091   if (!tag.is_klass() &amp;&amp; !tag.is_unresolved_klass()) {
2092     verify_error(ErrorContext::bad_cp_index(bci, index),
2093         &quot;Illegal type at constant pool entry %d in class %s&quot;,
2094         index, cp-&gt;pool_holder()-&gt;external_name());
2095     return;
2096   }
2097 }
2098 
2099 void ClassVerifier::verify_error(ErrorContext ctx, const char* msg, ...) {
2100   stringStream ss;
2101 
2102   ctx.reset_frames();
2103   _exception_type = vmSymbols::java_lang_VerifyError();
2104   _error_context = ctx;
2105   va_list va;
2106   va_start(va, msg);
2107   ss.vprint(msg, va);
2108   va_end(va);
2109   _message = ss.as_string();
2110 #ifdef ASSERT
2111   ResourceMark rm;
2112   const char* exception_name = _exception_type-&gt;as_C_string();
2113   Exceptions::debug_check_abort(exception_name, NULL);
2114 #endif // ndef ASSERT
2115 }
2116 
2117 void ClassVerifier::class_format_error(const char* msg, ...) {
2118   stringStream ss;
2119   _exception_type = vmSymbols::java_lang_ClassFormatError();
2120   va_list va;
2121   va_start(va, msg);
2122   ss.vprint(msg, va);
2123   va_end(va);
2124   if (!_method.is_null()) {
2125     ss.print(&quot; in method &#39;&quot;);
2126     _method-&gt;print_external_name(&amp;ss);
2127     ss.print(&quot;&#39;&quot;);
2128   }
2129   _message = ss.as_string();
2130 }
2131 
2132 Klass* ClassVerifier::load_class(Symbol* name, TRAPS) {
2133   HandleMark hm(THREAD);
2134   // Get current loader and protection domain first.
2135   oop loader = current_class()-&gt;class_loader();
2136   oop protection_domain = current_class()-&gt;protection_domain();
2137 
2138   assert(name_in_supers(name, current_class()), &quot;name should be a super class&quot;);
2139 
2140   Klass* kls = SystemDictionary::resolve_or_fail(
2141     name, Handle(THREAD, loader), Handle(THREAD, protection_domain),
2142     true, THREAD);
2143 
2144   if (kls != NULL) {
2145     if (log_is_enabled(Debug, class, resolve)) {
2146       Verifier::trace_class_resolution(kls, current_class());
2147     }
2148   }
2149   return kls;
2150 }
2151 
2152 bool ClassVerifier::is_protected_access(InstanceKlass* this_class,
2153                                         Klass* target_class,
2154                                         Symbol* field_name,
2155                                         Symbol* field_sig,
2156                                         bool is_method) {
2157   NoSafepointVerifier nosafepoint;
2158 
2159   // If target class isn&#39;t a super class of this class, we don&#39;t worry about this case
2160   if (!this_class-&gt;is_subclass_of(target_class)) {
2161     return false;
2162   }
2163   // Check if the specified method or field is protected
2164   InstanceKlass* target_instance = InstanceKlass::cast(target_class);
2165   fieldDescriptor fd;
2166   if (is_method) {
2167     Method* m = target_instance-&gt;uncached_lookup_method(field_name, field_sig, Klass::find_overpass);
2168     if (m != NULL &amp;&amp; m-&gt;is_protected()) {
2169       if (!this_class-&gt;is_same_class_package(m-&gt;method_holder())) {
2170         return true;
2171       }
2172     }
2173   } else {
2174     Klass* member_klass = target_instance-&gt;find_field(field_name, field_sig, &amp;fd);
2175     if (member_klass != NULL &amp;&amp; fd.is_protected()) {
2176       if (!this_class-&gt;is_same_class_package(member_klass)) {
2177         return true;
2178       }
2179     }
2180   }
2181   return false;
2182 }
2183 
2184 void ClassVerifier::verify_ldc(
2185     int opcode, u2 index, StackMapFrame* current_frame,
2186     const constantPoolHandle&amp; cp, u2 bci, TRAPS) {
2187   verify_cp_index(bci, cp, index, CHECK_VERIFY(this));
2188   constantTag tag = cp-&gt;tag_at(index);
2189   unsigned int types = 0;
2190   if (opcode == Bytecodes::_ldc || opcode == Bytecodes::_ldc_w) {
2191     if (!tag.is_unresolved_klass()) {
2192       types = (1 &lt;&lt; JVM_CONSTANT_Integer) | (1 &lt;&lt; JVM_CONSTANT_Float)
2193             | (1 &lt;&lt; JVM_CONSTANT_String) | (1 &lt;&lt; JVM_CONSTANT_Class)
2194             | (1 &lt;&lt; JVM_CONSTANT_MethodHandle) | (1 &lt;&lt; JVM_CONSTANT_MethodType)
2195             | (1 &lt;&lt; JVM_CONSTANT_Dynamic);
2196       // Note:  The class file parser already verified the legality of
2197       // MethodHandle and MethodType constants.
2198       verify_cp_type(bci, index, cp, types, CHECK_VERIFY(this));
2199     }
2200   } else {
2201     assert(opcode == Bytecodes::_ldc2_w, &quot;must be ldc2_w&quot;);
2202     types = (1 &lt;&lt; JVM_CONSTANT_Double) | (1 &lt;&lt; JVM_CONSTANT_Long)
2203           | (1 &lt;&lt; JVM_CONSTANT_Dynamic);
2204     verify_cp_type(bci, index, cp, types, CHECK_VERIFY(this));
2205   }
2206   if (tag.is_string() &amp;&amp; cp-&gt;is_pseudo_string_at(index)) {
2207     current_frame-&gt;push_stack(object_type(), CHECK_VERIFY(this));
2208   } else if (tag.is_string()) {
2209     current_frame-&gt;push_stack(
2210       VerificationType::reference_type(
2211         vmSymbols::java_lang_String()), CHECK_VERIFY(this));
2212   } else if (tag.is_klass() || tag.is_unresolved_klass()) {
2213     current_frame-&gt;push_stack(
2214       VerificationType::reference_type(
2215         vmSymbols::java_lang_Class()), CHECK_VERIFY(this));
2216   } else if (tag.is_int()) {
2217     current_frame-&gt;push_stack(
2218       VerificationType::integer_type(), CHECK_VERIFY(this));
2219   } else if (tag.is_float()) {
2220     current_frame-&gt;push_stack(
2221       VerificationType::float_type(), CHECK_VERIFY(this));
2222   } else if (tag.is_double()) {
2223     current_frame-&gt;push_stack_2(
2224       VerificationType::double_type(),
2225       VerificationType::double2_type(), CHECK_VERIFY(this));
2226   } else if (tag.is_long()) {
2227     current_frame-&gt;push_stack_2(
2228       VerificationType::long_type(),
2229       VerificationType::long2_type(), CHECK_VERIFY(this));
2230   } else if (tag.is_method_handle()) {
2231     current_frame-&gt;push_stack(
2232       VerificationType::reference_type(
2233         vmSymbols::java_lang_invoke_MethodHandle()), CHECK_VERIFY(this));
2234   } else if (tag.is_method_type()) {
2235     current_frame-&gt;push_stack(
2236       VerificationType::reference_type(
2237         vmSymbols::java_lang_invoke_MethodType()), CHECK_VERIFY(this));
2238   } else if (tag.is_dynamic_constant()) {
2239     Symbol* constant_type = cp-&gt;uncached_signature_ref_at(index);
2240     // Field signature was checked in ClassFileParser.
2241     assert(SignatureVerifier::is_valid_type_signature(constant_type),
2242            &quot;Invalid type for dynamic constant&quot;);
2243     assert(sizeof(VerificationType) == sizeof(uintptr_t),
2244           &quot;buffer type must match VerificationType size&quot;);
2245     uintptr_t constant_type_buffer[2];
2246     VerificationType* v_constant_type = (VerificationType*)constant_type_buffer;
2247     SignatureStream sig_stream(constant_type, false);
2248     int n = change_sig_to_verificationType(&amp;sig_stream, v_constant_type);
2249     int opcode_n = (opcode == Bytecodes::_ldc2_w ? 2 : 1);
2250     if (n != opcode_n) {
2251       // wrong kind of ldc; reverify against updated type mask
2252       types &amp;= ~(1 &lt;&lt; JVM_CONSTANT_Dynamic);
2253       verify_cp_type(bci, index, cp, types, CHECK_VERIFY(this));
2254     }
2255     for (int i = 0; i &lt; n; i++) {
2256       current_frame-&gt;push_stack(v_constant_type[i], CHECK_VERIFY(this));
2257     }
2258   } else {
2259     /* Unreachable? verify_cp_type has already validated the cp type. */
2260     verify_error(
2261         ErrorContext::bad_cp_index(bci, index), &quot;Invalid index in ldc&quot;);
2262     return;
2263   }
2264 }
2265 
2266 void ClassVerifier::verify_switch(
2267     RawBytecodeStream* bcs, u4 code_length, char* code_data,
2268     StackMapFrame* current_frame, StackMapTable* stackmap_table, TRAPS) {
2269   int bci = bcs-&gt;bci();
2270   address bcp = bcs-&gt;bcp();
2271   address aligned_bcp = align_up(bcp + 1, jintSize);
2272 
2273   if (_klass-&gt;major_version() &lt; NONZERO_PADDING_BYTES_IN_SWITCH_MAJOR_VERSION) {
2274     // 4639449 &amp; 4647081: padding bytes must be 0
2275     u2 padding_offset = 1;
2276     while ((bcp + padding_offset) &lt; aligned_bcp) {
2277       if(*(bcp + padding_offset) != 0) {
2278         verify_error(ErrorContext::bad_code(bci),
2279                      &quot;Nonzero padding byte in lookupswitch or tableswitch&quot;);
2280         return;
2281       }
2282       padding_offset++;
2283     }
2284   }
2285 
2286   int default_offset = (int) Bytes::get_Java_u4(aligned_bcp);
2287   int keys, delta;
2288   current_frame-&gt;pop_stack(
2289     VerificationType::integer_type(), CHECK_VERIFY(this));
2290   if (bcs-&gt;raw_code() == Bytecodes::_tableswitch) {
2291     jint low = (jint)Bytes::get_Java_u4(aligned_bcp + jintSize);
2292     jint high = (jint)Bytes::get_Java_u4(aligned_bcp + 2*jintSize);
2293     if (low &gt; high) {
2294       verify_error(ErrorContext::bad_code(bci),
2295           &quot;low must be less than or equal to high in tableswitch&quot;);
2296       return;
2297     }
2298     keys = high - low + 1;
2299     if (keys &lt; 0) {
2300       verify_error(ErrorContext::bad_code(bci), &quot;too many keys in tableswitch&quot;);
2301       return;
2302     }
2303     delta = 1;
2304   } else {
2305     keys = (int)Bytes::get_Java_u4(aligned_bcp + jintSize);
2306     if (keys &lt; 0) {
2307       verify_error(ErrorContext::bad_code(bci),
2308                    &quot;number of keys in lookupswitch less than 0&quot;);
2309       return;
2310     }
2311     delta = 2;
2312     // Make sure that the lookupswitch items are sorted
2313     for (int i = 0; i &lt; (keys - 1); i++) {
2314       jint this_key = Bytes::get_Java_u4(aligned_bcp + (2+2*i)*jintSize);
2315       jint next_key = Bytes::get_Java_u4(aligned_bcp + (2+2*i+2)*jintSize);
2316       if (this_key &gt;= next_key) {
2317         verify_error(ErrorContext::bad_code(bci),
2318                      &quot;Bad lookupswitch instruction&quot;);
2319         return;
2320       }
2321     }
2322   }
2323   int target = bci + default_offset;
2324   stackmap_table-&gt;check_jump_target(current_frame, target, CHECK_VERIFY(this));
2325   for (int i = 0; i &lt; keys; i++) {
2326     // Because check_jump_target() may safepoint, the bytecode could have
2327     // moved, which means &#39;aligned_bcp&#39; is no good and needs to be recalculated.
2328     aligned_bcp = align_up(bcs-&gt;bcp() + 1, jintSize);
2329     target = bci + (jint)Bytes::get_Java_u4(aligned_bcp+(3+i*delta)*jintSize);
2330     stackmap_table-&gt;check_jump_target(
2331       current_frame, target, CHECK_VERIFY(this));
2332   }
2333   NOT_PRODUCT(aligned_bcp = NULL);  // no longer valid at this point
2334 }
2335 
2336 bool ClassVerifier::name_in_supers(
2337     Symbol* ref_name, InstanceKlass* current) {
2338   Klass* super = current-&gt;super();
2339   while (super != NULL) {
2340     if (super-&gt;name() == ref_name) {
2341       return true;
2342     }
2343     super = super-&gt;super();
2344   }
2345   return false;
2346 }
2347 
2348 void ClassVerifier::verify_field_instructions(RawBytecodeStream* bcs,
2349                                               StackMapFrame* current_frame,
2350                                               const constantPoolHandle&amp; cp,
2351                                               bool allow_arrays,
2352                                               TRAPS) {
2353   u2 index = bcs-&gt;get_index_u2();
2354   verify_cp_type(bcs-&gt;bci(), index, cp,
2355       1 &lt;&lt; JVM_CONSTANT_Fieldref, CHECK_VERIFY(this));
2356 
2357   // Get field name and signature
2358   Symbol* field_name = cp-&gt;name_ref_at(index);
2359   Symbol* field_sig = cp-&gt;signature_ref_at(index);
2360 
2361   // Field signature was checked in ClassFileParser.
2362   assert(SignatureVerifier::is_valid_type_signature(field_sig),
2363          &quot;Invalid field signature&quot;);
2364 
2365   // Get referenced class type
2366   VerificationType ref_class_type = cp_ref_index_to_type(
2367     index, cp, CHECK_VERIFY(this));
2368   if (!ref_class_type.is_object() &amp;&amp;
2369       (!allow_arrays || !ref_class_type.is_array())) {
2370     verify_error(ErrorContext::bad_type(bcs-&gt;bci(),
2371         TypeOrigin::cp(index, ref_class_type)),
2372         &quot;Expecting reference to class in class %s at constant pool index %d&quot;,
2373         _klass-&gt;external_name(), index);
2374     return;
2375   }
2376 
2377   VerificationType target_class_type = ref_class_type;
2378 
2379   assert(sizeof(VerificationType) == sizeof(uintptr_t),
2380         &quot;buffer type must match VerificationType size&quot;);
2381   uintptr_t field_type_buffer[2];
2382   VerificationType* field_type = (VerificationType*)field_type_buffer;
2383   // If we make a VerificationType[2] array directly, the compiler calls
2384   // to the c-runtime library to do the allocation instead of just
2385   // stack allocating it.  Plus it would run constructors.  This shows up
2386   // in performance profiles.
2387 
2388   SignatureStream sig_stream(field_sig, false);
2389   VerificationType stack_object_type;
2390   int n = change_sig_to_verificationType(&amp;sig_stream, field_type);
2391   u2 bci = bcs-&gt;bci();
2392   bool is_assignable;
2393   switch (bcs-&gt;raw_code()) {
2394     case Bytecodes::_getstatic: {
2395       for (int i = 0; i &lt; n; i++) {
2396         current_frame-&gt;push_stack(field_type[i], CHECK_VERIFY(this));
2397       }
2398       break;
2399     }
2400     case Bytecodes::_putstatic: {
2401       for (int i = n - 1; i &gt;= 0; i--) {
2402         current_frame-&gt;pop_stack(field_type[i], CHECK_VERIFY(this));
2403       }
2404       break;
2405     }
2406     case Bytecodes::_withfield: {
2407       for (int i = n - 1; i &gt;= 0; i--) {
2408         current_frame-&gt;pop_stack(field_type[i], CHECK_VERIFY(this));
2409       }
2410       // stack_object_type and target_class_type must be the same inline type.
2411       stack_object_type =
2412         current_frame-&gt;pop_stack(VerificationType::inline_type_check(), CHECK_VERIFY(this));
2413       VerificationType target_inline_type =
2414         VerificationType::change_ref_to_inline_type(target_class_type);
2415       if (!stack_object_type.equals(target_inline_type)) {
2416         verify_error(ErrorContext::bad_inline_type(bci,
2417             current_frame-&gt;stack_top_ctx(),
2418             TypeOrigin::cp(index, target_class_type)),
2419             &quot;Invalid type on operand stack in withfield instruction&quot;);
2420         return;
2421       }
2422       current_frame-&gt;push_stack(target_inline_type, CHECK_VERIFY(this));
2423       break;
2424     }
2425     case Bytecodes::_getfield: {
2426       stack_object_type = current_frame-&gt;pop_stack(
2427         target_class_type, CHECK_VERIFY(this));
2428       for (int i = 0; i &lt; n; i++) {
2429         current_frame-&gt;push_stack(field_type[i], CHECK_VERIFY(this));
2430       }
2431       goto check_protected;
2432     }
2433     case Bytecodes::_putfield: {
2434       for (int i = n - 1; i &gt;= 0; i--) {
2435         current_frame-&gt;pop_stack(field_type[i], CHECK_VERIFY(this));
2436       }
2437       stack_object_type = current_frame-&gt;pop_stack(CHECK_VERIFY(this));
2438 
2439       // The JVMS 2nd edition allows field initialization before the superclass
2440       // initializer, if the field is defined within the current class.
2441       fieldDescriptor fd;
2442       if (stack_object_type == VerificationType::uninitialized_this_type() &amp;&amp;
2443           target_class_type.equals(current_type()) &amp;&amp;
2444           _klass-&gt;find_local_field(field_name, field_sig, &amp;fd)) {
2445         stack_object_type = current_type();
2446       }
2447       is_assignable = target_class_type.is_assignable_from(
2448         stack_object_type, this, false, CHECK_VERIFY(this));
2449       if (!is_assignable) {
2450         verify_error(ErrorContext::bad_type(bci,
2451             current_frame-&gt;stack_top_ctx(),
2452             TypeOrigin::cp(index, target_class_type)),
2453             &quot;Bad type on operand stack in putfield&quot;);
2454         return;
2455       }
2456     }
2457     check_protected: {
2458       if (_this_type == stack_object_type)
2459         break; // stack_object_type must be assignable to _current_class_type
2460       if (was_recursively_verified()) return;
2461       Symbol* ref_class_name =
2462         cp-&gt;klass_name_at(cp-&gt;klass_ref_index_at(index));
2463       if (!name_in_supers(ref_class_name, current_class()))
2464         // stack_object_type must be assignable to _current_class_type since:
2465         // 1. stack_object_type must be assignable to ref_class.
2466         // 2. ref_class must be _current_class or a subclass of it. It can&#39;t
2467         //    be a superclass of it. See revised JVMS 5.4.4.
2468         break;
2469 
2470       Klass* ref_class_oop = load_class(ref_class_name, CHECK);
2471       if (is_protected_access(current_class(), ref_class_oop, field_name,
2472                               field_sig, false)) {
2473         // It&#39;s protected access, check if stack object is assignable to
2474         // current class.
2475         is_assignable = current_type().is_assignable_from(
2476           stack_object_type, this, true, CHECK_VERIFY(this));
2477         if (!is_assignable) {
2478           verify_error(ErrorContext::bad_type(bci,
2479               current_frame-&gt;stack_top_ctx(),
2480               TypeOrigin::implicit(current_type())),
2481               &quot;Bad access to protected data in getfield&quot;);
2482           return;
2483         }
2484       }
2485       break;
2486     }
2487     default: ShouldNotReachHere();
2488   }
2489 }
2490 
2491 // Look at the method&#39;s handlers.  If the bci is in the handler&#39;s try block
2492 // then check if the handler_pc is already on the stack.  If not, push it
2493 // unless the handler has already been scanned.
2494 void ClassVerifier::push_handlers(ExceptionTable* exhandlers,
2495                                   GrowableArray&lt;u4&gt;* handler_list,
2496                                   GrowableArray&lt;u4&gt;* handler_stack,
2497                                   u4 bci) {
2498   int exlength = exhandlers-&gt;length();
2499   for(int x = 0; x &lt; exlength; x++) {
2500     if (bci &gt;= exhandlers-&gt;start_pc(x) &amp;&amp; bci &lt; exhandlers-&gt;end_pc(x)) {
2501       u4 exhandler_pc = exhandlers-&gt;handler_pc(x);
2502       if (!handler_list-&gt;contains(exhandler_pc)) {
2503         handler_stack-&gt;append_if_missing(exhandler_pc);
2504         handler_list-&gt;append(exhandler_pc);
2505       }
2506     }
2507   }
2508 }
2509 
2510 // Return TRUE if all code paths starting with start_bc_offset end in
2511 // bytecode athrow or loop.
2512 bool ClassVerifier::ends_in_athrow(u4 start_bc_offset) {
2513   ResourceMark rm;
2514   // Create bytecode stream.
2515   RawBytecodeStream bcs(method());
2516   u4 code_length = method()-&gt;code_size();
2517   bcs.set_start(start_bc_offset);
2518   u4 target;
2519   // Create stack for storing bytecode start offsets for if* and *switch.
2520   GrowableArray&lt;u4&gt;* bci_stack = new GrowableArray&lt;u4&gt;(30);
2521   // Create stack for handlers for try blocks containing this handler.
2522   GrowableArray&lt;u4&gt;* handler_stack = new GrowableArray&lt;u4&gt;(30);
2523   // Create list of handlers that have been pushed onto the handler_stack
2524   // so that handlers embedded inside of their own TRY blocks only get
2525   // scanned once.
2526   GrowableArray&lt;u4&gt;* handler_list = new GrowableArray&lt;u4&gt;(30);
2527   // Create list of visited branch opcodes (goto* and if*).
2528   GrowableArray&lt;u4&gt;* visited_branches = new GrowableArray&lt;u4&gt;(30);
2529   ExceptionTable exhandlers(_method());
2530 
2531   while (true) {
2532     if (bcs.is_last_bytecode()) {
2533       // if no more starting offsets to parse or if at the end of the
2534       // method then return false.
2535       if ((bci_stack-&gt;is_empty()) || ((u4)bcs.end_bci() == code_length))
2536         return false;
2537       // Pop a bytecode starting offset and scan from there.
2538       bcs.set_start(bci_stack-&gt;pop());
2539     }
2540     Bytecodes::Code opcode = bcs.raw_next();
2541     u4 bci = bcs.bci();
2542 
2543     // If the bytecode is in a TRY block, push its handlers so they
2544     // will get parsed.
2545     push_handlers(&amp;exhandlers, handler_list, handler_stack, bci);
2546 
2547     switch (opcode) {
2548       case Bytecodes::_if_icmpeq:
2549       case Bytecodes::_if_icmpne:
2550       case Bytecodes::_if_icmplt:
2551       case Bytecodes::_if_icmpge:
2552       case Bytecodes::_if_icmpgt:
2553       case Bytecodes::_if_icmple:
2554       case Bytecodes::_ifeq:
2555       case Bytecodes::_ifne:
2556       case Bytecodes::_iflt:
2557       case Bytecodes::_ifge:
2558       case Bytecodes::_ifgt:
2559       case Bytecodes::_ifle:
2560       case Bytecodes::_if_acmpeq:
2561       case Bytecodes::_if_acmpne:
2562       case Bytecodes::_ifnull:
2563       case Bytecodes::_ifnonnull:
2564         target = bcs.dest();
2565         if (visited_branches-&gt;contains(bci)) {
2566           if (bci_stack-&gt;is_empty()) {
2567             if (handler_stack-&gt;is_empty()) {
2568               return true;
2569             } else {
2570               // Parse the catch handlers for try blocks containing athrow.
2571               bcs.set_start(handler_stack-&gt;pop());
2572             }
2573           } else {
2574             // Pop a bytecode starting offset and scan from there.
2575             bcs.set_start(bci_stack-&gt;pop());
2576           }
2577         } else {
2578           if (target &gt; bci) { // forward branch
2579             if (target &gt;= code_length) return false;
2580             // Push the branch target onto the stack.
2581             bci_stack-&gt;push(target);
2582             // then, scan bytecodes starting with next.
2583             bcs.set_start(bcs.next_bci());
2584           } else { // backward branch
2585             // Push bytecode offset following backward branch onto the stack.
2586             bci_stack-&gt;push(bcs.next_bci());
2587             // Check bytecodes starting with branch target.
2588             bcs.set_start(target);
2589           }
2590           // Record target so we don&#39;t branch here again.
2591           visited_branches-&gt;append(bci);
2592         }
2593         break;
2594 
2595       case Bytecodes::_goto:
2596       case Bytecodes::_goto_w:
2597         target = (opcode == Bytecodes::_goto ? bcs.dest() : bcs.dest_w());
2598         if (visited_branches-&gt;contains(bci)) {
2599           if (bci_stack-&gt;is_empty()) {
2600             if (handler_stack-&gt;is_empty()) {
2601               return true;
2602             } else {
2603               // Parse the catch handlers for try blocks containing athrow.
2604               bcs.set_start(handler_stack-&gt;pop());
2605             }
2606           } else {
2607             // Been here before, pop new starting offset from stack.
2608             bcs.set_start(bci_stack-&gt;pop());
2609           }
2610         } else {
2611           if (target &gt;= code_length) return false;
2612           // Continue scanning from the target onward.
2613           bcs.set_start(target);
2614           // Record target so we don&#39;t branch here again.
2615           visited_branches-&gt;append(bci);
2616         }
2617         break;
2618 
2619       // Check that all switch alternatives end in &#39;athrow&#39; bytecodes. Since it
2620       // is  difficult to determine where each switch alternative ends, parse
2621       // each switch alternative until either hit a &#39;return&#39;, &#39;athrow&#39;, or reach
2622       // the end of the method&#39;s bytecodes.  This is gross but should be okay
2623       // because:
2624       // 1. tableswitch and lookupswitch byte codes in handlers for ctor explicit
2625       //    constructor invocations should be rare.
2626       // 2. if each switch alternative ends in an athrow then the parsing should be
2627       //    short.  If there is no athrow then it is bogus code, anyway.
2628       case Bytecodes::_lookupswitch:
2629       case Bytecodes::_tableswitch:
2630         {
2631           address aligned_bcp = align_up(bcs.bcp() + 1, jintSize);
2632           u4 default_offset = Bytes::get_Java_u4(aligned_bcp) + bci;
2633           int keys, delta;
2634           if (opcode == Bytecodes::_tableswitch) {
2635             jint low = (jint)Bytes::get_Java_u4(aligned_bcp + jintSize);
2636             jint high = (jint)Bytes::get_Java_u4(aligned_bcp + 2*jintSize);
2637             // This is invalid, but let the regular bytecode verifier
2638             // report this because the user will get a better error message.
2639             if (low &gt; high) return true;
2640             keys = high - low + 1;
2641             delta = 1;
2642           } else {
2643             keys = (int)Bytes::get_Java_u4(aligned_bcp + jintSize);
2644             delta = 2;
2645           }
2646           // Invalid, let the regular bytecode verifier deal with it.
2647           if (keys &lt; 0) return true;
2648 
2649           // Push the offset of the next bytecode onto the stack.
2650           bci_stack-&gt;push(bcs.next_bci());
2651 
2652           // Push the switch alternatives onto the stack.
2653           for (int i = 0; i &lt; keys; i++) {
2654             u4 target = bci + (jint)Bytes::get_Java_u4(aligned_bcp+(3+i*delta)*jintSize);
2655             if (target &gt; code_length) return false;
2656             bci_stack-&gt;push(target);
2657           }
2658 
2659           // Start bytecode parsing for the switch at the default alternative.
2660           if (default_offset &gt; code_length) return false;
2661           bcs.set_start(default_offset);
2662           break;
2663         }
2664 
2665       case Bytecodes::_return:
2666         return false;
2667 
2668       case Bytecodes::_athrow:
2669         {
2670           if (bci_stack-&gt;is_empty()) {
2671             if (handler_stack-&gt;is_empty()) {
2672               return true;
2673             } else {
2674               // Parse the catch handlers for try blocks containing athrow.
2675               bcs.set_start(handler_stack-&gt;pop());
2676             }
2677           } else {
2678             // Pop a bytecode offset and starting scanning from there.
2679             bcs.set_start(bci_stack-&gt;pop());
2680           }
2681         }
2682         break;
2683 
2684       default:
2685         ;
2686     } // end switch
2687   } // end while loop
2688 
2689   return false;
2690 }
2691 
2692 void ClassVerifier::verify_invoke_init(
2693     RawBytecodeStream* bcs, u2 ref_class_index, VerificationType ref_class_type,
2694     StackMapFrame* current_frame, u4 code_length, bool in_try_block,
2695     bool *this_uninit, const constantPoolHandle&amp; cp, StackMapTable* stackmap_table,
2696     TRAPS) {
2697   u2 bci = bcs-&gt;bci();
2698   VerificationType type = current_frame-&gt;pop_stack(
2699     VerificationType::reference_check(), CHECK_VERIFY(this));
2700   if (type == VerificationType::uninitialized_this_type()) {
2701     // The method must be an &lt;init&gt; method of this class or its superclass
2702     Klass* superk = current_class()-&gt;super();
2703     if (ref_class_type.name() != current_class()-&gt;name() &amp;&amp;
2704         ref_class_type.name() != superk-&gt;name()) {
2705       verify_error(ErrorContext::bad_type(bci,
2706           TypeOrigin::implicit(ref_class_type),
2707           TypeOrigin::implicit(current_type())),
2708           &quot;Bad &lt;init&gt; method call&quot;);
2709       return;
2710     }
2711 
2712     // If this invokespecial call is done from inside of a TRY block then make
2713     // sure that all catch clause paths end in a throw.  Otherwise, this can
2714     // result in returning an incomplete object.
2715     if (in_try_block) {
2716       ExceptionTable exhandlers(_method());
2717       int exlength = exhandlers.length();
2718       for(int i = 0; i &lt; exlength; i++) {
2719         u2 start_pc = exhandlers.start_pc(i);
2720         u2 end_pc = exhandlers.end_pc(i);
2721 
2722         if (bci &gt;= start_pc &amp;&amp; bci &lt; end_pc) {
2723           if (!ends_in_athrow(exhandlers.handler_pc(i))) {
2724             verify_error(ErrorContext::bad_code(bci),
2725               &quot;Bad &lt;init&gt; method call from after the start of a try block&quot;);
2726             return;
2727           } else if (log_is_enabled(Debug, verification)) {
2728             ResourceMark rm(THREAD);
2729             log_debug(verification)(&quot;Survived call to ends_in_athrow(): %s&quot;,
2730                                           current_class()-&gt;name()-&gt;as_C_string());
2731           }
2732         }
2733       }
2734 
2735       // Check the exception handler target stackmaps with the locals from the
2736       // incoming stackmap (before initialize_object() changes them to outgoing
2737       // state).
2738       if (was_recursively_verified()) return;
2739       verify_exception_handler_targets(bci, true, current_frame,
2740                                        stackmap_table, CHECK_VERIFY(this));
2741     } // in_try_block
2742 
2743     current_frame-&gt;initialize_object(type, current_type());
2744     *this_uninit = true;
2745   } else if (type.is_uninitialized()) {
2746     u2 new_offset = type.bci();
2747     address new_bcp = bcs-&gt;bcp() - bci + new_offset;
2748     if (new_offset &gt; (code_length - 3) || (*new_bcp) != Bytecodes::_new) {
2749       /* Unreachable?  Stack map parsing ensures valid type and new
2750        * instructions have a valid BCI. */
2751       verify_error(ErrorContext::bad_code(new_offset),
2752                    &quot;Expecting new instruction&quot;);
2753       return;
2754     }
2755     u2 new_class_index = Bytes::get_Java_u2(new_bcp + 1);
2756     if (was_recursively_verified()) return;
2757     verify_cp_class_type(bci, new_class_index, cp, CHECK_VERIFY(this));
2758 
2759     // The method must be an &lt;init&gt; method of the indicated class
2760     VerificationType new_class_type = cp_index_to_type(
2761       new_class_index, cp, CHECK_VERIFY(this));
2762     if (!new_class_type.equals(ref_class_type)) {
2763       verify_error(ErrorContext::bad_type(bci,
2764           TypeOrigin::cp(new_class_index, new_class_type),
2765           TypeOrigin::cp(ref_class_index, ref_class_type)),
2766           &quot;Call to wrong &lt;init&gt; method&quot;);
2767       return;
2768     }
2769     // According to the VM spec, if the referent class is a superclass of the
2770     // current class, and is in a different runtime package, and the method is
2771     // protected, then the objectref must be the current class or a subclass
2772     // of the current class.
2773     VerificationType objectref_type = new_class_type;
2774     if (name_in_supers(ref_class_type.name(), current_class())) {
2775       Klass* ref_klass = load_class(ref_class_type.name(), CHECK);
2776       if (was_recursively_verified()) return;
2777       Method* m = InstanceKlass::cast(ref_klass)-&gt;uncached_lookup_method(
2778         vmSymbols::object_initializer_name(),
2779         cp-&gt;signature_ref_at(bcs-&gt;get_index_u2()),
2780         Klass::find_overpass);
2781       // Do nothing if method is not found.  Let resolution detect the error.
2782       if (m != NULL) {
2783         InstanceKlass* mh = m-&gt;method_holder();
2784         if (m-&gt;is_protected() &amp;&amp; !mh-&gt;is_same_class_package(_klass)) {
2785           bool assignable = current_type().is_assignable_from(
2786             objectref_type, this, true, CHECK_VERIFY(this));
2787           if (!assignable) {
2788             verify_error(ErrorContext::bad_type(bci,
2789                 TypeOrigin::cp(new_class_index, objectref_type),
2790                 TypeOrigin::implicit(current_type())),
2791                 &quot;Bad access to protected &lt;init&gt; method&quot;);
2792             return;
2793           }
2794         }
2795       }
2796     }
2797     // Check the exception handler target stackmaps with the locals from the
2798     // incoming stackmap (before initialize_object() changes them to outgoing
2799     // state).
2800     if (in_try_block) {
2801       if (was_recursively_verified()) return;
2802       verify_exception_handler_targets(bci, *this_uninit, current_frame,
2803                                        stackmap_table, CHECK_VERIFY(this));
2804     }
2805     current_frame-&gt;initialize_object(type, new_class_type);
2806   } else {
2807     verify_error(ErrorContext::bad_type(bci, current_frame-&gt;stack_top_ctx()),
2808         &quot;Bad operand type when invoking &lt;init&gt;&quot;);
2809     return;
2810   }
2811 }
2812 
2813 bool ClassVerifier::is_same_or_direct_interface(
2814     InstanceKlass* klass,
2815     VerificationType klass_type,
2816     VerificationType ref_class_type) {
2817   if (ref_class_type.equals(klass_type)) return true;
2818   Array&lt;InstanceKlass*&gt;* local_interfaces = klass-&gt;local_interfaces();
2819   if (local_interfaces != NULL) {
2820     for (int x = 0; x &lt; local_interfaces-&gt;length(); x++) {
2821       InstanceKlass* k = local_interfaces-&gt;at(x);
2822       assert (k != NULL &amp;&amp; k-&gt;is_interface(), &quot;invalid interface&quot;);
2823       if (ref_class_type.equals(VerificationType::reference_type(k-&gt;name()))) {
2824         return true;
2825       }
2826     }
2827   }
2828   return false;
2829 }
2830 
2831 void ClassVerifier::verify_invoke_instructions(
2832     RawBytecodeStream* bcs, u4 code_length, StackMapFrame* current_frame,
2833     bool in_try_block, bool *this_uninit,
2834     const constantPoolHandle&amp; cp, StackMapTable* stackmap_table, TRAPS) {
2835   // Make sure the constant pool item is the right type
2836   u2 index = bcs-&gt;get_index_u2();
2837   Bytecodes::Code opcode = bcs-&gt;raw_code();
2838   unsigned int types = 0;
2839   switch (opcode) {
2840     case Bytecodes::_invokeinterface:
2841       types = 1 &lt;&lt; JVM_CONSTANT_InterfaceMethodref;
2842       break;
2843     case Bytecodes::_invokedynamic:
2844       types = 1 &lt;&lt; JVM_CONSTANT_InvokeDynamic;
2845       break;
2846     case Bytecodes::_invokespecial:
2847     case Bytecodes::_invokestatic:
2848       types = (_klass-&gt;major_version() &lt; STATIC_METHOD_IN_INTERFACE_MAJOR_VERSION) ?
2849         (1 &lt;&lt; JVM_CONSTANT_Methodref) :
2850         ((1 &lt;&lt; JVM_CONSTANT_InterfaceMethodref) | (1 &lt;&lt; JVM_CONSTANT_Methodref));
2851       break;
2852     default:
2853       types = 1 &lt;&lt; JVM_CONSTANT_Methodref;
2854   }
2855   verify_cp_type(bcs-&gt;bci(), index, cp, types, CHECK_VERIFY(this));
2856 
2857   // Get method name and signature
2858   Symbol* method_name = cp-&gt;name_ref_at(index);
2859   Symbol* method_sig = cp-&gt;signature_ref_at(index);
2860 
2861   // Method signature was checked in ClassFileParser.
2862   assert(SignatureVerifier::is_valid_method_signature(method_sig),
2863          &quot;Invalid method signature&quot;);
2864 
2865   // Get referenced class
2866   VerificationType ref_class_type;
2867   if (opcode == Bytecodes::_invokedynamic) {
2868     if (_klass-&gt;major_version() &lt; Verifier::INVOKEDYNAMIC_MAJOR_VERSION) {
2869       class_format_error(
2870         &quot;invokedynamic instructions not supported by this class file version (%d), class %s&quot;,
2871         _klass-&gt;major_version(), _klass-&gt;external_name());
2872       return;
2873     }
2874   } else {
2875     ref_class_type = cp_ref_index_to_type(index, cp, CHECK_VERIFY(this));
2876   }
2877 
2878   assert(sizeof(VerificationType) == sizeof(uintptr_t),
2879         &quot;buffer type must match VerificationType size&quot;);
2880 
2881   // Get the UTF8 index for this signature.
2882   int sig_index = cp-&gt;signature_ref_index_at(cp-&gt;name_and_type_ref_index_at(index));
2883 
2884   // Get the signature&#39;s verification types.
2885   sig_as_verification_types* mth_sig_verif_types;
2886   sig_as_verification_types** mth_sig_verif_types_ptr = method_signatures_table()-&gt;get(sig_index);
2887   if (mth_sig_verif_types_ptr != NULL) {
2888     // Found the entry for the signature&#39;s verification types in the hash table.
2889     mth_sig_verif_types = *mth_sig_verif_types_ptr;
2890     assert(mth_sig_verif_types != NULL, &quot;Unexpected NULL sig_as_verification_types value&quot;);
2891   } else {
2892     // Not found, add the entry to the table.
2893     GrowableArray&lt;VerificationType&gt;* verif_types = new GrowableArray&lt;VerificationType&gt;(10);
2894     mth_sig_verif_types = new sig_as_verification_types(verif_types);
2895     create_method_sig_entry(mth_sig_verif_types, sig_index, CHECK_VERIFY(this));
2896   }
2897 
2898   // Get the number of arguments for this signature.
2899   int nargs = mth_sig_verif_types-&gt;num_args();
2900 
2901   // Check instruction operands
2902   u2 bci = bcs-&gt;bci();
2903   if (opcode == Bytecodes::_invokeinterface) {
2904     address bcp = bcs-&gt;bcp();
2905     // 4905268: count operand in invokeinterface should be nargs+1, not nargs.
2906     // JSR202 spec: The count operand of an invokeinterface instruction is valid if it is
2907     // the difference between the size of the operand stack before and after the instruction
2908     // executes.
2909     if (*(bcp+3) != (nargs+1)) {
2910       verify_error(ErrorContext::bad_code(bci),
2911           &quot;Inconsistent args count operand in invokeinterface&quot;);
2912       return;
2913     }
2914     if (*(bcp+4) != 0) {
2915       verify_error(ErrorContext::bad_code(bci),
2916           &quot;Fourth operand byte of invokeinterface must be zero&quot;);
2917       return;
2918     }
2919   }
2920 
2921   if (opcode == Bytecodes::_invokedynamic) {
2922     address bcp = bcs-&gt;bcp();
2923     if (*(bcp+3) != 0 || *(bcp+4) != 0) {
2924       verify_error(ErrorContext::bad_code(bci),
2925           &quot;Third and fourth operand bytes of invokedynamic must be zero&quot;);
2926       return;
2927     }
2928   }
2929 
2930   if (method_name-&gt;char_at(0) == JVM_SIGNATURE_SPECIAL) {
2931     // Make sure &lt;init&gt; can only be invoked by invokespecial or invokestatic.
2932     // The allowed invocation mode of &lt;init&gt; depends on its signature.
2933     if ((opcode != Bytecodes::_invokespecial &amp;&amp;
2934          opcode != Bytecodes::_invokestatic) ||
2935         method_name != vmSymbols::object_initializer_name()) {
2936       verify_error(ErrorContext::bad_code(bci),
2937           &quot;Illegal call to internal method&quot;);
2938       return;
2939     }
2940   } else if (opcode == Bytecodes::_invokespecial
2941              &amp;&amp; !is_same_or_direct_interface(current_class(), current_type(), ref_class_type)
2942              &amp;&amp; !ref_class_type.equals(VerificationType::reference_type(
2943                   current_class()-&gt;super()-&gt;name()))) { // super() can never be an inline_type.
2944     bool subtype = false;
2945     bool have_imr_indirect = cp-&gt;tag_at(index).value() == JVM_CONSTANT_InterfaceMethodref;
2946     if (!current_class()-&gt;is_unsafe_anonymous()) {
2947       subtype = ref_class_type.is_assignable_from(
2948                  current_type(), this, false, CHECK_VERIFY(this));
2949     } else {
2950       InstanceKlass* unsafe_host = current_class()-&gt;unsafe_anonymous_host();
2951       VerificationType unsafe_anonymous_host_type = reference_or_inline_type(unsafe_host);
2952       subtype = ref_class_type.is_assignable_from(unsafe_anonymous_host_type, this, false, CHECK_VERIFY(this));
2953 
2954       // If invokespecial of IMR, need to recheck for same or
2955       // direct interface relative to the host class
2956       have_imr_indirect = (have_imr_indirect &amp;&amp;
2957                            !is_same_or_direct_interface(
2958                              unsafe_host,
2959                              unsafe_anonymous_host_type, ref_class_type));
2960     }
2961     if (!subtype) {
2962       verify_error(ErrorContext::bad_code(bci),
2963           &quot;Bad invokespecial instruction: &quot;
2964           &quot;current class isn&#39;t assignable to reference class.&quot;);
2965        return;
2966     } else if (have_imr_indirect) {
2967       verify_error(ErrorContext::bad_code(bci),
2968           &quot;Bad invokespecial instruction: &quot;
2969           &quot;interface method reference is in an indirect superinterface.&quot;);
2970       return;
2971     }
2972 
2973   }
2974 
2975   // Get the verification types for the method&#39;s arguments.
2976   GrowableArray&lt;VerificationType&gt;* sig_verif_types = mth_sig_verif_types-&gt;sig_verif_types();
2977   assert(sig_verif_types != NULL, &quot;Missing signature&#39;s array of verification types&quot;);
2978   // Match method descriptor with operand stack
2979   // The arguments are on the stack in descending order.
2980   for (int i = nargs - 1; i &gt;= 0; i--) { // Run backwards
2981     current_frame-&gt;pop_stack(sig_verif_types-&gt;at(i), CHECK_VERIFY(this));
2982   }
2983 
2984   // Check objectref on operand stack
2985   if (opcode != Bytecodes::_invokestatic &amp;&amp;
2986       opcode != Bytecodes::_invokedynamic) {
2987     if (method_name == vmSymbols::object_initializer_name()) {  // &lt;init&gt; method
2988       // (use of &lt;init&gt; as a static factory is handled under invokestatic)
2989       verify_invoke_init(bcs, index, ref_class_type, current_frame,
2990         code_length, in_try_block, this_uninit, cp, stackmap_table,
2991         CHECK_VERIFY(this));
2992       if (was_recursively_verified()) return;
2993     } else {   // other methods
2994       // Ensures that target class is assignable to method class.
2995       if (opcode == Bytecodes::_invokespecial) {
2996         if (!current_class()-&gt;is_unsafe_anonymous()) {
2997           current_frame-&gt;pop_stack(current_type(), CHECK_VERIFY(this));
2998         } else {
2999           // anonymous class invokespecial calls: check if the
3000           // objectref is a subtype of the unsafe_anonymous_host of the current class
3001           // to allow an anonymous class to reference methods in the unsafe_anonymous_host
3002           VerificationType top = current_frame-&gt;pop_stack(CHECK_VERIFY(this));
3003 
3004           InstanceKlass* unsafe_host = current_class()-&gt;unsafe_anonymous_host();
3005           VerificationType host_type = reference_or_inline_type(unsafe_host);
3006           bool subtype = host_type.is_assignable_from(top, this, false, CHECK_VERIFY(this));
3007           if (!subtype) {
3008             verify_error( ErrorContext::bad_type(current_frame-&gt;offset(),
3009               current_frame-&gt;stack_top_ctx(),
3010               TypeOrigin::implicit(top)),
3011               &quot;Bad type on operand stack&quot;);
3012             return;
3013           }
3014         }
3015       } else if (opcode == Bytecodes::_invokevirtual) {
3016         VerificationType stack_object_type =
3017           current_frame-&gt;pop_stack(ref_class_type, CHECK_VERIFY(this));
3018         if (current_type() != stack_object_type) {
3019           if (was_recursively_verified()) return;
3020           assert(cp-&gt;cache() == NULL, &quot;not rewritten yet&quot;);
3021           Symbol* ref_class_name =
3022             cp-&gt;klass_name_at(cp-&gt;klass_ref_index_at(index));
3023           // See the comments in verify_field_instructions() for
3024           // the rationale behind this.
3025           if (name_in_supers(ref_class_name, current_class())) {
3026             Klass* ref_class = load_class(ref_class_name, CHECK);
3027             if (is_protected_access(
3028                   _klass, ref_class, method_name, method_sig, true)) {
3029               // It&#39;s protected access, check if stack object is
3030               // assignable to current class.
3031               bool is_assignable = current_type().is_assignable_from(
3032                 stack_object_type, this, true, CHECK_VERIFY(this));
3033               if (!is_assignable) {
3034                 if (ref_class_type.name() == vmSymbols::java_lang_Object()
3035                     &amp;&amp; stack_object_type.is_array()
3036                     &amp;&amp; method_name == vmSymbols::clone_name()) {
3037                   // Special case: arrays pretend to implement public Object
3038                   // clone().
3039                 } else {
3040                   verify_error(ErrorContext::bad_type(bci,
3041                       current_frame-&gt;stack_top_ctx(),
3042                       TypeOrigin::implicit(current_type())),
3043                       &quot;Bad access to protected data in invokevirtual&quot;);
3044                   return;
3045                 }
3046               }
3047             }
3048           }
3049         }
3050       } else {
3051         assert(opcode == Bytecodes::_invokeinterface, &quot;Unexpected opcode encountered&quot;);
3052         current_frame-&gt;pop_stack(ref_class_type, CHECK_VERIFY(this));
3053       }
3054     }
3055   }
3056   // Push the result type.
3057   int sig_verif_types_len = sig_verif_types-&gt;length();
3058   if (sig_verif_types_len &gt; nargs) {  // There&#39;s a return type
3059     if (method_name == vmSymbols::object_initializer_name() &amp;&amp;
3060         opcode != Bytecodes::_invokestatic) {
3061       // an &lt;init&gt; method must have a void return type, unless it&#39;s a static factory
3062       verify_error(ErrorContext::bad_code(bci),
3063           &quot;Return type must be void in &lt;init&gt; method&quot;);
3064       return;
3065     }
3066 
3067     assert(sig_verif_types_len &lt;= nargs + 2,
3068            &quot;Signature verification types array return type is bogus&quot;);
3069     for (int i = nargs; i &lt; sig_verif_types_len; i++) {
3070       assert(i == nargs || sig_verif_types-&gt;at(i).is_long2() ||
3071              sig_verif_types-&gt;at(i).is_double2(), &quot;Unexpected return verificationType&quot;);
3072       current_frame-&gt;push_stack(sig_verif_types-&gt;at(i), CHECK_VERIFY(this));
3073     }
3074   } else {
3075     // an &lt;init&gt; method may not have a void return type, if it&#39;s a static factory
3076     if (method_name == vmSymbols::object_initializer_name() &amp;&amp;
3077         opcode != Bytecodes::_invokespecial) {
3078       verify_error(ErrorContext::bad_code(bci),
3079           &quot;Return type must be non-void in &lt;init&gt; static factory method&quot;);
3080       return;
3081     }
3082   }
3083 }
3084 
3085 VerificationType ClassVerifier::get_newarray_type(
3086     u2 index, u2 bci, TRAPS) {
3087   const char* from_bt[] = {
3088     NULL, NULL, NULL, NULL, &quot;[Z&quot;, &quot;[C&quot;, &quot;[F&quot;, &quot;[D&quot;, &quot;[B&quot;, &quot;[S&quot;, &quot;[I&quot;, &quot;[J&quot;,
3089   };
3090   if (index &lt; T_BOOLEAN || index &gt; T_LONG) {
3091     verify_error(ErrorContext::bad_code(bci), &quot;Illegal newarray instruction&quot;);
3092     return VerificationType::bogus_type();
3093   }
3094 
3095   // from_bt[index] contains the array signature which has a length of 2
3096   Symbol* sig = create_temporary_symbol(from_bt[index], 2);
3097   return VerificationType::reference_type(sig);
3098 }
3099 
3100 void ClassVerifier::verify_anewarray(
3101     u2 bci, u2 index, const constantPoolHandle&amp; cp,
3102     StackMapFrame* current_frame, TRAPS) {
3103   verify_cp_class_type(bci, index, cp, CHECK_VERIFY(this));
3104   current_frame-&gt;pop_stack(
3105     VerificationType::integer_type(), CHECK_VERIFY(this));
3106 
3107   if (was_recursively_verified()) return;
3108   VerificationType component_type =
3109     cp_index_to_type(index, cp, CHECK_VERIFY(this));
3110   int length;
3111   char* arr_sig_str;
3112   if (component_type.is_array()) {     // it&#39;s an array
3113     const char* component_name = component_type.name()-&gt;as_utf8();
3114     // Check for more than MAX_ARRAY_DIMENSIONS
3115     length = (int)strlen(component_name);
3116     if (length &gt; MAX_ARRAY_DIMENSIONS &amp;&amp;
3117         component_name[MAX_ARRAY_DIMENSIONS - 1] == JVM_SIGNATURE_ARRAY) {
3118       verify_error(ErrorContext::bad_code(bci),
3119         &quot;Illegal anewarray instruction, array has more than 255 dimensions&quot;);
3120     }
3121     // add one dimension to component
3122     length++;
3123     arr_sig_str = NEW_RESOURCE_ARRAY_IN_THREAD(THREAD, char, length + 1);
3124     int n = os::snprintf(arr_sig_str, length + 1, &quot;%c%s&quot;,
3125                          JVM_SIGNATURE_ARRAY, component_name);
3126     assert(n == length, &quot;Unexpected number of characters in string&quot;);
3127   } else {         // it&#39;s an object or interface
3128     const char* component_name = component_type.name()-&gt;as_utf8();
3129     char Q_or_L = component_type.is_inline_type() ? JVM_SIGNATURE_INLINE_TYPE : JVM_SIGNATURE_CLASS;
3130     // add one dimension to component with &#39;L&#39; or &#39;Q&#39; prepended and &#39;;&#39; appended.
3131     length = (int)strlen(component_name) + 3;
3132     arr_sig_str = NEW_RESOURCE_ARRAY_IN_THREAD(THREAD, char, length + 1);
3133     int n = os::snprintf(arr_sig_str, length + 1, &quot;%c%c%s;&quot;,
3134                          JVM_SIGNATURE_ARRAY, Q_or_L, component_name);
3135     assert(n == length, &quot;Unexpected number of characters in string&quot;);
3136   }
3137   Symbol* arr_sig = create_temporary_symbol(arr_sig_str, length);
3138   VerificationType new_array_type = VerificationType::reference_type(arr_sig);
3139   current_frame-&gt;push_stack(new_array_type, CHECK_VERIFY(this));
3140 }
3141 
3142 void ClassVerifier::verify_iload(u2 index, StackMapFrame* current_frame, TRAPS) {
3143   current_frame-&gt;get_local(
3144     index, VerificationType::integer_type(), CHECK_VERIFY(this));
3145   current_frame-&gt;push_stack(
3146     VerificationType::integer_type(), CHECK_VERIFY(this));
3147 }
3148 
3149 void ClassVerifier::verify_lload(u2 index, StackMapFrame* current_frame, TRAPS) {
3150   current_frame-&gt;get_local_2(
3151     index, VerificationType::long_type(),
3152     VerificationType::long2_type(), CHECK_VERIFY(this));
3153   current_frame-&gt;push_stack_2(
3154     VerificationType::long_type(),
3155     VerificationType::long2_type(), CHECK_VERIFY(this));
3156 }
3157 
3158 void ClassVerifier::verify_fload(u2 index, StackMapFrame* current_frame, TRAPS) {
3159   current_frame-&gt;get_local(
3160     index, VerificationType::float_type(), CHECK_VERIFY(this));
3161   current_frame-&gt;push_stack(
3162     VerificationType::float_type(), CHECK_VERIFY(this));
3163 }
3164 
3165 void ClassVerifier::verify_dload(u2 index, StackMapFrame* current_frame, TRAPS) {
3166   current_frame-&gt;get_local_2(
3167     index, VerificationType::double_type(),
3168     VerificationType::double2_type(), CHECK_VERIFY(this));
3169   current_frame-&gt;push_stack_2(
3170     VerificationType::double_type(),
3171     VerificationType::double2_type(), CHECK_VERIFY(this));
3172 }
3173 
3174 void ClassVerifier::verify_aload(u2 index, StackMapFrame* current_frame, TRAPS) {
3175   VerificationType type = current_frame-&gt;get_local(
3176     index, VerificationType::nonscalar_check(), CHECK_VERIFY(this));
3177   current_frame-&gt;push_stack(type, CHECK_VERIFY(this));
3178 }
3179 
3180 void ClassVerifier::verify_istore(u2 index, StackMapFrame* current_frame, TRAPS) {
3181   current_frame-&gt;pop_stack(
3182     VerificationType::integer_type(), CHECK_VERIFY(this));
3183   current_frame-&gt;set_local(
3184     index, VerificationType::integer_type(), CHECK_VERIFY(this));
3185 }
3186 
3187 void ClassVerifier::verify_lstore(u2 index, StackMapFrame* current_frame, TRAPS) {
3188   current_frame-&gt;pop_stack_2(
3189     VerificationType::long2_type(),
3190     VerificationType::long_type(), CHECK_VERIFY(this));
3191   current_frame-&gt;set_local_2(
3192     index, VerificationType::long_type(),
3193     VerificationType::long2_type(), CHECK_VERIFY(this));
3194 }
3195 
3196 void ClassVerifier::verify_fstore(u2 index, StackMapFrame* current_frame, TRAPS) {
3197   current_frame-&gt;pop_stack(VerificationType::float_type(), CHECK_VERIFY(this));
3198   current_frame-&gt;set_local(
3199     index, VerificationType::float_type(), CHECK_VERIFY(this));
3200 }
3201 
3202 void ClassVerifier::verify_dstore(u2 index, StackMapFrame* current_frame, TRAPS) {
3203   current_frame-&gt;pop_stack_2(
3204     VerificationType::double2_type(),
3205     VerificationType::double_type(), CHECK_VERIFY(this));
3206   current_frame-&gt;set_local_2(
3207     index, VerificationType::double_type(),
3208     VerificationType::double2_type(), CHECK_VERIFY(this));
3209 }
3210 
3211 void ClassVerifier::verify_astore(u2 index, StackMapFrame* current_frame, TRAPS) {
3212   VerificationType type = current_frame-&gt;pop_stack(
3213     VerificationType::nonscalar_check(), CHECK_VERIFY(this));
3214   current_frame-&gt;set_local(index, type, CHECK_VERIFY(this));
3215 }
3216 
3217 void ClassVerifier::verify_iinc(u2 index, StackMapFrame* current_frame, TRAPS) {
3218   VerificationType type = current_frame-&gt;get_local(
3219     index, VerificationType::integer_type(), CHECK_VERIFY(this));
3220   current_frame-&gt;set_local(index, type, CHECK_VERIFY(this));
3221 }
3222 
3223 void ClassVerifier::verify_return_value(
3224     VerificationType return_type, VerificationType type, u2 bci,
3225     StackMapFrame* current_frame, TRAPS) {
3226   if (return_type == VerificationType::bogus_type()) {
3227     verify_error(ErrorContext::bad_type(bci,
3228         current_frame-&gt;stack_top_ctx(), TypeOrigin::signature(return_type)),
3229         &quot;Method expects a return value&quot;);
3230     return;
3231   }
3232   bool match = return_type.is_assignable_from(type, this, false, CHECK_VERIFY(this));
3233   if (!match) {
3234     verify_error(ErrorContext::bad_type(bci,
3235         current_frame-&gt;stack_top_ctx(), TypeOrigin::signature(return_type)),
3236         &quot;Bad return type&quot;);
3237     return;
3238   }
3239 }
3240 
3241 // The verifier creates symbols which are substrings of Symbols.
3242 // These are stored in the verifier until the end of verification so that
3243 // they can be reference counted.
3244 Symbol* ClassVerifier::create_temporary_symbol(const char *name, int length) {
3245   // Quick deduplication check
3246   if (_previous_symbol != NULL &amp;&amp; _previous_symbol-&gt;equals(name, length)) {
3247     return _previous_symbol;
3248   }
3249   Symbol* sym = SymbolTable::new_symbol(name, length);
3250   if (!sym-&gt;is_permanent()) {
3251     if (_symbols == NULL) {
3252       _symbols = new GrowableArray&lt;Symbol*&gt;(50, 0, NULL);
3253     }
3254     _symbols-&gt;push(sym);
3255   }
3256   _previous_symbol = sym;
3257   return sym;
3258 }
<a name="3" id="anc3"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="3" type="hidden" />
</body>
</html>