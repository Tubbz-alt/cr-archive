<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff src/hotspot/share/memory/heapShared.cpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
  </head>
<body>
<center><a href="heapInspection.cpp.udiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="heapShared.hpp.udiff.html" target="_top">next &gt;</a></center>    <h2>src/hotspot/share/memory/heapShared.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -26,10 +26,11 @@</span>
  #include &quot;classfile/javaClasses.inline.hpp&quot;
  #include &quot;classfile/stringTable.hpp&quot;
  #include &quot;classfile/symbolTable.hpp&quot;
  #include &quot;classfile/systemDictionaryShared.hpp&quot;
  #include &quot;classfile/vmSymbols.hpp&quot;
<span class="udiff-line-added">+ #include &quot;gc/shared/gcLocker.hpp&quot;</span>
  #include &quot;logging/log.hpp&quot;
  #include &quot;logging/logMessage.hpp&quot;
  #include &quot;logging/logStream.hpp&quot;
  #include &quot;memory/archiveUtils.hpp&quot;
  #include &quot;memory/filemap.hpp&quot;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -184,10 +185,29 @@</span>
        ik-&gt;constants()-&gt;archive_resolved_references(THREAD);
      }
    }
  }
  
<span class="udiff-line-added">+ void HeapShared::run_full_gc_in_vm_thread() {</span>
<span class="udiff-line-added">+   if (is_heap_object_archiving_allowed()) {</span>
<span class="udiff-line-added">+     // Avoid fragmentation while archiving heap objects.</span>
<span class="udiff-line-added">+     // We do this inside a safepoint, so that no further allocation can happen after GC</span>
<span class="udiff-line-added">+     // has finished.</span>
<span class="udiff-line-added">+     if (GCLocker::is_active()) {</span>
<span class="udiff-line-added">+       // Just checking for safety ...</span>
<span class="udiff-line-added">+       // This should not happen during -Xshare:dump. If you see this, probably the Java core lib</span>
<span class="udiff-line-added">+       // has been modified such that JNI code is executed in some clean up threads after</span>
<span class="udiff-line-added">+       // we have finished class loading.</span>
<span class="udiff-line-added">+       log_warning(cds)(&quot;GC locker is held, unable to start extra compacting GC. This may produce suboptimal results.&quot;);</span>
<span class="udiff-line-added">+     } else {</span>
<span class="udiff-line-added">+       log_info(cds)(&quot;Run GC ...&quot;);</span>
<span class="udiff-line-added">+       Universe::heap()-&gt;collect_as_vm_thread(GCCause::_archive_time_gc);</span>
<span class="udiff-line-added">+       log_info(cds)(&quot;Run GC done&quot;);</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+   }</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
  void HeapShared::archive_java_heap_objects(GrowableArray&lt;MemRegion&gt; *closed,
                                             GrowableArray&lt;MemRegion&gt; *open) {
    if (!is_heap_object_archiving_allowed()) {
      log_info(cds)(
        &quot;Archived java heap is not supported as UseG1GC, &quot;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -287,11 +307,11 @@</span>
  void KlassSubGraphInfo::add_subgraph_entry_field(
        int static_field_offset, oop v, bool is_closed_archive) {
    assert(DumpSharedSpaces, &quot;dump time only&quot;);
    if (_subgraph_entry_fields == NULL) {
      _subgraph_entry_fields =
<span class="udiff-line-modified-removed">-       new(ResourceObj::C_HEAP, mtClass) GrowableArray&lt;juint&gt;(10, true);</span>
<span class="udiff-line-modified-added">+       new(ResourceObj::C_HEAP, mtClass) GrowableArray&lt;juint&gt;(10, mtClass);</span>
    }
    _subgraph_entry_fields-&gt;append((juint)static_field_offset);
    _subgraph_entry_fields-&gt;append(CompressedOops::encode(v));
    _subgraph_entry_fields-&gt;append(is_closed_archive ? 1 : 0);
  }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -303,11 +323,11 @@</span>
    assert(relocated_k == MetaspaceShared::get_relocated_klass(orig_k),
           &quot;must be the relocated Klass in the shared space&quot;);
  
    if (_subgraph_object_klasses == NULL) {
      _subgraph_object_klasses =
<span class="udiff-line-modified-removed">-       new(ResourceObj::C_HEAP, mtClass) GrowableArray&lt;Klass*&gt;(50, true);</span>
<span class="udiff-line-modified-added">+       new(ResourceObj::C_HEAP, mtClass) GrowableArray&lt;Klass*&gt;(50, mtClass);</span>
    }
  
    assert(relocated_k-&gt;is_shared(), &quot;must be a shared class&quot;);
  
    if (_k == relocated_k) {
</pre>
<center><a href="heapInspection.cpp.udiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="heapShared.hpp.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>