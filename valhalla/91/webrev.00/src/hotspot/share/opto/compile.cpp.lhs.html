<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames src/hotspot/share/opto/compile.cpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
    <script type="text/javascript" src="../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>   1 /*
   2  * Copyright (c) 1997, 2020, Oracle and/or its affiliates. All rights reserved.
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.
   8  *
   9  * This code is distributed in the hope that it will be useful, but WITHOUT
  10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  *
  23  */
  24 
  25 #include &quot;precompiled.hpp&quot;
  26 #include &quot;asm/macroAssembler.hpp&quot;
  27 #include &quot;asm/macroAssembler.inline.hpp&quot;
  28 #include &quot;ci/ciReplay.hpp&quot;
  29 #include &quot;classfile/systemDictionary.hpp&quot;
  30 #include &quot;code/exceptionHandlerTable.hpp&quot;
  31 #include &quot;code/nmethod.hpp&quot;
  32 #include &quot;compiler/compileBroker.hpp&quot;
  33 #include &quot;compiler/compileLog.hpp&quot;
  34 #include &quot;compiler/disassembler.hpp&quot;
  35 #include &quot;compiler/oopMap.hpp&quot;
  36 #include &quot;gc/shared/barrierSet.hpp&quot;
  37 #include &quot;gc/shared/c2/barrierSetC2.hpp&quot;
  38 #include &quot;jfr/jfrEvents.hpp&quot;
  39 #include &quot;memory/resourceArea.hpp&quot;
  40 #include &quot;opto/addnode.hpp&quot;
  41 #include &quot;opto/block.hpp&quot;
  42 #include &quot;opto/c2compiler.hpp&quot;
  43 #include &quot;opto/callGenerator.hpp&quot;
  44 #include &quot;opto/callnode.hpp&quot;
  45 #include &quot;opto/castnode.hpp&quot;
  46 #include &quot;opto/cfgnode.hpp&quot;
  47 #include &quot;opto/chaitin.hpp&quot;
  48 #include &quot;opto/compile.hpp&quot;
  49 #include &quot;opto/connode.hpp&quot;
  50 #include &quot;opto/convertnode.hpp&quot;
  51 #include &quot;opto/divnode.hpp&quot;
  52 #include &quot;opto/escape.hpp&quot;
  53 #include &quot;opto/idealGraphPrinter.hpp&quot;
  54 #include &quot;opto/loopnode.hpp&quot;
  55 #include &quot;opto/machnode.hpp&quot;
  56 #include &quot;opto/macro.hpp&quot;
  57 #include &quot;opto/matcher.hpp&quot;
  58 #include &quot;opto/mathexactnode.hpp&quot;
  59 #include &quot;opto/memnode.hpp&quot;
  60 #include &quot;opto/mulnode.hpp&quot;
  61 #include &quot;opto/narrowptrnode.hpp&quot;
  62 #include &quot;opto/node.hpp&quot;
  63 #include &quot;opto/opcodes.hpp&quot;
  64 #include &quot;opto/output.hpp&quot;
  65 #include &quot;opto/parse.hpp&quot;
  66 #include &quot;opto/phaseX.hpp&quot;
  67 #include &quot;opto/rootnode.hpp&quot;
  68 #include &quot;opto/runtime.hpp&quot;
  69 #include &quot;opto/stringopts.hpp&quot;
  70 #include &quot;opto/type.hpp&quot;
  71 #include &quot;opto/valuetypenode.hpp&quot;
  72 #include &quot;opto/vectornode.hpp&quot;
  73 #include &quot;runtime/arguments.hpp&quot;
  74 #include &quot;runtime/sharedRuntime.hpp&quot;
  75 #include &quot;runtime/signature.hpp&quot;
  76 #include &quot;runtime/stubRoutines.hpp&quot;
  77 #include &quot;runtime/timer.hpp&quot;
  78 #include &quot;utilities/align.hpp&quot;
  79 #include &quot;utilities/copy.hpp&quot;
  80 #include &quot;utilities/macros.hpp&quot;
  81 #include &quot;utilities/resourceHash.hpp&quot;
  82 
  83 
  84 // -------------------- Compile::mach_constant_base_node -----------------------
  85 // Constant table base node singleton.
  86 MachConstantBaseNode* Compile::mach_constant_base_node() {
  87   if (_mach_constant_base_node == NULL) {
  88     _mach_constant_base_node = new MachConstantBaseNode();
  89     _mach_constant_base_node-&gt;add_req(C-&gt;root());
  90   }
  91   return _mach_constant_base_node;
  92 }
  93 
  94 
  95 /// Support for intrinsics.
  96 
  97 // Return the index at which m must be inserted (or already exists).
  98 // The sort order is by the address of the ciMethod, with is_virtual as minor key.
  99 class IntrinsicDescPair {
 100  private:
 101   ciMethod* _m;
 102   bool _is_virtual;
 103  public:
 104   IntrinsicDescPair(ciMethod* m, bool is_virtual) : _m(m), _is_virtual(is_virtual) {}
 105   static int compare(IntrinsicDescPair* const&amp; key, CallGenerator* const&amp; elt) {
 106     ciMethod* m= elt-&gt;method();
 107     ciMethod* key_m = key-&gt;_m;
 108     if (key_m &lt; m)      return -1;
 109     else if (key_m &gt; m) return 1;
 110     else {
 111       bool is_virtual = elt-&gt;is_virtual();
 112       bool key_virtual = key-&gt;_is_virtual;
 113       if (key_virtual &lt; is_virtual)      return -1;
 114       else if (key_virtual &gt; is_virtual) return 1;
 115       else                               return 0;
 116     }
 117   }
 118 };
 119 int Compile::intrinsic_insertion_index(ciMethod* m, bool is_virtual, bool&amp; found) {
 120 #ifdef ASSERT
 121   for (int i = 1; i &lt; _intrinsics-&gt;length(); i++) {
 122     CallGenerator* cg1 = _intrinsics-&gt;at(i-1);
 123     CallGenerator* cg2 = _intrinsics-&gt;at(i);
 124     assert(cg1-&gt;method() != cg2-&gt;method()
 125            ? cg1-&gt;method()     &lt; cg2-&gt;method()
 126            : cg1-&gt;is_virtual() &lt; cg2-&gt;is_virtual(),
 127            &quot;compiler intrinsics list must stay sorted&quot;);
 128   }
 129 #endif
 130   IntrinsicDescPair pair(m, is_virtual);
 131   return _intrinsics-&gt;find_sorted&lt;IntrinsicDescPair*, IntrinsicDescPair::compare&gt;(&amp;pair, found);
 132 }
 133 
 134 void Compile::register_intrinsic(CallGenerator* cg) {
 135   if (_intrinsics == NULL) {
 136     _intrinsics = new (comp_arena())GrowableArray&lt;CallGenerator*&gt;(comp_arena(), 60, 0, NULL);
 137   }
 138   int len = _intrinsics-&gt;length();
 139   bool found = false;
 140   int index = intrinsic_insertion_index(cg-&gt;method(), cg-&gt;is_virtual(), found);
 141   assert(!found, &quot;registering twice&quot;);
 142   _intrinsics-&gt;insert_before(index, cg);
 143   assert(find_intrinsic(cg-&gt;method(), cg-&gt;is_virtual()) == cg, &quot;registration worked&quot;);
 144 }
 145 
 146 CallGenerator* Compile::find_intrinsic(ciMethod* m, bool is_virtual) {
 147   assert(m-&gt;is_loaded(), &quot;don&#39;t try this on unloaded methods&quot;);
 148   if (_intrinsics != NULL) {
 149     bool found = false;
 150     int index = intrinsic_insertion_index(m, is_virtual, found);
 151      if (found) {
 152       return _intrinsics-&gt;at(index);
 153     }
 154   }
 155   // Lazily create intrinsics for intrinsic IDs well-known in the runtime.
 156   if (m-&gt;intrinsic_id() != vmIntrinsics::_none &amp;&amp;
 157       m-&gt;intrinsic_id() &lt;= vmIntrinsics::LAST_COMPILER_INLINE) {
 158     CallGenerator* cg = make_vm_intrinsic(m, is_virtual);
 159     if (cg != NULL) {
 160       // Save it for next time:
 161       register_intrinsic(cg);
 162       return cg;
 163     } else {
 164       gather_intrinsic_statistics(m-&gt;intrinsic_id(), is_virtual, _intrinsic_disabled);
 165     }
 166   }
 167   return NULL;
 168 }
 169 
 170 // Compile:: register_library_intrinsics and make_vm_intrinsic are defined
 171 // in library_call.cpp.
 172 
 173 
 174 #ifndef PRODUCT
 175 // statistics gathering...
 176 
 177 juint  Compile::_intrinsic_hist_count[vmIntrinsics::ID_LIMIT] = {0};
 178 jubyte Compile::_intrinsic_hist_flags[vmIntrinsics::ID_LIMIT] = {0};
 179 
 180 bool Compile::gather_intrinsic_statistics(vmIntrinsics::ID id, bool is_virtual, int flags) {
 181   assert(id &gt; vmIntrinsics::_none &amp;&amp; id &lt; vmIntrinsics::ID_LIMIT, &quot;oob&quot;);
 182   int oflags = _intrinsic_hist_flags[id];
 183   assert(flags != 0, &quot;what happened?&quot;);
 184   if (is_virtual) {
 185     flags |= _intrinsic_virtual;
 186   }
 187   bool changed = (flags != oflags);
 188   if ((flags &amp; _intrinsic_worked) != 0) {
 189     juint count = (_intrinsic_hist_count[id] += 1);
 190     if (count == 1) {
 191       changed = true;           // first time
 192     }
 193     // increment the overall count also:
 194     _intrinsic_hist_count[vmIntrinsics::_none] += 1;
 195   }
 196   if (changed) {
 197     if (((oflags ^ flags) &amp; _intrinsic_virtual) != 0) {
 198       // Something changed about the intrinsic&#39;s virtuality.
 199       if ((flags &amp; _intrinsic_virtual) != 0) {
 200         // This is the first use of this intrinsic as a virtual call.
 201         if (oflags != 0) {
 202           // We already saw it as a non-virtual, so note both cases.
 203           flags |= _intrinsic_both;
 204         }
 205       } else if ((oflags &amp; _intrinsic_both) == 0) {
 206         // This is the first use of this intrinsic as a non-virtual
 207         flags |= _intrinsic_both;
 208       }
 209     }
 210     _intrinsic_hist_flags[id] = (jubyte) (oflags | flags);
 211   }
 212   // update the overall flags also:
 213   _intrinsic_hist_flags[vmIntrinsics::_none] |= (jubyte) flags;
 214   return changed;
 215 }
 216 
 217 static char* format_flags(int flags, char* buf) {
 218   buf[0] = 0;
 219   if ((flags &amp; Compile::_intrinsic_worked) != 0)    strcat(buf, &quot;,worked&quot;);
 220   if ((flags &amp; Compile::_intrinsic_failed) != 0)    strcat(buf, &quot;,failed&quot;);
 221   if ((flags &amp; Compile::_intrinsic_disabled) != 0)  strcat(buf, &quot;,disabled&quot;);
 222   if ((flags &amp; Compile::_intrinsic_virtual) != 0)   strcat(buf, &quot;,virtual&quot;);
 223   if ((flags &amp; Compile::_intrinsic_both) != 0)      strcat(buf, &quot;,nonvirtual&quot;);
 224   if (buf[0] == 0)  strcat(buf, &quot;,&quot;);
 225   assert(buf[0] == &#39;,&#39;, &quot;must be&quot;);
 226   return &amp;buf[1];
 227 }
 228 
 229 void Compile::print_intrinsic_statistics() {
 230   char flagsbuf[100];
 231   ttyLocker ttyl;
 232   if (xtty != NULL)  xtty-&gt;head(&quot;statistics type=&#39;intrinsic&#39;&quot;);
 233   tty-&gt;print_cr(&quot;Compiler intrinsic usage:&quot;);
 234   juint total = _intrinsic_hist_count[vmIntrinsics::_none];
 235   if (total == 0)  total = 1;  // avoid div0 in case of no successes
 236   #define PRINT_STAT_LINE(name, c, f) \
 237     tty-&gt;print_cr(&quot;  %4d (%4.1f%%) %s (%s)&quot;, (int)(c), ((c) * 100.0) / total, name, f);
 238   for (int index = 1 + (int)vmIntrinsics::_none; index &lt; (int)vmIntrinsics::ID_LIMIT; index++) {
 239     vmIntrinsics::ID id = (vmIntrinsics::ID) index;
 240     int   flags = _intrinsic_hist_flags[id];
 241     juint count = _intrinsic_hist_count[id];
 242     if ((flags | count) != 0) {
 243       PRINT_STAT_LINE(vmIntrinsics::name_at(id), count, format_flags(flags, flagsbuf));
 244     }
 245   }
 246   PRINT_STAT_LINE(&quot;total&quot;, total, format_flags(_intrinsic_hist_flags[vmIntrinsics::_none], flagsbuf));
 247   if (xtty != NULL)  xtty-&gt;tail(&quot;statistics&quot;);
 248 }
 249 
 250 void Compile::print_statistics() {
 251   { ttyLocker ttyl;
 252     if (xtty != NULL)  xtty-&gt;head(&quot;statistics type=&#39;opto&#39;&quot;);
 253     Parse::print_statistics();
 254     PhaseCCP::print_statistics();
 255     PhaseRegAlloc::print_statistics();
 256     PhaseOutput::print_statistics();
 257     PhasePeephole::print_statistics();
 258     PhaseIdealLoop::print_statistics();
 259     if (xtty != NULL)  xtty-&gt;tail(&quot;statistics&quot;);
 260   }
 261   if (_intrinsic_hist_flags[vmIntrinsics::_none] != 0) {
 262     // put this under its own &lt;statistics&gt; element.
 263     print_intrinsic_statistics();
 264   }
 265 }
 266 #endif //PRODUCT
 267 
 268 void Compile::gvn_replace_by(Node* n, Node* nn) {
 269   for (DUIterator_Last imin, i = n-&gt;last_outs(imin); i &gt;= imin; ) {
 270     Node* use = n-&gt;last_out(i);
 271     bool is_in_table = initial_gvn()-&gt;hash_delete(use);
 272     uint uses_found = 0;
 273     for (uint j = 0; j &lt; use-&gt;len(); j++) {
 274       if (use-&gt;in(j) == n) {
 275         if (j &lt; use-&gt;req())
 276           use-&gt;set_req(j, nn);
 277         else
 278           use-&gt;set_prec(j, nn);
 279         uses_found++;
 280       }
 281     }
 282     if (is_in_table) {
 283       // reinsert into table
 284       initial_gvn()-&gt;hash_find_insert(use);
 285     }
 286     record_for_igvn(use);
 287     i -= uses_found;    // we deleted 1 or more copies of this edge
 288   }
 289 }
 290 
 291 
 292 static inline bool not_a_node(const Node* n) {
 293   if (n == NULL)                   return true;
 294   if (((intptr_t)n &amp; 1) != 0)      return true;  // uninitialized, etc.
 295   if (*(address*)n == badAddress)  return true;  // kill by Node::destruct
 296   return false;
 297 }
 298 
 299 // Identify all nodes that are reachable from below, useful.
 300 // Use breadth-first pass that records state in a Unique_Node_List,
 301 // recursive traversal is slower.
 302 void Compile::identify_useful_nodes(Unique_Node_List &amp;useful) {
 303   int estimated_worklist_size = live_nodes();
 304   useful.map( estimated_worklist_size, NULL );  // preallocate space
 305 
 306   // Initialize worklist
 307   if (root() != NULL)     { useful.push(root()); }
 308   // If &#39;top&#39; is cached, declare it useful to preserve cached node
 309   if( cached_top_node() ) { useful.push(cached_top_node()); }
 310 
 311   // Push all useful nodes onto the list, breadthfirst
 312   for( uint next = 0; next &lt; useful.size(); ++next ) {
 313     assert( next &lt; unique(), &quot;Unique useful nodes &lt; total nodes&quot;);
 314     Node *n  = useful.at(next);
 315     uint max = n-&gt;len();
 316     for( uint i = 0; i &lt; max; ++i ) {
 317       Node *m = n-&gt;in(i);
 318       if (not_a_node(m))  continue;
 319       useful.push(m);
 320     }
 321   }
 322 }
 323 
 324 // Update dead_node_list with any missing dead nodes using useful
 325 // list. Consider all non-useful nodes to be useless i.e., dead nodes.
 326 void Compile::update_dead_node_list(Unique_Node_List &amp;useful) {
 327   uint max_idx = unique();
 328   VectorSet&amp; useful_node_set = useful.member_set();
 329 
 330   for (uint node_idx = 0; node_idx &lt; max_idx; node_idx++) {
 331     // If node with index node_idx is not in useful set,
 332     // mark it as dead in dead node list.
 333     if (!useful_node_set.test(node_idx)) {
 334       record_dead_node(node_idx);
 335     }
 336   }
 337 }
 338 
 339 void Compile::remove_useless_late_inlines(GrowableArray&lt;CallGenerator*&gt;* inlines, Unique_Node_List &amp;useful) {
 340   int shift = 0;
 341   for (int i = 0; i &lt; inlines-&gt;length(); i++) {
 342     CallGenerator* cg = inlines-&gt;at(i);
 343     CallNode* call = cg-&gt;call_node();
 344     if (shift &gt; 0) {
 345       inlines-&gt;at_put(i-shift, cg);
 346     }
 347     if (!useful.member(call)) {
 348       shift++;
 349     }
 350   }
 351   inlines-&gt;trunc_to(inlines-&gt;length()-shift);
 352 }
 353 
 354 // Disconnect all useless nodes by disconnecting those at the boundary.
 355 void Compile::remove_useless_nodes(Unique_Node_List &amp;useful) {
 356   uint next = 0;
 357   while (next &lt; useful.size()) {
 358     Node *n = useful.at(next++);
 359     if (n-&gt;is_SafePoint()) {
 360       // We&#39;re done with a parsing phase. Replaced nodes are not valid
 361       // beyond that point.
 362       n-&gt;as_SafePoint()-&gt;delete_replaced_nodes();
 363     }
 364     // Use raw traversal of out edges since this code removes out edges
 365     int max = n-&gt;outcnt();
 366     for (int j = 0; j &lt; max; ++j) {
 367       Node* child = n-&gt;raw_out(j);
 368       if (! useful.member(child)) {
 369         assert(!child-&gt;is_top() || child != top(),
 370                &quot;If top is cached in Compile object it is in useful list&quot;);
 371         // Only need to remove this out-edge to the useless node
 372         n-&gt;raw_del_out(j);
 373         --j;
 374         --max;
 375       }
 376     }
 377     if (n-&gt;outcnt() == 1 &amp;&amp; n-&gt;has_special_unique_user()) {
 378       record_for_igvn(n-&gt;unique_out());
 379     }
 380   }
 381   // Remove useless macro and predicate opaq nodes
 382   for (int i = C-&gt;macro_count()-1; i &gt;= 0; i--) {
 383     Node* n = C-&gt;macro_node(i);
 384     if (!useful.member(n)) {
 385       remove_macro_node(n);
 386     }
 387   }
 388   // Remove useless CastII nodes with range check dependency
 389   for (int i = range_check_cast_count() - 1; i &gt;= 0; i--) {
 390     Node* cast = range_check_cast_node(i);
 391     if (!useful.member(cast)) {
 392       remove_range_check_cast(cast);
 393     }
 394   }
 395   // Remove useless expensive nodes
 396   for (int i = C-&gt;expensive_count()-1; i &gt;= 0; i--) {
 397     Node* n = C-&gt;expensive_node(i);
 398     if (!useful.member(n)) {
 399       remove_expensive_node(n);
 400     }
 401   }
 402   // Remove useless Opaque4 nodes
 403   for (int i = opaque4_count() - 1; i &gt;= 0; i--) {
 404     Node* opaq = opaque4_node(i);
 405     if (!useful.member(opaq)) {
 406       remove_opaque4_node(opaq);
 407     }
 408   }
 409   // Remove useless value type nodes
 410   for (int i = _value_type_nodes-&gt;length() - 1; i &gt;= 0; i--) {
 411     Node* vt = _value_type_nodes-&gt;at(i);
 412     if (!useful.member(vt)) {
 413       _value_type_nodes-&gt;remove(vt);
 414     }
 415   }
 416   BarrierSetC2* bs = BarrierSet::barrier_set()-&gt;barrier_set_c2();
 417   bs-&gt;eliminate_useless_gc_barriers(useful, this);
 418   // clean up the late inline lists
 419   remove_useless_late_inlines(&amp;_string_late_inlines, useful);
 420   remove_useless_late_inlines(&amp;_boxing_late_inlines, useful);
 421   remove_useless_late_inlines(&amp;_late_inlines, useful);
 422   debug_only(verify_graph_edges(true/*check for no_dead_code*/);)
 423 }
 424 
 425 // ============================================================================
 426 //------------------------------CompileWrapper---------------------------------
 427 class CompileWrapper : public StackObj {
 428   Compile *const _compile;
 429  public:
 430   CompileWrapper(Compile* compile);
 431 
 432   ~CompileWrapper();
 433 };
 434 
 435 CompileWrapper::CompileWrapper(Compile* compile) : _compile(compile) {
 436   // the Compile* pointer is stored in the current ciEnv:
 437   ciEnv* env = compile-&gt;env();
 438   assert(env == ciEnv::current(), &quot;must already be a ciEnv active&quot;);
 439   assert(env-&gt;compiler_data() == NULL, &quot;compile already active?&quot;);
 440   env-&gt;set_compiler_data(compile);
 441   assert(compile == Compile::current(), &quot;sanity&quot;);
 442 
 443   compile-&gt;set_type_dict(NULL);
 444   compile-&gt;set_clone_map(new Dict(cmpkey, hashkey, _compile-&gt;comp_arena()));
 445   compile-&gt;clone_map().set_clone_idx(0);
 446   compile-&gt;set_type_last_size(0);
 447   compile-&gt;set_last_tf(NULL, NULL);
 448   compile-&gt;set_indexSet_arena(NULL);
 449   compile-&gt;set_indexSet_free_block_list(NULL);
 450   compile-&gt;init_type_arena();
 451   Type::Initialize(compile);
 452   _compile-&gt;begin_method();
 453   _compile-&gt;clone_map().set_debug(_compile-&gt;has_method() &amp;&amp; _compile-&gt;directive()-&gt;CloneMapDebugOption);
 454 }
 455 CompileWrapper::~CompileWrapper() {
 456   _compile-&gt;end_method();
 457   _compile-&gt;env()-&gt;set_compiler_data(NULL);
 458 }
 459 
 460 
 461 //----------------------------print_compile_messages---------------------------
 462 void Compile::print_compile_messages() {
 463 #ifndef PRODUCT
 464   // Check if recompiling
 465   if (_subsume_loads == false &amp;&amp; PrintOpto) {
 466     // Recompiling without allowing machine instructions to subsume loads
 467     tty-&gt;print_cr(&quot;*********************************************************&quot;);
 468     tty-&gt;print_cr(&quot;** Bailout: Recompile without subsuming loads          **&quot;);
 469     tty-&gt;print_cr(&quot;*********************************************************&quot;);
 470   }
 471   if (_do_escape_analysis != DoEscapeAnalysis &amp;&amp; PrintOpto) {
 472     // Recompiling without escape analysis
 473     tty-&gt;print_cr(&quot;*********************************************************&quot;);
 474     tty-&gt;print_cr(&quot;** Bailout: Recompile without escape analysis          **&quot;);
 475     tty-&gt;print_cr(&quot;*********************************************************&quot;);
 476   }
 477   if (_eliminate_boxing != EliminateAutoBox &amp;&amp; PrintOpto) {
 478     // Recompiling without boxing elimination
 479     tty-&gt;print_cr(&quot;*********************************************************&quot;);
 480     tty-&gt;print_cr(&quot;** Bailout: Recompile without boxing elimination       **&quot;);
 481     tty-&gt;print_cr(&quot;*********************************************************&quot;);
 482   }
 483   if (C-&gt;directive()-&gt;BreakAtCompileOption) {
 484     // Open the debugger when compiling this method.
 485     tty-&gt;print(&quot;### Breaking when compiling: &quot;);
 486     method()-&gt;print_short_name();
 487     tty-&gt;cr();
 488     BREAKPOINT;
 489   }
 490 
 491   if( PrintOpto ) {
 492     if (is_osr_compilation()) {
 493       tty-&gt;print(&quot;[OSR]%3d&quot;, _compile_id);
 494     } else {
 495       tty-&gt;print(&quot;%3d&quot;, _compile_id);
 496     }
 497   }
 498 #endif
 499 }
 500 
 501 // ============================================================================
 502 //------------------------------Compile standard-------------------------------
 503 debug_only( int Compile::_debug_idx = 100000; )
 504 
 505 // Compile a method.  entry_bci is -1 for normal compilations and indicates
 506 // the continuation bci for on stack replacement.
 507 
 508 
 509 Compile::Compile( ciEnv* ci_env, ciMethod* target, int osr_bci,
 510                   bool subsume_loads, bool do_escape_analysis, bool eliminate_boxing, DirectiveSet* directive)
 511                 : Phase(Compiler),
 512                   _compile_id(ci_env-&gt;compile_id()),
 513                   _save_argument_registers(false),
 514                   _subsume_loads(subsume_loads),
 515                   _do_escape_analysis(do_escape_analysis),
 516                   _eliminate_boxing(eliminate_boxing),
 517                   _method(target),
 518                   _entry_bci(osr_bci),
 519                   _stub_function(NULL),
 520                   _stub_name(NULL),
 521                   _stub_entry_point(NULL),
 522                   _max_node_limit(MaxNodeLimit),
 523                   _inlining_progress(false),
 524                   _inlining_incrementally(false),
 525                   _do_cleanup(false),
 526                   _has_reserved_stack_access(target-&gt;has_reserved_stack_access()),
 527 #ifndef PRODUCT
 528                   _trace_opto_output(directive-&gt;TraceOptoOutputOption),
 529                   _print_ideal(directive-&gt;PrintIdealOption),
 530 #endif
 531                   _has_method_handle_invokes(false),
 532                   _clinit_barrier_on_entry(false),
 533                   _comp_arena(mtCompiler),
 534                   _barrier_set_state(BarrierSet::barrier_set()-&gt;barrier_set_c2()-&gt;create_barrier_state(comp_arena())),
 535                   _env(ci_env),
 536                   _directive(directive),
 537                   _log(ci_env-&gt;log()),
 538                   _failure_reason(NULL),
 539                   _congraph(NULL),
<a name="1" id="anc1"></a><span class="line-modified"> 540 #ifndef PRODUCT</span>
<span class="line-removed"> 541                   _printer(IdealGraphPrinter::printer()),</span>
<span class="line-removed"> 542 #endif</span>
 543                   _dead_node_list(comp_arena()),
 544                   _dead_node_count(0),
 545                   _node_arena(mtCompiler),
 546                   _old_arena(mtCompiler),
 547                   _mach_constant_base_node(NULL),
 548                   _Compile_types(mtCompiler),
 549                   _initial_gvn(NULL),
 550                   _for_igvn(NULL),
 551                   _warm_calls(NULL),
 552                   _late_inlines(comp_arena(), 2, 0, NULL),
 553                   _string_late_inlines(comp_arena(), 2, 0, NULL),
 554                   _boxing_late_inlines(comp_arena(), 2, 0, NULL),
 555                   _late_inlines_pos(0),
 556                   _number_of_mh_late_inlines(0),
 557                   _print_inlining_stream(NULL),
 558                   _print_inlining_list(NULL),
 559                   _print_inlining_idx(0),
 560                   _print_inlining_output(NULL),
 561                   _replay_inline_data(NULL),
 562                   _java_calls(0),
 563                   _inner_loops(0),
 564                   _interpreter_frame_size(0)
 565 #ifndef PRODUCT
 566                   , _in_dump_cnt(0)
 567 #endif
 568 {
 569   C = this;
<a name="2" id="anc2"></a><span class="line-removed"> 570 #ifndef PRODUCT</span>
<span class="line-removed"> 571   if (_printer != NULL) {</span>
<span class="line-removed"> 572     _printer-&gt;set_compile(this);</span>
<span class="line-removed"> 573   }</span>
<span class="line-removed"> 574 #endif</span>
 575   CompileWrapper cw(this);
 576 
 577   if (CITimeVerbose) {
 578     tty-&gt;print(&quot; &quot;);
 579     target-&gt;holder()-&gt;name()-&gt;print();
 580     tty-&gt;print(&quot;.&quot;);
 581     target-&gt;print_short_name();
 582     tty-&gt;print(&quot;  &quot;);
 583   }
 584   TraceTime t1(&quot;Total compilation time&quot;, &amp;_t_totalCompilation, CITime, CITimeVerbose);
 585   TraceTime t2(NULL, &amp;_t_methodCompilation, CITime, false);
 586 
 587 #if defined(SUPPORT_ASSEMBLY) || defined(SUPPORT_ABSTRACT_ASSEMBLY)
 588   bool print_opto_assembly = directive-&gt;PrintOptoAssemblyOption;
 589   // We can always print a disassembly, either abstract (hex dump) or
 590   // with the help of a suitable hsdis library. Thus, we should not
 591   // couple print_assembly and print_opto_assembly controls.
 592   // But: always print opto and regular assembly on compile command &#39;print&#39;.
 593   bool print_assembly = directive-&gt;PrintAssemblyOption;
 594   set_print_assembly(print_opto_assembly || print_assembly);
 595 #else
 596   set_print_assembly(false); // must initialize.
 597 #endif
 598 
 599 #ifndef PRODUCT
 600   set_parsed_irreducible_loop(false);
 601 
 602   if (directive-&gt;ReplayInlineOption) {
 603     _replay_inline_data = ciReplay::load_inline_data(method(), entry_bci(), ci_env-&gt;comp_level());
 604   }
 605 #endif
 606   set_print_inlining(directive-&gt;PrintInliningOption || PrintOptoInlining);
 607   set_print_intrinsics(directive-&gt;PrintIntrinsicsOption);
 608   set_has_irreducible_loop(true); // conservative until build_loop_tree() reset it
 609 
 610   if (ProfileTraps RTM_OPT_ONLY( || UseRTMLocking )) {
 611     // Make sure the method being compiled gets its own MDO,
 612     // so we can at least track the decompile_count().
 613     // Need MDO to record RTM code generation state.
 614     method()-&gt;ensure_method_data();
 615   }
 616 
 617   Init(::AliasLevel);
 618 
 619 
 620   print_compile_messages();
 621 
 622   _ilt = InlineTree::build_inline_tree_root();
 623 
 624   // Even if NO memory addresses are used, MergeMem nodes must have at least 1 slice
 625   assert(num_alias_types() &gt;= AliasIdxRaw, &quot;&quot;);
 626 
 627 #define MINIMUM_NODE_HASH  1023
 628   // Node list that Iterative GVN will start with
 629   Unique_Node_List for_igvn(comp_arena());
 630   set_for_igvn(&amp;for_igvn);
 631 
 632   // GVN that will be run immediately on new nodes
 633   uint estimated_size = method()-&gt;code_size()*4+64;
 634   estimated_size = (estimated_size &lt; MINIMUM_NODE_HASH ? MINIMUM_NODE_HASH : estimated_size);
 635   PhaseGVN gvn(node_arena(), estimated_size);
 636   set_initial_gvn(&amp;gvn);
 637 
 638   print_inlining_init();
 639   { // Scope for timing the parser
 640     TracePhase tp(&quot;parse&quot;, &amp;timers[_t_parser]);
 641 
 642     // Put top into the hash table ASAP.
 643     initial_gvn()-&gt;transform_no_reclaim(top());
 644 
 645     // Set up tf(), start(), and find a CallGenerator.
 646     CallGenerator* cg = NULL;
 647     if (is_osr_compilation()) {
 648       init_tf(TypeFunc::make(method(), /* is_osr_compilation = */ true));
 649       StartNode* s = new StartOSRNode(root(), tf()-&gt;domain_sig());
 650       initial_gvn()-&gt;set_type_bottom(s);
 651       init_start(s);
 652       cg = CallGenerator::for_osr(method(), entry_bci());
 653     } else {
 654       // Normal case.
 655       init_tf(TypeFunc::make(method()));
 656       StartNode* s = new StartNode(root(), tf()-&gt;domain_cc());
 657       initial_gvn()-&gt;set_type_bottom(s);
 658       init_start(s);
 659       if (method()-&gt;intrinsic_id() == vmIntrinsics::_Reference_get) {
 660         // With java.lang.ref.reference.get() we must go through the
 661         // intrinsic - even when get() is the root
 662         // method of the compile - so that, if necessary, the value in
 663         // the referent field of the reference object gets recorded by
 664         // the pre-barrier code.
 665         cg = find_intrinsic(method(), false);
 666       }
 667       if (cg == NULL) {
 668         float past_uses = method()-&gt;interpreter_invocation_count();
 669         float expected_uses = past_uses;
 670         cg = CallGenerator::for_inline(method(), expected_uses);
 671       }
 672     }
 673     if (failing())  return;
 674     if (cg == NULL) {
 675       record_method_not_compilable(&quot;cannot parse method&quot;);
 676       return;
 677     }
 678     JVMState* jvms = build_start_state(start(), tf());
 679     if ((jvms = cg-&gt;generate(jvms)) == NULL) {
 680       if (!failure_reason_is(C2Compiler::retry_class_loading_during_parsing())) {
 681         record_method_not_compilable(&quot;method parse failed&quot;);
 682       }
 683       return;
 684     }
 685     GraphKit kit(jvms);
 686 
 687     if (!kit.stopped()) {
 688       // Accept return values, and transfer control we know not where.
 689       // This is done by a special, unique ReturnNode bound to root.
 690       return_values(kit.jvms());
 691     }
 692 
 693     if (kit.has_exceptions()) {
 694       // Any exceptions that escape from this call must be rethrown
 695       // to whatever caller is dynamically above us on the stack.
 696       // This is done by a special, unique RethrowNode bound to root.
 697       rethrow_exceptions(kit.transfer_exceptions_into_jvms());
 698     }
 699 
 700     assert(IncrementalInline || (_late_inlines.length() == 0 &amp;&amp; !has_mh_late_inlines()), &quot;incremental inlining is off&quot;);
 701 
 702     if (_late_inlines.length() == 0 &amp;&amp; !has_mh_late_inlines() &amp;&amp; !failing() &amp;&amp; has_stringbuilder()) {
 703       inline_string_calls(true);
 704     }
 705 
 706     if (failing())  return;
 707 
 708     print_method(PHASE_BEFORE_REMOVEUSELESS, 3);
 709 
 710     // Remove clutter produced by parsing.
 711     if (!failing()) {
 712       ResourceMark rm;
 713       PhaseRemoveUseless pru(initial_gvn(), &amp;for_igvn);
 714     }
 715   }
 716 
 717   // Note:  Large methods are capped off in do_one_bytecode().
 718   if (failing())  return;
 719 
 720   // After parsing, node notes are no longer automagic.
 721   // They must be propagated by register_new_node_with_optimizer(),
 722   // clone(), or the like.
 723   set_default_node_notes(NULL);
 724 
 725   for (;;) {
 726     int successes = Inline_Warm();
 727     if (failing())  return;
 728     if (successes == 0)  break;
 729   }
 730 
 731   // Drain the list.
 732   Finish_Warm();
 733 #ifndef PRODUCT
<a name="3" id="anc3"></a><span class="line-modified"> 734   if (_printer &amp;&amp; _printer-&gt;should_print(1)) {</span>
 735     _printer-&gt;print_inlining();
 736   }
 737 #endif
 738 
 739   if (failing())  return;
 740   NOT_PRODUCT( verify_graph_edges(); )
 741 
 742   // Now optimize
 743   Optimize();
 744   if (failing())  return;
 745   NOT_PRODUCT( verify_graph_edges(); )
 746 
 747 #ifndef PRODUCT
 748   if (print_ideal()) {
 749     ttyLocker ttyl;  // keep the following output all in one block
 750     // This output goes directly to the tty, not the compiler log.
 751     // To enable tools to match it up with the compilation activity,
 752     // be sure to tag this tty output with the compile ID.
 753     if (xtty != NULL) {
 754       xtty-&gt;head(&quot;ideal compile_id=&#39;%d&#39;%s&quot;, compile_id(),
 755                  is_osr_compilation()    ? &quot; compile_kind=&#39;osr&#39;&quot; :
 756                  &quot;&quot;);
 757     }
 758     root()-&gt;dump(9999);
 759     if (xtty != NULL) {
 760       xtty-&gt;tail(&quot;ideal&quot;);
 761     }
 762   }
 763 #endif
 764 
 765 #ifdef ASSERT
 766   BarrierSetC2* bs = BarrierSet::barrier_set()-&gt;barrier_set_c2();
 767   bs-&gt;verify_gc_barriers(this, BarrierSetC2::BeforeCodeGen);
 768 #endif
 769 
 770   // Dump compilation data to replay it.
 771   if (directive-&gt;DumpReplayOption) {
 772     env()-&gt;dump_replay_data(_compile_id);
 773   }
 774   if (directive-&gt;DumpInlineOption &amp;&amp; (ilt() != NULL)) {
 775     env()-&gt;dump_inline_data(_compile_id);
 776   }
 777 
 778   // Now that we know the size of all the monitors we can add a fixed slot
 779   // for the original deopt pc.
 780   int next_slot = fixed_slots() + (sizeof(address) / VMRegImpl::stack_slot_size);
 781   if (needs_stack_repair()) {
 782     // One extra slot for the special stack increment value
 783     next_slot += 2;
 784   }
 785   set_fixed_slots(next_slot);
 786 
 787   // Compute when to use implicit null checks. Used by matching trap based
 788   // nodes and NullCheck optimization.
 789   set_allowed_deopt_reasons();
 790 
 791   // Now generate code
 792   Code_Gen();
 793 }
 794 
 795 //------------------------------Compile----------------------------------------
 796 // Compile a runtime stub
 797 Compile::Compile( ciEnv* ci_env,
 798                   TypeFunc_generator generator,
 799                   address stub_function,
 800                   const char *stub_name,
 801                   int is_fancy_jump,
 802                   bool pass_tls,
 803                   bool save_arg_registers,
 804                   bool return_pc,
 805                   DirectiveSet* directive)
 806   : Phase(Compiler),
 807     _compile_id(0),
 808     _save_argument_registers(save_arg_registers),
 809     _subsume_loads(true),
 810     _do_escape_analysis(false),
 811     _eliminate_boxing(false),
 812     _method(NULL),
 813     _entry_bci(InvocationEntryBci),
 814     _stub_function(stub_function),
 815     _stub_name(stub_name),
 816     _stub_entry_point(NULL),
 817     _max_node_limit(MaxNodeLimit),
 818     _inlining_progress(false),
 819     _inlining_incrementally(false),
 820     _has_reserved_stack_access(false),
 821 #ifndef PRODUCT
 822     _trace_opto_output(directive-&gt;TraceOptoOutputOption),
 823     _print_ideal(directive-&gt;PrintIdealOption),
 824 #endif
 825     _has_method_handle_invokes(false),
 826     _clinit_barrier_on_entry(false),
 827     _comp_arena(mtCompiler),
 828     _barrier_set_state(BarrierSet::barrier_set()-&gt;barrier_set_c2()-&gt;create_barrier_state(comp_arena())),
 829     _env(ci_env),
 830     _directive(directive),
 831     _log(ci_env-&gt;log()),
 832     _failure_reason(NULL),
 833     _congraph(NULL),
<a name="4" id="anc4"></a><span class="line-modified"> 834 #ifndef PRODUCT</span>
<span class="line-removed"> 835     _printer(NULL),</span>
<span class="line-removed"> 836 #endif</span>
 837     _dead_node_list(comp_arena()),
 838     _dead_node_count(0),
 839     _node_arena(mtCompiler),
 840     _old_arena(mtCompiler),
 841     _mach_constant_base_node(NULL),
 842     _Compile_types(mtCompiler),
 843     _initial_gvn(NULL),
 844     _for_igvn(NULL),
 845     _warm_calls(NULL),
 846     _number_of_mh_late_inlines(0),
 847     _print_inlining_stream(NULL),
 848     _print_inlining_list(NULL),
 849     _print_inlining_idx(0),
 850     _print_inlining_output(NULL),
 851     _replay_inline_data(NULL),
 852     _java_calls(0),
 853     _inner_loops(0),
 854     _interpreter_frame_size(0),
 855 #ifndef PRODUCT
 856     _in_dump_cnt(0),
 857 #endif
 858     _allowed_reasons(0) {
 859   C = this;
 860 
 861   TraceTime t1(NULL, &amp;_t_totalCompilation, CITime, false);
 862   TraceTime t2(NULL, &amp;_t_stubCompilation, CITime, false);
 863 
 864 #ifndef PRODUCT
 865   set_print_assembly(PrintFrameConverterAssembly);
 866   set_parsed_irreducible_loop(false);
 867 #else
 868   set_print_assembly(false); // Must initialize.
 869 #endif
 870   set_has_irreducible_loop(false); // no loops
 871 
 872   CompileWrapper cw(this);
 873   Init(/*AliasLevel=*/ 0);
 874   init_tf((*generator)());
 875 
 876   {
 877     // The following is a dummy for the sake of GraphKit::gen_stub
 878     Unique_Node_List for_igvn(comp_arena());
 879     set_for_igvn(&amp;for_igvn);  // not used, but some GraphKit guys push on this
 880     PhaseGVN gvn(Thread::current()-&gt;resource_area(),255);
 881     set_initial_gvn(&amp;gvn);    // not significant, but GraphKit guys use it pervasively
 882     gvn.transform_no_reclaim(top());
 883 
 884     GraphKit kit;
 885     kit.gen_stub(stub_function, stub_name, is_fancy_jump, pass_tls, return_pc);
 886   }
 887 
 888   NOT_PRODUCT( verify_graph_edges(); )
 889 
 890   Code_Gen();
 891 }
 892 
 893 //------------------------------Init-------------------------------------------
 894 // Prepare for a single compilation
 895 void Compile::Init(int aliaslevel) {
 896   _unique  = 0;
 897   _regalloc = NULL;
 898 
 899   _tf      = NULL;  // filled in later
 900   _top     = NULL;  // cached later
 901   _matcher = NULL;  // filled in later
 902   _cfg     = NULL;  // filled in later
 903 
 904   IA32_ONLY( set_24_bit_selection_and_mode(true, false); )
 905 
 906   _node_note_array = NULL;
 907   _default_node_notes = NULL;
 908   DEBUG_ONLY( _modified_nodes = NULL; ) // Used in Optimize()
 909 
 910   _immutable_memory = NULL; // filled in at first inquiry
 911 
 912   // Globally visible Nodes
 913   // First set TOP to NULL to give safe behavior during creation of RootNode
 914   set_cached_top_node(NULL);
 915   set_root(new RootNode());
 916   // Now that you have a Root to point to, create the real TOP
 917   set_cached_top_node( new ConNode(Type::TOP) );
 918   set_recent_alloc(NULL, NULL);
 919 
 920   // Create Debug Information Recorder to record scopes, oopmaps, etc.
 921   env()-&gt;set_oop_recorder(new OopRecorder(env()-&gt;arena()));
 922   env()-&gt;set_debug_info(new DebugInformationRecorder(env()-&gt;oop_recorder()));
 923   env()-&gt;set_dependencies(new Dependencies(env()));
 924 
 925   _fixed_slots = 0;
 926   set_has_split_ifs(false);
 927   set_has_loops(has_method() &amp;&amp; method()-&gt;has_loops()); // first approximation
 928   set_has_stringbuilder(false);
 929   set_has_boxed_value(false);
 930   _trap_can_recompile = false;  // no traps emitted yet
 931   _major_progress = true; // start out assuming good things will happen
 932   set_has_unsafe_access(false);
 933   set_max_vector_size(0);
 934   set_clear_upper_avx(false);  //false as default for clear upper bits of ymm registers
 935   Copy::zero_to_bytes(_trap_hist, sizeof(_trap_hist));
 936   set_decompile_count(0);
 937 
 938   set_do_freq_based_layout(_directive-&gt;BlockLayoutByFrequencyOption);
 939   _loop_opts_cnt = LoopOptsCount;
 940   _has_flattened_accesses = false;
 941   _flattened_accesses_share_alias = true;
 942 
 943   set_do_inlining(Inline);
 944   set_max_inline_size(MaxInlineSize);
 945   set_freq_inline_size(FreqInlineSize);
 946   set_do_scheduling(OptoScheduling);
 947   set_do_count_invocations(false);
 948   set_do_method_data_update(false);
 949 
 950   set_do_vector_loop(false);
 951 
 952   if (AllowVectorizeOnDemand) {
 953     if (has_method() &amp;&amp; (_directive-&gt;VectorizeOption || _directive-&gt;VectorizeDebugOption)) {
 954       set_do_vector_loop(true);
 955       NOT_PRODUCT(if (do_vector_loop() &amp;&amp; Verbose) {tty-&gt;print(&quot;Compile::Init: do vectorized loops (SIMD like) for method %s\n&quot;,  method()-&gt;name()-&gt;as_quoted_ascii());})
 956     } else if (has_method() &amp;&amp; method()-&gt;name() != 0 &amp;&amp;
 957                method()-&gt;intrinsic_id() == vmIntrinsics::_forEachRemaining) {
 958       set_do_vector_loop(true);
 959     }
 960   }
 961   set_use_cmove(UseCMoveUnconditionally /* || do_vector_loop()*/); //TODO: consider do_vector_loop() mandate use_cmove unconditionally
 962   NOT_PRODUCT(if (use_cmove() &amp;&amp; Verbose &amp;&amp; has_method()) {tty-&gt;print(&quot;Compile::Init: use CMove without profitability tests for method %s\n&quot;,  method()-&gt;name()-&gt;as_quoted_ascii());})
 963 
 964   set_age_code(has_method() &amp;&amp; method()-&gt;profile_aging());
 965   set_rtm_state(NoRTM); // No RTM lock eliding by default
 966   _max_node_limit = _directive-&gt;MaxNodeLimitOption;
 967 
 968 #if INCLUDE_RTM_OPT
 969   if (UseRTMLocking &amp;&amp; has_method() &amp;&amp; (method()-&gt;method_data_or_null() != NULL)) {
 970     int rtm_state = method()-&gt;method_data()-&gt;rtm_state();
 971     if (method_has_option(&quot;NoRTMLockEliding&quot;) || ((rtm_state &amp; NoRTM) != 0)) {
 972       // Don&#39;t generate RTM lock eliding code.
 973       set_rtm_state(NoRTM);
 974     } else if (method_has_option(&quot;UseRTMLockEliding&quot;) || ((rtm_state &amp; UseRTM) != 0) || !UseRTMDeopt) {
 975       // Generate RTM lock eliding code without abort ratio calculation code.
 976       set_rtm_state(UseRTM);
 977     } else if (UseRTMDeopt) {
 978       // Generate RTM lock eliding code and include abort ratio calculation
 979       // code if UseRTMDeopt is on.
 980       set_rtm_state(ProfileRTM);
 981     }
 982   }
 983 #endif
 984   if (VM_Version::supports_fast_class_init_checks() &amp;&amp; has_method() &amp;&amp; !is_osr_compilation() &amp;&amp; method()-&gt;needs_clinit_barrier()) {
 985     set_clinit_barrier_on_entry(true);
 986   }
 987   if (debug_info()-&gt;recording_non_safepoints()) {
 988     set_node_note_array(new(comp_arena()) GrowableArray&lt;Node_Notes*&gt;
 989                         (comp_arena(), 8, 0, NULL));
 990     set_default_node_notes(Node_Notes::make(this));
 991   }
 992 
 993   // // -- Initialize types before each compile --
 994   // // Update cached type information
 995   // if( _method &amp;&amp; _method-&gt;constants() )
 996   //   Type::update_loaded_types(_method, _method-&gt;constants());
 997 
 998   // Init alias_type map.
 999   if (!_do_escape_analysis &amp;&amp; aliaslevel == 3)
1000     aliaslevel = 2;  // No unique types without escape analysis
1001   _AliasLevel = aliaslevel;
1002   const int grow_ats = 16;
1003   _max_alias_types = grow_ats;
1004   _alias_types   = NEW_ARENA_ARRAY(comp_arena(), AliasType*, grow_ats);
1005   AliasType* ats = NEW_ARENA_ARRAY(comp_arena(), AliasType,  grow_ats);
1006   Copy::zero_to_bytes(ats, sizeof(AliasType)*grow_ats);
1007   {
1008     for (int i = 0; i &lt; grow_ats; i++)  _alias_types[i] = &amp;ats[i];
1009   }
1010   // Initialize the first few types.
1011   _alias_types[AliasIdxTop]-&gt;Init(AliasIdxTop, NULL);
1012   _alias_types[AliasIdxBot]-&gt;Init(AliasIdxBot, TypePtr::BOTTOM);
1013   _alias_types[AliasIdxRaw]-&gt;Init(AliasIdxRaw, TypeRawPtr::BOTTOM);
1014   _num_alias_types = AliasIdxRaw+1;
1015   // Zero out the alias type cache.
1016   Copy::zero_to_bytes(_alias_cache, sizeof(_alias_cache));
1017   // A NULL adr_type hits in the cache right away.  Preload the right answer.
1018   probe_alias_cache(NULL)-&gt;_index = AliasIdxTop;
1019 
1020   _intrinsics = NULL;
1021   _macro_nodes = new(comp_arena()) GrowableArray&lt;Node*&gt;(comp_arena(), 8,  0, NULL);
1022   _predicate_opaqs = new(comp_arena()) GrowableArray&lt;Node*&gt;(comp_arena(), 8,  0, NULL);
1023   _expensive_nodes = new(comp_arena()) GrowableArray&lt;Node*&gt;(comp_arena(), 8,  0, NULL);
1024   _range_check_casts = new(comp_arena()) GrowableArray&lt;Node*&gt;(comp_arena(), 8,  0, NULL);
1025   _opaque4_nodes = new(comp_arena()) GrowableArray&lt;Node*&gt;(comp_arena(), 8,  0, NULL);
1026   _value_type_nodes = new(comp_arena()) GrowableArray&lt;Node*&gt;(comp_arena(), 8,  0, NULL);
1027   register_library_intrinsics();
1028 #ifdef ASSERT
1029   _type_verify_symmetry = true;
1030 #endif
1031 }
1032 
1033 //---------------------------init_start----------------------------------------
1034 // Install the StartNode on this compile object.
1035 void Compile::init_start(StartNode* s) {
1036   if (failing())
1037     return; // already failing
1038   assert(s == start(), &quot;&quot;);
1039 }
1040 
1041 /**
1042  * Return the &#39;StartNode&#39;. We must not have a pending failure, since the ideal graph
1043  * can be in an inconsistent state, i.e., we can get segmentation faults when traversing
1044  * the ideal graph.
1045  */
1046 StartNode* Compile::start() const {
1047   assert (!failing(), &quot;Must not have pending failure. Reason is: %s&quot;, failure_reason());
1048   for (DUIterator_Fast imax, i = root()-&gt;fast_outs(imax); i &lt; imax; i++) {
1049     Node* start = root()-&gt;fast_out(i);
1050     if (start-&gt;is_Start()) {
1051       return start-&gt;as_Start();
1052     }
1053   }
1054   fatal(&quot;Did not find Start node!&quot;);
1055   return NULL;
1056 }
1057 
1058 //-------------------------------immutable_memory-------------------------------------
1059 // Access immutable memory
1060 Node* Compile::immutable_memory() {
1061   if (_immutable_memory != NULL) {
1062     return _immutable_memory;
1063   }
1064   StartNode* s = start();
1065   for (DUIterator_Fast imax, i = s-&gt;fast_outs(imax); true; i++) {
1066     Node *p = s-&gt;fast_out(i);
1067     if (p != s &amp;&amp; p-&gt;as_Proj()-&gt;_con == TypeFunc::Memory) {
1068       _immutable_memory = p;
1069       return _immutable_memory;
1070     }
1071   }
1072   ShouldNotReachHere();
1073   return NULL;
1074 }
1075 
1076 //----------------------set_cached_top_node------------------------------------
1077 // Install the cached top node, and make sure Node::is_top works correctly.
1078 void Compile::set_cached_top_node(Node* tn) {
1079   if (tn != NULL)  verify_top(tn);
1080   Node* old_top = _top;
1081   _top = tn;
1082   // Calling Node::setup_is_top allows the nodes the chance to adjust
1083   // their _out arrays.
1084   if (_top != NULL)     _top-&gt;setup_is_top();
1085   if (old_top != NULL)  old_top-&gt;setup_is_top();
1086   assert(_top == NULL || top()-&gt;is_top(), &quot;&quot;);
1087 }
1088 
1089 #ifdef ASSERT
1090 uint Compile::count_live_nodes_by_graph_walk() {
1091   Unique_Node_List useful(comp_arena());
1092   // Get useful node list by walking the graph.
1093   identify_useful_nodes(useful);
1094   return useful.size();
1095 }
1096 
1097 void Compile::print_missing_nodes() {
1098 
1099   // Return if CompileLog is NULL and PrintIdealNodeCount is false.
1100   if ((_log == NULL) &amp;&amp; (! PrintIdealNodeCount)) {
1101     return;
1102   }
1103 
1104   // This is an expensive function. It is executed only when the user
1105   // specifies VerifyIdealNodeCount option or otherwise knows the
1106   // additional work that needs to be done to identify reachable nodes
1107   // by walking the flow graph and find the missing ones using
1108   // _dead_node_list.
1109 
1110   Unique_Node_List useful(comp_arena());
1111   // Get useful node list by walking the graph.
1112   identify_useful_nodes(useful);
1113 
1114   uint l_nodes = C-&gt;live_nodes();
1115   uint l_nodes_by_walk = useful.size();
1116 
1117   if (l_nodes != l_nodes_by_walk) {
1118     if (_log != NULL) {
1119       _log-&gt;begin_head(&quot;mismatched_nodes count=&#39;%d&#39;&quot;, abs((int) (l_nodes - l_nodes_by_walk)));
1120       _log-&gt;stamp();
1121       _log-&gt;end_head();
1122     }
1123     VectorSet&amp; useful_member_set = useful.member_set();
1124     int last_idx = l_nodes_by_walk;
1125     for (int i = 0; i &lt; last_idx; i++) {
1126       if (useful_member_set.test(i)) {
1127         if (_dead_node_list.test(i)) {
1128           if (_log != NULL) {
1129             _log-&gt;elem(&quot;mismatched_node_info node_idx=&#39;%d&#39; type=&#39;both live and dead&#39;&quot;, i);
1130           }
1131           if (PrintIdealNodeCount) {
1132             // Print the log message to tty
1133               tty-&gt;print_cr(&quot;mismatched_node idx=&#39;%d&#39; both live and dead&#39;&quot;, i);
1134               useful.at(i)-&gt;dump();
1135           }
1136         }
1137       }
1138       else if (! _dead_node_list.test(i)) {
1139         if (_log != NULL) {
1140           _log-&gt;elem(&quot;mismatched_node_info node_idx=&#39;%d&#39; type=&#39;neither live nor dead&#39;&quot;, i);
1141         }
1142         if (PrintIdealNodeCount) {
1143           // Print the log message to tty
1144           tty-&gt;print_cr(&quot;mismatched_node idx=&#39;%d&#39; type=&#39;neither live nor dead&#39;&quot;, i);
1145         }
1146       }
1147     }
1148     if (_log != NULL) {
1149       _log-&gt;tail(&quot;mismatched_nodes&quot;);
1150     }
1151   }
1152 }
1153 void Compile::record_modified_node(Node* n) {
1154   if (_modified_nodes != NULL &amp;&amp; !_inlining_incrementally &amp;&amp;
1155       n-&gt;outcnt() != 0 &amp;&amp; !n-&gt;is_Con()) {
1156     _modified_nodes-&gt;push(n);
1157   }
1158 }
1159 
1160 void Compile::remove_modified_node(Node* n) {
1161   if (_modified_nodes != NULL) {
1162     _modified_nodes-&gt;remove(n);
1163   }
1164 }
1165 #endif
1166 
1167 #ifndef PRODUCT
1168 void Compile::verify_top(Node* tn) const {
1169   if (tn != NULL) {
1170     assert(tn-&gt;is_Con(), &quot;top node must be a constant&quot;);
1171     assert(((ConNode*)tn)-&gt;type() == Type::TOP, &quot;top node must have correct type&quot;);
1172     assert(tn-&gt;in(0) != NULL, &quot;must have live top node&quot;);
1173   }
1174 }
1175 #endif
1176 
1177 
1178 ///-------------------Managing Per-Node Debug &amp; Profile Info-------------------
1179 
1180 void Compile::grow_node_notes(GrowableArray&lt;Node_Notes*&gt;* arr, int grow_by) {
1181   guarantee(arr != NULL, &quot;&quot;);
1182   int num_blocks = arr-&gt;length();
1183   if (grow_by &lt; num_blocks)  grow_by = num_blocks;
1184   int num_notes = grow_by * _node_notes_block_size;
1185   Node_Notes* notes = NEW_ARENA_ARRAY(node_arena(), Node_Notes, num_notes);
1186   Copy::zero_to_bytes(notes, num_notes * sizeof(Node_Notes));
1187   while (num_notes &gt; 0) {
1188     arr-&gt;append(notes);
1189     notes     += _node_notes_block_size;
1190     num_notes -= _node_notes_block_size;
1191   }
1192   assert(num_notes == 0, &quot;exact multiple, please&quot;);
1193 }
1194 
1195 bool Compile::copy_node_notes_to(Node* dest, Node* source) {
1196   if (source == NULL || dest == NULL)  return false;
1197 
1198   if (dest-&gt;is_Con())
1199     return false;               // Do not push debug info onto constants.
1200 
1201 #ifdef ASSERT
1202   // Leave a bread crumb trail pointing to the original node:
1203   if (dest != NULL &amp;&amp; dest != source &amp;&amp; dest-&gt;debug_orig() == NULL) {
1204     dest-&gt;set_debug_orig(source);
1205   }
1206 #endif
1207 
1208   if (node_note_array() == NULL)
1209     return false;               // Not collecting any notes now.
1210 
1211   // This is a copy onto a pre-existing node, which may already have notes.
1212   // If both nodes have notes, do not overwrite any pre-existing notes.
1213   Node_Notes* source_notes = node_notes_at(source-&gt;_idx);
1214   if (source_notes == NULL || source_notes-&gt;is_clear())  return false;
1215   Node_Notes* dest_notes   = node_notes_at(dest-&gt;_idx);
1216   if (dest_notes == NULL || dest_notes-&gt;is_clear()) {
1217     return set_node_notes_at(dest-&gt;_idx, source_notes);
1218   }
1219 
1220   Node_Notes merged_notes = (*source_notes);
1221   // The order of operations here ensures that dest notes will win...
1222   merged_notes.update_from(dest_notes);
1223   return set_node_notes_at(dest-&gt;_idx, &amp;merged_notes);
1224 }
1225 
1226 
1227 //--------------------------allow_range_check_smearing-------------------------
1228 // Gating condition for coalescing similar range checks.
1229 // Sometimes we try &#39;speculatively&#39; replacing a series of a range checks by a
1230 // single covering check that is at least as strong as any of them.
1231 // If the optimization succeeds, the simplified (strengthened) range check
1232 // will always succeed.  If it fails, we will deopt, and then give up
1233 // on the optimization.
1234 bool Compile::allow_range_check_smearing() const {
1235   // If this method has already thrown a range-check,
1236   // assume it was because we already tried range smearing
1237   // and it failed.
1238   uint already_trapped = trap_count(Deoptimization::Reason_range_check);
1239   return !already_trapped;
1240 }
1241 
1242 
1243 //------------------------------flatten_alias_type-----------------------------
1244 const TypePtr *Compile::flatten_alias_type( const TypePtr *tj ) const {
1245   int offset = tj-&gt;offset();
1246   TypePtr::PTR ptr = tj-&gt;ptr();
1247 
1248   // Known instance (scalarizable allocation) alias only with itself.
1249   bool is_known_inst = tj-&gt;isa_oopptr() != NULL &amp;&amp;
1250                        tj-&gt;is_oopptr()-&gt;is_known_instance();
1251 
1252   // Process weird unsafe references.
1253   if (offset == Type::OffsetBot &amp;&amp; (tj-&gt;isa_instptr() /*|| tj-&gt;isa_klassptr()*/)) {
1254     bool default_value_load = EnableValhalla &amp;&amp; tj-&gt;is_instptr()-&gt;klass() == ciEnv::current()-&gt;Class_klass();
1255     assert(InlineUnsafeOps || default_value_load, &quot;indeterminate pointers come only from unsafe ops&quot;);
1256     assert(!is_known_inst, &quot;scalarizable allocation should not have unsafe references&quot;);
1257     tj = TypeOopPtr::BOTTOM;
1258     ptr = tj-&gt;ptr();
1259     offset = tj-&gt;offset();
1260   }
1261 
1262   // Array pointers need some flattening
1263   const TypeAryPtr *ta = tj-&gt;isa_aryptr();
1264   if (ta &amp;&amp; ta-&gt;is_stable()) {
1265     // Erase stability property for alias analysis.
1266     tj = ta = ta-&gt;cast_to_stable(false);
1267   }
1268   if (ta &amp;&amp; ta-&gt;is_not_flat()) {
1269     // Erase not flat property for alias analysis.
1270     tj = ta = ta-&gt;cast_to_not_flat(false);
1271   }
1272   if (ta &amp;&amp; ta-&gt;is_not_null_free()) {
1273     // Erase not null free property for alias analysis.
1274     tj = ta = ta-&gt;cast_to_not_null_free(false);
1275   }
1276 
1277   if( ta &amp;&amp; is_known_inst ) {
1278     if ( offset != Type::OffsetBot &amp;&amp;
1279          offset &gt; arrayOopDesc::length_offset_in_bytes() ) {
1280       offset = Type::OffsetBot; // Flatten constant access into array body only
1281       tj = ta = TypeAryPtr::make(ptr, ta-&gt;ary(), ta-&gt;klass(), true, Type::Offset(offset), ta-&gt;field_offset(), ta-&gt;instance_id());
1282     }
1283   } else if( ta &amp;&amp; _AliasLevel &gt;= 2 ) {
1284     // For arrays indexed by constant indices, we flatten the alias
1285     // space to include all of the array body.  Only the header, klass
1286     // and array length can be accessed un-aliased.
1287     // For flattened value type array, each field has its own slice so
1288     // we must include the field offset.
1289     if( offset != Type::OffsetBot ) {
1290       if( ta-&gt;const_oop() ) { // MethodData* or Method*
1291         offset = Type::OffsetBot;   // Flatten constant access into array body
1292         tj = ta = TypeAryPtr::make(ptr,ta-&gt;const_oop(),ta-&gt;ary(),ta-&gt;klass(),false,Type::Offset(offset), ta-&gt;field_offset());
1293       } else if( offset == arrayOopDesc::length_offset_in_bytes() ) {
1294         // range is OK as-is.
1295         tj = ta = TypeAryPtr::RANGE;
1296       } else if( offset == oopDesc::klass_offset_in_bytes() ) {
1297         tj = TypeInstPtr::KLASS; // all klass loads look alike
1298         ta = TypeAryPtr::RANGE; // generic ignored junk
1299         ptr = TypePtr::BotPTR;
1300       } else if( offset == oopDesc::mark_offset_in_bytes() ) {
1301         tj = TypeInstPtr::MARK;
1302         ta = TypeAryPtr::RANGE; // generic ignored junk
1303         ptr = TypePtr::BotPTR;
1304       } else {                  // Random constant offset into array body
1305         offset = Type::OffsetBot;   // Flatten constant access into array body
1306         tj = ta = TypeAryPtr::make(ptr,ta-&gt;ary(),ta-&gt;klass(),false,Type::Offset(offset), ta-&gt;field_offset());
1307       }
1308     }
1309     // Arrays of fixed size alias with arrays of unknown size.
1310     if (ta-&gt;size() != TypeInt::POS) {
1311       const TypeAry *tary = TypeAry::make(ta-&gt;elem(), TypeInt::POS);
1312       tj = ta = TypeAryPtr::make(ptr,ta-&gt;const_oop(),tary,ta-&gt;klass(),false,Type::Offset(offset), ta-&gt;field_offset());
1313     }
1314     // Arrays of known objects become arrays of unknown objects.
1315     if (ta-&gt;elem()-&gt;isa_narrowoop() &amp;&amp; ta-&gt;elem() != TypeNarrowOop::BOTTOM) {
1316       const TypeAry *tary = TypeAry::make(TypeNarrowOop::BOTTOM, ta-&gt;size());
1317       tj = ta = TypeAryPtr::make(ptr,ta-&gt;const_oop(),tary,NULL,false,Type::Offset(offset), ta-&gt;field_offset());
1318     }
1319     if (ta-&gt;elem()-&gt;isa_oopptr() &amp;&amp; ta-&gt;elem() != TypeInstPtr::BOTTOM) {
1320       const TypeAry *tary = TypeAry::make(TypeInstPtr::BOTTOM, ta-&gt;size());
1321       tj = ta = TypeAryPtr::make(ptr,ta-&gt;const_oop(),tary,NULL,false,Type::Offset(offset), ta-&gt;field_offset());
1322     }
1323     // Initially all flattened array accesses share a single slice
1324     if (ta-&gt;elem()-&gt;isa_valuetype() &amp;&amp; ta-&gt;elem() != TypeValueType::BOTTOM &amp;&amp; _flattened_accesses_share_alias) {
1325       const TypeAry *tary = TypeAry::make(TypeValueType::BOTTOM, ta-&gt;size());
1326       tj = ta = TypeAryPtr::make(ptr,ta-&gt;const_oop(),tary,NULL,false,Type::Offset(offset), Type::Offset(Type::OffsetBot));
1327     }
1328     // Arrays of bytes and of booleans both use &#39;bastore&#39; and &#39;baload&#39; so
1329     // cannot be distinguished by bytecode alone.
1330     if (ta-&gt;elem() == TypeInt::BOOL) {
1331       const TypeAry *tary = TypeAry::make(TypeInt::BYTE, ta-&gt;size());
1332       ciKlass* aklass = ciTypeArrayKlass::make(T_BYTE);
1333       tj = ta = TypeAryPtr::make(ptr,ta-&gt;const_oop(),tary,aklass,false,Type::Offset(offset), ta-&gt;field_offset());
1334     }
1335     // During the 2nd round of IterGVN, NotNull castings are removed.
1336     // Make sure the Bottom and NotNull variants alias the same.
1337     // Also, make sure exact and non-exact variants alias the same.
1338     if (ptr == TypePtr::NotNull || ta-&gt;klass_is_exact() || ta-&gt;speculative() != NULL) {
1339       tj = ta = TypeAryPtr::make(TypePtr::BotPTR,ta-&gt;ary(),ta-&gt;klass(),false,Type::Offset(offset), ta-&gt;field_offset());
1340     }
1341   }
1342 
1343   // Oop pointers need some flattening
1344   const TypeInstPtr *to = tj-&gt;isa_instptr();
1345   if( to &amp;&amp; _AliasLevel &gt;= 2 &amp;&amp; to != TypeOopPtr::BOTTOM ) {
1346     ciInstanceKlass *k = to-&gt;klass()-&gt;as_instance_klass();
1347     if( ptr == TypePtr::Constant ) {
1348       if (to-&gt;klass() != ciEnv::current()-&gt;Class_klass() ||
1349           offset &lt; k-&gt;size_helper() * wordSize) {
1350         // No constant oop pointers (such as Strings); they alias with
1351         // unknown strings.
1352         assert(!is_known_inst, &quot;not scalarizable allocation&quot;);
1353         tj = to = TypeInstPtr::make(TypePtr::BotPTR,to-&gt;klass(),false,0,Type::Offset(offset), to-&gt;klass()-&gt;flatten_array());
1354       }
1355     } else if( is_known_inst ) {
1356       tj = to; // Keep NotNull and klass_is_exact for instance type
1357     } else if( ptr == TypePtr::NotNull || to-&gt;klass_is_exact() ) {
1358       // During the 2nd round of IterGVN, NotNull castings are removed.
1359       // Make sure the Bottom and NotNull variants alias the same.
1360       // Also, make sure exact and non-exact variants alias the same.
1361       tj = to = TypeInstPtr::make(TypePtr::BotPTR,to-&gt;klass(),false,0,Type::Offset(offset), to-&gt;klass()-&gt;flatten_array());
1362     }
1363     if (to-&gt;speculative() != NULL) {
1364       tj = to = TypeInstPtr::make(to-&gt;ptr(),to-&gt;klass(),to-&gt;klass_is_exact(),to-&gt;const_oop(),Type::Offset(to-&gt;offset()), to-&gt;klass()-&gt;flatten_array(), to-&gt;instance_id());
1365     }
1366     // Canonicalize the holder of this field
1367     if (offset &gt;= 0 &amp;&amp; offset &lt; instanceOopDesc::base_offset_in_bytes()) {
1368       // First handle header references such as a LoadKlassNode, even if the
1369       // object&#39;s klass is unloaded at compile time (4965979).
1370       if (!is_known_inst) { // Do it only for non-instance types
1371         tj = to = TypeInstPtr::make(TypePtr::BotPTR, env()-&gt;Object_klass(), false, NULL, Type::Offset(offset), false);
1372       }
1373     } else if (offset &lt; 0 || offset &gt;= k-&gt;size_helper() * wordSize) {
1374       // Static fields are in the space above the normal instance
1375       // fields in the java.lang.Class instance.
1376       if (to-&gt;klass() != ciEnv::current()-&gt;Class_klass()) {
1377         to = NULL;
1378         tj = TypeOopPtr::BOTTOM;
1379         offset = tj-&gt;offset();
1380       }
1381     } else {
1382       ciInstanceKlass *canonical_holder = k-&gt;get_canonical_holder(offset);
1383       if (!k-&gt;equals(canonical_holder) || tj-&gt;offset() != offset) {
1384         if( is_known_inst ) {
1385           tj = to = TypeInstPtr::make(to-&gt;ptr(), canonical_holder, true, NULL, Type::Offset(offset), canonical_holder-&gt;flatten_array(), to-&gt;instance_id());
1386         } else {
1387           tj = to = TypeInstPtr::make(to-&gt;ptr(), canonical_holder, false, NULL, Type::Offset(offset), canonical_holder-&gt;flatten_array());
1388         }
1389       }
1390     }
1391   }
1392 
1393   // Klass pointers to object array klasses need some flattening
1394   const TypeKlassPtr *tk = tj-&gt;isa_klassptr();
1395   if( tk ) {
1396     // If we are referencing a field within a Klass, we need
1397     // to assume the worst case of an Object.  Both exact and
1398     // inexact types must flatten to the same alias class so
1399     // use NotNull as the PTR.
1400     if ( offset == Type::OffsetBot || (offset &gt;= 0 &amp;&amp; (size_t)offset &lt; sizeof(Klass)) ) {
1401 
1402       tj = tk = TypeKlassPtr::make(TypePtr::NotNull,
1403                                    TypeKlassPtr::OBJECT-&gt;klass(),
1404                                    Type::Offset(offset),
1405                                    false);
1406     }
1407 
1408     ciKlass* klass = tk-&gt;klass();
1409     if (klass != NULL &amp;&amp; klass-&gt;is_obj_array_klass()) {
1410       ciKlass* k = TypeAryPtr::OOPS-&gt;klass();
1411       if( !k || !k-&gt;is_loaded() )                  // Only fails for some -Xcomp runs
1412         k = TypeInstPtr::BOTTOM-&gt;klass();
1413       tj = tk = TypeKlassPtr::make(TypePtr::NotNull, k, Type::Offset(offset), false);
1414     }
1415 
1416     // Check for precise loads from the primary supertype array and force them
1417     // to the supertype cache alias index.  Check for generic array loads from
1418     // the primary supertype array and also force them to the supertype cache
1419     // alias index.  Since the same load can reach both, we need to merge
1420     // these 2 disparate memories into the same alias class.  Since the
1421     // primary supertype array is read-only, there&#39;s no chance of confusion
1422     // where we bypass an array load and an array store.
1423     int primary_supers_offset = in_bytes(Klass::primary_supers_offset());
1424     if (offset == Type::OffsetBot ||
1425         (offset &gt;= primary_supers_offset &amp;&amp;
1426          offset &lt; (int)(primary_supers_offset + Klass::primary_super_limit() * wordSize)) ||
1427         offset == (int)in_bytes(Klass::secondary_super_cache_offset())) {
1428       offset = in_bytes(Klass::secondary_super_cache_offset());
1429       tj = tk = TypeKlassPtr::make(TypePtr::NotNull, tk-&gt;klass(), Type::Offset(offset), tk-&gt;flat_array());
1430     }
1431   }
1432 
1433   // Flatten all Raw pointers together.
1434   if (tj-&gt;base() == Type::RawPtr)
1435     tj = TypeRawPtr::BOTTOM;
1436 
1437   if (tj-&gt;base() == Type::AnyPtr)
1438     tj = TypePtr::BOTTOM;      // An error, which the caller must check for.
1439 
1440   // Flatten all to bottom for now
1441   switch( _AliasLevel ) {
1442   case 0:
1443     tj = TypePtr::BOTTOM;
1444     break;
1445   case 1:                       // Flatten to: oop, static, field or array
1446     switch (tj-&gt;base()) {
1447     //case Type::AryPtr: tj = TypeAryPtr::RANGE;    break;
1448     case Type::RawPtr:   tj = TypeRawPtr::BOTTOM;   break;
1449     case Type::AryPtr:   // do not distinguish arrays at all
1450     case Type::InstPtr:  tj = TypeInstPtr::BOTTOM;  break;
1451     case Type::KlassPtr: tj = TypeKlassPtr::OBJECT; break;
1452     case Type::AnyPtr:   tj = TypePtr::BOTTOM;      break;  // caller checks it
1453     default: ShouldNotReachHere();
1454     }
1455     break;
1456   case 2:                       // No collapsing at level 2; keep all splits
1457   case 3:                       // No collapsing at level 3; keep all splits
1458     break;
1459   default:
1460     Unimplemented();
1461   }
1462 
1463   offset = tj-&gt;offset();
1464   assert( offset != Type::OffsetTop, &quot;Offset has fallen from constant&quot; );
1465 
1466   assert( (offset != Type::OffsetBot &amp;&amp; tj-&gt;base() != Type::AryPtr) ||
1467           (offset == Type::OffsetBot &amp;&amp; tj-&gt;base() == Type::AryPtr) ||
1468           (offset == Type::OffsetBot &amp;&amp; tj == TypeOopPtr::BOTTOM) ||
1469           (offset == Type::OffsetBot &amp;&amp; tj == TypePtr::BOTTOM) ||
1470           (offset == oopDesc::mark_offset_in_bytes() &amp;&amp; tj-&gt;base() == Type::AryPtr) ||
1471           (offset == oopDesc::klass_offset_in_bytes() &amp;&amp; tj-&gt;base() == Type::AryPtr) ||
1472           (offset == arrayOopDesc::length_offset_in_bytes() &amp;&amp; tj-&gt;base() == Type::AryPtr),
1473           &quot;For oops, klasses, raw offset must be constant; for arrays the offset is never known&quot; );
1474   assert( tj-&gt;ptr() != TypePtr::TopPTR &amp;&amp;
1475           tj-&gt;ptr() != TypePtr::AnyNull &amp;&amp;
1476           tj-&gt;ptr() != TypePtr::Null, &quot;No imprecise addresses&quot; );
1477 //    assert( tj-&gt;ptr() != TypePtr::Constant ||
1478 //            tj-&gt;base() == Type::RawPtr ||
1479 //            tj-&gt;base() == Type::KlassPtr, &quot;No constant oop addresses&quot; );
1480 
1481   return tj;
1482 }
1483 
1484 void Compile::AliasType::Init(int i, const TypePtr* at) {
1485   assert(AliasIdxTop &lt;= i &amp;&amp; i &lt; Compile::current()-&gt;_max_alias_types, &quot;Invalid alias index&quot;);
1486   _index = i;
1487   _adr_type = at;
1488   _field = NULL;
1489   _element = NULL;
1490   _is_rewritable = true; // default
1491   const TypeOopPtr *atoop = (at != NULL) ? at-&gt;isa_oopptr() : NULL;
1492   if (atoop != NULL &amp;&amp; atoop-&gt;is_known_instance()) {
1493     const TypeOopPtr *gt = atoop-&gt;cast_to_instance_id(TypeOopPtr::InstanceBot);
1494     _general_index = Compile::current()-&gt;get_alias_index(gt);
1495   } else {
1496     _general_index = 0;
1497   }
1498 }
1499 
1500 BasicType Compile::AliasType::basic_type() const {
1501   if (element() != NULL) {
1502     const Type* element = adr_type()-&gt;is_aryptr()-&gt;elem();
1503     return element-&gt;isa_narrowoop() ? T_OBJECT : element-&gt;array_element_basic_type();
1504   } if (field() != NULL) {
1505     return field()-&gt;layout_type();
1506   } else {
1507     return T_ILLEGAL; // unknown
1508   }
1509 }
1510 
1511 //---------------------------------print_on------------------------------------
1512 #ifndef PRODUCT
1513 void Compile::AliasType::print_on(outputStream* st) {
1514   if (index() &lt; 10)
1515         st-&gt;print(&quot;@ &lt;%d&gt; &quot;, index());
1516   else  st-&gt;print(&quot;@ &lt;%d&gt;&quot;,  index());
1517   st-&gt;print(is_rewritable() ? &quot;   &quot; : &quot; RO&quot;);
1518   int offset = adr_type()-&gt;offset();
1519   if (offset == Type::OffsetBot)
1520         st-&gt;print(&quot; +any&quot;);
1521   else  st-&gt;print(&quot; +%-3d&quot;, offset);
1522   st-&gt;print(&quot; in &quot;);
1523   adr_type()-&gt;dump_on(st);
1524   const TypeOopPtr* tjp = adr_type()-&gt;isa_oopptr();
1525   if (field() != NULL &amp;&amp; tjp) {
1526     if (tjp-&gt;klass()  != field()-&gt;holder() ||
1527         tjp-&gt;offset() != field()-&gt;offset_in_bytes()) {
1528       st-&gt;print(&quot; != &quot;);
1529       field()-&gt;print();
1530       st-&gt;print(&quot; ***&quot;);
1531     }
1532   }
1533 }
1534 
1535 void print_alias_types() {
1536   Compile* C = Compile::current();
1537   tty-&gt;print_cr(&quot;--- Alias types, AliasIdxBot .. %d&quot;, C-&gt;num_alias_types()-1);
1538   for (int idx = Compile::AliasIdxBot; idx &lt; C-&gt;num_alias_types(); idx++) {
1539     C-&gt;alias_type(idx)-&gt;print_on(tty);
1540     tty-&gt;cr();
1541   }
1542 }
1543 #endif
1544 
1545 
1546 //----------------------------probe_alias_cache--------------------------------
1547 Compile::AliasCacheEntry* Compile::probe_alias_cache(const TypePtr* adr_type) {
1548   intptr_t key = (intptr_t) adr_type;
1549   key ^= key &gt;&gt; logAliasCacheSize;
1550   return &amp;_alias_cache[key &amp; right_n_bits(logAliasCacheSize)];
1551 }
1552 
1553 
1554 //-----------------------------grow_alias_types--------------------------------
1555 void Compile::grow_alias_types() {
1556   const int old_ats  = _max_alias_types; // how many before?
1557   const int new_ats  = old_ats;          // how many more?
1558   const int grow_ats = old_ats+new_ats;  // how many now?
1559   _max_alias_types = grow_ats;
1560   _alias_types =  REALLOC_ARENA_ARRAY(comp_arena(), AliasType*, _alias_types, old_ats, grow_ats);
1561   AliasType* ats =    NEW_ARENA_ARRAY(comp_arena(), AliasType, new_ats);
1562   Copy::zero_to_bytes(ats, sizeof(AliasType)*new_ats);
1563   for (int i = 0; i &lt; new_ats; i++)  _alias_types[old_ats+i] = &amp;ats[i];
1564 }
1565 
1566 
1567 //--------------------------------find_alias_type------------------------------
1568 Compile::AliasType* Compile::find_alias_type(const TypePtr* adr_type, bool no_create, ciField* original_field, bool uncached) {
1569   if (_AliasLevel == 0)
1570     return alias_type(AliasIdxBot);
1571 
1572   AliasCacheEntry* ace = NULL;
1573   if (!uncached) {
1574     ace = probe_alias_cache(adr_type);
1575     if (ace-&gt;_adr_type == adr_type) {
1576       return alias_type(ace-&gt;_index);
1577     }
1578   }
1579 
1580   // Handle special cases.
1581   if (adr_type == NULL)             return alias_type(AliasIdxTop);
1582   if (adr_type == TypePtr::BOTTOM)  return alias_type(AliasIdxBot);
1583 
1584   // Do it the slow way.
1585   const TypePtr* flat = flatten_alias_type(adr_type);
1586 
1587 #ifdef ASSERT
1588   {
1589     ResourceMark rm;
1590     assert(flat == flatten_alias_type(flat), &quot;not idempotent: adr_type = %s; flat = %s =&gt; %s&quot;,
1591            Type::str(adr_type), Type::str(flat), Type::str(flatten_alias_type(flat)));
1592     assert(flat != TypePtr::BOTTOM, &quot;cannot alias-analyze an untyped ptr: adr_type = %s&quot;,
1593            Type::str(adr_type));
1594     if (flat-&gt;isa_oopptr() &amp;&amp; !flat-&gt;isa_klassptr()) {
1595       const TypeOopPtr* foop = flat-&gt;is_oopptr();
1596       // Scalarizable allocations have exact klass always.
1597       bool exact = !foop-&gt;klass_is_exact() || foop-&gt;is_known_instance();
1598       const TypePtr* xoop = foop-&gt;cast_to_exactness(exact)-&gt;is_ptr();
1599       assert(foop == flatten_alias_type(xoop), &quot;exactness must not affect alias type: foop = %s; xoop = %s&quot;,
1600              Type::str(foop), Type::str(xoop));
1601     }
1602   }
1603 #endif
1604 
1605   int idx = AliasIdxTop;
1606   for (int i = 0; i &lt; num_alias_types(); i++) {
1607     if (alias_type(i)-&gt;adr_type() == flat) {
1608       idx = i;
1609       break;
1610     }
1611   }
1612 
1613   if (idx == AliasIdxTop) {
1614     if (no_create)  return NULL;
1615     // Grow the array if necessary.
1616     if (_num_alias_types == _max_alias_types)  grow_alias_types();
1617     // Add a new alias type.
1618     idx = _num_alias_types++;
1619     _alias_types[idx]-&gt;Init(idx, flat);
1620     if (flat == TypeInstPtr::KLASS)  alias_type(idx)-&gt;set_rewritable(false);
1621     if (flat == TypeAryPtr::RANGE)   alias_type(idx)-&gt;set_rewritable(false);
1622     if (flat-&gt;isa_instptr()) {
1623       if (flat-&gt;offset() == java_lang_Class::klass_offset()
1624           &amp;&amp; flat-&gt;is_instptr()-&gt;klass() == env()-&gt;Class_klass())
1625         alias_type(idx)-&gt;set_rewritable(false);
1626     }
1627     ciField* field = NULL;
1628     if (flat-&gt;isa_aryptr()) {
1629 #ifdef ASSERT
1630       const int header_size_min  = arrayOopDesc::base_offset_in_bytes(T_BYTE);
1631       // (T_BYTE has the weakest alignment and size restrictions...)
1632       assert(flat-&gt;offset() &lt; header_size_min, &quot;array body reference must be OffsetBot&quot;);
1633 #endif
1634       const Type* elemtype = flat-&gt;is_aryptr()-&gt;elem();
1635       if (flat-&gt;offset() == TypePtr::OffsetBot) {
1636         alias_type(idx)-&gt;set_element(elemtype);
1637       }
1638       int field_offset = flat-&gt;is_aryptr()-&gt;field_offset().get();
1639       if (elemtype-&gt;isa_valuetype() &amp;&amp;
1640           elemtype-&gt;value_klass() != NULL &amp;&amp;
1641           field_offset != Type::OffsetBot) {
1642         ciValueKlass* vk = elemtype-&gt;value_klass();
1643         field_offset += vk-&gt;first_field_offset();
1644         field = vk-&gt;get_field_by_offset(field_offset, false);
1645       }
1646     }
1647     if (flat-&gt;isa_klassptr()) {
1648       if (flat-&gt;offset() == in_bytes(Klass::super_check_offset_offset()))
1649         alias_type(idx)-&gt;set_rewritable(false);
1650       if (flat-&gt;offset() == in_bytes(Klass::modifier_flags_offset()))
1651         alias_type(idx)-&gt;set_rewritable(false);
1652       if (flat-&gt;offset() == in_bytes(Klass::access_flags_offset()))
1653         alias_type(idx)-&gt;set_rewritable(false);
1654       if (flat-&gt;offset() == in_bytes(Klass::java_mirror_offset()))
1655         alias_type(idx)-&gt;set_rewritable(false);
1656       if (flat-&gt;offset() == in_bytes(Klass::layout_helper_offset()))
1657         alias_type(idx)-&gt;set_rewritable(false);
1658       if (flat-&gt;offset() == in_bytes(Klass::secondary_super_cache_offset()))
1659         alias_type(idx)-&gt;set_rewritable(false);
1660     }
1661     // %%% (We would like to finalize JavaThread::threadObj_offset(),
1662     // but the base pointer type is not distinctive enough to identify
1663     // references into JavaThread.)
1664 
1665     // Check for final fields.
1666     const TypeInstPtr* tinst = flat-&gt;isa_instptr();
1667     if (tinst &amp;&amp; tinst-&gt;offset() &gt;= instanceOopDesc::base_offset_in_bytes()) {
1668       if (tinst-&gt;const_oop() != NULL &amp;&amp;
1669           tinst-&gt;klass() == ciEnv::current()-&gt;Class_klass() &amp;&amp;
1670           tinst-&gt;offset() &gt;= (tinst-&gt;klass()-&gt;as_instance_klass()-&gt;size_helper() * wordSize)) {
1671         // static field
1672         ciInstanceKlass* k = tinst-&gt;const_oop()-&gt;as_instance()-&gt;java_lang_Class_klass()-&gt;as_instance_klass();
1673         field = k-&gt;get_field_by_offset(tinst-&gt;offset(), true);
1674       } else if (tinst-&gt;klass()-&gt;is_valuetype()) {
1675         // Value type field
1676         ciValueKlass* vk = tinst-&gt;value_klass();
1677         field = vk-&gt;get_field_by_offset(tinst-&gt;offset(), false);
1678       } else {
1679         ciInstanceKlass* k = tinst-&gt;klass()-&gt;as_instance_klass();
1680         field = k-&gt;get_field_by_offset(tinst-&gt;offset(), false);
1681       }
1682     }
1683     assert(field == NULL ||
1684            original_field == NULL ||
1685            (field-&gt;holder() == original_field-&gt;holder() &amp;&amp;
1686             field-&gt;offset() == original_field-&gt;offset() &amp;&amp;
1687             field-&gt;is_static() == original_field-&gt;is_static()), &quot;wrong field?&quot;);
1688     // Set field() and is_rewritable() attributes.
1689     if (field != NULL) {
1690       alias_type(idx)-&gt;set_field(field);
1691       if (flat-&gt;isa_aryptr()) {
1692         // Fields of flattened inline type arrays are rewritable although they are declared final
1693         assert(flat-&gt;is_aryptr()-&gt;elem()-&gt;isa_valuetype(), &quot;must be a flattened value array&quot;);
1694         alias_type(idx)-&gt;set_rewritable(true);
1695       }
1696     }
1697   }
1698 
1699   // Fill the cache for next time.
1700   if (!uncached) {
1701     ace-&gt;_adr_type = adr_type;
1702     ace-&gt;_index    = idx;
1703     assert(alias_type(adr_type) == alias_type(idx),  &quot;type must be installed&quot;);
1704 
1705     // Might as well try to fill the cache for the flattened version, too.
1706     AliasCacheEntry* face = probe_alias_cache(flat);
1707     if (face-&gt;_adr_type == NULL) {
1708       face-&gt;_adr_type = flat;
1709       face-&gt;_index    = idx;
1710       assert(alias_type(flat) == alias_type(idx), &quot;flat type must work too&quot;);
1711     }
1712   }
1713 
1714   return alias_type(idx);
1715 }
1716 
1717 
1718 Compile::AliasType* Compile::alias_type(ciField* field) {
1719   const TypeOopPtr* t;
1720   if (field-&gt;is_static())
1721     t = TypeInstPtr::make(field-&gt;holder()-&gt;java_mirror());
1722   else
1723     t = TypeOopPtr::make_from_klass_raw(field-&gt;holder());
1724   AliasType* atp = alias_type(t-&gt;add_offset(field-&gt;offset_in_bytes()), field);
1725   assert((field-&gt;is_final() || field-&gt;is_stable()) == !atp-&gt;is_rewritable(), &quot;must get the rewritable bits correct&quot;);
1726   return atp;
1727 }
1728 
1729 
1730 //------------------------------have_alias_type--------------------------------
1731 bool Compile::have_alias_type(const TypePtr* adr_type) {
1732   AliasCacheEntry* ace = probe_alias_cache(adr_type);
1733   if (ace-&gt;_adr_type == adr_type) {
1734     return true;
1735   }
1736 
1737   // Handle special cases.
1738   if (adr_type == NULL)             return true;
1739   if (adr_type == TypePtr::BOTTOM)  return true;
1740 
1741   return find_alias_type(adr_type, true, NULL) != NULL;
1742 }
1743 
1744 //-----------------------------must_alias--------------------------------------
1745 // True if all values of the given address type are in the given alias category.
1746 bool Compile::must_alias(const TypePtr* adr_type, int alias_idx) {
1747   if (alias_idx == AliasIdxBot)         return true;  // the universal category
1748   if (adr_type == NULL)                 return true;  // NULL serves as TypePtr::TOP
1749   if (alias_idx == AliasIdxTop)         return false; // the empty category
1750   if (adr_type-&gt;base() == Type::AnyPtr) return false; // TypePtr::BOTTOM or its twins
1751 
1752   // the only remaining possible overlap is identity
1753   int adr_idx = get_alias_index(adr_type);
1754   assert(adr_idx != AliasIdxBot &amp;&amp; adr_idx != AliasIdxTop, &quot;&quot;);
1755   assert(adr_idx == alias_idx ||
1756          (alias_type(alias_idx)-&gt;adr_type() != TypeOopPtr::BOTTOM
1757           &amp;&amp; adr_type                       != TypeOopPtr::BOTTOM),
1758          &quot;should not be testing for overlap with an unsafe pointer&quot;);
1759   return adr_idx == alias_idx;
1760 }
1761 
1762 //------------------------------can_alias--------------------------------------
1763 // True if any values of the given address type are in the given alias category.
1764 bool Compile::can_alias(const TypePtr* adr_type, int alias_idx) {
1765   if (alias_idx == AliasIdxTop)         return false; // the empty category
1766   if (adr_type == NULL)                 return false; // NULL serves as TypePtr::TOP
1767   // Known instance doesn&#39;t alias with bottom memory
1768   if (alias_idx == AliasIdxBot)         return !adr_type-&gt;is_known_instance();                   // the universal category
1769   if (adr_type-&gt;base() == Type::AnyPtr) return !C-&gt;get_adr_type(alias_idx)-&gt;is_known_instance(); // TypePtr::BOTTOM or its twins
1770 
1771   // the only remaining possible overlap is identity
1772   int adr_idx = get_alias_index(adr_type);
1773   assert(adr_idx != AliasIdxBot &amp;&amp; adr_idx != AliasIdxTop, &quot;&quot;);
1774   return adr_idx == alias_idx;
1775 }
1776 
1777 
1778 
1779 //---------------------------pop_warm_call-------------------------------------
1780 WarmCallInfo* Compile::pop_warm_call() {
1781   WarmCallInfo* wci = _warm_calls;
1782   if (wci != NULL)  _warm_calls = wci-&gt;remove_from(wci);
1783   return wci;
1784 }
1785 
1786 //----------------------------Inline_Warm--------------------------------------
1787 int Compile::Inline_Warm() {
1788   // If there is room, try to inline some more warm call sites.
1789   // %%% Do a graph index compaction pass when we think we&#39;re out of space?
1790   if (!InlineWarmCalls)  return 0;
1791 
1792   int calls_made_hot = 0;
1793   int room_to_grow   = NodeCountInliningCutoff - unique();
1794   int amount_to_grow = MIN2(room_to_grow, (int)NodeCountInliningStep);
1795   int amount_grown   = 0;
1796   WarmCallInfo* call;
1797   while (amount_to_grow &gt; 0 &amp;&amp; (call = pop_warm_call()) != NULL) {
1798     int est_size = (int)call-&gt;size();
1799     if (est_size &gt; (room_to_grow - amount_grown)) {
1800       // This one won&#39;t fit anyway.  Get rid of it.
1801       call-&gt;make_cold();
1802       continue;
1803     }
1804     call-&gt;make_hot();
1805     calls_made_hot++;
1806     amount_grown   += est_size;
1807     amount_to_grow -= est_size;
1808   }
1809 
1810   if (calls_made_hot &gt; 0)  set_major_progress();
1811   return calls_made_hot;
1812 }
1813 
1814 
1815 //----------------------------Finish_Warm--------------------------------------
1816 void Compile::Finish_Warm() {
1817   if (!InlineWarmCalls)  return;
1818   if (failing())  return;
1819   if (warm_calls() == NULL)  return;
1820 
1821   // Clean up loose ends, if we are out of space for inlining.
1822   WarmCallInfo* call;
1823   while ((call = pop_warm_call()) != NULL) {
1824     call-&gt;make_cold();
1825   }
1826 }
1827 
1828 //---------------------cleanup_loop_predicates-----------------------
1829 // Remove the opaque nodes that protect the predicates so that all unused
1830 // checks and uncommon_traps will be eliminated from the ideal graph
1831 void Compile::cleanup_loop_predicates(PhaseIterGVN &amp;igvn) {
1832   if (predicate_count()==0) return;
1833   for (int i = predicate_count(); i &gt; 0; i--) {
1834     Node * n = predicate_opaque1_node(i-1);
1835     assert(n-&gt;Opcode() == Op_Opaque1, &quot;must be&quot;);
1836     igvn.replace_node(n, n-&gt;in(1));
1837   }
1838   assert(predicate_count()==0, &quot;should be clean!&quot;);
1839 }
1840 
1841 void Compile::add_range_check_cast(Node* n) {
1842   assert(n-&gt;isa_CastII()-&gt;has_range_check(), &quot;CastII should have range check dependency&quot;);
1843   assert(!_range_check_casts-&gt;contains(n), &quot;duplicate entry in range check casts&quot;);
1844   _range_check_casts-&gt;append(n);
1845 }
1846 
1847 // Remove all range check dependent CastIINodes.
1848 void Compile::remove_range_check_casts(PhaseIterGVN &amp;igvn) {
1849   for (int i = range_check_cast_count(); i &gt; 0; i--) {
1850     Node* cast = range_check_cast_node(i-1);
1851     assert(cast-&gt;isa_CastII()-&gt;has_range_check(), &quot;CastII should have range check dependency&quot;);
1852     igvn.replace_node(cast, cast-&gt;in(1));
1853   }
1854   assert(range_check_cast_count() == 0, &quot;should be empty&quot;);
1855 }
1856 
1857 void Compile::add_opaque4_node(Node* n) {
1858   assert(n-&gt;Opcode() == Op_Opaque4, &quot;Opaque4 only&quot;);
1859   assert(!_opaque4_nodes-&gt;contains(n), &quot;duplicate entry in Opaque4 list&quot;);
1860   _opaque4_nodes-&gt;append(n);
1861 }
1862 
1863 // Remove all Opaque4 nodes.
1864 void Compile::remove_opaque4_nodes(PhaseIterGVN &amp;igvn) {
1865   for (int i = opaque4_count(); i &gt; 0; i--) {
1866     Node* opaq = opaque4_node(i-1);
1867     assert(opaq-&gt;Opcode() == Op_Opaque4, &quot;Opaque4 only&quot;);
1868     igvn.replace_node(opaq, opaq-&gt;in(2));
1869   }
1870   assert(opaque4_count() == 0, &quot;should be empty&quot;);
1871 }
1872 
1873 void Compile::add_value_type(Node* n) {
1874   assert(n-&gt;is_ValueTypeBase(), &quot;unexpected node&quot;);
1875   if (_value_type_nodes != NULL) {
1876     _value_type_nodes-&gt;push(n);
1877   }
1878 }
1879 
1880 void Compile::remove_value_type(Node* n) {
1881   assert(n-&gt;is_ValueTypeBase(), &quot;unexpected node&quot;);
1882   if (_value_type_nodes != NULL &amp;&amp; _value_type_nodes-&gt;contains(n)) {
1883     _value_type_nodes-&gt;remove(n);
1884   }
1885 }
1886 
1887 // Does the return value keep otherwise useless value type allocations alive?
1888 static bool return_val_keeps_allocations_alive(Node* ret_val) {
1889   ResourceMark rm;
1890   Unique_Node_List wq;
1891   wq.push(ret_val);
1892   bool some_allocations = false;
1893   for (uint i = 0; i &lt; wq.size(); i++) {
1894     Node* n = wq.at(i);
1895     assert(!n-&gt;is_ValueType(), &quot;chain of value type nodes&quot;);
1896     if (n-&gt;outcnt() &gt; 1) {
1897       // Some other use for the allocation
1898       return false;
1899     } else if (n-&gt;is_ValueTypePtr()) {
1900       wq.push(n-&gt;in(1));
1901     } else if (n-&gt;is_Phi()) {
1902       for (uint j = 1; j &lt; n-&gt;req(); j++) {
1903         wq.push(n-&gt;in(j));
1904       }
1905     } else if (n-&gt;is_CheckCastPP() &amp;&amp;
1906                n-&gt;in(1)-&gt;is_Proj() &amp;&amp;
1907                n-&gt;in(1)-&gt;in(0)-&gt;is_Allocate()) {
1908       some_allocations = true;
1909     }
1910   }
1911   return some_allocations;
1912 }
1913 
1914 void Compile::process_value_types(PhaseIterGVN &amp;igvn, bool post_ea) {
1915   // Make value types scalar in safepoints
1916   for (int i = _value_type_nodes-&gt;length()-1; i &gt;= 0; i--) {
1917     ValueTypeBaseNode* vt = _value_type_nodes-&gt;at(i)-&gt;as_ValueTypeBase();
1918     vt-&gt;make_scalar_in_safepoints(&amp;igvn);
1919   }
1920   // Remove ValueTypePtr nodes only after EA to give scalar replacement a chance
1921   // to remove buffer allocations. ValueType nodes are kept until loop opts and
1922   // removed via ValueTypeNode::remove_redundant_allocations.
1923   if (post_ea) {
1924     while (_value_type_nodes-&gt;length() &gt; 0) {
1925       ValueTypeBaseNode* vt = _value_type_nodes-&gt;pop()-&gt;as_ValueTypeBase();
1926       if (vt-&gt;is_ValueTypePtr()) {
1927         igvn.replace_node(vt, vt-&gt;get_oop());
1928       }
1929     }
1930   }
1931   // Make sure that the return value does not keep an unused allocation alive
1932   if (tf()-&gt;returns_value_type_as_fields()) {
1933     Node* ret = NULL;
1934     for (uint i = 1; i &lt; root()-&gt;req(); i++){
1935       Node* in = root()-&gt;in(i);
1936       if (in-&gt;Opcode() == Op_Return) {
1937         assert(ret == NULL, &quot;only one return&quot;);
1938         ret = in;
1939       }
1940     }
1941     if (ret != NULL) {
1942       Node* ret_val = ret-&gt;in(TypeFunc::Parms);
1943       if (igvn.type(ret_val)-&gt;isa_oopptr() &amp;&amp;
1944           return_val_keeps_allocations_alive(ret_val)) {
1945         igvn.replace_input_of(ret, TypeFunc::Parms, ValueTypeNode::tagged_klass(igvn.type(ret_val)-&gt;value_klass(), igvn));
1946         assert(ret_val-&gt;outcnt() == 0, &quot;should be dead now&quot;);
1947         igvn.remove_dead_node(ret_val);
1948       }
1949     }
1950   }
1951   igvn.optimize();
1952 }
1953 
1954 void Compile::adjust_flattened_array_access_aliases(PhaseIterGVN&amp; igvn) {
1955   if (!_has_flattened_accesses) {
1956     return;
1957   }
1958   // Initially, all flattened array accesses share the same slice to
1959   // keep dependencies with Object[] array accesses (that could be
1960   // to a flattened array) correct. We&#39;re done with parsing so we
1961   // now know all flattened array accesses in this compile
1962   // unit. Let&#39;s move flattened array accesses to their own slice,
1963   // one per element field. This should help memory access
1964   // optimizations.
1965   ResourceMark rm;
1966   Unique_Node_List wq;
1967   wq.push(root());
1968 
1969   Node_List mergememnodes;
1970   Node_List memnodes;
1971 
1972   // Alias index currently shared by all flattened memory accesses
1973   int index = get_alias_index(TypeAryPtr::VALUES);
1974 
1975   // Find MergeMem nodes and flattened array accesses
1976   for (uint i = 0; i &lt; wq.size(); i++) {
1977     Node* n = wq.at(i);
1978     if (n-&gt;is_Mem()) {
1979       const TypePtr* adr_type = NULL;
1980       if (n-&gt;Opcode() == Op_StoreCM) {
1981         adr_type = get_adr_type(get_alias_index(n-&gt;in(MemNode::OopStore)-&gt;adr_type()));
1982       } else {
1983         adr_type = get_adr_type(get_alias_index(n-&gt;adr_type()));
1984       }
1985       if (adr_type == TypeAryPtr::VALUES) {
1986         memnodes.push(n);
1987       }
1988     } else if (n-&gt;is_MergeMem()) {
1989       MergeMemNode* mm = n-&gt;as_MergeMem();
1990       if (mm-&gt;memory_at(index) != mm-&gt;base_memory()) {
1991         mergememnodes.push(n);
1992       }
1993     }
1994     for (uint j = 0; j &lt; n-&gt;req(); j++) {
1995       Node* m = n-&gt;in(j);
1996       if (m != NULL) {
1997         wq.push(m);
1998       }
1999     }
2000   }
2001 
2002   if (memnodes.size() &gt; 0) {
2003     _flattened_accesses_share_alias = false;
2004 
2005     // We are going to change the slice for the flattened array
2006     // accesses so we need to clear the cache entries that refer to
2007     // them.
2008     for (uint i = 0; i &lt; AliasCacheSize; i++) {
2009       AliasCacheEntry* ace = &amp;_alias_cache[i];
2010       if (ace-&gt;_adr_type != NULL &amp;&amp;
2011           ace-&gt;_adr_type-&gt;isa_aryptr() &amp;&amp;
2012           ace-&gt;_adr_type-&gt;is_aryptr()-&gt;elem()-&gt;isa_valuetype()) {
2013         ace-&gt;_adr_type = NULL;
2014         ace-&gt;_index = (i != 0) ? 0 : AliasIdxTop; // Make sure the NULL adr_type resolves to AliasIdxTop
2015       }
2016     }
2017 
2018     // Find what aliases we are going to add
2019     int start_alias = num_alias_types()-1;
2020     int stop_alias = 0;
2021 
2022     for (uint i = 0; i &lt; memnodes.size(); i++) {
2023       Node* m = memnodes.at(i);
2024       const TypePtr* adr_type = NULL;
2025       if (m-&gt;Opcode() == Op_StoreCM) {
2026         adr_type = m-&gt;in(MemNode::OopStore)-&gt;adr_type();
2027         Node* clone = new StoreCMNode(m-&gt;in(MemNode::Control), m-&gt;in(MemNode::Memory), m-&gt;in(MemNode::Address),
2028                                       m-&gt;adr_type(), m-&gt;in(MemNode::ValueIn), m-&gt;in(MemNode::OopStore),
2029                                       get_alias_index(adr_type));
2030         igvn.register_new_node_with_optimizer(clone);
2031         igvn.replace_node(m, clone);
2032       } else {
2033         adr_type = m-&gt;adr_type();
2034 #ifdef ASSERT
2035         m-&gt;as_Mem()-&gt;set_adr_type(adr_type);
2036 #endif
2037       }
2038       int idx = get_alias_index(adr_type);
2039       start_alias = MIN2(start_alias, idx);
2040       stop_alias = MAX2(stop_alias, idx);
2041     }
2042 
2043     assert(stop_alias &gt;= start_alias, &quot;should have expanded aliases&quot;);
2044 
2045     Node_Stack stack(0);
2046 #ifdef ASSERT
2047     VectorSet seen(Thread::current()-&gt;resource_area());
2048 #endif
2049     // Now let&#39;s fix the memory graph so each flattened array access
2050     // is moved to the right slice. Start from the MergeMem nodes.
2051     uint last = unique();
2052     for (uint i = 0; i &lt; mergememnodes.size(); i++) {
2053       MergeMemNode* current = mergememnodes.at(i)-&gt;as_MergeMem();
2054       Node* n = current-&gt;memory_at(index);
2055       MergeMemNode* mm = NULL;
2056       do {
2057         // Follow memory edges through memory accesses, phis and
2058         // narrow membars and push nodes on the stack. Once we hit
2059         // bottom memory, we pop element off the stack one at a
2060         // time, in reverse order, and move them to the right slice
2061         // by changing their memory edges.
2062         if ((n-&gt;is_Phi() &amp;&amp; n-&gt;adr_type() != TypePtr::BOTTOM) || n-&gt;is_Mem() || n-&gt;adr_type() == TypeAryPtr::VALUES) {
2063           assert(!seen.test_set(n-&gt;_idx), &quot;&quot;);
2064           // Uses (a load for instance) will need to be moved to the
2065           // right slice as well and will get a new memory state
2066           // that we don&#39;t know yet. The use could also be the
2067           // backedge of a loop. We put a place holder node between
2068           // the memory node and its uses. We replace that place
2069           // holder with the correct memory state once we know it,
2070           // i.e. when nodes are popped off the stack. Using the
2071           // place holder make the logic work in the presence of
2072           // loops.
2073           if (n-&gt;outcnt() &gt; 1) {
2074             Node* place_holder = NULL;
2075             assert(!n-&gt;has_out_with(Op_Node), &quot;&quot;);
2076             for (DUIterator k = n-&gt;outs(); n-&gt;has_out(k); k++) {
2077               Node* u = n-&gt;out(k);
2078               if (u != current &amp;&amp; u-&gt;_idx &lt; last) {
2079                 bool success = false;
2080                 for (uint l = 0; l &lt; u-&gt;req(); l++) {
2081                   if (!stack.is_empty() &amp;&amp; u == stack.node() &amp;&amp; l == stack.index()) {
2082                     continue;
2083                   }
2084                   Node* in = u-&gt;in(l);
2085                   if (in == n) {
2086                     if (place_holder == NULL) {
2087                       place_holder = new Node(1);
2088                       place_holder-&gt;init_req(0, n);
2089                     }
2090                     igvn.replace_input_of(u, l, place_holder);
2091                     success = true;
2092                   }
2093                 }
2094                 if (success) {
2095                   --k;
2096                 }
2097               }
2098             }
2099           }
2100           if (n-&gt;is_Phi()) {
2101             stack.push(n, 1);
2102             n = n-&gt;in(1);
2103           } else if (n-&gt;is_Mem()) {
2104             stack.push(n, n-&gt;req());
2105             n = n-&gt;in(MemNode::Memory);
2106           } else {
2107             assert(n-&gt;is_Proj() &amp;&amp; n-&gt;in(0)-&gt;Opcode() == Op_MemBarCPUOrder, &quot;&quot;);
2108             stack.push(n, n-&gt;req());
2109             n = n-&gt;in(0)-&gt;in(TypeFunc::Memory);
2110           }
2111         } else {
2112           assert(n-&gt;adr_type() == TypePtr::BOTTOM || (n-&gt;Opcode() == Op_Node &amp;&amp; n-&gt;_idx &gt;= last) || (n-&gt;is_Proj() &amp;&amp; n-&gt;in(0)-&gt;is_Initialize()), &quot;&quot;);
2113           // Build a new MergeMem node to carry the new memory state
2114           // as we build it. IGVN should fold extraneous MergeMem
2115           // nodes.
2116           mm = MergeMemNode::make(n);
2117           igvn.register_new_node_with_optimizer(mm);
2118           while (stack.size() &gt; 0) {
2119             Node* m = stack.node();
2120             uint idx = stack.index();
2121             if (m-&gt;is_Mem()) {
2122               // Move memory node to its new slice
2123               const TypePtr* adr_type = m-&gt;adr_type();
2124               int alias = get_alias_index(adr_type);
2125               Node* prev = mm-&gt;memory_at(alias);
2126               igvn.replace_input_of(m, MemNode::Memory, prev);
2127               mm-&gt;set_memory_at(alias, m);
2128             } else if (m-&gt;is_Phi()) {
2129               // We need as many new phis as there are new aliases
2130               igvn.replace_input_of(m, idx, mm);
2131               if (idx == m-&gt;req()-1) {
2132                 Node* r = m-&gt;in(0);
2133                 for (uint j = (uint)start_alias; j &lt;= (uint)stop_alias; j++) {
2134                   const Type* adr_type = get_adr_type(j);
2135                   if (!adr_type-&gt;isa_aryptr() || !adr_type-&gt;is_aryptr()-&gt;elem()-&gt;isa_valuetype()) {
2136                     continue;
2137                   }
2138                   Node* phi = new PhiNode(r, Type::MEMORY, get_adr_type(j));
2139                   igvn.register_new_node_with_optimizer(phi);
2140                   for (uint k = 1; k &lt; m-&gt;req(); k++) {
2141                     phi-&gt;init_req(k, m-&gt;in(k)-&gt;as_MergeMem()-&gt;memory_at(j));
2142                   }
2143                   mm-&gt;set_memory_at(j, phi);
2144                 }
2145                 Node* base_phi = new PhiNode(r, Type::MEMORY, TypePtr::BOTTOM);
2146                 igvn.register_new_node_with_optimizer(base_phi);
2147                 for (uint k = 1; k &lt; m-&gt;req(); k++) {
2148                   base_phi-&gt;init_req(k, m-&gt;in(k)-&gt;as_MergeMem()-&gt;base_memory());
2149                 }
2150                 mm-&gt;set_base_memory(base_phi);
2151               }
2152             } else {
2153               // This is a MemBarCPUOrder node from
2154               // Parse::array_load()/Parse::array_store(), in the
2155               // branch that handles flattened arrays hidden under
2156               // an Object[] array. We also need one new membar per
2157               // new alias to keep the unknown access that the
2158               // membars protect properly ordered with accesses to
2159               // known flattened array.
2160               assert(m-&gt;is_Proj(), &quot;projection expected&quot;);
2161               Node* ctrl = m-&gt;in(0)-&gt;in(TypeFunc::Control);
2162               igvn.replace_input_of(m-&gt;in(0), TypeFunc::Control, top());
2163               for (uint j = (uint)start_alias; j &lt;= (uint)stop_alias; j++) {
2164                 const Type* adr_type = get_adr_type(j);
2165                 if (!adr_type-&gt;isa_aryptr() || !adr_type-&gt;is_aryptr()-&gt;elem()-&gt;isa_valuetype()) {
2166                   continue;
2167                 }
2168                 MemBarNode* mb = new MemBarCPUOrderNode(this, j, NULL);
2169                 igvn.register_new_node_with_optimizer(mb);
2170                 Node* mem = mm-&gt;memory_at(j);
2171                 mb-&gt;init_req(TypeFunc::Control, ctrl);
2172                 mb-&gt;init_req(TypeFunc::Memory, mem);
2173                 ctrl = new ProjNode(mb, TypeFunc::Control);
2174                 igvn.register_new_node_with_optimizer(ctrl);
2175                 mem = new ProjNode(mb, TypeFunc::Memory);
2176                 igvn.register_new_node_with_optimizer(mem);
2177                 mm-&gt;set_memory_at(j, mem);
2178               }
2179               igvn.replace_node(m-&gt;in(0)-&gt;as_Multi()-&gt;proj_out(TypeFunc::Control), ctrl);
2180             }
2181             if (idx &lt; m-&gt;req()-1) {
2182               idx += 1;
2183               stack.set_index(idx);
2184               n = m-&gt;in(idx);
2185               break;
2186             }
2187             // Take care of place holder nodes
2188             if (m-&gt;has_out_with(Op_Node)) {
2189               Node* place_holder = m-&gt;find_out_with(Op_Node);
2190               if (place_holder != NULL) {
2191                 Node* mm_clone = mm-&gt;clone();
2192                 igvn.register_new_node_with_optimizer(mm_clone);
2193                 Node* hook = new Node(1);
2194                 hook-&gt;init_req(0, mm);
2195                 igvn.replace_node(place_holder, mm_clone);
2196                 hook-&gt;destruct();
2197               }
2198               assert(!m-&gt;has_out_with(Op_Node), &quot;place holder should be gone now&quot;);
2199             }
2200             stack.pop();
2201           }
2202         }
2203       } while(stack.size() &gt; 0);
2204       // Fix the memory state at the MergeMem we started from
2205       igvn.rehash_node_delayed(current);
2206       for (uint j = (uint)start_alias; j &lt;= (uint)stop_alias; j++) {
2207         const Type* adr_type = get_adr_type(j);
2208         if (!adr_type-&gt;isa_aryptr() || !adr_type-&gt;is_aryptr()-&gt;elem()-&gt;isa_valuetype()) {
2209           continue;
2210         }
2211         current-&gt;set_memory_at(j, mm);
2212       }
2213       current-&gt;set_memory_at(index, current-&gt;base_memory());
2214     }
2215     igvn.optimize();
2216   }
2217   print_method(PHASE_SPLIT_VALUES_ARRAY, 2);
2218 }
2219 
2220 
2221 // StringOpts and late inlining of string methods
2222 void Compile::inline_string_calls(bool parse_time) {
2223   {
2224     // remove useless nodes to make the usage analysis simpler
2225     ResourceMark rm;
2226     PhaseRemoveUseless pru(initial_gvn(), for_igvn());
2227   }
2228 
2229   {
2230     ResourceMark rm;
2231     print_method(PHASE_BEFORE_STRINGOPTS, 3);
2232     PhaseStringOpts pso(initial_gvn(), for_igvn());
2233     print_method(PHASE_AFTER_STRINGOPTS, 3);
2234   }
2235 
2236   // now inline anything that we skipped the first time around
2237   if (!parse_time) {
2238     _late_inlines_pos = _late_inlines.length();
2239   }
2240 
2241   while (_string_late_inlines.length() &gt; 0) {
2242     CallGenerator* cg = _string_late_inlines.pop();
2243     cg-&gt;do_late_inline();
2244     if (failing())  return;
2245   }
2246   _string_late_inlines.trunc_to(0);
2247 }
2248 
2249 // Late inlining of boxing methods
2250 void Compile::inline_boxing_calls(PhaseIterGVN&amp; igvn) {
2251   if (_boxing_late_inlines.length() &gt; 0) {
2252     assert(has_boxed_value(), &quot;inconsistent&quot;);
2253 
2254     PhaseGVN* gvn = initial_gvn();
2255     set_inlining_incrementally(true);
2256 
2257     assert( igvn._worklist.size() == 0, &quot;should be done with igvn&quot; );
2258     for_igvn()-&gt;clear();
2259     gvn-&gt;replace_with(&amp;igvn);
2260 
2261     _late_inlines_pos = _late_inlines.length();
2262 
2263     while (_boxing_late_inlines.length() &gt; 0) {
2264       CallGenerator* cg = _boxing_late_inlines.pop();
2265       cg-&gt;do_late_inline();
2266       if (failing())  return;
2267     }
2268     _boxing_late_inlines.trunc_to(0);
2269 
2270     inline_incrementally_cleanup(igvn);
2271 
2272     set_inlining_incrementally(false);
2273   }
2274 }
2275 
2276 bool Compile::inline_incrementally_one() {
2277   assert(IncrementalInline, &quot;incremental inlining should be on&quot;);
2278 
2279   TracePhase tp(&quot;incrementalInline_inline&quot;, &amp;timers[_t_incrInline_inline]);
2280   set_inlining_progress(false);
2281   set_do_cleanup(false);
2282   int i = 0;
2283   for (; i &lt;_late_inlines.length() &amp;&amp; !inlining_progress(); i++) {
2284     CallGenerator* cg = _late_inlines.at(i);
2285     _late_inlines_pos = i+1;
2286     cg-&gt;do_late_inline();
2287     if (failing())  return false;
2288   }
2289   int j = 0;
2290   for (; i &lt; _late_inlines.length(); i++, j++) {
2291     _late_inlines.at_put(j, _late_inlines.at(i));
2292   }
2293   _late_inlines.trunc_to(j);
2294   assert(inlining_progress() || _late_inlines.length() == 0, &quot;&quot;);
2295 
2296   bool needs_cleanup = do_cleanup() || over_inlining_cutoff();
2297 
2298   set_inlining_progress(false);
2299   set_do_cleanup(false);
2300   return (_late_inlines.length() &gt; 0) &amp;&amp; !needs_cleanup;
2301 }
2302 
2303 void Compile::inline_incrementally_cleanup(PhaseIterGVN&amp; igvn) {
2304   {
2305     TracePhase tp(&quot;incrementalInline_pru&quot;, &amp;timers[_t_incrInline_pru]);
2306     ResourceMark rm;
2307     PhaseRemoveUseless pru(initial_gvn(), for_igvn());
2308   }
2309   {
2310     TracePhase tp(&quot;incrementalInline_igvn&quot;, &amp;timers[_t_incrInline_igvn]);
2311     igvn = PhaseIterGVN(initial_gvn());
2312     igvn.optimize();
2313   }
2314 }
2315 
2316 // Perform incremental inlining until bound on number of live nodes is reached
2317 void Compile::inline_incrementally(PhaseIterGVN&amp; igvn) {
2318   TracePhase tp(&quot;incrementalInline&quot;, &amp;timers[_t_incrInline]);
2319 
2320   set_inlining_incrementally(true);
2321   uint low_live_nodes = 0;
2322 
2323   while (_late_inlines.length() &gt; 0) {
2324     if (live_nodes() &gt; (uint)LiveNodeCountInliningCutoff) {
2325       if (low_live_nodes &lt; (uint)LiveNodeCountInliningCutoff * 8 / 10) {
2326         TracePhase tp(&quot;incrementalInline_ideal&quot;, &amp;timers[_t_incrInline_ideal]);
2327         // PhaseIdealLoop is expensive so we only try it once we are
2328         // out of live nodes and we only try it again if the previous
2329         // helped got the number of nodes down significantly
2330         PhaseIdealLoop::optimize(igvn, LoopOptsNone);
2331         if (failing())  return;
2332         low_live_nodes = live_nodes();
2333         _major_progress = true;
2334       }
2335 
2336       if (live_nodes() &gt; (uint)LiveNodeCountInliningCutoff) {
2337         break; // finish
2338       }
2339     }
2340 
2341     for_igvn()-&gt;clear();
2342     initial_gvn()-&gt;replace_with(&amp;igvn);
2343 
2344     while (inline_incrementally_one()) {
2345       assert(!failing(), &quot;inconsistent&quot;);
2346     }
2347 
2348     if (failing())  return;
2349 
2350     inline_incrementally_cleanup(igvn);
2351 
2352     if (failing())  return;
2353   }
2354   assert( igvn._worklist.size() == 0, &quot;should be done with igvn&quot; );
2355 
2356   if (_string_late_inlines.length() &gt; 0) {
2357     assert(has_stringbuilder(), &quot;inconsistent&quot;);
2358     for_igvn()-&gt;clear();
2359     initial_gvn()-&gt;replace_with(&amp;igvn);
2360 
2361     inline_string_calls(false);
2362 
2363     if (failing())  return;
2364 
2365     inline_incrementally_cleanup(igvn);
2366   }
2367 
2368   set_inlining_incrementally(false);
2369 }
2370 
2371 
2372 bool Compile::optimize_loops(PhaseIterGVN&amp; igvn, LoopOptsMode mode) {
2373   if(_loop_opts_cnt &gt; 0) {
2374     debug_only( int cnt = 0; );
2375     while(major_progress() &amp;&amp; (_loop_opts_cnt &gt; 0)) {
2376       TracePhase tp(&quot;idealLoop&quot;, &amp;timers[_t_idealLoop]);
2377       assert( cnt++ &lt; 40, &quot;infinite cycle in loop optimization&quot; );
2378       PhaseIdealLoop::optimize(igvn, mode);
2379       _loop_opts_cnt--;
2380       if (failing())  return false;
2381       if (major_progress()) print_method(PHASE_PHASEIDEALLOOP_ITERATIONS, 2);
2382     }
2383   }
2384   return true;
2385 }
2386 
2387 // Remove edges from &quot;root&quot; to each SafePoint at a backward branch.
2388 // They were inserted during parsing (see add_safepoint()) to make
2389 // infinite loops without calls or exceptions visible to root, i.e.,
2390 // useful.
2391 void Compile::remove_root_to_sfpts_edges(PhaseIterGVN&amp; igvn) {
2392   Node *r = root();
2393   if (r != NULL) {
2394     for (uint i = r-&gt;req(); i &lt; r-&gt;len(); ++i) {
2395       Node *n = r-&gt;in(i);
2396       if (n != NULL &amp;&amp; n-&gt;is_SafePoint()) {
2397         r-&gt;rm_prec(i);
2398         if (n-&gt;outcnt() == 0) {
2399           igvn.remove_dead_node(n);
2400         }
2401         --i;
2402       }
2403     }
2404     // Parsing may have added top inputs to the root node (Path
2405     // leading to the Halt node proven dead). Make sure we get a
2406     // chance to clean them up.
2407     igvn._worklist.push(r);
2408     igvn.optimize();
2409   }
2410 }
2411 
2412 //------------------------------Optimize---------------------------------------
2413 // Given a graph, optimize it.
2414 void Compile::Optimize() {
2415   TracePhase tp(&quot;optimizer&quot;, &amp;timers[_t_optimizer]);
2416 
2417 #ifndef PRODUCT
2418   if (_directive-&gt;BreakAtCompileOption) {
2419     BREAKPOINT;
2420   }
2421 
2422 #endif
2423 
2424   BarrierSetC2* bs = BarrierSet::barrier_set()-&gt;barrier_set_c2();
2425 #ifdef ASSERT
2426   bs-&gt;verify_gc_barriers(this, BarrierSetC2::BeforeOptimize);
2427 #endif
2428 
2429   ResourceMark rm;
2430 
2431   print_inlining_reinit();
2432 
2433   NOT_PRODUCT( verify_graph_edges(); )
2434 
2435   print_method(PHASE_AFTER_PARSING);
2436 
2437  {
2438   // Iterative Global Value Numbering, including ideal transforms
2439   // Initialize IterGVN with types and values from parse-time GVN
2440   PhaseIterGVN igvn(initial_gvn());
2441 #ifdef ASSERT
2442   _modified_nodes = new (comp_arena()) Unique_Node_List(comp_arena());
2443 #endif
2444   {
2445     TracePhase tp(&quot;iterGVN&quot;, &amp;timers[_t_iterGVN]);
2446     igvn.optimize();
2447   }
2448 
2449   if (failing())  return;
2450 
2451   print_method(PHASE_ITER_GVN1, 2);
2452 
2453   inline_incrementally(igvn);
2454 
2455   print_method(PHASE_INCREMENTAL_INLINE, 2);
2456 
2457   if (failing())  return;
2458 
2459   if (eliminate_boxing()) {
2460     // Inline valueOf() methods now.
2461     inline_boxing_calls(igvn);
2462 
2463     if (AlwaysIncrementalInline) {
2464       inline_incrementally(igvn);
2465     }
2466 
2467     print_method(PHASE_INCREMENTAL_BOXING_INLINE, 2);
2468 
2469     if (failing())  return;
2470   }
2471 
2472   // Now that all inlining is over, cut edge from root to loop
2473   // safepoints
2474   remove_root_to_sfpts_edges(igvn);
2475 
2476   // Remove the speculative part of types and clean up the graph from
2477   // the extra CastPP nodes whose only purpose is to carry them. Do
2478   // that early so that optimizations are not disrupted by the extra
2479   // CastPP nodes.
2480   remove_speculative_types(igvn);
2481 
2482   // No more new expensive nodes will be added to the list from here
2483   // so keep only the actual candidates for optimizations.
2484   cleanup_expensive_nodes(igvn);
2485 
2486   if (!failing() &amp;&amp; RenumberLiveNodes &amp;&amp; live_nodes() + NodeLimitFudgeFactor &lt; unique()) {
2487     Compile::TracePhase tp(&quot;&quot;, &amp;timers[_t_renumberLive]);
2488     initial_gvn()-&gt;replace_with(&amp;igvn);
2489     for_igvn()-&gt;clear();
2490     Unique_Node_List new_worklist(C-&gt;comp_arena());
2491     {
2492       ResourceMark rm;
2493       PhaseRenumberLive prl = PhaseRenumberLive(initial_gvn(), for_igvn(), &amp;new_worklist);
2494     }
2495     set_for_igvn(&amp;new_worklist);
2496     igvn = PhaseIterGVN(initial_gvn());
2497     igvn.optimize();
2498   }
2499 
2500   if (_value_type_nodes-&gt;length() &gt; 0) {
2501     // Do this once all inlining is over to avoid getting inconsistent debug info
2502     process_value_types(igvn);
2503   }
2504 
2505   adjust_flattened_array_access_aliases(igvn);
2506 
2507   // Perform escape analysis
2508   if (_do_escape_analysis &amp;&amp; ConnectionGraph::has_candidates(this)) {
2509     if (has_loops()) {
2510       // Cleanup graph (remove dead nodes).
2511       TracePhase tp(&quot;idealLoop&quot;, &amp;timers[_t_idealLoop]);
2512       PhaseIdealLoop::optimize(igvn, LoopOptsMaxUnroll);
2513       if (major_progress()) print_method(PHASE_PHASEIDEAL_BEFORE_EA, 2);
2514       if (failing())  return;
2515     }
2516     ConnectionGraph::do_analysis(this, &amp;igvn);
2517 
2518     if (failing())  return;
2519 
2520     // Optimize out fields loads from scalar replaceable allocations.
2521     igvn.optimize();
2522     print_method(PHASE_ITER_GVN_AFTER_EA, 2);
2523 
2524     if (failing())  return;
2525 
2526     if (congraph() != NULL &amp;&amp; macro_count() &gt; 0) {
2527       TracePhase tp(&quot;macroEliminate&quot;, &amp;timers[_t_macroEliminate]);
2528       PhaseMacroExpand mexp(igvn);
2529       mexp.eliminate_macro_nodes();
2530       igvn.set_delay_transform(false);
2531 
2532       igvn.optimize();
2533       print_method(PHASE_ITER_GVN_AFTER_ELIMINATION, 2);
2534 
2535       if (failing())  return;
2536     }
2537   }
2538 
2539   if (_value_type_nodes-&gt;length() &gt; 0) {
2540     // Process value types again now that EA might have simplified the graph
2541     process_value_types(igvn, /* post_ea= */ true);
2542   }
2543 
2544   // Loop transforms on the ideal graph.  Range Check Elimination,
2545   // peeling, unrolling, etc.
2546 
2547   // Set loop opts counter
2548   if((_loop_opts_cnt &gt; 0) &amp;&amp; (has_loops() || has_split_ifs())) {
2549     {
2550       TracePhase tp(&quot;idealLoop&quot;, &amp;timers[_t_idealLoop]);
2551       PhaseIdealLoop::optimize(igvn, LoopOptsDefault);
2552       _loop_opts_cnt--;
2553       if (major_progress()) print_method(PHASE_PHASEIDEALLOOP1, 2);
2554       if (failing())  return;
2555     }
2556     // Loop opts pass if partial peeling occurred in previous pass
2557     if(PartialPeelLoop &amp;&amp; major_progress() &amp;&amp; (_loop_opts_cnt &gt; 0)) {
2558       TracePhase tp(&quot;idealLoop&quot;, &amp;timers[_t_idealLoop]);
2559       PhaseIdealLoop::optimize(igvn, LoopOptsSkipSplitIf);
2560       _loop_opts_cnt--;
2561       if (major_progress()) print_method(PHASE_PHASEIDEALLOOP2, 2);
2562       if (failing())  return;
2563     }
2564     // Loop opts pass for loop-unrolling before CCP
2565     if(major_progress() &amp;&amp; (_loop_opts_cnt &gt; 0)) {
2566       TracePhase tp(&quot;idealLoop&quot;, &amp;timers[_t_idealLoop]);
2567       PhaseIdealLoop::optimize(igvn, LoopOptsSkipSplitIf);
2568       _loop_opts_cnt--;
2569       if (major_progress()) print_method(PHASE_PHASEIDEALLOOP3, 2);
2570     }
2571     if (!failing()) {
2572       // Verify that last round of loop opts produced a valid graph
2573       TracePhase tp(&quot;idealLoopVerify&quot;, &amp;timers[_t_idealLoopVerify]);
2574       PhaseIdealLoop::verify(igvn);
2575     }
2576   }
2577   if (failing())  return;
2578 
2579   // Conditional Constant Propagation;
2580   PhaseCCP ccp( &amp;igvn );
2581   assert( true, &quot;Break here to ccp.dump_nodes_and_types(_root,999,1)&quot;);
2582   {
2583     TracePhase tp(&quot;ccp&quot;, &amp;timers[_t_ccp]);
2584     ccp.do_transform();
2585   }
2586   print_method(PHASE_CPP1, 2);
2587 
2588   assert( true, &quot;Break here to ccp.dump_old2new_map()&quot;);
2589 
2590   // Iterative Global Value Numbering, including ideal transforms
2591   {
2592     TracePhase tp(&quot;iterGVN2&quot;, &amp;timers[_t_iterGVN2]);
2593     igvn = ccp;
2594     igvn.optimize();
2595   }
2596   print_method(PHASE_ITER_GVN2, 2);
2597 
2598   if (failing())  return;
2599 
2600   // Loop transforms on the ideal graph.  Range Check Elimination,
2601   // peeling, unrolling, etc.
2602   if (!optimize_loops(igvn, LoopOptsDefault)) {
2603     return;
2604   }
2605 
2606   if (failing())  return;
2607 
2608   // Ensure that major progress is now clear
2609   C-&gt;clear_major_progress();
2610 
2611   {
2612     // Verify that all previous optimizations produced a valid graph
2613     // at least to this point, even if no loop optimizations were done.
2614     TracePhase tp(&quot;idealLoopVerify&quot;, &amp;timers[_t_idealLoopVerify]);
2615     PhaseIdealLoop::verify(igvn);
2616   }
2617 
2618   if (range_check_cast_count() &gt; 0) {
2619     // No more loop optimizations. Remove all range check dependent CastIINodes.
2620     C-&gt;remove_range_check_casts(igvn);
2621     igvn.optimize();
2622   }
2623 
2624 #ifdef ASSERT
2625   bs-&gt;verify_gc_barriers(this, BarrierSetC2::BeforeMacroExpand);
2626 #endif
2627 
2628   {
2629     TracePhase tp(&quot;macroExpand&quot;, &amp;timers[_t_macroExpand]);
2630     PhaseMacroExpand  mex(igvn);
2631     if (mex.expand_macro_nodes()) {
2632       assert(failing(), &quot;must bail out w/ explicit message&quot;);
2633       return;
2634     }
2635     print_method(PHASE_MACRO_EXPANSION, 2);
2636   }
2637 
2638   {
2639     TracePhase tp(&quot;barrierExpand&quot;, &amp;timers[_t_barrierExpand]);
2640     if (bs-&gt;expand_barriers(this, igvn)) {
2641       assert(failing(), &quot;must bail out w/ explicit message&quot;);
2642       return;
2643     }
2644     print_method(PHASE_BARRIER_EXPANSION, 2);
2645   }
2646 
2647   if (opaque4_count() &gt; 0) {
2648     C-&gt;remove_opaque4_nodes(igvn);
2649     igvn.optimize();
2650   }
2651 
2652   if (C-&gt;max_vector_size() &gt; 0) {
2653     C-&gt;optimize_logic_cones(igvn);
2654     igvn.optimize();
2655   }
2656 
2657   DEBUG_ONLY( _modified_nodes = NULL; )
2658  } // (End scope of igvn; run destructor if necessary for asserts.)
2659 
2660  process_print_inlining();
2661  // A method with only infinite loops has no edges entering loops from root
2662  {
2663    TracePhase tp(&quot;graphReshape&quot;, &amp;timers[_t_graphReshaping]);
2664    if (final_graph_reshaping()) {
2665      assert(failing(), &quot;must bail out w/ explicit message&quot;);
2666      return;
2667    }
2668  }
2669 
2670  print_method(PHASE_OPTIMIZE_FINISHED, 2);
2671 }
2672 
2673 //---------------------------- Bitwise operation packing optimization ---------------------------
2674 
2675 static bool is_vector_unary_bitwise_op(Node* n) {
2676   return n-&gt;Opcode() == Op_XorV &amp;&amp;
2677          VectorNode::is_vector_bitwise_not_pattern(n);
2678 }
2679 
2680 static bool is_vector_binary_bitwise_op(Node* n) {
2681   switch (n-&gt;Opcode()) {
2682     case Op_AndV:
2683     case Op_OrV:
2684       return true;
2685 
2686     case Op_XorV:
2687       return !is_vector_unary_bitwise_op(n);
2688 
2689     default:
2690       return false;
2691   }
2692 }
2693 
2694 static bool is_vector_ternary_bitwise_op(Node* n) {
2695   return n-&gt;Opcode() == Op_MacroLogicV;
2696 }
2697 
2698 static bool is_vector_bitwise_op(Node* n) {
2699   return is_vector_unary_bitwise_op(n)  ||
2700          is_vector_binary_bitwise_op(n) ||
2701          is_vector_ternary_bitwise_op(n);
2702 }
2703 
2704 static bool is_vector_bitwise_cone_root(Node* n) {
2705   if (!is_vector_bitwise_op(n)) {
2706     return false;
2707   }
2708   for (DUIterator_Fast imax, i = n-&gt;fast_outs(imax); i &lt; imax; i++) {
2709     if (is_vector_bitwise_op(n-&gt;fast_out(i))) {
2710       return false;
2711     }
2712   }
2713   return true;
2714 }
2715 
2716 static uint collect_unique_inputs(Node* n, Unique_Node_List&amp; partition, Unique_Node_List&amp; inputs) {
2717   uint cnt = 0;
2718   if (is_vector_bitwise_op(n)) {
2719     if (VectorNode::is_vector_bitwise_not_pattern(n)) {
2720       for (uint i = 1; i &lt; n-&gt;req(); i++) {
2721         Node* in = n-&gt;in(i);
2722         bool skip = VectorNode::is_all_ones_vector(in);
2723         if (!skip &amp;&amp; !inputs.member(in)) {
2724           inputs.push(in);
2725           cnt++;
2726         }
2727       }
2728       assert(cnt &lt;= 1, &quot;not unary&quot;);
2729     } else {
2730       uint last_req = n-&gt;req();
2731       if (is_vector_ternary_bitwise_op(n)) {
2732         last_req = n-&gt;req() - 1; // skip last input
2733       }
2734       for (uint i = 1; i &lt; last_req; i++) {
2735         Node* def = n-&gt;in(i);
2736         if (!inputs.member(def)) {
2737           inputs.push(def);
2738           cnt++;
2739         }
2740       }
2741     }
2742     partition.push(n);
2743   } else { // not a bitwise operations
2744     if (!inputs.member(n)) {
2745       inputs.push(n);
2746       cnt++;
2747     }
2748   }
2749   return cnt;
2750 }
2751 
2752 void Compile::collect_logic_cone_roots(Unique_Node_List&amp; list) {
2753   Unique_Node_List useful_nodes;
2754   C-&gt;identify_useful_nodes(useful_nodes);
2755 
2756   for (uint i = 0; i &lt; useful_nodes.size(); i++) {
2757     Node* n = useful_nodes.at(i);
2758     if (is_vector_bitwise_cone_root(n)) {
2759       list.push(n);
2760     }
2761   }
2762 }
2763 
2764 Node* Compile::xform_to_MacroLogicV(PhaseIterGVN&amp; igvn,
2765                                     const TypeVect* vt,
2766                                     Unique_Node_List&amp; partition,
2767                                     Unique_Node_List&amp; inputs) {
2768   assert(partition.size() == 2 || partition.size() == 3, &quot;not supported&quot;);
2769   assert(inputs.size()    == 2 || inputs.size()    == 3, &quot;not supported&quot;);
2770   assert(Matcher::match_rule_supported_vector(Op_MacroLogicV, vt-&gt;length(), vt-&gt;element_basic_type()), &quot;not supported&quot;);
2771 
2772   Node* in1 = inputs.at(0);
2773   Node* in2 = inputs.at(1);
2774   Node* in3 = (inputs.size() == 3 ? inputs.at(2) : in2);
2775 
2776   uint func = compute_truth_table(partition, inputs);
2777   return igvn.transform(MacroLogicVNode::make(igvn, in3, in2, in1, func, vt));
2778 }
2779 
2780 static uint extract_bit(uint func, uint pos) {
2781   return (func &amp; (1 &lt;&lt; pos)) &gt;&gt; pos;
2782 }
2783 
2784 //
2785 //  A macro logic node represents a truth table. It has 4 inputs,
2786 //  First three inputs corresponds to 3 columns of a truth table
2787 //  and fourth input captures the logic function.
2788 //
2789 //  eg.  fn = (in1 AND in2) OR in3;
2790 //
2791 //      MacroNode(in1,in2,in3,fn)
2792 //
2793 //  -----------------
2794 //  in1 in2 in3  fn
2795 //  -----------------
2796 //  0    0   0    0
2797 //  0    0   1    1
2798 //  0    1   0    0
2799 //  0    1   1    1
2800 //  1    0   0    0
2801 //  1    0   1    1
2802 //  1    1   0    1
2803 //  1    1   1    1
2804 //
2805 
2806 uint Compile::eval_macro_logic_op(uint func, uint in1 , uint in2, uint in3) {
2807   int res = 0;
2808   for (int i = 0; i &lt; 8; i++) {
2809     int bit1 = extract_bit(in1, i);
2810     int bit2 = extract_bit(in2, i);
2811     int bit3 = extract_bit(in3, i);
2812 
2813     int func_bit_pos = (bit1 &lt;&lt; 2 | bit2 &lt;&lt; 1 | bit3);
2814     int func_bit = extract_bit(func, func_bit_pos);
2815 
2816     res |= func_bit &lt;&lt; i;
2817   }
2818   return res;
2819 }
2820 
2821 static uint eval_operand(Node* n, ResourceHashtable&lt;Node*,uint&gt;&amp; eval_map) {
2822   assert(n != NULL, &quot;&quot;);
2823   assert(eval_map.contains(n), &quot;absent&quot;);
2824   return *(eval_map.get(n));
2825 }
2826 
2827 static void eval_operands(Node* n,
2828                           uint&amp; func1, uint&amp; func2, uint&amp; func3,
2829                           ResourceHashtable&lt;Node*,uint&gt;&amp; eval_map) {
2830   assert(is_vector_bitwise_op(n), &quot;&quot;);
2831   func1 = eval_operand(n-&gt;in(1), eval_map);
2832 
2833   if (is_vector_binary_bitwise_op(n)) {
2834     func2 = eval_operand(n-&gt;in(2), eval_map);
2835   } else if (is_vector_ternary_bitwise_op(n)) {
2836     func2 = eval_operand(n-&gt;in(2), eval_map);
2837     func3 = eval_operand(n-&gt;in(3), eval_map);
2838   } else {
2839     assert(is_vector_unary_bitwise_op(n), &quot;not unary&quot;);
2840   }
2841 }
2842 
2843 uint Compile::compute_truth_table(Unique_Node_List&amp; partition, Unique_Node_List&amp; inputs) {
2844   assert(inputs.size() &lt;= 3, &quot;sanity&quot;);
2845   ResourceMark rm;
2846   uint res = 0;
2847   ResourceHashtable&lt;Node*,uint&gt; eval_map;
2848 
2849   // Populate precomputed functions for inputs.
2850   // Each input corresponds to one column of 3 input truth-table.
2851   uint input_funcs[] = { 0xAA,   // (_, _, a) -&gt; a
2852                          0xCC,   // (_, b, _) -&gt; b
2853                          0xF0 }; // (c, _, _) -&gt; c
2854   for (uint i = 0; i &lt; inputs.size(); i++) {
2855     eval_map.put(inputs.at(i), input_funcs[i]);
2856   }
2857 
2858   for (uint i = 0; i &lt; partition.size(); i++) {
2859     Node* n = partition.at(i);
2860 
2861     uint func1 = 0, func2 = 0, func3 = 0;
2862     eval_operands(n, func1, func2, func3, eval_map);
2863 
2864     switch (n-&gt;Opcode()) {
2865       case Op_OrV:
2866         assert(func3 == 0, &quot;not binary&quot;);
2867         res = func1 | func2;
2868         break;
2869       case Op_AndV:
2870         assert(func3 == 0, &quot;not binary&quot;);
2871         res = func1 &amp; func2;
2872         break;
2873       case Op_XorV:
2874         if (VectorNode::is_vector_bitwise_not_pattern(n)) {
2875           assert(func2 == 0 &amp;&amp; func3 == 0, &quot;not unary&quot;);
2876           res = (~func1) &amp; 0xFF;
2877         } else {
2878           assert(func3 == 0, &quot;not binary&quot;);
2879           res = func1 ^ func2;
2880         }
2881         break;
2882       case Op_MacroLogicV:
2883         // Ordering of inputs may change during evaluation of sub-tree
2884         // containing MacroLogic node as a child node, thus a re-evaluation
2885         // makes sure that function is evaluated in context of current
2886         // inputs.
2887         res = eval_macro_logic_op(n-&gt;in(4)-&gt;get_int(), func1, func2, func3);
2888         break;
2889 
2890       default: assert(false, &quot;not supported: %s&quot;, n-&gt;Name());
2891     }
2892     assert(res &lt;= 0xFF, &quot;invalid&quot;);
2893     eval_map.put(n, res);
2894   }
2895   return res;
2896 }
2897 
2898 bool Compile::compute_logic_cone(Node* n, Unique_Node_List&amp; partition, Unique_Node_List&amp; inputs) {
2899   assert(partition.size() == 0, &quot;not empty&quot;);
2900   assert(inputs.size() == 0, &quot;not empty&quot;);
2901   if (is_vector_ternary_bitwise_op(n)) {
2902     return false;
2903   }
2904 
2905   bool is_unary_op = is_vector_unary_bitwise_op(n);
2906   if (is_unary_op) {
2907     assert(collect_unique_inputs(n, partition, inputs) == 1, &quot;not unary&quot;);
2908     return false; // too few inputs
2909   }
2910 
2911   assert(is_vector_binary_bitwise_op(n), &quot;not binary&quot;);
2912   Node* in1 = n-&gt;in(1);
2913   Node* in2 = n-&gt;in(2);
2914 
2915   int in1_unique_inputs_cnt = collect_unique_inputs(in1, partition, inputs);
2916   int in2_unique_inputs_cnt = collect_unique_inputs(in2, partition, inputs);
2917   partition.push(n);
2918 
2919   // Too many inputs?
2920   if (inputs.size() &gt; 3) {
2921     partition.clear();
2922     inputs.clear();
2923     { // Recompute in2 inputs
2924       Unique_Node_List not_used;
2925       in2_unique_inputs_cnt = collect_unique_inputs(in2, not_used, not_used);
2926     }
2927     // Pick the node with minimum number of inputs.
2928     if (in1_unique_inputs_cnt &gt;= 3 &amp;&amp; in2_unique_inputs_cnt &gt;= 3) {
2929       return false; // still too many inputs
2930     }
2931     // Recompute partition &amp; inputs.
2932     Node* child       = (in1_unique_inputs_cnt &lt; in2_unique_inputs_cnt ? in1 : in2);
2933     collect_unique_inputs(child, partition, inputs);
2934 
2935     Node* other_input = (in1_unique_inputs_cnt &lt; in2_unique_inputs_cnt ? in2 : in1);
2936     inputs.push(other_input);
2937 
2938     partition.push(n);
2939   }
2940 
2941   return (partition.size() == 2 || partition.size() == 3) &amp;&amp;
2942          (inputs.size()    == 2 || inputs.size()    == 3);
2943 }
2944 
2945 
2946 void Compile::process_logic_cone_root(PhaseIterGVN &amp;igvn, Node *n, VectorSet &amp;visited) {
2947   assert(is_vector_bitwise_op(n), &quot;not a root&quot;);
2948 
2949   visited.set(n-&gt;_idx);
2950 
2951   // 1) Do a DFS walk over the logic cone.
2952   for (uint i = 1; i &lt; n-&gt;req(); i++) {
2953     Node* in = n-&gt;in(i);
2954     if (!visited.test(in-&gt;_idx) &amp;&amp; is_vector_bitwise_op(in)) {
2955       process_logic_cone_root(igvn, in, visited);
2956     }
2957   }
2958 
2959   // 2) Bottom up traversal: Merge node[s] with
2960   // the parent to form macro logic node.
2961   Unique_Node_List partition;
2962   Unique_Node_List inputs;
2963   if (compute_logic_cone(n, partition, inputs)) {
2964     const TypeVect* vt = n-&gt;bottom_type()-&gt;is_vect();
2965     Node* macro_logic = xform_to_MacroLogicV(igvn, vt, partition, inputs);
2966     igvn.replace_node(n, macro_logic);
2967   }
2968 }
2969 
2970 void Compile::optimize_logic_cones(PhaseIterGVN &amp;igvn) {
2971   ResourceMark rm;
2972   if (Matcher::match_rule_supported(Op_MacroLogicV)) {
2973     Unique_Node_List list;
2974     collect_logic_cone_roots(list);
2975 
2976     while (list.size() &gt; 0) {
2977       Node* n = list.pop();
2978       const TypeVect* vt = n-&gt;bottom_type()-&gt;is_vect();
2979       bool supported = Matcher::match_rule_supported_vector(Op_MacroLogicV, vt-&gt;length(), vt-&gt;element_basic_type());
2980       if (supported) {
2981         VectorSet visited(comp_arena());
2982         process_logic_cone_root(igvn, n, visited);
2983       }
2984     }
2985   }
2986 }
2987 
2988 //------------------------------Code_Gen---------------------------------------
2989 // Given a graph, generate code for it
2990 void Compile::Code_Gen() {
2991   if (failing()) {
2992     return;
2993   }
2994 
2995   // Perform instruction selection.  You might think we could reclaim Matcher
2996   // memory PDQ, but actually the Matcher is used in generating spill code.
2997   // Internals of the Matcher (including some VectorSets) must remain live
2998   // for awhile - thus I cannot reclaim Matcher memory lest a VectorSet usage
2999   // set a bit in reclaimed memory.
3000 
3001   // In debug mode can dump m._nodes.dump() for mapping of ideal to machine
3002   // nodes.  Mapping is only valid at the root of each matched subtree.
3003   NOT_PRODUCT( verify_graph_edges(); )
3004 
3005   Matcher matcher;
3006   _matcher = &amp;matcher;
3007   {
3008     TracePhase tp(&quot;matcher&quot;, &amp;timers[_t_matcher]);
3009     matcher.match();
3010     if (failing()) {
3011       return;
3012     }
3013   }
3014 
3015   // In debug mode can dump m._nodes.dump() for mapping of ideal to machine
3016   // nodes.  Mapping is only valid at the root of each matched subtree.
3017   NOT_PRODUCT( verify_graph_edges(); )
3018 
3019   // If you have too many nodes, or if matching has failed, bail out
3020   check_node_count(0, &quot;out of nodes matching instructions&quot;);
3021   if (failing()) {
3022     return;
3023   }
3024 
3025   print_method(PHASE_MATCHING, 2);
3026 
3027   // Build a proper-looking CFG
3028   PhaseCFG cfg(node_arena(), root(), matcher);
3029   _cfg = &amp;cfg;
3030   {
3031     TracePhase tp(&quot;scheduler&quot;, &amp;timers[_t_scheduler]);
3032     bool success = cfg.do_global_code_motion();
3033     if (!success) {
3034       return;
3035     }
3036 
3037     print_method(PHASE_GLOBAL_CODE_MOTION, 2);
3038     NOT_PRODUCT( verify_graph_edges(); )
3039     debug_only( cfg.verify(); )
3040   }
3041 
3042   PhaseChaitin regalloc(unique(), cfg, matcher, false);
3043   _regalloc = &amp;regalloc;
3044   {
3045     TracePhase tp(&quot;regalloc&quot;, &amp;timers[_t_registerAllocation]);
3046     // Perform register allocation.  After Chaitin, use-def chains are
3047     // no longer accurate (at spill code) and so must be ignored.
3048     // Node-&gt;LRG-&gt;reg mappings are still accurate.
3049     _regalloc-&gt;Register_Allocate();
3050 
3051     // Bail out if the allocator builds too many nodes
3052     if (failing()) {
3053       return;
3054     }
3055   }
3056 
3057   // Prior to register allocation we kept empty basic blocks in case the
3058   // the allocator needed a place to spill.  After register allocation we
3059   // are not adding any new instructions.  If any basic block is empty, we
3060   // can now safely remove it.
3061   {
3062     TracePhase tp(&quot;blockOrdering&quot;, &amp;timers[_t_blockOrdering]);
3063     cfg.remove_empty_blocks();
3064     if (do_freq_based_layout()) {
3065       PhaseBlockLayout layout(cfg);
3066     } else {
3067       cfg.set_loop_alignment();
3068     }
3069     cfg.fixup_flow();
3070   }
3071 
3072   // Apply peephole optimizations
3073   if( OptoPeephole ) {
3074     TracePhase tp(&quot;peephole&quot;, &amp;timers[_t_peephole]);
3075     PhasePeephole peep( _regalloc, cfg);
3076     peep.do_transform();
3077   }
3078 
3079   // Do late expand if CPU requires this.
3080   if (Matcher::require_postalloc_expand) {
3081     TracePhase tp(&quot;postalloc_expand&quot;, &amp;timers[_t_postalloc_expand]);
3082     cfg.postalloc_expand(_regalloc);
3083   }
3084 
3085   // Convert Nodes to instruction bits in a buffer
3086   {
3087     TracePhase tp(&quot;output&quot;, &amp;timers[_t_output]);
3088     PhaseOutput output;
3089     output.Output();
3090     if (failing())  return;
3091     output.install();
3092   }
3093 
3094   print_method(PHASE_FINAL_CODE);
3095 
3096   // He&#39;s dead, Jim.
3097   _cfg     = (PhaseCFG*)((intptr_t)0xdeadbeef);
3098   _regalloc = (PhaseChaitin*)((intptr_t)0xdeadbeef);
3099 }
3100 
3101 //------------------------------Final_Reshape_Counts---------------------------
3102 // This class defines counters to help identify when a method
3103 // may/must be executed using hardware with only 24-bit precision.
3104 struct Final_Reshape_Counts : public StackObj {
3105   int  _call_count;             // count non-inlined &#39;common&#39; calls
3106   int  _float_count;            // count float ops requiring 24-bit precision
3107   int  _double_count;           // count double ops requiring more precision
3108   int  _java_call_count;        // count non-inlined &#39;java&#39; calls
3109   int  _inner_loop_count;       // count loops which need alignment
3110   VectorSet _visited;           // Visitation flags
3111   Node_List _tests;             // Set of IfNodes &amp; PCTableNodes
3112 
3113   Final_Reshape_Counts() :
3114     _call_count(0), _float_count(0), _double_count(0),
3115     _java_call_count(0), _inner_loop_count(0),
3116     _visited( Thread::current()-&gt;resource_area() ) { }
3117 
3118   void inc_call_count  () { _call_count  ++; }
3119   void inc_float_count () { _float_count ++; }
3120   void inc_double_count() { _double_count++; }
3121   void inc_java_call_count() { _java_call_count++; }
3122   void inc_inner_loop_count() { _inner_loop_count++; }
3123 
3124   int  get_call_count  () const { return _call_count  ; }
3125   int  get_float_count () const { return _float_count ; }
3126   int  get_double_count() const { return _double_count; }
3127   int  get_java_call_count() const { return _java_call_count; }
3128   int  get_inner_loop_count() const { return _inner_loop_count; }
3129 };
3130 
3131 #ifdef ASSERT
3132 static bool oop_offset_is_sane(const TypeInstPtr* tp) {
3133   ciInstanceKlass *k = tp-&gt;klass()-&gt;as_instance_klass();
3134   // Make sure the offset goes inside the instance layout.
3135   return k-&gt;contains_field_offset(tp-&gt;offset());
3136   // Note that OffsetBot and OffsetTop are very negative.
3137 }
3138 #endif
3139 
3140 // Eliminate trivially redundant StoreCMs and accumulate their
3141 // precedence edges.
3142 void Compile::eliminate_redundant_card_marks(Node* n) {
3143   assert(n-&gt;Opcode() == Op_StoreCM, &quot;expected StoreCM&quot;);
3144   if (n-&gt;in(MemNode::Address)-&gt;outcnt() &gt; 1) {
3145     // There are multiple users of the same address so it might be
3146     // possible to eliminate some of the StoreCMs
3147     Node* mem = n-&gt;in(MemNode::Memory);
3148     Node* adr = n-&gt;in(MemNode::Address);
3149     Node* val = n-&gt;in(MemNode::ValueIn);
3150     Node* prev = n;
3151     bool done = false;
3152     // Walk the chain of StoreCMs eliminating ones that match.  As
3153     // long as it&#39;s a chain of single users then the optimization is
3154     // safe.  Eliminating partially redundant StoreCMs would require
3155     // cloning copies down the other paths.
3156     while (mem-&gt;Opcode() == Op_StoreCM &amp;&amp; mem-&gt;outcnt() == 1 &amp;&amp; !done) {
3157       if (adr == mem-&gt;in(MemNode::Address) &amp;&amp;
3158           val == mem-&gt;in(MemNode::ValueIn)) {
3159         // redundant StoreCM
3160         if (mem-&gt;req() &gt; MemNode::OopStore) {
3161           // Hasn&#39;t been processed by this code yet.
3162           n-&gt;add_prec(mem-&gt;in(MemNode::OopStore));
3163         } else {
3164           // Already converted to precedence edge
3165           for (uint i = mem-&gt;req(); i &lt; mem-&gt;len(); i++) {
3166             // Accumulate any precedence edges
3167             if (mem-&gt;in(i) != NULL) {
3168               n-&gt;add_prec(mem-&gt;in(i));
3169             }
3170           }
3171           // Everything above this point has been processed.
3172           done = true;
3173         }
3174         // Eliminate the previous StoreCM
3175         prev-&gt;set_req(MemNode::Memory, mem-&gt;in(MemNode::Memory));
3176         assert(mem-&gt;outcnt() == 0, &quot;should be dead&quot;);
3177         mem-&gt;disconnect_inputs(NULL, this);
3178       } else {
3179         prev = mem;
3180       }
3181       mem = prev-&gt;in(MemNode::Memory);
3182     }
3183   }
3184 }
3185 
3186 
3187 //------------------------------final_graph_reshaping_impl----------------------
3188 // Implement items 1-5 from final_graph_reshaping below.
3189 void Compile::final_graph_reshaping_impl( Node *n, Final_Reshape_Counts &amp;frc) {
3190 
3191   if ( n-&gt;outcnt() == 0 ) return; // dead node
3192   uint nop = n-&gt;Opcode();
3193 
3194   // Check for 2-input instruction with &quot;last use&quot; on right input.
3195   // Swap to left input.  Implements item (2).
3196   if( n-&gt;req() == 3 &amp;&amp;          // two-input instruction
3197       n-&gt;in(1)-&gt;outcnt() &gt; 1 &amp;&amp; // left use is NOT a last use
3198       (!n-&gt;in(1)-&gt;is_Phi() || n-&gt;in(1)-&gt;in(2) != n) &amp;&amp; // it is not data loop
3199       n-&gt;in(2)-&gt;outcnt() == 1 &amp;&amp;// right use IS a last use
3200       !n-&gt;in(2)-&gt;is_Con() ) {   // right use is not a constant
3201     // Check for commutative opcode
3202     switch( nop ) {
3203     case Op_AddI:  case Op_AddF:  case Op_AddD:  case Op_AddL:
3204     case Op_MaxI:  case Op_MinI:
3205     case Op_MulI:  case Op_MulF:  case Op_MulD:  case Op_MulL:
3206     case Op_AndL:  case Op_XorL:  case Op_OrL:
3207     case Op_AndI:  case Op_XorI:  case Op_OrI: {
3208       // Move &quot;last use&quot; input to left by swapping inputs
3209       n-&gt;swap_edges(1, 2);
3210       break;
3211     }
3212     default:
3213       break;
3214     }
3215   }
3216 
3217 #ifdef ASSERT
3218   if( n-&gt;is_Mem() ) {
3219     int alias_idx = get_alias_index(n-&gt;as_Mem()-&gt;adr_type());
3220     assert( n-&gt;in(0) != NULL || alias_idx != Compile::AliasIdxRaw ||
3221             // oop will be recorded in oop map if load crosses safepoint
3222             n-&gt;is_Load() &amp;&amp; (n-&gt;as_Load()-&gt;bottom_type()-&gt;isa_oopptr() ||
3223                              LoadNode::is_immutable_value(n-&gt;in(MemNode::Address))),
3224             &quot;raw memory operations should have control edge&quot;);
3225   }
3226   if (n-&gt;is_MemBar()) {
3227     MemBarNode* mb = n-&gt;as_MemBar();
3228     if (mb-&gt;trailing_store() || mb-&gt;trailing_load_store()) {
3229       assert(mb-&gt;leading_membar()-&gt;trailing_membar() == mb, &quot;bad membar pair&quot;);
3230       Node* mem = BarrierSet::barrier_set()-&gt;barrier_set_c2()-&gt;step_over_gc_barrier(mb-&gt;in(MemBarNode::Precedent));
3231       assert((mb-&gt;trailing_store() &amp;&amp; mem-&gt;is_Store() &amp;&amp; mem-&gt;as_Store()-&gt;is_release()) ||
3232              (mb-&gt;trailing_load_store() &amp;&amp; mem-&gt;is_LoadStore()), &quot;missing mem op&quot;);
3233     } else if (mb-&gt;leading()) {
3234       assert(mb-&gt;trailing_membar()-&gt;leading_membar() == mb, &quot;bad membar pair&quot;);
3235     }
3236   }
3237 #endif
3238   // Count FPU ops and common calls, implements item (3)
3239   bool gc_handled = BarrierSet::barrier_set()-&gt;barrier_set_c2()-&gt;final_graph_reshaping(this, n, nop);
3240   if (!gc_handled) {
3241     final_graph_reshaping_main_switch(n, frc, nop);
3242   }
3243 
3244   // Collect CFG split points
3245   if (n-&gt;is_MultiBranch() &amp;&amp; !n-&gt;is_RangeCheck()) {
3246     frc._tests.push(n);
3247   }
3248 }
3249 
3250 void Compile::final_graph_reshaping_main_switch(Node* n, Final_Reshape_Counts&amp; frc, uint nop) {
3251   switch( nop ) {
3252   // Count all float operations that may use FPU
3253   case Op_AddF:
3254   case Op_SubF:
3255   case Op_MulF:
3256   case Op_DivF:
3257   case Op_NegF:
3258   case Op_ModF:
3259   case Op_ConvI2F:
3260   case Op_ConF:
3261   case Op_CmpF:
3262   case Op_CmpF3:
3263   // case Op_ConvL2F: // longs are split into 32-bit halves
3264     frc.inc_float_count();
3265     break;
3266 
3267   case Op_ConvF2D:
3268   case Op_ConvD2F:
3269     frc.inc_float_count();
3270     frc.inc_double_count();
3271     break;
3272 
3273   // Count all double operations that may use FPU
3274   case Op_AddD:
3275   case Op_SubD:
3276   case Op_MulD:
3277   case Op_DivD:
3278   case Op_NegD:
3279   case Op_ModD:
3280   case Op_ConvI2D:
3281   case Op_ConvD2I:
3282   // case Op_ConvL2D: // handled by leaf call
3283   // case Op_ConvD2L: // handled by leaf call
3284   case Op_ConD:
3285   case Op_CmpD:
3286   case Op_CmpD3:
3287     frc.inc_double_count();
3288     break;
3289   case Op_Opaque1:              // Remove Opaque Nodes before matching
3290   case Op_Opaque2:              // Remove Opaque Nodes before matching
3291   case Op_Opaque3:
3292     n-&gt;subsume_by(n-&gt;in(1), this);
3293     break;
3294   case Op_CallStaticJava:
3295   case Op_CallJava:
3296   case Op_CallDynamicJava:
3297     frc.inc_java_call_count(); // Count java call site;
3298   case Op_CallRuntime:
3299   case Op_CallLeaf:
3300   case Op_CallLeafNoFP: {
3301     assert (n-&gt;is_Call(), &quot;&quot;);
3302     CallNode *call = n-&gt;as_Call();
3303     // Count call sites where the FP mode bit would have to be flipped.
3304     // Do not count uncommon runtime calls:
3305     // uncommon_trap, _complete_monitor_locking, _complete_monitor_unlocking,
3306     // _new_Java, _new_typeArray, _new_objArray, _rethrow_Java, ...
3307     if (!call-&gt;is_CallStaticJava() || !call-&gt;as_CallStaticJava()-&gt;_name) {
3308       frc.inc_call_count();   // Count the call site
3309     } else {                  // See if uncommon argument is shared
3310       Node *n = call-&gt;in(TypeFunc::Parms);
3311       int nop = n-&gt;Opcode();
3312       // Clone shared simple arguments to uncommon calls, item (1).
3313       if (n-&gt;outcnt() &gt; 1 &amp;&amp;
3314           !n-&gt;is_Proj() &amp;&amp;
3315           nop != Op_CreateEx &amp;&amp;
3316           nop != Op_CheckCastPP &amp;&amp;
3317           nop != Op_DecodeN &amp;&amp;
3318           nop != Op_DecodeNKlass &amp;&amp;
3319           !n-&gt;is_Mem() &amp;&amp;
3320           !n-&gt;is_Phi()) {
3321         Node *x = n-&gt;clone();
3322         call-&gt;set_req(TypeFunc::Parms, x);
3323       }
3324     }
3325     break;
3326   }
3327 
3328   case Op_StoreD:
3329   case Op_LoadD:
3330   case Op_LoadD_unaligned:
3331     frc.inc_double_count();
3332     goto handle_mem;
3333   case Op_StoreF:
3334   case Op_LoadF:
3335     frc.inc_float_count();
3336     goto handle_mem;
3337 
3338   case Op_StoreCM:
3339     {
3340       // Convert OopStore dependence into precedence edge
3341       Node* prec = n-&gt;in(MemNode::OopStore);
3342       n-&gt;del_req(MemNode::OopStore);
3343       n-&gt;add_prec(prec);
3344       eliminate_redundant_card_marks(n);
3345     }
3346 
3347     // fall through
3348 
3349   case Op_StoreB:
3350   case Op_StoreC:
3351   case Op_StorePConditional:
3352   case Op_StoreI:
3353   case Op_StoreL:
3354   case Op_StoreIConditional:
3355   case Op_StoreLConditional:
3356   case Op_CompareAndSwapB:
3357   case Op_CompareAndSwapS:
3358   case Op_CompareAndSwapI:
3359   case Op_CompareAndSwapL:
3360   case Op_CompareAndSwapP:
3361   case Op_CompareAndSwapN:
3362   case Op_WeakCompareAndSwapB:
3363   case Op_WeakCompareAndSwapS:
3364   case Op_WeakCompareAndSwapI:
3365   case Op_WeakCompareAndSwapL:
3366   case Op_WeakCompareAndSwapP:
3367   case Op_WeakCompareAndSwapN:
3368   case Op_CompareAndExchangeB:
3369   case Op_CompareAndExchangeS:
3370   case Op_CompareAndExchangeI:
3371   case Op_CompareAndExchangeL:
3372   case Op_CompareAndExchangeP:
3373   case Op_CompareAndExchangeN:
3374   case Op_GetAndAddS:
3375   case Op_GetAndAddB:
3376   case Op_GetAndAddI:
3377   case Op_GetAndAddL:
3378   case Op_GetAndSetS:
3379   case Op_GetAndSetB:
3380   case Op_GetAndSetI:
3381   case Op_GetAndSetL:
3382   case Op_GetAndSetP:
3383   case Op_GetAndSetN:
3384   case Op_StoreP:
3385   case Op_StoreN:
3386   case Op_StoreNKlass:
3387   case Op_LoadB:
3388   case Op_LoadUB:
3389   case Op_LoadUS:
3390   case Op_LoadI:
3391   case Op_LoadKlass:
3392   case Op_LoadNKlass:
3393   case Op_LoadL:
3394   case Op_LoadL_unaligned:
3395   case Op_LoadPLocked:
3396   case Op_LoadP:
3397   case Op_LoadN:
3398   case Op_LoadRange:
3399   case Op_LoadS: {
3400   handle_mem:
3401 #ifdef ASSERT
3402     if( VerifyOptoOopOffsets ) {
3403       MemNode* mem  = n-&gt;as_Mem();
3404       // Check to see if address types have grounded out somehow.
3405       const TypeInstPtr *tp = mem-&gt;in(MemNode::Address)-&gt;bottom_type()-&gt;isa_instptr();
3406       assert( !tp || oop_offset_is_sane(tp), &quot;&quot; );
3407     }
3408 #endif
3409     break;
3410   }
3411 
3412   case Op_AddP: {               // Assert sane base pointers
3413     Node *addp = n-&gt;in(AddPNode::Address);
3414     assert( !addp-&gt;is_AddP() ||
3415             addp-&gt;in(AddPNode::Base)-&gt;is_top() || // Top OK for allocation
3416             addp-&gt;in(AddPNode::Base) == n-&gt;in(AddPNode::Base),
3417             &quot;Base pointers must match (addp %u)&quot;, addp-&gt;_idx );
3418 #ifdef _LP64
3419     if ((UseCompressedOops || UseCompressedClassPointers) &amp;&amp;
3420         addp-&gt;Opcode() == Op_ConP &amp;&amp;
3421         addp == n-&gt;in(AddPNode::Base) &amp;&amp;
3422         n-&gt;in(AddPNode::Offset)-&gt;is_Con()) {
3423       // If the transformation of ConP to ConN+DecodeN is beneficial depends
3424       // on the platform and on the compressed oops mode.
3425       // Use addressing with narrow klass to load with offset on x86.
3426       // Some platforms can use the constant pool to load ConP.
3427       // Do this transformation here since IGVN will convert ConN back to ConP.
3428       const Type* t = addp-&gt;bottom_type();
3429       bool is_oop   = t-&gt;isa_oopptr() != NULL;
3430       bool is_klass = t-&gt;isa_klassptr() != NULL;
3431 
3432       if ((is_oop   &amp;&amp; Matcher::const_oop_prefer_decode()  ) ||
3433           (is_klass &amp;&amp; Matcher::const_klass_prefer_decode())) {
3434         Node* nn = NULL;
3435 
3436         int op = is_oop ? Op_ConN : Op_ConNKlass;
3437 
3438         // Look for existing ConN node of the same exact type.
3439         Node* r  = root();
3440         uint cnt = r-&gt;outcnt();
3441         for (uint i = 0; i &lt; cnt; i++) {
3442           Node* m = r-&gt;raw_out(i);
3443           if (m!= NULL &amp;&amp; m-&gt;Opcode() == op &amp;&amp;
3444               m-&gt;bottom_type()-&gt;make_ptr() == t) {
3445             nn = m;
3446             break;
3447           }
3448         }
3449         if (nn != NULL) {
3450           // Decode a narrow oop to match address
3451           // [R12 + narrow_oop_reg&lt;&lt;3 + offset]
3452           if (is_oop) {
3453             nn = new DecodeNNode(nn, t);
3454           } else {
3455             nn = new DecodeNKlassNode(nn, t);
3456           }
3457           // Check for succeeding AddP which uses the same Base.
3458           // Otherwise we will run into the assertion above when visiting that guy.
3459           for (uint i = 0; i &lt; n-&gt;outcnt(); ++i) {
3460             Node *out_i = n-&gt;raw_out(i);
3461             if (out_i &amp;&amp; out_i-&gt;is_AddP() &amp;&amp; out_i-&gt;in(AddPNode::Base) == addp) {
3462               out_i-&gt;set_req(AddPNode::Base, nn);
3463 #ifdef ASSERT
3464               for (uint j = 0; j &lt; out_i-&gt;outcnt(); ++j) {
3465                 Node *out_j = out_i-&gt;raw_out(j);
3466                 assert(out_j == NULL || !out_j-&gt;is_AddP() || out_j-&gt;in(AddPNode::Base) != addp,
3467                        &quot;more than 2 AddP nodes in a chain (out_j %u)&quot;, out_j-&gt;_idx);
3468               }
3469 #endif
3470             }
3471           }
3472           n-&gt;set_req(AddPNode::Base, nn);
3473           n-&gt;set_req(AddPNode::Address, nn);
3474           if (addp-&gt;outcnt() == 0) {
3475             addp-&gt;disconnect_inputs(NULL, this);
3476           }
3477         }
3478       }
3479     }
3480 #endif
3481     // platform dependent reshaping of the address expression
3482     reshape_address(n-&gt;as_AddP());
3483     break;
3484   }
3485 
3486   case Op_CastPP: {
3487     // Remove CastPP nodes to gain more freedom during scheduling but
3488     // keep the dependency they encode as control or precedence edges
3489     // (if control is set already) on memory operations. Some CastPP
3490     // nodes don&#39;t have a control (don&#39;t carry a dependency): skip
3491     // those.
3492     if (n-&gt;in(0) != NULL) {
3493       ResourceMark rm;
3494       Unique_Node_List wq;
3495       wq.push(n);
3496       for (uint next = 0; next &lt; wq.size(); ++next) {
3497         Node *m = wq.at(next);
3498         for (DUIterator_Fast imax, i = m-&gt;fast_outs(imax); i &lt; imax; i++) {
3499           Node* use = m-&gt;fast_out(i);
3500           if (use-&gt;is_Mem() || use-&gt;is_EncodeNarrowPtr()) {
3501             use-&gt;ensure_control_or_add_prec(n-&gt;in(0));
3502           } else {
3503             switch(use-&gt;Opcode()) {
3504             case Op_AddP:
3505             case Op_DecodeN:
3506             case Op_DecodeNKlass:
3507             case Op_CheckCastPP:
3508             case Op_CastPP:
3509               wq.push(use);
3510               break;
3511             }
3512           }
3513         }
3514       }
3515     }
3516     const bool is_LP64 = LP64_ONLY(true) NOT_LP64(false);
3517     if (is_LP64 &amp;&amp; n-&gt;in(1)-&gt;is_DecodeN() &amp;&amp; Matcher::gen_narrow_oop_implicit_null_checks()) {
3518       Node* in1 = n-&gt;in(1);
3519       const Type* t = n-&gt;bottom_type();
3520       Node* new_in1 = in1-&gt;clone();
3521       new_in1-&gt;as_DecodeN()-&gt;set_type(t);
3522 
3523       if (!Matcher::narrow_oop_use_complex_address()) {
3524         //
3525         // x86, ARM and friends can handle 2 adds in addressing mode
3526         // and Matcher can fold a DecodeN node into address by using
3527         // a narrow oop directly and do implicit NULL check in address:
3528         //
3529         // [R12 + narrow_oop_reg&lt;&lt;3 + offset]
3530         // NullCheck narrow_oop_reg
3531         //
3532         // On other platforms (Sparc) we have to keep new DecodeN node and
3533         // use it to do implicit NULL check in address:
3534         //
3535         // decode_not_null narrow_oop_reg, base_reg
3536         // [base_reg + offset]
3537         // NullCheck base_reg
3538         //
3539         // Pin the new DecodeN node to non-null path on these platform (Sparc)
3540         // to keep the information to which NULL check the new DecodeN node
3541         // corresponds to use it as value in implicit_null_check().
3542         //
3543         new_in1-&gt;set_req(0, n-&gt;in(0));
3544       }
3545 
3546       n-&gt;subsume_by(new_in1, this);
3547       if (in1-&gt;outcnt() == 0) {
3548         in1-&gt;disconnect_inputs(NULL, this);
3549       }
3550     } else {
3551       n-&gt;subsume_by(n-&gt;in(1), this);
3552       if (n-&gt;outcnt() == 0) {
3553         n-&gt;disconnect_inputs(NULL, this);
3554       }
3555     }
3556     break;
3557   }
3558 #ifdef _LP64
3559   case Op_CmpP:
3560     // Do this transformation here to preserve CmpPNode::sub() and
3561     // other TypePtr related Ideal optimizations (for example, ptr nullness).
3562     if (n-&gt;in(1)-&gt;is_DecodeNarrowPtr() || n-&gt;in(2)-&gt;is_DecodeNarrowPtr()) {
3563       Node* in1 = n-&gt;in(1);
3564       Node* in2 = n-&gt;in(2);
3565       if (!in1-&gt;is_DecodeNarrowPtr()) {
3566         in2 = in1;
3567         in1 = n-&gt;in(2);
3568       }
3569       assert(in1-&gt;is_DecodeNarrowPtr(), &quot;sanity&quot;);
3570 
3571       Node* new_in2 = NULL;
3572       if (in2-&gt;is_DecodeNarrowPtr()) {
3573         assert(in2-&gt;Opcode() == in1-&gt;Opcode(), &quot;must be same node type&quot;);
3574         new_in2 = in2-&gt;in(1);
3575       } else if (in2-&gt;Opcode() == Op_ConP) {
3576         const Type* t = in2-&gt;bottom_type();
3577         if (t == TypePtr::NULL_PTR) {
3578           assert(in1-&gt;is_DecodeN(), &quot;compare klass to null?&quot;);
3579           // Don&#39;t convert CmpP null check into CmpN if compressed
3580           // oops implicit null check is not generated.
3581           // This will allow to generate normal oop implicit null check.
3582           if (Matcher::gen_narrow_oop_implicit_null_checks())
3583             new_in2 = ConNode::make(TypeNarrowOop::NULL_PTR);
3584           //
3585           // This transformation together with CastPP transformation above
3586           // will generated code for implicit NULL checks for compressed oops.
3587           //
3588           // The original code after Optimize()
3589           //
3590           //    LoadN memory, narrow_oop_reg
3591           //    decode narrow_oop_reg, base_reg
3592           //    CmpP base_reg, NULL
3593           //    CastPP base_reg // NotNull
3594           //    Load [base_reg + offset], val_reg
3595           //
3596           // after these transformations will be
3597           //
3598           //    LoadN memory, narrow_oop_reg
3599           //    CmpN narrow_oop_reg, NULL
3600           //    decode_not_null narrow_oop_reg, base_reg
3601           //    Load [base_reg + offset], val_reg
3602           //
3603           // and the uncommon path (== NULL) will use narrow_oop_reg directly
3604           // since narrow oops can be used in debug info now (see the code in
3605           // final_graph_reshaping_walk()).
3606           //
3607           // At the end the code will be matched to
3608           // on x86:
3609           //
3610           //    Load_narrow_oop memory, narrow_oop_reg
3611           //    Load [R12 + narrow_oop_reg&lt;&lt;3 + offset], val_reg
3612           //    NullCheck narrow_oop_reg
3613           //
3614           // and on sparc:
3615           //
3616           //    Load_narrow_oop memory, narrow_oop_reg
3617           //    decode_not_null narrow_oop_reg, base_reg
3618           //    Load [base_reg + offset], val_reg
3619           //    NullCheck base_reg
3620           //
3621         } else if (t-&gt;isa_oopptr()) {
3622           new_in2 = ConNode::make(t-&gt;make_narrowoop());
3623         } else if (t-&gt;isa_klassptr()) {
3624           new_in2 = ConNode::make(t-&gt;make_narrowklass());
3625         }
3626       }
3627       if (new_in2 != NULL) {
3628         Node* cmpN = new CmpNNode(in1-&gt;in(1), new_in2);
3629         n-&gt;subsume_by(cmpN, this);
3630         if (in1-&gt;outcnt() == 0) {
3631           in1-&gt;disconnect_inputs(NULL, this);
3632         }
3633         if (in2-&gt;outcnt() == 0) {
3634           in2-&gt;disconnect_inputs(NULL, this);
3635         }
3636       }
3637     }
3638     break;
3639 
3640   case Op_DecodeN:
3641   case Op_DecodeNKlass:
3642     assert(!n-&gt;in(1)-&gt;is_EncodeNarrowPtr(), &quot;should be optimized out&quot;);
3643     // DecodeN could be pinned when it can&#39;t be fold into
3644     // an address expression, see the code for Op_CastPP above.
3645     assert(n-&gt;in(0) == NULL || (UseCompressedOops &amp;&amp; !Matcher::narrow_oop_use_complex_address()), &quot;no control&quot;);
3646     break;
3647 
3648   case Op_EncodeP:
3649   case Op_EncodePKlass: {
3650     Node* in1 = n-&gt;in(1);
3651     if (in1-&gt;is_DecodeNarrowPtr()) {
3652       n-&gt;subsume_by(in1-&gt;in(1), this);
3653     } else if (in1-&gt;Opcode() == Op_ConP) {
3654       const Type* t = in1-&gt;bottom_type();
3655       if (t == TypePtr::NULL_PTR) {
3656         assert(t-&gt;isa_oopptr(), &quot;null klass?&quot;);
3657         n-&gt;subsume_by(ConNode::make(TypeNarrowOop::NULL_PTR), this);
3658       } else if (t-&gt;isa_oopptr()) {
3659         n-&gt;subsume_by(ConNode::make(t-&gt;make_narrowoop()), this);
3660       } else if (t-&gt;isa_klassptr()) {
3661         n-&gt;subsume_by(ConNode::make(t-&gt;make_narrowklass()), this);
3662       }
3663     }
3664     if (in1-&gt;outcnt() == 0) {
3665       in1-&gt;disconnect_inputs(NULL, this);
3666     }
3667     break;
3668   }
3669 
3670   case Op_Proj: {
3671     if (OptimizeStringConcat) {
3672       ProjNode* p = n-&gt;as_Proj();
3673       if (p-&gt;_is_io_use) {
3674         // Separate projections were used for the exception path which
3675         // are normally removed by a late inline.  If it wasn&#39;t inlined
3676         // then they will hang around and should just be replaced with
3677         // the original one.
3678         Node* proj = NULL;
3679         // Replace with just one
3680         for (SimpleDUIterator i(p-&gt;in(0)); i.has_next(); i.next()) {
3681           Node *use = i.get();
3682           if (use-&gt;is_Proj() &amp;&amp; p != use &amp;&amp; use-&gt;as_Proj()-&gt;_con == p-&gt;_con) {
3683             proj = use;
3684             break;
3685           }
3686         }
3687         assert(proj != NULL || p-&gt;_con == TypeFunc::I_O, &quot;io may be dropped at an infinite loop&quot;);
3688         if (proj != NULL) {
3689           p-&gt;subsume_by(proj, this);
3690         }
3691       }
3692     }
3693     break;
3694   }
3695 
3696   case Op_Phi:
3697     if (n-&gt;as_Phi()-&gt;bottom_type()-&gt;isa_narrowoop() || n-&gt;as_Phi()-&gt;bottom_type()-&gt;isa_narrowklass()) {
3698       // The EncodeP optimization may create Phi with the same edges
3699       // for all paths. It is not handled well by Register Allocator.
3700       Node* unique_in = n-&gt;in(1);
3701       assert(unique_in != NULL, &quot;&quot;);
3702       uint cnt = n-&gt;req();
3703       for (uint i = 2; i &lt; cnt; i++) {
3704         Node* m = n-&gt;in(i);
3705         assert(m != NULL, &quot;&quot;);
3706         if (unique_in != m)
3707           unique_in = NULL;
3708       }
3709       if (unique_in != NULL) {
3710         n-&gt;subsume_by(unique_in, this);
3711       }
3712     }
3713     break;
3714 
3715 #endif
3716 
3717 #ifdef ASSERT
3718   case Op_CastII:
3719     // Verify that all range check dependent CastII nodes were removed.
3720     if (n-&gt;isa_CastII()-&gt;has_range_check()) {
3721       n-&gt;dump(3);
3722       assert(false, &quot;Range check dependent CastII node was not removed&quot;);
3723     }
3724     break;
3725 #endif
3726 
3727   case Op_ModI:
3728     if (UseDivMod) {
3729       // Check if a%b and a/b both exist
3730       Node* d = n-&gt;find_similar(Op_DivI);
3731       if (d) {
3732         // Replace them with a fused divmod if supported
3733         if (Matcher::has_match_rule(Op_DivModI)) {
3734           DivModINode* divmod = DivModINode::make(n);
3735           d-&gt;subsume_by(divmod-&gt;div_proj(), this);
3736           n-&gt;subsume_by(divmod-&gt;mod_proj(), this);
3737         } else {
3738           // replace a%b with a-((a/b)*b)
3739           Node* mult = new MulINode(d, d-&gt;in(2));
3740           Node* sub  = new SubINode(d-&gt;in(1), mult);
3741           n-&gt;subsume_by(sub, this);
3742         }
3743       }
3744     }
3745     break;
3746 
3747   case Op_ModL:
3748     if (UseDivMod) {
3749       // Check if a%b and a/b both exist
3750       Node* d = n-&gt;find_similar(Op_DivL);
3751       if (d) {
3752         // Replace them with a fused divmod if supported
3753         if (Matcher::has_match_rule(Op_DivModL)) {
3754           DivModLNode* divmod = DivModLNode::make(n);
3755           d-&gt;subsume_by(divmod-&gt;div_proj(), this);
3756           n-&gt;subsume_by(divmod-&gt;mod_proj(), this);
3757         } else {
3758           // replace a%b with a-((a/b)*b)
3759           Node* mult = new MulLNode(d, d-&gt;in(2));
3760           Node* sub  = new SubLNode(d-&gt;in(1), mult);
3761           n-&gt;subsume_by(sub, this);
3762         }
3763       }
3764     }
3765     break;
3766 
3767   case Op_LoadVector:
3768   case Op_StoreVector:
3769     break;
3770 
3771   case Op_AddReductionVI:
3772   case Op_AddReductionVL:
3773   case Op_AddReductionVF:
3774   case Op_AddReductionVD:
3775   case Op_MulReductionVI:
3776   case Op_MulReductionVL:
3777   case Op_MulReductionVF:
3778   case Op_MulReductionVD:
3779   case Op_MinReductionV:
3780   case Op_MaxReductionV:
3781   case Op_AndReductionV:
3782   case Op_OrReductionV:
3783   case Op_XorReductionV:
3784     break;
3785 
3786   case Op_PackB:
3787   case Op_PackS:
3788   case Op_PackI:
3789   case Op_PackF:
3790   case Op_PackL:
3791   case Op_PackD:
3792     if (n-&gt;req()-1 &gt; 2) {
3793       // Replace many operand PackNodes with a binary tree for matching
3794       PackNode* p = (PackNode*) n;
3795       Node* btp = p-&gt;binary_tree_pack(1, n-&gt;req());
3796       n-&gt;subsume_by(btp, this);
3797     }
3798     break;
3799   case Op_Loop:
3800   case Op_CountedLoop:
3801   case Op_OuterStripMinedLoop:
3802     if (n-&gt;as_Loop()-&gt;is_inner_loop()) {
3803       frc.inc_inner_loop_count();
3804     }
3805     n-&gt;as_Loop()-&gt;verify_strip_mined(0);
3806     break;
3807   case Op_LShiftI:
3808   case Op_RShiftI:
3809   case Op_URShiftI:
3810   case Op_LShiftL:
3811   case Op_RShiftL:
3812   case Op_URShiftL:
3813     if (Matcher::need_masked_shift_count) {
3814       // The cpu&#39;s shift instructions don&#39;t restrict the count to the
3815       // lower 5/6 bits. We need to do the masking ourselves.
3816       Node* in2 = n-&gt;in(2);
3817       juint mask = (n-&gt;bottom_type() == TypeInt::INT) ? (BitsPerInt - 1) : (BitsPerLong - 1);
3818       const TypeInt* t = in2-&gt;find_int_type();
3819       if (t != NULL &amp;&amp; t-&gt;is_con()) {
3820         juint shift = t-&gt;get_con();
3821         if (shift &gt; mask) { // Unsigned cmp
3822           n-&gt;set_req(2, ConNode::make(TypeInt::make(shift &amp; mask)));
3823         }
3824       } else {
3825         if (t == NULL || t-&gt;_lo &lt; 0 || t-&gt;_hi &gt; (int)mask) {
3826           Node* shift = new AndINode(in2, ConNode::make(TypeInt::make(mask)));
3827           n-&gt;set_req(2, shift);
3828         }
3829       }
3830       if (in2-&gt;outcnt() == 0) { // Remove dead node
3831         in2-&gt;disconnect_inputs(NULL, this);
3832       }
3833     }
3834     break;
3835   case Op_MemBarStoreStore:
3836   case Op_MemBarRelease:
3837     // Break the link with AllocateNode: it is no longer useful and
3838     // confuses register allocation.
3839     if (n-&gt;req() &gt; MemBarNode::Precedent) {
3840       n-&gt;set_req(MemBarNode::Precedent, top());
3841     }
3842     break;
3843   case Op_MemBarAcquire: {
3844     if (n-&gt;as_MemBar()-&gt;trailing_load() &amp;&amp; n-&gt;req() &gt; MemBarNode::Precedent) {
3845       // At parse time, the trailing MemBarAcquire for a volatile load
3846       // is created with an edge to the load. After optimizations,
3847       // that input may be a chain of Phis. If those phis have no
3848       // other use, then the MemBarAcquire keeps them alive and
3849       // register allocation can be confused.
3850       ResourceMark rm;
3851       Unique_Node_List wq;
3852       wq.push(n-&gt;in(MemBarNode::Precedent));
3853       n-&gt;set_req(MemBarNode::Precedent, top());
3854       while (wq.size() &gt; 0) {
3855         Node* m = wq.pop();
3856         if (m-&gt;outcnt() == 0) {
3857           for (uint j = 0; j &lt; m-&gt;req(); j++) {
3858             Node* in = m-&gt;in(j);
3859             if (in != NULL) {
3860               wq.push(in);
3861             }
3862           }
3863           m-&gt;disconnect_inputs(NULL, this);
3864         }
3865       }
3866     }
3867     break;
3868   }
3869   case Op_RangeCheck: {
3870     RangeCheckNode* rc = n-&gt;as_RangeCheck();
3871     Node* iff = new IfNode(rc-&gt;in(0), rc-&gt;in(1), rc-&gt;_prob, rc-&gt;_fcnt);
3872     n-&gt;subsume_by(iff, this);
3873     frc._tests.push(iff);
3874     break;
3875   }
3876   case Op_ConvI2L: {
3877     if (!Matcher::convi2l_type_required) {
3878       // Code generation on some platforms doesn&#39;t need accurate
3879       // ConvI2L types. Widening the type can help remove redundant
3880       // address computations.
3881       n-&gt;as_Type()-&gt;set_type(TypeLong::INT);
3882       ResourceMark rm;
3883       Unique_Node_List wq;
3884       wq.push(n);
3885       for (uint next = 0; next &lt; wq.size(); next++) {
3886         Node *m = wq.at(next);
3887 
3888         for(;;) {
3889           // Loop over all nodes with identical inputs edges as m
3890           Node* k = m-&gt;find_similar(m-&gt;Opcode());
3891           if (k == NULL) {
3892             break;
3893           }
3894           // Push their uses so we get a chance to remove node made
3895           // redundant
3896           for (DUIterator_Fast imax, i = k-&gt;fast_outs(imax); i &lt; imax; i++) {
3897             Node* u = k-&gt;fast_out(i);
3898             if (u-&gt;Opcode() == Op_LShiftL ||
3899                 u-&gt;Opcode() == Op_AddL ||
3900                 u-&gt;Opcode() == Op_SubL ||
3901                 u-&gt;Opcode() == Op_AddP) {
3902               wq.push(u);
3903             }
3904           }
3905           // Replace all nodes with identical edges as m with m
3906           k-&gt;subsume_by(m, this);
3907         }
3908       }
3909     }
3910     break;
3911   }
3912   case Op_CmpUL: {
3913     if (!Matcher::has_match_rule(Op_CmpUL)) {
3914       // No support for unsigned long comparisons
3915       ConINode* sign_pos = new ConINode(TypeInt::make(BitsPerLong - 1));
3916       Node* sign_bit_mask = new RShiftLNode(n-&gt;in(1), sign_pos);
3917       Node* orl = new OrLNode(n-&gt;in(1), sign_bit_mask);
3918       ConLNode* remove_sign_mask = new ConLNode(TypeLong::make(max_jlong));
3919       Node* andl = new AndLNode(orl, remove_sign_mask);
3920       Node* cmp = new CmpLNode(andl, n-&gt;in(2));
3921       n-&gt;subsume_by(cmp, this);
3922     }
3923     break;
3924   }
3925 #ifdef ASSERT
3926   case Op_ValueTypePtr:
3927   case Op_ValueType: {
3928     n-&gt;dump(-1);
3929     assert(false, &quot;value type node was not removed&quot;);
3930     break;
3931   }
3932 #endif
3933   default:
3934     assert(!n-&gt;is_Call(), &quot;&quot;);
3935     assert(!n-&gt;is_Mem(), &quot;&quot;);
3936     assert(nop != Op_ProfileBoolean, &quot;should be eliminated during IGVN&quot;);
3937     break;
3938   }
3939 }
3940 
3941 //------------------------------final_graph_reshaping_walk---------------------
3942 // Replacing Opaque nodes with their input in final_graph_reshaping_impl(),
3943 // requires that the walk visits a node&#39;s inputs before visiting the node.
3944 void Compile::final_graph_reshaping_walk( Node_Stack &amp;nstack, Node *root, Final_Reshape_Counts &amp;frc ) {
3945   ResourceArea *area = Thread::current()-&gt;resource_area();
3946   Unique_Node_List sfpt(area);
3947 
3948   frc._visited.set(root-&gt;_idx); // first, mark node as visited
3949   uint cnt = root-&gt;req();
3950   Node *n = root;
3951   uint  i = 0;
3952   while (true) {
3953     if (i &lt; cnt) {
3954       // Place all non-visited non-null inputs onto stack
3955       Node* m = n-&gt;in(i);
3956       ++i;
3957       if (m != NULL &amp;&amp; !frc._visited.test_set(m-&gt;_idx)) {
3958         if (m-&gt;is_SafePoint() &amp;&amp; m-&gt;as_SafePoint()-&gt;jvms() != NULL) {
3959           // compute worst case interpreter size in case of a deoptimization
3960           update_interpreter_frame_size(m-&gt;as_SafePoint()-&gt;jvms()-&gt;interpreter_frame_size());
3961 
3962           sfpt.push(m);
3963         }
3964         cnt = m-&gt;req();
3965         nstack.push(n, i); // put on stack parent and next input&#39;s index
3966         n = m;
3967         i = 0;
3968       }
3969     } else {
3970       // Now do post-visit work
3971       final_graph_reshaping_impl( n, frc );
3972       if (nstack.is_empty())
3973         break;             // finished
3974       n = nstack.node();   // Get node from stack
3975       cnt = n-&gt;req();
3976       i = nstack.index();
3977       nstack.pop();        // Shift to the next node on stack
3978     }
3979   }
3980 
3981   // Skip next transformation if compressed oops are not used.
3982   if ((UseCompressedOops &amp;&amp; !Matcher::gen_narrow_oop_implicit_null_checks()) ||
3983       (!UseCompressedOops &amp;&amp; !UseCompressedClassPointers))
3984     return;
3985 
3986   // Go over safepoints nodes to skip DecodeN/DecodeNKlass nodes for debug edges.
3987   // It could be done for an uncommon traps or any safepoints/calls
3988   // if the DecodeN/DecodeNKlass node is referenced only in a debug info.
3989   while (sfpt.size() &gt; 0) {
3990     n = sfpt.pop();
3991     JVMState *jvms = n-&gt;as_SafePoint()-&gt;jvms();
3992     assert(jvms != NULL, &quot;sanity&quot;);
3993     int start = jvms-&gt;debug_start();
3994     int end   = n-&gt;req();
3995     bool is_uncommon = (n-&gt;is_CallStaticJava() &amp;&amp;
3996                         n-&gt;as_CallStaticJava()-&gt;uncommon_trap_request() != 0);
3997     for (int j = start; j &lt; end; j++) {
3998       Node* in = n-&gt;in(j);
3999       if (in-&gt;is_DecodeNarrowPtr()) {
4000         bool safe_to_skip = true;
4001         if (!is_uncommon ) {
4002           // Is it safe to skip?
4003           for (uint i = 0; i &lt; in-&gt;outcnt(); i++) {
4004             Node* u = in-&gt;raw_out(i);
4005             if (!u-&gt;is_SafePoint() ||
4006                 (u-&gt;is_Call() &amp;&amp; u-&gt;as_Call()-&gt;has_non_debug_use(n))) {
4007               safe_to_skip = false;
4008             }
4009           }
4010         }
4011         if (safe_to_skip) {
4012           n-&gt;set_req(j, in-&gt;in(1));
4013         }
4014         if (in-&gt;outcnt() == 0) {
4015           in-&gt;disconnect_inputs(NULL, this);
4016         }
4017       }
4018     }
4019   }
4020 }
4021 
4022 //------------------------------final_graph_reshaping--------------------------
4023 // Final Graph Reshaping.
4024 //
4025 // (1) Clone simple inputs to uncommon calls, so they can be scheduled late
4026 //     and not commoned up and forced early.  Must come after regular
4027 //     optimizations to avoid GVN undoing the cloning.  Clone constant
4028 //     inputs to Loop Phis; these will be split by the allocator anyways.
4029 //     Remove Opaque nodes.
4030 // (2) Move last-uses by commutative operations to the left input to encourage
4031 //     Intel update-in-place two-address operations and better register usage
4032 //     on RISCs.  Must come after regular optimizations to avoid GVN Ideal
4033 //     calls canonicalizing them back.
4034 // (3) Count the number of double-precision FP ops, single-precision FP ops
4035 //     and call sites.  On Intel, we can get correct rounding either by
4036 //     forcing singles to memory (requires extra stores and loads after each
4037 //     FP bytecode) or we can set a rounding mode bit (requires setting and
4038 //     clearing the mode bit around call sites).  The mode bit is only used
4039 //     if the relative frequency of single FP ops to calls is low enough.
4040 //     This is a key transform for SPEC mpeg_audio.
4041 // (4) Detect infinite loops; blobs of code reachable from above but not
4042 //     below.  Several of the Code_Gen algorithms fail on such code shapes,
4043 //     so we simply bail out.  Happens a lot in ZKM.jar, but also happens
4044 //     from time to time in other codes (such as -Xcomp finalizer loops, etc).
4045 //     Detection is by looking for IfNodes where only 1 projection is
4046 //     reachable from below or CatchNodes missing some targets.
4047 // (5) Assert for insane oop offsets in debug mode.
4048 
4049 bool Compile::final_graph_reshaping() {
4050   // an infinite loop may have been eliminated by the optimizer,
4051   // in which case the graph will be empty.
4052   if (root()-&gt;req() == 1) {
4053     record_method_not_compilable(&quot;trivial infinite loop&quot;);
4054     return true;
4055   }
4056 
4057   // Expensive nodes have their control input set to prevent the GVN
4058   // from freely commoning them. There&#39;s no GVN beyond this point so
4059   // no need to keep the control input. We want the expensive nodes to
4060   // be freely moved to the least frequent code path by gcm.
4061   assert(OptimizeExpensiveOps || expensive_count() == 0, &quot;optimization off but list non empty?&quot;);
4062   for (int i = 0; i &lt; expensive_count(); i++) {
4063     _expensive_nodes-&gt;at(i)-&gt;set_req(0, NULL);
4064   }
4065 
4066   Final_Reshape_Counts frc;
4067 
4068   // Visit everybody reachable!
4069   // Allocate stack of size C-&gt;live_nodes()/2 to avoid frequent realloc
4070   Node_Stack nstack(live_nodes() &gt;&gt; 1);
4071   final_graph_reshaping_walk(nstack, root(), frc);
4072 
4073   // Check for unreachable (from below) code (i.e., infinite loops).
4074   for( uint i = 0; i &lt; frc._tests.size(); i++ ) {
4075     MultiBranchNode *n = frc._tests[i]-&gt;as_MultiBranch();
4076     // Get number of CFG targets.
4077     // Note that PCTables include exception targets after calls.
4078     uint required_outcnt = n-&gt;required_outcnt();
4079     if (n-&gt;outcnt() != required_outcnt) {
4080       // Check for a few special cases.  Rethrow Nodes never take the
4081       // &#39;fall-thru&#39; path, so expected kids is 1 less.
4082       if (n-&gt;is_PCTable() &amp;&amp; n-&gt;in(0) &amp;&amp; n-&gt;in(0)-&gt;in(0)) {
4083         if (n-&gt;in(0)-&gt;in(0)-&gt;is_Call()) {
4084           CallNode *call = n-&gt;in(0)-&gt;in(0)-&gt;as_Call();
4085           if (call-&gt;entry_point() == OptoRuntime::rethrow_stub()) {
4086             required_outcnt--;      // Rethrow always has 1 less kid
4087           } else if (call-&gt;req() &gt; TypeFunc::Parms &amp;&amp;
4088                      call-&gt;is_CallDynamicJava()) {
4089             // Check for null receiver. In such case, the optimizer has
4090             // detected that the virtual call will always result in a null
4091             // pointer exception. The fall-through projection of this CatchNode
4092             // will not be populated.
4093             Node *arg0 = call-&gt;in(TypeFunc::Parms);
4094             if (arg0-&gt;is_Type() &amp;&amp;
4095                 arg0-&gt;as_Type()-&gt;type()-&gt;higher_equal(TypePtr::NULL_PTR)) {
4096               required_outcnt--;
4097             }
4098           } else if (call-&gt;entry_point() == OptoRuntime::new_array_Java() &amp;&amp;
4099                      call-&gt;req() &gt; TypeFunc::Parms+1 &amp;&amp;
4100                      call-&gt;is_CallStaticJava()) {
4101             // Check for negative array length. In such case, the optimizer has
4102             // detected that the allocation attempt will always result in an
4103             // exception. There is no fall-through projection of this CatchNode .
4104             Node *arg1 = call-&gt;in(TypeFunc::Parms+1);
4105             if (arg1-&gt;is_Type() &amp;&amp;
4106                 arg1-&gt;as_Type()-&gt;type()-&gt;join(TypeInt::POS)-&gt;empty()) {
4107               required_outcnt--;
4108             }
4109           }
4110         }
4111       }
4112       // Recheck with a better notion of &#39;required_outcnt&#39;
4113       if (n-&gt;outcnt() != required_outcnt) {
4114         record_method_not_compilable(&quot;malformed control flow&quot;);
4115         return true;            // Not all targets reachable!
4116       }
4117     }
4118     // Check that I actually visited all kids.  Unreached kids
4119     // must be infinite loops.
4120     for (DUIterator_Fast jmax, j = n-&gt;fast_outs(jmax); j &lt; jmax; j++)
4121       if (!frc._visited.test(n-&gt;fast_out(j)-&gt;_idx)) {
4122         record_method_not_compilable(&quot;infinite loop&quot;);
4123         return true;            // Found unvisited kid; must be unreach
4124       }
4125 
4126     // Here so verification code in final_graph_reshaping_walk()
4127     // always see an OuterStripMinedLoopEnd
4128     if (n-&gt;is_OuterStripMinedLoopEnd()) {
4129       IfNode* init_iff = n-&gt;as_If();
4130       Node* iff = new IfNode(init_iff-&gt;in(0), init_iff-&gt;in(1), init_iff-&gt;_prob, init_iff-&gt;_fcnt);
4131       n-&gt;subsume_by(iff, this);
4132     }
4133   }
4134 
4135 #ifdef IA32
4136   // If original bytecodes contained a mixture of floats and doubles
4137   // check if the optimizer has made it homogenous, item (3).
4138   if (UseSSE == 0 &amp;&amp;
4139       frc.get_float_count() &gt; 32 &amp;&amp;
4140       frc.get_double_count() == 0 &amp;&amp;
4141       (10 * frc.get_call_count() &lt; frc.get_float_count()) ) {
4142     set_24_bit_selection_and_mode(false, true);
4143   }
4144 #endif // IA32
4145 
4146   set_java_calls(frc.get_java_call_count());
4147   set_inner_loops(frc.get_inner_loop_count());
4148 
4149   // No infinite loops, no reason to bail out.
4150   return false;
4151 }
4152 
4153 //-----------------------------too_many_traps----------------------------------
4154 // Report if there are too many traps at the current method and bci.
4155 // Return true if there was a trap, and/or PerMethodTrapLimit is exceeded.
4156 bool Compile::too_many_traps(ciMethod* method,
4157                              int bci,
4158                              Deoptimization::DeoptReason reason) {
4159   ciMethodData* md = method-&gt;method_data();
4160   if (md-&gt;is_empty()) {
4161     // Assume the trap has not occurred, or that it occurred only
4162     // because of a transient condition during start-up in the interpreter.
4163     return false;
4164   }
4165   ciMethod* m = Deoptimization::reason_is_speculate(reason) ? this-&gt;method() : NULL;
4166   if (md-&gt;has_trap_at(bci, m, reason) != 0) {
4167     // Assume PerBytecodeTrapLimit==0, for a more conservative heuristic.
4168     // Also, if there are multiple reasons, or if there is no per-BCI record,
4169     // assume the worst.
4170     if (log())
4171       log()-&gt;elem(&quot;observe trap=&#39;%s&#39; count=&#39;%d&#39;&quot;,
4172                   Deoptimization::trap_reason_name(reason),
4173                   md-&gt;trap_count(reason));
4174     return true;
4175   } else {
4176     // Ignore method/bci and see if there have been too many globally.
4177     return too_many_traps(reason, md);
4178   }
4179 }
4180 
4181 // Less-accurate variant which does not require a method and bci.
4182 bool Compile::too_many_traps(Deoptimization::DeoptReason reason,
4183                              ciMethodData* logmd) {
4184   if (trap_count(reason) &gt;= Deoptimization::per_method_trap_limit(reason)) {
4185     // Too many traps globally.
4186     // Note that we use cumulative trap_count, not just md-&gt;trap_count.
4187     if (log()) {
4188       int mcount = (logmd == NULL)? -1: (int)logmd-&gt;trap_count(reason);
4189       log()-&gt;elem(&quot;observe trap=&#39;%s&#39; count=&#39;0&#39; mcount=&#39;%d&#39; ccount=&#39;%d&#39;&quot;,
4190                   Deoptimization::trap_reason_name(reason),
4191                   mcount, trap_count(reason));
4192     }
4193     return true;
4194   } else {
4195     // The coast is clear.
4196     return false;
4197   }
4198 }
4199 
4200 //--------------------------too_many_recompiles--------------------------------
4201 // Report if there are too many recompiles at the current method and bci.
4202 // Consults PerBytecodeRecompilationCutoff and PerMethodRecompilationCutoff.
4203 // Is not eager to return true, since this will cause the compiler to use
4204 // Action_none for a trap point, to avoid too many recompilations.
4205 bool Compile::too_many_recompiles(ciMethod* method,
4206                                   int bci,
4207                                   Deoptimization::DeoptReason reason) {
4208   ciMethodData* md = method-&gt;method_data();
4209   if (md-&gt;is_empty()) {
4210     // Assume the trap has not occurred, or that it occurred only
4211     // because of a transient condition during start-up in the interpreter.
4212     return false;
4213   }
4214   // Pick a cutoff point well within PerBytecodeRecompilationCutoff.
4215   uint bc_cutoff = (uint) PerBytecodeRecompilationCutoff / 8;
4216   uint m_cutoff  = (uint) PerMethodRecompilationCutoff / 2 + 1;  // not zero
4217   Deoptimization::DeoptReason per_bc_reason
4218     = Deoptimization::reason_recorded_per_bytecode_if_any(reason);
4219   ciMethod* m = Deoptimization::reason_is_speculate(reason) ? this-&gt;method() : NULL;
4220   if ((per_bc_reason == Deoptimization::Reason_none
4221        || md-&gt;has_trap_at(bci, m, reason) != 0)
4222       // The trap frequency measure we care about is the recompile count:
4223       &amp;&amp; md-&gt;trap_recompiled_at(bci, m)
4224       &amp;&amp; md-&gt;overflow_recompile_count() &gt;= bc_cutoff) {
4225     // Do not emit a trap here if it has already caused recompilations.
4226     // Also, if there are multiple reasons, or if there is no per-BCI record,
4227     // assume the worst.
4228     if (log())
4229       log()-&gt;elem(&quot;observe trap=&#39;%s recompiled&#39; count=&#39;%d&#39; recompiles2=&#39;%d&#39;&quot;,
4230                   Deoptimization::trap_reason_name(reason),
4231                   md-&gt;trap_count(reason),
4232                   md-&gt;overflow_recompile_count());
4233     return true;
4234   } else if (trap_count(reason) != 0
4235              &amp;&amp; decompile_count() &gt;= m_cutoff) {
4236     // Too many recompiles globally, and we have seen this sort of trap.
4237     // Use cumulative decompile_count, not just md-&gt;decompile_count.
4238     if (log())
4239       log()-&gt;elem(&quot;observe trap=&#39;%s&#39; count=&#39;%d&#39; mcount=&#39;%d&#39; decompiles=&#39;%d&#39; mdecompiles=&#39;%d&#39;&quot;,
4240                   Deoptimization::trap_reason_name(reason),
4241                   md-&gt;trap_count(reason), trap_count(reason),
4242                   md-&gt;decompile_count(), decompile_count());
4243     return true;
4244   } else {
4245     // The coast is clear.
4246     return false;
4247   }
4248 }
4249 
4250 // Compute when not to trap. Used by matching trap based nodes and
4251 // NullCheck optimization.
4252 void Compile::set_allowed_deopt_reasons() {
4253   _allowed_reasons = 0;
4254   if (is_method_compilation()) {
4255     for (int rs = (int)Deoptimization::Reason_none+1; rs &lt; Compile::trapHistLength; rs++) {
4256       assert(rs &lt; BitsPerInt, &quot;recode bit map&quot;);
4257       if (!too_many_traps((Deoptimization::DeoptReason) rs)) {
4258         _allowed_reasons |= nth_bit(rs);
4259       }
4260     }
4261   }
4262 }
4263 
4264 bool Compile::needs_clinit_barrier(ciMethod* method, ciMethod* accessing_method) {
4265   return method-&gt;is_static() &amp;&amp; needs_clinit_barrier(method-&gt;holder(), accessing_method);
4266 }
4267 
4268 bool Compile::needs_clinit_barrier(ciField* field, ciMethod* accessing_method) {
4269   return field-&gt;is_static() &amp;&amp; needs_clinit_barrier(field-&gt;holder(), accessing_method);
4270 }
4271 
4272 bool Compile::needs_clinit_barrier(ciInstanceKlass* holder, ciMethod* accessing_method) {
4273   if (holder-&gt;is_initialized()) {
4274     return false;
4275   }
4276   if (holder-&gt;is_being_initialized()) {
4277     if (accessing_method-&gt;holder() == holder) {
4278       // Access inside a class. The barrier can be elided when access happens in &lt;clinit&gt;,
4279       // &lt;init&gt;, or a static method. In all those cases, there was an initialization
4280       // barrier on the holder klass passed.
4281       if (accessing_method-&gt;is_class_initializer() ||
4282           accessing_method-&gt;is_object_constructor() ||
4283           accessing_method-&gt;is_static()) {
4284         return false;
4285       }
4286     } else if (accessing_method-&gt;holder()-&gt;is_subclass_of(holder)) {
4287       // Access from a subclass. The barrier can be elided only when access happens in &lt;clinit&gt;.
4288       // In case of &lt;init&gt; or a static method, the barrier is on the subclass is not enough:
4289       // child class can become fully initialized while its parent class is still being initialized.
4290       if (accessing_method-&gt;is_class_initializer()) {
4291         return false;
4292       }
4293     }
4294     ciMethod* root = method(); // the root method of compilation
4295     if (root != accessing_method) {
4296       return needs_clinit_barrier(holder, root); // check access in the context of compilation root
4297     }
4298   }
4299   return true;
4300 }
4301 
4302 #ifndef PRODUCT
4303 //------------------------------verify_graph_edges---------------------------
4304 // Walk the Graph and verify that there is a one-to-one correspondence
4305 // between Use-Def edges and Def-Use edges in the graph.
4306 void Compile::verify_graph_edges(bool no_dead_code) {
4307   if (VerifyGraphEdges) {
4308     ResourceArea *area = Thread::current()-&gt;resource_area();
4309     Unique_Node_List visited(area);
4310     // Call recursive graph walk to check edges
4311     _root-&gt;verify_edges(visited);
4312     if (no_dead_code) {
4313       // Now make sure that no visited node is used by an unvisited node.
4314       bool dead_nodes = false;
4315       Unique_Node_List checked(area);
4316       while (visited.size() &gt; 0) {
4317         Node* n = visited.pop();
4318         checked.push(n);
4319         for (uint i = 0; i &lt; n-&gt;outcnt(); i++) {
4320           Node* use = n-&gt;raw_out(i);
4321           if (checked.member(use))  continue;  // already checked
4322           if (visited.member(use))  continue;  // already in the graph
4323           if (use-&gt;is_Con())        continue;  // a dead ConNode is OK
4324           // At this point, we have found a dead node which is DU-reachable.
4325           if (!dead_nodes) {
4326             tty-&gt;print_cr(&quot;*** Dead nodes reachable via DU edges:&quot;);
4327             dead_nodes = true;
4328           }
4329           use-&gt;dump(2);
4330           tty-&gt;print_cr(&quot;---&quot;);
4331           checked.push(use);  // No repeats; pretend it is now checked.
4332         }
4333       }
4334       assert(!dead_nodes, &quot;using nodes must be reachable from root&quot;);
4335     }
4336   }
4337 }
4338 #endif
4339 
4340 // The Compile object keeps track of failure reasons separately from the ciEnv.
4341 // This is required because there is not quite a 1-1 relation between the
4342 // ciEnv and its compilation task and the Compile object.  Note that one
4343 // ciEnv might use two Compile objects, if C2Compiler::compile_method decides
4344 // to backtrack and retry without subsuming loads.  Other than this backtracking
4345 // behavior, the Compile&#39;s failure reason is quietly copied up to the ciEnv
4346 // by the logic in C2Compiler.
4347 void Compile::record_failure(const char* reason) {
4348   if (log() != NULL) {
4349     log()-&gt;elem(&quot;failure reason=&#39;%s&#39; phase=&#39;compile&#39;&quot;, reason);
4350   }
4351   if (_failure_reason == NULL) {
4352     // Record the first failure reason.
4353     _failure_reason = reason;
4354   }
4355 
4356   if (!C-&gt;failure_reason_is(C2Compiler::retry_no_subsuming_loads())) {
4357     C-&gt;print_method(PHASE_FAILURE);
4358   }
4359   _root = NULL;  // flush the graph, too
4360 }
4361 
4362 Compile::TracePhase::TracePhase(const char* name, elapsedTimer* accumulator)
4363   : TraceTime(name, accumulator, CITime, CITimeVerbose),
4364     _phase_name(name), _dolog(CITimeVerbose)
4365 {
4366   if (_dolog) {
4367     C = Compile::current();
4368     _log = C-&gt;log();
4369   } else {
4370     C = NULL;
4371     _log = NULL;
4372   }
4373   if (_log != NULL) {
4374     _log-&gt;begin_head(&quot;phase name=&#39;%s&#39; nodes=&#39;%d&#39; live=&#39;%d&#39;&quot;, _phase_name, C-&gt;unique(), C-&gt;live_nodes());
4375     _log-&gt;stamp();
4376     _log-&gt;end_head();
4377   }
4378 }
4379 
4380 Compile::TracePhase::~TracePhase() {
4381 
4382   C = Compile::current();
4383   if (_dolog) {
4384     _log = C-&gt;log();
4385   } else {
4386     _log = NULL;
4387   }
4388 
4389 #ifdef ASSERT
4390   if (PrintIdealNodeCount) {
4391     tty-&gt;print_cr(&quot;phase name=&#39;%s&#39; nodes=&#39;%d&#39; live=&#39;%d&#39; live_graph_walk=&#39;%d&#39;&quot;,
4392                   _phase_name, C-&gt;unique(), C-&gt;live_nodes(), C-&gt;count_live_nodes_by_graph_walk());
4393   }
4394 
4395   if (VerifyIdealNodeCount) {
4396     Compile::current()-&gt;print_missing_nodes();
4397   }
4398 #endif
4399 
4400   if (_log != NULL) {
4401     _log-&gt;done(&quot;phase name=&#39;%s&#39; nodes=&#39;%d&#39; live=&#39;%d&#39;&quot;, _phase_name, C-&gt;unique(), C-&gt;live_nodes());
4402   }
4403 }
4404 
4405 //----------------------------static_subtype_check-----------------------------
4406 // Shortcut important common cases when superklass is exact:
4407 // (0) superklass is java.lang.Object (can occur in reflective code)
4408 // (1) subklass is already limited to a subtype of superklass =&gt; always ok
4409 // (2) subklass does not overlap with superklass =&gt; always fail
4410 // (3) superklass has NO subtypes and we can check with a simple compare.
4411 int Compile::static_subtype_check(ciKlass* superk, ciKlass* subk) {
4412   if (StressReflectiveCode || superk == NULL || subk == NULL) {
4413     return SSC_full_test;       // Let caller generate the general case.
4414   }
4415 
4416   if (superk == env()-&gt;Object_klass()) {
4417     return SSC_always_true;     // (0) this test cannot fail
4418   }
4419 
4420   ciType* superelem = superk;
4421   if (superelem-&gt;is_array_klass()) {
4422     ciArrayKlass* ak = superelem-&gt;as_array_klass();
4423     superelem = superelem-&gt;as_array_klass()-&gt;base_element_type();
4424   }
4425 
4426   if (!subk-&gt;is_interface()) {  // cannot trust static interface types yet
4427     if (subk-&gt;is_subtype_of(superk)) {
4428       return SSC_always_true;   // (1) false path dead; no dynamic test needed
4429     }
4430     if (!(superelem-&gt;is_klass() &amp;&amp; superelem-&gt;as_klass()-&gt;is_interface()) &amp;&amp;
4431         !superk-&gt;is_subtype_of(subk)) {
4432       return SSC_always_false;
4433     }
4434   }
4435 
4436   // If casting to an instance klass, it must have no subtypes
4437   if (superk-&gt;is_interface()) {
4438     // Cannot trust interfaces yet.
4439     // %%% S.B. superk-&gt;nof_implementors() == 1
4440   } else if (superelem-&gt;is_instance_klass()) {
4441     ciInstanceKlass* ik = superelem-&gt;as_instance_klass();
4442     if (!ik-&gt;has_subklass() &amp;&amp; !ik-&gt;is_interface()) {
4443       if (!ik-&gt;is_final()) {
4444         // Add a dependency if there is a chance of a later subclass.
4445         dependencies()-&gt;assert_leaf_type(ik);
4446       }
4447       return SSC_easy_test;     // (3) caller can do a simple ptr comparison
4448     }
4449   } else {
4450     // A primitive array type has no subtypes.
4451     return SSC_easy_test;       // (3) caller can do a simple ptr comparison
4452   }
4453 
4454   return SSC_full_test;
4455 }
4456 
4457 Node* Compile::conv_I2X_index(PhaseGVN* phase, Node* idx, const TypeInt* sizetype, Node* ctrl) {
4458 #ifdef _LP64
4459   // The scaled index operand to AddP must be a clean 64-bit value.
4460   // Java allows a 32-bit int to be incremented to a negative
4461   // value, which appears in a 64-bit register as a large
4462   // positive number.  Using that large positive number as an
4463   // operand in pointer arithmetic has bad consequences.
4464   // On the other hand, 32-bit overflow is rare, and the possibility
4465   // can often be excluded, if we annotate the ConvI2L node with
4466   // a type assertion that its value is known to be a small positive
4467   // number.  (The prior range check has ensured this.)
4468   // This assertion is used by ConvI2LNode::Ideal.
4469   int index_max = max_jint - 1;  // array size is max_jint, index is one less
4470   if (sizetype != NULL) index_max = sizetype-&gt;_hi - 1;
4471   const TypeInt* iidxtype = TypeInt::make(0, index_max, Type::WidenMax);
4472   idx = constrained_convI2L(phase, idx, iidxtype, ctrl);
4473 #endif
4474   return idx;
4475 }
4476 
4477 // Convert integer value to a narrowed long type dependent on ctrl (for example, a range check)
4478 Node* Compile::constrained_convI2L(PhaseGVN* phase, Node* value, const TypeInt* itype, Node* ctrl) {
4479   if (ctrl != NULL) {
4480     // Express control dependency by a CastII node with a narrow type.
4481     value = new CastIINode(value, itype, false, true /* range check dependency */);
4482     // Make the CastII node dependent on the control input to prevent the narrowed ConvI2L
4483     // node from floating above the range check during loop optimizations. Otherwise, the
4484     // ConvI2L node may be eliminated independently of the range check, causing the data path
4485     // to become TOP while the control path is still there (although it&#39;s unreachable).
4486     value-&gt;set_req(0, ctrl);
4487     // Save CastII node to remove it after loop optimizations.
4488     phase-&gt;C-&gt;add_range_check_cast(value);
4489     value = phase-&gt;transform(value);
4490   }
4491   const TypeLong* ltype = TypeLong::make(itype-&gt;_lo, itype-&gt;_hi, itype-&gt;_widen);
4492   return phase-&gt;transform(new ConvI2LNode(value, ltype));
4493 }
4494 
4495 void Compile::print_inlining_stream_free() {
4496   if (_print_inlining_stream != NULL) {
4497     _print_inlining_stream-&gt;~stringStream();
4498     _print_inlining_stream = NULL;
4499   }
4500 }
4501 
4502 // The message about the current inlining is accumulated in
4503 // _print_inlining_stream and transfered into the _print_inlining_list
4504 // once we know whether inlining succeeds or not. For regular
4505 // inlining, messages are appended to the buffer pointed by
4506 // _print_inlining_idx in the _print_inlining_list. For late inlining,
4507 // a new buffer is added after _print_inlining_idx in the list. This
4508 // way we can update the inlining message for late inlining call site
4509 // when the inlining is attempted again.
4510 void Compile::print_inlining_init() {
4511   if (print_inlining() || print_intrinsics()) {
4512     // print_inlining_init is actually called several times.
4513     print_inlining_stream_free();
4514     _print_inlining_stream = new stringStream();
4515     // Watch out: The memory initialized by the constructor call PrintInliningBuffer()
4516     // will be copied into the only initial element. The default destructor of
4517     // PrintInliningBuffer will be called when leaving the scope here. If it
4518     // would destuct the  enclosed stringStream _print_inlining_list[0]-&gt;_ss
4519     // would be destructed, too!
4520     _print_inlining_list = new (comp_arena())GrowableArray&lt;PrintInliningBuffer&gt;(comp_arena(), 1, 1, PrintInliningBuffer());
4521   }
4522 }
4523 
4524 void Compile::print_inlining_reinit() {
4525   if (print_inlining() || print_intrinsics()) {
4526     print_inlining_stream_free();
4527     // Re allocate buffer when we change ResourceMark
4528     _print_inlining_stream = new stringStream();
4529   }
4530 }
4531 
4532 void Compile::print_inlining_reset() {
4533   _print_inlining_stream-&gt;reset();
4534 }
4535 
4536 void Compile::print_inlining_commit() {
4537   assert(print_inlining() || print_intrinsics(), &quot;PrintInlining off?&quot;);
4538   // Transfer the message from _print_inlining_stream to the current
4539   // _print_inlining_list buffer and clear _print_inlining_stream.
4540   _print_inlining_list-&gt;at(_print_inlining_idx).ss()-&gt;write(_print_inlining_stream-&gt;base(), _print_inlining_stream-&gt;size());
4541   print_inlining_reset();
4542 }
4543 
4544 void Compile::print_inlining_push() {
4545   // Add new buffer to the _print_inlining_list at current position
4546   _print_inlining_idx++;
4547   _print_inlining_list-&gt;insert_before(_print_inlining_idx, PrintInliningBuffer());
4548 }
4549 
4550 Compile::PrintInliningBuffer&amp; Compile::print_inlining_current() {
4551   return _print_inlining_list-&gt;at(_print_inlining_idx);
4552 }
4553 
4554 void Compile::print_inlining_update(CallGenerator* cg) {
4555   if (print_inlining() || print_intrinsics()) {
4556     if (!cg-&gt;is_late_inline()) {
4557       if (print_inlining_current().cg() != NULL) {
4558         print_inlining_push();
4559       }
4560       print_inlining_commit();
4561     } else {
4562       if (print_inlining_current().cg() != cg &amp;&amp;
4563           (print_inlining_current().cg() != NULL ||
4564            print_inlining_current().ss()-&gt;size() != 0)) {
4565         print_inlining_push();
4566       }
4567       print_inlining_commit();
4568       print_inlining_current().set_cg(cg);
4569     }
4570   }
4571 }
4572 
4573 void Compile::print_inlining_move_to(CallGenerator* cg) {
4574   // We resume inlining at a late inlining call site. Locate the
4575   // corresponding inlining buffer so that we can update it.
4576   if (print_inlining()) {
4577     for (int i = 0; i &lt; _print_inlining_list-&gt;length(); i++) {
4578       if (_print_inlining_list-&gt;adr_at(i)-&gt;cg() == cg) {
4579         _print_inlining_idx = i;
4580         return;
4581       }
4582     }
4583     ShouldNotReachHere();
4584   }
4585 }
4586 
4587 void Compile::print_inlining_update_delayed(CallGenerator* cg) {
4588   if (print_inlining()) {
4589     assert(_print_inlining_stream-&gt;size() &gt; 0, &quot;missing inlining msg&quot;);
4590     assert(print_inlining_current().cg() == cg, &quot;wrong entry&quot;);
4591     // replace message with new message
4592     _print_inlining_list-&gt;at_put(_print_inlining_idx, PrintInliningBuffer());
4593     print_inlining_commit();
4594     print_inlining_current().set_cg(cg);
4595   }
4596 }
4597 
4598 void Compile::print_inlining_assert_ready() {
4599   assert(!_print_inlining || _print_inlining_stream-&gt;size() == 0, &quot;loosing data&quot;);
4600 }
4601 
4602 void Compile::process_print_inlining() {
4603   bool do_print_inlining = print_inlining() || print_intrinsics();
4604   if (do_print_inlining || log() != NULL) {
4605     // Print inlining message for candidates that we couldn&#39;t inline
4606     // for lack of space
4607     for (int i = 0; i &lt; _late_inlines.length(); i++) {
4608       CallGenerator* cg = _late_inlines.at(i);
4609       if (!cg-&gt;is_mh_late_inline()) {
4610         const char* msg = &quot;live nodes &gt; LiveNodeCountInliningCutoff&quot;;
4611         if (do_print_inlining) {
4612           cg-&gt;print_inlining_late(msg);
4613         }
4614         log_late_inline_failure(cg, msg);
4615       }
4616     }
4617   }
4618   if (do_print_inlining) {
4619     ResourceMark rm;
4620     stringStream ss;
4621     assert(_print_inlining_list != NULL, &quot;process_print_inlining should be called only once.&quot;);
4622     for (int i = 0; i &lt; _print_inlining_list-&gt;length(); i++) {
4623       ss.print(&quot;%s&quot;, _print_inlining_list-&gt;adr_at(i)-&gt;ss()-&gt;as_string());
4624       _print_inlining_list-&gt;at(i).freeStream();
4625     }
4626     // Reset _print_inlining_list, it only contains destructed objects.
4627     // It is on the arena, so it will be freed when the arena is reset.
4628     _print_inlining_list = NULL;
4629     // _print_inlining_stream won&#39;t be used anymore, either.
4630     print_inlining_stream_free();
4631     size_t end = ss.size();
4632     _print_inlining_output = NEW_ARENA_ARRAY(comp_arena(), char, end+1);
4633     strncpy(_print_inlining_output, ss.base(), end+1);
4634     _print_inlining_output[end] = 0;
4635   }
4636 }
4637 
4638 void Compile::dump_print_inlining() {
4639   if (_print_inlining_output != NULL) {
4640     tty-&gt;print_raw(_print_inlining_output);
4641   }
4642 }
4643 
4644 void Compile::log_late_inline(CallGenerator* cg) {
4645   if (log() != NULL) {
4646     log()-&gt;head(&quot;late_inline method=&#39;%d&#39;  inline_id=&#39;&quot; JLONG_FORMAT &quot;&#39;&quot;, log()-&gt;identify(cg-&gt;method()),
4647                 cg-&gt;unique_id());
4648     JVMState* p = cg-&gt;call_node()-&gt;jvms();
4649     while (p != NULL) {
4650       log()-&gt;elem(&quot;jvms bci=&#39;%d&#39; method=&#39;%d&#39;&quot;, p-&gt;bci(), log()-&gt;identify(p-&gt;method()));
4651       p = p-&gt;caller();
4652     }
4653     log()-&gt;tail(&quot;late_inline&quot;);
4654   }
4655 }
4656 
4657 void Compile::log_late_inline_failure(CallGenerator* cg, const char* msg) {
4658   log_late_inline(cg);
4659   if (log() != NULL) {
4660     log()-&gt;inline_fail(msg);
4661   }
4662 }
4663 
4664 void Compile::log_inline_id(CallGenerator* cg) {
4665   if (log() != NULL) {
4666     // The LogCompilation tool needs a unique way to identify late
4667     // inline call sites. This id must be unique for this call site in
4668     // this compilation. Try to have it unique across compilations as
4669     // well because it can be convenient when grepping through the log
4670     // file.
4671     // Distinguish OSR compilations from others in case CICountOSR is
4672     // on.
4673     jlong id = ((jlong)unique()) + (((jlong)compile_id()) &lt;&lt; 33) + (CICountOSR &amp;&amp; is_osr_compilation() ? ((jlong)1) &lt;&lt; 32 : 0);
4674     cg-&gt;set_unique_id(id);
4675     log()-&gt;elem(&quot;inline_id id=&#39;&quot; JLONG_FORMAT &quot;&#39;&quot;, id);
4676   }
4677 }
4678 
4679 void Compile::log_inline_failure(const char* msg) {
4680   if (C-&gt;log() != NULL) {
4681     C-&gt;log()-&gt;inline_fail(msg);
4682   }
4683 }
4684 
4685 
4686 // Dump inlining replay data to the stream.
4687 // Don&#39;t change thread state and acquire any locks.
4688 void Compile::dump_inline_data(outputStream* out) {
4689   InlineTree* inl_tree = ilt();
4690   if (inl_tree != NULL) {
4691     out-&gt;print(&quot; inline %d&quot;, inl_tree-&gt;count());
4692     inl_tree-&gt;dump_replay_data(out);
4693   }
4694 }
4695 
4696 int Compile::cmp_expensive_nodes(Node* n1, Node* n2) {
4697   if (n1-&gt;Opcode() &lt; n2-&gt;Opcode())      return -1;
4698   else if (n1-&gt;Opcode() &gt; n2-&gt;Opcode()) return 1;
4699 
4700   assert(n1-&gt;req() == n2-&gt;req(), &quot;can&#39;t compare %s nodes: n1-&gt;req() = %d, n2-&gt;req() = %d&quot;, NodeClassNames[n1-&gt;Opcode()], n1-&gt;req(), n2-&gt;req());
4701   for (uint i = 1; i &lt; n1-&gt;req(); i++) {
4702     if (n1-&gt;in(i) &lt; n2-&gt;in(i))      return -1;
4703     else if (n1-&gt;in(i) &gt; n2-&gt;in(i)) return 1;
4704   }
4705 
4706   return 0;
4707 }
4708 
4709 int Compile::cmp_expensive_nodes(Node** n1p, Node** n2p) {
4710   Node* n1 = *n1p;
4711   Node* n2 = *n2p;
4712 
4713   return cmp_expensive_nodes(n1, n2);
4714 }
4715 
4716 void Compile::sort_expensive_nodes() {
4717   if (!expensive_nodes_sorted()) {
4718     _expensive_nodes-&gt;sort(cmp_expensive_nodes);
4719   }
4720 }
4721 
4722 bool Compile::expensive_nodes_sorted() const {
4723   for (int i = 1; i &lt; _expensive_nodes-&gt;length(); i++) {
4724     if (cmp_expensive_nodes(_expensive_nodes-&gt;adr_at(i), _expensive_nodes-&gt;adr_at(i-1)) &lt; 0) {
4725       return false;
4726     }
4727   }
4728   return true;
4729 }
4730 
4731 bool Compile::should_optimize_expensive_nodes(PhaseIterGVN &amp;igvn) {
4732   if (_expensive_nodes-&gt;length() == 0) {
4733     return false;
4734   }
4735 
4736   assert(OptimizeExpensiveOps, &quot;optimization off?&quot;);
4737 
4738   // Take this opportunity to remove dead nodes from the list
4739   int j = 0;
4740   for (int i = 0; i &lt; _expensive_nodes-&gt;length(); i++) {
4741     Node* n = _expensive_nodes-&gt;at(i);
4742     if (!n-&gt;is_unreachable(igvn)) {
4743       assert(n-&gt;is_expensive(), &quot;should be expensive&quot;);
4744       _expensive_nodes-&gt;at_put(j, n);
4745       j++;
4746     }
4747   }
4748   _expensive_nodes-&gt;trunc_to(j);
4749 
4750   // Then sort the list so that similar nodes are next to each other
4751   // and check for at least two nodes of identical kind with same data
4752   // inputs.
4753   sort_expensive_nodes();
4754 
4755   for (int i = 0; i &lt; _expensive_nodes-&gt;length()-1; i++) {
4756     if (cmp_expensive_nodes(_expensive_nodes-&gt;adr_at(i), _expensive_nodes-&gt;adr_at(i+1)) == 0) {
4757       return true;
4758     }
4759   }
4760 
4761   return false;
4762 }
4763 
4764 void Compile::cleanup_expensive_nodes(PhaseIterGVN &amp;igvn) {
4765   if (_expensive_nodes-&gt;length() == 0) {
4766     return;
4767   }
4768 
4769   assert(OptimizeExpensiveOps, &quot;optimization off?&quot;);
4770 
4771   // Sort to bring similar nodes next to each other and clear the
4772   // control input of nodes for which there&#39;s only a single copy.
4773   sort_expensive_nodes();
4774 
4775   int j = 0;
4776   int identical = 0;
4777   int i = 0;
4778   bool modified = false;
4779   for (; i &lt; _expensive_nodes-&gt;length()-1; i++) {
4780     assert(j &lt;= i, &quot;can&#39;t write beyond current index&quot;);
4781     if (_expensive_nodes-&gt;at(i)-&gt;Opcode() == _expensive_nodes-&gt;at(i+1)-&gt;Opcode()) {
4782       identical++;
4783       _expensive_nodes-&gt;at_put(j++, _expensive_nodes-&gt;at(i));
4784       continue;
4785     }
4786     if (identical &gt; 0) {
4787       _expensive_nodes-&gt;at_put(j++, _expensive_nodes-&gt;at(i));
4788       identical = 0;
4789     } else {
4790       Node* n = _expensive_nodes-&gt;at(i);
4791       igvn.replace_input_of(n, 0, NULL);
4792       igvn.hash_insert(n);
4793       modified = true;
4794     }
4795   }
4796   if (identical &gt; 0) {
4797     _expensive_nodes-&gt;at_put(j++, _expensive_nodes-&gt;at(i));
4798   } else if (_expensive_nodes-&gt;length() &gt;= 1) {
4799     Node* n = _expensive_nodes-&gt;at(i);
4800     igvn.replace_input_of(n, 0, NULL);
4801     igvn.hash_insert(n);
4802     modified = true;
4803   }
4804   _expensive_nodes-&gt;trunc_to(j);
4805   if (modified) {
4806     igvn.optimize();
4807   }
4808 }
4809 
4810 void Compile::add_expensive_node(Node * n) {
4811   assert(!_expensive_nodes-&gt;contains(n), &quot;duplicate entry in expensive list&quot;);
4812   assert(n-&gt;is_expensive(), &quot;expensive nodes with non-null control here only&quot;);
4813   assert(!n-&gt;is_CFG() &amp;&amp; !n-&gt;is_Mem(), &quot;no cfg or memory nodes here&quot;);
4814   if (OptimizeExpensiveOps) {
4815     _expensive_nodes-&gt;append(n);
4816   } else {
4817     // Clear control input and let IGVN optimize expensive nodes if
4818     // OptimizeExpensiveOps is off.
4819     n-&gt;set_req(0, NULL);
4820   }
4821 }
4822 
4823 /**
4824  * Remove the speculative part of types and clean up the graph
4825  */
4826 void Compile::remove_speculative_types(PhaseIterGVN &amp;igvn) {
4827   if (UseTypeSpeculation) {
4828     Unique_Node_List worklist;
4829     worklist.push(root());
4830     int modified = 0;
4831     // Go over all type nodes that carry a speculative type, drop the
4832     // speculative part of the type and enqueue the node for an igvn
4833     // which may optimize it out.
4834     for (uint next = 0; next &lt; worklist.size(); ++next) {
4835       Node *n  = worklist.at(next);
4836       if (n-&gt;is_Type()) {
4837         TypeNode* tn = n-&gt;as_Type();
4838         const Type* t = tn-&gt;type();
4839         const Type* t_no_spec = t-&gt;remove_speculative();
4840         if (t_no_spec != t) {
4841           bool in_hash = igvn.hash_delete(n);
4842           assert(in_hash, &quot;node should be in igvn hash table&quot;);
4843           tn-&gt;set_type(t_no_spec);
4844           igvn.hash_insert(n);
4845           igvn._worklist.push(n); // give it a chance to go away
4846           modified++;
4847         }
4848       }
4849       uint max = n-&gt;len();
4850       for( uint i = 0; i &lt; max; ++i ) {
4851         Node *m = n-&gt;in(i);
4852         if (not_a_node(m))  continue;
4853         worklist.push(m);
4854       }
4855     }
4856     // Drop the speculative part of all types in the igvn&#39;s type table
4857     igvn.remove_speculative_types();
4858     if (modified &gt; 0) {
4859       igvn.optimize();
4860     }
4861 #ifdef ASSERT
4862     // Verify that after the IGVN is over no speculative type has resurfaced
4863     worklist.clear();
4864     worklist.push(root());
4865     for (uint next = 0; next &lt; worklist.size(); ++next) {
4866       Node *n  = worklist.at(next);
4867       const Type* t = igvn.type_or_null(n);
4868       assert((t == NULL) || (t == t-&gt;remove_speculative()), &quot;no more speculative types&quot;);
4869       if (n-&gt;is_Type()) {
4870         t = n-&gt;as_Type()-&gt;type();
4871         assert(t == t-&gt;remove_speculative(), &quot;no more speculative types&quot;);
4872       }
4873       uint max = n-&gt;len();
4874       for( uint i = 0; i &lt; max; ++i ) {
4875         Node *m = n-&gt;in(i);
4876         if (not_a_node(m))  continue;
4877         worklist.push(m);
4878       }
4879     }
4880     igvn.check_no_speculative_types();
4881 #endif
4882   }
4883 }
4884 
4885 Node* Compile::optimize_acmp(PhaseGVN* phase, Node* a, Node* b) {
4886   const TypeInstPtr* ta = phase-&gt;type(a)-&gt;isa_instptr();
4887   const TypeInstPtr* tb = phase-&gt;type(b)-&gt;isa_instptr();
4888   if (!EnableValhalla || ta == NULL || tb == NULL ||
4889       ta-&gt;is_zero_type() || tb-&gt;is_zero_type() ||
4890       !ta-&gt;can_be_value_type() || !tb-&gt;can_be_value_type()) {
4891     // Use old acmp if one operand is null or not a value type
4892     return new CmpPNode(a, b);
4893   } else if (ta-&gt;is_valuetypeptr() || tb-&gt;is_valuetypeptr()) {
4894     // We know that one operand is a value type. Therefore,
4895     // new acmp will only return true if both operands are NULL.
4896     // Check if both operands are null by or&#39;ing the oops.
4897     a = phase-&gt;transform(new CastP2XNode(NULL, a));
4898     b = phase-&gt;transform(new CastP2XNode(NULL, b));
4899     a = phase-&gt;transform(new OrXNode(a, b));
4900     return new CmpXNode(a, phase-&gt;MakeConX(0));
4901   }
4902   // Use new acmp
4903   return NULL;
4904 }
4905 
4906 // Auxiliary method to support randomized stressing/fuzzing.
4907 //
4908 // This method can be called the arbitrary number of times, with current count
4909 // as the argument. The logic allows selecting a single candidate from the
4910 // running list of candidates as follows:
4911 //    int count = 0;
4912 //    Cand* selected = null;
4913 //    while(cand = cand-&gt;next()) {
4914 //      if (randomized_select(++count)) {
4915 //        selected = cand;
4916 //      }
4917 //    }
4918 //
4919 // Including count equalizes the chances any candidate is &quot;selected&quot;.
4920 // This is useful when we don&#39;t have the complete list of candidates to choose
4921 // from uniformly. In this case, we need to adjust the randomicity of the
4922 // selection, or else we will end up biasing the selection towards the latter
4923 // candidates.
4924 //
4925 // Quick back-envelope calculation shows that for the list of n candidates
4926 // the equal probability for the candidate to persist as &quot;best&quot; can be
4927 // achieved by replacing it with &quot;next&quot; k-th candidate with the probability
4928 // of 1/k. It can be easily shown that by the end of the run, the
4929 // probability for any candidate is converged to 1/n, thus giving the
4930 // uniform distribution among all the candidates.
4931 //
4932 // We don&#39;t care about the domain size as long as (RANDOMIZED_DOMAIN / count) is large.
4933 #define RANDOMIZED_DOMAIN_POW 29
4934 #define RANDOMIZED_DOMAIN (1 &lt;&lt; RANDOMIZED_DOMAIN_POW)
4935 #define RANDOMIZED_DOMAIN_MASK ((1 &lt;&lt; (RANDOMIZED_DOMAIN_POW + 1)) - 1)
4936 bool Compile::randomized_select(int count) {
4937   assert(count &gt; 0, &quot;only positive&quot;);
4938   return (os::random() &amp; RANDOMIZED_DOMAIN_MASK) &lt; (RANDOMIZED_DOMAIN / count);
4939 }
4940 
4941 CloneMap&amp;     Compile::clone_map()                 { return _clone_map; }
4942 void          Compile::set_clone_map(Dict* d)      { _clone_map._dict = d; }
4943 
4944 void NodeCloneInfo::dump() const {
4945   tty-&gt;print(&quot; {%d:%d} &quot;, idx(), gen());
4946 }
4947 
4948 void CloneMap::clone(Node* old, Node* nnn, int gen) {
4949   uint64_t val = value(old-&gt;_idx);
4950   NodeCloneInfo cio(val);
4951   assert(val != 0, &quot;old node should be in the map&quot;);
4952   NodeCloneInfo cin(cio.idx(), gen + cio.gen());
4953   insert(nnn-&gt;_idx, cin.get());
4954 #ifndef PRODUCT
4955   if (is_debug()) {
4956     tty-&gt;print_cr(&quot;CloneMap::clone inserted node %d info {%d:%d} into CloneMap&quot;, nnn-&gt;_idx, cin.idx(), cin.gen());
4957   }
4958 #endif
4959 }
4960 
4961 void CloneMap::verify_insert_and_clone(Node* old, Node* nnn, int gen) {
4962   NodeCloneInfo cio(value(old-&gt;_idx));
4963   if (cio.get() == 0) {
4964     cio.set(old-&gt;_idx, 0);
4965     insert(old-&gt;_idx, cio.get());
4966 #ifndef PRODUCT
4967     if (is_debug()) {
4968       tty-&gt;print_cr(&quot;CloneMap::verify_insert_and_clone inserted node %d info {%d:%d} into CloneMap&quot;, old-&gt;_idx, cio.idx(), cio.gen());
4969     }
4970 #endif
4971   }
4972   clone(old, nnn, gen);
4973 }
4974 
4975 int CloneMap::max_gen() const {
4976   int g = 0;
4977   DictI di(_dict);
4978   for(; di.test(); ++di) {
4979     int t = gen(di._key);
4980     if (g &lt; t) {
4981       g = t;
4982 #ifndef PRODUCT
4983       if (is_debug()) {
4984         tty-&gt;print_cr(&quot;CloneMap::max_gen() update max=%d from %d&quot;, g, _2_node_idx_t(di._key));
4985       }
4986 #endif
4987     }
4988   }
4989   return g;
4990 }
4991 
4992 void CloneMap::dump(node_idx_t key) const {
4993   uint64_t val = value(key);
4994   if (val != 0) {
4995     NodeCloneInfo ni(val);
4996     ni.dump();
4997   }
4998 }
4999 
5000 // Move Allocate nodes to the start of the list
5001 void Compile::sort_macro_nodes() {
5002   int count = macro_count();
5003   int allocates = 0;
5004   for (int i = 0; i &lt; count; i++) {
5005     Node* n = macro_node(i);
5006     if (n-&gt;is_Allocate()) {
5007       if (i != allocates) {
5008         Node* tmp = macro_node(allocates);
5009         _macro_nodes-&gt;at_put(allocates, n);
5010         _macro_nodes-&gt;at_put(i, tmp);
5011       }
5012       allocates++;
5013     }
5014   }
5015 }
5016 
5017 void Compile::print_method(CompilerPhaseType cpt, int level, int idx) {
5018   EventCompilerPhase event;
5019   if (event.should_commit()) {
5020     CompilerEvent::PhaseEvent::post(event, C-&gt;_latest_stage_start_counter, cpt, C-&gt;_compile_id, level);
5021   }
5022 
5023 #ifndef PRODUCT
5024   if (should_print(level)) {
5025     char output[1024];
5026     if (idx != 0) {
5027       jio_snprintf(output, sizeof(output), &quot;%s:%d&quot;, CompilerPhaseTypeHelper::to_string(cpt), idx);
5028     } else {
5029       jio_snprintf(output, sizeof(output), &quot;%s&quot;, CompilerPhaseTypeHelper::to_string(cpt));
5030     }
5031     _printer-&gt;print_method(output, level);
5032   }
5033 #endif
5034   C-&gt;_latest_stage_start_counter.stamp();
5035 }
5036 
5037 void Compile::end_method(int level) {
5038   EventCompilerPhase event;
5039   if (event.should_commit()) {
5040     CompilerEvent::PhaseEvent::post(event, C-&gt;_latest_stage_start_counter, PHASE_END, C-&gt;_compile_id, level);
5041   }
5042 
5043 #ifndef PRODUCT
<a name="5" id="anc5"></a><span class="line-modified">5044   if (_printer &amp;&amp; _printer-&gt;should_print(level)) {</span>
5045     _printer-&gt;end_method();
5046   }
5047 #endif
5048 }
5049 
5050 
5051 #ifndef PRODUCT
5052 IdealGraphPrinter* Compile::_debug_file_printer = NULL;
5053 IdealGraphPrinter* Compile::_debug_network_printer = NULL;
5054 
5055 // Called from debugger. Prints method to the default file with the default phase name.
5056 // This works regardless of any Ideal Graph Visualizer flags set or not.
5057 void igv_print() {
5058   Compile::current()-&gt;igv_print_method_to_file();
5059 }
5060 
5061 // Same as igv_print() above but with a specified phase name.
5062 void igv_print(const char* phase_name) {
5063   Compile::current()-&gt;igv_print_method_to_file(phase_name);
5064 }
5065 
5066 // Called from debugger. Prints method with the default phase name to the default network or the one specified with
5067 // the network flags for the Ideal Graph Visualizer, or to the default file depending on the &#39;network&#39; argument.
5068 // This works regardless of any Ideal Graph Visualizer flags set or not.
5069 void igv_print(bool network) {
5070   if (network) {
5071     Compile::current()-&gt;igv_print_method_to_network();
5072   } else {
5073     Compile::current()-&gt;igv_print_method_to_file();
5074   }
5075 }
5076 
5077 // Same as igv_print(bool network) above but with a specified phase name.
5078 void igv_print(bool network, const char* phase_name) {
5079   if (network) {
5080     Compile::current()-&gt;igv_print_method_to_network(phase_name);
5081   } else {
5082     Compile::current()-&gt;igv_print_method_to_file(phase_name);
5083   }
5084 }
5085 
5086 // Called from debugger. Normal write to the default _printer. Only works if Ideal Graph Visualizer printing flags are set.
5087 void igv_print_default() {
5088   Compile::current()-&gt;print_method(PHASE_DEBUG, 0, 0);
5089 }
5090 
5091 // Called from debugger, especially when replaying a trace in which the program state cannot be altered like with rr replay.
5092 // A method is appended to an existing default file with the default phase name. This means that igv_append() must follow
5093 // an earlier igv_print(*) call which sets up the file. This works regardless of any Ideal Graph Visualizer flags set or not.
5094 void igv_append() {
5095   Compile::current()-&gt;igv_print_method_to_file(&quot;Debug&quot;, true);
5096 }
5097 
5098 // Same as igv_append() above but with a specified phase name.
5099 void igv_append(const char* phase_name) {
5100   Compile::current()-&gt;igv_print_method_to_file(phase_name, true);
5101 }
5102 
5103 void Compile::igv_print_method_to_file(const char* phase_name, bool append) {
5104   const char* file_name = &quot;custom_debug.xml&quot;;
5105   if (_debug_file_printer == NULL) {
5106     _debug_file_printer = new IdealGraphPrinter(C, file_name, append);
5107   } else {
5108     _debug_file_printer-&gt;update_compiled_method(C-&gt;method());
5109   }
5110   tty-&gt;print_cr(&quot;Method %s to %s&quot;, append ? &quot;appended&quot; : &quot;printed&quot;, file_name);
5111   _debug_file_printer-&gt;print_method(phase_name, 0);
5112 }
5113 
5114 void Compile::igv_print_method_to_network(const char* phase_name) {
5115   if (_debug_network_printer == NULL) {
5116     _debug_network_printer = new IdealGraphPrinter(C);
5117   } else {
5118     _debug_network_printer-&gt;update_compiled_method(C-&gt;method());
5119   }
5120   tty-&gt;print_cr(&quot;Method printed over network stream to IGV&quot;);
5121   _debug_network_printer-&gt;print_method(phase_name, 0);
5122 }
5123 #endif
5124 
<a name="6" id="anc6"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="6" type="hidden" />
</body>
</html>