<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff src/java.desktop/windows/native/libawt/windows/awt_PrintJob.cpp</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
  </head>
<body>
<center><a href="awt_Cursor.cpp.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="awt_TrayIcon.cpp.udiff.html" target="_top">next &gt;</a></center>    <h2>src/java.desktop/windows/native/libawt/windows/awt_PrintJob.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -1737,15 +1737,22 @@</span>
  //     HGDIOBJ oldBrush =
  //      ::SelectObject(hDC, AwtBrush::Get(RGB(0xff, 0xff, 0xff))-&gt;GetHandle());
  //     ::PatBlt(hDC, destX+1, destY+1, destWidth-2, destHeight-2, PATCOPY);
  //     ::SelectObject(hDC, oldBrush);
  
<span class="udiff-line-added">+     /* This code is rarely used now. It used to be invoked by Java plugin browser</span>
<span class="udiff-line-added">+      * printing. Today embedded frames are used only when a toolkit such as SWT</span>
<span class="udiff-line-added">+      * needs to embed</span>
<span class="udiff-line-added">+      */</span>
      TRY;
      jbyte *image = NULL;
      try {
<span class="udiff-line-modified-removed">-         image = (jbyte *)env-&gt;GetPrimitiveArrayCritical(imageArray, 0);</span>
<span class="udiff-line-modified-added">+         int length = env-&gt;GetArrayLength(imageArray);</span>
<span class="udiff-line-added">+         image = new jbyte[length];</span>
          CHECK_NULL(image);
<span class="udiff-line-added">+         env-&gt;GetByteArrayRegion(imageArray, 0, length, image);</span>
<span class="udiff-line-added">+ </span>
          struct {
              BITMAPINFOHEADER bmiHeader;
              DWORD*                 bmiColors;
          } bitMapHeader;
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1775,17 +1782,15 @@</span>
       FILE *file = fopen(&quot;c:\\plog.txt&quot;, &quot;a&quot;);
       fprintf(file,&quot;sh=%d dh=%d sy=%d dy=%d result=%d\n&quot;, srcHeight, destHeight, srcY, destY, result);
       fclose(file);
  #endif //DEBUG_PRINTING
      } catch (...) {
<span class="udiff-line-modified-removed">-         if (image != NULL) {</span>
<span class="udiff-line-removed">-             env-&gt;ReleasePrimitiveArrayCritical(imageArray, image, 0);</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-modified-added">+         delete[] image;</span>
          throw;
      }
  
<span class="udiff-line-modified-removed">-     env-&gt;ReleasePrimitiveArrayCritical(imageArray, image, 0);</span>
<span class="udiff-line-modified-added">+     delete[] image;</span>
  
      CATCH_BAD_ALLOC;
  }
  
  /*
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -2801,104 +2806,10 @@</span>
          return alignedImage;
      }
      return NULL;
  }
  
<span class="udiff-line-removed">- #if 0</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">- /*</span>
<span class="udiff-line-removed">-  * Class:     sun_awt_windows_WPrinterJob</span>
<span class="udiff-line-removed">-  * Method:    drawImageIntRGB</span>
<span class="udiff-line-removed">-  * Signature: (J[IFFFFFFFFII)V</span>
<span class="udiff-line-removed">-  */</span>
<span class="udiff-line-removed">- JNIEXPORT void JNICALL Java_sun_awt_windows_WPrinterJob_drawImageIntRGB</span>
<span class="udiff-line-removed">-   (JNIEnv *env, jobject self,</span>
<span class="udiff-line-removed">-    jlong printDC, jintArray image,</span>
<span class="udiff-line-removed">-    jfloat destX, jfloat destY,</span>
<span class="udiff-line-removed">-    jfloat destWidth, jfloat destHeight,</span>
<span class="udiff-line-removed">-    jfloat srcX, jfloat srcY,</span>
<span class="udiff-line-removed">-    jfloat srcWidth, jfloat srcHeight,</span>
<span class="udiff-line-removed">-    jint srcBitMapWidth, jint srcBitMapHeight) {</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     int result = 0;</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     assert(printDC != NULL);</span>
<span class="udiff-line-removed">-     assert(image != NULL);</span>
<span class="udiff-line-removed">-     assert(srcX &gt;= 0);</span>
<span class="udiff-line-removed">-     assert(srcY &gt;= 0);</span>
<span class="udiff-line-removed">-     assert(srcWidth &gt; 0);</span>
<span class="udiff-line-removed">-     assert(srcHeight &gt; 0);</span>
<span class="udiff-line-removed">-     assert(srcBitMapWidth &gt; 0);</span>
<span class="udiff-line-removed">-     assert(srcBitMapHeight &gt; 0);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     static int alphaMask =  0xff000000;</span>
<span class="udiff-line-removed">-     static int redMask =    0x00ff0000;</span>
<span class="udiff-line-removed">-     static int greenMask =  0x0000ff00;</span>
<span class="udiff-line-removed">-     static int blueMask =   0x000000ff;</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     struct {</span>
<span class="udiff-line-removed">-         BITMAPV4HEADER header;</span>
<span class="udiff-line-removed">-         DWORD          masks[256];</span>
<span class="udiff-line-removed">-     } dib;</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     memset(&amp;dib,0,sizeof(dib));</span>
<span class="udiff-line-removed">-     dib.header.bV4Size = sizeof(dib.header);</span>
<span class="udiff-line-removed">-     dib.header.bV4Width = srcBitMapWidth;</span>
<span class="udiff-line-removed">-     dib.header.bV4Height = -srcBitMapHeight;    // Top down DIB</span>
<span class="udiff-line-removed">-     dib.header.bV4Planes = 1;</span>
<span class="udiff-line-removed">-     dib.header.bV4BitCount = 32;</span>
<span class="udiff-line-removed">-     dib.header.bV4V4Compression = BI_BITFIELDS;</span>
<span class="udiff-line-removed">-     dib.header.bV4SizeImage = 0;        // It&#39;s the default size.</span>
<span class="udiff-line-removed">-     dib.header.bV4XPelsPerMeter = 0;</span>
<span class="udiff-line-removed">-     dib.header.bV4YPelsPerMeter = 0;</span>
<span class="udiff-line-removed">-     dib.header.bV4ClrUsed = 0;</span>
<span class="udiff-line-removed">-     dib.header.bV4ClrImportant = 0;</span>
<span class="udiff-line-removed">-     dib.header.bV4RedMask = redMask;</span>
<span class="udiff-line-removed">-     dib.header.bV4GreenMask = greenMask;</span>
<span class="udiff-line-removed">-     dib.header.bV4BlueMask = blueMask;</span>
<span class="udiff-line-removed">-     dib.header.bV4AlphaMask = alphaMask;</span>
<span class="udiff-line-removed">-     dib.masks[0] = redMask;</span>
<span class="udiff-line-removed">-     dib.masks[1] = greenMask;</span>
<span class="udiff-line-removed">-     dib.masks[2] = blueMask;</span>
<span class="udiff-line-removed">-     dib.masks[3] = alphaMask;</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     jint *imageBits = NULL;</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     try {</span>
<span class="udiff-line-removed">-         imageBits = (jint *)env-&gt;GetPrimitiveArrayCritical(image, 0);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-         if (printDC){</span>
<span class="udiff-line-removed">-             result = ::StretchDIBits( (HDC)printDC,</span>
<span class="udiff-line-removed">-                                       ROUND_TO_LONG(destX),</span>
<span class="udiff-line-removed">-                                       ROUND_TO_LONG(destY),</span>
<span class="udiff-line-removed">-                                       ROUND_TO_LONG(destWidth),</span>
<span class="udiff-line-removed">-                                       ROUND_TO_LONG(destHeight),</span>
<span class="udiff-line-removed">-                                       ROUND_TO_LONG(srcX),</span>
<span class="udiff-line-removed">-                                       ROUND_TO_LONG(srcY),</span>
<span class="udiff-line-removed">-                                       ROUND_TO_LONG(srcWidth),</span>
<span class="udiff-line-removed">-                                       ROUND_TO_LONG(srcHeight),</span>
<span class="udiff-line-removed">-                                       imageBits,</span>
<span class="udiff-line-removed">-                                       (BITMAPINFO *)&amp;dib,</span>
<span class="udiff-line-removed">-                                       DIB_RGB_COLORS,</span>
<span class="udiff-line-removed">-                                       SRCCOPY);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">-     } catch (...) {</span>
<span class="udiff-line-removed">-         if (imageBits != NULL) {</span>
<span class="udiff-line-removed">-             env-&gt;ReleasePrimitiveArrayCritical(image, imageBits, 0);</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">-         throw;</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     env-&gt;ReleasePrimitiveArrayCritical(image, imageBits, 0);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">- }</span>
<span class="udiff-line-removed">- #else</span>
<span class="udiff-line-removed">- </span>
  /*
   * Class:     sun_awt_windows_WPrinterJob
   * Method:    drawDIBImage
   * Signature: (J[BFFFFFFFFI[B)V
   */
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -2989,11 +2900,10 @@</span>
          return;
      }
      env-&gt;ReleasePrimitiveArrayCritical(image, imageBits, 0);
  
  }
<span class="udiff-line-removed">- #endif</span>
  
  /*
   * An utility function to print passed image byte array to
   * the printDC.
   * browserPrinting flag controls whether the image array
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -3057,11 +2967,11 @@</span>
      env-&gt;ReleasePrimitiveArrayCritical(imageArray, image, 0);
  
      CATCH_BAD_ALLOC;
  
  }
<span class="udiff-line-modified-removed">- static FILE* outfile = NULL;</span>
<span class="udiff-line-modified-added">+ </span>
  static int bitsToDevice(HDC printDC, jbyte *image, long destX, long destY,
                          long width, long height) {
      int result = 0;
  
      assert(printDC != NULL);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -3070,10 +2980,13 @@</span>
      assert(destY &gt;= 0);
      assert(width &gt; 0);
      /* height could be negative to indicate that this is a top-down DIB */
  //      assert(height &gt; 0);
  
<span class="udiff-line-added">+     if (!printDC || height == 0) {</span>
<span class="udiff-line-added">+         return result;</span>
<span class="udiff-line-added">+     }</span>
      struct {
          BITMAPINFOHEADER bmiHeader;
          DWORD*             bmiColors;
      } bitMapHeader;
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -3097,15 +3010,13 @@</span>
      // Because we don&#39;t know if they support or not,
      // always send bottom-up DIBs
      if (bitMapHeader.bmiHeader.biHeight &lt; 0) {
        jbyte *dibImage = reverseDIB(image, width, height, 24);
        if (dibImage != NULL) {
<span class="udiff-line-modified-removed">-         bitMapHeader.bmiHeader.biWidth = ROUND_TO_LONG(width);</span>
<span class="udiff-line-modified-removed">-         bitMapHeader.bmiHeader.biHeight = ROUND_TO_LONG(height);</span>
<span class="udiff-line-modified-removed">- </span>
<span class="udiff-line-removed">-         if (printDC){</span>
<span class="udiff-line-removed">-           result = ::SetDIBitsToDevice(printDC,</span>
<span class="udiff-line-modified-added">+             bitMapHeader.bmiHeader.biWidth = ROUND_TO_LONG(width);</span>
<span class="udiff-line-modified-added">+             bitMapHeader.bmiHeader.biHeight = ROUND_TO_LONG(height);</span>
<span class="udiff-line-modified-added">+             result = ::SetDIBitsToDevice(printDC,</span>
                                  ROUND_TO_LONG(destX),   // left of dest rect
                                  ROUND_TO_LONG(destY),   // top of dest rect
                                  ROUND_TO_LONG(width),   // width of dest rect
                                  ROUND_TO_LONG(height),  // height of dest rect
                                  0,      // left of source rect
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -3113,16 +3024,13 @@</span>
                                  0,      // line number of 1st source scan line
                                  ROUND_TO_LONG(height),  // number of scan lines
                                  dibImage,       // points to the DIB
                                  (BITMAPINFO *)&amp;bitMapHeader,
                                  DIB_RGB_COLORS);
<span class="udiff-line-modified-removed">-         }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-         free (dibImage);</span>
<span class="udiff-line-modified-added">+             free (dibImage);</span>
        }
      } else {
<span class="udiff-line-removed">-       if (printDC){</span>
            result = ::SetDIBitsToDevice(printDC,
                                  destX,  // left of dest rect
                                  destY,  // top of dest rect
                                  width,  // width of dest rect
                                  height, // height of dest rect
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -3131,13 +3039,34 @@</span>
                                  0,      // line number of 1st source scan line
                                  height, // number of source scan lines
                                  image,  // points to the DIB
                                  (BITMAPINFO *)&amp;bitMapHeader,
                                  DIB_RGB_COLORS);
<span class="udiff-line-modified-removed">-       }</span>
<span class="udiff-line-modified-added">+          if (result == 0) {</span>
<span class="udiff-line-added">+              size_t size = width * height * 3; // Always 24bpp, also DWORD aligned.</span>
<span class="udiff-line-added">+              void *imageData = NULL;</span>
<span class="udiff-line-added">+              try {</span>
<span class="udiff-line-added">+                   imageData = safe_Malloc(size);</span>
<span class="udiff-line-added">+               } catch (std::bad_alloc&amp;) {</span>
<span class="udiff-line-added">+                   return result;</span>
<span class="udiff-line-added">+               }</span>
<span class="udiff-line-added">+               memcpy(imageData, image, size);</span>
<span class="udiff-line-added">+               result = ::SetDIBitsToDevice(printDC,</span>
<span class="udiff-line-added">+                                     destX,  // left of dest rect</span>
<span class="udiff-line-added">+                                     destY,  // top of dest rect</span>
<span class="udiff-line-added">+                                     width,  // width of dest rect</span>
<span class="udiff-line-added">+                                     height, // height of dest rect</span>
<span class="udiff-line-added">+                                     0,      // left of source rect</span>
<span class="udiff-line-added">+                                     0,      // top of source rect</span>
<span class="udiff-line-added">+                                     0,      // line number of 1st source scan line</span>
<span class="udiff-line-added">+                                     height, // number of source scan lines</span>
<span class="udiff-line-added">+                                     imageData,  // points to the DIB</span>
<span class="udiff-line-added">+                                     (BITMAPINFO *)&amp;bitMapHeader,</span>
<span class="udiff-line-added">+                                     DIB_RGB_COLORS);</span>
<span class="udiff-line-added">+               free(imageData);</span>
<span class="udiff-line-added">+          }</span>
      }
<span class="udiff-line-removed">- </span>
      return result;
  }
  
  LRESULT CALLBACK PageDialogWndProc(HWND hWnd, UINT message,
                                     WPARAM wParam, LPARAM lParam)
</pre>
<center><a href="awt_Cursor.cpp.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="awt_TrayIcon.cpp.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>