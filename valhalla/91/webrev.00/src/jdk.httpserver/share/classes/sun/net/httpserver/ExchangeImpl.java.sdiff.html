<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/jdk.httpserver/share/classes/sun/net/httpserver/ExchangeImpl.java</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
  </head>
<body>
<center><a href="../../../../../../jdk.compiler/share/classes/com/sun/tools/javac/comp/TypeEnter.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="../../../../../../jdk.incubator.jpackage/share/classes/jdk/incubator/jpackage/internal/StandardBundlerParam.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/jdk.httpserver/share/classes/sun/net/httpserver/ExchangeImpl.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2005, 2019, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.  Oracle designates this
  8  * particular file as subject to the &quot;Classpath&quot; exception as provided
  9  * by Oracle in the LICENSE file that accompanied this code.
 10  *
 11  * This code is distributed in the hope that it will be useful, but WITHOUT
 12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 14  * version 2 for more details (a copy is included in the LICENSE file that
 15  * accompanied this code).
 16  *
 17  * You should have received a copy of the GNU General Public License version
 18  * 2 along with this work; if not, write to the Free Software Foundation,
 19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 20  *
 21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 22  * or visit www.oracle.com if you need additional information or have any
 23  * questions.
 24  */
 25 
 26 package sun.net.httpserver;
 27 
 28 import java.io.*;
 29 import java.net.*;
 30 import javax.net.ssl.*;
 31 import java.util.*;
 32 import java.lang.System.Logger;
 33 import java.lang.System.Logger.Level;
 34 import java.text.*;



 35 import java.util.stream.Stream;
 36 import com.sun.net.httpserver.*;
 37 
 38 class ExchangeImpl {
 39 
 40     Headers reqHdrs, rspHdrs;
 41     Request req;
 42     String method;
 43     boolean writefinished;
 44     URI uri;
 45     HttpConnection connection;
 46     long reqContentLen;
 47     long rspContentLen;
 48     /* raw streams which access the socket directly */
 49     InputStream ris;
 50     OutputStream ros;
 51     Thread thread;
 52     /* close the underlying connection when this exchange finished */
 53     boolean close;
 54     boolean closed;
 55     boolean http10 = false;
 56 
 57     /* for formatting the Date: header */
<span class="line-modified"> 58     private static final String pattern = &quot;EEE, dd MMM yyyy HH:mm:ss zzz&quot;;</span>
<span class="line-modified"> 59     private static final TimeZone gmtTZ = TimeZone.getTimeZone(&quot;GMT&quot;);</span>
<span class="line-modified"> 60     private static final ThreadLocal&lt;DateFormat&gt; dateFormat =</span>
<span class="line-modified"> 61          new ThreadLocal&lt;DateFormat&gt;() {</span>
<span class="line-modified"> 62              @Override protected DateFormat initialValue() {</span>
<span class="line-modified"> 63                  DateFormat df = new SimpleDateFormat(pattern, Locale.US);</span>
<span class="line-removed"> 64                  df.setTimeZone(gmtTZ);</span>
<span class="line-removed"> 65                  return df;</span>
<span class="line-removed"> 66          }</span>
<span class="line-removed"> 67      };</span>
 68 
 69     private static final String HEAD = &quot;HEAD&quot;;
 70 
 71     /* streams which take care of the HTTP protocol framing
 72      * and are passed up to higher layers
 73      */
 74     InputStream uis;
 75     OutputStream uos;
 76     LeftOverInputStream uis_orig; // uis may have be a user supplied wrapper
 77     PlaceholderOutputStream uos_orig;
 78 
 79     boolean sentHeaders; /* true after response headers sent */
 80     Map&lt;String,Object&gt; attributes;
 81     int rcode = -1;
 82     HttpPrincipal principal;
 83     ServerImpl server;
 84 
 85     ExchangeImpl (
 86         String m, URI u, Request req, long len, HttpConnection connection
 87     ) throws IOException {
</pre>
<hr />
<pre>
195      * The &quot;real&quot; ouputstream is then placed inside this
196      */
197     PlaceholderOutputStream getPlaceholderResponseBody () {
198         getResponseBody();
199         return uos_orig;
200     }
201 
202     public void sendResponseHeaders (int rCode, long contentLen)
203     throws IOException
204     {
205         if (sentHeaders) {
206             throw new IOException (&quot;headers already sent&quot;);
207         }
208         this.rcode = rCode;
209         String statusLine = &quot;HTTP/1.1 &quot;+rCode+Code.msg(rCode)+&quot;\r\n&quot;;
210         OutputStream tmpout = new BufferedOutputStream (ros);
211         PlaceholderOutputStream o = getPlaceholderResponseBody();
212         tmpout.write (bytes(statusLine, 0), 0, statusLine.length());
213         boolean noContentToSend = false; // assume there is content
214         boolean noContentLengthHeader = false; // must not send Content-length is set
<span class="line-modified">215         rspHdrs.set (&quot;Date&quot;, dateFormat.get().format (new Date()));</span>
216 
217         /* check for response type that is not allowed to send a body */
218 
219         if ((rCode&gt;=100 &amp;&amp; rCode &lt;200) /* informational */
220             ||(rCode == 204)           /* no content */
221             ||(rCode == 304))          /* not modified */
222         {
223             if (contentLen != -1) {
224                 Logger logger = server.getLogger();
225                 String msg = &quot;sendResponseHeaders: rCode = &quot;+ rCode
226                     + &quot;: forcing contentLen = -1&quot;;
227                 logger.log (Level.WARNING, msg);
228             }
229             contentLen = -1;
230             noContentLengthHeader = (rCode != 304);
231         }
232 
233         if (isHeadRequest() || rCode == 304) {
234             /* HEAD requests or 304 responses should not set a content length by passing it
235              * through this API, but should instead manually set the required
</pre>
</td>
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2005, 2020, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.  Oracle designates this
  8  * particular file as subject to the &quot;Classpath&quot; exception as provided
  9  * by Oracle in the LICENSE file that accompanied this code.
 10  *
 11  * This code is distributed in the hope that it will be useful, but WITHOUT
 12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 14  * version 2 for more details (a copy is included in the LICENSE file that
 15  * accompanied this code).
 16  *
 17  * You should have received a copy of the GNU General Public License version
 18  * 2 along with this work; if not, write to the Free Software Foundation,
 19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 20  *
 21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 22  * or visit www.oracle.com if you need additional information or have any
 23  * questions.
 24  */
 25 
 26 package sun.net.httpserver;
 27 
 28 import java.io.*;
 29 import java.net.*;
 30 import javax.net.ssl.*;
 31 import java.util.*;
 32 import java.lang.System.Logger;
 33 import java.lang.System.Logger.Level;
 34 import java.text.*;
<span class="line-added"> 35 import java.time.Instant;</span>
<span class="line-added"> 36 import java.time.ZoneId;</span>
<span class="line-added"> 37 import java.time.format.DateTimeFormatter;</span>
 38 import java.util.stream.Stream;
 39 import com.sun.net.httpserver.*;
 40 
 41 class ExchangeImpl {
 42 
 43     Headers reqHdrs, rspHdrs;
 44     Request req;
 45     String method;
 46     boolean writefinished;
 47     URI uri;
 48     HttpConnection connection;
 49     long reqContentLen;
 50     long rspContentLen;
 51     /* raw streams which access the socket directly */
 52     InputStream ris;
 53     OutputStream ros;
 54     Thread thread;
 55     /* close the underlying connection when this exchange finished */
 56     boolean close;
 57     boolean closed;
 58     boolean http10 = false;
 59 
 60     /* for formatting the Date: header */
<span class="line-modified"> 61     private static final DateTimeFormatter FORMATTER;</span>
<span class="line-modified"> 62     static {</span>
<span class="line-modified"> 63         String pattern = &quot;EEE, dd MMM yyyy HH:mm:ss zzz&quot;;</span>
<span class="line-modified"> 64         FORMATTER = DateTimeFormatter.ofPattern(pattern, Locale.US)</span>
<span class="line-modified"> 65                                      .withZone(ZoneId.of(&quot;GMT&quot;));</span>
<span class="line-modified"> 66     }</span>




 67 
 68     private static final String HEAD = &quot;HEAD&quot;;
 69 
 70     /* streams which take care of the HTTP protocol framing
 71      * and are passed up to higher layers
 72      */
 73     InputStream uis;
 74     OutputStream uos;
 75     LeftOverInputStream uis_orig; // uis may have be a user supplied wrapper
 76     PlaceholderOutputStream uos_orig;
 77 
 78     boolean sentHeaders; /* true after response headers sent */
 79     Map&lt;String,Object&gt; attributes;
 80     int rcode = -1;
 81     HttpPrincipal principal;
 82     ServerImpl server;
 83 
 84     ExchangeImpl (
 85         String m, URI u, Request req, long len, HttpConnection connection
 86     ) throws IOException {
</pre>
<hr />
<pre>
194      * The &quot;real&quot; ouputstream is then placed inside this
195      */
196     PlaceholderOutputStream getPlaceholderResponseBody () {
197         getResponseBody();
198         return uos_orig;
199     }
200 
201     public void sendResponseHeaders (int rCode, long contentLen)
202     throws IOException
203     {
204         if (sentHeaders) {
205             throw new IOException (&quot;headers already sent&quot;);
206         }
207         this.rcode = rCode;
208         String statusLine = &quot;HTTP/1.1 &quot;+rCode+Code.msg(rCode)+&quot;\r\n&quot;;
209         OutputStream tmpout = new BufferedOutputStream (ros);
210         PlaceholderOutputStream o = getPlaceholderResponseBody();
211         tmpout.write (bytes(statusLine, 0), 0, statusLine.length());
212         boolean noContentToSend = false; // assume there is content
213         boolean noContentLengthHeader = false; // must not send Content-length is set
<span class="line-modified">214         rspHdrs.set(&quot;Date&quot;, FORMATTER.format(Instant.now()));</span>
215 
216         /* check for response type that is not allowed to send a body */
217 
218         if ((rCode&gt;=100 &amp;&amp; rCode &lt;200) /* informational */
219             ||(rCode == 204)           /* no content */
220             ||(rCode == 304))          /* not modified */
221         {
222             if (contentLen != -1) {
223                 Logger logger = server.getLogger();
224                 String msg = &quot;sendResponseHeaders: rCode = &quot;+ rCode
225                     + &quot;: forcing contentLen = -1&quot;;
226                 logger.log (Level.WARNING, msg);
227             }
228             contentLen = -1;
229             noContentLengthHeader = (rCode != 304);
230         }
231 
232         if (isHeadRequest() || rCode == 304) {
233             /* HEAD requests or 304 responses should not set a content length by passing it
234              * through this API, but should instead manually set the required
</pre>
</td>
</tr>
</table>
<center><a href="../../../../../../jdk.compiler/share/classes/com/sun/tools/javac/comp/TypeEnter.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="../../../../../../jdk.incubator.jpackage/share/classes/jdk/incubator/jpackage/internal/StandardBundlerParam.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>