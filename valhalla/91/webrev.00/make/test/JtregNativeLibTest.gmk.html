<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>New make/test/JtregNativeLibTest.gmk</title>
    <link rel="stylesheet" href="../../style.css" />
  </head>
  <body>
    <pre>
 1 #
 2 # Copyright (c) 2020, Oracle and/or its affiliates. All rights reserved.
 3 # DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 4 #
 5 # This code is free software; you can redistribute it and/or modify it
 6 # under the terms of the GNU General Public License version 2 only, as
 7 # published by the Free Software Foundation.  Oracle designates this
 8 # particular file as subject to the &quot;Classpath&quot; exception as provided
 9 # by Oracle in the LICENSE file that accompanied this code.
10 #
11 # This code is distributed in the hope that it will be useful, but WITHOUT
12 # ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
13 # FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
14 # version 2 for more details (a copy is included in the LICENSE file that
15 # accompanied this code).
16 #
17 # You should have received a copy of the GNU General Public License version
18 # 2 along with this work; if not, write to the Free Software Foundation,
19 # Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
20 #
21 # Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
22 # or visit www.oracle.com if you need additional information or have any
23 # questions.
24 #
25 
26 ################################################################################
27 # This file builds the native component of the JTReg tests for testlibrary.
28 # It also covers the test-image part, where the built files are copied to the
29 # test image.
30 ################################################################################
31 
32 default: all
33 
34 include $(SPEC)
35 include MakeBase.gmk
36 include TestFilesCompilation.gmk
37 
38 $(eval $(call IncludeCustomExtension, test/JtregNativeLibTest.gmk))
39 
40 ################################################################################
41 # Targets for building the native tests themselves.
42 ################################################################################
43 
44 # This might have been added to by a custom extension.
45 BUILD_LIBTEST_JTREG_NATIVE_SRC += $(TOPDIR)/test/lib-test
46 
47 BUILD_LIBTEST_JTREG_OUTPUT_DIR := $(OUTPUTDIR)/support/test/lib-test/jtreg/native
48 
49 BUILD_LIBTEST_JTREG_IMAGE_DIR := $(TEST_IMAGE_DIR)/lib-test/jtreg
50 
51 ifeq ($(call isTargetOs, windows), true)
52     BUILD_LIBTEST_JTREG_EXECUTABLES_LIBS_exejvm-test-launcher := jvm.lib
53 else
54     BUILD_LIBTEST_JTREG_EXECUTABLES_LIBS_exejvm-test-launcher := -ljvm
55 endif
56 
57 # This evaluation is expensive and should only be done if this target was
58 # explicitly called.
59 ifneq ($(filter build-test-libtest-jtreg-native, $(MAKECMDGOALS)), )
60   $(eval $(call SetupTestFilesCompilation, BUILD_LIBTEST_JTREG_LIBRARIES, \
61       TYPE := LIBRARY, \
62       SOURCE_DIRS := $(BUILD_LIBTEST_JTREG_NATIVE_SRC), \
63       OUTPUT_DIR := $(BUILD_LIBTEST_JTREG_OUTPUT_DIR), \
64       EXCLUDE := $(BUILD_LIBTEST_JTREG_EXCLUDE), \
65   ))
66 
67   $(eval $(call SetupTestFilesCompilation, BUILD_LIBTEST_JTREG_EXECUTABLES, \
68       TYPE := PROGRAM, \
69       SOURCE_DIRS := $(BUILD_LIBTEST_JTREG_NATIVE_SRC), \
70       OUTPUT_DIR := $(BUILD_LIBTEST_JTREG_OUTPUT_DIR), \
71       EXCLUDE := $(BUILD_LIBTEST_JTREG_EXCLUDE), \
72   ))
73 endif
74 
75 build-test-libtest-jtreg-native: $(BUILD_LIBTEST_JTREG_LIBRARIES) $(BUILD_LIBTEST_JTREG_EXECUTABLES)
76 
77 ################################################################################
78 # Targets for building test-image.
79 ################################################################################
80 
81 # Copy to lib-test jtreg test image
82 $(eval $(call SetupCopyFiles, COPY_LIBTEST_JTREG_NATIVE, \
83     SRC := $(BUILD_LIBTEST_JTREG_OUTPUT_DIR), \
84     DEST := $(TEST_IMAGE_DIR)/lib-test/jtreg/native, \
85     FILES := $(wildcard $(addprefix $(BUILD_LIBTEST_JTREG_OUTPUT_DIR), /bin/* /lib/*)), \
86     FLATTEN := true, \
87 ))
88 
89 test-image-libtest-jtreg-native: $(COPY_LIBTEST_JTREG_NATIVE)
90 
91 all: build-test-libtest-jtreg-native
92 test-image: test-image-libtest-jtreg-native
93 
94 .PHONY: default all build-test-libtest-jtreg-native test-image-libtest-jtreg-native test-image
    </pre>
  </body>
</html>