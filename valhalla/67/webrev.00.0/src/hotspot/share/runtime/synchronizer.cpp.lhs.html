<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames src/hotspot/share/runtime/synchronizer.cpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
    <script type="text/javascript" src="../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>   1 /*
   2  * Copyright (c) 1998, 2020, Oracle and/or its affiliates. All rights reserved.
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.
   8  *
   9  * This code is distributed in the hope that it will be useful, but WITHOUT
  10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  *
  23  */
  24 
  25 #include &quot;precompiled.hpp&quot;
  26 #include &quot;classfile/vmSymbols.hpp&quot;
  27 #include &quot;logging/log.hpp&quot;
  28 #include &quot;logging/logStream.hpp&quot;
  29 #include &quot;jfr/jfrEvents.hpp&quot;
  30 #include &quot;memory/allocation.inline.hpp&quot;
  31 #include &quot;memory/metaspaceShared.hpp&quot;
  32 #include &quot;memory/padded.hpp&quot;
  33 #include &quot;memory/resourceArea.hpp&quot;
  34 #include &quot;memory/universe.hpp&quot;
  35 #include &quot;oops/markWord.hpp&quot;
  36 #include &quot;oops/oop.inline.hpp&quot;
  37 #include &quot;runtime/atomic.hpp&quot;
  38 #include &quot;runtime/biasedLocking.hpp&quot;
  39 #include &quot;runtime/handles.inline.hpp&quot;
  40 #include &quot;runtime/interfaceSupport.inline.hpp&quot;
  41 #include &quot;runtime/mutexLocker.hpp&quot;
  42 #include &quot;runtime/objectMonitor.hpp&quot;
  43 #include &quot;runtime/objectMonitor.inline.hpp&quot;
  44 #include &quot;runtime/osThread.hpp&quot;
  45 #include &quot;runtime/safepointVerifiers.hpp&quot;
  46 #include &quot;runtime/sharedRuntime.hpp&quot;
  47 #include &quot;runtime/stubRoutines.hpp&quot;
  48 #include &quot;runtime/synchronizer.hpp&quot;
  49 #include &quot;runtime/thread.inline.hpp&quot;
  50 #include &quot;runtime/timer.hpp&quot;
  51 #include &quot;runtime/vframe.hpp&quot;
  52 #include &quot;runtime/vmThread.hpp&quot;
  53 #include &quot;utilities/align.hpp&quot;
  54 #include &quot;utilities/dtrace.hpp&quot;
  55 #include &quot;utilities/events.hpp&quot;
  56 #include &quot;utilities/preserveException.hpp&quot;
  57 
  58 // The &quot;core&quot; versions of monitor enter and exit reside in this file.
  59 // The interpreter and compilers contain specialized transliterated
  60 // variants of the enter-exit fast-path operations.  See i486.ad fast_lock(),
  61 // for instance.  If you make changes here, make sure to modify the
  62 // interpreter, and both C1 and C2 fast-path inline locking code emission.
  63 //
  64 // -----------------------------------------------------------------------------
  65 
  66 #ifdef DTRACE_ENABLED
  67 
  68 // Only bother with this argument setup if dtrace is available
  69 // TODO-FIXME: probes should not fire when caller is _blocked.  assert() accordingly.
  70 
  71 #define DTRACE_MONITOR_PROBE_COMMON(obj, thread)                           \
  72   char* bytes = NULL;                                                      \
  73   int len = 0;                                                             \
  74   jlong jtid = SharedRuntime::get_java_tid(thread);                        \
  75   Symbol* klassname = ((oop)(obj))-&gt;klass()-&gt;name();                       \
  76   if (klassname != NULL) {                                                 \
  77     bytes = (char*)klassname-&gt;bytes();                                     \
  78     len = klassname-&gt;utf8_length();                                        \
  79   }
  80 
  81 #define DTRACE_MONITOR_WAIT_PROBE(monitor, obj, thread, millis)            \
  82   {                                                                        \
  83     if (DTraceMonitorProbes) {                                             \
  84       DTRACE_MONITOR_PROBE_COMMON(obj, thread);                            \
  85       HOTSPOT_MONITOR_WAIT(jtid,                                           \
  86                            (uintptr_t)(monitor), bytes, len, (millis));    \
  87     }                                                                      \
  88   }
  89 
  90 #define HOTSPOT_MONITOR_PROBE_notify HOTSPOT_MONITOR_NOTIFY
  91 #define HOTSPOT_MONITOR_PROBE_notifyAll HOTSPOT_MONITOR_NOTIFYALL
  92 #define HOTSPOT_MONITOR_PROBE_waited HOTSPOT_MONITOR_WAITED
  93 
  94 #define DTRACE_MONITOR_PROBE(probe, monitor, obj, thread)                  \
  95   {                                                                        \
  96     if (DTraceMonitorProbes) {                                             \
  97       DTRACE_MONITOR_PROBE_COMMON(obj, thread);                            \
  98       HOTSPOT_MONITOR_PROBE_##probe(jtid, /* probe = waited */             \
  99                                     (uintptr_t)(monitor), bytes, len);     \
 100     }                                                                      \
 101   }
 102 
 103 #else //  ndef DTRACE_ENABLED
 104 
 105 #define DTRACE_MONITOR_WAIT_PROBE(obj, thread, millis, mon)    {;}
 106 #define DTRACE_MONITOR_PROBE(probe, obj, thread, mon)          {;}
 107 
 108 #endif // ndef DTRACE_ENABLED
 109 
 110 // This exists only as a workaround of dtrace bug 6254741
 111 int dtrace_waited_probe(ObjectMonitor* monitor, Handle obj, Thread* thr) {
 112   DTRACE_MONITOR_PROBE(waited, monitor, obj(), thr);
 113   return 0;
 114 }
 115 
 116 #define NINFLATIONLOCKS 256
 117 static volatile intptr_t gInflationLocks[NINFLATIONLOCKS];
 118 
 119 // global list of blocks of monitors
 120 PaddedObjectMonitor* ObjectSynchronizer::g_block_list = NULL;
 121 
 122 struct ObjectMonitorListGlobals {
 123   char         _pad_prefix[OM_CACHE_LINE_SIZE];
 124   // These are highly shared list related variables.
 125   // To avoid false-sharing they need to be the sole occupants of a cache line.
 126 
 127   // Global ObjectMonitor free list. Newly allocated and deflated
 128   // ObjectMonitors are prepended here.
 129   ObjectMonitor* _free_list;
 130   DEFINE_PAD_MINUS_SIZE(1, OM_CACHE_LINE_SIZE, sizeof(ObjectMonitor*));
 131 
 132   // Global ObjectMonitor in-use list. When a JavaThread is exiting,
 133   // ObjectMonitors on its per-thread in-use list are prepended here.
 134   ObjectMonitor* _in_use_list;
 135   DEFINE_PAD_MINUS_SIZE(2, OM_CACHE_LINE_SIZE, sizeof(ObjectMonitor*));
 136 
 137   int _free_count;    // # on free_list
 138   DEFINE_PAD_MINUS_SIZE(3, OM_CACHE_LINE_SIZE, sizeof(int));
 139 
 140   int _in_use_count;  // # on in_use_list
 141   DEFINE_PAD_MINUS_SIZE(4, OM_CACHE_LINE_SIZE, sizeof(int));
 142 
 143   int _population;    // # Extant -- in circulation
 144   DEFINE_PAD_MINUS_SIZE(5, OM_CACHE_LINE_SIZE, sizeof(int));
 145 };
 146 static ObjectMonitorListGlobals om_list_globals;
 147 
 148 #define CHECK_THROW_NOSYNC_IMSE(obj)  \
 149   if ((obj)-&gt;mark().is_always_locked()) {  \
 150     ResourceMark rm(THREAD);                \
 151     THROW_MSG(vmSymbols::java_lang_IllegalMonitorStateException(), obj-&gt;klass()-&gt;external_name()); \
 152   }
 153 
 154 #define CHECK_THROW_NOSYNC_IMSE_0(obj)  \
 155     if ((obj)-&gt;mark().is_always_locked()) {  \
 156     ResourceMark rm(THREAD);                  \
 157     THROW_MSG_0(vmSymbols::java_lang_IllegalMonitorStateException(), obj-&gt;klass()-&gt;external_name()); \
 158   }
 159 
 160 
 161 #define CHAINMARKER (cast_to_oop&lt;intptr_t&gt;(-1))
 162 
 163 
 164 // =====================&gt; Spin-lock functions
 165 
 166 // ObjectMonitors are not lockable outside of this file. We use spin-locks
 167 // implemented using a bit in the _next_om field instead of the heavier
 168 // weight locking mechanisms for faster list management.
 169 
 170 #define OM_LOCK_BIT 0x1
 171 
 172 // Return true if the ObjectMonitor is locked.
 173 // Otherwise returns false.
 174 static bool is_locked(ObjectMonitor* om) {
 175   return ((intptr_t)om-&gt;next_om() &amp; OM_LOCK_BIT) == OM_LOCK_BIT;
 176 }
 177 
 178 // Mark an ObjectMonitor* with OM_LOCK_BIT and return it.
 179 static ObjectMonitor* mark_om_ptr(ObjectMonitor* om) {
 180   return (ObjectMonitor*)((intptr_t)om | OM_LOCK_BIT);
 181 }
 182 
 183 // Return the unmarked next field in an ObjectMonitor. Note: the next
 184 // field may or may not have been marked with OM_LOCK_BIT originally.
 185 static ObjectMonitor* unmarked_next(ObjectMonitor* om) {
 186   return (ObjectMonitor*)((intptr_t)om-&gt;next_om() &amp; ~OM_LOCK_BIT);
 187 }
 188 
 189 // Try to lock an ObjectMonitor. Returns true if locking was successful.
 190 // Otherwise returns false.
 191 static bool try_om_lock(ObjectMonitor* om) {
 192   // Get current next field without any OM_LOCK_BIT value.
 193   ObjectMonitor* next = unmarked_next(om);
 194   if (om-&gt;try_set_next_om(next, mark_om_ptr(next)) != next) {
 195     return false;  // Cannot lock the ObjectMonitor.
 196   }
 197   return true;
 198 }
 199 
 200 // Lock an ObjectMonitor.
 201 static void om_lock(ObjectMonitor* om) {
 202   while (true) {
 203     if (try_om_lock(om)) {
 204       return;
 205     }
 206   }
 207 }
 208 
 209 // Unlock an ObjectMonitor.
 210 static void om_unlock(ObjectMonitor* om) {
 211   ObjectMonitor* next = om-&gt;next_om();
 212   guarantee(((intptr_t)next &amp; OM_LOCK_BIT) == OM_LOCK_BIT, &quot;next=&quot; INTPTR_FORMAT
 213             &quot; must have OM_LOCK_BIT=%x set.&quot;, p2i(next), OM_LOCK_BIT);
 214 
 215   next = (ObjectMonitor*)((intptr_t)next &amp; ~OM_LOCK_BIT);  // Clear OM_LOCK_BIT.
 216   om-&gt;set_next_om(next);
 217 }
 218 
 219 // Get the list head after locking it. Returns the list head or NULL
 220 // if the list is empty.
 221 static ObjectMonitor* get_list_head_locked(ObjectMonitor** list_p) {
 222   while (true) {
 223     ObjectMonitor* mid = Atomic::load(list_p);
 224     if (mid == NULL) {
 225       return NULL;  // The list is empty.
 226     }
 227     if (try_om_lock(mid)) {
 228       if (Atomic::load(list_p) != mid) {
 229         // The list head changed before we could lock it so we have to retry.
 230         om_unlock(mid);
 231         continue;
 232       }
 233       return mid;
 234     }
 235   }
 236 }
 237 
 238 #undef OM_LOCK_BIT
 239 
 240 
 241 // =====================&gt; List Management functions
 242 
 243 // Prepend a list of ObjectMonitors to the specified *list_p. &#39;tail&#39; is
 244 // the last ObjectMonitor in the list and there are &#39;count&#39; on the list.
 245 // Also updates the specified *count_p.
 246 static void prepend_list_to_common(ObjectMonitor* list, ObjectMonitor* tail,
 247                                    int count, ObjectMonitor** list_p,
 248                                    int* count_p) {
 249   while (true) {
 250     ObjectMonitor* cur = Atomic::load(list_p);
 251     // Prepend list to *list_p.
 252     if (!try_om_lock(tail)) {
 253       // Failed to lock tail due to a list walker so try it all again.
 254       continue;
 255     }
 256     tail-&gt;set_next_om(cur);  // tail now points to cur (and unlocks tail)
 257     if (cur == NULL) {
 258       // No potential race with takers or other prependers since
 259       // *list_p is empty.
 260       if (Atomic::cmpxchg(list_p, cur, list) == cur) {
 261         // Successfully switched *list_p to the list value.
 262         Atomic::add(count_p, count);
 263         break;
 264       }
 265       // Implied else: try it all again
 266     } else {
 267       if (!try_om_lock(cur)) {
 268         continue;  // failed to lock cur so try it all again
 269       }
 270       // We locked cur so try to switch *list_p to the list value.
 271       if (Atomic::cmpxchg(list_p, cur, list) != cur) {
 272         // The list head has changed so unlock cur and try again:
 273         om_unlock(cur);
 274         continue;
 275       }
 276       Atomic::add(count_p, count);
 277       om_unlock(cur);
 278       break;
 279     }
 280   }
 281 }
 282 
 283 // Prepend a newly allocated block of ObjectMonitors to g_block_list and
 284 // om_list_globals._free_list. Also updates om_list_globals._population
 285 // and om_list_globals._free_count.
 286 void ObjectSynchronizer::prepend_block_to_lists(PaddedObjectMonitor* new_blk) {
 287   // First we handle g_block_list:
 288   while (true) {
 289     PaddedObjectMonitor* cur = Atomic::load(&amp;g_block_list);
 290     // Prepend new_blk to g_block_list. The first ObjectMonitor in
 291     // a block is reserved for use as linkage to the next block.
 292     new_blk[0].set_next_om(cur);
 293     if (Atomic::cmpxchg(&amp;g_block_list, cur, new_blk) == cur) {
 294       // Successfully switched g_block_list to the new_blk value.
 295       Atomic::add(&amp;om_list_globals._population, _BLOCKSIZE - 1);
 296       break;
 297     }
 298     // Implied else: try it all again
 299   }
 300 
 301   // Second we handle om_list_globals._free_list:
 302   prepend_list_to_common(new_blk + 1, &amp;new_blk[_BLOCKSIZE - 1], _BLOCKSIZE - 1,
 303                          &amp;om_list_globals._free_list, &amp;om_list_globals._free_count);
 304 }
 305 
 306 // Prepend a list of ObjectMonitors to om_list_globals._free_list.
 307 // &#39;tail&#39; is the last ObjectMonitor in the list and there are &#39;count&#39;
 308 // on the list. Also updates om_list_globals._free_count.
 309 static void prepend_list_to_global_free_list(ObjectMonitor* list,
 310                                              ObjectMonitor* tail, int count) {
 311   prepend_list_to_common(list, tail, count, &amp;om_list_globals._free_list,
 312                          &amp;om_list_globals._free_count);
 313 }
 314 
 315 // Prepend a list of ObjectMonitors to om_list_globals._in_use_list.
 316 // &#39;tail&#39; is the last ObjectMonitor in the list and there are &#39;count&#39;
 317 // on the list. Also updates om_list_globals._in_use_list.
 318 static void prepend_list_to_global_in_use_list(ObjectMonitor* list,
 319                                                ObjectMonitor* tail, int count) {
 320   prepend_list_to_common(list, tail, count, &amp;om_list_globals._in_use_list,
 321                          &amp;om_list_globals._in_use_count);
 322 }
 323 
 324 // Prepend an ObjectMonitor to the specified list. Also updates
 325 // the specified counter.
 326 static void prepend_to_common(ObjectMonitor* m, ObjectMonitor** list_p,
 327                               int* count_p) {
 328   while (true) {
 329     om_lock(m);  // Lock m so we can safely update its next field.
 330     ObjectMonitor* cur = NULL;
 331     // Lock the list head to guard against races with a list walker
 332     // thread:
 333     if ((cur = get_list_head_locked(list_p)) != NULL) {
 334       // List head is now locked so we can safely switch it.
 335       m-&gt;set_next_om(cur);  // m now points to cur (and unlocks m)
 336       Atomic::store(list_p, m);  // Switch list head to unlocked m.
 337       om_unlock(cur);
 338       break;
 339     }
 340     // The list is empty so try to set the list head.
 341     assert(cur == NULL, &quot;cur must be NULL: cur=&quot; INTPTR_FORMAT, p2i(cur));
 342     m-&gt;set_next_om(cur);  // m now points to NULL (and unlocks m)
 343     if (Atomic::cmpxchg(list_p, cur, m) == cur) {
 344       // List head is now unlocked m.
 345       break;
 346     }
 347     // Implied else: try it all again
 348   }
 349   Atomic::inc(count_p);
 350 }
 351 
 352 // Prepend an ObjectMonitor to a per-thread om_free_list.
 353 // Also updates the per-thread om_free_count.
 354 static void prepend_to_om_free_list(Thread* self, ObjectMonitor* m) {
 355   prepend_to_common(m, &amp;self-&gt;om_free_list, &amp;self-&gt;om_free_count);
 356 }
 357 
 358 // Prepend an ObjectMonitor to a per-thread om_in_use_list.
 359 // Also updates the per-thread om_in_use_count.
 360 static void prepend_to_om_in_use_list(Thread* self, ObjectMonitor* m) {
 361   prepend_to_common(m, &amp;self-&gt;om_in_use_list, &amp;self-&gt;om_in_use_count);
 362 }
 363 
 364 // Take an ObjectMonitor from the start of the specified list. Also
 365 // decrements the specified counter. Returns NULL if none are available.
 366 static ObjectMonitor* take_from_start_of_common(ObjectMonitor** list_p,
 367                                                 int* count_p) {
 368   ObjectMonitor* take = NULL;
 369   // Lock the list head to guard against races with a list walker
 370   // thread:
 371   if ((take = get_list_head_locked(list_p)) == NULL) {
 372     return NULL;  // None are available.
 373   }
 374   ObjectMonitor* next = unmarked_next(take);
 375   // Switch locked list head to next (which unlocks the list head, but
 376   // leaves take locked):
 377   Atomic::store(list_p, next);
 378   Atomic::dec(count_p);
 379   // Unlock take, but leave the next value for any lagging list
 380   // walkers. It will get cleaned up when take is prepended to
 381   // the in-use list:
 382   om_unlock(take);
 383   return take;
 384 }
 385 
 386 // Take an ObjectMonitor from the start of the om_list_globals._free_list.
 387 // Also updates om_list_globals._free_count. Returns NULL if none are
 388 // available.
 389 static ObjectMonitor* take_from_start_of_global_free_list() {
 390   return take_from_start_of_common(&amp;om_list_globals._free_list,
 391                                    &amp;om_list_globals._free_count);
 392 }
 393 
 394 // Take an ObjectMonitor from the start of a per-thread free-list.
 395 // Also updates om_free_count. Returns NULL if none are available.
 396 static ObjectMonitor* take_from_start_of_om_free_list(Thread* self) {
 397   return take_from_start_of_common(&amp;self-&gt;om_free_list, &amp;self-&gt;om_free_count);
 398 }
 399 
 400 
 401 // =====================&gt; Quick functions
 402 
 403 // The quick_* forms are special fast-path variants used to improve
 404 // performance.  In the simplest case, a &quot;quick_*&quot; implementation could
 405 // simply return false, in which case the caller will perform the necessary
 406 // state transitions and call the slow-path form.
 407 // The fast-path is designed to handle frequently arising cases in an efficient
 408 // manner and is just a degenerate &quot;optimistic&quot; variant of the slow-path.
 409 // returns true  -- to indicate the call was satisfied.
 410 // returns false -- to indicate the call needs the services of the slow-path.
 411 // A no-loitering ordinance is in effect for code in the quick_* family
 412 // operators: safepoints or indefinite blocking (blocking that might span a
 413 // safepoint) are forbidden. Generally the thread_state() is _in_Java upon
 414 // entry.
 415 //
 416 // Consider: An interesting optimization is to have the JIT recognize the
 417 // following common idiom:
 418 //   synchronized (someobj) { .... ; notify(); }
 419 // That is, we find a notify() or notifyAll() call that immediately precedes
 420 // the monitorexit operation.  In that case the JIT could fuse the operations
 421 // into a single notifyAndExit() runtime primitive.
 422 
 423 bool ObjectSynchronizer::quick_notify(oopDesc* obj, Thread* self, bool all) {
 424   assert(!SafepointSynchronize::is_at_safepoint(), &quot;invariant&quot;);
 425   assert(self-&gt;is_Java_thread(), &quot;invariant&quot;);
 426   assert(((JavaThread *) self)-&gt;thread_state() == _thread_in_Java, &quot;invariant&quot;);
 427   NoSafepointVerifier nsv;
 428   if (obj == NULL) return false;  // slow-path for invalid obj
 429   assert(!EnableValhalla || !obj-&gt;klass()-&gt;is_value(), &quot;monitor op on value type&quot;);
 430   const markWord mark = obj-&gt;mark();
 431 
 432   if (mark.has_locker() &amp;&amp; self-&gt;is_lock_owned((address)mark.locker())) {
 433     // Degenerate notify
 434     // stack-locked by caller so by definition the implied waitset is empty.
 435     return true;
 436   }
 437 
 438   if (mark.has_monitor()) {
 439     ObjectMonitor* const mon = mark.monitor();
 440     assert(mon-&gt;object() == obj, &quot;invariant&quot;);
 441     if (mon-&gt;owner() != self) return false;  // slow-path for IMS exception
 442 
 443     if (mon-&gt;first_waiter() != NULL) {
 444       // We have one or more waiters. Since this is an inflated monitor
 445       // that we own, we can transfer one or more threads from the waitset
 446       // to the entrylist here and now, avoiding the slow-path.
 447       if (all) {
 448         DTRACE_MONITOR_PROBE(notifyAll, mon, obj, self);
 449       } else {
 450         DTRACE_MONITOR_PROBE(notify, mon, obj, self);
 451       }
 452       int free_count = 0;
 453       do {
 454         mon-&gt;INotify(self);
 455         ++free_count;
 456       } while (mon-&gt;first_waiter() != NULL &amp;&amp; all);
 457       OM_PERFDATA_OP(Notifications, inc(free_count));
 458     }
 459     return true;
 460   }
 461 
 462   // biased locking and any other IMS exception states take the slow-path
 463   return false;
 464 }
 465 
 466 
 467 // The LockNode emitted directly at the synchronization site would have
 468 // been too big if it were to have included support for the cases of inflated
 469 // recursive enter and exit, so they go here instead.
 470 // Note that we can&#39;t safely call AsyncPrintJavaStack() from within
 471 // quick_enter() as our thread state remains _in_Java.
 472 
 473 bool ObjectSynchronizer::quick_enter(oop obj, Thread* self,
 474                                      BasicLock * lock) {
 475   assert(!SafepointSynchronize::is_at_safepoint(), &quot;invariant&quot;);
 476   assert(self-&gt;is_Java_thread(), &quot;invariant&quot;);
 477   assert(((JavaThread *) self)-&gt;thread_state() == _thread_in_Java, &quot;invariant&quot;);
 478   NoSafepointVerifier nsv;
 479   if (obj == NULL) return false;       // Need to throw NPE
 480   assert(!EnableValhalla || !obj-&gt;klass()-&gt;is_value(), &quot;monitor op on value type&quot;);
 481   const markWord mark = obj-&gt;mark();
 482 
 483   if (mark.has_monitor()) {
 484     ObjectMonitor* const m = mark.monitor();
 485     assert(m-&gt;object() == obj, &quot;invariant&quot;);
 486     Thread* const owner = (Thread *) m-&gt;_owner;
 487 
 488     // Lock contention and Transactional Lock Elision (TLE) diagnostics
 489     // and observability
 490     // Case: light contention possibly amenable to TLE
 491     // Case: TLE inimical operations such as nested/recursive synchronization
 492 
 493     if (owner == self) {
 494       m-&gt;_recursions++;
 495       return true;
 496     }
 497 
 498     // This Java Monitor is inflated so obj&#39;s header will never be
 499     // displaced to this thread&#39;s BasicLock. Make the displaced header
 500     // non-NULL so this BasicLock is not seen as recursive nor as
 501     // being locked. We do this unconditionally so that this thread&#39;s
 502     // BasicLock cannot be mis-interpreted by any stack walkers. For
 503     // performance reasons, stack walkers generally first check for
 504     // Biased Locking in the object&#39;s header, the second check is for
 505     // stack-locking in the object&#39;s header, the third check is for
 506     // recursive stack-locking in the displaced header in the BasicLock,
 507     // and last are the inflated Java Monitor (ObjectMonitor) checks.
 508     lock-&gt;set_displaced_header(markWord::unused_mark());
 509 
 510     if (owner == NULL &amp;&amp; m-&gt;try_set_owner_from(NULL, self) == NULL) {
 511       assert(m-&gt;_recursions == 0, &quot;invariant&quot;);
 512       return true;
 513     }
 514   }
 515 
 516   // Note that we could inflate in quick_enter.
 517   // This is likely a useful optimization
 518   // Critically, in quick_enter() we must not:
 519   // -- perform bias revocation, or
 520   // -- block indefinitely, or
 521   // -- reach a safepoint
 522 
 523   return false;        // revert to slow-path
 524 }
 525 
 526 // -----------------------------------------------------------------------------
 527 // Monitor Enter/Exit
 528 // The interpreter and compiler assembly code tries to lock using the fast path
 529 // of this algorithm. Make sure to update that code if the following function is
 530 // changed. The implementation is extremely sensitive to race condition. Be careful.
 531 
 532 void ObjectSynchronizer::enter(Handle obj, BasicLock* lock, TRAPS) {
 533   CHECK_THROW_NOSYNC_IMSE(obj);
 534   if (UseBiasedLocking) {
 535     if (!SafepointSynchronize::is_at_safepoint()) {
 536       BiasedLocking::revoke(obj, THREAD);
 537     } else {
 538       BiasedLocking::revoke_at_safepoint(obj);
 539     }
 540   }
 541 
 542   markWord mark = obj-&gt;mark();
 543   assert(!mark.has_bias_pattern(), &quot;should not see bias pattern here&quot;);
 544 
 545   if (mark.is_neutral()) {
 546     // Anticipate successful CAS -- the ST of the displaced mark must
 547     // be visible &lt;= the ST performed by the CAS.
 548     lock-&gt;set_displaced_header(mark);
 549     if (mark == obj()-&gt;cas_set_mark(markWord::from_pointer(lock), mark)) {
 550       return;
 551     }
 552     // Fall through to inflate() ...
 553   } else if (mark.has_locker() &amp;&amp;
 554              THREAD-&gt;is_lock_owned((address)mark.locker())) {
 555     assert(lock != mark.locker(), &quot;must not re-lock the same lock&quot;);
 556     assert(lock != (BasicLock*)obj-&gt;mark().value(), &quot;don&#39;t relock with same BasicLock&quot;);
 557     lock-&gt;set_displaced_header(markWord::from_pointer(NULL));
 558     return;
 559   }
 560 
 561   // The object header will never be displaced to this lock,
 562   // so it does not matter what the value is, except that it
 563   // must be non-zero to avoid looking like a re-entrant lock,
 564   // and must not look locked either.
 565   lock-&gt;set_displaced_header(markWord::unused_mark());
 566   inflate(THREAD, obj(), inflate_cause_monitor_enter)-&gt;enter(THREAD);
 567 }
 568 
 569 void ObjectSynchronizer::exit(oop object, BasicLock* lock, TRAPS) {
 570   markWord mark = object-&gt;mark();
 571   if (EnableValhalla &amp;&amp; mark.is_always_locked()) {
 572     return;
 573   }
 574   assert(!EnableValhalla || !object-&gt;klass()-&gt;is_value(), &quot;monitor op on value type&quot;);
 575   // We cannot check for Biased Locking if we are racing an inflation.
 576   assert(mark == markWord::INFLATING() ||
 577          !mark.has_bias_pattern(), &quot;should not see bias pattern here&quot;);
 578 
 579   markWord dhw = lock-&gt;displaced_header();
 580   if (dhw.value() == 0) {
 581     // If the displaced header is NULL, then this exit matches up with
 582     // a recursive enter. No real work to do here except for diagnostics.
 583 #ifndef PRODUCT
 584     if (mark != markWord::INFLATING()) {
 585       // Only do diagnostics if we are not racing an inflation. Simply
 586       // exiting a recursive enter of a Java Monitor that is being
 587       // inflated is safe; see the has_monitor() comment below.
 588       assert(!mark.is_neutral(), &quot;invariant&quot;);
 589       assert(!mark.has_locker() ||
 590              THREAD-&gt;is_lock_owned((address)mark.locker()), &quot;invariant&quot;);
 591       if (mark.has_monitor()) {
 592         // The BasicLock&#39;s displaced_header is marked as a recursive
 593         // enter and we have an inflated Java Monitor (ObjectMonitor).
 594         // This is a special case where the Java Monitor was inflated
 595         // after this thread entered the stack-lock recursively. When a
 596         // Java Monitor is inflated, we cannot safely walk the Java
 597         // Monitor owner&#39;s stack and update the BasicLocks because a
 598         // Java Monitor can be asynchronously inflated by a thread that
 599         // does not own the Java Monitor.
 600         ObjectMonitor* m = mark.monitor();
 601         assert(((oop)(m-&gt;object()))-&gt;mark() == mark, &quot;invariant&quot;);
 602         assert(m-&gt;is_entered(THREAD), &quot;invariant&quot;);
 603       }
 604     }
 605 #endif
 606     return;
 607   }
 608 
 609   if (mark == markWord::from_pointer(lock)) {
 610     // If the object is stack-locked by the current thread, try to
 611     // swing the displaced header from the BasicLock back to the mark.
 612     assert(dhw.is_neutral(), &quot;invariant&quot;);
 613     if (object-&gt;cas_set_mark(dhw, mark) == mark) {
 614       return;
 615     }
 616   }
 617 
 618   // We have to take the slow-path of possible inflation and then exit.
 619   inflate(THREAD, object, inflate_cause_vm_internal)-&gt;exit(true, THREAD);
 620 }
 621 
 622 // -----------------------------------------------------------------------------
 623 // Class Loader  support to workaround deadlocks on the class loader lock objects
 624 // Also used by GC
 625 // complete_exit()/reenter() are used to wait on a nested lock
 626 // i.e. to give up an outer lock completely and then re-enter
 627 // Used when holding nested locks - lock acquisition order: lock1 then lock2
 628 //  1) complete_exit lock1 - saving recursion count
 629 //  2) wait on lock2
 630 //  3) when notified on lock2, unlock lock2
 631 //  4) reenter lock1 with original recursion count
 632 //  5) lock lock2
 633 // NOTE: must use heavy weight monitor to handle complete_exit/reenter()
 634 intx ObjectSynchronizer::complete_exit(Handle obj, TRAPS) {
 635   assert(!EnableValhalla || !obj-&gt;klass()-&gt;is_value(), &quot;monitor op on value type&quot;);
 636   if (UseBiasedLocking) {
 637     BiasedLocking::revoke(obj, THREAD);
 638     assert(!obj-&gt;mark().has_bias_pattern(), &quot;biases should be revoked by now&quot;);
 639   }
 640 
 641   ObjectMonitor* monitor = inflate(THREAD, obj(), inflate_cause_vm_internal);
 642 
 643   return monitor-&gt;complete_exit(THREAD);
 644 }
 645 
 646 // NOTE: must use heavy weight monitor to handle complete_exit/reenter()
 647 void ObjectSynchronizer::reenter(Handle obj, intx recursions, TRAPS) {
 648   assert(!EnableValhalla || !obj-&gt;klass()-&gt;is_value(), &quot;monitor op on value type&quot;);
 649   if (UseBiasedLocking) {
 650     BiasedLocking::revoke(obj, THREAD);
 651     assert(!obj-&gt;mark().has_bias_pattern(), &quot;biases should be revoked by now&quot;);
 652   }
 653 
 654   ObjectMonitor* monitor = inflate(THREAD, obj(), inflate_cause_vm_internal);
 655 
 656   monitor-&gt;reenter(recursions, THREAD);
 657 }
 658 // -----------------------------------------------------------------------------
 659 // JNI locks on java objects
 660 // NOTE: must use heavy weight monitor to handle jni monitor enter
 661 void ObjectSynchronizer::jni_enter(Handle obj, TRAPS) {
 662   // the current locking is from JNI instead of Java code
 663   CHECK_THROW_NOSYNC_IMSE(obj);
 664   if (UseBiasedLocking) {
 665     BiasedLocking::revoke(obj, THREAD);
 666     assert(!obj-&gt;mark().has_bias_pattern(), &quot;biases should be revoked by now&quot;);
 667   }
 668   THREAD-&gt;set_current_pending_monitor_is_from_java(false);
 669   inflate(THREAD, obj(), inflate_cause_jni_enter)-&gt;enter(THREAD);
 670   THREAD-&gt;set_current_pending_monitor_is_from_java(true);
 671 }
 672 
 673 // NOTE: must use heavy weight monitor to handle jni monitor exit
 674 void ObjectSynchronizer::jni_exit(oop obj, Thread* THREAD) {
 675   CHECK_THROW_NOSYNC_IMSE(obj);
 676   if (UseBiasedLocking) {
 677     Handle h_obj(THREAD, obj);
 678     BiasedLocking::revoke(h_obj, THREAD);
 679     obj = h_obj();
 680   }
 681   assert(!obj-&gt;mark().has_bias_pattern(), &quot;biases should be revoked by now&quot;);
 682 
 683   ObjectMonitor* monitor = inflate(THREAD, obj, inflate_cause_jni_exit);
 684   // If this thread has locked the object, exit the monitor. We
 685   // intentionally do not use CHECK here because we must exit the
 686   // monitor even if an exception is pending.
 687   if (monitor-&gt;check_owner(THREAD)) {
 688     monitor-&gt;exit(true, THREAD);
 689   }
 690 }
 691 
 692 // -----------------------------------------------------------------------------
 693 // Internal VM locks on java objects
 694 // standard constructor, allows locking failures
 695 ObjectLocker::ObjectLocker(Handle obj, Thread* thread, bool do_lock) {
 696   _dolock = do_lock;
 697   _thread = thread;
 698   _thread-&gt;check_for_valid_safepoint_state();
 699   _obj = obj;
 700 
 701   if (_dolock) {
 702     ObjectSynchronizer::enter(_obj, &amp;_lock, _thread);
 703   }
 704 }
 705 
 706 ObjectLocker::~ObjectLocker() {
 707   if (_dolock) {
 708     ObjectSynchronizer::exit(_obj(), &amp;_lock, _thread);
 709   }
 710 }
 711 
 712 
 713 // -----------------------------------------------------------------------------
 714 //  Wait/Notify/NotifyAll
 715 // NOTE: must use heavy weight monitor to handle wait()
 716 int ObjectSynchronizer::wait(Handle obj, jlong millis, TRAPS) {
 717   CHECK_THROW_NOSYNC_IMSE_0(obj);
 718   if (UseBiasedLocking) {
 719     BiasedLocking::revoke(obj, THREAD);
 720     assert(!obj-&gt;mark().has_bias_pattern(), &quot;biases should be revoked by now&quot;);
 721   }
 722   if (millis &lt; 0) {
 723     THROW_MSG_0(vmSymbols::java_lang_IllegalArgumentException(), &quot;timeout value is negative&quot;);
 724   }
 725   ObjectMonitor* monitor = inflate(THREAD, obj(), inflate_cause_wait);
 726 
 727   DTRACE_MONITOR_WAIT_PROBE(monitor, obj(), THREAD, millis);
 728   monitor-&gt;wait(millis, true, THREAD);
 729 
 730   // This dummy call is in place to get around dtrace bug 6254741.  Once
 731   // that&#39;s fixed we can uncomment the following line, remove the call
 732   // and change this function back into a &quot;void&quot; func.
 733   // DTRACE_MONITOR_PROBE(waited, monitor, obj(), THREAD);
 734   return dtrace_waited_probe(monitor, obj, THREAD);
 735 }
 736 
 737 void ObjectSynchronizer::wait_uninterruptibly(Handle obj, jlong millis, TRAPS) {
 738   CHECK_THROW_NOSYNC_IMSE(obj);
 739   if (UseBiasedLocking) {
 740     BiasedLocking::revoke(obj, THREAD);
 741     assert(!obj-&gt;mark().has_bias_pattern(), &quot;biases should be revoked by now&quot;);
 742   }
 743   if (millis &lt; 0) {
 744     THROW_MSG(vmSymbols::java_lang_IllegalArgumentException(), &quot;timeout value is negative&quot;);
 745   }
 746   inflate(THREAD, obj(), inflate_cause_wait)-&gt;wait(millis, false, THREAD);
 747 }
 748 
 749 void ObjectSynchronizer::notify(Handle obj, TRAPS) {
 750   CHECK_THROW_NOSYNC_IMSE(obj);
 751   if (UseBiasedLocking) {
 752     BiasedLocking::revoke(obj, THREAD);
 753     assert(!obj-&gt;mark().has_bias_pattern(), &quot;biases should be revoked by now&quot;);
 754   }
 755 
 756   markWord mark = obj-&gt;mark();
 757   if (mark.has_locker() &amp;&amp; THREAD-&gt;is_lock_owned((address)mark.locker())) {
 758     return;
 759   }
 760   inflate(THREAD, obj(), inflate_cause_notify)-&gt;notify(THREAD);
 761 }
 762 
 763 // NOTE: see comment of notify()
 764 void ObjectSynchronizer::notifyall(Handle obj, TRAPS) {
 765   CHECK_THROW_NOSYNC_IMSE(obj);
 766   if (UseBiasedLocking) {
 767     BiasedLocking::revoke(obj, THREAD);
 768     assert(!obj-&gt;mark().has_bias_pattern(), &quot;biases should be revoked by now&quot;);
 769   }
 770 
 771   markWord mark = obj-&gt;mark();
 772   if (mark.has_locker() &amp;&amp; THREAD-&gt;is_lock_owned((address)mark.locker())) {
 773     return;
 774   }
 775   inflate(THREAD, obj(), inflate_cause_notify)-&gt;notifyAll(THREAD);
 776 }
 777 
 778 // -----------------------------------------------------------------------------
 779 // Hash Code handling
 780 //
 781 // Performance concern:
 782 // OrderAccess::storestore() calls release() which at one time stored 0
 783 // into the global volatile OrderAccess::dummy variable. This store was
 784 // unnecessary for correctness. Many threads storing into a common location
 785 // causes considerable cache migration or &quot;sloshing&quot; on large SMP systems.
 786 // As such, I avoided using OrderAccess::storestore(). In some cases
 787 // OrderAccess::fence() -- which incurs local latency on the executing
 788 // processor -- is a better choice as it scales on SMP systems.
 789 //
 790 // See http://blogs.oracle.com/dave/entry/biased_locking_in_hotspot for
 791 // a discussion of coherency costs. Note that all our current reference
 792 // platforms provide strong ST-ST order, so the issue is moot on IA32,
 793 // x64, and SPARC.
 794 //
 795 // As a general policy we use &quot;volatile&quot; to control compiler-based reordering
 796 // and explicit fences (barriers) to control for architectural reordering
 797 // performed by the CPU(s) or platform.
 798 
 799 struct SharedGlobals {
 800   char         _pad_prefix[OM_CACHE_LINE_SIZE];
 801   // These are highly shared mostly-read variables.
 802   // To avoid false-sharing they need to be the sole occupants of a cache line.
 803   volatile int stw_random;
 804   volatile int stw_cycle;
 805   DEFINE_PAD_MINUS_SIZE(1, OM_CACHE_LINE_SIZE, sizeof(volatile int) * 2);
 806   // Hot RW variable -- Sequester to avoid false-sharing
 807   volatile int hc_sequence;
 808   DEFINE_PAD_MINUS_SIZE(2, OM_CACHE_LINE_SIZE, sizeof(volatile int));
 809 };
 810 
 811 static SharedGlobals GVars;
<a name="1" id="anc1"></a><span class="line-removed"> 812 static int _forceMonitorScavenge = 0; // Scavenge required and pending</span>
 813 
 814 static markWord read_stable_mark(oop obj) {
 815   markWord mark = obj-&gt;mark();
 816   if (!mark.is_being_inflated()) {
 817     return mark;       // normal fast-path return
 818   }
 819 
 820   int its = 0;
 821   for (;;) {
 822     markWord mark = obj-&gt;mark();
 823     if (!mark.is_being_inflated()) {
 824       return mark;    // normal fast-path return
 825     }
 826 
 827     // The object is being inflated by some other thread.
 828     // The caller of read_stable_mark() must wait for inflation to complete.
 829     // Avoid live-lock
 830     // TODO: consider calling SafepointSynchronize::do_call_back() while
 831     // spinning to see if there&#39;s a safepoint pending.  If so, immediately
 832     // yielding or blocking would be appropriate.  Avoid spinning while
 833     // there is a safepoint pending.
 834     // TODO: add inflation contention performance counters.
 835     // TODO: restrict the aggregate number of spinners.
 836 
 837     ++its;
 838     if (its &gt; 10000 || !os::is_MP()) {
 839       if (its &amp; 1) {
 840         os::naked_yield();
 841       } else {
 842         // Note that the following code attenuates the livelock problem but is not
 843         // a complete remedy.  A more complete solution would require that the inflating
 844         // thread hold the associated inflation lock.  The following code simply restricts
 845         // the number of spinners to at most one.  We&#39;ll have N-2 threads blocked
 846         // on the inflationlock, 1 thread holding the inflation lock and using
 847         // a yield/park strategy, and 1 thread in the midst of inflation.
 848         // A more refined approach would be to change the encoding of INFLATING
 849         // to allow encapsulation of a native thread pointer.  Threads waiting for
 850         // inflation to complete would use CAS to push themselves onto a singly linked
 851         // list rooted at the markword.  Once enqueued, they&#39;d loop, checking a per-thread flag
 852         // and calling park().  When inflation was complete the thread that accomplished inflation
 853         // would detach the list and set the markword to inflated with a single CAS and
 854         // then for each thread on the list, set the flag and unpark() the thread.
 855         // This is conceptually similar to muxAcquire-muxRelease, except that muxRelease
 856         // wakes at most one thread whereas we need to wake the entire list.
 857         int ix = (cast_from_oop&lt;intptr_t&gt;(obj) &gt;&gt; 5) &amp; (NINFLATIONLOCKS-1);
 858         int YieldThenBlock = 0;
 859         assert(ix &gt;= 0 &amp;&amp; ix &lt; NINFLATIONLOCKS, &quot;invariant&quot;);
 860         assert((NINFLATIONLOCKS &amp; (NINFLATIONLOCKS-1)) == 0, &quot;invariant&quot;);
 861         Thread::muxAcquire(gInflationLocks + ix, &quot;gInflationLock&quot;);
 862         while (obj-&gt;mark() == markWord::INFLATING()) {
 863           // Beware: NakedYield() is advisory and has almost no effect on some platforms
 864           // so we periodically call self-&gt;_ParkEvent-&gt;park(1).
 865           // We use a mixed spin/yield/block mechanism.
 866           if ((YieldThenBlock++) &gt;= 16) {
 867             Thread::current()-&gt;_ParkEvent-&gt;park(1);
 868           } else {
 869             os::naked_yield();
 870           }
 871         }
 872         Thread::muxRelease(gInflationLocks + ix);
 873       }
 874     } else {
 875       SpinPause();       // SMP-polite spinning
 876     }
 877   }
 878 }
 879 
 880 // hashCode() generation :
 881 //
 882 // Possibilities:
 883 // * MD5Digest of {obj,stw_random}
 884 // * CRC32 of {obj,stw_random} or any linear-feedback shift register function.
 885 // * A DES- or AES-style SBox[] mechanism
 886 // * One of the Phi-based schemes, such as:
 887 //   2654435761 = 2^32 * Phi (golden ratio)
 888 //   HashCodeValue = ((uintptr_t(obj) &gt;&gt; 3) * 2654435761) ^ GVars.stw_random ;
 889 // * A variation of Marsaglia&#39;s shift-xor RNG scheme.
 890 // * (obj ^ stw_random) is appealing, but can result
 891 //   in undesirable regularity in the hashCode values of adjacent objects
 892 //   (objects allocated back-to-back, in particular).  This could potentially
 893 //   result in hashtable collisions and reduced hashtable efficiency.
 894 //   There are simple ways to &quot;diffuse&quot; the middle address bits over the
 895 //   generated hashCode values:
 896 
 897 static inline intptr_t get_next_hash(Thread* self, oop obj) {
 898   intptr_t value = 0;
 899   if (hashCode == 0) {
 900     // This form uses global Park-Miller RNG.
 901     // On MP system we&#39;ll have lots of RW access to a global, so the
 902     // mechanism induces lots of coherency traffic.
 903     value = os::random();
 904   } else if (hashCode == 1) {
 905     // This variation has the property of being stable (idempotent)
 906     // between STW operations.  This can be useful in some of the 1-0
 907     // synchronization schemes.
 908     intptr_t addr_bits = cast_from_oop&lt;intptr_t&gt;(obj) &gt;&gt; 3;
 909     value = addr_bits ^ (addr_bits &gt;&gt; 5) ^ GVars.stw_random;
 910   } else if (hashCode == 2) {
 911     value = 1;            // for sensitivity testing
 912   } else if (hashCode == 3) {
 913     value = ++GVars.hc_sequence;
 914   } else if (hashCode == 4) {
 915     value = cast_from_oop&lt;intptr_t&gt;(obj);
 916   } else {
 917     // Marsaglia&#39;s xor-shift scheme with thread-specific state
 918     // This is probably the best overall implementation -- we&#39;ll
 919     // likely make this the default in future releases.
 920     unsigned t = self-&gt;_hashStateX;
 921     t ^= (t &lt;&lt; 11);
 922     self-&gt;_hashStateX = self-&gt;_hashStateY;
 923     self-&gt;_hashStateY = self-&gt;_hashStateZ;
 924     self-&gt;_hashStateZ = self-&gt;_hashStateW;
 925     unsigned v = self-&gt;_hashStateW;
 926     v = (v ^ (v &gt;&gt; 19)) ^ (t ^ (t &gt;&gt; 8));
 927     self-&gt;_hashStateW = v;
 928     value = v;
 929   }
 930 
 931   value &amp;= markWord::hash_mask;
 932   if (value == 0) value = 0xBAD;
 933   assert(value != markWord::no_hash, &quot;invariant&quot;);
 934   return value;
 935 }
 936 
 937 intptr_t ObjectSynchronizer::FastHashCode(Thread* self, oop obj) {
 938   if (EnableValhalla &amp;&amp; obj-&gt;klass()-&gt;is_value()) {
 939     // Expected tooling to override hashCode for value type, just don&#39;t crash
 940     if (log_is_enabled(Debug, monitorinflation)) {
 941       ResourceMark rm;
 942       log_debug(monitorinflation)(&quot;FastHashCode for value type: %s&quot;, obj-&gt;klass()-&gt;external_name());
 943     }
 944     return obj-&gt;klass()-&gt;java_mirror()-&gt;identity_hash();
 945   }
 946   if (UseBiasedLocking) {
 947     // NOTE: many places throughout the JVM do not expect a safepoint
 948     // to be taken here, in particular most operations on perm gen
 949     // objects. However, we only ever bias Java instances and all of
 950     // the call sites of identity_hash that might revoke biases have
 951     // been checked to make sure they can handle a safepoint. The
 952     // added check of the bias pattern is to avoid useless calls to
 953     // thread-local storage.
 954     if (obj-&gt;mark().has_bias_pattern()) {
 955       // Handle for oop obj in case of STW safepoint
 956       Handle hobj(self, obj);
 957       // Relaxing assertion for bug 6320749.
 958       assert(Universe::verify_in_progress() ||
 959              !SafepointSynchronize::is_at_safepoint(),
 960              &quot;biases should not be seen by VM thread here&quot;);
 961       BiasedLocking::revoke(hobj, JavaThread::current());
 962       obj = hobj();
 963       assert(!obj-&gt;mark().has_bias_pattern(), &quot;biases should be revoked by now&quot;);
 964     }
 965   }
 966 
 967   // hashCode() is a heap mutator ...
 968   // Relaxing assertion for bug 6320749.
 969   assert(Universe::verify_in_progress() || DumpSharedSpaces ||
 970          !SafepointSynchronize::is_at_safepoint(), &quot;invariant&quot;);
 971   assert(Universe::verify_in_progress() || DumpSharedSpaces ||
 972          self-&gt;is_Java_thread() , &quot;invariant&quot;);
 973   assert(Universe::verify_in_progress() || DumpSharedSpaces ||
 974          ((JavaThread *)self)-&gt;thread_state() != _thread_blocked, &quot;invariant&quot;);
 975 
 976   ObjectMonitor* monitor = NULL;
 977   markWord temp, test;
 978   intptr_t hash;
 979   markWord mark = read_stable_mark(obj);
 980 
 981   // object should remain ineligible for biased locking
 982   assert(!mark.has_bias_pattern(), &quot;invariant&quot;);
 983 
 984   if (mark.is_neutral()) {            // if this is a normal header
 985     hash = mark.hash();
 986     if (hash != 0) {                  // if it has a hash, just return it
 987       return hash;
 988     }
 989     hash = get_next_hash(self, obj);  // get a new hash
 990     temp = mark.copy_set_hash(hash);  // merge the hash into header
 991                                       // try to install the hash
 992     test = obj-&gt;cas_set_mark(temp, mark);
 993     if (test == mark) {               // if the hash was installed, return it
 994       return hash;
 995     }
 996     // Failed to install the hash. It could be that another thread
 997     // installed the hash just before our attempt or inflation has
 998     // occurred or... so we fall thru to inflate the monitor for
 999     // stability and then install the hash.
1000   } else if (mark.has_monitor()) {
1001     monitor = mark.monitor();
1002     temp = monitor-&gt;header();
1003     assert(temp.is_neutral(), &quot;invariant: header=&quot; INTPTR_FORMAT, temp.value());
1004     hash = temp.hash();
1005     if (hash != 0) {                  // if it has a hash, just return it
1006       return hash;
1007     }
1008     // Fall thru so we only have one place that installs the hash in
1009     // the ObjectMonitor.
1010   } else if (self-&gt;is_lock_owned((address)mark.locker())) {
1011     // This is a stack lock owned by the calling thread so fetch the
1012     // displaced markWord from the BasicLock on the stack.
1013     temp = mark.displaced_mark_helper();
1014     assert(temp.is_neutral(), &quot;invariant: header=&quot; INTPTR_FORMAT, temp.value());
1015     hash = temp.hash();
1016     if (hash != 0) {                  // if it has a hash, just return it
1017       return hash;
1018     }
1019     // WARNING:
1020     // The displaced header in the BasicLock on a thread&#39;s stack
1021     // is strictly immutable. It CANNOT be changed in ANY cases.
1022     // So we have to inflate the stack lock into an ObjectMonitor
1023     // even if the current thread owns the lock. The BasicLock on
1024     // a thread&#39;s stack can be asynchronously read by other threads
1025     // during an inflate() call so any change to that stack memory
1026     // may not propagate to other threads correctly.
1027   }
1028 
1029   // Inflate the monitor to set the hash.
1030   monitor = inflate(self, obj, inflate_cause_hash_code);
1031   // Load ObjectMonitor&#39;s header/dmw field and see if it has a hash.
1032   mark = monitor-&gt;header();
1033   assert(mark.is_neutral(), &quot;invariant: header=&quot; INTPTR_FORMAT, mark.value());
1034   hash = mark.hash();
1035   if (hash == 0) {                    // if it does not have a hash
1036     hash = get_next_hash(self, obj);  // get a new hash
1037     temp = mark.copy_set_hash(hash);  // merge the hash into header
1038     assert(temp.is_neutral(), &quot;invariant: header=&quot; INTPTR_FORMAT, temp.value());
1039     uintptr_t v = Atomic::cmpxchg((volatile uintptr_t*)monitor-&gt;header_addr(), mark.value(), temp.value());
1040     test = markWord(v);
1041     if (test != mark) {
1042       // The attempt to update the ObjectMonitor&#39;s header/dmw field
1043       // did not work. This can happen if another thread managed to
1044       // merge in the hash just before our cmpxchg().
1045       // If we add any new usages of the header/dmw field, this code
1046       // will need to be updated.
1047       hash = test.hash();
1048       assert(test.is_neutral(), &quot;invariant: header=&quot; INTPTR_FORMAT, test.value());
1049       assert(hash != 0, &quot;should only have lost the race to a thread that set a non-zero hash&quot;);
1050     }
1051   }
1052   // We finally get the hash.
1053   return hash;
1054 }
1055 
1056 
1057 bool ObjectSynchronizer::current_thread_holds_lock(JavaThread* thread,
1058                                                    Handle h_obj) {
1059   if (EnableValhalla &amp;&amp; h_obj-&gt;mark().is_always_locked()) {
1060     return false;
1061   }
1062   if (UseBiasedLocking) {
1063     BiasedLocking::revoke(h_obj, thread);
1064     assert(!h_obj-&gt;mark().has_bias_pattern(), &quot;biases should be revoked by now&quot;);
1065   }
1066 
1067   assert(thread == JavaThread::current(), &quot;Can only be called on current thread&quot;);
1068   oop obj = h_obj();
1069 
1070   markWord mark = read_stable_mark(obj);
1071 
1072   // Uncontended case, header points to stack
1073   if (mark.has_locker()) {
1074     return thread-&gt;is_lock_owned((address)mark.locker());
1075   }
1076   // Contended case, header points to ObjectMonitor (tagged pointer)
1077   if (mark.has_monitor()) {
1078     ObjectMonitor* monitor = mark.monitor();
1079     return monitor-&gt;is_entered(thread) != 0;
1080   }
1081   // Unlocked case, header in place
1082   assert(mark.is_neutral(), &quot;sanity check&quot;);
1083   return false;
1084 }
1085 
1086 // Be aware of this method could revoke bias of the lock object.
1087 // This method queries the ownership of the lock handle specified by &#39;h_obj&#39;.
1088 // If the current thread owns the lock, it returns owner_self. If no
1089 // thread owns the lock, it returns owner_none. Otherwise, it will return
1090 // owner_other.
1091 ObjectSynchronizer::LockOwnership ObjectSynchronizer::query_lock_ownership
1092 (JavaThread *self, Handle h_obj) {
1093   // The caller must beware this method can revoke bias, and
1094   // revocation can result in a safepoint.
1095   assert(!SafepointSynchronize::is_at_safepoint(), &quot;invariant&quot;);
1096   assert(self-&gt;thread_state() != _thread_blocked, &quot;invariant&quot;);
1097 
1098   // Possible mark states: neutral, biased, stack-locked, inflated
1099 
1100   if (UseBiasedLocking &amp;&amp; h_obj()-&gt;mark().has_bias_pattern()) {
1101     // CASE: biased
1102     BiasedLocking::revoke(h_obj, self);
1103     assert(!h_obj-&gt;mark().has_bias_pattern(),
1104            &quot;biases should be revoked by now&quot;);
1105   }
1106 
1107   assert(self == JavaThread::current(), &quot;Can only be called on current thread&quot;);
1108   oop obj = h_obj();
1109   markWord mark = read_stable_mark(obj);
1110 
1111   // CASE: stack-locked.  Mark points to a BasicLock on the owner&#39;s stack.
1112   if (mark.has_locker()) {
1113     return self-&gt;is_lock_owned((address)mark.locker()) ?
1114       owner_self : owner_other;
1115   }
1116 
1117   // CASE: inflated. Mark (tagged pointer) points to an ObjectMonitor.
1118   // The Object:ObjectMonitor relationship is stable as long as we&#39;re
1119   // not at a safepoint.
1120   if (mark.has_monitor()) {
1121     void* owner = mark.monitor()-&gt;_owner;
1122     if (owner == NULL) return owner_none;
1123     return (owner == self ||
1124             self-&gt;is_lock_owned((address)owner)) ? owner_self : owner_other;
1125   }
1126 
1127   // CASE: neutral
1128   assert(mark.is_neutral(), &quot;sanity check&quot;);
1129   return owner_none;           // it&#39;s unlocked
1130 }
1131 
1132 // FIXME: jvmti should call this
1133 JavaThread* ObjectSynchronizer::get_lock_owner(ThreadsList * t_list, Handle h_obj) {
1134   if (UseBiasedLocking) {
1135     if (SafepointSynchronize::is_at_safepoint()) {
1136       BiasedLocking::revoke_at_safepoint(h_obj);
1137     } else {
1138       BiasedLocking::revoke(h_obj, JavaThread::current());
1139     }
1140     assert(!h_obj-&gt;mark().has_bias_pattern(), &quot;biases should be revoked by now&quot;);
1141   }
1142 
1143   oop obj = h_obj();
1144   address owner = NULL;
1145 
1146   markWord mark = read_stable_mark(obj);
1147 
1148   // Uncontended case, header points to stack
1149   if (mark.has_locker()) {
1150     owner = (address) mark.locker();
1151   }
1152 
1153   // Contended case, header points to ObjectMonitor (tagged pointer)
1154   else if (mark.has_monitor()) {
1155     ObjectMonitor* monitor = mark.monitor();
1156     assert(monitor != NULL, &quot;monitor should be non-null&quot;);
1157     owner = (address) monitor-&gt;owner();
1158   }
1159 
1160   if (owner != NULL) {
1161     // owning_thread_from_monitor_owner() may also return NULL here
1162     return Threads::owning_thread_from_monitor_owner(t_list, owner);
1163   }
1164 
1165   // Unlocked case, header in place
1166   // Cannot have assertion since this object may have been
1167   // locked by another thread when reaching here.
1168   // assert(mark.is_neutral(), &quot;sanity check&quot;);
1169 
1170   return NULL;
1171 }
1172 
1173 // Visitors ...
1174 
1175 void ObjectSynchronizer::monitors_iterate(MonitorClosure* closure) {
1176   PaddedObjectMonitor* block = Atomic::load(&amp;g_block_list);
1177   while (block != NULL) {
1178     assert(block-&gt;object() == CHAINMARKER, &quot;must be a block header&quot;);
1179     for (int i = _BLOCKSIZE - 1; i &gt; 0; i--) {
1180       ObjectMonitor* mid = (ObjectMonitor *)(block + i);
1181       oop object = (oop)mid-&gt;object();
1182       if (object != NULL) {
1183         // Only process with closure if the object is set.
1184         closure-&gt;do_monitor(mid);
1185       }
1186     }
1187     // unmarked_next() is not needed with g_block_list (no locking
1188     // used with block linkage _next_om fields).
1189     block = (PaddedObjectMonitor*)block-&gt;next_om();
1190   }
1191 }
1192 
1193 static bool monitors_used_above_threshold() {
1194   int population = Atomic::load(&amp;om_list_globals._population);
1195   if (population == 0) {
1196     return false;
1197   }
1198   if (MonitorUsedDeflationThreshold &gt; 0) {
1199     int monitors_used = population - Atomic::load(&amp;om_list_globals._free_count);
1200     int monitor_usage = (monitors_used * 100LL) / population;
1201     return monitor_usage &gt; MonitorUsedDeflationThreshold;
1202   }
1203   return false;
1204 }
1205 
<a name="2" id="anc2"></a><span class="line-modified">1206 // Returns true if MonitorBound is set (&gt; 0) and if the specified</span>
<span class="line-removed">1207 // cnt is &gt; MonitorBound. Otherwise returns false.</span>
<span class="line-removed">1208 static bool is_MonitorBound_exceeded(const int cnt) {</span>
<span class="line-removed">1209   const int mx = MonitorBound;</span>
<span class="line-removed">1210   return mx &gt; 0 &amp;&amp; cnt &gt; mx;</span>
<span class="line-removed">1211 }</span>
<span class="line-removed">1212 </span>
<span class="line-removed">1213 bool ObjectSynchronizer::is_cleanup_needed() {</span>
<span class="line-removed">1214   if (monitors_used_above_threshold()) {</span>
<span class="line-removed">1215     // Too many monitors in use.</span>
<span class="line-removed">1216     return true;</span>
<span class="line-removed">1217   }</span>
<span class="line-removed">1218   return needs_monitor_scavenge();</span>
<span class="line-removed">1219 }</span>
<span class="line-removed">1220 </span>
<span class="line-removed">1221 bool ObjectSynchronizer::needs_monitor_scavenge() {</span>
<span class="line-removed">1222   if (Atomic::load(&amp;_forceMonitorScavenge) == 1) {</span>
<span class="line-removed">1223     log_info(monitorinflation)(&quot;Monitor scavenge needed, triggering safepoint cleanup.&quot;);</span>
<span class="line-removed">1224     return true;</span>
<span class="line-removed">1225   }</span>
1226   return false;
1227 }
1228 
1229 void ObjectSynchronizer::oops_do(OopClosure* f) {
1230   // We only scan the global used list here (for moribund threads), and
1231   // the thread-local monitors in Thread::oops_do().
1232   global_used_oops_do(f);
1233 }
1234 
1235 void ObjectSynchronizer::global_used_oops_do(OopClosure* f) {
1236   assert(SafepointSynchronize::is_at_safepoint(), &quot;must be at safepoint&quot;);
1237   list_oops_do(Atomic::load(&amp;om_list_globals._in_use_list), f);
1238 }
1239 
1240 void ObjectSynchronizer::thread_local_used_oops_do(Thread* thread, OopClosure* f) {
1241   assert(SafepointSynchronize::is_at_safepoint(), &quot;must be at safepoint&quot;);
1242   list_oops_do(thread-&gt;om_in_use_list, f);
1243 }
1244 
1245 void ObjectSynchronizer::list_oops_do(ObjectMonitor* list, OopClosure* f) {
1246   assert(SafepointSynchronize::is_at_safepoint(), &quot;must be at safepoint&quot;);
1247   // The oops_do() phase does not overlap with monitor deflation
1248   // so no need to lock ObjectMonitors for the list traversal.
1249   for (ObjectMonitor* mid = list; mid != NULL; mid = unmarked_next(mid)) {
1250     if (mid-&gt;object() != NULL) {
1251       f-&gt;do_oop((oop*)mid-&gt;object_addr());
1252     }
1253   }
1254 }
1255 
1256 
1257 // -----------------------------------------------------------------------------
1258 // ObjectMonitor Lifecycle
1259 // -----------------------
1260 // Inflation unlinks monitors from om_list_globals._free_list or a per-thread
1261 // free list and associates them with objects. Deflation -- which occurs at
1262 // STW-time -- disassociates idle monitors from objects.
1263 // Such scavenged monitors are returned to the om_list_globals._free_list.
1264 //
1265 // ObjectMonitors reside in type-stable memory (TSM) and are immortal.
1266 //
1267 // Lifecycle:
1268 // --   unassigned and on the om_list_globals._free_list
1269 // --   unassigned and on a per-thread free list
1270 // --   assigned to an object.  The object is inflated and the mark refers
1271 //      to the ObjectMonitor.
1272 
<a name="3" id="anc3"></a><span class="line-removed">1273 </span>
<span class="line-removed">1274 // Constraining monitor pool growth via MonitorBound ...</span>
<span class="line-removed">1275 //</span>
<span class="line-removed">1276 // If MonitorBound is not set (&lt;= 0), MonitorBound checks are disabled.</span>
<span class="line-removed">1277 //</span>
<span class="line-removed">1278 // The monitor pool is grow-only.  We scavenge at STW safepoint-time, but the</span>
<span class="line-removed">1279 // the rate of scavenging is driven primarily by GC.  As such,  we can find</span>
<span class="line-removed">1280 // an inordinate number of monitors in circulation.</span>
<span class="line-removed">1281 // To avoid that scenario we can artificially induce a STW safepoint</span>
<span class="line-removed">1282 // if the pool appears to be growing past some reasonable bound.</span>
<span class="line-removed">1283 // Generally we favor time in space-time tradeoffs, but as there&#39;s no</span>
<span class="line-removed">1284 // natural back-pressure on the # of extant monitors we need to impose some</span>
<span class="line-removed">1285 // type of limit.  Beware that if MonitorBound is set to too low a value</span>
<span class="line-removed">1286 // we could just loop. In addition, if MonitorBound is set to a low value</span>
<span class="line-removed">1287 // we&#39;ll incur more safepoints, which are harmful to performance.</span>
<span class="line-removed">1288 // See also: GuaranteedSafepointInterval</span>
<span class="line-removed">1289 //</span>
<span class="line-removed">1290 // If MonitorBound is set, the boundry applies to</span>
<span class="line-removed">1291 //     (om_list_globals._population - om_list_globals._free_count)</span>
<span class="line-removed">1292 // i.e., if there are not enough ObjectMonitors on the global free list,</span>
<span class="line-removed">1293 // then a safepoint deflation is induced. Picking a good MonitorBound value</span>
<span class="line-removed">1294 // is non-trivial.</span>
<span class="line-removed">1295 </span>
<span class="line-removed">1296 static void InduceScavenge(Thread* self, const char * Whence) {</span>
<span class="line-removed">1297   // Induce STW safepoint to trim monitors</span>
<span class="line-removed">1298   // Ultimately, this results in a call to deflate_idle_monitors() in the near future.</span>
<span class="line-removed">1299   // More precisely, trigger a cleanup safepoint as the number</span>
<span class="line-removed">1300   // of active monitors passes the specified threshold.</span>
<span class="line-removed">1301   // TODO: assert thread state is reasonable</span>
<span class="line-removed">1302 </span>
<span class="line-removed">1303   if (Atomic::xchg(&amp;_forceMonitorScavenge, 1) == 0) {</span>
<span class="line-removed">1304     VMThread::check_for_forced_cleanup();</span>
<span class="line-removed">1305   }</span>
<span class="line-removed">1306 }</span>
<span class="line-removed">1307 </span>
1308 ObjectMonitor* ObjectSynchronizer::om_alloc(Thread* self) {
1309   // A large MAXPRIVATE value reduces both list lock contention
1310   // and list coherency traffic, but also tends to increase the
1311   // number of ObjectMonitors in circulation as well as the STW
1312   // scavenge costs.  As usual, we lean toward time in space-time
1313   // tradeoffs.
1314   const int MAXPRIVATE = 1024;
1315   NoSafepointVerifier nsv;
1316 
1317   for (;;) {
1318     ObjectMonitor* m;
1319 
1320     // 1: try to allocate from the thread&#39;s local om_free_list.
1321     // Threads will attempt to allocate first from their local list, then
1322     // from the global list, and only after those attempts fail will the
1323     // thread attempt to instantiate new monitors. Thread-local free lists
1324     // improve allocation latency, as well as reducing coherency traffic
1325     // on the shared global list.
1326     m = take_from_start_of_om_free_list(self);
1327     if (m != NULL) {
1328       guarantee(m-&gt;object() == NULL, &quot;invariant&quot;);
1329       prepend_to_om_in_use_list(self, m);
1330       return m;
1331     }
1332 
1333     // 2: try to allocate from the global om_list_globals._free_list
1334     // If we&#39;re using thread-local free lists then try
1335     // to reprovision the caller&#39;s free list.
1336     if (Atomic::load(&amp;om_list_globals._free_list) != NULL) {
1337       // Reprovision the thread&#39;s om_free_list.
1338       // Use bulk transfers to reduce the allocation rate and heat
1339       // on various locks.
1340       for (int i = self-&gt;om_free_provision; --i &gt;= 0;) {
1341         ObjectMonitor* take = take_from_start_of_global_free_list();
1342         if (take == NULL) {
1343           break;  // No more are available.
1344         }
1345         guarantee(take-&gt;object() == NULL, &quot;invariant&quot;);
1346         take-&gt;Recycle();
1347         om_release(self, take, false);
1348       }
1349       self-&gt;om_free_provision += 1 + (self-&gt;om_free_provision / 2);
1350       if (self-&gt;om_free_provision &gt; MAXPRIVATE) self-&gt;om_free_provision = MAXPRIVATE;
<a name="4" id="anc4"></a><span class="line-removed">1351 </span>
<span class="line-removed">1352       if (is_MonitorBound_exceeded(Atomic::load(&amp;om_list_globals._population) -</span>
<span class="line-removed">1353                                    Atomic::load(&amp;om_list_globals._free_count))) {</span>
<span class="line-removed">1354         // Not enough ObjectMonitors on the global free list.</span>
<span class="line-removed">1355         // We can&#39;t safely induce a STW safepoint from om_alloc() as our thread</span>
<span class="line-removed">1356         // state may not be appropriate for such activities and callers may hold</span>
<span class="line-removed">1357         // naked oops, so instead we defer the action.</span>
<span class="line-removed">1358         InduceScavenge(self, &quot;om_alloc&quot;);</span>
<span class="line-removed">1359       }</span>
1360       continue;
1361     }
1362 
1363     // 3: allocate a block of new ObjectMonitors
1364     // Both the local and global free lists are empty -- resort to malloc().
1365     // In the current implementation ObjectMonitors are TSM - immortal.
1366     // Ideally, we&#39;d write &quot;new ObjectMonitor[_BLOCKSIZE], but we want
1367     // each ObjectMonitor to start at the beginning of a cache line,
1368     // so we use align_up().
1369     // A better solution would be to use C++ placement-new.
1370     // BEWARE: As it stands currently, we don&#39;t run the ctors!
1371     assert(_BLOCKSIZE &gt; 1, &quot;invariant&quot;);
1372     size_t neededsize = sizeof(PaddedObjectMonitor) * _BLOCKSIZE;
1373     PaddedObjectMonitor* temp;
1374     size_t aligned_size = neededsize + (OM_CACHE_LINE_SIZE - 1);
1375     void* real_malloc_addr = NEW_C_HEAP_ARRAY(char, aligned_size, mtInternal);
1376     temp = (PaddedObjectMonitor*)align_up(real_malloc_addr, OM_CACHE_LINE_SIZE);
1377     (void)memset((void *) temp, 0, neededsize);
1378 
1379     // Format the block.
1380     // initialize the linked list, each monitor points to its next
1381     // forming the single linked free list, the very first monitor
1382     // will points to next block, which forms the block list.
1383     // The trick of using the 1st element in the block as g_block_list
1384     // linkage should be reconsidered.  A better implementation would
1385     // look like: class Block { Block * next; int N; ObjectMonitor Body [N] ; }
1386 
1387     for (int i = 1; i &lt; _BLOCKSIZE; i++) {
1388       temp[i].set_next_om((ObjectMonitor*)&amp;temp[i + 1]);
1389     }
1390 
1391     // terminate the last monitor as the end of list
1392     temp[_BLOCKSIZE - 1].set_next_om((ObjectMonitor*)NULL);
1393 
1394     // Element [0] is reserved for global list linkage
1395     temp[0].set_object(CHAINMARKER);
1396 
1397     // Consider carving out this thread&#39;s current request from the
1398     // block in hand.  This avoids some lock traffic and redundant
1399     // list activity.
1400 
1401     prepend_block_to_lists(temp);
1402   }
1403 }
1404 
1405 // Place &quot;m&quot; on the caller&#39;s private per-thread om_free_list.
1406 // In practice there&#39;s no need to clamp or limit the number of
1407 // monitors on a thread&#39;s om_free_list as the only non-allocation time
1408 // we&#39;ll call om_release() is to return a monitor to the free list after
1409 // a CAS attempt failed. This doesn&#39;t allow unbounded #s of monitors to
1410 // accumulate on a thread&#39;s free list.
1411 //
1412 // Key constraint: all ObjectMonitors on a thread&#39;s free list and the global
1413 // free list must have their object field set to null. This prevents the
1414 // scavenger -- deflate_monitor_list() -- from reclaiming them while we
1415 // are trying to release them.
1416 
1417 void ObjectSynchronizer::om_release(Thread* self, ObjectMonitor* m,
1418                                     bool from_per_thread_alloc) {
1419   guarantee(m-&gt;header().value() == 0, &quot;invariant&quot;);
1420   guarantee(m-&gt;object() == NULL, &quot;invariant&quot;);
1421   NoSafepointVerifier nsv;
1422 
1423   if ((m-&gt;is_busy() | m-&gt;_recursions) != 0) {
1424     stringStream ss;
1425     fatal(&quot;freeing in-use monitor: %s, recursions=&quot; INTX_FORMAT,
1426           m-&gt;is_busy_to_string(&amp;ss), m-&gt;_recursions);
1427   }
1428   // _next_om is used for both per-thread in-use and free lists so
1429   // we have to remove &#39;m&#39; from the in-use list first (as needed).
1430   if (from_per_thread_alloc) {
1431     // Need to remove &#39;m&#39; from om_in_use_list.
1432     ObjectMonitor* mid = NULL;
1433     ObjectMonitor* next = NULL;
1434 
1435     // This list walk can only race with another list walker since
1436     // deflation can only happen at a safepoint so we don&#39;t have to
1437     // worry about an ObjectMonitor being removed from this list
1438     // while we are walking it.
1439 
1440     // Lock the list head to avoid racing with another list walker.
1441     if ((mid = get_list_head_locked(&amp;self-&gt;om_in_use_list)) == NULL) {
1442       fatal(&quot;thread=&quot; INTPTR_FORMAT &quot; in-use list must not be empty.&quot;, p2i(self));
1443     }
1444     next = unmarked_next(mid);
1445     if (m == mid) {
1446       // First special case:
1447       // &#39;m&#39; matches mid, is the list head and is locked. Switch the list
1448       // head to next which unlocks the list head, but leaves the extracted
1449       // mid locked:
1450       Atomic::store(&amp;self-&gt;om_in_use_list, next);
1451     } else if (m == next) {
1452       // Second special case:
1453       // &#39;m&#39; matches next after the list head and we already have the list
1454       // head locked so set mid to what we are extracting:
1455       mid = next;
1456       // Lock mid to prevent races with a list walker:
1457       om_lock(mid);
1458       // Update next to what follows mid (if anything):
1459       next = unmarked_next(mid);
1460       // Switch next after the list head to new next which unlocks the
1461       // list head, but leaves the extracted mid locked:
1462       self-&gt;om_in_use_list-&gt;set_next_om(next);
1463     } else {
1464       // We have to search the list to find &#39;m&#39;.
1465       om_unlock(mid);  // unlock the list head
1466       guarantee(next != NULL, &quot;thread=&quot; INTPTR_FORMAT &quot;: om_in_use_list=&quot; INTPTR_FORMAT
1467                 &quot; is too short.&quot;, p2i(self), p2i(self-&gt;om_in_use_list));
1468       // Our starting anchor is next after the list head which is the
1469       // last ObjectMonitor we checked:
1470       ObjectMonitor* anchor = next;
1471       while ((mid = unmarked_next(anchor)) != NULL) {
1472         if (m == mid) {
1473           // We found &#39;m&#39; on the per-thread in-use list so extract it.
1474           om_lock(anchor);  // Lock the anchor so we can safely modify it.
1475           // Update next to what follows mid (if anything):
1476           next = unmarked_next(mid);
1477           // Switch next after the anchor to new next which unlocks the
1478           // anchor, but leaves the extracted mid locked:
1479           anchor-&gt;set_next_om(next);
1480           break;
1481         } else {
1482           anchor = mid;
1483         }
1484       }
1485     }
1486 
1487     if (mid == NULL) {
1488       // Reached end of the list and didn&#39;t find &#39;m&#39; so:
1489       fatal(&quot;thread=&quot; INTPTR_FORMAT &quot; must find m=&quot; INTPTR_FORMAT &quot;on om_in_use_list=&quot;
1490             INTPTR_FORMAT, p2i(self), p2i(m), p2i(self-&gt;om_in_use_list));
1491     }
1492 
1493     // At this point mid is disconnected from the in-use list so
1494     // its lock no longer has any effects on the in-use list.
1495     Atomic::dec(&amp;self-&gt;om_in_use_count);
1496     // Unlock mid, but leave the next value for any lagging list
1497     // walkers. It will get cleaned up when mid is prepended to
1498     // the thread&#39;s free list:
1499     om_unlock(mid);
1500   }
1501 
1502   prepend_to_om_free_list(self, m);
1503 }
1504 
1505 // Return ObjectMonitors on a moribund thread&#39;s free and in-use
1506 // lists to the appropriate global lists. The ObjectMonitors on the
1507 // per-thread in-use list may still be in use by other threads.
1508 //
1509 // We currently call om_flush() from Threads::remove() before the
1510 // thread has been excised from the thread list and is no longer a
1511 // mutator. This means that om_flush() cannot run concurrently with
1512 // a safepoint and interleave with deflate_idle_monitors(). In
1513 // particular, this ensures that the thread&#39;s in-use monitors are
1514 // scanned by a GC safepoint, either via Thread::oops_do() (before
1515 // om_flush() is called) or via ObjectSynchronizer::oops_do() (after
1516 // om_flush() is called).
1517 
1518 void ObjectSynchronizer::om_flush(Thread* self) {
1519   // Process the per-thread in-use list first to be consistent.
1520   int in_use_count = 0;
1521   ObjectMonitor* in_use_list = NULL;
1522   ObjectMonitor* in_use_tail = NULL;
1523   NoSafepointVerifier nsv;
1524 
1525   // This function can race with a list walker thread so we lock the
1526   // list head to prevent confusion.
1527   if ((in_use_list = get_list_head_locked(&amp;self-&gt;om_in_use_list)) != NULL) {
1528     // At this point, we have locked the in-use list head so a racing
1529     // thread cannot come in after us. However, a racing thread could
1530     // be ahead of us; we&#39;ll detect that and delay to let it finish.
1531     //
1532     // The thread is going away, however the ObjectMonitors on the
1533     // om_in_use_list may still be in-use by other threads. Link
1534     // them to in_use_tail, which will be linked into the global
1535     // in-use list (om_list_globals._in_use_list) below.
1536     //
1537     // Account for the in-use list head before the loop since it is
1538     // already locked (by this thread):
1539     in_use_tail = in_use_list;
1540     in_use_count++;
1541     for (ObjectMonitor* cur_om = unmarked_next(in_use_list); cur_om != NULL; cur_om = unmarked_next(cur_om)) {
1542       if (is_locked(cur_om)) {
1543         // cur_om is locked so there must be a racing walker thread ahead
1544         // of us so we&#39;ll give it a chance to finish.
1545         while (is_locked(cur_om)) {
1546           os::naked_short_sleep(1);
1547         }
1548       }
1549       in_use_tail = cur_om;
1550       in_use_count++;
1551     }
1552     guarantee(in_use_tail != NULL, &quot;invariant&quot;);
1553     int l_om_in_use_count = Atomic::load(&amp;self-&gt;om_in_use_count);
1554     assert(l_om_in_use_count == in_use_count, &quot;in-use counts don&#39;t match: &quot;
1555           &quot;l_om_in_use_count=%d, in_use_count=%d&quot;, l_om_in_use_count, in_use_count);
1556     Atomic::store(&amp;self-&gt;om_in_use_count, 0);
1557     // Clear the in-use list head (which also unlocks it):
1558     Atomic::store(&amp;self-&gt;om_in_use_list, (ObjectMonitor*)NULL);
1559     om_unlock(in_use_list);
1560   }
1561 
1562   int free_count = 0;
1563   ObjectMonitor* free_list = NULL;
1564   ObjectMonitor* free_tail = NULL;
1565   // This function can race with a list walker thread so we lock the
1566   // list head to prevent confusion.
1567   if ((free_list = get_list_head_locked(&amp;self-&gt;om_free_list)) != NULL) {
1568     // At this point, we have locked the free list head so a racing
1569     // thread cannot come in after us. However, a racing thread could
1570     // be ahead of us; we&#39;ll detect that and delay to let it finish.
1571     //
1572     // The thread is going away. Set &#39;free_tail&#39; to the last per-thread free
1573     // monitor which will be linked to om_list_globals._free_list below.
1574     //
1575     // Account for the free list head before the loop since it is
1576     // already locked (by this thread):
1577     free_tail = free_list;
1578     free_count++;
1579     for (ObjectMonitor* s = unmarked_next(free_list); s != NULL; s = unmarked_next(s)) {
1580       if (is_locked(s)) {
1581         // s is locked so there must be a racing walker thread ahead
1582         // of us so we&#39;ll give it a chance to finish.
1583         while (is_locked(s)) {
1584           os::naked_short_sleep(1);
1585         }
1586       }
1587       free_tail = s;
1588       free_count++;
1589       guarantee(s-&gt;object() == NULL, &quot;invariant&quot;);
1590       if (s-&gt;is_busy()) {
1591         stringStream ss;
1592         fatal(&quot;must be !is_busy: %s&quot;, s-&gt;is_busy_to_string(&amp;ss));
1593       }
1594     }
1595     guarantee(free_tail != NULL, &quot;invariant&quot;);
1596     int l_om_free_count = Atomic::load(&amp;self-&gt;om_free_count);
1597     assert(l_om_free_count == free_count, &quot;free counts don&#39;t match: &quot;
1598            &quot;l_om_free_count=%d, free_count=%d&quot;, l_om_free_count, free_count);
1599     Atomic::store(&amp;self-&gt;om_free_count, 0);
1600     Atomic::store(&amp;self-&gt;om_free_list, (ObjectMonitor*)NULL);
1601     om_unlock(free_list);
1602   }
1603 
1604   if (free_tail != NULL) {
1605     prepend_list_to_global_free_list(free_list, free_tail, free_count);
1606   }
1607 
1608   if (in_use_tail != NULL) {
1609     prepend_list_to_global_in_use_list(in_use_list, in_use_tail, in_use_count);
1610   }
1611 
1612   LogStreamHandle(Debug, monitorinflation) lsh_debug;
1613   LogStreamHandle(Info, monitorinflation) lsh_info;
1614   LogStream* ls = NULL;
1615   if (log_is_enabled(Debug, monitorinflation)) {
1616     ls = &amp;lsh_debug;
1617   } else if ((free_count != 0 || in_use_count != 0) &amp;&amp;
1618              log_is_enabled(Info, monitorinflation)) {
1619     ls = &amp;lsh_info;
1620   }
1621   if (ls != NULL) {
1622     ls-&gt;print_cr(&quot;om_flush: jt=&quot; INTPTR_FORMAT &quot;, free_count=%d&quot;
1623                  &quot;, in_use_count=%d&quot; &quot;, om_free_provision=%d&quot;,
1624                  p2i(self), free_count, in_use_count, self-&gt;om_free_provision);
1625   }
1626 }
1627 
1628 static void post_monitor_inflate_event(EventJavaMonitorInflate* event,
1629                                        const oop obj,
1630                                        ObjectSynchronizer::InflateCause cause) {
1631   assert(event != NULL, &quot;invariant&quot;);
1632   assert(event-&gt;should_commit(), &quot;invariant&quot;);
1633   event-&gt;set_monitorClass(obj-&gt;klass());
1634   event-&gt;set_address((uintptr_t)(void*)obj);
1635   event-&gt;set_cause((u1)cause);
1636   event-&gt;commit();
1637 }
1638 
1639 // Fast path code shared by multiple functions
1640 void ObjectSynchronizer::inflate_helper(oop obj) {
1641   markWord mark = obj-&gt;mark();
1642   if (mark.has_monitor()) {
1643     assert(ObjectSynchronizer::verify_objmon_isinpool(mark.monitor()), &quot;monitor is invalid&quot;);
1644     assert(mark.monitor()-&gt;header().is_neutral(), &quot;monitor must record a good object header&quot;);
1645     return;
1646   }
1647   inflate(Thread::current(), obj, inflate_cause_vm_internal);
1648 }
1649 
1650 ObjectMonitor* ObjectSynchronizer::inflate(Thread* self,
1651                                            oop object, const InflateCause cause) {
1652   // Inflate mutates the heap ...
1653   // Relaxing assertion for bug 6320749.
1654   assert(Universe::verify_in_progress() ||
1655          !SafepointSynchronize::is_at_safepoint(), &quot;invariant&quot;);
1656 
1657   if (EnableValhalla) {
1658     guarantee(!object-&gt;klass()-&gt;is_value(), &quot;Attempt to inflate value type&quot;);
1659   }
1660 
1661   EventJavaMonitorInflate event;
1662 
1663   for (;;) {
1664     const markWord mark = object-&gt;mark();
1665     assert(!mark.has_bias_pattern(), &quot;invariant&quot;);
1666 
1667     // The mark can be in one of the following states:
1668     // *  Inflated     - just return
1669     // *  Stack-locked - coerce it to inflated
1670     // *  INFLATING    - busy wait for conversion to complete
1671     // *  Neutral      - aggressively inflate the object.
1672     // *  BIASED       - Illegal.  We should never see this
1673 
1674     // CASE: inflated
1675     if (mark.has_monitor()) {
1676       ObjectMonitor* inf = mark.monitor();
1677       markWord dmw = inf-&gt;header();
1678       assert(dmw.is_neutral(), &quot;invariant: header=&quot; INTPTR_FORMAT, dmw.value());
1679       assert(inf-&gt;object() == object, &quot;invariant&quot;);
1680       assert(ObjectSynchronizer::verify_objmon_isinpool(inf), &quot;monitor is invalid&quot;);
1681       return inf;
1682     }
1683 
1684     // CASE: inflation in progress - inflating over a stack-lock.
1685     // Some other thread is converting from stack-locked to inflated.
1686     // Only that thread can complete inflation -- other threads must wait.
1687     // The INFLATING value is transient.
1688     // Currently, we spin/yield/park and poll the markword, waiting for inflation to finish.
1689     // We could always eliminate polling by parking the thread on some auxiliary list.
1690     if (mark == markWord::INFLATING()) {
1691       read_stable_mark(object);
1692       continue;
1693     }
1694 
1695     // CASE: stack-locked
1696     // Could be stack-locked either by this thread or by some other thread.
1697     //
1698     // Note that we allocate the objectmonitor speculatively, _before_ attempting
1699     // to install INFLATING into the mark word.  We originally installed INFLATING,
1700     // allocated the objectmonitor, and then finally STed the address of the
1701     // objectmonitor into the mark.  This was correct, but artificially lengthened
1702     // the interval in which INFLATED appeared in the mark, thus increasing
1703     // the odds of inflation contention.
1704     //
1705     // We now use per-thread private objectmonitor free lists.
1706     // These list are reprovisioned from the global free list outside the
1707     // critical INFLATING...ST interval.  A thread can transfer
1708     // multiple objectmonitors en-mass from the global free list to its local free list.
1709     // This reduces coherency traffic and lock contention on the global free list.
1710     // Using such local free lists, it doesn&#39;t matter if the om_alloc() call appears
1711     // before or after the CAS(INFLATING) operation.
1712     // See the comments in om_alloc().
1713 
1714     LogStreamHandle(Trace, monitorinflation) lsh;
1715 
1716     if (mark.has_locker()) {
1717       ObjectMonitor* m = om_alloc(self);
1718       // Optimistically prepare the objectmonitor - anticipate successful CAS
1719       // We do this before the CAS in order to minimize the length of time
1720       // in which INFLATING appears in the mark.
1721       m-&gt;Recycle();
1722       m-&gt;_Responsible  = NULL;
1723       m-&gt;_SpinDuration = ObjectMonitor::Knob_SpinLimit;   // Consider: maintain by type/class
1724 
1725       markWord cmp = object-&gt;cas_set_mark(markWord::INFLATING(), mark);
1726       if (cmp != mark) {
1727         om_release(self, m, true);
1728         continue;       // Interference -- just retry
1729       }
1730 
1731       // We&#39;ve successfully installed INFLATING (0) into the mark-word.
1732       // This is the only case where 0 will appear in a mark-word.
1733       // Only the singular thread that successfully swings the mark-word
1734       // to 0 can perform (or more precisely, complete) inflation.
1735       //
1736       // Why do we CAS a 0 into the mark-word instead of just CASing the
1737       // mark-word from the stack-locked value directly to the new inflated state?
1738       // Consider what happens when a thread unlocks a stack-locked object.
1739       // It attempts to use CAS to swing the displaced header value from the
1740       // on-stack BasicLock back into the object header.  Recall also that the
1741       // header value (hash code, etc) can reside in (a) the object header, or
1742       // (b) a displaced header associated with the stack-lock, or (c) a displaced
1743       // header in an ObjectMonitor.  The inflate() routine must copy the header
1744       // value from the BasicLock on the owner&#39;s stack to the ObjectMonitor, all
1745       // the while preserving the hashCode stability invariants.  If the owner
1746       // decides to release the lock while the value is 0, the unlock will fail
1747       // and control will eventually pass from slow_exit() to inflate.  The owner
1748       // will then spin, waiting for the 0 value to disappear.   Put another way,
1749       // the 0 causes the owner to stall if the owner happens to try to
1750       // drop the lock (restoring the header from the BasicLock to the object)
1751       // while inflation is in-progress.  This protocol avoids races that might
1752       // would otherwise permit hashCode values to change or &quot;flicker&quot; for an object.
1753       // Critically, while object-&gt;mark is 0 mark.displaced_mark_helper() is stable.
1754       // 0 serves as a &quot;BUSY&quot; inflate-in-progress indicator.
1755 
1756 
1757       // fetch the displaced mark from the owner&#39;s stack.
1758       // The owner can&#39;t die or unwind past the lock while our INFLATING
1759       // object is in the mark.  Furthermore the owner can&#39;t complete
1760       // an unlock on the object, either.
1761       markWord dmw = mark.displaced_mark_helper();
1762       // Catch if the object&#39;s header is not neutral (not locked and
1763       // not marked is what we care about here).
1764       assert(dmw.is_neutral(), &quot;invariant: header=&quot; INTPTR_FORMAT, dmw.value());
1765 
1766       // Setup monitor fields to proper values -- prepare the monitor
1767       m-&gt;set_header(dmw);
1768 
1769       // Optimization: if the mark.locker stack address is associated
1770       // with this thread we could simply set m-&gt;_owner = self.
1771       // Note that a thread can inflate an object
1772       // that it has stack-locked -- as might happen in wait() -- directly
1773       // with CAS.  That is, we can avoid the xchg-NULL .... ST idiom.
1774       m-&gt;set_owner_from(NULL, mark.locker());
1775       m-&gt;set_object(object);
1776       // TODO-FIXME: assert BasicLock-&gt;dhw != 0.
1777 
1778       // Must preserve store ordering. The monitor state must
1779       // be stable at the time of publishing the monitor address.
1780       guarantee(object-&gt;mark() == markWord::INFLATING(), &quot;invariant&quot;);
1781       object-&gt;release_set_mark(markWord::encode(m));
1782 
1783       // Hopefully the performance counters are allocated on distinct cache lines
1784       // to avoid false sharing on MP systems ...
1785       OM_PERFDATA_OP(Inflations, inc());
1786       if (log_is_enabled(Trace, monitorinflation)) {
1787         ResourceMark rm(self);
1788         lsh.print_cr(&quot;inflate(has_locker): object=&quot; INTPTR_FORMAT &quot;, mark=&quot;
1789                      INTPTR_FORMAT &quot;, type=&#39;%s&#39;&quot;, p2i(object),
1790                      object-&gt;mark().value(), object-&gt;klass()-&gt;external_name());
1791       }
1792       if (event.should_commit()) {
1793         post_monitor_inflate_event(&amp;event, object, cause);
1794       }
1795       return m;
1796     }
1797 
1798     // CASE: neutral
1799     // TODO-FIXME: for entry we currently inflate and then try to CAS _owner.
1800     // If we know we&#39;re inflating for entry it&#39;s better to inflate by swinging a
1801     // pre-locked ObjectMonitor pointer into the object header.   A successful
1802     // CAS inflates the object *and* confers ownership to the inflating thread.
1803     // In the current implementation we use a 2-step mechanism where we CAS()
1804     // to inflate and then CAS() again to try to swing _owner from NULL to self.
1805     // An inflateTry() method that we could call from enter() would be useful.
1806 
1807     // Catch if the object&#39;s header is not neutral (not locked and
1808     // not marked is what we care about here).
1809     assert(mark.is_neutral(), &quot;invariant: header=&quot; INTPTR_FORMAT, mark.value());
1810     ObjectMonitor* m = om_alloc(self);
1811     // prepare m for installation - set monitor to initial state
1812     m-&gt;Recycle();
1813     m-&gt;set_header(mark);
1814     m-&gt;set_object(object);
1815     m-&gt;_Responsible  = NULL;
1816     m-&gt;_SpinDuration = ObjectMonitor::Knob_SpinLimit;       // consider: keep metastats by type/class
1817 
1818     if (object-&gt;cas_set_mark(markWord::encode(m), mark) != mark) {
1819       m-&gt;set_header(markWord::zero());
1820       m-&gt;set_object(NULL);
1821       m-&gt;Recycle();
1822       om_release(self, m, true);
1823       m = NULL;
1824       continue;
1825       // interference - the markword changed - just retry.
1826       // The state-transitions are one-way, so there&#39;s no chance of
1827       // live-lock -- &quot;Inflated&quot; is an absorbing state.
1828     }
1829 
1830     // Hopefully the performance counters are allocated on distinct
1831     // cache lines to avoid false sharing on MP systems ...
1832     OM_PERFDATA_OP(Inflations, inc());
1833     if (log_is_enabled(Trace, monitorinflation)) {
1834       ResourceMark rm(self);
1835       lsh.print_cr(&quot;inflate(neutral): object=&quot; INTPTR_FORMAT &quot;, mark=&quot;
1836                    INTPTR_FORMAT &quot;, type=&#39;%s&#39;&quot;, p2i(object),
1837                    object-&gt;mark().value(), object-&gt;klass()-&gt;external_name());
1838     }
1839     if (event.should_commit()) {
1840       post_monitor_inflate_event(&amp;event, object, cause);
1841     }
1842     return m;
1843   }
1844 }
1845 
1846 
1847 // We maintain a list of in-use monitors for each thread.
1848 //
1849 // deflate_thread_local_monitors() scans a single thread&#39;s in-use list, while
1850 // deflate_idle_monitors() scans only a global list of in-use monitors which
1851 // is populated only as a thread dies (see om_flush()).
1852 //
1853 // These operations are called at all safepoints, immediately after mutators
1854 // are stopped, but before any objects have moved. Collectively they traverse
1855 // the population of in-use monitors, deflating where possible. The scavenged
1856 // monitors are returned to the global monitor free list.
1857 //
1858 // Beware that we scavenge at *every* stop-the-world point. Having a large
1859 // number of monitors in-use could negatively impact performance. We also want
1860 // to minimize the total # of monitors in circulation, as they incur a small
1861 // footprint penalty.
1862 //
1863 // Perversely, the heap size -- and thus the STW safepoint rate --
1864 // typically drives the scavenge rate.  Large heaps can mean infrequent GC,
1865 // which in turn can mean large(r) numbers of ObjectMonitors in circulation.
1866 // This is an unfortunate aspect of this design.
1867 
1868 // Deflate a single monitor if not in-use
1869 // Return true if deflated, false if in-use
1870 bool ObjectSynchronizer::deflate_monitor(ObjectMonitor* mid, oop obj,
1871                                          ObjectMonitor** free_head_p,
1872                                          ObjectMonitor** free_tail_p) {
1873   bool deflated;
1874   // Normal case ... The monitor is associated with obj.
1875   const markWord mark = obj-&gt;mark();
1876   guarantee(mark == markWord::encode(mid), &quot;should match: mark=&quot;
1877             INTPTR_FORMAT &quot;, encoded mid=&quot; INTPTR_FORMAT, mark.value(),
1878             markWord::encode(mid).value());
1879   // Make sure that mark.monitor() and markWord::encode() agree:
1880   guarantee(mark.monitor() == mid, &quot;should match: monitor()=&quot; INTPTR_FORMAT
1881             &quot;, mid=&quot; INTPTR_FORMAT, p2i(mark.monitor()), p2i(mid));
1882   const markWord dmw = mid-&gt;header();
1883   guarantee(dmw.is_neutral(), &quot;invariant: header=&quot; INTPTR_FORMAT, dmw.value());
1884 
1885   if (mid-&gt;is_busy()) {
1886     // Easy checks are first - the ObjectMonitor is busy so no deflation.
1887     deflated = false;
1888   } else {
1889     // Deflate the monitor if it is no longer being used
1890     // It&#39;s idle - scavenge and return to the global free list
1891     // plain old deflation ...
1892     if (log_is_enabled(Trace, monitorinflation)) {
1893       ResourceMark rm;
1894       log_trace(monitorinflation)(&quot;deflate_monitor: &quot;
1895                                   &quot;object=&quot; INTPTR_FORMAT &quot;, mark=&quot;
1896                                   INTPTR_FORMAT &quot;, type=&#39;%s&#39;&quot;, p2i(obj),
1897                                   mark.value(), obj-&gt;klass()-&gt;external_name());
1898     }
1899 
1900     // Restore the header back to obj
1901     obj-&gt;release_set_mark(dmw);
1902     mid-&gt;clear();
1903 
1904     assert(mid-&gt;object() == NULL, &quot;invariant: object=&quot; INTPTR_FORMAT,
1905            p2i(mid-&gt;object()));
1906 
1907     // Move the deflated ObjectMonitor to the working free list
1908     // defined by free_head_p and free_tail_p.
1909     if (*free_head_p == NULL) *free_head_p = mid;
1910     if (*free_tail_p != NULL) {
1911       // We append to the list so the caller can use mid-&gt;_next_om
1912       // to fix the linkages in its context.
1913       ObjectMonitor* prevtail = *free_tail_p;
1914       // Should have been cleaned up by the caller:
1915       // Note: Should not have to lock prevtail here since we&#39;re at a
1916       // safepoint and ObjectMonitors on the local free list should
1917       // not be accessed in parallel.
1918 #ifdef ASSERT
1919       ObjectMonitor* l_next_om = prevtail-&gt;next_om();
1920 #endif
1921       assert(l_next_om == NULL, &quot;must be NULL: _next_om=&quot; INTPTR_FORMAT, p2i(l_next_om));
1922       prevtail-&gt;set_next_om(mid);
1923     }
1924     *free_tail_p = mid;
1925     // At this point, mid-&gt;_next_om still refers to its current
1926     // value and another ObjectMonitor&#39;s _next_om field still
1927     // refers to this ObjectMonitor. Those linkages have to be
1928     // cleaned up by the caller who has the complete context.
1929     deflated = true;
1930   }
1931   return deflated;
1932 }
1933 
1934 // Walk a given monitor list, and deflate idle monitors.
1935 // The given list could be a per-thread list or a global list.
1936 //
1937 // In the case of parallel processing of thread local monitor lists,
1938 // work is done by Threads::parallel_threads_do() which ensures that
1939 // each Java thread is processed by exactly one worker thread, and
1940 // thus avoid conflicts that would arise when worker threads would
1941 // process the same monitor lists concurrently.
1942 //
1943 // See also ParallelSPCleanupTask and
1944 // SafepointSynchronize::do_cleanup_tasks() in safepoint.cpp and
1945 // Threads::parallel_java_threads_do() in thread.cpp.
1946 int ObjectSynchronizer::deflate_monitor_list(ObjectMonitor** list_p,
1947                                              int* count_p,
1948                                              ObjectMonitor** free_head_p,
1949                                              ObjectMonitor** free_tail_p) {
1950   ObjectMonitor* cur_mid_in_use = NULL;
1951   ObjectMonitor* mid = NULL;
1952   ObjectMonitor* next = NULL;
1953   int deflated_count = 0;
1954 
1955   // This list walk executes at a safepoint and does not race with any
1956   // other list walkers.
1957 
1958   for (mid = Atomic::load(list_p); mid != NULL; mid = next) {
1959     next = unmarked_next(mid);
1960     oop obj = (oop) mid-&gt;object();
1961     if (obj != NULL &amp;&amp; deflate_monitor(mid, obj, free_head_p, free_tail_p)) {
1962       // Deflation succeeded and already updated free_head_p and
1963       // free_tail_p as needed. Finish the move to the local free list
1964       // by unlinking mid from the global or per-thread in-use list.
1965       if (cur_mid_in_use == NULL) {
1966         // mid is the list head so switch the list head to next:
1967         Atomic::store(list_p, next);
1968       } else {
1969         // Switch cur_mid_in_use&#39;s next field to next:
1970         cur_mid_in_use-&gt;set_next_om(next);
1971       }
1972       // At this point mid is disconnected from the in-use list.
1973       deflated_count++;
1974       Atomic::dec(count_p);
1975       // mid is current tail in the free_head_p list so NULL terminate it:
1976       mid-&gt;set_next_om(NULL);
1977     } else {
1978       cur_mid_in_use = mid;
1979     }
1980   }
1981   return deflated_count;
1982 }
1983 
1984 void ObjectSynchronizer::prepare_deflate_idle_monitors(DeflateMonitorCounters* counters) {
1985   counters-&gt;n_in_use = 0;              // currently associated with objects
1986   counters-&gt;n_in_circulation = 0;      // extant
1987   counters-&gt;n_scavenged = 0;           // reclaimed (global and per-thread)
1988   counters-&gt;per_thread_scavenged = 0;  // per-thread scavenge total
1989   counters-&gt;per_thread_times = 0.0;    // per-thread scavenge times
1990 }
1991 
1992 void ObjectSynchronizer::deflate_idle_monitors(DeflateMonitorCounters* counters) {
1993   assert(SafepointSynchronize::is_at_safepoint(), &quot;must be at safepoint&quot;);
1994   bool deflated = false;
1995 
1996   ObjectMonitor* free_head_p = NULL;  // Local SLL of scavenged monitors
1997   ObjectMonitor* free_tail_p = NULL;
1998   elapsedTimer timer;
1999 
2000   if (log_is_enabled(Info, monitorinflation)) {
2001     timer.start();
2002   }
2003 
2004   // Note: the thread-local monitors lists get deflated in
2005   // a separate pass. See deflate_thread_local_monitors().
2006 
2007   // For moribund threads, scan om_list_globals._in_use_list
2008   int deflated_count = 0;
2009   if (Atomic::load(&amp;om_list_globals._in_use_list) != NULL) {
2010     // Update n_in_circulation before om_list_globals._in_use_count is
2011     // updated by deflation.
2012     Atomic::add(&amp;counters-&gt;n_in_circulation,
2013                 Atomic::load(&amp;om_list_globals._in_use_count));
2014 
2015     deflated_count = deflate_monitor_list(&amp;om_list_globals._in_use_list,
2016                                           &amp;om_list_globals._in_use_count,
2017                                           &amp;free_head_p, &amp;free_tail_p);
2018     Atomic::add(&amp;counters-&gt;n_in_use, Atomic::load(&amp;om_list_globals._in_use_count));
2019   }
2020 
2021   if (free_head_p != NULL) {
2022     // Move the deflated ObjectMonitors back to the global free list.
2023     guarantee(free_tail_p != NULL &amp;&amp; deflated_count &gt; 0, &quot;invariant&quot;);
2024 #ifdef ASSERT
2025     ObjectMonitor* l_next_om = free_tail_p-&gt;next_om();
2026 #endif
2027     assert(l_next_om == NULL, &quot;must be NULL: _next_om=&quot; INTPTR_FORMAT, p2i(l_next_om));
2028     prepend_list_to_global_free_list(free_head_p, free_tail_p, deflated_count);
2029     Atomic::add(&amp;counters-&gt;n_scavenged, deflated_count);
2030   }
2031   timer.stop();
2032 
2033   LogStreamHandle(Debug, monitorinflation) lsh_debug;
2034   LogStreamHandle(Info, monitorinflation) lsh_info;
2035   LogStream* ls = NULL;
2036   if (log_is_enabled(Debug, monitorinflation)) {
2037     ls = &amp;lsh_debug;
2038   } else if (deflated_count != 0 &amp;&amp; log_is_enabled(Info, monitorinflation)) {
2039     ls = &amp;lsh_info;
2040   }
2041   if (ls != NULL) {
2042     ls-&gt;print_cr(&quot;deflating global idle monitors, %3.7f secs, %d monitors&quot;, timer.seconds(), deflated_count);
2043   }
2044 }
2045 
2046 void ObjectSynchronizer::finish_deflate_idle_monitors(DeflateMonitorCounters* counters) {
2047   // Report the cumulative time for deflating each thread&#39;s idle
2048   // monitors. Note: if the work is split among more than one
2049   // worker thread, then the reported time will likely be more
2050   // than a beginning to end measurement of the phase.
2051   log_info(safepoint, cleanup)(&quot;deflating per-thread idle monitors, %3.7f secs, monitors=%d&quot;, counters-&gt;per_thread_times, counters-&gt;per_thread_scavenged);
2052 
2053   if (log_is_enabled(Debug, monitorinflation)) {
2054     // exit_globals()&#39;s call to audit_and_print_stats() is done
2055     // at the Info level and not at a safepoint.
2056     ObjectSynchronizer::audit_and_print_stats(false /* on_exit */);
2057   } else if (log_is_enabled(Info, monitorinflation)) {
2058     log_info(monitorinflation)(&quot;global_population=%d, global_in_use_count=%d, &quot;
2059                                &quot;global_free_count=%d&quot;,
2060                                Atomic::load(&amp;om_list_globals._population),
2061                                Atomic::load(&amp;om_list_globals._in_use_count),
2062                                Atomic::load(&amp;om_list_globals._free_count));
2063   }
2064 
<a name="5" id="anc5"></a><span class="line-removed">2065   Atomic::store(&amp;_forceMonitorScavenge, 0);    // Reset</span>
<span class="line-removed">2066 </span>
2067   OM_PERFDATA_OP(Deflations, inc(counters-&gt;n_scavenged));
2068   OM_PERFDATA_OP(MonExtant, set_value(counters-&gt;n_in_circulation));
2069 
2070   GVars.stw_random = os::random();
2071   GVars.stw_cycle++;
2072 }
2073 
2074 void ObjectSynchronizer::deflate_thread_local_monitors(Thread* thread, DeflateMonitorCounters* counters) {
2075   assert(SafepointSynchronize::is_at_safepoint(), &quot;must be at safepoint&quot;);
2076 
2077   ObjectMonitor* free_head_p = NULL;  // Local SLL of scavenged monitors
2078   ObjectMonitor* free_tail_p = NULL;
2079   elapsedTimer timer;
2080 
2081   if (log_is_enabled(Info, safepoint, cleanup) ||
2082       log_is_enabled(Info, monitorinflation)) {
2083     timer.start();
2084   }
2085 
2086   // Update n_in_circulation before om_in_use_count is updated by deflation.
2087   Atomic::add(&amp;counters-&gt;n_in_circulation, Atomic::load(&amp;thread-&gt;om_in_use_count));
2088 
2089   int deflated_count = deflate_monitor_list(&amp;thread-&gt;om_in_use_list, &amp;thread-&gt;om_in_use_count, &amp;free_head_p, &amp;free_tail_p);
2090   Atomic::add(&amp;counters-&gt;n_in_use, Atomic::load(&amp;thread-&gt;om_in_use_count));
2091 
2092   if (free_head_p != NULL) {
2093     // Move the deflated ObjectMonitors back to the global free list.
2094     guarantee(free_tail_p != NULL &amp;&amp; deflated_count &gt; 0, &quot;invariant&quot;);
2095 #ifdef ASSERT
2096     ObjectMonitor* l_next_om = free_tail_p-&gt;next_om();
2097 #endif
2098     assert(l_next_om == NULL, &quot;must be NULL: _next_om=&quot; INTPTR_FORMAT, p2i(l_next_om));
2099     prepend_list_to_global_free_list(free_head_p, free_tail_p, deflated_count);
2100     Atomic::add(&amp;counters-&gt;n_scavenged, deflated_count);
2101     Atomic::add(&amp;counters-&gt;per_thread_scavenged, deflated_count);
2102   }
2103 
2104   timer.stop();
2105   counters-&gt;per_thread_times += timer.seconds();
2106 
2107   LogStreamHandle(Debug, monitorinflation) lsh_debug;
2108   LogStreamHandle(Info, monitorinflation) lsh_info;
2109   LogStream* ls = NULL;
2110   if (log_is_enabled(Debug, monitorinflation)) {
2111     ls = &amp;lsh_debug;
2112   } else if (deflated_count != 0 &amp;&amp; log_is_enabled(Info, monitorinflation)) {
2113     ls = &amp;lsh_info;
2114   }
2115   if (ls != NULL) {
2116     ls-&gt;print_cr(&quot;jt=&quot; INTPTR_FORMAT &quot;: deflating per-thread idle monitors, %3.7f secs, %d monitors&quot;, p2i(thread), timer.seconds(), deflated_count);
2117   }
2118 }
2119 
2120 // Monitor cleanup on JavaThread::exit
2121 
2122 // Iterate through monitor cache and attempt to release thread&#39;s monitors
2123 // Gives up on a particular monitor if an exception occurs, but continues
2124 // the overall iteration, swallowing the exception.
2125 class ReleaseJavaMonitorsClosure: public MonitorClosure {
2126  private:
2127   TRAPS;
2128 
2129  public:
2130   ReleaseJavaMonitorsClosure(Thread* thread) : THREAD(thread) {}
2131   void do_monitor(ObjectMonitor* mid) {
2132     if (mid-&gt;owner() == THREAD) {
2133       (void)mid-&gt;complete_exit(CHECK);
2134     }
2135   }
2136 };
2137 
2138 // Release all inflated monitors owned by THREAD.  Lightweight monitors are
2139 // ignored.  This is meant to be called during JNI thread detach which assumes
2140 // all remaining monitors are heavyweight.  All exceptions are swallowed.
2141 // Scanning the extant monitor list can be time consuming.
2142 // A simple optimization is to add a per-thread flag that indicates a thread
2143 // called jni_monitorenter() during its lifetime.
2144 //
2145 // Instead of No_Savepoint_Verifier it might be cheaper to
2146 // use an idiom of the form:
2147 //   auto int tmp = SafepointSynchronize::_safepoint_counter ;
2148 //   &lt;code that must not run at safepoint&gt;
2149 //   guarantee (((tmp ^ _safepoint_counter) | (tmp &amp; 1)) == 0) ;
2150 // Since the tests are extremely cheap we could leave them enabled
2151 // for normal product builds.
2152 
2153 void ObjectSynchronizer::release_monitors_owned_by_thread(TRAPS) {
2154   assert(THREAD == JavaThread::current(), &quot;must be current Java thread&quot;);
2155   NoSafepointVerifier nsv;
2156   ReleaseJavaMonitorsClosure rjmc(THREAD);
2157   ObjectSynchronizer::monitors_iterate(&amp;rjmc);
2158   THREAD-&gt;clear_pending_exception();
2159 }
2160 
2161 const char* ObjectSynchronizer::inflate_cause_name(const InflateCause cause) {
2162   switch (cause) {
2163     case inflate_cause_vm_internal:    return &quot;VM Internal&quot;;
2164     case inflate_cause_monitor_enter:  return &quot;Monitor Enter&quot;;
2165     case inflate_cause_wait:           return &quot;Monitor Wait&quot;;
2166     case inflate_cause_notify:         return &quot;Monitor Notify&quot;;
2167     case inflate_cause_hash_code:      return &quot;Monitor Hash Code&quot;;
2168     case inflate_cause_jni_enter:      return &quot;JNI Monitor Enter&quot;;
2169     case inflate_cause_jni_exit:       return &quot;JNI Monitor Exit&quot;;
2170     default:
2171       ShouldNotReachHere();
2172   }
2173   return &quot;Unknown&quot;;
2174 }
2175 
2176 //------------------------------------------------------------------------------
2177 // Debugging code
2178 
2179 u_char* ObjectSynchronizer::get_gvars_addr() {
2180   return (u_char*)&amp;GVars;
2181 }
2182 
2183 u_char* ObjectSynchronizer::get_gvars_hc_sequence_addr() {
2184   return (u_char*)&amp;GVars.hc_sequence;
2185 }
2186 
2187 size_t ObjectSynchronizer::get_gvars_size() {
2188   return sizeof(SharedGlobals);
2189 }
2190 
2191 u_char* ObjectSynchronizer::get_gvars_stw_random_addr() {
2192   return (u_char*)&amp;GVars.stw_random;
2193 }
2194 
2195 // This function can be called at a safepoint or it can be called when
2196 // we are trying to exit the VM. When we are trying to exit the VM, the
2197 // list walker functions can run in parallel with the other list
2198 // operations so spin-locking is used for safety.
2199 //
2200 // Calls to this function can be added in various places as a debugging
2201 // aid; pass &#39;true&#39; for the &#39;on_exit&#39; parameter to have in-use monitor
2202 // details logged at the Info level and &#39;false&#39; for the &#39;on_exit&#39;
2203 // parameter to have in-use monitor details logged at the Trace level.
2204 // deflate_monitor_list() no longer uses spin-locking so be careful
2205 // when adding audit_and_print_stats() calls at a safepoint.
2206 //
2207 void ObjectSynchronizer::audit_and_print_stats(bool on_exit) {
2208   assert(on_exit || SafepointSynchronize::is_at_safepoint(), &quot;invariant&quot;);
2209 
2210   LogStreamHandle(Debug, monitorinflation) lsh_debug;
2211   LogStreamHandle(Info, monitorinflation) lsh_info;
2212   LogStreamHandle(Trace, monitorinflation) lsh_trace;
2213   LogStream* ls = NULL;
2214   if (log_is_enabled(Trace, monitorinflation)) {
2215     ls = &amp;lsh_trace;
2216   } else if (log_is_enabled(Debug, monitorinflation)) {
2217     ls = &amp;lsh_debug;
2218   } else if (log_is_enabled(Info, monitorinflation)) {
2219     ls = &amp;lsh_info;
2220   }
2221   assert(ls != NULL, &quot;sanity check&quot;);
2222 
2223   // Log counts for the global and per-thread monitor lists:
2224   int chk_om_population = log_monitor_list_counts(ls);
2225   int error_cnt = 0;
2226 
2227   ls-&gt;print_cr(&quot;Checking global lists:&quot;);
2228 
2229   // Check om_list_globals._population:
2230   if (Atomic::load(&amp;om_list_globals._population) == chk_om_population) {
2231     ls-&gt;print_cr(&quot;global_population=%d equals chk_om_population=%d&quot;,
2232                  Atomic::load(&amp;om_list_globals._population), chk_om_population);
2233   } else {
2234     // With fine grained locks on the monitor lists, it is possible for
2235     // log_monitor_list_counts() to return a value that doesn&#39;t match
2236     // om_list_globals._population. So far a higher value has been
2237     // seen in testing so something is being double counted by
2238     // log_monitor_list_counts().
2239     ls-&gt;print_cr(&quot;WARNING: global_population=%d is not equal to &quot;
2240                  &quot;chk_om_population=%d&quot;,
2241                  Atomic::load(&amp;om_list_globals._population), chk_om_population);
2242   }
2243 
2244   // Check om_list_globals._in_use_list and om_list_globals._in_use_count:
2245   chk_global_in_use_list_and_count(ls, &amp;error_cnt);
2246 
2247   // Check om_list_globals._free_list and om_list_globals._free_count:
2248   chk_global_free_list_and_count(ls, &amp;error_cnt);
2249 
2250   ls-&gt;print_cr(&quot;Checking per-thread lists:&quot;);
2251 
2252   for (JavaThreadIteratorWithHandle jtiwh; JavaThread *jt = jtiwh.next(); ) {
2253     // Check om_in_use_list and om_in_use_count:
2254     chk_per_thread_in_use_list_and_count(jt, ls, &amp;error_cnt);
2255 
2256     // Check om_free_list and om_free_count:
2257     chk_per_thread_free_list_and_count(jt, ls, &amp;error_cnt);
2258   }
2259 
2260   if (error_cnt == 0) {
2261     ls-&gt;print_cr(&quot;No errors found in monitor list checks.&quot;);
2262   } else {
2263     log_error(monitorinflation)(&quot;found monitor list errors: error_cnt=%d&quot;, error_cnt);
2264   }
2265 
2266   if ((on_exit &amp;&amp; log_is_enabled(Info, monitorinflation)) ||
2267       (!on_exit &amp;&amp; log_is_enabled(Trace, monitorinflation))) {
2268     // When exiting this log output is at the Info level. When called
2269     // at a safepoint, this log output is at the Trace level since
2270     // there can be a lot of it.
2271     log_in_use_monitor_details(ls);
2272   }
2273 
2274   ls-&gt;flush();
2275 
2276   guarantee(error_cnt == 0, &quot;ERROR: found monitor list errors: error_cnt=%d&quot;, error_cnt);
2277 }
2278 
2279 // Check a free monitor entry; log any errors.
2280 void ObjectSynchronizer::chk_free_entry(JavaThread* jt, ObjectMonitor* n,
2281                                         outputStream * out, int *error_cnt_p) {
2282   stringStream ss;
2283   if (n-&gt;is_busy()) {
2284     if (jt != NULL) {
2285       out-&gt;print_cr(&quot;ERROR: jt=&quot; INTPTR_FORMAT &quot;, monitor=&quot; INTPTR_FORMAT
2286                     &quot;: free per-thread monitor must not be busy: %s&quot;, p2i(jt),
2287                     p2i(n), n-&gt;is_busy_to_string(&amp;ss));
2288     } else {
2289       out-&gt;print_cr(&quot;ERROR: monitor=&quot; INTPTR_FORMAT &quot;: free global monitor &quot;
2290                     &quot;must not be busy: %s&quot;, p2i(n), n-&gt;is_busy_to_string(&amp;ss));
2291     }
2292     *error_cnt_p = *error_cnt_p + 1;
2293   }
2294   if (n-&gt;header().value() != 0) {
2295     if (jt != NULL) {
2296       out-&gt;print_cr(&quot;ERROR: jt=&quot; INTPTR_FORMAT &quot;, monitor=&quot; INTPTR_FORMAT
2297                     &quot;: free per-thread monitor must have NULL _header &quot;
2298                     &quot;field: _header=&quot; INTPTR_FORMAT, p2i(jt), p2i(n),
2299                     n-&gt;header().value());
2300     } else {
2301       out-&gt;print_cr(&quot;ERROR: monitor=&quot; INTPTR_FORMAT &quot;: free global monitor &quot;
2302                     &quot;must have NULL _header field: _header=&quot; INTPTR_FORMAT,
2303                     p2i(n), n-&gt;header().value());
2304     }
2305     *error_cnt_p = *error_cnt_p + 1;
2306   }
2307   if (n-&gt;object() != NULL) {
2308     if (jt != NULL) {
2309       out-&gt;print_cr(&quot;ERROR: jt=&quot; INTPTR_FORMAT &quot;, monitor=&quot; INTPTR_FORMAT
2310                     &quot;: free per-thread monitor must have NULL _object &quot;
2311                     &quot;field: _object=&quot; INTPTR_FORMAT, p2i(jt), p2i(n),
2312                     p2i(n-&gt;object()));
2313     } else {
2314       out-&gt;print_cr(&quot;ERROR: monitor=&quot; INTPTR_FORMAT &quot;: free global monitor &quot;
2315                     &quot;must have NULL _object field: _object=&quot; INTPTR_FORMAT,
2316                     p2i(n), p2i(n-&gt;object()));
2317     }
2318     *error_cnt_p = *error_cnt_p + 1;
2319   }
2320 }
2321 
2322 // Lock the next ObjectMonitor for traversal and unlock the current
2323 // ObjectMonitor. Returns the next ObjectMonitor if there is one.
2324 // Otherwise returns NULL (after unlocking the current ObjectMonitor).
2325 // This function is used by the various list walker functions to
2326 // safely walk a list without allowing an ObjectMonitor to be moved
2327 // to another list in the middle of a walk.
2328 static ObjectMonitor* lock_next_for_traversal(ObjectMonitor* cur) {
2329   assert(is_locked(cur), &quot;cur=&quot; INTPTR_FORMAT &quot; must be locked&quot;, p2i(cur));
2330   ObjectMonitor* next = unmarked_next(cur);
2331   if (next == NULL) {  // Reached the end of the list.
2332     om_unlock(cur);
2333     return NULL;
2334   }
2335   om_lock(next);   // Lock next before unlocking current to keep
2336   om_unlock(cur);  // from being by-passed by another thread.
2337   return next;
2338 }
2339 
2340 // Check the global free list and count; log the results of the checks.
2341 void ObjectSynchronizer::chk_global_free_list_and_count(outputStream * out,
2342                                                         int *error_cnt_p) {
2343   int chk_om_free_count = 0;
2344   ObjectMonitor* cur = NULL;
2345   if ((cur = get_list_head_locked(&amp;om_list_globals._free_list)) != NULL) {
2346     // Marked the global free list head so process the list.
2347     while (true) {
2348       chk_free_entry(NULL /* jt */, cur, out, error_cnt_p);
2349       chk_om_free_count++;
2350 
2351       cur = lock_next_for_traversal(cur);
2352       if (cur == NULL) {
2353         break;
2354       }
2355     }
2356   }
2357   int l_free_count = Atomic::load(&amp;om_list_globals._free_count);
2358   if (l_free_count == chk_om_free_count) {
2359     out-&gt;print_cr(&quot;global_free_count=%d equals chk_om_free_count=%d&quot;,
2360                   l_free_count, chk_om_free_count);
2361   } else {
2362     // With fine grained locks on om_list_globals._free_list, it
2363     // is possible for an ObjectMonitor to be prepended to
2364     // om_list_globals._free_list after we started calculating
2365     // chk_om_free_count so om_list_globals._free_count may not
2366     // match anymore.
2367     out-&gt;print_cr(&quot;WARNING: global_free_count=%d is not equal to &quot;
2368                   &quot;chk_om_free_count=%d&quot;, l_free_count, chk_om_free_count);
2369   }
2370 }
2371 
2372 // Check the global in-use list and count; log the results of the checks.
2373 void ObjectSynchronizer::chk_global_in_use_list_and_count(outputStream * out,
2374                                                           int *error_cnt_p) {
2375   int chk_om_in_use_count = 0;
2376   ObjectMonitor* cur = NULL;
2377   if ((cur = get_list_head_locked(&amp;om_list_globals._in_use_list)) != NULL) {
2378     // Marked the global in-use list head so process the list.
2379     while (true) {
2380       chk_in_use_entry(NULL /* jt */, cur, out, error_cnt_p);
2381       chk_om_in_use_count++;
2382 
2383       cur = lock_next_for_traversal(cur);
2384       if (cur == NULL) {
2385         break;
2386       }
2387     }
2388   }
2389   int l_in_use_count = Atomic::load(&amp;om_list_globals._in_use_count);
2390   if (l_in_use_count == chk_om_in_use_count) {
2391     out-&gt;print_cr(&quot;global_in_use_count=%d equals chk_om_in_use_count=%d&quot;,
2392                   l_in_use_count, chk_om_in_use_count);
2393   } else {
2394     // With fine grained locks on the monitor lists, it is possible for
2395     // an exiting JavaThread to put its in-use ObjectMonitors on the
2396     // global in-use list after chk_om_in_use_count is calculated above.
2397     out-&gt;print_cr(&quot;WARNING: global_in_use_count=%d is not equal to chk_om_in_use_count=%d&quot;,
2398                   l_in_use_count, chk_om_in_use_count);
2399   }
2400 }
2401 
2402 // Check an in-use monitor entry; log any errors.
2403 void ObjectSynchronizer::chk_in_use_entry(JavaThread* jt, ObjectMonitor* n,
2404                                           outputStream * out, int *error_cnt_p) {
2405   if (n-&gt;header().value() == 0) {
2406     if (jt != NULL) {
2407       out-&gt;print_cr(&quot;ERROR: jt=&quot; INTPTR_FORMAT &quot;, monitor=&quot; INTPTR_FORMAT
2408                     &quot;: in-use per-thread monitor must have non-NULL _header &quot;
2409                     &quot;field.&quot;, p2i(jt), p2i(n));
2410     } else {
2411       out-&gt;print_cr(&quot;ERROR: monitor=&quot; INTPTR_FORMAT &quot;: in-use global monitor &quot;
2412                     &quot;must have non-NULL _header field.&quot;, p2i(n));
2413     }
2414     *error_cnt_p = *error_cnt_p + 1;
2415   }
2416   if (n-&gt;object() == NULL) {
2417     if (jt != NULL) {
2418       out-&gt;print_cr(&quot;ERROR: jt=&quot; INTPTR_FORMAT &quot;, monitor=&quot; INTPTR_FORMAT
2419                     &quot;: in-use per-thread monitor must have non-NULL _object &quot;
2420                     &quot;field.&quot;, p2i(jt), p2i(n));
2421     } else {
2422       out-&gt;print_cr(&quot;ERROR: monitor=&quot; INTPTR_FORMAT &quot;: in-use global monitor &quot;
2423                     &quot;must have non-NULL _object field.&quot;, p2i(n));
2424     }
2425     *error_cnt_p = *error_cnt_p + 1;
2426   }
2427   const oop obj = (oop)n-&gt;object();
2428   const markWord mark = obj-&gt;mark();
2429   if (!mark.has_monitor()) {
2430     if (jt != NULL) {
2431       out-&gt;print_cr(&quot;ERROR: jt=&quot; INTPTR_FORMAT &quot;, monitor=&quot; INTPTR_FORMAT
2432                     &quot;: in-use per-thread monitor&#39;s object does not think &quot;
2433                     &quot;it has a monitor: obj=&quot; INTPTR_FORMAT &quot;, mark=&quot;
2434                     INTPTR_FORMAT,  p2i(jt), p2i(n), p2i(obj), mark.value());
2435     } else {
2436       out-&gt;print_cr(&quot;ERROR: monitor=&quot; INTPTR_FORMAT &quot;: in-use global &quot;
2437                     &quot;monitor&#39;s object does not think it has a monitor: obj=&quot;
2438                     INTPTR_FORMAT &quot;, mark=&quot; INTPTR_FORMAT, p2i(n),
2439                     p2i(obj), mark.value());
2440     }
2441     *error_cnt_p = *error_cnt_p + 1;
2442   }
2443   ObjectMonitor* const obj_mon = mark.monitor();
2444   if (n != obj_mon) {
2445     if (jt != NULL) {
2446       out-&gt;print_cr(&quot;ERROR: jt=&quot; INTPTR_FORMAT &quot;, monitor=&quot; INTPTR_FORMAT
2447                     &quot;: in-use per-thread monitor&#39;s object does not refer &quot;
2448                     &quot;to the same monitor: obj=&quot; INTPTR_FORMAT &quot;, mark=&quot;
2449                     INTPTR_FORMAT &quot;, obj_mon=&quot; INTPTR_FORMAT, p2i(jt),
2450                     p2i(n), p2i(obj), mark.value(), p2i(obj_mon));
2451     } else {
2452       out-&gt;print_cr(&quot;ERROR: monitor=&quot; INTPTR_FORMAT &quot;: in-use global &quot;
2453                     &quot;monitor&#39;s object does not refer to the same monitor: obj=&quot;
2454                     INTPTR_FORMAT &quot;, mark=&quot; INTPTR_FORMAT &quot;, obj_mon=&quot;
2455                     INTPTR_FORMAT, p2i(n), p2i(obj), mark.value(), p2i(obj_mon));
2456     }
2457     *error_cnt_p = *error_cnt_p + 1;
2458   }
2459 }
2460 
2461 // Check the thread&#39;s free list and count; log the results of the checks.
2462 void ObjectSynchronizer::chk_per_thread_free_list_and_count(JavaThread *jt,
2463                                                             outputStream * out,
2464                                                             int *error_cnt_p) {
2465   int chk_om_free_count = 0;
2466   ObjectMonitor* cur = NULL;
2467   if ((cur = get_list_head_locked(&amp;jt-&gt;om_free_list)) != NULL) {
2468     // Marked the per-thread free list head so process the list.
2469     while (true) {
2470       chk_free_entry(jt, cur, out, error_cnt_p);
2471       chk_om_free_count++;
2472 
2473       cur = lock_next_for_traversal(cur);
2474       if (cur == NULL) {
2475         break;
2476       }
2477     }
2478   }
2479   int l_om_free_count = Atomic::load(&amp;jt-&gt;om_free_count);
2480   if (l_om_free_count == chk_om_free_count) {
2481     out-&gt;print_cr(&quot;jt=&quot; INTPTR_FORMAT &quot;: om_free_count=%d equals &quot;
2482                   &quot;chk_om_free_count=%d&quot;, p2i(jt), l_om_free_count, chk_om_free_count);
2483   } else {
2484     out-&gt;print_cr(&quot;ERROR: jt=&quot; INTPTR_FORMAT &quot;: om_free_count=%d is not &quot;
2485                   &quot;equal to chk_om_free_count=%d&quot;, p2i(jt), l_om_free_count,
2486                   chk_om_free_count);
2487     *error_cnt_p = *error_cnt_p + 1;
2488   }
2489 }
2490 
2491 // Check the thread&#39;s in-use list and count; log the results of the checks.
2492 void ObjectSynchronizer::chk_per_thread_in_use_list_and_count(JavaThread *jt,
2493                                                               outputStream * out,
2494                                                               int *error_cnt_p) {
2495   int chk_om_in_use_count = 0;
2496   ObjectMonitor* cur = NULL;
2497   if ((cur = get_list_head_locked(&amp;jt-&gt;om_in_use_list)) != NULL) {
2498     // Marked the per-thread in-use list head so process the list.
2499     while (true) {
2500       chk_in_use_entry(jt, cur, out, error_cnt_p);
2501       chk_om_in_use_count++;
2502 
2503       cur = lock_next_for_traversal(cur);
2504       if (cur == NULL) {
2505         break;
2506       }
2507     }
2508   }
2509   int l_om_in_use_count = Atomic::load(&amp;jt-&gt;om_in_use_count);
2510   if (l_om_in_use_count == chk_om_in_use_count) {
2511     out-&gt;print_cr(&quot;jt=&quot; INTPTR_FORMAT &quot;: om_in_use_count=%d equals &quot;
2512                   &quot;chk_om_in_use_count=%d&quot;, p2i(jt), l_om_in_use_count,
2513                   chk_om_in_use_count);
2514   } else {
2515     out-&gt;print_cr(&quot;ERROR: jt=&quot; INTPTR_FORMAT &quot;: om_in_use_count=%d is not &quot;
2516                   &quot;equal to chk_om_in_use_count=%d&quot;, p2i(jt), l_om_in_use_count,
2517                   chk_om_in_use_count);
2518     *error_cnt_p = *error_cnt_p + 1;
2519   }
2520 }
2521 
2522 // Log details about ObjectMonitors on the in-use lists. The &#39;BHL&#39;
2523 // flags indicate why the entry is in-use, &#39;object&#39; and &#39;object type&#39;
2524 // indicate the associated object and its type.
2525 void ObjectSynchronizer::log_in_use_monitor_details(outputStream * out) {
2526   stringStream ss;
2527   if (Atomic::load(&amp;om_list_globals._in_use_count) &gt; 0) {
2528     out-&gt;print_cr(&quot;In-use global monitor info:&quot;);
2529     out-&gt;print_cr(&quot;(B -&gt; is_busy, H -&gt; has hash code, L -&gt; lock status)&quot;);
2530     out-&gt;print_cr(&quot;%18s  %s  %18s  %18s&quot;,
2531                   &quot;monitor&quot;, &quot;BHL&quot;, &quot;object&quot;, &quot;object type&quot;);
2532     out-&gt;print_cr(&quot;==================  ===  ==================  ==================&quot;);
2533     ObjectMonitor* cur = NULL;
2534     if ((cur = get_list_head_locked(&amp;om_list_globals._in_use_list)) != NULL) {
2535       // Marked the global in-use list head so process the list.
2536       while (true) {
2537         const oop obj = (oop) cur-&gt;object();
2538         const markWord mark = cur-&gt;header();
2539         ResourceMark rm;
2540         out-&gt;print(INTPTR_FORMAT &quot;  %d%d%d  &quot; INTPTR_FORMAT &quot;  %s&quot;, p2i(cur),
2541                    cur-&gt;is_busy() != 0, mark.hash() != 0, cur-&gt;owner() != NULL,
2542                    p2i(obj), obj-&gt;klass()-&gt;external_name());
2543         if (cur-&gt;is_busy() != 0) {
2544           out-&gt;print(&quot; (%s)&quot;, cur-&gt;is_busy_to_string(&amp;ss));
2545           ss.reset();
2546         }
2547         out-&gt;cr();
2548 
2549         cur = lock_next_for_traversal(cur);
2550         if (cur == NULL) {
2551           break;
2552         }
2553       }
2554     }
2555   }
2556 
2557   out-&gt;print_cr(&quot;In-use per-thread monitor info:&quot;);
2558   out-&gt;print_cr(&quot;(B -&gt; is_busy, H -&gt; has hash code, L -&gt; lock status)&quot;);
2559   out-&gt;print_cr(&quot;%18s  %18s  %s  %18s  %18s&quot;,
2560                 &quot;jt&quot;, &quot;monitor&quot;, &quot;BHL&quot;, &quot;object&quot;, &quot;object type&quot;);
2561   out-&gt;print_cr(&quot;==================  ==================  ===  ==================  ==================&quot;);
2562   for (JavaThreadIteratorWithHandle jtiwh; JavaThread *jt = jtiwh.next(); ) {
2563     ObjectMonitor* cur = NULL;
2564     if ((cur = get_list_head_locked(&amp;jt-&gt;om_in_use_list)) != NULL) {
2565       // Marked the global in-use list head so process the list.
2566       while (true) {
2567         const oop obj = (oop) cur-&gt;object();
2568         const markWord mark = cur-&gt;header();
2569         ResourceMark rm;
2570         out-&gt;print(INTPTR_FORMAT &quot;  &quot; INTPTR_FORMAT &quot;  %d%d%d  &quot; INTPTR_FORMAT
2571                    &quot;  %s&quot;, p2i(jt), p2i(cur), cur-&gt;is_busy() != 0,
2572                    mark.hash() != 0, cur-&gt;owner() != NULL, p2i(obj),
2573                    obj-&gt;klass()-&gt;external_name());
2574         if (cur-&gt;is_busy() != 0) {
2575           out-&gt;print(&quot; (%s)&quot;, cur-&gt;is_busy_to_string(&amp;ss));
2576           ss.reset();
2577         }
2578         out-&gt;cr();
2579 
2580         cur = lock_next_for_traversal(cur);
2581         if (cur == NULL) {
2582           break;
2583         }
2584       }
2585     }
2586   }
2587 
2588   out-&gt;flush();
2589 }
2590 
2591 // Log counts for the global and per-thread monitor lists and return
2592 // the population count.
2593 int ObjectSynchronizer::log_monitor_list_counts(outputStream * out) {
2594   int pop_count = 0;
2595   out-&gt;print_cr(&quot;%18s  %10s  %10s  %10s&quot;,
2596                 &quot;Global Lists:&quot;, &quot;InUse&quot;, &quot;Free&quot;, &quot;Total&quot;);
2597   out-&gt;print_cr(&quot;==================  ==========  ==========  ==========&quot;);
2598   int l_in_use_count = Atomic::load(&amp;om_list_globals._in_use_count);
2599   int l_free_count = Atomic::load(&amp;om_list_globals._free_count);
2600   out-&gt;print_cr(&quot;%18s  %10d  %10d  %10d&quot;, &quot;&quot;, l_in_use_count,
2601                 l_free_count, Atomic::load(&amp;om_list_globals._population));
2602   pop_count += l_in_use_count + l_free_count;
2603 
2604   out-&gt;print_cr(&quot;%18s  %10s  %10s  %10s&quot;,
2605                 &quot;Per-Thread Lists:&quot;, &quot;InUse&quot;, &quot;Free&quot;, &quot;Provision&quot;);
2606   out-&gt;print_cr(&quot;==================  ==========  ==========  ==========&quot;);
2607 
2608   for (JavaThreadIteratorWithHandle jtiwh; JavaThread *jt = jtiwh.next(); ) {
2609     int l_om_in_use_count = Atomic::load(&amp;jt-&gt;om_in_use_count);
2610     int l_om_free_count = Atomic::load(&amp;jt-&gt;om_free_count);
2611     out-&gt;print_cr(INTPTR_FORMAT &quot;  %10d  %10d  %10d&quot;, p2i(jt),
2612                   l_om_in_use_count, l_om_free_count, jt-&gt;om_free_provision);
2613     pop_count += l_om_in_use_count + l_om_free_count;
2614   }
2615   return pop_count;
2616 }
2617 
2618 #ifndef PRODUCT
2619 
2620 // Check if monitor belongs to the monitor cache
2621 // The list is grow-only so it&#39;s *relatively* safe to traverse
2622 // the list of extant blocks without taking a lock.
2623 
2624 int ObjectSynchronizer::verify_objmon_isinpool(ObjectMonitor *monitor) {
2625   PaddedObjectMonitor* block = Atomic::load(&amp;g_block_list);
2626   while (block != NULL) {
2627     assert(block-&gt;object() == CHAINMARKER, &quot;must be a block header&quot;);
2628     if (monitor &gt; &amp;block[0] &amp;&amp; monitor &lt; &amp;block[_BLOCKSIZE]) {
2629       address mon = (address)monitor;
2630       address blk = (address)block;
2631       size_t diff = mon - blk;
2632       assert((diff % sizeof(PaddedObjectMonitor)) == 0, &quot;must be aligned&quot;);
2633       return 1;
2634     }
2635     // unmarked_next() is not needed with g_block_list (no locking
2636     // used with block linkage _next_om fields).
2637     block = (PaddedObjectMonitor*)block-&gt;next_om();
2638   }
2639   return 0;
2640 }
2641 
2642 #endif
<a name="6" id="anc6"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="6" type="hidden" />
</body>
</html>