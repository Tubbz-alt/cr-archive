<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff src/hotspot/share/classfile/classLoader.cpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
  </head>
<body>
<center><a href="../../cpu/aarch64/aarch64.ad.udiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="systemDictionary.cpp.udiff.html" target="_top">next &gt;</a></center>    <h2>src/hotspot/share/classfile/classLoader.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -93,10 +93,11 @@</span>
  static ZipClose_t        ZipClose           = NULL;
  static FindEntry_t       FindEntry          = NULL;
  static ReadEntry_t       ReadEntry          = NULL;
  static GetNextEntry_t    GetNextEntry       = NULL;
  static Crc32_t           Crc32              = NULL;
<span class="udiff-line-added">+ int ClassLoader::_libzip_loaded = 0;</span>
  
  // Entry points for jimage.dll for loading jimage file entries
  
  static JImageOpen_t                    JImageOpen             = NULL;
  static JImageClose_t                   JImageClose            = NULL;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -745,10 +746,11 @@</span>
        jzfile* zip;
        {
          // enable call to C land
          ThreadToNativeFromVM ttn(thread);
          HandleMark hm(thread);
<span class="udiff-line-added">+         load_zip_library_if_needed();</span>
          zip = (*ZipOpen)(canonical_path, &amp;error_msg);
        }
        if (zip != NULL &amp;&amp; error_msg == NULL) {
          new_entry = new ClassPathZipEntry(zip, path, is_boot_append, from_class_path_attr);
        } else {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -794,10 +796,11 @@</span>
          {
            // enable call to C land
            JavaThread* thread = JavaThread::current();
            ThreadToNativeFromVM ttn(thread);
            HandleMark hm(thread);
<span class="udiff-line-added">+           load_zip_library_if_needed();</span>
            zip = (*ZipOpen)(canonical_path, &amp;error_msg);
          }
          if (zip != NULL &amp;&amp; error_msg == NULL) {
            // create using canonical path
            return new ClassPathZipEntry(zip, canonical_path, is_boot_append, false);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -965,10 +968,18 @@</span>
    }
  
    CanonicalizeEntry = CAST_TO_FN_PTR(canonicalize_fn_t, dll_lookup(javalib_handle, &quot;JDK_Canonicalize&quot;, NULL));
  }
  
<span class="udiff-line-added">+ void ClassLoader::release_load_zip_library() {</span>
<span class="udiff-line-added">+   MutexLocker locker(Zip_lock, Monitor::_no_safepoint_check_flag);</span>
<span class="udiff-line-added">+   if (_libzip_loaded == 0) {</span>
<span class="udiff-line-added">+     load_zip_library();</span>
<span class="udiff-line-added">+     Atomic::release_store(&amp;_libzip_loaded, 1);</span>
<span class="udiff-line-added">+   }</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
  void ClassLoader::load_zip_library() {
    assert(ZipOpen == NULL, &quot;should not load zip library twice&quot;);
    char path[JVM_MAXPATHLEN];
    char ebuf[1024];
    void* handle = NULL;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1006,10 +1017,11 @@</span>
    JImageGetResource = CAST_TO_FN_PTR(JImageGetResource_t, dll_lookup(handle, &quot;JIMAGE_GetResource&quot;, path));
    JImageResourceIterator = CAST_TO_FN_PTR(JImageResourceIterator_t, dll_lookup(handle, &quot;JIMAGE_ResourceIterator&quot;, path));
  }
  
  int ClassLoader::crc32(int crc, const char* buf, int len) {
<span class="udiff-line-added">+   load_zip_library_if_needed();</span>
    return (*Crc32)(crc, (const jbyte*)buf, len);
  }
  
  oop ClassLoader::get_system_package(const char* name, TRAPS) {
    // Look up the name in the boot loader&#39;s package entry table.
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1464,12 +1476,10 @@</span>
                          &quot;unsafeDefineClassCalls&quot;);
    }
  
    // lookup java library entry points
    load_java_library();
<span class="udiff-line-removed">-   // lookup zip library entry points</span>
<span class="udiff-line-removed">-   load_zip_library();</span>
    // jimage library entry points are loaded below, in lookup_vm_options
    setup_bootstrap_search_path();
  }
  
  char* lookup_vm_resource(JImageFile *jimage, const char *jimage_version, const char *path) {
</pre>
<center><a href="../../cpu/aarch64/aarch64.ad.udiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="systemDictionary.cpp.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>