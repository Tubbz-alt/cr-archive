<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Old src/hotspot/share/interpreter/interpreterRuntime.cpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
  </head>
  <body>
    <pre>
   1 /*
   2  * Copyright (c) 1997, 2020, Oracle and/or its affiliates. All rights reserved.
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.
   8  *
   9  * This code is distributed in the hope that it will be useful, but WITHOUT
  10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  *
  23  */
  24 
  25 #include &quot;precompiled.hpp&quot;
  26 #include &quot;classfile/javaClasses.inline.hpp&quot;
  27 #include &quot;classfile/symbolTable.hpp&quot;
  28 #include &quot;classfile/systemDictionary.hpp&quot;
  29 #include &quot;classfile/vmSymbols.hpp&quot;
  30 #include &quot;code/codeCache.hpp&quot;
  31 #include &quot;compiler/compilationPolicy.hpp&quot;
  32 #include &quot;compiler/compileBroker.hpp&quot;
  33 #include &quot;compiler/disassembler.hpp&quot;
  34 #include &quot;gc/shared/barrierSetNMethod.hpp&quot;
  35 #include &quot;gc/shared/collectedHeap.hpp&quot;
  36 #include &quot;interpreter/interpreter.hpp&quot;
  37 #include &quot;interpreter/interpreterRuntime.hpp&quot;
  38 #include &quot;interpreter/linkResolver.hpp&quot;
  39 #include &quot;interpreter/templateTable.hpp&quot;
  40 #include &quot;logging/log.hpp&quot;
  41 #include &quot;memory/oopFactory.hpp&quot;
  42 #include &quot;memory/resourceArea.hpp&quot;
  43 #include &quot;memory/universe.hpp&quot;
  44 #include &quot;oops/constantPool.hpp&quot;
  45 #include &quot;oops/cpCache.inline.hpp&quot;
  46 #include &quot;oops/instanceKlass.hpp&quot;
  47 #include &quot;oops/methodData.hpp&quot;
  48 #include &quot;oops/objArrayKlass.hpp&quot;
  49 #include &quot;oops/objArrayOop.inline.hpp&quot;
  50 #include &quot;oops/oop.inline.hpp&quot;
  51 #include &quot;oops/symbol.hpp&quot;
  52 #include &quot;oops/valueArrayKlass.hpp&quot;
  53 #include &quot;oops/valueArrayOop.inline.hpp&quot;
  54 #include &quot;oops/valueKlass.inline.hpp&quot;
  55 #include &quot;prims/jvmtiExport.hpp&quot;
  56 #include &quot;prims/nativeLookup.hpp&quot;
  57 #include &quot;runtime/atomic.hpp&quot;
  58 #include &quot;runtime/biasedLocking.hpp&quot;
  59 #include &quot;runtime/deoptimization.hpp&quot;
  60 #include &quot;runtime/fieldDescriptor.inline.hpp&quot;
  61 #include &quot;runtime/frame.inline.hpp&quot;
  62 #include &quot;runtime/handles.inline.hpp&quot;
  63 #include &quot;runtime/icache.hpp&quot;
  64 #include &quot;runtime/interfaceSupport.inline.hpp&quot;
  65 #include &quot;runtime/java.hpp&quot;
  66 #include &quot;runtime/javaCalls.hpp&quot;
  67 #include &quot;runtime/jfieldIDWorkaround.hpp&quot;
  68 #include &quot;runtime/osThread.hpp&quot;
  69 #include &quot;runtime/sharedRuntime.hpp&quot;
  70 #include &quot;runtime/stubRoutines.hpp&quot;
  71 #include &quot;runtime/synchronizer.hpp&quot;
  72 #include &quot;runtime/threadCritical.hpp&quot;
  73 #include &quot;utilities/align.hpp&quot;
  74 #include &quot;utilities/copy.hpp&quot;
  75 #include &quot;utilities/events.hpp&quot;
  76 #include &quot;utilities/globalDefinitions.hpp&quot;
  77 #ifdef COMPILER2
  78 #include &quot;opto/runtime.hpp&quot;
  79 #endif
  80 
  81 class UnlockFlagSaver {
  82   private:
  83     JavaThread* _thread;
  84     bool _do_not_unlock;
  85   public:
  86     UnlockFlagSaver(JavaThread* t) {
  87       _thread = t;
  88       _do_not_unlock = t-&gt;do_not_unlock_if_synchronized();
  89       t-&gt;set_do_not_unlock_if_synchronized(false);
  90     }
  91     ~UnlockFlagSaver() {
  92       _thread-&gt;set_do_not_unlock_if_synchronized(_do_not_unlock);
  93     }
  94 };
  95 
  96 // Helper class to access current interpreter state
  97 class LastFrameAccessor : public StackObj {
  98   frame _last_frame;
  99 public:
 100   LastFrameAccessor(JavaThread* thread) {
 101     assert(thread == Thread::current(), &quot;sanity&quot;);
 102     _last_frame = thread-&gt;last_frame();
 103   }
 104   bool is_interpreted_frame() const              { return _last_frame.is_interpreted_frame(); }
 105   Method*   method() const                       { return _last_frame.interpreter_frame_method(); }
 106   address   bcp() const                          { return _last_frame.interpreter_frame_bcp(); }
 107   int       bci() const                          { return _last_frame.interpreter_frame_bci(); }
 108   address   mdp() const                          { return _last_frame.interpreter_frame_mdp(); }
 109 
 110   void      set_bcp(address bcp)                 { _last_frame.interpreter_frame_set_bcp(bcp); }
 111   void      set_mdp(address dp)                  { _last_frame.interpreter_frame_set_mdp(dp); }
 112 
 113   // pass method to avoid calling unsafe bcp_to_method (partial fix 4926272)
 114   Bytecodes::Code code() const                   { return Bytecodes::code_at(method(), bcp()); }
 115 
 116   Bytecode  bytecode() const                     { return Bytecode(method(), bcp()); }
 117   int get_index_u1(Bytecodes::Code bc) const     { return bytecode().get_index_u1(bc); }
 118   int get_index_u2(Bytecodes::Code bc) const     { return bytecode().get_index_u2(bc); }
 119   int get_index_u2_cpcache(Bytecodes::Code bc) const
 120                                                  { return bytecode().get_index_u2_cpcache(bc); }
 121   int get_index_u4(Bytecodes::Code bc) const     { return bytecode().get_index_u4(bc); }
 122   int number_of_dimensions() const               { return bcp()[3]; }
 123   ConstantPoolCacheEntry* cache_entry_at(int i) const
 124                                                  { return method()-&gt;constants()-&gt;cache()-&gt;entry_at(i); }
 125   ConstantPoolCacheEntry* cache_entry() const    { return cache_entry_at(Bytes::get_native_u2(bcp() + 1)); }
 126 
 127   oop callee_receiver(Symbol* signature) {
 128     return _last_frame.interpreter_callee_receiver(signature);
 129   }
 130   BasicObjectLock* monitor_begin() const {
 131     return _last_frame.interpreter_frame_monitor_begin();
 132   }
 133   BasicObjectLock* monitor_end() const {
 134     return _last_frame.interpreter_frame_monitor_end();
 135   }
 136   BasicObjectLock* next_monitor(BasicObjectLock* current) const {
 137     return _last_frame.next_monitor_in_interpreter_frame(current);
 138   }
 139 
 140   frame&amp; get_frame()                             { return _last_frame; }
 141 };
 142 
 143 //------------------------------------------------------------------------------------------------------------------------
 144 // State accessors
 145 
 146 void InterpreterRuntime::set_bcp_and_mdp(address bcp, JavaThread *thread) {
 147   LastFrameAccessor last_frame(thread);
 148   last_frame.set_bcp(bcp);
 149   if (ProfileInterpreter) {
 150     // ProfileTraps uses MDOs independently of ProfileInterpreter.
 151     // That is why we must check both ProfileInterpreter and mdo != NULL.
 152     MethodData* mdo = last_frame.method()-&gt;method_data();
 153     if (mdo != NULL) {
 154       NEEDS_CLEANUP;
 155       last_frame.set_mdp(mdo-&gt;bci_to_dp(last_frame.bci()));
 156     }
 157   }
 158 }
 159 
 160 //------------------------------------------------------------------------------------------------------------------------
 161 // Constants
 162 
 163 
 164 JRT_ENTRY(void, InterpreterRuntime::ldc(JavaThread* thread, bool wide))
 165   // access constant pool
 166   LastFrameAccessor last_frame(thread);
 167   ConstantPool* pool = last_frame.method()-&gt;constants();
 168   int index = wide ? last_frame.get_index_u2(Bytecodes::_ldc_w) : last_frame.get_index_u1(Bytecodes::_ldc);
 169   constantTag tag = pool-&gt;tag_at(index);
 170 
 171   assert (tag.is_unresolved_klass() || tag.is_klass(), &quot;wrong ldc call&quot;);
 172   Klass* klass = pool-&gt;klass_at(index, CHECK);
 173     oop java_class = klass-&gt;java_mirror();
 174     thread-&gt;set_vm_result(java_class);
 175 JRT_END
 176 
 177 JRT_ENTRY(void, InterpreterRuntime::resolve_ldc(JavaThread* thread, Bytecodes::Code bytecode)) {
 178   assert(bytecode == Bytecodes::_ldc ||
 179          bytecode == Bytecodes::_ldc_w ||
 180          bytecode == Bytecodes::_ldc2_w ||
 181          bytecode == Bytecodes::_fast_aldc ||
 182          bytecode == Bytecodes::_fast_aldc_w, &quot;wrong bc&quot;);
 183   ResourceMark rm(thread);
 184   const bool is_fast_aldc = (bytecode == Bytecodes::_fast_aldc ||
 185                              bytecode == Bytecodes::_fast_aldc_w);
 186   LastFrameAccessor last_frame(thread);
 187   methodHandle m (thread, last_frame.method());
 188   Bytecode_loadconstant ldc(m, last_frame.bci());
 189 
 190   // Double-check the size.  (Condy can have any type.)
 191   BasicType type = ldc.result_type();
 192   switch (type2size[type]) {
 193   case 2: guarantee(bytecode == Bytecodes::_ldc2_w, &quot;&quot;); break;
 194   case 1: guarantee(bytecode != Bytecodes::_ldc2_w, &quot;&quot;); break;
 195   default: ShouldNotReachHere();
 196   }
 197 
 198   // Resolve the constant.  This does not do unboxing.
 199   // But it does replace Universe::the_null_sentinel by null.
 200   oop result = ldc.resolve_constant(CHECK);
 201   assert(result != NULL || is_fast_aldc, &quot;null result only valid for fast_aldc&quot;);
 202 
 203 #ifdef ASSERT
 204   {
 205     // The bytecode wrappers aren&#39;t GC-safe so construct a new one
 206     Bytecode_loadconstant ldc2(m, last_frame.bci());
 207     int rindex = ldc2.cache_index();
 208     if (rindex &lt; 0)
 209       rindex = m-&gt;constants()-&gt;cp_to_object_index(ldc2.pool_index());
 210     if (rindex &gt;= 0) {
 211       oop coop = m-&gt;constants()-&gt;resolved_references()-&gt;obj_at(rindex);
 212       oop roop = (result == NULL ? Universe::the_null_sentinel() : result);
 213       assert(roop == coop, &quot;expected result for assembly code&quot;);
 214     }
 215   }
 216 #endif
 217   thread-&gt;set_vm_result(result);
 218   if (!is_fast_aldc) {
 219     // Tell the interpreter how to unbox the primitive.
 220     guarantee(java_lang_boxing_object::is_instance(result, type), &quot;&quot;);
 221     int offset = java_lang_boxing_object::value_offset_in_bytes(type);
 222     intptr_t flags = ((as_TosState(type) &lt;&lt; ConstantPoolCacheEntry::tos_state_shift)
 223                       | (offset &amp; ConstantPoolCacheEntry::field_index_mask));
 224     thread-&gt;set_vm_result_2((Metadata*)flags);
 225   }
 226 }
 227 JRT_END
 228 
 229 
 230 //------------------------------------------------------------------------------------------------------------------------
 231 // Allocation
 232 
 233 JRT_ENTRY(void, InterpreterRuntime::_new(JavaThread* thread, ConstantPool* pool, int index))
 234   Klass* k = pool-&gt;klass_at(index, CHECK);
 235   InstanceKlass* klass = InstanceKlass::cast(k);
 236 
 237   // Make sure we are not instantiating an abstract klass
 238   klass-&gt;check_valid_for_instantiation(true, CHECK);
 239 
 240   // Make sure klass is initialized
 241   klass-&gt;initialize(CHECK);
 242 
 243   // At this point the class may not be fully initialized
 244   // because of recursive initialization. If it is fully
 245   // initialized &amp; has_finalized is not set, we rewrite
 246   // it into its fast version (Note: no locking is needed
 247   // here since this is an atomic byte write and can be
 248   // done more than once).
 249   //
 250   // Note: In case of classes with has_finalized we don&#39;t
 251   //       rewrite since that saves us an extra check in
 252   //       the fast version which then would call the
 253   //       slow version anyway (and do a call back into
 254   //       Java).
 255   //       If we have a breakpoint, then we don&#39;t rewrite
 256   //       because the _breakpoint bytecode would be lost.
 257   oop obj = klass-&gt;allocate_instance(CHECK);
 258   thread-&gt;set_vm_result(obj);
 259 JRT_END
 260 
 261 void copy_primitive_argument(intptr_t* addr, Handle instance, int offset, BasicType type) {
 262   switch (type) {
 263   case T_BOOLEAN:
 264     instance()-&gt;bool_field_put(offset, (jboolean)*((int*)addr));
 265     break;
 266   case T_CHAR:
 267     instance()-&gt;char_field_put(offset, (jchar) *((int*)addr));
 268     break;
 269   case T_FLOAT:
 270     instance()-&gt;float_field_put(offset, (jfloat)*((float*)addr));
 271     break;
 272   case T_DOUBLE:
 273     instance()-&gt;double_field_put(offset, (jdouble)*((double*)addr));
 274     break;
 275   case T_BYTE:
 276     instance()-&gt;byte_field_put(offset, (jbyte)*((int*)addr));
 277     break;
 278   case T_SHORT:
 279     instance()-&gt;short_field_put(offset, (jshort)*((int*)addr));
 280     break;
 281   case T_INT:
 282     instance()-&gt;int_field_put(offset, (jint)*((int*)addr));
 283     break;
 284   case T_LONG:
 285     instance()-&gt;long_field_put(offset, (jlong)*((long long*)addr));
 286     break;
 287   case T_OBJECT:
 288   case T_ARRAY:
 289   case T_VALUETYPE:
 290     fatal(&quot;Should not be handled with this method&quot;);
 291     break;
 292   default:
 293     fatal(&quot;Unsupported BasicType&quot;);
 294   }
 295 }
 296 
 297 JRT_ENTRY(void, InterpreterRuntime::defaultvalue(JavaThread* thread, ConstantPool* pool, int index))
 298   // Getting the ValueKlass
 299   Klass* k = pool-&gt;klass_at(index, CHECK);
 300   assert(k-&gt;is_value(), &quot;defaultvalue argument must be the value type class&quot;);
 301   ValueKlass* vklass = ValueKlass::cast(k);
 302 
 303   vklass-&gt;initialize(THREAD);
 304   oop res = vklass-&gt;default_value();
 305   thread-&gt;set_vm_result(res);
 306 JRT_END
 307 
 308 JRT_ENTRY(int, InterpreterRuntime::withfield(JavaThread* thread, ConstantPoolCache* cp_cache))
 309   LastFrameAccessor last_frame(thread);
 310   // Getting the ValueKlass
 311   int index = ConstantPool::decode_cpcache_index(last_frame.get_index_u2_cpcache(Bytecodes::_withfield));
 312   ConstantPoolCacheEntry* cp_entry = cp_cache-&gt;entry_at(index);
 313   assert(cp_entry-&gt;is_resolved(Bytecodes::_withfield), &quot;Should have been resolved&quot;);
 314   Klass* klass = cp_entry-&gt;f1_as_klass();
 315   assert(klass-&gt;is_value(), &quot;withfield only applies to value types&quot;);
 316   ValueKlass* vklass = ValueKlass::cast(klass);
 317 
 318   // Getting Field information
 319   int offset = cp_entry-&gt;f2_as_index();
 320   int field_index = cp_entry-&gt;field_index();
 321   int field_offset = cp_entry-&gt;f2_as_offset();
 322   Symbol* field_signature = vklass-&gt;field_signature(field_index);
 323   BasicType field_type = Signature::basic_type(field_signature);
 324   int return_offset = (type2size[field_type] + type2size[T_OBJECT]) * AbstractInterpreter::stackElementSize;
 325 
 326   // Getting old value
 327   frame&amp; f = last_frame.get_frame();
 328   jint tos_idx = f.interpreter_frame_expression_stack_size() - 1;
 329   int vt_offset = type2size[field_type];
 330   oop old_value = *(oop*)f.interpreter_frame_expression_stack_at(tos_idx - vt_offset);
 331   assert(old_value != NULL &amp;&amp; oopDesc::is_oop(old_value) &amp;&amp; old_value-&gt;is_value(),&quot;Verifying receiver&quot;);
 332   Handle old_value_h(THREAD, old_value);
 333 
 334   // Creating new value by copying the one passed in argument
 335   instanceOop new_value = vklass-&gt;allocate_instance(
 336       CHECK_((type2size[field_type]) * AbstractInterpreter::stackElementSize));
 337   Handle new_value_h = Handle(THREAD, new_value);
 338   vklass-&gt;value_copy_oop_to_new_oop(old_value_h(), new_value_h());
 339 
 340   // Updating the field specified in arguments
 341   if (field_type == T_ARRAY || field_type == T_OBJECT) {
 342     oop aoop = *(oop*)f.interpreter_frame_expression_stack_at(tos_idx);
 343     assert(aoop == NULL || oopDesc::is_oop(aoop),&quot;argument must be a reference type&quot;);
 344     new_value_h()-&gt;obj_field_put(field_offset, aoop);
 345   } else if (field_type == T_VALUETYPE) {
 346     if (cp_entry-&gt;is_flattened()) {
 347       oop vt_oop = *(oop*)f.interpreter_frame_expression_stack_at(tos_idx);
 348       assert(vt_oop != NULL &amp;&amp; oopDesc::is_oop(vt_oop) &amp;&amp; vt_oop-&gt;is_value(),&quot;argument must be a value type&quot;);
 349       ValueKlass* field_vk = ValueKlass::cast(vklass-&gt;get_value_field_klass(field_index));
 350       assert(vt_oop != NULL &amp;&amp; field_vk == vt_oop-&gt;klass(), &quot;Must match&quot;);
 351       field_vk-&gt;write_flattened_field(new_value_h(), offset, vt_oop, CHECK_(return_offset));
 352     } else { // not flattened
 353       oop voop = *(oop*)f.interpreter_frame_expression_stack_at(tos_idx);
 354       if (voop == NULL &amp;&amp; cp_entry-&gt;is_flattenable()) {
 355         THROW_(vmSymbols::java_lang_NullPointerException(), return_offset);
 356       }
 357       assert(voop == NULL || oopDesc::is_oop(voop),&quot;checking argument&quot;);
 358       new_value_h()-&gt;obj_field_put(field_offset, voop);
 359     }
 360   } else { // not T_OBJECT nor T_ARRAY nor T_VALUETYPE
 361     intptr_t* addr = f.interpreter_frame_expression_stack_at(tos_idx);
 362     copy_primitive_argument(addr, new_value_h, field_offset, field_type);
 363   }
 364 
 365   // returning result
 366   thread-&gt;set_vm_result(new_value_h());
 367   return return_offset;
 368 JRT_END
 369 
 370 JRT_ENTRY(void, InterpreterRuntime::uninitialized_static_value_field(JavaThread* thread, oopDesc* mirror, int index))
 371   // The interpreter tries to access a flattenable static field that has not been initialized.
 372   // This situation can happen in different scenarios:
 373   //   1 - if the load or initialization of the field failed during step 8 of
 374   //       the initialization of the holder of the field, in this case the access to the field
 375   //       must fail
 376   //   2 - it can also happen when the initialization of the holder class triggered the initialization of
 377   //       another class which accesses this field in its static initializer, in this case the
 378   //       access must succeed to allow circularity
 379   // The code below tries to load and initialize the field&#39;s class again before returning the default value.
 380   // If the field was not initialized because of an error, a exception should be thrown.
 381   // If the class is being initialized, the default value is returned.
 382   instanceHandle mirror_h(THREAD, (instanceOop)mirror);
 383   InstanceKlass* klass = InstanceKlass::cast(java_lang_Class::as_Klass(mirror));
 384   if (klass-&gt;is_being_initialized() &amp;&amp; klass-&gt;is_reentrant_initialization(THREAD)) {
 385     int offset = klass-&gt;field_offset(index);
 386     Klass* field_k = klass-&gt;get_value_field_klass_or_null(index);
 387     if (field_k == NULL) {
 388       field_k = SystemDictionary::resolve_or_fail(klass-&gt;field_signature(index)-&gt;fundamental_name(THREAD),
 389           Handle(THREAD, klass-&gt;class_loader()),
 390           Handle(THREAD, klass-&gt;protection_domain()),
 391           true, CHECK);
 392       assert(field_k != NULL, &quot;Should have been loaded or an exception thrown above&quot;);
 393       klass-&gt;set_value_field_klass(index, field_k);
 394     }
 395     field_k-&gt;initialize(CHECK);
 396     oop defaultvalue = ValueKlass::cast(field_k)-&gt;default_value();
 397     // It is safe to initialized the static field because 1) the current thread is the initializing thread
 398     // and is the only one that can access it, and 2) the field is actually not initialized (i.e. null)
 399     // otherwise the JVM should not be executing this code.
 400     mirror-&gt;obj_field_put(offset, defaultvalue);
 401     thread-&gt;set_vm_result(defaultvalue);
 402   } else {
 403     assert(klass-&gt;is_in_error_state(), &quot;If not initializing, initialization must have failed to get there&quot;);
 404     ResourceMark rm(THREAD);
 405     const char* desc = &quot;Could not initialize class &quot;;
 406     const char* className = klass-&gt;external_name();
 407     size_t msglen = strlen(desc) + strlen(className) + 1;
 408     char* message = NEW_RESOURCE_ARRAY(char, msglen);
 409     if (NULL == message) {
 410       // Out of memory: can&#39;t create detailed error message
 411       THROW_MSG(vmSymbols::java_lang_NoClassDefFoundError(), className);
 412     } else {
 413       jio_snprintf(message, msglen, &quot;%s%s&quot;, desc, className);
 414       THROW_MSG(vmSymbols::java_lang_NoClassDefFoundError(), message);
 415     }
 416   }
 417 JRT_END
 418 
 419 JRT_ENTRY(void, InterpreterRuntime::read_flattened_field(JavaThread* thread, oopDesc* obj, int index, Klass* field_holder))
 420   Handle obj_h(THREAD, obj);
 421 
 422   assert(oopDesc::is_oop(obj), &quot;Sanity check&quot;);
 423 
 424   assert(field_holder-&gt;is_instance_klass(), &quot;Sanity check&quot;);
 425   InstanceKlass* klass = InstanceKlass::cast(field_holder);
 426 
 427   assert(klass-&gt;field_is_flattened(index), &quot;Sanity check&quot;);
 428 
 429   ValueKlass* field_vklass = ValueKlass::cast(klass-&gt;get_value_field_klass(index));
 430   assert(field_vklass-&gt;is_initialized(), &quot;Must be initialized at this point&quot;);
 431 
 432   oop res = field_vklass-&gt;read_flattened_field(obj_h(), klass-&gt;field_offset(index), CHECK);
 433   thread-&gt;set_vm_result(res);
 434 JRT_END
 435 
 436 JRT_ENTRY(void, InterpreterRuntime::newarray(JavaThread* thread, BasicType type, jint size))
 437   oop obj = oopFactory::new_typeArray(type, size, CHECK);
 438   thread-&gt;set_vm_result(obj);
 439 JRT_END
 440 
 441 
 442 JRT_ENTRY(void, InterpreterRuntime::anewarray(JavaThread* thread, ConstantPool* pool, int index, jint size))
 443   Klass*    klass = pool-&gt;klass_at(index, CHECK);
 444   bool      is_qtype_desc = pool-&gt;tag_at(index).is_Qdescriptor_klass();
 445   arrayOop obj;
 446   if ((!klass-&gt;is_array_klass()) &amp;&amp; is_qtype_desc) { // Logically creates elements, ensure klass init
 447     klass-&gt;initialize(CHECK);
 448     obj = oopFactory::new_valueArray(klass, size, CHECK);
 449   } else {
 450     obj = oopFactory::new_objArray(klass, size, CHECK);
 451   }
 452   thread-&gt;set_vm_result(obj);
 453 JRT_END
 454 
 455 JRT_ENTRY(void, InterpreterRuntime::value_array_load(JavaThread* thread, arrayOopDesc* array, int index))
 456   valueArrayHandle vah(thread, (valueArrayOop)array);
 457   oop value_holder = valueArrayOopDesc::value_alloc_copy_from_index(vah, index, CHECK);
 458   thread-&gt;set_vm_result(value_holder);
 459 JRT_END
 460 
 461 JRT_ENTRY(void, InterpreterRuntime::value_array_store(JavaThread* thread, void* val, arrayOopDesc* array, int index))
 462   assert(val != NULL, &quot;can&#39;t store null into flat array&quot;);
 463   ((valueArrayOop)array)-&gt;value_copy_to_index((oop)val, index);
 464 JRT_END
 465 
 466 JRT_ENTRY(void, InterpreterRuntime::multianewarray(JavaThread* thread, jint* first_size_address))
 467   // We may want to pass in more arguments - could make this slightly faster
 468   LastFrameAccessor last_frame(thread);
 469   ConstantPool* constants = last_frame.method()-&gt;constants();
 470   int i = last_frame.get_index_u2(Bytecodes::_multianewarray);
 471   Klass* klass = constants-&gt;klass_at(i, CHECK);
 472   bool is_qtype = klass-&gt;name()-&gt;is_Q_array_signature();
 473   int   nof_dims = last_frame.number_of_dimensions();
 474   assert(klass-&gt;is_klass(), &quot;not a class&quot;);
 475   assert(nof_dims &gt;= 1, &quot;multianewarray rank must be nonzero&quot;);
 476 
 477   if (is_qtype) { // Logically creates elements, ensure klass init
 478     klass-&gt;initialize(CHECK);
 479   }
 480 
 481   // We must create an array of jints to pass to multi_allocate.
 482   ResourceMark rm(thread);
 483   const int small_dims = 10;
 484   jint dim_array[small_dims];
 485   jint *dims = &amp;dim_array[0];
 486   if (nof_dims &gt; small_dims) {
 487     dims = (jint*) NEW_RESOURCE_ARRAY(jint, nof_dims);
 488   }
 489   for (int index = 0; index &lt; nof_dims; index++) {
 490     // offset from first_size_address is addressed as local[index]
 491     int n = Interpreter::local_offset_in_bytes(index)/jintSize;
 492     dims[index] = first_size_address[n];
 493   }
 494   oop obj = ArrayKlass::cast(klass)-&gt;multi_allocate(nof_dims, dims, CHECK);
 495   thread-&gt;set_vm_result(obj);
 496 JRT_END
 497 
 498 
 499 JRT_ENTRY(void, InterpreterRuntime::register_finalizer(JavaThread* thread, oopDesc* obj))
 500   assert(oopDesc::is_oop(obj), &quot;must be a valid oop&quot;);
 501   assert(obj-&gt;klass()-&gt;has_finalizer(), &quot;shouldn&#39;t be here otherwise&quot;);
 502   InstanceKlass::register_finalizer(instanceOop(obj), CHECK);
 503 JRT_END
 504 
 505 JRT_ENTRY(jboolean, InterpreterRuntime::is_substitutable(JavaThread* thread, oopDesc* aobj, oopDesc* bobj))
 506   assert(oopDesc::is_oop(aobj) &amp;&amp; oopDesc::is_oop(bobj), &quot;must be valid oops&quot;);
 507 
 508   Handle ha(THREAD, aobj);
 509   Handle hb(THREAD, bobj);
 510   JavaValue result(T_BOOLEAN);
 511   JavaCallArguments args;
 512   args.push_oop(ha);
 513   args.push_oop(hb);
 514   methodHandle method(thread, Universe::is_substitutable_method());
 515   JavaCalls::call(&amp;result, method, &amp;args, THREAD);
 516   if (HAS_PENDING_EXCEPTION) {
 517     // Something really bad happened because isSubstitutable() should not throw exceptions
 518     // If it is an error, just let it propagate
 519     // If it is an exception, wrap it into an InternalError
 520     if (!PENDING_EXCEPTION-&gt;is_a(SystemDictionary::Error_klass())) {
 521       Handle e(THREAD, PENDING_EXCEPTION);
 522       CLEAR_PENDING_EXCEPTION;
 523       THROW_MSG_CAUSE_(vmSymbols::java_lang_InternalError(), &quot;Internal error in substitutability test&quot;, e, false);
 524     }
 525   }
 526   return result.get_jboolean();
 527 JRT_END
 528 
 529 // Quicken instance-of and check-cast bytecodes
 530 JRT_ENTRY(void, InterpreterRuntime::quicken_io_cc(JavaThread* thread))
 531   // Force resolving; quicken the bytecode
 532   LastFrameAccessor last_frame(thread);
 533   int which = last_frame.get_index_u2(Bytecodes::_checkcast);
 534   ConstantPool* cpool = last_frame.method()-&gt;constants();
 535   // We&#39;d expect to assert that we&#39;re only here to quicken bytecodes, but in a multithreaded
 536   // program we might have seen an unquick&#39;d bytecode in the interpreter but have another
 537   // thread quicken the bytecode before we get here.
 538   // assert( cpool-&gt;tag_at(which).is_unresolved_klass(), &quot;should only come here to quicken bytecodes&quot; );
 539   Klass* klass = cpool-&gt;klass_at(which, CHECK);
 540   thread-&gt;set_vm_result_2(klass);
 541 JRT_END
 542 
 543 
 544 //------------------------------------------------------------------------------------------------------------------------
 545 // Exceptions
 546 
 547 void InterpreterRuntime::note_trap_inner(JavaThread* thread, int reason,
 548                                          const methodHandle&amp; trap_method, int trap_bci, TRAPS) {
 549   if (trap_method.not_null()) {
 550     MethodData* trap_mdo = trap_method-&gt;method_data();
 551     if (trap_mdo == NULL) {
 552       Method::build_interpreter_method_data(trap_method, THREAD);
 553       if (HAS_PENDING_EXCEPTION) {
 554         assert((PENDING_EXCEPTION-&gt;is_a(SystemDictionary::OutOfMemoryError_klass())),
 555                &quot;we expect only an OOM error here&quot;);
 556         CLEAR_PENDING_EXCEPTION;
 557       }
 558       trap_mdo = trap_method-&gt;method_data();
 559       // and fall through...
 560     }
 561     if (trap_mdo != NULL) {
 562       // Update per-method count of trap events.  The interpreter
 563       // is updating the MDO to simulate the effect of compiler traps.
 564       Deoptimization::update_method_data_from_interpreter(trap_mdo, trap_bci, reason);
 565     }
 566   }
 567 }
 568 
 569 // Assume the compiler is (or will be) interested in this event.
 570 // If necessary, create an MDO to hold the information, and record it.
 571 void InterpreterRuntime::note_trap(JavaThread* thread, int reason, TRAPS) {
 572   assert(ProfileTraps, &quot;call me only if profiling&quot;);
 573   LastFrameAccessor last_frame(thread);
 574   methodHandle trap_method(thread, last_frame.method());
 575   int trap_bci = trap_method-&gt;bci_from(last_frame.bcp());
 576   note_trap_inner(thread, reason, trap_method, trap_bci, THREAD);
 577 }
 578 
 579 #ifdef CC_INTERP
 580 // As legacy note_trap, but we have more arguments.
 581 JRT_ENTRY(void, InterpreterRuntime::note_trap(JavaThread* thread, int reason, Method *method, int trap_bci))
 582   methodHandle trap_method(thread, method);
 583   note_trap_inner(thread, reason, trap_method, trap_bci, THREAD);
 584 JRT_END
 585 
 586 // Class Deoptimization is not visible in BytecodeInterpreter, so we need a wrapper
 587 // for each exception.
 588 void InterpreterRuntime::note_nullCheck_trap(JavaThread* thread, Method *method, int trap_bci)
 589   { if (ProfileTraps) note_trap(thread, Deoptimization::Reason_null_check, method, trap_bci); }
 590 void InterpreterRuntime::note_div0Check_trap(JavaThread* thread, Method *method, int trap_bci)
 591   { if (ProfileTraps) note_trap(thread, Deoptimization::Reason_div0_check, method, trap_bci); }
 592 void InterpreterRuntime::note_rangeCheck_trap(JavaThread* thread, Method *method, int trap_bci)
 593   { if (ProfileTraps) note_trap(thread, Deoptimization::Reason_range_check, method, trap_bci); }
 594 void InterpreterRuntime::note_classCheck_trap(JavaThread* thread, Method *method, int trap_bci)
 595   { if (ProfileTraps) note_trap(thread, Deoptimization::Reason_class_check, method, trap_bci); }
 596 void InterpreterRuntime::note_arrayCheck_trap(JavaThread* thread, Method *method, int trap_bci)
 597   { if (ProfileTraps) note_trap(thread, Deoptimization::Reason_array_check, method, trap_bci); }
 598 #endif // CC_INTERP
 599 
 600 
 601 static Handle get_preinitialized_exception(Klass* k, TRAPS) {
 602   // get klass
 603   InstanceKlass* klass = InstanceKlass::cast(k);
 604   assert(klass-&gt;is_initialized(),
 605          &quot;this klass should have been initialized during VM initialization&quot;);
 606   // create instance - do not call constructor since we may have no
 607   // (java) stack space left (should assert constructor is empty)
 608   Handle exception;
 609   oop exception_oop = klass-&gt;allocate_instance(CHECK_(exception));
 610   exception = Handle(THREAD, exception_oop);
 611   if (StackTraceInThrowable) {
 612     java_lang_Throwable::fill_in_stack_trace(exception);
 613   }
 614   return exception;
 615 }
 616 
 617 // Special handling for stack overflow: since we don&#39;t have any (java) stack
 618 // space left we use the pre-allocated &amp; pre-initialized StackOverflowError
 619 // klass to create an stack overflow error instance.  We do not call its
 620 // constructor for the same reason (it is empty, anyway).
 621 JRT_ENTRY(void, InterpreterRuntime::throw_StackOverflowError(JavaThread* thread))
 622   Handle exception = get_preinitialized_exception(
 623                                  SystemDictionary::StackOverflowError_klass(),
 624                                  CHECK);
 625   // Increment counter for hs_err file reporting
 626   Atomic::inc(&amp;Exceptions::_stack_overflow_errors);
 627   THROW_HANDLE(exception);
 628 JRT_END
 629 
 630 JRT_ENTRY(void, InterpreterRuntime::throw_delayed_StackOverflowError(JavaThread* thread))
 631   Handle exception = get_preinitialized_exception(
 632                                  SystemDictionary::StackOverflowError_klass(),
 633                                  CHECK);
 634   java_lang_Throwable::set_message(exception(),
 635           Universe::delayed_stack_overflow_error_message());
 636   // Increment counter for hs_err file reporting
 637   Atomic::inc(&amp;Exceptions::_stack_overflow_errors);
 638   THROW_HANDLE(exception);
 639 JRT_END
 640 
 641 JRT_ENTRY(void, InterpreterRuntime::create_exception(JavaThread* thread, char* name, char* message))
 642   // lookup exception klass
 643   TempNewSymbol s = SymbolTable::new_symbol(name);
 644   if (ProfileTraps) {
 645     if (s == vmSymbols::java_lang_ArithmeticException()) {
 646       note_trap(thread, Deoptimization::Reason_div0_check, CHECK);
 647     } else if (s == vmSymbols::java_lang_NullPointerException()) {
 648       note_trap(thread, Deoptimization::Reason_null_check, CHECK);
 649     }
 650   }
 651   // create exception
 652   Handle exception = Exceptions::new_exception(thread, s, message);
 653   thread-&gt;set_vm_result(exception());
 654 JRT_END
 655 
 656 
 657 JRT_ENTRY(void, InterpreterRuntime::create_klass_exception(JavaThread* thread, char* name, oopDesc* obj))
 658   // Produce the error message first because note_trap can safepoint
 659   ResourceMark rm(thread);
 660   const char* klass_name = obj-&gt;klass()-&gt;external_name();
 661   // lookup exception klass
 662   TempNewSymbol s = SymbolTable::new_symbol(name);
 663   if (ProfileTraps) {
 664     note_trap(thread, Deoptimization::Reason_class_check, CHECK);
 665   }
 666   // create exception, with klass name as detail message
 667   Handle exception = Exceptions::new_exception(thread, s, klass_name);
 668   thread-&gt;set_vm_result(exception());
 669 JRT_END
 670 
 671 JRT_ENTRY(void, InterpreterRuntime::throw_ArrayIndexOutOfBoundsException(JavaThread* thread, arrayOopDesc* a, jint index))
 672   // Produce the error message first because note_trap can safepoint
 673   ResourceMark rm(thread);
 674   stringStream ss;
 675   ss.print(&quot;Index %d out of bounds for length %d&quot;, index, a-&gt;length());
 676 
 677   if (ProfileTraps) {
 678     note_trap(thread, Deoptimization::Reason_range_check, CHECK);
 679   }
 680 
 681   THROW_MSG(vmSymbols::java_lang_ArrayIndexOutOfBoundsException(), ss.as_string());
 682 JRT_END
 683 
 684 JRT_ENTRY(void, InterpreterRuntime::throw_ClassCastException(
 685   JavaThread* thread, oopDesc* obj))
 686 
 687   // Produce the error message first because note_trap can safepoint
 688   ResourceMark rm(thread);
 689   char* message = SharedRuntime::generate_class_cast_message(
 690     thread, obj-&gt;klass());
 691 
 692   if (ProfileTraps) {
 693     note_trap(thread, Deoptimization::Reason_class_check, CHECK);
 694   }
 695 
 696   // create exception
 697   THROW_MSG(vmSymbols::java_lang_ClassCastException(), message);
 698 JRT_END
 699 
 700 // exception_handler_for_exception(...) returns the continuation address,
 701 // the exception oop (via TLS) and sets the bci/bcp for the continuation.
 702 // The exception oop is returned to make sure it is preserved over GC (it
 703 // is only on the stack if the exception was thrown explicitly via athrow).
 704 // During this operation, the expression stack contains the values for the
 705 // bci where the exception happened. If the exception was propagated back
 706 // from a call, the expression stack contains the values for the bci at the
 707 // invoke w/o arguments (i.e., as if one were inside the call).
 708 JRT_ENTRY(address, InterpreterRuntime::exception_handler_for_exception(JavaThread* thread, oopDesc* exception))
 709 
 710   LastFrameAccessor last_frame(thread);
 711   Handle             h_exception(thread, exception);
 712   methodHandle       h_method   (thread, last_frame.method());
 713   constantPoolHandle h_constants(thread, h_method-&gt;constants());
 714   bool               should_repeat;
 715   int                handler_bci;
 716   int                current_bci = last_frame.bci();
 717 
 718   if (thread-&gt;frames_to_pop_failed_realloc() &gt; 0) {
 719     // Allocation of scalar replaced object used in this frame
 720     // failed. Unconditionally pop the frame.
 721     thread-&gt;dec_frames_to_pop_failed_realloc();
 722     thread-&gt;set_vm_result(h_exception());
 723     // If the method is synchronized we already unlocked the monitor
 724     // during deoptimization so the interpreter needs to skip it when
 725     // the frame is popped.
 726     thread-&gt;set_do_not_unlock_if_synchronized(true);
 727 #ifdef CC_INTERP
 728     return (address) -1;
 729 #else
 730     return Interpreter::remove_activation_entry();
 731 #endif
 732   }
 733 
 734   // Need to do this check first since when _do_not_unlock_if_synchronized
 735   // is set, we don&#39;t want to trigger any classloading which may make calls
 736   // into java, or surprisingly find a matching exception handler for bci 0
 737   // since at this moment the method hasn&#39;t been &quot;officially&quot; entered yet.
 738   if (thread-&gt;do_not_unlock_if_synchronized()) {
 739     ResourceMark rm;
 740     assert(current_bci == 0,  &quot;bci isn&#39;t zero for do_not_unlock_if_synchronized&quot;);
 741     thread-&gt;set_vm_result(exception);
 742 #ifdef CC_INTERP
 743     return (address) -1;
 744 #else
 745     return Interpreter::remove_activation_entry();
 746 #endif
 747   }
 748 
 749   do {
 750     should_repeat = false;
 751 
 752     // assertions
 753 #ifdef ASSERT
 754     assert(h_exception.not_null(), &quot;NULL exceptions should be handled by athrow&quot;);
 755     // Check that exception is a subclass of Throwable, otherwise we have a VerifyError
 756     if (!(h_exception-&gt;is_a(SystemDictionary::Throwable_klass()))) {
 757       if (ExitVMOnVerifyError) vm_exit(-1);
 758       ShouldNotReachHere();
 759     }
 760 #endif
 761 
 762     // tracing
 763     if (log_is_enabled(Info, exceptions)) {
 764       ResourceMark rm(thread);
 765       stringStream tempst;
 766       tempst.print(&quot;interpreter method &lt;%s&gt;\n&quot;
 767                    &quot; at bci %d for thread &quot; INTPTR_FORMAT &quot; (%s)&quot;,
 768                    h_method-&gt;print_value_string(), current_bci, p2i(thread), thread-&gt;name());
 769       Exceptions::log_exception(h_exception, tempst.as_string());
 770     }
 771 // Don&#39;t go paging in something which won&#39;t be used.
 772 //     else if (extable-&gt;length() == 0) {
 773 //       // disabled for now - interpreter is not using shortcut yet
 774 //       // (shortcut is not to call runtime if we have no exception handlers)
 775 //       // warning(&quot;performance bug: should not call runtime if method has no exception handlers&quot;);
 776 //     }
 777     // for AbortVMOnException flag
 778     Exceptions::debug_check_abort(h_exception);
 779 
 780     // exception handler lookup
 781     Klass* klass = h_exception-&gt;klass();
 782     handler_bci = Method::fast_exception_handler_bci_for(h_method, klass, current_bci, THREAD);
 783     if (HAS_PENDING_EXCEPTION) {
 784       // We threw an exception while trying to find the exception handler.
 785       // Transfer the new exception to the exception handle which will
 786       // be set into thread local storage, and do another lookup for an
 787       // exception handler for this exception, this time starting at the
 788       // BCI of the exception handler which caused the exception to be
 789       // thrown (bug 4307310).
 790       h_exception = Handle(THREAD, PENDING_EXCEPTION);
 791       CLEAR_PENDING_EXCEPTION;
 792       if (handler_bci &gt;= 0) {
 793         current_bci = handler_bci;
 794         should_repeat = true;
 795       }
 796     }
 797   } while (should_repeat == true);
 798 
 799 #if INCLUDE_JVMCI
 800   if (EnableJVMCI &amp;&amp; h_method-&gt;method_data() != NULL) {
 801     ResourceMark rm(thread);
 802     ProfileData* pdata = h_method-&gt;method_data()-&gt;allocate_bci_to_data(current_bci, NULL);
 803     if (pdata != NULL &amp;&amp; pdata-&gt;is_BitData()) {
 804       BitData* bit_data = (BitData*) pdata;
 805       bit_data-&gt;set_exception_seen();
 806     }
 807   }
 808 #endif
 809 
 810   // notify JVMTI of an exception throw; JVMTI will detect if this is a first
 811   // time throw or a stack unwinding throw and accordingly notify the debugger
 812   if (JvmtiExport::can_post_on_exceptions()) {
 813     JvmtiExport::post_exception_throw(thread, h_method(), last_frame.bcp(), h_exception());
 814   }
 815 
 816 #ifdef CC_INTERP
 817   address continuation = (address)(intptr_t) handler_bci;
 818 #else
 819   address continuation = NULL;
 820 #endif
 821   address handler_pc = NULL;
 822   if (handler_bci &lt; 0 || !thread-&gt;reguard_stack((address) &amp;continuation)) {
 823     // Forward exception to callee (leaving bci/bcp untouched) because (a) no
 824     // handler in this method, or (b) after a stack overflow there is not yet
 825     // enough stack space available to reprotect the stack.
 826 #ifndef CC_INTERP
 827     continuation = Interpreter::remove_activation_entry();
 828 #endif
 829 #if COMPILER2_OR_JVMCI
 830     // Count this for compilation purposes
 831     h_method-&gt;interpreter_throwout_increment(THREAD);
 832 #endif
 833   } else {
 834     // handler in this method =&gt; change bci/bcp to handler bci/bcp and continue there
 835     handler_pc = h_method-&gt;code_base() + handler_bci;
 836 #ifndef CC_INTERP
 837     set_bcp_and_mdp(handler_pc, thread);
 838     continuation = Interpreter::dispatch_table(vtos)[*handler_pc];
 839 #endif
 840   }
 841   // notify debugger of an exception catch
 842   // (this is good for exceptions caught in native methods as well)
 843   if (JvmtiExport::can_post_on_exceptions()) {
 844     JvmtiExport::notice_unwind_due_to_exception(thread, h_method(), handler_pc, h_exception(), (handler_pc != NULL));
 845   }
 846 
 847   thread-&gt;set_vm_result(h_exception());
 848   return continuation;
 849 JRT_END
 850 
 851 
 852 JRT_ENTRY(void, InterpreterRuntime::throw_pending_exception(JavaThread* thread))
 853   assert(thread-&gt;has_pending_exception(), &quot;must only ne called if there&#39;s an exception pending&quot;);
 854   // nothing to do - eventually we should remove this code entirely (see comments @ call sites)
 855 JRT_END
 856 
 857 
 858 JRT_ENTRY(void, InterpreterRuntime::throw_AbstractMethodError(JavaThread* thread))
 859   THROW(vmSymbols::java_lang_AbstractMethodError());
 860 JRT_END
 861 
 862 // This method is called from the &quot;abstract_entry&quot; of the interpreter.
 863 // At that point, the arguments have already been removed from the stack
 864 // and therefore we don&#39;t have the receiver object at our fingertips. (Though,
 865 // on some platforms the receiver still resides in a register...). Thus,
 866 // we have no choice but print an error message not containing the receiver
 867 // type.
 868 JRT_ENTRY(void, InterpreterRuntime::throw_AbstractMethodErrorWithMethod(JavaThread* thread,
 869                                                                         Method* missingMethod))
 870   ResourceMark rm(thread);
 871   assert(missingMethod != NULL, &quot;sanity&quot;);
 872   methodHandle m(thread, missingMethod);
 873   LinkResolver::throw_abstract_method_error(m, THREAD);
 874 JRT_END
 875 
 876 JRT_ENTRY(void, InterpreterRuntime::throw_AbstractMethodErrorVerbose(JavaThread* thread,
 877                                                                      Klass* recvKlass,
 878                                                                      Method* missingMethod))
 879   ResourceMark rm(thread);
 880   methodHandle mh = methodHandle(thread, missingMethod);
 881   LinkResolver::throw_abstract_method_error(mh, recvKlass, THREAD);
 882 JRT_END
 883 
 884 
 885 JRT_ENTRY(void, InterpreterRuntime::throw_IncompatibleClassChangeError(JavaThread* thread))
 886   THROW(vmSymbols::java_lang_IncompatibleClassChangeError());
 887 JRT_END
 888 
 889 JRT_ENTRY(void, InterpreterRuntime::throw_IncompatibleClassChangeErrorVerbose(JavaThread* thread,
 890                                                                               Klass* recvKlass,
 891                                                                               Klass* interfaceKlass))
 892   ResourceMark rm(thread);
 893   char buf[1000];
 894   buf[0] = &#39;\0&#39;;
 895   jio_snprintf(buf, sizeof(buf),
 896                &quot;Class %s does not implement the requested interface %s&quot;,
 897                recvKlass ? recvKlass-&gt;external_name() : &quot;NULL&quot;,
 898                interfaceKlass ? interfaceKlass-&gt;external_name() : &quot;NULL&quot;);
 899   THROW_MSG(vmSymbols::java_lang_IncompatibleClassChangeError(), buf);
 900 JRT_END
 901 
 902 //------------------------------------------------------------------------------------------------------------------------
 903 // Fields
 904 //
 905 
 906 void InterpreterRuntime::resolve_get_put(JavaThread* thread, Bytecodes::Code bytecode) {
 907   Thread* THREAD = thread;
 908   // resolve field
 909   fieldDescriptor info;
 910   LastFrameAccessor last_frame(thread);
 911   constantPoolHandle pool(thread, last_frame.method()-&gt;constants());
 912   methodHandle m(thread, last_frame.method());
 913   bool is_put    = (bytecode == Bytecodes::_putfield  || bytecode == Bytecodes::_nofast_putfield ||
 914                     bytecode == Bytecodes::_putstatic || bytecode == Bytecodes::_withfield);
 915   bool is_static = (bytecode == Bytecodes::_getstatic || bytecode == Bytecodes::_putstatic);
 916   bool is_value  = bytecode == Bytecodes::_withfield;
 917 
 918   {
 919     JvmtiHideSingleStepping jhss(thread);
 920     LinkResolver::resolve_field_access(info, pool, last_frame.get_index_u2_cpcache(bytecode),
 921                                        m, bytecode, CHECK);
 922   } // end JvmtiHideSingleStepping
 923 
 924   // check if link resolution caused cpCache to be updated
 925   ConstantPoolCacheEntry* cp_cache_entry = last_frame.cache_entry();
 926   if (cp_cache_entry-&gt;is_resolved(bytecode)) return;
 927 
 928   // compute auxiliary field attributes
 929   TosState state  = as_TosState(info.field_type());
 930 
 931   // Resolution of put instructions on final fields is delayed. That is required so that
 932   // exceptions are thrown at the correct place (when the instruction is actually invoked).
 933   // If we do not resolve an instruction in the current pass, leaving the put_code
 934   // set to zero will cause the next put instruction to the same field to reresolve.
 935 
 936   // Resolution of put instructions to final instance fields with invalid updates (i.e.,
 937   // to final instance fields with updates originating from a method different than &lt;init&gt;)
 938   // is inhibited. A putfield instruction targeting an instance final field must throw
 939   // an IllegalAccessError if the instruction is not in an instance
 940   // initializer method &lt;init&gt;. If resolution were not inhibited, a putfield
 941   // in an initializer method could be resolved in the initializer. Subsequent
 942   // putfield instructions to the same field would then use cached information.
 943   // As a result, those instructions would not pass through the VM. That is,
 944   // checks in resolve_field_access() would not be executed for those instructions
 945   // and the required IllegalAccessError would not be thrown.
 946   //
 947   // Also, we need to delay resolving getstatic and putstatic instructions until the
 948   // class is initialized.  This is required so that access to the static
 949   // field will call the initialization function every time until the class
 950   // is completely initialized ala. in 2.17.5 in JVM Specification.
 951   InstanceKlass* klass = info.field_holder();
 952   bool uninitialized_static = is_static &amp;&amp; !klass-&gt;is_initialized();
 953   bool has_initialized_final_update = info.field_holder()-&gt;major_version() &gt;= 53 &amp;&amp;
 954                                       info.has_initialized_final_update();
 955   assert(!(has_initialized_final_update &amp;&amp; !info.access_flags().is_final()), &quot;Fields with initialized final updates must be final&quot;);
 956 
 957   Bytecodes::Code get_code = (Bytecodes::Code)0;
 958   Bytecodes::Code put_code = (Bytecodes::Code)0;
 959   if (!uninitialized_static) {
 960     if (is_static) {
 961       get_code = Bytecodes::_getstatic;
 962     } else {
 963       get_code = Bytecodes::_getfield;
 964     }
 965     if (is_put &amp;&amp; is_value) {
 966         put_code = ((is_static) ? Bytecodes::_putstatic : Bytecodes::_withfield);
 967     } else if ((is_put &amp;&amp; !has_initialized_final_update) || !info.access_flags().is_final()) {
 968         put_code = ((is_static) ? Bytecodes::_putstatic : Bytecodes::_putfield);
 969     }
 970   }
 971 
 972   cp_cache_entry-&gt;set_field(
 973     get_code,
 974     put_code,
 975     info.field_holder(),
 976     info.index(),
 977     info.offset(),
 978     state,
 979     info.access_flags().is_final(),
 980     info.access_flags().is_volatile(),
 981     info.is_flattened(),
 982     info.is_flattenable(),
 983     pool-&gt;pool_holder()
 984   );
 985 }
 986 
 987 
 988 //------------------------------------------------------------------------------------------------------------------------
 989 // Synchronization
 990 //
 991 // The interpreter&#39;s synchronization code is factored out so that it can
 992 // be shared by method invocation and synchronized blocks.
 993 //%note synchronization_3
 994 
 995 //%note monitor_1
 996 JRT_ENTRY_NO_ASYNC(void, InterpreterRuntime::monitorenter(JavaThread* thread, BasicObjectLock* elem))
 997 #ifdef ASSERT
 998   thread-&gt;last_frame().interpreter_frame_verify_monitor(elem);
 999 #endif
1000   if (PrintBiasedLockingStatistics) {
1001     Atomic::inc(BiasedLocking::slow_path_entry_count_addr());
1002   }
1003   Handle h_obj(thread, elem-&gt;obj());
1004   assert(Universe::heap()-&gt;is_in_or_null(h_obj()),
1005          &quot;must be NULL or an object&quot;);
1006   ObjectSynchronizer::enter(h_obj, elem-&gt;lock(), CHECK);
1007   assert(Universe::heap()-&gt;is_in_or_null(elem-&gt;obj()),
1008          &quot;must be NULL or an object&quot;);
1009 #ifdef ASSERT
1010   thread-&gt;last_frame().interpreter_frame_verify_monitor(elem);
1011 #endif
1012 JRT_END
1013 
1014 
1015 //%note monitor_1
1016 JRT_ENTRY_NO_ASYNC(void, InterpreterRuntime::monitorexit(JavaThread* thread, BasicObjectLock* elem))
1017 #ifdef ASSERT
1018   thread-&gt;last_frame().interpreter_frame_verify_monitor(elem);
1019 #endif
1020   Handle h_obj(thread, elem-&gt;obj());
1021   assert(Universe::heap()-&gt;is_in_or_null(h_obj()),
1022          &quot;must be NULL or an object&quot;);
1023   if (elem == NULL || h_obj()-&gt;is_unlocked()) {
1024     THROW(vmSymbols::java_lang_IllegalMonitorStateException());
1025   }
1026   ObjectSynchronizer::exit(h_obj(), elem-&gt;lock(), thread);
1027   // Free entry. This must be done here, since a pending exception might be installed on
1028   // exit. If it is not cleared, the exception handling code will try to unlock the monitor again.
1029   elem-&gt;set_obj(NULL);
1030 #ifdef ASSERT
1031   thread-&gt;last_frame().interpreter_frame_verify_monitor(elem);
1032 #endif
1033 JRT_END
1034 
1035 
1036 JRT_ENTRY(void, InterpreterRuntime::throw_illegal_monitor_state_exception(JavaThread* thread))
1037   THROW(vmSymbols::java_lang_IllegalMonitorStateException());
1038 JRT_END
1039 
1040 
1041 JRT_ENTRY(void, InterpreterRuntime::new_illegal_monitor_state_exception(JavaThread* thread))
1042   // Returns an illegal exception to install into the current thread. The
1043   // pending_exception flag is cleared so normal exception handling does not
1044   // trigger. Any current installed exception will be overwritten. This
1045   // method will be called during an exception unwind.
1046 
1047   assert(!HAS_PENDING_EXCEPTION, &quot;no pending exception&quot;);
1048   Handle exception(thread, thread-&gt;vm_result());
1049   assert(exception() != NULL, &quot;vm result should be set&quot;);
1050   thread-&gt;set_vm_result(NULL); // clear vm result before continuing (may cause memory leaks and assert failures)
1051   if (!exception-&gt;is_a(SystemDictionary::ThreadDeath_klass())) {
1052     exception = get_preinitialized_exception(
1053                        SystemDictionary::IllegalMonitorStateException_klass(),
1054                        CATCH);
1055   }
1056   thread-&gt;set_vm_result(exception());
1057 JRT_END
1058 
1059 
1060 //------------------------------------------------------------------------------------------------------------------------
1061 // Invokes
1062 
1063 JRT_ENTRY(Bytecodes::Code, InterpreterRuntime::get_original_bytecode_at(JavaThread* thread, Method* method, address bcp))
1064   return method-&gt;orig_bytecode_at(method-&gt;bci_from(bcp));
1065 JRT_END
1066 
1067 JRT_ENTRY(void, InterpreterRuntime::set_original_bytecode_at(JavaThread* thread, Method* method, address bcp, Bytecodes::Code new_code))
1068   method-&gt;set_orig_bytecode_at(method-&gt;bci_from(bcp), new_code);
1069 JRT_END
1070 
1071 JRT_ENTRY(void, InterpreterRuntime::_breakpoint(JavaThread* thread, Method* method, address bcp))
1072   JvmtiExport::post_raw_breakpoint(thread, method, bcp);
1073 JRT_END
1074 
1075 void InterpreterRuntime::resolve_invoke(JavaThread* thread, Bytecodes::Code bytecode) {
1076   Thread* THREAD = thread;
1077   LastFrameAccessor last_frame(thread);
1078   // extract receiver from the outgoing argument list if necessary
1079   Handle receiver(thread, NULL);
1080   if (bytecode == Bytecodes::_invokevirtual || bytecode == Bytecodes::_invokeinterface ||
1081       bytecode == Bytecodes::_invokespecial) {
1082     ResourceMark rm(thread);
1083     methodHandle m (thread, last_frame.method());
1084     Bytecode_invoke call(m, last_frame.bci());
1085     Symbol* signature = call.signature();
1086     receiver = Handle(thread, last_frame.callee_receiver(signature));
1087 
1088     assert(Universe::heap()-&gt;is_in_or_null(receiver()),
1089            &quot;sanity check&quot;);
1090     assert(receiver.is_null() ||
1091            !Universe::heap()-&gt;is_in(receiver-&gt;klass()),
1092            &quot;sanity check&quot;);
1093   }
1094 
1095   // resolve method
1096   CallInfo info;
1097   constantPoolHandle pool(thread, last_frame.method()-&gt;constants());
1098 
1099   {
1100     JvmtiHideSingleStepping jhss(thread);
1101     LinkResolver::resolve_invoke(info, receiver, pool,
1102                                  last_frame.get_index_u2_cpcache(bytecode), bytecode,
1103                                  CHECK);
1104     if (JvmtiExport::can_hotswap_or_post_breakpoint()) {
1105       int retry_count = 0;
1106       while (info.resolved_method()-&gt;is_old()) {
1107         // It is very unlikely that method is redefined more than 100 times
1108         // in the middle of resolve. If it is looping here more than 100 times
1109         // means then there could be a bug here.
1110         guarantee((retry_count++ &lt; 100),
1111                   &quot;Could not resolve to latest version of redefined method&quot;);
1112         // method is redefined in the middle of resolve so re-try.
1113         LinkResolver::resolve_invoke(info, receiver, pool,
1114                                      last_frame.get_index_u2_cpcache(bytecode), bytecode,
1115                                      CHECK);
1116       }
1117     }
1118   } // end JvmtiHideSingleStepping
1119 
1120   // check if link resolution caused cpCache to be updated
1121   ConstantPoolCacheEntry* cp_cache_entry = last_frame.cache_entry();
1122   if (cp_cache_entry-&gt;is_resolved(bytecode)) return;
1123 
1124 #ifdef ASSERT
1125   if (bytecode == Bytecodes::_invokeinterface) {
1126     if (info.resolved_method()-&gt;method_holder() ==
1127                                             SystemDictionary::Object_klass()) {
1128       // NOTE: THIS IS A FIX FOR A CORNER CASE in the JVM spec
1129       // (see also CallInfo::set_interface for details)
1130       assert(info.call_kind() == CallInfo::vtable_call ||
1131              info.call_kind() == CallInfo::direct_call, &quot;&quot;);
1132       Method* rm = info.resolved_method();
1133       assert(rm-&gt;is_final() || info.has_vtable_index(),
1134              &quot;should have been set already&quot;);
1135     } else if (!info.resolved_method()-&gt;has_itable_index()) {
1136       // Resolved something like CharSequence.toString.  Use vtable not itable.
1137       assert(info.call_kind() != CallInfo::itable_call, &quot;&quot;);
1138     } else {
1139       // Setup itable entry
1140       assert(info.call_kind() == CallInfo::itable_call, &quot;&quot;);
1141       int index = info.resolved_method()-&gt;itable_index();
1142       assert(info.itable_index() == index, &quot;&quot;);
1143     }
1144   } else if (bytecode == Bytecodes::_invokespecial) {
1145     assert(info.call_kind() == CallInfo::direct_call, &quot;must be direct call&quot;);
1146   } else {
1147     assert(info.call_kind() == CallInfo::direct_call ||
1148            info.call_kind() == CallInfo::vtable_call, &quot;&quot;);
1149   }
1150 #endif
1151   // Get sender or sender&#39;s unsafe_anonymous_host, and only set cpCache entry to resolved if
1152   // it is not an interface.  The receiver for invokespecial calls within interface
1153   // methods must be checked for every call.
1154   InstanceKlass* sender = pool-&gt;pool_holder();
1155   sender = sender-&gt;is_unsafe_anonymous() ? sender-&gt;unsafe_anonymous_host() : sender;
1156   methodHandle resolved_method(THREAD, info.resolved_method());
1157 
1158   switch (info.call_kind()) {
1159   case CallInfo::direct_call:
1160     cp_cache_entry-&gt;set_direct_call(
1161       bytecode,
1162       resolved_method,
1163       sender-&gt;is_interface());
1164     break;
1165   case CallInfo::vtable_call:
1166     cp_cache_entry-&gt;set_vtable_call(
1167       bytecode,
1168       resolved_method,
1169       info.vtable_index());
1170     break;
1171   case CallInfo::itable_call:
1172     cp_cache_entry-&gt;set_itable_call(
1173       bytecode,
1174       info.resolved_klass(),
1175       resolved_method,
1176       info.itable_index());
1177     break;
1178   default:  ShouldNotReachHere();
1179   }
1180 }
1181 
1182 
1183 // First time execution:  Resolve symbols, create a permanent MethodType object.
1184 void InterpreterRuntime::resolve_invokehandle(JavaThread* thread) {
1185   Thread* THREAD = thread;
1186   const Bytecodes::Code bytecode = Bytecodes::_invokehandle;
1187   LastFrameAccessor last_frame(thread);
1188 
1189   // resolve method
1190   CallInfo info;
1191   constantPoolHandle pool(thread, last_frame.method()-&gt;constants());
1192   {
1193     JvmtiHideSingleStepping jhss(thread);
1194     LinkResolver::resolve_invoke(info, Handle(), pool,
1195                                  last_frame.get_index_u2_cpcache(bytecode), bytecode,
1196                                  CHECK);
1197   } // end JvmtiHideSingleStepping
1198 
1199   ConstantPoolCacheEntry* cp_cache_entry = last_frame.cache_entry();
1200   cp_cache_entry-&gt;set_method_handle(pool, info);
1201 }
1202 
1203 // First time execution:  Resolve symbols, create a permanent CallSite object.
1204 void InterpreterRuntime::resolve_invokedynamic(JavaThread* thread) {
1205   Thread* THREAD = thread;
1206   LastFrameAccessor last_frame(thread);
1207   const Bytecodes::Code bytecode = Bytecodes::_invokedynamic;
1208 
1209   // resolve method
1210   CallInfo info;
1211   constantPoolHandle pool(thread, last_frame.method()-&gt;constants());
1212   int index = last_frame.get_index_u4(bytecode);
1213   {
1214     JvmtiHideSingleStepping jhss(thread);
1215     LinkResolver::resolve_invoke(info, Handle(), pool,
1216                                  index, bytecode, CHECK);
1217   } // end JvmtiHideSingleStepping
1218 
1219   ConstantPoolCacheEntry* cp_cache_entry = pool-&gt;invokedynamic_cp_cache_entry_at(index);
1220   cp_cache_entry-&gt;set_dynamic_call(pool, info);
1221 }
1222 
1223 // This function is the interface to the assembly code. It returns the resolved
1224 // cpCache entry.  This doesn&#39;t safepoint, but the helper routines safepoint.
1225 // This function will check for redefinition!
1226 JRT_ENTRY(void, InterpreterRuntime::resolve_from_cache(JavaThread* thread, Bytecodes::Code bytecode)) {
1227   switch (bytecode) {
1228   case Bytecodes::_getstatic:
1229   case Bytecodes::_putstatic:
1230   case Bytecodes::_getfield:
1231   case Bytecodes::_putfield:
1232   case Bytecodes::_withfield:
1233     resolve_get_put(thread, bytecode);
1234     break;
1235   case Bytecodes::_invokevirtual:
1236   case Bytecodes::_invokespecial:
1237   case Bytecodes::_invokestatic:
1238   case Bytecodes::_invokeinterface:
1239     resolve_invoke(thread, bytecode);
1240     break;
1241   case Bytecodes::_invokehandle:
1242     resolve_invokehandle(thread);
1243     break;
1244   case Bytecodes::_invokedynamic:
1245     resolve_invokedynamic(thread);
1246     break;
1247   default:
1248     fatal(&quot;unexpected bytecode: %s&quot;, Bytecodes::name(bytecode));
1249     break;
1250   }
1251 }
1252 JRT_END
1253 
1254 //------------------------------------------------------------------------------------------------------------------------
1255 // Miscellaneous
1256 
1257 
1258 nmethod* InterpreterRuntime::frequency_counter_overflow(JavaThread* thread, address branch_bcp) {
1259   nmethod* nm = frequency_counter_overflow_inner(thread, branch_bcp);
1260   assert(branch_bcp != NULL || nm == NULL, &quot;always returns null for non OSR requests&quot;);
1261   if (branch_bcp != NULL &amp;&amp; nm != NULL) {
1262     // This was a successful request for an OSR nmethod.  Because
1263     // frequency_counter_overflow_inner ends with a safepoint check,
1264     // nm could have been unloaded so look it up again.  It&#39;s unsafe
1265     // to examine nm directly since it might have been freed and used
1266     // for something else.
1267     LastFrameAccessor last_frame(thread);
1268     Method* method =  last_frame.method();
1269     int bci = method-&gt;bci_from(last_frame.bcp());
1270     nm = method-&gt;lookup_osr_nmethod_for(bci, CompLevel_none, false);
1271     BarrierSetNMethod* bs_nm = BarrierSet::barrier_set()-&gt;barrier_set_nmethod();
1272     if (nm != NULL &amp;&amp; bs_nm != NULL) {
1273       // in case the transition passed a safepoint we need to barrier this again
1274       if (!bs_nm-&gt;nmethod_osr_entry_barrier(nm)) {
1275         nm = NULL;
1276       }
1277     }
1278   }
1279   if (nm != NULL &amp;&amp; thread-&gt;is_interp_only_mode()) {
1280     // Normally we never get an nm if is_interp_only_mode() is true, because
1281     // policy()-&gt;event has a check for this and won&#39;t compile the method when
1282     // true. However, it&#39;s possible for is_interp_only_mode() to become true
1283     // during the compilation. We don&#39;t want to return the nm in that case
1284     // because we want to continue to execute interpreted.
1285     nm = NULL;
1286   }
1287 #ifndef PRODUCT
1288   if (TraceOnStackReplacement) {
1289     if (nm != NULL) {
1290       tty-&gt;print(&quot;OSR entry @ pc: &quot; INTPTR_FORMAT &quot;: &quot;, p2i(nm-&gt;osr_entry()));
1291       nm-&gt;print();
1292     }
1293   }
1294 #endif
1295   return nm;
1296 }
1297 
1298 JRT_ENTRY(nmethod*,
1299           InterpreterRuntime::frequency_counter_overflow_inner(JavaThread* thread, address branch_bcp))
1300   // use UnlockFlagSaver to clear and restore the _do_not_unlock_if_synchronized
1301   // flag, in case this method triggers classloading which will call into Java.
1302   UnlockFlagSaver fs(thread);
1303 
1304   LastFrameAccessor last_frame(thread);
1305   assert(last_frame.is_interpreted_frame(), &quot;must come from interpreter&quot;);
1306   methodHandle method(thread, last_frame.method());
1307   const int branch_bci = branch_bcp != NULL ? method-&gt;bci_from(branch_bcp) : InvocationEntryBci;
1308   const int bci = branch_bcp != NULL ? method-&gt;bci_from(last_frame.bcp()) : InvocationEntryBci;
1309 
1310   assert(!HAS_PENDING_EXCEPTION, &quot;Should not have any exceptions pending&quot;);
1311   nmethod* osr_nm = CompilationPolicy::policy()-&gt;event(method, method, branch_bci, bci, CompLevel_none, NULL, thread);
1312   assert(!HAS_PENDING_EXCEPTION, &quot;Event handler should not throw any exceptions&quot;);
1313 
1314   BarrierSetNMethod* bs_nm = BarrierSet::barrier_set()-&gt;barrier_set_nmethod();
1315   if (osr_nm != NULL &amp;&amp; bs_nm != NULL) {
1316     if (!bs_nm-&gt;nmethod_osr_entry_barrier(osr_nm)) {
1317       osr_nm = NULL;
1318     }
1319   }
1320 
1321   if (osr_nm != NULL) {
1322     // We may need to do on-stack replacement which requires that no
1323     // monitors in the activation are biased because their
1324     // BasicObjectLocks will need to migrate during OSR. Force
1325     // unbiasing of all monitors in the activation now (even though
1326     // the OSR nmethod might be invalidated) because we don&#39;t have a
1327     // safepoint opportunity later once the migration begins.
1328     if (UseBiasedLocking) {
1329       ResourceMark rm;
1330       GrowableArray&lt;Handle&gt;* objects_to_revoke = new GrowableArray&lt;Handle&gt;();
1331       for( BasicObjectLock *kptr = last_frame.monitor_end();
1332            kptr &lt; last_frame.monitor_begin();
1333            kptr = last_frame.next_monitor(kptr) ) {
1334         if( kptr-&gt;obj() != NULL ) {
1335           objects_to_revoke-&gt;append(Handle(THREAD, kptr-&gt;obj()));
1336         }
1337       }
1338       BiasedLocking::revoke(objects_to_revoke, thread);
1339     }
1340   }
1341   return osr_nm;
1342 JRT_END
1343 
1344 JRT_LEAF(jint, InterpreterRuntime::bcp_to_di(Method* method, address cur_bcp))
1345   assert(ProfileInterpreter, &quot;must be profiling interpreter&quot;);
1346   int bci = method-&gt;bci_from(cur_bcp);
1347   MethodData* mdo = method-&gt;method_data();
1348   if (mdo == NULL)  return 0;
1349   return mdo-&gt;bci_to_di(bci);
1350 JRT_END
1351 
1352 JRT_ENTRY(void, InterpreterRuntime::profile_method(JavaThread* thread))
1353   // use UnlockFlagSaver to clear and restore the _do_not_unlock_if_synchronized
1354   // flag, in case this method triggers classloading which will call into Java.
1355   UnlockFlagSaver fs(thread);
1356 
1357   assert(ProfileInterpreter, &quot;must be profiling interpreter&quot;);
1358   LastFrameAccessor last_frame(thread);
1359   assert(last_frame.is_interpreted_frame(), &quot;must come from interpreter&quot;);
1360   methodHandle method(thread, last_frame.method());
1361   Method::build_interpreter_method_data(method, THREAD);
1362   if (HAS_PENDING_EXCEPTION) {
1363     assert((PENDING_EXCEPTION-&gt;is_a(SystemDictionary::OutOfMemoryError_klass())), &quot;we expect only an OOM error here&quot;);
1364     CLEAR_PENDING_EXCEPTION;
1365     // and fall through...
1366   }
1367 JRT_END
1368 
1369 
1370 #ifdef ASSERT
1371 JRT_LEAF(void, InterpreterRuntime::verify_mdp(Method* method, address bcp, address mdp))
1372   assert(ProfileInterpreter, &quot;must be profiling interpreter&quot;);
1373 
1374   MethodData* mdo = method-&gt;method_data();
1375   assert(mdo != NULL, &quot;must not be null&quot;);
1376 
1377   int bci = method-&gt;bci_from(bcp);
1378 
1379   address mdp2 = mdo-&gt;bci_to_dp(bci);
1380   if (mdp != mdp2) {
1381     ResourceMark rm;
1382     ResetNoHandleMark rnm; // In a LEAF entry.
1383     HandleMark hm;
1384     tty-&gt;print_cr(&quot;FAILED verify : actual mdp %p   expected mdp %p @ bci %d&quot;, mdp, mdp2, bci);
1385     int current_di = mdo-&gt;dp_to_di(mdp);
1386     int expected_di  = mdo-&gt;dp_to_di(mdp2);
1387     tty-&gt;print_cr(&quot;  actual di %d   expected di %d&quot;, current_di, expected_di);
1388     int expected_approx_bci = mdo-&gt;data_at(expected_di)-&gt;bci();
1389     int approx_bci = -1;
1390     if (current_di &gt;= 0) {
1391       approx_bci = mdo-&gt;data_at(current_di)-&gt;bci();
1392     }
1393     tty-&gt;print_cr(&quot;  actual bci is %d  expected bci %d&quot;, approx_bci, expected_approx_bci);
1394     mdo-&gt;print_on(tty);
1395     method-&gt;print_codes();
1396   }
1397   assert(mdp == mdp2, &quot;wrong mdp&quot;);
1398 JRT_END
1399 #endif // ASSERT
1400 
1401 JRT_ENTRY(void, InterpreterRuntime::update_mdp_for_ret(JavaThread* thread, int return_bci))
1402   assert(ProfileInterpreter, &quot;must be profiling interpreter&quot;);
1403   ResourceMark rm(thread);
1404   HandleMark hm(thread);
1405   LastFrameAccessor last_frame(thread);
1406   assert(last_frame.is_interpreted_frame(), &quot;must come from interpreter&quot;);
1407   MethodData* h_mdo = last_frame.method()-&gt;method_data();
1408 
1409   // Grab a lock to ensure atomic access to setting the return bci and
1410   // the displacement.  This can block and GC, invalidating all naked oops.
1411   MutexLocker ml(RetData_lock);
1412 
1413   // ProfileData is essentially a wrapper around a derived oop, so we
1414   // need to take the lock before making any ProfileData structures.
1415   ProfileData* data = h_mdo-&gt;data_at(h_mdo-&gt;dp_to_di(last_frame.mdp()));
1416   guarantee(data != NULL, &quot;profile data must be valid&quot;);
1417   RetData* rdata = data-&gt;as_RetData();
1418   address new_mdp = rdata-&gt;fixup_ret(return_bci, h_mdo);
1419   last_frame.set_mdp(new_mdp);
1420 JRT_END
1421 
1422 JRT_ENTRY(MethodCounters*, InterpreterRuntime::build_method_counters(JavaThread* thread, Method* m))
1423   MethodCounters* mcs = Method::build_method_counters(m, thread);
1424   if (HAS_PENDING_EXCEPTION) {
1425     assert((PENDING_EXCEPTION-&gt;is_a(SystemDictionary::OutOfMemoryError_klass())), &quot;we expect only an OOM error here&quot;);
1426     CLEAR_PENDING_EXCEPTION;
1427   }
1428   return mcs;
1429 JRT_END
1430 
1431 
1432 JRT_ENTRY(void, InterpreterRuntime::at_safepoint(JavaThread* thread))
1433   // We used to need an explict preserve_arguments here for invoke bytecodes. However,
1434   // stack traversal automatically takes care of preserving arguments for invoke, so
1435   // this is no longer needed.
1436 
1437   // JRT_END does an implicit safepoint check, hence we are guaranteed to block
1438   // if this is called during a safepoint
1439 
1440   if (JvmtiExport::should_post_single_step()) {
1441     // We are called during regular safepoints and when the VM is
1442     // single stepping. If any thread is marked for single stepping,
1443     // then we may have JVMTI work to do.
1444     LastFrameAccessor last_frame(thread);
1445     JvmtiExport::at_single_stepping_point(thread, last_frame.method(), last_frame.bcp());
1446   }
1447 JRT_END
1448 
1449 JRT_ENTRY(void, InterpreterRuntime::post_field_access(JavaThread *thread, oopDesc* obj,
1450 ConstantPoolCacheEntry *cp_entry))
1451 
1452   // check the access_flags for the field in the klass
1453 
1454   InstanceKlass* ik = InstanceKlass::cast(cp_entry-&gt;f1_as_klass());
1455   int index = cp_entry-&gt;field_index();
1456   if ((ik-&gt;field_access_flags(index) &amp; JVM_ACC_FIELD_ACCESS_WATCHED) == 0) return;
1457 
1458   bool is_static = (obj == NULL);
1459   bool is_flattened = cp_entry-&gt;is_flattened();
1460   HandleMark hm(thread);
1461 
1462   Handle h_obj;
1463   if (!is_static) {
1464     // non-static field accessors have an object, but we need a handle
1465     h_obj = Handle(thread, obj);
1466   }
1467   InstanceKlass* cp_entry_f1 = InstanceKlass::cast(cp_entry-&gt;f1_as_klass());
1468   jfieldID fid = jfieldIDWorkaround::to_jfieldID(cp_entry_f1, cp_entry-&gt;f2_as_index(), is_static, is_flattened);
1469   LastFrameAccessor last_frame(thread);
1470   JvmtiExport::post_field_access(thread, last_frame.method(), last_frame.bcp(), cp_entry_f1, h_obj, fid);
1471 JRT_END
1472 
1473 JRT_ENTRY(void, InterpreterRuntime::post_field_modification(JavaThread *thread,
1474   oopDesc* obj, ConstantPoolCacheEntry *cp_entry, jvalue *value))
1475 
1476   Klass* k = cp_entry-&gt;f1_as_klass();
1477 
1478   // check the access_flags for the field in the klass
1479   InstanceKlass* ik = InstanceKlass::cast(k);
1480   int index = cp_entry-&gt;field_index();
1481   // bail out if field modifications are not watched
1482   if ((ik-&gt;field_access_flags(index) &amp; JVM_ACC_FIELD_MODIFICATION_WATCHED) == 0) return;
1483 
1484   char sig_type = &#39;\0&#39;;
1485 
1486   switch(cp_entry-&gt;flag_state()) {
1487     case btos: sig_type = JVM_SIGNATURE_BYTE;    break;
1488     case ztos: sig_type = JVM_SIGNATURE_BOOLEAN; break;
1489     case ctos: sig_type = JVM_SIGNATURE_CHAR;    break;
1490     case stos: sig_type = JVM_SIGNATURE_SHORT;   break;
1491     case itos: sig_type = JVM_SIGNATURE_INT;     break;
1492     case ftos: sig_type = JVM_SIGNATURE_FLOAT;   break;
1493     case atos: sig_type = JVM_SIGNATURE_CLASS;   break;
1494     case ltos: sig_type = JVM_SIGNATURE_LONG;    break;
1495     case dtos: sig_type = JVM_SIGNATURE_DOUBLE;  break;
1496     default:  ShouldNotReachHere(); return;
1497   }
1498 
1499   // Both Q-signatures and L-signatures are mapped to atos
1500   if (cp_entry-&gt;flag_state() == atos &amp;&amp; ik-&gt;field_signature(index)-&gt;is_Q_signature()) {
1501     sig_type = JVM_SIGNATURE_VALUETYPE;
1502   }
1503 
1504   bool is_static = (obj == NULL);
1505   bool is_flattened = cp_entry-&gt;is_flattened();
1506 
1507   HandleMark hm(thread);
1508   jfieldID fid = jfieldIDWorkaround::to_jfieldID(ik, cp_entry-&gt;f2_as_index(), is_static, is_flattened);
1509   jvalue fvalue;
1510 #ifdef _LP64
1511   fvalue = *value;
1512 #else
1513   // Long/double values are stored unaligned and also noncontiguously with
1514   // tagged stacks.  We can&#39;t just do a simple assignment even in the non-
1515   // J/D cases because a C++ compiler is allowed to assume that a jvalue is
1516   // 8-byte aligned, and interpreter stack slots are only 4-byte aligned.
1517   // We assume that the two halves of longs/doubles are stored in interpreter
1518   // stack slots in platform-endian order.
1519   jlong_accessor u;
1520   jint* newval = (jint*)value;
1521   u.words[0] = newval[0];
1522   u.words[1] = newval[Interpreter::stackElementWords]; // skip if tag
1523   fvalue.j = u.long_value;
1524 #endif // _LP64
1525 
1526   Handle h_obj;
1527   if (!is_static) {
1528     // non-static field accessors have an object, but we need a handle
1529     h_obj = Handle(thread, obj);
1530   }
1531 
1532   LastFrameAccessor last_frame(thread);
1533   JvmtiExport::post_raw_field_modification(thread, last_frame.method(), last_frame.bcp(), ik, h_obj,
1534                                            fid, sig_type, &amp;fvalue);
1535 JRT_END
1536 
1537 JRT_ENTRY(void, InterpreterRuntime::post_method_entry(JavaThread *thread))
1538   LastFrameAccessor last_frame(thread);
1539   JvmtiExport::post_method_entry(thread, last_frame.method(), last_frame.get_frame());
1540 JRT_END
1541 
1542 
1543 JRT_ENTRY(void, InterpreterRuntime::post_method_exit(JavaThread *thread))
1544   LastFrameAccessor last_frame(thread);
1545   JvmtiExport::post_method_exit(thread, last_frame.method(), last_frame.get_frame());
1546 JRT_END
1547 
1548 JRT_LEAF(int, InterpreterRuntime::interpreter_contains(address pc))
1549 {
1550   return (Interpreter::contains(pc) ? 1 : 0);
1551 }
1552 JRT_END
1553 
1554 
1555 // Implementation of SignatureHandlerLibrary
1556 
1557 #ifndef SHARING_FAST_NATIVE_FINGERPRINTS
1558 // Dummy definition (else normalization method is defined in CPU
1559 // dependant code)
1560 uint64_t InterpreterRuntime::normalize_fast_native_fingerprint(uint64_t fingerprint) {
1561   return fingerprint;
1562 }
1563 #endif
1564 
1565 address SignatureHandlerLibrary::set_handler_blob() {
1566   BufferBlob* handler_blob = BufferBlob::create(&quot;native signature handlers&quot;, blob_size);
1567   if (handler_blob == NULL) {
1568     return NULL;
1569   }
1570   address handler = handler_blob-&gt;code_begin();
1571   _handler_blob = handler_blob;
1572   _handler = handler;
1573   return handler;
1574 }
1575 
1576 void SignatureHandlerLibrary::initialize() {
1577   if (_fingerprints != NULL) {
1578     return;
1579   }
1580   if (set_handler_blob() == NULL) {
1581     vm_exit_out_of_memory(blob_size, OOM_MALLOC_ERROR, &quot;native signature handlers&quot;);
1582   }
1583 
1584   BufferBlob* bb = BufferBlob::create(&quot;Signature Handler Temp Buffer&quot;,
1585                                       SignatureHandlerLibrary::buffer_size);
1586   _buffer = bb-&gt;code_begin();
1587 
1588   _fingerprints = new(ResourceObj::C_HEAP, mtCode)GrowableArray&lt;uint64_t&gt;(32, true);
1589   _handlers     = new(ResourceObj::C_HEAP, mtCode)GrowableArray&lt;address&gt;(32, true);
1590 }
1591 
1592 address SignatureHandlerLibrary::set_handler(CodeBuffer* buffer) {
1593   address handler   = _handler;
1594   int     insts_size = buffer-&gt;pure_insts_size();
1595   if (handler + insts_size &gt; _handler_blob-&gt;code_end()) {
1596     // get a new handler blob
1597     handler = set_handler_blob();
1598   }
1599   if (handler != NULL) {
1600     memcpy(handler, buffer-&gt;insts_begin(), insts_size);
1601     pd_set_handler(handler);
1602     ICache::invalidate_range(handler, insts_size);
1603     _handler = handler + insts_size;
1604   }
1605   return handler;
1606 }
1607 
1608 void SignatureHandlerLibrary::add(const methodHandle&amp; method) {
1609   if (method-&gt;signature_handler() == NULL) {
1610     // use slow signature handler if we can&#39;t do better
1611     int handler_index = -1;
1612     // check if we can use customized (fast) signature handler
1613     if (UseFastSignatureHandlers &amp;&amp; method-&gt;size_of_parameters() &lt;= Fingerprinter::fp_max_size_of_parameters) {
1614       // use customized signature handler
1615       MutexLocker mu(SignatureHandlerLibrary_lock);
1616       // make sure data structure is initialized
1617       initialize();
1618       // lookup method signature&#39;s fingerprint
1619       uint64_t fingerprint = Fingerprinter(method).fingerprint();
1620       // allow CPU dependant code to optimize the fingerprints for the fast handler
1621       fingerprint = InterpreterRuntime::normalize_fast_native_fingerprint(fingerprint);
1622       handler_index = _fingerprints-&gt;find(fingerprint);
1623       // create handler if necessary
1624       if (handler_index &lt; 0) {
1625         ResourceMark rm;
1626         ptrdiff_t align_offset = align_up(_buffer, CodeEntryAlignment) - (address)_buffer;
1627         CodeBuffer buffer((address)(_buffer + align_offset),
1628                           SignatureHandlerLibrary::buffer_size - align_offset);
1629         InterpreterRuntime::SignatureHandlerGenerator(method, &amp;buffer).generate(fingerprint);
1630         // copy into code heap
1631         address handler = set_handler(&amp;buffer);
1632         if (handler == NULL) {
1633           // use slow signature handler (without memorizing it in the fingerprints)
1634         } else {
1635           // debugging suppport
1636           if (PrintSignatureHandlers &amp;&amp; (handler != Interpreter::slow_signature_handler())) {
1637             ttyLocker ttyl;
1638             tty-&gt;cr();
1639             tty-&gt;print_cr(&quot;argument handler #%d for: %s %s (fingerprint = &quot; UINT64_FORMAT &quot;, %d bytes generated)&quot;,
1640                           _handlers-&gt;length(),
1641                           (method-&gt;is_static() ? &quot;static&quot; : &quot;receiver&quot;),
1642                           method-&gt;name_and_sig_as_C_string(),
1643                           fingerprint,
1644                           buffer.insts_size());
1645             if (buffer.insts_size() &gt; 0) {
1646               Disassembler::decode(handler, handler + buffer.insts_size());
1647             }
1648 #ifndef PRODUCT
1649             address rh_begin = Interpreter::result_handler(method()-&gt;result_type());
1650             if (CodeCache::contains(rh_begin)) {
1651               // else it might be special platform dependent values
1652               tty-&gt;print_cr(&quot; --- associated result handler ---&quot;);
1653               address rh_end = rh_begin;
1654               while (*(int*)rh_end != 0) {
1655                 rh_end += sizeof(int);
1656               }
1657               Disassembler::decode(rh_begin, rh_end);
1658             } else {
1659               tty-&gt;print_cr(&quot; associated result handler: &quot; PTR_FORMAT, p2i(rh_begin));
1660             }
1661 #endif
1662           }
1663           // add handler to library
1664           _fingerprints-&gt;append(fingerprint);
1665           _handlers-&gt;append(handler);
1666           // set handler index
1667           assert(_fingerprints-&gt;length() == _handlers-&gt;length(), &quot;sanity check&quot;);
1668           handler_index = _fingerprints-&gt;length() - 1;
1669         }
1670       }
1671       // Set handler under SignatureHandlerLibrary_lock
1672       if (handler_index &lt; 0) {
1673         // use generic signature handler
1674         method-&gt;set_signature_handler(Interpreter::slow_signature_handler());
1675       } else {
1676         // set handler
1677         method-&gt;set_signature_handler(_handlers-&gt;at(handler_index));
1678       }
1679     } else {
1680       DEBUG_ONLY(Thread::current()-&gt;check_possible_safepoint());
1681       // use generic signature handler
1682       method-&gt;set_signature_handler(Interpreter::slow_signature_handler());
1683     }
1684   }
1685 #ifdef ASSERT
1686   int handler_index = -1;
1687   int fingerprint_index = -2;
1688   {
1689     // &#39;_handlers&#39; and &#39;_fingerprints&#39; are &#39;GrowableArray&#39;s and are NOT synchronized
1690     // in any way if accessed from multiple threads. To avoid races with another
1691     // thread which may change the arrays in the above, mutex protected block, we
1692     // have to protect this read access here with the same mutex as well!
1693     MutexLocker mu(SignatureHandlerLibrary_lock);
1694     if (_handlers != NULL) {
1695       handler_index = _handlers-&gt;find(method-&gt;signature_handler());
1696       uint64_t fingerprint = Fingerprinter(method).fingerprint();
1697       fingerprint = InterpreterRuntime::normalize_fast_native_fingerprint(fingerprint);
1698       fingerprint_index = _fingerprints-&gt;find(fingerprint);
1699     }
1700   }
1701   assert(method-&gt;signature_handler() == Interpreter::slow_signature_handler() ||
1702          handler_index == fingerprint_index, &quot;sanity check&quot;);
1703 #endif // ASSERT
1704 }
1705 
1706 void SignatureHandlerLibrary::add(uint64_t fingerprint, address handler) {
1707   int handler_index = -1;
1708   // use customized signature handler
1709   MutexLocker mu(SignatureHandlerLibrary_lock);
1710   // make sure data structure is initialized
1711   initialize();
1712   fingerprint = InterpreterRuntime::normalize_fast_native_fingerprint(fingerprint);
1713   handler_index = _fingerprints-&gt;find(fingerprint);
1714   // create handler if necessary
1715   if (handler_index &lt; 0) {
1716     if (PrintSignatureHandlers &amp;&amp; (handler != Interpreter::slow_signature_handler())) {
1717       tty-&gt;cr();
1718       tty-&gt;print_cr(&quot;argument handler #%d at &quot; PTR_FORMAT &quot; for fingerprint &quot; UINT64_FORMAT,
1719                     _handlers-&gt;length(),
1720                     p2i(handler),
1721                     fingerprint);
1722     }
1723     _fingerprints-&gt;append(fingerprint);
1724     _handlers-&gt;append(handler);
1725   } else {
1726     if (PrintSignatureHandlers) {
1727       tty-&gt;cr();
1728       tty-&gt;print_cr(&quot;duplicate argument handler #%d for fingerprint &quot; UINT64_FORMAT &quot;(old: &quot; PTR_FORMAT &quot;, new : &quot; PTR_FORMAT &quot;)&quot;,
1729                     _handlers-&gt;length(),
1730                     fingerprint,
1731                     p2i(_handlers-&gt;at(handler_index)),
1732                     p2i(handler));
1733     }
1734   }
1735 }
1736 
1737 
1738 BufferBlob*              SignatureHandlerLibrary::_handler_blob = NULL;
1739 address                  SignatureHandlerLibrary::_handler      = NULL;
1740 GrowableArray&lt;uint64_t&gt;* SignatureHandlerLibrary::_fingerprints = NULL;
1741 GrowableArray&lt;address&gt;*  SignatureHandlerLibrary::_handlers     = NULL;
1742 address                  SignatureHandlerLibrary::_buffer       = NULL;
1743 
1744 
1745 JRT_ENTRY(void, InterpreterRuntime::prepare_native_call(JavaThread* thread, Method* method))
1746   methodHandle m(thread, method);
1747   assert(m-&gt;is_native(), &quot;sanity check&quot;);
1748   // lookup native function entry point if it doesn&#39;t exist
1749   bool in_base_library;
1750   if (!m-&gt;has_native_function()) {
1751     NativeLookup::lookup(m, in_base_library, CHECK);
1752   }
1753   // make sure signature handler is installed
1754   SignatureHandlerLibrary::add(m);
1755   // The interpreter entry point checks the signature handler first,
1756   // before trying to fetch the native entry point and klass mirror.
1757   // We must set the signature handler last, so that multiple processors
1758   // preparing the same method will be sure to see non-null entry &amp; mirror.
1759 JRT_END
1760 
1761 #if defined(IA32) || defined(AMD64) || defined(ARM)
1762 JRT_LEAF(void, InterpreterRuntime::popframe_move_outgoing_args(JavaThread* thread, void* src_address, void* dest_address))
1763   if (src_address == dest_address) {
1764     return;
1765   }
1766   ResetNoHandleMark rnm; // In a LEAF entry.
1767   HandleMark hm;
1768   ResourceMark rm;
1769   LastFrameAccessor last_frame(thread);
1770   assert(last_frame.is_interpreted_frame(), &quot;&quot;);
1771   jint bci = last_frame.bci();
1772   methodHandle mh(thread, last_frame.method());
1773   Bytecode_invoke invoke(mh, bci);
1774   ArgumentSizeComputer asc(invoke.signature());
1775   int size_of_arguments = (asc.size() + (invoke.has_receiver() ? 1 : 0)); // receiver
1776   Copy::conjoint_jbytes(src_address, dest_address,
1777                        size_of_arguments * Interpreter::stackElementSize);
1778 JRT_END
1779 #endif
1780 
1781 #if INCLUDE_JVMTI
1782 // This is a support of the JVMTI PopFrame interface.
1783 // Make sure it is an invokestatic of a polymorphic intrinsic that has a member_name argument
1784 // and return it as a vm_result so that it can be reloaded in the list of invokestatic parameters.
1785 // The member_name argument is a saved reference (in local#0) to the member_name.
1786 // For backward compatibility with some JDK versions (7, 8) it can also be a direct method handle.
1787 // FIXME: remove DMH case after j.l.i.InvokerBytecodeGenerator code shape is updated.
1788 JRT_ENTRY(void, InterpreterRuntime::member_name_arg_or_null(JavaThread* thread, address member_name,
1789                                                             Method* method, address bcp))
1790   Bytecodes::Code code = Bytecodes::code_at(method, bcp);
1791   if (code != Bytecodes::_invokestatic) {
1792     return;
1793   }
1794   ConstantPool* cpool = method-&gt;constants();
1795   int cp_index = Bytes::get_native_u2(bcp + 1) + ConstantPool::CPCACHE_INDEX_TAG;
1796   Symbol* cname = cpool-&gt;klass_name_at(cpool-&gt;klass_ref_index_at(cp_index));
1797   Symbol* mname = cpool-&gt;name_ref_at(cp_index);
1798 
1799   if (MethodHandles::has_member_arg(cname, mname)) {
1800     oop member_name_oop = (oop) member_name;
1801     if (java_lang_invoke_DirectMethodHandle::is_instance(member_name_oop)) {
1802       // FIXME: remove after j.l.i.InvokerBytecodeGenerator code shape is updated.
1803       member_name_oop = java_lang_invoke_DirectMethodHandle::member(member_name_oop);
1804     }
1805     thread-&gt;set_vm_result(member_name_oop);
1806   } else {
1807     thread-&gt;set_vm_result(NULL);
1808   }
1809 JRT_END
1810 #endif // INCLUDE_JVMTI
1811 
1812 #ifndef PRODUCT
1813 // This must be a JRT_LEAF function because the interpreter must save registers on x86 to
1814 // call this, which changes rsp and makes the interpreter&#39;s expression stack not walkable.
1815 // The generated code still uses call_VM because that will set up the frame pointer for
1816 // bcp and method.
1817 JRT_LEAF(intptr_t, InterpreterRuntime::trace_bytecode(JavaThread* thread, intptr_t preserve_this_value, intptr_t tos, intptr_t tos2))
1818   LastFrameAccessor last_frame(thread);
1819   assert(last_frame.is_interpreted_frame(), &quot;must be an interpreted frame&quot;);
1820   methodHandle mh(thread, last_frame.method());
1821   BytecodeTracer::trace(mh, last_frame.bcp(), tos, tos2);
1822   return preserve_this_value;
1823 JRT_END
1824 #endif // !PRODUCT
    </pre>
  </body>
</html>