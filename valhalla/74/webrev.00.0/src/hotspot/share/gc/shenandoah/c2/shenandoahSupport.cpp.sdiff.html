<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/hotspot/share/gc/shenandoah/c2/shenandoahSupport.cpp</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
  </head>
<body>
<center><a href="../../parallel/psPromotionManager.cpp.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="../shenandoahBarrierSet.inline.hpp.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/hotspot/share/gc/shenandoah/c2/shenandoahSupport.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 906     IfNode* null_iff = new IfNode(old_ctrl, null_test, PROB_LIKELY(0.999), COUNT_UNKNOWN);
 907     ctrl             = new IfTrueNode(null_iff);
 908     null_ctrl        = new IfFalseNode(null_iff);
 909 
 910     IdealLoopTree* loop = phase-&gt;get_loop(old_ctrl);
 911     phase-&gt;register_control(null_iff,  loop, old_ctrl);
 912     phase-&gt;register_control(ctrl,      loop, null_iff);
 913     phase-&gt;register_control(null_ctrl, loop, null_iff);
 914 
 915     phase-&gt;register_new_node(null_cmp,  old_ctrl);
 916     phase-&gt;register_new_node(null_test, old_ctrl);
 917   }
 918 }
 919 
 920 void ShenandoahBarrierC2Support::test_in_cset(Node*&amp; ctrl, Node*&amp; not_cset_ctrl, Node* val, Node* raw_mem, PhaseIdealLoop* phase) {
 921   Node* old_ctrl = ctrl;
 922   PhaseIterGVN&amp; igvn = phase-&gt;igvn();
 923 
 924   Node* raw_val        = new CastP2XNode(old_ctrl, val);
 925   Node* cset_idx       = new URShiftXNode(raw_val, igvn.intcon(ShenandoahHeapRegion::region_size_bytes_shift_jint()));
<span class="line-modified"> 926   Node* cset_addr      = igvn.makecon(TypeRawPtr::make(ShenandoahHeap::in_cset_fast_test_addr()));</span>
<span class="line-modified"> 927   Node* cset_load_addr = new AddPNode(phase-&gt;C-&gt;top(), cset_addr, cset_idx);</span>
<span class="line-modified"> 928   Node* cset_load      = new LoadBNode(old_ctrl, raw_mem, cset_load_addr,</span>







 929                                        DEBUG_ONLY(phase-&gt;C-&gt;get_adr_type(Compile::AliasIdxRaw)) NOT_DEBUG(NULL),
 930                                        TypeInt::BYTE, MemNode::unordered);
 931   Node* cset_cmp       = new CmpINode(cset_load, igvn.zerocon(T_INT));
 932   Node* cset_bool      = new BoolNode(cset_cmp, BoolTest::ne);
 933 
 934   IfNode* cset_iff     = new IfNode(old_ctrl, cset_bool, PROB_UNLIKELY(0.999), COUNT_UNKNOWN);
 935   ctrl                 = new IfTrueNode(cset_iff);
 936   not_cset_ctrl        = new IfFalseNode(cset_iff);
 937 
 938   IdealLoopTree *loop = phase-&gt;get_loop(old_ctrl);
 939   phase-&gt;register_control(cset_iff,      loop, old_ctrl);
 940   phase-&gt;register_control(ctrl,          loop, cset_iff);
 941   phase-&gt;register_control(not_cset_ctrl, loop, cset_iff);
 942 
<span class="line-modified"> 943   phase-&gt;set_ctrl(cset_addr, phase-&gt;C-&gt;root());</span>
 944 
 945   phase-&gt;register_new_node(raw_val,        old_ctrl);
 946   phase-&gt;register_new_node(cset_idx,       old_ctrl);

 947   phase-&gt;register_new_node(cset_load_addr, old_ctrl);

 948   phase-&gt;register_new_node(cset_load,      old_ctrl);
 949   phase-&gt;register_new_node(cset_cmp,       old_ctrl);
 950   phase-&gt;register_new_node(cset_bool,      old_ctrl);
 951 }
 952 
 953 void ShenandoahBarrierC2Support::call_lrb_stub(Node*&amp; ctrl, Node*&amp; val, Node* load_addr, Node*&amp; result_mem, Node* raw_mem, bool is_native, PhaseIdealLoop* phase) {
 954   IdealLoopTree*loop = phase-&gt;get_loop(ctrl);
 955   const TypePtr* obj_type = phase-&gt;igvn().type(val)-&gt;is_oopptr();
 956 
 957   // The slow path stub consumes and produces raw memory in addition
 958   // to the existing memory edges
 959   Node* base = find_bottom_mem(ctrl, phase);
 960   MergeMemNode* mm = MergeMemNode::make(base);
 961   mm-&gt;set_memory_at(Compile::AliasIdxRaw, raw_mem);
 962   phase-&gt;register_new_node(mm, ctrl);
 963 
 964   address target = LP64_ONLY(UseCompressedOops) NOT_LP64(false) ?
 965           CAST_FROM_FN_PTR(address, ShenandoahRuntime::load_reference_barrier_narrow) :
 966           CAST_FROM_FN_PTR(address, ShenandoahRuntime::load_reference_barrier);
 967 
</pre>
</td>
<td>
<hr />
<pre>
 906     IfNode* null_iff = new IfNode(old_ctrl, null_test, PROB_LIKELY(0.999), COUNT_UNKNOWN);
 907     ctrl             = new IfTrueNode(null_iff);
 908     null_ctrl        = new IfFalseNode(null_iff);
 909 
 910     IdealLoopTree* loop = phase-&gt;get_loop(old_ctrl);
 911     phase-&gt;register_control(null_iff,  loop, old_ctrl);
 912     phase-&gt;register_control(ctrl,      loop, null_iff);
 913     phase-&gt;register_control(null_ctrl, loop, null_iff);
 914 
 915     phase-&gt;register_new_node(null_cmp,  old_ctrl);
 916     phase-&gt;register_new_node(null_test, old_ctrl);
 917   }
 918 }
 919 
 920 void ShenandoahBarrierC2Support::test_in_cset(Node*&amp; ctrl, Node*&amp; not_cset_ctrl, Node* val, Node* raw_mem, PhaseIdealLoop* phase) {
 921   Node* old_ctrl = ctrl;
 922   PhaseIterGVN&amp; igvn = phase-&gt;igvn();
 923 
 924   Node* raw_val        = new CastP2XNode(old_ctrl, val);
 925   Node* cset_idx       = new URShiftXNode(raw_val, igvn.intcon(ShenandoahHeapRegion::region_size_bytes_shift_jint()));
<span class="line-modified"> 926 </span>
<span class="line-modified"> 927   // Figure out the target cset address with raw pointer math.</span>
<span class="line-modified"> 928   // This avoids matching AddP+LoadB that would emit inefficient code.</span>
<span class="line-added"> 929   // See JDK-8245465.</span>
<span class="line-added"> 930   Node* cset_addr_ptr  = igvn.makecon(TypeRawPtr::make(ShenandoahHeap::in_cset_fast_test_addr()));</span>
<span class="line-added"> 931   Node* cset_addr      = new CastP2XNode(old_ctrl, cset_addr_ptr);</span>
<span class="line-added"> 932   Node* cset_load_addr = new AddXNode(cset_addr, cset_idx);</span>
<span class="line-added"> 933   Node* cset_load_ptr  = new CastX2PNode(cset_load_addr);</span>
<span class="line-added"> 934 </span>
<span class="line-added"> 935   Node* cset_load      = new LoadBNode(old_ctrl, raw_mem, cset_load_ptr,</span>
 936                                        DEBUG_ONLY(phase-&gt;C-&gt;get_adr_type(Compile::AliasIdxRaw)) NOT_DEBUG(NULL),
 937                                        TypeInt::BYTE, MemNode::unordered);
 938   Node* cset_cmp       = new CmpINode(cset_load, igvn.zerocon(T_INT));
 939   Node* cset_bool      = new BoolNode(cset_cmp, BoolTest::ne);
 940 
 941   IfNode* cset_iff     = new IfNode(old_ctrl, cset_bool, PROB_UNLIKELY(0.999), COUNT_UNKNOWN);
 942   ctrl                 = new IfTrueNode(cset_iff);
 943   not_cset_ctrl        = new IfFalseNode(cset_iff);
 944 
 945   IdealLoopTree *loop = phase-&gt;get_loop(old_ctrl);
 946   phase-&gt;register_control(cset_iff,      loop, old_ctrl);
 947   phase-&gt;register_control(ctrl,          loop, cset_iff);
 948   phase-&gt;register_control(not_cset_ctrl, loop, cset_iff);
 949 
<span class="line-modified"> 950   phase-&gt;set_ctrl(cset_addr_ptr, phase-&gt;C-&gt;root());</span>
 951 
 952   phase-&gt;register_new_node(raw_val,        old_ctrl);
 953   phase-&gt;register_new_node(cset_idx,       old_ctrl);
<span class="line-added"> 954   phase-&gt;register_new_node(cset_addr,      old_ctrl);</span>
 955   phase-&gt;register_new_node(cset_load_addr, old_ctrl);
<span class="line-added"> 956   phase-&gt;register_new_node(cset_load_ptr,  old_ctrl);</span>
 957   phase-&gt;register_new_node(cset_load,      old_ctrl);
 958   phase-&gt;register_new_node(cset_cmp,       old_ctrl);
 959   phase-&gt;register_new_node(cset_bool,      old_ctrl);
 960 }
 961 
 962 void ShenandoahBarrierC2Support::call_lrb_stub(Node*&amp; ctrl, Node*&amp; val, Node* load_addr, Node*&amp; result_mem, Node* raw_mem, bool is_native, PhaseIdealLoop* phase) {
 963   IdealLoopTree*loop = phase-&gt;get_loop(ctrl);
 964   const TypePtr* obj_type = phase-&gt;igvn().type(val)-&gt;is_oopptr();
 965 
 966   // The slow path stub consumes and produces raw memory in addition
 967   // to the existing memory edges
 968   Node* base = find_bottom_mem(ctrl, phase);
 969   MergeMemNode* mm = MergeMemNode::make(base);
 970   mm-&gt;set_memory_at(Compile::AliasIdxRaw, raw_mem);
 971   phase-&gt;register_new_node(mm, ctrl);
 972 
 973   address target = LP64_ONLY(UseCompressedOops) NOT_LP64(false) ?
 974           CAST_FROM_FN_PTR(address, ShenandoahRuntime::load_reference_barrier_narrow) :
 975           CAST_FROM_FN_PTR(address, ShenandoahRuntime::load_reference_barrier);
 976 
</pre>
</td>
</tr>
</table>
<center><a href="../../parallel/psPromotionManager.cpp.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="../shenandoahBarrierSet.inline.hpp.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>