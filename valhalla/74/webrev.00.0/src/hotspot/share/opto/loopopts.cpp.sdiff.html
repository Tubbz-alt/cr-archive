<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/hotspot/share/opto/loopopts.cpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
  </head>
<body>
<center><a href="loopnode.hpp.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="output.cpp.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/hotspot/share/opto/loopopts.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
2258         set_loop(newuse, use_loop);
2259         set_idom(newuse, nnn, dom_depth(nnn) + 1 );
2260 
2261         // We need a Region to merge the exit from the peeled body and the
2262         // exit from the old loop body.
2263         RegionNode *r = new RegionNode(3);
2264         // Map the old use to the new merge point
2265         old_new.map( use-&gt;_idx, r );
2266         uint dd_r = MIN2(dom_depth(newuse),dom_depth(use));
2267         assert( dd_r &gt;= dom_depth(dom_lca(newuse,use)), &quot;&quot; );
2268 
2269         // The original user of &#39;use&#39; uses &#39;r&#39; instead.
2270         for (DUIterator_Last lmin, l = use-&gt;last_outs(lmin); l &gt;= lmin;) {
2271           Node* useuse = use-&gt;last_out(l);
2272           _igvn.rehash_node_delayed(useuse);
2273           uint uses_found = 0;
2274           if( useuse-&gt;in(0) == use ) {
2275             useuse-&gt;set_req(0, r);
2276             uses_found++;
2277             if( useuse-&gt;is_CFG() ) {
<span class="line-modified">2278               assert( dom_depth(useuse) &gt; dd_r, &quot;&quot; );</span>



2279               set_idom(useuse, r, dom_depth(useuse));
2280             }
2281           }
2282           for( uint k = 1; k &lt; useuse-&gt;req(); k++ ) {
2283             if( useuse-&gt;in(k) == use ) {
2284               useuse-&gt;set_req(k, r);
2285               uses_found++;
2286               if (useuse-&gt;is_Loop() &amp;&amp; k == LoopNode::EntryControl) {
<span class="line-modified">2287                 assert(dom_depth(useuse) &gt; dd_r , &quot;&quot;);</span>



2288                 set_idom(useuse, r, dom_depth(useuse));
2289               }
2290             }
2291           }
2292           l -= uses_found;    // we deleted 1 or more copies of this edge
2293         }
2294 
2295         // Now finish up &#39;r&#39;
2296         r-&gt;set_req( 1, newuse );
2297         r-&gt;set_req( 2,    use );
2298         _igvn.register_new_node_with_optimizer(r);
2299         set_loop(r, use_loop);
2300         set_idom(r, !side_by_side_idom ? newuse-&gt;in(0) : side_by_side_idom, dd_r);
2301       } // End of if a loop-exit test
2302     }
2303   }
2304 
2305   // Step 4: If loop-invariant use is not control, it must be dominated by a
2306   // loop exit IfFalse/IfTrue.  Find &quot;proper&quot; loop exit.  Make a Region
2307   // there if needed.  Make a Phi there merging old and new used values.
</pre>
</td>
<td>
<hr />
<pre>
2258         set_loop(newuse, use_loop);
2259         set_idom(newuse, nnn, dom_depth(nnn) + 1 );
2260 
2261         // We need a Region to merge the exit from the peeled body and the
2262         // exit from the old loop body.
2263         RegionNode *r = new RegionNode(3);
2264         // Map the old use to the new merge point
2265         old_new.map( use-&gt;_idx, r );
2266         uint dd_r = MIN2(dom_depth(newuse),dom_depth(use));
2267         assert( dd_r &gt;= dom_depth(dom_lca(newuse,use)), &quot;&quot; );
2268 
2269         // The original user of &#39;use&#39; uses &#39;r&#39; instead.
2270         for (DUIterator_Last lmin, l = use-&gt;last_outs(lmin); l &gt;= lmin;) {
2271           Node* useuse = use-&gt;last_out(l);
2272           _igvn.rehash_node_delayed(useuse);
2273           uint uses_found = 0;
2274           if( useuse-&gt;in(0) == use ) {
2275             useuse-&gt;set_req(0, r);
2276             uses_found++;
2277             if( useuse-&gt;is_CFG() ) {
<span class="line-modified">2278               // This is not a dom_depth &gt; dd_r because when new</span>
<span class="line-added">2279               // control flow is constructed by a loop opt, a node and</span>
<span class="line-added">2280               // its dominator can end up at the same dom_depth</span>
<span class="line-added">2281               assert(dom_depth(useuse) &gt;= dd_r, &quot;&quot;);</span>
2282               set_idom(useuse, r, dom_depth(useuse));
2283             }
2284           }
2285           for( uint k = 1; k &lt; useuse-&gt;req(); k++ ) {
2286             if( useuse-&gt;in(k) == use ) {
2287               useuse-&gt;set_req(k, r);
2288               uses_found++;
2289               if (useuse-&gt;is_Loop() &amp;&amp; k == LoopNode::EntryControl) {
<span class="line-modified">2290                 // This is not a dom_depth &gt; dd_r because when new</span>
<span class="line-added">2291                 // control flow is constructed by a loop opt, a node</span>
<span class="line-added">2292                 // and its dominator can end up at the same dom_depth</span>
<span class="line-added">2293                 assert(dom_depth(useuse) &gt;= dd_r , &quot;&quot;);</span>
2294                 set_idom(useuse, r, dom_depth(useuse));
2295               }
2296             }
2297           }
2298           l -= uses_found;    // we deleted 1 or more copies of this edge
2299         }
2300 
2301         // Now finish up &#39;r&#39;
2302         r-&gt;set_req( 1, newuse );
2303         r-&gt;set_req( 2,    use );
2304         _igvn.register_new_node_with_optimizer(r);
2305         set_loop(r, use_loop);
2306         set_idom(r, !side_by_side_idom ? newuse-&gt;in(0) : side_by_side_idom, dd_r);
2307       } // End of if a loop-exit test
2308     }
2309   }
2310 
2311   // Step 4: If loop-invariant use is not control, it must be dominated by a
2312   // loop exit IfFalse/IfTrue.  Find &quot;proper&quot; loop exit.  Make a Region
2313   // there if needed.  Make a Phi there merging old and new used values.
</pre>
</td>
</tr>
</table>
<center><a href="loopnode.hpp.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="output.cpp.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>