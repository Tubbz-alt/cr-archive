<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/hotspot/share/prims/jvm.cpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
  </head>
<body>
<center><a href="jniCheck.cpp.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="../runtime/arguments.cpp.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/hotspot/share/prims/jvm.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 795   oop mirror = NULL;
 796   BasicType t = name2type(utf);
 797   if (t != T_ILLEGAL &amp;&amp; !is_reference_type(t)) {
 798     mirror = Universe::java_mirror(t);
 799   }
 800   if (mirror == NULL) {
 801     THROW_MSG_0(vmSymbols::java_lang_ClassNotFoundException(), (char*) utf);
 802   } else {
 803     return (jclass) JNIHandles::make_local(env, mirror);
 804   }
 805 JVM_END
 806 
 807 
 808 // Returns a class loaded by the bootstrap class loader; or null
 809 // if not found.  ClassNotFoundException is not thrown.
 810 // FindClassFromBootLoader is exported to the launcher for windows.
 811 JVM_ENTRY(jclass, JVM_FindClassFromBootLoader(JNIEnv* env,
 812                                               const char* name))
 813   JVMWrapper(&quot;JVM_FindClassFromBootLoader&quot;);
 814 
<span class="line-modified"> 815   // Java libraries should ensure that name is never null...</span>
 816   if (name == NULL || (int)strlen(name) &gt; Symbol::max_length()) {
 817     // It&#39;s impossible to create this class;  the name cannot fit
 818     // into the constant pool.
 819     return NULL;
 820   }

 821 
 822   TempNewSymbol h_name = SymbolTable::new_symbol(name);
 823   Klass* k = SystemDictionary::resolve_or_null(h_name, CHECK_NULL);
 824   if (k == NULL) {
 825     return NULL;
 826   }
 827 
 828   if (log_is_enabled(Debug, class, resolve)) {
 829     trace_class_resolution(k);
 830   }
 831   return (jclass) JNIHandles::make_local(env, k-&gt;java_mirror());
 832 JVM_END
 833 
 834 // Find a class with this name in this loader, using the caller&#39;s protection domain.
 835 JVM_ENTRY(jclass, JVM_FindClassFromCaller(JNIEnv* env, const char* name,
 836                                           jboolean init, jobject loader,
 837                                           jclass caller))
 838   JVMWrapper(&quot;JVM_FindClassFromCaller throws ClassNotFoundException&quot;);
<span class="line-modified"> 839   // Java libraries should ensure that name is never null...</span>
<span class="line-modified"> 840   if (name == NULL || (int)strlen(name) &gt; Symbol::max_length()) {</span>
<span class="line-modified"> 841     // It&#39;s impossible to create this class;  the name cannot fit</span>
<span class="line-removed"> 842     // into the constant pool.</span>
<span class="line-removed"> 843     THROW_MSG_0(vmSymbols::java_lang_ClassNotFoundException(), name);</span>
<span class="line-removed"> 844   }</span>
<span class="line-removed"> 845 </span>
 846   TempNewSymbol h_name = SymbolTable::new_symbol(name);
 847 
 848   oop loader_oop = JNIHandles::resolve(loader);
 849   oop from_class = JNIHandles::resolve(caller);
 850   oop protection_domain = NULL;
 851   // If loader is null, shouldn&#39;t call ClassLoader.checkPackageAccess; otherwise get
 852   // NPE. Put it in another way, the bootstrap class loader has all permission and
 853   // thus no checkPackageAccess equivalence in the VM class loader.
 854   // The caller is also passed as NULL by the java code if there is no security
 855   // manager to avoid the performance cost of getting the calling class.
 856   if (from_class != NULL &amp;&amp; loader_oop != NULL) {
 857     protection_domain = java_lang_Class::as_Klass(from_class)-&gt;protection_domain();
 858   }
 859 
 860   Handle h_loader(THREAD, loader_oop);
 861   Handle h_prot(THREAD, protection_domain);
 862   jclass result = find_class_from_class_loader(env, h_name, init, h_loader,
 863                                                h_prot, false, THREAD);
 864 
 865   if (log_is_enabled(Debug, class, resolve) &amp;&amp; result != NULL) {
 866     trace_class_resolution(java_lang_Class::as_Klass(JNIHandles::resolve_non_null(result)));
 867   }
 868   return result;
 869 JVM_END
 870 
 871 // Currently only called from the old verifier.
 872 JVM_ENTRY(jclass, JVM_FindClassFromClass(JNIEnv *env, const char *name,
 873                                          jboolean init, jclass from))
 874   JVMWrapper(&quot;JVM_FindClassFromClass&quot;);
<span class="line-modified"> 875   if (name == NULL) {</span>
<span class="line-modified"> 876     THROW_MSG_0(vmSymbols::java_lang_NoClassDefFoundError(), &quot;No class name given&quot;);</span>
<span class="line-modified"> 877   }</span>
<span class="line-removed"> 878   if ((int)strlen(name) &gt; Symbol::max_length()) {</span>
<span class="line-removed"> 879     // It&#39;s impossible to create this class;  the name cannot fit</span>
<span class="line-removed"> 880     // into the constant pool.</span>
<span class="line-removed"> 881     Exceptions::fthrow(THREAD_AND_LOCATION,</span>
<span class="line-removed"> 882                        vmSymbols::java_lang_NoClassDefFoundError(),</span>
<span class="line-removed"> 883                        &quot;Class name exceeds maximum length of %d: %s&quot;,</span>
<span class="line-removed"> 884                        Symbol::max_length(),</span>
<span class="line-removed"> 885                        name);</span>
<span class="line-removed"> 886     return 0;</span>
<span class="line-removed"> 887   }</span>
<span class="line-removed"> 888   TempNewSymbol h_name = SymbolTable::new_symbol(name);</span>
 889   oop from_class_oop = JNIHandles::resolve(from);
 890   Klass* from_class = (from_class_oop == NULL)
 891                            ? (Klass*)NULL
 892                            : java_lang_Class::as_Klass(from_class_oop);
 893   oop class_loader = NULL;
 894   oop protection_domain = NULL;
 895   if (from_class != NULL) {
 896     class_loader = from_class-&gt;class_loader();
 897     protection_domain = from_class-&gt;protection_domain();
 898   }
 899   Handle h_loader(THREAD, class_loader);
 900   Handle h_prot  (THREAD, protection_domain);
 901   jclass result = find_class_from_class_loader(env, h_name, init, h_loader,
 902                                                h_prot, true, thread);
 903 
 904   if (log_is_enabled(Debug, class, resolve) &amp;&amp; result != NULL) {
 905     // this function is generally only used for class loading during verification.
 906     ResourceMark rm;
 907     oop from_mirror = JNIHandles::resolve_non_null(from);
 908     Klass* from_class = java_lang_Class::as_Klass(from_mirror);
</pre>
<hr />
<pre>
 934 static jclass jvm_define_class_common(JNIEnv *env, const char *name,
 935                                       jobject loader, const jbyte *buf,
 936                                       jsize len, jobject pd, const char *source,
 937                                       TRAPS) {
 938   if (source == NULL)  source = &quot;__JVM_DefineClass__&quot;;
 939 
 940   assert(THREAD-&gt;is_Java_thread(), &quot;must be a JavaThread&quot;);
 941   JavaThread* jt = (JavaThread*) THREAD;
 942 
 943   PerfClassTraceTime vmtimer(ClassLoader::perf_define_appclass_time(),
 944                              ClassLoader::perf_define_appclass_selftime(),
 945                              ClassLoader::perf_define_appclasses(),
 946                              jt-&gt;get_thread_stat()-&gt;perf_recursion_counts_addr(),
 947                              jt-&gt;get_thread_stat()-&gt;perf_timers_addr(),
 948                              PerfClassTraceTime::DEFINE_CLASS);
 949 
 950   if (UsePerfData) {
 951     ClassLoader::perf_app_classfile_bytes_read()-&gt;inc(len);
 952   }
 953 
<span class="line-modified"> 954   // Since exceptions can be thrown, class initialization can take place</span>
<span class="line-modified"> 955   // if name is NULL no check for class name in .class stream has to be made.</span>
<span class="line-modified"> 956   TempNewSymbol class_name = NULL;</span>
<span class="line-modified"> 957   if (name != NULL) {</span>
<span class="line-removed"> 958     const int str_len = (int)strlen(name);</span>
<span class="line-removed"> 959     if (str_len &gt; Symbol::max_length()) {</span>
<span class="line-removed"> 960       // It&#39;s impossible to create this class;  the name cannot fit</span>
<span class="line-removed"> 961       // into the constant pool.</span>
<span class="line-removed"> 962       Exceptions::fthrow(THREAD_AND_LOCATION,</span>
<span class="line-removed"> 963                          vmSymbols::java_lang_NoClassDefFoundError(),</span>
<span class="line-removed"> 964                          &quot;Class name exceeds maximum length of %d: %s&quot;,</span>
<span class="line-removed"> 965                          Symbol::max_length(),</span>
<span class="line-removed"> 966                          name);</span>
<span class="line-removed"> 967       return 0;</span>
<span class="line-removed"> 968     }</span>
<span class="line-removed"> 969     class_name = SymbolTable::new_symbol(name, str_len);</span>
<span class="line-removed"> 970   }</span>
 971 
 972   ResourceMark rm(THREAD);
 973   ClassFileStream st((u1*)buf, len, source, ClassFileStream::verify);
 974   Handle class_loader (THREAD, JNIHandles::resolve(loader));
 975   if (UsePerfData) {
 976     is_lock_held_by_thread(class_loader,
 977                            ClassLoader::sync_JVMDefineClassLockFreeCounter(),
 978                            THREAD);
 979   }
 980   Handle protection_domain (THREAD, JNIHandles::resolve(pd));
 981   Klass* k = SystemDictionary::resolve_from_stream(class_name,
 982                                                    class_loader,
 983                                                    protection_domain,
 984                                                    &amp;st,
 985                                                    CHECK_NULL);
 986 
 987   if (log_is_enabled(Debug, class, resolve) &amp;&amp; k != NULL) {
 988     trace_class_resolution(k);
 989   }
 990 
</pre>
<hr />
<pre>
1039   if (!is_hidden) {
1040     // classData is only applicable for hidden classes
1041     if (classData != NULL) {
1042       THROW_MSG_0(vmSymbols::java_lang_IllegalArgumentException(), &quot;classData is only applicable for hidden classes&quot;);
1043     }
1044     if (is_nestmate) {
1045       THROW_MSG_0(vmSymbols::java_lang_IllegalArgumentException(), &quot;dynamic nestmate is only applicable for hidden classes&quot;);
1046     }
1047     if (!is_strong) {
1048       THROW_MSG_0(vmSymbols::java_lang_IllegalArgumentException(), &quot;an ordinary class must be strongly referenced by its defining loader&quot;);
1049     }
1050     if (vm_annotations) {
1051       THROW_MSG_0(vmSymbols::java_lang_IllegalArgumentException(), &quot;vm annotations only allowed for hidden classes&quot;);
1052     }
1053     if (flags != STRONG_LOADER_LINK) {
1054       THROW_MSG_0(vmSymbols::java_lang_IllegalArgumentException(),
1055                   err_msg(&quot;invalid flag 0x%x&quot;, flags));
1056     }
1057   }
1058 
<span class="line-modified">1059 </span>
<span class="line-modified">1060   // Since exceptions can be thrown, class initialization can take place</span>
<span class="line-modified">1061   // if name is NULL no check for class name in .class stream has to be made.</span>
<span class="line-modified">1062   TempNewSymbol class_name = NULL;</span>
<span class="line-removed">1063   if (name != NULL) {</span>
<span class="line-removed">1064     const int str_len = (int)strlen(name);</span>
<span class="line-removed">1065     if (str_len &gt; Symbol::max_length()) {</span>
<span class="line-removed">1066       // It&#39;s impossible to create this class;  the name cannot fit</span>
<span class="line-removed">1067       // into the constant pool.</span>
<span class="line-removed">1068       Exceptions::fthrow(THREAD_AND_LOCATION,</span>
<span class="line-removed">1069                          vmSymbols::java_lang_NoClassDefFoundError(),</span>
<span class="line-removed">1070                          &quot;Class name exceeds maximum length of %d: %s&quot;,</span>
<span class="line-removed">1071                          Symbol::max_length(),</span>
<span class="line-removed">1072                          name);</span>
<span class="line-removed">1073       return 0;</span>
<span class="line-removed">1074     }</span>
<span class="line-removed">1075     class_name = SymbolTable::new_symbol(name, str_len);</span>
<span class="line-removed">1076   }</span>
1077 
1078   Handle protection_domain (THREAD, JNIHandles::resolve(pd));
1079   const char* source = is_nestmate ? host_class-&gt;external_name() : &quot;__JVM_LookupDefineClass__&quot;;
1080   ClassFileStream st((u1*)buf, len, source, ClassFileStream::verify);
1081 
1082   Klass* defined_k;
1083   InstanceKlass* ik = NULL;
1084   if (!is_hidden) {
1085     defined_k = SystemDictionary::resolve_from_stream(class_name,
1086                                                       class_loader,
1087                                                       protection_domain,
1088                                                       &amp;st,
1089                                                       CHECK_NULL);
1090 
1091     if (log_is_enabled(Debug, class, resolve) &amp;&amp; defined_k != NULL) {
1092       trace_class_resolution(defined_k);
1093     }
1094     ik = InstanceKlass::cast(defined_k);
1095   } else { // hidden
1096     Handle classData_h(THREAD, JNIHandles::resolve(classData));
</pre>
</td>
<td>
<hr />
<pre>
 795   oop mirror = NULL;
 796   BasicType t = name2type(utf);
 797   if (t != T_ILLEGAL &amp;&amp; !is_reference_type(t)) {
 798     mirror = Universe::java_mirror(t);
 799   }
 800   if (mirror == NULL) {
 801     THROW_MSG_0(vmSymbols::java_lang_ClassNotFoundException(), (char*) utf);
 802   } else {
 803     return (jclass) JNIHandles::make_local(env, mirror);
 804   }
 805 JVM_END
 806 
 807 
 808 // Returns a class loaded by the bootstrap class loader; or null
 809 // if not found.  ClassNotFoundException is not thrown.
 810 // FindClassFromBootLoader is exported to the launcher for windows.
 811 JVM_ENTRY(jclass, JVM_FindClassFromBootLoader(JNIEnv* env,
 812                                               const char* name))
 813   JVMWrapper(&quot;JVM_FindClassFromBootLoader&quot;);
 814 
<span class="line-modified"> 815   // Java libraries should ensure that name is never null or illegal.</span>
 816   if (name == NULL || (int)strlen(name) &gt; Symbol::max_length()) {
 817     // It&#39;s impossible to create this class;  the name cannot fit
 818     // into the constant pool.
 819     return NULL;
 820   }
<span class="line-added"> 821   assert(UTF8::is_legal_utf8((const unsigned char*)name, (int)strlen(name), false), &quot;illegal UTF name&quot;);</span>
 822 
 823   TempNewSymbol h_name = SymbolTable::new_symbol(name);
 824   Klass* k = SystemDictionary::resolve_or_null(h_name, CHECK_NULL);
 825   if (k == NULL) {
 826     return NULL;
 827   }
 828 
 829   if (log_is_enabled(Debug, class, resolve)) {
 830     trace_class_resolution(k);
 831   }
 832   return (jclass) JNIHandles::make_local(env, k-&gt;java_mirror());
 833 JVM_END
 834 
 835 // Find a class with this name in this loader, using the caller&#39;s protection domain.
 836 JVM_ENTRY(jclass, JVM_FindClassFromCaller(JNIEnv* env, const char* name,
 837                                           jboolean init, jobject loader,
 838                                           jclass caller))
 839   JVMWrapper(&quot;JVM_FindClassFromCaller throws ClassNotFoundException&quot;);
<span class="line-modified"> 840 </span>
<span class="line-modified"> 841   TempNewSymbol h_name =</span>
<span class="line-modified"> 842        SystemDictionary::class_name_symbol(name, vmSymbols::java_lang_ClassNotFoundException(),</span>




 843                                            CHECK_NULL);
 844 
 845   oop loader_oop = JNIHandles::resolve(loader);
 846   oop from_class = JNIHandles::resolve(caller);
 847   oop protection_domain = NULL;
 848   // If loader is null, shouldn&#39;t call ClassLoader.checkPackageAccess; otherwise get
 849   // NPE. Put it in another way, the bootstrap class loader has all permission and
 850   // thus no checkPackageAccess equivalence in the VM class loader.
 851   // The caller is also passed as NULL by the java code if there is no security
 852   // manager to avoid the performance cost of getting the calling class.
 853   if (from_class != NULL &amp;&amp; loader_oop != NULL) {
 854     protection_domain = java_lang_Class::as_Klass(from_class)-&gt;protection_domain();
 855   }
 856 
 857   Handle h_loader(THREAD, loader_oop);
 858   Handle h_prot(THREAD, protection_domain);
 859   jclass result = find_class_from_class_loader(env, h_name, init, h_loader,
 860                                                h_prot, false, THREAD);
 861 
 862   if (log_is_enabled(Debug, class, resolve) &amp;&amp; result != NULL) {
 863     trace_class_resolution(java_lang_Class::as_Klass(JNIHandles::resolve_non_null(result)));
 864   }
 865   return result;
 866 JVM_END
 867 
 868 // Currently only called from the old verifier.
 869 JVM_ENTRY(jclass, JVM_FindClassFromClass(JNIEnv *env, const char *name,
 870                                          jboolean init, jclass from))
 871   JVMWrapper(&quot;JVM_FindClassFromClass&quot;);
<span class="line-modified"> 872   TempNewSymbol h_name =</span>
<span class="line-modified"> 873        SystemDictionary::class_name_symbol(name, vmSymbols::java_lang_ClassNotFoundException(),</span>
<span class="line-modified"> 874                                            CHECK_NULL);</span>











 875   oop from_class_oop = JNIHandles::resolve(from);
 876   Klass* from_class = (from_class_oop == NULL)
 877                            ? (Klass*)NULL
 878                            : java_lang_Class::as_Klass(from_class_oop);
 879   oop class_loader = NULL;
 880   oop protection_domain = NULL;
 881   if (from_class != NULL) {
 882     class_loader = from_class-&gt;class_loader();
 883     protection_domain = from_class-&gt;protection_domain();
 884   }
 885   Handle h_loader(THREAD, class_loader);
 886   Handle h_prot  (THREAD, protection_domain);
 887   jclass result = find_class_from_class_loader(env, h_name, init, h_loader,
 888                                                h_prot, true, thread);
 889 
 890   if (log_is_enabled(Debug, class, resolve) &amp;&amp; result != NULL) {
 891     // this function is generally only used for class loading during verification.
 892     ResourceMark rm;
 893     oop from_mirror = JNIHandles::resolve_non_null(from);
 894     Klass* from_class = java_lang_Class::as_Klass(from_mirror);
</pre>
<hr />
<pre>
 920 static jclass jvm_define_class_common(JNIEnv *env, const char *name,
 921                                       jobject loader, const jbyte *buf,
 922                                       jsize len, jobject pd, const char *source,
 923                                       TRAPS) {
 924   if (source == NULL)  source = &quot;__JVM_DefineClass__&quot;;
 925 
 926   assert(THREAD-&gt;is_Java_thread(), &quot;must be a JavaThread&quot;);
 927   JavaThread* jt = (JavaThread*) THREAD;
 928 
 929   PerfClassTraceTime vmtimer(ClassLoader::perf_define_appclass_time(),
 930                              ClassLoader::perf_define_appclass_selftime(),
 931                              ClassLoader::perf_define_appclasses(),
 932                              jt-&gt;get_thread_stat()-&gt;perf_recursion_counts_addr(),
 933                              jt-&gt;get_thread_stat()-&gt;perf_timers_addr(),
 934                              PerfClassTraceTime::DEFINE_CLASS);
 935 
 936   if (UsePerfData) {
 937     ClassLoader::perf_app_classfile_bytes_read()-&gt;inc(len);
 938   }
 939 
<span class="line-modified"> 940   // Class resolution will get the class name from the .class stream if the name is null.</span>
<span class="line-modified"> 941   TempNewSymbol class_name = name == NULL ? NULL :</span>
<span class="line-modified"> 942        SystemDictionary::class_name_symbol(name, vmSymbols::java_lang_NoClassDefFoundError(),</span>
<span class="line-modified"> 943                                            CHECK_NULL);</span>













 944 
 945   ResourceMark rm(THREAD);
 946   ClassFileStream st((u1*)buf, len, source, ClassFileStream::verify);
 947   Handle class_loader (THREAD, JNIHandles::resolve(loader));
 948   if (UsePerfData) {
 949     is_lock_held_by_thread(class_loader,
 950                            ClassLoader::sync_JVMDefineClassLockFreeCounter(),
 951                            THREAD);
 952   }
 953   Handle protection_domain (THREAD, JNIHandles::resolve(pd));
 954   Klass* k = SystemDictionary::resolve_from_stream(class_name,
 955                                                    class_loader,
 956                                                    protection_domain,
 957                                                    &amp;st,
 958                                                    CHECK_NULL);
 959 
 960   if (log_is_enabled(Debug, class, resolve) &amp;&amp; k != NULL) {
 961     trace_class_resolution(k);
 962   }
 963 
</pre>
<hr />
<pre>
1012   if (!is_hidden) {
1013     // classData is only applicable for hidden classes
1014     if (classData != NULL) {
1015       THROW_MSG_0(vmSymbols::java_lang_IllegalArgumentException(), &quot;classData is only applicable for hidden classes&quot;);
1016     }
1017     if (is_nestmate) {
1018       THROW_MSG_0(vmSymbols::java_lang_IllegalArgumentException(), &quot;dynamic nestmate is only applicable for hidden classes&quot;);
1019     }
1020     if (!is_strong) {
1021       THROW_MSG_0(vmSymbols::java_lang_IllegalArgumentException(), &quot;an ordinary class must be strongly referenced by its defining loader&quot;);
1022     }
1023     if (vm_annotations) {
1024       THROW_MSG_0(vmSymbols::java_lang_IllegalArgumentException(), &quot;vm annotations only allowed for hidden classes&quot;);
1025     }
1026     if (flags != STRONG_LOADER_LINK) {
1027       THROW_MSG_0(vmSymbols::java_lang_IllegalArgumentException(),
1028                   err_msg(&quot;invalid flag 0x%x&quot;, flags));
1029     }
1030   }
1031 
<span class="line-modified">1032   // Class resolution will get the class name from the .class stream if the name is null.</span>
<span class="line-modified">1033   TempNewSymbol class_name = name == NULL ? NULL :</span>
<span class="line-modified">1034        SystemDictionary::class_name_symbol(name, vmSymbols::java_lang_NoClassDefFoundError(),</span>
<span class="line-modified">1035                                            CHECK_NULL);</span>














1036 
1037   Handle protection_domain (THREAD, JNIHandles::resolve(pd));
1038   const char* source = is_nestmate ? host_class-&gt;external_name() : &quot;__JVM_LookupDefineClass__&quot;;
1039   ClassFileStream st((u1*)buf, len, source, ClassFileStream::verify);
1040 
1041   Klass* defined_k;
1042   InstanceKlass* ik = NULL;
1043   if (!is_hidden) {
1044     defined_k = SystemDictionary::resolve_from_stream(class_name,
1045                                                       class_loader,
1046                                                       protection_domain,
1047                                                       &amp;st,
1048                                                       CHECK_NULL);
1049 
1050     if (log_is_enabled(Debug, class, resolve) &amp;&amp; defined_k != NULL) {
1051       trace_class_resolution(defined_k);
1052     }
1053     ik = InstanceKlass::cast(defined_k);
1054   } else { // hidden
1055     Handle classData_h(THREAD, JNIHandles::resolve(classData));
</pre>
</td>
</tr>
</table>
<center><a href="jniCheck.cpp.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="../runtime/arguments.cpp.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>