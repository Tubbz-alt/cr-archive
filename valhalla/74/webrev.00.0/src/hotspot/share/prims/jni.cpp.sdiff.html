<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/hotspot/share/prims/jni.cpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
  </head>
<body>
<center><a href="../precompiled/precompiled.hpp.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="jniCheck.cpp.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/hotspot/share/prims/jni.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 301 #else
 302   #define JNIWrapper(arg)
 303 #endif
 304 
 305 
 306 // Implementation of JNI entries
 307 
 308 DT_RETURN_MARK_DECL(DefineClass, jclass
 309                     , HOTSPOT_JNI_DEFINECLASS_RETURN(_ret_ref));
 310 
 311 JNI_ENTRY(jclass, jni_DefineClass(JNIEnv *env, const char *name, jobject loaderRef,
 312                                   const jbyte *buf, jsize bufLen))
 313   JNIWrapper(&quot;DefineClass&quot;);
 314 
 315   HOTSPOT_JNI_DEFINECLASS_ENTRY(
 316     env, (char*) name, loaderRef, (char*) buf, bufLen);
 317 
 318   jclass cls = NULL;
 319   DT_RETURN_MARK(DefineClass, jclass, (const jclass&amp;)cls);
 320 
<span class="line-modified"> 321   TempNewSymbol class_name = NULL;</span>
<span class="line-modified"> 322   // Since exceptions can be thrown, class initialization can take place</span>
<span class="line-modified"> 323   // if name is NULL no check for class name in .class stream has to be made.</span>
<span class="line-modified"> 324   if (name != NULL) {</span>
<span class="line-modified"> 325     const int str_len = (int)strlen(name);</span>
<span class="line-removed"> 326     if (str_len &gt; Symbol::max_length()) {</span>
<span class="line-removed"> 327       // It&#39;s impossible to create this class;  the name cannot fit</span>
<span class="line-removed"> 328       // into the constant pool.</span>
<span class="line-removed"> 329       Exceptions::fthrow(THREAD_AND_LOCATION,</span>
<span class="line-removed"> 330                          vmSymbols::java_lang_NoClassDefFoundError(),</span>
<span class="line-removed"> 331                          &quot;Class name exceeds maximum length of %d: %s&quot;,</span>
<span class="line-removed"> 332                          Symbol::max_length(),</span>
<span class="line-removed"> 333                          name);</span>
<span class="line-removed"> 334       return 0;</span>
<span class="line-removed"> 335     }</span>
<span class="line-removed"> 336     class_name = SymbolTable::new_symbol(name);</span>
<span class="line-removed"> 337   }</span>
 338   ResourceMark rm(THREAD);
 339   ClassFileStream st((u1*)buf, bufLen, NULL, ClassFileStream::verify);
 340   Handle class_loader (THREAD, JNIHandles::resolve(loaderRef));
 341 
 342   if (UsePerfData &amp;&amp; !class_loader.is_null()) {
 343     // check whether the current caller thread holds the lock or not.
 344     // If not, increment the corresponding counter
 345     if (ObjectSynchronizer::
 346         query_lock_ownership((JavaThread*)THREAD, class_loader) !=
 347         ObjectSynchronizer::owner_self) {
 348       ClassLoader::sync_JNIDefineClassLockFreeCounter()-&gt;inc();
 349     }
 350   }
 351   Klass* k = SystemDictionary::resolve_from_stream(class_name,
 352                                                    class_loader,
 353                                                    Handle(),
 354                                                    &amp;st,
 355                                                    CHECK_NULL);
 356 
 357   if (log_is_enabled(Debug, class, resolve) &amp;&amp; k != NULL) {
</pre>
<hr />
<pre>
 359   }
 360 
 361   cls = (jclass)JNIHandles::make_local(
 362     env, k-&gt;java_mirror());
 363   return cls;
 364 JNI_END
 365 
 366 
 367 
 368 DT_RETURN_MARK_DECL(FindClass, jclass
 369                     , HOTSPOT_JNI_FINDCLASS_RETURN(_ret_ref));
 370 
 371 JNI_ENTRY(jclass, jni_FindClass(JNIEnv *env, const char *name))
 372   JNIWrapper(&quot;FindClass&quot;);
 373 
 374   HOTSPOT_JNI_FINDCLASS_ENTRY(env, (char *)name);
 375 
 376   jclass result = NULL;
 377   DT_RETURN_MARK(FindClass, jclass, (const jclass&amp;)result);
 378 
<span class="line-modified"> 379   // Sanity check the name:  it cannot be null or larger than the maximum size</span>
<span class="line-modified"> 380   // name we can fit in the constant pool.</span>
<span class="line-modified"> 381   if (name == NULL) {</span>
<span class="line-modified"> 382     THROW_MSG_0(vmSymbols::java_lang_NoClassDefFoundError(), &quot;No class name given&quot;);</span>
<span class="line-removed"> 383   }</span>
<span class="line-removed"> 384   if ((int)strlen(name) &gt; Symbol::max_length()) {</span>
<span class="line-removed"> 385     Exceptions::fthrow(THREAD_AND_LOCATION,</span>
<span class="line-removed"> 386                        vmSymbols::java_lang_NoClassDefFoundError(),</span>
<span class="line-removed"> 387                        &quot;Class name exceeds maximum length of %d: %s&quot;,</span>
<span class="line-removed"> 388                        Symbol::max_length(),</span>
<span class="line-removed"> 389                        name);</span>
<span class="line-removed"> 390     return 0;</span>
<span class="line-removed"> 391   }</span>
 392 
 393   //%note jni_3
 394   Handle protection_domain;
 395   // Find calling class
 396   Klass* k = thread-&gt;security_get_caller_class(0);
 397   // default to the system loader when no context
 398   Handle loader(THREAD, SystemDictionary::java_system_loader());
 399   if (k != NULL) {
 400     // Special handling to make sure JNI_OnLoad and JNI_OnUnload are executed
 401     // in the correct class context.
 402     if (k-&gt;class_loader() == NULL &amp;&amp;
 403         k-&gt;name() == vmSymbols::jdk_internal_loader_NativeLibraries()) {
 404       JavaValue result(T_OBJECT);
 405       JavaCalls::call_static(&amp;result, k,
 406                              vmSymbols::getFromClass_name(),
 407                              vmSymbols::void_class_signature(),
 408                              CHECK_NULL);
 409       // When invoked from JNI_OnLoad, NativeLibraries::getFromClass returns
 410       // a non-NULL Class object.  When invoked from JNI_OnUnload,
 411       // it will return NULL to indicate no context.
 412       oop mirror = (oop) result.get_jobject();
 413       if (mirror != NULL) {
 414         Klass* fromClass = java_lang_Class::as_Klass(mirror);
 415         loader = Handle(THREAD, fromClass-&gt;class_loader());
 416         protection_domain = Handle(THREAD, fromClass-&gt;protection_domain());
 417       }
 418     } else {
 419       loader = Handle(THREAD, k-&gt;class_loader());
 420     }
 421   }
 422 
<span class="line-modified"> 423   TempNewSymbol sym = SymbolTable::new_symbol(name);</span>
<span class="line-removed"> 424   result = find_class_from_class_loader(env, sym, true, loader,</span>
 425                                         protection_domain, true, thread);
 426 
 427   if (log_is_enabled(Debug, class, resolve) &amp;&amp; result != NULL) {
 428     trace_class_resolution(java_lang_Class::as_Klass(JNIHandles::resolve_non_null(result)));
 429   }
 430 
 431   return result;
 432 JNI_END
 433 
 434 DT_RETURN_MARK_DECL(FromReflectedMethod, jmethodID
 435                     , HOTSPOT_JNI_FROMREFLECTEDMETHOD_RETURN((uintptr_t)_ret_ref));
 436 
 437 JNI_ENTRY(jmethodID, jni_FromReflectedMethod(JNIEnv *env, jobject method))
 438   JNIWrapper(&quot;FromReflectedMethod&quot;);
 439 
 440   HOTSPOT_JNI_FROMREFLECTEDMETHOD_ENTRY(env, method);
 441 
 442   jmethodID ret = NULL;
 443   DT_RETURN_MARK(FromReflectedMethod, jmethodID, (const jmethodID&amp;)ret);
 444 
</pre>
</td>
<td>
<hr />
<pre>
 301 #else
 302   #define JNIWrapper(arg)
 303 #endif
 304 
 305 
 306 // Implementation of JNI entries
 307 
 308 DT_RETURN_MARK_DECL(DefineClass, jclass
 309                     , HOTSPOT_JNI_DEFINECLASS_RETURN(_ret_ref));
 310 
 311 JNI_ENTRY(jclass, jni_DefineClass(JNIEnv *env, const char *name, jobject loaderRef,
 312                                   const jbyte *buf, jsize bufLen))
 313   JNIWrapper(&quot;DefineClass&quot;);
 314 
 315   HOTSPOT_JNI_DEFINECLASS_ENTRY(
 316     env, (char*) name, loaderRef, (char*) buf, bufLen);
 317 
 318   jclass cls = NULL;
 319   DT_RETURN_MARK(DefineClass, jclass, (const jclass&amp;)cls);
 320 
<span class="line-modified"> 321   // Class resolution will get the class name from the .class stream if the name is null.</span>
<span class="line-modified"> 322   TempNewSymbol class_name = name == NULL ? NULL :</span>
<span class="line-modified"> 323     SystemDictionary::class_name_symbol(name, vmSymbols::java_lang_NoClassDefFoundError(),</span>
<span class="line-modified"> 324                                         CHECK_NULL);</span>
<span class="line-modified"> 325 </span>












 326   ResourceMark rm(THREAD);
 327   ClassFileStream st((u1*)buf, bufLen, NULL, ClassFileStream::verify);
 328   Handle class_loader (THREAD, JNIHandles::resolve(loaderRef));
 329 
 330   if (UsePerfData &amp;&amp; !class_loader.is_null()) {
 331     // check whether the current caller thread holds the lock or not.
 332     // If not, increment the corresponding counter
 333     if (ObjectSynchronizer::
 334         query_lock_ownership((JavaThread*)THREAD, class_loader) !=
 335         ObjectSynchronizer::owner_self) {
 336       ClassLoader::sync_JNIDefineClassLockFreeCounter()-&gt;inc();
 337     }
 338   }
 339   Klass* k = SystemDictionary::resolve_from_stream(class_name,
 340                                                    class_loader,
 341                                                    Handle(),
 342                                                    &amp;st,
 343                                                    CHECK_NULL);
 344 
 345   if (log_is_enabled(Debug, class, resolve) &amp;&amp; k != NULL) {
</pre>
<hr />
<pre>
 347   }
 348 
 349   cls = (jclass)JNIHandles::make_local(
 350     env, k-&gt;java_mirror());
 351   return cls;
 352 JNI_END
 353 
 354 
 355 
 356 DT_RETURN_MARK_DECL(FindClass, jclass
 357                     , HOTSPOT_JNI_FINDCLASS_RETURN(_ret_ref));
 358 
 359 JNI_ENTRY(jclass, jni_FindClass(JNIEnv *env, const char *name))
 360   JNIWrapper(&quot;FindClass&quot;);
 361 
 362   HOTSPOT_JNI_FINDCLASS_ENTRY(env, (char *)name);
 363 
 364   jclass result = NULL;
 365   DT_RETURN_MARK(FindClass, jclass, (const jclass&amp;)result);
 366 
<span class="line-modified"> 367   // This should be ClassNotFoundException imo.</span>
<span class="line-modified"> 368   TempNewSymbol class_name =</span>
<span class="line-modified"> 369     SystemDictionary::class_name_symbol(name, vmSymbols::java_lang_NoClassDefFoundError(),</span>
<span class="line-modified"> 370                                         CHECK_NULL);</span>









 371 
 372   //%note jni_3
 373   Handle protection_domain;
 374   // Find calling class
 375   Klass* k = thread-&gt;security_get_caller_class(0);
 376   // default to the system loader when no context
 377   Handle loader(THREAD, SystemDictionary::java_system_loader());
 378   if (k != NULL) {
 379     // Special handling to make sure JNI_OnLoad and JNI_OnUnload are executed
 380     // in the correct class context.
 381     if (k-&gt;class_loader() == NULL &amp;&amp;
 382         k-&gt;name() == vmSymbols::jdk_internal_loader_NativeLibraries()) {
 383       JavaValue result(T_OBJECT);
 384       JavaCalls::call_static(&amp;result, k,
 385                              vmSymbols::getFromClass_name(),
 386                              vmSymbols::void_class_signature(),
 387                              CHECK_NULL);
 388       // When invoked from JNI_OnLoad, NativeLibraries::getFromClass returns
 389       // a non-NULL Class object.  When invoked from JNI_OnUnload,
 390       // it will return NULL to indicate no context.
 391       oop mirror = (oop) result.get_jobject();
 392       if (mirror != NULL) {
 393         Klass* fromClass = java_lang_Class::as_Klass(mirror);
 394         loader = Handle(THREAD, fromClass-&gt;class_loader());
 395         protection_domain = Handle(THREAD, fromClass-&gt;protection_domain());
 396       }
 397     } else {
 398       loader = Handle(THREAD, k-&gt;class_loader());
 399     }
 400   }
 401 
<span class="line-modified"> 402   result = find_class_from_class_loader(env, class_name, true, loader,</span>

 403                                         protection_domain, true, thread);
 404 
 405   if (log_is_enabled(Debug, class, resolve) &amp;&amp; result != NULL) {
 406     trace_class_resolution(java_lang_Class::as_Klass(JNIHandles::resolve_non_null(result)));
 407   }
 408 
 409   return result;
 410 JNI_END
 411 
 412 DT_RETURN_MARK_DECL(FromReflectedMethod, jmethodID
 413                     , HOTSPOT_JNI_FROMREFLECTEDMETHOD_RETURN((uintptr_t)_ret_ref));
 414 
 415 JNI_ENTRY(jmethodID, jni_FromReflectedMethod(JNIEnv *env, jobject method))
 416   JNIWrapper(&quot;FromReflectedMethod&quot;);
 417 
 418   HOTSPOT_JNI_FROMREFLECTEDMETHOD_ENTRY(env, method);
 419 
 420   jmethodID ret = NULL;
 421   DT_RETURN_MARK(FromReflectedMethod, jmethodID, (const jmethodID&amp;)ret);
 422 
</pre>
</td>
</tr>
</table>
<center><a href="../precompiled/precompiled.hpp.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="jniCheck.cpp.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>