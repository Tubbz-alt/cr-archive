<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff test/hotspot/jtreg/compiler/valhalla/valuetypes/TestLWorld.java</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
  </head>
<body>
<center><a href="TestCallingConvention.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> next &gt;</center>    <h2>test/hotspot/jtreg/compiler/valhalla/valuetypes/TestLWorld.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  */
  23 
  24 package compiler.valhalla.valuetypes;
  25 
  26 import java.lang.invoke.*;
  27 import java.lang.reflect.Method;
  28 import java.util.Arrays;
  29 
  30 import jdk.experimental.value.MethodHandleBuilder;
  31 import jdk.test.lib.Asserts;
  32 
  33 /*
  34  * @test
  35  * @summary Test value types in LWorld.
  36  * @modules java.base/jdk.experimental.value
  37  * @library /testlibrary /test/lib /compiler/whitebox /
  38  * @requires (os.simpleArch == &quot;x64&quot; | os.simpleArch == &quot;aarch64&quot;)
<span class="line-modified">  39  * @compile TestLWorld.java</span>
  40  * @run driver ClassFileInstaller sun.hotspot.WhiteBox jdk.test.lib.Platform
  41  * @run main/othervm/timeout=300 -Xbootclasspath/a:. -XX:+IgnoreUnrecognizedVMOptions -XX:+UnlockDiagnosticVMOptions
  42  *                               -XX:+UnlockExperimentalVMOptions -XX:+WhiteBoxAPI
  43  *                               compiler.valhalla.valuetypes.ValueTypeTest
  44  *                               compiler.valhalla.valuetypes.TestLWorld
  45  */
  46 public class TestLWorld extends ValueTypeTest {
  47     // Extra VM parameters for some test scenarios. See ValueTypeTest.getVMParameters()
  48     @Override
  49     public String[] getExtraVMParameters(int scenario) {
  50         switch (scenario) {
  51         case 1: return new String[] {&quot;-XX:-UseOptoBiasInlining&quot;};
  52         case 2: return new String[] {&quot;-DVerifyIR=false&quot;, &quot;-XX:-UseBiasedLocking&quot;};
  53         case 3: return new String[] {&quot;-XX:-MonomorphicArrayCheck&quot;, &quot;-XX:-UseBiasedLocking&quot;, &quot;-XX:InlineArrayElemMaxFlatSize=-1&quot;};
  54         case 4: return new String[] {&quot;-XX:-MonomorphicArrayCheck&quot;};
  55         }
  56         return null;
  57     }
  58 
  59     public static void main(String[] args) throws Throwable {
</pre>
<hr />
<pre>
3224         long res = test114();
3225         Asserts.assertEquals(res, 5*rL);
3226     }
3227 
3228     // Same as test114 but with .default instead of ZERO field
3229     @Test(failOn = ALLOC_G + MEMBAR, match = { PREDICATE_TRAP }, matchCount = { 1 })
3230     @Warmup(10000)
3231     public long test115() {
3232         long res = 0;
3233         for (int i = 0; i &lt; lArr.length; i++) {
3234             res += InterfaceBox2.box_default(lArr[i]).content.value();
3235         }
3236         return res;
3237     }
3238 
3239     @DontCompile
3240     public void test115_verifier(boolean warmup) {
3241         long res = test115();
3242         Asserts.assertEquals(res, 5*rL);
3243     }


















































3244 }
</pre>
</td>
<td>
<hr />
<pre>
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  */
  23 
  24 package compiler.valhalla.valuetypes;
  25 
  26 import java.lang.invoke.*;
  27 import java.lang.reflect.Method;
  28 import java.util.Arrays;
  29 
  30 import jdk.experimental.value.MethodHandleBuilder;
  31 import jdk.test.lib.Asserts;
  32 
  33 /*
  34  * @test
  35  * @summary Test value types in LWorld.
  36  * @modules java.base/jdk.experimental.value
  37  * @library /testlibrary /test/lib /compiler/whitebox /
  38  * @requires (os.simpleArch == &quot;x64&quot; | os.simpleArch == &quot;aarch64&quot;)
<span class="line-modified">  39  * @compile -XDallowEmptyValues TestLWorld.java</span>
  40  * @run driver ClassFileInstaller sun.hotspot.WhiteBox jdk.test.lib.Platform
  41  * @run main/othervm/timeout=300 -Xbootclasspath/a:. -XX:+IgnoreUnrecognizedVMOptions -XX:+UnlockDiagnosticVMOptions
  42  *                               -XX:+UnlockExperimentalVMOptions -XX:+WhiteBoxAPI
  43  *                               compiler.valhalla.valuetypes.ValueTypeTest
  44  *                               compiler.valhalla.valuetypes.TestLWorld
  45  */
  46 public class TestLWorld extends ValueTypeTest {
  47     // Extra VM parameters for some test scenarios. See ValueTypeTest.getVMParameters()
  48     @Override
  49     public String[] getExtraVMParameters(int scenario) {
  50         switch (scenario) {
  51         case 1: return new String[] {&quot;-XX:-UseOptoBiasInlining&quot;};
  52         case 2: return new String[] {&quot;-DVerifyIR=false&quot;, &quot;-XX:-UseBiasedLocking&quot;};
  53         case 3: return new String[] {&quot;-XX:-MonomorphicArrayCheck&quot;, &quot;-XX:-UseBiasedLocking&quot;, &quot;-XX:InlineArrayElemMaxFlatSize=-1&quot;};
  54         case 4: return new String[] {&quot;-XX:-MonomorphicArrayCheck&quot;};
  55         }
  56         return null;
  57     }
  58 
  59     public static void main(String[] args) throws Throwable {
</pre>
<hr />
<pre>
3224         long res = test114();
3225         Asserts.assertEquals(res, 5*rL);
3226     }
3227 
3228     // Same as test114 but with .default instead of ZERO field
3229     @Test(failOn = ALLOC_G + MEMBAR, match = { PREDICATE_TRAP }, matchCount = { 1 })
3230     @Warmup(10000)
3231     public long test115() {
3232         long res = 0;
3233         for (int i = 0; i &lt; lArr.length; i++) {
3234             res += InterfaceBox2.box_default(lArr[i]).content.value();
3235         }
3236         return res;
3237     }
3238 
3239     @DontCompile
3240     public void test115_verifier(boolean warmup) {
3241         long res = test115();
3242         Asserts.assertEquals(res, 5*rL);
3243     }
<span class="line-added">3244 </span>
<span class="line-added">3245     static MyValueEmpty     fEmpty1;</span>
<span class="line-added">3246     static MyValueEmpty.ref fEmpty2 = MyValueEmpty.default;</span>
<span class="line-added">3247            MyValueEmpty     fEmpty3;</span>
<span class="line-added">3248            MyValueEmpty.ref fEmpty4 = MyValueEmpty.default;</span>
<span class="line-added">3249 </span>
<span class="line-added">3250     // Test fields loads/stores with empty inline types</span>
<span class="line-added">3251     @Test(failOn = ALLOC + ALLOC_G + LOAD + STORE + TRAP)</span>
<span class="line-added">3252     public void test116() {</span>
<span class="line-added">3253         fEmpty1 = fEmpty4;</span>
<span class="line-added">3254         fEmpty2 = fEmpty1;</span>
<span class="line-added">3255         fEmpty3 = fEmpty2;</span>
<span class="line-added">3256         fEmpty4 = fEmpty3;</span>
<span class="line-added">3257     }</span>
<span class="line-added">3258 </span>
<span class="line-added">3259     @DontCompile</span>
<span class="line-added">3260     public void test116_verifier(boolean warmup) {</span>
<span class="line-added">3261         test116();</span>
<span class="line-added">3262         Asserts.assertEquals(fEmpty1, fEmpty2);</span>
<span class="line-added">3263         Asserts.assertEquals(fEmpty2, fEmpty3);</span>
<span class="line-added">3264         Asserts.assertEquals(fEmpty3, fEmpty4);</span>
<span class="line-added">3265     }</span>
<span class="line-added">3266 </span>
<span class="line-added">3267     // Test array loads/stores with empty inline types</span>
<span class="line-added">3268     @Test(failOn = ALLOC + ALLOC_G)</span>
<span class="line-added">3269     public MyValueEmpty test117(MyValueEmpty[] arr1, MyValueEmpty.ref[] arr2) {</span>
<span class="line-added">3270         arr1[0] = arr2[0];</span>
<span class="line-added">3271         arr2[0] = new MyValueEmpty();</span>
<span class="line-added">3272         return arr1[0];</span>
<span class="line-added">3273     }</span>
<span class="line-added">3274 </span>
<span class="line-added">3275     @DontCompile</span>
<span class="line-added">3276     public void test117_verifier(boolean warmup) {</span>
<span class="line-added">3277         MyValueEmpty[] arr1 = new MyValueEmpty[]{MyValueEmpty.default};</span>
<span class="line-added">3278         MyValueEmpty res = test117(arr1, arr1);</span>
<span class="line-added">3279         Asserts.assertEquals(res, MyValueEmpty.default);</span>
<span class="line-added">3280         Asserts.assertEquals(arr1[0], MyValueEmpty.default);</span>
<span class="line-added">3281     }</span>
<span class="line-added">3282 </span>
<span class="line-added">3283     // Test acmp with empty inline types</span>
<span class="line-added">3284     @Test(failOn = ALLOC + ALLOC_G)</span>
<span class="line-added">3285     public boolean test118(MyValueEmpty v1, MyValueEmpty.ref v2, Object o1) {</span>
<span class="line-added">3286         return (v1 == v2) &amp;&amp; (v2 == o1);</span>
<span class="line-added">3287     }</span>
<span class="line-added">3288 </span>
<span class="line-added">3289     @DontCompile</span>
<span class="line-added">3290     public void test118_verifier(boolean warmup) {</span>
<span class="line-added">3291         boolean res = test118(MyValueEmpty.default, MyValueEmpty.default, new MyValueEmpty());</span>
<span class="line-added">3292         Asserts.assertTrue(res);</span>
<span class="line-added">3293     }</span>
3294 }
</pre>
</td>
</tr>
</table>
<center><a href="TestCallingConvention.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> next &gt;</center>  </body>
</html>