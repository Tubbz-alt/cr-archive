<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Old src/hotspot/share/oops/instanceKlass.cpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
  </head>
  <body>
    <pre>
   1 /*
   2  * Copyright (c) 1997, 2020, Oracle and/or its affiliates. All rights reserved.
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.
   8  *
   9  * This code is distributed in the hope that it will be useful, but WITHOUT
  10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  *
  23  */
  24 
  25 #include &quot;precompiled.hpp&quot;
  26 #include &quot;jvm.h&quot;
  27 #include &quot;aot/aotLoader.hpp&quot;
  28 #include &quot;classfile/classFileParser.hpp&quot;
  29 #include &quot;classfile/classFileStream.hpp&quot;
  30 #include &quot;classfile/classLoader.hpp&quot;
  31 #include &quot;classfile/classLoaderData.inline.hpp&quot;
  32 #include &quot;classfile/javaClasses.hpp&quot;
  33 #include &quot;classfile/moduleEntry.hpp&quot;
  34 #include &quot;classfile/symbolTable.hpp&quot;
  35 #include &quot;classfile/systemDictionary.hpp&quot;
  36 #include &quot;classfile/systemDictionaryShared.hpp&quot;
  37 #include &quot;classfile/verifier.hpp&quot;
  38 #include &quot;classfile/vmSymbols.hpp&quot;
  39 #include &quot;code/dependencyContext.hpp&quot;
  40 #include &quot;compiler/compileBroker.hpp&quot;
  41 #include &quot;gc/shared/collectedHeap.inline.hpp&quot;
  42 #include &quot;interpreter/oopMapCache.hpp&quot;
  43 #include &quot;interpreter/rewriter.hpp&quot;
  44 #include &quot;jvmtifiles/jvmti.h&quot;
  45 #include &quot;logging/log.hpp&quot;
  46 #include &quot;logging/logMessage.hpp&quot;
  47 #include &quot;logging/logStream.hpp&quot;
  48 #include &quot;memory/allocation.inline.hpp&quot;
  49 #include &quot;memory/iterator.inline.hpp&quot;
  50 #include &quot;memory/metadataFactory.hpp&quot;
  51 #include &quot;memory/metaspaceClosure.hpp&quot;
  52 #include &quot;memory/metaspaceShared.hpp&quot;
  53 #include &quot;memory/oopFactory.hpp&quot;
  54 #include &quot;memory/resourceArea.hpp&quot;
  55 #include &quot;memory/universe.hpp&quot;
  56 #include &quot;oops/fieldStreams.inline.hpp&quot;
  57 #include &quot;oops/constantPool.hpp&quot;
  58 #include &quot;oops/instanceClassLoaderKlass.hpp&quot;
  59 #include &quot;oops/instanceKlass.inline.hpp&quot;
  60 #include &quot;oops/instanceMirrorKlass.hpp&quot;
  61 #include &quot;oops/instanceOop.hpp&quot;
  62 #include &quot;oops/klass.inline.hpp&quot;
  63 #include &quot;oops/method.hpp&quot;
  64 #include &quot;oops/oop.inline.hpp&quot;
  65 #include &quot;oops/recordComponent.hpp&quot;
  66 #include &quot;oops/symbol.hpp&quot;
  67 #include &quot;oops/valueKlass.hpp&quot;
  68 #include &quot;prims/jvmtiExport.hpp&quot;
  69 #include &quot;prims/jvmtiRedefineClasses.hpp&quot;
  70 #include &quot;prims/jvmtiThreadState.hpp&quot;
  71 #include &quot;prims/methodComparator.hpp&quot;
  72 #include &quot;runtime/atomic.hpp&quot;
  73 #include &quot;runtime/biasedLocking.hpp&quot;
  74 #include &quot;runtime/fieldDescriptor.inline.hpp&quot;
  75 #include &quot;runtime/handles.inline.hpp&quot;
  76 #include &quot;runtime/javaCalls.hpp&quot;
  77 #include &quot;runtime/mutexLocker.hpp&quot;
  78 #include &quot;runtime/orderAccess.hpp&quot;
  79 #include &quot;runtime/thread.inline.hpp&quot;
  80 #include &quot;services/classLoadingService.hpp&quot;
  81 #include &quot;services/threadService.hpp&quot;
  82 #include &quot;utilities/dtrace.hpp&quot;
  83 #include &quot;utilities/events.hpp&quot;
  84 #include &quot;utilities/macros.hpp&quot;
  85 #include &quot;utilities/stringUtils.hpp&quot;
  86 #ifdef COMPILER1
  87 #include &quot;c1/c1_Compiler.hpp&quot;
  88 #endif
  89 #if INCLUDE_JFR
  90 #include &quot;jfr/jfrEvents.hpp&quot;
  91 #endif
  92 
  93 
  94 #ifdef DTRACE_ENABLED
  95 
  96 
  97 #define HOTSPOT_CLASS_INITIALIZATION_required HOTSPOT_CLASS_INITIALIZATION_REQUIRED
  98 #define HOTSPOT_CLASS_INITIALIZATION_recursive HOTSPOT_CLASS_INITIALIZATION_RECURSIVE
  99 #define HOTSPOT_CLASS_INITIALIZATION_concurrent HOTSPOT_CLASS_INITIALIZATION_CONCURRENT
 100 #define HOTSPOT_CLASS_INITIALIZATION_erroneous HOTSPOT_CLASS_INITIALIZATION_ERRONEOUS
 101 #define HOTSPOT_CLASS_INITIALIZATION_super__failed HOTSPOT_CLASS_INITIALIZATION_SUPER_FAILED
 102 #define HOTSPOT_CLASS_INITIALIZATION_clinit HOTSPOT_CLASS_INITIALIZATION_CLINIT
 103 #define HOTSPOT_CLASS_INITIALIZATION_error HOTSPOT_CLASS_INITIALIZATION_ERROR
 104 #define HOTSPOT_CLASS_INITIALIZATION_end HOTSPOT_CLASS_INITIALIZATION_END
 105 #define DTRACE_CLASSINIT_PROBE(type, thread_type)                \
 106   {                                                              \
 107     char* data = NULL;                                           \
 108     int len = 0;                                                 \
 109     Symbol* clss_name = name();                                  \
 110     if (clss_name != NULL) {                                     \
 111       data = (char*)clss_name-&gt;bytes();                          \
 112       len = clss_name-&gt;utf8_length();                            \
 113     }                                                            \
 114     HOTSPOT_CLASS_INITIALIZATION_##type(                         \
 115       data, len, (void*)class_loader(), thread_type);            \
 116   }
 117 
 118 #define DTRACE_CLASSINIT_PROBE_WAIT(type, thread_type, wait)     \
 119   {                                                              \
 120     char* data = NULL;                                           \
 121     int len = 0;                                                 \
 122     Symbol* clss_name = name();                                  \
 123     if (clss_name != NULL) {                                     \
 124       data = (char*)clss_name-&gt;bytes();                          \
 125       len = clss_name-&gt;utf8_length();                            \
 126     }                                                            \
 127     HOTSPOT_CLASS_INITIALIZATION_##type(                         \
 128       data, len, (void*)class_loader(), thread_type, wait);      \
 129   }
 130 
 131 #else //  ndef DTRACE_ENABLED
 132 
 133 #define DTRACE_CLASSINIT_PROBE(type, thread_type)
 134 #define DTRACE_CLASSINIT_PROBE_WAIT(type, thread_type, wait)
 135 
 136 #endif //  ndef DTRACE_ENABLED
 137 
 138 static inline bool is_class_loader(const Symbol* class_name,
 139                                    const ClassFileParser&amp; parser) {
 140   assert(class_name != NULL, &quot;invariant&quot;);
 141 
 142   if (class_name == vmSymbols::java_lang_ClassLoader()) {
 143     return true;
 144   }
 145 
 146   if (SystemDictionary::ClassLoader_klass_loaded()) {
 147     const Klass* const super_klass = parser.super_klass();
 148     if (super_klass != NULL) {
 149       if (super_klass-&gt;is_subtype_of(SystemDictionary::ClassLoader_klass())) {
 150         return true;
 151       }
 152     }
 153   }
 154   return false;
 155 }
 156 
 157 // called to verify that k is a member of this nest
 158 bool InstanceKlass::has_nest_member(InstanceKlass* k, TRAPS) const {
 159   if (_nest_members == NULL || _nest_members == Universe::the_empty_short_array()) {
 160     if (log_is_enabled(Trace, class, nestmates)) {
 161       ResourceMark rm(THREAD);
 162       log_trace(class, nestmates)(&quot;Checked nest membership of %s in non-nest-host class %s&quot;,
 163                                   k-&gt;external_name(), this-&gt;external_name());
 164     }
 165     return false;
 166   }
 167 
 168   if (log_is_enabled(Trace, class, nestmates)) {
 169     ResourceMark rm(THREAD);
 170     log_trace(class, nestmates)(&quot;Checking nest membership of %s in %s&quot;,
 171                                 k-&gt;external_name(), this-&gt;external_name());
 172   }
 173 
 174   // Check for a resolved cp entry , else fall back to a name check.
 175   // We don&#39;t want to resolve any class other than the one being checked.
 176   for (int i = 0; i &lt; _nest_members-&gt;length(); i++) {
 177     int cp_index = _nest_members-&gt;at(i);
 178     if (_constants-&gt;tag_at(cp_index).is_klass()) {
 179       Klass* k2 = _constants-&gt;klass_at(cp_index, CHECK_false);
 180       if (k2 == k) {
 181         log_trace(class, nestmates)(&quot;- class is listed at nest_members[%d] =&gt; cp[%d]&quot;, i, cp_index);
 182         return true;
 183       }
 184     }
 185     else {
 186       Symbol* name = _constants-&gt;klass_name_at(cp_index);
 187       if (name == k-&gt;name()) {
 188         log_trace(class, nestmates)(&quot;- Found it at nest_members[%d] =&gt; cp[%d]&quot;, i, cp_index);
 189 
 190         // Names match so check actual klass - this may trigger class loading if
 191         // it doesn&#39;t match (though that should be impossible). But to be safe we
 192         // have to check for a compiler thread executing here.
 193         if (!THREAD-&gt;can_call_java() &amp;&amp; !_constants-&gt;tag_at(cp_index).is_klass()) {
 194           log_trace(class, nestmates)(&quot;- validation required resolution in an unsuitable thread&quot;);
 195           return false;
 196         }
 197 
 198         Klass* k2 = _constants-&gt;klass_at(cp_index, CHECK_false);
 199         if (k2 == k) {
 200           log_trace(class, nestmates)(&quot;- class is listed as a nest member&quot;);
 201           return true;
 202         }
 203         else {
 204           // same name but different klass!
 205           log_trace(class, nestmates)(&quot; - klass comparison failed!&quot;);
 206           // can&#39;t have two names the same, so we&#39;re done
 207           return false;
 208         }
 209       }
 210     }
 211   }
 212   log_trace(class, nestmates)(&quot;- class is NOT a nest member!&quot;);
 213   return false;
 214 }
 215 
 216 // Return nest-host class, resolving, validating and saving it if needed.
 217 // In cases where this is called from a thread that can not do classloading
 218 // (such as a native JIT thread) then we simply return NULL, which in turn
 219 // causes the access check to return false. Such code will retry the access
 220 // from a more suitable environment later.
 221 InstanceKlass* InstanceKlass::nest_host(Symbol* validationException, TRAPS) {
 222   InstanceKlass* nest_host_k = _nest_host;
 223   if (nest_host_k == NULL) {
 224     // need to resolve and save our nest-host class. This could be attempted
 225     // concurrently but as the result is idempotent and we don&#39;t use the class
 226     // then we do not need any synchronization beyond what is implicitly used
 227     // during class loading.
 228     if (_nest_host_index != 0) { // we have a real nest_host
 229       // Before trying to resolve check if we&#39;re in a suitable context
 230       if (!THREAD-&gt;can_call_java() &amp;&amp; !_constants-&gt;tag_at(_nest_host_index).is_klass()) {
 231         if (log_is_enabled(Trace, class, nestmates)) {
 232           ResourceMark rm(THREAD);
 233           log_trace(class, nestmates)(&quot;Rejected resolution of nest-host of %s in unsuitable thread&quot;,
 234                                       this-&gt;external_name());
 235         }
 236         return NULL;
 237       }
 238 
 239       if (log_is_enabled(Trace, class, nestmates)) {
 240         ResourceMark rm(THREAD);
 241         log_trace(class, nestmates)(&quot;Resolving nest-host of %s using cp entry for %s&quot;,
 242                                     this-&gt;external_name(),
 243                                     _constants-&gt;klass_name_at(_nest_host_index)-&gt;as_C_string());
 244       }
 245 
 246       Klass* k = _constants-&gt;klass_at(_nest_host_index, THREAD);
 247       if (HAS_PENDING_EXCEPTION) {
 248         Handle exc_h = Handle(THREAD, PENDING_EXCEPTION);
 249         if (exc_h-&gt;is_a(SystemDictionary::NoClassDefFoundError_klass())) {
 250           // throw a new CDNFE with the original as its cause, and a clear msg
 251           ResourceMark rm(THREAD);
 252           char buf[200];
 253           CLEAR_PENDING_EXCEPTION;
 254           jio_snprintf(buf, sizeof(buf),
 255                        &quot;Unable to load nest-host class (%s) of %s&quot;,
 256                        _constants-&gt;klass_name_at(_nest_host_index)-&gt;as_C_string(),
 257                        this-&gt;external_name());
 258           log_trace(class, nestmates)(&quot;%s - NoClassDefFoundError&quot;, buf);
 259           THROW_MSG_CAUSE_NULL(vmSymbols::java_lang_NoClassDefFoundError(), buf, exc_h);
 260         }
 261         // All other exceptions pass through (OOME, StackOverflowError, LinkageErrors etc).
 262         return NULL;
 263       }
 264 
 265       // A valid nest-host is an instance class in the current package that lists this
 266       // class as a nest member. If any of these conditions are not met we post the
 267       // requested exception type (if any) and return NULL
 268 
 269       const char* error = NULL;
 270 
 271       // JVMS 5.4.4 indicates package check comes first
 272       if (is_same_class_package(k)) {
 273 
 274         // Now check actual membership. We can&#39;t be a member if our &quot;host&quot; is
 275         // not an instance class.
 276         if (k-&gt;is_instance_klass()) {
 277           nest_host_k = InstanceKlass::cast(k);
 278 
 279           bool is_member = nest_host_k-&gt;has_nest_member(this, CHECK_NULL);
 280           if (is_member) {
 281             // save resolved nest-host value
 282             _nest_host = nest_host_k;
 283 
 284             if (log_is_enabled(Trace, class, nestmates)) {
 285               ResourceMark rm(THREAD);
 286               log_trace(class, nestmates)(&quot;Resolved nest-host of %s to %s&quot;,
 287                                           this-&gt;external_name(), k-&gt;external_name());
 288             }
 289             return nest_host_k;
 290           }
 291         }
 292         error = &quot;current type is not listed as a nest member&quot;;
 293       } else {
 294         error = &quot;types are in different packages&quot;;
 295       }
 296 
 297       if (log_is_enabled(Trace, class, nestmates)) {
 298         ResourceMark rm(THREAD);
 299         log_trace(class, nestmates)
 300           (&quot;Type %s (loader: %s) is not a nest member of &quot;
 301            &quot;resolved type %s (loader: %s): %s&quot;,
 302            this-&gt;external_name(),
 303            this-&gt;class_loader_data()-&gt;loader_name_and_id(),
 304            k-&gt;external_name(),
 305            k-&gt;class_loader_data()-&gt;loader_name_and_id(),
 306            error);
 307       }
 308 
 309       if (validationException != NULL &amp;&amp; THREAD-&gt;can_call_java()) {
 310         ResourceMark rm(THREAD);
 311         Exceptions::fthrow(THREAD_AND_LOCATION,
 312                            validationException,
 313                            &quot;Type %s (loader: %s) is not a nest member of %s (loader: %s): %s&quot;,
 314                            this-&gt;external_name(),
 315                            this-&gt;class_loader_data()-&gt;loader_name_and_id(),
 316                            k-&gt;external_name(),
 317                            k-&gt;class_loader_data()-&gt;loader_name_and_id(),
 318                            error
 319                            );
 320       }
 321       return NULL;
 322     } else {
 323       if (log_is_enabled(Trace, class, nestmates)) {
 324         ResourceMark rm(THREAD);
 325         log_trace(class, nestmates)(&quot;Type %s is not part of a nest: setting nest-host to self&quot;,
 326                                     this-&gt;external_name());
 327       }
 328       // save resolved nest-host value
 329       return (_nest_host = this);
 330     }
 331   }
 332   return nest_host_k;
 333 }
 334 
 335 // check if &#39;this&#39; and k are nestmates (same nest_host), or k is our nest_host,
 336 // or we are k&#39;s nest_host - all of which is covered by comparing the two
 337 // resolved_nest_hosts
 338 bool InstanceKlass::has_nestmate_access_to(InstanceKlass* k, TRAPS) {
 339 
 340   assert(this != k, &quot;this should be handled by higher-level code&quot;);
 341 
 342   // Per JVMS 5.4.4 we first resolve and validate the current class, then
 343   // the target class k. Resolution exceptions will be passed on by upper
 344   // layers. IncompatibleClassChangeErrors from membership validation failures
 345   // will also be passed through.
 346 
 347   Symbol* icce = vmSymbols::java_lang_IncompatibleClassChangeError();
 348   InstanceKlass* cur_host = nest_host(icce, CHECK_false);
 349   if (cur_host == NULL) {
 350     return false;
 351   }
 352 
 353   Klass* k_nest_host = k-&gt;nest_host(icce, CHECK_false);
 354   if (k_nest_host == NULL) {
 355     return false;
 356   }
 357 
 358   bool access = (cur_host == k_nest_host);
 359 
 360   if (log_is_enabled(Trace, class, nestmates)) {
 361     ResourceMark rm(THREAD);
 362     log_trace(class, nestmates)(&quot;Class %s does %shave nestmate access to %s&quot;,
 363                                 this-&gt;external_name(),
 364                                 access ? &quot;&quot; : &quot;NOT &quot;,
 365                                 k-&gt;external_name());
 366   }
 367 
 368   return access;
 369 }
 370 
 371 InstanceKlass* InstanceKlass::allocate_instance_klass(const ClassFileParser&amp; parser, TRAPS) {
 372   const int size = InstanceKlass::size(parser.vtable_size(),
 373                                        parser.itable_size(),
 374                                        nonstatic_oop_map_size(parser.total_oop_map_count()),
 375                                        parser.is_interface(),
 376                                        parser.is_unsafe_anonymous(),
 377                                        should_store_fingerprint(parser.is_unsafe_anonymous()),
 378                                        parser.has_flattenable_fields() ? parser.java_fields_count() : 0,
 379                                        parser.is_value_type());
 380 
 381   const Symbol* const class_name = parser.class_name();
 382   assert(class_name != NULL, &quot;invariant&quot;);
 383   ClassLoaderData* loader_data = parser.loader_data();
 384   assert(loader_data != NULL, &quot;invariant&quot;);
 385 
 386   InstanceKlass* ik;
 387 
 388   // Allocation
 389   if (REF_NONE == parser.reference_type()) {
 390     if (class_name == vmSymbols::java_lang_Class()) {
 391       // mirror
 392       ik = new (loader_data, size, THREAD) InstanceMirrorKlass(parser);
 393     } else if (is_class_loader(class_name, parser)) {
 394       // class loader
 395       ik = new (loader_data, size, THREAD) InstanceClassLoaderKlass(parser);
 396     } else if (parser.is_value_type()) {
 397       // value type
 398       ik = new (loader_data, size, THREAD) ValueKlass(parser);
 399     } else {
 400       // normal
 401       ik = new (loader_data, size, THREAD) InstanceKlass(parser, InstanceKlass::_misc_kind_other);
 402     }
 403   } else {
 404     // reference
 405     ik = new (loader_data, size, THREAD) InstanceRefKlass(parser);
 406   }
 407 
 408   // Check for pending exception before adding to the loader data and incrementing
 409   // class count.  Can get OOM here.
 410   if (HAS_PENDING_EXCEPTION) {
 411     return NULL;
 412   }
 413 
 414 #ifdef ASSERT
 415   assert(ik-&gt;size() == size, &quot;&quot;);
 416   ik-&gt;bounds_check((address) ik-&gt;start_of_vtable(), false, size);
 417   ik-&gt;bounds_check((address) ik-&gt;start_of_itable(), false, size);
 418   ik-&gt;bounds_check((address) ik-&gt;end_of_itable(), true, size);
 419   ik-&gt;bounds_check((address) ik-&gt;end_of_nonstatic_oop_maps(), true, size);
 420 #endif //ASSERT
 421   return ik;
 422 }
 423 
 424 #ifndef PRODUCT
 425 bool InstanceKlass::bounds_check(address addr, bool edge_ok, intptr_t size_in_bytes) const {
 426   const char* bad = NULL;
 427   address end = NULL;
 428   if (addr &lt; (address)this) {
 429     bad = &quot;before&quot;;
 430   } else if (addr == (address)this) {
 431     if (edge_ok)  return true;
 432     bad = &quot;just before&quot;;
 433   } else if (addr == (end = (address)this + sizeof(intptr_t) * (size_in_bytes &lt; 0 ? size() : size_in_bytes))) {
 434     if (edge_ok)  return true;
 435     bad = &quot;just after&quot;;
 436   } else if (addr &gt; end) {
 437     bad = &quot;after&quot;;
 438   } else {
 439     return true;
 440   }
 441   tty-&gt;print_cr(&quot;%s object bounds: &quot; INTPTR_FORMAT &quot; [&quot; INTPTR_FORMAT &quot;..&quot; INTPTR_FORMAT &quot;]&quot;,
 442       bad, (intptr_t)addr, (intptr_t)this, (intptr_t)end);
 443   Verbose = WizardMode = true; this-&gt;print(); //@@
 444   return false;
 445 }
 446 #endif //PRODUCT
 447 
 448 // copy method ordering from resource area to Metaspace
 449 void InstanceKlass::copy_method_ordering(const intArray* m, TRAPS) {
 450   if (m != NULL) {
 451     // allocate a new array and copy contents (memcpy?)
 452     _method_ordering = MetadataFactory::new_array&lt;int&gt;(class_loader_data(), m-&gt;length(), CHECK);
 453     for (int i = 0; i &lt; m-&gt;length(); i++) {
 454       _method_ordering-&gt;at_put(i, m-&gt;at(i));
 455     }
 456   } else {
 457     _method_ordering = Universe::the_empty_int_array();
 458   }
 459 }
 460 
 461 // create a new array of vtable_indices for default methods
 462 Array&lt;int&gt;* InstanceKlass::create_new_default_vtable_indices(int len, TRAPS) {
 463   Array&lt;int&gt;* vtable_indices = MetadataFactory::new_array&lt;int&gt;(class_loader_data(), len, CHECK_NULL);
 464   assert(default_vtable_indices() == NULL, &quot;only create once&quot;);
 465   set_default_vtable_indices(vtable_indices);
 466   return vtable_indices;
 467 }
 468 
 469 InstanceKlass::InstanceKlass(const ClassFileParser&amp; parser, unsigned kind, KlassID id) :
 470   Klass(id),
 471   _nest_members(NULL),
 472   _nest_host_index(0),
 473   _nest_host(NULL),
 474   _record_components(NULL),
 475   _static_field_size(parser.static_field_size()),
 476   _nonstatic_oop_map_size(nonstatic_oop_map_size(parser.total_oop_map_count())),
 477   _itable_len(parser.itable_size()),
 478   _init_thread(NULL),
 479   _init_state(allocated),
 480   _reference_type(parser.reference_type()),
 481   _value_field_klasses(NULL),
 482   _adr_valueklass_fixed_block(NULL)
 483 {
 484   set_vtable_length(parser.vtable_size());
 485   set_kind(kind);
 486   set_access_flags(parser.access_flags());
 487   set_is_unsafe_anonymous(parser.is_unsafe_anonymous());
 488   set_layout_helper(Klass::instance_layout_helper(parser.layout_size(),
 489                                                     false));
 490     if (parser.has_flattenable_fields()) {
 491       set_has_value_fields();
 492     }
 493     _java_fields_count = parser.java_fields_count();
 494 
 495     assert(NULL == _methods, &quot;underlying memory not zeroed?&quot;);
 496     assert(is_instance_klass(), &quot;is layout incorrect?&quot;);
 497     assert(size_helper() == parser.layout_size(), &quot;incorrect size_helper?&quot;);
 498 
 499   if (Arguments::is_dumping_archive()) {
 500       SystemDictionaryShared::init_dumptime_info(this);
 501     }
 502 
 503   // Set biased locking bit for all instances of this class; it will be
 504   // cleared if revocation occurs too often for this type
 505   if (UseBiasedLocking &amp;&amp; BiasedLocking::enabled()) {
 506     set_prototype_header(markWord::biased_locking_prototype());
 507   }
 508   if (has_value_fields()) {
 509     _value_field_klasses = (const Klass**) adr_value_fields_klasses();
 510   }
 511 }
 512 
 513 void InstanceKlass::deallocate_methods(ClassLoaderData* loader_data,
 514                                        Array&lt;Method*&gt;* methods) {
 515   if (methods != NULL &amp;&amp; methods != Universe::the_empty_method_array() &amp;&amp;
 516       !methods-&gt;is_shared()) {
 517     for (int i = 0; i &lt; methods-&gt;length(); i++) {
 518       Method* method = methods-&gt;at(i);
 519       if (method == NULL) continue;  // maybe null if error processing
 520       // Only want to delete methods that are not executing for RedefineClasses.
 521       // The previous version will point to them so they&#39;re not totally dangling
 522       assert (!method-&gt;on_stack(), &quot;shouldn&#39;t be called with methods on stack&quot;);
 523       MetadataFactory::free_metadata(loader_data, method);
 524     }
 525     MetadataFactory::free_array&lt;Method*&gt;(loader_data, methods);
 526   }
 527 }
 528 
 529 void InstanceKlass::deallocate_interfaces(ClassLoaderData* loader_data,
 530                                           const Klass* super_klass,
 531                                           Array&lt;InstanceKlass*&gt;* local_interfaces,
 532                                           Array&lt;InstanceKlass*&gt;* transitive_interfaces) {
 533   // Only deallocate transitive interfaces if not empty, same as super class
 534   // or same as local interfaces.  See code in parseClassFile.
 535   Array&lt;InstanceKlass*&gt;* ti = transitive_interfaces;
 536   if (ti != Universe::the_empty_instance_klass_array() &amp;&amp; ti != local_interfaces) {
 537     // check that the interfaces don&#39;t come from super class
 538     Array&lt;InstanceKlass*&gt;* sti = (super_klass == NULL) ? NULL :
 539                     InstanceKlass::cast(super_klass)-&gt;transitive_interfaces();
 540     if (ti != sti &amp;&amp; ti != NULL &amp;&amp; !ti-&gt;is_shared()) {
 541       MetadataFactory::free_array&lt;InstanceKlass*&gt;(loader_data, ti);
 542     }
 543   }
 544 
 545   // local interfaces can be empty
 546   if (local_interfaces != Universe::the_empty_instance_klass_array() &amp;&amp;
 547       local_interfaces != NULL &amp;&amp; !local_interfaces-&gt;is_shared()) {
 548     MetadataFactory::free_array&lt;InstanceKlass*&gt;(loader_data, local_interfaces);
 549   }
 550 }
 551 
 552 void InstanceKlass::deallocate_record_components(ClassLoaderData* loader_data,
 553                                                  Array&lt;RecordComponent*&gt;* record_components) {
 554   if (record_components != NULL &amp;&amp; !record_components-&gt;is_shared()) {
 555     for (int i = 0; i &lt; record_components-&gt;length(); i++) {
 556       RecordComponent* record_component = record_components-&gt;at(i);
 557       MetadataFactory::free_metadata(loader_data, record_component);
 558     }
 559     MetadataFactory::free_array&lt;RecordComponent*&gt;(loader_data, record_components);
 560   }
 561 }
 562 
 563 // This function deallocates the metadata and C heap pointers that the
 564 // InstanceKlass points to.
 565 void InstanceKlass::deallocate_contents(ClassLoaderData* loader_data) {
 566 
 567   // Orphan the mirror first, CMS thinks it&#39;s still live.
 568   if (java_mirror() != NULL) {
 569     java_lang_Class::set_klass(java_mirror(), NULL);
 570   }
 571 
 572   // Also remove mirror from handles
 573   loader_data-&gt;remove_handle(_java_mirror);
 574 
 575   // Need to take this class off the class loader data list.
 576   loader_data-&gt;remove_class(this);
 577 
 578   // The array_klass for this class is created later, after error handling.
 579   // For class redefinition, we keep the original class so this scratch class
 580   // doesn&#39;t have an array class.  Either way, assert that there is nothing
 581   // to deallocate.
 582   assert(array_klasses() == NULL, &quot;array classes shouldn&#39;t be created for this class yet&quot;);
 583 
 584   // Release C heap allocated data that this might point to, which includes
 585   // reference counting symbol names.
 586   release_C_heap_structures();
 587 
 588   deallocate_methods(loader_data, methods());
 589   set_methods(NULL);
 590 
 591   deallocate_record_components(loader_data, record_components());
 592   set_record_components(NULL);
 593 
 594   if (method_ordering() != NULL &amp;&amp;
 595       method_ordering() != Universe::the_empty_int_array() &amp;&amp;
 596       !method_ordering()-&gt;is_shared()) {
 597     MetadataFactory::free_array&lt;int&gt;(loader_data, method_ordering());
 598   }
 599   set_method_ordering(NULL);
 600 
 601   // default methods can be empty
 602   if (default_methods() != NULL &amp;&amp;
 603       default_methods() != Universe::the_empty_method_array() &amp;&amp;
 604       !default_methods()-&gt;is_shared()) {
 605     MetadataFactory::free_array&lt;Method*&gt;(loader_data, default_methods());
 606   }
 607   // Do NOT deallocate the default methods, they are owned by superinterfaces.
 608   set_default_methods(NULL);
 609 
 610   // default methods vtable indices can be empty
 611   if (default_vtable_indices() != NULL &amp;&amp;
 612       !default_vtable_indices()-&gt;is_shared()) {
 613     MetadataFactory::free_array&lt;int&gt;(loader_data, default_vtable_indices());
 614   }
 615   set_default_vtable_indices(NULL);
 616 
 617 
 618   // This array is in Klass, but remove it with the InstanceKlass since
 619   // this place would be the only caller and it can share memory with transitive
 620   // interfaces.
 621   if (secondary_supers() != NULL &amp;&amp;
 622       secondary_supers() != Universe::the_empty_klass_array() &amp;&amp;
 623       // see comments in compute_secondary_supers about the following cast
 624       (address)(secondary_supers()) != (address)(transitive_interfaces()) &amp;&amp;
 625       !secondary_supers()-&gt;is_shared()) {
 626     MetadataFactory::free_array&lt;Klass*&gt;(loader_data, secondary_supers());
 627   }
 628   set_secondary_supers(NULL);
 629 
 630   deallocate_interfaces(loader_data, super(), local_interfaces(), transitive_interfaces());
 631   set_transitive_interfaces(NULL);
 632   set_local_interfaces(NULL);
 633 
 634   if (fields() != NULL &amp;&amp; !fields()-&gt;is_shared()) {
 635     MetadataFactory::free_array&lt;jushort&gt;(loader_data, fields());
 636   }
 637   set_fields(NULL, 0);
 638 
 639   // If a method from a redefined class is using this constant pool, don&#39;t
 640   // delete it, yet.  The new class&#39;s previous version will point to this.
 641   if (constants() != NULL) {
 642     assert (!constants()-&gt;on_stack(), &quot;shouldn&#39;t be called if anything is onstack&quot;);
 643     if (!constants()-&gt;is_shared()) {
 644       MetadataFactory::free_metadata(loader_data, constants());
 645     }
 646     // Delete any cached resolution errors for the constant pool
 647     SystemDictionary::delete_resolution_error(constants());
 648 
 649     set_constants(NULL);
 650   }
 651 
 652   if (inner_classes() != NULL &amp;&amp;
 653       inner_classes() != Universe::the_empty_short_array() &amp;&amp;
 654       !inner_classes()-&gt;is_shared()) {
 655     MetadataFactory::free_array&lt;jushort&gt;(loader_data, inner_classes());
 656   }
 657   set_inner_classes(NULL);
 658 
 659   if (nest_members() != NULL &amp;&amp;
 660       nest_members() != Universe::the_empty_short_array() &amp;&amp;
 661       !nest_members()-&gt;is_shared()) {
 662     MetadataFactory::free_array&lt;jushort&gt;(loader_data, nest_members());
 663   }
 664   set_nest_members(NULL);
 665 
 666   // We should deallocate the Annotations instance if it&#39;s not in shared spaces.
 667   if (annotations() != NULL &amp;&amp; !annotations()-&gt;is_shared()) {
 668     MetadataFactory::free_metadata(loader_data, annotations());
 669   }
 670   set_annotations(NULL);
 671 
 672   if (Arguments::is_dumping_archive()) {
 673     SystemDictionaryShared::remove_dumptime_info(this);
 674   }
 675 }
 676 
 677 bool InstanceKlass::should_be_initialized() const {
 678   return !is_initialized();
 679 }
 680 
 681 klassItable InstanceKlass::itable() const {
 682   return klassItable(const_cast&lt;InstanceKlass*&gt;(this));
 683 }
 684 
 685 void InstanceKlass::eager_initialize(Thread *thread) {
 686   if (!EagerInitialization) return;
 687 
 688   if (this-&gt;is_not_initialized()) {
 689     // abort if the the class has a class initializer
 690     if (this-&gt;class_initializer() != NULL) return;
 691 
 692     // abort if it is java.lang.Object (initialization is handled in genesis)
 693     Klass* super_klass = super();
 694     if (super_klass == NULL) return;
 695 
 696     // abort if the super class should be initialized
 697     if (!InstanceKlass::cast(super_klass)-&gt;is_initialized()) return;
 698 
 699     // call body to expose the this pointer
 700     eager_initialize_impl();
 701   }
 702 }
 703 
 704 // JVMTI spec thinks there are signers and protection domain in the
 705 // instanceKlass.  These accessors pretend these fields are there.
 706 // The hprof specification also thinks these fields are in InstanceKlass.
 707 oop InstanceKlass::protection_domain() const {
 708   // return the protection_domain from the mirror
 709   return java_lang_Class::protection_domain(java_mirror());
 710 }
 711 
 712 // To remove these from requires an incompatible change and CCC request.
 713 objArrayOop InstanceKlass::signers() const {
 714   // return the signers from the mirror
 715   return java_lang_Class::signers(java_mirror());
 716 }
 717 
 718 oop InstanceKlass::init_lock() const {
 719   // return the init lock from the mirror
 720   oop lock = java_lang_Class::init_lock(java_mirror());
 721   // Prevent reordering with any access of initialization state
 722   OrderAccess::loadload();
 723   assert((oop)lock != NULL || !is_not_initialized(), // initialized or in_error state
 724          &quot;only fully initialized state can have a null lock&quot;);
 725   return lock;
 726 }
 727 
 728 // Set the initialization lock to null so the object can be GC&#39;ed.  Any racing
 729 // threads to get this lock will see a null lock and will not lock.
 730 // That&#39;s okay because they all check for initialized state after getting
 731 // the lock and return.
 732 void InstanceKlass::fence_and_clear_init_lock() {
 733   // make sure previous stores are all done, notably the init_state.
 734   OrderAccess::storestore();
 735   java_lang_Class::set_init_lock(java_mirror(), NULL);
 736   assert(!is_not_initialized(), &quot;class must be initialized now&quot;);
 737 }
 738 
 739 void InstanceKlass::eager_initialize_impl() {
 740   EXCEPTION_MARK;
 741   HandleMark hm(THREAD);
 742   Handle h_init_lock(THREAD, init_lock());
 743   ObjectLocker ol(h_init_lock, THREAD, h_init_lock() != NULL);
 744 
 745   // abort if someone beat us to the initialization
 746   if (!is_not_initialized()) return;  // note: not equivalent to is_initialized()
 747 
 748   ClassState old_state = init_state();
 749   link_class_impl(THREAD);
 750   if (HAS_PENDING_EXCEPTION) {
 751     CLEAR_PENDING_EXCEPTION;
 752     // Abort if linking the class throws an exception.
 753 
 754     // Use a test to avoid redundantly resetting the state if there&#39;s
 755     // no change.  Set_init_state() asserts that state changes make
 756     // progress, whereas here we might just be spinning in place.
 757     if (old_state != _init_state)
 758       set_init_state(old_state);
 759   } else {
 760     // linking successfull, mark class as initialized
 761     set_init_state(fully_initialized);
 762     fence_and_clear_init_lock();
 763     // trace
 764     if (log_is_enabled(Info, class, init)) {
 765       ResourceMark rm(THREAD);
 766       log_info(class, init)(&quot;[Initialized %s without side effects]&quot;, external_name());
 767     }
 768   }
 769 }
 770 
 771 
 772 // See &quot;The Virtual Machine Specification&quot; section 2.16.5 for a detailed explanation of the class initialization
 773 // process. The step comments refers to the procedure described in that section.
 774 // Note: implementation moved to static method to expose the this pointer.
 775 void InstanceKlass::initialize(TRAPS) {
 776   if (this-&gt;should_be_initialized()) {
 777     initialize_impl(CHECK);
 778     // Note: at this point the class may be initialized
 779     //       OR it may be in the state of being initialized
 780     //       in case of recursive initialization!
 781   } else {
 782     assert(is_initialized(), &quot;sanity check&quot;);
 783   }
 784 }
 785 
 786 
 787 bool InstanceKlass::verify_code(TRAPS) {
 788   // 1) Verify the bytecodes
 789   return Verifier::verify(this, should_verify_class(), THREAD);
 790 }
 791 
 792 void InstanceKlass::link_class(TRAPS) {
 793   assert(is_loaded(), &quot;must be loaded&quot;);
 794   if (!is_linked()) {
 795     link_class_impl(CHECK);
 796   }
 797 }
 798 
 799 // Called to verify that a class can link during initialization, without
 800 // throwing a VerifyError.
 801 bool InstanceKlass::link_class_or_fail(TRAPS) {
 802   assert(is_loaded(), &quot;must be loaded&quot;);
 803   if (!is_linked()) {
 804     link_class_impl(CHECK_false);
 805   }
 806   return is_linked();
 807 }
 808 
 809 bool InstanceKlass::link_class_impl(TRAPS) {
 810   if (DumpSharedSpaces &amp;&amp; SystemDictionaryShared::has_class_failed_verification(this)) {
 811     // This is for CDS dumping phase only -- we use the in_error_state to indicate that
 812     // the class has failed verification. Throwing the NoClassDefFoundError here is just
 813     // a convenient way to stop repeat attempts to verify the same (bad) class.
 814     //
 815     // Note that the NoClassDefFoundError is not part of the JLS, and should not be thrown
 816     // if we are executing Java code. This is not a problem for CDS dumping phase since
 817     // it doesn&#39;t execute any Java code.
 818     ResourceMark rm(THREAD);
 819     Exceptions::fthrow(THREAD_AND_LOCATION,
 820                        vmSymbols::java_lang_NoClassDefFoundError(),
 821                        &quot;Class %s, or one of its supertypes, failed class initialization&quot;,
 822                        external_name());
 823     return false;
 824   }
 825   // return if already verified
 826   if (is_linked()) {
 827     return true;
 828   }
 829 
 830   // Timing
 831   // timer handles recursion
 832   assert(THREAD-&gt;is_Java_thread(), &quot;non-JavaThread in link_class_impl&quot;);
 833   JavaThread* jt = (JavaThread*)THREAD;
 834 
 835   // link super class before linking this class
 836   Klass* super_klass = super();
 837   if (super_klass != NULL) {
 838     if (super_klass-&gt;is_interface()) {  // check if super class is an interface
 839       ResourceMark rm(THREAD);
 840       Exceptions::fthrow(
 841         THREAD_AND_LOCATION,
 842         vmSymbols::java_lang_IncompatibleClassChangeError(),
 843         &quot;class %s has interface %s as super class&quot;,
 844         external_name(),
 845         super_klass-&gt;external_name()
 846       );
 847       return false;
 848     }
 849 
 850     InstanceKlass* ik_super = InstanceKlass::cast(super_klass);
 851     ik_super-&gt;link_class_impl(CHECK_false);
 852   }
 853 
 854   // link all interfaces implemented by this class before linking this class
 855   Array&lt;InstanceKlass*&gt;* interfaces = local_interfaces();
 856   int num_interfaces = interfaces-&gt;length();
 857   for (int index = 0; index &lt; num_interfaces; index++) {
 858     InstanceKlass* interk = interfaces-&gt;at(index);
 859     interk-&gt;link_class_impl(CHECK_false);
 860   }
 861 
 862 
 863   // If a class declares a method that uses a value class as an argument
 864   // type or return value type, this value class must be loaded during the
 865   // linking of this class because size and properties of the value class
 866   // must be known in order to be able to perform value type optimizations.
 867   // The implementation below is an approximation of this rule, the code
 868   // iterates over all methods of the current class (including overridden
 869   // methods), not only the methods declared by this class. This
 870   // approximation makes the code simpler, and doesn&#39;t change the semantic
 871   // because classes declaring methods overridden by the current class are
 872   // linked (and have performed their own pre-loading) before the linking
 873   // of the current class.
 874   // This is also the moment to detect potential mismatch between the
 875   // ValueTypes attribute and the kind of the class effectively loaded.
 876 
 877 
 878   // Note:
 879   // Value class types used for flattenable fields are loaded during
 880   // the loading phase (see ClassFileParser::post_process_parsed_stream()).
 881   // Value class types used as element types for array creation
 882   // are not pre-loaded. Their loading is triggered by either anewarray
 883   // or multianewarray bytecodes.
 884 
 885   // Could it be possible to do the following processing only if the
 886   // class uses value types?
 887   {
 888     ResourceMark rm(THREAD);
 889     for (int i = 0; i &lt; methods()-&gt;length(); i++) {
 890       Method* m = methods()-&gt;at(i);
 891       for (SignatureStream ss(m-&gt;signature()); !ss.is_done(); ss.next()) {
 892         if (ss.is_reference()) {
 893           if (ss.is_array()) {
 894             ss.skip_array_prefix();
 895           }
 896           if (ss.type() == T_VALUETYPE) {
 897             Symbol* symb = ss.as_symbol();
 898 
 899             oop loader = class_loader();
 900             oop protection_domain = this-&gt;protection_domain();
 901             Klass* klass = SystemDictionary::resolve_or_fail(symb,
 902                                                              Handle(THREAD, loader), Handle(THREAD, protection_domain), true,
 903                                                              CHECK_false);
 904             if (klass == NULL) {
 905               THROW_(vmSymbols::java_lang_LinkageError(), false);
 906             }
 907             if (!klass-&gt;is_value()) {
 908               Exceptions::fthrow(
 909                 THREAD_AND_LOCATION,
 910                 vmSymbols::java_lang_IncompatibleClassChangeError(),
 911                 &quot;class %s is not an inline type&quot;,
 912                 klass-&gt;external_name());
 913             }
 914           }
 915         }
 916       }
 917     }
 918   }
 919 
 920   // in case the class is linked in the process of linking its superclasses
 921   if (is_linked()) {
 922     return true;
 923   }
 924 
 925   // trace only the link time for this klass that includes
 926   // the verification time
 927   PerfClassTraceTime vmtimer(ClassLoader::perf_class_link_time(),
 928                              ClassLoader::perf_class_link_selftime(),
 929                              ClassLoader::perf_classes_linked(),
 930                              jt-&gt;get_thread_stat()-&gt;perf_recursion_counts_addr(),
 931                              jt-&gt;get_thread_stat()-&gt;perf_timers_addr(),
 932                              PerfClassTraceTime::CLASS_LINK);
 933 
 934   // verification &amp; rewriting
 935   {
 936     HandleMark hm(THREAD);
 937     Handle h_init_lock(THREAD, init_lock());
 938     ObjectLocker ol(h_init_lock, THREAD, h_init_lock() != NULL);
 939     // rewritten will have been set if loader constraint error found
 940     // on an earlier link attempt
 941     // don&#39;t verify or rewrite if already rewritten
 942     //
 943 
 944     if (!is_linked()) {
 945       if (!is_rewritten()) {
 946         {
 947           bool verify_ok = verify_code(THREAD);
 948           if (!verify_ok) {
 949             return false;
 950           }
 951         }
 952 
 953         // Just in case a side-effect of verify linked this class already
 954         // (which can sometimes happen since the verifier loads classes
 955         // using custom class loaders, which are free to initialize things)
 956         if (is_linked()) {
 957           return true;
 958         }
 959 
 960         // also sets rewritten
 961         rewrite_class(CHECK_false);
 962       } else if (is_shared()) {
 963         SystemDictionaryShared::check_verification_constraints(this, CHECK_false);
 964       }
 965 
 966       // relocate jsrs and link methods after they are all rewritten
 967       link_methods(CHECK_false);
 968 
 969       // Initialize the vtable and interface table after
 970       // methods have been rewritten since rewrite may
 971       // fabricate new Method*s.
 972       // also does loader constraint checking
 973       //
 974       // initialize_vtable and initialize_itable need to be rerun for
 975       // a shared class if the class is not loaded by the NULL classloader.
 976       ClassLoaderData * loader_data = class_loader_data();
 977       if (!(is_shared() &amp;&amp;
 978             loader_data-&gt;is_the_null_class_loader_data())) {
 979         vtable().initialize_vtable(true, CHECK_false);
 980         itable().initialize_itable(true, CHECK_false);
 981       }
 982 #ifdef ASSERT
 983       else {
 984         vtable().verify(tty, true);
 985         // In case itable verification is ever added.
 986         // itable().verify(tty, true);
 987       }
 988 #endif
 989 
 990       set_init_state(linked);
 991       if (JvmtiExport::should_post_class_prepare()) {
 992         Thread *thread = THREAD;
 993         assert(thread-&gt;is_Java_thread(), &quot;thread-&gt;is_Java_thread()&quot;);
 994         JvmtiExport::post_class_prepare((JavaThread *) thread, this);
 995       }
 996     }
 997   }
 998   return true;
 999 }
1000 
1001 // Rewrite the byte codes of all of the methods of a class.
1002 // The rewriter must be called exactly once. Rewriting must happen after
1003 // verification but before the first method of the class is executed.
1004 void InstanceKlass::rewrite_class(TRAPS) {
1005   assert(is_loaded(), &quot;must be loaded&quot;);
1006   if (is_rewritten()) {
1007     assert(is_shared(), &quot;rewriting an unshared class?&quot;);
1008     return;
1009   }
1010   Rewriter::rewrite(this, CHECK);
1011   set_rewritten();
1012 }
1013 
1014 // Now relocate and link method entry points after class is rewritten.
1015 // This is outside is_rewritten flag. In case of an exception, it can be
1016 // executed more than once.
1017 void InstanceKlass::link_methods(TRAPS) {
1018   int len = methods()-&gt;length();
1019   for (int i = len-1; i &gt;= 0; i--) {
1020     methodHandle m(THREAD, methods()-&gt;at(i));
1021 
1022     // Set up method entry points for compiler and interpreter    .
1023     m-&gt;link_method(m, CHECK);
1024   }
1025 }
1026 
1027 // Eagerly initialize superinterfaces that declare default methods (concrete instance: any access)
1028 void InstanceKlass::initialize_super_interfaces(TRAPS) {
1029   assert (has_nonstatic_concrete_methods(), &quot;caller should have checked this&quot;);
1030   for (int i = 0; i &lt; local_interfaces()-&gt;length(); ++i) {
1031     InstanceKlass* ik = local_interfaces()-&gt;at(i);
1032 
1033     // Initialization is depth first search ie. we start with top of the inheritance tree
1034     // has_nonstatic_concrete_methods drives searching superinterfaces since it
1035     // means has_nonstatic_concrete_methods in its superinterface hierarchy
1036     if (ik-&gt;has_nonstatic_concrete_methods()) {
1037       ik-&gt;initialize_super_interfaces(CHECK);
1038     }
1039 
1040     // Only initialize() interfaces that &quot;declare&quot; concrete methods.
1041     if (ik-&gt;should_be_initialized() &amp;&amp; ik-&gt;declares_nonstatic_concrete_methods()) {
1042       ik-&gt;initialize(CHECK);
1043     }
1044   }
1045 }
1046 
1047 void InstanceKlass::initialize_impl(TRAPS) {
1048   HandleMark hm(THREAD);
1049 
1050   // Make sure klass is linked (verified) before initialization
1051   // A class could already be verified, since it has been reflected upon.
1052   link_class(CHECK);
1053 
1054   DTRACE_CLASSINIT_PROBE(required, -1);
1055 
1056   bool wait = false;
1057 
1058   assert(THREAD-&gt;is_Java_thread(), &quot;non-JavaThread in initialize_impl&quot;);
1059   JavaThread* jt = (JavaThread*)THREAD;
1060 
1061   // refer to the JVM book page 47 for description of steps
1062   // Step 1
1063   {
1064     Handle h_init_lock(THREAD, init_lock());
1065     ObjectLocker ol(h_init_lock, THREAD, h_init_lock() != NULL);
1066 
1067     // Step 2
1068     // If we were to use wait() instead of waitInterruptibly() then
1069     // we might end up throwing IE from link/symbol resolution sites
1070     // that aren&#39;t expected to throw.  This would wreak havoc.  See 6320309.
1071     while (is_being_initialized() &amp;&amp; !is_reentrant_initialization(jt)) {
1072       wait = true;
1073       jt-&gt;set_class_to_be_initialized(this);
1074       ol.wait_uninterruptibly(jt);
1075       jt-&gt;set_class_to_be_initialized(NULL);
1076     }
1077 
1078     // Step 3
1079     if (is_being_initialized() &amp;&amp; is_reentrant_initialization(jt)) {
1080       DTRACE_CLASSINIT_PROBE_WAIT(recursive, -1, wait);
1081       return;
1082     }
1083 
1084     // Step 4
1085     if (is_initialized()) {
1086       DTRACE_CLASSINIT_PROBE_WAIT(concurrent, -1, wait);
1087       return;
1088     }
1089 
1090     // Step 5
1091     if (is_in_error_state()) {
1092       DTRACE_CLASSINIT_PROBE_WAIT(erroneous, -1, wait);
1093       ResourceMark rm(THREAD);
1094       const char* desc = &quot;Could not initialize class &quot;;
1095       const char* className = external_name();
1096       size_t msglen = strlen(desc) + strlen(className) + 1;
1097       char* message = NEW_RESOURCE_ARRAY(char, msglen);
1098       if (NULL == message) {
1099         // Out of memory: can&#39;t create detailed error message
1100           THROW_MSG(vmSymbols::java_lang_NoClassDefFoundError(), className);
1101       } else {
1102         jio_snprintf(message, msglen, &quot;%s%s&quot;, desc, className);
1103           THROW_MSG(vmSymbols::java_lang_NoClassDefFoundError(), message);
1104       }
1105     }
1106 
1107     // Step 6
1108     set_init_state(being_initialized);
1109     set_init_thread(jt);
1110   }
1111 
1112   // Step 7
1113   // Next, if C is a class rather than an interface, initialize it&#39;s super class and super
1114   // interfaces.
1115   if (!is_interface()) {
1116     Klass* super_klass = super();
1117     if (super_klass != NULL &amp;&amp; super_klass-&gt;should_be_initialized()) {
1118       super_klass-&gt;initialize(THREAD);
1119     }
1120     // If C implements any interface that declares a non-static, concrete method,
1121     // the initialization of C triggers initialization of its super interfaces.
1122     // Only need to recurse if has_nonstatic_concrete_methods which includes declaring and
1123     // having a superinterface that declares, non-static, concrete methods
1124     if (!HAS_PENDING_EXCEPTION &amp;&amp; has_nonstatic_concrete_methods()) {
1125       initialize_super_interfaces(THREAD);
1126     }
1127 
1128     // If any exceptions, complete abruptly, throwing the same exception as above.
1129     if (HAS_PENDING_EXCEPTION) {
1130       Handle e(THREAD, PENDING_EXCEPTION);
1131       CLEAR_PENDING_EXCEPTION;
1132       {
1133         EXCEPTION_MARK;
1134         // Locks object, set state, and notify all waiting threads
1135         set_initialization_state_and_notify(initialization_error, THREAD);
1136         CLEAR_PENDING_EXCEPTION;
1137       }
1138       DTRACE_CLASSINIT_PROBE_WAIT(super__failed, -1, wait);
1139       THROW_OOP(e());
1140     }
1141   }
1142 
1143   // Step 8
1144   // Initialize classes of flattenable fields
1145   {
1146     for (AllFieldStream fs(this); !fs.done(); fs.next()) {
1147       if (fs.is_flattenable()) {
1148         Klass* klass = this-&gt;get_value_field_klass_or_null(fs.index());
1149         if (klass == NULL) {
1150           assert(fs.access_flags().is_static() &amp;&amp; fs.access_flags().is_flattenable(),
1151               &quot;Otherwise should have been pre-loaded&quot;);
1152           klass = SystemDictionary::resolve_or_fail(field_signature(fs.index())-&gt;fundamental_name(THREAD),
1153               Handle(THREAD, class_loader()),
1154               Handle(THREAD, protection_domain()),
1155               true, CHECK);
1156           if (klass == NULL) {
1157             THROW(vmSymbols::java_lang_NoClassDefFoundError());
1158           }
1159           if (!klass-&gt;is_value()) {
1160             THROW(vmSymbols::java_lang_IncompatibleClassChangeError());
1161           }
1162           this-&gt;set_value_field_klass(fs.index(), klass);
1163         }
1164         InstanceKlass::cast(klass)-&gt;initialize(CHECK);
1165         if (fs.access_flags().is_static()) {
1166           if (java_mirror()-&gt;obj_field(fs.offset()) == NULL) {
1167             java_mirror()-&gt;obj_field_put(fs.offset(), ValueKlass::cast(klass)-&gt;default_value());
1168           }
1169         }
1170       }
1171     }
1172   }
1173 
1174 
1175   // Look for aot compiled methods for this klass, including class initializer.
1176   AOTLoader::load_for_klass(this, THREAD);
1177 
1178   // Step 9
1179   {
1180     DTRACE_CLASSINIT_PROBE_WAIT(clinit, -1, wait);
1181     // Timer includes any side effects of class initialization (resolution,
1182     // etc), but not recursive entry into call_class_initializer().
1183     PerfClassTraceTime timer(ClassLoader::perf_class_init_time(),
1184                              ClassLoader::perf_class_init_selftime(),
1185                              ClassLoader::perf_classes_inited(),
1186                              jt-&gt;get_thread_stat()-&gt;perf_recursion_counts_addr(),
1187                              jt-&gt;get_thread_stat()-&gt;perf_timers_addr(),
1188                              PerfClassTraceTime::CLASS_CLINIT);
1189     call_class_initializer(THREAD);
1190   }
1191 
1192   // Step 10
1193   if (!HAS_PENDING_EXCEPTION) {
1194     set_initialization_state_and_notify(fully_initialized, CHECK);
1195     {
1196       debug_only(vtable().verify(tty, true);)
1197     }
1198   }
1199   else {
1200     // Step 11 and 12
1201     Handle e(THREAD, PENDING_EXCEPTION);
1202     CLEAR_PENDING_EXCEPTION;
1203     // JVMTI has already reported the pending exception
1204     // JVMTI internal flag reset is needed in order to report ExceptionInInitializerError
1205     JvmtiExport::clear_detected_exception(jt);
1206     {
1207       EXCEPTION_MARK;
1208       set_initialization_state_and_notify(initialization_error, THREAD);
1209       CLEAR_PENDING_EXCEPTION;   // ignore any exception thrown, class initialization error is thrown below
1210       // JVMTI has already reported the pending exception
1211       // JVMTI internal flag reset is needed in order to report ExceptionInInitializerError
1212       JvmtiExport::clear_detected_exception(jt);
1213     }
1214     DTRACE_CLASSINIT_PROBE_WAIT(error, -1, wait);
1215     if (e-&gt;is_a(SystemDictionary::Error_klass())) {
1216       THROW_OOP(e());
1217     } else {
1218       JavaCallArguments args(e);
1219       THROW_ARG(vmSymbols::java_lang_ExceptionInInitializerError(),
1220                 vmSymbols::throwable_void_signature(),
1221                 &amp;args);
1222     }
1223   }
1224   DTRACE_CLASSINIT_PROBE_WAIT(end, -1, wait);
1225 }
1226 
1227 
1228 void InstanceKlass::set_initialization_state_and_notify(ClassState state, TRAPS) {
1229   Handle h_init_lock(THREAD, init_lock());
1230   if (h_init_lock() != NULL) {
1231     ObjectLocker ol(h_init_lock, THREAD);
1232     set_init_thread(NULL); // reset _init_thread before changing _init_state
1233     set_init_state(state);
1234     fence_and_clear_init_lock();
1235     ol.notify_all(CHECK);
1236   } else {
1237     assert(h_init_lock() != NULL, &quot;The initialization state should never be set twice&quot;);
1238     set_init_thread(NULL); // reset _init_thread before changing _init_state
1239     set_init_state(state);
1240   }
1241 }
1242 
1243 Klass* InstanceKlass::implementor() const {
1244   Klass* volatile* k = adr_implementor();
1245   if (k == NULL) {
1246     return NULL;
1247   } else {
1248     // This load races with inserts, and therefore needs acquire.
1249     Klass* kls = Atomic::load_acquire(k);
1250     if (kls != NULL &amp;&amp; !kls-&gt;is_loader_alive()) {
1251       return NULL;  // don&#39;t return unloaded class
1252     } else {
1253       return kls;
1254     }
1255   }
1256 }
1257 
1258 
1259 void InstanceKlass::set_implementor(Klass* k) {
1260   assert_locked_or_safepoint(Compile_lock);
1261   assert(is_interface(), &quot;not interface&quot;);
1262   Klass* volatile* addr = adr_implementor();
1263   assert(addr != NULL, &quot;null addr&quot;);
1264   if (addr != NULL) {
1265     Atomic::release_store(addr, k);
1266   }
1267 }
1268 
1269 int  InstanceKlass::nof_implementors() const {
1270   Klass* k = implementor();
1271   if (k == NULL) {
1272     return 0;
1273   } else if (k != this) {
1274     return 1;
1275   } else {
1276     return 2;
1277   }
1278 }
1279 
1280 // The embedded _implementor field can only record one implementor.
1281 // When there are more than one implementors, the _implementor field
1282 // is set to the interface Klass* itself. Following are the possible
1283 // values for the _implementor field:
1284 //   NULL                  - no implementor
1285 //   implementor Klass*    - one implementor
1286 //   self                  - more than one implementor
1287 //
1288 // The _implementor field only exists for interfaces.
1289 void InstanceKlass::add_implementor(Klass* k) {
1290   if (Universe::is_fully_initialized()) {
1291     assert_lock_strong(Compile_lock);
1292   }
1293   assert(is_interface(), &quot;not interface&quot;);
1294   // Filter out my subinterfaces.
1295   // (Note: Interfaces are never on the subklass list.)
1296   if (InstanceKlass::cast(k)-&gt;is_interface()) return;
1297 
1298   // Filter out subclasses whose supers already implement me.
1299   // (Note: CHA must walk subclasses of direct implementors
1300   // in order to locate indirect implementors.)
1301   Klass* sk = k-&gt;super();
1302   if (sk != NULL &amp;&amp; InstanceKlass::cast(sk)-&gt;implements_interface(this))
1303     // We only need to check one immediate superclass, since the
1304     // implements_interface query looks at transitive_interfaces.
1305     // Any supers of the super have the same (or fewer) transitive_interfaces.
1306     return;
1307 
1308   Klass* ik = implementor();
1309   if (ik == NULL) {
1310     set_implementor(k);
1311   } else if (ik != this &amp;&amp; ik != k) {
1312     // There is already an implementor. Use itself as an indicator of
1313     // more than one implementors.
1314     set_implementor(this);
1315   }
1316 
1317   // The implementor also implements the transitive_interfaces
1318   for (int index = 0; index &lt; local_interfaces()-&gt;length(); index++) {
1319     InstanceKlass::cast(local_interfaces()-&gt;at(index))-&gt;add_implementor(k);
1320   }
1321 }
1322 
1323 void InstanceKlass::init_implementor() {
1324   if (is_interface()) {
1325     set_implementor(NULL);
1326   }
1327 }
1328 
1329 
1330 void InstanceKlass::process_interfaces(Thread *thread) {
1331   // link this class into the implementors list of every interface it implements
1332   for (int i = local_interfaces()-&gt;length() - 1; i &gt;= 0; i--) {
1333     assert(local_interfaces()-&gt;at(i)-&gt;is_klass(), &quot;must be a klass&quot;);
1334     InstanceKlass* interf = InstanceKlass::cast(local_interfaces()-&gt;at(i));
1335     assert(interf-&gt;is_interface(), &quot;expected interface&quot;);
1336     interf-&gt;add_implementor(this);
1337   }
1338 }
1339 
1340 bool InstanceKlass::can_be_primary_super_slow() const {
1341   if (is_interface())
1342     return false;
1343   else
1344     return Klass::can_be_primary_super_slow();
1345 }
1346 
1347 GrowableArray&lt;Klass*&gt;* InstanceKlass::compute_secondary_supers(int num_extra_slots,
1348                                                                Array&lt;InstanceKlass*&gt;* transitive_interfaces) {
1349   // The secondaries are the implemented interfaces.
1350   Array&lt;InstanceKlass*&gt;* interfaces = transitive_interfaces;
1351   int num_secondaries = num_extra_slots + interfaces-&gt;length();
1352   if (num_secondaries == 0) {
1353     // Must share this for correct bootstrapping!
1354     set_secondary_supers(Universe::the_empty_klass_array());
1355     return NULL;
1356   } else if (num_extra_slots == 0) {
1357     // The secondary super list is exactly the same as the transitive interfaces, so
1358     // let&#39;s use it instead of making a copy.
1359     // Redefine classes has to be careful not to delete this!
1360     // We need the cast because Array&lt;Klass*&gt; is NOT a supertype of Array&lt;InstanceKlass*&gt;,
1361     // (but it&#39;s safe to do here because we won&#39;t write into _secondary_supers from this point on).
1362     set_secondary_supers((Array&lt;Klass*&gt;*)(address)interfaces);
1363     return NULL;
1364   } else {
1365     // Copy transitive interfaces to a temporary growable array to be constructed
1366     // into the secondary super list with extra slots.
1367     GrowableArray&lt;Klass*&gt;* secondaries = new GrowableArray&lt;Klass*&gt;(interfaces-&gt;length());
1368     for (int i = 0; i &lt; interfaces-&gt;length(); i++) {
1369       secondaries-&gt;push(interfaces-&gt;at(i));
1370     }
1371     return secondaries;
1372   }
1373 }
1374 
1375 bool InstanceKlass::implements_interface(Klass* k) const {
1376   if (this == k) return true;
1377   assert(k-&gt;is_interface(), &quot;should be an interface class&quot;);
1378   for (int i = 0; i &lt; transitive_interfaces()-&gt;length(); i++) {
1379     if (transitive_interfaces()-&gt;at(i) == k) {
1380       return true;
1381     }
1382   }
1383   return false;
1384 }
1385 
1386 bool InstanceKlass::is_same_or_direct_interface(Klass *k) const {
1387   // Verify direct super interface
1388   if (this == k) return true;
1389   assert(k-&gt;is_interface(), &quot;should be an interface class&quot;);
1390   for (int i = 0; i &lt; local_interfaces()-&gt;length(); i++) {
1391     if (local_interfaces()-&gt;at(i) == k) {
1392       return true;
1393     }
1394   }
1395   return false;
1396 }
1397 
1398 objArrayOop InstanceKlass::allocate_objArray(int n, int length, TRAPS) {
1399   check_array_allocation_length(length, arrayOopDesc::max_array_length(T_OBJECT), CHECK_NULL);
1400   int size = objArrayOopDesc::object_size(length);
1401   Klass* ak = array_klass(n, CHECK_NULL);
1402   objArrayOop o = (objArrayOop)Universe::heap()-&gt;array_allocate(ak, size, length,
1403                                                                 /* do_zero */ true, CHECK_NULL);
1404   return o;
1405 }
1406 
1407 instanceOop InstanceKlass::register_finalizer(instanceOop i, TRAPS) {
1408   if (TraceFinalizerRegistration) {
1409     tty-&gt;print(&quot;Registered &quot;);
1410     i-&gt;print_value_on(tty);
1411     tty-&gt;print_cr(&quot; (&quot; INTPTR_FORMAT &quot;) as finalizable&quot;, p2i(i));
1412   }
1413   instanceHandle h_i(THREAD, i);
1414   // Pass the handle as argument, JavaCalls::call expects oop as jobjects
1415   JavaValue result(T_VOID);
1416   JavaCallArguments args(h_i);
1417   methodHandle mh (THREAD, Universe::finalizer_register_method());
1418   JavaCalls::call(&amp;result, mh, &amp;args, CHECK_NULL);
1419   return h_i();
1420 }
1421 
1422 instanceOop InstanceKlass::allocate_instance(TRAPS) {
1423   bool has_finalizer_flag = has_finalizer(); // Query before possible GC
1424   int size = size_helper();  // Query before forming handle.
1425 
1426   instanceOop i;
1427 
1428   i = (instanceOop)Universe::heap()-&gt;obj_allocate(this, size, CHECK_NULL);
1429   if (has_finalizer_flag &amp;&amp; !RegisterFinalizersAtInit) {
1430     i = register_finalizer(i, CHECK_NULL);
1431   }
1432   return i;
1433 }
1434 
1435 instanceHandle InstanceKlass::allocate_instance_handle(TRAPS) {
1436   return instanceHandle(THREAD, allocate_instance(THREAD));
1437 }
1438 
1439 void InstanceKlass::check_valid_for_instantiation(bool throwError, TRAPS) {
1440   if (is_interface() || is_abstract()) {
1441     ResourceMark rm(THREAD);
1442     THROW_MSG(throwError ? vmSymbols::java_lang_InstantiationError()
1443               : vmSymbols::java_lang_InstantiationException(), external_name());
1444   }
1445   if (this == SystemDictionary::Class_klass()) {
1446     ResourceMark rm(THREAD);
1447     THROW_MSG(throwError ? vmSymbols::java_lang_IllegalAccessError()
1448               : vmSymbols::java_lang_IllegalAccessException(), external_name());
1449   }
1450 }
1451 
1452 Klass* InstanceKlass::array_klass_impl(ArrayStorageProperties storage_props, bool or_null, int n, TRAPS) {
1453   assert(storage_props.is_empty(), &quot;Unexpected&quot;);
1454   // Need load-acquire for lock-free read
1455   if (array_klasses_acquire() == NULL) {
1456     if (or_null) return NULL;
1457 
1458     ResourceMark rm(THREAD);
1459     JavaThread *jt = (JavaThread *)THREAD;
1460     {
1461       // Atomic creation of array_klasses
1462       MutexLocker ma(THREAD, MultiArray_lock);
1463 
1464       // Check if update has already taken place
1465       if (array_klasses() == NULL) {
1466         Klass*    k = ObjArrayKlass::allocate_objArray_klass(storage_props, 1, this, CHECK_NULL);
1467         // use &#39;release&#39; to pair with lock-free load
1468         release_set_array_klasses(k);
1469       }
1470     }
1471   }
1472   // _this will always be set at this point
1473   ObjArrayKlass* oak = (ObjArrayKlass*)array_klasses();
1474   if (or_null) {
1475     return oak-&gt;array_klass_or_null(storage_props, n);
1476   }
1477   return oak-&gt;array_klass(storage_props, n, THREAD);
1478 }
1479 
1480 Klass* InstanceKlass::array_klass_impl(ArrayStorageProperties storage_props, bool or_null, TRAPS) {
1481   return array_klass_impl(storage_props, or_null, 1, THREAD);
1482 }
1483 
1484 static int call_class_initializer_counter = 0;   // for debugging
1485 
1486 Method* InstanceKlass::class_initializer() const {
1487   Method* clinit = find_method(
1488       vmSymbols::class_initializer_name(), vmSymbols::void_method_signature());
1489   if (clinit != NULL &amp;&amp; clinit-&gt;is_class_initializer()) {
1490     return clinit;
1491   }
1492   return NULL;
1493 }
1494 
1495 void InstanceKlass::call_class_initializer(TRAPS) {
1496   if (ReplayCompiles &amp;&amp;
1497       (ReplaySuppressInitializers == 1 ||
1498        (ReplaySuppressInitializers &gt;= 2 &amp;&amp; class_loader() != NULL))) {
1499     // Hide the existence of the initializer for the purpose of replaying the compile
1500     return;
1501   }
1502 
1503   methodHandle h_method(THREAD, class_initializer());
1504   assert(!is_initialized(), &quot;we cannot initialize twice&quot;);
1505   LogTarget(Info, class, init) lt;
1506   if (lt.is_enabled()) {
1507     ResourceMark rm(THREAD);
1508     LogStream ls(lt);
1509     ls.print(&quot;%d Initializing &quot;, call_class_initializer_counter++);
1510     name()-&gt;print_value_on(&amp;ls);
1511     ls.print_cr(&quot;%s (&quot; INTPTR_FORMAT &quot;)&quot;, h_method() == NULL ? &quot;(no method)&quot; : &quot;&quot;, p2i(this));
1512   }
1513   if (h_method() != NULL) {
1514     JavaCallArguments args; // No arguments
1515     JavaValue result(T_VOID);
1516     JavaCalls::call(&amp;result, h_method, &amp;args, CHECK); // Static call (no args)
1517   }
1518 }
1519 
1520 
1521 void InstanceKlass::mask_for(const methodHandle&amp; method, int bci,
1522   InterpreterOopMap* entry_for) {
1523   // Lazily create the _oop_map_cache at first request
1524   // Lock-free access requires load_acquire.
1525   OopMapCache* oop_map_cache = Atomic::load_acquire(&amp;_oop_map_cache);
1526   if (oop_map_cache == NULL) {
1527     MutexLocker x(OopMapCacheAlloc_lock,  Mutex::_no_safepoint_check_flag);
1528     // Check if _oop_map_cache was allocated while we were waiting for this lock
1529     if ((oop_map_cache = _oop_map_cache) == NULL) {
1530       oop_map_cache = new OopMapCache();
1531       // Ensure _oop_map_cache is stable, since it is examined without a lock
1532       Atomic::release_store(&amp;_oop_map_cache, oop_map_cache);
1533     }
1534   }
1535   // _oop_map_cache is constant after init; lookup below does its own locking.
1536   oop_map_cache-&gt;lookup(method, bci, entry_for);
1537 }
1538 
1539 bool InstanceKlass::find_local_field(Symbol* name, Symbol* sig, fieldDescriptor* fd) const {
1540   for (JavaFieldStream fs(this); !fs.done(); fs.next()) {
1541     Symbol* f_name = fs.name();
1542     Symbol* f_sig  = fs.signature();
1543     if (f_name == name &amp;&amp; f_sig == sig) {
1544       fd-&gt;reinitialize(const_cast&lt;InstanceKlass*&gt;(this), fs.index());
1545       return true;
1546     }
1547   }
1548   return false;
1549 }
1550 
1551 
1552 Klass* InstanceKlass::find_interface_field(Symbol* name, Symbol* sig, fieldDescriptor* fd) const {
1553   const int n = local_interfaces()-&gt;length();
1554   for (int i = 0; i &lt; n; i++) {
1555     Klass* intf1 = local_interfaces()-&gt;at(i);
1556     assert(intf1-&gt;is_interface(), &quot;just checking type&quot;);
1557     // search for field in current interface
1558     if (InstanceKlass::cast(intf1)-&gt;find_local_field(name, sig, fd)) {
1559       assert(fd-&gt;is_static(), &quot;interface field must be static&quot;);
1560       return intf1;
1561     }
1562     // search for field in direct superinterfaces
1563     Klass* intf2 = InstanceKlass::cast(intf1)-&gt;find_interface_field(name, sig, fd);
1564     if (intf2 != NULL) return intf2;
1565   }
1566   // otherwise field lookup fails
1567   return NULL;
1568 }
1569 
1570 
1571 Klass* InstanceKlass::find_field(Symbol* name, Symbol* sig, fieldDescriptor* fd) const {
1572   // search order according to newest JVM spec (5.4.3.2, p.167).
1573   // 1) search for field in current klass
1574   if (find_local_field(name, sig, fd)) {
1575     return const_cast&lt;InstanceKlass*&gt;(this);
1576   }
1577   // 2) search for field recursively in direct superinterfaces
1578   { Klass* intf = find_interface_field(name, sig, fd);
1579     if (intf != NULL) return intf;
1580   }
1581   // 3) apply field lookup recursively if superclass exists
1582   { Klass* supr = super();
1583     if (supr != NULL) return InstanceKlass::cast(supr)-&gt;find_field(name, sig, fd);
1584   }
1585   // 4) otherwise field lookup fails
1586   return NULL;
1587 }
1588 
1589 
1590 Klass* InstanceKlass::find_field(Symbol* name, Symbol* sig, bool is_static, fieldDescriptor* fd) const {
1591   // search order according to newest JVM spec (5.4.3.2, p.167).
1592   // 1) search for field in current klass
1593   if (find_local_field(name, sig, fd)) {
1594     if (fd-&gt;is_static() == is_static) return const_cast&lt;InstanceKlass*&gt;(this);
1595   }
1596   // 2) search for field recursively in direct superinterfaces
1597   if (is_static) {
1598     Klass* intf = find_interface_field(name, sig, fd);
1599     if (intf != NULL) return intf;
1600   }
1601   // 3) apply field lookup recursively if superclass exists
1602   { Klass* supr = super();
1603     if (supr != NULL) return InstanceKlass::cast(supr)-&gt;find_field(name, sig, is_static, fd);
1604   }
1605   // 4) otherwise field lookup fails
1606   return NULL;
1607 }
1608 
1609 bool InstanceKlass::contains_field_offset(int offset) {
1610   if (this-&gt;is_value()) {
1611     ValueKlass* vk = ValueKlass::cast(this);
1612     return offset &gt;= vk-&gt;first_field_offset() &amp;&amp; offset &lt; (vk-&gt;first_field_offset() + vk-&gt;get_exact_size_in_bytes());
1613   } else {
1614     fieldDescriptor fd;
1615     return find_field_from_offset(offset, false, &amp;fd);
1616   }
1617 }
1618 
1619 bool InstanceKlass::find_local_field_from_offset(int offset, bool is_static, fieldDescriptor* fd) const {
1620   for (JavaFieldStream fs(this); !fs.done(); fs.next()) {
1621     if (fs.offset() == offset) {
1622       fd-&gt;reinitialize(const_cast&lt;InstanceKlass*&gt;(this), fs.index());
1623       if (fd-&gt;is_static() == is_static) return true;
1624     }
1625   }
1626   return false;
1627 }
1628 
1629 
1630 bool InstanceKlass::find_field_from_offset(int offset, bool is_static, fieldDescriptor* fd) const {
1631   Klass* klass = const_cast&lt;InstanceKlass*&gt;(this);
1632   while (klass != NULL) {
1633     if (InstanceKlass::cast(klass)-&gt;find_local_field_from_offset(offset, is_static, fd)) {
1634       return true;
1635     }
1636     klass = klass-&gt;super();
1637   }
1638   return false;
1639 }
1640 
1641 
1642 void InstanceKlass::methods_do(void f(Method* method)) {
1643   // Methods aren&#39;t stable until they are loaded.  This can be read outside
1644   // a lock through the ClassLoaderData for profiling
1645   if (!is_loaded()) {
1646     return;
1647   }
1648 
1649   int len = methods()-&gt;length();
1650   for (int index = 0; index &lt; len; index++) {
1651     Method* m = methods()-&gt;at(index);
1652     assert(m-&gt;is_method(), &quot;must be method&quot;);
1653     f(m);
1654   }
1655 }
1656 
1657 
1658 void InstanceKlass::do_local_static_fields(FieldClosure* cl) {
1659   for (JavaFieldStream fs(this); !fs.done(); fs.next()) {
1660     if (fs.access_flags().is_static()) {
1661       fieldDescriptor&amp; fd = fs.field_descriptor();
1662       cl-&gt;do_field(&amp;fd);
1663     }
1664   }
1665 }
1666 
1667 
1668 void InstanceKlass::do_local_static_fields(void f(fieldDescriptor*, Handle, TRAPS), Handle mirror, TRAPS) {
1669   for (JavaFieldStream fs(this); !fs.done(); fs.next()) {
1670     if (fs.access_flags().is_static()) {
1671       fieldDescriptor&amp; fd = fs.field_descriptor();
1672       f(&amp;fd, mirror, CHECK);
1673     }
1674   }
1675 }
1676 
1677 
1678 static int compare_fields_by_offset(int* a, int* b) {
1679   return a[0] - b[0];
1680 }
1681 
1682 void InstanceKlass::do_nonstatic_fields(FieldClosure* cl) {
1683   InstanceKlass* super = superklass();
1684   if (super != NULL) {
1685     super-&gt;do_nonstatic_fields(cl);
1686   }
1687   fieldDescriptor fd;
1688   int length = java_fields_count();
1689   // In DebugInfo nonstatic fields are sorted by offset.
1690   int* fields_sorted = NEW_C_HEAP_ARRAY(int, 2*(length+1), mtClass);
1691   int j = 0;
1692   for (int i = 0; i &lt; length; i += 1) {
1693     fd.reinitialize(this, i);
1694     if (!fd.is_static()) {
1695       fields_sorted[j + 0] = fd.offset();
1696       fields_sorted[j + 1] = i;
1697       j += 2;
1698     }
1699   }
1700   if (j &gt; 0) {
1701     length = j;
1702     // _sort_Fn is defined in growableArray.hpp.
1703     qsort(fields_sorted, length/2, 2*sizeof(int), (_sort_Fn)compare_fields_by_offset);
1704     for (int i = 0; i &lt; length; i += 2) {
1705       fd.reinitialize(this, fields_sorted[i + 1]);
1706       assert(!fd.is_static() &amp;&amp; fd.offset() == fields_sorted[i], &quot;only nonstatic fields&quot;);
1707       cl-&gt;do_field(&amp;fd);
1708     }
1709   }
1710   FREE_C_HEAP_ARRAY(int, fields_sorted);
1711 }
1712 
1713 
1714 void InstanceKlass::array_klasses_do(void f(Klass* k)) {
1715   if (array_klasses() != NULL)
1716     ArrayKlass::cast(array_klasses())-&gt;array_klasses_do(f);
1717 }
1718 
1719 #ifdef ASSERT
1720 static int linear_search(const Array&lt;Method*&gt;* methods,
1721                          const Symbol* name,
1722                          const Symbol* signature) {
1723   const int len = methods-&gt;length();
1724   for (int index = 0; index &lt; len; index++) {
1725     const Method* const m = methods-&gt;at(index);
1726     assert(m-&gt;is_method(), &quot;must be method&quot;);
1727     if (m-&gt;signature() == signature &amp;&amp; m-&gt;name() == name) {
1728        return index;
1729     }
1730   }
1731   return -1;
1732 }
1733 #endif
1734 
1735 bool InstanceKlass::_disable_method_binary_search = false;
1736 
1737 NOINLINE int linear_search(const Array&lt;Method*&gt;* methods, const Symbol* name) {
1738   int len = methods-&gt;length();
1739   int l = 0;
1740   int h = len - 1;
1741   while (l &lt;= h) {
1742     Method* m = methods-&gt;at(l);
1743     if (m-&gt;name() == name) {
1744       return l;
1745     }
1746     l++;
1747   }
1748   return -1;
1749 }
1750 
1751 inline int InstanceKlass::quick_search(const Array&lt;Method*&gt;* methods, const Symbol* name) {
1752   if (_disable_method_binary_search) {
1753     assert(DynamicDumpSharedSpaces, &quot;must be&quot;);
1754     // At the final stage of dynamic dumping, the methods array may not be sorted
1755     // by ascending addresses of their names, so we can&#39;t use binary search anymore.
1756     // However, methods with the same name are still laid out consecutively inside the
1757     // methods array, so let&#39;s look for the first one that matches.
1758     return linear_search(methods, name);
1759   }
1760 
1761   int len = methods-&gt;length();
1762   int l = 0;
1763   int h = len - 1;
1764 
1765   // methods are sorted by ascending addresses of their names, so do binary search
1766   while (l &lt;= h) {
1767     int mid = (l + h) &gt;&gt; 1;
1768     Method* m = methods-&gt;at(mid);
1769     assert(m-&gt;is_method(), &quot;must be method&quot;);
1770     int res = m-&gt;name()-&gt;fast_compare(name);
1771     if (res == 0) {
1772       return mid;
1773     } else if (res &lt; 0) {
1774       l = mid + 1;
1775     } else {
1776       h = mid - 1;
1777     }
1778   }
1779   return -1;
1780 }
1781 
1782 // find_method looks up the name/signature in the local methods array
1783 Method* InstanceKlass::find_method(const Symbol* name,
1784                                    const Symbol* signature) const {
1785   return find_method_impl(name, signature, find_overpass, find_static, find_private);
1786 }
1787 
1788 Method* InstanceKlass::find_method_impl(const Symbol* name,
1789                                         const Symbol* signature,
1790                                         OverpassLookupMode overpass_mode,
1791                                         StaticLookupMode static_mode,
1792                                         PrivateLookupMode private_mode) const {
1793   return InstanceKlass::find_method_impl(methods(),
1794                                          name,
1795                                          signature,
1796                                          overpass_mode,
1797                                          static_mode,
1798                                          private_mode);
1799 }
1800 
1801 // find_instance_method looks up the name/signature in the local methods array
1802 // and skips over static methods
1803 Method* InstanceKlass::find_instance_method(const Array&lt;Method*&gt;* methods,
1804                                             const Symbol* name,
1805                                             const Symbol* signature,
1806                                             PrivateLookupMode private_mode) {
1807   Method* const meth = InstanceKlass::find_method_impl(methods,
1808                                                  name,
1809                                                  signature,
1810                                                  find_overpass,
1811                                                  skip_static,
1812                                                  private_mode);
1813   assert(((meth == NULL) || !meth-&gt;is_static()),
1814     &quot;find_instance_method should have skipped statics&quot;);
1815   return meth;
1816 }
1817 
1818 // find_instance_method looks up the name/signature in the local methods array
1819 // and skips over static methods
1820 Method* InstanceKlass::find_instance_method(const Symbol* name,
1821                                             const Symbol* signature,
1822                                             PrivateLookupMode private_mode) const {
1823   return InstanceKlass::find_instance_method(methods(), name, signature, private_mode);
1824 }
1825 
1826 // Find looks up the name/signature in the local methods array
1827 // and filters on the overpass, static and private flags
1828 // This returns the first one found
1829 // note that the local methods array can have up to one overpass, one static
1830 // and one instance (private or not) with the same name/signature
1831 Method* InstanceKlass::find_local_method(const Symbol* name,
1832                                          const Symbol* signature,
1833                                          OverpassLookupMode overpass_mode,
1834                                          StaticLookupMode static_mode,
1835                                          PrivateLookupMode private_mode) const {
1836   return InstanceKlass::find_method_impl(methods(),
1837                                          name,
1838                                          signature,
1839                                          overpass_mode,
1840                                          static_mode,
1841                                          private_mode);
1842 }
1843 
1844 // Find looks up the name/signature in the local methods array
1845 // and filters on the overpass, static and private flags
1846 // This returns the first one found
1847 // note that the local methods array can have up to one overpass, one static
1848 // and one instance (private or not) with the same name/signature
1849 Method* InstanceKlass::find_local_method(const Array&lt;Method*&gt;* methods,
1850                                          const Symbol* name,
1851                                          const Symbol* signature,
1852                                          OverpassLookupMode overpass_mode,
1853                                          StaticLookupMode static_mode,
1854                                          PrivateLookupMode private_mode) {
1855   return InstanceKlass::find_method_impl(methods,
1856                                          name,
1857                                          signature,
1858                                          overpass_mode,
1859                                          static_mode,
1860                                          private_mode);
1861 }
1862 
1863 Method* InstanceKlass::find_method(const Array&lt;Method*&gt;* methods,
1864                                    const Symbol* name,
1865                                    const Symbol* signature) {
1866   return InstanceKlass::find_method_impl(methods,
1867                                          name,
1868                                          signature,
1869                                          find_overpass,
1870                                          find_static,
1871                                          find_private);
1872 }
1873 
1874 Method* InstanceKlass::find_method_impl(const Array&lt;Method*&gt;* methods,
1875                                         const Symbol* name,
1876                                         const Symbol* signature,
1877                                         OverpassLookupMode overpass_mode,
1878                                         StaticLookupMode static_mode,
1879                                         PrivateLookupMode private_mode) {
1880   int hit = find_method_index(methods, name, signature, overpass_mode, static_mode, private_mode);
1881   return hit &gt;= 0 ? methods-&gt;at(hit): NULL;
1882 }
1883 
1884 // true if method matches signature and conforms to skipping_X conditions.
1885 static bool method_matches(const Method* m,
1886                            const Symbol* signature,
1887                            bool skipping_overpass,
1888                            bool skipping_static,
1889                            bool skipping_private) {
1890   return ((m-&gt;signature() == signature) &amp;&amp;
1891     (!skipping_overpass || !m-&gt;is_overpass()) &amp;&amp;
1892     (!skipping_static || !m-&gt;is_static()) &amp;&amp;
1893     (!skipping_private || !m-&gt;is_private()));
1894 }
1895 
1896 // Used directly for default_methods to find the index into the
1897 // default_vtable_indices, and indirectly by find_method
1898 // find_method_index looks in the local methods array to return the index
1899 // of the matching name/signature. If, overpass methods are being ignored,
1900 // the search continues to find a potential non-overpass match.  This capability
1901 // is important during method resolution to prefer a static method, for example,
1902 // over an overpass method.
1903 // There is the possibility in any _method&#39;s array to have the same name/signature
1904 // for a static method, an overpass method and a local instance method
1905 // To correctly catch a given method, the search criteria may need
1906 // to explicitly skip the other two. For local instance methods, it
1907 // is often necessary to skip private methods
1908 int InstanceKlass::find_method_index(const Array&lt;Method*&gt;* methods,
1909                                      const Symbol* name,
1910                                      const Symbol* signature,
1911                                      OverpassLookupMode overpass_mode,
1912                                      StaticLookupMode static_mode,
1913                                      PrivateLookupMode private_mode) {
1914   const bool skipping_overpass = (overpass_mode == skip_overpass);
1915   const bool skipping_static = (static_mode == skip_static);
1916   const bool skipping_private = (private_mode == skip_private);
1917   const int hit = quick_search(methods, name);
1918   if (hit != -1) {
1919     const Method* const m = methods-&gt;at(hit);
1920 
1921     // Do linear search to find matching signature.  First, quick check
1922     // for common case, ignoring overpasses if requested.
1923     if (method_matches(m, signature, skipping_overpass, skipping_static, skipping_private)) {
1924       return hit;
1925     }
1926 
1927     // search downwards through overloaded methods
1928     int i;
1929     for (i = hit - 1; i &gt;= 0; --i) {
1930         const Method* const m = methods-&gt;at(i);
1931         assert(m-&gt;is_method(), &quot;must be method&quot;);
1932         if (m-&gt;name() != name) {
1933           break;
1934         }
1935         if (method_matches(m, signature, skipping_overpass, skipping_static, skipping_private)) {
1936           return i;
1937         }
1938     }
1939     // search upwards
1940     for (i = hit + 1; i &lt; methods-&gt;length(); ++i) {
1941         const Method* const m = methods-&gt;at(i);
1942         assert(m-&gt;is_method(), &quot;must be method&quot;);
1943         if (m-&gt;name() != name) {
1944           break;
1945         }
1946         if (method_matches(m, signature, skipping_overpass, skipping_static, skipping_private)) {
1947           return i;
1948         }
1949     }
1950     // not found
1951 #ifdef ASSERT
1952     const int index = (skipping_overpass || skipping_static || skipping_private) ? -1 :
1953       linear_search(methods, name, signature);
1954     assert(-1 == index, &quot;binary search should have found entry %d&quot;, index);
1955 #endif
1956   }
1957   return -1;
1958 }
1959 
1960 int InstanceKlass::find_method_by_name(const Symbol* name, int* end) const {
1961   return find_method_by_name(methods(), name, end);
1962 }
1963 
1964 int InstanceKlass::find_method_by_name(const Array&lt;Method*&gt;* methods,
1965                                        const Symbol* name,
1966                                        int* end_ptr) {
1967   assert(end_ptr != NULL, &quot;just checking&quot;);
1968   int start = quick_search(methods, name);
1969   int end = start + 1;
1970   if (start != -1) {
1971     while (start - 1 &gt;= 0 &amp;&amp; (methods-&gt;at(start - 1))-&gt;name() == name) --start;
1972     while (end &lt; methods-&gt;length() &amp;&amp; (methods-&gt;at(end))-&gt;name() == name) ++end;
1973     *end_ptr = end;
1974     return start;
1975   }
1976   return -1;
1977 }
1978 
1979 // uncached_lookup_method searches both the local class methods array and all
1980 // superclasses methods arrays, skipping any overpass methods in superclasses,
1981 // and possibly skipping private methods.
1982 Method* InstanceKlass::uncached_lookup_method(const Symbol* name,
1983                                               const Symbol* signature,
1984                                               OverpassLookupMode overpass_mode,
1985                                               PrivateLookupMode private_mode) const {
1986   OverpassLookupMode overpass_local_mode = overpass_mode;
1987   const Klass* klass = this;
1988   while (klass != NULL) {
1989     Method* const method = InstanceKlass::cast(klass)-&gt;find_method_impl(name,
1990                                                                         signature,
1991                                                                         overpass_local_mode,
1992                                                                         find_static,
1993                                                                         private_mode);
1994     if (method != NULL) {
1995       return method;
1996     }
1997     if (name == vmSymbols::object_initializer_name()) {
1998       break;  // &lt;init&gt; is never inherited, not even as a static factory
1999     }
2000     klass = klass-&gt;super();
2001     overpass_local_mode = skip_overpass;   // Always ignore overpass methods in superclasses
2002   }
2003   return NULL;
2004 }
2005 
2006 #ifdef ASSERT
2007 // search through class hierarchy and return true if this class or
2008 // one of the superclasses was redefined
2009 bool InstanceKlass::has_redefined_this_or_super() const {
2010   const Klass* klass = this;
2011   while (klass != NULL) {
2012     if (InstanceKlass::cast(klass)-&gt;has_been_redefined()) {
2013       return true;
2014     }
2015     klass = klass-&gt;super();
2016   }
2017   return false;
2018 }
2019 #endif
2020 
2021 // lookup a method in the default methods list then in all transitive interfaces
2022 // Do NOT return private or static methods
2023 Method* InstanceKlass::lookup_method_in_ordered_interfaces(Symbol* name,
2024                                                          Symbol* signature) const {
2025   Method* m = NULL;
2026   if (default_methods() != NULL) {
2027     m = find_method(default_methods(), name, signature);
2028   }
2029   // Look up interfaces
2030   if (m == NULL) {
2031     m = lookup_method_in_all_interfaces(name, signature, find_defaults);
2032   }
2033   return m;
2034 }
2035 
2036 // lookup a method in all the interfaces that this class implements
2037 // Do NOT return private or static methods, new in JDK8 which are not externally visible
2038 // They should only be found in the initial InterfaceMethodRef
2039 Method* InstanceKlass::lookup_method_in_all_interfaces(Symbol* name,
2040                                                        Symbol* signature,
2041                                                        DefaultsLookupMode defaults_mode) const {
2042   Array&lt;InstanceKlass*&gt;* all_ifs = transitive_interfaces();
2043   int num_ifs = all_ifs-&gt;length();
2044   InstanceKlass *ik = NULL;
2045   for (int i = 0; i &lt; num_ifs; i++) {
2046     ik = all_ifs-&gt;at(i);
2047     Method* m = ik-&gt;lookup_method(name, signature);
2048     if (m != NULL &amp;&amp; m-&gt;is_public() &amp;&amp; !m-&gt;is_static() &amp;&amp;
2049         ((defaults_mode != skip_defaults) || !m-&gt;is_default_method())) {
2050       return m;
2051     }
2052   }
2053   return NULL;
2054 }
2055 
2056 /* jni_id_for_impl for jfieldIds only */
2057 JNIid* InstanceKlass::jni_id_for_impl(int offset) {
2058   MutexLocker ml(JfieldIdCreation_lock);
2059   // Retry lookup after we got the lock
2060   JNIid* probe = jni_ids() == NULL ? NULL : jni_ids()-&gt;find(offset);
2061   if (probe == NULL) {
2062     // Slow case, allocate new static field identifier
2063     probe = new JNIid(this, offset, jni_ids());
2064     set_jni_ids(probe);
2065   }
2066   return probe;
2067 }
2068 
2069 
2070 /* jni_id_for for jfieldIds only */
2071 JNIid* InstanceKlass::jni_id_for(int offset) {
2072   JNIid* probe = jni_ids() == NULL ? NULL : jni_ids()-&gt;find(offset);
2073   if (probe == NULL) {
2074     probe = jni_id_for_impl(offset);
2075   }
2076   return probe;
2077 }
2078 
2079 u2 InstanceKlass::enclosing_method_data(int offset) const {
2080   const Array&lt;jushort&gt;* const inner_class_list = inner_classes();
2081   if (inner_class_list == NULL) {
2082     return 0;
2083   }
2084   const int length = inner_class_list-&gt;length();
2085   if (length % inner_class_next_offset == 0) {
2086     return 0;
2087   }
2088   const int index = length - enclosing_method_attribute_size;
2089   assert(offset &lt; enclosing_method_attribute_size, &quot;invalid offset&quot;);
2090   return inner_class_list-&gt;at(index + offset);
2091 }
2092 
2093 void InstanceKlass::set_enclosing_method_indices(u2 class_index,
2094                                                  u2 method_index) {
2095   Array&lt;jushort&gt;* inner_class_list = inner_classes();
2096   assert (inner_class_list != NULL, &quot;_inner_classes list is not set up&quot;);
2097   int length = inner_class_list-&gt;length();
2098   if (length % inner_class_next_offset == enclosing_method_attribute_size) {
2099     int index = length - enclosing_method_attribute_size;
2100     inner_class_list-&gt;at_put(
2101       index + enclosing_method_class_index_offset, class_index);
2102     inner_class_list-&gt;at_put(
2103       index + enclosing_method_method_index_offset, method_index);
2104   }
2105 }
2106 
2107 // Lookup or create a jmethodID.
2108 // This code is called by the VMThread and JavaThreads so the
2109 // locking has to be done very carefully to avoid deadlocks
2110 // and/or other cache consistency problems.
2111 //
2112 jmethodID InstanceKlass::get_jmethod_id(const methodHandle&amp; method_h) {
2113   size_t idnum = (size_t)method_h-&gt;method_idnum();
2114   jmethodID* jmeths = methods_jmethod_ids_acquire();
2115   size_t length = 0;
2116   jmethodID id = NULL;
2117 
2118   // We use a double-check locking idiom here because this cache is
2119   // performance sensitive. In the normal system, this cache only
2120   // transitions from NULL to non-NULL which is safe because we use
2121   // release_set_methods_jmethod_ids() to advertise the new cache.
2122   // A partially constructed cache should never be seen by a racing
2123   // thread. We also use release_store() to save a new jmethodID
2124   // in the cache so a partially constructed jmethodID should never be
2125   // seen either. Cache reads of existing jmethodIDs proceed without a
2126   // lock, but cache writes of a new jmethodID requires uniqueness and
2127   // creation of the cache itself requires no leaks so a lock is
2128   // generally acquired in those two cases.
2129   //
2130   // If the RedefineClasses() API has been used, then this cache can
2131   // grow and we&#39;ll have transitions from non-NULL to bigger non-NULL.
2132   // Cache creation requires no leaks and we require safety between all
2133   // cache accesses and freeing of the old cache so a lock is generally
2134   // acquired when the RedefineClasses() API has been used.
2135 
2136   if (jmeths != NULL) {
2137     // the cache already exists
2138     if (!idnum_can_increment()) {
2139       // the cache can&#39;t grow so we can just get the current values
2140       get_jmethod_id_length_value(jmeths, idnum, &amp;length, &amp;id);
2141     } else {
2142       // cache can grow so we have to be more careful
2143       if (Threads::number_of_threads() == 0 ||
2144           SafepointSynchronize::is_at_safepoint()) {
2145         // we&#39;re single threaded or at a safepoint - no locking needed
2146         get_jmethod_id_length_value(jmeths, idnum, &amp;length, &amp;id);
2147       } else {
2148         MutexLocker ml(JmethodIdCreation_lock, Mutex::_no_safepoint_check_flag);
2149         get_jmethod_id_length_value(jmeths, idnum, &amp;length, &amp;id);
2150       }
2151     }
2152   }
2153   // implied else:
2154   // we need to allocate a cache so default length and id values are good
2155 
2156   if (jmeths == NULL ||   // no cache yet
2157       length &lt;= idnum ||  // cache is too short
2158       id == NULL) {       // cache doesn&#39;t contain entry
2159 
2160     // This function can be called by the VMThread so we have to do all
2161     // things that might block on a safepoint before grabbing the lock.
2162     // Otherwise, we can deadlock with the VMThread or have a cache
2163     // consistency issue. These vars keep track of what we might have
2164     // to free after the lock is dropped.
2165     jmethodID  to_dealloc_id     = NULL;
2166     jmethodID* to_dealloc_jmeths = NULL;
2167 
2168     // may not allocate new_jmeths or use it if we allocate it
2169     jmethodID* new_jmeths = NULL;
2170     if (length &lt;= idnum) {
2171       // allocate a new cache that might be used
2172       size_t size = MAX2(idnum+1, (size_t)idnum_allocated_count());
2173       new_jmeths = NEW_C_HEAP_ARRAY(jmethodID, size+1, mtClass);
2174       memset(new_jmeths, 0, (size+1)*sizeof(jmethodID));
2175       // cache size is stored in element[0], other elements offset by one
2176       new_jmeths[0] = (jmethodID)size;
2177     }
2178 
2179     // allocate a new jmethodID that might be used
2180     jmethodID new_id = NULL;
2181     if (method_h-&gt;is_old() &amp;&amp; !method_h-&gt;is_obsolete()) {
2182       // The method passed in is old (but not obsolete), we need to use the current version
2183       Method* current_method = method_with_idnum((int)idnum);
2184       assert(current_method != NULL, &quot;old and but not obsolete, so should exist&quot;);
2185       new_id = Method::make_jmethod_id(class_loader_data(), current_method);
2186     } else {
2187       // It is the current version of the method or an obsolete method,
2188       // use the version passed in
2189       new_id = Method::make_jmethod_id(class_loader_data(), method_h());
2190     }
2191 
2192     if (Threads::number_of_threads() == 0 ||
2193         SafepointSynchronize::is_at_safepoint()) {
2194       // we&#39;re single threaded or at a safepoint - no locking needed
2195       id = get_jmethod_id_fetch_or_update(idnum, new_id, new_jmeths,
2196                                           &amp;to_dealloc_id, &amp;to_dealloc_jmeths);
2197     } else {
2198       MutexLocker ml(JmethodIdCreation_lock, Mutex::_no_safepoint_check_flag);
2199       id = get_jmethod_id_fetch_or_update(idnum, new_id, new_jmeths,
2200                                           &amp;to_dealloc_id, &amp;to_dealloc_jmeths);
2201     }
2202 
2203     // The lock has been dropped so we can free resources.
2204     // Free up either the old cache or the new cache if we allocated one.
2205     if (to_dealloc_jmeths != NULL) {
2206       FreeHeap(to_dealloc_jmeths);
2207     }
2208     // free up the new ID since it wasn&#39;t needed
2209     if (to_dealloc_id != NULL) {
2210       Method::destroy_jmethod_id(class_loader_data(), to_dealloc_id);
2211     }
2212   }
2213   return id;
2214 }
2215 
2216 // Figure out how many jmethodIDs haven&#39;t been allocated, and make
2217 // sure space for them is pre-allocated.  This makes getting all
2218 // method ids much, much faster with classes with more than 8
2219 // methods, and has a *substantial* effect on performance with jvmti
2220 // code that loads all jmethodIDs for all classes.
2221 void InstanceKlass::ensure_space_for_methodids(int start_offset) {
2222   int new_jmeths = 0;
2223   int length = methods()-&gt;length();
2224   for (int index = start_offset; index &lt; length; index++) {
2225     Method* m = methods()-&gt;at(index);
2226     jmethodID id = m-&gt;find_jmethod_id_or_null();
2227     if (id == NULL) {
2228       new_jmeths++;
2229     }
2230   }
2231   if (new_jmeths != 0) {
2232     Method::ensure_jmethod_ids(class_loader_data(), new_jmeths);
2233   }
2234 }
2235 
2236 // Common code to fetch the jmethodID from the cache or update the
2237 // cache with the new jmethodID. This function should never do anything
2238 // that causes the caller to go to a safepoint or we can deadlock with
2239 // the VMThread or have cache consistency issues.
2240 //
2241 jmethodID InstanceKlass::get_jmethod_id_fetch_or_update(
2242             size_t idnum, jmethodID new_id,
2243             jmethodID* new_jmeths, jmethodID* to_dealloc_id_p,
2244             jmethodID** to_dealloc_jmeths_p) {
2245   assert(new_id != NULL, &quot;sanity check&quot;);
2246   assert(to_dealloc_id_p != NULL, &quot;sanity check&quot;);
2247   assert(to_dealloc_jmeths_p != NULL, &quot;sanity check&quot;);
2248   assert(Threads::number_of_threads() == 0 ||
2249          SafepointSynchronize::is_at_safepoint() ||
2250          JmethodIdCreation_lock-&gt;owned_by_self(), &quot;sanity check&quot;);
2251 
2252   // reacquire the cache - we are locked, single threaded or at a safepoint
2253   jmethodID* jmeths = methods_jmethod_ids_acquire();
2254   jmethodID  id     = NULL;
2255   size_t     length = 0;
2256 
2257   if (jmeths == NULL ||                         // no cache yet
2258       (length = (size_t)jmeths[0]) &lt;= idnum) {  // cache is too short
2259     if (jmeths != NULL) {
2260       // copy any existing entries from the old cache
2261       for (size_t index = 0; index &lt; length; index++) {
2262         new_jmeths[index+1] = jmeths[index+1];
2263       }
2264       *to_dealloc_jmeths_p = jmeths;  // save old cache for later delete
2265     }
2266     release_set_methods_jmethod_ids(jmeths = new_jmeths);
2267   } else {
2268     // fetch jmethodID (if any) from the existing cache
2269     id = jmeths[idnum+1];
2270     *to_dealloc_jmeths_p = new_jmeths;  // save new cache for later delete
2271   }
2272   if (id == NULL) {
2273     // No matching jmethodID in the existing cache or we have a new
2274     // cache or we just grew the cache. This cache write is done here
2275     // by the first thread to win the foot race because a jmethodID
2276     // needs to be unique once it is generally available.
2277     id = new_id;
2278 
2279     // The jmethodID cache can be read while unlocked so we have to
2280     // make sure the new jmethodID is complete before installing it
2281     // in the cache.
2282     Atomic::release_store(&amp;jmeths[idnum+1], id);
2283   } else {
2284     *to_dealloc_id_p = new_id; // save new id for later delete
2285   }
2286   return id;
2287 }
2288 
2289 
2290 // Common code to get the jmethodID cache length and the jmethodID
2291 // value at index idnum if there is one.
2292 //
2293 void InstanceKlass::get_jmethod_id_length_value(jmethodID* cache,
2294        size_t idnum, size_t *length_p, jmethodID* id_p) {
2295   assert(cache != NULL, &quot;sanity check&quot;);
2296   assert(length_p != NULL, &quot;sanity check&quot;);
2297   assert(id_p != NULL, &quot;sanity check&quot;);
2298 
2299   // cache size is stored in element[0], other elements offset by one
2300   *length_p = (size_t)cache[0];
2301   if (*length_p &lt;= idnum) {  // cache is too short
2302     *id_p = NULL;
2303   } else {
2304     *id_p = cache[idnum+1];  // fetch jmethodID (if any)
2305   }
2306 }
2307 
2308 
2309 // Lookup a jmethodID, NULL if not found.  Do no blocking, no allocations, no handles
2310 jmethodID InstanceKlass::jmethod_id_or_null(Method* method) {
2311   size_t idnum = (size_t)method-&gt;method_idnum();
2312   jmethodID* jmeths = methods_jmethod_ids_acquire();
2313   size_t length;                                // length assigned as debugging crumb
2314   jmethodID id = NULL;
2315   if (jmeths != NULL &amp;&amp;                         // If there is a cache
2316       (length = (size_t)jmeths[0]) &gt; idnum) {   // and if it is long enough,
2317     id = jmeths[idnum+1];                       // Look up the id (may be NULL)
2318   }
2319   return id;
2320 }
2321 
2322 inline DependencyContext InstanceKlass::dependencies() {
2323   DependencyContext dep_context(&amp;_dep_context, &amp;_dep_context_last_cleaned);
2324   return dep_context;
2325 }
2326 
2327 int InstanceKlass::mark_dependent_nmethods(KlassDepChange&amp; changes) {
2328   return dependencies().mark_dependent_nmethods(changes);
2329 }
2330 
2331 void InstanceKlass::add_dependent_nmethod(nmethod* nm) {
2332   dependencies().add_dependent_nmethod(nm);
2333 }
2334 
2335 void InstanceKlass::remove_dependent_nmethod(nmethod* nm) {
2336   dependencies().remove_dependent_nmethod(nm);
2337 }
2338 
2339 void InstanceKlass::clean_dependency_context() {
2340   dependencies().clean_unloading_dependents();
2341 }
2342 
2343 #ifndef PRODUCT
2344 void InstanceKlass::print_dependent_nmethods(bool verbose) {
2345   dependencies().print_dependent_nmethods(verbose);
2346 }
2347 
2348 bool InstanceKlass::is_dependent_nmethod(nmethod* nm) {
2349   return dependencies().is_dependent_nmethod(nm);
2350 }
2351 #endif //PRODUCT
2352 
2353 void InstanceKlass::clean_weak_instanceklass_links() {
2354   clean_implementors_list();
2355   clean_method_data();
2356 }
2357 
2358 void InstanceKlass::clean_implementors_list() {
2359   assert(is_loader_alive(), &quot;this klass should be live&quot;);
2360   if (is_interface()) {
2361     assert (ClassUnloading, &quot;only called for ClassUnloading&quot;);
2362     for (;;) {
2363       // Use load_acquire due to competing with inserts
2364       Klass* impl = Atomic::load_acquire(adr_implementor());
2365       if (impl != NULL &amp;&amp; !impl-&gt;is_loader_alive()) {
2366         // NULL this field, might be an unloaded klass or NULL
2367         Klass* volatile* klass = adr_implementor();
2368         if (Atomic::cmpxchg(klass, impl, (Klass*)NULL) == impl) {
2369           // Successfully unlinking implementor.
2370           if (log_is_enabled(Trace, class, unload)) {
2371             ResourceMark rm;
2372             log_trace(class, unload)(&quot;unlinking class (implementor): %s&quot;, impl-&gt;external_name());
2373           }
2374           return;
2375         }
2376       } else {
2377         return;
2378       }
2379     }
2380   }
2381 }
2382 
2383 void InstanceKlass::clean_method_data() {
2384   for (int m = 0; m &lt; methods()-&gt;length(); m++) {
2385     MethodData* mdo = methods()-&gt;at(m)-&gt;method_data();
2386     if (mdo != NULL) {
2387       MutexLocker ml(SafepointSynchronize::is_at_safepoint() ? NULL : mdo-&gt;extra_data_lock());
2388       mdo-&gt;clean_method_data(/*always_clean*/false);
2389     }
2390   }
2391 }
2392 
2393 bool InstanceKlass::supers_have_passed_fingerprint_checks() {
2394   if (java_super() != NULL &amp;&amp; !java_super()-&gt;has_passed_fingerprint_check()) {
2395     ResourceMark rm;
2396     log_trace(class, fingerprint)(&quot;%s : super %s not fingerprinted&quot;, external_name(), java_super()-&gt;external_name());
2397     return false;
2398   }
2399 
2400   Array&lt;InstanceKlass*&gt;* local_interfaces = this-&gt;local_interfaces();
2401   if (local_interfaces != NULL) {
2402     int length = local_interfaces-&gt;length();
2403     for (int i = 0; i &lt; length; i++) {
2404       InstanceKlass* intf = local_interfaces-&gt;at(i);
2405       if (!intf-&gt;has_passed_fingerprint_check()) {
2406         ResourceMark rm;
2407         log_trace(class, fingerprint)(&quot;%s : interface %s not fingerprinted&quot;, external_name(), intf-&gt;external_name());
2408         return false;
2409       }
2410     }
2411   }
2412 
2413   return true;
2414 }
2415 
2416 bool InstanceKlass::should_store_fingerprint(bool is_unsafe_anonymous) {
2417 #if INCLUDE_AOT
2418   // We store the fingerprint into the InstanceKlass only in the following 2 cases:
2419   if (CalculateClassFingerprint) {
2420     // (1) We are running AOT to generate a shared library.
2421     return true;
2422   }
2423   if (Arguments::is_dumping_archive()) {
2424     // (2) We are running -Xshare:dump or -XX:ArchiveClassesAtExit to create a shared archive
2425     return true;
2426   }
2427   if (UseAOT &amp;&amp; is_unsafe_anonymous) {
2428     // (3) We are using AOT code from a shared library and see an unsafe anonymous class
2429     return true;
2430   }
2431 #endif
2432 
2433   // In all other cases we might set the _misc_has_passed_fingerprint_check bit,
2434   // but do not store the 64-bit fingerprint to save space.
2435   return false;
2436 }
2437 
2438 bool InstanceKlass::has_stored_fingerprint() const {
2439 #if INCLUDE_AOT
2440   return should_store_fingerprint() || is_shared();
2441 #else
2442   return false;
2443 #endif
2444 }
2445 
2446 uint64_t InstanceKlass::get_stored_fingerprint() const {
2447   address adr = adr_fingerprint();
2448   if (adr != NULL) {
2449     return (uint64_t)Bytes::get_native_u8(adr); // adr may not be 64-bit aligned
2450   }
2451   return 0;
2452 }
2453 
2454 void InstanceKlass::store_fingerprint(uint64_t fingerprint) {
2455   address adr = adr_fingerprint();
2456   if (adr != NULL) {
2457     Bytes::put_native_u8(adr, (u8)fingerprint); // adr may not be 64-bit aligned
2458 
2459     ResourceMark rm;
2460     log_trace(class, fingerprint)(&quot;stored as &quot; PTR64_FORMAT &quot; for class %s&quot;, fingerprint, external_name());
2461   }
2462 }
2463 
2464 void InstanceKlass::metaspace_pointers_do(MetaspaceClosure* it) {
2465   Klass::metaspace_pointers_do(it);
2466 
2467   if (log_is_enabled(Trace, cds)) {
2468     ResourceMark rm;
2469     log_trace(cds)(&quot;Iter(InstanceKlass): %p (%s)&quot;, this, external_name());
2470   }
2471 
2472   it-&gt;push(&amp;_annotations);
2473   it-&gt;push((Klass**)&amp;_array_klasses);
2474   it-&gt;push(&amp;_constants);
2475   it-&gt;push(&amp;_inner_classes);
2476   it-&gt;push(&amp;_array_name);
2477 #if INCLUDE_JVMTI
2478   it-&gt;push(&amp;_previous_versions);
2479 #endif
2480   it-&gt;push(&amp;_methods);
2481   it-&gt;push(&amp;_default_methods);
2482   it-&gt;push(&amp;_local_interfaces);
2483   it-&gt;push(&amp;_transitive_interfaces);
2484   it-&gt;push(&amp;_method_ordering);
2485   it-&gt;push(&amp;_default_vtable_indices);
2486   it-&gt;push(&amp;_fields);
2487 
2488   if (itable_length() &gt; 0) {
2489     itableOffsetEntry* ioe = (itableOffsetEntry*)start_of_itable();
2490     int method_table_offset_in_words = ioe-&gt;offset()/wordSize;
2491     int nof_interfaces = (method_table_offset_in_words - itable_offset_in_words())
2492                          / itableOffsetEntry::size();
2493 
2494     for (int i = 0; i &lt; nof_interfaces; i ++, ioe ++) {
2495       if (ioe-&gt;interface_klass() != NULL) {
2496         it-&gt;push(ioe-&gt;interface_klass_addr());
2497         itableMethodEntry* ime = ioe-&gt;first_method_entry(this);
2498         int n = klassItable::method_count_for_interface(ioe-&gt;interface_klass());
2499         for (int index = 0; index &lt; n; index ++) {
2500           it-&gt;push(ime[index].method_addr());
2501         }
2502       }
2503     }
2504   }
2505 
2506   it-&gt;push(&amp;_nest_members);
2507   it-&gt;push(&amp;_record_components);
2508 }
2509 
2510 void InstanceKlass::remove_unshareable_info() {
2511   Klass::remove_unshareable_info();
2512 
2513   if (SystemDictionaryShared::has_class_failed_verification(this)) {
2514     // Classes are attempted to link during dumping and may fail,
2515     // but these classes are still in the dictionary and class list in CLD.
2516     // If the class has failed verification, there is nothing else to remove.
2517     return;
2518   }
2519 
2520   // Reset to the &#39;allocated&#39; state to prevent any premature accessing to
2521   // a shared class at runtime while the class is still being loaded and
2522   // restored. A class&#39; init_state is set to &#39;loaded&#39; at runtime when it&#39;s
2523   // being added to class hierarchy (see SystemDictionary:::add_to_hierarchy()).
2524   _init_state = allocated;
2525 
2526   { // Otherwise this needs to take out the Compile_lock.
2527     assert(SafepointSynchronize::is_at_safepoint(), &quot;only called at safepoint&quot;);
2528     init_implementor();
2529   }
2530 
2531   constants()-&gt;remove_unshareable_info();
2532 
2533   for (int i = 0; i &lt; methods()-&gt;length(); i++) {
2534     Method* m = methods()-&gt;at(i);
2535     m-&gt;remove_unshareable_info();
2536   }
2537 
2538   // do array classes also.
2539   if (array_klasses() != NULL) {
2540     array_klasses()-&gt;remove_unshareable_info();
2541   }
2542 
2543   // These are not allocated from metaspace. They are safe to set to NULL.
2544   _source_debug_extension = NULL;
2545   _dep_context = NULL;
2546   _osr_nmethods_head = NULL;
2547 #if INCLUDE_JVMTI
2548   _breakpoints = NULL;
2549   _previous_versions = NULL;
2550   _cached_class_file = NULL;
2551   _jvmti_cached_class_field_map = NULL;
2552 #endif
2553 
2554   _init_thread = NULL;
2555   _methods_jmethod_ids = NULL;
2556   _jni_ids = NULL;
2557   _oop_map_cache = NULL;
2558   // clear _nest_host to ensure re-load at runtime
2559   _nest_host = NULL;
2560   _package_entry = NULL;
2561   _dep_context_last_cleaned = 0;
2562 }
2563 
2564 void InstanceKlass::remove_java_mirror() {
2565   Klass::remove_java_mirror();
2566 
2567   // do array classes also.
2568   if (array_klasses() != NULL) {
2569     array_klasses()-&gt;remove_java_mirror();
2570   }
2571 }
2572 
2573 void InstanceKlass::restore_unshareable_info(ClassLoaderData* loader_data, Handle protection_domain,
2574                                              PackageEntry* pkg_entry, TRAPS) {
2575   // SystemDictionary::add_to_hierarchy() sets the init_state to loaded
2576   // before the InstanceKlass is added to the SystemDictionary. Make
2577   // sure the current state is &lt;loaded.
2578   assert(!is_loaded(), &quot;invalid init state&quot;);
2579   set_package(loader_data, pkg_entry, CHECK);
2580   Klass::restore_unshareable_info(loader_data, protection_domain, CHECK);
2581 
2582   if (is_value()) {
2583     ValueKlass::cast(this)-&gt;initialize_calling_convention(CHECK);
2584   }
2585 
2586   Array&lt;Method*&gt;* methods = this-&gt;methods();
2587   int num_methods = methods-&gt;length();
2588   for (int index = 0; index &lt; num_methods; ++index) {
2589     methods-&gt;at(index)-&gt;restore_unshareable_info(CHECK);
2590   }
2591   if (JvmtiExport::has_redefined_a_class()) {
2592     // Reinitialize vtable because RedefineClasses may have changed some
2593     // entries in this vtable for super classes so the CDS vtable might
2594     // point to old or obsolete entries.  RedefineClasses doesn&#39;t fix up
2595     // vtables in the shared system dictionary, only the main one.
2596     // It also redefines the itable too so fix that too.
2597     vtable().initialize_vtable(false, CHECK);
2598     itable().initialize_itable(false, CHECK);
2599   }
2600 
2601   // restore constant pool resolved references
2602   constants()-&gt;restore_unshareable_info(CHECK);
2603 
2604   if (array_klasses() != NULL) {
2605     // Array classes have null protection domain.
2606     // --&gt; see ArrayKlass::complete_create_array_klass()
2607     ArrayKlass::cast(array_klasses())-&gt;restore_unshareable_info(ClassLoaderData::the_null_class_loader_data(), Handle(), CHECK);
2608   }
2609 
2610   // Initialize current biased locking state.
2611   if (UseBiasedLocking &amp;&amp; BiasedLocking::enabled() &amp;&amp; !is_value()) {
2612     set_prototype_header(markWord::biased_locking_prototype());
2613   }
2614 }
2615 
2616 void InstanceKlass::set_shared_class_loader_type(s2 loader_type) {
2617   switch (loader_type) {
2618   case ClassLoader::BOOT_LOADER:
2619     _misc_flags |= _misc_is_shared_boot_class;
2620     break;
2621   case ClassLoader::PLATFORM_LOADER:
2622     _misc_flags |= _misc_is_shared_platform_class;
2623     break;
2624   case ClassLoader::APP_LOADER:
2625     _misc_flags |= _misc_is_shared_app_class;
2626     break;
2627   default:
2628     ShouldNotReachHere();
2629     break;
2630   }
2631 }
2632 
2633 #if INCLUDE_JVMTI
2634 static void clear_all_breakpoints(Method* m) {
2635   m-&gt;clear_all_breakpoints();
2636 }
2637 #endif
2638 
2639 void InstanceKlass::unload_class(InstanceKlass* ik) {
2640   // Release dependencies.
2641   ik-&gt;dependencies().remove_all_dependents();
2642 
2643   // notify the debugger
2644   if (JvmtiExport::should_post_class_unload()) {
2645     JvmtiExport::post_class_unload(ik);
2646   }
2647 
2648   // notify ClassLoadingService of class unload
2649   ClassLoadingService::notify_class_unloaded(ik);
2650 
2651   if (Arguments::is_dumping_archive()) {
2652     SystemDictionaryShared::remove_dumptime_info(ik);
2653   }
2654 
2655   if (log_is_enabled(Info, class, unload)) {
2656     ResourceMark rm;
2657     log_info(class, unload)(&quot;unloading class %s &quot; INTPTR_FORMAT, ik-&gt;external_name(), p2i(ik));
2658   }
2659 
2660   Events::log_class_unloading(Thread::current(), ik);
2661 
2662 #if INCLUDE_JFR
2663   assert(ik != NULL, &quot;invariant&quot;);
2664   EventClassUnload event;
2665   event.set_unloadedClass(ik);
2666   event.set_definingClassLoader(ik-&gt;class_loader_data());
2667   event.commit();
2668 #endif
2669 }
2670 
2671 static void method_release_C_heap_structures(Method* m) {
2672   m-&gt;release_C_heap_structures();
2673 }
2674 
2675 void InstanceKlass::release_C_heap_structures(InstanceKlass* ik) {
2676   // Clean up C heap
2677   ik-&gt;release_C_heap_structures();
2678   ik-&gt;constants()-&gt;release_C_heap_structures();
2679 
2680   // Deallocate and call destructors for MDO mutexes
2681   ik-&gt;methods_do(method_release_C_heap_structures);
2682 
2683 }
2684 
2685 void InstanceKlass::release_C_heap_structures() {
2686   // Can&#39;t release the constant pool here because the constant pool can be
2687   // deallocated separately from the InstanceKlass for default methods and
2688   // redefine classes.
2689 
2690   // Deallocate oop map cache
2691   if (_oop_map_cache != NULL) {
2692     delete _oop_map_cache;
2693     _oop_map_cache = NULL;
2694   }
2695 
2696   // Deallocate JNI identifiers for jfieldIDs
2697   JNIid::deallocate(jni_ids());
2698   set_jni_ids(NULL);
2699 
2700   jmethodID* jmeths = methods_jmethod_ids_acquire();
2701   if (jmeths != (jmethodID*)NULL) {
2702     release_set_methods_jmethod_ids(NULL);
2703     FreeHeap(jmeths);
2704   }
2705 
2706   assert(_dep_context == NULL,
2707          &quot;dependencies should already be cleaned&quot;);
2708 
2709 #if INCLUDE_JVMTI
2710   // Deallocate breakpoint records
2711   if (breakpoints() != 0x0) {
2712     methods_do(clear_all_breakpoints);
2713     assert(breakpoints() == 0x0, &quot;should have cleared breakpoints&quot;);
2714   }
2715 
2716   // deallocate the cached class file
2717   if (_cached_class_file != NULL) {
2718     os::free(_cached_class_file);
2719     _cached_class_file = NULL;
2720   }
2721 #endif
2722 
2723   // Decrement symbol reference counts associated with the unloaded class.
2724   if (_name != NULL) _name-&gt;decrement_refcount();
2725   // unreference array name derived from this class name (arrays of an unloaded
2726   // class can&#39;t be referenced anymore).
2727   if (_array_name != NULL)  _array_name-&gt;decrement_refcount();
2728   if (_value_types != NULL) {
2729     for (int i = 0; i &lt; _value_types-&gt;length(); i++) {
2730       Symbol* s = _value_types-&gt;at(i)._class_name;
2731       if (s != NULL) {
2732         s-&gt;decrement_refcount();
2733       }
2734     }
2735   }
2736   FREE_C_HEAP_ARRAY(char, _source_debug_extension);
2737 }
2738 
2739 void InstanceKlass::set_source_debug_extension(const char* array, int length) {
2740   if (array == NULL) {
2741     _source_debug_extension = NULL;
2742   } else {
2743     // Adding one to the attribute length in order to store a null terminator
2744     // character could cause an overflow because the attribute length is
2745     // already coded with an u4 in the classfile, but in practice, it&#39;s
2746     // unlikely to happen.
2747     assert((length+1) &gt; length, &quot;Overflow checking&quot;);
2748     char* sde = NEW_C_HEAP_ARRAY(char, (length + 1), mtClass);
2749     for (int i = 0; i &lt; length; i++) {
2750       sde[i] = array[i];
2751     }
2752     sde[length] = &#39;\0&#39;;
2753     _source_debug_extension = sde;
2754   }
2755 }
2756 
2757 const char* InstanceKlass::signature_name() const {
2758   return signature_name_of(is_value() ? JVM_SIGNATURE_VALUETYPE : JVM_SIGNATURE_CLASS);
2759 }
2760 
2761 const char* InstanceKlass::signature_name_of(char c) const {
2762   int hash_len = 0;
2763   char hash_buf[40];
2764 
2765   // If this is an unsafe anonymous class, append a hash to make the name unique
2766   if (is_unsafe_anonymous()) {
2767     intptr_t hash = (java_mirror() != NULL) ? java_mirror()-&gt;identity_hash() : 0;
2768     jio_snprintf(hash_buf, sizeof(hash_buf), &quot;/&quot; UINTX_FORMAT, (uintx)hash);
2769     hash_len = (int)strlen(hash_buf);
2770   }
2771 
2772   // Get the internal name as a c string
2773   const char* src = (const char*) (name()-&gt;as_C_string());
2774   const int src_length = (int)strlen(src);
2775 
2776   char* dest = NEW_RESOURCE_ARRAY(char, src_length + hash_len + 3);
2777 
2778   // Add L or Q as type indicator
2779   int dest_index = 0;
2780   dest[dest_index++] = c;
2781 
2782   // Add the actual class name
2783   for (int src_index = 0; src_index &lt; src_length; ) {
2784     dest[dest_index++] = src[src_index++];
2785   }
2786 
2787   // If we have a hash, append it
2788   for (int hash_index = 0; hash_index &lt; hash_len; ) {
2789     dest[dest_index++] = hash_buf[hash_index++];
2790   }
2791 
2792   // Add the semicolon and the NULL
2793   dest[dest_index++] = JVM_SIGNATURE_ENDCLASS;
2794   dest[dest_index] = &#39;\0&#39;;
2795   return dest;
2796 }
2797 
2798 ModuleEntry* InstanceKlass::module() const {
2799   // For an unsafe anonymous class return the host class&#39; module
2800   if (is_unsafe_anonymous()) {
2801     assert(unsafe_anonymous_host() != NULL, &quot;unsafe anonymous class must have a host class&quot;);
2802     return unsafe_anonymous_host()-&gt;module();
2803   }
2804 
2805   // Class is in a named package
2806   if (!in_unnamed_package()) {
2807     return _package_entry-&gt;module();
2808   }
2809 
2810   // Class is in an unnamed package, return its loader&#39;s unnamed module
2811   return class_loader_data()-&gt;unnamed_module();
2812 }
2813 
2814 void InstanceKlass::set_package(ClassLoaderData* loader_data, PackageEntry* pkg_entry, TRAPS) {
2815 
2816   // ensure java/ packages only loaded by boot or platform builtin loaders
2817   check_prohibited_package(name(), loader_data, CHECK);
2818 
2819   TempNewSymbol pkg_name = pkg_entry != NULL ? pkg_entry-&gt;name() : ClassLoader::package_from_class_name(name());
2820 
2821   if (pkg_name != NULL &amp;&amp; loader_data != NULL) {
2822 
2823     // Find in class loader&#39;s package entry table.
2824     _package_entry = pkg_entry != NULL ? pkg_entry : loader_data-&gt;packages()-&gt;lookup_only(pkg_name);
2825 
2826     // If the package name is not found in the loader&#39;s package
2827     // entry table, it is an indication that the package has not
2828     // been defined. Consider it defined within the unnamed module.
2829     if (_package_entry == NULL) {
2830 
2831       if (!ModuleEntryTable::javabase_defined()) {
2832         // Before java.base is defined during bootstrapping, define all packages in
2833         // the java.base module.  If a non-java.base package is erroneously placed
2834         // in the java.base module it will be caught later when java.base
2835         // is defined by ModuleEntryTable::verify_javabase_packages check.
2836         assert(ModuleEntryTable::javabase_moduleEntry() != NULL, JAVA_BASE_NAME &quot; module is NULL&quot;);
2837         _package_entry = loader_data-&gt;packages()-&gt;lookup(pkg_name, ModuleEntryTable::javabase_moduleEntry());
2838       } else {
2839         assert(loader_data-&gt;unnamed_module() != NULL, &quot;unnamed module is NULL&quot;);
2840         _package_entry = loader_data-&gt;packages()-&gt;lookup(pkg_name,
2841                                                          loader_data-&gt;unnamed_module());
2842       }
2843 
2844       // A package should have been successfully created
2845       DEBUG_ONLY(ResourceMark rm(THREAD));
2846       assert(_package_entry != NULL, &quot;Package entry for class %s not found, loader %s&quot;,
2847              name()-&gt;as_C_string(), loader_data-&gt;loader_name_and_id());
2848     }
2849 
2850     if (log_is_enabled(Debug, module)) {
2851       ResourceMark rm(THREAD);
2852       ModuleEntry* m = _package_entry-&gt;module();
2853       log_trace(module)(&quot;Setting package: class: %s, package: %s, loader: %s, module: %s&quot;,
2854                         external_name(),
2855                         pkg_name-&gt;as_C_string(),
2856                         loader_data-&gt;loader_name_and_id(),
2857                         (m-&gt;is_named() ? m-&gt;name()-&gt;as_C_string() : UNNAMED_MODULE));
2858     }
2859   } else {
2860     ResourceMark rm(THREAD);
2861     log_trace(module)(&quot;Setting package: class: %s, package: unnamed, loader: %s, module: %s&quot;,
2862                       external_name(),
2863                       (loader_data != NULL) ? loader_data-&gt;loader_name_and_id() : &quot;NULL&quot;,
2864                       UNNAMED_MODULE);
2865   }
2866 }
2867 
2868 
2869 // different versions of is_same_class_package
2870 
2871 bool InstanceKlass::is_same_class_package(const Klass* class2) const {
2872   oop classloader1 = this-&gt;class_loader();
2873   PackageEntry* classpkg1 = this-&gt;package();
2874   if (class2-&gt;is_objArray_klass()) {
2875     class2 = ObjArrayKlass::cast(class2)-&gt;bottom_klass();
2876   }
2877 
2878   oop classloader2;
2879   PackageEntry* classpkg2;
2880   if (class2-&gt;is_instance_klass()) {
2881     classloader2 = class2-&gt;class_loader();
2882     classpkg2 = class2-&gt;package();
2883   } else {
2884     assert(class2-&gt;is_typeArray_klass(), &quot;should be type array&quot;);
2885     classloader2 = NULL;
2886     classpkg2 = NULL;
2887   }
2888 
2889   // Same package is determined by comparing class loader
2890   // and package entries. Both must be the same. This rule
2891   // applies even to classes that are defined in the unnamed
2892   // package, they still must have the same class loader.
2893   if ((classloader1 == classloader2) &amp;&amp; (classpkg1 == classpkg2)) {
2894     return true;
2895   }
2896 
2897   return false;
2898 }
2899 
2900 // return true if this class and other_class are in the same package. Classloader
2901 // and classname information is enough to determine a class&#39;s package
2902 bool InstanceKlass::is_same_class_package(oop other_class_loader,
2903                                           const Symbol* other_class_name) const {
2904   if (class_loader() != other_class_loader) {
2905     return false;
2906   }
2907   if (name()-&gt;fast_compare(other_class_name) == 0) {
2908      return true;
2909   }
2910 
2911   {
2912     ResourceMark rm;
2913 
2914     bool bad_class_name = false;
2915     TempNewSymbol other_pkg = ClassLoader::package_from_class_name(other_class_name, &amp;bad_class_name);
2916     if (bad_class_name) {
2917       return false;
2918     }
2919     // Check that package_from_class_name() returns NULL, not &quot;&quot;, if there is no package.
2920     assert(other_pkg == NULL || other_pkg-&gt;utf8_length() &gt; 0, &quot;package name is empty string&quot;);
2921 
2922     const Symbol* const this_package_name =
2923       this-&gt;package() != NULL ? this-&gt;package()-&gt;name() : NULL;
2924 
2925     if (this_package_name == NULL || other_pkg == NULL) {
2926       // One of the two doesn&#39;t have a package.  Only return true if the other
2927       // one also doesn&#39;t have a package.
2928       return this_package_name == other_pkg;
2929     }
2930 
2931     // Check if package is identical
2932     return this_package_name-&gt;fast_compare(other_pkg) == 0;
2933   }
2934 }
2935 
2936 // Returns true iff super_method can be overridden by a method in targetclassname
2937 // See JLS 3rd edition 8.4.6.1
2938 // Assumes name-signature match
2939 // &quot;this&quot; is InstanceKlass of super_method which must exist
2940 // note that the InstanceKlass of the method in the targetclassname has not always been created yet
2941 bool InstanceKlass::is_override(const methodHandle&amp; super_method, Handle targetclassloader, Symbol* targetclassname, TRAPS) {
2942    // Private methods can not be overridden
2943    if (super_method-&gt;is_private()) {
2944      return false;
2945    }
2946    // If super method is accessible, then override
2947    if ((super_method-&gt;is_protected()) ||
2948        (super_method-&gt;is_public())) {
2949      return true;
2950    }
2951    // Package-private methods are not inherited outside of package
2952    assert(super_method-&gt;is_package_private(), &quot;must be package private&quot;);
2953    return(is_same_class_package(targetclassloader(), targetclassname));
2954 }
2955 
2956 // Only boot and platform class loaders can define classes in &quot;java/&quot; packages.
2957 void InstanceKlass::check_prohibited_package(Symbol* class_name,
2958                                              ClassLoaderData* loader_data,
2959                                              TRAPS) {
2960   if (!loader_data-&gt;is_boot_class_loader_data() &amp;&amp;
2961       !loader_data-&gt;is_platform_class_loader_data() &amp;&amp;
2962       class_name != NULL) {
2963     ResourceMark rm(THREAD);
2964     char* name = class_name-&gt;as_C_string();
2965     if (strncmp(name, JAVAPKG, JAVAPKG_LEN) == 0 &amp;&amp; name[JAVAPKG_LEN] == &#39;/&#39;) {
2966       TempNewSymbol pkg_name = ClassLoader::package_from_class_name(class_name);
2967       assert(pkg_name != NULL, &quot;Error in parsing package name starting with &#39;java/&#39;&quot;);
2968       name = pkg_name-&gt;as_C_string();
2969       const char* class_loader_name = loader_data-&gt;loader_name_and_id();
2970       StringUtils::replace_no_expand(name, &quot;/&quot;, &quot;.&quot;);
2971       const char* msg_text1 = &quot;Class loader (instance of): &quot;;
2972       const char* msg_text2 = &quot; tried to load prohibited package name: &quot;;
2973       size_t len = strlen(msg_text1) + strlen(class_loader_name) + strlen(msg_text2) + strlen(name) + 1;
2974       char* message = NEW_RESOURCE_ARRAY_IN_THREAD(THREAD, char, len);
2975       jio_snprintf(message, len, &quot;%s%s%s%s&quot;, msg_text1, class_loader_name, msg_text2, name);
2976       THROW_MSG(vmSymbols::java_lang_SecurityException(), message);
2977     }
2978   }
2979   return;
2980 }
2981 
2982 bool InstanceKlass::find_inner_classes_attr(int* ooff, int* noff, TRAPS) const {
2983   constantPoolHandle i_cp(THREAD, constants());
2984   for (InnerClassesIterator iter(this); !iter.done(); iter.next()) {
2985     int ioff = iter.inner_class_info_index();
2986     if (ioff != 0) {
2987       // Check to see if the name matches the class we&#39;re looking for
2988       // before attempting to find the class.
2989       if (i_cp-&gt;klass_name_at_matches(this, ioff)) {
2990         Klass* inner_klass = i_cp-&gt;klass_at(ioff, CHECK_false);
2991         if (this == inner_klass) {
2992           *ooff = iter.outer_class_info_index();
2993           *noff = iter.inner_name_index();
2994           return true;
2995         }
2996       }
2997     }
2998   }
2999   return false;
3000 }
3001 
3002 InstanceKlass* InstanceKlass::compute_enclosing_class(bool* inner_is_member, TRAPS) const {
3003   InstanceKlass* outer_klass = NULL;
3004   *inner_is_member = false;
3005   int ooff = 0, noff = 0;
3006   bool has_inner_classes_attr = find_inner_classes_attr(&amp;ooff, &amp;noff, THREAD);
3007   if (has_inner_classes_attr) {
3008     constantPoolHandle i_cp(THREAD, constants());
3009     if (ooff != 0) {
3010       Klass* ok = i_cp-&gt;klass_at(ooff, CHECK_NULL);
3011       outer_klass = InstanceKlass::cast(ok);
3012       *inner_is_member = true;
3013     }
3014     if (NULL == outer_klass) {
3015       // It may be unsafe anonymous; try for that.
3016       int encl_method_class_idx = enclosing_method_class_index();
3017       if (encl_method_class_idx != 0) {
3018         Klass* ok = i_cp-&gt;klass_at(encl_method_class_idx, CHECK_NULL);
3019         outer_klass = InstanceKlass::cast(ok);
3020         *inner_is_member = false;
3021       }
3022     }
3023   }
3024 
3025   // If no inner class attribute found for this class.
3026   if (NULL == outer_klass) return NULL;
3027 
3028   // Throws an exception if outer klass has not declared k as an inner klass
3029   // We need evidence that each klass knows about the other, or else
3030   // the system could allow a spoof of an inner class to gain access rights.
3031   Reflection::check_for_inner_class(outer_klass, this, *inner_is_member, CHECK_NULL);
3032   return outer_klass;
3033 }
3034 
3035 jint InstanceKlass::compute_modifier_flags(TRAPS) const {
3036   jint access = access_flags().as_int();
3037 
3038   // But check if it happens to be member class.
3039   InnerClassesIterator iter(this);
3040   for (; !iter.done(); iter.next()) {
3041     int ioff = iter.inner_class_info_index();
3042     // Inner class attribute can be zero, skip it.
3043     // Strange but true:  JVM spec. allows null inner class refs.
3044     if (ioff == 0) continue;
3045 
3046     // only look at classes that are already loaded
3047     // since we are looking for the flags for our self.
3048     Symbol* inner_name = constants()-&gt;klass_name_at(ioff);
3049     if (name() == inner_name) {
3050       // This is really a member class.
3051       access = iter.inner_access_flags();
3052       break;
3053     }
3054   }
3055   // Remember to strip ACC_SUPER bit
3056   return (access &amp; (~JVM_ACC_SUPER)) &amp; JVM_ACC_WRITTEN_FLAGS;
3057 }
3058 
3059 jint InstanceKlass::jvmti_class_status() const {
3060   jint result = 0;
3061 
3062   if (is_linked()) {
3063     result |= JVMTI_CLASS_STATUS_VERIFIED | JVMTI_CLASS_STATUS_PREPARED;
3064   }
3065 
3066   if (is_initialized()) {
3067     assert(is_linked(), &quot;Class status is not consistent&quot;);
3068     result |= JVMTI_CLASS_STATUS_INITIALIZED;
3069   }
3070   if (is_in_error_state()) {
3071     result |= JVMTI_CLASS_STATUS_ERROR;
3072   }
3073   return result;
3074 }
3075 
3076 Method* InstanceKlass::method_at_itable(Klass* holder, int index, TRAPS) {
3077   itableOffsetEntry* ioe = (itableOffsetEntry*)start_of_itable();
3078   int method_table_offset_in_words = ioe-&gt;offset()/wordSize;
3079   int nof_interfaces = (method_table_offset_in_words - itable_offset_in_words())
3080                        / itableOffsetEntry::size();
3081 
3082   for (int cnt = 0 ; ; cnt ++, ioe ++) {
3083     // If the interface isn&#39;t implemented by the receiver class,
3084     // the VM should throw IncompatibleClassChangeError.
3085     if (cnt &gt;= nof_interfaces) {
3086       ResourceMark rm(THREAD);
3087       stringStream ss;
3088       bool same_module = (module() == holder-&gt;module());
3089       ss.print(&quot;Receiver class %s does not implement &quot;
3090                &quot;the interface %s defining the method to be called &quot;
3091                &quot;(%s%s%s)&quot;,
3092                external_name(), holder-&gt;external_name(),
3093                (same_module) ? joint_in_module_of_loader(holder) : class_in_module_of_loader(),
3094                (same_module) ? &quot;&quot; : &quot;; &quot;,
3095                (same_module) ? &quot;&quot; : holder-&gt;class_in_module_of_loader());
3096       THROW_MSG_NULL(vmSymbols::java_lang_IncompatibleClassChangeError(), ss.as_string());
3097     }
3098 
3099     Klass* ik = ioe-&gt;interface_klass();
3100     if (ik == holder) break;
3101   }
3102 
3103   itableMethodEntry* ime = ioe-&gt;first_method_entry(this);
3104   Method* m = ime[index].method();
3105   if (m == NULL) {
3106     THROW_NULL(vmSymbols::java_lang_AbstractMethodError());
3107   }
3108   return m;
3109 }
3110 
3111 
3112 #if INCLUDE_JVMTI
3113 // update default_methods for redefineclasses for methods that are
3114 // not yet in the vtable due to concurrent subclass define and superinterface
3115 // redefinition
3116 // Note: those in the vtable, should have been updated via adjust_method_entries
3117 void InstanceKlass::adjust_default_methods(bool* trace_name_printed) {
3118   // search the default_methods for uses of either obsolete or EMCP methods
3119   if (default_methods() != NULL) {
3120     for (int index = 0; index &lt; default_methods()-&gt;length(); index ++) {
3121       Method* old_method = default_methods()-&gt;at(index);
3122       if (old_method == NULL || !old_method-&gt;is_old()) {
3123         continue; // skip uninteresting entries
3124       }
3125       assert(!old_method-&gt;is_deleted(), &quot;default methods may not be deleted&quot;);
3126       Method* new_method = old_method-&gt;get_new_method();
3127       default_methods()-&gt;at_put(index, new_method);
3128 
3129       if (log_is_enabled(Info, redefine, class, update)) {
3130         ResourceMark rm;
3131         if (!(*trace_name_printed)) {
3132           log_info(redefine, class, update)
3133             (&quot;adjust: klassname=%s default methods from name=%s&quot;,
3134              external_name(), old_method-&gt;method_holder()-&gt;external_name());
3135           *trace_name_printed = true;
3136         }
3137         log_debug(redefine, class, update, vtables)
3138           (&quot;default method update: %s(%s) &quot;,
3139            new_method-&gt;name()-&gt;as_C_string(), new_method-&gt;signature()-&gt;as_C_string());
3140       }
3141     }
3142   }
3143 }
3144 #endif // INCLUDE_JVMTI
3145 
3146 // On-stack replacement stuff
3147 void InstanceKlass::add_osr_nmethod(nmethod* n) {
3148   assert_lock_strong(CompiledMethod_lock);
3149 #ifndef PRODUCT
3150   if (TieredCompilation) {
3151       nmethod * prev = lookup_osr_nmethod(n-&gt;method(), n-&gt;osr_entry_bci(), n-&gt;comp_level(), true);
3152       assert(prev == NULL || !prev-&gt;is_in_use(),
3153       &quot;redundunt OSR recompilation detected. memory leak in CodeCache!&quot;);
3154   }
3155 #endif
3156   // only one compilation can be active
3157   {
3158     assert(n-&gt;is_osr_method(), &quot;wrong kind of nmethod&quot;);
3159     n-&gt;set_osr_link(osr_nmethods_head());
3160     set_osr_nmethods_head(n);
3161     // Raise the highest osr level if necessary
3162     if (TieredCompilation) {
3163       Method* m = n-&gt;method();
3164       m-&gt;set_highest_osr_comp_level(MAX2(m-&gt;highest_osr_comp_level(), n-&gt;comp_level()));
3165     }
3166   }
3167 
3168   // Get rid of the osr methods for the same bci that have lower levels.
3169   if (TieredCompilation) {
3170     for (int l = CompLevel_limited_profile; l &lt; n-&gt;comp_level(); l++) {
3171       nmethod *inv = lookup_osr_nmethod(n-&gt;method(), n-&gt;osr_entry_bci(), l, true);
3172       if (inv != NULL &amp;&amp; inv-&gt;is_in_use()) {
3173         inv-&gt;make_not_entrant();
3174       }
3175     }
3176   }
3177 }
3178 
3179 // Remove osr nmethod from the list. Return true if found and removed.
3180 bool InstanceKlass::remove_osr_nmethod(nmethod* n) {
3181   // This is a short non-blocking critical region, so the no safepoint check is ok.
3182   MutexLocker ml(CompiledMethod_lock-&gt;owned_by_self() ? NULL : CompiledMethod_lock
3183                  , Mutex::_no_safepoint_check_flag);
3184   assert(n-&gt;is_osr_method(), &quot;wrong kind of nmethod&quot;);
3185   nmethod* last = NULL;
3186   nmethod* cur  = osr_nmethods_head();
3187   int max_level = CompLevel_none;  // Find the max comp level excluding n
3188   Method* m = n-&gt;method();
3189   // Search for match
3190   bool found = false;
3191   while(cur != NULL &amp;&amp; cur != n) {
3192     if (TieredCompilation &amp;&amp; m == cur-&gt;method()) {
3193       // Find max level before n
3194       max_level = MAX2(max_level, cur-&gt;comp_level());
3195     }
3196     last = cur;
3197     cur = cur-&gt;osr_link();
3198   }
3199   nmethod* next = NULL;
3200   if (cur == n) {
3201     found = true;
3202     next = cur-&gt;osr_link();
3203     if (last == NULL) {
3204       // Remove first element
3205       set_osr_nmethods_head(next);
3206     } else {
3207       last-&gt;set_osr_link(next);
3208     }
3209   }
3210   n-&gt;set_osr_link(NULL);
3211   if (TieredCompilation) {
3212     cur = next;
3213     while (cur != NULL) {
3214       // Find max level after n
3215       if (m == cur-&gt;method()) {
3216         max_level = MAX2(max_level, cur-&gt;comp_level());
3217       }
3218       cur = cur-&gt;osr_link();
3219     }
3220     m-&gt;set_highest_osr_comp_level(max_level);
3221   }
3222   return found;
3223 }
3224 
3225 int InstanceKlass::mark_osr_nmethods(const Method* m) {
3226   MutexLocker ml(CompiledMethod_lock-&gt;owned_by_self() ? NULL : CompiledMethod_lock,
3227                  Mutex::_no_safepoint_check_flag);
3228   nmethod* osr = osr_nmethods_head();
3229   int found = 0;
3230   while (osr != NULL) {
3231     assert(osr-&gt;is_osr_method(), &quot;wrong kind of nmethod found in chain&quot;);
3232     if (osr-&gt;method() == m) {
3233       osr-&gt;mark_for_deoptimization();
3234       found++;
3235     }
3236     osr = osr-&gt;osr_link();
3237   }
3238   return found;
3239 }
3240 
3241 nmethod* InstanceKlass::lookup_osr_nmethod(const Method* m, int bci, int comp_level, bool match_level) const {
3242   MutexLocker ml(CompiledMethod_lock-&gt;owned_by_self() ? NULL : CompiledMethod_lock,
3243                  Mutex::_no_safepoint_check_flag);
3244   nmethod* osr = osr_nmethods_head();
3245   nmethod* best = NULL;
3246   while (osr != NULL) {
3247     assert(osr-&gt;is_osr_method(), &quot;wrong kind of nmethod found in chain&quot;);
3248     // There can be a time when a c1 osr method exists but we are waiting
3249     // for a c2 version. When c2 completes its osr nmethod we will trash
3250     // the c1 version and only be able to find the c2 version. However
3251     // while we overflow in the c1 code at back branches we don&#39;t want to
3252     // try and switch to the same code as we are already running
3253 
3254     if (osr-&gt;method() == m &amp;&amp;
3255         (bci == InvocationEntryBci || osr-&gt;osr_entry_bci() == bci)) {
3256       if (match_level) {
3257         if (osr-&gt;comp_level() == comp_level) {
3258           // Found a match - return it.
3259           return osr;
3260         }
3261       } else {
3262         if (best == NULL || (osr-&gt;comp_level() &gt; best-&gt;comp_level())) {
3263           if (osr-&gt;comp_level() == CompLevel_highest_tier) {
3264             // Found the best possible - return it.
3265             return osr;
3266           }
3267           best = osr;
3268         }
3269       }
3270     }
3271     osr = osr-&gt;osr_link();
3272   }
3273 
3274   assert(match_level == false || best == NULL, &quot;shouldn&#39;t pick up anything if match_level is set&quot;);
3275   if (best != NULL &amp;&amp; best-&gt;comp_level() &gt;= comp_level) {
3276     return best;
3277   }
3278   return NULL;
3279 }
3280 
3281 // -----------------------------------------------------------------------------------------------------
3282 // Printing
3283 
3284 #ifndef PRODUCT
3285 
3286 #define BULLET  &quot; - &quot;
3287 
3288 static const char* state_names[] = {
3289   &quot;allocated&quot;, &quot;loaded&quot;, &quot;linked&quot;, &quot;being_initialized&quot;, &quot;fully_initialized&quot;, &quot;initialization_error&quot;
3290 };
3291 
3292 static void print_vtable(address self, intptr_t* start, int len, outputStream* st) {
3293   ResourceMark rm;
3294   int* forward_refs = NEW_RESOURCE_ARRAY(int, len);
3295   for (int i = 0; i &lt; len; i++)  forward_refs[i] = 0;
3296   for (int i = 0; i &lt; len; i++) {
3297     intptr_t e = start[i];
3298     st-&gt;print(&quot;%d : &quot; INTPTR_FORMAT, i, e);
3299     if (forward_refs[i] != 0) {
3300       int from = forward_refs[i];
3301       int off = (int) start[from];
3302       st-&gt;print(&quot; (offset %d &lt;= [%d])&quot;, off, from);
3303     }
3304     if (MetaspaceObj::is_valid((Metadata*)e)) {
3305       st-&gt;print(&quot; &quot;);
3306       ((Metadata*)e)-&gt;print_value_on(st);
3307     } else if (self != NULL &amp;&amp; e &gt; 0 &amp;&amp; e &lt; 0x10000) {
3308       address location = self + e;
3309       int index = (int)((intptr_t*)location - start);
3310       st-&gt;print(&quot; (offset %d =&gt; [%d])&quot;, (int)e, index);
3311       if (index &gt;= 0 &amp;&amp; index &lt; len)
3312         forward_refs[index] = i;
3313     }
3314     st-&gt;cr();
3315   }
3316 }
3317 
3318 static void print_vtable(vtableEntry* start, int len, outputStream* st) {
3319   return print_vtable(NULL, reinterpret_cast&lt;intptr_t*&gt;(start), len, st);
3320 }
3321 
3322 template&lt;typename T&gt;
3323  static void print_array_on(outputStream* st, Array&lt;T&gt;* array) {
3324    if (array == NULL) { st-&gt;print_cr(&quot;NULL&quot;); return; }
3325    array-&gt;print_value_on(st); st-&gt;cr();
3326    if (Verbose || WizardMode) {
3327      for (int i = 0; i &lt; array-&gt;length(); i++) {
3328        st-&gt;print(&quot;%d : &quot;, i); array-&gt;at(i)-&gt;print_value_on(st); st-&gt;cr();
3329      }
3330    }
3331  }
3332 
3333 static void print_array_on(outputStream* st, Array&lt;int&gt;* array) {
3334   if (array == NULL) { st-&gt;print_cr(&quot;NULL&quot;); return; }
3335   array-&gt;print_value_on(st); st-&gt;cr();
3336   if (Verbose || WizardMode) {
3337     for (int i = 0; i &lt; array-&gt;length(); i++) {
3338       st-&gt;print(&quot;%d : %d&quot;, i, array-&gt;at(i)); st-&gt;cr();
3339     }
3340   }
3341 }
3342 
3343 void InstanceKlass::print_on(outputStream* st) const {
3344   assert(is_klass(), &quot;must be klass&quot;);
3345   Klass::print_on(st);
3346 
3347   st-&gt;print(BULLET&quot;instance size:     %d&quot;, size_helper());                        st-&gt;cr();
3348   st-&gt;print(BULLET&quot;klass size:        %d&quot;, size());                               st-&gt;cr();
3349   st-&gt;print(BULLET&quot;access:            &quot;); access_flags().print_on(st);            st-&gt;cr();
3350   st-&gt;print(BULLET&quot;misc flags:        0x%x&quot;, _misc_flags);                        st-&gt;cr();
3351   st-&gt;print(BULLET&quot;state:             &quot;); st-&gt;print_cr(&quot;%s&quot;, state_names[_init_state]);
3352   st-&gt;print(BULLET&quot;name:              &quot;); name()-&gt;print_value_on(st);             st-&gt;cr();
3353   st-&gt;print(BULLET&quot;super:             &quot;); Metadata::print_value_on_maybe_null(st, super()); st-&gt;cr();
3354   st-&gt;print(BULLET&quot;sub:               &quot;);
3355   Klass* sub = subklass();
3356   int n;
3357   for (n = 0; sub != NULL; n++, sub = sub-&gt;next_sibling()) {
3358     if (n &lt; MaxSubklassPrintSize) {
3359       sub-&gt;print_value_on(st);
3360       st-&gt;print(&quot;   &quot;);
3361     }
3362   }
3363   if (n &gt;= MaxSubklassPrintSize) st-&gt;print(&quot;(&quot; INTX_FORMAT &quot; more klasses...)&quot;, n - MaxSubklassPrintSize);
3364   st-&gt;cr();
3365 
3366   if (is_interface()) {
3367     st-&gt;print_cr(BULLET&quot;nof implementors:  %d&quot;, nof_implementors());
3368     if (nof_implementors() == 1) {
3369       st-&gt;print_cr(BULLET&quot;implementor:    &quot;);
3370       st-&gt;print(&quot;   &quot;);
3371       implementor()-&gt;print_value_on(st);
3372       st-&gt;cr();
3373     }
3374   }
3375 
3376   st-&gt;print(BULLET&quot;arrays:            &quot;); Metadata::print_value_on_maybe_null(st, array_klasses()); st-&gt;cr();
3377   st-&gt;print(BULLET&quot;methods:           &quot;); print_array_on(st, methods());
3378   st-&gt;print(BULLET&quot;method ordering:   &quot;); print_array_on(st, method_ordering());
3379   st-&gt;print(BULLET&quot;default_methods:   &quot;); print_array_on(st, default_methods());
3380   if (default_vtable_indices() != NULL) {
3381     st-&gt;print(BULLET&quot;default vtable indices:   &quot;); print_array_on(st, default_vtable_indices());
3382   }
3383   st-&gt;print(BULLET&quot;local interfaces:  &quot;); print_array_on(st, local_interfaces());
3384   st-&gt;print(BULLET&quot;trans. interfaces: &quot;); print_array_on(st, transitive_interfaces());
3385   st-&gt;print(BULLET&quot;constants:         &quot;); constants()-&gt;print_value_on(st);         st-&gt;cr();
3386   if (class_loader_data() != NULL) {
3387     st-&gt;print(BULLET&quot;class loader data:  &quot;);
3388     class_loader_data()-&gt;print_value_on(st);
3389     st-&gt;cr();
3390   }
3391   st-&gt;print(BULLET&quot;unsafe anonymous host class:        &quot;); Metadata::print_value_on_maybe_null(st, unsafe_anonymous_host()); st-&gt;cr();
3392   if (source_file_name() != NULL) {
3393     st-&gt;print(BULLET&quot;source file:       &quot;);
3394     source_file_name()-&gt;print_value_on(st);
3395     st-&gt;cr();
3396   }
3397   if (source_debug_extension() != NULL) {
3398     st-&gt;print(BULLET&quot;source debug extension:       &quot;);
3399     st-&gt;print(&quot;%s&quot;, source_debug_extension());
3400     st-&gt;cr();
3401   }
3402   st-&gt;print(BULLET&quot;class annotations:       &quot;); class_annotations()-&gt;print_value_on(st); st-&gt;cr();
3403   st-&gt;print(BULLET&quot;class type annotations:  &quot;); class_type_annotations()-&gt;print_value_on(st); st-&gt;cr();
3404   st-&gt;print(BULLET&quot;field annotations:       &quot;); fields_annotations()-&gt;print_value_on(st); st-&gt;cr();
3405   st-&gt;print(BULLET&quot;field type annotations:  &quot;); fields_type_annotations()-&gt;print_value_on(st); st-&gt;cr();
3406   {
3407     bool have_pv = false;
3408     // previous versions are linked together through the InstanceKlass
3409     for (InstanceKlass* pv_node = previous_versions();
3410          pv_node != NULL;
3411          pv_node = pv_node-&gt;previous_versions()) {
3412       if (!have_pv)
3413         st-&gt;print(BULLET&quot;previous version:  &quot;);
3414       have_pv = true;
3415       pv_node-&gt;constants()-&gt;print_value_on(st);
3416     }
3417     if (have_pv) st-&gt;cr();
3418   }
3419 
3420   if (generic_signature() != NULL) {
3421     st-&gt;print(BULLET&quot;generic signature: &quot;);
3422     generic_signature()-&gt;print_value_on(st);
3423     st-&gt;cr();
3424   }
3425   st-&gt;print(BULLET&quot;inner classes:     &quot;); inner_classes()-&gt;print_value_on(st);     st-&gt;cr();
3426   st-&gt;print(BULLET&quot;nest members:     &quot;); nest_members()-&gt;print_value_on(st);     st-&gt;cr();
3427   if (record_components() != NULL) {
3428     st-&gt;print(BULLET&quot;record components:     &quot;); record_components()-&gt;print_value_on(st);     st-&gt;cr();
3429   }
3430   if (java_mirror() != NULL) {
3431     st-&gt;print(BULLET&quot;java mirror:       &quot;);
3432     java_mirror()-&gt;print_value_on(st);
3433     st-&gt;cr();
3434   } else {
3435     st-&gt;print_cr(BULLET&quot;java mirror:       NULL&quot;);
3436   }
3437   st-&gt;print(BULLET&quot;vtable length      %d  (start addr: &quot; INTPTR_FORMAT &quot;)&quot;, vtable_length(), p2i(start_of_vtable())); st-&gt;cr();
3438   if (vtable_length() &gt; 0 &amp;&amp; (Verbose || WizardMode))  print_vtable(start_of_vtable(), vtable_length(), st);
3439   st-&gt;print(BULLET&quot;itable length      %d (start addr: &quot; INTPTR_FORMAT &quot;)&quot;, itable_length(), p2i(start_of_itable())); st-&gt;cr();
3440   if (itable_length() &gt; 0 &amp;&amp; (Verbose || WizardMode))  print_vtable(NULL, start_of_itable(), itable_length(), st);
3441   st-&gt;print_cr(BULLET&quot;---- static fields (%d words):&quot;, static_field_size());
3442   FieldPrinter print_static_field(st);
3443   ((InstanceKlass*)this)-&gt;do_local_static_fields(&amp;print_static_field);
3444   st-&gt;print_cr(BULLET&quot;---- non-static fields (%d words):&quot;, nonstatic_field_size());
3445   FieldPrinter print_nonstatic_field(st);
3446   InstanceKlass* ik = const_cast&lt;InstanceKlass*&gt;(this);
3447   ik-&gt;do_nonstatic_fields(&amp;print_nonstatic_field);
3448 
3449   st-&gt;print(BULLET&quot;non-static oop maps: &quot;);
3450   OopMapBlock* map     = start_of_nonstatic_oop_maps();
3451   OopMapBlock* end_map = map + nonstatic_oop_map_count();
3452   while (map &lt; end_map) {
3453     st-&gt;print(&quot;%d-%d &quot;, map-&gt;offset(), map-&gt;offset() + heapOopSize*(map-&gt;count() - 1));
3454     map++;
3455   }
3456   st-&gt;cr();
3457 }
3458 
3459 #endif //PRODUCT
3460 
3461 void InstanceKlass::print_value_on(outputStream* st) const {
3462   assert(is_klass(), &quot;must be klass&quot;);
3463   if (Verbose || WizardMode)  access_flags().print_on(st);
3464   name()-&gt;print_value_on(st);
3465 }
3466 
3467 #ifndef PRODUCT
3468 
3469 void FieldPrinter::do_field(fieldDescriptor* fd) {
3470   _st-&gt;print(BULLET);
3471    if (_obj == NULL) {
3472      fd-&gt;print_on(_st);
3473      _st-&gt;cr();
3474    } else {
3475      fd-&gt;print_on_for(_st, _obj);
3476      _st-&gt;cr();
3477    }
3478 }
3479 
3480 
3481 void InstanceKlass::oop_print_on(oop obj, outputStream* st) {
3482   Klass::oop_print_on(obj, st);
3483 
3484   if (this == SystemDictionary::String_klass()) {
3485     typeArrayOop value  = java_lang_String::value(obj);
3486     juint        length = java_lang_String::length(obj);
3487     if (value != NULL &amp;&amp;
3488         value-&gt;is_typeArray() &amp;&amp;
3489         length &lt;= (juint) value-&gt;length()) {
3490       st-&gt;print(BULLET&quot;string: &quot;);
3491       java_lang_String::print(obj, st);
3492       st-&gt;cr();
3493       if (!WizardMode)  return;  // that is enough
3494     }
3495   }
3496 
3497   st-&gt;print_cr(BULLET&quot;---- fields (total size %d words):&quot;, oop_size(obj));
3498   FieldPrinter print_field(st, obj);
3499   do_nonstatic_fields(&amp;print_field);
3500 
3501   if (this == SystemDictionary::Class_klass()) {
3502     st-&gt;print(BULLET&quot;signature: &quot;);
3503     java_lang_Class::print_signature(obj, st);
3504     st-&gt;cr();
3505     Klass* mirrored_klass = java_lang_Class::as_Klass(obj);
3506     st-&gt;print(BULLET&quot;fake entry for mirror: &quot;);
3507     Metadata::print_value_on_maybe_null(st, mirrored_klass);
3508     st-&gt;cr();
3509     Klass* array_klass = java_lang_Class::array_klass_acquire(obj);
3510     st-&gt;print(BULLET&quot;fake entry for array: &quot;);
3511     Metadata::print_value_on_maybe_null(st, array_klass);
3512     st-&gt;cr();
3513     st-&gt;print_cr(BULLET&quot;fake entry for oop_size: %d&quot;, java_lang_Class::oop_size(obj));
3514     st-&gt;print_cr(BULLET&quot;fake entry for static_oop_field_count: %d&quot;, java_lang_Class::static_oop_field_count(obj));
3515     Klass* real_klass = java_lang_Class::as_Klass(obj);
3516     if (real_klass != NULL &amp;&amp; real_klass-&gt;is_instance_klass()) {
3517       InstanceKlass::cast(real_klass)-&gt;do_local_static_fields(&amp;print_field);
3518     }
3519   } else if (this == SystemDictionary::MethodType_klass()) {
3520     st-&gt;print(BULLET&quot;signature: &quot;);
3521     java_lang_invoke_MethodType::print_signature(obj, st);
3522     st-&gt;cr();
3523   }
3524 }
3525 
3526 bool InstanceKlass::verify_itable_index(int i) {
3527   int method_count = klassItable::method_count_for_interface(this);
3528   assert(i &gt;= 0 &amp;&amp; i &lt; method_count, &quot;index out of bounds&quot;);
3529   return true;
3530 }
3531 
3532 #endif //PRODUCT
3533 
3534 void InstanceKlass::oop_print_value_on(oop obj, outputStream* st) {
3535   st-&gt;print(&quot;a &quot;);
3536   name()-&gt;print_value_on(st);
3537   obj-&gt;print_address_on(st);
3538   if (this == SystemDictionary::String_klass()
3539       &amp;&amp; java_lang_String::value(obj) != NULL) {
3540     ResourceMark rm;
3541     int len = java_lang_String::length(obj);
3542     int plen = (len &lt; 24 ? len : 12);
3543     char* str = java_lang_String::as_utf8_string(obj, 0, plen);
3544     st-&gt;print(&quot; = \&quot;%s\&quot;&quot;, str);
3545     if (len &gt; plen)
3546       st-&gt;print(&quot;...[%d]&quot;, len);
3547   } else if (this == SystemDictionary::Class_klass()) {
3548     Klass* k = java_lang_Class::as_Klass(obj);
3549     st-&gt;print(&quot; = &quot;);
3550     if (k != NULL) {
3551       k-&gt;print_value_on(st);
3552     } else {
3553       const char* tname = type2name(java_lang_Class::primitive_type(obj));
3554       st-&gt;print(&quot;%s&quot;, tname ? tname : &quot;type?&quot;);
3555     }
3556   } else if (this == SystemDictionary::MethodType_klass()) {
3557     st-&gt;print(&quot; = &quot;);
3558     java_lang_invoke_MethodType::print_signature(obj, st);
3559   } else if (java_lang_boxing_object::is_instance(obj)) {
3560     st-&gt;print(&quot; = &quot;);
3561     java_lang_boxing_object::print(obj, st);
3562   } else if (this == SystemDictionary::LambdaForm_klass()) {
3563     oop vmentry = java_lang_invoke_LambdaForm::vmentry(obj);
3564     if (vmentry != NULL) {
3565       st-&gt;print(&quot; =&gt; &quot;);
3566       vmentry-&gt;print_value_on(st);
3567     }
3568   } else if (this == SystemDictionary::MemberName_klass()) {
3569     Metadata* vmtarget = java_lang_invoke_MemberName::vmtarget(obj);
3570     if (vmtarget != NULL) {
3571       st-&gt;print(&quot; = &quot;);
3572       vmtarget-&gt;print_value_on(st);
3573     } else {
3574       java_lang_invoke_MemberName::clazz(obj)-&gt;print_value_on(st);
3575       st-&gt;print(&quot;.&quot;);
3576       java_lang_invoke_MemberName::name(obj)-&gt;print_value_on(st);
3577     }
3578   }
3579 }
3580 
3581 const char* InstanceKlass::internal_name() const {
3582   return external_name();
3583 }
3584 
3585 void InstanceKlass::print_class_load_logging(ClassLoaderData* loader_data,
3586                                              const char* module_name,
3587                                              const ClassFileStream* cfs) const {
3588   if (!log_is_enabled(Info, class, load)) {
3589     return;
3590   }
3591 
3592   ResourceMark rm;
3593   LogMessage(class, load) msg;
3594   stringStream info_stream;
3595 
3596   // Name and class hierarchy info
3597   info_stream.print(&quot;%s&quot;, external_name());
3598 
3599   // Source
3600   if (cfs != NULL) {
3601     if (cfs-&gt;source() != NULL) {
3602       if (module_name != NULL) {
3603         // When the boot loader created the stream, it didn&#39;t know the module name
3604         // yet. Let&#39;s format it now.
3605         if (cfs-&gt;from_boot_loader_modules_image()) {
3606           info_stream.print(&quot; source: jrt:/%s&quot;, module_name);
3607         } else {
3608           info_stream.print(&quot; source: %s&quot;, cfs-&gt;source());
3609         }
3610       } else {
3611         info_stream.print(&quot; source: %s&quot;, cfs-&gt;source());
3612       }
3613     } else if (loader_data == ClassLoaderData::the_null_class_loader_data()) {
3614       Thread* THREAD = Thread::current();
3615       Klass* caller =
3616             THREAD-&gt;is_Java_thread()
3617                 ? ((JavaThread*)THREAD)-&gt;security_get_caller_class(1)
3618                 : NULL;
3619       // caller can be NULL, for example, during a JVMTI VM_Init hook
3620       if (caller != NULL) {
3621         info_stream.print(&quot; source: instance of %s&quot;, caller-&gt;external_name());
3622       } else {
3623         // source is unknown
3624       }
3625     } else {
3626       oop class_loader = loader_data-&gt;class_loader();
3627       info_stream.print(&quot; source: %s&quot;, class_loader-&gt;klass()-&gt;external_name());
3628     }
3629   } else {
3630     assert(this-&gt;is_shared(), &quot;must be&quot;);
3631     if (MetaspaceShared::is_shared_dynamic((void*)this)) {
3632       info_stream.print(&quot; source: shared objects file (top)&quot;);
3633     } else {
3634       info_stream.print(&quot; source: shared objects file&quot;);
3635     }
3636   }
3637 
3638   msg.info(&quot;%s&quot;, info_stream.as_string());
3639 
3640   if (log_is_enabled(Debug, class, load)) {
3641     stringStream debug_stream;
3642 
3643     // Class hierarchy info
3644     debug_stream.print(&quot; klass: &quot; INTPTR_FORMAT &quot; super: &quot; INTPTR_FORMAT,
3645                        p2i(this),  p2i(superklass()));
3646 
3647     // Interfaces
3648     if (local_interfaces() != NULL &amp;&amp; local_interfaces()-&gt;length() &gt; 0) {
3649       debug_stream.print(&quot; interfaces:&quot;);
3650       int length = local_interfaces()-&gt;length();
3651       for (int i = 0; i &lt; length; i++) {
3652         debug_stream.print(&quot; &quot; INTPTR_FORMAT,
3653                            p2i(InstanceKlass::cast(local_interfaces()-&gt;at(i))));
3654       }
3655     }
3656 
3657     // Class loader
3658     debug_stream.print(&quot; loader: [&quot;);
3659     loader_data-&gt;print_value_on(&amp;debug_stream);
3660     debug_stream.print(&quot;]&quot;);
3661 
3662     // Classfile checksum
3663     if (cfs) {
3664       debug_stream.print(&quot; bytes: %d checksum: %08x&quot;,
3665                          cfs-&gt;length(),
3666                          ClassLoader::crc32(0, (const char*)cfs-&gt;buffer(),
3667                          cfs-&gt;length()));
3668     }
3669 
3670     msg.debug(&quot;%s&quot;, debug_stream.as_string());
3671   }
3672 }
3673 
3674 // Verification
3675 
3676 class VerifyFieldClosure: public BasicOopIterateClosure {
3677  protected:
3678   template &lt;class T&gt; void do_oop_work(T* p) {
3679     oop obj = RawAccess&lt;&gt;::oop_load(p);
3680     if (!oopDesc::is_oop_or_null(obj)) {
3681       tty-&gt;print_cr(&quot;Failed: &quot; PTR_FORMAT &quot; -&gt; &quot; PTR_FORMAT, p2i(p), p2i(obj));
3682       Universe::print_on(tty);
3683       guarantee(false, &quot;boom&quot;);
3684     }
3685   }
3686  public:
3687   virtual void do_oop(oop* p)       { VerifyFieldClosure::do_oop_work(p); }
3688   virtual void do_oop(narrowOop* p) { VerifyFieldClosure::do_oop_work(p); }
3689 };
3690 
3691 void InstanceKlass::verify_on(outputStream* st) {
3692 #ifndef PRODUCT
3693   // Avoid redundant verifies, this really should be in product.
3694   if (_verify_count == Universe::verify_count()) return;
3695   _verify_count = Universe::verify_count();
3696 #endif
3697 
3698   // Verify Klass
3699   Klass::verify_on(st);
3700 
3701   // Verify that klass is present in ClassLoaderData
3702   guarantee(class_loader_data()-&gt;contains_klass(this),
3703             &quot;this class isn&#39;t found in class loader data&quot;);
3704 
3705   // Verify vtables
3706   if (is_linked()) {
3707     // $$$ This used to be done only for m/s collections.  Doing it
3708     // always seemed a valid generalization.  (DLD -- 6/00)
3709     vtable().verify(st);
3710   }
3711 
3712   // Verify first subklass
3713   if (subklass() != NULL) {
3714     guarantee(subklass()-&gt;is_klass(), &quot;should be klass&quot;);
3715   }
3716 
3717   // Verify siblings
3718   Klass* super = this-&gt;super();
3719   Klass* sib = next_sibling();
3720   if (sib != NULL) {
3721     if (sib == this) {
3722       fatal(&quot;subclass points to itself &quot; PTR_FORMAT, p2i(sib));
3723     }
3724 
3725     guarantee(sib-&gt;is_klass(), &quot;should be klass&quot;);
3726     guarantee(sib-&gt;super() == super, &quot;siblings should have same superklass&quot;);
3727   }
3728 
3729   // Verify local interfaces
3730   if (local_interfaces()) {
3731     Array&lt;InstanceKlass*&gt;* local_interfaces = this-&gt;local_interfaces();
3732     for (int j = 0; j &lt; local_interfaces-&gt;length(); j++) {
3733       InstanceKlass* e = local_interfaces-&gt;at(j);
3734       guarantee(e-&gt;is_klass() &amp;&amp; e-&gt;is_interface(), &quot;invalid local interface&quot;);
3735     }
3736   }
3737 
3738   // Verify transitive interfaces
3739   if (transitive_interfaces() != NULL) {
3740     Array&lt;InstanceKlass*&gt;* transitive_interfaces = this-&gt;transitive_interfaces();
3741     for (int j = 0; j &lt; transitive_interfaces-&gt;length(); j++) {
3742       InstanceKlass* e = transitive_interfaces-&gt;at(j);
3743       guarantee(e-&gt;is_klass() &amp;&amp; e-&gt;is_interface(), &quot;invalid transitive interface&quot;);
3744     }
3745   }
3746 
3747   // Verify methods
3748   if (methods() != NULL) {
3749     Array&lt;Method*&gt;* methods = this-&gt;methods();
3750     for (int j = 0; j &lt; methods-&gt;length(); j++) {
3751       guarantee(methods-&gt;at(j)-&gt;is_method(), &quot;non-method in methods array&quot;);
3752     }
3753     for (int j = 0; j &lt; methods-&gt;length() - 1; j++) {
3754       Method* m1 = methods-&gt;at(j);
3755       Method* m2 = methods-&gt;at(j + 1);
3756       guarantee(m1-&gt;name()-&gt;fast_compare(m2-&gt;name()) &lt;= 0, &quot;methods not sorted correctly&quot;);
3757     }
3758   }
3759 
3760   // Verify method ordering
3761   if (method_ordering() != NULL) {
3762     Array&lt;int&gt;* method_ordering = this-&gt;method_ordering();
3763     int length = method_ordering-&gt;length();
3764     if (JvmtiExport::can_maintain_original_method_order() ||
3765         ((UseSharedSpaces || Arguments::is_dumping_archive()) &amp;&amp; length != 0)) {
3766       guarantee(length == methods()-&gt;length(), &quot;invalid method ordering length&quot;);
3767       jlong sum = 0;
3768       for (int j = 0; j &lt; length; j++) {
3769         int original_index = method_ordering-&gt;at(j);
3770         guarantee(original_index &gt;= 0, &quot;invalid method ordering index&quot;);
3771         guarantee(original_index &lt; length, &quot;invalid method ordering index&quot;);
3772         sum += original_index;
3773       }
3774       // Verify sum of indices 0,1,...,length-1
3775       guarantee(sum == ((jlong)length*(length-1))/2, &quot;invalid method ordering sum&quot;);
3776     } else {
3777       guarantee(length == 0, &quot;invalid method ordering length&quot;);
3778     }
3779   }
3780 
3781   // Verify default methods
3782   if (default_methods() != NULL) {
3783     Array&lt;Method*&gt;* methods = this-&gt;default_methods();
3784     for (int j = 0; j &lt; methods-&gt;length(); j++) {
3785       guarantee(methods-&gt;at(j)-&gt;is_method(), &quot;non-method in methods array&quot;);
3786     }
3787     for (int j = 0; j &lt; methods-&gt;length() - 1; j++) {
3788       Method* m1 = methods-&gt;at(j);
3789       Method* m2 = methods-&gt;at(j + 1);
3790       guarantee(m1-&gt;name()-&gt;fast_compare(m2-&gt;name()) &lt;= 0, &quot;methods not sorted correctly&quot;);
3791     }
3792   }
3793 
3794   // Verify JNI static field identifiers
3795   if (jni_ids() != NULL) {
3796     jni_ids()-&gt;verify(this);
3797   }
3798 
3799   // Verify other fields
3800   if (array_klasses() != NULL) {
3801     guarantee(array_klasses()-&gt;is_klass(), &quot;should be klass&quot;);
3802   }
3803   if (constants() != NULL) {
3804     guarantee(constants()-&gt;is_constantPool(), &quot;should be constant pool&quot;);
3805   }
3806   const Klass* anonymous_host = unsafe_anonymous_host();
3807   if (anonymous_host != NULL) {
3808     guarantee(anonymous_host-&gt;is_klass(), &quot;should be klass&quot;);
3809   }
3810 }
3811 
3812 void InstanceKlass::oop_verify_on(oop obj, outputStream* st) {
3813   Klass::oop_verify_on(obj, st);
3814   VerifyFieldClosure blk;
3815   obj-&gt;oop_iterate(&amp;blk);
3816 }
3817 
3818 
3819 // JNIid class for jfieldIDs only
3820 // Note to reviewers:
3821 // These JNI functions are just moved over to column 1 and not changed
3822 // in the compressed oops workspace.
3823 JNIid::JNIid(Klass* holder, int offset, JNIid* next) {
3824   _holder = holder;
3825   _offset = offset;
3826   _next = next;
3827   debug_only(_is_static_field_id = false;)
3828 }
3829 
3830 
3831 JNIid* JNIid::find(int offset) {
3832   JNIid* current = this;
3833   while (current != NULL) {
3834     if (current-&gt;offset() == offset) return current;
3835     current = current-&gt;next();
3836   }
3837   return NULL;
3838 }
3839 
3840 void JNIid::deallocate(JNIid* current) {
3841   while (current != NULL) {
3842     JNIid* next = current-&gt;next();
3843     delete current;
3844     current = next;
3845   }
3846 }
3847 
3848 
3849 void JNIid::verify(Klass* holder) {
3850   int first_field_offset  = InstanceMirrorKlass::offset_of_static_fields();
3851   int end_field_offset;
3852   end_field_offset = first_field_offset + (InstanceKlass::cast(holder)-&gt;static_field_size() * wordSize);
3853 
3854   JNIid* current = this;
3855   while (current != NULL) {
3856     guarantee(current-&gt;holder() == holder, &quot;Invalid klass in JNIid&quot;);
3857 #ifdef ASSERT
3858     int o = current-&gt;offset();
3859     if (current-&gt;is_static_field_id()) {
3860       guarantee(o &gt;= first_field_offset  &amp;&amp; o &lt; end_field_offset,  &quot;Invalid static field offset in JNIid&quot;);
3861     }
3862 #endif
3863     current = current-&gt;next();
3864   }
3865 }
3866 
3867 void InstanceKlass::set_init_state(ClassState state) {
3868 #ifdef ASSERT
3869   bool good_state = is_shared() ? (_init_state &lt;= state)
3870                                                : (_init_state &lt; state);
3871   assert(good_state || state == allocated, &quot;illegal state transition&quot;);
3872 #endif
3873   assert(_init_thread == NULL, &quot;should be cleared before state change&quot;);
3874   _init_state = (u1)state;
3875 }
3876 
3877 #if INCLUDE_JVMTI
3878 
3879 // RedefineClasses() support for previous versions
3880 
3881 // Globally, there is at least one previous version of a class to walk
3882 // during class unloading, which is saved because old methods in the class
3883 // are still running.   Otherwise the previous version list is cleaned up.
3884 bool InstanceKlass::_has_previous_versions = false;
3885 
3886 // Returns true if there are previous versions of a class for class
3887 // unloading only. Also resets the flag to false. purge_previous_version
3888 // will set the flag to true if there are any left, i.e., if there&#39;s any
3889 // work to do for next time. This is to avoid the expensive code cache
3890 // walk in CLDG::clean_deallocate_lists().
3891 bool InstanceKlass::has_previous_versions_and_reset() {
3892   bool ret = _has_previous_versions;
3893   log_trace(redefine, class, iklass, purge)(&quot;Class unloading: has_previous_versions = %s&quot;,
3894      ret ? &quot;true&quot; : &quot;false&quot;);
3895   _has_previous_versions = false;
3896   return ret;
3897 }
3898 
3899 // Purge previous versions before adding new previous versions of the class and
3900 // during class unloading.
3901 void InstanceKlass::purge_previous_version_list() {
3902   assert(SafepointSynchronize::is_at_safepoint(), &quot;only called at safepoint&quot;);
3903   assert(has_been_redefined(), &quot;Should only be called for main class&quot;);
3904 
3905   // Quick exit.
3906   if (previous_versions() == NULL) {
3907     return;
3908   }
3909 
3910   // This klass has previous versions so see what we can cleanup
3911   // while it is safe to do so.
3912 
3913   int deleted_count = 0;    // leave debugging breadcrumbs
3914   int live_count = 0;
3915   ClassLoaderData* loader_data = class_loader_data();
3916   assert(loader_data != NULL, &quot;should never be null&quot;);
3917 
3918   ResourceMark rm;
3919   log_trace(redefine, class, iklass, purge)(&quot;%s: previous versions&quot;, external_name());
3920 
3921   // previous versions are linked together through the InstanceKlass
3922   InstanceKlass* pv_node = previous_versions();
3923   InstanceKlass* last = this;
3924   int version = 0;
3925 
3926   // check the previous versions list
3927   for (; pv_node != NULL; ) {
3928 
3929     ConstantPool* pvcp = pv_node-&gt;constants();
3930     assert(pvcp != NULL, &quot;cp ref was unexpectedly cleared&quot;);
3931 
3932     if (!pvcp-&gt;on_stack()) {
3933       // If the constant pool isn&#39;t on stack, none of the methods
3934       // are executing.  Unlink this previous_version.
3935       // The previous version InstanceKlass is on the ClassLoaderData deallocate list
3936       // so will be deallocated during the next phase of class unloading.
3937       log_trace(redefine, class, iklass, purge)
3938         (&quot;previous version &quot; INTPTR_FORMAT &quot; is dead.&quot;, p2i(pv_node));
3939       // For debugging purposes.
3940       pv_node-&gt;set_is_scratch_class();
3941       // Unlink from previous version list.
3942       assert(pv_node-&gt;class_loader_data() == loader_data, &quot;wrong loader_data&quot;);
3943       InstanceKlass* next = pv_node-&gt;previous_versions();
3944       pv_node-&gt;link_previous_versions(NULL);   // point next to NULL
3945       last-&gt;link_previous_versions(next);
3946       // Add to the deallocate list after unlinking
3947       loader_data-&gt;add_to_deallocate_list(pv_node);
3948       pv_node = next;
3949       deleted_count++;
3950       version++;
3951       continue;
3952     } else {
3953       log_trace(redefine, class, iklass, purge)(&quot;previous version &quot; INTPTR_FORMAT &quot; is alive&quot;, p2i(pv_node));
3954       assert(pvcp-&gt;pool_holder() != NULL, &quot;Constant pool with no holder&quot;);
3955       guarantee (!loader_data-&gt;is_unloading(), &quot;unloaded classes can&#39;t be on the stack&quot;);
3956       live_count++;
3957       // found a previous version for next time we do class unloading
3958       _has_previous_versions = true;
3959     }
3960 
3961     // At least one method is live in this previous version.
3962     // Reset dead EMCP methods not to get breakpoints.
3963     // All methods are deallocated when all of the methods for this class are no
3964     // longer running.
3965     Array&lt;Method*&gt;* method_refs = pv_node-&gt;methods();
3966     if (method_refs != NULL) {
3967       log_trace(redefine, class, iklass, purge)(&quot;previous methods length=%d&quot;, method_refs-&gt;length());
3968       for (int j = 0; j &lt; method_refs-&gt;length(); j++) {
3969         Method* method = method_refs-&gt;at(j);
3970 
3971         if (!method-&gt;on_stack()) {
3972           // no breakpoints for non-running methods
3973           if (method-&gt;is_running_emcp()) {
3974             method-&gt;set_running_emcp(false);
3975           }
3976         } else {
3977           assert (method-&gt;is_obsolete() || method-&gt;is_running_emcp(),
3978                   &quot;emcp method cannot run after emcp bit is cleared&quot;);
3979           log_trace(redefine, class, iklass, purge)
3980             (&quot;purge: %s(%s): prev method @%d in version @%d is alive&quot;,
3981              method-&gt;name()-&gt;as_C_string(), method-&gt;signature()-&gt;as_C_string(), j, version);
3982         }
3983       }
3984     }
3985     // next previous version
3986     last = pv_node;
3987     pv_node = pv_node-&gt;previous_versions();
3988     version++;
3989   }
3990   log_trace(redefine, class, iklass, purge)
3991     (&quot;previous version stats: live=%d, deleted=%d&quot;, live_count, deleted_count);
3992 }
3993 
3994 void InstanceKlass::mark_newly_obsolete_methods(Array&lt;Method*&gt;* old_methods,
3995                                                 int emcp_method_count) {
3996   int obsolete_method_count = old_methods-&gt;length() - emcp_method_count;
3997 
3998   if (emcp_method_count != 0 &amp;&amp; obsolete_method_count != 0 &amp;&amp;
3999       _previous_versions != NULL) {
4000     // We have a mix of obsolete and EMCP methods so we have to
4001     // clear out any matching EMCP method entries the hard way.
4002     int local_count = 0;
4003     for (int i = 0; i &lt; old_methods-&gt;length(); i++) {
4004       Method* old_method = old_methods-&gt;at(i);
4005       if (old_method-&gt;is_obsolete()) {
4006         // only obsolete methods are interesting
4007         Symbol* m_name = old_method-&gt;name();
4008         Symbol* m_signature = old_method-&gt;signature();
4009 
4010         // previous versions are linked together through the InstanceKlass
4011         int j = 0;
4012         for (InstanceKlass* prev_version = _previous_versions;
4013              prev_version != NULL;
4014              prev_version = prev_version-&gt;previous_versions(), j++) {
4015 
4016           Array&lt;Method*&gt;* method_refs = prev_version-&gt;methods();
4017           for (int k = 0; k &lt; method_refs-&gt;length(); k++) {
4018             Method* method = method_refs-&gt;at(k);
4019 
4020             if (!method-&gt;is_obsolete() &amp;&amp;
4021                 method-&gt;name() == m_name &amp;&amp;
4022                 method-&gt;signature() == m_signature) {
4023               // The current RedefineClasses() call has made all EMCP
4024               // versions of this method obsolete so mark it as obsolete
4025               log_trace(redefine, class, iklass, add)
4026                 (&quot;%s(%s): flush obsolete method @%d in version @%d&quot;,
4027                  m_name-&gt;as_C_string(), m_signature-&gt;as_C_string(), k, j);
4028 
4029               method-&gt;set_is_obsolete();
4030               break;
4031             }
4032           }
4033 
4034           // The previous loop may not find a matching EMCP method, but
4035           // that doesn&#39;t mean that we can optimize and not go any
4036           // further back in the PreviousVersion generations. The EMCP
4037           // method for this generation could have already been made obsolete,
4038           // but there still may be an older EMCP method that has not
4039           // been made obsolete.
4040         }
4041 
4042         if (++local_count &gt;= obsolete_method_count) {
4043           // no more obsolete methods so bail out now
4044           break;
4045         }
4046       }
4047     }
4048   }
4049 }
4050 
4051 // Save the scratch_class as the previous version if any of the methods are running.
4052 // The previous_versions are used to set breakpoints in EMCP methods and they are
4053 // also used to clean MethodData links to redefined methods that are no longer running.
4054 void InstanceKlass::add_previous_version(InstanceKlass* scratch_class,
4055                                          int emcp_method_count) {
4056   assert(Thread::current()-&gt;is_VM_thread(),
4057          &quot;only VMThread can add previous versions&quot;);
4058 
4059   ResourceMark rm;
4060   log_trace(redefine, class, iklass, add)
4061     (&quot;adding previous version ref for %s, EMCP_cnt=%d&quot;, scratch_class-&gt;external_name(), emcp_method_count);
4062 
4063   // Clean out old previous versions for this class
4064   purge_previous_version_list();
4065 
4066   // Mark newly obsolete methods in remaining previous versions.  An EMCP method from
4067   // a previous redefinition may be made obsolete by this redefinition.
4068   Array&lt;Method*&gt;* old_methods = scratch_class-&gt;methods();
4069   mark_newly_obsolete_methods(old_methods, emcp_method_count);
4070 
4071   // If the constant pool for this previous version of the class
4072   // is not marked as being on the stack, then none of the methods
4073   // in this previous version of the class are on the stack so
4074   // we don&#39;t need to add this as a previous version.
4075   ConstantPool* cp_ref = scratch_class-&gt;constants();
4076   if (!cp_ref-&gt;on_stack()) {
4077     log_trace(redefine, class, iklass, add)(&quot;scratch class not added; no methods are running&quot;);
4078     // For debugging purposes.
4079     scratch_class-&gt;set_is_scratch_class();
4080     scratch_class-&gt;class_loader_data()-&gt;add_to_deallocate_list(scratch_class);
4081     return;
4082   }
4083 
4084   if (emcp_method_count != 0) {
4085     // At least one method is still running, check for EMCP methods
4086     for (int i = 0; i &lt; old_methods-&gt;length(); i++) {
4087       Method* old_method = old_methods-&gt;at(i);
4088       if (!old_method-&gt;is_obsolete() &amp;&amp; old_method-&gt;on_stack()) {
4089         // if EMCP method (not obsolete) is on the stack, mark as EMCP so that
4090         // we can add breakpoints for it.
4091 
4092         // We set the method-&gt;on_stack bit during safepoints for class redefinition
4093         // and use this bit to set the is_running_emcp bit.
4094         // After the safepoint, the on_stack bit is cleared and the running emcp
4095         // method may exit.   If so, we would set a breakpoint in a method that
4096         // is never reached, but this won&#39;t be noticeable to the programmer.
4097         old_method-&gt;set_running_emcp(true);
4098         log_trace(redefine, class, iklass, add)
4099           (&quot;EMCP method %s is on_stack &quot; INTPTR_FORMAT, old_method-&gt;name_and_sig_as_C_string(), p2i(old_method));
4100       } else if (!old_method-&gt;is_obsolete()) {
4101         log_trace(redefine, class, iklass, add)
4102           (&quot;EMCP method %s is NOT on_stack &quot; INTPTR_FORMAT, old_method-&gt;name_and_sig_as_C_string(), p2i(old_method));
4103       }
4104     }
4105   }
4106 
4107   // Add previous version if any methods are still running.
4108   // Set has_previous_version flag for processing during class unloading.
4109   _has_previous_versions = true;
4110   log_trace(redefine, class, iklass, add) (&quot;scratch class added; one of its methods is on_stack.&quot;);
4111   assert(scratch_class-&gt;previous_versions() == NULL, &quot;shouldn&#39;t have a previous version&quot;);
4112   scratch_class-&gt;link_previous_versions(previous_versions());
4113   link_previous_versions(scratch_class);
4114 } // end add_previous_version()
4115 
4116 #endif // INCLUDE_JVMTI
4117 
4118 Method* InstanceKlass::method_with_idnum(int idnum) {
4119   Method* m = NULL;
4120   if (idnum &lt; methods()-&gt;length()) {
4121     m = methods()-&gt;at(idnum);
4122   }
4123   if (m == NULL || m-&gt;method_idnum() != idnum) {
4124     for (int index = 0; index &lt; methods()-&gt;length(); ++index) {
4125       m = methods()-&gt;at(index);
4126       if (m-&gt;method_idnum() == idnum) {
4127         return m;
4128       }
4129     }
4130     // None found, return null for the caller to handle.
4131     return NULL;
4132   }
4133   return m;
4134 }
4135 
4136 
4137 Method* InstanceKlass::method_with_orig_idnum(int idnum) {
4138   if (idnum &gt;= methods()-&gt;length()) {
4139     return NULL;
4140   }
4141   Method* m = methods()-&gt;at(idnum);
4142   if (m != NULL &amp;&amp; m-&gt;orig_method_idnum() == idnum) {
4143     return m;
4144   }
4145   // Obsolete method idnum does not match the original idnum
4146   for (int index = 0; index &lt; methods()-&gt;length(); ++index) {
4147     m = methods()-&gt;at(index);
4148     if (m-&gt;orig_method_idnum() == idnum) {
4149       return m;
4150     }
4151   }
4152   // None found, return null for the caller to handle.
4153   return NULL;
4154 }
4155 
4156 
4157 Method* InstanceKlass::method_with_orig_idnum(int idnum, int version) {
4158   InstanceKlass* holder = get_klass_version(version);
4159   if (holder == NULL) {
4160     return NULL; // The version of klass is gone, no method is found
4161   }
4162   Method* method = holder-&gt;method_with_orig_idnum(idnum);
4163   return method;
4164 }
4165 
4166 #if INCLUDE_JVMTI
4167 JvmtiCachedClassFileData* InstanceKlass::get_cached_class_file() {
4168   return _cached_class_file;
4169 }
4170 
4171 jint InstanceKlass::get_cached_class_file_len() {
4172   return VM_RedefineClasses::get_cached_class_file_len(_cached_class_file);
4173 }
4174 
4175 unsigned char * InstanceKlass::get_cached_class_file_bytes() {
4176   return VM_RedefineClasses::get_cached_class_file_bytes(_cached_class_file);
4177 }
4178 #endif
4179 
4180 #define THROW_DVT_ERROR(s) \
4181   Exceptions::fthrow(THREAD_AND_LOCATION, vmSymbols::java_lang_IncompatibleClassChangeError(), \
4182       &quot;ValueCapableClass class &#39;%s&#39; %s&quot;, external_name(),(s)); \
4183       return
    </pre>
  </body>
</html>