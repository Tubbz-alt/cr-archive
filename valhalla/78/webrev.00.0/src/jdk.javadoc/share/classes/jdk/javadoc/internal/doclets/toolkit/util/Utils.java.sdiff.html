<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/jdk.javadoc/share/classes/jdk/javadoc/internal/doclets/toolkit/util/Utils.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="../../../../../../../../../jdk.internal.vm.compiler/share/classes/org.graalvm.compiler.hotspot.test/src/org/graalvm/compiler/hotspot/test/CheckGraalIntrinsics.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="../../../../../../../../../jdk.jdi/share/classes/com/sun/tools/jdi/VirtualMachineImpl.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/jdk.javadoc/share/classes/jdk/javadoc/internal/doclets/toolkit/util/Utils.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  90 import javax.tools.JavaFileManager;
  91 import javax.tools.JavaFileManager.Location;
  92 import javax.tools.StandardLocation;
  93 
  94 import com.sun.source.doctree.DocCommentTree;
  95 import com.sun.source.doctree.DocTree;
  96 import com.sun.source.doctree.DocTree.Kind;
  97 import com.sun.source.doctree.EndElementTree;
  98 import com.sun.source.doctree.ParamTree;
  99 import com.sun.source.doctree.StartElementTree;
 100 import com.sun.source.doctree.TextTree;
 101 import com.sun.source.doctree.UnknownBlockTagTree;
 102 import com.sun.source.tree.CompilationUnitTree;
 103 import com.sun.source.tree.LineMap;
 104 import com.sun.source.util.DocSourcePositions;
 105 import com.sun.source.util.DocTrees;
 106 import com.sun.source.util.TreePath;
 107 import com.sun.tools.javac.model.JavacTypes;
 108 import jdk.javadoc.internal.doclets.toolkit.BaseConfiguration;
 109 import jdk.javadoc.internal.doclets.toolkit.BaseOptions;
<span class="line-modified"> 110 import jdk.javadoc.internal.doclets.toolkit.CommentUtils.DocCommentDuo;</span>
 111 import jdk.javadoc.internal.doclets.toolkit.Resources;
 112 import jdk.javadoc.internal.doclets.toolkit.WorkArounds;
 113 import jdk.javadoc.internal.doclets.toolkit.taglets.BaseTaglet;
 114 import jdk.javadoc.internal.doclets.toolkit.taglets.Taglet;
 115 import jdk.javadoc.internal.tool.DocEnvImpl;
 116 
 117 import static javax.lang.model.element.ElementKind.*;
 118 import static javax.lang.model.element.Modifier.*;
 119 import static javax.lang.model.type.TypeKind.*;
 120 
 121 import static com.sun.source.doctree.DocTree.Kind.*;
 122 import static jdk.javadoc.internal.doclets.toolkit.builders.ConstantsSummaryBuilder.MAX_CONSTANT_VALUE_INDEX_LENGTH;
 123 
 124 /**
 125  * Utilities Class for Doclets.
 126  *
 127  *  &lt;p&gt;&lt;b&gt;This is NOT part of any supported API.
 128  *  If you write code that depends on this, you do so at your own risk.
 129  *  This code and its internal interfaces are subject to change or
 130  *  deletion without notice.&lt;/b&gt;
</pre>
<hr />
<pre>
2634                 ? tagName.substring(1)
2635                 : tagName;
2636         for (DocTree dt : getBlockTags(element, kind)) {
2637             if (dt.getKind() == kind) {
2638                 if (tname == null || ch.getTagName(dt).equals(tname)) {
2639                     return true;
2640                 }
2641             }
2642         }
2643         return false;
2644     }
2645 
2646     /**
2647      * Gets a TreePath for an Element. Note this method is called very
2648      * frequently, care must be taken to ensure this method is lithe
2649      * and efficient.
2650      * @param e an Element
2651      * @return TreePath
2652      */
2653     public TreePath getTreePath(Element e) {
<span class="line-modified">2654         DocCommentDuo duo = dcTreeCache.get(e);</span>
<span class="line-modified">2655         if (duo != null &amp;&amp; duo.treePath != null) {</span>
<span class="line-modified">2656             return duo.treePath;</span>
2657         }
<span class="line-modified">2658         duo = configuration.cmtUtils.getSyntheticCommentDuo(e);</span>
<span class="line-modified">2659         if (duo != null &amp;&amp; duo.treePath != null) {</span>
<span class="line-modified">2660             return duo.treePath;</span>
2661         }
2662         Map&lt;Element, TreePath&gt; elementToTreePath = configuration.workArounds.getElementToTreePath();
2663         TreePath path = elementToTreePath.get(e);
2664         if (path != null || elementToTreePath.containsKey(e)) {
2665             // expedite the path and one that is a null
2666             return path;
2667         }
2668         return elementToTreePath.computeIfAbsent(e, docTrees::getPath);
2669     }
2670 
<span class="line-modified">2671     private final Map&lt;Element, DocCommentDuo&gt; dcTreeCache = new LinkedHashMap&lt;&gt;();</span>







2672 
2673     /**
2674      * Retrieves the doc comments for a given element.
2675      * @param element
2676      * @return DocCommentTree for the Element
2677      */
2678     public DocCommentTree getDocCommentTree0(Element element) {
2679 
<span class="line-modified">2680         DocCommentDuo duo = null;</span>
2681 
2682         ElementKind kind = element.getKind();
2683         if (kind == ElementKind.PACKAGE || kind == ElementKind.OTHER) {
<span class="line-modified">2684             duo = dcTreeCache.get(element); // local cache</span>
<span class="line-modified">2685             if (duo == null &amp;&amp; kind == ElementKind.PACKAGE) {</span>
2686                 // package-info.java
<span class="line-modified">2687                 duo = getDocCommentTuple(element);</span>
2688             }
<span class="line-modified">2689             if (duo == null) {</span>
2690                 // package.html or overview.html
<span class="line-modified">2691                 duo = configuration.cmtUtils.getHtmlCommentDuo(element); // html source</span>
2692             }
2693         } else {
<span class="line-modified">2694             duo = configuration.cmtUtils.getSyntheticCommentDuo(element);</span>
<span class="line-modified">2695             if (duo == null) {</span>
<span class="line-modified">2696                 duo = dcTreeCache.get(element); // local cache</span>
2697             }
<span class="line-modified">2698             if (duo == null) {</span>
<span class="line-modified">2699                 duo = getDocCommentTuple(element); // get the real mccoy</span>
2700             }
2701         }
2702 
<span class="line-modified">2703         DocCommentTree docCommentTree = isValidDuo(duo) ? duo.dcTree : null;</span>
<span class="line-removed">2704         TreePath path = isValidDuo(duo) ? duo.treePath : null;</span>
2705         if (!dcTreeCache.containsKey(element)) {
<span class="line-modified">2706             if (docCommentTree != null &amp;&amp; path != null) {</span>
<span class="line-modified">2707                 if (!configuration.isAllowScriptInComments()) {</span>

2708                     try {
2709                         javaScriptScanner.scan(docCommentTree, path, p -&gt; {
2710                             throw new JavaScriptScanner.Fault();
2711                         });
2712                     } catch (JavaScriptScanner.Fault jsf) {
2713                         String text = resources.getText(&quot;doclet.JavaScript_in_comment&quot;);
2714                         throw new UncheckedDocletException(new SimpleDocletException(text, jsf));
2715                     }
2716                 }

2717                 configuration.workArounds.runDocLint(path);
2718             }
<span class="line-modified">2719             dcTreeCache.put(element, duo);</span>
2720         }
2721         return docCommentTree;
2722     }
2723 
<span class="line-modified">2724     private DocCommentDuo getDocCommentTuple(Element element) {</span>
2725         // prevent nasty things downstream with overview element
2726         if (element.getKind() != ElementKind.OTHER) {
2727             TreePath path = getTreePath(element);
2728             if (path != null) {
2729                 DocCommentTree docCommentTree = docTrees.getDocCommentTree(path);
<span class="line-modified">2730                 return new DocCommentDuo(path, docCommentTree);</span>
2731             }
2732         }
2733         return null;
2734     }
2735 
2736     public void checkJavaScriptInOption(String name, String value) {
2737         if (!configuration.isAllowScriptInComments()) {
2738             DocCommentTree dct = configuration.cmtUtils.parse(
2739                     URI.create(&quot;option://&quot; + name.replace(&quot;-&quot;, &quot;&quot;)), &quot;&lt;body&gt;&quot; + value + &quot;&lt;/body&gt;&quot;);
2740 
2741             if (dct == null)
2742                 return;
2743 
2744             try {
2745                 javaScriptScanner.scan(dct, null, p -&gt; {
2746                     throw new JavaScriptScanner.Fault();
2747                 });
2748             } catch (JavaScriptScanner.Fault jsf) {
2749                 String text = resources.getText(&quot;doclet.JavaScript_in_option&quot;, name);
2750                 throw new UncheckedDocletException(new SimpleDocletException(text, jsf));
2751             }
2752         }
2753     }
2754 
<span class="line-removed">2755     boolean isValidDuo(DocCommentDuo duo) {</span>
<span class="line-removed">2756         return duo != null &amp;&amp; duo.dcTree != null;</span>
<span class="line-removed">2757     }</span>
<span class="line-removed">2758 </span>
2759     public DocCommentTree getDocCommentTree(Element element) {
2760         CommentHelper ch = commentHelperCache.get(element);
2761         if (ch != null) {
2762             return ch.dcTree;
2763         }
2764         DocCommentTree dcTree = getDocCommentTree0(element);
2765         if (dcTree != null) {
2766             commentHelperCache.put(element, new CommentHelper(configuration, element, getTreePath(element), dcTree));
2767         }
2768         return dcTree;
2769     }
2770 
2771     public List&lt;? extends DocTree&gt; getPreamble(Element element) {
2772         DocCommentTree docCommentTree = getDocCommentTree(element);
2773         return docCommentTree == null
2774                 ? Collections.emptyList()
2775                 : docCommentTree.getPreamble();
2776     }
2777 
2778     public List&lt;? extends DocTree&gt; getFullBody(Element element) {
</pre>
</td>
<td>
<hr />
<pre>
  90 import javax.tools.JavaFileManager;
  91 import javax.tools.JavaFileManager.Location;
  92 import javax.tools.StandardLocation;
  93 
  94 import com.sun.source.doctree.DocCommentTree;
  95 import com.sun.source.doctree.DocTree;
  96 import com.sun.source.doctree.DocTree.Kind;
  97 import com.sun.source.doctree.EndElementTree;
  98 import com.sun.source.doctree.ParamTree;
  99 import com.sun.source.doctree.StartElementTree;
 100 import com.sun.source.doctree.TextTree;
 101 import com.sun.source.doctree.UnknownBlockTagTree;
 102 import com.sun.source.tree.CompilationUnitTree;
 103 import com.sun.source.tree.LineMap;
 104 import com.sun.source.util.DocSourcePositions;
 105 import com.sun.source.util.DocTrees;
 106 import com.sun.source.util.TreePath;
 107 import com.sun.tools.javac.model.JavacTypes;
 108 import jdk.javadoc.internal.doclets.toolkit.BaseConfiguration;
 109 import jdk.javadoc.internal.doclets.toolkit.BaseOptions;
<span class="line-modified"> 110 import jdk.javadoc.internal.doclets.toolkit.CommentUtils.DocCommentInfo;</span>
 111 import jdk.javadoc.internal.doclets.toolkit.Resources;
 112 import jdk.javadoc.internal.doclets.toolkit.WorkArounds;
 113 import jdk.javadoc.internal.doclets.toolkit.taglets.BaseTaglet;
 114 import jdk.javadoc.internal.doclets.toolkit.taglets.Taglet;
 115 import jdk.javadoc.internal.tool.DocEnvImpl;
 116 
 117 import static javax.lang.model.element.ElementKind.*;
 118 import static javax.lang.model.element.Modifier.*;
 119 import static javax.lang.model.type.TypeKind.*;
 120 
 121 import static com.sun.source.doctree.DocTree.Kind.*;
 122 import static jdk.javadoc.internal.doclets.toolkit.builders.ConstantsSummaryBuilder.MAX_CONSTANT_VALUE_INDEX_LENGTH;
 123 
 124 /**
 125  * Utilities Class for Doclets.
 126  *
 127  *  &lt;p&gt;&lt;b&gt;This is NOT part of any supported API.
 128  *  If you write code that depends on this, you do so at your own risk.
 129  *  This code and its internal interfaces are subject to change or
 130  *  deletion without notice.&lt;/b&gt;
</pre>
<hr />
<pre>
2634                 ? tagName.substring(1)
2635                 : tagName;
2636         for (DocTree dt : getBlockTags(element, kind)) {
2637             if (dt.getKind() == kind) {
2638                 if (tname == null || ch.getTagName(dt).equals(tname)) {
2639                     return true;
2640                 }
2641             }
2642         }
2643         return false;
2644     }
2645 
2646     /**
2647      * Gets a TreePath for an Element. Note this method is called very
2648      * frequently, care must be taken to ensure this method is lithe
2649      * and efficient.
2650      * @param e an Element
2651      * @return TreePath
2652      */
2653     public TreePath getTreePath(Element e) {
<span class="line-modified">2654         DocCommentInfo info = dcTreeCache.get(e);</span>
<span class="line-modified">2655         if (info != null &amp;&amp; info.treePath != null) {</span>
<span class="line-modified">2656             return info.treePath;</span>
2657         }
<span class="line-modified">2658         info = configuration.cmtUtils.getSyntheticCommentInfo(e);</span>
<span class="line-modified">2659         if (info != null &amp;&amp; info.treePath != null) {</span>
<span class="line-modified">2660             return info.treePath;</span>
2661         }
2662         Map&lt;Element, TreePath&gt; elementToTreePath = configuration.workArounds.getElementToTreePath();
2663         TreePath path = elementToTreePath.get(e);
2664         if (path != null || elementToTreePath.containsKey(e)) {
2665             // expedite the path and one that is a null
2666             return path;
2667         }
2668         return elementToTreePath.computeIfAbsent(e, docTrees::getPath);
2669     }
2670 
<span class="line-modified">2671     /**</span>
<span class="line-added">2672      * A cache of doc comment info objects for elements.</span>
<span class="line-added">2673      * The entries may come from the AST and DocCommentParser, or may be autromatically</span>
<span class="line-added">2674      * generated comments for mandated elements and JavaFX properties.</span>
<span class="line-added">2675      *</span>
<span class="line-added">2676      * @see CommentUtils.dcInfoMap</span>
<span class="line-added">2677      */</span>
<span class="line-added">2678     private final Map&lt;Element, DocCommentInfo&gt; dcTreeCache = new LinkedHashMap&lt;&gt;();</span>
2679 
2680     /**
2681      * Retrieves the doc comments for a given element.
2682      * @param element
2683      * @return DocCommentTree for the Element
2684      */
2685     public DocCommentTree getDocCommentTree0(Element element) {
2686 
<span class="line-modified">2687         DocCommentInfo info = null;</span>
2688 
2689         ElementKind kind = element.getKind();
2690         if (kind == ElementKind.PACKAGE || kind == ElementKind.OTHER) {
<span class="line-modified">2691             info = dcTreeCache.get(element); // local cache</span>
<span class="line-modified">2692             if (info == null &amp;&amp; kind == ElementKind.PACKAGE) {</span>
2693                 // package-info.java
<span class="line-modified">2694                 info = getDocCommentInfo(element);</span>
2695             }
<span class="line-modified">2696             if (info == null) {</span>
2697                 // package.html or overview.html
<span class="line-modified">2698                 info = configuration.cmtUtils.getHtmlCommentInfo(element); // html source</span>
2699             }
2700         } else {
<span class="line-modified">2701             info = configuration.cmtUtils.getSyntheticCommentInfo(element);</span>
<span class="line-modified">2702             if (info == null) {</span>
<span class="line-modified">2703                 info = dcTreeCache.get(element); // local cache</span>
2704             }
<span class="line-modified">2705             if (info == null) {</span>
<span class="line-modified">2706                 info = getDocCommentInfo(element); // get the real mccoy</span>
2707             }
2708         }
2709 
<span class="line-modified">2710         DocCommentTree docCommentTree = info == null ? null : info.dcTree;</span>

2711         if (!dcTreeCache.containsKey(element)) {
<span class="line-modified">2712             TreePath path = info == null ? null : info.treePath;</span>
<span class="line-modified">2713             if (path != null) {</span>
<span class="line-added">2714                 if (docCommentTree != null &amp;&amp; !configuration.isAllowScriptInComments()) {</span>
2715                     try {
2716                         javaScriptScanner.scan(docCommentTree, path, p -&gt; {
2717                             throw new JavaScriptScanner.Fault();
2718                         });
2719                     } catch (JavaScriptScanner.Fault jsf) {
2720                         String text = resources.getText(&quot;doclet.JavaScript_in_comment&quot;);
2721                         throw new UncheckedDocletException(new SimpleDocletException(text, jsf));
2722                     }
2723                 }
<span class="line-added">2724                 // run doclint even if docCommentTree is null, to trigger checks for missing comments</span>
2725                 configuration.workArounds.runDocLint(path);
2726             }
<span class="line-modified">2727             dcTreeCache.put(element, info);</span>
2728         }
2729         return docCommentTree;
2730     }
2731 
<span class="line-modified">2732     private DocCommentInfo getDocCommentInfo(Element element) {</span>
2733         // prevent nasty things downstream with overview element
2734         if (element.getKind() != ElementKind.OTHER) {
2735             TreePath path = getTreePath(element);
2736             if (path != null) {
2737                 DocCommentTree docCommentTree = docTrees.getDocCommentTree(path);
<span class="line-modified">2738                 return new DocCommentInfo(path, docCommentTree);</span>
2739             }
2740         }
2741         return null;
2742     }
2743 
2744     public void checkJavaScriptInOption(String name, String value) {
2745         if (!configuration.isAllowScriptInComments()) {
2746             DocCommentTree dct = configuration.cmtUtils.parse(
2747                     URI.create(&quot;option://&quot; + name.replace(&quot;-&quot;, &quot;&quot;)), &quot;&lt;body&gt;&quot; + value + &quot;&lt;/body&gt;&quot;);
2748 
2749             if (dct == null)
2750                 return;
2751 
2752             try {
2753                 javaScriptScanner.scan(dct, null, p -&gt; {
2754                     throw new JavaScriptScanner.Fault();
2755                 });
2756             } catch (JavaScriptScanner.Fault jsf) {
2757                 String text = resources.getText(&quot;doclet.JavaScript_in_option&quot;, name);
2758                 throw new UncheckedDocletException(new SimpleDocletException(text, jsf));
2759             }
2760         }
2761     }
2762 




2763     public DocCommentTree getDocCommentTree(Element element) {
2764         CommentHelper ch = commentHelperCache.get(element);
2765         if (ch != null) {
2766             return ch.dcTree;
2767         }
2768         DocCommentTree dcTree = getDocCommentTree0(element);
2769         if (dcTree != null) {
2770             commentHelperCache.put(element, new CommentHelper(configuration, element, getTreePath(element), dcTree));
2771         }
2772         return dcTree;
2773     }
2774 
2775     public List&lt;? extends DocTree&gt; getPreamble(Element element) {
2776         DocCommentTree docCommentTree = getDocCommentTree(element);
2777         return docCommentTree == null
2778                 ? Collections.emptyList()
2779                 : docCommentTree.getPreamble();
2780     }
2781 
2782     public List&lt;? extends DocTree&gt; getFullBody(Element element) {
</pre>
</td>
</tr>
</table>
<center><a href="../../../../../../../../../jdk.internal.vm.compiler/share/classes/org.graalvm.compiler.hotspot.test/src/org/graalvm/compiler/hotspot/test/CheckGraalIntrinsics.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="../../../../../../../../../jdk.jdi/share/classes/com/sun/tools/jdi/VirtualMachineImpl.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>