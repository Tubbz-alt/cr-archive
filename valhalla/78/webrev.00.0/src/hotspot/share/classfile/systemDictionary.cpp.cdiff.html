<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff src/hotspot/share/classfile/systemDictionary.cpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
  </head>
<body>
<center><a href="javaClasses.cpp.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="systemDictionary.hpp.cdiff.html" target="_top">next &gt;</a></center>    <h2>src/hotspot/share/classfile/systemDictionary.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 44,12 ***</span>
  #include &quot;classfile/systemDictionary.hpp&quot;
  #include &quot;classfile/vmSymbols.hpp&quot;
  #include &quot;code/codeCache.hpp&quot;
  #include &quot;compiler/compileBroker.hpp&quot;
  #include &quot;gc/shared/gcTraceTime.inline.hpp&quot;
<span class="line-removed">- #include &quot;gc/shared/oopStorage.inline.hpp&quot;</span>
<span class="line-removed">- #include &quot;gc/shared/oopStorageSet.hpp&quot;</span>
  #include &quot;interpreter/bytecodeStream.hpp&quot;
  #include &quot;interpreter/interpreter.hpp&quot;
  #include &quot;jfr/jfrEvents.hpp&quot;
  #include &quot;logging/log.hpp&quot;
  #include &quot;logging/logStream.hpp&quot;
<span class="line-new-header">--- 44,10 ---</span>
</pre>
<hr />
<pre>
<span class="line-old-header">*** 67,10 ***</span>
<span class="line-new-header">--- 65,11 ---</span>
  #include &quot;oops/method.inline.hpp&quot;
  #include &quot;oops/methodData.hpp&quot;
  #include &quot;oops/objArrayKlass.hpp&quot;
  #include &quot;oops/objArrayOop.inline.hpp&quot;
  #include &quot;oops/oop.inline.hpp&quot;
<span class="line-added">+ #include &quot;oops/oopHandle.inline.hpp&quot;</span>
  #include &quot;oops/symbol.hpp&quot;
  #include &quot;oops/typeArrayKlass.hpp&quot;
  #include &quot;oops/valueKlass.hpp&quot;
  #include &quot;prims/jvmtiExport.hpp&quot;
  #include &quot;prims/methodHandles.hpp&quot;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 99,19 ***</span>
  LoaderConstraintTable* SystemDictionary::_loader_constraints  = NULL;
  ResolutionErrorTable*  SystemDictionary::_resolution_errors   = NULL;
  SymbolPropertyTable*   SystemDictionary::_invoke_method_table = NULL;
  ProtectionDomainCacheTable*   SystemDictionary::_pd_cache_table = NULL;
  
<span class="line-removed">- oop         SystemDictionary::_system_loader_lock_obj     =  NULL;</span>
<span class="line-removed">- </span>
  InstanceKlass*      SystemDictionary::_well_known_klasses[SystemDictionary::WKID_LIMIT]
                                                            =  { NULL /*, NULL...*/ };
  
  InstanceKlass*      SystemDictionary::_box_klasses[T_VOID+1]      =  { NULL /*, NULL...*/ };
  
<span class="line-modified">! oop         SystemDictionary::_java_system_loader         =  NULL;</span>
<span class="line-modified">! oop         SystemDictionary::_java_platform_loader       =  NULL;</span>
  
  // Default ProtectionDomainCacheSize value
  
  const int defaultProtectionDomainCacheSize = 1009;
  
<span class="line-new-header">--- 98,19 ---</span>
  LoaderConstraintTable* SystemDictionary::_loader_constraints  = NULL;
  ResolutionErrorTable*  SystemDictionary::_resolution_errors   = NULL;
  SymbolPropertyTable*   SystemDictionary::_invoke_method_table = NULL;
  ProtectionDomainCacheTable*   SystemDictionary::_pd_cache_table = NULL;
  
  InstanceKlass*      SystemDictionary::_well_known_klasses[SystemDictionary::WKID_LIMIT]
                                                            =  { NULL /*, NULL...*/ };
  
  InstanceKlass*      SystemDictionary::_box_klasses[T_VOID+1]      =  { NULL /*, NULL...*/ };
  
<span class="line-modified">! </span>
<span class="line-modified">! OopHandle   SystemDictionary::_system_loader_lock_obj;</span>
<span class="line-added">+ OopHandle   SystemDictionary::_java_system_loader;</span>
<span class="line-added">+ OopHandle   SystemDictionary::_java_platform_loader;</span>
  
  // Default ProtectionDomainCacheSize value
  
  const int defaultProtectionDomainCacheSize = 1009;
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 156,16 ***</span>
  }
  
  // ----------------------------------------------------------------------------
  // Java-level SystemLoader and PlatformLoader
  
  oop SystemDictionary::java_system_loader() {
<span class="line-modified">!   return _java_system_loader;</span>
  }
  
  oop SystemDictionary::java_platform_loader() {
<span class="line-modified">!   return _java_platform_loader;</span>
  }
  
  void SystemDictionary::compute_java_loaders(TRAPS) {
    JavaValue result(T_OBJECT);
    InstanceKlass* class_loader_klass = SystemDictionary::ClassLoader_klass();
<span class="line-new-header">--- 155,20 ---</span>
  }
  
  // ----------------------------------------------------------------------------
  // Java-level SystemLoader and PlatformLoader
  
<span class="line-added">+ oop SystemDictionary::system_loader_lock() {</span>
<span class="line-added">+   return _system_loader_lock_obj.resolve();</span>
<span class="line-added">+ }</span>
<span class="line-added">+ </span>
  oop SystemDictionary::java_system_loader() {
<span class="line-modified">!   return _java_system_loader.resolve();</span>
  }
  
  oop SystemDictionary::java_platform_loader() {
<span class="line-modified">!   return _java_platform_loader.resolve();</span>
  }
  
  void SystemDictionary::compute_java_loaders(TRAPS) {
    JavaValue result(T_OBJECT);
    InstanceKlass* class_loader_klass = SystemDictionary::ClassLoader_klass();
</pre>
<hr />
<pre>
<span class="line-old-header">*** 173,19 ***</span>
                           class_loader_klass,
                           vmSymbols::getSystemClassLoader_name(),
                           vmSymbols::void_classloader_signature(),
                           CHECK);
  
<span class="line-modified">!   _java_system_loader = (oop)result.get_jobject();</span>
  
    JavaCalls::call_static(&amp;result,
                           class_loader_klass,
                           vmSymbols::getPlatformClassLoader_name(),
                           vmSymbols::void_classloader_signature(),
                           CHECK);
  
<span class="line-modified">!   _java_platform_loader = (oop)result.get_jobject();</span>
  }
  
  ClassLoaderData* SystemDictionary::register_loader(Handle class_loader, bool create_mirror_cld) {
    if (create_mirror_cld) {
      // Add a new class loader data to the graph.
<span class="line-new-header">--- 176,19 ---</span>
                           class_loader_klass,
                           vmSymbols::getSystemClassLoader_name(),
                           vmSymbols::void_classloader_signature(),
                           CHECK);
  
<span class="line-modified">!   _java_system_loader = OopHandle::create((oop)result.get_jobject());</span>
  
    JavaCalls::call_static(&amp;result,
                           class_loader_klass,
                           vmSymbols::getPlatformClassLoader_name(),
                           vmSymbols::void_classloader_signature(),
                           CHECK);
  
<span class="line-modified">!   _java_platform_loader = OopHandle::create((oop)result.get_jobject());</span>
  }
  
  ClassLoaderData* SystemDictionary::register_loader(Handle class_loader, bool create_mirror_cld) {
    if (create_mirror_cld) {
      // Add a new class loader data to the graph.
</pre>
<hr />
<pre>
<span class="line-old-header">*** 220,11 ***</span>
  bool SystemDictionary::is_system_class_loader(oop class_loader) {
    if (class_loader == NULL) {
      return false;
    }
    return (class_loader-&gt;klass() == SystemDictionary::jdk_internal_loader_ClassLoaders_AppClassLoader_klass() ||
<span class="line-modified">!          class_loader == _java_system_loader);</span>
  }
  
  // Returns true if the passed class loader is the platform class loader.
  bool SystemDictionary::is_platform_class_loader(oop class_loader) {
    if (class_loader == NULL) {
<span class="line-new-header">--- 223,11 ---</span>
  bool SystemDictionary::is_system_class_loader(oop class_loader) {
    if (class_loader == NULL) {
      return false;
    }
    return (class_loader-&gt;klass() == SystemDictionary::jdk_internal_loader_ClassLoaders_AppClassLoader_klass() ||
<span class="line-modified">!          class_loader == _java_system_loader.peek());</span>
  }
  
  // Returns true if the passed class loader is the platform class loader.
  bool SystemDictionary::is_platform_class_loader(oop class_loader) {
    if (class_loader == NULL) {
</pre>
<hr />
<pre>
<span class="line-old-header">*** 648,11 ***</span>
    assert_lock_strong(SystemDictionary_lock);
  
    bool calledholdinglock
        = ObjectSynchronizer::current_thread_holds_lock((JavaThread*)THREAD, lockObject);
    assert(calledholdinglock,&quot;must hold lock for notify&quot;);
<span class="line-modified">!   assert((lockObject() != _system_loader_lock_obj &amp;&amp; !is_parallelCapable(lockObject)), &quot;unexpected double_lock_wait&quot;);</span>
    ObjectSynchronizer::notifyall(lockObject, THREAD);
    intx recursions =  ObjectSynchronizer::complete_exit(lockObject, THREAD);
    SystemDictionary_lock-&gt;wait();
    SystemDictionary_lock-&gt;unlock();
    ObjectSynchronizer::reenter(lockObject, recursions, THREAD);
<span class="line-new-header">--- 651,12 ---</span>
    assert_lock_strong(SystemDictionary_lock);
  
    bool calledholdinglock
        = ObjectSynchronizer::current_thread_holds_lock((JavaThread*)THREAD, lockObject);
    assert(calledholdinglock,&quot;must hold lock for notify&quot;);
<span class="line-modified">!   assert((lockObject() != _system_loader_lock_obj.resolve() &amp;&amp;</span>
<span class="line-added">+          !is_parallelCapable(lockObject)), &quot;unexpected double_lock_wait&quot;);</span>
    ObjectSynchronizer::notifyall(lockObject, THREAD);
    intx recursions =  ObjectSynchronizer::complete_exit(lockObject, THREAD);
    SystemDictionary_lock-&gt;wait();
    SystemDictionary_lock-&gt;unlock();
    ObjectSynchronizer::reenter(lockObject, recursions, THREAD);
</pre>
<hr />
<pre>
<span class="line-old-header">*** 744,11 ***</span>
      }
    }
    return NULL;
  }
  
<span class="line-modified">! static void post_class_load_event(EventClassLoad* event, const InstanceKlass* k, const ClassLoaderData* init_cld) {</span>
    assert(event != NULL, &quot;invariant&quot;);
    assert(k != NULL, &quot;invariant&quot;);
    assert(event-&gt;should_commit(), &quot;invariant&quot;);
    event-&gt;set_loadedClass(k);
    event-&gt;set_definingClassLoader(k-&gt;class_loader_data());
<span class="line-new-header">--- 748,11 ---</span>
      }
    }
    return NULL;
  }
  
<span class="line-modified">! void SystemDictionary::post_class_load_event(EventClassLoad* event, const InstanceKlass* k, const ClassLoaderData* init_cld) {</span>
    assert(event != NULL, &quot;invariant&quot;);
    assert(k != NULL, &quot;invariant&quot;);
    assert(event-&gt;should_commit(), &quot;invariant&quot;);
    event-&gt;set_loadedClass(k);
    event-&gt;set_definingClassLoader(k-&gt;class_loader_data());
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1410,10 ***</span>
<span class="line-new-header">--- 1414,41 ---</span>
    }
  
    return true;
  }
  
<span class="line-added">+ InstanceKlass* SystemDictionary::load_shared_lambda_proxy_class(InstanceKlass* ik,</span>
<span class="line-added">+                                                                 Handle class_loader,</span>
<span class="line-added">+                                                                 Handle protection_domain,</span>
<span class="line-added">+                                                                 PackageEntry* pkg_entry,</span>
<span class="line-added">+                                                                 TRAPS) {</span>
<span class="line-added">+   InstanceKlass* shared_nest_host = SystemDictionaryShared::get_shared_nest_host(ik);</span>
<span class="line-added">+   assert(shared_nest_host-&gt;is_shared(), &quot;nest host must be in CDS archive&quot;);</span>
<span class="line-added">+   Symbol* cn = shared_nest_host-&gt;name();</span>
<span class="line-added">+   Klass *s = resolve_or_fail(cn, class_loader, protection_domain, true, CHECK_NULL);</span>
<span class="line-added">+   if (s != shared_nest_host) {</span>
<span class="line-added">+     // The dynamically resolved nest_host is not the same as the one we used during dump time,</span>
<span class="line-added">+     // so we cannot use ik.</span>
<span class="line-added">+     return NULL;</span>
<span class="line-added">+   } else {</span>
<span class="line-added">+     assert(s-&gt;is_shared(), &quot;must be&quot;);</span>
<span class="line-added">+   }</span>
<span class="line-added">+ </span>
<span class="line-added">+   // The lambda proxy class and its nest host have the same class loader and class loader data,</span>
<span class="line-added">+   // as verified in SystemDictionaryShared::add_lambda_proxy_class()</span>
<span class="line-added">+   assert(shared_nest_host-&gt;class_loader() == class_loader(), &quot;mismatched class loader&quot;);</span>
<span class="line-added">+   assert(shared_nest_host-&gt;class_loader_data() == ClassLoaderData::class_loader_data(class_loader()), &quot;mismatched class loader data&quot;);</span>
<span class="line-added">+   ik-&gt;set_nest_host(shared_nest_host, THREAD);</span>
<span class="line-added">+ </span>
<span class="line-added">+   InstanceKlass* loaded_ik = load_shared_class(ik, class_loader, protection_domain, NULL, pkg_entry, CHECK_NULL);</span>
<span class="line-added">+ </span>
<span class="line-added">+   assert(shared_nest_host-&gt;is_same_class_package(ik),</span>
<span class="line-added">+          &quot;lambda proxy class and its nest host must be in the same package&quot;);</span>
<span class="line-added">+ </span>
<span class="line-added">+   return loaded_ik;</span>
<span class="line-added">+ }</span>
<span class="line-added">+ </span>
  InstanceKlass* SystemDictionary::load_shared_class(InstanceKlass* ik,
                                                     Handle class_loader,
                                                     Handle protection_domain,
                                                     const ClassFileStream *cfs,
                                                     PackageEntry* pkg_entry,
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1430,12 ***</span>
  
    if (!check_shared_class_super_types(ik, class_loader, protection_domain, THREAD)) {
      return NULL;
    }
  
<span class="line-modified">!   InstanceKlass* new_ik = KlassFactory::check_shared_class_file_load_hook(</span>
        ik, class_name, class_loader, protection_domain, cfs, CHECK_NULL);
    if (new_ik != NULL) {
      // The class is changed by CFLH. Return the new class. The shared class is
      // not used.
      return new_ik;
    }
<span class="line-new-header">--- 1465,17 ---</span>
  
    if (!check_shared_class_super_types(ik, class_loader, protection_domain, THREAD)) {
      return NULL;
    }
  
<span class="line-modified">!   InstanceKlass* new_ik = NULL;</span>
<span class="line-added">+   // CFLH check is skipped for VM hidden or anonymous classes (see KlassFactory::create_from_stream).</span>
<span class="line-added">+   // It will be skipped for shared VM hidden lambda proxy classes.</span>
<span class="line-added">+   if (!SystemDictionaryShared::is_hidden_lambda_proxy(ik)) {</span>
<span class="line-added">+     new_ik = KlassFactory::check_shared_class_file_load_hook(</span>
        ik, class_name, class_loader, protection_domain, cfs, CHECK_NULL);
<span class="line-added">+   }</span>
    if (new_ik != NULL) {
      // The class is changed by CFLH. Return the new class. The shared class is
      // not used.
      return new_ik;
    }
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1865,11 ***</span>
  }
  
  Handle SystemDictionary::compute_loader_lock_object(Handle class_loader, TRAPS) {
    // If class_loader is NULL we synchronize on _system_loader_lock_obj
    if (class_loader.is_null()) {
<span class="line-modified">!     return Handle(THREAD, _system_loader_lock_obj);</span>
    } else {
      return class_loader;
    }
  }
  
<span class="line-new-header">--- 1905,11 ---</span>
  }
  
  Handle SystemDictionary::compute_loader_lock_object(Handle class_loader, TRAPS) {
    // If class_loader is NULL we synchronize on _system_loader_lock_obj
    if (class_loader.is_null()) {
<span class="line-modified">!     return Handle(THREAD, _system_loader_lock_obj.resolve());</span>
    } else {
      return class_loader;
    }
  }
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1886,11 ***</span>
  
    if (ObjectSynchronizer::query_lock_ownership((JavaThread*)THREAD, loader_lock)
        == ObjectSynchronizer::owner_other) {
      // contention will likely happen, so increment the corresponding
      // contention counter.
<span class="line-modified">!     if (loader_lock() == _system_loader_lock_obj) {</span>
        ClassLoader::sync_systemLoaderLockContentionRate()-&gt;inc();
      } else {
        ClassLoader::sync_nonSystemLoaderLockContentionRate()-&gt;inc();
      }
    }
<span class="line-new-header">--- 1926,11 ---</span>
  
    if (ObjectSynchronizer::query_lock_ownership((JavaThread*)THREAD, loader_lock)
        == ObjectSynchronizer::owner_other) {
      // contention will likely happen, so increment the corresponding
      // contention counter.
<span class="line-modified">!     if (loader_lock() == _system_loader_lock_obj.resolve()) {</span>
        ClassLoader::sync_systemLoaderLockContentionRate()-&gt;inc();
      } else {
        ClassLoader::sync_nonSystemLoaderLockContentionRate()-&gt;inc();
      }
    }
</pre>
<hr />
<pre>
<span class="line-old-header">*** 2003,24 ***</span>
    }
  
    return unloading_occurred;
  }
  
<span class="line-removed">- void SystemDictionary::oops_do(OopClosure* f, bool include_handles) {</span>
<span class="line-removed">-   f-&gt;do_oop(&amp;_java_system_loader);</span>
<span class="line-removed">-   f-&gt;do_oop(&amp;_java_platform_loader);</span>
<span class="line-removed">-   f-&gt;do_oop(&amp;_system_loader_lock_obj);</span>
<span class="line-removed">-   CDS_ONLY(SystemDictionaryShared::oops_do(f);)</span>
<span class="line-removed">- </span>
<span class="line-removed">-   // Visit extra methods</span>
<span class="line-removed">-   invoke_method_table()-&gt;oops_do(f);</span>
<span class="line-removed">- </span>
<span class="line-removed">-   if (include_handles) {</span>
<span class="line-removed">-     OopStorageSet::vm_global()-&gt;oops_do(f);</span>
<span class="line-removed">-   }</span>
<span class="line-removed">- }</span>
<span class="line-removed">- </span>
  // CDS: scan and relocate all classes referenced by _well_known_klasses[].
  void SystemDictionary::well_known_klasses_do(MetaspaceClosure* it) {
    for (int id = FIRST_WKID; id &lt; WKID_LIMIT; id++) {
      it-&gt;push(well_known_klass_addr((WKID)id));
    }
<span class="line-new-header">--- 2043,10 ---</span>
</pre>
<hr />
<pre>
<span class="line-old-header">*** 2044,11 ***</span>
    _resolution_errors   = new ResolutionErrorTable(_resolution_error_size);
    _invoke_method_table = new SymbolPropertyTable(_invoke_method_size);
    _pd_cache_table = new ProtectionDomainCacheTable(defaultProtectionDomainCacheSize);
  
    // Allocate private object used as system class loader lock
<span class="line-modified">!   _system_loader_lock_obj = oopFactory::new_intArray(0, CHECK);</span>
    // Initialize basic classes
    resolve_well_known_classes(CHECK);
  }
  
  // Compact table of directions on the initialization of klasses:
<span class="line-new-header">--- 2070,13 ---</span>
    _resolution_errors   = new ResolutionErrorTable(_resolution_error_size);
    _invoke_method_table = new SymbolPropertyTable(_invoke_method_size);
    _pd_cache_table = new ProtectionDomainCacheTable(defaultProtectionDomainCacheSize);
  
    // Allocate private object used as system class loader lock
<span class="line-modified">!   oop lock_obj = oopFactory::new_intArray(0, CHECK);</span>
<span class="line-added">+   _system_loader_lock_obj = OopHandle::create(lock_obj);</span>
<span class="line-added">+ </span>
    // Initialize basic classes
    resolve_well_known_classes(CHECK);
  }
  
  // Compact table of directions on the initialization of klasses:
</pre>
<center><a href="javaClasses.cpp.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="systemDictionary.hpp.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>