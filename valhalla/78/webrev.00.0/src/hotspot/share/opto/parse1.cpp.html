<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>New src/hotspot/share/opto/parse1.cpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
  </head>
  <body>
    <pre>
   1 /*
   2  * Copyright (c) 1997, 2020, Oracle and/or its affiliates. All rights reserved.
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.
   8  *
   9  * This code is distributed in the hope that it will be useful, but WITHOUT
  10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  *
  23  */
  24 
  25 #include &quot;precompiled.hpp&quot;
  26 #include &quot;compiler/compileLog.hpp&quot;
  27 #include &quot;interpreter/linkResolver.hpp&quot;
  28 #include &quot;memory/resourceArea.hpp&quot;
  29 #include &quot;oops/method.hpp&quot;
  30 #include &quot;opto/addnode.hpp&quot;
  31 #include &quot;opto/c2compiler.hpp&quot;
  32 #include &quot;opto/castnode.hpp&quot;
  33 #include &quot;opto/idealGraphPrinter.hpp&quot;
  34 #include &quot;opto/locknode.hpp&quot;
  35 #include &quot;opto/memnode.hpp&quot;
  36 #include &quot;opto/opaquenode.hpp&quot;
  37 #include &quot;opto/parse.hpp&quot;
  38 #include &quot;opto/rootnode.hpp&quot;
  39 #include &quot;opto/runtime.hpp&quot;
  40 #include &quot;opto/valuetypenode.hpp&quot;
  41 #include &quot;runtime/arguments.hpp&quot;
  42 #include &quot;runtime/handles.inline.hpp&quot;
  43 #include &quot;runtime/safepointMechanism.hpp&quot;
  44 #include &quot;runtime/sharedRuntime.hpp&quot;
  45 #include &quot;utilities/bitMap.inline.hpp&quot;
  46 #include &quot;utilities/copy.hpp&quot;
  47 
  48 // Static array so we can figure out which bytecodes stop us from compiling
  49 // the most. Some of the non-static variables are needed in bytecodeInfo.cpp
  50 // and eventually should be encapsulated in a proper class (gri 8/18/98).
  51 
  52 #ifndef PRODUCT
  53 int nodes_created              = 0;
  54 int methods_parsed             = 0;
  55 int methods_seen               = 0;
  56 int blocks_parsed              = 0;
  57 int blocks_seen                = 0;
  58 
  59 int explicit_null_checks_inserted = 0;
  60 int explicit_null_checks_elided   = 0;
  61 int all_null_checks_found         = 0;
  62 int implicit_null_checks          = 0;
  63 
  64 bool Parse::BytecodeParseHistogram::_initialized = false;
  65 uint Parse::BytecodeParseHistogram::_bytecodes_parsed [Bytecodes::number_of_codes];
  66 uint Parse::BytecodeParseHistogram::_nodes_constructed[Bytecodes::number_of_codes];
  67 uint Parse::BytecodeParseHistogram::_nodes_transformed[Bytecodes::number_of_codes];
  68 uint Parse::BytecodeParseHistogram::_new_values       [Bytecodes::number_of_codes];
  69 
  70 //------------------------------print_statistics-------------------------------
  71 void Parse::print_statistics() {
  72   tty-&gt;print_cr(&quot;--- Compiler Statistics ---&quot;);
  73   tty-&gt;print(&quot;Methods seen: %d  Methods parsed: %d&quot;, methods_seen, methods_parsed);
  74   tty-&gt;print(&quot;  Nodes created: %d&quot;, nodes_created);
  75   tty-&gt;cr();
  76   if (methods_seen != methods_parsed) {
  77     tty-&gt;print_cr(&quot;Reasons for parse failures (NOT cumulative):&quot;);
  78   }
  79   tty-&gt;print_cr(&quot;Blocks parsed: %d  Blocks seen: %d&quot;, blocks_parsed, blocks_seen);
  80 
  81   if (explicit_null_checks_inserted) {
  82     tty-&gt;print_cr(&quot;%d original NULL checks - %d elided (%2d%%); optimizer leaves %d,&quot;,
  83                   explicit_null_checks_inserted, explicit_null_checks_elided,
  84                   (100*explicit_null_checks_elided)/explicit_null_checks_inserted,
  85                   all_null_checks_found);
  86   }
  87   if (all_null_checks_found) {
  88     tty-&gt;print_cr(&quot;%d made implicit (%2d%%)&quot;, implicit_null_checks,
  89                   (100*implicit_null_checks)/all_null_checks_found);
  90   }
  91   if (SharedRuntime::_implicit_null_throws) {
  92     tty-&gt;print_cr(&quot;%d implicit null exceptions at runtime&quot;,
  93                   SharedRuntime::_implicit_null_throws);
  94   }
  95 
  96   if (PrintParseStatistics &amp;&amp; BytecodeParseHistogram::initialized()) {
  97     BytecodeParseHistogram::print();
  98   }
  99 }
 100 #endif
 101 
 102 //------------------------------ON STACK REPLACEMENT---------------------------
 103 
 104 // Construct a node which can be used to get incoming state for
 105 // on stack replacement.
 106 Node* Parse::fetch_interpreter_state(int index,
 107                                      const Type* type,
 108                                      Node* local_addrs,
 109                                      Node* local_addrs_base) {
 110   BasicType bt = type-&gt;basic_type();
 111   if (type == TypePtr::NULL_PTR) {
 112     // Ptr types are mixed together with T_ADDRESS but NULL is
 113     // really for T_OBJECT types so correct it.
 114     bt = T_OBJECT;
 115   }
 116   Node *mem = memory(Compile::AliasIdxRaw);
 117   Node *adr = basic_plus_adr( local_addrs_base, local_addrs, -index*wordSize );
 118   Node *ctl = control();
 119 
 120   // Very similar to LoadNode::make, except we handle un-aligned longs and
 121   // doubles on Sparc.  Intel can handle them just fine directly.
 122   Node *l = NULL;
 123   switch (bt) {                // Signature is flattened
 124   case T_INT:     l = new LoadINode(ctl, mem, adr, TypeRawPtr::BOTTOM, TypeInt::INT,        MemNode::unordered); break;
 125   case T_FLOAT:   l = new LoadFNode(ctl, mem, adr, TypeRawPtr::BOTTOM, Type::FLOAT,         MemNode::unordered); break;
 126   case T_ADDRESS: l = new LoadPNode(ctl, mem, adr, TypeRawPtr::BOTTOM, TypeRawPtr::BOTTOM,  MemNode::unordered); break;
 127   case T_VALUETYPE:
 128   case T_OBJECT:  l = new LoadPNode(ctl, mem, adr, TypeRawPtr::BOTTOM, TypeInstPtr::BOTTOM, MemNode::unordered); break;
 129   case T_LONG:
 130   case T_DOUBLE: {
 131     // Since arguments are in reverse order, the argument address &#39;adr&#39;
 132     // refers to the back half of the long/double.  Recompute adr.
 133     adr = basic_plus_adr(local_addrs_base, local_addrs, -(index+1)*wordSize);
 134     if (Matcher::misaligned_doubles_ok) {
 135       l = (bt == T_DOUBLE)
 136         ? (Node*)new LoadDNode(ctl, mem, adr, TypeRawPtr::BOTTOM, Type::DOUBLE, MemNode::unordered)
 137         : (Node*)new LoadLNode(ctl, mem, adr, TypeRawPtr::BOTTOM, TypeLong::LONG, MemNode::unordered);
 138     } else {
 139       l = (bt == T_DOUBLE)
 140         ? (Node*)new LoadD_unalignedNode(ctl, mem, adr, TypeRawPtr::BOTTOM, MemNode::unordered)
 141         : (Node*)new LoadL_unalignedNode(ctl, mem, adr, TypeRawPtr::BOTTOM, MemNode::unordered);
 142     }
 143     break;
 144   }
 145   default: ShouldNotReachHere();
 146   }
 147   return _gvn.transform(l);
 148 }
 149 
 150 // Helper routine to prevent the interpreter from handing
 151 // unexpected typestate to an OSR method.
 152 // The Node l is a value newly dug out of the interpreter frame.
 153 // The type is the type predicted by ciTypeFlow.  Note that it is
 154 // not a general type, but can only come from Type::get_typeflow_type.
 155 // The safepoint is a map which will feed an uncommon trap.
 156 Node* Parse::check_interpreter_type(Node* l, const Type* type,
 157                                     SafePointNode* &amp;bad_type_exit) {
 158   const TypeOopPtr* tp = type-&gt;isa_oopptr();
 159   if (type-&gt;isa_valuetype() != NULL) {
 160     // The interpreter passes value types as oops
 161     tp = TypeOopPtr::make_from_klass(type-&gt;value_klass());
 162     tp = tp-&gt;join_speculative(TypePtr::NOTNULL)-&gt;is_oopptr();
 163   }
 164 
 165   // TypeFlow may assert null-ness if a type appears unloaded.
 166   if (type == TypePtr::NULL_PTR ||
 167       (tp != NULL &amp;&amp; !tp-&gt;klass()-&gt;is_loaded())) {
 168     // Value must be null, not a real oop.
 169     Node* chk = _gvn.transform( new CmpPNode(l, null()) );
 170     Node* tst = _gvn.transform( new BoolNode(chk, BoolTest::eq) );
 171     IfNode* iff = create_and_map_if(control(), tst, PROB_MAX, COUNT_UNKNOWN);
 172     set_control(_gvn.transform( new IfTrueNode(iff) ));
 173     Node* bad_type = _gvn.transform( new IfFalseNode(iff) );
 174     bad_type_exit-&gt;control()-&gt;add_req(bad_type);
 175     l = null();
 176   }
 177 
 178   // Typeflow can also cut off paths from the CFG, based on
 179   // types which appear unloaded, or call sites which appear unlinked.
 180   // When paths are cut off, values at later merge points can rise
 181   // toward more specific classes.  Make sure these specific classes
 182   // are still in effect.
 183   if (tp != NULL &amp;&amp; tp-&gt;klass() != C-&gt;env()-&gt;Object_klass()) {
 184     // TypeFlow asserted a specific object type.  Value must have that type.
 185     Node* bad_type_ctrl = NULL;
 186     if (tp-&gt;is_valuetypeptr() &amp;&amp; !tp-&gt;maybe_null()) {
 187       // Check value types for null here to prevent checkcast from adding an
 188       // exception state before the bytecode entry (use &#39;bad_type_ctrl&#39; instead).
 189       l = null_check_oop(l, &amp;bad_type_ctrl);
 190       bad_type_exit-&gt;control()-&gt;add_req(bad_type_ctrl);
 191     }
 192     l = gen_checkcast(l, makecon(TypeKlassPtr::make(tp-&gt;klass())), &amp;bad_type_ctrl);
 193     bad_type_exit-&gt;control()-&gt;add_req(bad_type_ctrl);
 194   }
 195   assert(_gvn.type(l)-&gt;higher_equal(type), &quot;must constrain OSR typestate&quot;);
 196   return l;
 197 }
 198 
 199 // Helper routine which sets up elements of the initial parser map when
 200 // performing a parse for on stack replacement.  Add values into map.
 201 // The only parameter contains the address of a interpreter arguments.
 202 void Parse::load_interpreter_state(Node* osr_buf) {
 203   int index;
 204   int max_locals = jvms()-&gt;loc_size();
 205   int max_stack  = jvms()-&gt;stk_size();
 206 
 207   // Mismatch between method and jvms can occur since map briefly held
 208   // an OSR entry state (which takes up one RawPtr word).
 209   assert(max_locals == method()-&gt;max_locals(), &quot;sanity&quot;);
 210   assert(max_stack  &gt;= method()-&gt;max_stack(),  &quot;sanity&quot;);
 211   assert((int)jvms()-&gt;endoff() == TypeFunc::Parms + max_locals + max_stack, &quot;sanity&quot;);
 212   assert((int)jvms()-&gt;endoff() == (int)map()-&gt;req(), &quot;sanity&quot;);
 213 
 214   // Find the start block.
 215   Block* osr_block = start_block();
 216   assert(osr_block-&gt;start() == osr_bci(), &quot;sanity&quot;);
 217 
 218   // Set initial BCI.
 219   set_parse_bci(osr_block-&gt;start());
 220 
 221   // Set initial stack depth.
 222   set_sp(osr_block-&gt;start_sp());
 223 
 224   // Check bailouts.  We currently do not perform on stack replacement
 225   // of loops in catch blocks or loops which branch with a non-empty stack.
 226   if (sp() != 0) {
 227     C-&gt;record_method_not_compilable(&quot;OSR starts with non-empty stack&quot;);
 228     return;
 229   }
 230   // Do not OSR inside finally clauses:
 231   if (osr_block-&gt;has_trap_at(osr_block-&gt;start())) {
 232     C-&gt;record_method_not_compilable(&quot;OSR starts with an immediate trap&quot;);
 233     return;
 234   }
 235 
 236   // Commute monitors from interpreter frame to compiler frame.
 237   assert(jvms()-&gt;monitor_depth() == 0, &quot;should be no active locks at beginning of osr&quot;);
 238   int mcnt = osr_block-&gt;flow()-&gt;monitor_count();
 239   Node *monitors_addr = basic_plus_adr(osr_buf, osr_buf, (max_locals+mcnt*2-1)*wordSize);
 240   for (index = 0; index &lt; mcnt; index++) {
 241     // Make a BoxLockNode for the monitor.
 242     Node *box = _gvn.transform(new BoxLockNode(next_monitor()));
 243 
 244     // Displaced headers and locked objects are interleaved in the
 245     // temp OSR buffer.  We only copy the locked objects out here.
 246     // Fetch the locked object from the OSR temp buffer and copy to our fastlock node.
 247     Node* lock_object = fetch_interpreter_state(index*2, Type::get_const_basic_type(T_OBJECT), monitors_addr, osr_buf);
 248     // Try and copy the displaced header to the BoxNode
 249     Node* displaced_hdr = fetch_interpreter_state((index*2) + 1, Type::get_const_basic_type(T_ADDRESS), monitors_addr, osr_buf);
 250 
 251     store_to_memory(control(), box, displaced_hdr, T_ADDRESS, Compile::AliasIdxRaw, MemNode::unordered);
 252 
 253     // Build a bogus FastLockNode (no code will be generated) and push the
 254     // monitor into our debug info.
 255     const FastLockNode *flock = _gvn.transform(new FastLockNode( 0, lock_object, box ))-&gt;as_FastLock();
 256     map()-&gt;push_monitor(flock);
 257 
 258     // If the lock is our method synchronization lock, tuck it away in
 259     // _sync_lock for return and rethrow exit paths.
 260     if (index == 0 &amp;&amp; method()-&gt;is_synchronized()) {
 261       _synch_lock = flock;
 262     }
 263   }
 264 
 265   // Use the raw liveness computation to make sure that unexpected
 266   // values don&#39;t propagate into the OSR frame.
 267   MethodLivenessResult live_locals = method()-&gt;liveness_at_bci(osr_bci());
 268   if (!live_locals.is_valid()) {
 269     // Degenerate or breakpointed method.
 270     C-&gt;record_method_not_compilable(&quot;OSR in empty or breakpointed method&quot;);
 271     return;
 272   }
 273 
 274   // Extract the needed locals from the interpreter frame.
 275   Node *locals_addr = basic_plus_adr(osr_buf, osr_buf, (max_locals-1)*wordSize);
 276 
 277   // find all the locals that the interpreter thinks contain live oops
 278   const ResourceBitMap live_oops = method()-&gt;live_local_oops_at_bci(osr_bci());
 279   for (index = 0; index &lt; max_locals; index++) {
 280 
 281     if (!live_locals.at(index)) {
 282       continue;
 283     }
 284 
 285     const Type *type = osr_block-&gt;local_type_at(index);
 286 
 287     if (type-&gt;isa_oopptr() != NULL) {
 288 
 289       // 6403625: Verify that the interpreter oopMap thinks that the oop is live
 290       // else we might load a stale oop if the MethodLiveness disagrees with the
 291       // result of the interpreter. If the interpreter says it is dead we agree
 292       // by making the value go to top.
 293       //
 294 
 295       if (!live_oops.at(index)) {
 296         if (C-&gt;log() != NULL) {
 297           C-&gt;log()-&gt;elem(&quot;OSR_mismatch local_index=&#39;%d&#39;&quot;,index);
 298         }
 299         set_local(index, null());
 300         // and ignore it for the loads
 301         continue;
 302       }
 303     }
 304 
 305     // Filter out TOP, HALF, and BOTTOM.  (Cf. ensure_phi.)
 306     if (type == Type::TOP || type == Type::HALF) {
 307       continue;
 308     }
 309     // If the type falls to bottom, then this must be a local that
 310     // is mixing ints and oops or some such.  Forcing it to top
 311     // makes it go dead.
 312     if (type == Type::BOTTOM) {
 313       continue;
 314     }
 315     // Construct code to access the appropriate local.
 316     Node* value = fetch_interpreter_state(index, type, locals_addr, osr_buf);
 317     set_local(index, value);
 318   }
 319 
 320   // Extract the needed stack entries from the interpreter frame.
 321   for (index = 0; index &lt; sp(); index++) {
 322     const Type *type = osr_block-&gt;stack_type_at(index);
 323     if (type != Type::TOP) {
 324       // Currently the compiler bails out when attempting to on stack replace
 325       // at a bci with a non-empty stack.  We should not reach here.
 326       ShouldNotReachHere();
 327     }
 328   }
 329 
 330   // End the OSR migration
 331   make_runtime_call(RC_LEAF, OptoRuntime::osr_end_Type(),
 332                     CAST_FROM_FN_PTR(address, SharedRuntime::OSR_migration_end),
 333                     &quot;OSR_migration_end&quot;, TypeRawPtr::BOTTOM,
 334                     osr_buf);
 335 
 336   // Now that the interpreter state is loaded, make sure it will match
 337   // at execution time what the compiler is expecting now:
 338   SafePointNode* bad_type_exit = clone_map();
 339   bad_type_exit-&gt;set_control(new RegionNode(1));
 340 
 341   assert(osr_block-&gt;flow()-&gt;jsrs()-&gt;size() == 0, &quot;should be no jsrs live at osr point&quot;);
 342   for (index = 0; index &lt; max_locals; index++) {
 343     if (stopped())  break;
 344     Node* l = local(index);
 345     if (l-&gt;is_top())  continue;  // nothing here
 346     const Type *type = osr_block-&gt;local_type_at(index);
 347     if (type-&gt;isa_oopptr() != NULL) {
 348       if (!live_oops.at(index)) {
 349         // skip type check for dead oops
 350         continue;
 351       }
 352     }
 353     if (osr_block-&gt;flow()-&gt;local_type_at(index)-&gt;is_return_address()) {
 354       // In our current system it&#39;s illegal for jsr addresses to be
 355       // live into an OSR entry point because the compiler performs
 356       // inlining of jsrs.  ciTypeFlow has a bailout that detect this
 357       // case and aborts the compile if addresses are live into an OSR
 358       // entry point.  Because of that we can assume that any address
 359       // locals at the OSR entry point are dead.  Method liveness
 360       // isn&#39;t precise enought to figure out that they are dead in all
 361       // cases so simply skip checking address locals all
 362       // together. Any type check is guaranteed to fail since the
 363       // interpreter type is the result of a load which might have any
 364       // value and the expected type is a constant.
 365       continue;
 366     }
 367     set_local(index, check_interpreter_type(l, type, bad_type_exit));
 368   }
 369 
 370   for (index = 0; index &lt; sp(); index++) {
 371     if (stopped())  break;
 372     Node* l = stack(index);
 373     if (l-&gt;is_top())  continue;  // nothing here
 374     const Type *type = osr_block-&gt;stack_type_at(index);
 375     set_stack(index, check_interpreter_type(l, type, bad_type_exit));
 376   }
 377 
 378   if (bad_type_exit-&gt;control()-&gt;req() &gt; 1) {
 379     // Build an uncommon trap here, if any inputs can be unexpected.
 380     bad_type_exit-&gt;set_control(_gvn.transform( bad_type_exit-&gt;control() ));
 381     record_for_igvn(bad_type_exit-&gt;control());
 382     SafePointNode* types_are_good = map();
 383     set_map(bad_type_exit);
 384     // The unexpected type happens because a new edge is active
 385     // in the CFG, which typeflow had previously ignored.
 386     // E.g., Object x = coldAtFirst() &amp;&amp; notReached()? &quot;str&quot;: new Integer(123).
 387     // This x will be typed as Integer if notReached is not yet linked.
 388     // It could also happen due to a problem in ciTypeFlow analysis.
 389     uncommon_trap(Deoptimization::Reason_constraint,
 390                   Deoptimization::Action_reinterpret);
 391     set_map(types_are_good);
 392   }
 393 }
 394 
 395 //------------------------------Parse------------------------------------------
 396 // Main parser constructor.
 397 Parse::Parse(JVMState* caller, ciMethod* parse_method, float expected_uses)
 398   : _exits(caller)
 399 {
 400   // Init some variables
 401   _caller = caller;
 402   _method = parse_method;
 403   _expected_uses = expected_uses;
 404   _depth = 1 + (caller-&gt;has_method() ? caller-&gt;depth() : 0);
 405   _wrote_final = false;
 406   _wrote_volatile = false;
 407   _wrote_stable = false;
 408   _wrote_fields = false;
 409   _alloc_with_final = NULL;
 410   _entry_bci = InvocationEntryBci;
 411   _tf = NULL;
 412   _block = NULL;
 413   _first_return = true;
 414   _replaced_nodes_for_exceptions = false;
 415   _new_idx = C-&gt;unique();
 416   debug_only(_block_count = -1);
 417   debug_only(_blocks = (Block*)-1);
 418 #ifndef PRODUCT
 419   if (PrintCompilation || PrintOpto) {
 420     // Make sure I have an inline tree, so I can print messages about it.
 421     JVMState* ilt_caller = is_osr_parse() ? caller-&gt;caller() : caller;
 422     InlineTree::find_subtree_from_root(C-&gt;ilt(), ilt_caller, parse_method);
 423   }
 424   _max_switch_depth = 0;
 425   _est_switch_depth = 0;
 426 #endif
 427 
 428   if (parse_method-&gt;has_reserved_stack_access()) {
 429     C-&gt;set_has_reserved_stack_access(true);
 430   }
 431 
 432   _tf = TypeFunc::make(method());
 433   _iter.reset_to_method(method());
 434   _flow = method()-&gt;get_flow_analysis();
 435   if (_flow-&gt;failing()) {
 436     C-&gt;record_method_not_compilable(_flow-&gt;failure_reason());
 437   }
 438 
 439 #ifndef PRODUCT
 440   if (_flow-&gt;has_irreducible_entry()) {
 441     C-&gt;set_parsed_irreducible_loop(true);
 442   }
 443 #endif
 444 
 445   if (_expected_uses &lt;= 0) {
 446     _prof_factor = 1;
 447   } else {
 448     float prof_total = parse_method-&gt;interpreter_invocation_count();
 449     if (prof_total &lt;= _expected_uses) {
 450       _prof_factor = 1;
 451     } else {
 452       _prof_factor = _expected_uses / prof_total;
 453     }
 454   }
 455 
 456   CompileLog* log = C-&gt;log();
 457   if (log != NULL) {
 458     log-&gt;begin_head(&quot;parse method=&#39;%d&#39; uses=&#39;%f&#39;&quot;,
 459                     log-&gt;identify(parse_method), expected_uses);
 460     if (depth() == 1 &amp;&amp; C-&gt;is_osr_compilation()) {
 461       log-&gt;print(&quot; osr_bci=&#39;%d&#39;&quot;, C-&gt;entry_bci());
 462     }
 463     log-&gt;stamp();
 464     log-&gt;end_head();
 465   }
 466 
 467   // Accumulate deoptimization counts.
 468   // (The range_check and store_check counts are checked elsewhere.)
 469   ciMethodData* md = method()-&gt;method_data();
 470   for (uint reason = 0; reason &lt; md-&gt;trap_reason_limit(); reason++) {
 471     uint md_count = md-&gt;trap_count(reason);
 472     if (md_count != 0) {
 473       if (md_count == md-&gt;trap_count_limit())
 474         md_count += md-&gt;overflow_trap_count();
 475       uint total_count = C-&gt;trap_count(reason);
 476       uint old_count   = total_count;
 477       total_count += md_count;
 478       // Saturate the add if it overflows.
 479       if (total_count &lt; old_count || total_count &lt; md_count)
 480         total_count = (uint)-1;
 481       C-&gt;set_trap_count(reason, total_count);
 482       if (log != NULL)
 483         log-&gt;elem(&quot;observe trap=&#39;%s&#39; count=&#39;%d&#39; total=&#39;%d&#39;&quot;,
 484                   Deoptimization::trap_reason_name(reason),
 485                   md_count, total_count);
 486     }
 487   }
 488   // Accumulate total sum of decompilations, also.
 489   C-&gt;set_decompile_count(C-&gt;decompile_count() + md-&gt;decompile_count());
 490 
 491   _count_invocations = C-&gt;do_count_invocations();
 492   _method_data_update = C-&gt;do_method_data_update();
 493 
 494   if (log != NULL &amp;&amp; method()-&gt;has_exception_handlers()) {
 495     log-&gt;elem(&quot;observe that=&#39;has_exception_handlers&#39;&quot;);
 496   }
 497 
 498   assert(InlineTree::check_can_parse(method()) == NULL, &quot;Can not parse this method, cutout earlier&quot;);
 499   assert(method()-&gt;has_balanced_monitors(), &quot;Can not parse unbalanced monitors, cutout earlier&quot;);
 500 
 501   // Always register dependence if JVMTI is enabled, because
 502   // either breakpoint setting or hotswapping of methods may
 503   // cause deoptimization.
 504   if (C-&gt;env()-&gt;jvmti_can_hotswap_or_post_breakpoint()) {
 505     C-&gt;dependencies()-&gt;assert_evol_method(method());
 506   }
 507 
 508   NOT_PRODUCT(methods_seen++);
 509 
 510   // Do some special top-level things.
 511   if (depth() == 1 &amp;&amp; C-&gt;is_osr_compilation()) {
 512     _entry_bci = C-&gt;entry_bci();
 513     _flow = method()-&gt;get_osr_flow_analysis(osr_bci());
 514     if (_flow-&gt;failing()) {
 515       C-&gt;record_method_not_compilable(_flow-&gt;failure_reason());
 516 #ifndef PRODUCT
 517       if (PrintOpto &amp;&amp; (Verbose || WizardMode)) {
 518         tty-&gt;print_cr(&quot;OSR @%d type flow bailout: %s&quot;, _entry_bci, _flow-&gt;failure_reason());
 519         if (Verbose) {
 520           method()-&gt;print();
 521           method()-&gt;print_codes();
 522           _flow-&gt;print();
 523         }
 524       }
 525 #endif
 526     }
 527     _tf = C-&gt;tf();     // the OSR entry type is different
 528   }
 529 
 530 #ifdef ASSERT
 531   if (depth() == 1) {
 532     assert(C-&gt;is_osr_compilation() == this-&gt;is_osr_parse(), &quot;OSR in sync&quot;);
 533   } else {
 534     assert(!this-&gt;is_osr_parse(), &quot;no recursive OSR&quot;);
 535   }
 536 #endif
 537 
 538 #ifndef PRODUCT
 539   methods_parsed++;
 540   // add method size here to guarantee that inlined methods are added too
 541   if (CITime)
 542     _total_bytes_compiled += method()-&gt;code_size();
 543 
 544   show_parse_info();
 545 #endif
 546 
 547   if (failing()) {
 548     if (log)  log-&gt;done(&quot;parse&quot;);
 549     return;
 550   }
 551 
 552   gvn().set_type(root(), root()-&gt;bottom_type());
 553   gvn().transform(top());
 554 
 555   // Import the results of the ciTypeFlow.
 556   init_blocks();
 557 
 558   // Merge point for all normal exits
 559   build_exits();
 560 
 561   // Setup the initial JVM state map.
 562   SafePointNode* entry_map = create_entry_map();
 563 
 564   // Check for bailouts during map initialization
 565   if (failing() || entry_map == NULL) {
 566     if (log)  log-&gt;done(&quot;parse&quot;);
 567     return;
 568   }
 569 
 570   Node_Notes* caller_nn = C-&gt;default_node_notes();
 571   // Collect debug info for inlined calls unless -XX:-DebugInlinedCalls.
 572   if (DebugInlinedCalls || depth() == 1) {
 573     C-&gt;set_default_node_notes(make_node_notes(caller_nn));
 574   }
 575 
 576   if (is_osr_parse()) {
 577     Node* osr_buf = entry_map-&gt;in(TypeFunc::Parms+0);
 578     entry_map-&gt;set_req(TypeFunc::Parms+0, top());
 579     set_map(entry_map);
 580     load_interpreter_state(osr_buf);
 581   } else {
 582     set_map(entry_map);
 583     do_method_entry();
 584     if (depth() == 1 &amp;&amp; C-&gt;age_code()) {
 585       decrement_age();
 586     }
 587   }
 588 
 589   if (depth() == 1 &amp;&amp; !failing()) {
 590     if (C-&gt;clinit_barrier_on_entry()) {
 591       // Add check to deoptimize the nmethod once the holder class is fully initialized
 592       clinit_deopt();
 593     }
 594 
 595     // Add check to deoptimize the nmethod if RTM state was changed
 596     rtm_deopt();
 597   }
 598 
 599   // Check for bailouts during method entry or RTM state check setup.
 600   if (failing()) {
 601     if (log)  log-&gt;done(&quot;parse&quot;);
 602     C-&gt;set_default_node_notes(caller_nn);
 603     return;
 604   }
 605 
 606   // Handle value type arguments
 607   int arg_size_sig = tf()-&gt;domain_sig()-&gt;cnt();
 608   for (uint i = 0; i &lt; (uint)arg_size_sig; i++) {
 609     Node* parm = map()-&gt;in(i);
 610     const Type* t = _gvn.type(parm);
 611     if (t-&gt;is_valuetypeptr() &amp;&amp; t-&gt;value_klass()-&gt;is_scalarizable() &amp;&amp; !t-&gt;maybe_null()) {
 612       // Create ValueTypeNode from the oop and replace the parameter
 613       Node* vt = ValueTypeNode::make_from_oop(this, parm, t-&gt;value_klass());
 614       map()-&gt;replace_edge(parm, vt);
 615     } else if (UseTypeSpeculation &amp;&amp; (i == (uint)(arg_size_sig - 1)) &amp;&amp; !is_osr_parse() &amp;&amp;
 616                method()-&gt;has_vararg() &amp;&amp; t-&gt;isa_aryptr() != NULL &amp;&amp; !t-&gt;is_aryptr()-&gt;is_not_null_free()) {
 617       // Speculate on varargs Object array being not null-free (and therefore also not flattened)
 618       const TypePtr* spec_type = t-&gt;speculative();
 619       spec_type = (spec_type != NULL &amp;&amp; spec_type-&gt;isa_aryptr() != NULL) ? spec_type : t-&gt;is_aryptr();
 620       spec_type = spec_type-&gt;remove_speculative()-&gt;is_aryptr()-&gt;cast_to_not_null_free();
 621       spec_type = TypeOopPtr::make(TypePtr::BotPTR, Type::Offset::bottom, TypeOopPtr::InstanceBot, spec_type);
 622       Node* cast = _gvn.transform(new CheckCastPPNode(control(), parm, t-&gt;join_speculative(spec_type)));
 623       replace_in_map(parm, cast);
 624     }
 625   }
 626 
 627   entry_map = map();  // capture any changes performed by method setup code
 628   assert(jvms()-&gt;endoff() == map()-&gt;req(), &quot;map matches JVMS layout&quot;);
 629 
 630   // We begin parsing as if we have just encountered a jump to the
 631   // method entry.
 632   Block* entry_block = start_block();
 633   assert(entry_block-&gt;start() == (is_osr_parse() ? osr_bci() : 0), &quot;&quot;);
 634   set_map_clone(entry_map);
 635   merge_common(entry_block, entry_block-&gt;next_path_num());
 636 
 637 #ifndef PRODUCT
 638   BytecodeParseHistogram *parse_histogram_obj = new (C-&gt;env()-&gt;arena()) BytecodeParseHistogram(this, C);
 639   set_parse_histogram( parse_histogram_obj );
 640 #endif
 641 
 642   // Parse all the basic blocks.
 643   do_all_blocks();
 644 
 645   C-&gt;set_default_node_notes(caller_nn);
 646 
 647   // Check for bailouts during conversion to graph
 648   if (failing()) {
 649     if (log)  log-&gt;done(&quot;parse&quot;);
 650     return;
 651   }
 652 
 653   // Fix up all exiting control flow.
 654   set_map(entry_map);
 655   do_exits();
 656 
 657   if (log)  log-&gt;done(&quot;parse nodes=&#39;%d&#39; live=&#39;%d&#39; memory=&#39;&quot; SIZE_FORMAT &quot;&#39;&quot;,
 658                       C-&gt;unique(), C-&gt;live_nodes(), C-&gt;node_arena()-&gt;used());
 659 }
 660 
 661 //---------------------------do_all_blocks-------------------------------------
 662 void Parse::do_all_blocks() {
 663   bool has_irreducible = flow()-&gt;has_irreducible_entry();
 664 
 665   // Walk over all blocks in Reverse Post-Order.
 666   while (true) {
 667     bool progress = false;
 668     for (int rpo = 0; rpo &lt; block_count(); rpo++) {
 669       Block* block = rpo_at(rpo);
 670 
 671       if (block-&gt;is_parsed()) continue;
 672 
 673       if (!block-&gt;is_merged()) {
 674         // Dead block, no state reaches this block
 675         continue;
 676       }
 677 
 678       // Prepare to parse this block.
 679       load_state_from(block);
 680 
 681       if (stopped()) {
 682         // Block is dead.
 683         continue;
 684       }
 685 
 686       NOT_PRODUCT(blocks_parsed++);
 687 
 688       progress = true;
 689       if (block-&gt;is_loop_head() || block-&gt;is_handler() || (has_irreducible &amp;&amp; !block-&gt;is_ready())) {
 690         // Not all preds have been parsed.  We must build phis everywhere.
 691         // (Note that dead locals do not get phis built, ever.)
 692         ensure_phis_everywhere();
 693 
 694         if (block-&gt;is_SEL_head()) {
 695           // Add predicate to single entry (not irreducible) loop head.
 696           assert(!block-&gt;has_merged_backedge(), &quot;only entry paths should be merged for now&quot;);
 697           // Predicates may have been added after a dominating if
 698           if (!block-&gt;has_predicates()) {
 699             // Need correct bci for predicate.
 700             // It is fine to set it here since do_one_block() will set it anyway.
 701             set_parse_bci(block-&gt;start());
 702             add_empty_predicates();
 703           }
 704           // Add new region for back branches.
 705           int edges = block-&gt;pred_count() - block-&gt;preds_parsed() + 1; // +1 for original region
 706           RegionNode *r = new RegionNode(edges+1);
 707           _gvn.set_type(r, Type::CONTROL);
 708           record_for_igvn(r);
 709           r-&gt;init_req(edges, control());
 710           set_control(r);
 711           // Add new phis.
 712           ensure_phis_everywhere();
 713         }
 714 
 715         // Leave behind an undisturbed copy of the map, for future merges.
 716         set_map(clone_map());
 717       }
 718 
 719       if (control()-&gt;is_Region() &amp;&amp; !block-&gt;is_loop_head() &amp;&amp; !has_irreducible &amp;&amp; !block-&gt;is_handler()) {
 720         // In the absence of irreducible loops, the Region and Phis
 721         // associated with a merge that doesn&#39;t involve a backedge can
 722         // be simplified now since the RPO parsing order guarantees
 723         // that any path which was supposed to reach here has already
 724         // been parsed or must be dead.
 725         Node* c = control();
 726         Node* result = _gvn.transform_no_reclaim(control());
 727         if (c != result &amp;&amp; TraceOptoParse) {
 728           tty-&gt;print_cr(&quot;Block #%d replace %d with %d&quot;, block-&gt;rpo(), c-&gt;_idx, result-&gt;_idx);
 729         }
 730         if (result != top()) {
 731           record_for_igvn(result);
 732         }
 733       }
 734 
 735       // Parse the block.
 736       do_one_block();
 737 
 738       // Check for bailouts.
 739       if (failing())  return;
 740     }
 741 
 742     // with irreducible loops multiple passes might be necessary to parse everything
 743     if (!has_irreducible || !progress) {
 744       break;
 745     }
 746   }
 747 
 748 #ifndef PRODUCT
 749   blocks_seen += block_count();
 750 
 751   // Make sure there are no half-processed blocks remaining.
 752   // Every remaining unprocessed block is dead and may be ignored now.
 753   for (int rpo = 0; rpo &lt; block_count(); rpo++) {
 754     Block* block = rpo_at(rpo);
 755     if (!block-&gt;is_parsed()) {
 756       if (TraceOptoParse) {
 757         tty-&gt;print_cr(&quot;Skipped dead block %d at bci:%d&quot;, rpo, block-&gt;start());
 758       }
 759       assert(!block-&gt;is_merged(), &quot;no half-processed blocks&quot;);
 760     }
 761   }
 762 #endif
 763 }
 764 
 765 static Node* mask_int_value(Node* v, BasicType bt, PhaseGVN* gvn) {
 766   switch (bt) {
 767   case T_BYTE:
 768     v = gvn-&gt;transform(new LShiftINode(v, gvn-&gt;intcon(24)));
 769     v = gvn-&gt;transform(new RShiftINode(v, gvn-&gt;intcon(24)));
 770     break;
 771   case T_SHORT:
 772     v = gvn-&gt;transform(new LShiftINode(v, gvn-&gt;intcon(16)));
 773     v = gvn-&gt;transform(new RShiftINode(v, gvn-&gt;intcon(16)));
 774     break;
 775   case T_CHAR:
 776     v = gvn-&gt;transform(new AndINode(v, gvn-&gt;intcon(0xFFFF)));
 777     break;
 778   case T_BOOLEAN:
 779     v = gvn-&gt;transform(new AndINode(v, gvn-&gt;intcon(0x1)));
 780     break;
 781   default:
 782     break;
 783   }
 784   return v;
 785 }
 786 
 787 //-------------------------------build_exits----------------------------------
 788 // Build normal and exceptional exit merge points.
 789 void Parse::build_exits() {
 790   // make a clone of caller to prevent sharing of side-effects
 791   _exits.set_map(_exits.clone_map());
 792   _exits.clean_stack(_exits.sp());
 793   _exits.sync_jvms();
 794 
 795   RegionNode* region = new RegionNode(1);
 796   record_for_igvn(region);
 797   gvn().set_type_bottom(region);
 798   _exits.set_control(region);
 799 
 800   // Note:  iophi and memphi are not transformed until do_exits.
 801   Node* iophi  = new PhiNode(region, Type::ABIO);
 802   Node* memphi = new PhiNode(region, Type::MEMORY, TypePtr::BOTTOM);
 803   gvn().set_type_bottom(iophi);
 804   gvn().set_type_bottom(memphi);
 805   _exits.set_i_o(iophi);
 806   _exits.set_all_memory(memphi);
 807 
 808   // Add a return value to the exit state.  (Do not push it yet.)
 809   if (tf()-&gt;range_sig()-&gt;cnt() &gt; TypeFunc::Parms) {
 810     const Type* ret_type = tf()-&gt;range_sig()-&gt;field_at(TypeFunc::Parms);
 811     if (ret_type-&gt;isa_int()) {
 812       BasicType ret_bt = method()-&gt;return_type()-&gt;basic_type();
 813       if (ret_bt == T_BOOLEAN ||
 814           ret_bt == T_CHAR ||
 815           ret_bt == T_BYTE ||
 816           ret_bt == T_SHORT) {
 817         ret_type = TypeInt::INT;
 818       }
 819     }
 820 
 821     // Don&#39;t &quot;bind&quot; an unloaded return klass to the ret_phi. If the klass
 822     // becomes loaded during the subsequent parsing, the loaded and unloaded
 823     // types will not join when we transform and push in do_exits().
 824     const TypeOopPtr* ret_oop_type = ret_type-&gt;isa_oopptr();
 825     if (ret_oop_type &amp;&amp; !ret_oop_type-&gt;klass()-&gt;is_loaded()) {
 826       ret_type = TypeOopPtr::BOTTOM;
 827     }
 828     if ((_caller-&gt;has_method() || tf()-&gt;returns_value_type_as_fields()) &amp;&amp;
 829         ret_type-&gt;is_valuetypeptr() &amp;&amp; ret_type-&gt;value_klass()-&gt;is_scalarizable() &amp;&amp; !ret_type-&gt;maybe_null()) {
 830       // Scalarize value type return when inlining or with multiple return values
 831       ret_type = TypeValueType::make(ret_type-&gt;value_klass());
 832     }
 833     int         ret_size = type2size[ret_type-&gt;basic_type()];
 834     Node*       ret_phi  = new PhiNode(region, ret_type);
 835     gvn().set_type_bottom(ret_phi);
 836     _exits.ensure_stack(ret_size);
 837     assert((int)(tf()-&gt;range_sig()-&gt;cnt() - TypeFunc::Parms) == ret_size, &quot;good tf range&quot;);
 838     assert(method()-&gt;return_type()-&gt;size() == ret_size, &quot;tf agrees w/ method&quot;);
 839     _exits.set_argument(0, ret_phi);  // here is where the parser finds it
 840     // Note:  ret_phi is not yet pushed, until do_exits.
 841   }
 842 }
 843 
 844 //----------------------------build_start_state-------------------------------
 845 // Construct a state which contains only the incoming arguments from an
 846 // unknown caller.  The method &amp; bci will be NULL &amp; InvocationEntryBci.
 847 JVMState* Compile::build_start_state(StartNode* start, const TypeFunc* tf) {
 848   int        arg_size = tf-&gt;domain_sig()-&gt;cnt();
 849   int        max_size = MAX2(arg_size, (int)tf-&gt;range_cc()-&gt;cnt());
 850   JVMState*  jvms     = new (this) JVMState(max_size - TypeFunc::Parms);
 851   SafePointNode* map  = new SafePointNode(max_size, NULL);
 852   map-&gt;set_jvms(jvms);
 853   jvms-&gt;set_map(map);
 854   record_for_igvn(map);
 855   assert(arg_size == TypeFunc::Parms + (is_osr_compilation() ? 1 : method()-&gt;arg_size()), &quot;correct arg_size&quot;);
 856   Node_Notes* old_nn = default_node_notes();
 857   if (old_nn != NULL &amp;&amp; has_method()) {
 858     Node_Notes* entry_nn = old_nn-&gt;clone(this);
 859     JVMState* entry_jvms = new(this) JVMState(method(), old_nn-&gt;jvms());
 860     entry_jvms-&gt;set_offsets(0);
 861     entry_jvms-&gt;set_bci(entry_bci());
 862     entry_nn-&gt;set_jvms(entry_jvms);
 863     set_default_node_notes(entry_nn);
 864   }
 865   PhaseGVN&amp; gvn = *initial_gvn();
 866   uint j = 0;
 867   ExtendedSignature sig_cc = ExtendedSignature(method()-&gt;get_sig_cc(), SigEntryFilter());
 868   for (uint i = 0; i &lt; (uint)arg_size; i++) {
 869     const Type* t = tf-&gt;domain_sig()-&gt;field_at(i);
 870     Node* parm = NULL;
 871     if (has_scalarized_args() &amp;&amp; t-&gt;is_valuetypeptr() &amp;&amp; !t-&gt;maybe_null()) {
 872       // Value type arguments are not passed by reference: we get an argument per
 873       // field of the value type. Build ValueTypeNodes from the value type arguments.
 874       GraphKit kit(jvms, &amp;gvn);
 875       kit.set_control(map-&gt;control());
 876       Node* old_mem = map-&gt;memory();
 877       // Use immutable memory for value type loads and restore it below
 878       // TODO make sure value types are always loaded from immutable memory
 879       kit.set_all_memory(C-&gt;immutable_memory());
 880       parm = ValueTypeNode::make_from_multi(&amp;kit, start, sig_cc, t-&gt;value_klass(), j, true);
 881       map-&gt;set_control(kit.control());
 882       map-&gt;set_memory(old_mem);
 883     } else {
 884       parm = gvn.transform(new ParmNode(start, j++));
 885       BasicType bt = t-&gt;basic_type();
 886       while (i &gt;= TypeFunc::Parms &amp;&amp; !is_osr_compilation() &amp;&amp; SigEntry::next_is_reserved(sig_cc, bt, true)) {
 887         j += type2size[bt]; // Skip reserved arguments
 888       }
 889     }
 890     map-&gt;init_req(i, parm);
 891     // Record all these guys for later GVN.
 892     record_for_igvn(parm);
 893   }
 894   for (; j &lt; map-&gt;req(); j++) {
 895     map-&gt;init_req(j, top());
 896   }
 897   assert(jvms-&gt;argoff() == TypeFunc::Parms, &quot;parser gets arguments here&quot;);
 898   set_default_node_notes(old_nn);
 899   return jvms;
 900 }
 901 
 902 //-----------------------------make_node_notes---------------------------------
 903 Node_Notes* Parse::make_node_notes(Node_Notes* caller_nn) {
 904   if (caller_nn == NULL)  return NULL;
 905   Node_Notes* nn = caller_nn-&gt;clone(C);
 906   JVMState* caller_jvms = nn-&gt;jvms();
 907   JVMState* jvms = new (C) JVMState(method(), caller_jvms);
 908   jvms-&gt;set_offsets(0);
 909   jvms-&gt;set_bci(_entry_bci);
 910   nn-&gt;set_jvms(jvms);
 911   return nn;
 912 }
 913 
 914 
 915 //--------------------------return_values--------------------------------------
 916 void Compile::return_values(JVMState* jvms) {
 917   GraphKit kit(jvms);
 918   Node* ret = new ReturnNode(TypeFunc::Parms,
 919                              kit.control(),
 920                              kit.i_o(),
 921                              kit.reset_memory(),
 922                              kit.frameptr(),
 923                              kit.returnadr());
 924   // Add zero or 1 return values
 925   int ret_size = tf()-&gt;range_sig()-&gt;cnt() - TypeFunc::Parms;
 926   if (ret_size &gt; 0) {
 927     kit.inc_sp(-ret_size);  // pop the return value(s)
 928     kit.sync_jvms();
 929     Node* res = kit.argument(0);
 930     if (tf()-&gt;returns_value_type_as_fields()) {
 931       // Multiple return values (value type fields): add as many edges
 932       // to the Return node as returned values.
 933       assert(res-&gt;is_ValueType(), &quot;what else supports multi value return?&quot;);
 934       ValueTypeNode* vt = res-&gt;as_ValueType();
 935       ret-&gt;add_req_batch(NULL, tf()-&gt;range_cc()-&gt;cnt() - TypeFunc::Parms);
 936       if (vt-&gt;is_allocated(&amp;kit.gvn()) &amp;&amp; !StressInlineTypeReturnedAsFields) {
 937         ret-&gt;init_req(TypeFunc::Parms, vt-&gt;get_oop());
 938       } else {
 939         ret-&gt;init_req(TypeFunc::Parms, vt-&gt;tagged_klass(kit.gvn()));
 940       }
 941       const Array&lt;SigEntry&gt;* sig_array = vt-&gt;type()-&gt;value_klass()-&gt;extended_sig();
 942       GrowableArray&lt;SigEntry&gt; sig = GrowableArray&lt;SigEntry&gt;(sig_array-&gt;length());
 943       sig.appendAll(sig_array);
 944       ExtendedSignature sig_cc = ExtendedSignature(&amp;sig, SigEntryFilter());
 945       uint idx = TypeFunc::Parms+1;
 946       vt-&gt;pass_fields(&amp;kit, ret, sig_cc, idx);
 947     } else {
 948       ret-&gt;add_req(res);
 949       // Note:  The second dummy edge is not needed by a ReturnNode.
 950     }
 951   }
 952   // bind it to root
 953   root()-&gt;add_req(ret);
 954   record_for_igvn(ret);
 955   initial_gvn()-&gt;transform_no_reclaim(ret);
 956 }
 957 
 958 //------------------------rethrow_exceptions-----------------------------------
 959 // Bind all exception states in the list into a single RethrowNode.
 960 void Compile::rethrow_exceptions(JVMState* jvms) {
 961   GraphKit kit(jvms);
 962   if (!kit.has_exceptions())  return;  // nothing to generate
 963   // Load my combined exception state into the kit, with all phis transformed:
 964   SafePointNode* ex_map = kit.combine_and_pop_all_exception_states();
 965   Node* ex_oop = kit.use_exception_state(ex_map);
 966   RethrowNode* exit = new RethrowNode(kit.control(),
 967                                       kit.i_o(), kit.reset_memory(),
 968                                       kit.frameptr(), kit.returnadr(),
 969                                       // like a return but with exception input
 970                                       ex_oop);
 971   // bind to root
 972   root()-&gt;add_req(exit);
 973   record_for_igvn(exit);
 974   initial_gvn()-&gt;transform_no_reclaim(exit);
 975 }
 976 
 977 //---------------------------do_exceptions-------------------------------------
 978 // Process exceptions arising from the current bytecode.
 979 // Send caught exceptions to the proper handler within this method.
 980 // Unhandled exceptions feed into _exit.
 981 void Parse::do_exceptions() {
 982   if (!has_exceptions())  return;
 983 
 984   if (failing()) {
 985     // Pop them all off and throw them away.
 986     while (pop_exception_state() != NULL) ;
 987     return;
 988   }
 989 
 990   PreserveJVMState pjvms(this, false);
 991 
 992   SafePointNode* ex_map;
 993   while ((ex_map = pop_exception_state()) != NULL) {
 994     if (!method()-&gt;has_exception_handlers()) {
 995       // Common case:  Transfer control outward.
 996       // Doing it this early allows the exceptions to common up
 997       // even between adjacent method calls.
 998       throw_to_exit(ex_map);
 999     } else {
1000       // Have to look at the exception first.
1001       assert(stopped(), &quot;catch_inline_exceptions trashes the map&quot;);
1002       catch_inline_exceptions(ex_map);
1003       stop_and_kill_map();      // we used up this exception state; kill it
1004     }
1005   }
1006 
1007   // We now return to our regularly scheduled program:
1008 }
1009 
1010 //---------------------------throw_to_exit-------------------------------------
1011 // Merge the given map into an exception exit from this method.
1012 // The exception exit will handle any unlocking of receiver.
1013 // The ex_oop must be saved within the ex_map, unlike merge_exception.
1014 void Parse::throw_to_exit(SafePointNode* ex_map) {
1015   // Pop the JVMS to (a copy of) the caller.
1016   GraphKit caller;
1017   caller.set_map_clone(_caller-&gt;map());
1018   caller.set_bci(_caller-&gt;bci());
1019   caller.set_sp(_caller-&gt;sp());
1020   // Copy out the standard machine state:
1021   for (uint i = 0; i &lt; TypeFunc::Parms; i++) {
1022     caller.map()-&gt;set_req(i, ex_map-&gt;in(i));
1023   }
1024   if (ex_map-&gt;has_replaced_nodes()) {
1025     _replaced_nodes_for_exceptions = true;
1026   }
1027   caller.map()-&gt;transfer_replaced_nodes_from(ex_map, _new_idx);
1028   // ...and the exception:
1029   Node*          ex_oop        = saved_ex_oop(ex_map);
1030   SafePointNode* caller_ex_map = caller.make_exception_state(ex_oop);
1031   // Finally, collect the new exception state in my exits:
1032   _exits.add_exception_state(caller_ex_map);
1033 }
1034 
1035 //------------------------------do_exits---------------------------------------
1036 void Parse::do_exits() {
1037   set_parse_bci(InvocationEntryBci);
1038 
1039   // Now peephole on the return bits
1040   Node* region = _exits.control();
1041   _exits.set_control(gvn().transform(region));
1042 
1043   Node* iophi = _exits.i_o();
1044   _exits.set_i_o(gvn().transform(iophi));
1045 
1046   // Figure out if we need to emit the trailing barrier. The barrier is only
1047   // needed in the constructors, and only in three cases:
1048   //
1049   // 1. The constructor wrote a final. The effects of all initializations
1050   //    must be committed to memory before any code after the constructor
1051   //    publishes the reference to the newly constructed object. Rather
1052   //    than wait for the publication, we simply block the writes here.
1053   //    Rather than put a barrier on only those writes which are required
1054   //    to complete, we force all writes to complete.
1055   //
1056   // 2. Experimental VM option is used to force the barrier if any field
1057   //    was written out in the constructor.
1058   //
1059   // 3. On processors which are not CPU_MULTI_COPY_ATOMIC (e.g. PPC64),
1060   //    support_IRIW_for_not_multiple_copy_atomic_cpu selects that
1061   //    MemBarVolatile is used before volatile load instead of after volatile
1062   //    store, so there&#39;s no barrier after the store.
1063   //    We want to guarantee the same behavior as on platforms with total store
1064   //    order, although this is not required by the Java memory model.
1065   //    In this case, we want to enforce visibility of volatile field
1066   //    initializations which are performed in constructors.
1067   //    So as with finals, we add a barrier here.
1068   //
1069   // &quot;All bets are off&quot; unless the first publication occurs after a
1070   // normal return from the constructor.  We do not attempt to detect
1071   // such unusual early publications.  But no barrier is needed on
1072   // exceptional returns, since they cannot publish normally.
1073   //
1074   if (method()-&gt;is_object_constructor_or_class_initializer() &amp;&amp;
1075        (wrote_final() ||
1076          (AlwaysSafeConstructors &amp;&amp; wrote_fields()) ||
1077          (support_IRIW_for_not_multiple_copy_atomic_cpu &amp;&amp; wrote_volatile()))) {
1078     _exits.insert_mem_bar(Op_MemBarRelease, alloc_with_final());
1079 
1080     // If Memory barrier is created for final fields write
1081     // and allocation node does not escape the initialize method,
1082     // then barrier introduced by allocation node can be removed.
1083     if (DoEscapeAnalysis &amp;&amp; alloc_with_final()) {
1084       AllocateNode *alloc = AllocateNode::Ideal_allocation(alloc_with_final(), &amp;_gvn);
1085       alloc-&gt;compute_MemBar_redundancy(method());
1086     }
1087     if (PrintOpto &amp;&amp; (Verbose || WizardMode)) {
1088       method()-&gt;print_name();
1089       tty-&gt;print_cr(&quot; writes finals and needs a memory barrier&quot;);
1090     }
1091   }
1092 
1093   // Any method can write a @Stable field; insert memory barriers
1094   // after those also. Can&#39;t bind predecessor allocation node (if any)
1095   // with barrier because allocation doesn&#39;t always dominate
1096   // MemBarRelease.
1097   if (wrote_stable()) {
1098     _exits.insert_mem_bar(Op_MemBarRelease);
1099     if (PrintOpto &amp;&amp; (Verbose || WizardMode)) {
1100       method()-&gt;print_name();
1101       tty-&gt;print_cr(&quot; writes @Stable and needs a memory barrier&quot;);
1102     }
1103   }
1104 
1105   for (MergeMemStream mms(_exits.merged_memory()); mms.next_non_empty(); ) {
1106     // transform each slice of the original memphi:
1107     mms.set_memory(_gvn.transform(mms.memory()));
1108   }
1109   // Clean up input MergeMems created by transforming the slices
1110   _gvn.transform(_exits.merged_memory());
1111 
1112   if (tf()-&gt;range_sig()-&gt;cnt() &gt; TypeFunc::Parms) {
1113     const Type* ret_type = tf()-&gt;range_sig()-&gt;field_at(TypeFunc::Parms);
1114     Node*       ret_phi  = _gvn.transform( _exits.argument(0) );
1115     if (!_exits.control()-&gt;is_top() &amp;&amp; _gvn.type(ret_phi)-&gt;empty()) {
1116       // If the type we set for the ret_phi in build_exits() is too optimistic and
1117       // the ret_phi is top now, there&#39;s an extremely small chance that it may be due to class
1118       // loading.  It could also be due to an error, so mark this method as not compilable because
1119       // otherwise this could lead to an infinite compile loop.
1120       // In any case, this code path is rarely (and never in my testing) reached.
1121       C-&gt;record_method_not_compilable(&quot;Can&#39;t determine return type.&quot;);
1122       return;
1123     }
1124     if (ret_type-&gt;isa_int()) {
1125       BasicType ret_bt = method()-&gt;return_type()-&gt;basic_type();
1126       ret_phi = mask_int_value(ret_phi, ret_bt, &amp;_gvn);
1127     }
1128     _exits.push_node(ret_type-&gt;basic_type(), ret_phi);
1129   }
1130 
1131   // Note:  Logic for creating and optimizing the ReturnNode is in Compile.
1132 
1133   // Unlock along the exceptional paths.
1134   // This is done late so that we can common up equivalent exceptions
1135   // (e.g., null checks) arising from multiple points within this method.
1136   // See GraphKit::add_exception_state, which performs the commoning.
1137   bool do_synch = method()-&gt;is_synchronized() &amp;&amp; GenerateSynchronizationCode;
1138 
1139   // record exit from a method if compiled while Dtrace is turned on.
1140   if (do_synch || C-&gt;env()-&gt;dtrace_method_probes() || _replaced_nodes_for_exceptions) {
1141     // First move the exception list out of _exits:
1142     GraphKit kit(_exits.transfer_exceptions_into_jvms());
1143     SafePointNode* normal_map = kit.map();  // keep this guy safe
1144     // Now re-collect the exceptions into _exits:
1145     SafePointNode* ex_map;
1146     while ((ex_map = kit.pop_exception_state()) != NULL) {
1147       Node* ex_oop = kit.use_exception_state(ex_map);
1148       // Force the exiting JVM state to have this method at InvocationEntryBci.
1149       // The exiting JVM state is otherwise a copy of the calling JVMS.
1150       JVMState* caller = kit.jvms();
1151       JVMState* ex_jvms = caller-&gt;clone_shallow(C);
1152       ex_jvms-&gt;set_map(kit.clone_map());
1153       ex_jvms-&gt;map()-&gt;set_jvms(ex_jvms);
1154       ex_jvms-&gt;set_bci(   InvocationEntryBci);
1155       kit.set_jvms(ex_jvms);
1156       if (do_synch) {
1157         // Add on the synchronized-method box/object combo
1158         kit.map()-&gt;push_monitor(_synch_lock);
1159         // Unlock!
1160         kit.shared_unlock(_synch_lock-&gt;box_node(), _synch_lock-&gt;obj_node());
1161       }
1162       if (C-&gt;env()-&gt;dtrace_method_probes()) {
1163         kit.make_dtrace_method_exit(method());
1164       }
1165       if (_replaced_nodes_for_exceptions) {
1166         kit.map()-&gt;apply_replaced_nodes(_new_idx);
1167       }
1168       // Done with exception-path processing.
1169       ex_map = kit.make_exception_state(ex_oop);
1170       assert(ex_jvms-&gt;same_calls_as(ex_map-&gt;jvms()), &quot;sanity&quot;);
1171       // Pop the last vestige of this method:
1172       ex_map-&gt;set_jvms(caller-&gt;clone_shallow(C));
1173       ex_map-&gt;jvms()-&gt;set_map(ex_map);
1174       _exits.push_exception_state(ex_map);
1175     }
1176     assert(_exits.map() == normal_map, &quot;keep the same return state&quot;);
1177   }
1178 
1179   {
1180     // Capture very early exceptions (receiver null checks) from caller JVMS
1181     GraphKit caller(_caller);
1182     SafePointNode* ex_map;
1183     while ((ex_map = caller.pop_exception_state()) != NULL) {
1184       _exits.add_exception_state(ex_map);
1185     }
1186   }
1187   _exits.map()-&gt;apply_replaced_nodes(_new_idx);
1188 }
1189 
1190 //-----------------------------create_entry_map-------------------------------
1191 // Initialize our parser map to contain the types at method entry.
1192 // For OSR, the map contains a single RawPtr parameter.
1193 // Initial monitor locking for sync. methods is performed by do_method_entry.
1194 SafePointNode* Parse::create_entry_map() {
1195   // Check for really stupid bail-out cases.
1196   uint len = TypeFunc::Parms + method()-&gt;max_locals() + method()-&gt;max_stack();
1197   if (len &gt;= 32760) {
1198     C-&gt;record_method_not_compilable(&quot;too many local variables&quot;);
1199     return NULL;
1200   }
1201 
1202   // clear current replaced nodes that are of no use from here on (map was cloned in build_exits).
1203   _caller-&gt;map()-&gt;delete_replaced_nodes();
1204 
1205   // If this is an inlined method, we may have to do a receiver null check.
1206   if (_caller-&gt;has_method() &amp;&amp; is_normal_parse() &amp;&amp; !method()-&gt;is_static()) {
1207     GraphKit kit(_caller);
1208     kit.null_check_receiver_before_call(method(), false);
1209     _caller = kit.transfer_exceptions_into_jvms();
1210     if (kit.stopped()) {
1211       _exits.add_exception_states_from(_caller);
1212       _exits.set_jvms(_caller);
1213       return NULL;
1214     }
1215   }
1216 
1217   assert(method() != NULL, &quot;parser must have a method&quot;);
1218 
1219   // Create an initial safepoint to hold JVM state during parsing
1220   JVMState* jvms = new (C) JVMState(method(), _caller-&gt;has_method() ? _caller : NULL);
1221   set_map(new SafePointNode(len, jvms));
1222   jvms-&gt;set_map(map());
1223   record_for_igvn(map());
1224   assert(jvms-&gt;endoff() == len, &quot;correct jvms sizing&quot;);
1225 
1226   SafePointNode* inmap = _caller-&gt;map();
1227   assert(inmap != NULL, &quot;must have inmap&quot;);
1228   // In case of null check on receiver above
1229   map()-&gt;transfer_replaced_nodes_from(inmap, _new_idx);
1230 
1231   uint i;
1232 
1233   // Pass thru the predefined input parameters.
1234   for (i = 0; i &lt; TypeFunc::Parms; i++) {
1235     map()-&gt;init_req(i, inmap-&gt;in(i));
1236   }
1237 
1238   if (depth() == 1) {
1239     assert(map()-&gt;memory()-&gt;Opcode() == Op_Parm, &quot;&quot;);
1240     // Insert the memory aliasing node
1241     set_all_memory(reset_memory());
1242   }
1243   assert(merged_memory(), &quot;&quot;);
1244 
1245   // Now add the locals which are initially bound to arguments:
1246   uint arg_size = tf()-&gt;domain_sig()-&gt;cnt();
1247   ensure_stack(arg_size - TypeFunc::Parms);  // OSR methods have funny args
1248   for (i = TypeFunc::Parms; i &lt; arg_size; i++) {
1249     map()-&gt;init_req(i, inmap-&gt;argument(_caller, i - TypeFunc::Parms));
1250   }
1251 
1252   // Clear out the rest of the map (locals and stack)
1253   for (i = arg_size; i &lt; len; i++) {
1254     map()-&gt;init_req(i, top());
1255   }
1256 
1257   SafePointNode* entry_map = stop();
1258   return entry_map;
1259 }
1260 
1261 //-----------------------------do_method_entry--------------------------------
1262 // Emit any code needed in the pseudo-block before BCI zero.
1263 // The main thing to do is lock the receiver of a synchronized method.
1264 void Parse::do_method_entry() {
1265   set_parse_bci(InvocationEntryBci); // Pseudo-BCP
1266   set_sp(0);                         // Java Stack Pointer
1267 
1268   NOT_PRODUCT( count_compiled_calls(true/*at_method_entry*/, false/*is_inline*/); )
1269 
1270   if (C-&gt;env()-&gt;dtrace_method_probes()) {
1271     make_dtrace_method_entry(method());
1272   }
1273 
1274   // If the method is synchronized, we need to construct a lock node, attach
1275   // it to the Start node, and pin it there.
1276   if (method()-&gt;is_synchronized()) {
1277     // Insert a FastLockNode right after the Start which takes as arguments
1278     // the current thread pointer, the &quot;this&quot; pointer &amp; the address of the
1279     // stack slot pair used for the lock.  The &quot;this&quot; pointer is a projection
1280     // off the start node, but the locking spot has to be constructed by
1281     // creating a ConLNode of 0, and boxing it with a BoxLockNode.  The BoxLockNode
1282     // becomes the second argument to the FastLockNode call.  The
1283     // FastLockNode becomes the new control parent to pin it to the start.
1284 
1285     // Setup Object Pointer
1286     Node *lock_obj = NULL;
1287     if(method()-&gt;is_static()) {
1288       ciInstance* mirror = _method-&gt;holder()-&gt;java_mirror();
1289       const TypeInstPtr *t_lock = TypeInstPtr::make(mirror);
1290       lock_obj = makecon(t_lock);
1291     } else {                  // Else pass the &quot;this&quot; pointer,
1292       lock_obj = local(0);    // which is Parm0 from StartNode
1293       assert(!_gvn.type(lock_obj)-&gt;make_oopptr()-&gt;can_be_value_type(), &quot;can&#39;t be an inline type&quot;);
1294     }
1295     // Clear out dead values from the debug info.
1296     kill_dead_locals();
1297     // Build the FastLockNode
1298     _synch_lock = shared_lock(lock_obj);
1299   }
1300 
1301   // Feed profiling data for parameters to the type system so it can
1302   // propagate it as speculative types
1303   record_profiled_parameters_for_speculation();
1304 
1305   if (depth() == 1) {
1306     increment_and_test_invocation_counter(Tier2CompileThreshold);
1307   }
1308 }
1309 
1310 //------------------------------init_blocks------------------------------------
1311 // Initialize our parser map to contain the types/monitors at method entry.
1312 void Parse::init_blocks() {
1313   // Create the blocks.
1314   _block_count = flow()-&gt;block_count();
1315   _blocks = NEW_RESOURCE_ARRAY(Block, _block_count);
1316 
1317   // Initialize the structs.
1318   for (int rpo = 0; rpo &lt; block_count(); rpo++) {
1319     Block* block = rpo_at(rpo);
1320     new(block) Block(this, rpo);
1321   }
1322 
1323   // Collect predecessor and successor information.
1324   for (int rpo = 0; rpo &lt; block_count(); rpo++) {
1325     Block* block = rpo_at(rpo);
1326     block-&gt;init_graph(this);
1327   }
1328 }
1329 
1330 //-------------------------------init_node-------------------------------------
1331 Parse::Block::Block(Parse* outer, int rpo) : _live_locals() {
1332   _flow = outer-&gt;flow()-&gt;rpo_at(rpo);
1333   _pred_count = 0;
1334   _preds_parsed = 0;
1335   _count = 0;
1336   _is_parsed = false;
1337   _is_handler = false;
1338   _has_merged_backedge = false;
1339   _start_map = NULL;
1340   _has_predicates = false;
1341   _num_successors = 0;
1342   _all_successors = 0;
1343   _successors = NULL;
1344   assert(pred_count() == 0 &amp;&amp; preds_parsed() == 0, &quot;sanity&quot;);
1345   assert(!(is_merged() || is_parsed() || is_handler() || has_merged_backedge()), &quot;sanity&quot;);
1346   assert(_live_locals.size() == 0, &quot;sanity&quot;);
1347 
1348   // entry point has additional predecessor
1349   if (flow()-&gt;is_start())  _pred_count++;
1350   assert(flow()-&gt;is_start() == (this == outer-&gt;start_block()), &quot;&quot;);
1351 }
1352 
1353 //-------------------------------init_graph------------------------------------
1354 void Parse::Block::init_graph(Parse* outer) {
1355   // Create the successor list for this parser block.
1356   GrowableArray&lt;ciTypeFlow::Block*&gt;* tfs = flow()-&gt;successors();
1357   GrowableArray&lt;ciTypeFlow::Block*&gt;* tfe = flow()-&gt;exceptions();
1358   int ns = tfs-&gt;length();
1359   int ne = tfe-&gt;length();
1360   _num_successors = ns;
1361   _all_successors = ns+ne;
1362   _successors = (ns+ne == 0) ? NULL : NEW_RESOURCE_ARRAY(Block*, ns+ne);
1363   int p = 0;
1364   for (int i = 0; i &lt; ns+ne; i++) {
1365     ciTypeFlow::Block* tf2 = (i &lt; ns) ? tfs-&gt;at(i) : tfe-&gt;at(i-ns);
1366     Block* block2 = outer-&gt;rpo_at(tf2-&gt;rpo());
1367     _successors[i] = block2;
1368 
1369     // Accumulate pred info for the other block, too.
1370     // Note: We also need to set _pred_count for exception blocks since they could
1371     // also have normal predecessors (reached without athrow by an explicit jump).
1372     // This also means that next_path_num can be called along exception paths.
1373     block2-&gt;_pred_count++;
1374     if (i &gt;= ns) {
1375       block2-&gt;_is_handler = true;
1376     }
1377 
1378     #ifdef ASSERT
1379     // A block&#39;s successors must be distinguishable by BCI.
1380     // That is, no bytecode is allowed to branch to two different
1381     // clones of the same code location.
1382     for (int j = 0; j &lt; i; j++) {
1383       Block* block1 = _successors[j];
1384       if (block1 == block2)  continue;  // duplicates are OK
1385       assert(block1-&gt;start() != block2-&gt;start(), &quot;successors have unique bcis&quot;);
1386     }
1387     #endif
1388   }
1389 }
1390 
1391 //---------------------------successor_for_bci---------------------------------
1392 Parse::Block* Parse::Block::successor_for_bci(int bci) {
1393   for (int i = 0; i &lt; all_successors(); i++) {
1394     Block* block2 = successor_at(i);
1395     if (block2-&gt;start() == bci)  return block2;
1396   }
1397   // We can actually reach here if ciTypeFlow traps out a block
1398   // due to an unloaded class, and concurrently with compilation the
1399   // class is then loaded, so that a later phase of the parser is
1400   // able to see more of the bytecode CFG.  Or, the flow pass and
1401   // the parser can have a minor difference of opinion about executability
1402   // of bytecodes.  For example, &quot;obj.field = null&quot; is executable even
1403   // if the field&#39;s type is an unloaded class; the flow pass used to
1404   // make a trap for such code.
1405   return NULL;
1406 }
1407 
1408 
1409 //-----------------------------stack_type_at-----------------------------------
1410 const Type* Parse::Block::stack_type_at(int i) const {
1411   return get_type(flow()-&gt;stack_type_at(i));
1412 }
1413 
1414 
1415 //-----------------------------local_type_at-----------------------------------
1416 const Type* Parse::Block::local_type_at(int i) const {
1417   // Make dead locals fall to bottom.
1418   if (_live_locals.size() == 0) {
1419     MethodLivenessResult live_locals = flow()-&gt;outer()-&gt;method()-&gt;liveness_at_bci(start());
1420     // This bitmap can be zero length if we saw a breakpoint.
1421     // In such cases, pretend they are all live.
1422     ((Block*)this)-&gt;_live_locals = live_locals;
1423   }
1424   if (_live_locals.size() &gt; 0 &amp;&amp; !_live_locals.at(i))
1425     return Type::BOTTOM;
1426 
1427   return get_type(flow()-&gt;local_type_at(i));
1428 }
1429 
1430 
1431 #ifndef PRODUCT
1432 
1433 //----------------------------name_for_bc--------------------------------------
1434 // helper method for BytecodeParseHistogram
1435 static const char* name_for_bc(int i) {
1436   return Bytecodes::is_defined(i) ? Bytecodes::name(Bytecodes::cast(i)) : &quot;xxxunusedxxx&quot;;
1437 }
1438 
1439 //----------------------------BytecodeParseHistogram------------------------------------
1440 Parse::BytecodeParseHistogram::BytecodeParseHistogram(Parse *p, Compile *c) {
1441   _parser   = p;
1442   _compiler = c;
1443   if( ! _initialized ) { _initialized = true; reset(); }
1444 }
1445 
1446 //----------------------------current_count------------------------------------
1447 int Parse::BytecodeParseHistogram::current_count(BPHType bph_type) {
1448   switch( bph_type ) {
1449   case BPH_transforms: { return _parser-&gt;gvn().made_progress(); }
1450   case BPH_values:     { return _parser-&gt;gvn().made_new_values(); }
1451   default: { ShouldNotReachHere(); return 0; }
1452   }
1453 }
1454 
1455 //----------------------------initialized--------------------------------------
1456 bool Parse::BytecodeParseHistogram::initialized() { return _initialized; }
1457 
1458 //----------------------------reset--------------------------------------------
1459 void Parse::BytecodeParseHistogram::reset() {
1460   int i = Bytecodes::number_of_codes;
1461   while (i-- &gt; 0) { _bytecodes_parsed[i] = 0; _nodes_constructed[i] = 0; _nodes_transformed[i] = 0; _new_values[i] = 0; }
1462 }
1463 
1464 //----------------------------set_initial_state--------------------------------
1465 // Record info when starting to parse one bytecode
1466 void Parse::BytecodeParseHistogram::set_initial_state( Bytecodes::Code bc ) {
1467   if( PrintParseStatistics &amp;&amp; !_parser-&gt;is_osr_parse() ) {
1468     _initial_bytecode    = bc;
1469     _initial_node_count  = _compiler-&gt;unique();
1470     _initial_transforms  = current_count(BPH_transforms);
1471     _initial_values      = current_count(BPH_values);
1472   }
1473 }
1474 
1475 //----------------------------record_change--------------------------------
1476 // Record results of parsing one bytecode
1477 void Parse::BytecodeParseHistogram::record_change() {
1478   if( PrintParseStatistics &amp;&amp; !_parser-&gt;is_osr_parse() ) {
1479     ++_bytecodes_parsed[_initial_bytecode];
1480     _nodes_constructed [_initial_bytecode] += (_compiler-&gt;unique() - _initial_node_count);
1481     _nodes_transformed [_initial_bytecode] += (current_count(BPH_transforms) - _initial_transforms);
1482     _new_values        [_initial_bytecode] += (current_count(BPH_values)     - _initial_values);
1483   }
1484 }
1485 
1486 
1487 //----------------------------print--------------------------------------------
1488 void Parse::BytecodeParseHistogram::print(float cutoff) {
1489   ResourceMark rm;
1490   // print profile
1491   int total  = 0;
1492   int i      = 0;
1493   for( i = 0; i &lt; Bytecodes::number_of_codes; ++i ) { total += _bytecodes_parsed[i]; }
1494   int abs_sum = 0;
1495   tty-&gt;cr();   //0123456789012345678901234567890123456789012345678901234567890123456789
1496   tty-&gt;print_cr(&quot;Histogram of %d parsed bytecodes:&quot;, total);
1497   if( total == 0 ) { return; }
1498   tty-&gt;cr();
1499   tty-&gt;print_cr(&quot;absolute:  count of compiled bytecodes of this type&quot;);
1500   tty-&gt;print_cr(&quot;relative:  percentage contribution to compiled nodes&quot;);
1501   tty-&gt;print_cr(&quot;nodes   :  Average number of nodes constructed per bytecode&quot;);
1502   tty-&gt;print_cr(&quot;rnodes  :  Significance towards total nodes constructed, (nodes*relative)&quot;);
1503   tty-&gt;print_cr(&quot;transforms: Average amount of tranform progress per bytecode compiled&quot;);
1504   tty-&gt;print_cr(&quot;values  :  Average number of node values improved per bytecode&quot;);
1505   tty-&gt;print_cr(&quot;name    :  Bytecode name&quot;);
1506   tty-&gt;cr();
1507   tty-&gt;print_cr(&quot;  absolute  relative   nodes  rnodes  transforms  values   name&quot;);
1508   tty-&gt;print_cr(&quot;----------------------------------------------------------------------&quot;);
1509   while (--i &gt; 0) {
1510     int       abs = _bytecodes_parsed[i];
1511     float     rel = abs * 100.0F / total;
1512     float   nodes = _bytecodes_parsed[i] == 0 ? 0 : (1.0F * _nodes_constructed[i])/_bytecodes_parsed[i];
1513     float  rnodes = _bytecodes_parsed[i] == 0 ? 0 :  rel * nodes;
1514     float  xforms = _bytecodes_parsed[i] == 0 ? 0 : (1.0F * _nodes_transformed[i])/_bytecodes_parsed[i];
1515     float  values = _bytecodes_parsed[i] == 0 ? 0 : (1.0F * _new_values       [i])/_bytecodes_parsed[i];
1516     if (cutoff &lt;= rel) {
1517       tty-&gt;print_cr(&quot;%10d  %7.2f%%  %6.1f  %6.2f   %6.1f   %6.1f     %s&quot;, abs, rel, nodes, rnodes, xforms, values, name_for_bc(i));
1518       abs_sum += abs;
1519     }
1520   }
1521   tty-&gt;print_cr(&quot;----------------------------------------------------------------------&quot;);
1522   float rel_sum = abs_sum * 100.0F / total;
1523   tty-&gt;print_cr(&quot;%10d  %7.2f%%    (cutoff = %.2f%%)&quot;, abs_sum, rel_sum, cutoff);
1524   tty-&gt;print_cr(&quot;----------------------------------------------------------------------&quot;);
1525   tty-&gt;cr();
1526 }
1527 #endif
1528 
1529 //----------------------------load_state_from----------------------------------
1530 // Load block/map/sp.  But not do not touch iter/bci.
1531 void Parse::load_state_from(Block* block) {
1532   set_block(block);
1533   // load the block&#39;s JVM state:
1534   set_map(block-&gt;start_map());
1535   set_sp( block-&gt;start_sp());
1536 }
1537 
1538 
1539 //-----------------------------record_state------------------------------------
1540 void Parse::Block::record_state(Parse* p) {
1541   assert(!is_merged(), &quot;can only record state once, on 1st inflow&quot;);
1542   assert(start_sp() == p-&gt;sp(), &quot;stack pointer must agree with ciTypeFlow&quot;);
1543   set_start_map(p-&gt;stop());
1544 }
1545 
1546 
1547 //------------------------------do_one_block-----------------------------------
1548 void Parse::do_one_block() {
1549   if (TraceOptoParse) {
1550     Block *b = block();
1551     int ns = b-&gt;num_successors();
1552     int nt = b-&gt;all_successors();
1553 
1554     tty-&gt;print(&quot;Parsing block #%d at bci [%d,%d), successors: &quot;,
1555                   block()-&gt;rpo(), block()-&gt;start(), block()-&gt;limit());
1556     for (int i = 0; i &lt; nt; i++) {
1557       tty-&gt;print((( i &lt; ns) ? &quot; %d&quot; : &quot; %d(e)&quot;), b-&gt;successor_at(i)-&gt;rpo());
1558     }
1559     if (b-&gt;is_loop_head()) tty-&gt;print(&quot;  lphd&quot;);
1560     tty-&gt;cr();
1561   }
1562 
1563   assert(block()-&gt;is_merged(), &quot;must be merged before being parsed&quot;);
1564   block()-&gt;mark_parsed();
1565 
1566   // Set iterator to start of block.
1567   iter().reset_to_bci(block()-&gt;start());
1568 
1569   CompileLog* log = C-&gt;log();
1570 
1571   // Parse bytecodes
1572   while (!stopped() &amp;&amp; !failing()) {
1573     iter().next();
1574 
1575     // Learn the current bci from the iterator:
1576     set_parse_bci(iter().cur_bci());
1577 
1578     if (bci() == block()-&gt;limit()) {
1579       // Do not walk into the next block until directed by do_all_blocks.
1580       merge(bci());
1581       break;
1582     }
1583     assert(bci() &lt; block()-&gt;limit(), &quot;bci still in block&quot;);
1584 
1585     if (log != NULL) {
1586       // Output an optional context marker, to help place actions
1587       // that occur during parsing of this BC.  If there is no log
1588       // output until the next context string, this context string
1589       // will be silently ignored.
1590       log-&gt;set_context(&quot;bc code=&#39;%d&#39; bci=&#39;%d&#39;&quot;, (int)bc(), bci());
1591     }
1592 
1593     if (block()-&gt;has_trap_at(bci())) {
1594       // We must respect the flow pass&#39;s traps, because it will refuse
1595       // to produce successors for trapping blocks.
1596       int trap_index = block()-&gt;flow()-&gt;trap_index();
1597       assert(trap_index != 0, &quot;trap index must be valid&quot;);
1598       uncommon_trap(trap_index);
1599       break;
1600     }
1601 
1602     NOT_PRODUCT( parse_histogram()-&gt;set_initial_state(bc()); );
1603 
1604 #ifdef ASSERT
1605     int pre_bc_sp = sp();
1606     int inputs, depth;
1607     bool have_se = !stopped() &amp;&amp; compute_stack_effects(inputs, depth);
1608     assert(!have_se || pre_bc_sp &gt;= inputs, &quot;have enough stack to execute this BC: pre_bc_sp=%d, inputs=%d&quot;, pre_bc_sp, inputs);
1609 #endif //ASSERT
1610 
1611     do_one_bytecode();
1612 
1613     assert(!have_se || stopped() || failing() || (sp() - pre_bc_sp) == depth,
1614            &quot;incorrect depth prediction: sp=%d, pre_bc_sp=%d, depth=%d&quot;, sp(), pre_bc_sp, depth);
1615 
1616     do_exceptions();
1617 
1618     NOT_PRODUCT( parse_histogram()-&gt;record_change(); );
1619 
1620     if (log != NULL)
1621       log-&gt;clear_context();  // skip marker if nothing was printed
1622 
1623     // Fall into next bytecode.  Each bytecode normally has 1 sequential
1624     // successor which is typically made ready by visiting this bytecode.
1625     // If the successor has several predecessors, then it is a merge
1626     // point, starts a new basic block, and is handled like other basic blocks.
1627   }
1628 }
1629 
1630 
1631 //------------------------------merge------------------------------------------
1632 void Parse::set_parse_bci(int bci) {
1633   set_bci(bci);
1634   Node_Notes* nn = C-&gt;default_node_notes();
1635   if (nn == NULL)  return;
1636 
1637   // Collect debug info for inlined calls unless -XX:-DebugInlinedCalls.
1638   if (!DebugInlinedCalls &amp;&amp; depth() &gt; 1) {
1639     return;
1640   }
1641 
1642   // Update the JVMS annotation, if present.
1643   JVMState* jvms = nn-&gt;jvms();
1644   if (jvms != NULL &amp;&amp; jvms-&gt;bci() != bci) {
1645     // Update the JVMS.
1646     jvms = jvms-&gt;clone_shallow(C);
1647     jvms-&gt;set_bci(bci);
1648     nn-&gt;set_jvms(jvms);
1649   }
1650 }
1651 
1652 //------------------------------merge------------------------------------------
1653 // Merge the current mapping into the basic block starting at bci
1654 void Parse::merge(int target_bci) {
1655   Block* target = successor_for_bci(target_bci);
1656   if (target == NULL) { handle_missing_successor(target_bci); return; }
1657   assert(!target-&gt;is_ready(), &quot;our arrival must be expected&quot;);
1658   int pnum = target-&gt;next_path_num();
1659   merge_common(target, pnum);
1660 }
1661 
1662 //-------------------------merge_new_path--------------------------------------
1663 // Merge the current mapping into the basic block, using a new path
1664 void Parse::merge_new_path(int target_bci) {
1665   Block* target = successor_for_bci(target_bci);
1666   if (target == NULL) { handle_missing_successor(target_bci); return; }
1667   assert(!target-&gt;is_ready(), &quot;new path into frozen graph&quot;);
1668   int pnum = target-&gt;add_new_path();
1669   merge_common(target, pnum);
1670 }
1671 
1672 //-------------------------merge_exception-------------------------------------
1673 // Merge the current mapping into the basic block starting at bci
1674 // The ex_oop must be pushed on the stack, unlike throw_to_exit.
1675 void Parse::merge_exception(int target_bci) {
1676   assert(sp() == 1, &quot;must have only the throw exception on the stack&quot;);
1677   Block* target = successor_for_bci(target_bci);
1678   if (target == NULL) { handle_missing_successor(target_bci); return; }
1679   assert(target-&gt;is_handler(), &quot;exceptions are handled by special blocks&quot;);
1680   int pnum = target-&gt;add_new_path();
1681   merge_common(target, pnum);
1682 }
1683 
1684 //--------------------handle_missing_successor---------------------------------
1685 void Parse::handle_missing_successor(int target_bci) {
1686 #ifndef PRODUCT
1687   Block* b = block();
1688   int trap_bci = b-&gt;flow()-&gt;has_trap()? b-&gt;flow()-&gt;trap_bci(): -1;
1689   tty-&gt;print_cr(&quot;### Missing successor at bci:%d for block #%d (trap_bci:%d)&quot;, target_bci, b-&gt;rpo(), trap_bci);
1690 #endif
1691   ShouldNotReachHere();
1692 }
1693 
1694 //--------------------------merge_common---------------------------------------
1695 void Parse::merge_common(Parse::Block* target, int pnum) {
1696   if (TraceOptoParse) {
1697     tty-&gt;print(&quot;Merging state at block #%d bci:%d&quot;, target-&gt;rpo(), target-&gt;start());
1698   }
1699 
1700   // Zap extra stack slots to top
1701   assert(sp() == target-&gt;start_sp(), &quot;&quot;);
1702   clean_stack(sp());
1703 
1704   // Check for merge conflicts involving value types
1705   JVMState* old_jvms = map()-&gt;jvms();
1706   int old_bci = bci();
1707   JVMState* tmp_jvms = old_jvms-&gt;clone_shallow(C);
1708   tmp_jvms-&gt;set_should_reexecute(true);
1709   map()-&gt;set_jvms(tmp_jvms);
1710   // Execution needs to restart a the next bytecode (entry of next
1711   // block)
1712   if (target-&gt;is_merged() ||
1713       pnum &gt; PhiNode::Input ||
1714       target-&gt;is_handler() ||
1715       target-&gt;is_loop_head()) {
1716     set_parse_bci(target-&gt;start());
1717     for (uint j = TypeFunc::Parms; j &lt; map()-&gt;req(); j++) {
1718       Node* n = map()-&gt;in(j);                 // Incoming change to target state.
1719       const Type* t = NULL;
1720       if (tmp_jvms-&gt;is_loc(j)) {
1721         t = target-&gt;local_type_at(j - tmp_jvms-&gt;locoff());
1722       } else if (tmp_jvms-&gt;is_stk(j) &amp;&amp; j &lt; (uint)sp() + tmp_jvms-&gt;stkoff()) {
1723         t = target-&gt;stack_type_at(j - tmp_jvms-&gt;stkoff());
1724       }
1725       if (t != NULL &amp;&amp; t != Type::BOTTOM) {
1726         if (n-&gt;is_ValueType() &amp;&amp; !t-&gt;isa_valuetype()) {
1727           // Allocate value type in src block to be able to merge it with oop in target block
1728           map()-&gt;set_req(j, ValueTypePtrNode::make_from_value_type(this, n-&gt;as_ValueType()));
1729         }
1730         assert(!t-&gt;isa_valuetype() || n-&gt;is_ValueType(), &quot;inconsistent typeflow info&quot;);
1731       }
1732     }
1733   }
1734   map()-&gt;set_jvms(old_jvms);
1735   set_parse_bci(old_bci);
1736 
1737   if (!target-&gt;is_merged()) {   // No prior mapping at this bci
1738     if (TraceOptoParse) { tty-&gt;print(&quot; with empty state&quot;);  }
1739 
1740     // If this path is dead, do not bother capturing it as a merge.
1741     // It is &quot;as if&quot; we had 1 fewer predecessors from the beginning.
1742     if (stopped()) {
1743       if (TraceOptoParse)  tty-&gt;print_cr(&quot;, but path is dead and doesn&#39;t count&quot;);
1744       return;
1745     }
1746 
1747     // Make a region if we know there are multiple or unpredictable inputs.
1748     // (Also, if this is a plain fall-through, we might see another region,
1749     // which must not be allowed into this block&#39;s map.)
1750     if (pnum &gt; PhiNode::Input         // Known multiple inputs.
1751         || target-&gt;is_handler()       // These have unpredictable inputs.
1752         || target-&gt;is_loop_head()     // Known multiple inputs
1753         || control()-&gt;is_Region()) {  // We must hide this guy.
1754 
1755       int current_bci = bci();
1756       set_parse_bci(target-&gt;start()); // Set target bci
1757       if (target-&gt;is_SEL_head()) {
1758         DEBUG_ONLY( target-&gt;mark_merged_backedge(block()); )
1759         if (target-&gt;start() == 0) {
1760           // Add loop predicate for the special case when
1761           // there are backbranches to the method entry.
1762           add_empty_predicates();
1763         }
1764       }
1765       // Add a Region to start the new basic block.  Phis will be added
1766       // later lazily.
1767       int edges = target-&gt;pred_count();
1768       if (edges &lt; pnum)  edges = pnum;  // might be a new path!
1769       RegionNode *r = new RegionNode(edges+1);
1770       gvn().set_type(r, Type::CONTROL);
1771       record_for_igvn(r);
1772       // zap all inputs to NULL for debugging (done in Node(uint) constructor)
1773       // for (int j = 1; j &lt; edges+1; j++) { r-&gt;init_req(j, NULL); }
1774       r-&gt;init_req(pnum, control());
1775       set_control(r);
1776       set_parse_bci(current_bci); // Restore bci
1777     }
1778 
1779     // Convert the existing Parser mapping into a mapping at this bci.
1780     store_state_to(target);
1781     assert(target-&gt;is_merged(), &quot;do not come here twice&quot;);
1782 
1783   } else {                      // Prior mapping at this bci
1784     if (TraceOptoParse) {  tty-&gt;print(&quot; with previous state&quot;); }
1785 #ifdef ASSERT
1786     if (target-&gt;is_SEL_head()) {
1787       target-&gt;mark_merged_backedge(block());
1788     }
1789 #endif
1790 
1791     // We must not manufacture more phis if the target is already parsed.
1792     bool nophi = target-&gt;is_parsed();
1793 
1794     SafePointNode* newin = map();// Hang on to incoming mapping
1795     Block* save_block = block(); // Hang on to incoming block;
1796     load_state_from(target);    // Get prior mapping
1797 
1798     assert(newin-&gt;jvms()-&gt;locoff() == jvms()-&gt;locoff(), &quot;JVMS layouts agree&quot;);
1799     assert(newin-&gt;jvms()-&gt;stkoff() == jvms()-&gt;stkoff(), &quot;JVMS layouts agree&quot;);
1800     assert(newin-&gt;jvms()-&gt;monoff() == jvms()-&gt;monoff(), &quot;JVMS layouts agree&quot;);
1801     assert(newin-&gt;jvms()-&gt;endoff() == jvms()-&gt;endoff(), &quot;JVMS layouts agree&quot;);
1802 
1803     // Iterate over my current mapping and the old mapping.
1804     // Where different, insert Phi functions.
1805     // Use any existing Phi functions.
1806     assert(control()-&gt;is_Region(), &quot;must be merging to a region&quot;);
1807     RegionNode* r = control()-&gt;as_Region();
1808 
1809     // Compute where to merge into
1810     // Merge incoming control path
1811     r-&gt;init_req(pnum, newin-&gt;control());
1812 
1813     if (pnum == 1) {            // Last merge for this Region?
1814       if (!block()-&gt;flow()-&gt;is_irreducible_entry()) {
1815         Node* result = _gvn.transform_no_reclaim(r);
1816         if (r != result &amp;&amp; TraceOptoParse) {
1817           tty-&gt;print_cr(&quot;Block #%d replace %d with %d&quot;, block()-&gt;rpo(), r-&gt;_idx, result-&gt;_idx);
1818         }
1819       }
1820       record_for_igvn(r);
1821     }
1822 
1823     // Update all the non-control inputs to map:
1824     assert(TypeFunc::Parms == newin-&gt;jvms()-&gt;locoff(), &quot;parser map should contain only youngest jvms&quot;);
1825     bool check_elide_phi = target-&gt;is_SEL_backedge(save_block);
1826     bool last_merge = (pnum == PhiNode::Input);
1827     for (uint j = 1; j &lt; newin-&gt;req(); j++) {
1828       Node* m = map()-&gt;in(j);   // Current state of target.
1829       Node* n = newin-&gt;in(j);   // Incoming change to target state.
1830       PhiNode* phi;
1831       if (m-&gt;is_Phi() &amp;&amp; m-&gt;as_Phi()-&gt;region() == r) {
1832         phi = m-&gt;as_Phi();
1833       } else if (m-&gt;is_ValueType() &amp;&amp; m-&gt;as_ValueType()-&gt;has_phi_inputs(r)){
1834         phi = m-&gt;as_ValueType()-&gt;get_oop()-&gt;as_Phi();
1835       } else {
1836         phi = NULL;
1837       }
1838       if (m != n) {             // Different; must merge
1839         switch (j) {
1840         // Frame pointer and Return Address never changes
1841         case TypeFunc::FramePtr:// Drop m, use the original value
1842         case TypeFunc::ReturnAdr:
1843           break;
1844         case TypeFunc::Memory:  // Merge inputs to the MergeMem node
1845           assert(phi == NULL, &quot;the merge contains phis, not vice versa&quot;);
1846           merge_memory_edges(n-&gt;as_MergeMem(), pnum, nophi);
1847           continue;
1848         default:                // All normal stuff
1849           if (phi == NULL) {
1850             const JVMState* jvms = map()-&gt;jvms();
1851             if (EliminateNestedLocks &amp;&amp;
1852                 jvms-&gt;is_mon(j) &amp;&amp; jvms-&gt;is_monitor_box(j)) {
1853               // BoxLock nodes are not commoning.
1854               // Use old BoxLock node as merged box.
1855               assert(newin-&gt;jvms()-&gt;is_monitor_box(j), &quot;sanity&quot;);
1856               // This assert also tests that nodes are BoxLock.
1857               assert(BoxLockNode::same_slot(n, m), &quot;sanity&quot;);
1858               C-&gt;gvn_replace_by(n, m);
1859             } else if (!check_elide_phi || !target-&gt;can_elide_SEL_phi(j)) {
1860               phi = ensure_phi(j, nophi);
1861             }
1862           }
1863           break;
1864         }
1865       }
1866       // At this point, n might be top if:
1867       //  - there is no phi (because TypeFlow detected a conflict), or
1868       //  - the corresponding control edges is top (a dead incoming path)
1869       // It is a bug if we create a phi which sees a garbage value on a live path.
1870 
1871       // Merging two value types?
1872       if (phi != NULL &amp;&amp; n-&gt;is_ValueType()) {
1873         // Reload current state because it may have been updated by ensure_phi
1874         m = map()-&gt;in(j);
1875         ValueTypeNode* vtm = m-&gt;as_ValueType(); // Current value type
1876         ValueTypeNode* vtn = n-&gt;as_ValueType(); // Incoming value type
1877         assert(vtm-&gt;get_oop() == phi, &quot;Value type should have Phi input&quot;);
1878         if (TraceOptoParse) {
1879 #ifdef ASSERT
1880           tty-&gt;print_cr(&quot;\nMerging value types&quot;);
1881           tty-&gt;print_cr(&quot;Current:&quot;);
1882           vtm-&gt;dump(2);
1883           tty-&gt;print_cr(&quot;Incoming:&quot;);
1884           vtn-&gt;dump(2);
1885           tty-&gt;cr();
1886 #endif
1887         }
1888         // Do the merge
1889         vtm-&gt;merge_with(&amp;_gvn, vtn, pnum, last_merge);
1890         if (last_merge) {
1891           map()-&gt;set_req(j, _gvn.transform_no_reclaim(vtm));
1892           record_for_igvn(vtm);
1893         }
1894       } else if (phi != NULL) {
1895         assert(n != top() || r-&gt;in(pnum) == top(), &quot;live value must not be garbage&quot;);
1896         assert(phi-&gt;region() == r, &quot;&quot;);
1897         phi-&gt;set_req(pnum, n);  // Then add &#39;n&#39; to the merge
1898         if (last_merge) {
1899           // Last merge for this Phi.
1900           // So far, Phis have had a reasonable type from ciTypeFlow.
1901           // Now _gvn will join that with the meet of current inputs.
1902           // BOTTOM is never permissible here, &#39;cause pessimistically
1903           // Phis of pointers cannot lose the basic pointer type.
1904           debug_only(const Type* bt1 = phi-&gt;bottom_type());
1905           assert(bt1 != Type::BOTTOM, &quot;should not be building conflict phis&quot;);
1906           map()-&gt;set_req(j, _gvn.transform_no_reclaim(phi));
1907           debug_only(const Type* bt2 = phi-&gt;bottom_type());
1908           assert(bt2-&gt;higher_equal_speculative(bt1), &quot;must be consistent with type-flow&quot;);
1909           record_for_igvn(phi);
1910         }
1911       }
1912     } // End of for all values to be merged
1913 
1914     if (last_merge &amp;&amp; !r-&gt;in(0)) {         // The occasional useless Region
1915       assert(control() == r, &quot;&quot;);
1916       set_control(r-&gt;nonnull_req());
1917     }
1918 
1919     map()-&gt;merge_replaced_nodes_with(newin);
1920 
1921     // newin has been subsumed into the lazy merge, and is now dead.
1922     set_block(save_block);
1923 
1924     stop();                     // done with this guy, for now
1925   }
1926 
1927   if (TraceOptoParse) {
1928     tty-&gt;print_cr(&quot; on path %d&quot;, pnum);
1929   }
1930 
1931   // Done with this parser state.
1932   assert(stopped(), &quot;&quot;);
1933 }
1934 
1935 
1936 //--------------------------merge_memory_edges---------------------------------
1937 void Parse::merge_memory_edges(MergeMemNode* n, int pnum, bool nophi) {
1938   // (nophi means we must not create phis, because we already parsed here)
1939   assert(n != NULL, &quot;&quot;);
1940   // Merge the inputs to the MergeMems
1941   MergeMemNode* m = merged_memory();
1942 
1943   assert(control()-&gt;is_Region(), &quot;must be merging to a region&quot;);
1944   RegionNode* r = control()-&gt;as_Region();
1945 
1946   PhiNode* base = NULL;
1947   MergeMemNode* remerge = NULL;
1948   for (MergeMemStream mms(m, n); mms.next_non_empty2(); ) {
1949     Node *p = mms.force_memory();
1950     Node *q = mms.memory2();
1951     if (mms.is_empty() &amp;&amp; nophi) {
1952       // Trouble:  No new splits allowed after a loop body is parsed.
1953       // Instead, wire the new split into a MergeMem on the backedge.
1954       // The optimizer will sort it out, slicing the phi.
1955       if (remerge == NULL) {
1956         guarantee(base != NULL, &quot;&quot;);
1957         assert(base-&gt;in(0) != NULL, &quot;should not be xformed away&quot;);
1958         remerge = MergeMemNode::make(base-&gt;in(pnum));
1959         gvn().set_type(remerge, Type::MEMORY);
1960         base-&gt;set_req(pnum, remerge);
1961       }
1962       remerge-&gt;set_memory_at(mms.alias_idx(), q);
1963       continue;
1964     }
1965     assert(!q-&gt;is_MergeMem(), &quot;&quot;);
1966     PhiNode* phi;
1967     if (p != q) {
1968       phi = ensure_memory_phi(mms.alias_idx(), nophi);
1969     } else {
1970       if (p-&gt;is_Phi() &amp;&amp; p-&gt;as_Phi()-&gt;region() == r)
1971         phi = p-&gt;as_Phi();
1972       else
1973         phi = NULL;
1974     }
1975     // Insert q into local phi
1976     if (phi != NULL) {
1977       assert(phi-&gt;region() == r, &quot;&quot;);
1978       p = phi;
1979       phi-&gt;set_req(pnum, q);
1980       if (mms.at_base_memory()) {
1981         base = phi;  // delay transforming it
1982       } else if (pnum == 1) {
1983         record_for_igvn(phi);
1984         p = _gvn.transform_no_reclaim(phi);
1985       }
1986       mms.set_memory(p);// store back through the iterator
1987     }
1988   }
1989   // Transform base last, in case we must fiddle with remerging.
1990   if (base != NULL &amp;&amp; pnum == 1) {
1991     record_for_igvn(base);
1992     m-&gt;set_base_memory( _gvn.transform_no_reclaim(base) );
1993   }
1994 }
1995 
1996 
1997 //------------------------ensure_phis_everywhere-------------------------------
1998 void Parse::ensure_phis_everywhere() {
1999   ensure_phi(TypeFunc::I_O);
2000 
2001   // Ensure a phi on all currently known memories.
2002   for (MergeMemStream mms(merged_memory()); mms.next_non_empty(); ) {
2003     ensure_memory_phi(mms.alias_idx());
2004     debug_only(mms.set_memory());  // keep the iterator happy
2005   }
2006 
2007   // Note:  This is our only chance to create phis for memory slices.
2008   // If we miss a slice that crops up later, it will have to be
2009   // merged into the base-memory phi that we are building here.
2010   // Later, the optimizer will comb out the knot, and build separate
2011   // phi-loops for each memory slice that matters.
2012 
2013   // Monitors must nest nicely and not get confused amongst themselves.
2014   // Phi-ify everything up to the monitors, though.
2015   uint monoff = map()-&gt;jvms()-&gt;monoff();
2016   uint nof_monitors = map()-&gt;jvms()-&gt;nof_monitors();
2017 
2018   assert(TypeFunc::Parms == map()-&gt;jvms()-&gt;locoff(), &quot;parser map should contain only youngest jvms&quot;);
2019   bool check_elide_phi = block()-&gt;is_SEL_head();
2020   for (uint i = TypeFunc::Parms; i &lt; monoff; i++) {
2021     if (!check_elide_phi || !block()-&gt;can_elide_SEL_phi(i)) {
2022       ensure_phi(i);
2023     }
2024   }
2025 
2026   // Even monitors need Phis, though they are well-structured.
2027   // This is true for OSR methods, and also for the rare cases where
2028   // a monitor object is the subject of a replace_in_map operation.
2029   // See bugs 4426707 and 5043395.
2030   for (uint m = 0; m &lt; nof_monitors; m++) {
2031     ensure_phi(map()-&gt;jvms()-&gt;monitor_obj_offset(m));
2032   }
2033 }
2034 
2035 
2036 //-----------------------------add_new_path------------------------------------
2037 // Add a previously unaccounted predecessor to this block.
2038 int Parse::Block::add_new_path() {
2039   // If there is no map, return the lowest unused path number.
2040   if (!is_merged())  return pred_count()+1;  // there will be a map shortly
2041 
2042   SafePointNode* map = start_map();
2043   if (!map-&gt;control()-&gt;is_Region())
2044     return pred_count()+1;  // there may be a region some day
2045   RegionNode* r = map-&gt;control()-&gt;as_Region();
2046 
2047   // Add new path to the region.
2048   uint pnum = r-&gt;req();
2049   r-&gt;add_req(NULL);
2050 
2051   for (uint i = 1; i &lt; map-&gt;req(); i++) {
2052     Node* n = map-&gt;in(i);
2053     if (i == TypeFunc::Memory) {
2054       // Ensure a phi on all currently known memories.
2055       for (MergeMemStream mms(n-&gt;as_MergeMem()); mms.next_non_empty(); ) {
2056         Node* phi = mms.memory();
2057         if (phi-&gt;is_Phi() &amp;&amp; phi-&gt;as_Phi()-&gt;region() == r) {
2058           assert(phi-&gt;req() == pnum, &quot;must be same size as region&quot;);
2059           phi-&gt;add_req(NULL);
2060         }
2061       }
2062     } else {
2063       if (n-&gt;is_Phi() &amp;&amp; n-&gt;as_Phi()-&gt;region() == r) {
2064         assert(n-&gt;req() == pnum, &quot;must be same size as region&quot;);
2065         n-&gt;add_req(NULL);
2066       } else if (n-&gt;is_ValueType() &amp;&amp; n-&gt;as_ValueType()-&gt;has_phi_inputs(r)) {
2067         n-&gt;as_ValueType()-&gt;add_new_path(r);
2068       }
2069     }
2070   }
2071 
2072   return pnum;
2073 }
2074 
2075 //------------------------------ensure_phi-------------------------------------
2076 // Turn the idx&#39;th entry of the current map into a Phi
2077 PhiNode *Parse::ensure_phi(int idx, bool nocreate) {
2078   SafePointNode* map = this-&gt;map();
2079   Node* region = map-&gt;control();
2080   assert(region-&gt;is_Region(), &quot;&quot;);
2081 
2082   Node* o = map-&gt;in(idx);
2083   assert(o != NULL, &quot;&quot;);
2084 
2085   if (o == top())  return NULL; // TOP always merges into TOP
2086 
2087   if (o-&gt;is_Phi() &amp;&amp; o-&gt;as_Phi()-&gt;region() == region) {
2088     return o-&gt;as_Phi();
2089   }
2090   ValueTypeBaseNode* vt = o-&gt;isa_ValueType();
2091   if (vt != NULL &amp;&amp; vt-&gt;has_phi_inputs(region)) {
2092     return vt-&gt;get_oop()-&gt;as_Phi();
2093   }
2094 
2095   // Now use a Phi here for merging
2096   assert(!nocreate, &quot;Cannot build a phi for a block already parsed.&quot;);
2097   const JVMState* jvms = map-&gt;jvms();
2098   const Type* t = NULL;
2099   if (jvms-&gt;is_loc(idx)) {
2100     t = block()-&gt;local_type_at(idx - jvms-&gt;locoff());
2101   } else if (jvms-&gt;is_stk(idx)) {
2102     t = block()-&gt;stack_type_at(idx - jvms-&gt;stkoff());
2103   } else if (jvms-&gt;is_mon(idx)) {
2104     assert(!jvms-&gt;is_monitor_box(idx), &quot;no phis for boxes&quot;);
2105     t = TypeInstPtr::BOTTOM; // this is sufficient for a lock object
2106   } else if ((uint)idx &lt; TypeFunc::Parms) {
2107     t = o-&gt;bottom_type();  // Type::RETURN_ADDRESS or such-like.
2108   } else {
2109     assert(false, &quot;no type information for this phi&quot;);
2110   }
2111 
2112   // If the type falls to bottom, then this must be a local that
2113   // is already dead or is mixing ints and oops or some such.
2114   // Forcing it to top makes it go dead.
2115   if (t == Type::BOTTOM) {
2116     map-&gt;set_req(idx, top());
2117     return NULL;
2118   }
2119 
2120   // Do not create phis for top either.
2121   // A top on a non-null control flow must be an unused even after the.phi.
2122   if (t == Type::TOP || t == Type::HALF) {
2123     map-&gt;set_req(idx, top());
2124     return NULL;
2125   }
2126 
2127   if (vt != NULL) {
2128     // Value types are merged by merging their field values.
2129     // Create a cloned ValueTypeNode with phi inputs that
2130     // represents the merged value type and update the map.
2131     vt = vt-&gt;clone_with_phis(&amp;_gvn, region);
2132     map-&gt;set_req(idx, vt);
2133     return vt-&gt;get_oop()-&gt;as_Phi();
2134   } else {
2135     PhiNode* phi = PhiNode::make(region, o, t);
2136     gvn().set_type(phi, t);
2137     if (C-&gt;do_escape_analysis()) record_for_igvn(phi);
2138     map-&gt;set_req(idx, phi);
2139     return phi;
2140   }
2141 }
2142 
2143 //--------------------------ensure_memory_phi----------------------------------
2144 // Turn the idx&#39;th slice of the current memory into a Phi
2145 PhiNode *Parse::ensure_memory_phi(int idx, bool nocreate) {
2146   MergeMemNode* mem = merged_memory();
2147   Node* region = control();
2148   assert(region-&gt;is_Region(), &quot;&quot;);
2149 
2150   Node *o = (idx == Compile::AliasIdxBot)? mem-&gt;base_memory(): mem-&gt;memory_at(idx);
2151   assert(o != NULL &amp;&amp; o != top(), &quot;&quot;);
2152 
2153   PhiNode* phi;
2154   if (o-&gt;is_Phi() &amp;&amp; o-&gt;as_Phi()-&gt;region() == region) {
2155     phi = o-&gt;as_Phi();
2156     if (phi == mem-&gt;base_memory() &amp;&amp; idx &gt;= Compile::AliasIdxRaw) {
2157       // clone the shared base memory phi to make a new memory split
2158       assert(!nocreate, &quot;Cannot build a phi for a block already parsed.&quot;);
2159       const Type* t = phi-&gt;bottom_type();
2160       const TypePtr* adr_type = C-&gt;get_adr_type(idx);
2161       phi = phi-&gt;slice_memory(adr_type);
2162       gvn().set_type(phi, t);
2163     }
2164     return phi;
2165   }
2166 
2167   // Now use a Phi here for merging
2168   assert(!nocreate, &quot;Cannot build a phi for a block already parsed.&quot;);
2169   const Type* t = o-&gt;bottom_type();
2170   const TypePtr* adr_type = C-&gt;get_adr_type(idx);
2171   phi = PhiNode::make(region, o, t, adr_type);
2172   gvn().set_type(phi, t);
2173   if (idx == Compile::AliasIdxBot)
2174     mem-&gt;set_base_memory(phi);
2175   else
2176     mem-&gt;set_memory_at(idx, phi);
2177   return phi;
2178 }
2179 
2180 //------------------------------call_register_finalizer-----------------------
2181 // Check the klass of the receiver and call register_finalizer if the
2182 // class need finalization.
2183 void Parse::call_register_finalizer() {
2184   Node* receiver = local(0);
2185   assert(receiver != NULL &amp;&amp; receiver-&gt;bottom_type()-&gt;isa_instptr() != NULL,
2186          &quot;must have non-null instance type&quot;);
2187 
2188   const TypeInstPtr *tinst = receiver-&gt;bottom_type()-&gt;isa_instptr();
2189   if (tinst != NULL &amp;&amp; tinst-&gt;klass()-&gt;is_loaded() &amp;&amp; !tinst-&gt;klass_is_exact()) {
2190     // The type isn&#39;t known exactly so see if CHA tells us anything.
2191     ciInstanceKlass* ik = tinst-&gt;klass()-&gt;as_instance_klass();
2192     if (!Dependencies::has_finalizable_subclass(ik)) {
2193       // No finalizable subclasses so skip the dynamic check.
2194       C-&gt;dependencies()-&gt;assert_has_no_finalizable_subclasses(ik);
2195       return;
2196     }
2197   }
2198 
2199   // Insert a dynamic test for whether the instance needs
2200   // finalization.  In general this will fold up since the concrete
2201   // class is often visible so the access flags are constant.
2202   Node* klass_addr = basic_plus_adr( receiver, receiver, oopDesc::klass_offset_in_bytes() );
2203   Node* klass = _gvn.transform(LoadKlassNode::make(_gvn, NULL, immutable_memory(), klass_addr, TypeInstPtr::KLASS));
2204 
2205   Node* access_flags_addr = basic_plus_adr(klass, klass, in_bytes(Klass::access_flags_offset()));
2206   Node* access_flags = make_load(NULL, access_flags_addr, TypeInt::INT, T_INT, MemNode::unordered);
2207 
2208   Node* mask  = _gvn.transform(new AndINode(access_flags, intcon(JVM_ACC_HAS_FINALIZER)));
2209   Node* check = _gvn.transform(new CmpINode(mask, intcon(0)));
2210   Node* test  = _gvn.transform(new BoolNode(check, BoolTest::ne));
2211 
2212   IfNode* iff = create_and_map_if(control(), test, PROB_MAX, COUNT_UNKNOWN);
2213 
2214   RegionNode* result_rgn = new RegionNode(3);
2215   record_for_igvn(result_rgn);
2216 
2217   Node *skip_register = _gvn.transform(new IfFalseNode(iff));
2218   result_rgn-&gt;init_req(1, skip_register);
2219 
2220   Node *needs_register = _gvn.transform(new IfTrueNode(iff));
2221   set_control(needs_register);
2222   if (stopped()) {
2223     // There is no slow path.
2224     result_rgn-&gt;init_req(2, top());
2225   } else {
2226     Node *call = make_runtime_call(RC_NO_LEAF,
2227                                    OptoRuntime::register_finalizer_Type(),
2228                                    OptoRuntime::register_finalizer_Java(),
2229                                    NULL, TypePtr::BOTTOM,
2230                                    receiver);
2231     make_slow_call_ex(call, env()-&gt;Throwable_klass(), true);
2232 
2233     Node* fast_io  = call-&gt;in(TypeFunc::I_O);
2234     Node* fast_mem = call-&gt;in(TypeFunc::Memory);
2235     // These two phis are pre-filled with copies of of the fast IO and Memory
2236     Node* io_phi   = PhiNode::make(result_rgn, fast_io,  Type::ABIO);
2237     Node* mem_phi  = PhiNode::make(result_rgn, fast_mem, Type::MEMORY, TypePtr::BOTTOM);
2238 
2239     result_rgn-&gt;init_req(2, control());
2240     io_phi    -&gt;init_req(2, i_o());
2241     mem_phi   -&gt;init_req(2, reset_memory());
2242 
2243     set_all_memory( _gvn.transform(mem_phi) );
2244     set_i_o(        _gvn.transform(io_phi) );
2245   }
2246 
2247   set_control( _gvn.transform(result_rgn) );
2248 }
2249 
2250 // Add check to deoptimize once holder klass is fully initialized.
2251 void Parse::clinit_deopt() {
2252   assert(C-&gt;has_method(), &quot;only for normal compilations&quot;);
2253   assert(depth() == 1, &quot;only for main compiled method&quot;);
2254   assert(is_normal_parse(), &quot;no barrier needed on osr entry&quot;);
2255   assert(!method()-&gt;holder()-&gt;is_not_initialized(), &quot;initialization should have been started&quot;);
2256 
2257   set_parse_bci(0);
2258 
2259   Node* holder = makecon(TypeKlassPtr::make(method()-&gt;holder()));
2260   guard_klass_being_initialized(holder);
2261 }
2262 
2263 // Add check to deoptimize if RTM state is not ProfileRTM
2264 void Parse::rtm_deopt() {
2265 #if INCLUDE_RTM_OPT
2266   if (C-&gt;profile_rtm()) {
2267     assert(C-&gt;has_method(), &quot;only for normal compilations&quot;);
2268     assert(!C-&gt;method()-&gt;method_data()-&gt;is_empty(), &quot;MDO is needed to record RTM state&quot;);
2269     assert(depth() == 1, &quot;generate check only for main compiled method&quot;);
2270 
2271     // Set starting bci for uncommon trap.
2272     set_parse_bci(is_osr_parse() ? osr_bci() : 0);
2273 
2274     // Load the rtm_state from the MethodData.
2275     const TypePtr* adr_type = TypeMetadataPtr::make(C-&gt;method()-&gt;method_data());
2276     Node* mdo = makecon(adr_type);
2277     int offset = MethodData::rtm_state_offset_in_bytes();
2278     Node* adr_node = basic_plus_adr(mdo, mdo, offset);
2279     Node* rtm_state = make_load(control(), adr_node, TypeInt::INT, T_INT, adr_type, MemNode::unordered);
2280 
2281     // Separate Load from Cmp by Opaque.
2282     // In expand_macro_nodes() it will be replaced either
2283     // with this load when there are locks in the code
2284     // or with ProfileRTM (cmp-&gt;in(2)) otherwise so that
2285     // the check will fold.
2286     Node* profile_state = makecon(TypeInt::make(ProfileRTM));
2287     Node* opq   = _gvn.transform( new Opaque3Node(C, rtm_state, Opaque3Node::RTM_OPT) );
2288     Node* chk   = _gvn.transform( new CmpINode(opq, profile_state) );
2289     Node* tst   = _gvn.transform( new BoolNode(chk, BoolTest::eq) );
2290     // Branch to failure if state was changed
2291     { BuildCutout unless(this, tst, PROB_ALWAYS);
2292       uncommon_trap(Deoptimization::Reason_rtm_state_change,
2293                     Deoptimization::Action_make_not_entrant);
2294     }
2295   }
2296 #endif
2297 }
2298 
2299 void Parse::decrement_age() {
2300   MethodCounters* mc = method()-&gt;ensure_method_counters();
2301   if (mc == NULL) {
2302     C-&gt;record_failure(&quot;Must have MCs&quot;);
2303     return;
2304   }
2305   assert(!is_osr_parse(), &quot;Not doing this for OSRs&quot;);
2306 
2307   // Set starting bci for uncommon trap.
2308   set_parse_bci(0);
2309 
2310   const TypePtr* adr_type = TypeRawPtr::make((address)mc);
2311   Node* mc_adr = makecon(adr_type);
2312   Node* cnt_adr = basic_plus_adr(mc_adr, mc_adr, in_bytes(MethodCounters::nmethod_age_offset()));
2313   Node* cnt = make_load(control(), cnt_adr, TypeInt::INT, T_INT, adr_type, MemNode::unordered);
2314   Node* decr = _gvn.transform(new SubINode(cnt, makecon(TypeInt::ONE)));
2315   store_to_memory(control(), cnt_adr, decr, T_INT, adr_type, MemNode::unordered);
2316   Node *chk   = _gvn.transform(new CmpINode(decr, makecon(TypeInt::ZERO)));
2317   Node* tst   = _gvn.transform(new BoolNode(chk, BoolTest::gt));
2318   { BuildCutout unless(this, tst, PROB_ALWAYS);
2319     uncommon_trap(Deoptimization::Reason_tenured,
2320                   Deoptimization::Action_make_not_entrant);
2321   }
2322 }
2323 
2324 //------------------------------return_current---------------------------------
2325 // Append current _map to _exit_return
2326 void Parse::return_current(Node* value) {
2327   if (RegisterFinalizersAtInit &amp;&amp;
2328       method()-&gt;intrinsic_id() == vmIntrinsics::_Object_init) {
2329     call_register_finalizer();
2330   }
2331 
2332   // Do not set_parse_bci, so that return goo is credited to the return insn.
2333   // vreturn can trigger an allocation so vreturn can throw. Setting
2334   // the bci here breaks exception handling. Commenting this out
2335   // doesn&#39;t seem to break anything.
2336   //  set_bci(InvocationEntryBci);
2337   if (method()-&gt;is_synchronized() &amp;&amp; GenerateSynchronizationCode) {
2338     shared_unlock(_synch_lock-&gt;box_node(), _synch_lock-&gt;obj_node());
2339   }
2340   if (C-&gt;env()-&gt;dtrace_method_probes()) {
2341     make_dtrace_method_exit(method());
2342   }
2343   // frame pointer is always same, already captured
2344   if (value != NULL) {
2345     Node* phi = _exits.argument(0);
2346     const Type* return_type = phi-&gt;bottom_type();
2347     const TypeOopPtr* tr = return_type-&gt;isa_oopptr();
2348     if (return_type-&gt;isa_valuetype() &amp;&amp; !Compile::current()-&gt;inlining_incrementally()) {
2349       // Value type is returned as fields, make sure it is scalarized
2350       if (!value-&gt;is_ValueType()) {
2351         value = ValueTypeNode::make_from_oop(this, value, return_type-&gt;value_klass());
2352       }
2353       if (!_caller-&gt;has_method()) {
2354         // Value type is returned as fields from root method, make sure all non-flattened
2355         // fields are buffered and re-execute if allocation triggers deoptimization.
2356         PreserveReexecuteState preexecs(this);
2357         assert(tf()-&gt;returns_value_type_as_fields(), &quot;must be returned as fields&quot;);
2358         jvms()-&gt;set_should_reexecute(true);
2359         inc_sp(1);
2360         value = value-&gt;as_ValueType()-&gt;allocate_fields(this);
2361       }
2362     } else if (value-&gt;is_ValueType()) {
2363       // Value type is returned as oop, make sure it is buffered and re-execute
2364       // if allocation triggers deoptimization.
2365       PreserveReexecuteState preexecs(this);
2366       jvms()-&gt;set_should_reexecute(true);
2367       inc_sp(1);
2368       value = ValueTypePtrNode::make_from_value_type(this, value-&gt;as_ValueType());
2369       if (Compile::current()-&gt;inlining_incrementally()) {
2370         value = value-&gt;as_ValueTypeBase()-&gt;allocate_fields(this);
2371       }
2372     } else if (tr &amp;&amp; tr-&gt;isa_instptr() &amp;&amp; tr-&gt;klass()-&gt;is_loaded() &amp;&amp; tr-&gt;klass()-&gt;is_interface()) {
2373       // If returning oops to an interface-return, there is a silent free
2374       // cast from oop to interface allowed by the Verifier. Make it explicit here.
2375       const TypeInstPtr* tp = value-&gt;bottom_type()-&gt;isa_instptr();
2376       if (tp &amp;&amp; tp-&gt;klass()-&gt;is_loaded() &amp;&amp; !tp-&gt;klass()-&gt;is_interface()) {
2377         // sharpen the type eagerly; this eases certain assert checking
2378         if (tp-&gt;higher_equal(TypeInstPtr::NOTNULL)) {
2379           tr = tr-&gt;join_speculative(TypeInstPtr::NOTNULL)-&gt;is_instptr();
2380         }
2381         value = _gvn.transform(new CheckCastPPNode(0, value, tr));
2382       }
2383     } else {
2384       // Handle returns of oop-arrays to an arrays-of-interface return
2385       const TypeInstPtr* phi_tip;
2386       const TypeInstPtr* val_tip;
2387       Type::get_arrays_base_elements(return_type, value-&gt;bottom_type(), &amp;phi_tip, &amp;val_tip);
2388       if (phi_tip != NULL &amp;&amp; phi_tip-&gt;is_loaded() &amp;&amp; phi_tip-&gt;klass()-&gt;is_interface() &amp;&amp;
2389           val_tip != NULL &amp;&amp; val_tip-&gt;is_loaded() &amp;&amp; !val_tip-&gt;klass()-&gt;is_interface()) {
2390         value = _gvn.transform(new CheckCastPPNode(0, value, return_type));
2391       }
2392     }
2393     phi-&gt;add_req(value);
2394   }
2395 
2396   SafePointNode* exit_return = _exits.map();
2397   exit_return-&gt;in( TypeFunc::Control  )-&gt;add_req( control() );
2398   exit_return-&gt;in( TypeFunc::I_O      )-&gt;add_req( i_o    () );
2399   Node *mem = exit_return-&gt;in( TypeFunc::Memory   );
2400   for (MergeMemStream mms(mem-&gt;as_MergeMem(), merged_memory()); mms.next_non_empty2(); ) {
2401     if (mms.is_empty()) {
2402       // get a copy of the base memory, and patch just this one input
2403       const TypePtr* adr_type = mms.adr_type(C);
2404       Node* phi = mms.force_memory()-&gt;as_Phi()-&gt;slice_memory(adr_type);
2405       assert(phi-&gt;as_Phi()-&gt;region() == mms.base_memory()-&gt;in(0), &quot;&quot;);
2406       gvn().set_type_bottom(phi);
2407       phi-&gt;del_req(phi-&gt;req()-1);  // prepare to re-patch
2408       mms.set_memory(phi);
2409     }
2410     mms.memory()-&gt;add_req(mms.memory2());
2411   }
2412 
2413   if (_first_return) {
2414     _exits.map()-&gt;transfer_replaced_nodes_from(map(), _new_idx);
2415     _first_return = false;
2416   } else {
2417     _exits.map()-&gt;merge_replaced_nodes_with(map());
2418   }
2419 
2420   stop_and_kill_map();          // This CFG path dies here
2421 }
2422 
2423 
2424 //------------------------------add_safepoint----------------------------------
2425 void Parse::add_safepoint() {
2426   // See if we can avoid this safepoint.  No need for a SafePoint immediately
2427   // after a Call (except Leaf Call) or another SafePoint.
2428   Node *proj = control();
2429   uint parms = TypeFunc::Parms+1;
2430   if( proj-&gt;is_Proj() ) {
2431     Node *n0 = proj-&gt;in(0);
2432     if( n0-&gt;is_Catch() ) {
2433       n0 = n0-&gt;in(0)-&gt;in(0);
2434       assert( n0-&gt;is_Call(), &quot;expect a call here&quot; );
2435     }
2436     if( n0-&gt;is_Call() ) {
2437       if( n0-&gt;as_Call()-&gt;guaranteed_safepoint() )
2438         return;
2439     } else if( n0-&gt;is_SafePoint() &amp;&amp; n0-&gt;req() &gt;= parms ) {
2440       return;
2441     }
2442   }
2443 
2444   // Clear out dead values from the debug info.
2445   kill_dead_locals();
2446 
2447   // Clone the JVM State
2448   SafePointNode *sfpnt = new SafePointNode(parms, NULL);
2449 
2450   // Capture memory state BEFORE a SafePoint.  Since we can block at a
2451   // SafePoint we need our GC state to be safe; i.e. we need all our current
2452   // write barriers (card marks) to not float down after the SafePoint so we
2453   // must read raw memory.  Likewise we need all oop stores to match the card
2454   // marks.  If deopt can happen, we need ALL stores (we need the correct JVM
2455   // state on a deopt).
2456 
2457   // We do not need to WRITE the memory state after a SafePoint.  The control
2458   // edge will keep card-marks and oop-stores from floating up from below a
2459   // SafePoint and our true dependency added here will keep them from floating
2460   // down below a SafePoint.
2461 
2462   // Clone the current memory state
2463   Node* mem = MergeMemNode::make(map()-&gt;memory());
2464 
2465   mem = _gvn.transform(mem);
2466 
2467   // Pass control through the safepoint
2468   sfpnt-&gt;init_req(TypeFunc::Control  , control());
2469   // Fix edges normally used by a call
2470   sfpnt-&gt;init_req(TypeFunc::I_O      , top() );
2471   sfpnt-&gt;init_req(TypeFunc::Memory   , mem   );
2472   sfpnt-&gt;init_req(TypeFunc::ReturnAdr, top() );
2473   sfpnt-&gt;init_req(TypeFunc::FramePtr , top() );
2474 
2475   // Create a node for the polling address
2476   Node *polladr;
2477   Node *thread = _gvn.transform(new ThreadLocalNode());
2478   Node *polling_page_load_addr = _gvn.transform(basic_plus_adr(top(), thread, in_bytes(Thread::polling_page_offset())));
2479   polladr = make_load(control(), polling_page_load_addr, TypeRawPtr::BOTTOM, T_ADDRESS, Compile::AliasIdxRaw, MemNode::unordered);
2480   sfpnt-&gt;init_req(TypeFunc::Parms+0, _gvn.transform(polladr));
2481 
2482   // Fix up the JVM State edges
2483   add_safepoint_edges(sfpnt);
2484   Node *transformed_sfpnt = _gvn.transform(sfpnt);
2485   set_control(transformed_sfpnt);
2486 
2487   // Provide an edge from root to safepoint.  This makes the safepoint
2488   // appear useful until the parse has completed.
2489   if( OptoRemoveUseless &amp;&amp; transformed_sfpnt-&gt;is_SafePoint() ) {
2490     assert(C-&gt;root() != NULL, &quot;Expect parse is still valid&quot;);
2491     C-&gt;root()-&gt;add_prec(transformed_sfpnt);
2492   }
2493 }
2494 
2495 #ifndef PRODUCT
2496 //------------------------show_parse_info--------------------------------------
2497 void Parse::show_parse_info() {
2498   InlineTree* ilt = NULL;
2499   if (C-&gt;ilt() != NULL) {
2500     JVMState* caller_jvms = is_osr_parse() ? caller()-&gt;caller() : caller();
2501     ilt = InlineTree::find_subtree_from_root(C-&gt;ilt(), caller_jvms, method());
2502   }
2503   if (PrintCompilation &amp;&amp; Verbose) {
2504     if (depth() == 1) {
2505       if( ilt-&gt;count_inlines() ) {
2506         tty-&gt;print(&quot;    __inlined %d (%d bytes)&quot;, ilt-&gt;count_inlines(),
2507                      ilt-&gt;count_inline_bcs());
2508         tty-&gt;cr();
2509       }
2510     } else {
2511       if (method()-&gt;is_synchronized())         tty-&gt;print(&quot;s&quot;);
2512       if (method()-&gt;has_exception_handlers())  tty-&gt;print(&quot;!&quot;);
2513       // Check this is not the final compiled version
2514       if (C-&gt;trap_can_recompile()) {
2515         tty-&gt;print(&quot;-&quot;);
2516       } else {
2517         tty-&gt;print(&quot; &quot;);
2518       }
2519       method()-&gt;print_short_name();
2520       if (is_osr_parse()) {
2521         tty-&gt;print(&quot; @ %d&quot;, osr_bci());
2522       }
2523       tty-&gt;print(&quot; (%d bytes)&quot;,method()-&gt;code_size());
2524       if (ilt-&gt;count_inlines()) {
2525         tty-&gt;print(&quot; __inlined %d (%d bytes)&quot;, ilt-&gt;count_inlines(),
2526                    ilt-&gt;count_inline_bcs());
2527       }
2528       tty-&gt;cr();
2529     }
2530   }
2531   if (PrintOpto &amp;&amp; (depth() == 1 || PrintOptoInlining)) {
2532     // Print that we succeeded; suppress this message on the first osr parse.
2533 
2534     if (method()-&gt;is_synchronized())         tty-&gt;print(&quot;s&quot;);
2535     if (method()-&gt;has_exception_handlers())  tty-&gt;print(&quot;!&quot;);
2536     // Check this is not the final compiled version
2537     if (C-&gt;trap_can_recompile() &amp;&amp; depth() == 1) {
2538       tty-&gt;print(&quot;-&quot;);
2539     } else {
2540       tty-&gt;print(&quot; &quot;);
2541     }
2542     if( depth() != 1 ) { tty-&gt;print(&quot;   &quot;); }  // missing compile count
2543     for (int i = 1; i &lt; depth(); ++i) { tty-&gt;print(&quot;  &quot;); }
2544     method()-&gt;print_short_name();
2545     if (is_osr_parse()) {
2546       tty-&gt;print(&quot; @ %d&quot;, osr_bci());
2547     }
2548     if (ilt-&gt;caller_bci() != -1) {
2549       tty-&gt;print(&quot; @ %d&quot;, ilt-&gt;caller_bci());
2550     }
2551     tty-&gt;print(&quot; (%d bytes)&quot;,method()-&gt;code_size());
2552     if (ilt-&gt;count_inlines()) {
2553       tty-&gt;print(&quot; __inlined %d (%d bytes)&quot;, ilt-&gt;count_inlines(),
2554                  ilt-&gt;count_inline_bcs());
2555     }
2556     tty-&gt;cr();
2557   }
2558 }
2559 
2560 
2561 //------------------------------dump-------------------------------------------
2562 // Dump information associated with the bytecodes of current _method
2563 void Parse::dump() {
2564   if( method() != NULL ) {
2565     // Iterate over bytecodes
2566     ciBytecodeStream iter(method());
2567     for( Bytecodes::Code bc = iter.next(); bc != ciBytecodeStream::EOBC() ; bc = iter.next() ) {
2568       dump_bci( iter.cur_bci() );
2569       tty-&gt;cr();
2570     }
2571   }
2572 }
2573 
2574 // Dump information associated with a byte code index, &#39;bci&#39;
2575 void Parse::dump_bci(int bci) {
2576   // Output info on merge-points, cloning, and within _jsr..._ret
2577   // NYI
2578   tty-&gt;print(&quot; bci:%d&quot;, bci);
2579 }
2580 
2581 #endif
    </pre>
  </body>
</html>