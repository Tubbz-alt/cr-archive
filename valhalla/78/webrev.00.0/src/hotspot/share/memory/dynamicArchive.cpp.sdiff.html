<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/hotspot/share/memory/dynamicArchive.cpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
  </head>
<body>
<center><a href="../gc/shared/collectedHeap.hpp.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="metaspaceShared.cpp.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/hotspot/share/memory/dynamicArchive.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 656       // Write the symbol table and system dictionaries to the RO space.
 657       // Note that these tables still point to the *original* objects
 658       // (because they were not processed by ExternalRefUpdater), so
 659       // they would need to call DynamicArchive::original_to_target() to
 660       // get the correct addresses.
 661       assert(current_dump_space() == ro_space, &quot;Must be RO space&quot;);
 662       SymbolTable::write_to_archive(false);
 663       SystemDictionaryShared::write_to_archive(false);
 664 
 665       serialized_data = ro_space-&gt;top();
 666       WriteClosure wc(ro_space);
 667       SymbolTable::serialize_shared_table_header(&amp;wc, false);
 668       SystemDictionaryShared::serialize_dictionary_headers(&amp;wc, false);
 669     }
 670 
 671     verify_estimate_size(_estimated_hashtable_bytes, &quot;Hashtables&quot;);
 672 
 673     make_trampolines();
 674     make_klasses_shareable();
 675 





 676     {
 677       log_info(cds)(&quot;Final relocation of pointers ... &quot;);
 678       ResourceMark rm;
 679       PointerMarker marker(this);
 680       iterate_roots(&amp;marker);
 681       relocate_buffer_to_target();
 682     }
 683 
 684     write_archive(serialized_data);
 685     release_header();
 686 
 687     assert(_num_dump_regions_used == _total_dump_regions, &quot;must be&quot;);
 688     verify_universe(&quot;After CDS dynamic dump&quot;);
 689   }
 690 
 691   void iterate_roots(MetaspaceClosure* it) {
 692     int i;
 693     int num_klasses = _klasses-&gt;length();
 694     for (i = 0; i &lt; num_klasses; i++) {
 695       it-&gt;push(&amp;_klasses-&gt;at(i));
</pre>
<hr />
<pre>
 847       assert(p &gt;= mc_space-&gt;base() &amp;&amp; p &lt;= mc_space-&gt;top(), &quot;must be&quot;);
 848       *adapter_trampoline = NULL;
 849       m-&gt;set_adapter_trampoline(to_target(adapter_trampoline));
 850     }
 851   }
 852 
 853   guarantee(p &lt;= mc_space-&gt;top(), &quot;Estimate of trampoline size is insufficient&quot;);
 854 }
 855 
 856 void DynamicArchiveBuilder::make_klasses_shareable() {
 857   int i, count = _klasses-&gt;length();
 858 
 859   InstanceKlass::disable_method_binary_search();
 860   for (i = 0; i &lt; count; i++) {
 861     InstanceKlass* ik = _klasses-&gt;at(i);
 862     sort_methods(ik);
 863   }
 864 
 865   for (i = 0; i &lt; count; i++) {
 866     InstanceKlass* ik = _klasses-&gt;at(i);
<span class="line-modified"> 867     ClassLoaderData *cld = ik-&gt;class_loader_data();</span>
<span class="line-removed"> 868     if (cld-&gt;is_boot_class_loader_data()) {</span>
<span class="line-removed"> 869       ik-&gt;set_shared_class_loader_type(ClassLoader::BOOT_LOADER);</span>
<span class="line-removed"> 870     }</span>
<span class="line-removed"> 871     else if (cld-&gt;is_platform_class_loader_data()) {</span>
<span class="line-removed"> 872       ik-&gt;set_shared_class_loader_type(ClassLoader::PLATFORM_LOADER);</span>
<span class="line-removed"> 873     }</span>
<span class="line-removed"> 874     else if (cld-&gt;is_system_class_loader_data()) {</span>
<span class="line-removed"> 875       ik-&gt;set_shared_class_loader_type(ClassLoader::APP_LOADER);</span>
<span class="line-removed"> 876     }</span>
 877 
 878     MetaspaceShared::rewrite_nofast_bytecodes_and_calculate_fingerprints(Thread::current(), ik);
 879     ik-&gt;remove_unshareable_info();
 880 
 881     assert(ik-&gt;array_klasses() == NULL, &quot;sanity&quot;);
 882 
 883     if (log_is_enabled(Debug, cds, dynamic)) {
 884       ResourceMark rm;
 885       log_debug(cds, dynamic)(&quot;klasses[%4i] = &quot; PTR_FORMAT &quot; %s&quot;, i, p2i(to_target(ik)), ik-&gt;external_name());
 886     }
 887   }
 888 }
 889 
 890 // The address order of the copied Symbols may be different than when the original
 891 // klasses were created. Re-sort all the tables. See Method::sort_methods().
 892 void DynamicArchiveBuilder::sort_methods(InstanceKlass* ik) const {
 893   assert(ik != NULL, &quot;DynamicArchiveBuilder currently doesn&#39;t support dumping the base archive&quot;);
 894   if (MetaspaceShared::is_in_shared_metaspace(ik)) {
 895     // We have reached a supertype that&#39;s already in the base archive
 896     return;
</pre>
</td>
<td>
<hr />
<pre>
 656       // Write the symbol table and system dictionaries to the RO space.
 657       // Note that these tables still point to the *original* objects
 658       // (because they were not processed by ExternalRefUpdater), so
 659       // they would need to call DynamicArchive::original_to_target() to
 660       // get the correct addresses.
 661       assert(current_dump_space() == ro_space, &quot;Must be RO space&quot;);
 662       SymbolTable::write_to_archive(false);
 663       SystemDictionaryShared::write_to_archive(false);
 664 
 665       serialized_data = ro_space-&gt;top();
 666       WriteClosure wc(ro_space);
 667       SymbolTable::serialize_shared_table_header(&amp;wc, false);
 668       SystemDictionaryShared::serialize_dictionary_headers(&amp;wc, false);
 669     }
 670 
 671     verify_estimate_size(_estimated_hashtable_bytes, &quot;Hashtables&quot;);
 672 
 673     make_trampolines();
 674     make_klasses_shareable();
 675 
<span class="line-added"> 676     {</span>
<span class="line-added"> 677       log_info(cds)(&quot;Adjust lambda proxy class dictionary&quot;);</span>
<span class="line-added"> 678       SystemDictionaryShared::adjust_lambda_proxy_class_dictionary();</span>
<span class="line-added"> 679     }</span>
<span class="line-added"> 680 </span>
 681     {
 682       log_info(cds)(&quot;Final relocation of pointers ... &quot;);
 683       ResourceMark rm;
 684       PointerMarker marker(this);
 685       iterate_roots(&amp;marker);
 686       relocate_buffer_to_target();
 687     }
 688 
 689     write_archive(serialized_data);
 690     release_header();
 691 
 692     assert(_num_dump_regions_used == _total_dump_regions, &quot;must be&quot;);
 693     verify_universe(&quot;After CDS dynamic dump&quot;);
 694   }
 695 
 696   void iterate_roots(MetaspaceClosure* it) {
 697     int i;
 698     int num_klasses = _klasses-&gt;length();
 699     for (i = 0; i &lt; num_klasses; i++) {
 700       it-&gt;push(&amp;_klasses-&gt;at(i));
</pre>
<hr />
<pre>
 852       assert(p &gt;= mc_space-&gt;base() &amp;&amp; p &lt;= mc_space-&gt;top(), &quot;must be&quot;);
 853       *adapter_trampoline = NULL;
 854       m-&gt;set_adapter_trampoline(to_target(adapter_trampoline));
 855     }
 856   }
 857 
 858   guarantee(p &lt;= mc_space-&gt;top(), &quot;Estimate of trampoline size is insufficient&quot;);
 859 }
 860 
 861 void DynamicArchiveBuilder::make_klasses_shareable() {
 862   int i, count = _klasses-&gt;length();
 863 
 864   InstanceKlass::disable_method_binary_search();
 865   for (i = 0; i &lt; count; i++) {
 866     InstanceKlass* ik = _klasses-&gt;at(i);
 867     sort_methods(ik);
 868   }
 869 
 870   for (i = 0; i &lt; count; i++) {
 871     InstanceKlass* ik = _klasses-&gt;at(i);
<span class="line-modified"> 872     ik-&gt;assign_class_loader_type();</span>









 873 
 874     MetaspaceShared::rewrite_nofast_bytecodes_and_calculate_fingerprints(Thread::current(), ik);
 875     ik-&gt;remove_unshareable_info();
 876 
 877     assert(ik-&gt;array_klasses() == NULL, &quot;sanity&quot;);
 878 
 879     if (log_is_enabled(Debug, cds, dynamic)) {
 880       ResourceMark rm;
 881       log_debug(cds, dynamic)(&quot;klasses[%4i] = &quot; PTR_FORMAT &quot; %s&quot;, i, p2i(to_target(ik)), ik-&gt;external_name());
 882     }
 883   }
 884 }
 885 
 886 // The address order of the copied Symbols may be different than when the original
 887 // klasses were created. Re-sort all the tables. See Method::sort_methods().
 888 void DynamicArchiveBuilder::sort_methods(InstanceKlass* ik) const {
 889   assert(ik != NULL, &quot;DynamicArchiveBuilder currently doesn&#39;t support dumping the base archive&quot;);
 890   if (MetaspaceShared::is_in_shared_metaspace(ik)) {
 891     // We have reached a supertype that&#39;s already in the base archive
 892     return;
</pre>
</td>
</tr>
</table>
<center><a href="../gc/shared/collectedHeap.hpp.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="metaspaceShared.cpp.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>