<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/hotspot/share/opto/parse1.cpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
  </head>
<body>
<center><a href="library_call.cpp.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="../prims/jvm.cpp.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/hotspot/share/opto/parse1.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  *
  23  */
  24 
  25 #include &quot;precompiled.hpp&quot;
  26 #include &quot;compiler/compileLog.hpp&quot;
  27 #include &quot;interpreter/linkResolver.hpp&quot;
  28 #include &quot;memory/resourceArea.hpp&quot;
  29 #include &quot;oops/method.hpp&quot;
  30 #include &quot;opto/addnode.hpp&quot;
  31 #include &quot;opto/c2compiler.hpp&quot;
  32 #include &quot;opto/castnode.hpp&quot;
  33 #include &quot;opto/idealGraphPrinter.hpp&quot;
  34 #include &quot;opto/locknode.hpp&quot;
  35 #include &quot;opto/memnode.hpp&quot;
  36 #include &quot;opto/opaquenode.hpp&quot;
  37 #include &quot;opto/parse.hpp&quot;
  38 #include &quot;opto/rootnode.hpp&quot;
  39 #include &quot;opto/runtime.hpp&quot;

  40 #include &quot;runtime/arguments.hpp&quot;
  41 #include &quot;runtime/handles.inline.hpp&quot;
  42 #include &quot;runtime/safepointMechanism.hpp&quot;
  43 #include &quot;runtime/sharedRuntime.hpp&quot;
  44 #include &quot;utilities/bitMap.inline.hpp&quot;
  45 #include &quot;utilities/copy.hpp&quot;
  46 
  47 // Static array so we can figure out which bytecodes stop us from compiling
  48 // the most. Some of the non-static variables are needed in bytecodeInfo.cpp
  49 // and eventually should be encapsulated in a proper class (gri 8/18/98).
  50 
  51 #ifndef PRODUCT
  52 int nodes_created              = 0;
  53 int methods_parsed             = 0;
  54 int methods_seen               = 0;
  55 int blocks_parsed              = 0;
  56 int blocks_seen                = 0;
  57 
  58 int explicit_null_checks_inserted = 0;
  59 int explicit_null_checks_elided   = 0;
</pre>
<hr />
<pre>
  85   }
  86   if (all_null_checks_found) {
  87     tty-&gt;print_cr(&quot;%d made implicit (%2d%%)&quot;, implicit_null_checks,
  88                   (100*implicit_null_checks)/all_null_checks_found);
  89   }
  90   if (SharedRuntime::_implicit_null_throws) {
  91     tty-&gt;print_cr(&quot;%d implicit null exceptions at runtime&quot;,
  92                   SharedRuntime::_implicit_null_throws);
  93   }
  94 
  95   if (PrintParseStatistics &amp;&amp; BytecodeParseHistogram::initialized()) {
  96     BytecodeParseHistogram::print();
  97   }
  98 }
  99 #endif
 100 
 101 //------------------------------ON STACK REPLACEMENT---------------------------
 102 
 103 // Construct a node which can be used to get incoming state for
 104 // on stack replacement.
<span class="line-modified"> 105 Node *Parse::fetch_interpreter_state(int index,</span>
<span class="line-modified"> 106                                      BasicType bt,</span>
<span class="line-modified"> 107                                      Node *local_addrs,</span>
<span class="line-modified"> 108                                      Node *local_addrs_base) {</span>






 109   Node *mem = memory(Compile::AliasIdxRaw);
 110   Node *adr = basic_plus_adr( local_addrs_base, local_addrs, -index*wordSize );
 111   Node *ctl = control();
 112 
 113   // Very similar to LoadNode::make, except we handle un-aligned longs and
 114   // doubles on Sparc.  Intel can handle them just fine directly.
 115   Node *l = NULL;
 116   switch (bt) {                // Signature is flattened
 117   case T_INT:     l = new LoadINode(ctl, mem, adr, TypeRawPtr::BOTTOM, TypeInt::INT,        MemNode::unordered); break;
 118   case T_FLOAT:   l = new LoadFNode(ctl, mem, adr, TypeRawPtr::BOTTOM, Type::FLOAT,         MemNode::unordered); break;
 119   case T_ADDRESS: l = new LoadPNode(ctl, mem, adr, TypeRawPtr::BOTTOM, TypeRawPtr::BOTTOM,  MemNode::unordered); break;

 120   case T_OBJECT:  l = new LoadPNode(ctl, mem, adr, TypeRawPtr::BOTTOM, TypeInstPtr::BOTTOM, MemNode::unordered); break;
 121   case T_LONG:
 122   case T_DOUBLE: {
 123     // Since arguments are in reverse order, the argument address &#39;adr&#39;
 124     // refers to the back half of the long/double.  Recompute adr.
 125     adr = basic_plus_adr(local_addrs_base, local_addrs, -(index+1)*wordSize);
 126     if (Matcher::misaligned_doubles_ok) {
 127       l = (bt == T_DOUBLE)
 128         ? (Node*)new LoadDNode(ctl, mem, adr, TypeRawPtr::BOTTOM, Type::DOUBLE, MemNode::unordered)
 129         : (Node*)new LoadLNode(ctl, mem, adr, TypeRawPtr::BOTTOM, TypeLong::LONG, MemNode::unordered);
 130     } else {
 131       l = (bt == T_DOUBLE)
 132         ? (Node*)new LoadD_unalignedNode(ctl, mem, adr, TypeRawPtr::BOTTOM, MemNode::unordered)
 133         : (Node*)new LoadL_unalignedNode(ctl, mem, adr, TypeRawPtr::BOTTOM, MemNode::unordered);
 134     }
 135     break;
 136   }
 137   default: ShouldNotReachHere();
 138   }
 139   return _gvn.transform(l);
 140 }
 141 
 142 // Helper routine to prevent the interpreter from handing
 143 // unexpected typestate to an OSR method.
 144 // The Node l is a value newly dug out of the interpreter frame.
 145 // The type is the type predicted by ciTypeFlow.  Note that it is
 146 // not a general type, but can only come from Type::get_typeflow_type.
 147 // The safepoint is a map which will feed an uncommon trap.
 148 Node* Parse::check_interpreter_type(Node* l, const Type* type,
 149                                     SafePointNode* &amp;bad_type_exit) {
<span class="line-modified"> 150 </span>




 151   const TypeOopPtr* tp = type-&gt;isa_oopptr();
 152 
 153   // TypeFlow may assert null-ness if a type appears unloaded.
 154   if (type == TypePtr::NULL_PTR ||
 155       (tp != NULL &amp;&amp; !tp-&gt;klass()-&gt;is_loaded())) {
 156     // Value must be null, not a real oop.
 157     Node* chk = _gvn.transform( new CmpPNode(l, null()) );
 158     Node* tst = _gvn.transform( new BoolNode(chk, BoolTest::eq) );
 159     IfNode* iff = create_and_map_if(control(), tst, PROB_MAX, COUNT_UNKNOWN);
 160     set_control(_gvn.transform( new IfTrueNode(iff) ));
 161     Node* bad_type = _gvn.transform( new IfFalseNode(iff) );
 162     bad_type_exit-&gt;control()-&gt;add_req(bad_type);
 163     l = null();
 164   }
 165 
 166   // Typeflow can also cut off paths from the CFG, based on
 167   // types which appear unloaded, or call sites which appear unlinked.
 168   // When paths are cut off, values at later merge points can rise
 169   // toward more specific classes.  Make sure these specific classes
 170   // are still in effect.
 171   if (tp != NULL &amp;&amp; tp-&gt;klass() != C-&gt;env()-&gt;Object_klass()) {
 172     // TypeFlow asserted a specific object type.  Value must have that type.
 173     Node* bad_type_ctrl = NULL;






 174     l = gen_checkcast(l, makecon(TypeKlassPtr::make(tp-&gt;klass())), &amp;bad_type_ctrl);
 175     bad_type_exit-&gt;control()-&gt;add_req(bad_type_ctrl);
 176   }
<span class="line-removed"> 177 </span>
<span class="line-removed"> 178   BasicType bt_l = _gvn.type(l)-&gt;basic_type();</span>
<span class="line-removed"> 179   BasicType bt_t = type-&gt;basic_type();</span>
 180   assert(_gvn.type(l)-&gt;higher_equal(type), &quot;must constrain OSR typestate&quot;);
 181   return l;
 182 }
 183 
 184 // Helper routine which sets up elements of the initial parser map when
 185 // performing a parse for on stack replacement.  Add values into map.
 186 // The only parameter contains the address of a interpreter arguments.
 187 void Parse::load_interpreter_state(Node* osr_buf) {
 188   int index;
 189   int max_locals = jvms()-&gt;loc_size();
 190   int max_stack  = jvms()-&gt;stk_size();
 191 
<span class="line-removed"> 192 </span>
 193   // Mismatch between method and jvms can occur since map briefly held
 194   // an OSR entry state (which takes up one RawPtr word).
 195   assert(max_locals == method()-&gt;max_locals(), &quot;sanity&quot;);
 196   assert(max_stack  &gt;= method()-&gt;max_stack(),  &quot;sanity&quot;);
 197   assert((int)jvms()-&gt;endoff() == TypeFunc::Parms + max_locals + max_stack, &quot;sanity&quot;);
 198   assert((int)jvms()-&gt;endoff() == (int)map()-&gt;req(), &quot;sanity&quot;);
 199 
 200   // Find the start block.
 201   Block* osr_block = start_block();
 202   assert(osr_block-&gt;start() == osr_bci(), &quot;sanity&quot;);
 203 
 204   // Set initial BCI.
 205   set_parse_bci(osr_block-&gt;start());
 206 
 207   // Set initial stack depth.
 208   set_sp(osr_block-&gt;start_sp());
 209 
 210   // Check bailouts.  We currently do not perform on stack replacement
 211   // of loops in catch blocks or loops which branch with a non-empty stack.
 212   if (sp() != 0) {
 213     C-&gt;record_method_not_compilable(&quot;OSR starts with non-empty stack&quot;);
 214     return;
 215   }
 216   // Do not OSR inside finally clauses:
 217   if (osr_block-&gt;has_trap_at(osr_block-&gt;start())) {
 218     C-&gt;record_method_not_compilable(&quot;OSR starts with an immediate trap&quot;);
 219     return;
 220   }
 221 
 222   // Commute monitors from interpreter frame to compiler frame.
 223   assert(jvms()-&gt;monitor_depth() == 0, &quot;should be no active locks at beginning of osr&quot;);
 224   int mcnt = osr_block-&gt;flow()-&gt;monitor_count();
 225   Node *monitors_addr = basic_plus_adr(osr_buf, osr_buf, (max_locals+mcnt*2-1)*wordSize);
 226   for (index = 0; index &lt; mcnt; index++) {
 227     // Make a BoxLockNode for the monitor.
 228     Node *box = _gvn.transform(new BoxLockNode(next_monitor()));
 229 
<span class="line-removed"> 230 </span>
 231     // Displaced headers and locked objects are interleaved in the
 232     // temp OSR buffer.  We only copy the locked objects out here.
 233     // Fetch the locked object from the OSR temp buffer and copy to our fastlock node.
<span class="line-modified"> 234     Node *lock_object = fetch_interpreter_state(index*2, T_OBJECT, monitors_addr, osr_buf);</span>
 235     // Try and copy the displaced header to the BoxNode
<span class="line-modified"> 236     Node *displaced_hdr = fetch_interpreter_state((index*2) + 1, T_ADDRESS, monitors_addr, osr_buf);</span>
<span class="line-removed"> 237 </span>
 238 
 239     store_to_memory(control(), box, displaced_hdr, T_ADDRESS, Compile::AliasIdxRaw, MemNode::unordered);
 240 
 241     // Build a bogus FastLockNode (no code will be generated) and push the
 242     // monitor into our debug info.
 243     const FastLockNode *flock = _gvn.transform(new FastLockNode( 0, lock_object, box ))-&gt;as_FastLock();
 244     map()-&gt;push_monitor(flock);
 245 
 246     // If the lock is our method synchronization lock, tuck it away in
 247     // _sync_lock for return and rethrow exit paths.
 248     if (index == 0 &amp;&amp; method()-&gt;is_synchronized()) {
 249       _synch_lock = flock;
 250     }
 251   }
 252 
 253   // Use the raw liveness computation to make sure that unexpected
 254   // values don&#39;t propagate into the OSR frame.
 255   MethodLivenessResult live_locals = method()-&gt;liveness_at_bci(osr_bci());
 256   if (!live_locals.is_valid()) {
 257     // Degenerate or breakpointed method.
</pre>
<hr />
<pre>
 284         if (C-&gt;log() != NULL) {
 285           C-&gt;log()-&gt;elem(&quot;OSR_mismatch local_index=&#39;%d&#39;&quot;,index);
 286         }
 287         set_local(index, null());
 288         // and ignore it for the loads
 289         continue;
 290       }
 291     }
 292 
 293     // Filter out TOP, HALF, and BOTTOM.  (Cf. ensure_phi.)
 294     if (type == Type::TOP || type == Type::HALF) {
 295       continue;
 296     }
 297     // If the type falls to bottom, then this must be a local that
 298     // is mixing ints and oops or some such.  Forcing it to top
 299     // makes it go dead.
 300     if (type == Type::BOTTOM) {
 301       continue;
 302     }
 303     // Construct code to access the appropriate local.
<span class="line-modified"> 304     BasicType bt = type-&gt;basic_type();</span>
<span class="line-removed"> 305     if (type == TypePtr::NULL_PTR) {</span>
<span class="line-removed"> 306       // Ptr types are mixed together with T_ADDRESS but NULL is</span>
<span class="line-removed"> 307       // really for T_OBJECT types so correct it.</span>
<span class="line-removed"> 308       bt = T_OBJECT;</span>
<span class="line-removed"> 309     }</span>
<span class="line-removed"> 310     Node *value = fetch_interpreter_state(index, bt, locals_addr, osr_buf);</span>
 311     set_local(index, value);
 312   }
 313 
 314   // Extract the needed stack entries from the interpreter frame.
 315   for (index = 0; index &lt; sp(); index++) {
 316     const Type *type = osr_block-&gt;stack_type_at(index);
 317     if (type != Type::TOP) {
 318       // Currently the compiler bails out when attempting to on stack replace
 319       // at a bci with a non-empty stack.  We should not reach here.
 320       ShouldNotReachHere();
 321     }
 322   }
 323 
 324   // End the OSR migration
 325   make_runtime_call(RC_LEAF, OptoRuntime::osr_end_Type(),
 326                     CAST_FROM_FN_PTR(address, SharedRuntime::OSR_migration_end),
 327                     &quot;OSR_migration_end&quot;, TypeRawPtr::BOTTOM,
 328                     osr_buf);
 329 
 330   // Now that the interpreter state is loaded, make sure it will match
</pre>
<hr />
<pre>
 580     }
 581   }
 582 
 583   if (depth() == 1 &amp;&amp; !failing()) {
 584     if (C-&gt;clinit_barrier_on_entry()) {
 585       // Add check to deoptimize the nmethod once the holder class is fully initialized
 586       clinit_deopt();
 587     }
 588 
 589     // Add check to deoptimize the nmethod if RTM state was changed
 590     rtm_deopt();
 591   }
 592 
 593   // Check for bailouts during method entry or RTM state check setup.
 594   if (failing()) {
 595     if (log)  log-&gt;done(&quot;parse&quot;);
 596     C-&gt;set_default_node_notes(caller_nn);
 597     return;
 598   }
 599 





















 600   entry_map = map();  // capture any changes performed by method setup code
 601   assert(jvms()-&gt;endoff() == map()-&gt;req(), &quot;map matches JVMS layout&quot;);
 602 
 603   // We begin parsing as if we have just encountered a jump to the
 604   // method entry.
 605   Block* entry_block = start_block();
 606   assert(entry_block-&gt;start() == (is_osr_parse() ? osr_bci() : 0), &quot;&quot;);
 607   set_map_clone(entry_map);
 608   merge_common(entry_block, entry_block-&gt;next_path_num());
 609 
 610 #ifndef PRODUCT
 611   BytecodeParseHistogram *parse_histogram_obj = new (C-&gt;env()-&gt;arena()) BytecodeParseHistogram(this, C);
 612   set_parse_histogram( parse_histogram_obj );
 613 #endif
 614 
 615   // Parse all the basic blocks.
 616   do_all_blocks();
 617 
 618   C-&gt;set_default_node_notes(caller_nn);
 619 
</pre>
<hr />
<pre>
 762 void Parse::build_exits() {
 763   // make a clone of caller to prevent sharing of side-effects
 764   _exits.set_map(_exits.clone_map());
 765   _exits.clean_stack(_exits.sp());
 766   _exits.sync_jvms();
 767 
 768   RegionNode* region = new RegionNode(1);
 769   record_for_igvn(region);
 770   gvn().set_type_bottom(region);
 771   _exits.set_control(region);
 772 
 773   // Note:  iophi and memphi are not transformed until do_exits.
 774   Node* iophi  = new PhiNode(region, Type::ABIO);
 775   Node* memphi = new PhiNode(region, Type::MEMORY, TypePtr::BOTTOM);
 776   gvn().set_type_bottom(iophi);
 777   gvn().set_type_bottom(memphi);
 778   _exits.set_i_o(iophi);
 779   _exits.set_all_memory(memphi);
 780 
 781   // Add a return value to the exit state.  (Do not push it yet.)
<span class="line-modified"> 782   if (tf()-&gt;range()-&gt;cnt() &gt; TypeFunc::Parms) {</span>
<span class="line-modified"> 783     const Type* ret_type = tf()-&gt;range()-&gt;field_at(TypeFunc::Parms);</span>
 784     if (ret_type-&gt;isa_int()) {
 785       BasicType ret_bt = method()-&gt;return_type()-&gt;basic_type();
 786       if (ret_bt == T_BOOLEAN ||
 787           ret_bt == T_CHAR ||
 788           ret_bt == T_BYTE ||
 789           ret_bt == T_SHORT) {
 790         ret_type = TypeInt::INT;
 791       }
 792     }
 793 
 794     // Don&#39;t &quot;bind&quot; an unloaded return klass to the ret_phi. If the klass
 795     // becomes loaded during the subsequent parsing, the loaded and unloaded
 796     // types will not join when we transform and push in do_exits().
 797     const TypeOopPtr* ret_oop_type = ret_type-&gt;isa_oopptr();
 798     if (ret_oop_type &amp;&amp; !ret_oop_type-&gt;klass()-&gt;is_loaded()) {
 799       ret_type = TypeOopPtr::BOTTOM;
 800     }





 801     int         ret_size = type2size[ret_type-&gt;basic_type()];
 802     Node*       ret_phi  = new PhiNode(region, ret_type);
 803     gvn().set_type_bottom(ret_phi);
 804     _exits.ensure_stack(ret_size);
<span class="line-modified"> 805     assert((int)(tf()-&gt;range()-&gt;cnt() - TypeFunc::Parms) == ret_size, &quot;good tf range&quot;);</span>
 806     assert(method()-&gt;return_type()-&gt;size() == ret_size, &quot;tf agrees w/ method&quot;);
 807     _exits.set_argument(0, ret_phi);  // here is where the parser finds it
 808     // Note:  ret_phi is not yet pushed, until do_exits.
 809   }
 810 }
 811 
<span class="line-removed"> 812 </span>
 813 //----------------------------build_start_state-------------------------------
 814 // Construct a state which contains only the incoming arguments from an
 815 // unknown caller.  The method &amp; bci will be NULL &amp; InvocationEntryBci.
 816 JVMState* Compile::build_start_state(StartNode* start, const TypeFunc* tf) {
<span class="line-modified"> 817   int        arg_size = tf-&gt;domain()-&gt;cnt();</span>
<span class="line-modified"> 818   int        max_size = MAX2(arg_size, (int)tf-&gt;range()-&gt;cnt());</span>
 819   JVMState*  jvms     = new (this) JVMState(max_size - TypeFunc::Parms);
 820   SafePointNode* map  = new SafePointNode(max_size, NULL);


 821   record_for_igvn(map);
 822   assert(arg_size == TypeFunc::Parms + (is_osr_compilation() ? 1 : method()-&gt;arg_size()), &quot;correct arg_size&quot;);
 823   Node_Notes* old_nn = default_node_notes();
 824   if (old_nn != NULL &amp;&amp; has_method()) {
 825     Node_Notes* entry_nn = old_nn-&gt;clone(this);
 826     JVMState* entry_jvms = new(this) JVMState(method(), old_nn-&gt;jvms());
 827     entry_jvms-&gt;set_offsets(0);
 828     entry_jvms-&gt;set_bci(entry_bci());
 829     entry_nn-&gt;set_jvms(entry_jvms);
 830     set_default_node_notes(entry_nn);
 831   }
<span class="line-modified"> 832   uint i;</span>
<span class="line-modified"> 833   for (i = 0; i &lt; (uint)arg_size; i++) {</span>
<span class="line-modified"> 834     Node* parm = initial_gvn()-&gt;transform(new ParmNode(start, i));</span>






















 835     map-&gt;init_req(i, parm);
 836     // Record all these guys for later GVN.
 837     record_for_igvn(parm);
 838   }
<span class="line-modified"> 839   for (; i &lt; map-&gt;req(); i++) {</span>
<span class="line-modified"> 840     map-&gt;init_req(i, top());</span>
 841   }
 842   assert(jvms-&gt;argoff() == TypeFunc::Parms, &quot;parser gets arguments here&quot;);
 843   set_default_node_notes(old_nn);
<span class="line-removed"> 844   map-&gt;set_jvms(jvms);</span>
<span class="line-removed"> 845   jvms-&gt;set_map(map);</span>
 846   return jvms;
 847 }
 848 
 849 //-----------------------------make_node_notes---------------------------------
 850 Node_Notes* Parse::make_node_notes(Node_Notes* caller_nn) {
 851   if (caller_nn == NULL)  return NULL;
 852   Node_Notes* nn = caller_nn-&gt;clone(C);
 853   JVMState* caller_jvms = nn-&gt;jvms();
 854   JVMState* jvms = new (C) JVMState(method(), caller_jvms);
 855   jvms-&gt;set_offsets(0);
 856   jvms-&gt;set_bci(_entry_bci);
 857   nn-&gt;set_jvms(jvms);
 858   return nn;
 859 }
 860 
 861 
 862 //--------------------------return_values--------------------------------------
 863 void Compile::return_values(JVMState* jvms) {
 864   GraphKit kit(jvms);
 865   Node* ret = new ReturnNode(TypeFunc::Parms,
 866                              kit.control(),
 867                              kit.i_o(),
 868                              kit.reset_memory(),
 869                              kit.frameptr(),
 870                              kit.returnadr());
 871   // Add zero or 1 return values
<span class="line-modified"> 872   int ret_size = tf()-&gt;range()-&gt;cnt() - TypeFunc::Parms;</span>
 873   if (ret_size &gt; 0) {
 874     kit.inc_sp(-ret_size);  // pop the return value(s)
 875     kit.sync_jvms();
<span class="line-modified"> 876     ret-&gt;add_req(kit.argument(0));</span>
<span class="line-modified"> 877     // Note:  The second dummy edge is not needed by a ReturnNode.</span>




















 878   }
 879   // bind it to root
 880   root()-&gt;add_req(ret);
 881   record_for_igvn(ret);
 882   initial_gvn()-&gt;transform_no_reclaim(ret);
 883 }
 884 
 885 //------------------------rethrow_exceptions-----------------------------------
 886 // Bind all exception states in the list into a single RethrowNode.
 887 void Compile::rethrow_exceptions(JVMState* jvms) {
 888   GraphKit kit(jvms);
 889   if (!kit.has_exceptions())  return;  // nothing to generate
 890   // Load my combined exception state into the kit, with all phis transformed:
 891   SafePointNode* ex_map = kit.combine_and_pop_all_exception_states();
 892   Node* ex_oop = kit.use_exception_state(ex_map);
 893   RethrowNode* exit = new RethrowNode(kit.control(),
 894                                       kit.i_o(), kit.reset_memory(),
 895                                       kit.frameptr(), kit.returnadr(),
 896                                       // like a return but with exception input
 897                                       ex_oop);
</pre>
<hr />
<pre>
 981   //    to complete, we force all writes to complete.
 982   //
 983   // 2. Experimental VM option is used to force the barrier if any field
 984   //    was written out in the constructor.
 985   //
 986   // 3. On processors which are not CPU_MULTI_COPY_ATOMIC (e.g. PPC64),
 987   //    support_IRIW_for_not_multiple_copy_atomic_cpu selects that
 988   //    MemBarVolatile is used before volatile load instead of after volatile
 989   //    store, so there&#39;s no barrier after the store.
 990   //    We want to guarantee the same behavior as on platforms with total store
 991   //    order, although this is not required by the Java memory model.
 992   //    In this case, we want to enforce visibility of volatile field
 993   //    initializations which are performed in constructors.
 994   //    So as with finals, we add a barrier here.
 995   //
 996   // &quot;All bets are off&quot; unless the first publication occurs after a
 997   // normal return from the constructor.  We do not attempt to detect
 998   // such unusual early publications.  But no barrier is needed on
 999   // exceptional returns, since they cannot publish normally.
1000   //
<span class="line-modified">1001   if (method()-&gt;is_initializer() &amp;&amp;</span>
1002        (wrote_final() ||
1003          (AlwaysSafeConstructors &amp;&amp; wrote_fields()) ||
1004          (support_IRIW_for_not_multiple_copy_atomic_cpu &amp;&amp; wrote_volatile()))) {
1005     _exits.insert_mem_bar(Op_MemBarRelease, alloc_with_final());
1006 
1007     // If Memory barrier is created for final fields write
1008     // and allocation node does not escape the initialize method,
1009     // then barrier introduced by allocation node can be removed.
1010     if (DoEscapeAnalysis &amp;&amp; alloc_with_final()) {
1011       AllocateNode *alloc = AllocateNode::Ideal_allocation(alloc_with_final(), &amp;_gvn);
1012       alloc-&gt;compute_MemBar_redundancy(method());
1013     }
1014     if (PrintOpto &amp;&amp; (Verbose || WizardMode)) {
1015       method()-&gt;print_name();
1016       tty-&gt;print_cr(&quot; writes finals and needs a memory barrier&quot;);
1017     }
1018   }
1019 
1020   // Any method can write a @Stable field; insert memory barriers
1021   // after those also. Can&#39;t bind predecessor allocation node (if any)
1022   // with barrier because allocation doesn&#39;t always dominate
1023   // MemBarRelease.
1024   if (wrote_stable()) {
1025     _exits.insert_mem_bar(Op_MemBarRelease);
1026     if (PrintOpto &amp;&amp; (Verbose || WizardMode)) {
1027       method()-&gt;print_name();
1028       tty-&gt;print_cr(&quot; writes @Stable and needs a memory barrier&quot;);
1029     }
1030   }
1031 
1032   for (MergeMemStream mms(_exits.merged_memory()); mms.next_non_empty(); ) {
1033     // transform each slice of the original memphi:
1034     mms.set_memory(_gvn.transform(mms.memory()));
1035   }
1036   // Clean up input MergeMems created by transforming the slices
1037   _gvn.transform(_exits.merged_memory());
1038 
<span class="line-modified">1039   if (tf()-&gt;range()-&gt;cnt() &gt; TypeFunc::Parms) {</span>
<span class="line-modified">1040     const Type* ret_type = tf()-&gt;range()-&gt;field_at(TypeFunc::Parms);</span>
1041     Node*       ret_phi  = _gvn.transform( _exits.argument(0) );
1042     if (!_exits.control()-&gt;is_top() &amp;&amp; _gvn.type(ret_phi)-&gt;empty()) {
1043       // If the type we set for the ret_phi in build_exits() is too optimistic and
1044       // the ret_phi is top now, there&#39;s an extremely small chance that it may be due to class
1045       // loading.  It could also be due to an error, so mark this method as not compilable because
1046       // otherwise this could lead to an infinite compile loop.
1047       // In any case, this code path is rarely (and never in my testing) reached.
1048       C-&gt;record_method_not_compilable(&quot;Can&#39;t determine return type.&quot;);
1049       return;
1050     }
1051     if (ret_type-&gt;isa_int()) {
1052       BasicType ret_bt = method()-&gt;return_type()-&gt;basic_type();
1053       ret_phi = mask_int_value(ret_phi, ret_bt, &amp;_gvn);
1054     }
1055     _exits.push_node(ret_type-&gt;basic_type(), ret_phi);
1056   }
1057 
1058   // Note:  Logic for creating and optimizing the ReturnNode is in Compile.
1059 
1060   // Unlock along the exceptional paths.
</pre>
<hr />
<pre>
1115 }
1116 
1117 //-----------------------------create_entry_map-------------------------------
1118 // Initialize our parser map to contain the types at method entry.
1119 // For OSR, the map contains a single RawPtr parameter.
1120 // Initial monitor locking for sync. methods is performed by do_method_entry.
1121 SafePointNode* Parse::create_entry_map() {
1122   // Check for really stupid bail-out cases.
1123   uint len = TypeFunc::Parms + method()-&gt;max_locals() + method()-&gt;max_stack();
1124   if (len &gt;= 32760) {
1125     C-&gt;record_method_not_compilable(&quot;too many local variables&quot;);
1126     return NULL;
1127   }
1128 
1129   // clear current replaced nodes that are of no use from here on (map was cloned in build_exits).
1130   _caller-&gt;map()-&gt;delete_replaced_nodes();
1131 
1132   // If this is an inlined method, we may have to do a receiver null check.
1133   if (_caller-&gt;has_method() &amp;&amp; is_normal_parse() &amp;&amp; !method()-&gt;is_static()) {
1134     GraphKit kit(_caller);
<span class="line-modified">1135     kit.null_check_receiver_before_call(method());</span>
1136     _caller = kit.transfer_exceptions_into_jvms();
1137     if (kit.stopped()) {
1138       _exits.add_exception_states_from(_caller);
1139       _exits.set_jvms(_caller);
1140       return NULL;
1141     }
1142   }
1143 
1144   assert(method() != NULL, &quot;parser must have a method&quot;);
1145 
1146   // Create an initial safepoint to hold JVM state during parsing
1147   JVMState* jvms = new (C) JVMState(method(), _caller-&gt;has_method() ? _caller : NULL);
1148   set_map(new SafePointNode(len, jvms));
1149   jvms-&gt;set_map(map());
1150   record_for_igvn(map());
1151   assert(jvms-&gt;endoff() == len, &quot;correct jvms sizing&quot;);
1152 
1153   SafePointNode* inmap = _caller-&gt;map();
1154   assert(inmap != NULL, &quot;must have inmap&quot;);
1155   // In case of null check on receiver above
1156   map()-&gt;transfer_replaced_nodes_from(inmap, _new_idx);
1157 
1158   uint i;
1159 
1160   // Pass thru the predefined input parameters.
1161   for (i = 0; i &lt; TypeFunc::Parms; i++) {
1162     map()-&gt;init_req(i, inmap-&gt;in(i));
1163   }
1164 
1165   if (depth() == 1) {
1166     assert(map()-&gt;memory()-&gt;Opcode() == Op_Parm, &quot;&quot;);
1167     // Insert the memory aliasing node
1168     set_all_memory(reset_memory());
1169   }
1170   assert(merged_memory(), &quot;&quot;);
1171 
1172   // Now add the locals which are initially bound to arguments:
<span class="line-modified">1173   uint arg_size = tf()-&gt;domain()-&gt;cnt();</span>
1174   ensure_stack(arg_size - TypeFunc::Parms);  // OSR methods have funny args
1175   for (i = TypeFunc::Parms; i &lt; arg_size; i++) {
1176     map()-&gt;init_req(i, inmap-&gt;argument(_caller, i - TypeFunc::Parms));
1177   }
1178 
1179   // Clear out the rest of the map (locals and stack)
1180   for (i = arg_size; i &lt; len; i++) {
1181     map()-&gt;init_req(i, top());
1182   }
1183 
1184   SafePointNode* entry_map = stop();
1185   return entry_map;
1186 }
1187 
1188 //-----------------------------do_method_entry--------------------------------
1189 // Emit any code needed in the pseudo-block before BCI zero.
1190 // The main thing to do is lock the receiver of a synchronized method.
1191 void Parse::do_method_entry() {
1192   set_parse_bci(InvocationEntryBci); // Pseudo-BCP
1193   set_sp(0);                         // Java Stack Pointer
</pre>
<hr />
<pre>
1200 
1201   // If the method is synchronized, we need to construct a lock node, attach
1202   // it to the Start node, and pin it there.
1203   if (method()-&gt;is_synchronized()) {
1204     // Insert a FastLockNode right after the Start which takes as arguments
1205     // the current thread pointer, the &quot;this&quot; pointer &amp; the address of the
1206     // stack slot pair used for the lock.  The &quot;this&quot; pointer is a projection
1207     // off the start node, but the locking spot has to be constructed by
1208     // creating a ConLNode of 0, and boxing it with a BoxLockNode.  The BoxLockNode
1209     // becomes the second argument to the FastLockNode call.  The
1210     // FastLockNode becomes the new control parent to pin it to the start.
1211 
1212     // Setup Object Pointer
1213     Node *lock_obj = NULL;
1214     if(method()-&gt;is_static()) {
1215       ciInstance* mirror = _method-&gt;holder()-&gt;java_mirror();
1216       const TypeInstPtr *t_lock = TypeInstPtr::make(mirror);
1217       lock_obj = makecon(t_lock);
1218     } else {                  // Else pass the &quot;this&quot; pointer,
1219       lock_obj = local(0);    // which is Parm0 from StartNode

1220     }
1221     // Clear out dead values from the debug info.
1222     kill_dead_locals();
1223     // Build the FastLockNode
1224     _synch_lock = shared_lock(lock_obj);
1225   }
1226 
1227   // Feed profiling data for parameters to the type system so it can
1228   // propagate it as speculative types
1229   record_profiled_parameters_for_speculation();
1230 
1231   if (depth() == 1) {
1232     increment_and_test_invocation_counter(Tier2CompileThreshold);
1233   }
1234 }
1235 
1236 //------------------------------init_blocks------------------------------------
1237 // Initialize our parser map to contain the types/monitors at method entry.
1238 void Parse::init_blocks() {
1239   // Create the blocks.
</pre>
<hr />
<pre>
1610 //--------------------handle_missing_successor---------------------------------
1611 void Parse::handle_missing_successor(int target_bci) {
1612 #ifndef PRODUCT
1613   Block* b = block();
1614   int trap_bci = b-&gt;flow()-&gt;has_trap()? b-&gt;flow()-&gt;trap_bci(): -1;
1615   tty-&gt;print_cr(&quot;### Missing successor at bci:%d for block #%d (trap_bci:%d)&quot;, target_bci, b-&gt;rpo(), trap_bci);
1616 #endif
1617   ShouldNotReachHere();
1618 }
1619 
1620 //--------------------------merge_common---------------------------------------
1621 void Parse::merge_common(Parse::Block* target, int pnum) {
1622   if (TraceOptoParse) {
1623     tty-&gt;print(&quot;Merging state at block #%d bci:%d&quot;, target-&gt;rpo(), target-&gt;start());
1624   }
1625 
1626   // Zap extra stack slots to top
1627   assert(sp() == target-&gt;start_sp(), &quot;&quot;);
1628   clean_stack(sp());
1629 

































1630   if (!target-&gt;is_merged()) {   // No prior mapping at this bci
1631     if (TraceOptoParse) { tty-&gt;print(&quot; with empty state&quot;);  }
1632 
1633     // If this path is dead, do not bother capturing it as a merge.
1634     // It is &quot;as if&quot; we had 1 fewer predecessors from the beginning.
1635     if (stopped()) {
1636       if (TraceOptoParse)  tty-&gt;print_cr(&quot;, but path is dead and doesn&#39;t count&quot;);
1637       return;
1638     }
1639 
1640     // Make a region if we know there are multiple or unpredictable inputs.
1641     // (Also, if this is a plain fall-through, we might see another region,
1642     // which must not be allowed into this block&#39;s map.)
1643     if (pnum &gt; PhiNode::Input         // Known multiple inputs.
1644         || target-&gt;is_handler()       // These have unpredictable inputs.
1645         || target-&gt;is_loop_head()     // Known multiple inputs
1646         || control()-&gt;is_Region()) {  // We must hide this guy.
1647 
1648       int current_bci = bci();
1649       set_parse_bci(target-&gt;start()); // Set target bci
</pre>
<hr />
<pre>
1663       gvn().set_type(r, Type::CONTROL);
1664       record_for_igvn(r);
1665       // zap all inputs to NULL for debugging (done in Node(uint) constructor)
1666       // for (int j = 1; j &lt; edges+1; j++) { r-&gt;init_req(j, NULL); }
1667       r-&gt;init_req(pnum, control());
1668       set_control(r);
1669       set_parse_bci(current_bci); // Restore bci
1670     }
1671 
1672     // Convert the existing Parser mapping into a mapping at this bci.
1673     store_state_to(target);
1674     assert(target-&gt;is_merged(), &quot;do not come here twice&quot;);
1675 
1676   } else {                      // Prior mapping at this bci
1677     if (TraceOptoParse) {  tty-&gt;print(&quot; with previous state&quot;); }
1678 #ifdef ASSERT
1679     if (target-&gt;is_SEL_head()) {
1680       target-&gt;mark_merged_backedge(block());
1681     }
1682 #endif

1683     // We must not manufacture more phis if the target is already parsed.
1684     bool nophi = target-&gt;is_parsed();
1685 
1686     SafePointNode* newin = map();// Hang on to incoming mapping
1687     Block* save_block = block(); // Hang on to incoming block;
1688     load_state_from(target);    // Get prior mapping
1689 
1690     assert(newin-&gt;jvms()-&gt;locoff() == jvms()-&gt;locoff(), &quot;JVMS layouts agree&quot;);
1691     assert(newin-&gt;jvms()-&gt;stkoff() == jvms()-&gt;stkoff(), &quot;JVMS layouts agree&quot;);
1692     assert(newin-&gt;jvms()-&gt;monoff() == jvms()-&gt;monoff(), &quot;JVMS layouts agree&quot;);
1693     assert(newin-&gt;jvms()-&gt;endoff() == jvms()-&gt;endoff(), &quot;JVMS layouts agree&quot;);
1694 
1695     // Iterate over my current mapping and the old mapping.
1696     // Where different, insert Phi functions.
1697     // Use any existing Phi functions.
1698     assert(control()-&gt;is_Region(), &quot;must be merging to a region&quot;);
1699     RegionNode* r = control()-&gt;as_Region();
1700 
1701     // Compute where to merge into
1702     // Merge incoming control path
1703     r-&gt;init_req(pnum, newin-&gt;control());
1704 
1705     if (pnum == 1) {            // Last merge for this Region?
1706       if (!block()-&gt;flow()-&gt;is_irreducible_entry()) {
1707         Node* result = _gvn.transform_no_reclaim(r);
1708         if (r != result &amp;&amp; TraceOptoParse) {
1709           tty-&gt;print_cr(&quot;Block #%d replace %d with %d&quot;, block()-&gt;rpo(), r-&gt;_idx, result-&gt;_idx);
1710         }
1711       }
1712       record_for_igvn(r);
1713     }
1714 
1715     // Update all the non-control inputs to map:
1716     assert(TypeFunc::Parms == newin-&gt;jvms()-&gt;locoff(), &quot;parser map should contain only youngest jvms&quot;);
1717     bool check_elide_phi = target-&gt;is_SEL_backedge(save_block);

1718     for (uint j = 1; j &lt; newin-&gt;req(); j++) {
1719       Node* m = map()-&gt;in(j);   // Current state of target.
1720       Node* n = newin-&gt;in(j);   // Incoming change to target state.
1721       PhiNode* phi;
<span class="line-modified">1722       if (m-&gt;is_Phi() &amp;&amp; m-&gt;as_Phi()-&gt;region() == r)</span>
1723         phi = m-&gt;as_Phi();
<span class="line-modified">1724       else</span>


1725         phi = NULL;

1726       if (m != n) {             // Different; must merge
1727         switch (j) {
1728         // Frame pointer and Return Address never changes
1729         case TypeFunc::FramePtr:// Drop m, use the original value
1730         case TypeFunc::ReturnAdr:
1731           break;
1732         case TypeFunc::Memory:  // Merge inputs to the MergeMem node
1733           assert(phi == NULL, &quot;the merge contains phis, not vice versa&quot;);
1734           merge_memory_edges(n-&gt;as_MergeMem(), pnum, nophi);
1735           continue;
1736         default:                // All normal stuff
1737           if (phi == NULL) {
1738             const JVMState* jvms = map()-&gt;jvms();
1739             if (EliminateNestedLocks &amp;&amp;
1740                 jvms-&gt;is_mon(j) &amp;&amp; jvms-&gt;is_monitor_box(j)) {
1741               // BoxLock nodes are not commoning.
1742               // Use old BoxLock node as merged box.
1743               assert(newin-&gt;jvms()-&gt;is_monitor_box(j), &quot;sanity&quot;);
1744               // This assert also tests that nodes are BoxLock.
1745               assert(BoxLockNode::same_slot(n, m), &quot;sanity&quot;);
1746               C-&gt;gvn_replace_by(n, m);
1747             } else if (!check_elide_phi || !target-&gt;can_elide_SEL_phi(j)) {
1748               phi = ensure_phi(j, nophi);
1749             }
1750           }
1751           break;
1752         }
1753       }
1754       // At this point, n might be top if:
1755       //  - there is no phi (because TypeFlow detected a conflict), or
1756       //  - the corresponding control edges is top (a dead incoming path)
1757       // It is a bug if we create a phi which sees a garbage value on a live path.
1758 
<span class="line-modified">1759       if (phi != NULL) {</span>























1760         assert(n != top() || r-&gt;in(pnum) == top(), &quot;live value must not be garbage&quot;);
1761         assert(phi-&gt;region() == r, &quot;&quot;);
1762         phi-&gt;set_req(pnum, n);  // Then add &#39;n&#39; to the merge
<span class="line-modified">1763         if (pnum == PhiNode::Input) {</span>
1764           // Last merge for this Phi.
1765           // So far, Phis have had a reasonable type from ciTypeFlow.
1766           // Now _gvn will join that with the meet of current inputs.
1767           // BOTTOM is never permissible here, &#39;cause pessimistically
1768           // Phis of pointers cannot lose the basic pointer type.
1769           debug_only(const Type* bt1 = phi-&gt;bottom_type());
1770           assert(bt1 != Type::BOTTOM, &quot;should not be building conflict phis&quot;);
1771           map()-&gt;set_req(j, _gvn.transform_no_reclaim(phi));
1772           debug_only(const Type* bt2 = phi-&gt;bottom_type());
1773           assert(bt2-&gt;higher_equal_speculative(bt1), &quot;must be consistent with type-flow&quot;);
1774           record_for_igvn(phi);
1775         }
1776       }
1777     } // End of for all values to be merged
1778 
<span class="line-modified">1779     if (pnum == PhiNode::Input &amp;&amp;</span>
<span class="line-removed">1780         !r-&gt;in(0)) {         // The occasional useless Region</span>
1781       assert(control() == r, &quot;&quot;);
1782       set_control(r-&gt;nonnull_req());
1783     }
1784 
1785     map()-&gt;merge_replaced_nodes_with(newin);
1786 
1787     // newin has been subsumed into the lazy merge, and is now dead.
1788     set_block(save_block);
1789 
1790     stop();                     // done with this guy, for now
1791   }
1792 
1793   if (TraceOptoParse) {
1794     tty-&gt;print_cr(&quot; on path %d&quot;, pnum);
1795   }
1796 
1797   // Done with this parser state.
1798   assert(stopped(), &quot;&quot;);
1799 }
1800 
</pre>
<hr />
<pre>
1912 
1913   // Add new path to the region.
1914   uint pnum = r-&gt;req();
1915   r-&gt;add_req(NULL);
1916 
1917   for (uint i = 1; i &lt; map-&gt;req(); i++) {
1918     Node* n = map-&gt;in(i);
1919     if (i == TypeFunc::Memory) {
1920       // Ensure a phi on all currently known memories.
1921       for (MergeMemStream mms(n-&gt;as_MergeMem()); mms.next_non_empty(); ) {
1922         Node* phi = mms.memory();
1923         if (phi-&gt;is_Phi() &amp;&amp; phi-&gt;as_Phi()-&gt;region() == r) {
1924           assert(phi-&gt;req() == pnum, &quot;must be same size as region&quot;);
1925           phi-&gt;add_req(NULL);
1926         }
1927       }
1928     } else {
1929       if (n-&gt;is_Phi() &amp;&amp; n-&gt;as_Phi()-&gt;region() == r) {
1930         assert(n-&gt;req() == pnum, &quot;must be same size as region&quot;);
1931         n-&gt;add_req(NULL);


1932       }
1933     }
1934   }
1935 
1936   return pnum;
1937 }
1938 
1939 //------------------------------ensure_phi-------------------------------------
1940 // Turn the idx&#39;th entry of the current map into a Phi
1941 PhiNode *Parse::ensure_phi(int idx, bool nocreate) {
1942   SafePointNode* map = this-&gt;map();
1943   Node* region = map-&gt;control();
1944   assert(region-&gt;is_Region(), &quot;&quot;);
1945 
1946   Node* o = map-&gt;in(idx);
1947   assert(o != NULL, &quot;&quot;);
1948 
1949   if (o == top())  return NULL; // TOP always merges into TOP
1950 
1951   if (o-&gt;is_Phi() &amp;&amp; o-&gt;as_Phi()-&gt;region() == region) {
1952     return o-&gt;as_Phi();
1953   }




1954 
1955   // Now use a Phi here for merging
1956   assert(!nocreate, &quot;Cannot build a phi for a block already parsed.&quot;);
1957   const JVMState* jvms = map-&gt;jvms();
1958   const Type* t = NULL;
1959   if (jvms-&gt;is_loc(idx)) {
1960     t = block()-&gt;local_type_at(idx - jvms-&gt;locoff());
1961   } else if (jvms-&gt;is_stk(idx)) {
1962     t = block()-&gt;stack_type_at(idx - jvms-&gt;stkoff());
1963   } else if (jvms-&gt;is_mon(idx)) {
1964     assert(!jvms-&gt;is_monitor_box(idx), &quot;no phis for boxes&quot;);
1965     t = TypeInstPtr::BOTTOM; // this is sufficient for a lock object
1966   } else if ((uint)idx &lt; TypeFunc::Parms) {
1967     t = o-&gt;bottom_type();  // Type::RETURN_ADDRESS or such-like.
1968   } else {
1969     assert(false, &quot;no type information for this phi&quot;);
1970   }
1971 
1972   // If the type falls to bottom, then this must be a local that
<span class="line-modified">1973   // is mixing ints and oops or some such.  Forcing it to top</span>
<span class="line-modified">1974   // makes it go dead.</span>
1975   if (t == Type::BOTTOM) {
1976     map-&gt;set_req(idx, top());
1977     return NULL;
1978   }
1979 
1980   // Do not create phis for top either.
1981   // A top on a non-null control flow must be an unused even after the.phi.
1982   if (t == Type::TOP || t == Type::HALF) {
1983     map-&gt;set_req(idx, top());
1984     return NULL;
1985   }
1986 
<span class="line-modified">1987   PhiNode* phi = PhiNode::make(region, o, t);</span>
<span class="line-modified">1988   gvn().set_type(phi, t);</span>
<span class="line-modified">1989   if (C-&gt;do_escape_analysis()) record_for_igvn(phi);</span>
<span class="line-modified">1990   map-&gt;set_req(idx, phi);</span>
<span class="line-modified">1991   return phi;</span>









1992 }
1993 
1994 //--------------------------ensure_memory_phi----------------------------------
1995 // Turn the idx&#39;th slice of the current memory into a Phi
1996 PhiNode *Parse::ensure_memory_phi(int idx, bool nocreate) {
1997   MergeMemNode* mem = merged_memory();
1998   Node* region = control();
1999   assert(region-&gt;is_Region(), &quot;&quot;);
2000 
2001   Node *o = (idx == Compile::AliasIdxBot)? mem-&gt;base_memory(): mem-&gt;memory_at(idx);
2002   assert(o != NULL &amp;&amp; o != top(), &quot;&quot;);
2003 
2004   PhiNode* phi;
2005   if (o-&gt;is_Phi() &amp;&amp; o-&gt;as_Phi()-&gt;region() == region) {
2006     phi = o-&gt;as_Phi();
2007     if (phi == mem-&gt;base_memory() &amp;&amp; idx &gt;= Compile::AliasIdxRaw) {
2008       // clone the shared base memory phi to make a new memory split
2009       assert(!nocreate, &quot;Cannot build a phi for a block already parsed.&quot;);
2010       const Type* t = phi-&gt;bottom_type();
2011       const TypePtr* adr_type = C-&gt;get_adr_type(idx);
</pre>
<hr />
<pre>
2164   Node* cnt = make_load(control(), cnt_adr, TypeInt::INT, T_INT, adr_type, MemNode::unordered);
2165   Node* decr = _gvn.transform(new SubINode(cnt, makecon(TypeInt::ONE)));
2166   store_to_memory(control(), cnt_adr, decr, T_INT, adr_type, MemNode::unordered);
2167   Node *chk   = _gvn.transform(new CmpINode(decr, makecon(TypeInt::ZERO)));
2168   Node* tst   = _gvn.transform(new BoolNode(chk, BoolTest::gt));
2169   { BuildCutout unless(this, tst, PROB_ALWAYS);
2170     uncommon_trap(Deoptimization::Reason_tenured,
2171                   Deoptimization::Action_make_not_entrant);
2172   }
2173 }
2174 
2175 //------------------------------return_current---------------------------------
2176 // Append current _map to _exit_return
2177 void Parse::return_current(Node* value) {
2178   if (RegisterFinalizersAtInit &amp;&amp;
2179       method()-&gt;intrinsic_id() == vmIntrinsics::_Object_init) {
2180     call_register_finalizer();
2181   }
2182 
2183   // Do not set_parse_bci, so that return goo is credited to the return insn.
<span class="line-modified">2184   set_bci(InvocationEntryBci);</span>



2185   if (method()-&gt;is_synchronized() &amp;&amp; GenerateSynchronizationCode) {
2186     shared_unlock(_synch_lock-&gt;box_node(), _synch_lock-&gt;obj_node());
2187   }
2188   if (C-&gt;env()-&gt;dtrace_method_probes()) {
2189     make_dtrace_method_exit(method());
2190   }
<span class="line-removed">2191   SafePointNode* exit_return = _exits.map();</span>
<span class="line-removed">2192   exit_return-&gt;in( TypeFunc::Control  )-&gt;add_req( control() );</span>
<span class="line-removed">2193   exit_return-&gt;in( TypeFunc::I_O      )-&gt;add_req( i_o    () );</span>
<span class="line-removed">2194   Node *mem = exit_return-&gt;in( TypeFunc::Memory   );</span>
<span class="line-removed">2195   for (MergeMemStream mms(mem-&gt;as_MergeMem(), merged_memory()); mms.next_non_empty2(); ) {</span>
<span class="line-removed">2196     if (mms.is_empty()) {</span>
<span class="line-removed">2197       // get a copy of the base memory, and patch just this one input</span>
<span class="line-removed">2198       const TypePtr* adr_type = mms.adr_type(C);</span>
<span class="line-removed">2199       Node* phi = mms.force_memory()-&gt;as_Phi()-&gt;slice_memory(adr_type);</span>
<span class="line-removed">2200       assert(phi-&gt;as_Phi()-&gt;region() == mms.base_memory()-&gt;in(0), &quot;&quot;);</span>
<span class="line-removed">2201       gvn().set_type_bottom(phi);</span>
<span class="line-removed">2202       phi-&gt;del_req(phi-&gt;req()-1);  // prepare to re-patch</span>
<span class="line-removed">2203       mms.set_memory(phi);</span>
<span class="line-removed">2204     }</span>
<span class="line-removed">2205     mms.memory()-&gt;add_req(mms.memory2());</span>
<span class="line-removed">2206   }</span>
<span class="line-removed">2207 </span>
2208   // frame pointer is always same, already captured
2209   if (value != NULL) {
<span class="line-modified">2210     // If returning oops to an interface-return, there is a silent free</span>
<span class="line-modified">2211     // cast from oop to interface allowed by the Verifier.  Make it explicit</span>
<span class="line-modified">2212     // here.</span>
<span class="line-modified">2213     Node* phi = _exits.argument(0);</span>
<span class="line-modified">2214     const TypeInstPtr *tr = phi-&gt;bottom_type()-&gt;isa_instptr();</span>
<span class="line-modified">2215     if (tr &amp;&amp; tr-&gt;klass()-&gt;is_loaded() &amp;&amp;</span>
<span class="line-modified">2216         tr-&gt;klass()-&gt;is_interface()) {</span>
<span class="line-modified">2217       const TypeInstPtr *tp = value-&gt;bottom_type()-&gt;isa_instptr();</span>
<span class="line-modified">2218       if (tp &amp;&amp; tp-&gt;klass()-&gt;is_loaded() &amp;&amp;</span>






















2219           !tp-&gt;klass()-&gt;is_interface()) {
2220         // sharpen the type eagerly; this eases certain assert checking
<span class="line-modified">2221         if (tp-&gt;higher_equal(TypeInstPtr::NOTNULL))</span>
2222           tr = tr-&gt;join_speculative(TypeInstPtr::NOTNULL)-&gt;is_instptr();

2223         value = _gvn.transform(new CheckCastPPNode(0, value, tr));
2224       }
2225     } else {
<span class="line-modified">2226       // Also handle returns of oop-arrays to an arrays-of-interface return</span>
2227       const TypeInstPtr* phi_tip;
2228       const TypeInstPtr* val_tip;
<span class="line-modified">2229       Type::get_arrays_base_elements(phi-&gt;bottom_type(), value-&gt;bottom_type(), &amp;phi_tip, &amp;val_tip);</span>
2230       if (phi_tip != NULL &amp;&amp; phi_tip-&gt;is_loaded() &amp;&amp; phi_tip-&gt;klass()-&gt;is_interface() &amp;&amp;
2231           val_tip != NULL &amp;&amp; val_tip-&gt;is_loaded() &amp;&amp; !val_tip-&gt;klass()-&gt;is_interface()) {
<span class="line-modified">2232         value = _gvn.transform(new CheckCastPPNode(0, value, phi-&gt;bottom_type()));</span>
2233       }
2234     }
2235     phi-&gt;add_req(value);
2236   }
2237 

















2238   if (_first_return) {
2239     _exits.map()-&gt;transfer_replaced_nodes_from(map(), _new_idx);
2240     _first_return = false;
2241   } else {
2242     _exits.map()-&gt;merge_replaced_nodes_with(map());
2243   }
2244 
2245   stop_and_kill_map();          // This CFG path dies here
2246 }
2247 
2248 
2249 //------------------------------add_safepoint----------------------------------
2250 void Parse::add_safepoint() {
2251   // See if we can avoid this safepoint.  No need for a SafePoint immediately
2252   // after a Call (except Leaf Call) or another SafePoint.
2253   Node *proj = control();
2254   uint parms = TypeFunc::Parms+1;
2255   if( proj-&gt;is_Proj() ) {
2256     Node *n0 = proj-&gt;in(0);
2257     if( n0-&gt;is_Catch() ) {
</pre>
</td>
<td>
<hr />
<pre>
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  *
  23  */
  24 
  25 #include &quot;precompiled.hpp&quot;
  26 #include &quot;compiler/compileLog.hpp&quot;
  27 #include &quot;interpreter/linkResolver.hpp&quot;
  28 #include &quot;memory/resourceArea.hpp&quot;
  29 #include &quot;oops/method.hpp&quot;
  30 #include &quot;opto/addnode.hpp&quot;
  31 #include &quot;opto/c2compiler.hpp&quot;
  32 #include &quot;opto/castnode.hpp&quot;
  33 #include &quot;opto/idealGraphPrinter.hpp&quot;
  34 #include &quot;opto/locknode.hpp&quot;
  35 #include &quot;opto/memnode.hpp&quot;
  36 #include &quot;opto/opaquenode.hpp&quot;
  37 #include &quot;opto/parse.hpp&quot;
  38 #include &quot;opto/rootnode.hpp&quot;
  39 #include &quot;opto/runtime.hpp&quot;
<span class="line-added">  40 #include &quot;opto/valuetypenode.hpp&quot;</span>
  41 #include &quot;runtime/arguments.hpp&quot;
  42 #include &quot;runtime/handles.inline.hpp&quot;
  43 #include &quot;runtime/safepointMechanism.hpp&quot;
  44 #include &quot;runtime/sharedRuntime.hpp&quot;
  45 #include &quot;utilities/bitMap.inline.hpp&quot;
  46 #include &quot;utilities/copy.hpp&quot;
  47 
  48 // Static array so we can figure out which bytecodes stop us from compiling
  49 // the most. Some of the non-static variables are needed in bytecodeInfo.cpp
  50 // and eventually should be encapsulated in a proper class (gri 8/18/98).
  51 
  52 #ifndef PRODUCT
  53 int nodes_created              = 0;
  54 int methods_parsed             = 0;
  55 int methods_seen               = 0;
  56 int blocks_parsed              = 0;
  57 int blocks_seen                = 0;
  58 
  59 int explicit_null_checks_inserted = 0;
  60 int explicit_null_checks_elided   = 0;
</pre>
<hr />
<pre>
  86   }
  87   if (all_null_checks_found) {
  88     tty-&gt;print_cr(&quot;%d made implicit (%2d%%)&quot;, implicit_null_checks,
  89                   (100*implicit_null_checks)/all_null_checks_found);
  90   }
  91   if (SharedRuntime::_implicit_null_throws) {
  92     tty-&gt;print_cr(&quot;%d implicit null exceptions at runtime&quot;,
  93                   SharedRuntime::_implicit_null_throws);
  94   }
  95 
  96   if (PrintParseStatistics &amp;&amp; BytecodeParseHistogram::initialized()) {
  97     BytecodeParseHistogram::print();
  98   }
  99 }
 100 #endif
 101 
 102 //------------------------------ON STACK REPLACEMENT---------------------------
 103 
 104 // Construct a node which can be used to get incoming state for
 105 // on stack replacement.
<span class="line-modified"> 106 Node* Parse::fetch_interpreter_state(int index,</span>
<span class="line-modified"> 107                                      const Type* type,</span>
<span class="line-modified"> 108                                      Node* local_addrs,</span>
<span class="line-modified"> 109                                      Node* local_addrs_base) {</span>
<span class="line-added"> 110   BasicType bt = type-&gt;basic_type();</span>
<span class="line-added"> 111   if (type == TypePtr::NULL_PTR) {</span>
<span class="line-added"> 112     // Ptr types are mixed together with T_ADDRESS but NULL is</span>
<span class="line-added"> 113     // really for T_OBJECT types so correct it.</span>
<span class="line-added"> 114     bt = T_OBJECT;</span>
<span class="line-added"> 115   }</span>
 116   Node *mem = memory(Compile::AliasIdxRaw);
 117   Node *adr = basic_plus_adr( local_addrs_base, local_addrs, -index*wordSize );
 118   Node *ctl = control();
 119 
 120   // Very similar to LoadNode::make, except we handle un-aligned longs and
 121   // doubles on Sparc.  Intel can handle them just fine directly.
 122   Node *l = NULL;
 123   switch (bt) {                // Signature is flattened
 124   case T_INT:     l = new LoadINode(ctl, mem, adr, TypeRawPtr::BOTTOM, TypeInt::INT,        MemNode::unordered); break;
 125   case T_FLOAT:   l = new LoadFNode(ctl, mem, adr, TypeRawPtr::BOTTOM, Type::FLOAT,         MemNode::unordered); break;
 126   case T_ADDRESS: l = new LoadPNode(ctl, mem, adr, TypeRawPtr::BOTTOM, TypeRawPtr::BOTTOM,  MemNode::unordered); break;
<span class="line-added"> 127   case T_VALUETYPE:</span>
 128   case T_OBJECT:  l = new LoadPNode(ctl, mem, adr, TypeRawPtr::BOTTOM, TypeInstPtr::BOTTOM, MemNode::unordered); break;
 129   case T_LONG:
 130   case T_DOUBLE: {
 131     // Since arguments are in reverse order, the argument address &#39;adr&#39;
 132     // refers to the back half of the long/double.  Recompute adr.
 133     adr = basic_plus_adr(local_addrs_base, local_addrs, -(index+1)*wordSize);
 134     if (Matcher::misaligned_doubles_ok) {
 135       l = (bt == T_DOUBLE)
 136         ? (Node*)new LoadDNode(ctl, mem, adr, TypeRawPtr::BOTTOM, Type::DOUBLE, MemNode::unordered)
 137         : (Node*)new LoadLNode(ctl, mem, adr, TypeRawPtr::BOTTOM, TypeLong::LONG, MemNode::unordered);
 138     } else {
 139       l = (bt == T_DOUBLE)
 140         ? (Node*)new LoadD_unalignedNode(ctl, mem, adr, TypeRawPtr::BOTTOM, MemNode::unordered)
 141         : (Node*)new LoadL_unalignedNode(ctl, mem, adr, TypeRawPtr::BOTTOM, MemNode::unordered);
 142     }
 143     break;
 144   }
 145   default: ShouldNotReachHere();
 146   }
 147   return _gvn.transform(l);
 148 }
 149 
 150 // Helper routine to prevent the interpreter from handing
 151 // unexpected typestate to an OSR method.
 152 // The Node l is a value newly dug out of the interpreter frame.
 153 // The type is the type predicted by ciTypeFlow.  Note that it is
 154 // not a general type, but can only come from Type::get_typeflow_type.
 155 // The safepoint is a map which will feed an uncommon trap.
 156 Node* Parse::check_interpreter_type(Node* l, const Type* type,
 157                                     SafePointNode* &amp;bad_type_exit) {
<span class="line-modified"> 158   const TypeOopPtr* tp = type-&gt;isa_oopptr();</span>
<span class="line-added"> 159   if (type-&gt;isa_valuetype() != NULL) {</span>
<span class="line-added"> 160     // The interpreter passes value types as oops</span>
<span class="line-added"> 161     tp = TypeOopPtr::make_from_klass(type-&gt;value_klass());</span>
<span class="line-added"> 162     tp = tp-&gt;join_speculative(TypePtr::NOTNULL)-&gt;is_oopptr();</span>
 163   }
 164 
 165   // TypeFlow may assert null-ness if a type appears unloaded.
 166   if (type == TypePtr::NULL_PTR ||
 167       (tp != NULL &amp;&amp; !tp-&gt;klass()-&gt;is_loaded())) {
 168     // Value must be null, not a real oop.
 169     Node* chk = _gvn.transform( new CmpPNode(l, null()) );
 170     Node* tst = _gvn.transform( new BoolNode(chk, BoolTest::eq) );
 171     IfNode* iff = create_and_map_if(control(), tst, PROB_MAX, COUNT_UNKNOWN);
 172     set_control(_gvn.transform( new IfTrueNode(iff) ));
 173     Node* bad_type = _gvn.transform( new IfFalseNode(iff) );
 174     bad_type_exit-&gt;control()-&gt;add_req(bad_type);
 175     l = null();
 176   }
 177 
 178   // Typeflow can also cut off paths from the CFG, based on
 179   // types which appear unloaded, or call sites which appear unlinked.
 180   // When paths are cut off, values at later merge points can rise
 181   // toward more specific classes.  Make sure these specific classes
 182   // are still in effect.
 183   if (tp != NULL &amp;&amp; tp-&gt;klass() != C-&gt;env()-&gt;Object_klass()) {
 184     // TypeFlow asserted a specific object type.  Value must have that type.
 185     Node* bad_type_ctrl = NULL;
<span class="line-added"> 186     if (tp-&gt;is_valuetypeptr() &amp;&amp; !tp-&gt;maybe_null()) {</span>
<span class="line-added"> 187       // Check value types for null here to prevent checkcast from adding an</span>
<span class="line-added"> 188       // exception state before the bytecode entry (use &#39;bad_type_ctrl&#39; instead).</span>
<span class="line-added"> 189       l = null_check_oop(l, &amp;bad_type_ctrl);</span>
<span class="line-added"> 190       bad_type_exit-&gt;control()-&gt;add_req(bad_type_ctrl);</span>
<span class="line-added"> 191     }</span>
 192     l = gen_checkcast(l, makecon(TypeKlassPtr::make(tp-&gt;klass())), &amp;bad_type_ctrl);
 193     bad_type_exit-&gt;control()-&gt;add_req(bad_type_ctrl);
 194   }



 195   assert(_gvn.type(l)-&gt;higher_equal(type), &quot;must constrain OSR typestate&quot;);
 196   return l;
 197 }
 198 
 199 // Helper routine which sets up elements of the initial parser map when
 200 // performing a parse for on stack replacement.  Add values into map.
 201 // The only parameter contains the address of a interpreter arguments.
 202 void Parse::load_interpreter_state(Node* osr_buf) {
 203   int index;
 204   int max_locals = jvms()-&gt;loc_size();
 205   int max_stack  = jvms()-&gt;stk_size();
 206 

 207   // Mismatch between method and jvms can occur since map briefly held
 208   // an OSR entry state (which takes up one RawPtr word).
 209   assert(max_locals == method()-&gt;max_locals(), &quot;sanity&quot;);
 210   assert(max_stack  &gt;= method()-&gt;max_stack(),  &quot;sanity&quot;);
 211   assert((int)jvms()-&gt;endoff() == TypeFunc::Parms + max_locals + max_stack, &quot;sanity&quot;);
 212   assert((int)jvms()-&gt;endoff() == (int)map()-&gt;req(), &quot;sanity&quot;);
 213 
 214   // Find the start block.
 215   Block* osr_block = start_block();
 216   assert(osr_block-&gt;start() == osr_bci(), &quot;sanity&quot;);
 217 
 218   // Set initial BCI.
 219   set_parse_bci(osr_block-&gt;start());
 220 
 221   // Set initial stack depth.
 222   set_sp(osr_block-&gt;start_sp());
 223 
 224   // Check bailouts.  We currently do not perform on stack replacement
 225   // of loops in catch blocks or loops which branch with a non-empty stack.
 226   if (sp() != 0) {
 227     C-&gt;record_method_not_compilable(&quot;OSR starts with non-empty stack&quot;);
 228     return;
 229   }
 230   // Do not OSR inside finally clauses:
 231   if (osr_block-&gt;has_trap_at(osr_block-&gt;start())) {
 232     C-&gt;record_method_not_compilable(&quot;OSR starts with an immediate trap&quot;);
 233     return;
 234   }
 235 
 236   // Commute monitors from interpreter frame to compiler frame.
 237   assert(jvms()-&gt;monitor_depth() == 0, &quot;should be no active locks at beginning of osr&quot;);
 238   int mcnt = osr_block-&gt;flow()-&gt;monitor_count();
 239   Node *monitors_addr = basic_plus_adr(osr_buf, osr_buf, (max_locals+mcnt*2-1)*wordSize);
 240   for (index = 0; index &lt; mcnt; index++) {
 241     // Make a BoxLockNode for the monitor.
 242     Node *box = _gvn.transform(new BoxLockNode(next_monitor()));
 243 

 244     // Displaced headers and locked objects are interleaved in the
 245     // temp OSR buffer.  We only copy the locked objects out here.
 246     // Fetch the locked object from the OSR temp buffer and copy to our fastlock node.
<span class="line-modified"> 247     Node* lock_object = fetch_interpreter_state(index*2, Type::get_const_basic_type(T_OBJECT), monitors_addr, osr_buf);</span>
 248     // Try and copy the displaced header to the BoxNode
<span class="line-modified"> 249     Node* displaced_hdr = fetch_interpreter_state((index*2) + 1, Type::get_const_basic_type(T_ADDRESS), monitors_addr, osr_buf);</span>

 250 
 251     store_to_memory(control(), box, displaced_hdr, T_ADDRESS, Compile::AliasIdxRaw, MemNode::unordered);
 252 
 253     // Build a bogus FastLockNode (no code will be generated) and push the
 254     // monitor into our debug info.
 255     const FastLockNode *flock = _gvn.transform(new FastLockNode( 0, lock_object, box ))-&gt;as_FastLock();
 256     map()-&gt;push_monitor(flock);
 257 
 258     // If the lock is our method synchronization lock, tuck it away in
 259     // _sync_lock for return and rethrow exit paths.
 260     if (index == 0 &amp;&amp; method()-&gt;is_synchronized()) {
 261       _synch_lock = flock;
 262     }
 263   }
 264 
 265   // Use the raw liveness computation to make sure that unexpected
 266   // values don&#39;t propagate into the OSR frame.
 267   MethodLivenessResult live_locals = method()-&gt;liveness_at_bci(osr_bci());
 268   if (!live_locals.is_valid()) {
 269     // Degenerate or breakpointed method.
</pre>
<hr />
<pre>
 296         if (C-&gt;log() != NULL) {
 297           C-&gt;log()-&gt;elem(&quot;OSR_mismatch local_index=&#39;%d&#39;&quot;,index);
 298         }
 299         set_local(index, null());
 300         // and ignore it for the loads
 301         continue;
 302       }
 303     }
 304 
 305     // Filter out TOP, HALF, and BOTTOM.  (Cf. ensure_phi.)
 306     if (type == Type::TOP || type == Type::HALF) {
 307       continue;
 308     }
 309     // If the type falls to bottom, then this must be a local that
 310     // is mixing ints and oops or some such.  Forcing it to top
 311     // makes it go dead.
 312     if (type == Type::BOTTOM) {
 313       continue;
 314     }
 315     // Construct code to access the appropriate local.
<span class="line-modified"> 316     Node* value = fetch_interpreter_state(index, type, locals_addr, osr_buf);</span>






 317     set_local(index, value);
 318   }
 319 
 320   // Extract the needed stack entries from the interpreter frame.
 321   for (index = 0; index &lt; sp(); index++) {
 322     const Type *type = osr_block-&gt;stack_type_at(index);
 323     if (type != Type::TOP) {
 324       // Currently the compiler bails out when attempting to on stack replace
 325       // at a bci with a non-empty stack.  We should not reach here.
 326       ShouldNotReachHere();
 327     }
 328   }
 329 
 330   // End the OSR migration
 331   make_runtime_call(RC_LEAF, OptoRuntime::osr_end_Type(),
 332                     CAST_FROM_FN_PTR(address, SharedRuntime::OSR_migration_end),
 333                     &quot;OSR_migration_end&quot;, TypeRawPtr::BOTTOM,
 334                     osr_buf);
 335 
 336   // Now that the interpreter state is loaded, make sure it will match
</pre>
<hr />
<pre>
 586     }
 587   }
 588 
 589   if (depth() == 1 &amp;&amp; !failing()) {
 590     if (C-&gt;clinit_barrier_on_entry()) {
 591       // Add check to deoptimize the nmethod once the holder class is fully initialized
 592       clinit_deopt();
 593     }
 594 
 595     // Add check to deoptimize the nmethod if RTM state was changed
 596     rtm_deopt();
 597   }
 598 
 599   // Check for bailouts during method entry or RTM state check setup.
 600   if (failing()) {
 601     if (log)  log-&gt;done(&quot;parse&quot;);
 602     C-&gt;set_default_node_notes(caller_nn);
 603     return;
 604   }
 605 
<span class="line-added"> 606   // Handle value type arguments</span>
<span class="line-added"> 607   int arg_size_sig = tf()-&gt;domain_sig()-&gt;cnt();</span>
<span class="line-added"> 608   for (uint i = 0; i &lt; (uint)arg_size_sig; i++) {</span>
<span class="line-added"> 609     Node* parm = map()-&gt;in(i);</span>
<span class="line-added"> 610     const Type* t = _gvn.type(parm);</span>
<span class="line-added"> 611     if (t-&gt;is_valuetypeptr() &amp;&amp; t-&gt;value_klass()-&gt;is_scalarizable() &amp;&amp; !t-&gt;maybe_null()) {</span>
<span class="line-added"> 612       // Create ValueTypeNode from the oop and replace the parameter</span>
<span class="line-added"> 613       Node* vt = ValueTypeNode::make_from_oop(this, parm, t-&gt;value_klass());</span>
<span class="line-added"> 614       map()-&gt;replace_edge(parm, vt);</span>
<span class="line-added"> 615     } else if (UseTypeSpeculation &amp;&amp; (i == (uint)(arg_size_sig - 1)) &amp;&amp; !is_osr_parse() &amp;&amp;</span>
<span class="line-added"> 616                method()-&gt;has_vararg() &amp;&amp; t-&gt;isa_aryptr() != NULL &amp;&amp; !t-&gt;is_aryptr()-&gt;is_not_null_free()) {</span>
<span class="line-added"> 617       // Speculate on varargs Object array being not null-free (and therefore also not flattened)</span>
<span class="line-added"> 618       const TypePtr* spec_type = t-&gt;speculative();</span>
<span class="line-added"> 619       spec_type = (spec_type != NULL &amp;&amp; spec_type-&gt;isa_aryptr() != NULL) ? spec_type : t-&gt;is_aryptr();</span>
<span class="line-added"> 620       spec_type = spec_type-&gt;remove_speculative()-&gt;is_aryptr()-&gt;cast_to_not_null_free();</span>
<span class="line-added"> 621       spec_type = TypeOopPtr::make(TypePtr::BotPTR, Type::Offset::bottom, TypeOopPtr::InstanceBot, spec_type);</span>
<span class="line-added"> 622       Node* cast = _gvn.transform(new CheckCastPPNode(control(), parm, t-&gt;join_speculative(spec_type)));</span>
<span class="line-added"> 623       replace_in_map(parm, cast);</span>
<span class="line-added"> 624     }</span>
<span class="line-added"> 625   }</span>
<span class="line-added"> 626 </span>
 627   entry_map = map();  // capture any changes performed by method setup code
 628   assert(jvms()-&gt;endoff() == map()-&gt;req(), &quot;map matches JVMS layout&quot;);
 629 
 630   // We begin parsing as if we have just encountered a jump to the
 631   // method entry.
 632   Block* entry_block = start_block();
 633   assert(entry_block-&gt;start() == (is_osr_parse() ? osr_bci() : 0), &quot;&quot;);
 634   set_map_clone(entry_map);
 635   merge_common(entry_block, entry_block-&gt;next_path_num());
 636 
 637 #ifndef PRODUCT
 638   BytecodeParseHistogram *parse_histogram_obj = new (C-&gt;env()-&gt;arena()) BytecodeParseHistogram(this, C);
 639   set_parse_histogram( parse_histogram_obj );
 640 #endif
 641 
 642   // Parse all the basic blocks.
 643   do_all_blocks();
 644 
 645   C-&gt;set_default_node_notes(caller_nn);
 646 
</pre>
<hr />
<pre>
 789 void Parse::build_exits() {
 790   // make a clone of caller to prevent sharing of side-effects
 791   _exits.set_map(_exits.clone_map());
 792   _exits.clean_stack(_exits.sp());
 793   _exits.sync_jvms();
 794 
 795   RegionNode* region = new RegionNode(1);
 796   record_for_igvn(region);
 797   gvn().set_type_bottom(region);
 798   _exits.set_control(region);
 799 
 800   // Note:  iophi and memphi are not transformed until do_exits.
 801   Node* iophi  = new PhiNode(region, Type::ABIO);
 802   Node* memphi = new PhiNode(region, Type::MEMORY, TypePtr::BOTTOM);
 803   gvn().set_type_bottom(iophi);
 804   gvn().set_type_bottom(memphi);
 805   _exits.set_i_o(iophi);
 806   _exits.set_all_memory(memphi);
 807 
 808   // Add a return value to the exit state.  (Do not push it yet.)
<span class="line-modified"> 809   if (tf()-&gt;range_sig()-&gt;cnt() &gt; TypeFunc::Parms) {</span>
<span class="line-modified"> 810     const Type* ret_type = tf()-&gt;range_sig()-&gt;field_at(TypeFunc::Parms);</span>
 811     if (ret_type-&gt;isa_int()) {
 812       BasicType ret_bt = method()-&gt;return_type()-&gt;basic_type();
 813       if (ret_bt == T_BOOLEAN ||
 814           ret_bt == T_CHAR ||
 815           ret_bt == T_BYTE ||
 816           ret_bt == T_SHORT) {
 817         ret_type = TypeInt::INT;
 818       }
 819     }
 820 
 821     // Don&#39;t &quot;bind&quot; an unloaded return klass to the ret_phi. If the klass
 822     // becomes loaded during the subsequent parsing, the loaded and unloaded
 823     // types will not join when we transform and push in do_exits().
 824     const TypeOopPtr* ret_oop_type = ret_type-&gt;isa_oopptr();
 825     if (ret_oop_type &amp;&amp; !ret_oop_type-&gt;klass()-&gt;is_loaded()) {
 826       ret_type = TypeOopPtr::BOTTOM;
 827     }
<span class="line-added"> 828     if ((_caller-&gt;has_method() || tf()-&gt;returns_value_type_as_fields()) &amp;&amp;</span>
<span class="line-added"> 829         ret_type-&gt;is_valuetypeptr() &amp;&amp; ret_type-&gt;value_klass()-&gt;is_scalarizable() &amp;&amp; !ret_type-&gt;maybe_null()) {</span>
<span class="line-added"> 830       // Scalarize value type return when inlining or with multiple return values</span>
<span class="line-added"> 831       ret_type = TypeValueType::make(ret_type-&gt;value_klass());</span>
<span class="line-added"> 832     }</span>
 833     int         ret_size = type2size[ret_type-&gt;basic_type()];
 834     Node*       ret_phi  = new PhiNode(region, ret_type);
 835     gvn().set_type_bottom(ret_phi);
 836     _exits.ensure_stack(ret_size);
<span class="line-modified"> 837     assert((int)(tf()-&gt;range_sig()-&gt;cnt() - TypeFunc::Parms) == ret_size, &quot;good tf range&quot;);</span>
 838     assert(method()-&gt;return_type()-&gt;size() == ret_size, &quot;tf agrees w/ method&quot;);
 839     _exits.set_argument(0, ret_phi);  // here is where the parser finds it
 840     // Note:  ret_phi is not yet pushed, until do_exits.
 841   }
 842 }
 843 

 844 //----------------------------build_start_state-------------------------------
 845 // Construct a state which contains only the incoming arguments from an
 846 // unknown caller.  The method &amp; bci will be NULL &amp; InvocationEntryBci.
 847 JVMState* Compile::build_start_state(StartNode* start, const TypeFunc* tf) {
<span class="line-modified"> 848   int        arg_size = tf-&gt;domain_sig()-&gt;cnt();</span>
<span class="line-modified"> 849   int        max_size = MAX2(arg_size, (int)tf-&gt;range_cc()-&gt;cnt());</span>
 850   JVMState*  jvms     = new (this) JVMState(max_size - TypeFunc::Parms);
 851   SafePointNode* map  = new SafePointNode(max_size, NULL);
<span class="line-added"> 852   map-&gt;set_jvms(jvms);</span>
<span class="line-added"> 853   jvms-&gt;set_map(map);</span>
 854   record_for_igvn(map);
 855   assert(arg_size == TypeFunc::Parms + (is_osr_compilation() ? 1 : method()-&gt;arg_size()), &quot;correct arg_size&quot;);
 856   Node_Notes* old_nn = default_node_notes();
 857   if (old_nn != NULL &amp;&amp; has_method()) {
 858     Node_Notes* entry_nn = old_nn-&gt;clone(this);
 859     JVMState* entry_jvms = new(this) JVMState(method(), old_nn-&gt;jvms());
 860     entry_jvms-&gt;set_offsets(0);
 861     entry_jvms-&gt;set_bci(entry_bci());
 862     entry_nn-&gt;set_jvms(entry_jvms);
 863     set_default_node_notes(entry_nn);
 864   }
<span class="line-modified"> 865   PhaseGVN&amp; gvn = *initial_gvn();</span>
<span class="line-modified"> 866   uint j = 0;</span>
<span class="line-modified"> 867   ExtendedSignature sig_cc = ExtendedSignature(method()-&gt;get_sig_cc(), SigEntryFilter());</span>
<span class="line-added"> 868   for (uint i = 0; i &lt; (uint)arg_size; i++) {</span>
<span class="line-added"> 869     const Type* t = tf-&gt;domain_sig()-&gt;field_at(i);</span>
<span class="line-added"> 870     Node* parm = NULL;</span>
<span class="line-added"> 871     if (has_scalarized_args() &amp;&amp; t-&gt;is_valuetypeptr() &amp;&amp; !t-&gt;maybe_null()) {</span>
<span class="line-added"> 872       // Value type arguments are not passed by reference: we get an argument per</span>
<span class="line-added"> 873       // field of the value type. Build ValueTypeNodes from the value type arguments.</span>
<span class="line-added"> 874       GraphKit kit(jvms, &amp;gvn);</span>
<span class="line-added"> 875       kit.set_control(map-&gt;control());</span>
<span class="line-added"> 876       Node* old_mem = map-&gt;memory();</span>
<span class="line-added"> 877       // Use immutable memory for value type loads and restore it below</span>
<span class="line-added"> 878       // TODO make sure value types are always loaded from immutable memory</span>
<span class="line-added"> 879       kit.set_all_memory(C-&gt;immutable_memory());</span>
<span class="line-added"> 880       parm = ValueTypeNode::make_from_multi(&amp;kit, start, sig_cc, t-&gt;value_klass(), j, true);</span>
<span class="line-added"> 881       map-&gt;set_control(kit.control());</span>
<span class="line-added"> 882       map-&gt;set_memory(old_mem);</span>
<span class="line-added"> 883     } else {</span>
<span class="line-added"> 884       parm = gvn.transform(new ParmNode(start, j++));</span>
<span class="line-added"> 885       BasicType bt = t-&gt;basic_type();</span>
<span class="line-added"> 886       while (i &gt;= TypeFunc::Parms &amp;&amp; !is_osr_compilation() &amp;&amp; SigEntry::next_is_reserved(sig_cc, bt, true)) {</span>
<span class="line-added"> 887         j += type2size[bt]; // Skip reserved arguments</span>
<span class="line-added"> 888       }</span>
<span class="line-added"> 889     }</span>
 890     map-&gt;init_req(i, parm);
 891     // Record all these guys for later GVN.
 892     record_for_igvn(parm);
 893   }
<span class="line-modified"> 894   for (; j &lt; map-&gt;req(); j++) {</span>
<span class="line-modified"> 895     map-&gt;init_req(j, top());</span>
 896   }
 897   assert(jvms-&gt;argoff() == TypeFunc::Parms, &quot;parser gets arguments here&quot;);
 898   set_default_node_notes(old_nn);


 899   return jvms;
 900 }
 901 
 902 //-----------------------------make_node_notes---------------------------------
 903 Node_Notes* Parse::make_node_notes(Node_Notes* caller_nn) {
 904   if (caller_nn == NULL)  return NULL;
 905   Node_Notes* nn = caller_nn-&gt;clone(C);
 906   JVMState* caller_jvms = nn-&gt;jvms();
 907   JVMState* jvms = new (C) JVMState(method(), caller_jvms);
 908   jvms-&gt;set_offsets(0);
 909   jvms-&gt;set_bci(_entry_bci);
 910   nn-&gt;set_jvms(jvms);
 911   return nn;
 912 }
 913 
 914 
 915 //--------------------------return_values--------------------------------------
 916 void Compile::return_values(JVMState* jvms) {
 917   GraphKit kit(jvms);
 918   Node* ret = new ReturnNode(TypeFunc::Parms,
 919                              kit.control(),
 920                              kit.i_o(),
 921                              kit.reset_memory(),
 922                              kit.frameptr(),
 923                              kit.returnadr());
 924   // Add zero or 1 return values
<span class="line-modified"> 925   int ret_size = tf()-&gt;range_sig()-&gt;cnt() - TypeFunc::Parms;</span>
 926   if (ret_size &gt; 0) {
 927     kit.inc_sp(-ret_size);  // pop the return value(s)
 928     kit.sync_jvms();
<span class="line-modified"> 929     Node* res = kit.argument(0);</span>
<span class="line-modified"> 930     if (tf()-&gt;returns_value_type_as_fields()) {</span>
<span class="line-added"> 931       // Multiple return values (value type fields): add as many edges</span>
<span class="line-added"> 932       // to the Return node as returned values.</span>
<span class="line-added"> 933       assert(res-&gt;is_ValueType(), &quot;what else supports multi value return?&quot;);</span>
<span class="line-added"> 934       ValueTypeNode* vt = res-&gt;as_ValueType();</span>
<span class="line-added"> 935       ret-&gt;add_req_batch(NULL, tf()-&gt;range_cc()-&gt;cnt() - TypeFunc::Parms);</span>
<span class="line-added"> 936       if (vt-&gt;is_allocated(&amp;kit.gvn()) &amp;&amp; !StressInlineTypeReturnedAsFields) {</span>
<span class="line-added"> 937         ret-&gt;init_req(TypeFunc::Parms, vt-&gt;get_oop());</span>
<span class="line-added"> 938       } else {</span>
<span class="line-added"> 939         ret-&gt;init_req(TypeFunc::Parms, vt-&gt;tagged_klass(kit.gvn()));</span>
<span class="line-added"> 940       }</span>
<span class="line-added"> 941       const Array&lt;SigEntry&gt;* sig_array = vt-&gt;type()-&gt;value_klass()-&gt;extended_sig();</span>
<span class="line-added"> 942       GrowableArray&lt;SigEntry&gt; sig = GrowableArray&lt;SigEntry&gt;(sig_array-&gt;length());</span>
<span class="line-added"> 943       sig.appendAll(sig_array);</span>
<span class="line-added"> 944       ExtendedSignature sig_cc = ExtendedSignature(&amp;sig, SigEntryFilter());</span>
<span class="line-added"> 945       uint idx = TypeFunc::Parms+1;</span>
<span class="line-added"> 946       vt-&gt;pass_fields(&amp;kit, ret, sig_cc, idx);</span>
<span class="line-added"> 947     } else {</span>
<span class="line-added"> 948       ret-&gt;add_req(res);</span>
<span class="line-added"> 949       // Note:  The second dummy edge is not needed by a ReturnNode.</span>
<span class="line-added"> 950     }</span>
 951   }
 952   // bind it to root
 953   root()-&gt;add_req(ret);
 954   record_for_igvn(ret);
 955   initial_gvn()-&gt;transform_no_reclaim(ret);
 956 }
 957 
 958 //------------------------rethrow_exceptions-----------------------------------
 959 // Bind all exception states in the list into a single RethrowNode.
 960 void Compile::rethrow_exceptions(JVMState* jvms) {
 961   GraphKit kit(jvms);
 962   if (!kit.has_exceptions())  return;  // nothing to generate
 963   // Load my combined exception state into the kit, with all phis transformed:
 964   SafePointNode* ex_map = kit.combine_and_pop_all_exception_states();
 965   Node* ex_oop = kit.use_exception_state(ex_map);
 966   RethrowNode* exit = new RethrowNode(kit.control(),
 967                                       kit.i_o(), kit.reset_memory(),
 968                                       kit.frameptr(), kit.returnadr(),
 969                                       // like a return but with exception input
 970                                       ex_oop);
</pre>
<hr />
<pre>
1054   //    to complete, we force all writes to complete.
1055   //
1056   // 2. Experimental VM option is used to force the barrier if any field
1057   //    was written out in the constructor.
1058   //
1059   // 3. On processors which are not CPU_MULTI_COPY_ATOMIC (e.g. PPC64),
1060   //    support_IRIW_for_not_multiple_copy_atomic_cpu selects that
1061   //    MemBarVolatile is used before volatile load instead of after volatile
1062   //    store, so there&#39;s no barrier after the store.
1063   //    We want to guarantee the same behavior as on platforms with total store
1064   //    order, although this is not required by the Java memory model.
1065   //    In this case, we want to enforce visibility of volatile field
1066   //    initializations which are performed in constructors.
1067   //    So as with finals, we add a barrier here.
1068   //
1069   // &quot;All bets are off&quot; unless the first publication occurs after a
1070   // normal return from the constructor.  We do not attempt to detect
1071   // such unusual early publications.  But no barrier is needed on
1072   // exceptional returns, since they cannot publish normally.
1073   //
<span class="line-modified">1074   if (method()-&gt;is_object_constructor_or_class_initializer() &amp;&amp;</span>
1075        (wrote_final() ||
1076          (AlwaysSafeConstructors &amp;&amp; wrote_fields()) ||
1077          (support_IRIW_for_not_multiple_copy_atomic_cpu &amp;&amp; wrote_volatile()))) {
1078     _exits.insert_mem_bar(Op_MemBarRelease, alloc_with_final());
1079 
1080     // If Memory barrier is created for final fields write
1081     // and allocation node does not escape the initialize method,
1082     // then barrier introduced by allocation node can be removed.
1083     if (DoEscapeAnalysis &amp;&amp; alloc_with_final()) {
1084       AllocateNode *alloc = AllocateNode::Ideal_allocation(alloc_with_final(), &amp;_gvn);
1085       alloc-&gt;compute_MemBar_redundancy(method());
1086     }
1087     if (PrintOpto &amp;&amp; (Verbose || WizardMode)) {
1088       method()-&gt;print_name();
1089       tty-&gt;print_cr(&quot; writes finals and needs a memory barrier&quot;);
1090     }
1091   }
1092 
1093   // Any method can write a @Stable field; insert memory barriers
1094   // after those also. Can&#39;t bind predecessor allocation node (if any)
1095   // with barrier because allocation doesn&#39;t always dominate
1096   // MemBarRelease.
1097   if (wrote_stable()) {
1098     _exits.insert_mem_bar(Op_MemBarRelease);
1099     if (PrintOpto &amp;&amp; (Verbose || WizardMode)) {
1100       method()-&gt;print_name();
1101       tty-&gt;print_cr(&quot; writes @Stable and needs a memory barrier&quot;);
1102     }
1103   }
1104 
1105   for (MergeMemStream mms(_exits.merged_memory()); mms.next_non_empty(); ) {
1106     // transform each slice of the original memphi:
1107     mms.set_memory(_gvn.transform(mms.memory()));
1108   }
1109   // Clean up input MergeMems created by transforming the slices
1110   _gvn.transform(_exits.merged_memory());
1111 
<span class="line-modified">1112   if (tf()-&gt;range_sig()-&gt;cnt() &gt; TypeFunc::Parms) {</span>
<span class="line-modified">1113     const Type* ret_type = tf()-&gt;range_sig()-&gt;field_at(TypeFunc::Parms);</span>
1114     Node*       ret_phi  = _gvn.transform( _exits.argument(0) );
1115     if (!_exits.control()-&gt;is_top() &amp;&amp; _gvn.type(ret_phi)-&gt;empty()) {
1116       // If the type we set for the ret_phi in build_exits() is too optimistic and
1117       // the ret_phi is top now, there&#39;s an extremely small chance that it may be due to class
1118       // loading.  It could also be due to an error, so mark this method as not compilable because
1119       // otherwise this could lead to an infinite compile loop.
1120       // In any case, this code path is rarely (and never in my testing) reached.
1121       C-&gt;record_method_not_compilable(&quot;Can&#39;t determine return type.&quot;);
1122       return;
1123     }
1124     if (ret_type-&gt;isa_int()) {
1125       BasicType ret_bt = method()-&gt;return_type()-&gt;basic_type();
1126       ret_phi = mask_int_value(ret_phi, ret_bt, &amp;_gvn);
1127     }
1128     _exits.push_node(ret_type-&gt;basic_type(), ret_phi);
1129   }
1130 
1131   // Note:  Logic for creating and optimizing the ReturnNode is in Compile.
1132 
1133   // Unlock along the exceptional paths.
</pre>
<hr />
<pre>
1188 }
1189 
1190 //-----------------------------create_entry_map-------------------------------
1191 // Initialize our parser map to contain the types at method entry.
1192 // For OSR, the map contains a single RawPtr parameter.
1193 // Initial monitor locking for sync. methods is performed by do_method_entry.
1194 SafePointNode* Parse::create_entry_map() {
1195   // Check for really stupid bail-out cases.
1196   uint len = TypeFunc::Parms + method()-&gt;max_locals() + method()-&gt;max_stack();
1197   if (len &gt;= 32760) {
1198     C-&gt;record_method_not_compilable(&quot;too many local variables&quot;);
1199     return NULL;
1200   }
1201 
1202   // clear current replaced nodes that are of no use from here on (map was cloned in build_exits).
1203   _caller-&gt;map()-&gt;delete_replaced_nodes();
1204 
1205   // If this is an inlined method, we may have to do a receiver null check.
1206   if (_caller-&gt;has_method() &amp;&amp; is_normal_parse() &amp;&amp; !method()-&gt;is_static()) {
1207     GraphKit kit(_caller);
<span class="line-modified">1208     kit.null_check_receiver_before_call(method(), false);</span>
1209     _caller = kit.transfer_exceptions_into_jvms();
1210     if (kit.stopped()) {
1211       _exits.add_exception_states_from(_caller);
1212       _exits.set_jvms(_caller);
1213       return NULL;
1214     }
1215   }
1216 
1217   assert(method() != NULL, &quot;parser must have a method&quot;);
1218 
1219   // Create an initial safepoint to hold JVM state during parsing
1220   JVMState* jvms = new (C) JVMState(method(), _caller-&gt;has_method() ? _caller : NULL);
1221   set_map(new SafePointNode(len, jvms));
1222   jvms-&gt;set_map(map());
1223   record_for_igvn(map());
1224   assert(jvms-&gt;endoff() == len, &quot;correct jvms sizing&quot;);
1225 
1226   SafePointNode* inmap = _caller-&gt;map();
1227   assert(inmap != NULL, &quot;must have inmap&quot;);
1228   // In case of null check on receiver above
1229   map()-&gt;transfer_replaced_nodes_from(inmap, _new_idx);
1230 
1231   uint i;
1232 
1233   // Pass thru the predefined input parameters.
1234   for (i = 0; i &lt; TypeFunc::Parms; i++) {
1235     map()-&gt;init_req(i, inmap-&gt;in(i));
1236   }
1237 
1238   if (depth() == 1) {
1239     assert(map()-&gt;memory()-&gt;Opcode() == Op_Parm, &quot;&quot;);
1240     // Insert the memory aliasing node
1241     set_all_memory(reset_memory());
1242   }
1243   assert(merged_memory(), &quot;&quot;);
1244 
1245   // Now add the locals which are initially bound to arguments:
<span class="line-modified">1246   uint arg_size = tf()-&gt;domain_sig()-&gt;cnt();</span>
1247   ensure_stack(arg_size - TypeFunc::Parms);  // OSR methods have funny args
1248   for (i = TypeFunc::Parms; i &lt; arg_size; i++) {
1249     map()-&gt;init_req(i, inmap-&gt;argument(_caller, i - TypeFunc::Parms));
1250   }
1251 
1252   // Clear out the rest of the map (locals and stack)
1253   for (i = arg_size; i &lt; len; i++) {
1254     map()-&gt;init_req(i, top());
1255   }
1256 
1257   SafePointNode* entry_map = stop();
1258   return entry_map;
1259 }
1260 
1261 //-----------------------------do_method_entry--------------------------------
1262 // Emit any code needed in the pseudo-block before BCI zero.
1263 // The main thing to do is lock the receiver of a synchronized method.
1264 void Parse::do_method_entry() {
1265   set_parse_bci(InvocationEntryBci); // Pseudo-BCP
1266   set_sp(0);                         // Java Stack Pointer
</pre>
<hr />
<pre>
1273 
1274   // If the method is synchronized, we need to construct a lock node, attach
1275   // it to the Start node, and pin it there.
1276   if (method()-&gt;is_synchronized()) {
1277     // Insert a FastLockNode right after the Start which takes as arguments
1278     // the current thread pointer, the &quot;this&quot; pointer &amp; the address of the
1279     // stack slot pair used for the lock.  The &quot;this&quot; pointer is a projection
1280     // off the start node, but the locking spot has to be constructed by
1281     // creating a ConLNode of 0, and boxing it with a BoxLockNode.  The BoxLockNode
1282     // becomes the second argument to the FastLockNode call.  The
1283     // FastLockNode becomes the new control parent to pin it to the start.
1284 
1285     // Setup Object Pointer
1286     Node *lock_obj = NULL;
1287     if(method()-&gt;is_static()) {
1288       ciInstance* mirror = _method-&gt;holder()-&gt;java_mirror();
1289       const TypeInstPtr *t_lock = TypeInstPtr::make(mirror);
1290       lock_obj = makecon(t_lock);
1291     } else {                  // Else pass the &quot;this&quot; pointer,
1292       lock_obj = local(0);    // which is Parm0 from StartNode
<span class="line-added">1293       assert(!_gvn.type(lock_obj)-&gt;make_oopptr()-&gt;can_be_value_type(), &quot;can&#39;t be an inline type&quot;);</span>
1294     }
1295     // Clear out dead values from the debug info.
1296     kill_dead_locals();
1297     // Build the FastLockNode
1298     _synch_lock = shared_lock(lock_obj);
1299   }
1300 
1301   // Feed profiling data for parameters to the type system so it can
1302   // propagate it as speculative types
1303   record_profiled_parameters_for_speculation();
1304 
1305   if (depth() == 1) {
1306     increment_and_test_invocation_counter(Tier2CompileThreshold);
1307   }
1308 }
1309 
1310 //------------------------------init_blocks------------------------------------
1311 // Initialize our parser map to contain the types/monitors at method entry.
1312 void Parse::init_blocks() {
1313   // Create the blocks.
</pre>
<hr />
<pre>
1684 //--------------------handle_missing_successor---------------------------------
1685 void Parse::handle_missing_successor(int target_bci) {
1686 #ifndef PRODUCT
1687   Block* b = block();
1688   int trap_bci = b-&gt;flow()-&gt;has_trap()? b-&gt;flow()-&gt;trap_bci(): -1;
1689   tty-&gt;print_cr(&quot;### Missing successor at bci:%d for block #%d (trap_bci:%d)&quot;, target_bci, b-&gt;rpo(), trap_bci);
1690 #endif
1691   ShouldNotReachHere();
1692 }
1693 
1694 //--------------------------merge_common---------------------------------------
1695 void Parse::merge_common(Parse::Block* target, int pnum) {
1696   if (TraceOptoParse) {
1697     tty-&gt;print(&quot;Merging state at block #%d bci:%d&quot;, target-&gt;rpo(), target-&gt;start());
1698   }
1699 
1700   // Zap extra stack slots to top
1701   assert(sp() == target-&gt;start_sp(), &quot;&quot;);
1702   clean_stack(sp());
1703 
<span class="line-added">1704   // Check for merge conflicts involving value types</span>
<span class="line-added">1705   JVMState* old_jvms = map()-&gt;jvms();</span>
<span class="line-added">1706   int old_bci = bci();</span>
<span class="line-added">1707   JVMState* tmp_jvms = old_jvms-&gt;clone_shallow(C);</span>
<span class="line-added">1708   tmp_jvms-&gt;set_should_reexecute(true);</span>
<span class="line-added">1709   map()-&gt;set_jvms(tmp_jvms);</span>
<span class="line-added">1710   // Execution needs to restart a the next bytecode (entry of next</span>
<span class="line-added">1711   // block)</span>
<span class="line-added">1712   if (target-&gt;is_merged() ||</span>
<span class="line-added">1713       pnum &gt; PhiNode::Input ||</span>
<span class="line-added">1714       target-&gt;is_handler() ||</span>
<span class="line-added">1715       target-&gt;is_loop_head()) {</span>
<span class="line-added">1716     set_parse_bci(target-&gt;start());</span>
<span class="line-added">1717     for (uint j = TypeFunc::Parms; j &lt; map()-&gt;req(); j++) {</span>
<span class="line-added">1718       Node* n = map()-&gt;in(j);                 // Incoming change to target state.</span>
<span class="line-added">1719       const Type* t = NULL;</span>
<span class="line-added">1720       if (tmp_jvms-&gt;is_loc(j)) {</span>
<span class="line-added">1721         t = target-&gt;local_type_at(j - tmp_jvms-&gt;locoff());</span>
<span class="line-added">1722       } else if (tmp_jvms-&gt;is_stk(j) &amp;&amp; j &lt; (uint)sp() + tmp_jvms-&gt;stkoff()) {</span>
<span class="line-added">1723         t = target-&gt;stack_type_at(j - tmp_jvms-&gt;stkoff());</span>
<span class="line-added">1724       }</span>
<span class="line-added">1725       if (t != NULL &amp;&amp; t != Type::BOTTOM) {</span>
<span class="line-added">1726         if (n-&gt;is_ValueType() &amp;&amp; !t-&gt;isa_valuetype()) {</span>
<span class="line-added">1727           // Allocate value type in src block to be able to merge it with oop in target block</span>
<span class="line-added">1728           map()-&gt;set_req(j, ValueTypePtrNode::make_from_value_type(this, n-&gt;as_ValueType()));</span>
<span class="line-added">1729         }</span>
<span class="line-added">1730         assert(!t-&gt;isa_valuetype() || n-&gt;is_ValueType(), &quot;inconsistent typeflow info&quot;);</span>
<span class="line-added">1731       }</span>
<span class="line-added">1732     }</span>
<span class="line-added">1733   }</span>
<span class="line-added">1734   map()-&gt;set_jvms(old_jvms);</span>
<span class="line-added">1735   set_parse_bci(old_bci);</span>
<span class="line-added">1736 </span>
1737   if (!target-&gt;is_merged()) {   // No prior mapping at this bci
1738     if (TraceOptoParse) { tty-&gt;print(&quot; with empty state&quot;);  }
1739 
1740     // If this path is dead, do not bother capturing it as a merge.
1741     // It is &quot;as if&quot; we had 1 fewer predecessors from the beginning.
1742     if (stopped()) {
1743       if (TraceOptoParse)  tty-&gt;print_cr(&quot;, but path is dead and doesn&#39;t count&quot;);
1744       return;
1745     }
1746 
1747     // Make a region if we know there are multiple or unpredictable inputs.
1748     // (Also, if this is a plain fall-through, we might see another region,
1749     // which must not be allowed into this block&#39;s map.)
1750     if (pnum &gt; PhiNode::Input         // Known multiple inputs.
1751         || target-&gt;is_handler()       // These have unpredictable inputs.
1752         || target-&gt;is_loop_head()     // Known multiple inputs
1753         || control()-&gt;is_Region()) {  // We must hide this guy.
1754 
1755       int current_bci = bci();
1756       set_parse_bci(target-&gt;start()); // Set target bci
</pre>
<hr />
<pre>
1770       gvn().set_type(r, Type::CONTROL);
1771       record_for_igvn(r);
1772       // zap all inputs to NULL for debugging (done in Node(uint) constructor)
1773       // for (int j = 1; j &lt; edges+1; j++) { r-&gt;init_req(j, NULL); }
1774       r-&gt;init_req(pnum, control());
1775       set_control(r);
1776       set_parse_bci(current_bci); // Restore bci
1777     }
1778 
1779     // Convert the existing Parser mapping into a mapping at this bci.
1780     store_state_to(target);
1781     assert(target-&gt;is_merged(), &quot;do not come here twice&quot;);
1782 
1783   } else {                      // Prior mapping at this bci
1784     if (TraceOptoParse) {  tty-&gt;print(&quot; with previous state&quot;); }
1785 #ifdef ASSERT
1786     if (target-&gt;is_SEL_head()) {
1787       target-&gt;mark_merged_backedge(block());
1788     }
1789 #endif
<span class="line-added">1790 </span>
1791     // We must not manufacture more phis if the target is already parsed.
1792     bool nophi = target-&gt;is_parsed();
1793 
1794     SafePointNode* newin = map();// Hang on to incoming mapping
1795     Block* save_block = block(); // Hang on to incoming block;
1796     load_state_from(target);    // Get prior mapping
1797 
1798     assert(newin-&gt;jvms()-&gt;locoff() == jvms()-&gt;locoff(), &quot;JVMS layouts agree&quot;);
1799     assert(newin-&gt;jvms()-&gt;stkoff() == jvms()-&gt;stkoff(), &quot;JVMS layouts agree&quot;);
1800     assert(newin-&gt;jvms()-&gt;monoff() == jvms()-&gt;monoff(), &quot;JVMS layouts agree&quot;);
1801     assert(newin-&gt;jvms()-&gt;endoff() == jvms()-&gt;endoff(), &quot;JVMS layouts agree&quot;);
1802 
1803     // Iterate over my current mapping and the old mapping.
1804     // Where different, insert Phi functions.
1805     // Use any existing Phi functions.
1806     assert(control()-&gt;is_Region(), &quot;must be merging to a region&quot;);
1807     RegionNode* r = control()-&gt;as_Region();
1808 
1809     // Compute where to merge into
1810     // Merge incoming control path
1811     r-&gt;init_req(pnum, newin-&gt;control());
1812 
1813     if (pnum == 1) {            // Last merge for this Region?
1814       if (!block()-&gt;flow()-&gt;is_irreducible_entry()) {
1815         Node* result = _gvn.transform_no_reclaim(r);
1816         if (r != result &amp;&amp; TraceOptoParse) {
1817           tty-&gt;print_cr(&quot;Block #%d replace %d with %d&quot;, block()-&gt;rpo(), r-&gt;_idx, result-&gt;_idx);
1818         }
1819       }
1820       record_for_igvn(r);
1821     }
1822 
1823     // Update all the non-control inputs to map:
1824     assert(TypeFunc::Parms == newin-&gt;jvms()-&gt;locoff(), &quot;parser map should contain only youngest jvms&quot;);
1825     bool check_elide_phi = target-&gt;is_SEL_backedge(save_block);
<span class="line-added">1826     bool last_merge = (pnum == PhiNode::Input);</span>
1827     for (uint j = 1; j &lt; newin-&gt;req(); j++) {
1828       Node* m = map()-&gt;in(j);   // Current state of target.
1829       Node* n = newin-&gt;in(j);   // Incoming change to target state.
1830       PhiNode* phi;
<span class="line-modified">1831       if (m-&gt;is_Phi() &amp;&amp; m-&gt;as_Phi()-&gt;region() == r) {</span>
1832         phi = m-&gt;as_Phi();
<span class="line-modified">1833       } else if (m-&gt;is_ValueType() &amp;&amp; m-&gt;as_ValueType()-&gt;has_phi_inputs(r)){</span>
<span class="line-added">1834         phi = m-&gt;as_ValueType()-&gt;get_oop()-&gt;as_Phi();</span>
<span class="line-added">1835       } else {</span>
1836         phi = NULL;
<span class="line-added">1837       }</span>
1838       if (m != n) {             // Different; must merge
1839         switch (j) {
1840         // Frame pointer and Return Address never changes
1841         case TypeFunc::FramePtr:// Drop m, use the original value
1842         case TypeFunc::ReturnAdr:
1843           break;
1844         case TypeFunc::Memory:  // Merge inputs to the MergeMem node
1845           assert(phi == NULL, &quot;the merge contains phis, not vice versa&quot;);
1846           merge_memory_edges(n-&gt;as_MergeMem(), pnum, nophi);
1847           continue;
1848         default:                // All normal stuff
1849           if (phi == NULL) {
1850             const JVMState* jvms = map()-&gt;jvms();
1851             if (EliminateNestedLocks &amp;&amp;
1852                 jvms-&gt;is_mon(j) &amp;&amp; jvms-&gt;is_monitor_box(j)) {
1853               // BoxLock nodes are not commoning.
1854               // Use old BoxLock node as merged box.
1855               assert(newin-&gt;jvms()-&gt;is_monitor_box(j), &quot;sanity&quot;);
1856               // This assert also tests that nodes are BoxLock.
1857               assert(BoxLockNode::same_slot(n, m), &quot;sanity&quot;);
1858               C-&gt;gvn_replace_by(n, m);
1859             } else if (!check_elide_phi || !target-&gt;can_elide_SEL_phi(j)) {
1860               phi = ensure_phi(j, nophi);
1861             }
1862           }
1863           break;
1864         }
1865       }
1866       // At this point, n might be top if:
1867       //  - there is no phi (because TypeFlow detected a conflict), or
1868       //  - the corresponding control edges is top (a dead incoming path)
1869       // It is a bug if we create a phi which sees a garbage value on a live path.
1870 
<span class="line-modified">1871       // Merging two value types?</span>
<span class="line-added">1872       if (phi != NULL &amp;&amp; n-&gt;is_ValueType()) {</span>
<span class="line-added">1873         // Reload current state because it may have been updated by ensure_phi</span>
<span class="line-added">1874         m = map()-&gt;in(j);</span>
<span class="line-added">1875         ValueTypeNode* vtm = m-&gt;as_ValueType(); // Current value type</span>
<span class="line-added">1876         ValueTypeNode* vtn = n-&gt;as_ValueType(); // Incoming value type</span>
<span class="line-added">1877         assert(vtm-&gt;get_oop() == phi, &quot;Value type should have Phi input&quot;);</span>
<span class="line-added">1878         if (TraceOptoParse) {</span>
<span class="line-added">1879 #ifdef ASSERT</span>
<span class="line-added">1880           tty-&gt;print_cr(&quot;\nMerging value types&quot;);</span>
<span class="line-added">1881           tty-&gt;print_cr(&quot;Current:&quot;);</span>
<span class="line-added">1882           vtm-&gt;dump(2);</span>
<span class="line-added">1883           tty-&gt;print_cr(&quot;Incoming:&quot;);</span>
<span class="line-added">1884           vtn-&gt;dump(2);</span>
<span class="line-added">1885           tty-&gt;cr();</span>
<span class="line-added">1886 #endif</span>
<span class="line-added">1887         }</span>
<span class="line-added">1888         // Do the merge</span>
<span class="line-added">1889         vtm-&gt;merge_with(&amp;_gvn, vtn, pnum, last_merge);</span>
<span class="line-added">1890         if (last_merge) {</span>
<span class="line-added">1891           map()-&gt;set_req(j, _gvn.transform_no_reclaim(vtm));</span>
<span class="line-added">1892           record_for_igvn(vtm);</span>
<span class="line-added">1893         }</span>
<span class="line-added">1894       } else if (phi != NULL) {</span>
1895         assert(n != top() || r-&gt;in(pnum) == top(), &quot;live value must not be garbage&quot;);
1896         assert(phi-&gt;region() == r, &quot;&quot;);
1897         phi-&gt;set_req(pnum, n);  // Then add &#39;n&#39; to the merge
<span class="line-modified">1898         if (last_merge) {</span>
1899           // Last merge for this Phi.
1900           // So far, Phis have had a reasonable type from ciTypeFlow.
1901           // Now _gvn will join that with the meet of current inputs.
1902           // BOTTOM is never permissible here, &#39;cause pessimistically
1903           // Phis of pointers cannot lose the basic pointer type.
1904           debug_only(const Type* bt1 = phi-&gt;bottom_type());
1905           assert(bt1 != Type::BOTTOM, &quot;should not be building conflict phis&quot;);
1906           map()-&gt;set_req(j, _gvn.transform_no_reclaim(phi));
1907           debug_only(const Type* bt2 = phi-&gt;bottom_type());
1908           assert(bt2-&gt;higher_equal_speculative(bt1), &quot;must be consistent with type-flow&quot;);
1909           record_for_igvn(phi);
1910         }
1911       }
1912     } // End of for all values to be merged
1913 
<span class="line-modified">1914     if (last_merge &amp;&amp; !r-&gt;in(0)) {         // The occasional useless Region</span>

1915       assert(control() == r, &quot;&quot;);
1916       set_control(r-&gt;nonnull_req());
1917     }
1918 
1919     map()-&gt;merge_replaced_nodes_with(newin);
1920 
1921     // newin has been subsumed into the lazy merge, and is now dead.
1922     set_block(save_block);
1923 
1924     stop();                     // done with this guy, for now
1925   }
1926 
1927   if (TraceOptoParse) {
1928     tty-&gt;print_cr(&quot; on path %d&quot;, pnum);
1929   }
1930 
1931   // Done with this parser state.
1932   assert(stopped(), &quot;&quot;);
1933 }
1934 
</pre>
<hr />
<pre>
2046 
2047   // Add new path to the region.
2048   uint pnum = r-&gt;req();
2049   r-&gt;add_req(NULL);
2050 
2051   for (uint i = 1; i &lt; map-&gt;req(); i++) {
2052     Node* n = map-&gt;in(i);
2053     if (i == TypeFunc::Memory) {
2054       // Ensure a phi on all currently known memories.
2055       for (MergeMemStream mms(n-&gt;as_MergeMem()); mms.next_non_empty(); ) {
2056         Node* phi = mms.memory();
2057         if (phi-&gt;is_Phi() &amp;&amp; phi-&gt;as_Phi()-&gt;region() == r) {
2058           assert(phi-&gt;req() == pnum, &quot;must be same size as region&quot;);
2059           phi-&gt;add_req(NULL);
2060         }
2061       }
2062     } else {
2063       if (n-&gt;is_Phi() &amp;&amp; n-&gt;as_Phi()-&gt;region() == r) {
2064         assert(n-&gt;req() == pnum, &quot;must be same size as region&quot;);
2065         n-&gt;add_req(NULL);
<span class="line-added">2066       } else if (n-&gt;is_ValueType() &amp;&amp; n-&gt;as_ValueType()-&gt;has_phi_inputs(r)) {</span>
<span class="line-added">2067         n-&gt;as_ValueType()-&gt;add_new_path(r);</span>
2068       }
2069     }
2070   }
2071 
2072   return pnum;
2073 }
2074 
2075 //------------------------------ensure_phi-------------------------------------
2076 // Turn the idx&#39;th entry of the current map into a Phi
2077 PhiNode *Parse::ensure_phi(int idx, bool nocreate) {
2078   SafePointNode* map = this-&gt;map();
2079   Node* region = map-&gt;control();
2080   assert(region-&gt;is_Region(), &quot;&quot;);
2081 
2082   Node* o = map-&gt;in(idx);
2083   assert(o != NULL, &quot;&quot;);
2084 
2085   if (o == top())  return NULL; // TOP always merges into TOP
2086 
2087   if (o-&gt;is_Phi() &amp;&amp; o-&gt;as_Phi()-&gt;region() == region) {
2088     return o-&gt;as_Phi();
2089   }
<span class="line-added">2090   ValueTypeBaseNode* vt = o-&gt;isa_ValueType();</span>
<span class="line-added">2091   if (vt != NULL &amp;&amp; vt-&gt;has_phi_inputs(region)) {</span>
<span class="line-added">2092     return vt-&gt;get_oop()-&gt;as_Phi();</span>
<span class="line-added">2093   }</span>
2094 
2095   // Now use a Phi here for merging
2096   assert(!nocreate, &quot;Cannot build a phi for a block already parsed.&quot;);
2097   const JVMState* jvms = map-&gt;jvms();
2098   const Type* t = NULL;
2099   if (jvms-&gt;is_loc(idx)) {
2100     t = block()-&gt;local_type_at(idx - jvms-&gt;locoff());
2101   } else if (jvms-&gt;is_stk(idx)) {
2102     t = block()-&gt;stack_type_at(idx - jvms-&gt;stkoff());
2103   } else if (jvms-&gt;is_mon(idx)) {
2104     assert(!jvms-&gt;is_monitor_box(idx), &quot;no phis for boxes&quot;);
2105     t = TypeInstPtr::BOTTOM; // this is sufficient for a lock object
2106   } else if ((uint)idx &lt; TypeFunc::Parms) {
2107     t = o-&gt;bottom_type();  // Type::RETURN_ADDRESS or such-like.
2108   } else {
2109     assert(false, &quot;no type information for this phi&quot;);
2110   }
2111 
2112   // If the type falls to bottom, then this must be a local that
<span class="line-modified">2113   // is already dead or is mixing ints and oops or some such.</span>
<span class="line-modified">2114   // Forcing it to top makes it go dead.</span>
2115   if (t == Type::BOTTOM) {
2116     map-&gt;set_req(idx, top());
2117     return NULL;
2118   }
2119 
2120   // Do not create phis for top either.
2121   // A top on a non-null control flow must be an unused even after the.phi.
2122   if (t == Type::TOP || t == Type::HALF) {
2123     map-&gt;set_req(idx, top());
2124     return NULL;
2125   }
2126 
<span class="line-modified">2127   if (vt != NULL) {</span>
<span class="line-modified">2128     // Value types are merged by merging their field values.</span>
<span class="line-modified">2129     // Create a cloned ValueTypeNode with phi inputs that</span>
<span class="line-modified">2130     // represents the merged value type and update the map.</span>
<span class="line-modified">2131     vt = vt-&gt;clone_with_phis(&amp;_gvn, region);</span>
<span class="line-added">2132     map-&gt;set_req(idx, vt);</span>
<span class="line-added">2133     return vt-&gt;get_oop()-&gt;as_Phi();</span>
<span class="line-added">2134   } else {</span>
<span class="line-added">2135     PhiNode* phi = PhiNode::make(region, o, t);</span>
<span class="line-added">2136     gvn().set_type(phi, t);</span>
<span class="line-added">2137     if (C-&gt;do_escape_analysis()) record_for_igvn(phi);</span>
<span class="line-added">2138     map-&gt;set_req(idx, phi);</span>
<span class="line-added">2139     return phi;</span>
<span class="line-added">2140   }</span>
2141 }
2142 
2143 //--------------------------ensure_memory_phi----------------------------------
2144 // Turn the idx&#39;th slice of the current memory into a Phi
2145 PhiNode *Parse::ensure_memory_phi(int idx, bool nocreate) {
2146   MergeMemNode* mem = merged_memory();
2147   Node* region = control();
2148   assert(region-&gt;is_Region(), &quot;&quot;);
2149 
2150   Node *o = (idx == Compile::AliasIdxBot)? mem-&gt;base_memory(): mem-&gt;memory_at(idx);
2151   assert(o != NULL &amp;&amp; o != top(), &quot;&quot;);
2152 
2153   PhiNode* phi;
2154   if (o-&gt;is_Phi() &amp;&amp; o-&gt;as_Phi()-&gt;region() == region) {
2155     phi = o-&gt;as_Phi();
2156     if (phi == mem-&gt;base_memory() &amp;&amp; idx &gt;= Compile::AliasIdxRaw) {
2157       // clone the shared base memory phi to make a new memory split
2158       assert(!nocreate, &quot;Cannot build a phi for a block already parsed.&quot;);
2159       const Type* t = phi-&gt;bottom_type();
2160       const TypePtr* adr_type = C-&gt;get_adr_type(idx);
</pre>
<hr />
<pre>
2313   Node* cnt = make_load(control(), cnt_adr, TypeInt::INT, T_INT, adr_type, MemNode::unordered);
2314   Node* decr = _gvn.transform(new SubINode(cnt, makecon(TypeInt::ONE)));
2315   store_to_memory(control(), cnt_adr, decr, T_INT, adr_type, MemNode::unordered);
2316   Node *chk   = _gvn.transform(new CmpINode(decr, makecon(TypeInt::ZERO)));
2317   Node* tst   = _gvn.transform(new BoolNode(chk, BoolTest::gt));
2318   { BuildCutout unless(this, tst, PROB_ALWAYS);
2319     uncommon_trap(Deoptimization::Reason_tenured,
2320                   Deoptimization::Action_make_not_entrant);
2321   }
2322 }
2323 
2324 //------------------------------return_current---------------------------------
2325 // Append current _map to _exit_return
2326 void Parse::return_current(Node* value) {
2327   if (RegisterFinalizersAtInit &amp;&amp;
2328       method()-&gt;intrinsic_id() == vmIntrinsics::_Object_init) {
2329     call_register_finalizer();
2330   }
2331 
2332   // Do not set_parse_bci, so that return goo is credited to the return insn.
<span class="line-modified">2333   // vreturn can trigger an allocation so vreturn can throw. Setting</span>
<span class="line-added">2334   // the bci here breaks exception handling. Commenting this out</span>
<span class="line-added">2335   // doesn&#39;t seem to break anything.</span>
<span class="line-added">2336   //  set_bci(InvocationEntryBci);</span>
2337   if (method()-&gt;is_synchronized() &amp;&amp; GenerateSynchronizationCode) {
2338     shared_unlock(_synch_lock-&gt;box_node(), _synch_lock-&gt;obj_node());
2339   }
2340   if (C-&gt;env()-&gt;dtrace_method_probes()) {
2341     make_dtrace_method_exit(method());
2342   }

















2343   // frame pointer is always same, already captured
2344   if (value != NULL) {
<span class="line-modified">2345     Node* phi = _exits.argument(0);</span>
<span class="line-modified">2346     const Type* return_type = phi-&gt;bottom_type();</span>
<span class="line-modified">2347     const TypeOopPtr* tr = return_type-&gt;isa_oopptr();</span>
<span class="line-modified">2348     if (return_type-&gt;isa_valuetype() &amp;&amp; !Compile::current()-&gt;inlining_incrementally()) {</span>
<span class="line-modified">2349       // Value type is returned as fields, make sure it is scalarized</span>
<span class="line-modified">2350       if (!value-&gt;is_ValueType()) {</span>
<span class="line-modified">2351         value = ValueTypeNode::make_from_oop(this, value, return_type-&gt;value_klass());</span>
<span class="line-modified">2352       }</span>
<span class="line-modified">2353       if (!_caller-&gt;has_method()) {</span>
<span class="line-added">2354         // Value type is returned as fields from root method, make sure all non-flattened</span>
<span class="line-added">2355         // fields are buffered and re-execute if allocation triggers deoptimization.</span>
<span class="line-added">2356         PreserveReexecuteState preexecs(this);</span>
<span class="line-added">2357         assert(tf()-&gt;returns_value_type_as_fields(), &quot;must be returned as fields&quot;);</span>
<span class="line-added">2358         jvms()-&gt;set_should_reexecute(true);</span>
<span class="line-added">2359         inc_sp(1);</span>
<span class="line-added">2360         value = value-&gt;as_ValueType()-&gt;allocate_fields(this);</span>
<span class="line-added">2361       }</span>
<span class="line-added">2362     } else if (value-&gt;is_ValueType()) {</span>
<span class="line-added">2363       // Value type is returned as oop, make sure it is buffered and re-execute</span>
<span class="line-added">2364       // if allocation triggers deoptimization.</span>
<span class="line-added">2365       PreserveReexecuteState preexecs(this);</span>
<span class="line-added">2366       jvms()-&gt;set_should_reexecute(true);</span>
<span class="line-added">2367       inc_sp(1);</span>
<span class="line-added">2368       value = ValueTypePtrNode::make_from_value_type(this, value-&gt;as_ValueType());</span>
<span class="line-added">2369       if (Compile::current()-&gt;inlining_incrementally()) {</span>
<span class="line-added">2370         value = value-&gt;as_ValueTypeBase()-&gt;allocate_fields(this);</span>
<span class="line-added">2371       }</span>
<span class="line-added">2372     } else if (tr &amp;&amp; tr-&gt;isa_instptr() &amp;&amp; tr-&gt;klass()-&gt;is_loaded() &amp;&amp; tr-&gt;klass()-&gt;is_interface()) {</span>
<span class="line-added">2373       // If returning oops to an interface-return, there is a silent free</span>
<span class="line-added">2374       // cast from oop to interface allowed by the Verifier. Make it explicit here.</span>
<span class="line-added">2375       const TypeInstPtr* tp = value-&gt;bottom_type()-&gt;isa_instptr();</span>
2376       if (tp &amp;&amp; tp-&gt;klass()-&gt;is_loaded() &amp;&amp; !tp-&gt;klass()-&gt;is_interface()) {
2377         // sharpen the type eagerly; this eases certain assert checking
<span class="line-modified">2378         if (tp-&gt;higher_equal(TypeInstPtr::NOTNULL)) {</span>
2379           tr = tr-&gt;join_speculative(TypeInstPtr::NOTNULL)-&gt;is_instptr();
<span class="line-added">2380         }</span>
2381         value = _gvn.transform(new CheckCastPPNode(0, value, tr));
2382       }
2383     } else {
<span class="line-modified">2384       // Handle returns of oop-arrays to an arrays-of-interface return</span>
2385       const TypeInstPtr* phi_tip;
2386       const TypeInstPtr* val_tip;
<span class="line-modified">2387       Type::get_arrays_base_elements(return_type, value-&gt;bottom_type(), &amp;phi_tip, &amp;val_tip);</span>
2388       if (phi_tip != NULL &amp;&amp; phi_tip-&gt;is_loaded() &amp;&amp; phi_tip-&gt;klass()-&gt;is_interface() &amp;&amp;
2389           val_tip != NULL &amp;&amp; val_tip-&gt;is_loaded() &amp;&amp; !val_tip-&gt;klass()-&gt;is_interface()) {
<span class="line-modified">2390         value = _gvn.transform(new CheckCastPPNode(0, value, return_type));</span>
2391       }
2392     }
2393     phi-&gt;add_req(value);
2394   }
2395 
<span class="line-added">2396   SafePointNode* exit_return = _exits.map();</span>
<span class="line-added">2397   exit_return-&gt;in( TypeFunc::Control  )-&gt;add_req( control() );</span>
<span class="line-added">2398   exit_return-&gt;in( TypeFunc::I_O      )-&gt;add_req( i_o    () );</span>
<span class="line-added">2399   Node *mem = exit_return-&gt;in( TypeFunc::Memory   );</span>
<span class="line-added">2400   for (MergeMemStream mms(mem-&gt;as_MergeMem(), merged_memory()); mms.next_non_empty2(); ) {</span>
<span class="line-added">2401     if (mms.is_empty()) {</span>
<span class="line-added">2402       // get a copy of the base memory, and patch just this one input</span>
<span class="line-added">2403       const TypePtr* adr_type = mms.adr_type(C);</span>
<span class="line-added">2404       Node* phi = mms.force_memory()-&gt;as_Phi()-&gt;slice_memory(adr_type);</span>
<span class="line-added">2405       assert(phi-&gt;as_Phi()-&gt;region() == mms.base_memory()-&gt;in(0), &quot;&quot;);</span>
<span class="line-added">2406       gvn().set_type_bottom(phi);</span>
<span class="line-added">2407       phi-&gt;del_req(phi-&gt;req()-1);  // prepare to re-patch</span>
<span class="line-added">2408       mms.set_memory(phi);</span>
<span class="line-added">2409     }</span>
<span class="line-added">2410     mms.memory()-&gt;add_req(mms.memory2());</span>
<span class="line-added">2411   }</span>
<span class="line-added">2412 </span>
2413   if (_first_return) {
2414     _exits.map()-&gt;transfer_replaced_nodes_from(map(), _new_idx);
2415     _first_return = false;
2416   } else {
2417     _exits.map()-&gt;merge_replaced_nodes_with(map());
2418   }
2419 
2420   stop_and_kill_map();          // This CFG path dies here
2421 }
2422 
2423 
2424 //------------------------------add_safepoint----------------------------------
2425 void Parse::add_safepoint() {
2426   // See if we can avoid this safepoint.  No need for a SafePoint immediately
2427   // after a Call (except Leaf Call) or another SafePoint.
2428   Node *proj = control();
2429   uint parms = TypeFunc::Parms+1;
2430   if( proj-&gt;is_Proj() ) {
2431     Node *n0 = proj-&gt;in(0);
2432     if( n0-&gt;is_Catch() ) {
</pre>
</td>
</tr>
</table>
<center><a href="library_call.cpp.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="../prims/jvm.cpp.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>