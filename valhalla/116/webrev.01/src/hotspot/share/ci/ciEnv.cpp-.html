<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Old src/hotspot/share/ci/ciEnv.cpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
  </head>
  <body>
    <pre>
   1 /*
   2  * Copyright (c) 1999, 2020, Oracle and/or its affiliates. All rights reserved.
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.
   8  *
   9  * This code is distributed in the hope that it will be useful, but WITHOUT
  10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  *
  23  */
  24 
  25 #include &quot;precompiled.hpp&quot;
  26 #include &quot;jvm.h&quot;
  27 #include &quot;ci/ciConstant.hpp&quot;
  28 #include &quot;ci/ciEnv.hpp&quot;
  29 #include &quot;ci/ciField.hpp&quot;
  30 #include &quot;ci/ciInstance.hpp&quot;
  31 #include &quot;ci/ciInstanceKlass.hpp&quot;
  32 #include &quot;ci/ciMethod.hpp&quot;
  33 #include &quot;ci/ciNullObject.hpp&quot;
  34 #include &quot;ci/ciReplay.hpp&quot;
  35 #include &quot;ci/ciUtilities.inline.hpp&quot;
  36 #include &quot;ci/ciValueKlass.hpp&quot;
  37 #include &quot;classfile/symbolTable.hpp&quot;
  38 #include &quot;classfile/systemDictionary.hpp&quot;
  39 #include &quot;classfile/vmSymbols.hpp&quot;
  40 #include &quot;code/codeCache.hpp&quot;
  41 #include &quot;code/scopeDesc.hpp&quot;
  42 #include &quot;compiler/compileBroker.hpp&quot;
  43 #include &quot;compiler/compilerEvent.hpp&quot;
  44 #include &quot;compiler/compileLog.hpp&quot;
  45 #include &quot;compiler/compileTask.hpp&quot;
  46 #include &quot;compiler/disassembler.hpp&quot;
  47 #include &quot;gc/shared/collectedHeap.inline.hpp&quot;
  48 #include &quot;interpreter/linkResolver.hpp&quot;
  49 #include &quot;jfr/jfrEvents.hpp&quot;
  50 #include &quot;logging/log.hpp&quot;
  51 #include &quot;memory/allocation.inline.hpp&quot;
  52 #include &quot;memory/oopFactory.hpp&quot;
  53 #include &quot;memory/resourceArea.hpp&quot;
  54 #include &quot;memory/universe.hpp&quot;
  55 #include &quot;oops/constantPool.inline.hpp&quot;
  56 #include &quot;oops/cpCache.inline.hpp&quot;
  57 #include &quot;oops/method.inline.hpp&quot;
  58 #include &quot;oops/methodData.hpp&quot;
  59 #include &quot;oops/objArrayKlass.hpp&quot;
  60 #include &quot;oops/objArrayOop.inline.hpp&quot;
  61 #include &quot;oops/oop.inline.hpp&quot;
  62 #include &quot;prims/jvmtiExport.hpp&quot;
  63 #include &quot;runtime/handles.inline.hpp&quot;
  64 #include &quot;runtime/init.hpp&quot;
  65 #include &quot;runtime/reflection.hpp&quot;
  66 #include &quot;runtime/jniHandles.inline.hpp&quot;
  67 #include &quot;runtime/safepointVerifiers.hpp&quot;
  68 #include &quot;runtime/sharedRuntime.hpp&quot;
  69 #include &quot;runtime/thread.inline.hpp&quot;
  70 #include &quot;utilities/dtrace.hpp&quot;
  71 #include &quot;utilities/macros.hpp&quot;
  72 #ifdef COMPILER1
  73 #include &quot;c1/c1_Runtime1.hpp&quot;
  74 #endif
  75 #ifdef COMPILER2
  76 #include &quot;opto/runtime.hpp&quot;
  77 #endif
  78 
  79 // ciEnv
  80 //
  81 // This class is the top level broker for requests from the compiler
  82 // to the VM.
  83 
  84 ciObject*              ciEnv::_null_object_instance;
  85 
  86 #define WK_KLASS_DEFN(name, ignore_s) ciInstanceKlass* ciEnv::_##name = NULL;
  87 WK_KLASSES_DO(WK_KLASS_DEFN)
  88 #undef WK_KLASS_DEFN
  89 
  90 ciSymbol*        ciEnv::_unloaded_cisymbol = NULL;
  91 ciInstanceKlass* ciEnv::_unloaded_ciinstance_klass = NULL;
  92 ciObjArrayKlass* ciEnv::_unloaded_ciobjarrayklass = NULL;
  93 
  94 jobject ciEnv::_ArrayIndexOutOfBoundsException_handle = NULL;
  95 jobject ciEnv::_ArrayStoreException_handle = NULL;
  96 jobject ciEnv::_ClassCastException_handle = NULL;
  97 
  98 #ifndef PRODUCT
  99 static bool firstEnv = true;
 100 #endif /* PRODUCT */
 101 
 102 // ------------------------------------------------------------------
 103 // ciEnv::ciEnv
 104 ciEnv::ciEnv(CompileTask* task)
 105   : _ciEnv_arena(mtCompiler) {
 106   VM_ENTRY_MARK;
 107 
 108   // Set up ciEnv::current immediately, for the sake of ciObjectFactory, etc.
 109   thread-&gt;set_env(this);
 110   assert(ciEnv::current() == this, &quot;sanity&quot;);
 111 
 112   _oop_recorder = NULL;
 113   _debug_info = NULL;
 114   _dependencies = NULL;
 115   _failure_reason = NULL;
 116   _inc_decompile_count_on_failure = true;
 117   _compilable = MethodCompilable;
 118   _break_at_compile = false;
 119   _compiler_data = NULL;
 120 #ifndef PRODUCT
 121   assert(!firstEnv, &quot;not initialized properly&quot;);
 122 #endif /* !PRODUCT */
 123 
 124   _num_inlined_bytecodes = 0;
 125   assert(task == NULL || thread-&gt;task() == task, &quot;sanity&quot;);
 126   if (task != NULL) {
 127     task-&gt;mark_started(os::elapsed_counter());
 128   }
 129   _task = task;
 130   _log = NULL;
 131 
 132   // Temporary buffer for creating symbols and such.
 133   _name_buffer = NULL;
 134   _name_buffer_len = 0;
 135 
 136   _arena   = &amp;_ciEnv_arena;
 137   _factory = new (_arena) ciObjectFactory(_arena, 128);
 138 
 139   // Preload commonly referenced system ciObjects.
 140 
 141   // During VM initialization, these instances have not yet been created.
 142   // Assertions ensure that these instances are not accessed before
 143   // their initialization.
 144 
 145   assert(Universe::is_fully_initialized(), &quot;should be complete&quot;);
 146 
 147   oop o = Universe::null_ptr_exception_instance();
 148   assert(o != NULL, &quot;should have been initialized&quot;);
 149   _NullPointerException_instance = get_object(o)-&gt;as_instance();
 150   o = Universe::arithmetic_exception_instance();
 151   assert(o != NULL, &quot;should have been initialized&quot;);
 152   _ArithmeticException_instance = get_object(o)-&gt;as_instance();
 153 
 154   _ArrayIndexOutOfBoundsException_instance = NULL;
 155   _ArrayStoreException_instance = NULL;
 156   _ClassCastException_instance = NULL;
 157   _the_null_string = NULL;
 158   _the_min_jint_string = NULL;
 159 
 160   _jvmti_redefinition_count = 0;
 161   _jvmti_can_hotswap_or_post_breakpoint = false;
 162   _jvmti_can_access_local_variables = false;
 163   _jvmti_can_post_on_exceptions = false;
 164   _jvmti_can_pop_frame = false;
 165 }
 166 
 167 ciEnv::ciEnv(Arena* arena) : _ciEnv_arena(mtCompiler) {
 168   ASSERT_IN_VM;
 169 
 170   // Set up ciEnv::current immediately, for the sake of ciObjectFactory, etc.
 171   CompilerThread* current_thread = CompilerThread::current();
 172   assert(current_thread-&gt;env() == NULL, &quot;must be&quot;);
 173   current_thread-&gt;set_env(this);
 174   assert(ciEnv::current() == this, &quot;sanity&quot;);
 175 
 176   _oop_recorder = NULL;
 177   _debug_info = NULL;
 178   _dependencies = NULL;
 179   _failure_reason = NULL;
 180   _inc_decompile_count_on_failure = true;
 181   _compilable = MethodCompilable_never;
 182   _break_at_compile = false;
 183   _compiler_data = NULL;
 184 #ifndef PRODUCT
 185   assert(firstEnv, &quot;must be first&quot;);
 186   firstEnv = false;
 187 #endif /* !PRODUCT */
 188 
 189   _num_inlined_bytecodes = 0;
 190   _task = NULL;
 191   _log = NULL;
 192 
 193   // Temporary buffer for creating symbols and such.
 194   _name_buffer = NULL;
 195   _name_buffer_len = 0;
 196 
 197   _arena   = arena;
 198   _factory = new (_arena) ciObjectFactory(_arena, 128);
 199 
 200   // Preload commonly referenced system ciObjects.
 201 
 202   // During VM initialization, these instances have not yet been created.
 203   // Assertions ensure that these instances are not accessed before
 204   // their initialization.
 205 
 206   assert(Universe::is_fully_initialized(), &quot;must be&quot;);
 207 
 208   _NullPointerException_instance = NULL;
 209   _ArithmeticException_instance = NULL;
 210   _ArrayIndexOutOfBoundsException_instance = NULL;
 211   _ArrayStoreException_instance = NULL;
 212   _ClassCastException_instance = NULL;
 213   _the_null_string = NULL;
 214   _the_min_jint_string = NULL;
 215 
 216   _jvmti_redefinition_count = 0;
 217   _jvmti_can_hotswap_or_post_breakpoint = false;
 218   _jvmti_can_access_local_variables = false;
 219   _jvmti_can_post_on_exceptions = false;
 220   _jvmti_can_pop_frame = false;
 221 }
 222 
 223 ciEnv::~ciEnv() {
 224   GUARDED_VM_ENTRY(
 225       CompilerThread* current_thread = CompilerThread::current();
 226       _factory-&gt;remove_symbols();
 227       // Need safepoint to clear the env on the thread.  RedefineClasses might
 228       // be reading it.
 229       current_thread-&gt;set_env(NULL);
 230   )
 231 }
 232 
 233 // ------------------------------------------------------------------
 234 // Cache Jvmti state
 235 bool ciEnv::cache_jvmti_state() {
 236   VM_ENTRY_MARK;
 237   // Get Jvmti capabilities under lock to get consistant values.
 238   MutexLocker mu(JvmtiThreadState_lock);
 239   _jvmti_redefinition_count             = JvmtiExport::redefinition_count();
 240   _jvmti_can_hotswap_or_post_breakpoint = JvmtiExport::can_hotswap_or_post_breakpoint();
 241   _jvmti_can_access_local_variables     = JvmtiExport::can_access_local_variables();
 242   _jvmti_can_post_on_exceptions         = JvmtiExport::can_post_on_exceptions();
 243   _jvmti_can_pop_frame                  = JvmtiExport::can_pop_frame();
 244   _jvmti_can_get_owned_monitor_info     = JvmtiExport::can_get_owned_monitor_info();
 245   return _task != NULL &amp;&amp; _task-&gt;method()-&gt;is_old();
 246 }
 247 
 248 bool ciEnv::jvmti_state_changed() const {
 249   // Some classes were redefined
 250   if (_jvmti_redefinition_count != JvmtiExport::redefinition_count()) {
 251     return true;
 252   }
 253 
 254   if (!_jvmti_can_access_local_variables &amp;&amp;
 255       JvmtiExport::can_access_local_variables()) {
 256     return true;
 257   }
 258   if (!_jvmti_can_hotswap_or_post_breakpoint &amp;&amp;
 259       JvmtiExport::can_hotswap_or_post_breakpoint()) {
 260     return true;
 261   }
 262   if (!_jvmti_can_post_on_exceptions &amp;&amp;
 263       JvmtiExport::can_post_on_exceptions()) {
 264     return true;
 265   }
 266   if (!_jvmti_can_pop_frame &amp;&amp;
 267       JvmtiExport::can_pop_frame()) {
 268     return true;
 269   }
 270   if (!_jvmti_can_get_owned_monitor_info &amp;&amp;
 271       JvmtiExport::can_get_owned_monitor_info()) {
 272     return true;
 273   }
 274 
 275   return false;
 276 }
 277 
 278 // ------------------------------------------------------------------
 279 // Cache DTrace flags
 280 void ciEnv::cache_dtrace_flags() {
 281   // Need lock?
 282   _dtrace_extended_probes = ExtendedDTraceProbes;
 283   if (_dtrace_extended_probes) {
 284     _dtrace_monitor_probes  = true;
 285     _dtrace_method_probes   = true;
 286     _dtrace_alloc_probes    = true;
 287   } else {
 288     _dtrace_monitor_probes  = DTraceMonitorProbes;
 289     _dtrace_method_probes   = DTraceMethodProbes;
 290     _dtrace_alloc_probes    = DTraceAllocProbes;
 291   }
 292 }
 293 
 294 // ------------------------------------------------------------------
 295 // helper for lazy exception creation
 296 ciInstance* ciEnv::get_or_create_exception(jobject&amp; handle, Symbol* name) {
 297   VM_ENTRY_MARK;
 298   if (handle == NULL) {
 299     // Cf. universe.cpp, creation of Universe::_null_ptr_exception_instance.
 300     Klass* k = SystemDictionary::find(name, Handle(), Handle(), THREAD);
 301     jobject objh = NULL;
 302     if (!HAS_PENDING_EXCEPTION &amp;&amp; k != NULL) {
 303       oop obj = InstanceKlass::cast(k)-&gt;allocate_instance(THREAD);
 304       if (!HAS_PENDING_EXCEPTION)
 305         objh = JNIHandles::make_global(Handle(THREAD, obj));
 306     }
 307     if (HAS_PENDING_EXCEPTION) {
 308       CLEAR_PENDING_EXCEPTION;
 309     } else {
 310       handle = objh;
 311     }
 312   }
 313   oop obj = JNIHandles::resolve(handle);
 314   return obj == NULL? NULL: get_object(obj)-&gt;as_instance();
 315 }
 316 
 317 ciInstance* ciEnv::ArrayIndexOutOfBoundsException_instance() {
 318   if (_ArrayIndexOutOfBoundsException_instance == NULL) {
 319     _ArrayIndexOutOfBoundsException_instance
 320           = get_or_create_exception(_ArrayIndexOutOfBoundsException_handle,
 321           vmSymbols::java_lang_ArrayIndexOutOfBoundsException());
 322   }
 323   return _ArrayIndexOutOfBoundsException_instance;
 324 }
 325 ciInstance* ciEnv::ArrayStoreException_instance() {
 326   if (_ArrayStoreException_instance == NULL) {
 327     _ArrayStoreException_instance
 328           = get_or_create_exception(_ArrayStoreException_handle,
 329           vmSymbols::java_lang_ArrayStoreException());
 330   }
 331   return _ArrayStoreException_instance;
 332 }
 333 ciInstance* ciEnv::ClassCastException_instance() {
 334   if (_ClassCastException_instance == NULL) {
 335     _ClassCastException_instance
 336           = get_or_create_exception(_ClassCastException_handle,
 337           vmSymbols::java_lang_ClassCastException());
 338   }
 339   return _ClassCastException_instance;
 340 }
 341 
 342 ciInstance* ciEnv::the_null_string() {
 343   if (_the_null_string == NULL) {
 344     VM_ENTRY_MARK;
 345     _the_null_string = get_object(Universe::the_null_string())-&gt;as_instance();
 346   }
 347   return _the_null_string;
 348 }
 349 
 350 ciInstance* ciEnv::the_min_jint_string() {
 351   if (_the_min_jint_string == NULL) {
 352     VM_ENTRY_MARK;
 353     _the_min_jint_string = get_object(Universe::the_min_jint_string())-&gt;as_instance();
 354   }
 355   return _the_min_jint_string;
 356 }
 357 
 358 // ------------------------------------------------------------------
 359 // ciEnv::get_method_from_handle
 360 ciMethod* ciEnv::get_method_from_handle(Method* method) {
 361   VM_ENTRY_MARK;
 362   return get_metadata(method)-&gt;as_method();
 363 }
 364 
 365 // ------------------------------------------------------------------
 366 // ciEnv::array_element_offset_in_bytes
 367 int ciEnv::array_element_offset_in_bytes(ciArray* a_h, ciObject* o_h) {
 368   VM_ENTRY_MARK;
 369   objArrayOop a = (objArrayOop)a_h-&gt;get_oop();
 370   assert(a-&gt;is_objArray(), &quot;&quot;);
 371   int length = a-&gt;length();
 372   oop o = o_h-&gt;get_oop();
 373   for (int i = 0; i &lt; length; i++) {
 374     if (a-&gt;obj_at(i) == o)  return i;
 375   }
 376   return -1;
 377 }
 378 
 379 
 380 // ------------------------------------------------------------------
 381 // ciEnv::check_klass_accessiblity
 382 //
 383 // Note: the logic of this method should mirror the logic of
 384 // ConstantPool::verify_constant_pool_resolve.
 385 bool ciEnv::check_klass_accessibility(ciKlass* accessing_klass,
 386                                       Klass* resolved_klass) {
 387   if (accessing_klass == NULL || !accessing_klass-&gt;is_loaded()) {
 388     return true;
 389   }
 390   if (accessing_klass-&gt;is_obj_array_klass()) {
 391     accessing_klass = accessing_klass-&gt;as_obj_array_klass()-&gt;base_element_klass();
 392   }
 393   if (!accessing_klass-&gt;is_instance_klass()) {
 394     return true;
 395   }
 396 
 397   if (resolved_klass-&gt;is_objArray_klass()) {
 398     // Find the element klass, if this is an array.
 399     resolved_klass = ObjArrayKlass::cast(resolved_klass)-&gt;bottom_klass();
 400   }
 401   if (resolved_klass-&gt;is_instance_klass()) {
 402     return (Reflection::verify_class_access(accessing_klass-&gt;get_Klass(),
 403                                             InstanceKlass::cast(resolved_klass),
 404                                             true) == Reflection::ACCESS_OK);
 405   }
 406   return true;
 407 }
 408 
 409 // ------------------------------------------------------------------
 410 // ciEnv::get_klass_by_name_impl
 411 ciKlass* ciEnv::get_klass_by_name_impl(ciKlass* accessing_klass,
 412                                        const constantPoolHandle&amp; cpool,
 413                                        ciSymbol* name,
 414                                        bool require_local) {
 415   ASSERT_IN_VM;
 416   EXCEPTION_CONTEXT;
 417 
 418   // Now we need to check the SystemDictionary
 419   Symbol* sym = name-&gt;get_symbol();
 420   if (Signature::has_envelope(sym)) {
 421     // This is a name from a signature.  Strip off the trimmings.
 422     // Call recursive to keep scope of strippedsym.
 423     TempNewSymbol strippedsym = Signature::strip_envelope(sym);
 424     ciSymbol* strippedname = get_symbol(strippedsym);
 425     return get_klass_by_name_impl(accessing_klass, cpool, strippedname, require_local);
 426   }
 427 
 428   // Check for prior unloaded klass.  The SystemDictionary&#39;s answers
 429   // can vary over time but the compiler needs consistency.
 430   ciKlass* unloaded_klass = check_get_unloaded_klass(accessing_klass, name);
 431   if (unloaded_klass != NULL) {
 432     if (require_local)  return NULL;
 433     return unloaded_klass;
 434   }
 435 
 436   Handle loader(THREAD, (oop)NULL);
 437   Handle domain(THREAD, (oop)NULL);
 438   if (accessing_klass != NULL) {
 439     loader = Handle(THREAD, accessing_klass-&gt;loader());
 440     domain = Handle(THREAD, accessing_klass-&gt;protection_domain());
 441   }
 442 
 443   // setup up the proper type to return on OOM
 444   ciKlass* fail_type;
 445   if (sym-&gt;char_at(0) == JVM_SIGNATURE_ARRAY) {
 446     fail_type = _unloaded_ciobjarrayklass;
 447   } else {
 448     fail_type = _unloaded_ciinstance_klass;
 449   }
 450   Klass* found_klass;
 451   {
 452     ttyUnlocker ttyul;  // release tty lock to avoid ordering problems
 453     MutexLocker ml(Compile_lock);
 454     Klass* kls;
 455     if (!require_local) {
 456       kls = SystemDictionary::find_constrained_instance_or_array_klass(sym, loader,
 457                                                                        KILL_COMPILE_ON_FATAL_(fail_type));
 458     } else {
 459       kls = SystemDictionary::find_instance_or_array_klass(sym, loader, domain,
 460                                                            KILL_COMPILE_ON_FATAL_(fail_type));
 461     }
 462     found_klass = kls;
 463   }
 464 
 465   // If we fail to find an array klass, look again for its element type.
 466   // The element type may be available either locally or via constraints.
 467   // In either case, if we can find the element type in the system dictionary,
 468   // we must build an array type around it.  The CI requires array klasses
 469   // to be loaded if their element klasses are loaded, except when memory
 470   // is exhausted.
 471   if (Signature::is_array(sym) &amp;&amp;
 472       (sym-&gt;char_at(1) == JVM_SIGNATURE_ARRAY ||
 473        sym-&gt;char_at(1) == JVM_SIGNATURE_CLASS ||
 474        sym-&gt;char_at(1) == JVM_SIGNATURE_INLINE_TYPE )) {
 475     // We have an unloaded array.
 476     // Build it on the fly if the element class exists.
 477     SignatureStream ss(sym, false);
 478     ss.skip_array_prefix(1);
 479     // Get element ciKlass recursively.
 480     ciKlass* elem_klass =
 481       get_klass_by_name_impl(accessing_klass,
 482                              cpool,
 483                              get_symbol(ss.as_symbol()),
 484                              require_local);
 485     if (elem_klass != NULL &amp;&amp; elem_klass-&gt;is_loaded()) {
 486       // Now make an array for it
 487       return ciArrayKlass::make(elem_klass);
 488     }
 489   }
 490 
 491   if (found_klass == NULL &amp;&amp; !cpool.is_null() &amp;&amp; cpool-&gt;has_preresolution()) {
 492     // Look inside the constant pool for pre-resolved class entries.
 493     for (int i = cpool-&gt;length() - 1; i &gt;= 1; i--) {
 494       if (cpool-&gt;tag_at(i).is_klass()) {
 495         Klass* kls = cpool-&gt;resolved_klass_at(i);
 496         if (kls-&gt;name() == sym) {
 497           found_klass = kls;
 498           break;
 499         }
 500       }
 501     }
 502   }
 503 
 504   if (found_klass != NULL) {
 505     // Found it.  Build a CI handle.
 506     return get_klass(found_klass);
 507   }
 508 
 509   if (require_local)  return NULL;
 510 
 511   // Not yet loaded into the VM, or not governed by loader constraints.
 512   // Make a CI representative for it.
 513   int i = 0;
 514   while (sym-&gt;char_at(i) == JVM_SIGNATURE_ARRAY) {
 515     i++;
 516   }
 517   if (i &gt; 0 &amp;&amp; sym-&gt;char_at(i) == JVM_SIGNATURE_INLINE_TYPE) {
 518     // An unloaded array class of value types is an ObjArrayKlass, an
 519     // unloaded value type class is an InstanceKlass. For consistency,
 520     // make the signature of the unloaded array of value type use L
 521     // rather than Q.
 522     char *new_name = CURRENT_THREAD_ENV-&gt;name_buffer(sym-&gt;utf8_length()+1);
 523     strncpy(new_name, (char*)sym-&gt;base(), sym-&gt;utf8_length());
 524     new_name[i] = JVM_SIGNATURE_CLASS;
 525     new_name[sym-&gt;utf8_length()] = &#39;\0&#39;;
 526     return get_unloaded_klass(accessing_klass, ciSymbol::make(new_name));
 527   }
 528   return get_unloaded_klass(accessing_klass, name);
 529 }
 530 
 531 // ------------------------------------------------------------------
 532 // ciEnv::get_klass_by_name
 533 ciKlass* ciEnv::get_klass_by_name(ciKlass* accessing_klass,
 534                                   ciSymbol* klass_name,
 535                                   bool require_local) {
 536   GUARDED_VM_ENTRY(return get_klass_by_name_impl(accessing_klass,
 537                                                  constantPoolHandle(),
 538                                                  klass_name,
 539                                                  require_local);)
 540 }
 541 
 542 // ------------------------------------------------------------------
 543 // ciEnv::get_klass_by_index_impl
 544 //
 545 // Implementation of get_klass_by_index.
 546 ciKlass* ciEnv::get_klass_by_index_impl(const constantPoolHandle&amp; cpool,
 547                                         int index,
 548                                         bool&amp; is_accessible,
 549                                         ciInstanceKlass* accessor) {
 550   EXCEPTION_CONTEXT;
 551   Klass* klass = NULL;
 552   Symbol* klass_name = NULL;
 553 
 554   if (cpool-&gt;tag_at(index).is_symbol()) {
 555     klass_name = cpool-&gt;symbol_at(index);
 556   } else {
 557     // Check if it&#39;s resolved if it&#39;s not a symbol constant pool entry.
 558     klass = ConstantPool::klass_at_if_loaded(cpool, index);
 559     // Try to look it up by name.
 560     if (klass == NULL) {
 561       klass_name = cpool-&gt;klass_name_at(index);
 562     }
 563   }
 564 
 565   if (klass == NULL) {
 566     // Not found in constant pool.  Use the name to do the lookup.
 567     ciKlass* k = get_klass_by_name_impl(accessor,
 568                                         cpool,
 569                                         get_symbol(klass_name),
 570                                         false);
 571     // Calculate accessibility the hard way.
 572     if (!k-&gt;is_loaded()) {
 573       is_accessible = false;
 574     } else if (k-&gt;loader() != accessor-&gt;loader() &amp;&amp;
 575                get_klass_by_name_impl(accessor, cpool, k-&gt;name(), true) == NULL) {
 576       // Loaded only remotely.  Not linked yet.
 577       is_accessible = false;
 578     } else {
 579       // Linked locally, and we must also check public/private, etc.
 580       is_accessible = check_klass_accessibility(accessor, k-&gt;get_Klass());
 581     }
 582     return k;
 583   }
 584 
 585   // Check for prior unloaded klass.  The SystemDictionary&#39;s answers
 586   // can vary over time but the compiler needs consistency.
 587   ciSymbol* name = get_symbol(klass-&gt;name());
 588   ciKlass* unloaded_klass = check_get_unloaded_klass(accessor, name);
 589   if (unloaded_klass != NULL) {
 590     is_accessible = false;
 591     return unloaded_klass;
 592   }
 593 
 594   // It is known to be accessible, since it was found in the constant pool.
 595   is_accessible = true;
 596   return get_klass(klass);
 597 }
 598 
 599 // ------------------------------------------------------------------
 600 // ciEnv::get_klass_by_index
 601 //
 602 // Get a klass from the constant pool.
 603 ciKlass* ciEnv::get_klass_by_index(const constantPoolHandle&amp; cpool,
 604                                    int index,
 605                                    bool&amp; is_accessible,
 606                                    ciInstanceKlass* accessor) {
 607   GUARDED_VM_ENTRY(return get_klass_by_index_impl(cpool, index, is_accessible, accessor);)
 608 }
 609 
 610 // ------------------------------------------------------------------
 611 // ciEnv::is_klass_never_null
 612 //
 613 // Get information about nullability from the constant pool.
 614 bool ciEnv::is_klass_never_null(const constantPoolHandle&amp; cpool, int index) {
 615   GUARDED_VM_ENTRY(return cpool-&gt;klass_name_at(index)-&gt;is_Q_signature();)
 616 }
 617 
 618 // ------------------------------------------------------------------
 619 // ciEnv::get_constant_by_index_impl
 620 //
 621 // Implementation of get_constant_by_index().
 622 ciConstant ciEnv::get_constant_by_index_impl(const constantPoolHandle&amp; cpool,
 623                                              int pool_index, int cache_index,
 624                                              ciInstanceKlass* accessor) {
 625   bool ignore_will_link;
 626   EXCEPTION_CONTEXT;
 627   int index = pool_index;
 628   if (cache_index &gt;= 0) {
 629     assert(index &lt; 0, &quot;only one kind of index at a time&quot;);
 630     index = cpool-&gt;object_to_cp_index(cache_index);
 631     oop obj = cpool-&gt;resolved_references()-&gt;obj_at(cache_index);
 632     if (obj != NULL) {
 633       if (obj == Universe::the_null_sentinel()) {
 634         return ciConstant(T_OBJECT, get_object(NULL));
 635       }
 636       BasicType bt = T_OBJECT;
 637       if (cpool-&gt;tag_at(index).is_dynamic_constant())
 638         bt = Signature::basic_type(cpool-&gt;uncached_signature_ref_at(index));
 639       if (is_reference_type(bt)) {
 640       } else {
 641         // we have to unbox the primitive value
 642         if (!is_java_primitive(bt))  return ciConstant();
 643         jvalue value;
 644         BasicType bt2 = java_lang_boxing_object::get_value(obj, &amp;value);
 645         assert(bt2 == bt, &quot;&quot;);
 646         switch (bt2) {
 647         case T_DOUBLE:  return ciConstant(value.d);
 648         case T_FLOAT:   return ciConstant(value.f);
 649         case T_LONG:    return ciConstant(value.j);
 650         case T_INT:     return ciConstant(bt2, value.i);
 651         case T_SHORT:   return ciConstant(bt2, value.s);
 652         case T_BYTE:    return ciConstant(bt2, value.b);
 653         case T_CHAR:    return ciConstant(bt2, value.c);
 654         case T_BOOLEAN: return ciConstant(bt2, value.z);
 655         default:  return ciConstant();
 656         }
 657       }
 658       ciObject* ciobj = get_object(obj);
 659       if (ciobj-&gt;is_array()) {
 660         return ciConstant(T_ARRAY, ciobj);
 661       } else {
 662         assert(ciobj-&gt;is_instance(), &quot;should be an instance&quot;);
 663         return ciConstant(T_OBJECT, ciobj);
 664       }
 665     }
 666   }
 667   constantTag tag = cpool-&gt;tag_at(index);
 668   if (tag.is_int()) {
 669     return ciConstant(T_INT, (jint)cpool-&gt;int_at(index));
 670   } else if (tag.is_long()) {
 671     return ciConstant((jlong)cpool-&gt;long_at(index));
 672   } else if (tag.is_float()) {
 673     return ciConstant((jfloat)cpool-&gt;float_at(index));
 674   } else if (tag.is_double()) {
 675     return ciConstant((jdouble)cpool-&gt;double_at(index));
 676   } else if (tag.is_string()) {
 677     oop string = NULL;
 678     assert(cache_index &gt;= 0, &quot;should have a cache index&quot;);
 679     if (cpool-&gt;is_pseudo_string_at(index)) {
 680       string = cpool-&gt;pseudo_string_at(index, cache_index);
 681     } else {
 682       string = cpool-&gt;string_at(index, cache_index, THREAD);
 683       if (HAS_PENDING_EXCEPTION) {
 684         CLEAR_PENDING_EXCEPTION;
 685         record_out_of_memory_failure();
 686         return ciConstant();
 687       }
 688     }
 689     ciObject* constant = get_object(string);
 690     if (constant-&gt;is_array()) {
 691       return ciConstant(T_ARRAY, constant);
 692     } else {
 693       assert (constant-&gt;is_instance(), &quot;must be an instance, or not? &quot;);
 694       return ciConstant(T_OBJECT, constant);
 695     }
 696   } else if (tag.is_klass() || tag.is_unresolved_klass()) {
 697     // 4881222: allow ldc to take a class type
 698     ciKlass* klass = get_klass_by_index_impl(cpool, index, ignore_will_link, accessor);
 699     if (HAS_PENDING_EXCEPTION) {
 700       CLEAR_PENDING_EXCEPTION;
 701       record_out_of_memory_failure();
 702       return ciConstant();
 703     }
 704     assert (klass-&gt;is_instance_klass() || klass-&gt;is_array_klass(),
 705             &quot;must be an instance or array klass &quot;);
 706     return ciConstant(T_OBJECT, klass-&gt;java_mirror());
 707   } else if (tag.is_method_type()) {
 708     // must execute Java code to link this CP entry into cache[i].f1
 709     ciSymbol* signature = get_symbol(cpool-&gt;method_type_signature_at(index));
 710     ciObject* ciobj = get_unloaded_method_type_constant(signature);
 711     return ciConstant(T_OBJECT, ciobj);
 712   } else if (tag.is_method_handle()) {
 713     // must execute Java code to link this CP entry into cache[i].f1
 714     int ref_kind        = cpool-&gt;method_handle_ref_kind_at(index);
 715     int callee_index    = cpool-&gt;method_handle_klass_index_at(index);
 716     ciKlass* callee     = get_klass_by_index_impl(cpool, callee_index, ignore_will_link, accessor);
 717     ciSymbol* name      = get_symbol(cpool-&gt;method_handle_name_ref_at(index));
 718     ciSymbol* signature = get_symbol(cpool-&gt;method_handle_signature_ref_at(index));
 719     ciObject* ciobj     = get_unloaded_method_handle_constant(callee, name, signature, ref_kind);
 720     return ciConstant(T_OBJECT, ciobj);
 721   } else if (tag.is_dynamic_constant()) {
 722     return ciConstant();
 723   } else {
 724     ShouldNotReachHere();
 725     return ciConstant();
 726   }
 727 }
 728 
 729 // ------------------------------------------------------------------
 730 // ciEnv::get_constant_by_index
 731 //
 732 // Pull a constant out of the constant pool.  How appropriate.
 733 //
 734 // Implementation note: this query is currently in no way cached.
 735 ciConstant ciEnv::get_constant_by_index(const constantPoolHandle&amp; cpool,
 736                                         int pool_index, int cache_index,
 737                                         ciInstanceKlass* accessor) {
 738   GUARDED_VM_ENTRY(return get_constant_by_index_impl(cpool, pool_index, cache_index, accessor);)
 739 }
 740 
 741 // ------------------------------------------------------------------
 742 // ciEnv::get_field_by_index_impl
 743 //
 744 // Implementation of get_field_by_index.
 745 //
 746 // Implementation note: the results of field lookups are cached
 747 // in the accessor klass.
 748 ciField* ciEnv::get_field_by_index_impl(ciInstanceKlass* accessor,
 749                                         int index) {
 750   ciConstantPoolCache* cache = accessor-&gt;field_cache();
 751   if (cache == NULL) {
 752     ciField* field = new (arena()) ciField(accessor, index);
 753     return field;
 754   } else {
 755     ciField* field = (ciField*)cache-&gt;get(index);
 756     if (field == NULL) {
 757       field = new (arena()) ciField(accessor, index);
 758       cache-&gt;insert(index, field);
 759     }
 760     return field;
 761   }
 762 }
 763 
 764 // ------------------------------------------------------------------
 765 // ciEnv::get_field_by_index
 766 //
 767 // Get a field by index from a klass&#39;s constant pool.
 768 ciField* ciEnv::get_field_by_index(ciInstanceKlass* accessor,
 769                                    int index) {
 770   GUARDED_VM_ENTRY(return get_field_by_index_impl(accessor, index);)
 771 }
 772 
 773 // ------------------------------------------------------------------
 774 // ciEnv::lookup_method
 775 //
 776 // Perform an appropriate method lookup based on accessor, holder,
 777 // name, signature, and bytecode.
 778 Method* ciEnv::lookup_method(ciInstanceKlass* accessor,
 779                              ciKlass*         holder,
 780                              Symbol*          name,
 781                              Symbol*          sig,
 782                              Bytecodes::Code  bc,
 783                              constantTag      tag) {
 784   // Accessibility checks are performed in ciEnv::get_method_by_index_impl.
 785   assert(check_klass_accessibility(accessor, holder-&gt;get_Klass()), &quot;holder not accessible&quot;);
 786 
 787   InstanceKlass* accessor_klass = accessor-&gt;get_instanceKlass();
 788   Klass* holder_klass = holder-&gt;get_Klass();
 789   Method* dest_method;
 790   LinkInfo link_info(holder_klass, name, sig, accessor_klass, LinkInfo::needs_access_check, tag);
 791   switch (bc) {
 792   case Bytecodes::_invokestatic:
 793     dest_method =
 794       LinkResolver::resolve_static_call_or_null(link_info);
 795     break;
 796   case Bytecodes::_invokespecial:
 797     dest_method =
 798       LinkResolver::resolve_special_call_or_null(link_info);
 799     break;
 800   case Bytecodes::_invokeinterface:
 801     dest_method =
 802       LinkResolver::linktime_resolve_interface_method_or_null(link_info);
 803     break;
 804   case Bytecodes::_invokevirtual:
 805     dest_method =
 806       LinkResolver::linktime_resolve_virtual_method_or_null(link_info);
 807     break;
 808   default: ShouldNotReachHere();
 809   }
 810 
 811   return dest_method;
 812 }
 813 
 814 
 815 // ------------------------------------------------------------------
 816 // ciEnv::get_method_by_index_impl
 817 ciMethod* ciEnv::get_method_by_index_impl(const constantPoolHandle&amp; cpool,
 818                                           int index, Bytecodes::Code bc,
 819                                           ciInstanceKlass* accessor) {
 820   assert(cpool.not_null(), &quot;need constant pool&quot;);
 821   assert(accessor != NULL, &quot;need origin of access&quot;);
 822   if (bc == Bytecodes::_invokedynamic) {
 823     ConstantPoolCacheEntry* cpce = cpool-&gt;invokedynamic_cp_cache_entry_at(index);
 824     bool is_resolved = !cpce-&gt;is_f1_null();
 825     // FIXME: code generation could allow for null (unlinked) call site
 826     // The call site could be made patchable as follows:
 827     // Load the appendix argument from the constant pool.
 828     // Test the appendix argument and jump to a known deopt routine if it is null.
 829     // Jump through a patchable call site, which is initially a deopt routine.
 830     // Patch the call site to the nmethod entry point of the static compiled lambda form.
 831     // As with other two-component call sites, both values must be independently verified.
 832 
 833     if (is_resolved) {
 834       // Get the invoker Method* from the constant pool.
 835       // (The appendix argument, if any, will be noted in the method&#39;s signature.)
 836       Method* adapter = cpce-&gt;f1_as_method();
 837       return get_method(adapter);
 838     }
 839 
 840     // Fake a method that is equivalent to a declared method.
 841     ciInstanceKlass* holder    = get_instance_klass(SystemDictionary::MethodHandle_klass());
 842     ciSymbol*        name      = ciSymbol::invokeBasic_name();
 843     ciSymbol*        signature = get_symbol(cpool-&gt;signature_ref_at(index));
 844     return get_unloaded_method(holder, name, signature, accessor);
 845   } else {
 846     const int holder_index = cpool-&gt;klass_ref_index_at(index);
 847     bool holder_is_accessible;
 848     ciKlass* holder = get_klass_by_index_impl(cpool, holder_index, holder_is_accessible, accessor);
 849 
 850     // Get the method&#39;s name and signature.
 851     Symbol* name_sym = cpool-&gt;name_ref_at(index);
 852     Symbol* sig_sym  = cpool-&gt;signature_ref_at(index);
 853 
 854     if (cpool-&gt;has_preresolution()
 855         || ((holder == ciEnv::MethodHandle_klass() || holder == ciEnv::VarHandle_klass()) &amp;&amp;
 856             MethodHandles::is_signature_polymorphic_name(holder-&gt;get_Klass(), name_sym))) {
 857       // Short-circuit lookups for JSR 292-related call sites.
 858       // That is, do not rely only on name-based lookups, because they may fail
 859       // if the names are not resolvable in the boot class loader (7056328).
 860       switch (bc) {
 861       case Bytecodes::_invokevirtual:
 862       case Bytecodes::_invokeinterface:
 863       case Bytecodes::_invokespecial:
 864       case Bytecodes::_invokestatic:
 865         {
 866           Method* m = ConstantPool::method_at_if_loaded(cpool, index);
 867           if (m != NULL) {
 868             return get_method(m);
 869           }
 870         }
 871         break;
 872       default:
 873         break;
 874       }
 875     }
 876 
 877     if (holder_is_accessible) {  // Our declared holder is loaded.
 878       constantTag tag = cpool-&gt;tag_ref_at(index);
 879       assert(accessor-&gt;get_instanceKlass() == cpool-&gt;pool_holder(), &quot;not the pool holder?&quot;);
 880       Method* m = lookup_method(accessor, holder, name_sym, sig_sym, bc, tag);
 881       if (m != NULL &amp;&amp;
 882           (bc == Bytecodes::_invokestatic
 883            ?  m-&gt;method_holder()-&gt;is_not_initialized()
 884            : !m-&gt;method_holder()-&gt;is_loaded())) {
 885         m = NULL;
 886       }
 887 #ifdef ASSERT
 888       if (m != NULL &amp;&amp; ReplayCompiles &amp;&amp; !ciReplay::is_loaded(m)) {
 889         m = NULL;
 890       }
 891 #endif
 892       if (m != NULL) {
 893         // We found the method.
 894         return get_method(m);
 895       }
 896     }
 897 
 898     // Either the declared holder was not loaded, or the method could
 899     // not be found.  Create a dummy ciMethod to represent the failed
 900     // lookup.
 901     ciSymbol* name      = get_symbol(name_sym);
 902     ciSymbol* signature = get_symbol(sig_sym);
 903     return get_unloaded_method(holder, name, signature, accessor);
 904   }
 905 }
 906 
 907 
 908 // ------------------------------------------------------------------
 909 // ciEnv::get_instance_klass_for_declared_method_holder
 910 ciInstanceKlass* ciEnv::get_instance_klass_for_declared_method_holder(ciKlass* method_holder) {
 911   // For the case of &lt;array&gt;.clone(), the method holder can be a ciArrayKlass
 912   // instead of a ciInstanceKlass.  For that case simply pretend that the
 913   // declared holder is Object.clone since that&#39;s where the call will bottom out.
 914   // A more correct fix would trickle out through many interfaces in CI,
 915   // requiring ciInstanceKlass* to become ciKlass* and many more places would
 916   // require checks to make sure the expected type was found.  Given that this
 917   // only occurs for clone() the more extensive fix seems like overkill so
 918   // instead we simply smear the array type into Object.
 919   guarantee(method_holder != NULL, &quot;no method holder&quot;);
 920   if (method_holder-&gt;is_instance_klass()) {
 921     return method_holder-&gt;as_instance_klass();
 922   } else if (method_holder-&gt;is_array_klass()) {
 923     return current()-&gt;Object_klass();
 924   } else {
 925     ShouldNotReachHere();
 926   }
 927   return NULL;
 928 }
 929 
 930 
 931 // ------------------------------------------------------------------
 932 // ciEnv::get_method_by_index
 933 ciMethod* ciEnv::get_method_by_index(const constantPoolHandle&amp; cpool,
 934                                      int index, Bytecodes::Code bc,
 935                                      ciInstanceKlass* accessor) {
 936   GUARDED_VM_ENTRY(return get_method_by_index_impl(cpool, index, bc, accessor);)
 937 }
 938 
 939 
 940 // ------------------------------------------------------------------
 941 // ciEnv::name_buffer
 942 char *ciEnv::name_buffer(int req_len) {
 943   if (_name_buffer_len &lt; req_len) {
 944     if (_name_buffer == NULL) {
 945       _name_buffer = (char*)arena()-&gt;Amalloc(sizeof(char)*req_len);
 946       _name_buffer_len = req_len;
 947     } else {
 948       _name_buffer =
 949         (char*)arena()-&gt;Arealloc(_name_buffer, _name_buffer_len, req_len);
 950       _name_buffer_len = req_len;
 951     }
 952   }
 953   return _name_buffer;
 954 }
 955 
 956 // ------------------------------------------------------------------
 957 // ciEnv::is_in_vm
 958 bool ciEnv::is_in_vm() {
 959   return JavaThread::current()-&gt;thread_state() == _thread_in_vm;
 960 }
 961 
 962 // ------------------------------------------------------------------
 963 // ciEnv::validate_compile_task_dependencies
 964 //
 965 // Check for changes during compilation (e.g. class loads, evolution,
 966 // breakpoints, call site invalidation).
 967 void ciEnv::validate_compile_task_dependencies(ciMethod* target) {
 968   if (failing())  return;  // no need for further checks
 969 
 970   Dependencies::DepType result = dependencies()-&gt;validate_dependencies(_task);
 971   if (result != Dependencies::end_marker) {
 972     if (result == Dependencies::call_site_target_value) {
 973       _inc_decompile_count_on_failure = false;
 974       record_failure(&quot;call site target change&quot;);
 975     } else if (Dependencies::is_klass_type(result)) {
 976       record_failure(&quot;concurrent class loading&quot;);
 977     } else {
 978       record_failure(&quot;invalid non-klass dependency&quot;);
 979     }
 980   }
 981 }
 982 
 983 // ------------------------------------------------------------------
 984 // ciEnv::register_method
 985 void ciEnv::register_method(ciMethod* target,
 986                             int entry_bci,
 987                             CodeOffsets* offsets,
 988                             int orig_pc_offset,
 989                             CodeBuffer* code_buffer,
 990                             int frame_words,
 991                             OopMapSet* oop_map_set,
 992                             ExceptionHandlerTable* handler_table,
 993                             ImplicitExceptionTable* inc_table,
 994                             AbstractCompiler* compiler,
 995                             bool has_unsafe_access,
 996                             bool has_wide_vectors,
 997                             RTMState  rtm_state) {
 998   VM_ENTRY_MARK;
 999   nmethod* nm = NULL;
1000   {
1001     // To prevent compile queue updates.
1002     MutexLocker locker(THREAD, MethodCompileQueue_lock);
1003 
1004     // Prevent SystemDictionary::add_to_hierarchy from running
1005     // and invalidating our dependencies until we install this method.
1006     // No safepoints are allowed. Otherwise, class redefinition can occur in between.
1007     MutexLocker ml(Compile_lock);
1008     NoSafepointVerifier nsv;
1009 
1010     // Change in Jvmti state may invalidate compilation.
1011     if (!failing() &amp;&amp; jvmti_state_changed()) {
1012       record_failure(&quot;Jvmti state change invalidated dependencies&quot;);
1013     }
1014 
1015     // Change in DTrace flags may invalidate compilation.
1016     if (!failing() &amp;&amp;
1017         ( (!dtrace_extended_probes() &amp;&amp; ExtendedDTraceProbes) ||
1018           (!dtrace_method_probes() &amp;&amp; DTraceMethodProbes) ||
1019           (!dtrace_alloc_probes() &amp;&amp; DTraceAllocProbes) )) {
1020       record_failure(&quot;DTrace flags change invalidated dependencies&quot;);
1021     }
1022 
1023     if (!failing() &amp;&amp; target-&gt;needs_clinit_barrier() &amp;&amp;
1024         target-&gt;holder()-&gt;is_in_error_state()) {
1025       record_failure(&quot;method holder is in error state&quot;);
1026     }
1027 
1028     if (!failing()) {
1029       if (log() != NULL) {
1030         // Log the dependencies which this compilation declares.
1031         dependencies()-&gt;log_all_dependencies();
1032       }
1033 
1034       // Encode the dependencies now, so we can check them right away.
1035       dependencies()-&gt;encode_content_bytes();
1036 
1037       // Check for {class loads, evolution, breakpoints, ...} during compilation
1038       validate_compile_task_dependencies(target);
1039     }
1040 
1041     methodHandle method(THREAD, target-&gt;get_Method());
1042 
1043 #if INCLUDE_RTM_OPT
1044     if (!failing() &amp;&amp; (rtm_state != NoRTM) &amp;&amp;
1045         (method()-&gt;method_data() != NULL) &amp;&amp;
1046         (method()-&gt;method_data()-&gt;rtm_state() != rtm_state)) {
1047       // Preemptive decompile if rtm state was changed.
1048       record_failure(&quot;RTM state change invalidated rtm code&quot;);
1049     }
1050 #endif
1051 
1052     if (failing()) {
1053       // While not a true deoptimization, it is a preemptive decompile.
1054       MethodData* mdo = method()-&gt;method_data();
1055       if (mdo != NULL &amp;&amp; _inc_decompile_count_on_failure) {
1056         mdo-&gt;inc_decompile_count();
1057       }
1058 
1059       // All buffers in the CodeBuffer are allocated in the CodeCache.
1060       // If the code buffer is created on each compile attempt
1061       // as in C2, then it must be freed.
1062       code_buffer-&gt;free_blob();
1063       return;
1064     }
1065 
1066     assert(offsets-&gt;value(CodeOffsets::Deopt) != -1, &quot;must have deopt entry&quot;);
1067     assert(offsets-&gt;value(CodeOffsets::Exceptions) != -1, &quot;must have exception entry&quot;);
1068 
1069     nm =  nmethod::new_nmethod(method,
1070                                compile_id(),
1071                                entry_bci,
1072                                offsets,
1073                                orig_pc_offset,
1074                                debug_info(), dependencies(), code_buffer,
1075                                frame_words, oop_map_set,
1076                                handler_table, inc_table,
1077                                compiler, task()-&gt;comp_level());
1078 
1079     // Free codeBlobs
1080     code_buffer-&gt;free_blob();
1081 
1082     if (nm != NULL) {
1083       nm-&gt;set_has_unsafe_access(has_unsafe_access);
1084       nm-&gt;set_has_wide_vectors(has_wide_vectors);
1085 #if INCLUDE_RTM_OPT
1086       nm-&gt;set_rtm_state(rtm_state);
1087 #endif
1088 
1089       // Record successful registration.
1090       // (Put nm into the task handle *before* publishing to the Java heap.)
1091       if (task() != NULL) {
1092         task()-&gt;set_code(nm);
1093       }
1094 
1095       if (entry_bci == InvocationEntryBci) {
1096         if (TieredCompilation) {
1097           // If there is an old version we&#39;re done with it
1098           CompiledMethod* old = method-&gt;code();
1099           if (TraceMethodReplacement &amp;&amp; old != NULL) {
1100             ResourceMark rm;
1101             char *method_name = method-&gt;name_and_sig_as_C_string();
1102             tty-&gt;print_cr(&quot;Replacing method %s&quot;, method_name);
1103           }
1104           if (old != NULL) {
1105             old-&gt;make_not_used();
1106           }
1107         }
1108 
1109         LogTarget(Info, nmethod, install) lt;
1110         if (lt.is_enabled()) {
1111           ResourceMark rm;
1112           char *method_name = method-&gt;name_and_sig_as_C_string();
1113           lt.print(&quot;Installing method (%d) %s &quot;,
1114                     task()-&gt;comp_level(), method_name);
1115         }
1116         // Allow the code to be executed
1117         MutexLocker ml(CompiledMethod_lock, Mutex::_no_safepoint_check_flag);
1118         if (nm-&gt;make_in_use()) {
1119           method-&gt;set_code(method, nm);
1120         }
1121       } else {
1122         LogTarget(Info, nmethod, install) lt;
1123         if (lt.is_enabled()) {
1124           ResourceMark rm;
1125           char *method_name = method-&gt;name_and_sig_as_C_string();
1126           lt.print(&quot;Installing osr method (%d) %s @ %d&quot;,
1127                     task()-&gt;comp_level(), method_name, entry_bci);
1128         }
1129         MutexLocker ml(CompiledMethod_lock, Mutex::_no_safepoint_check_flag);
1130         if (nm-&gt;make_in_use()) {
1131           method-&gt;method_holder()-&gt;add_osr_nmethod(nm);
1132         }
1133       }
1134     }
1135   }  // safepoints are allowed again
1136 
1137   if (nm != NULL) {
1138     // JVMTI -- compiled method notification (must be done outside lock)
1139     nm-&gt;post_compiled_method_load_event();
1140   } else {
1141     // The CodeCache is full.
1142     record_failure(&quot;code cache is full&quot;);
1143   }
1144 }
1145 
1146 
1147 // ------------------------------------------------------------------
1148 // ciEnv::find_system_klass
1149 ciKlass* ciEnv::find_system_klass(ciSymbol* klass_name) {
1150   VM_ENTRY_MARK;
1151   return get_klass_by_name_impl(NULL, constantPoolHandle(), klass_name, false);
1152 }
1153 
1154 // ------------------------------------------------------------------
1155 // ciEnv::comp_level
1156 int ciEnv::comp_level() {
1157   if (task() == NULL)  return CompLevel_highest_tier;
1158   return task()-&gt;comp_level();
1159 }
1160 
1161 // ------------------------------------------------------------------
1162 // ciEnv::compile_id
1163 uint ciEnv::compile_id() {
1164   if (task() == NULL)  return 0;
1165   return task()-&gt;compile_id();
1166 }
1167 
1168 // ------------------------------------------------------------------
1169 // ciEnv::notice_inlined_method()
1170 void ciEnv::notice_inlined_method(ciMethod* method) {
1171   _num_inlined_bytecodes += method-&gt;code_size_for_inlining();
1172 }
1173 
1174 // ------------------------------------------------------------------
1175 // ciEnv::num_inlined_bytecodes()
1176 int ciEnv::num_inlined_bytecodes() const {
1177   return _num_inlined_bytecodes;
1178 }
1179 
1180 // ------------------------------------------------------------------
1181 // ciEnv::record_failure()
1182 void ciEnv::record_failure(const char* reason) {
1183   if (_failure_reason == NULL) {
1184     // Record the first failure reason.
1185     _failure_reason = reason;
1186   }
1187 }
1188 
1189 void ciEnv::report_failure(const char* reason) {
1190   EventCompilationFailure event;
1191   if (event.should_commit()) {
1192     CompilerEvent::CompilationFailureEvent::post(event, compile_id(), reason);
1193   }
1194 }
1195 
1196 // ------------------------------------------------------------------
1197 // ciEnv::record_method_not_compilable()
1198 void ciEnv::record_method_not_compilable(const char* reason, bool all_tiers) {
1199   int new_compilable =
1200     all_tiers ? MethodCompilable_never : MethodCompilable_not_at_tier ;
1201 
1202   // Only note transitions to a worse state
1203   if (new_compilable &gt; _compilable) {
1204     if (log() != NULL) {
1205       if (all_tiers) {
1206         log()-&gt;elem(&quot;method_not_compilable&quot;);
1207       } else {
1208         log()-&gt;elem(&quot;method_not_compilable_at_tier level=&#39;%d&#39;&quot;,
1209                     current()-&gt;task()-&gt;comp_level());
1210       }
1211     }
1212     _compilable = new_compilable;
1213 
1214     // Reset failure reason; this one is more important.
1215     _failure_reason = NULL;
1216     record_failure(reason);
1217   }
1218 }
1219 
1220 // ------------------------------------------------------------------
1221 // ciEnv::record_out_of_memory_failure()
1222 void ciEnv::record_out_of_memory_failure() {
1223   // If memory is low, we stop compiling methods.
1224   record_method_not_compilable(&quot;out of memory&quot;);
1225 }
1226 
1227 ciInstance* ciEnv::unloaded_ciinstance() {
1228   GUARDED_VM_ENTRY(return _factory-&gt;get_unloaded_object_constant();)
1229 }
1230 
1231 // ------------------------------------------------------------------
1232 // ciEnv::dump_replay_data*
1233 
1234 // Don&#39;t change thread state and acquire any locks.
1235 // Safe to call from VM error reporter.
1236 
1237 void ciEnv::dump_compile_data(outputStream* out) {
1238   CompileTask* task = this-&gt;task();
1239   if (task) {
1240     Method* method = task-&gt;method();
1241     int entry_bci = task-&gt;osr_bci();
1242     int comp_level = task-&gt;comp_level();
1243     out-&gt;print(&quot;compile %s %s %s %d %d&quot;,
1244                method-&gt;klass_name()-&gt;as_quoted_ascii(),
1245                method-&gt;name()-&gt;as_quoted_ascii(),
1246                method-&gt;signature()-&gt;as_quoted_ascii(),
1247                entry_bci, comp_level);
1248     if (compiler_data() != NULL) {
1249       if (is_c2_compile(comp_level)) {
1250 #ifdef COMPILER2
1251         // Dump C2 inlining data.
1252         ((Compile*)compiler_data())-&gt;dump_inline_data(out);
1253 #endif
1254       } else if (is_c1_compile(comp_level)) {
1255 #ifdef COMPILER1
1256         // Dump C1 inlining data.
1257         ((Compilation*)compiler_data())-&gt;dump_inline_data(out);
1258 #endif
1259       }
1260     }
1261     out-&gt;cr();
1262   }
1263 }
1264 
1265 void ciEnv::dump_replay_data_unsafe(outputStream* out) {
1266   ResourceMark rm;
1267 #if INCLUDE_JVMTI
1268   out-&gt;print_cr(&quot;JvmtiExport can_access_local_variables %d&quot;,     _jvmti_can_access_local_variables);
1269   out-&gt;print_cr(&quot;JvmtiExport can_hotswap_or_post_breakpoint %d&quot;, _jvmti_can_hotswap_or_post_breakpoint);
1270   out-&gt;print_cr(&quot;JvmtiExport can_post_on_exceptions %d&quot;,         _jvmti_can_post_on_exceptions);
1271 #endif // INCLUDE_JVMTI
1272 
1273   GrowableArray&lt;ciMetadata*&gt;* objects = _factory-&gt;get_ci_metadata();
1274   out-&gt;print_cr(&quot;# %d ciObject found&quot;, objects-&gt;length());
1275   for (int i = 0; i &lt; objects-&gt;length(); i++) {
1276     objects-&gt;at(i)-&gt;dump_replay_data(out);
1277   }
1278   dump_compile_data(out);
1279   out-&gt;flush();
1280 }
1281 
1282 void ciEnv::dump_replay_data(outputStream* out) {
1283   GUARDED_VM_ENTRY(
1284     MutexLocker ml(Compile_lock);
1285     dump_replay_data_unsafe(out);
1286   )
1287 }
1288 
1289 void ciEnv::dump_replay_data(int compile_id) {
1290   static char buffer[O_BUFLEN];
1291   int ret = jio_snprintf(buffer, O_BUFLEN, &quot;replay_pid%p_compid%d.log&quot;, os::current_process_id(), compile_id);
1292   if (ret &gt; 0) {
1293     int fd = os::open(buffer, O_RDWR | O_CREAT | O_TRUNC, 0666);
1294     if (fd != -1) {
1295       FILE* replay_data_file = os::open(fd, &quot;w&quot;);
1296       if (replay_data_file != NULL) {
1297         fileStream replay_data_stream(replay_data_file, /*need_close=*/true);
1298         dump_replay_data(&amp;replay_data_stream);
1299         tty-&gt;print_cr(&quot;# Compiler replay data is saved as: %s&quot;, buffer);
1300       } else {
1301         tty-&gt;print_cr(&quot;# Can&#39;t open file to dump replay data.&quot;);
1302       }
1303     }
1304   }
1305 }
1306 
1307 void ciEnv::dump_inline_data(int compile_id) {
1308   static char buffer[O_BUFLEN];
1309   int ret = jio_snprintf(buffer, O_BUFLEN, &quot;inline_pid%p_compid%d.log&quot;, os::current_process_id(), compile_id);
1310   if (ret &gt; 0) {
1311     int fd = os::open(buffer, O_RDWR | O_CREAT | O_TRUNC, 0666);
1312     if (fd != -1) {
1313       FILE* inline_data_file = os::open(fd, &quot;w&quot;);
1314       if (inline_data_file != NULL) {
1315         fileStream replay_data_stream(inline_data_file, /*need_close=*/true);
1316         GUARDED_VM_ENTRY(
1317           MutexLocker ml(Compile_lock);
1318           dump_compile_data(&amp;replay_data_stream);
1319         )
1320         replay_data_stream.flush();
1321         tty-&gt;print(&quot;# Compiler inline data is saved as: &quot;);
1322         tty-&gt;print_cr(&quot;%s&quot;, buffer);
1323       } else {
1324         tty-&gt;print_cr(&quot;# Can&#39;t open file to dump inline data.&quot;);
1325       }
1326     }
1327   }
1328 }
    </pre>
  </body>
</html>