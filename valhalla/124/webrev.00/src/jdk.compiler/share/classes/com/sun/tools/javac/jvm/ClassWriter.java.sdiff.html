<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/jdk.compiler/share/classes/com/sun/tools/javac/jvm/ClassWriter.java</title>
    <link rel="stylesheet" href="../../../../../../../../../style.css" />
  </head>
<body>
<center>&lt; prev <a href="../../../../../../../../../index.html" target="_top">index</a> next &gt;</center>    <h2>src/jdk.compiler/share/classes/com/sun/tools/javac/jvm/ClassWriter.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 849         int alenIdx = writeAttr(names.Record);
 850         Scope s = csym.members();
 851         databuf.appendChar(csym.getRecordComponents().size());
 852         for (VarSymbol v: csym.getRecordComponents()) {
 853             //databuf.appendChar(poolWriter.putMember(v.accessor.head.snd));
 854             databuf.appendChar(poolWriter.putName(v.name));
 855             databuf.appendChar(poolWriter.putDescriptor(v));
 856             int acountIdx = beginAttrs();
 857             int acount = 0;
 858             acount += writeMemberAttrs(v, true);
 859             endAttrs(acountIdx, acount);
 860         }
 861         endAttr(alenIdx);
 862         return 1;
 863     }
 864 
 865     /**
 866      * Write NestMembers attribute (if needed)
 867      */
 868     int writeNestMembersIfNeeded(ClassSymbol csym) {
<span class="line-modified"> 869         ListBuffer&lt;ClassSymbol&gt; nested = new ListBuffer&lt;&gt;();</span>
<span class="line-modified"> 870         listNested(csym, nested);</span>
<span class="line-modified"> 871         Set&lt;ClassSymbol&gt; nestedUnique = new LinkedHashSet&lt;&gt;(nested);</span>
<span class="line-modified"> 872         if (csym.owner.kind == PCK &amp;&amp; !nestedUnique.isEmpty()) {</span>
<span class="line-modified"> 873             int alenIdx = writeAttr(names.NestMembers);</span>
<span class="line-modified"> 874             databuf.appendChar(nestedUnique.size());</span>
<span class="line-modified"> 875             for (ClassSymbol s : nestedUnique) {</span>
<span class="line-modified"> 876                 databuf.appendChar(poolWriter.putClass(s));</span>











 877             }
<span class="line-removed"> 878             endAttr(alenIdx);</span>
<span class="line-removed"> 879             return 1;</span>
 880         }
 881         return 0;
 882     }
 883 
 884     /**
 885      * Write NestHost attribute (if needed)
 886      */
 887     int writeNestHostIfNeeded(ClassSymbol csym) {
<span class="line-modified"> 888         if (csym.owner.kind != PCK) {</span>
 889             int alenIdx = writeAttr(names.NestHost);
<span class="line-modified"> 890             databuf.appendChar(poolWriter.putClass(csym.outermostClass()));</span>




 891             endAttr(alenIdx);
 892             return 1;
 893         }
 894         return 0;
 895     }
 896 
<span class="line-modified"> 897     private void listNested(Symbol sym, ListBuffer&lt;ClassSymbol&gt; seen) {</span>
 898         if (sym.kind != TYP) return;
 899         ClassSymbol csym = (ClassSymbol)sym;
 900         if (csym.owner.kind != PCK) {
 901             seen.add(csym);
 902             if (csym.isValue()) {
 903                 seen.add(csym.referenceProjection());
 904             }
 905         }
 906         if (csym.members() != null) {
 907             for (Symbol s : sym.members().getSymbols()) {
 908                 listNested(s, seen);
 909             }
 910         }
 911         if (csym.trans_local != null) {
 912             for (Symbol s : csym.trans_local) {
 913                 listNested(s, seen);
 914             }
 915         }
 916     }
 917 
</pre>
</td>
<td>
<hr />
<pre>
 849         int alenIdx = writeAttr(names.Record);
 850         Scope s = csym.members();
 851         databuf.appendChar(csym.getRecordComponents().size());
 852         for (VarSymbol v: csym.getRecordComponents()) {
 853             //databuf.appendChar(poolWriter.putMember(v.accessor.head.snd));
 854             databuf.appendChar(poolWriter.putName(v.name));
 855             databuf.appendChar(poolWriter.putDescriptor(v));
 856             int acountIdx = beginAttrs();
 857             int acount = 0;
 858             acount += writeMemberAttrs(v, true);
 859             endAttrs(acountIdx, acount);
 860         }
 861         endAttr(alenIdx);
 862         return 1;
 863     }
 864 
 865     /**
 866      * Write NestMembers attribute (if needed)
 867      */
 868     int writeNestMembersIfNeeded(ClassSymbol csym) {
<span class="line-modified"> 869         Set&lt;ClassSymbol&gt; nestedUnique = new LinkedHashSet&lt;&gt;();</span>
<span class="line-modified"> 870         if (csym.owner.kind == PCK) {</span>
<span class="line-modified"> 871             if (csym.isValue()) {</span>
<span class="line-modified"> 872                 // reference projection is the host</span>
<span class="line-modified"> 873             } else if (csym.isReferenceProjection()) {</span>
<span class="line-modified"> 874                 ClassSymbol valueProjection = csym.valueProjection();</span>
<span class="line-modified"> 875                 nestedUnique.add(valueProjection);</span>
<span class="line-modified"> 876                 listNested(valueProjection, nestedUnique);</span>
<span class="line-added"> 877             } else {</span>
<span class="line-added"> 878                 listNested(csym, nestedUnique);</span>
<span class="line-added"> 879             }</span>
<span class="line-added"> 880             if (!nestedUnique.isEmpty()) {</span>
<span class="line-added"> 881                 int alenIdx = writeAttr(names.NestMembers);</span>
<span class="line-added"> 882                 databuf.appendChar(nestedUnique.size());</span>
<span class="line-added"> 883                 for (ClassSymbol s : nestedUnique) {</span>
<span class="line-added"> 884                     databuf.appendChar(poolWriter.putClass(s));</span>
<span class="line-added"> 885                 }</span>
<span class="line-added"> 886                 endAttr(alenIdx);</span>
<span class="line-added"> 887                 return 1;</span>
 888             }


 889         }
 890         return 0;
 891     }
 892 
 893     /**
 894      * Write NestHost attribute (if needed)
 895      */
 896     int writeNestHostIfNeeded(ClassSymbol csym) {
<span class="line-modified"> 897         if (csym.owner.kind != PCK || csym.isValue()) {</span>
 898             int alenIdx = writeAttr(names.NestHost);
<span class="line-modified"> 899             ClassSymbol outerMost = csym.outermostClass();</span>
<span class="line-added"> 900             if (outerMost.isValue()) {</span>
<span class="line-added"> 901                 outerMost = outerMost.referenceProjection();</span>
<span class="line-added"> 902             }</span>
<span class="line-added"> 903             databuf.appendChar(poolWriter.putClass(outerMost));</span>
 904             endAttr(alenIdx);
 905             return 1;
 906         }
 907         return 0;
 908     }
 909 
<span class="line-modified"> 910     private void listNested(Symbol sym, Set&lt;ClassSymbol&gt; seen) {</span>
 911         if (sym.kind != TYP) return;
 912         ClassSymbol csym = (ClassSymbol)sym;
 913         if (csym.owner.kind != PCK) {
 914             seen.add(csym);
 915             if (csym.isValue()) {
 916                 seen.add(csym.referenceProjection());
 917             }
 918         }
 919         if (csym.members() != null) {
 920             for (Symbol s : sym.members().getSymbols()) {
 921                 listNested(s, seen);
 922             }
 923         }
 924         if (csym.trans_local != null) {
 925             for (Symbol s : csym.trans_local) {
 926                 listNested(s, seen);
 927             }
 928         }
 929     }
 930 
</pre>
</td>
</tr>
</table>
<center>&lt; prev <a href="../../../../../../../../../index.html" target="_top">index</a> next &gt;</center>  </body>
</html>