<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff src/jdk.compiler/share/classes/com/sun/tools/javac/jvm/ClassWriter.java</title>
    <link rel="stylesheet" href="../../../../../../../../../style.css" />
  </head>
<body>
<center>&lt; prev <a href="../../../../../../../../../index.html" target="_top">index</a> next &gt;</center>    <h2>src/jdk.compiler/share/classes/com/sun/tools/javac/jvm/ClassWriter.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -864,39 +864,52 @@</span>
  
      /**
       * Write NestMembers attribute (if needed)
       */
      int writeNestMembersIfNeeded(ClassSymbol csym) {
<span class="udiff-line-modified-removed">-         ListBuffer&lt;ClassSymbol&gt; nested = new ListBuffer&lt;&gt;();</span>
<span class="udiff-line-modified-removed">-         listNested(csym, nested);</span>
<span class="udiff-line-modified-removed">-         Set&lt;ClassSymbol&gt; nestedUnique = new LinkedHashSet&lt;&gt;(nested);</span>
<span class="udiff-line-modified-removed">-         if (csym.owner.kind == PCK &amp;&amp; !nestedUnique.isEmpty()) {</span>
<span class="udiff-line-modified-removed">-             int alenIdx = writeAttr(names.NestMembers);</span>
<span class="udiff-line-modified-removed">-             databuf.appendChar(nestedUnique.size());</span>
<span class="udiff-line-modified-removed">-             for (ClassSymbol s : nestedUnique) {</span>
<span class="udiff-line-modified-removed">-                 databuf.appendChar(poolWriter.putClass(s));</span>
<span class="udiff-line-modified-added">+         Set&lt;ClassSymbol&gt; nestedUnique = new LinkedHashSet&lt;&gt;();</span>
<span class="udiff-line-modified-added">+         if (csym.owner.kind == PCK) {</span>
<span class="udiff-line-modified-added">+             if (csym.isValue()) {</span>
<span class="udiff-line-modified-added">+                 // reference projection is the host</span>
<span class="udiff-line-modified-added">+             } else if (csym.isReferenceProjection()) {</span>
<span class="udiff-line-modified-added">+                 ClassSymbol valueProjection = csym.valueProjection();</span>
<span class="udiff-line-modified-added">+                 nestedUnique.add(valueProjection);</span>
<span class="udiff-line-modified-added">+                 listNested(valueProjection, nestedUnique);</span>
<span class="udiff-line-added">+             } else {</span>
<span class="udiff-line-added">+                 listNested(csym, nestedUnique);</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+             if (!nestedUnique.isEmpty()) {</span>
<span class="udiff-line-added">+                 int alenIdx = writeAttr(names.NestMembers);</span>
<span class="udiff-line-added">+                 databuf.appendChar(nestedUnique.size());</span>
<span class="udiff-line-added">+                 for (ClassSymbol s : nestedUnique) {</span>
<span class="udiff-line-added">+                     databuf.appendChar(poolWriter.putClass(s));</span>
<span class="udiff-line-added">+                 }</span>
<span class="udiff-line-added">+                 endAttr(alenIdx);</span>
<span class="udiff-line-added">+                 return 1;</span>
              }
<span class="udiff-line-removed">-             endAttr(alenIdx);</span>
<span class="udiff-line-removed">-             return 1;</span>
          }
          return 0;
      }
  
      /**
       * Write NestHost attribute (if needed)
       */
      int writeNestHostIfNeeded(ClassSymbol csym) {
<span class="udiff-line-modified-removed">-         if (csym.owner.kind != PCK) {</span>
<span class="udiff-line-modified-added">+         if (csym.owner.kind != PCK || csym.isValue()) {</span>
              int alenIdx = writeAttr(names.NestHost);
<span class="udiff-line-modified-removed">-             databuf.appendChar(poolWriter.putClass(csym.outermostClass()));</span>
<span class="udiff-line-modified-added">+             ClassSymbol outerMost = csym.outermostClass();</span>
<span class="udiff-line-added">+             if (outerMost.isValue()) {</span>
<span class="udiff-line-added">+                 outerMost = outerMost.referenceProjection();</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+             databuf.appendChar(poolWriter.putClass(outerMost));</span>
              endAttr(alenIdx);
              return 1;
          }
          return 0;
      }
  
<span class="udiff-line-modified-removed">-     private void listNested(Symbol sym, ListBuffer&lt;ClassSymbol&gt; seen) {</span>
<span class="udiff-line-modified-added">+     private void listNested(Symbol sym, Set&lt;ClassSymbol&gt; seen) {</span>
          if (sym.kind != TYP) return;
          ClassSymbol csym = (ClassSymbol)sym;
          if (csym.owner.kind != PCK) {
              seen.add(csym);
              if (csym.isValue()) {
</pre>
<center>&lt; prev <a href="../../../../../../../../../index.html" target="_top">index</a> next &gt;</center>  </body>
</html>