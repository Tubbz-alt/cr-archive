<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff test/hotspot/jtreg/runtime/valhalla/valuetypes/libTestJNIArrays.c</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
  </head>
<body>
<center><a href="EmptyValueTest.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="../../../../../langtools/tools/javac/valhalla/lworld-values/BoxValCastTest.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>test/hotspot/jtreg/runtime/valhalla/valuetypes/libTestJNIArrays.c</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2019, 2019 Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
</pre>
<hr />
<pre>
 98   (*env)-&gt;ReleaseFlattenedArrayElements(env, array, base, 0);
 99 }
100 
101 JNIEXPORT void JNICALL
102 Java_TestJNIArrays_initializeIntIntArrayBuffer(JNIEnv* env, jobject receiver, jarray array, int i0, int i1) {
103   int len = (*env)-&gt;GetArrayLength(env, array);
104   jsize elm_sz = (*env)-&gt;GetFlattenedArrayElementSize(env, array);
105   jclass clazz = (*env)-&gt;GetFlattenedArrayElementClass(env, array);
106   int i0_offset = (*env)-&gt;GetFieldOffsetInFlattenedLayout(env, clazz, &quot;i0&quot;, &quot;I&quot;, NULL);
107   int i1_offset = (*env)-&gt;GetFieldOffsetInFlattenedLayout(env, clazz, &quot;i1&quot;, &quot;I&quot;, NULL);
108   char* buffer = (char*)malloc(elm_sz);
109   if (buffer == NULL) {
110     jclass OOM = (*env)-&gt;FindClass(env, &quot;java/lang/OutOfMemoryException&quot;);
111     (*env)-&gt;ThrowNew(env, OOM, &quot;Malloc failed&quot;);
112     return;
113   }
114   *(int*)(buffer + i0_offset) = i0;
115   *(int*)(buffer + i1_offset) = i1;
116   void* base = (void*)(*env)-&gt;GetFlattenedArrayElements(env, array, NULL);
117   for (int i = 0; i &lt; len; i++) {
<span class="line-modified">118     memcpy((char*)base + i * elm_sz, buffer, elm_sz); </span>
119   }
120   (*env)-&gt;ReleaseFlattenedArrayElements(env, array, base, 0);
121   free(buffer);
122 }
123 
124 JNIEXPORT void JNICALL
125 Java_TestJNIArrays_initializeIntIntArrayFields(JNIEnv* env, jobject receiver, jarray array, int i0, int i1) {
126   int len = (*env)-&gt;GetArrayLength(env, array);
127   jsize elm_sz = (*env)-&gt;GetFlattenedArrayElementSize(env, array);
128   jclass clazz = (*env)-&gt;GetFlattenedArrayElementClass(env, array);
129   int i0_offset = (*env)-&gt;GetFieldOffsetInFlattenedLayout(env, clazz, &quot;i0&quot;, &quot;I&quot;, NULL);
130   int i1_offset = (*env)-&gt;GetFieldOffsetInFlattenedLayout(env, clazz, &quot;i1&quot;, &quot;I&quot;, NULL);
131   void* base = (void*)(*env)-&gt;GetFlattenedArrayElements(env, array, NULL);
132   char* elm_ptr = base;
133   for (int i = 0; i &lt; len; i++) {
134     *(int*)(elm_ptr + i0_offset) = i0;
135     *(int*)(elm_ptr + i1_offset) = i1;
136     elm_ptr += elm_sz;
137   }
138   (*env)-&gt;ReleaseFlattenedArrayElements(env, array, base, 0);
139 }
140 
141 struct IntInt_offsets {
142   int i0_offset;
143   int i1_offset;
144 };
145 
146 #ifdef __APPLE__
147 static int compare_IntInt(void* offsets, const void* x, const void* y)  {
148 #endif // __APPLE__
149 #ifdef __linux__
150 static int compare_IntInt(const void* x, const void* y, void* offsets)  {
<span class="line-modified">151 #endif // __linux__  </span>
152   int i0_offset = ((struct IntInt_offsets*)offsets)-&gt;i0_offset;
153   int x_i0 = *(int*)((char*)x + i0_offset);
154   int y_i0 = *(int*)((char*)y + i0_offset);
155   if (x_i0 &lt; y_i0) return -1;
156   if (x_i0 &gt; y_i0) return 1;
157   int i1_offset = ((struct IntInt_offsets*)offsets)-&gt;i1_offset;
158   int x_i1 = *(int*)((char*)x + i1_offset);
159   int y_i1 = *(int*)((char*)y + i1_offset );
160   if (x_i1 &lt; y_i1) return -1;
161   if (x_i1 &gt; y_i1) return 1;
162   return 0;
163 }
164 
165 JNIEXPORT void JNICALL
166 Java_TestJNIArrays_sortIntIntArray(JNIEnv* env, jobject receiver, jarray array) {
167   int len = (*env)-&gt;GetArrayLength(env, array);
168   jsize elm_sz = (*env)-&gt;GetFlattenedArrayElementSize(env, array);
169   jclass clazz = (*env)-&gt;GetFlattenedArrayElementClass(env, array);
170   struct IntInt_offsets offsets;
171   offsets.i0_offset = (*env)-&gt;GetFieldOffsetInFlattenedLayout(env, clazz, &quot;i0&quot;, &quot;I&quot;, NULL);
</pre>
</td>
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2019, 2020, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
</pre>
<hr />
<pre>
 98   (*env)-&gt;ReleaseFlattenedArrayElements(env, array, base, 0);
 99 }
100 
101 JNIEXPORT void JNICALL
102 Java_TestJNIArrays_initializeIntIntArrayBuffer(JNIEnv* env, jobject receiver, jarray array, int i0, int i1) {
103   int len = (*env)-&gt;GetArrayLength(env, array);
104   jsize elm_sz = (*env)-&gt;GetFlattenedArrayElementSize(env, array);
105   jclass clazz = (*env)-&gt;GetFlattenedArrayElementClass(env, array);
106   int i0_offset = (*env)-&gt;GetFieldOffsetInFlattenedLayout(env, clazz, &quot;i0&quot;, &quot;I&quot;, NULL);
107   int i1_offset = (*env)-&gt;GetFieldOffsetInFlattenedLayout(env, clazz, &quot;i1&quot;, &quot;I&quot;, NULL);
108   char* buffer = (char*)malloc(elm_sz);
109   if (buffer == NULL) {
110     jclass OOM = (*env)-&gt;FindClass(env, &quot;java/lang/OutOfMemoryException&quot;);
111     (*env)-&gt;ThrowNew(env, OOM, &quot;Malloc failed&quot;);
112     return;
113   }
114   *(int*)(buffer + i0_offset) = i0;
115   *(int*)(buffer + i1_offset) = i1;
116   void* base = (void*)(*env)-&gt;GetFlattenedArrayElements(env, array, NULL);
117   for (int i = 0; i &lt; len; i++) {
<span class="line-modified">118     memcpy((char*)base + i * elm_sz, buffer, elm_sz);</span>
119   }
120   (*env)-&gt;ReleaseFlattenedArrayElements(env, array, base, 0);
121   free(buffer);
122 }
123 
124 JNIEXPORT void JNICALL
125 Java_TestJNIArrays_initializeIntIntArrayFields(JNIEnv* env, jobject receiver, jarray array, int i0, int i1) {
126   int len = (*env)-&gt;GetArrayLength(env, array);
127   jsize elm_sz = (*env)-&gt;GetFlattenedArrayElementSize(env, array);
128   jclass clazz = (*env)-&gt;GetFlattenedArrayElementClass(env, array);
129   int i0_offset = (*env)-&gt;GetFieldOffsetInFlattenedLayout(env, clazz, &quot;i0&quot;, &quot;I&quot;, NULL);
130   int i1_offset = (*env)-&gt;GetFieldOffsetInFlattenedLayout(env, clazz, &quot;i1&quot;, &quot;I&quot;, NULL);
131   void* base = (void*)(*env)-&gt;GetFlattenedArrayElements(env, array, NULL);
132   char* elm_ptr = base;
133   for (int i = 0; i &lt; len; i++) {
134     *(int*)(elm_ptr + i0_offset) = i0;
135     *(int*)(elm_ptr + i1_offset) = i1;
136     elm_ptr += elm_sz;
137   }
138   (*env)-&gt;ReleaseFlattenedArrayElements(env, array, base, 0);
139 }
140 
141 struct IntInt_offsets {
142   int i0_offset;
143   int i1_offset;
144 };
145 
146 #ifdef __APPLE__
147 static int compare_IntInt(void* offsets, const void* x, const void* y)  {
148 #endif // __APPLE__
149 #ifdef __linux__
150 static int compare_IntInt(const void* x, const void* y, void* offsets)  {
<span class="line-modified">151 #endif // __linux__</span>
152   int i0_offset = ((struct IntInt_offsets*)offsets)-&gt;i0_offset;
153   int x_i0 = *(int*)((char*)x + i0_offset);
154   int y_i0 = *(int*)((char*)y + i0_offset);
155   if (x_i0 &lt; y_i0) return -1;
156   if (x_i0 &gt; y_i0) return 1;
157   int i1_offset = ((struct IntInt_offsets*)offsets)-&gt;i1_offset;
158   int x_i1 = *(int*)((char*)x + i1_offset);
159   int y_i1 = *(int*)((char*)y + i1_offset );
160   if (x_i1 &lt; y_i1) return -1;
161   if (x_i1 &gt; y_i1) return 1;
162   return 0;
163 }
164 
165 JNIEXPORT void JNICALL
166 Java_TestJNIArrays_sortIntIntArray(JNIEnv* env, jobject receiver, jarray array) {
167   int len = (*env)-&gt;GetArrayLength(env, array);
168   jsize elm_sz = (*env)-&gt;GetFlattenedArrayElementSize(env, array);
169   jclass clazz = (*env)-&gt;GetFlattenedArrayElementClass(env, array);
170   struct IntInt_offsets offsets;
171   offsets.i0_offset = (*env)-&gt;GetFieldOffsetInFlattenedLayout(env, clazz, &quot;i0&quot;, &quot;I&quot;, NULL);
</pre>
</td>
</tr>
</table>
<center><a href="EmptyValueTest.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="../../../../../langtools/tools/javac/valhalla/lworld-values/BoxValCastTest.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>