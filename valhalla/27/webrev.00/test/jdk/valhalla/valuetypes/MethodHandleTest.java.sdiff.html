<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff test/jdk/valhalla/valuetypes/MethodHandleTest.java</title>
    <link rel="stylesheet" href="../../../../style.css" />
  </head>
<body>
<center><a href="InlineReferenceTest.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="MixedValues.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>test/jdk/valhalla/valuetypes/MethodHandleTest.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
116         for (int i=0; i &lt; size; i++) {
117             Object v = (Object)getter.invoke(array, i);
118             assertEquals(v, o);
119         }
120 
121         Class&lt;?&gt; elementType = c.getComponentType();
122         if (elementType.isInlineClass()) {
123             assertTrue(elementType == elementType.asPrimaryType());
124         }
125         // set an array element to null
126         try {
127             Object v = (Object)setter.invoke(array, 0, null);
128             assertFalse(elementType.isInlineClass(), &quot;should fail to set an inline class array element to null&quot;);
129         } catch (NullPointerException e) {
130             assertTrue(elementType.isInlineClass(), &quot;should only fail to set an inline class array element to null&quot;);
131         }
132     }
133 
134     @Test
135     public static void testNullableArray() throws Throwable {
<span class="line-modified">136         Class&lt;?&gt; arrayClass = (new Point?[0]).getClass();</span>
137         Class&lt;?&gt; elementType = arrayClass.getComponentType();
<span class="line-modified">138         assertTrue(elementType == Point.class.asIndirectType(), arrayClass.getComponentType().toString());</span>
139 
140         MethodHandle setter = MethodHandles.arrayElementSetter(arrayClass);
141         MethodHandle getter = MethodHandles.arrayElementGetter(arrayClass);
142         MethodHandle ctor = MethodHandles.arrayConstructor(arrayClass);
143         Object[] array = (Object[]) ctor.invoke(2);
144         setter.invoke(array, 0, P);
145         setter.invoke(array, 1, null);
146         assertEquals((Point)getter.invoke(array, 0), P);
147         assertNull((Object)getter.invoke(array, 1));
148     }
149 
150     private final Class&lt;?&gt; c;
151     private final Object o;
152     private final List&lt;String&gt; names;
153     public MethodHandleTest(String cn, Object o, String... fields) throws Exception {
154         this.c = Class.forName(cn);
155         this.o = o;
156         this.names = List.of(fields);
157     }
158 
</pre>
<hr />
<pre>
178         Object value = mh.invoke(o);
179     }
180 
181     void varHandle(Field f) throws Throwable {
182         VarHandle vh = MethodHandles.lookup().findVarHandle(c, f.getName(), f.getType());
183         Object value = vh.get(o);
184     }
185 
186     void unreflectField(Field f) throws Throwable {
187         MethodHandle mh = MethodHandles.lookup().unreflectGetter(f);
188         Object value = mh.invoke(o);
189     }
190 
191     /*
192      * Test setting a field of an inline type to a new value.
193      * The field must be flattenable but may or may not be flattened.
194      */
195     void setValueField(String name, Object obj, Object value) throws Throwable {
196         Field f = c.getDeclaredField(name);
197         boolean isStatic = Modifier.isStatic(f.getModifiers());
<span class="line-modified">198         assertTrue(f.getType().isInlineClass());</span>

199         assertTrue((isStatic &amp;&amp; obj == null) || (!isStatic &amp;&amp; obj != null));
200         Object v = f.get(obj);
201 
202         // Field::set
203         try {
204             f.set(obj, value);
205             assertEquals(f.get(obj), value);
206         } finally {
207             f.set(obj, v);
208         }
209 
210 
211         if (isStatic) {
212             setStaticField(f, value);
213         } else {
214             setInstanceField(f, obj, value);
215         }
216     }
217 
218     private void setInstanceField(Field f, Object obj, Object value) throws Throwable {
</pre>
</td>
<td>
<hr />
<pre>
116         for (int i=0; i &lt; size; i++) {
117             Object v = (Object)getter.invoke(array, i);
118             assertEquals(v, o);
119         }
120 
121         Class&lt;?&gt; elementType = c.getComponentType();
122         if (elementType.isInlineClass()) {
123             assertTrue(elementType == elementType.asPrimaryType());
124         }
125         // set an array element to null
126         try {
127             Object v = (Object)setter.invoke(array, 0, null);
128             assertFalse(elementType.isInlineClass(), &quot;should fail to set an inline class array element to null&quot;);
129         } catch (NullPointerException e) {
130             assertTrue(elementType.isInlineClass(), &quot;should only fail to set an inline class array element to null&quot;);
131         }
132     }
133 
134     @Test
135     public static void testNullableArray() throws Throwable {
<span class="line-modified">136         Class&lt;?&gt; arrayClass = (new Point.ref[0]).getClass();</span>
137         Class&lt;?&gt; elementType = arrayClass.getComponentType();
<span class="line-modified">138         assertTrue(elementType == Point.ref.class, arrayClass.getComponentType().toString());</span>
139 
140         MethodHandle setter = MethodHandles.arrayElementSetter(arrayClass);
141         MethodHandle getter = MethodHandles.arrayElementGetter(arrayClass);
142         MethodHandle ctor = MethodHandles.arrayConstructor(arrayClass);
143         Object[] array = (Object[]) ctor.invoke(2);
144         setter.invoke(array, 0, P);
145         setter.invoke(array, 1, null);
146         assertEquals((Point)getter.invoke(array, 0), P);
147         assertNull((Object)getter.invoke(array, 1));
148     }
149 
150     private final Class&lt;?&gt; c;
151     private final Object o;
152     private final List&lt;String&gt; names;
153     public MethodHandleTest(String cn, Object o, String... fields) throws Exception {
154         this.c = Class.forName(cn);
155         this.o = o;
156         this.names = List.of(fields);
157     }
158 
</pre>
<hr />
<pre>
178         Object value = mh.invoke(o);
179     }
180 
181     void varHandle(Field f) throws Throwable {
182         VarHandle vh = MethodHandles.lookup().findVarHandle(c, f.getName(), f.getType());
183         Object value = vh.get(o);
184     }
185 
186     void unreflectField(Field f) throws Throwable {
187         MethodHandle mh = MethodHandles.lookup().unreflectGetter(f);
188         Object value = mh.invoke(o);
189     }
190 
191     /*
192      * Test setting a field of an inline type to a new value.
193      * The field must be flattenable but may or may not be flattened.
194      */
195     void setValueField(String name, Object obj, Object value) throws Throwable {
196         Field f = c.getDeclaredField(name);
197         boolean isStatic = Modifier.isStatic(f.getModifiers());
<span class="line-modified">198         assertTrue(f.getType().isInlineClass() ||</span>
<span class="line-added">199                    f.getType().getCanonicalName().endsWith(&quot;$ref&quot;));</span>
200         assertTrue((isStatic &amp;&amp; obj == null) || (!isStatic &amp;&amp; obj != null));
201         Object v = f.get(obj);
202 
203         // Field::set
204         try {
205             f.set(obj, value);
206             assertEquals(f.get(obj), value);
207         } finally {
208             f.set(obj, v);
209         }
210 
211 
212         if (isStatic) {
213             setStaticField(f, value);
214         } else {
215             setInstanceField(f, obj, value);
216         }
217     }
218 
219     private void setInstanceField(Field f, Object obj, Object value) throws Throwable {
</pre>
</td>
</tr>
</table>
<center><a href="InlineReferenceTest.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="MixedValues.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>