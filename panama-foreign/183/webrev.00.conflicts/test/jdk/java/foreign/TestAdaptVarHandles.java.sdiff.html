<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff test/jdk/java/foreign/TestAdaptVarHandles.java</title>
    <link rel="stylesheet" href="../../../../style.css" />
  </head>
<body>
<center><a href="../../../../src/jdk.incubator.foreign/share/classes/jdk/internal/foreign/NativeMemorySegmentImpl.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="TestByteBuffer.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>test/jdk/java/foreign/TestAdaptVarHandles.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 32  */
 33 
 34 import jdk.incubator.foreign.MemoryAddress;
 35 import jdk.incubator.foreign.MemoryHandles;
 36 import jdk.incubator.foreign.MemoryLayouts;
 37 import jdk.incubator.foreign.MemorySegment;
 38 import jdk.incubator.foreign.ValueLayout;
 39 import org.testng.annotations.*;
 40 import static org.testng.Assert.*;
 41 
 42 import java.lang.invoke.MethodHandle;
 43 import java.lang.invoke.MethodHandles;
 44 import java.lang.invoke.MethodType;
 45 import java.lang.invoke.VarHandle;
 46 import java.util.List;
 47 
 48 public class TestAdaptVarHandles {
 49 
 50     static MethodHandle S2I;
 51     static MethodHandle I2S;






 52     static MethodHandle S2L;
 53     static MethodHandle S2L_EX;
 54     static MethodHandle S2I_EX;
 55     static MethodHandle I2S_EX;
 56     static MethodHandle BASE_ADDR;
 57     static MethodHandle SUM_OFFSETS;
 58     static MethodHandle VOID_FILTER;
 59 
 60     static {
 61         try {
 62             S2I = MethodHandles.lookup().findStatic(TestAdaptVarHandles.class, &quot;stringToInt&quot;, MethodType.methodType(int.class, String.class));
 63             I2S = MethodHandles.lookup().findStatic(TestAdaptVarHandles.class, &quot;intToString&quot;, MethodType.methodType(String.class, int.class));







 64             S2L = MethodHandles.lookup().findStatic(TestAdaptVarHandles.class, &quot;stringToLong&quot;, MethodType.methodType(long.class, String.class));
 65             S2L_EX = MethodHandles.lookup().findStatic(TestAdaptVarHandles.class, &quot;stringToLongException&quot;, MethodType.methodType(long.class, String.class));
 66             BASE_ADDR = MethodHandles.lookup().findStatic(TestAdaptVarHandles.class, &quot;baseAddress&quot;, MethodType.methodType(MemoryAddress.class, MemorySegment.class));
 67             SUM_OFFSETS = MethodHandles.lookup().findStatic(TestAdaptVarHandles.class, &quot;sumOffsets&quot;, MethodType.methodType(long.class, long.class, long.class));
 68             VOID_FILTER = MethodHandles.lookup().findStatic(TestAdaptVarHandles.class, &quot;void_filter&quot;, MethodType.methodType(void.class, String.class));
 69 
 70             MethodHandle s2i_ex = MethodHandles.throwException(int.class, Throwable.class);
 71             s2i_ex = MethodHandles.insertArguments(s2i_ex, 0, new Throwable());
 72             S2I_EX = MethodHandles.dropArguments(s2i_ex, 0, String.class);
 73 
 74             MethodHandle i2s_ex = MethodHandles.throwException(String.class, Throwable.class);
 75             i2s_ex = MethodHandles.insertArguments(i2s_ex, 0, new Throwable());
 76             I2S_EX = MethodHandles.dropArguments(i2s_ex, 0, int.class);
 77         } catch (Throwable ex) {
 78             throw new ExceptionInInitializerError();
 79         }
 80     }
 81 
 82     @Test
 83     public void testFilterValue() throws Throwable {
 84         ValueLayout layout = MemoryLayouts.JAVA_INT;
 85         MemorySegment segment = MemorySegment.allocateNative(layout);
 86         VarHandle intHandle = layout.varHandle(int.class);
 87         VarHandle i2SHandle = MemoryHandles.filterValue(intHandle, S2I, I2S);
 88         i2SHandle.set(segment.baseAddress(), &quot;1&quot;);
 89         String oldValue = (String)i2SHandle.getAndAdd(segment.baseAddress(), &quot;42&quot;);
 90         assertEquals(oldValue, &quot;1&quot;);
 91         String value = (String)i2SHandle.get(segment.baseAddress());
 92         assertEquals(value, &quot;43&quot;);
 93         boolean swapped = (boolean)i2SHandle.compareAndSet(segment.baseAddress(), &quot;43&quot;, &quot;12&quot;);
 94         assertTrue(swapped);
 95         oldValue = (String)i2SHandle.compareAndExchange(segment.baseAddress(), &quot;12&quot;, &quot;42&quot;);
 96         assertEquals(oldValue, &quot;12&quot;);
 97         value = (String)i2SHandle.toMethodHandle(VarHandle.AccessMode.GET).invokeExact(segment.baseAddress());
 98         assertEquals(value, &quot;42&quot;);
 99     }
100 











































101     @Test(expectedExceptions = NullPointerException.class)
102     public void testBadFilterNullTarget() {
103         MemoryHandles.filterValue(null, S2I, I2S);
104     }
105 
106     @Test(expectedExceptions = NullPointerException.class)
107     public void testBadFilterNullUnbox() {
108         VarHandle intHandle = MemoryLayouts.JAVA_INT.varHandle(int.class);
109         MemoryHandles.filterValue(intHandle, null, I2S);
110     }
111 
112     @Test(expectedExceptions = NullPointerException.class)
113     public void testBadFilterNullBox() {
114         VarHandle intHandle = MemoryLayouts.JAVA_INT.varHandle(int.class);
115         MemoryHandles.filterValue(intHandle, S2I, null);
116     }
117 
118     @Test(expectedExceptions = IllegalArgumentException.class)
119     public void testBadFilterCarrier() {
120         VarHandle floatHandle = MemoryLayouts.JAVA_FLOAT.varHandle(float.class);
121         MemoryHandles.filterValue(floatHandle, S2I, I2S);
122     }
123 
124     @Test(expectedExceptions = IllegalArgumentException.class)
125     public void testBadFilterUnboxArity() {
126         VarHandle floatHandle = MemoryLayouts.JAVA_INT.varHandle(int.class);
127         MemoryHandles.filterValue(floatHandle, S2I.bindTo(&quot;&quot;), I2S);
128     }
129 
130     @Test(expectedExceptions = IllegalArgumentException.class)
131     public void testBadFilterBoxArity() {
132         VarHandle intHandle = MemoryLayouts.JAVA_INT.varHandle(int.class);
133         MemoryHandles.filterValue(intHandle, S2I, I2S.bindTo(42));
134     }
135 
136     @Test(expectedExceptions = IllegalArgumentException.class)











137     public void testBadFilterBoxException() {
138         VarHandle intHandle = MemoryLayouts.JAVA_INT.varHandle(int.class);
139         MemoryHandles.filterValue(intHandle, I2S, S2L_EX);
140     }
141 
142     @Test(expectedExceptions = IllegalArgumentException.class)
143     public void testBadFilterUnboxException() {
144         VarHandle intHandle = MemoryLayouts.JAVA_INT.varHandle(int.class);
145         MemoryHandles.filterValue(intHandle, S2L_EX, I2S);
146     }
147 
148     @Test(expectedExceptions = IllegalArgumentException.class)
149     public void testBadFilterBoxHandleException() {
150         VarHandle intHandle = MemoryLayouts.JAVA_INT.varHandle(int.class);
151         MemoryHandles.filterValue(intHandle, S2I, I2S_EX);
152     }
153 
154     @Test(expectedExceptions = IllegalArgumentException.class)
155     public void testBadFilterUnboxHandleException() {
156         VarHandle intHandle = MemoryLayouts.JAVA_INT.varHandle(int.class);
</pre>
<hr />
<pre>
444         return String.valueOf(i);
445     }
446 
447     static long stringToLong(String s) {
448         return Long.valueOf(s);
449     }
450 
451     static long stringToLongException(String s) throws Throwable {
452         return Long.valueOf(s);
453     }
454 
455     static MemoryAddress baseAddress(MemorySegment segment) {
456         return segment.baseAddress();
457     }
458 
459     static long sumOffsets(long l1, long l2) {
460         return l1 + l2;
461     }
462 
463     static void void_filter(String s) { }







464 }
</pre>
</td>
<td>
<hr />
<pre>
 32  */
 33 
 34 import jdk.incubator.foreign.MemoryAddress;
 35 import jdk.incubator.foreign.MemoryHandles;
 36 import jdk.incubator.foreign.MemoryLayouts;
 37 import jdk.incubator.foreign.MemorySegment;
 38 import jdk.incubator.foreign.ValueLayout;
 39 import org.testng.annotations.*;
 40 import static org.testng.Assert.*;
 41 
 42 import java.lang.invoke.MethodHandle;
 43 import java.lang.invoke.MethodHandles;
 44 import java.lang.invoke.MethodType;
 45 import java.lang.invoke.VarHandle;
 46 import java.util.List;
 47 
 48 public class TestAdaptVarHandles {
 49 
 50     static MethodHandle S2I;
 51     static MethodHandle I2S;
<span class="line-added"> 52 &lt;&lt;&lt;&lt;&lt;&lt;&lt; HEAD</span>
<span class="line-added"> 53 =======</span>
<span class="line-added"> 54     static MethodHandle CTX_I2S;</span>
<span class="line-added"> 55     static MethodHandle O2I;</span>
<span class="line-added"> 56     static MethodHandle I2O;</span>
<span class="line-added"> 57 &gt;&gt;&gt;&gt;&gt;&gt;&gt; cd397502f19f72fa8a926f4508d3913c8ace9059</span>
 58     static MethodHandle S2L;
 59     static MethodHandle S2L_EX;
 60     static MethodHandle S2I_EX;
 61     static MethodHandle I2S_EX;
 62     static MethodHandle BASE_ADDR;
 63     static MethodHandle SUM_OFFSETS;
 64     static MethodHandle VOID_FILTER;
 65 
 66     static {
 67         try {
 68             S2I = MethodHandles.lookup().findStatic(TestAdaptVarHandles.class, &quot;stringToInt&quot;, MethodType.methodType(int.class, String.class));
 69             I2S = MethodHandles.lookup().findStatic(TestAdaptVarHandles.class, &quot;intToString&quot;, MethodType.methodType(String.class, int.class));
<span class="line-added"> 70 &lt;&lt;&lt;&lt;&lt;&lt;&lt; HEAD</span>
<span class="line-added"> 71 =======</span>
<span class="line-added"> 72             CTX_I2S = MethodHandles.lookup().findStatic(TestAdaptVarHandles.class, &quot;ctxIntToString&quot;,</span>
<span class="line-added"> 73                     MethodType.methodType(String.class, String.class, String.class, int.class));</span>
<span class="line-added"> 74             O2I = MethodHandles.explicitCastArguments(S2I, MethodType.methodType(int.class, Object.class));</span>
<span class="line-added"> 75             I2O = MethodHandles.explicitCastArguments(I2S, MethodType.methodType(Object.class, int.class));</span>
<span class="line-added"> 76 &gt;&gt;&gt;&gt;&gt;&gt;&gt; cd397502f19f72fa8a926f4508d3913c8ace9059</span>
 77             S2L = MethodHandles.lookup().findStatic(TestAdaptVarHandles.class, &quot;stringToLong&quot;, MethodType.methodType(long.class, String.class));
 78             S2L_EX = MethodHandles.lookup().findStatic(TestAdaptVarHandles.class, &quot;stringToLongException&quot;, MethodType.methodType(long.class, String.class));
 79             BASE_ADDR = MethodHandles.lookup().findStatic(TestAdaptVarHandles.class, &quot;baseAddress&quot;, MethodType.methodType(MemoryAddress.class, MemorySegment.class));
 80             SUM_OFFSETS = MethodHandles.lookup().findStatic(TestAdaptVarHandles.class, &quot;sumOffsets&quot;, MethodType.methodType(long.class, long.class, long.class));
 81             VOID_FILTER = MethodHandles.lookup().findStatic(TestAdaptVarHandles.class, &quot;void_filter&quot;, MethodType.methodType(void.class, String.class));
 82 
 83             MethodHandle s2i_ex = MethodHandles.throwException(int.class, Throwable.class);
 84             s2i_ex = MethodHandles.insertArguments(s2i_ex, 0, new Throwable());
 85             S2I_EX = MethodHandles.dropArguments(s2i_ex, 0, String.class);
 86 
 87             MethodHandle i2s_ex = MethodHandles.throwException(String.class, Throwable.class);
 88             i2s_ex = MethodHandles.insertArguments(i2s_ex, 0, new Throwable());
 89             I2S_EX = MethodHandles.dropArguments(i2s_ex, 0, int.class);
 90         } catch (Throwable ex) {
 91             throw new ExceptionInInitializerError();
 92         }
 93     }
 94 
 95     @Test
 96     public void testFilterValue() throws Throwable {
 97         ValueLayout layout = MemoryLayouts.JAVA_INT;
 98         MemorySegment segment = MemorySegment.allocateNative(layout);
 99         VarHandle intHandle = layout.varHandle(int.class);
100         VarHandle i2SHandle = MemoryHandles.filterValue(intHandle, S2I, I2S);
101         i2SHandle.set(segment.baseAddress(), &quot;1&quot;);
102         String oldValue = (String)i2SHandle.getAndAdd(segment.baseAddress(), &quot;42&quot;);
103         assertEquals(oldValue, &quot;1&quot;);
104         String value = (String)i2SHandle.get(segment.baseAddress());
105         assertEquals(value, &quot;43&quot;);
106         boolean swapped = (boolean)i2SHandle.compareAndSet(segment.baseAddress(), &quot;43&quot;, &quot;12&quot;);
107         assertTrue(swapped);
108         oldValue = (String)i2SHandle.compareAndExchange(segment.baseAddress(), &quot;12&quot;, &quot;42&quot;);
109         assertEquals(oldValue, &quot;12&quot;);
110         value = (String)i2SHandle.toMethodHandle(VarHandle.AccessMode.GET).invokeExact(segment.baseAddress());
111         assertEquals(value, &quot;42&quot;);
112     }
113 
<span class="line-added">114 &lt;&lt;&lt;&lt;&lt;&lt;&lt; HEAD</span>
<span class="line-added">115 =======</span>
<span class="line-added">116     @Test</span>
<span class="line-added">117     public void testFilterValueComposite() throws Throwable {</span>
<span class="line-added">118         ValueLayout layout = MemoryLayouts.JAVA_INT;</span>
<span class="line-added">119         MemorySegment segment = MemorySegment.allocateNative(layout);</span>
<span class="line-added">120         VarHandle intHandle = layout.varHandle(int.class);</span>
<span class="line-added">121         MethodHandle CTX_S2I = MethodHandles.dropArguments(S2I, 0, String.class, String.class);</span>
<span class="line-added">122         VarHandle i2SHandle = MemoryHandles.filterValue(intHandle, CTX_S2I, CTX_I2S);</span>
<span class="line-added">123         i2SHandle = MemoryHandles.insertCoordinates(i2SHandle, 1, &quot;a&quot;, &quot;b&quot;);</span>
<span class="line-added">124         i2SHandle.set(segment.baseAddress(), &quot;1&quot;);</span>
<span class="line-added">125         String oldValue = (String)i2SHandle.getAndAdd(segment.baseAddress(), &quot;42&quot;);</span>
<span class="line-added">126         assertEquals(oldValue, &quot;ab1&quot;);</span>
<span class="line-added">127         String value = (String)i2SHandle.get(segment.baseAddress());</span>
<span class="line-added">128         assertEquals(value, &quot;ab43&quot;);</span>
<span class="line-added">129         boolean swapped = (boolean)i2SHandle.compareAndSet(segment.baseAddress(), &quot;43&quot;, &quot;12&quot;);</span>
<span class="line-added">130         assertTrue(swapped);</span>
<span class="line-added">131         oldValue = (String)i2SHandle.compareAndExchange(segment.baseAddress(), &quot;12&quot;, &quot;42&quot;);</span>
<span class="line-added">132         assertEquals(oldValue, &quot;ab12&quot;);</span>
<span class="line-added">133         value = (String)i2SHandle.toMethodHandle(VarHandle.AccessMode.GET).invokeExact(segment.baseAddress());</span>
<span class="line-added">134         assertEquals(value, &quot;ab42&quot;);</span>
<span class="line-added">135     }</span>
<span class="line-added">136 </span>
<span class="line-added">137     @Test</span>
<span class="line-added">138     public void testFilterValueLoose() throws Throwable {</span>
<span class="line-added">139         ValueLayout layout = MemoryLayouts.JAVA_INT;</span>
<span class="line-added">140         MemorySegment segment = MemorySegment.allocateNative(layout);</span>
<span class="line-added">141         VarHandle intHandle = layout.varHandle(int.class);</span>
<span class="line-added">142         VarHandle i2SHandle = MemoryHandles.filterValue(intHandle, O2I, I2O);</span>
<span class="line-added">143         i2SHandle.set(segment.baseAddress(), &quot;1&quot;);</span>
<span class="line-added">144         String oldValue = (String)i2SHandle.getAndAdd(segment.baseAddress(), &quot;42&quot;);</span>
<span class="line-added">145         assertEquals(oldValue, &quot;1&quot;);</span>
<span class="line-added">146         String value = (String)i2SHandle.get(segment.baseAddress());</span>
<span class="line-added">147         assertEquals(value, &quot;43&quot;);</span>
<span class="line-added">148         boolean swapped = (boolean)i2SHandle.compareAndSet(segment.baseAddress(), &quot;43&quot;, &quot;12&quot;);</span>
<span class="line-added">149         assertTrue(swapped);</span>
<span class="line-added">150         oldValue = (String)i2SHandle.compareAndExchange(segment.baseAddress(), &quot;12&quot;, &quot;42&quot;);</span>
<span class="line-added">151         assertEquals(oldValue, &quot;12&quot;);</span>
<span class="line-added">152         value = (String)(Object)i2SHandle.toMethodHandle(VarHandle.AccessMode.GET).invokeExact(segment.baseAddress());</span>
<span class="line-added">153         assertEquals(value, &quot;42&quot;);</span>
<span class="line-added">154     }</span>
<span class="line-added">155 </span>
<span class="line-added">156 &gt;&gt;&gt;&gt;&gt;&gt;&gt; cd397502f19f72fa8a926f4508d3913c8ace9059</span>
157     @Test(expectedExceptions = NullPointerException.class)
158     public void testBadFilterNullTarget() {
159         MemoryHandles.filterValue(null, S2I, I2S);
160     }
161 
162     @Test(expectedExceptions = NullPointerException.class)
163     public void testBadFilterNullUnbox() {
164         VarHandle intHandle = MemoryLayouts.JAVA_INT.varHandle(int.class);
165         MemoryHandles.filterValue(intHandle, null, I2S);
166     }
167 
168     @Test(expectedExceptions = NullPointerException.class)
169     public void testBadFilterNullBox() {
170         VarHandle intHandle = MemoryLayouts.JAVA_INT.varHandle(int.class);
171         MemoryHandles.filterValue(intHandle, S2I, null);
172     }
173 
174     @Test(expectedExceptions = IllegalArgumentException.class)
175     public void testBadFilterCarrier() {
176         VarHandle floatHandle = MemoryLayouts.JAVA_FLOAT.varHandle(float.class);
177         MemoryHandles.filterValue(floatHandle, S2I, I2S);
178     }
179 
180     @Test(expectedExceptions = IllegalArgumentException.class)
181     public void testBadFilterUnboxArity() {
182         VarHandle floatHandle = MemoryLayouts.JAVA_INT.varHandle(int.class);
183         MemoryHandles.filterValue(floatHandle, S2I.bindTo(&quot;&quot;), I2S);
184     }
185 
186     @Test(expectedExceptions = IllegalArgumentException.class)
187     public void testBadFilterBoxArity() {
188         VarHandle intHandle = MemoryLayouts.JAVA_INT.varHandle(int.class);
189         MemoryHandles.filterValue(intHandle, S2I, I2S.bindTo(42));
190     }
191 
192     @Test(expectedExceptions = IllegalArgumentException.class)
<span class="line-added">193 &lt;&lt;&lt;&lt;&lt;&lt;&lt; HEAD</span>
<span class="line-added">194 =======</span>
<span class="line-added">195     public void testBadFilterBoxPrefixCoordinates() {</span>
<span class="line-added">196         VarHandle intHandle = MemoryLayouts.JAVA_INT.varHandle(int.class);</span>
<span class="line-added">197         MemoryHandles.filterValue(intHandle,</span>
<span class="line-added">198                 MethodHandles.dropArguments(S2I, 1, int.class),</span>
<span class="line-added">199                 MethodHandles.dropArguments(I2S, 1, long.class));</span>
<span class="line-added">200     }</span>
<span class="line-added">201 </span>
<span class="line-added">202     @Test(expectedExceptions = IllegalArgumentException.class)</span>
<span class="line-added">203 &gt;&gt;&gt;&gt;&gt;&gt;&gt; cd397502f19f72fa8a926f4508d3913c8ace9059</span>
204     public void testBadFilterBoxException() {
205         VarHandle intHandle = MemoryLayouts.JAVA_INT.varHandle(int.class);
206         MemoryHandles.filterValue(intHandle, I2S, S2L_EX);
207     }
208 
209     @Test(expectedExceptions = IllegalArgumentException.class)
210     public void testBadFilterUnboxException() {
211         VarHandle intHandle = MemoryLayouts.JAVA_INT.varHandle(int.class);
212         MemoryHandles.filterValue(intHandle, S2L_EX, I2S);
213     }
214 
215     @Test(expectedExceptions = IllegalArgumentException.class)
216     public void testBadFilterBoxHandleException() {
217         VarHandle intHandle = MemoryLayouts.JAVA_INT.varHandle(int.class);
218         MemoryHandles.filterValue(intHandle, S2I, I2S_EX);
219     }
220 
221     @Test(expectedExceptions = IllegalArgumentException.class)
222     public void testBadFilterUnboxHandleException() {
223         VarHandle intHandle = MemoryLayouts.JAVA_INT.varHandle(int.class);
</pre>
<hr />
<pre>
511         return String.valueOf(i);
512     }
513 
514     static long stringToLong(String s) {
515         return Long.valueOf(s);
516     }
517 
518     static long stringToLongException(String s) throws Throwable {
519         return Long.valueOf(s);
520     }
521 
522     static MemoryAddress baseAddress(MemorySegment segment) {
523         return segment.baseAddress();
524     }
525 
526     static long sumOffsets(long l1, long l2) {
527         return l1 + l2;
528     }
529 
530     static void void_filter(String s) { }
<span class="line-added">531 &lt;&lt;&lt;&lt;&lt;&lt;&lt; HEAD</span>
<span class="line-added">532 =======</span>
<span class="line-added">533 </span>
<span class="line-added">534     static String ctxIntToString(String a, String b, int i) {</span>
<span class="line-added">535         return a + b + String.valueOf(i);</span>
<span class="line-added">536     }</span>
<span class="line-added">537 &gt;&gt;&gt;&gt;&gt;&gt;&gt; cd397502f19f72fa8a926f4508d3913c8ace9059</span>
538 }
</pre>
</td>
</tr>
</table>
<center><a href="../../../../src/jdk.incubator.foreign/share/classes/jdk/internal/foreign/NativeMemorySegmentImpl.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="TestByteBuffer.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>