<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/java.base/share/classes/java/lang/invoke/MemoryAccessVarHandleGenerator.java</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
  </head>
<body>
<center><a href="Invokers.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="VarHandles.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/java.base/share/classes/java/lang/invoke/MemoryAccessVarHandleGenerator.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 44 import java.io.PrintWriter;
 45 import java.io.StringWriter;
 46 import java.util.Arrays;
 47 import java.util.HashMap;
 48 
 49 import static jdk.internal.org.objectweb.asm.Opcodes.AALOAD;
 50 import static jdk.internal.org.objectweb.asm.Opcodes.ACC_FINAL;
 51 import static jdk.internal.org.objectweb.asm.Opcodes.ACC_PRIVATE;
 52 import static jdk.internal.org.objectweb.asm.Opcodes.ACC_PUBLIC;
 53 import static jdk.internal.org.objectweb.asm.Opcodes.ACC_STATIC;
 54 import static jdk.internal.org.objectweb.asm.Opcodes.ACC_SUPER;
 55 import static jdk.internal.org.objectweb.asm.Opcodes.ALOAD;
 56 import static jdk.internal.org.objectweb.asm.Opcodes.ARETURN;
 57 import static jdk.internal.org.objectweb.asm.Opcodes.ASTORE;
 58 import static jdk.internal.org.objectweb.asm.Opcodes.BIPUSH;
 59 import static jdk.internal.org.objectweb.asm.Opcodes.CHECKCAST;
 60 import static jdk.internal.org.objectweb.asm.Opcodes.GETFIELD;
 61 import static jdk.internal.org.objectweb.asm.Opcodes.GETSTATIC;
 62 import static jdk.internal.org.objectweb.asm.Opcodes.H_INVOKESTATIC;
 63 import static jdk.internal.org.objectweb.asm.Opcodes.ICONST_0;

 64 import static jdk.internal.org.objectweb.asm.Opcodes.ICONST_1;
 65 import static jdk.internal.org.objectweb.asm.Opcodes.ICONST_2;
 66 import static jdk.internal.org.objectweb.asm.Opcodes.ICONST_3;


 67 import static jdk.internal.org.objectweb.asm.Opcodes.ILOAD;
 68 import static jdk.internal.org.objectweb.asm.Opcodes.INVOKESPECIAL;
 69 import static jdk.internal.org.objectweb.asm.Opcodes.INVOKESTATIC;
 70 import static jdk.internal.org.objectweb.asm.Opcodes.INVOKEVIRTUAL;
 71 import static jdk.internal.org.objectweb.asm.Opcodes.LALOAD;
 72 import static jdk.internal.org.objectweb.asm.Opcodes.LASTORE;
 73 import static jdk.internal.org.objectweb.asm.Opcodes.LLOAD;
 74 import static jdk.internal.org.objectweb.asm.Opcodes.NEWARRAY;
 75 import static jdk.internal.org.objectweb.asm.Opcodes.PUTFIELD;
 76 import static jdk.internal.org.objectweb.asm.Opcodes.PUTSTATIC;
 77 import static jdk.internal.org.objectweb.asm.Opcodes.RETURN;
 78 import static jdk.internal.org.objectweb.asm.Opcodes.DUP;
 79 import static jdk.internal.org.objectweb.asm.Opcodes.SIPUSH;
 80 import static jdk.internal.org.objectweb.asm.Opcodes.T_LONG;
 81 import static jdk.internal.org.objectweb.asm.Opcodes.V14;
 82 
 83 class MemoryAccessVarHandleGenerator {
 84     private static final String DEBUG_DUMP_CLASSES_DIR_PROPERTY = &quot;jdk.internal.foreign.ClassGenerator.DEBUG_DUMP_CLASSES_DIR&quot;;
 85 
 86     private static final boolean DEBUG =
</pre>
<hr />
<pre>
314             MethodHandles.Lookup.IMPL_LOOKUP
315                     .findStatic(helperClass,
316                             helperMethodName,
317                             helperType);
318 
319 
320             MethodVisitor mv = cw.visitMethod(ACC_STATIC, methName, methType.toMethodDescriptorString(), null, null);
321             mv.visitAnnotation(Type.getDescriptor(ForceInline.class), true);
322             mv.visitCode();
323 
324             mv.visitVarInsn(ALOAD, 0); // handle impl
325             mv.visitVarInsn(ALOAD, 1); // receiver
326 
327             // offset calculation
328             int slot = 2;
329             mv.visitVarInsn(ALOAD, 0); // load recv
330             mv.visitTypeInsn(CHECKCAST, Type.getInternalName(BASE_CLASS));
331             mv.visitFieldInsn(GETFIELD, Type.getInternalName(BASE_CLASS), &quot;offset&quot;, &quot;J&quot;);
332             for (int i = 0 ; i &lt; dimensions ; i++) {
333                 // load ADD MH

334                 mv.visitFieldInsn(GETSTATIC, implClassName, &quot;addHandle&quot;, MethodHandle.class.descriptorString());




335 
336                 //fixup stack so that ADD MH ends up bottom
337                 mv.visitInsn(Opcodes.DUP_X2);
338                 mv.visitInsn(Opcodes.POP);
339 
340                 // load MUL MH

341                 mv.visitFieldInsn(GETSTATIC, implClassName, &quot;mulHandle&quot;, MethodHandle.class.descriptorString());



342                 mv.visitTypeInsn(CHECKCAST, Type.getInternalName(MethodHandle.class));
343 
344                 mv.visitVarInsn(ALOAD, 0); // load recv
345                 mv.visitTypeInsn(CHECKCAST, implClassName);
346                 mv.visitFieldInsn(GETFIELD, implClassName, &quot;dim&quot; + i, &quot;J&quot;);
347                 mv.visitVarInsn(LLOAD, slot);
348 
349                 mv.visitVarInsn(ALOAD, 1); // receiver
350                 mv.visitTypeInsn(CHECKCAST, Type.getInternalName(MemoryAddressProxy.class));
351 
352                 //MUL
353                 mv.visitMethodInsn(INVOKEVIRTUAL, Type.getInternalName(MethodHandle.class), &quot;invokeExact&quot;,
354                         OFFSET_OP_TYPE.toMethodDescriptorString(), false);
355 
356                 mv.visitVarInsn(ALOAD, 1); // receiver
357                 mv.visitTypeInsn(CHECKCAST, Type.getInternalName(MemoryAddressProxy.class));
358 
359                 //ADD
360                 mv.visitMethodInsn(INVOKEVIRTUAL, Type.getInternalName(MethodHandle.class), &quot;invokeExact&quot;,
361                         OFFSET_OP_TYPE.toMethodDescriptorString(), false);
</pre>
</td>
<td>
<hr />
<pre>
 44 import java.io.PrintWriter;
 45 import java.io.StringWriter;
 46 import java.util.Arrays;
 47 import java.util.HashMap;
 48 
 49 import static jdk.internal.org.objectweb.asm.Opcodes.AALOAD;
 50 import static jdk.internal.org.objectweb.asm.Opcodes.ACC_FINAL;
 51 import static jdk.internal.org.objectweb.asm.Opcodes.ACC_PRIVATE;
 52 import static jdk.internal.org.objectweb.asm.Opcodes.ACC_PUBLIC;
 53 import static jdk.internal.org.objectweb.asm.Opcodes.ACC_STATIC;
 54 import static jdk.internal.org.objectweb.asm.Opcodes.ACC_SUPER;
 55 import static jdk.internal.org.objectweb.asm.Opcodes.ALOAD;
 56 import static jdk.internal.org.objectweb.asm.Opcodes.ARETURN;
 57 import static jdk.internal.org.objectweb.asm.Opcodes.ASTORE;
 58 import static jdk.internal.org.objectweb.asm.Opcodes.BIPUSH;
 59 import static jdk.internal.org.objectweb.asm.Opcodes.CHECKCAST;
 60 import static jdk.internal.org.objectweb.asm.Opcodes.GETFIELD;
 61 import static jdk.internal.org.objectweb.asm.Opcodes.GETSTATIC;
 62 import static jdk.internal.org.objectweb.asm.Opcodes.H_INVOKESTATIC;
 63 import static jdk.internal.org.objectweb.asm.Opcodes.ICONST_0;
<span class="line-added"> 64 &lt;&lt;&lt;&lt;&lt;&lt;&lt; HEAD:src/java.base/share/classes/java/lang/invoke/MemoryAccessVarHandleGenerator.java</span>
 65 import static jdk.internal.org.objectweb.asm.Opcodes.ICONST_1;
 66 import static jdk.internal.org.objectweb.asm.Opcodes.ICONST_2;
 67 import static jdk.internal.org.objectweb.asm.Opcodes.ICONST_3;
<span class="line-added"> 68 =======</span>
<span class="line-added"> 69 &gt;&gt;&gt;&gt;&gt;&gt;&gt; cd397502f19f72fa8a926f4508d3913c8ace9059:src/java.base/share/classes/java/lang/invoke/AddressVarHandleGenerator.java</span>
 70 import static jdk.internal.org.objectweb.asm.Opcodes.ILOAD;
 71 import static jdk.internal.org.objectweb.asm.Opcodes.INVOKESPECIAL;
 72 import static jdk.internal.org.objectweb.asm.Opcodes.INVOKESTATIC;
 73 import static jdk.internal.org.objectweb.asm.Opcodes.INVOKEVIRTUAL;
 74 import static jdk.internal.org.objectweb.asm.Opcodes.LALOAD;
 75 import static jdk.internal.org.objectweb.asm.Opcodes.LASTORE;
 76 import static jdk.internal.org.objectweb.asm.Opcodes.LLOAD;
 77 import static jdk.internal.org.objectweb.asm.Opcodes.NEWARRAY;
 78 import static jdk.internal.org.objectweb.asm.Opcodes.PUTFIELD;
 79 import static jdk.internal.org.objectweb.asm.Opcodes.PUTSTATIC;
 80 import static jdk.internal.org.objectweb.asm.Opcodes.RETURN;
 81 import static jdk.internal.org.objectweb.asm.Opcodes.DUP;
 82 import static jdk.internal.org.objectweb.asm.Opcodes.SIPUSH;
 83 import static jdk.internal.org.objectweb.asm.Opcodes.T_LONG;
 84 import static jdk.internal.org.objectweb.asm.Opcodes.V14;
 85 
 86 class MemoryAccessVarHandleGenerator {
 87     private static final String DEBUG_DUMP_CLASSES_DIR_PROPERTY = &quot;jdk.internal.foreign.ClassGenerator.DEBUG_DUMP_CLASSES_DIR&quot;;
 88 
 89     private static final boolean DEBUG =
</pre>
<hr />
<pre>
317             MethodHandles.Lookup.IMPL_LOOKUP
318                     .findStatic(helperClass,
319                             helperMethodName,
320                             helperType);
321 
322 
323             MethodVisitor mv = cw.visitMethod(ACC_STATIC, methName, methType.toMethodDescriptorString(), null, null);
324             mv.visitAnnotation(Type.getDescriptor(ForceInline.class), true);
325             mv.visitCode();
326 
327             mv.visitVarInsn(ALOAD, 0); // handle impl
328             mv.visitVarInsn(ALOAD, 1); // receiver
329 
330             // offset calculation
331             int slot = 2;
332             mv.visitVarInsn(ALOAD, 0); // load recv
333             mv.visitTypeInsn(CHECKCAST, Type.getInternalName(BASE_CLASS));
334             mv.visitFieldInsn(GETFIELD, Type.getInternalName(BASE_CLASS), &quot;offset&quot;, &quot;J&quot;);
335             for (int i = 0 ; i &lt; dimensions ; i++) {
336                 // load ADD MH
<span class="line-added">337 &lt;&lt;&lt;&lt;&lt;&lt;&lt; HEAD:src/java.base/share/classes/java/lang/invoke/MemoryAccessVarHandleGenerator.java</span>
338                 mv.visitFieldInsn(GETSTATIC, implClassName, &quot;addHandle&quot;, MethodHandle.class.descriptorString());
<span class="line-added">339 =======</span>
<span class="line-added">340                 mv.visitLdcInsn(cw.makeConstantPoolPatch(ADD_OFFSETS_HANDLE));</span>
<span class="line-added">341                 mv.visitTypeInsn(CHECKCAST, Type.getInternalName(MethodHandle.class));</span>
<span class="line-added">342 &gt;&gt;&gt;&gt;&gt;&gt;&gt; cd397502f19f72fa8a926f4508d3913c8ace9059:src/java.base/share/classes/java/lang/invoke/AddressVarHandleGenerator.java</span>
343 
344                 //fixup stack so that ADD MH ends up bottom
345                 mv.visitInsn(Opcodes.DUP_X2);
346                 mv.visitInsn(Opcodes.POP);
347 
348                 // load MUL MH
<span class="line-added">349 &lt;&lt;&lt;&lt;&lt;&lt;&lt; HEAD:src/java.base/share/classes/java/lang/invoke/MemoryAccessVarHandleGenerator.java</span>
350                 mv.visitFieldInsn(GETSTATIC, implClassName, &quot;mulHandle&quot;, MethodHandle.class.descriptorString());
<span class="line-added">351 =======</span>
<span class="line-added">352                 mv.visitLdcInsn(cw.makeConstantPoolPatch(MUL_OFFSETS_HANDLE));</span>
<span class="line-added">353 &gt;&gt;&gt;&gt;&gt;&gt;&gt; cd397502f19f72fa8a926f4508d3913c8ace9059:src/java.base/share/classes/java/lang/invoke/AddressVarHandleGenerator.java</span>
354                 mv.visitTypeInsn(CHECKCAST, Type.getInternalName(MethodHandle.class));
355 
356                 mv.visitVarInsn(ALOAD, 0); // load recv
357                 mv.visitTypeInsn(CHECKCAST, implClassName);
358                 mv.visitFieldInsn(GETFIELD, implClassName, &quot;dim&quot; + i, &quot;J&quot;);
359                 mv.visitVarInsn(LLOAD, slot);
360 
361                 mv.visitVarInsn(ALOAD, 1); // receiver
362                 mv.visitTypeInsn(CHECKCAST, Type.getInternalName(MemoryAddressProxy.class));
363 
364                 //MUL
365                 mv.visitMethodInsn(INVOKEVIRTUAL, Type.getInternalName(MethodHandle.class), &quot;invokeExact&quot;,
366                         OFFSET_OP_TYPE.toMethodDescriptorString(), false);
367 
368                 mv.visitVarInsn(ALOAD, 1); // receiver
369                 mv.visitTypeInsn(CHECKCAST, Type.getInternalName(MemoryAddressProxy.class));
370 
371                 //ADD
372                 mv.visitMethodInsn(INVOKEVIRTUAL, Type.getInternalName(MethodHandle.class), &quot;invokeExact&quot;,
373                         OFFSET_OP_TYPE.toMethodDescriptorString(), false);
</pre>
</td>
</tr>
</table>
<center><a href="Invokers.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="VarHandles.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>