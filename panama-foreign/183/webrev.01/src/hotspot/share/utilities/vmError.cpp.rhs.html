<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames src/hotspot/share/utilities/vmError.cpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
    <script type="text/javascript" src="../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>   1 /*
   2  * Copyright (c) 2003, 2020, Oracle and/or its affiliates. All rights reserved.
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.
   8  *
   9  * This code is distributed in the hope that it will be useful, but WITHOUT
  10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  *
  23  */
  24 
  25 #include &quot;precompiled.hpp&quot;
  26 #include &quot;jvm.h&quot;
  27 #include &quot;code/codeCache.hpp&quot;
  28 #include &quot;compiler/compileBroker.hpp&quot;
  29 #include &quot;compiler/disassembler.hpp&quot;
  30 #include &quot;gc/shared/gcConfig.hpp&quot;
  31 #include &quot;logging/logConfiguration.hpp&quot;
<a name="1" id="anc1"></a><span class="line-added">  32 #include &quot;memory/metaspace.hpp&quot;</span>
<span class="line-added">  33 #include &quot;memory/metaspaceShared.hpp&quot;</span>
  34 #include &quot;memory/resourceArea.hpp&quot;
  35 #include &quot;memory/universe.hpp&quot;
  36 #include &quot;oops/compressedOops.hpp&quot;
  37 #include &quot;prims/whitebox.hpp&quot;
  38 #include &quot;runtime/arguments.hpp&quot;
  39 #include &quot;runtime/atomic.hpp&quot;
  40 #include &quot;runtime/frame.inline.hpp&quot;
  41 #include &quot;runtime/init.hpp&quot;
  42 #include &quot;runtime/os.hpp&quot;
  43 #include &quot;runtime/safepointMechanism.hpp&quot;
  44 #include &quot;runtime/thread.inline.hpp&quot;
  45 #include &quot;runtime/threadSMR.hpp&quot;
  46 #include &quot;runtime/vmThread.hpp&quot;
  47 #include &quot;runtime/vmOperations.hpp&quot;
  48 #include &quot;runtime/vm_version.hpp&quot;
  49 #include &quot;runtime/flags/jvmFlag.hpp&quot;
  50 #include &quot;services/memTracker.hpp&quot;
  51 #include &quot;utilities/debug.hpp&quot;
  52 #include &quot;utilities/decoder.hpp&quot;
  53 #include &quot;utilities/defaultStream.hpp&quot;
  54 #include &quot;utilities/events.hpp&quot;
  55 #include &quot;utilities/vmError.hpp&quot;
  56 #include &quot;utilities/macros.hpp&quot;
  57 #if INCLUDE_JFR
  58 #include &quot;jfr/jfr.hpp&quot;
  59 #endif
  60 
  61 #ifndef PRODUCT
  62 #include &lt;signal.h&gt;
  63 #endif // PRODUCT
  64 
  65 bool VMError::_error_reported = false;
  66 
  67 // call this when the VM is dying--it might loosen some asserts
  68 bool VMError::is_error_reported() { return _error_reported; }
  69 
  70 // returns an address which is guaranteed to generate a SIGSEGV on read,
  71 // for test purposes, which is not NULL and contains bits in every word
  72 void* VMError::get_segfault_address() {
  73   return (void*)
  74 #ifdef _LP64
  75     0xABC0000000000ABCULL;
  76 #else
  77     0x00000ABC;
  78 #endif
  79 }
  80 
  81 // List of environment variables that should be reported in error log file.
  82 const char *env_list[] = {
  83   // All platforms
  84   &quot;JAVA_HOME&quot;, &quot;JAVA_TOOL_OPTIONS&quot;, &quot;_JAVA_OPTIONS&quot;, &quot;CLASSPATH&quot;,
  85   &quot;PATH&quot;, &quot;USERNAME&quot;,
  86 
  87   // Env variables that are defined on Linux/BSD
  88   &quot;LD_LIBRARY_PATH&quot;, &quot;LD_PRELOAD&quot;, &quot;SHELL&quot;, &quot;DISPLAY&quot;,
  89   &quot;HOSTTYPE&quot;, &quot;OSTYPE&quot;, &quot;ARCH&quot;, &quot;MACHTYPE&quot;,
  90   &quot;LANG&quot;, &quot;LC_ALL&quot;, &quot;LC_CTYPE&quot;, &quot;TZ&quot;,
  91 
  92   // defined on AIX
  93   &quot;LIBPATH&quot;, &quot;LDR_PRELOAD&quot;, &quot;LDR_PRELOAD64&quot;,
  94 
  95   // defined on Linux/AIX/BSD
  96   &quot;_JAVA_SR_SIGNUM&quot;,
  97 
  98   // defined on Darwin
  99   &quot;DYLD_LIBRARY_PATH&quot;, &quot;DYLD_FALLBACK_LIBRARY_PATH&quot;,
 100   &quot;DYLD_FRAMEWORK_PATH&quot;, &quot;DYLD_FALLBACK_FRAMEWORK_PATH&quot;,
 101   &quot;DYLD_INSERT_LIBRARIES&quot;,
 102 
 103   // defined on Windows
 104   &quot;OS&quot;, &quot;PROCESSOR_IDENTIFIER&quot;, &quot;_ALT_JAVA_HOME_DIR&quot;,
 105 
 106   (const char *)0
 107 };
 108 
 109 // A simple parser for -XX:OnError, usage:
 110 //  ptr = OnError;
 111 //  while ((cmd = next_OnError_command(buffer, sizeof(buffer), &amp;ptr) != NULL)
 112 //     ... ...
 113 static char* next_OnError_command(char* buf, int buflen, const char** ptr) {
 114   if (ptr == NULL || *ptr == NULL) return NULL;
 115 
 116   const char* cmd = *ptr;
 117 
 118   // skip leading blanks or &#39;;&#39;
 119   while (*cmd == &#39; &#39; || *cmd == &#39;;&#39;) cmd++;
 120 
 121   if (*cmd == &#39;\0&#39;) return NULL;
 122 
 123   const char * cmdend = cmd;
 124   while (*cmdend != &#39;\0&#39; &amp;&amp; *cmdend != &#39;;&#39;) cmdend++;
 125 
 126   Arguments::copy_expand_pid(cmd, cmdend - cmd, buf, buflen);
 127 
 128   *ptr = (*cmdend == &#39;\0&#39; ? cmdend : cmdend + 1);
 129   return buf;
 130 }
 131 
 132 static void print_bug_submit_message(outputStream *out, Thread *thread) {
 133   if (out == NULL) return;
 134   const char *url = Arguments::java_vendor_url_bug();
 135   if (url == NULL || *url == &#39;\0&#39;)
 136     url = JDK_Version::runtime_vendor_vm_bug_url();
 137   if (url != NULL &amp;&amp; *url != &#39;\0&#39;) {
 138     out-&gt;print_raw_cr(&quot;# If you would like to submit a bug report, please visit:&quot;);
 139     out-&gt;print_raw   (&quot;#   &quot;);
 140     out-&gt;print_raw_cr(url);
 141   }
 142   // If the crash is in native code, encourage user to submit a bug to the
 143   // provider of that code.
 144   if (thread &amp;&amp; thread-&gt;is_Java_thread() &amp;&amp;
 145       !thread-&gt;is_hidden_from_external_view()) {
 146     JavaThread* jt = (JavaThread*)thread;
 147     if (jt-&gt;thread_state() == _thread_in_native) {
 148       out-&gt;print_cr(&quot;# The crash happened outside the Java Virtual Machine in native code.\n# See problematic frame for where to report the bug.&quot;);
 149     }
 150   }
 151   out-&gt;print_raw_cr(&quot;#&quot;);
 152 }
 153 
 154 bool VMError::coredump_status;
 155 char VMError::coredump_message[O_BUFLEN];
 156 
 157 void VMError::record_coredump_status(const char* message, bool status) {
 158   coredump_status = status;
 159   strncpy(coredump_message, message, sizeof(coredump_message));
 160   coredump_message[sizeof(coredump_message)-1] = 0;
 161 }
 162 
 163 // Return a string to describe the error
 164 char* VMError::error_string(char* buf, int buflen) {
 165   char signame_buf[64];
 166   const char *signame = os::exception_name(_id, signame_buf, sizeof(signame_buf));
 167 
 168   if (signame) {
 169     jio_snprintf(buf, buflen,
 170                  &quot;%s (0x%x) at pc=&quot; PTR_FORMAT &quot;, pid=%d, tid=&quot; UINTX_FORMAT,
 171                  signame, _id, _pc,
 172                  os::current_process_id(), os::current_thread_id());
 173   } else if (_filename != NULL &amp;&amp; _lineno &gt; 0) {
 174     // skip directory names
 175     char separator = os::file_separator()[0];
 176     const char *p = strrchr(_filename, separator);
 177     int n = jio_snprintf(buf, buflen,
 178                          &quot;Internal Error at %s:%d, pid=%d, tid=&quot; UINTX_FORMAT,
 179                          p ? p + 1 : _filename, _lineno,
 180                          os::current_process_id(), os::current_thread_id());
 181     if (n &gt;= 0 &amp;&amp; n &lt; buflen &amp;&amp; _message) {
 182       if (strlen(_detail_msg) &gt; 0) {
 183         jio_snprintf(buf + n, buflen - n, &quot;%s%s: %s&quot;,
 184         os::line_separator(), _message, _detail_msg);
 185       } else {
 186         jio_snprintf(buf + n, buflen - n, &quot;%sError: %s&quot;,
 187                      os::line_separator(), _message);
 188       }
 189     }
 190   } else {
 191     jio_snprintf(buf, buflen,
 192                  &quot;Internal Error (0x%x), pid=%d, tid=&quot; UINTX_FORMAT,
 193                  _id, os::current_process_id(), os::current_thread_id());
 194   }
 195 
 196   return buf;
 197 }
 198 
 199 void VMError::print_stack_trace(outputStream* st, JavaThread* jt,
 200                                 char* buf, int buflen, bool verbose) {
 201 #ifdef ZERO
 202   if (jt-&gt;zero_stack()-&gt;sp() &amp;&amp; jt-&gt;top_zero_frame()) {
 203     // StackFrameStream uses the frame anchor, which may not have
 204     // been set up.  This can be done at any time in Zero, however,
 205     // so if it hasn&#39;t been set up then we just set it up now and
 206     // clear it again when we&#39;re done.
 207     bool has_last_Java_frame = jt-&gt;has_last_Java_frame();
 208     if (!has_last_Java_frame)
 209       jt-&gt;set_last_Java_frame();
 210     st-&gt;print(&quot;Java frames:&quot;);
 211     st-&gt;cr();
 212 
 213     // Print the frames
 214     StackFrameStream sfs(jt);
 215     for(int i = 0; !sfs.is_done(); sfs.next(), i++) {
 216       sfs.current()-&gt;zero_print_on_error(i, st, buf, buflen);
 217       st-&gt;cr();
 218     }
 219 
 220     // Reset the frame anchor if necessary
 221     if (!has_last_Java_frame)
 222       jt-&gt;reset_last_Java_frame();
 223   }
 224 #else
 225   if (jt-&gt;has_last_Java_frame()) {
 226     st-&gt;print_cr(&quot;Java frames: (J=compiled Java code, j=interpreted, Vv=VM code)&quot;);
 227     for(StackFrameStream sfs(jt); !sfs.is_done(); sfs.next()) {
 228       sfs.current()-&gt;print_on_error(st, buf, buflen, verbose);
 229       st-&gt;cr();
 230     }
 231   }
 232 #endif // ZERO
 233 }
 234 
 235 void VMError::print_native_stack(outputStream* st, frame fr, Thread* t, char* buf, int buf_size) {
 236 
 237   // see if it&#39;s a valid frame
 238   if (fr.pc()) {
 239     st-&gt;print_cr(&quot;Native frames: (J=compiled Java code, A=aot compiled Java code, j=interpreted, Vv=VM code, C=native code)&quot;);
 240 
 241     int count = 0;
 242     while (count++ &lt; StackPrintLimit) {
 243       fr.print_on_error(st, buf, buf_size);
 244       if (fr.pc()) { // print source file and line, if available
 245         char buf[128];
 246         int line_no;
 247         if (Decoder::get_source_info(fr.pc(), buf, sizeof(buf), &amp;line_no)) {
 248           st-&gt;print(&quot;  (%s:%d)&quot;, buf, line_no);
 249         }
 250       }
 251       st-&gt;cr();
 252       // Compiled code may use EBP register on x86 so it looks like
 253       // non-walkable C frame. Use frame.sender() for java frames.
 254       if (t &amp;&amp; t-&gt;is_Java_thread()) {
 255         // Catch very first native frame by using stack address.
 256         // For JavaThread stack_base and stack_size should be set.
 257         if (!t-&gt;is_in_full_stack((address)(fr.real_fp() + 1))) {
 258           break;
 259         }
 260         if (fr.is_java_frame() || fr.is_native_frame() || fr.is_runtime_frame()) {
 261           RegisterMap map((JavaThread*)t, false); // No update
 262           fr = fr.sender(&amp;map);
 263         } else {
 264           // is_first_C_frame() does only simple checks for frame pointer,
 265           // it will pass if java compiled code has a pointer in EBP.
 266           if (os::is_first_C_frame(&amp;fr)) break;
 267           fr = os::get_sender_for_C_frame(&amp;fr);
 268         }
 269       } else {
 270         if (os::is_first_C_frame(&amp;fr)) break;
 271         fr = os::get_sender_for_C_frame(&amp;fr);
 272       }
 273     }
 274 
 275     if (count &gt; StackPrintLimit) {
 276       st-&gt;print_cr(&quot;...&lt;more frames&gt;...&quot;);
 277     }
 278 
 279     st-&gt;cr();
 280   }
 281 }
 282 
 283 static void print_oom_reasons(outputStream* st) {
 284   st-&gt;print_cr(&quot;# Possible reasons:&quot;);
 285   st-&gt;print_cr(&quot;#   The system is out of physical RAM or swap space&quot;);
 286   if (UseCompressedOops) {
 287     st-&gt;print_cr(&quot;#   The process is running with CompressedOops enabled, and the Java Heap may be blocking the growth of the native heap&quot;);
 288   }
 289   if (LogBytesPerWord == 2) {
 290     st-&gt;print_cr(&quot;#   In 32 bit mode, the process size limit was hit&quot;);
 291   }
 292   st-&gt;print_cr(&quot;# Possible solutions:&quot;);
 293   st-&gt;print_cr(&quot;#   Reduce memory load on the system&quot;);
 294   st-&gt;print_cr(&quot;#   Increase physical memory or swap space&quot;);
 295   st-&gt;print_cr(&quot;#   Check if swap backing store is full&quot;);
 296   if (LogBytesPerWord == 2) {
 297     st-&gt;print_cr(&quot;#   Use 64 bit Java on a 64 bit OS&quot;);
 298   }
 299   st-&gt;print_cr(&quot;#   Decrease Java heap size (-Xmx/-Xms)&quot;);
 300   st-&gt;print_cr(&quot;#   Decrease number of Java threads&quot;);
 301   st-&gt;print_cr(&quot;#   Decrease Java thread stack sizes (-Xss)&quot;);
 302   st-&gt;print_cr(&quot;#   Set larger code cache with -XX:ReservedCodeCacheSize=&quot;);
 303   if (UseCompressedOops) {
 304     switch (CompressedOops::mode()) {
 305       case CompressedOops::UnscaledNarrowOop:
 306         st-&gt;print_cr(&quot;#   JVM is running with Unscaled Compressed Oops mode in which the Java heap is&quot;);
 307         st-&gt;print_cr(&quot;#     placed in the first 4GB address space. The Java Heap base address is the&quot;);
 308         st-&gt;print_cr(&quot;#     maximum limit for the native heap growth. Please use -XX:HeapBaseMinAddress&quot;);
 309         st-&gt;print_cr(&quot;#     to set the Java Heap base and to place the Java Heap above 4GB virtual address.&quot;);
 310         break;
 311       case CompressedOops::ZeroBasedNarrowOop:
 312         st-&gt;print_cr(&quot;#   JVM is running with Zero Based Compressed Oops mode in which the Java heap is&quot;);
 313         st-&gt;print_cr(&quot;#     placed in the first 32GB address space. The Java Heap base address is the&quot;);
 314         st-&gt;print_cr(&quot;#     maximum limit for the native heap growth. Please use -XX:HeapBaseMinAddress&quot;);
 315         st-&gt;print_cr(&quot;#     to set the Java Heap base and to place the Java Heap above 32GB virtual address.&quot;);
 316         break;
 317       default:
 318         break;
 319     }
 320   }
 321   st-&gt;print_cr(&quot;# This output file may be truncated or incomplete.&quot;);
 322 }
 323 
 324 static void report_vm_version(outputStream* st, char* buf, int buflen) {
 325    // VM version
 326    st-&gt;print_cr(&quot;#&quot;);
 327    JDK_Version::current().to_string(buf, buflen);
 328    const char* runtime_name = JDK_Version::runtime_name() != NULL ?
 329                                 JDK_Version::runtime_name() : &quot;&quot;;
 330    const char* runtime_version = JDK_Version::runtime_version() != NULL ?
 331                                    JDK_Version::runtime_version() : &quot;&quot;;
 332    const char* vendor_version = JDK_Version::runtime_vendor_version() != NULL ?
 333                                   JDK_Version::runtime_vendor_version() : &quot;&quot;;
 334    const char* jdk_debug_level = VM_Version::printable_jdk_debug_level() != NULL ?
 335                                    VM_Version::printable_jdk_debug_level() : &quot;&quot;;
 336 
 337    st-&gt;print_cr(&quot;# JRE version: %s%s%s (%s) (%sbuild %s)&quot;, runtime_name,
 338                 (*vendor_version != &#39;\0&#39;) ? &quot; &quot; : &quot;&quot;, vendor_version,
 339                 buf, jdk_debug_level, runtime_version);
 340 
 341    // This is the long version with some default settings added
 342    st-&gt;print_cr(&quot;# Java VM: %s%s%s (%s%s, %s%s%s%s%s, %s, %s)&quot;,
 343                  VM_Version::vm_name(),
 344                 (*vendor_version != &#39;\0&#39;) ? &quot; &quot; : &quot;&quot;, vendor_version,
 345                  jdk_debug_level,
 346                  VM_Version::vm_release(),
 347                  VM_Version::vm_info_string(),
 348                  TieredCompilation ? &quot;, tiered&quot; : &quot;&quot;,
 349 #if INCLUDE_JVMCI
 350                  EnableJVMCI ? &quot;, jvmci&quot; : &quot;&quot;,
 351                  UseJVMCICompiler ? &quot;, jvmci compiler&quot; : &quot;&quot;,
 352 #else
 353                  &quot;&quot;, &quot;&quot;,
 354 #endif
 355                  UseCompressedOops ? &quot;, compressed oops&quot; : &quot;&quot;,
 356                  GCConfig::hs_err_name(),
 357                  VM_Version::vm_platform_string()
 358                );
 359 }
 360 
 361 // This is the main function to report a fatal error. Only one thread can
 362 // call this function, so we don&#39;t need to worry about MT-safety. But it&#39;s
 363 // possible that the error handler itself may crash or die on an internal
 364 // error, for example, when the stack/heap is badly damaged. We must be
 365 // able to handle recursive errors that happen inside error handler.
 366 //
 367 // Error reporting is done in several steps. If a crash or internal error
 368 // occurred when reporting an error, the nested signal/exception handler
 369 // can skip steps that are already (or partially) done. Error reporting will
 370 // continue from the next step. This allows us to retrieve and print
 371 // information that may be unsafe to get after a fatal error. If it happens,
 372 // you may find nested report_and_die() frames when you look at the stack
 373 // in a debugger.
 374 //
 375 // In general, a hang in error handler is much worse than a crash or internal
 376 // error, as it&#39;s harder to recover from a hang. Deadlock can happen if we
 377 // try to grab a lock that is already owned by current thread, or if the
 378 // owner is blocked forever (e.g. in os::infinite_sleep()). If possible, the
 379 // error handler and all the functions it called should avoid grabbing any
 380 // lock. An important thing to notice is that memory allocation needs a lock.
 381 //
 382 // We should avoid using large stack allocated buffers. Many errors happen
 383 // when stack space is already low. Making things even worse is that there
 384 // could be nested report_and_die() calls on stack (see above). Only one
 385 // thread can report error, so large buffers are statically allocated in data
 386 // segment.
 387 
 388 int          VMError::_current_step;
 389 const char*  VMError::_current_step_info;
 390 
 391 volatile jlong VMError::_reporting_start_time = -1;
 392 volatile bool VMError::_reporting_did_timeout = false;
 393 volatile jlong VMError::_step_start_time = -1;
 394 volatile bool VMError::_step_did_timeout = false;
 395 
 396 // Helper, return current timestamp for timeout handling.
 397 jlong VMError::get_current_timestamp() {
 398   return os::javaTimeNanos();
 399 }
 400 // Factor to translate the timestamp to seconds.
 401 #define TIMESTAMP_TO_SECONDS_FACTOR (1000 * 1000 * 1000)
 402 
 403 void VMError::record_reporting_start_time() {
 404   const jlong now = get_current_timestamp();
 405   Atomic::store(&amp;_reporting_start_time, now);
 406 }
 407 
 408 jlong VMError::get_reporting_start_time() {
 409   return Atomic::load(&amp;_reporting_start_time);
 410 }
 411 
 412 void VMError::record_step_start_time() {
 413   const jlong now = get_current_timestamp();
 414   Atomic::store(&amp;_step_start_time, now);
 415 }
 416 
 417 jlong VMError::get_step_start_time() {
 418   return Atomic::load(&amp;_step_start_time);
 419 }
 420 
 421 void VMError::clear_step_start_time() {
 422   return Atomic::store(&amp;_step_start_time, (jlong)0);
 423 }
 424 
 425 void VMError::report(outputStream* st, bool _verbose) {
 426 
 427 # define BEGIN if (_current_step == 0) { _current_step = __LINE__;
 428 # define STEP(s) } if (_current_step &lt; __LINE__) { _current_step = __LINE__; _current_step_info = s; \
 429   record_step_start_time(); _step_did_timeout = false;
 430 # define END clear_step_start_time(); }
 431 
 432   // don&#39;t allocate large buffer on stack
 433   static char buf[O_BUFLEN];
 434 
 435   BEGIN
 436 
 437   STEP(&quot;printing fatal error message&quot;)
 438 
 439     st-&gt;print_cr(&quot;#&quot;);
 440     if (should_report_bug(_id)) {
 441       st-&gt;print_cr(&quot;# A fatal error has been detected by the Java Runtime Environment:&quot;);
 442     } else {
 443       st-&gt;print_cr(&quot;# There is insufficient memory for the Java &quot;
 444                    &quot;Runtime Environment to continue.&quot;);
 445     }
 446 
 447 #ifndef PRODUCT
 448   // Error handler self tests
 449 
 450   // test secondary error handling. Test it twice, to test that resetting
 451   // error handler after a secondary crash works.
 452   STEP(&quot;test secondary crash 1&quot;)
 453     if (_verbose &amp;&amp; TestCrashInErrorHandler != 0) {
 454       st-&gt;print_cr(&quot;Will crash now (TestCrashInErrorHandler=&quot; UINTX_FORMAT &quot;)...&quot;,
 455         TestCrashInErrorHandler);
 456       controlled_crash(TestCrashInErrorHandler);
 457     }
 458 
 459   STEP(&quot;test secondary crash 2&quot;)
 460     if (_verbose &amp;&amp; TestCrashInErrorHandler != 0) {
 461       st-&gt;print_cr(&quot;Will crash now (TestCrashInErrorHandler=&quot; UINTX_FORMAT &quot;)...&quot;,
 462         TestCrashInErrorHandler);
 463       controlled_crash(TestCrashInErrorHandler);
 464     }
 465 
 466   // TestUnresponsiveErrorHandler: We want to test both step timeouts and global timeout.
 467   // Step to global timeout ratio is 4:1, so in order to be absolutely sure we hit the
 468   // global timeout, let&#39;s execute the timeout step five times.
 469   // See corresponding test in test/runtime/ErrorHandling/TimeoutInErrorHandlingTest.java
 470   STEP(&quot;setup for test unresponsive error reporting step&quot;)
 471     if (_verbose &amp;&amp; TestUnresponsiveErrorHandler) {
 472       // We record reporting_start_time for this test here because we
 473       // care about the time spent executing TIMEOUT_TEST_STEP and not
 474       // about the time it took us to get here.
 475       tty-&gt;print_cr(&quot;Recording reporting_start_time for TestUnresponsiveErrorHandler.&quot;);
 476       record_reporting_start_time();
 477     }
 478 
 479   #define TIMEOUT_TEST_STEP STEP(&quot;test unresponsive error reporting step&quot;) \
 480     if (_verbose &amp;&amp; TestUnresponsiveErrorHandler) { os::infinite_sleep(); }
 481   TIMEOUT_TEST_STEP
 482   TIMEOUT_TEST_STEP
 483   TIMEOUT_TEST_STEP
 484   TIMEOUT_TEST_STEP
 485   TIMEOUT_TEST_STEP
 486 
 487   STEP(&quot;test safefetch in error handler&quot;)
 488     // test whether it is safe to use SafeFetch32 in Crash Handler. Test twice
 489     // to test that resetting the signal handler works correctly.
 490     if (_verbose &amp;&amp; TestSafeFetchInErrorHandler) {
 491       st-&gt;print_cr(&quot;Will test SafeFetch...&quot;);
 492       if (CanUseSafeFetch32()) {
 493         int* const invalid_pointer = (int*) get_segfault_address();
 494         const int x = 0x76543210;
 495         int i1 = SafeFetch32(invalid_pointer, x);
 496         int i2 = SafeFetch32(invalid_pointer, x);
 497         if (i1 == x &amp;&amp; i2 == x) {
 498           st-&gt;print_cr(&quot;SafeFetch OK.&quot;); // Correctly deflected and returned default pattern
 499         } else {
 500           st-&gt;print_cr(&quot;??&quot;);
 501         }
 502       } else {
 503         st-&gt;print_cr(&quot;not possible; skipped.&quot;);
 504       }
 505     }
 506 #endif // PRODUCT
 507 
 508   STEP(&quot;printing type of error&quot;)
 509 
 510      switch(static_cast&lt;unsigned int&gt;(_id)) {
 511        case OOM_MALLOC_ERROR:
 512        case OOM_MMAP_ERROR:
 513          if (_size) {
 514            st-&gt;print(&quot;# Native memory allocation &quot;);
 515            st-&gt;print((_id == (int)OOM_MALLOC_ERROR) ? &quot;(malloc) failed to allocate &quot; :
 516                                                  &quot;(mmap) failed to map &quot;);
 517            jio_snprintf(buf, sizeof(buf), SIZE_FORMAT, _size);
 518            st-&gt;print(&quot;%s&quot;, buf);
 519            st-&gt;print(&quot; bytes&quot;);
 520            if (strlen(_detail_msg) &gt; 0) {
 521              st-&gt;print(&quot; for &quot;);
 522              st-&gt;print(&quot;%s&quot;, _detail_msg);
 523            }
 524            st-&gt;cr();
 525          } else {
 526            if (strlen(_detail_msg) &gt; 0) {
 527              st-&gt;print(&quot;# &quot;);
 528              st-&gt;print_cr(&quot;%s&quot;, _detail_msg);
 529            }
 530          }
 531          // In error file give some solutions
 532          if (_verbose) {
 533            print_oom_reasons(st);
 534          } else {
 535            return;  // that&#39;s enough for the screen
 536          }
 537          break;
 538        case INTERNAL_ERROR:
 539        default:
 540          break;
 541      }
 542 
 543   STEP(&quot;printing exception/signal name&quot;)
 544 
 545      st-&gt;print_cr(&quot;#&quot;);
 546      st-&gt;print(&quot;#  &quot;);
 547      // Is it an OS exception/signal?
 548      if (os::exception_name(_id, buf, sizeof(buf))) {
 549        st-&gt;print(&quot;%s&quot;, buf);
 550        st-&gt;print(&quot; (0x%x)&quot;, _id);                // signal number
 551        st-&gt;print(&quot; at pc=&quot; PTR_FORMAT, p2i(_pc));
 552        if (_siginfo != NULL &amp;&amp; os::signal_sent_by_kill(_siginfo)) {
 553          st-&gt;print(&quot; (sent by kill)&quot;);
 554        }
 555      } else {
 556        if (should_report_bug(_id)) {
 557          st-&gt;print(&quot;Internal Error&quot;);
 558        } else {
 559          st-&gt;print(&quot;Out of Memory Error&quot;);
 560        }
 561        if (_filename != NULL &amp;&amp; _lineno &gt; 0) {
 562 #ifdef PRODUCT
 563          // In product mode chop off pathname?
 564          char separator = os::file_separator()[0];
 565          const char *p = strrchr(_filename, separator);
 566          const char *file = p ? p+1 : _filename;
 567 #else
 568          const char *file = _filename;
 569 #endif
 570          st-&gt;print(&quot; (%s:%d)&quot;, file, _lineno);
 571        } else {
 572          st-&gt;print(&quot; (0x%x)&quot;, _id);
 573        }
 574      }
 575 
 576   STEP(&quot;printing current thread and pid&quot;)
 577 
 578      // process id, thread id
 579      st-&gt;print(&quot;, pid=%d&quot;, os::current_process_id());
 580      st-&gt;print(&quot;, tid=&quot; UINTX_FORMAT, os::current_thread_id());
 581      st-&gt;cr();
 582 
 583   STEP(&quot;printing error message&quot;)
 584 
 585      if (should_report_bug(_id)) {  // already printed the message.
 586        // error message
 587        if (strlen(_detail_msg) &gt; 0) {
 588          st-&gt;print_cr(&quot;#  %s: %s&quot;, _message ? _message : &quot;Error&quot;, _detail_msg);
 589        } else if (_message) {
 590          st-&gt;print_cr(&quot;#  Error: %s&quot;, _message);
 591        }
 592      }
 593 
 594   STEP(&quot;printing Java version string&quot;)
 595 
 596      report_vm_version(st, buf, sizeof(buf));
 597 
 598   STEP(&quot;printing problematic frame&quot;)
 599 
 600      // Print current frame if we have a context (i.e. it&#39;s a crash)
 601      if (_context) {
 602        st-&gt;print_cr(&quot;# Problematic frame:&quot;);
 603        st-&gt;print(&quot;# &quot;);
 604        frame fr = os::fetch_frame_from_context(_context);
 605        fr.print_on_error(st, buf, sizeof(buf));
 606        st-&gt;cr();
 607        st-&gt;print_cr(&quot;#&quot;);
 608      }
 609 
 610   STEP(&quot;printing core file information&quot;)
 611     st-&gt;print(&quot;# &quot;);
 612     if (CreateCoredumpOnCrash) {
 613       if (coredump_status) {
 614         st-&gt;print(&quot;Core dump will be written. Default location: %s&quot;, coredump_message);
 615       } else {
 616         st-&gt;print(&quot;No core dump will be written. %s&quot;, coredump_message);
 617       }
 618     } else {
 619       st-&gt;print(&quot;CreateCoredumpOnCrash turned off, no core file dumped&quot;);
 620     }
 621     st-&gt;cr();
 622     st-&gt;print_cr(&quot;#&quot;);
 623 
 624   JFR_ONLY(STEP(&quot;printing jfr information&quot;))
 625   JFR_ONLY(Jfr::on_vm_error_report(st);)
 626 
 627   STEP(&quot;printing bug submit message&quot;)
 628 
 629      if (should_report_bug(_id) &amp;&amp; _verbose) {
 630        print_bug_submit_message(st, _thread);
 631      }
 632 
 633   STEP(&quot;printing summary&quot;)
 634 
 635      if (_verbose) {
 636        st-&gt;cr();
 637        st-&gt;print_cr(&quot;---------------  S U M M A R Y ------------&quot;);
 638        st-&gt;cr();
 639      }
 640 
 641   STEP(&quot;printing VM option summary&quot;)
 642 
 643      if (_verbose) {
 644        // VM options
 645        Arguments::print_summary_on(st);
 646        st-&gt;cr();
 647      }
 648 
 649   STEP(&quot;printing summary machine and OS info&quot;)
 650 
 651      if (_verbose) {
 652        os::print_summary_info(st, buf, sizeof(buf));
 653      }
 654 
 655 
 656   STEP(&quot;printing date and time&quot;)
 657 
 658      if (_verbose) {
 659        os::print_date_and_time(st, buf, sizeof(buf));
 660      }
 661 
 662   STEP(&quot;printing thread&quot;)
 663 
 664      if (_verbose) {
 665        st-&gt;cr();
 666        st-&gt;print_cr(&quot;---------------  T H R E A D  ---------------&quot;);
 667        st-&gt;cr();
 668      }
 669 
 670   STEP(&quot;printing current thread&quot;)
 671 
 672      // current thread
 673      if (_verbose) {
 674        if (_thread) {
 675          st-&gt;print(&quot;Current thread (&quot; PTR_FORMAT &quot;):  &quot;, p2i(_thread));
 676          _thread-&gt;print_on_error(st, buf, sizeof(buf));
 677          st-&gt;cr();
 678        } else {
 679          st-&gt;print_cr(&quot;Current thread is native thread&quot;);
 680        }
 681        st-&gt;cr();
 682      }
 683 
 684   STEP(&quot;printing current compile task&quot;)
 685 
 686      if (_verbose &amp;&amp; _thread &amp;&amp; _thread-&gt;is_Compiler_thread()) {
 687         CompilerThread* t = (CompilerThread*)_thread;
 688         if (t-&gt;task()) {
 689            st-&gt;cr();
 690            st-&gt;print_cr(&quot;Current CompileTask:&quot;);
 691            t-&gt;task()-&gt;print_line_on_error(st, buf, sizeof(buf));
 692            st-&gt;cr();
 693         }
 694      }
 695 
 696 
 697   STEP(&quot;printing stack bounds&quot;)
 698 
 699      if (_verbose) {
 700        st-&gt;print(&quot;Stack: &quot;);
 701 
 702        address stack_top;
 703        size_t stack_size;
 704 
 705        if (_thread) {
 706           stack_top = _thread-&gt;stack_base();
 707           stack_size = _thread-&gt;stack_size();
 708        } else {
 709           stack_top = os::current_stack_base();
 710           stack_size = os::current_stack_size();
 711        }
 712 
 713        address stack_bottom = stack_top - stack_size;
 714        st-&gt;print(&quot;[&quot; PTR_FORMAT &quot;,&quot; PTR_FORMAT &quot;]&quot;, p2i(stack_bottom), p2i(stack_top));
 715 
 716        frame fr = _context ? os::fetch_frame_from_context(_context)
 717                            : os::current_frame();
 718 
 719        if (fr.sp()) {
 720          st-&gt;print(&quot;,  sp=&quot; PTR_FORMAT, p2i(fr.sp()));
 721          size_t free_stack_size = pointer_delta(fr.sp(), stack_bottom, 1024);
 722          st-&gt;print(&quot;,  free space=&quot; SIZE_FORMAT &quot;k&quot;, free_stack_size);
 723        }
 724 
 725        st-&gt;cr();
 726      }
 727 
 728   STEP(&quot;printing native stack&quot;)
 729 
 730    if (_verbose) {
 731      if (os::platform_print_native_stack(st, _context, buf, sizeof(buf))) {
 732        // We have printed the native stack in platform-specific code
 733        // Windows/x64 needs special handling.
 734      } else {
 735        frame fr = _context ? os::fetch_frame_from_context(_context)
 736                            : os::current_frame();
 737 
 738        print_native_stack(st, fr, _thread, buf, sizeof(buf));
 739      }
 740    }
 741 
 742   STEP(&quot;printing Java stack&quot;)
 743 
 744      if (_verbose &amp;&amp; _thread &amp;&amp; _thread-&gt;is_Java_thread()) {
 745        print_stack_trace(st, (JavaThread*)_thread, buf, sizeof(buf));
 746      }
 747 
 748   STEP(&quot;printing target Java thread stack&quot;)
 749 
 750      // printing Java thread stack trace if it is involved in GC crash
 751      if (_verbose &amp;&amp; _thread &amp;&amp; (_thread-&gt;is_Named_thread())) {
 752        JavaThread*  jt = ((NamedThread *)_thread)-&gt;processed_thread();
 753        if (jt != NULL) {
 754          st-&gt;print_cr(&quot;JavaThread &quot; PTR_FORMAT &quot; (nid = %d) was being processed&quot;, p2i(jt), jt-&gt;osthread()-&gt;thread_id());
 755          print_stack_trace(st, jt, buf, sizeof(buf), true);
 756        }
 757      }
 758 
 759   STEP(&quot;printing siginfo&quot;)
 760 
 761      // signal no, signal code, address that caused the fault
 762      if (_verbose &amp;&amp; _siginfo) {
 763        st-&gt;cr();
 764        os::print_siginfo(st, _siginfo);
 765        st-&gt;cr();
 766      }
 767 
 768   STEP(&quot;CDS archive access warning&quot;)
 769 
 770      // Print an explicit hint if we crashed on access to the CDS archive.
 771      if (_verbose &amp;&amp; _siginfo) {
 772        check_failing_cds_access(st, _siginfo);
 773        st-&gt;cr();
 774      }
 775 
 776   STEP(&quot;printing register info&quot;)
 777 
 778      // decode register contents if possible
 779      if (_verbose &amp;&amp; _context &amp;&amp; Universe::is_fully_initialized()) {
 780        os::print_register_info(st, _context);
 781        st-&gt;cr();
 782      }
 783 
 784   STEP(&quot;printing registers, top of stack, instructions near pc&quot;)
 785 
 786      // registers, top of stack, instructions near pc
 787      if (_verbose &amp;&amp; _context) {
 788        os::print_context(st, _context);
 789        st-&gt;cr();
 790      }
 791 
 792   STEP(&quot;inspecting top of stack&quot;)
 793 
 794      // decode stack contents if possible
 795      if (_verbose &amp;&amp; _context &amp;&amp; Universe::is_fully_initialized()) {
 796        frame fr = os::fetch_frame_from_context(_context);
 797        const int slots = 8;
 798        const intptr_t *start = fr.sp();
 799        const intptr_t *end = start + slots;
 800        if (is_aligned(start, sizeof(intptr_t)) &amp;&amp; os::is_readable_range(start, end)) {
 801          st-&gt;print_cr(&quot;Stack slot to memory mapping:&quot;);
 802          for (int i = 0; i &lt; slots; ++i) {
 803            st-&gt;print(&quot;stack at sp + %d slots: &quot;, i);
 804            os::print_location(st, *(start + i));
 805          }
 806        }
 807        st-&gt;cr();
 808      }
 809 
 810   STEP(&quot;printing code blob if possible&quot;)
 811 
 812      if (_verbose &amp;&amp; _context) {
 813        CodeBlob* cb = CodeCache::find_blob(_pc);
 814        if (cb != NULL) {
 815          if (Interpreter::contains(_pc)) {
 816            // The interpreter CodeBlob is very large so try to print the codelet instead.
 817            InterpreterCodelet* codelet = Interpreter::codelet_containing(_pc);
 818            if (codelet != NULL) {
 819              codelet-&gt;print_on(st);
 820              Disassembler::decode(codelet-&gt;code_begin(), codelet-&gt;code_end(), st);
 821            }
 822          } else {
 823            StubCodeDesc* desc = StubCodeDesc::desc_for(_pc);
 824            if (desc != NULL) {
 825              desc-&gt;print_on(st);
 826              Disassembler::decode(desc-&gt;begin(), desc-&gt;end(), st);
 827            } else if (_thread != NULL) {
 828              // Disassembling nmethod will incur resource memory allocation,
 829              // only do so when thread is valid.
 830              ResourceMark rm(_thread);
 831              Disassembler::decode(cb, st);
 832              st-&gt;cr();
 833            }
 834          }
 835        }
 836      }
 837 
 838   STEP(&quot;printing VM operation&quot;)
 839 
 840      if (_verbose &amp;&amp; _thread &amp;&amp; _thread-&gt;is_VM_thread()) {
 841         VMThread* t = (VMThread*)_thread;
 842         VM_Operation* op = t-&gt;vm_operation();
 843         if (op) {
 844           op-&gt;print_on_error(st);
 845           st-&gt;cr();
 846           st-&gt;cr();
 847         }
 848      }
 849 
 850   STEP(&quot;printing process&quot;)
 851 
 852      if (_verbose) {
 853        st-&gt;cr();
 854        st-&gt;print_cr(&quot;---------------  P R O C E S S  ---------------&quot;);
 855        st-&gt;cr();
 856      }
 857 
 858 #ifndef _WIN32
 859   STEP(&quot;printing user info&quot;)
 860 
 861      if (ExtensiveErrorReports &amp;&amp; _verbose) {
 862        os::Posix::print_user_info(st);
 863      }
 864 #endif
 865 
 866   STEP(&quot;printing all threads&quot;)
 867 
 868      // all threads
 869      if (_verbose &amp;&amp; _thread) {
 870        Threads::print_on_error(st, _thread, buf, sizeof(buf));
 871        st-&gt;cr();
 872      }
 873 
 874   STEP(&quot;printing VM state&quot;)
 875 
 876      if (_verbose) {
 877        // Safepoint state
 878        st-&gt;print(&quot;VM state:&quot;);
 879 
 880        if (SafepointSynchronize::is_synchronizing()) st-&gt;print(&quot;synchronizing&quot;);
 881        else if (SafepointSynchronize::is_at_safepoint()) st-&gt;print(&quot;at safepoint&quot;);
 882        else st-&gt;print(&quot;not at safepoint&quot;);
 883 
 884        // Also see if error occurred during initialization or shutdown
 885        if (!Universe::is_fully_initialized()) {
 886          st-&gt;print(&quot; (not fully initialized)&quot;);
 887        } else if (VM_Exit::vm_exited()) {
 888          st-&gt;print(&quot; (shutting down)&quot;);
 889        } else {
 890          st-&gt;print(&quot; (normal execution)&quot;);
 891        }
 892        st-&gt;cr();
 893        st-&gt;cr();
 894      }
 895 
 896   STEP(&quot;printing owned locks on error&quot;)
 897 
 898      // mutexes/monitors that currently have an owner
 899      if (_verbose) {
 900        print_owned_locks_on_error(st);
 901        st-&gt;cr();
 902      }
 903 
 904   STEP(&quot;printing number of OutOfMemoryError and StackOverflow exceptions&quot;)
 905 
 906      if (_verbose &amp;&amp; Exceptions::has_exception_counts()) {
 907        st-&gt;print_cr(&quot;OutOfMemory and StackOverflow Exception counts:&quot;);
 908        Exceptions::print_exception_counts_on_error(st);
 909        st-&gt;cr();
 910      }
 911 
<a name="2" id="anc2"></a><span class="line-added"> 912 #ifdef _LP64</span>
 913   STEP(&quot;printing compressed oops mode&quot;)
 914 
 915      if (_verbose &amp;&amp; UseCompressedOops) {
 916        CompressedOops::print_mode(st);
 917        if (UseCompressedClassPointers) {
<a name="3" id="anc3"></a><span class="line-added"> 918          CDS_ONLY(MetaspaceShared::print_on(st);)</span>
 919          Metaspace::print_compressed_class_space(st);
<a name="4" id="anc4"></a><span class="line-added"> 920          CompressedKlassPointers::print_mode(st);</span>
 921        }
 922        st-&gt;cr();
 923      }
<a name="5" id="anc5"></a><span class="line-added"> 924 #endif</span>
 925 
 926   STEP(&quot;printing heap information&quot;)
 927 
 928      if (_verbose &amp;&amp; Universe::is_fully_initialized()) {
 929        Universe::heap()-&gt;print_on_error(st);
 930        st-&gt;cr();
 931        st-&gt;print_cr(&quot;Polling page: &quot; INTPTR_FORMAT, p2i(SafepointMechanism::get_polling_page()));
 932        st-&gt;cr();
 933      }
 934 
 935   STEP(&quot;printing metaspace information&quot;)
 936 
 937      if (_verbose &amp;&amp; Universe::is_fully_initialized()) {
 938        st-&gt;print_cr(&quot;Metaspace:&quot;);
 939        MetaspaceUtils::print_basic_report(st, 0);
 940      }
 941 
 942   STEP(&quot;printing code cache information&quot;)
 943 
 944      if (_verbose &amp;&amp; Universe::is_fully_initialized()) {
 945        // print code cache information before vm abort
 946        CodeCache::print_summary(st);
 947        st-&gt;cr();
 948      }
 949 
 950   STEP(&quot;printing ring buffers&quot;)
 951 
 952      if (_verbose) {
 953        Events::print_all(st);
 954        st-&gt;cr();
 955      }
 956 
 957   STEP(&quot;printing dynamic libraries&quot;)
 958 
 959      if (_verbose) {
 960        // dynamic libraries, or memory map
 961        os::print_dll_info(st);
 962        st-&gt;cr();
 963      }
 964 
 965   STEP(&quot;printing native decoder state&quot;)
 966 
 967      if (_verbose) {
 968        Decoder::print_state_on(st);
 969        st-&gt;cr();
 970      }
 971 
 972   STEP(&quot;printing VM options&quot;)
 973 
 974      if (_verbose) {
 975        // VM options
 976        Arguments::print_on(st);
 977        st-&gt;cr();
 978      }
 979 
 980   STEP(&quot;printing flags&quot;)
 981 
 982     if (_verbose) {
 983       JVMFlag::printFlags(
 984         st,
 985         true, // with comments
 986         false, // no ranges
 987         true); // skip defaults
 988       st-&gt;cr();
 989     }
 990 
 991   STEP(&quot;printing warning if internal testing API used&quot;)
 992 
 993      if (WhiteBox::used()) {
 994        st-&gt;print_cr(&quot;Unsupported internal testing APIs have been used.&quot;);
 995        st-&gt;cr();
 996      }
 997 
 998   STEP(&quot;printing log configuration&quot;)
 999     if (_verbose){
1000       st-&gt;print_cr(&quot;Logging:&quot;);
1001       LogConfiguration::describe_current_configuration(st);
1002       st-&gt;cr();
1003     }
1004 
1005   STEP(&quot;printing all environment variables&quot;)
1006 
1007      if (_verbose) {
1008        os::print_environment_variables(st, env_list);
1009        st-&gt;cr();
1010      }
1011 
1012   STEP(&quot;printing signal handlers&quot;)
1013 
1014      if (_verbose) {
1015        os::print_signal_handlers(st, buf, sizeof(buf));
1016        st-&gt;cr();
1017      }
1018 
1019   STEP(&quot;Native Memory Tracking&quot;)
1020      if (_verbose) {
1021        MemTracker::error_report(st);
1022      }
1023 
1024   STEP(&quot;printing system&quot;)
1025 
1026      if (_verbose) {
1027        st-&gt;cr();
1028        st-&gt;print_cr(&quot;---------------  S Y S T E M  ---------------&quot;);
1029        st-&gt;cr();
1030      }
1031 
1032   STEP(&quot;printing OS information&quot;)
1033 
1034      if (_verbose) {
1035        os::print_os_info(st);
1036        st-&gt;cr();
1037      }
1038 
1039   STEP(&quot;printing CPU info&quot;)
1040      if (_verbose) {
1041        os::print_cpu_info(st, buf, sizeof(buf));
1042        st-&gt;cr();
1043      }
1044 
1045   STEP(&quot;printing memory info&quot;)
1046 
1047      if (_verbose) {
1048        os::print_memory_info(st);
1049        st-&gt;cr();
1050      }
1051 
1052   STEP(&quot;printing internal vm info&quot;)
1053 
1054      if (_verbose) {
1055        st-&gt;print_cr(&quot;vm_info: %s&quot;, VM_Version::internal_vm_info_string());
1056        st-&gt;cr();
1057      }
1058 
1059   // print a defined marker to show that error handling finished correctly.
1060   STEP(&quot;printing end marker&quot;)
1061 
1062      if (_verbose) {
1063        st-&gt;print_cr(&quot;END.&quot;);
1064      }
1065 
1066   END
1067 
1068 # undef BEGIN
1069 # undef STEP
1070 # undef END
1071 }
1072 
1073 // Report for the vm_info_cmd. This prints out the information above omitting
1074 // crash and thread specific information.  If output is added above, it should be added
1075 // here also, if it is safe to call during a running process.
1076 void VMError::print_vm_info(outputStream* st) {
1077 
1078   char buf[O_BUFLEN];
1079   report_vm_version(st, buf, sizeof(buf));
1080 
1081   // STEP(&quot;printing summary&quot;)
1082 
1083   st-&gt;cr();
1084   st-&gt;print_cr(&quot;---------------  S U M M A R Y ------------&quot;);
1085   st-&gt;cr();
1086 
1087   // STEP(&quot;printing VM option summary&quot;)
1088 
1089   // VM options
1090   Arguments::print_summary_on(st);
1091   st-&gt;cr();
1092 
1093   // STEP(&quot;printing summary machine and OS info&quot;)
1094 
1095   os::print_summary_info(st, buf, sizeof(buf));
1096 
1097   // STEP(&quot;printing date and time&quot;)
1098 
1099   os::print_date_and_time(st, buf, sizeof(buf));
1100 
1101   // Skip: STEP(&quot;printing thread&quot;)
1102 
1103   // STEP(&quot;printing process&quot;)
1104 
1105   st-&gt;cr();
1106   st-&gt;print_cr(&quot;---------------  P R O C E S S  ---------------&quot;);
1107   st-&gt;cr();
1108 
1109   // STEP(&quot;printing number of OutOfMemoryError and StackOverflow exceptions&quot;)
1110 
1111   if (Exceptions::has_exception_counts()) {
1112     st-&gt;print_cr(&quot;OutOfMemory and StackOverflow Exception counts:&quot;);
1113     Exceptions::print_exception_counts_on_error(st);
1114     st-&gt;cr();
1115   }
1116 
<a name="6" id="anc6"></a><span class="line-added">1117 #ifdef _LP64</span>
1118   // STEP(&quot;printing compressed oops mode&quot;)
<a name="7" id="anc7"></a>
1119   if (UseCompressedOops) {
1120     CompressedOops::print_mode(st);
1121     if (UseCompressedClassPointers) {
<a name="8" id="anc8"></a><span class="line-added">1122       CDS_ONLY(MetaspaceShared::print_on(st);)</span>
1123       Metaspace::print_compressed_class_space(st);
<a name="9" id="anc9"></a><span class="line-added">1124       CompressedKlassPointers::print_mode(st);</span>
1125     }
1126     st-&gt;cr();
1127   }
<a name="10" id="anc10"></a><span class="line-added">1128 #endif</span>
1129 
1130   // STEP(&quot;printing heap information&quot;)
1131 
1132   if (Universe::is_fully_initialized()) {
1133     MutexLocker hl(Heap_lock);
1134     Universe::heap()-&gt;print_on_error(st);
1135     st-&gt;cr();
1136     st-&gt;print_cr(&quot;Polling page: &quot; INTPTR_FORMAT, p2i(SafepointMechanism::get_polling_page()));
1137     st-&gt;cr();
1138   }
1139 
1140   // STEP(&quot;printing metaspace information&quot;)
1141 
1142   if (Universe::is_fully_initialized()) {
1143     st-&gt;print_cr(&quot;Metaspace:&quot;);
1144     MetaspaceUtils::print_basic_report(st, 0);
1145   }
1146 
1147   // STEP(&quot;printing code cache information&quot;)
1148 
1149   if (Universe::is_fully_initialized()) {
1150     // print code cache information before vm abort
1151     CodeCache::print_summary(st);
1152     st-&gt;cr();
1153   }
1154 
1155   // STEP(&quot;printing ring buffers&quot;)
1156 
1157   Events::print_all(st);
1158   st-&gt;cr();
1159 
1160   // STEP(&quot;printing dynamic libraries&quot;)
1161 
1162   // dynamic libraries, or memory map
1163   os::print_dll_info(st);
1164   st-&gt;cr();
1165 
1166   // STEP(&quot;printing VM options&quot;)
1167 
1168   // VM options
1169   Arguments::print_on(st);
1170   st-&gt;cr();
1171 
1172   // STEP(&quot;printing warning if internal testing API used&quot;)
1173 
1174   if (WhiteBox::used()) {
1175     st-&gt;print_cr(&quot;Unsupported internal testing APIs have been used.&quot;);
1176     st-&gt;cr();
1177   }
1178 
1179   // STEP(&quot;printing log configuration&quot;)
1180   st-&gt;print_cr(&quot;Logging:&quot;);
1181   LogConfiguration::describe(st);
1182   st-&gt;cr();
1183 
1184   // STEP(&quot;printing all environment variables&quot;)
1185 
1186   os::print_environment_variables(st, env_list);
1187   st-&gt;cr();
1188 
1189   // STEP(&quot;printing signal handlers&quot;)
1190 
1191   os::print_signal_handlers(st, buf, sizeof(buf));
1192   st-&gt;cr();
1193 
1194   // STEP(&quot;Native Memory Tracking&quot;)
1195 
1196   MemTracker::error_report(st);
1197 
1198   // STEP(&quot;printing system&quot;)
1199 
1200   st-&gt;cr();
1201   st-&gt;print_cr(&quot;---------------  S Y S T E M  ---------------&quot;);
1202   st-&gt;cr();
1203 
1204   // STEP(&quot;printing OS information&quot;)
1205 
1206   os::print_os_info(st);
1207   st-&gt;cr();
1208 
1209   // STEP(&quot;printing CPU info&quot;)
1210 
1211   os::print_cpu_info(st, buf, sizeof(buf));
1212   st-&gt;cr();
1213 
1214   // STEP(&quot;printing memory info&quot;)
1215 
1216   os::print_memory_info(st);
1217   st-&gt;cr();
1218 
1219   // STEP(&quot;printing internal vm info&quot;)
1220 
1221   st-&gt;print_cr(&quot;vm_info: %s&quot;, VM_Version::internal_vm_info_string());
1222   st-&gt;cr();
1223 
1224   // print a defined marker to show that error handling finished correctly.
1225   // STEP(&quot;printing end marker&quot;)
1226 
1227   st-&gt;print_cr(&quot;END.&quot;);
1228 }
1229 
1230 volatile intptr_t VMError::_first_error_tid = -1;
1231 
1232 /** Expand a pattern into a buffer starting at pos and open a file using constructed path */
1233 static int expand_and_open(const char* pattern, bool overwrite_existing, char* buf, size_t buflen, size_t pos) {
1234   int fd = -1;
1235   int mode = O_RDWR | O_CREAT;
1236   if (overwrite_existing) {
1237     mode |= O_TRUNC;
1238   } else {
1239     mode |= O_EXCL;
1240   }
1241   if (Arguments::copy_expand_pid(pattern, strlen(pattern), &amp;buf[pos], buflen - pos)) {
1242     fd = open(buf, mode, 0666);
1243   }
1244   return fd;
1245 }
1246 
1247 /**
1248  * Construct file name for a log file and return it&#39;s file descriptor.
1249  * Name and location depends on pattern, default_pattern params and access
1250  * permissions.
1251  */
1252 static int prepare_log_file(const char* pattern, const char* default_pattern, bool overwrite_existing, char* buf, size_t buflen) {
1253   int fd = -1;
1254 
1255   // If possible, use specified pattern to construct log file name
1256   if (pattern != NULL) {
1257     fd = expand_and_open(pattern, overwrite_existing, buf, buflen, 0);
1258   }
1259 
1260   // Either user didn&#39;t specify, or the user&#39;s location failed,
1261   // so use the default name in the current directory
1262   if (fd == -1) {
1263     const char* cwd = os::get_current_directory(buf, buflen);
1264     if (cwd != NULL) {
1265       size_t pos = strlen(cwd);
1266       int fsep_len = jio_snprintf(&amp;buf[pos], buflen-pos, &quot;%s&quot;, os::file_separator());
1267       pos += fsep_len;
1268       if (fsep_len &gt; 0) {
1269         fd = expand_and_open(default_pattern, overwrite_existing, buf, buflen, pos);
1270       }
1271     }
1272   }
1273 
1274    // try temp directory if it exists.
1275    if (fd == -1) {
1276      const char* tmpdir = os::get_temp_directory();
1277      if (tmpdir != NULL &amp;&amp; strlen(tmpdir) &gt; 0) {
1278        int pos = jio_snprintf(buf, buflen, &quot;%s%s&quot;, tmpdir, os::file_separator());
1279        if (pos &gt; 0) {
1280          fd = expand_and_open(default_pattern, overwrite_existing, buf, buflen, pos);
1281        }
1282      }
1283    }
1284 
1285   return fd;
1286 }
1287 
1288 int         VMError::_id;
1289 const char* VMError::_message;
1290 char        VMError::_detail_msg[1024];
1291 Thread*     VMError::_thread;
1292 address     VMError::_pc;
1293 void*       VMError::_siginfo;
1294 void*       VMError::_context;
1295 const char* VMError::_filename;
1296 int         VMError::_lineno;
1297 size_t      VMError::_size;
1298 
1299 void VMError::report_and_die(Thread* thread, unsigned int sig, address pc, void* siginfo,
1300                              void* context, const char* detail_fmt, ...)
1301 {
1302   va_list detail_args;
1303   va_start(detail_args, detail_fmt);
1304   report_and_die(sig, NULL, detail_fmt, detail_args, thread, pc, siginfo, context, NULL, 0, 0);
1305   va_end(detail_args);
1306 }
1307 
1308 void VMError::report_and_die(Thread* thread, unsigned int sig, address pc, void* siginfo, void* context)
1309 {
1310   report_and_die(thread, sig, pc, siginfo, context, &quot;%s&quot;, &quot;&quot;);
1311 }
1312 
1313 void VMError::report_and_die(const char* message, const char* detail_fmt, ...)
1314 {
1315   va_list detail_args;
1316   va_start(detail_args, detail_fmt);
1317   report_and_die(INTERNAL_ERROR, message, detail_fmt, detail_args, NULL, NULL, NULL, NULL, NULL, 0, 0);
1318   va_end(detail_args);
1319 }
1320 
1321 void VMError::report_and_die(const char* message)
1322 {
1323   report_and_die(message, &quot;%s&quot;, &quot;&quot;);
1324 }
1325 
1326 void VMError::report_and_die(Thread* thread, void* context, const char* filename, int lineno, const char* message,
1327                              const char* detail_fmt, va_list detail_args)
1328 {
1329   report_and_die(INTERNAL_ERROR, message, detail_fmt, detail_args, thread, NULL, NULL, context, filename, lineno, 0);
1330 }
1331 
1332 void VMError::report_and_die(Thread* thread, const char* filename, int lineno, size_t size,
1333                              VMErrorType vm_err_type, const char* detail_fmt, va_list detail_args) {
1334   report_and_die(vm_err_type, NULL, detail_fmt, detail_args, thread, NULL, NULL, NULL, filename, lineno, size);
1335 }
1336 
1337 void VMError::report_and_die(int id, const char* message, const char* detail_fmt, va_list detail_args,
1338                              Thread* thread, address pc, void* siginfo, void* context, const char* filename,
1339                              int lineno, size_t size)
1340 {
1341   // A single scratch buffer to be used from here on.
1342   // Do not rely on it being preserved across function calls.
1343   static char buffer[O_BUFLEN];
1344 
1345   // File descriptor to tty to print an error summary to.
1346   // Hard wired to stdout; see JDK-8215004 (compatibility concerns).
1347   static const int fd_out = 1; // stdout
1348 
1349   // File descriptor to the error log file.
1350   static int fd_log = -1;
1351 
1352 #ifdef CAN_SHOW_REGISTERS_ON_ASSERT
1353   // Disarm assertion poison page, since from this point on we do not need this mechanism anymore and it may
1354   // cause problems in error handling during native OOM, see JDK-8227275.
1355   disarm_assert_poison();
1356 #endif
1357 
1358   // Use local fdStream objects only. Do not use global instances whose initialization
1359   // relies on dynamic initialization (see JDK-8214975). Do not rely on these instances
1360   // to carry over into recursions or invocations from other threads.
1361   fdStream out(fd_out);
1362   out.set_scratch_buffer(buffer, sizeof(buffer));
1363 
1364   // Depending on the re-entrance depth at this point, fd_log may be -1 or point to an open hs-err file.
1365   fdStream log(fd_log);
1366   log.set_scratch_buffer(buffer, sizeof(buffer));
1367 
1368   // How many errors occurred in error handler when reporting first_error.
1369   static int recursive_error_count;
1370 
1371   // We will first print a brief message to standard out (verbose = false),
1372   // then save detailed information in log file (verbose = true).
1373   static bool out_done = false;         // done printing to standard out
1374   static bool log_done = false;         // done saving error log
1375 
1376   if (SuppressFatalErrorMessage) {
1377       os::abort(CreateCoredumpOnCrash);
1378   }
1379   intptr_t mytid = os::current_thread_id();
1380   if (_first_error_tid == -1 &amp;&amp;
1381       Atomic::cmpxchg(&amp;_first_error_tid, (intptr_t)-1, mytid) == -1) {
1382 
1383     // Initialize time stamps to use the same base.
1384     out.time_stamp().update_to(1);
1385     log.time_stamp().update_to(1);
1386 
1387     _id = id;
1388     _message = message;
1389     _thread = thread;
1390     _pc = pc;
1391     _siginfo = siginfo;
1392     _context = context;
1393     _filename = filename;
1394     _lineno = lineno;
1395     _size = size;
1396     jio_vsnprintf(_detail_msg, sizeof(_detail_msg), detail_fmt, detail_args);
1397 
1398     // first time
1399     _error_reported = true;
1400 
1401     reporting_started();
1402     if (!TestUnresponsiveErrorHandler) {
1403       // Record reporting_start_time unless we&#39;re running the
1404       // TestUnresponsiveErrorHandler test. For that test we record
1405       // reporting_start_time at the beginning of the test.
1406       record_reporting_start_time();
1407     } else {
1408       out.print_raw_cr(&quot;Delaying recording reporting_start_time for TestUnresponsiveErrorHandler.&quot;);
1409     }
1410 
1411     if (ShowMessageBoxOnError || PauseAtExit) {
1412       show_message_box(buffer, sizeof(buffer));
1413 
1414       // User has asked JVM to abort. Reset ShowMessageBoxOnError so the
1415       // WatcherThread can kill JVM if the error handler hangs.
1416       ShowMessageBoxOnError = false;
1417     }
1418 
1419     os::check_dump_limit(buffer, sizeof(buffer));
1420 
1421     // reset signal handlers or exception filter; make sure recursive crashes
1422     // are handled properly.
1423     reset_signal_handlers();
1424   } else {
1425     // If UseOsErrorReporting we call this for each level of the call stack
1426     // while searching for the exception handler.  Only the first level needs
1427     // to be reported.
1428     if (UseOSErrorReporting &amp;&amp; log_done) return;
1429 
1430     // This is not the first error, see if it happened in a different thread
1431     // or in the same thread during error reporting.
1432     if (_first_error_tid != mytid) {
1433       char msgbuf[64];
1434       jio_snprintf(msgbuf, sizeof(msgbuf),
1435                    &quot;[thread &quot; INTX_FORMAT &quot; also had an error]&quot;,
1436                    mytid);
1437       out.print_raw_cr(msgbuf);
1438 
1439       // error reporting is not MT-safe, block current thread
1440       os::infinite_sleep();
1441 
1442     } else {
1443       if (recursive_error_count++ &gt; 30) {
1444         out.print_raw_cr(&quot;[Too many errors, abort]&quot;);
1445         os::die();
1446       }
1447 
1448       outputStream* const st = log.is_open() ? &amp;log : &amp;out;
1449       st-&gt;cr();
1450 
1451       // Timeout handling.
1452       if (_step_did_timeout) {
1453         // The current step had a timeout. Lets continue reporting with the next step.
1454         st-&gt;print_raw(&quot;[timeout occurred during error reporting in step \&quot;&quot;);
1455         st-&gt;print_raw(_current_step_info);
1456         st-&gt;print_cr(&quot;\&quot;] after &quot; INT64_FORMAT &quot; s.&quot;,
1457                      (int64_t)
1458                      ((get_current_timestamp() - _step_start_time) / TIMESTAMP_TO_SECONDS_FACTOR));
1459       } else if (_reporting_did_timeout) {
1460         // We hit ErrorLogTimeout. Reporting will stop altogether. Let&#39;s wrap things
1461         // up, the process is about to be stopped by the WatcherThread.
1462         st-&gt;print_cr(&quot;------ Timeout during error reporting after &quot; INT64_FORMAT &quot; s. ------&quot;,
1463                      (int64_t)
1464                      ((get_current_timestamp() - _reporting_start_time) / TIMESTAMP_TO_SECONDS_FACTOR));
1465         st-&gt;flush();
1466         // Watcherthread is about to call os::die. Lets just wait.
1467         os::infinite_sleep();
1468       } else {
1469         // Crash or assert during error reporting. Lets continue reporting with the next step.
1470         stringStream ss(buffer, sizeof(buffer));
1471         // Note: this string does get parsed by a number of jtreg tests,
1472         // see hotspot/jtreg/runtime/ErrorHandling.
1473         ss.print(&quot;[error occurred during error reporting (%s), id 0x%x&quot;,
1474                    _current_step_info, id);
1475         char signal_name[64];
1476         if (os::exception_name(id, signal_name, sizeof(signal_name))) {
1477           ss.print(&quot;, %s (0x%x) at pc=&quot; PTR_FORMAT, signal_name, id, p2i(pc));
1478         } else {
1479           if (should_report_bug(id)) {
1480             ss.print(&quot;, Internal Error (%s:%d)&quot;,
1481               filename == NULL ? &quot;??&quot; : filename, lineno);
1482           } else {
1483             ss.print(&quot;, Out of Memory Error (%s:%d)&quot;,
1484               filename == NULL ? &quot;??&quot; : filename, lineno);
1485           }
1486         }
1487         ss.print(&quot;]&quot;);
1488         st-&gt;print_raw_cr(buffer);
1489         st-&gt;cr();
1490       }
1491     }
1492   }
1493 
1494   // Part 1: print an abbreviated version (the &#39;#&#39; section) to stdout.
1495   if (!out_done) {
1496     // Suppress this output if we plan to print Part 2 to stdout too.
1497     // No need to have the &quot;#&quot; section twice.
1498     if (!(ErrorFileToStdout &amp;&amp; out.fd() == 1)) {
1499       report(&amp;out, false);
1500     }
1501 
1502     out_done = true;
1503 
1504     _current_step = 0;
1505     _current_step_info = &quot;&quot;;
1506   }
1507 
1508   // Part 2: print a full error log file (optionally to stdout or stderr).
1509   // print to error log file
1510   if (!log_done) {
1511     // see if log file is already open
1512     if (!log.is_open()) {
1513       // open log file
1514       if (ErrorFileToStdout) {
1515         fd_log = 1;
1516       } else if (ErrorFileToStderr) {
1517         fd_log = 2;
1518       } else {
1519         fd_log = prepare_log_file(ErrorFile, &quot;hs_err_pid%p.log&quot;, true,
1520                  buffer, sizeof(buffer));
1521         if (fd_log != -1) {
1522           out.print_raw(&quot;# An error report file with more information is saved as:\n# &quot;);
1523           out.print_raw_cr(buffer);
1524         } else {
1525           out.print_raw_cr(&quot;# Can not save log file, dump to screen..&quot;);
1526           fd_log = 1;
1527         }
1528       }
1529       log.set_fd(fd_log);
1530     }
1531 
1532     report(&amp;log, true);
1533     log_done = true;
1534     _current_step = 0;
1535     _current_step_info = &quot;&quot;;
1536 
1537     if (fd_log &gt; 3) {
1538       close(fd_log);
1539       fd_log = -1;
1540     }
1541 
1542     log.set_fd(-1);
1543   }
1544 
1545   JFR_ONLY(Jfr::on_vm_shutdown(true);)
1546 
1547   if (PrintNMTStatistics) {
1548     fdStream fds(fd_out);
1549     MemTracker::final_report(&amp;fds);
1550   }
1551 
1552   static bool skip_replay = ReplayCompiles; // Do not overwrite file during replay
1553   if (DumpReplayDataOnError &amp;&amp; _thread &amp;&amp; _thread-&gt;is_Compiler_thread() &amp;&amp; !skip_replay) {
1554     skip_replay = true;
1555     ciEnv* env = ciEnv::current();
1556     if (env != NULL) {
1557       const bool overwrite = false; // We do not overwrite an existing replay file.
1558       int fd = prepare_log_file(ReplayDataFile, &quot;replay_pid%p.log&quot;, overwrite, buffer, sizeof(buffer));
1559       if (fd != -1) {
1560         FILE* replay_data_file = os::open(fd, &quot;w&quot;);
1561         if (replay_data_file != NULL) {
1562           fileStream replay_data_stream(replay_data_file, /*need_close=*/true);
1563           env-&gt;dump_replay_data_unsafe(&amp;replay_data_stream);
1564           out.print_raw(&quot;#\n# Compiler replay data is saved as:\n# &quot;);
1565           out.print_raw_cr(buffer);
1566         } else {
1567           int e = errno;
1568           out.print_raw(&quot;#\n# Can&#39;t open file to dump replay data. Error: &quot;);
1569           out.print_raw_cr(os::strerror(e));
1570         }
1571       }
1572     }
1573   }
1574 
1575   static bool skip_bug_url = !should_report_bug(_id);
1576   if (!skip_bug_url) {
1577     skip_bug_url = true;
1578 
1579     out.print_raw_cr(&quot;#&quot;);
1580     print_bug_submit_message(&amp;out, _thread);
1581   }
1582 
1583   static bool skip_OnError = false;
1584   if (!skip_OnError &amp;&amp; OnError &amp;&amp; OnError[0]) {
1585     skip_OnError = true;
1586 
1587     // Flush output and finish logs before running OnError commands.
1588     ostream_abort();
1589 
1590     out.print_raw_cr(&quot;#&quot;);
1591     out.print_raw   (&quot;# -XX:OnError=\&quot;&quot;);
1592     out.print_raw   (OnError);
1593     out.print_raw_cr(&quot;\&quot;&quot;);
1594 
1595     char* cmd;
1596     const char* ptr = OnError;
1597     while ((cmd = next_OnError_command(buffer, sizeof(buffer), &amp;ptr)) != NULL){
1598       out.print_raw   (&quot;#   Executing &quot;);
1599 #if defined(LINUX) || defined(_ALLBSD_SOURCE)
1600       out.print_raw   (&quot;/bin/sh -c &quot;);
1601 #elif defined(_WINDOWS)
1602       out.print_raw   (&quot;cmd /C &quot;);
1603 #endif
1604       out.print_raw   (&quot;\&quot;&quot;);
1605       out.print_raw   (cmd);
1606       out.print_raw_cr(&quot;\&quot; ...&quot;);
1607 
1608       if (os::fork_and_exec(cmd) &lt; 0) {
1609         out.print_cr(&quot;os::fork_and_exec failed: %s (%s=%d)&quot;,
1610                      os::strerror(errno), os::errno_name(errno), errno);
1611       }
1612     }
1613 
1614     // done with OnError
1615     OnError = NULL;
1616   }
1617 
1618   if (!UseOSErrorReporting) {
1619     // os::abort() will call abort hooks, try it first.
1620     static bool skip_os_abort = false;
1621     if (!skip_os_abort) {
1622       skip_os_abort = true;
1623       bool dump_core = should_report_bug(_id);
1624       os::abort(dump_core &amp;&amp; CreateCoredumpOnCrash, _siginfo, _context);
1625     }
1626 
1627     // if os::abort() doesn&#39;t abort, try os::die();
1628     os::die();
1629   }
1630 }
1631 
1632 /*
1633  * OnOutOfMemoryError scripts/commands executed while VM is a safepoint - this
1634  * ensures utilities such as jmap can observe the process is a consistent state.
1635  */
1636 class VM_ReportJavaOutOfMemory : public VM_Operation {
1637  private:
1638   const char* _message;
1639  public:
1640   VM_ReportJavaOutOfMemory(const char* message) { _message = message; }
1641   VMOp_Type type() const                        { return VMOp_ReportJavaOutOfMemory; }
1642   void doit();
1643 };
1644 
1645 void VM_ReportJavaOutOfMemory::doit() {
1646   // Don&#39;t allocate large buffer on stack
1647   static char buffer[O_BUFLEN];
1648 
1649   tty-&gt;print_cr(&quot;#&quot;);
1650   tty-&gt;print_cr(&quot;# java.lang.OutOfMemoryError: %s&quot;, _message);
1651   tty-&gt;print_cr(&quot;# -XX:OnOutOfMemoryError=\&quot;%s\&quot;&quot;, OnOutOfMemoryError);
1652 
1653   // make heap parsability
1654   Universe::heap()-&gt;ensure_parsability(false);  // no need to retire TLABs
1655 
1656   char* cmd;
1657   const char* ptr = OnOutOfMemoryError;
1658   while ((cmd = next_OnError_command(buffer, sizeof(buffer), &amp;ptr)) != NULL){
1659     tty-&gt;print(&quot;#   Executing &quot;);
1660 #if defined(LINUX)
1661     tty-&gt;print  (&quot;/bin/sh -c &quot;);
1662 #endif
1663     tty-&gt;print_cr(&quot;\&quot;%s\&quot;...&quot;, cmd);
1664 
1665     if (os::fork_and_exec(cmd, true) &lt; 0) {
1666       tty-&gt;print_cr(&quot;os::fork_and_exec failed: %s (%s=%d)&quot;,
1667                      os::strerror(errno), os::errno_name(errno), errno);
1668     }
1669   }
1670 }
1671 
1672 void VMError::report_java_out_of_memory(const char* message) {
1673   if (OnOutOfMemoryError &amp;&amp; OnOutOfMemoryError[0]) {
1674     MutexLocker ml(Heap_lock);
1675     VM_ReportJavaOutOfMemory op(message);
1676     VMThread::execute(&amp;op);
1677   }
1678 }
1679 
1680 void VMError::show_message_box(char *buf, int buflen) {
1681   bool yes;
1682   do {
1683     error_string(buf, buflen);
1684     yes = os::start_debugging(buf,buflen);
1685   } while (yes);
1686 }
1687 
1688 // Timeout handling: check if a timeout happened (either a single step did
1689 // timeout or the whole of error reporting hit ErrorLogTimeout). Interrupt
1690 // the reporting thread if that is the case.
1691 bool VMError::check_timeout() {
1692 
1693   if (ErrorLogTimeout == 0) {
1694     return false;
1695   }
1696 
1697   // Do not check for timeouts if we still have a message box to show to the
1698   // user or if there are OnError handlers to be run.
1699   if (ShowMessageBoxOnError
1700       || (OnError != NULL &amp;&amp; OnError[0] != &#39;\0&#39;)
1701       || Arguments::abort_hook() != NULL) {
1702     return false;
1703   }
1704 
1705   const jlong reporting_start_time_l = get_reporting_start_time();
1706   const jlong now = get_current_timestamp();
1707   // Timestamp is stored in nanos.
1708   if (reporting_start_time_l &gt; 0) {
1709     const jlong end = reporting_start_time_l + (jlong)ErrorLogTimeout * TIMESTAMP_TO_SECONDS_FACTOR;
1710     if (end &lt;= now &amp;&amp; !_reporting_did_timeout) {
1711       // We hit ErrorLogTimeout and we haven&#39;t interrupted the reporting
1712       // thread yet.
1713       _reporting_did_timeout = true;
1714       interrupt_reporting_thread();
1715       return true; // global timeout
1716     }
1717   }
1718 
1719   const jlong step_start_time_l = get_step_start_time();
1720   if (step_start_time_l &gt; 0) {
1721     // A step times out after a quarter of the total timeout. Steps are mostly fast unless they
1722     // hang for some reason, so this simple rule allows for three hanging step and still
1723     // hopefully leaves time enough for the rest of the steps to finish.
1724     const jlong end = step_start_time_l + (jlong)ErrorLogTimeout * TIMESTAMP_TO_SECONDS_FACTOR / 4;
1725     if (end &lt;= now &amp;&amp; !_step_did_timeout) {
1726       // The step timed out and we haven&#39;t interrupted the reporting
1727       // thread yet.
1728       _step_did_timeout = true;
1729       interrupt_reporting_thread();
1730       return false; // (Not a global timeout)
1731     }
1732   }
1733 
1734   return false;
1735 
1736 }
1737 
1738 #ifndef PRODUCT
1739 typedef void (*voidfun_t)();
1740 // Crash with an authentic sigfpe
1741 static void crash_with_sigfpe() {
1742   // generate a native synchronous SIGFPE where possible;
1743   // if that did not cause a signal (e.g. on ppc), just
1744   // raise the signal.
1745   volatile int x = 0;
1746   volatile int y = 1/x;
1747 #ifndef _WIN32
1748   // OSX implements raise(sig) incorrectly so we need to
1749   // explicitly target the current thread
1750   pthread_kill(pthread_self(), SIGFPE);
1751 #endif
1752 } // end: crash_with_sigfpe
1753 
1754 // crash with sigsegv at non-null address.
1755 static void crash_with_segfault() {
1756 
1757   char* const crash_addr = (char*) VMError::get_segfault_address();
1758   *crash_addr = &#39;X&#39;;
1759 
1760 } // end: crash_with_segfault
1761 
1762 void VMError::test_error_handler() {
1763   controlled_crash(ErrorHandlerTest);
1764 }
1765 
1766 // crash in a controlled way:
1767 // how can be one of:
1768 // 1,2 - asserts
1769 // 3,4 - guarantee
1770 // 5-7 - fatal
1771 // 8 - vm_exit_out_of_memory
1772 // 9 - ShouldNotCallThis
1773 // 10 - ShouldNotReachHere
1774 // 11 - Unimplemented
1775 // 12,13 - (not guaranteed) crashes
1776 // 14 - SIGSEGV
1777 // 15 - SIGFPE
1778 void VMError::controlled_crash(int how) {
1779   if (how == 0) return;
1780 
1781   // If asserts are disabled, use the corresponding guarantee instead.
1782   NOT_DEBUG(if (how &lt;= 2) how += 2);
1783 
1784   const char* const str = &quot;hello&quot;;
1785   const size_t      num = (size_t)os::vm_page_size();
1786 
1787   const char* const eol = os::line_separator();
1788   const char* const msg = &quot;this message should be truncated during formatting&quot;;
1789   char * const dataPtr = NULL;  // bad data pointer
1790   const void (*funcPtr)(void);  // bad function pointer
1791 
1792 #if defined(PPC64) &amp;&amp; !defined(ABI_ELFv2)
1793   struct FunctionDescriptor functionDescriptor;
1794 
1795   functionDescriptor.set_entry((address) 0xF);
1796   funcPtr = (const void(*)()) &amp;functionDescriptor;
1797 #else
1798   funcPtr = (const void(*)()) 0xF;
1799 #endif
1800 
1801   // Keep this in sync with test/hotspot/jtreg/runtime/ErrorHandling/ErrorHandler.java
1802   // which tests cases 1 thru 13.
1803   // Case 14 is tested by test/hotspot/jtreg/runtime/ErrorHandling/SafeFetchInErrorHandlingTest.java.
1804   // Case 15 is tested by test/hotspot/jtreg/runtime/ErrorHandling/SecondaryErrorTest.java.
1805   // Case 16 is tested by test/hotspot/jtreg/runtime/ErrorHandling/ThreadsListHandleInErrorHandlingTest.java.
1806   // Case 17 is tested by test/hotspot/jtreg/runtime/ErrorHandling/NestedThreadsListHandleInErrorHandlingTest.java.
1807 
1808   // We try to grab Threads_lock to keep ThreadsSMRSupport::print_info_on()
1809   // from racing with Threads::add() or Threads::remove() as we
1810   // generate the hs_err_pid file. This makes our ErrorHandling tests
1811   // more stable.
1812   if (!Threads_lock-&gt;owned_by_self()) {
1813     Threads_lock-&gt;try_lock();
1814     // The VM is going to die so no need to unlock Thread_lock.
1815   }
1816 
1817   switch (how) {
1818     case  1: vmassert(str == NULL, &quot;expected null&quot;); break;
1819     case  2: vmassert(num == 1023 &amp;&amp; *str == &#39;X&#39;,
1820                       &quot;num=&quot; SIZE_FORMAT &quot; str=\&quot;%s\&quot;&quot;, num, str); break;
1821     case  3: guarantee(str == NULL, &quot;expected null&quot;); break;
1822     case  4: guarantee(num == 1023 &amp;&amp; *str == &#39;X&#39;,
1823                        &quot;num=&quot; SIZE_FORMAT &quot; str=\&quot;%s\&quot;&quot;, num, str); break;
1824     case  5: fatal(&quot;expected null&quot;); break;
1825     case  6: fatal(&quot;num=&quot; SIZE_FORMAT &quot; str=\&quot;%s\&quot;&quot;, num, str); break;
1826     case  7: fatal(&quot;%s%s#    %s%s#    %s%s#    %s%s#    %s%s#    &quot;
1827                    &quot;%s%s#    %s%s#    %s%s#    %s%s#    %s%s#    &quot;
1828                    &quot;%s%s#    %s%s#    %s%s#    %s%s#    %s&quot;,
1829                    msg, eol, msg, eol, msg, eol, msg, eol, msg, eol,
1830                    msg, eol, msg, eol, msg, eol, msg, eol, msg, eol,
1831                    msg, eol, msg, eol, msg, eol, msg, eol, msg); break;
1832     case  8: vm_exit_out_of_memory(num, OOM_MALLOC_ERROR, &quot;ChunkPool::allocate&quot;); break;
1833     case  9: ShouldNotCallThis(); break;
1834     case 10: ShouldNotReachHere(); break;
1835     case 11: Unimplemented(); break;
1836     // There&#39;s no guarantee the bad data pointer will crash us
1837     // so &quot;break&quot; out to the ShouldNotReachHere().
1838     case 12: *dataPtr = &#39;\0&#39;; break;
1839     // There&#39;s no guarantee the bad function pointer will crash us
1840     // so &quot;break&quot; out to the ShouldNotReachHere().
1841     case 13: (*funcPtr)(); break;
1842     case 14: crash_with_segfault(); break;
1843     case 15: crash_with_sigfpe(); break;
1844     case 16: {
1845       ThreadsListHandle tlh;
1846       fatal(&quot;Force crash with an active ThreadsListHandle.&quot;);
1847     }
1848     case 17: {
1849       ThreadsListHandle tlh;
1850       {
1851         ThreadsListHandle tlh2;
1852         fatal(&quot;Force crash with a nested ThreadsListHandle.&quot;);
1853       }
1854     }
1855 
1856     default: tty-&gt;print_cr(&quot;ERROR: %d: unexpected test_num value.&quot;, how);
1857   }
1858   tty-&gt;print_cr(&quot;VMError::controlled_crash: survived intentional crash. Did you suppress the assert?&quot;);
1859   ShouldNotReachHere();
1860 }
1861 #endif // !PRODUCT
<a name="11" id="anc11"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="11" type="hidden" />
</body>
</html>