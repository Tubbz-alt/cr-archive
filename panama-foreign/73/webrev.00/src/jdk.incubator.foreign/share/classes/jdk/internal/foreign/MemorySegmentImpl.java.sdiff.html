<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/jdk.incubator.foreign/share/classes/jdk/internal/foreign/MemorySegmentImpl.java</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
  </head>
<body>
<center><a href="../../incubator/foreign/unsafe/ForeignUnsafe.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="../../../../../../../test/jdk/java/foreign/TestSharedAccess.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/jdk.incubator.foreign/share/classes/jdk/internal/foreign/MemorySegmentImpl.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
187     }
188 
189     @Override
190     public int accessModes() {
191         return mask &amp; ACCESS_MASK;
192     }
193 
194     @Override
195     public byte[] toByteArray() {
196         checkIntSize(&quot;byte[]&quot;);
197         byte[] arr = new byte[(int)length];
198         MemorySegment arrSegment = MemorySegment.ofArray(arr);
199         MemoryAddress.copy(this.baseAddress(), arrSegment.baseAddress(), length);
200         return arr;
201     }
202 
203     // MemorySegmentProxy methods
204 
205     @Override
206     public final void checkValidState() {
<span class="line-modified">207         if (owner != Thread.currentThread()) {</span>
208             throw new IllegalStateException(&quot;Attempt to access segment outside owning thread&quot;);
209         }
210         scope.checkAliveConfined();
211     }
212 
213     boolean isSmall() {
214         return isSet(SMALL);
215     }
216 
217     // Object methods
218 
219     @Override
220     public String toString() {
221         return &quot;MemorySegment{ id=0x&quot; + Long.toHexString(id()) + &quot; limit: &quot; + byteSize() + &quot; }&quot;;
222     }
223 
224     // Helper methods
225 
226     private MemorySegmentImpl acquire() {
227         if (Thread.currentThread() != owner &amp;&amp; !isSet(ACQUIRE)) {
228             throw unsupportedAccessMode(ACQUIRE);
229         }
230         return new MemorySegmentImpl(min, base, length, mask, Thread.currentThread(), scope.acquire());
231     }
232 





233     void checkRange(long offset, long length, boolean writeAccess) {
234         checkValidState();
235         if (writeAccess &amp;&amp; !isSet(WRITE)) {
236             throw unsupportedAccessMode(WRITE);
237         } else if (!writeAccess &amp;&amp; !isSet(READ)) {
238             throw unsupportedAccessMode(READ);
239         }
240         checkBounds(offset, length);
241     }
242 
243     Object base() {
244         return base;
245     }
246 
247     private boolean isSet(int mask) {
248         return (this.mask &amp; mask) != 0;
249     }
250 
251     private void checkIntSize(String typeName) {
252         if (length &gt; (Integer.MAX_VALUE - 8)) { //conservative check
</pre>
</td>
<td>
<hr />
<pre>
187     }
188 
189     @Override
190     public int accessModes() {
191         return mask &amp; ACCESS_MASK;
192     }
193 
194     @Override
195     public byte[] toByteArray() {
196         checkIntSize(&quot;byte[]&quot;);
197         byte[] arr = new byte[(int)length];
198         MemorySegment arrSegment = MemorySegment.ofArray(arr);
199         MemoryAddress.copy(this.baseAddress(), arrSegment.baseAddress(), length);
200         return arr;
201     }
202 
203     // MemorySegmentProxy methods
204 
205     @Override
206     public final void checkValidState() {
<span class="line-modified">207         if (owner != null &amp;&amp; owner != Thread.currentThread()) {</span>
208             throw new IllegalStateException(&quot;Attempt to access segment outside owning thread&quot;);
209         }
210         scope.checkAliveConfined();
211     }
212 
213     boolean isSmall() {
214         return isSet(SMALL);
215     }
216 
217     // Object methods
218 
219     @Override
220     public String toString() {
221         return &quot;MemorySegment{ id=0x&quot; + Long.toHexString(id()) + &quot; limit: &quot; + byteSize() + &quot; }&quot;;
222     }
223 
224     // Helper methods
225 
226     private MemorySegmentImpl acquire() {
227         if (Thread.currentThread() != owner &amp;&amp; !isSet(ACQUIRE)) {
228             throw unsupportedAccessMode(ACQUIRE);
229         }
230         return new MemorySegmentImpl(min, base, length, mask, Thread.currentThread(), scope.acquire());
231     }
232 
<span class="line-added">233     public MemorySegment asUnconfined() {</span>
<span class="line-added">234         checkValidState();</span>
<span class="line-added">235         return new MemorySegmentImpl(min, base, length, mask, null, scope);</span>
<span class="line-added">236     }</span>
<span class="line-added">237 </span>
238     void checkRange(long offset, long length, boolean writeAccess) {
239         checkValidState();
240         if (writeAccess &amp;&amp; !isSet(WRITE)) {
241             throw unsupportedAccessMode(WRITE);
242         } else if (!writeAccess &amp;&amp; !isSet(READ)) {
243             throw unsupportedAccessMode(READ);
244         }
245         checkBounds(offset, length);
246     }
247 
248     Object base() {
249         return base;
250     }
251 
252     private boolean isSet(int mask) {
253         return (this.mask &amp; mask) != 0;
254     }
255 
256     private void checkIntSize(String typeName) {
257         if (length &gt; (Integer.MAX_VALUE - 8)) { //conservative check
</pre>
</td>
</tr>
</table>
<center><a href="../../incubator/foreign/unsafe/ForeignUnsafe.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="../../../../../../../test/jdk/java/foreign/TestSharedAccess.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>