<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff src/jdk.incubator.jextract/share/classes/jdk/internal/jextract/impl/MacroParserImpl.java</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center>&lt; prev <a href="../../../../../../../../index.html" target="_top">index</a> next &gt;</center>    <h2>src/jdk.incubator.jextract/share/classes/jdk/internal/jextract/impl/MacroParserImpl.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -186,15 +186,15 @@</span>
  
              String mangledName() {
                  return &quot;jextract$macro$&quot; + name;
              }
  
<span class="udiff-line-modified-removed">-             Success success(Type type, Object value) {</span>
<span class="udiff-line-modified-added">+             Entry success(Type type, Object value) {</span>
                  throw new IllegalStateException();
              }
  
<span class="udiff-line-modified-removed">-             RecoverableFailure failure(Type type) {</span>
<span class="udiff-line-modified-added">+             Entry failure(Type type) {</span>
                  throw new IllegalStateException();
              }
  
              boolean isSuccess() {
                  return false;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -203,33 +203,42 @@</span>
                  return false;
              }
              boolean isUnparsed() {
                  return false;
              }
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             void update() {</span>
<span class="udiff-line-added">+                 macrosByMangledName.put(mangledName(), this);</span>
<span class="udiff-line-added">+             }</span>
          }
  
          class Unparsed extends Entry {
              Unparsed(String name, String[] tokens, Cursor cursor) {
                  super(name, tokens, cursor);
              }
  
              @Override
<span class="udiff-line-modified-removed">-             Success success(Type type, Object value) {</span>
<span class="udiff-line-modified-added">+             Entry success(Type type, Object value) {</span>
                  return new Success(name, tokens, cursor, type, value);
              }
  
              @Override
<span class="udiff-line-modified-removed">-             RecoverableFailure failure(Type type) {</span>
<span class="udiff-line-modified-added">+             Entry failure(Type type) {</span>
                  return type != null ?
                          new RecoverableFailure(name, tokens, cursor, type) :
<span class="udiff-line-modified-removed">-                         null;</span>
<span class="udiff-line-modified-added">+                         new UnparseableMacro(name, tokens, cursor);</span>
              }
  
              @Override
              boolean isUnparsed() {
                  return true;
              }
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             @Override</span>
<span class="udiff-line-added">+             void update() {</span>
<span class="udiff-line-added">+                 throw new IllegalStateException();</span>
<span class="udiff-line-added">+             }</span>
          }
  
          class RecoverableFailure extends Entry {
  
              final Type type;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -238,17 +247,17 @@</span>
                  super(name, tokens, cursor);
                  this.type = type;
              }
  
              @Override
<span class="udiff-line-modified-removed">-             Success success(Type type, Object value) {</span>
<span class="udiff-line-modified-added">+             Entry success(Type type, Object value) {</span>
                  return new Success(name, tokens, cursor, this.type, value);
              }
  
              @Override
<span class="udiff-line-modified-removed">-             RecoverableFailure failure(Type type) {</span>
<span class="udiff-line-modified-removed">-                 return null;</span>
<span class="udiff-line-modified-added">+             Entry failure(Type type) {</span>
<span class="udiff-line-modified-added">+                 return new UnparseableMacro(name, tokens, cursor);</span>
              }
  
              @Override
              boolean isRecoverableFailure() {
                  return true;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -273,10 +282,22 @@</span>
              public Object value() {
                  return value;
              }
          }
  
<span class="udiff-line-added">+         class UnparseableMacro extends Entry {</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             UnparseableMacro(String name, String[] tokens, Cursor cursor) {</span>
<span class="udiff-line-added">+                 super(name, tokens, cursor);</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             @Override</span>
<span class="udiff-line-added">+             void update() {</span>
<span class="udiff-line-added">+                 macrosByMangledName.remove(mangledName());</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+         };</span>
<span class="udiff-line-added">+ </span>
          void enterMacro(String name, String[] tokens, Cursor cursor) {
              Unparsed unparsed = new Unparsed(name, tokens, cursor);
              macrosByMangledName.put(unparsed.mangledName(), unparsed);
          }
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -297,39 +318,31 @@</span>
          }
  
          void updateTable(TypeMaker typeMaker, Cursor decl) {
              String mangledName = decl.spelling();
              Entry entry = macrosByMangledName.get(mangledName);
<span class="udiff-line-removed">-             Entry newEntry;</span>
              try (EvalResult result = decl.eval()) {
<span class="udiff-line-modified-removed">-                 switch (result.getKind()) {</span>
<span class="udiff-line-modified-removed">-                     case Integral: {</span>
<span class="udiff-line-modified-added">+                 Entry newEntry = switch (result.getKind()) {</span>
<span class="udiff-line-modified-added">+                     case Integral -&gt; {</span>
                          long value = result.getAsInt();
<span class="udiff-line-modified-removed">-                         newEntry = entry.success(typeMaker.makeType(decl.type()), value);</span>
<span class="udiff-line-removed">-                         break;</span>
<span class="udiff-line-modified-added">+                         yield entry.success(typeMaker.makeType(decl.type()), value);</span>
                      }
<span class="udiff-line-modified-removed">-                     case FloatingPoint: {</span>
<span class="udiff-line-modified-added">+                     case FloatingPoint -&gt; {</span>
                          double value = result.getAsFloat();
<span class="udiff-line-modified-removed">-                         newEntry = entry.success(typeMaker.makeType(decl.type()), value);</span>
<span class="udiff-line-removed">-                         break;</span>
<span class="udiff-line-modified-added">+                         yield entry.success(typeMaker.makeType(decl.type()), value);</span>
                      }
<span class="udiff-line-modified-removed">-                     case StrLiteral: {</span>
<span class="udiff-line-modified-added">+                     case StrLiteral -&gt; {</span>
                          String value = result.getAsString();
<span class="udiff-line-modified-removed">-                         newEntry = entry.success(typeMaker.makeType(decl.type()), value);</span>
<span class="udiff-line-removed">-                         break;</span>
<span class="udiff-line-modified-added">+                         yield entry.success(typeMaker.makeType(decl.type()), value);</span>
                      }
<span class="udiff-line-modified-removed">-                     default: {</span>
<span class="udiff-line-modified-added">+                     default -&gt; {</span>
                          Type type = decl.type().equals(decl.type().canonicalType()) ?
                                  null : typeMaker.makeType(decl.type());
<span class="udiff-line-modified-removed">-                         newEntry = entry.failure(type);</span>
<span class="udiff-line-modified-added">+                         yield entry.failure(type);</span>
                      }
<span class="udiff-line-modified-removed">-                 }</span>
<span class="udiff-line-modified-removed">-             }</span>
<span class="udiff-line-removed">-             if (newEntry != null) {</span>
<span class="udiff-line-removed">-                 macrosByMangledName.put(newEntry.mangledName(), newEntry);</span>
<span class="udiff-line-removed">-             } else {</span>
<span class="udiff-line-removed">-                 macrosByMangledName.remove(entry.mangledName());</span>
<span class="udiff-line-modified-added">+                 };</span>
<span class="udiff-line-modified-added">+                 newEntry.update();</span>
              }
          }
  
          void reparseMacros(boolean recovery) {
              String snippet = macroDecl(recovery);
</pre>
<center>&lt; prev <a href="../../../../../../../../index.html" target="_top">index</a> next &gt;</center>  </body>
</html>