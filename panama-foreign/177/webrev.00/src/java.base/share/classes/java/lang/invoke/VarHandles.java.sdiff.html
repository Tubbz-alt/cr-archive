<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/java.base/share/classes/java/lang/invoke/VarHandles.java</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
  </head>
<body>
<center>&lt; prev <a href="../../../../../../../index.html" target="_top">index</a> <a href="../../../../../../../test/jdk/java/foreign/TestAdaptVarHandles.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/java.base/share/classes/java/lang/invoke/VarHandles.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
525         Objects.nonNull(target);
526         Objects.nonNull(valueTypes);
527 
528         List&lt;Class&lt;?&gt;&gt; targetCoordinates = target.coordinateTypes();
529         if (pos &lt; 0 || pos &gt; targetCoordinates.size()) {
530             throw newIllegalArgumentException(&quot;Invalid position &quot; + pos + &quot; for coordinate types&quot;, targetCoordinates);
531         }
532 
533         if (valueTypes.length == 0) return target;
534 
535         List&lt;Class&lt;?&gt;&gt; newCoordinates = new ArrayList&lt;&gt;(targetCoordinates);
536         newCoordinates.addAll(pos, List.of(valueTypes));
537 
538         return new IndirectVarHandle(target, target.varType(), newCoordinates.toArray(new Class&lt;?&gt;[0]),
539                 (mode, modeHandle) -&gt; MethodHandles.dropArguments(modeHandle, 1 + pos, valueTypes));
540     }
541 
542     private static void noCheckedExceptions(MethodHandle handle) {
543         if (handle instanceof DirectMethodHandle) {
544             DirectMethodHandle directHandle = (DirectMethodHandle)handle;
<span class="line-modified">545             MethodHandleInfo info = MethodHandles.Lookup.IMPL_LOOKUP.revealDirect(directHandle);</span>
<span class="line-modified">546             Class&lt;?&gt;[] exceptionTypes = switch (info.getReferenceKind()) {</span>
<span class="line-modified">547                 case MethodHandleInfo.REF_invokeInterface, MethodHandleInfo.REF_invokeSpecial,</span>
<span class="line-modified">548                         MethodHandleInfo.REF_invokeStatic, MethodHandleInfo.REF_invokeVirtual -&gt;</span>
<span class="line-modified">549                         info.reflectAs(Method.class, MethodHandles.Lookup.IMPL_LOOKUP).getExceptionTypes();</span>
<span class="line-modified">550                 case MethodHandleInfo.REF_newInvokeSpecial -&gt;</span>
<span class="line-modified">551                         info.reflectAs(Constructor.class, MethodHandles.Lookup.IMPL_LOOKUP).getExceptionTypes();</span>
<span class="line-modified">552                 case MethodHandleInfo.REF_getField, MethodHandleInfo.REF_getStatic,</span>
<span class="line-modified">553                         MethodHandleInfo.REF_putField, MethodHandleInfo.REF_putStatic -&gt; null;</span>
<span class="line-modified">554                 default -&gt; throw new AssertionError(&quot;Cannot get here&quot;);</span>
<span class="line-modified">555             };</span>






556             if (exceptionTypes != null) {
557                 if (Stream.of(exceptionTypes).anyMatch(VarHandles::isCheckedException)) {
558                     throw newIllegalArgumentException(&quot;Cannot adapt a var handle with a method handle which throws checked exceptions&quot;);
559                 }
560             }
561         } else if (handle instanceof DelegatingMethodHandle) {
562             noCheckedExceptions(((DelegatingMethodHandle)handle).getTarget());
563         } else {
564             //bound
565             BoundMethodHandle boundHandle = (BoundMethodHandle)handle;
566             for (int i = 0 ; i &lt; boundHandle.fieldCount() ; i++) {
567                 Object arg = boundHandle.arg(i);
568                 if (arg instanceof MethodHandle){
569                     noCheckedExceptions((MethodHandle) arg);
570                 }
571             }
572         }
573     }
574 
575     private static boolean isCheckedException(Class&lt;?&gt; clazz) {
</pre>
</td>
<td>
<hr />
<pre>
525         Objects.nonNull(target);
526         Objects.nonNull(valueTypes);
527 
528         List&lt;Class&lt;?&gt;&gt; targetCoordinates = target.coordinateTypes();
529         if (pos &lt; 0 || pos &gt; targetCoordinates.size()) {
530             throw newIllegalArgumentException(&quot;Invalid position &quot; + pos + &quot; for coordinate types&quot;, targetCoordinates);
531         }
532 
533         if (valueTypes.length == 0) return target;
534 
535         List&lt;Class&lt;?&gt;&gt; newCoordinates = new ArrayList&lt;&gt;(targetCoordinates);
536         newCoordinates.addAll(pos, List.of(valueTypes));
537 
538         return new IndirectVarHandle(target, target.varType(), newCoordinates.toArray(new Class&lt;?&gt;[0]),
539                 (mode, modeHandle) -&gt; MethodHandles.dropArguments(modeHandle, 1 + pos, valueTypes));
540     }
541 
542     private static void noCheckedExceptions(MethodHandle handle) {
543         if (handle instanceof DirectMethodHandle) {
544             DirectMethodHandle directHandle = (DirectMethodHandle)handle;
<span class="line-modified">545             byte refKind = directHandle.member.getReferenceKind();</span>
<span class="line-modified">546             MethodHandleInfo info = new InfoFromMemberName(</span>
<span class="line-modified">547                     MethodHandles.Lookup.IMPL_LOOKUP,</span>
<span class="line-modified">548                     directHandle.member,</span>
<span class="line-modified">549                     refKind);</span>
<span class="line-modified">550             final Class&lt;?&gt;[] exceptionTypes;</span>
<span class="line-modified">551             if (MethodHandleNatives.refKindIsMethod(refKind)) {</span>
<span class="line-modified">552                 exceptionTypes = info.reflectAs(Method.class, MethodHandles.Lookup.IMPL_LOOKUP)</span>
<span class="line-modified">553                         .getExceptionTypes();</span>
<span class="line-modified">554             } else if (MethodHandleNatives.refKindIsField(refKind)) {</span>
<span class="line-modified">555                 exceptionTypes = null;</span>
<span class="line-added">556             } else if (MethodHandleNatives.refKindIsConstructor(refKind)) {</span>
<span class="line-added">557                 exceptionTypes = info.reflectAs(Constructor.class, MethodHandles.Lookup.IMPL_LOOKUP)</span>
<span class="line-added">558                         .getExceptionTypes();</span>
<span class="line-added">559             } else {</span>
<span class="line-added">560                 throw new AssertionError(&quot;Cannot get here&quot;);</span>
<span class="line-added">561             }</span>
562             if (exceptionTypes != null) {
563                 if (Stream.of(exceptionTypes).anyMatch(VarHandles::isCheckedException)) {
564                     throw newIllegalArgumentException(&quot;Cannot adapt a var handle with a method handle which throws checked exceptions&quot;);
565                 }
566             }
567         } else if (handle instanceof DelegatingMethodHandle) {
568             noCheckedExceptions(((DelegatingMethodHandle)handle).getTarget());
569         } else {
570             //bound
571             BoundMethodHandle boundHandle = (BoundMethodHandle)handle;
572             for (int i = 0 ; i &lt; boundHandle.fieldCount() ; i++) {
573                 Object arg = boundHandle.arg(i);
574                 if (arg instanceof MethodHandle){
575                     noCheckedExceptions((MethodHandle) arg);
576                 }
577             }
578         }
579     }
580 
581     private static boolean isCheckedException(Class&lt;?&gt; clazz) {
</pre>
</td>
</tr>
</table>
<center>&lt; prev <a href="../../../../../../../index.html" target="_top">index</a> <a href="../../../../../../../test/jdk/java/foreign/TestAdaptVarHandles.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>