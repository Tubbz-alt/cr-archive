<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff test/jdk/java/foreign/TestAdaptVarHandles.java</title>
    <link rel="stylesheet" href="../../../../style.css" />
  </head>
<body>
<center><a href="../../../../src/java.base/share/classes/java/lang/invoke/VarHandles.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> next &gt;</center>    <h2>test/jdk/java/foreign/TestAdaptVarHandles.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 32  */
 33 
 34 import jdk.incubator.foreign.MemoryAddress;
 35 import jdk.incubator.foreign.MemoryHandles;
 36 import jdk.incubator.foreign.MemoryLayouts;
 37 import jdk.incubator.foreign.MemorySegment;
 38 import jdk.incubator.foreign.ValueLayout;
 39 import org.testng.annotations.*;
 40 import static org.testng.Assert.*;
 41 
 42 import java.lang.invoke.MethodHandle;
 43 import java.lang.invoke.MethodHandles;
 44 import java.lang.invoke.MethodType;
 45 import java.lang.invoke.VarHandle;
 46 import java.util.List;
 47 
 48 public class TestAdaptVarHandles {
 49 
 50     static MethodHandle S2I;
 51     static MethodHandle I2S;


 52     static MethodHandle S2L;
 53     static MethodHandle S2L_EX;
 54     static MethodHandle S2I_EX;
 55     static MethodHandle I2S_EX;
 56     static MethodHandle BASE_ADDR;
 57     static MethodHandle SUM_OFFSETS;
 58     static MethodHandle VOID_FILTER;
 59 
 60     static {
 61         try {
 62             S2I = MethodHandles.lookup().findStatic(TestAdaptVarHandles.class, &quot;stringToInt&quot;, MethodType.methodType(int.class, String.class));
 63             I2S = MethodHandles.lookup().findStatic(TestAdaptVarHandles.class, &quot;intToString&quot;, MethodType.methodType(String.class, int.class));


 64             S2L = MethodHandles.lookup().findStatic(TestAdaptVarHandles.class, &quot;stringToLong&quot;, MethodType.methodType(long.class, String.class));
 65             S2L_EX = MethodHandles.lookup().findStatic(TestAdaptVarHandles.class, &quot;stringToLongException&quot;, MethodType.methodType(long.class, String.class));
 66             BASE_ADDR = MethodHandles.lookup().findStatic(TestAdaptVarHandles.class, &quot;baseAddress&quot;, MethodType.methodType(MemoryAddress.class, MemorySegment.class));
 67             SUM_OFFSETS = MethodHandles.lookup().findStatic(TestAdaptVarHandles.class, &quot;sumOffsets&quot;, MethodType.methodType(long.class, long.class, long.class));
 68             VOID_FILTER = MethodHandles.lookup().findStatic(TestAdaptVarHandles.class, &quot;void_filter&quot;, MethodType.methodType(void.class, String.class));
 69 
 70             MethodHandle s2i_ex = MethodHandles.throwException(int.class, Throwable.class);
 71             s2i_ex = MethodHandles.insertArguments(s2i_ex, 0, new Throwable());
 72             S2I_EX = MethodHandles.dropArguments(s2i_ex, 0, String.class);
 73 
 74             MethodHandle i2s_ex = MethodHandles.throwException(String.class, Throwable.class);
 75             i2s_ex = MethodHandles.insertArguments(i2s_ex, 0, new Throwable());
 76             I2S_EX = MethodHandles.dropArguments(i2s_ex, 0, int.class);
 77         } catch (Throwable ex) {
 78             throw new ExceptionInInitializerError();
 79         }
 80     }
 81 
 82     @Test
 83     public void testFilterValue() throws Throwable {
 84         ValueLayout layout = MemoryLayouts.JAVA_INT;
 85         MemorySegment segment = MemorySegment.allocateNative(layout);
 86         VarHandle intHandle = layout.varHandle(int.class);
 87         VarHandle i2SHandle = MemoryHandles.filterValue(intHandle, S2I, I2S);
 88         i2SHandle.set(segment.baseAddress(), &quot;1&quot;);
 89         String oldValue = (String)i2SHandle.getAndAdd(segment.baseAddress(), &quot;42&quot;);
 90         assertEquals(oldValue, &quot;1&quot;);
 91         String value = (String)i2SHandle.get(segment.baseAddress());
 92         assertEquals(value, &quot;43&quot;);
 93         boolean swapped = (boolean)i2SHandle.compareAndSet(segment.baseAddress(), &quot;43&quot;, &quot;12&quot;);
 94         assertTrue(swapped);
 95         oldValue = (String)i2SHandle.compareAndExchange(segment.baseAddress(), &quot;12&quot;, &quot;42&quot;);
 96         assertEquals(oldValue, &quot;12&quot;);
 97         value = (String)i2SHandle.toMethodHandle(VarHandle.AccessMode.GET).invokeExact(segment.baseAddress());
 98         assertEquals(value, &quot;42&quot;);
 99     }
100 



















101     @Test(expectedExceptions = NullPointerException.class)
102     public void testBadFilterNullTarget() {
103         MemoryHandles.filterValue(null, S2I, I2S);
104     }
105 
106     @Test(expectedExceptions = NullPointerException.class)
107     public void testBadFilterNullUnbox() {
108         VarHandle intHandle = MemoryLayouts.JAVA_INT.varHandle(int.class);
109         MemoryHandles.filterValue(intHandle, null, I2S);
110     }
111 
112     @Test(expectedExceptions = NullPointerException.class)
113     public void testBadFilterNullBox() {
114         VarHandle intHandle = MemoryLayouts.JAVA_INT.varHandle(int.class);
115         MemoryHandles.filterValue(intHandle, S2I, null);
116     }
117 
118     @Test(expectedExceptions = IllegalArgumentException.class)
119     public void testBadFilterCarrier() {
120         VarHandle floatHandle = MemoryLayouts.JAVA_FLOAT.varHandle(float.class);
</pre>
</td>
<td>
<hr />
<pre>
 32  */
 33 
 34 import jdk.incubator.foreign.MemoryAddress;
 35 import jdk.incubator.foreign.MemoryHandles;
 36 import jdk.incubator.foreign.MemoryLayouts;
 37 import jdk.incubator.foreign.MemorySegment;
 38 import jdk.incubator.foreign.ValueLayout;
 39 import org.testng.annotations.*;
 40 import static org.testng.Assert.*;
 41 
 42 import java.lang.invoke.MethodHandle;
 43 import java.lang.invoke.MethodHandles;
 44 import java.lang.invoke.MethodType;
 45 import java.lang.invoke.VarHandle;
 46 import java.util.List;
 47 
 48 public class TestAdaptVarHandles {
 49 
 50     static MethodHandle S2I;
 51     static MethodHandle I2S;
<span class="line-added"> 52     static MethodHandle O2I;</span>
<span class="line-added"> 53     static MethodHandle I2O;</span>
 54     static MethodHandle S2L;
 55     static MethodHandle S2L_EX;
 56     static MethodHandle S2I_EX;
 57     static MethodHandle I2S_EX;
 58     static MethodHandle BASE_ADDR;
 59     static MethodHandle SUM_OFFSETS;
 60     static MethodHandle VOID_FILTER;
 61 
 62     static {
 63         try {
 64             S2I = MethodHandles.lookup().findStatic(TestAdaptVarHandles.class, &quot;stringToInt&quot;, MethodType.methodType(int.class, String.class));
 65             I2S = MethodHandles.lookup().findStatic(TestAdaptVarHandles.class, &quot;intToString&quot;, MethodType.methodType(String.class, int.class));
<span class="line-added"> 66             O2I = MethodHandles.explicitCastArguments(S2I, MethodType.methodType(int.class, Object.class));</span>
<span class="line-added"> 67             I2O = MethodHandles.explicitCastArguments(I2S, MethodType.methodType(Object.class, int.class));</span>
 68             S2L = MethodHandles.lookup().findStatic(TestAdaptVarHandles.class, &quot;stringToLong&quot;, MethodType.methodType(long.class, String.class));
 69             S2L_EX = MethodHandles.lookup().findStatic(TestAdaptVarHandles.class, &quot;stringToLongException&quot;, MethodType.methodType(long.class, String.class));
 70             BASE_ADDR = MethodHandles.lookup().findStatic(TestAdaptVarHandles.class, &quot;baseAddress&quot;, MethodType.methodType(MemoryAddress.class, MemorySegment.class));
 71             SUM_OFFSETS = MethodHandles.lookup().findStatic(TestAdaptVarHandles.class, &quot;sumOffsets&quot;, MethodType.methodType(long.class, long.class, long.class));
 72             VOID_FILTER = MethodHandles.lookup().findStatic(TestAdaptVarHandles.class, &quot;void_filter&quot;, MethodType.methodType(void.class, String.class));
 73 
 74             MethodHandle s2i_ex = MethodHandles.throwException(int.class, Throwable.class);
 75             s2i_ex = MethodHandles.insertArguments(s2i_ex, 0, new Throwable());
 76             S2I_EX = MethodHandles.dropArguments(s2i_ex, 0, String.class);
 77 
 78             MethodHandle i2s_ex = MethodHandles.throwException(String.class, Throwable.class);
 79             i2s_ex = MethodHandles.insertArguments(i2s_ex, 0, new Throwable());
 80             I2S_EX = MethodHandles.dropArguments(i2s_ex, 0, int.class);
 81         } catch (Throwable ex) {
 82             throw new ExceptionInInitializerError();
 83         }
 84     }
 85 
 86     @Test
 87     public void testFilterValue() throws Throwable {
 88         ValueLayout layout = MemoryLayouts.JAVA_INT;
 89         MemorySegment segment = MemorySegment.allocateNative(layout);
 90         VarHandle intHandle = layout.varHandle(int.class);
 91         VarHandle i2SHandle = MemoryHandles.filterValue(intHandle, S2I, I2S);
 92         i2SHandle.set(segment.baseAddress(), &quot;1&quot;);
 93         String oldValue = (String)i2SHandle.getAndAdd(segment.baseAddress(), &quot;42&quot;);
 94         assertEquals(oldValue, &quot;1&quot;);
 95         String value = (String)i2SHandle.get(segment.baseAddress());
 96         assertEquals(value, &quot;43&quot;);
 97         boolean swapped = (boolean)i2SHandle.compareAndSet(segment.baseAddress(), &quot;43&quot;, &quot;12&quot;);
 98         assertTrue(swapped);
 99         oldValue = (String)i2SHandle.compareAndExchange(segment.baseAddress(), &quot;12&quot;, &quot;42&quot;);
100         assertEquals(oldValue, &quot;12&quot;);
101         value = (String)i2SHandle.toMethodHandle(VarHandle.AccessMode.GET).invokeExact(segment.baseAddress());
102         assertEquals(value, &quot;42&quot;);
103     }
104 
<span class="line-added">105     @Test</span>
<span class="line-added">106     public void testFilterValueLoose() throws Throwable {</span>
<span class="line-added">107         ValueLayout layout = MemoryLayouts.JAVA_INT;</span>
<span class="line-added">108         MemorySegment segment = MemorySegment.allocateNative(layout);</span>
<span class="line-added">109         VarHandle intHandle = layout.varHandle(int.class);</span>
<span class="line-added">110         VarHandle i2SHandle = MemoryHandles.filterValue(intHandle, O2I, I2O);</span>
<span class="line-added">111         i2SHandle.set(segment.baseAddress(), &quot;1&quot;);</span>
<span class="line-added">112         String oldValue = (String)i2SHandle.getAndAdd(segment.baseAddress(), &quot;42&quot;);</span>
<span class="line-added">113         assertEquals(oldValue, &quot;1&quot;);</span>
<span class="line-added">114         String value = (String)i2SHandle.get(segment.baseAddress());</span>
<span class="line-added">115         assertEquals(value, &quot;43&quot;);</span>
<span class="line-added">116         boolean swapped = (boolean)i2SHandle.compareAndSet(segment.baseAddress(), &quot;43&quot;, &quot;12&quot;);</span>
<span class="line-added">117         assertTrue(swapped);</span>
<span class="line-added">118         oldValue = (String)i2SHandle.compareAndExchange(segment.baseAddress(), &quot;12&quot;, &quot;42&quot;);</span>
<span class="line-added">119         assertEquals(oldValue, &quot;12&quot;);</span>
<span class="line-added">120         value = (String)(Object)i2SHandle.toMethodHandle(VarHandle.AccessMode.GET).invokeExact(segment.baseAddress());</span>
<span class="line-added">121         assertEquals(value, &quot;42&quot;);</span>
<span class="line-added">122     }</span>
<span class="line-added">123 </span>
124     @Test(expectedExceptions = NullPointerException.class)
125     public void testBadFilterNullTarget() {
126         MemoryHandles.filterValue(null, S2I, I2S);
127     }
128 
129     @Test(expectedExceptions = NullPointerException.class)
130     public void testBadFilterNullUnbox() {
131         VarHandle intHandle = MemoryLayouts.JAVA_INT.varHandle(int.class);
132         MemoryHandles.filterValue(intHandle, null, I2S);
133     }
134 
135     @Test(expectedExceptions = NullPointerException.class)
136     public void testBadFilterNullBox() {
137         VarHandle intHandle = MemoryLayouts.JAVA_INT.varHandle(int.class);
138         MemoryHandles.filterValue(intHandle, S2I, null);
139     }
140 
141     @Test(expectedExceptions = IllegalArgumentException.class)
142     public void testBadFilterCarrier() {
143         VarHandle floatHandle = MemoryLayouts.JAVA_FLOAT.varHandle(float.class);
</pre>
</td>
</tr>
</table>
<center><a href="../../../../src/java.base/share/classes/java/lang/invoke/VarHandles.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> next &gt;</center>  </body>
</html>