<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/jdk.incubator.foreign/share/classes/jdk/incubator/foreign/CSupport.java</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
  </head>
<body>
<center>&lt; prev <a href="../../../../../../../index.html" target="_top">index</a> <a href="MemorySegment.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/jdk.incubator.foreign/share/classes/jdk/incubator/foreign/CSupport.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 28 import jdk.internal.foreign.AbstractMemorySegmentImpl;
 29 import jdk.internal.foreign.MemoryAddressImpl;
 30 import jdk.internal.foreign.NativeMemorySegmentImpl;
 31 import jdk.internal.foreign.Utils;
 32 import jdk.internal.foreign.abi.SharedUtils;
 33 
 34 import java.lang.invoke.VarHandle;
 35 import java.nio.ByteOrder;
 36 import java.nio.charset.Charset;
 37 import java.util.Objects;
 38 import java.util.function.Consumer;
 39 
 40 /**
 41  * A set of utilities for working with libraries using the C language/ABI
 42  */
 43 public class CSupport {
 44     /**
 45      * Obtain a linker that uses the de facto C ABI of the current system to do it&#39;s linking.
 46      * &lt;p&gt;
 47      * This method is &lt;em&gt;restricted&lt;/em&gt;. Restricted method are unsafe, and, if used incorrectly, their use might crash
<span class="line-modified"> 48      * the JVM crash or, worse, silently result in memory corruption. Thus, clients should refrain from depending on</span>
 49      * restricted methods, and use safe and supported functionalities, where possible.
 50      * @return a linker for this system.
 51      * @throws IllegalAccessError if the runtime property {@code foreign.restricted} is not set to either
 52      * {@code permit}, {@code warn} or {@code debug} (the default value is set to {@code deny}).
 53      */
 54     public static ForeignLinker getSystemLinker() {
 55         Utils.checkRestrictedAccess(&quot;CSupport.getSystemLinker&quot;);
 56         return SharedUtils.getSystemLinker();
 57     }
 58 
 59     /**
 60      * An interface that models a C {@code va_list}.
 61      *
 62      * Per the C specification (see C standard 6.5.2.2 Function calls - item 6),
 63      * arguments to variadic calls are erased by way of &#39;default argument promotions&#39;,
 64      * which erases integral types by way of integer promotion (see C standard 6.3.1.1 - item 2),
 65      * and which erases all {@code float} arguments to {@code double}.
 66      *
 67      * As such, this interface only supports reading {@code int}, {@code double},
 68      * and any other type that fits into a {@code long}.
</pre>
<hr />
<pre>
628      * @param scope the scope to be used for the native segment allocation.
629      * @return a new native memory segment containing the converted C string.
630      * @throws NullPointerException if either {@code str == null}, {@code charset == null} or {@code scope == null}.
631      */
632     public static MemoryAddress toCString(String str, Charset charset, NativeScope scope) {
633         Objects.requireNonNull(str);
634         Objects.requireNonNull(charset);
635         Objects.requireNonNull(scope);
636         return toCString(str.getBytes(charset), scope);
637     }
638 
639     /**
640      * Convert a null-terminated C string stored at given address into a Java string, using the platform&#39;s default charset.
641      * &lt;p&gt;
642      * This method always replaces malformed-input and unmappable-character
643      * sequences with this charset&#39;s default replacement string.  The {@link
644      * java.nio.charset.CharsetDecoder} class should be used when more control
645      * over the decoding process is required.
646      * &lt;p&gt;
647      * This method is &lt;em&gt;restricted&lt;/em&gt;. Restricted method are unsafe, and, if used incorrectly, their use might crash
<span class="line-modified">648      * the JVM crash or, worse, silently result in memory corruption. Thus, clients should refrain from depending on</span>
649      * restricted methods, and use safe and supported functionalities, where possible.
650      * @param addr the address at which the string is stored.
651      * @return a Java string with the contents of the null-terminated C string at given address.
652      * @throws NullPointerException if {@code addr == null}
653      * @throws IllegalArgumentException if the size of the native string is greater than {@code Integer.MAX_VALUE}.
654      */
655     public static String toJavaStringRestricted(MemoryAddress addr) {
656         Utils.checkRestrictedAccess(&quot;CSupport.toJavaStringRestricted&quot;);
657         return toJavaStringInternal(addr.rebase(AbstractMemorySegmentImpl.EVERYTHING), Charset.defaultCharset());
658     }
659 
660     /**
661      * Convert a null-terminated C string stored at given address into a Java string, using the given {@linkplain java.nio.charset.Charset charset}.
662      * &lt;p&gt;
663      * This method always replaces malformed-input and unmappable-character
664      * sequences with this charset&#39;s default replacement string.  The {@link
665      * java.nio.charset.CharsetDecoder} class should be used when more control
666      * over the decoding process is required.
667      * &lt;p&gt;
668      * This method is &lt;em&gt;restricted&lt;/em&gt;. Restricted method are unsafe, and, if used incorrectly, their use might crash
<span class="line-modified">669      * the JVM crash or, worse, silently result in memory corruption. Thus, clients should refrain from depending on</span>
670      * restricted methods, and use safe and supported functionalities, where possible.
671      * @param addr the address at which the string is stored.
672      * @param charset The {@linkplain java.nio.charset.Charset} to be used to compute the contents of the Java string.
673      * @return a Java string with the contents of the null-terminated C string at given address.
674      * @throws NullPointerException if {@code addr == null}
675      * @throws IllegalArgumentException if the size of the native string is greater than {@code Integer.MAX_VALUE}.
676      */
677     public static String toJavaStringRestricted(MemoryAddress addr, Charset charset) {
678         Utils.checkRestrictedAccess(&quot;CSupport.toJavaStringRestricted&quot;);
679         return toJavaStringInternal(addr.rebase(AbstractMemorySegmentImpl.EVERYTHING), charset);
680     }
681 
682     /**
683      * Convert a null-terminated C string stored at given address into a Java string, using the platform&#39;s default charset.
684      * &lt;p&gt;
685      * This method always replaces malformed-input and unmappable-character
686      * sequences with this charset&#39;s default replacement string.  The {@link
687      * java.nio.charset.CharsetDecoder} class should be used when more control
688      * over the decoding process is required.
689      * @param addr the address at which the string is stored.
</pre>
</td>
<td>
<hr />
<pre>
 28 import jdk.internal.foreign.AbstractMemorySegmentImpl;
 29 import jdk.internal.foreign.MemoryAddressImpl;
 30 import jdk.internal.foreign.NativeMemorySegmentImpl;
 31 import jdk.internal.foreign.Utils;
 32 import jdk.internal.foreign.abi.SharedUtils;
 33 
 34 import java.lang.invoke.VarHandle;
 35 import java.nio.ByteOrder;
 36 import java.nio.charset.Charset;
 37 import java.util.Objects;
 38 import java.util.function.Consumer;
 39 
 40 /**
 41  * A set of utilities for working with libraries using the C language/ABI
 42  */
 43 public class CSupport {
 44     /**
 45      * Obtain a linker that uses the de facto C ABI of the current system to do it&#39;s linking.
 46      * &lt;p&gt;
 47      * This method is &lt;em&gt;restricted&lt;/em&gt;. Restricted method are unsafe, and, if used incorrectly, their use might crash
<span class="line-modified"> 48      * the JVM or, worse, silently result in memory corruption. Thus, clients should refrain from depending on</span>
 49      * restricted methods, and use safe and supported functionalities, where possible.
 50      * @return a linker for this system.
 51      * @throws IllegalAccessError if the runtime property {@code foreign.restricted} is not set to either
 52      * {@code permit}, {@code warn} or {@code debug} (the default value is set to {@code deny}).
 53      */
 54     public static ForeignLinker getSystemLinker() {
 55         Utils.checkRestrictedAccess(&quot;CSupport.getSystemLinker&quot;);
 56         return SharedUtils.getSystemLinker();
 57     }
 58 
 59     /**
 60      * An interface that models a C {@code va_list}.
 61      *
 62      * Per the C specification (see C standard 6.5.2.2 Function calls - item 6),
 63      * arguments to variadic calls are erased by way of &#39;default argument promotions&#39;,
 64      * which erases integral types by way of integer promotion (see C standard 6.3.1.1 - item 2),
 65      * and which erases all {@code float} arguments to {@code double}.
 66      *
 67      * As such, this interface only supports reading {@code int}, {@code double},
 68      * and any other type that fits into a {@code long}.
</pre>
<hr />
<pre>
628      * @param scope the scope to be used for the native segment allocation.
629      * @return a new native memory segment containing the converted C string.
630      * @throws NullPointerException if either {@code str == null}, {@code charset == null} or {@code scope == null}.
631      */
632     public static MemoryAddress toCString(String str, Charset charset, NativeScope scope) {
633         Objects.requireNonNull(str);
634         Objects.requireNonNull(charset);
635         Objects.requireNonNull(scope);
636         return toCString(str.getBytes(charset), scope);
637     }
638 
639     /**
640      * Convert a null-terminated C string stored at given address into a Java string, using the platform&#39;s default charset.
641      * &lt;p&gt;
642      * This method always replaces malformed-input and unmappable-character
643      * sequences with this charset&#39;s default replacement string.  The {@link
644      * java.nio.charset.CharsetDecoder} class should be used when more control
645      * over the decoding process is required.
646      * &lt;p&gt;
647      * This method is &lt;em&gt;restricted&lt;/em&gt;. Restricted method are unsafe, and, if used incorrectly, their use might crash
<span class="line-modified">648      * the JVM or, worse, silently result in memory corruption. Thus, clients should refrain from depending on</span>
649      * restricted methods, and use safe and supported functionalities, where possible.
650      * @param addr the address at which the string is stored.
651      * @return a Java string with the contents of the null-terminated C string at given address.
652      * @throws NullPointerException if {@code addr == null}
653      * @throws IllegalArgumentException if the size of the native string is greater than {@code Integer.MAX_VALUE}.
654      */
655     public static String toJavaStringRestricted(MemoryAddress addr) {
656         Utils.checkRestrictedAccess(&quot;CSupport.toJavaStringRestricted&quot;);
657         return toJavaStringInternal(addr.rebase(AbstractMemorySegmentImpl.EVERYTHING), Charset.defaultCharset());
658     }
659 
660     /**
661      * Convert a null-terminated C string stored at given address into a Java string, using the given {@linkplain java.nio.charset.Charset charset}.
662      * &lt;p&gt;
663      * This method always replaces malformed-input and unmappable-character
664      * sequences with this charset&#39;s default replacement string.  The {@link
665      * java.nio.charset.CharsetDecoder} class should be used when more control
666      * over the decoding process is required.
667      * &lt;p&gt;
668      * This method is &lt;em&gt;restricted&lt;/em&gt;. Restricted method are unsafe, and, if used incorrectly, their use might crash
<span class="line-modified">669      * the JVM or, worse, silently result in memory corruption. Thus, clients should refrain from depending on</span>
670      * restricted methods, and use safe and supported functionalities, where possible.
671      * @param addr the address at which the string is stored.
672      * @param charset The {@linkplain java.nio.charset.Charset} to be used to compute the contents of the Java string.
673      * @return a Java string with the contents of the null-terminated C string at given address.
674      * @throws NullPointerException if {@code addr == null}
675      * @throws IllegalArgumentException if the size of the native string is greater than {@code Integer.MAX_VALUE}.
676      */
677     public static String toJavaStringRestricted(MemoryAddress addr, Charset charset) {
678         Utils.checkRestrictedAccess(&quot;CSupport.toJavaStringRestricted&quot;);
679         return toJavaStringInternal(addr.rebase(AbstractMemorySegmentImpl.EVERYTHING), charset);
680     }
681 
682     /**
683      * Convert a null-terminated C string stored at given address into a Java string, using the platform&#39;s default charset.
684      * &lt;p&gt;
685      * This method always replaces malformed-input and unmappable-character
686      * sequences with this charset&#39;s default replacement string.  The {@link
687      * java.nio.charset.CharsetDecoder} class should be used when more control
688      * over the decoding process is required.
689      * @param addr the address at which the string is stored.
</pre>
</td>
</tr>
</table>
<center>&lt; prev <a href="../../../../../../../index.html" target="_top">index</a> <a href="MemorySegment.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>