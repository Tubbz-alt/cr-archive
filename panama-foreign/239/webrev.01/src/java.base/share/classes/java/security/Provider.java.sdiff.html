<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/java.base/share/classes/java/security/Provider.java</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
  </head>
<body>
<center><a href="../net/NetworkInterface.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="../../javax/security/auth/Subject.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/java.base/share/classes/java/security/Provider.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 851         if (security != null) {
 852             security.checkSecurityAccess(directive);
 853         }
 854     }
 855 
 856     // legacy properties changed since last call to any services method?
 857     private transient boolean legacyChanged;
 858     // serviceMap changed since last call to getServices()
 859     private volatile transient boolean servicesChanged;
 860 
 861     // Map&lt;String,String&gt; used to keep track of legacy registration
 862     private transient Map&lt;String,String&gt; legacyStrings;
 863 
 864     // Map&lt;ServiceKey,Service&gt;
 865     // used for services added via putService(), initialized on demand
 866     private transient Map&lt;ServiceKey,Service&gt; serviceMap;
 867 
 868     // For backward compatibility, the registration ordering of
 869     // SecureRandom (RNG) algorithms needs to be preserved for
 870     // &quot;new SecureRandom()&quot; calls when this provider is used
<span class="line-modified"> 871     private transient Set&lt;Service&gt; prngServices;</span>
 872 
 873     // Map&lt;ServiceKey,Service&gt;
 874     // used for services added via legacy methods, init on demand
 875     private transient Map&lt;ServiceKey,Service&gt; legacyMap;
 876 
 877     // Set&lt;Service&gt;
 878     // Unmodifiable set of all services. Initialized on demand.
 879     private transient Set&lt;Service&gt; serviceSet;
 880 
 881     // register the id attributes for this provider
 882     // this is to ensure that equals() and hashCode() do not incorrectly
 883     // report to different provider objects as the same
 884     private void putId() {
 885         // note: name and info may be null
 886         super.put(&quot;Provider.id name&quot;, String.valueOf(name));
 887         super.put(&quot;Provider.id version&quot;, String.valueOf(versionStr));
 888         super.put(&quot;Provider.id info&quot;, String.valueOf(info));
 889         super.put(&quot;Provider.id className&quot;, this.getClass().getName());
 890     }
 891 
</pre>
<hr />
<pre>
1072         if ((key instanceof String) &amp;&amp; (value instanceof String)) {
1073             if (!checkLegacy(key)) {
1074                 return null;
1075             }
1076             legacyStrings.putIfAbsent((String)key, (String)value);
1077         }
1078         return super.putIfAbsent(key, value);
1079     }
1080 
1081     private void implClear() {
1082         if (legacyStrings != null) {
1083             legacyStrings.clear();
1084         }
1085         if (legacyMap != null) {
1086             legacyMap.clear();
1087         }
1088         serviceMap.clear();
1089         legacyChanged = false;
1090         servicesChanged = false;
1091         serviceSet = null;
<span class="line-modified">1092         prngServices = null;</span>
1093         super.clear();
1094         putId();
1095     }
1096 
1097     // used as key in the serviceMap and legacyMap HashMaps
1098     private static class ServiceKey {
1099         private final String type;
1100         private final String algorithm;
1101         private final String originalAlgorithm;
1102         private ServiceKey(String type, String algorithm, boolean intern) {
1103             this.type = type;
1104             this.originalAlgorithm = algorithm;
1105             algorithm = algorithm.toUpperCase(ENGLISH);
1106             this.algorithm = intern ? algorithm.intern() : algorithm;
1107         }
1108         public int hashCode() {
1109             return Objects.hash(type, algorithm);
1110         }
1111         public boolean equals(Object obj) {
1112             if (this == obj) {
</pre>
<hr />
<pre>
1204             if (typeAndAlg == null) {
1205                 return;
1206             }
1207             int i = typeAndAlg[1].indexOf(&#39; &#39;);
1208             if (i == -1) {
1209                 // e.g. put(&quot;MessageDigest.SHA-1&quot;, &quot;sun.security.provider.SHA&quot;);
1210                 String type = getEngineName(typeAndAlg[0]);
1211                 String stdAlg = typeAndAlg[1].intern();
1212                 String className = value;
1213                 ServiceKey key = new ServiceKey(type, stdAlg, true);
1214                 Service s = legacyMap.get(key);
1215                 if (s == null) {
1216                     s = new Service(this);
1217                     s.type = type;
1218                     s.algorithm = stdAlg;
1219                     legacyMap.put(key, s);
1220                 }
1221                 s.className = className;
1222 
1223                 if (type.equals(&quot;SecureRandom&quot;)) {
<span class="line-modified">1224                     updateSecureRandomEntries(true, s);</span>
1225                 }
1226             } else { // attribute
1227                 // e.g. put(&quot;MessageDigest.SHA-1 ImplementedIn&quot;, &quot;Software&quot;);
1228                 String attributeValue = value;
1229                 String type = getEngineName(typeAndAlg[0]);
1230                 String attributeString = typeAndAlg[1];
1231                 String stdAlg = attributeString.substring(0, i).intern();
1232                 String attributeName = attributeString.substring(i + 1);
1233                 // kill additional spaces
1234                 while (attributeName.startsWith(&quot; &quot;)) {
1235                     attributeName = attributeName.substring(1);
1236                 }
1237                 attributeName = attributeName.intern();
1238                 ServiceKey key = new ServiceKey(type, stdAlg, true);
1239                 Service s = legacyMap.get(key);
1240                 if (s == null) {
1241                     s = new Service(this);
1242                     s.type = type;
1243                     s.algorithm = stdAlg;
1244                     legacyMap.put(key, s);
</pre>
<hr />
<pre>
1366         }
1367         if (s == null) {
1368             throw new NullPointerException();
1369         }
1370         if (s.getProvider() != this) {
1371             throw new IllegalArgumentException
1372                     (&quot;service.getProvider() must match this Provider object&quot;);
1373         }
1374         String type = s.getType();
1375         String algorithm = s.getAlgorithm();
1376         ServiceKey key = new ServiceKey(type, algorithm, true);
1377         implRemoveService(serviceMap.get(key));
1378         serviceMap.put(key, s);
1379         for (String alias : s.getAliases()) {
1380             serviceMap.put(new ServiceKey(type, alias, true), s);
1381         }
1382         servicesChanged = true;
1383         synchronized (this) {
1384             putPropertyStrings(s);
1385             if (type.equals(&quot;SecureRandom&quot;)) {
<span class="line-modified">1386                 updateSecureRandomEntries(true, s);</span>
1387             }
1388         }
1389     }
1390 
<span class="line-modified">1391     private void updateSecureRandomEntries(boolean doAdd, Service s) {</span>

1392         Objects.requireNonNull(s);
1393         if (doAdd) {
<span class="line-modified">1394             if (prngServices == null) {</span>
<span class="line-modified">1395                 prngServices = new LinkedHashSet&lt;Service&gt;();</span>
1396             }
<span class="line-modified">1397             prngServices.add(s);</span>
1398         } else {
<span class="line-modified">1399             prngServices.remove(s);</span>
1400         }
1401 
1402         if (debug != null) {
<span class="line-modified">1403             debug.println((doAdd? &quot;Add&quot;:&quot;Remove&quot;) + &quot; SecureRandom algo &quot; +</span>
<span class="line-removed">1404                 s.getAlgorithm());</span>
1405         }
1406     }
1407 
1408     // used by new SecureRandom() to find out the default SecureRandom
1409     // service for this provider
1410     synchronized Service getDefaultSecureRandomService() {
1411         checkInitialized();
1412 
1413         if (legacyChanged) {
<span class="line-modified">1414             prngServices = null;</span>
1415             ensureLegacyParsed();
1416         }
1417 
<span class="line-modified">1418         if (prngServices != null &amp;&amp; !prngServices.isEmpty()) {</span>
<span class="line-modified">1419             return prngServices.iterator().next();</span>



1420         }
1421 
1422         return null;
1423     }
1424 
1425     /**
1426      * Put the string properties for this Service in this Provider&#39;s
1427      * Hashtable.
1428      */
1429     private void putPropertyStrings(Service s) {
1430         String type = s.getType();
1431         String algorithm = s.getAlgorithm();
1432         // use super() to avoid permission check and other processing
1433         super.put(type + &quot;.&quot; + algorithm, s.getClassName());
1434         for (String alias : s.getAliases()) {
1435             super.put(ALIAS_PREFIX + type + &quot;.&quot; + alias, algorithm);
1436         }
1437         for (Map.Entry&lt;UString,String&gt; entry : s.attributes.entrySet()) {
1438             String key = type + &quot;.&quot; + algorithm + &quot; &quot; + entry.getKey();
1439             super.put(key, entry.getValue());
</pre>
<hr />
<pre>
1499 
1500     private void implRemoveService(Service s) {
1501         if ((s == null) || serviceMap.isEmpty()) {
1502             return;
1503         }
1504         String type = s.getType();
1505         String algorithm = s.getAlgorithm();
1506         ServiceKey key = new ServiceKey(type, algorithm, false);
1507         Service oldService = serviceMap.get(key);
1508         if (s != oldService) {
1509             return;
1510         }
1511         servicesChanged = true;
1512         serviceMap.remove(key);
1513         for (String alias : s.getAliases()) {
1514             serviceMap.remove(new ServiceKey(type, alias, false));
1515         }
1516         synchronized (this) {
1517             removePropertyStrings(s);
1518             if (type.equals(&quot;SecureRandom&quot;)) {
<span class="line-modified">1519                 updateSecureRandomEntries(false, s);</span>
1520             }
1521         }
1522     }
1523 
1524     // Wrapped String that behaves in a case insensitive way for equals/hashCode
1525     private static class UString {
1526         final String string;
1527         final String lowerString;
1528 
1529         UString(String s) {
1530             this.string = s;
1531             this.lowerString = s.toLowerCase(ENGLISH);
1532         }
1533 
1534         public int hashCode() {
1535             return lowerString.hashCode();
1536         }
1537 
1538         public boolean equals(Object obj) {
1539             if (this == obj) {
</pre>
</td>
<td>
<hr />
<pre>
 851         if (security != null) {
 852             security.checkSecurityAccess(directive);
 853         }
 854     }
 855 
 856     // legacy properties changed since last call to any services method?
 857     private transient boolean legacyChanged;
 858     // serviceMap changed since last call to getServices()
 859     private volatile transient boolean servicesChanged;
 860 
 861     // Map&lt;String,String&gt; used to keep track of legacy registration
 862     private transient Map&lt;String,String&gt; legacyStrings;
 863 
 864     // Map&lt;ServiceKey,Service&gt;
 865     // used for services added via putService(), initialized on demand
 866     private transient Map&lt;ServiceKey,Service&gt; serviceMap;
 867 
 868     // For backward compatibility, the registration ordering of
 869     // SecureRandom (RNG) algorithms needs to be preserved for
 870     // &quot;new SecureRandom()&quot; calls when this provider is used
<span class="line-modified"> 871     private transient Set&lt;String&gt; prngAlgos;</span>
 872 
 873     // Map&lt;ServiceKey,Service&gt;
 874     // used for services added via legacy methods, init on demand
 875     private transient Map&lt;ServiceKey,Service&gt; legacyMap;
 876 
 877     // Set&lt;Service&gt;
 878     // Unmodifiable set of all services. Initialized on demand.
 879     private transient Set&lt;Service&gt; serviceSet;
 880 
 881     // register the id attributes for this provider
 882     // this is to ensure that equals() and hashCode() do not incorrectly
 883     // report to different provider objects as the same
 884     private void putId() {
 885         // note: name and info may be null
 886         super.put(&quot;Provider.id name&quot;, String.valueOf(name));
 887         super.put(&quot;Provider.id version&quot;, String.valueOf(versionStr));
 888         super.put(&quot;Provider.id info&quot;, String.valueOf(info));
 889         super.put(&quot;Provider.id className&quot;, this.getClass().getName());
 890     }
 891 
</pre>
<hr />
<pre>
1072         if ((key instanceof String) &amp;&amp; (value instanceof String)) {
1073             if (!checkLegacy(key)) {
1074                 return null;
1075             }
1076             legacyStrings.putIfAbsent((String)key, (String)value);
1077         }
1078         return super.putIfAbsent(key, value);
1079     }
1080 
1081     private void implClear() {
1082         if (legacyStrings != null) {
1083             legacyStrings.clear();
1084         }
1085         if (legacyMap != null) {
1086             legacyMap.clear();
1087         }
1088         serviceMap.clear();
1089         legacyChanged = false;
1090         servicesChanged = false;
1091         serviceSet = null;
<span class="line-modified">1092         prngAlgos = null;</span>
1093         super.clear();
1094         putId();
1095     }
1096 
1097     // used as key in the serviceMap and legacyMap HashMaps
1098     private static class ServiceKey {
1099         private final String type;
1100         private final String algorithm;
1101         private final String originalAlgorithm;
1102         private ServiceKey(String type, String algorithm, boolean intern) {
1103             this.type = type;
1104             this.originalAlgorithm = algorithm;
1105             algorithm = algorithm.toUpperCase(ENGLISH);
1106             this.algorithm = intern ? algorithm.intern() : algorithm;
1107         }
1108         public int hashCode() {
1109             return Objects.hash(type, algorithm);
1110         }
1111         public boolean equals(Object obj) {
1112             if (this == obj) {
</pre>
<hr />
<pre>
1204             if (typeAndAlg == null) {
1205                 return;
1206             }
1207             int i = typeAndAlg[1].indexOf(&#39; &#39;);
1208             if (i == -1) {
1209                 // e.g. put(&quot;MessageDigest.SHA-1&quot;, &quot;sun.security.provider.SHA&quot;);
1210                 String type = getEngineName(typeAndAlg[0]);
1211                 String stdAlg = typeAndAlg[1].intern();
1212                 String className = value;
1213                 ServiceKey key = new ServiceKey(type, stdAlg, true);
1214                 Service s = legacyMap.get(key);
1215                 if (s == null) {
1216                     s = new Service(this);
1217                     s.type = type;
1218                     s.algorithm = stdAlg;
1219                     legacyMap.put(key, s);
1220                 }
1221                 s.className = className;
1222 
1223                 if (type.equals(&quot;SecureRandom&quot;)) {
<span class="line-modified">1224                     updateSecureRandomEntries(true, s.algorithm);</span>
1225                 }
1226             } else { // attribute
1227                 // e.g. put(&quot;MessageDigest.SHA-1 ImplementedIn&quot;, &quot;Software&quot;);
1228                 String attributeValue = value;
1229                 String type = getEngineName(typeAndAlg[0]);
1230                 String attributeString = typeAndAlg[1];
1231                 String stdAlg = attributeString.substring(0, i).intern();
1232                 String attributeName = attributeString.substring(i + 1);
1233                 // kill additional spaces
1234                 while (attributeName.startsWith(&quot; &quot;)) {
1235                     attributeName = attributeName.substring(1);
1236                 }
1237                 attributeName = attributeName.intern();
1238                 ServiceKey key = new ServiceKey(type, stdAlg, true);
1239                 Service s = legacyMap.get(key);
1240                 if (s == null) {
1241                     s = new Service(this);
1242                     s.type = type;
1243                     s.algorithm = stdAlg;
1244                     legacyMap.put(key, s);
</pre>
<hr />
<pre>
1366         }
1367         if (s == null) {
1368             throw new NullPointerException();
1369         }
1370         if (s.getProvider() != this) {
1371             throw new IllegalArgumentException
1372                     (&quot;service.getProvider() must match this Provider object&quot;);
1373         }
1374         String type = s.getType();
1375         String algorithm = s.getAlgorithm();
1376         ServiceKey key = new ServiceKey(type, algorithm, true);
1377         implRemoveService(serviceMap.get(key));
1378         serviceMap.put(key, s);
1379         for (String alias : s.getAliases()) {
1380             serviceMap.put(new ServiceKey(type, alias, true), s);
1381         }
1382         servicesChanged = true;
1383         synchronized (this) {
1384             putPropertyStrings(s);
1385             if (type.equals(&quot;SecureRandom&quot;)) {
<span class="line-modified">1386                 updateSecureRandomEntries(true, s.algorithm);</span>
1387             }
1388         }
1389     }
1390 
<span class="line-modified">1391     // keep tracks of the registered secure random algos and store them in order</span>
<span class="line-added">1392     private void updateSecureRandomEntries(boolean doAdd, String s) {</span>
1393         Objects.requireNonNull(s);
1394         if (doAdd) {
<span class="line-modified">1395             if (prngAlgos == null) {</span>
<span class="line-modified">1396                 prngAlgos = new LinkedHashSet&lt;String&gt;();</span>
1397             }
<span class="line-modified">1398             prngAlgos.add(s);</span>
1399         } else {
<span class="line-modified">1400             prngAlgos.remove(s);</span>
1401         }
1402 
1403         if (debug != null) {
<span class="line-modified">1404             debug.println((doAdd? &quot;Add&quot;:&quot;Remove&quot;) + &quot; SecureRandom algo &quot; + s);</span>

1405         }
1406     }
1407 
1408     // used by new SecureRandom() to find out the default SecureRandom
1409     // service for this provider
1410     synchronized Service getDefaultSecureRandomService() {
1411         checkInitialized();
1412 
1413         if (legacyChanged) {
<span class="line-modified">1414             prngAlgos = null;</span>
1415             ensureLegacyParsed();
1416         }
1417 
<span class="line-modified">1418         if (prngAlgos != null &amp;&amp; !prngAlgos.isEmpty()) {</span>
<span class="line-modified">1419             // IMPORTANT: use the Service obj returned by getService(...) call</span>
<span class="line-added">1420             // as providers may override putService(...)/getService(...) and</span>
<span class="line-added">1421             // return their own Service objects</span>
<span class="line-added">1422             return getService(&quot;SecureRandom&quot;, prngAlgos.iterator().next());</span>
1423         }
1424 
1425         return null;
1426     }
1427 
1428     /**
1429      * Put the string properties for this Service in this Provider&#39;s
1430      * Hashtable.
1431      */
1432     private void putPropertyStrings(Service s) {
1433         String type = s.getType();
1434         String algorithm = s.getAlgorithm();
1435         // use super() to avoid permission check and other processing
1436         super.put(type + &quot;.&quot; + algorithm, s.getClassName());
1437         for (String alias : s.getAliases()) {
1438             super.put(ALIAS_PREFIX + type + &quot;.&quot; + alias, algorithm);
1439         }
1440         for (Map.Entry&lt;UString,String&gt; entry : s.attributes.entrySet()) {
1441             String key = type + &quot;.&quot; + algorithm + &quot; &quot; + entry.getKey();
1442             super.put(key, entry.getValue());
</pre>
<hr />
<pre>
1502 
1503     private void implRemoveService(Service s) {
1504         if ((s == null) || serviceMap.isEmpty()) {
1505             return;
1506         }
1507         String type = s.getType();
1508         String algorithm = s.getAlgorithm();
1509         ServiceKey key = new ServiceKey(type, algorithm, false);
1510         Service oldService = serviceMap.get(key);
1511         if (s != oldService) {
1512             return;
1513         }
1514         servicesChanged = true;
1515         serviceMap.remove(key);
1516         for (String alias : s.getAliases()) {
1517             serviceMap.remove(new ServiceKey(type, alias, false));
1518         }
1519         synchronized (this) {
1520             removePropertyStrings(s);
1521             if (type.equals(&quot;SecureRandom&quot;)) {
<span class="line-modified">1522                 updateSecureRandomEntries(false, s.algorithm);</span>
1523             }
1524         }
1525     }
1526 
1527     // Wrapped String that behaves in a case insensitive way for equals/hashCode
1528     private static class UString {
1529         final String string;
1530         final String lowerString;
1531 
1532         UString(String s) {
1533             this.string = s;
1534             this.lowerString = s.toLowerCase(ENGLISH);
1535         }
1536 
1537         public int hashCode() {
1538             return lowerString.hashCode();
1539         }
1540 
1541         public boolean equals(Object obj) {
1542             if (this == obj) {
</pre>
</td>
</tr>
</table>
<center><a href="../net/NetworkInterface.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="../../javax/security/auth/Subject.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>