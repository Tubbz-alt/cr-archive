<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/java.base/share/classes/javax/security/auth/Subject.java</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
  </head>
<body>
<center><a href="../../../java/security/Provider.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="../../../sun/security/tools/keytool/Resources_ja.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/java.base/share/classes/javax/security/auth/Subject.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
   1 /*
<span class="line-modified">   2  * Copyright (c) 1998, 2019, Oracle and/or its affiliates. All rights reserved.</span>
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.  Oracle designates this
   8  * particular file as subject to the &quot;Classpath&quot; exception as provided
   9  * by Oracle in the LICENSE file that accompanied this code.
  10  *
  11  * This code is distributed in the hope that it will be useful, but WITHOUT
  12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  14  * version 2 for more details (a copy is included in the LICENSE file that
  15  * accompanied this code).
  16  *
  17  * You should have received a copy of the GNU General Public License version
  18  * 2 along with this work; if not, write to the Free Software Foundation,
  19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  20  *
  21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  22  * or visit www.oracle.com if you need additional information or have any
</pre>
<hr />
<pre>
 186      *
 187      * @param readOnly true if the {@code Subject} is to be read-only,
 188      *          and false otherwise.
 189      *
 190      * @param principals the {@code Set} of Principals
 191      *          to be associated with this {@code Subject}.
 192      *
 193      * @param pubCredentials the {@code Set} of public credentials
 194      *          to be associated with this {@code Subject}.
 195      *
 196      * @param privCredentials the {@code Set} of private credentials
 197      *          to be associated with this {@code Subject}.
 198      *
 199      * @throws NullPointerException if the specified
 200      *          {@code principals}, {@code pubCredentials},
 201      *          or {@code privCredentials} are {@code null},
 202      *          or a null value exists within any of these three
 203      *          Sets.
 204      */
 205     public Subject(boolean readOnly, Set&lt;? extends Principal&gt; principals,
<span class="line-modified"> 206                    Set&lt;?&gt; pubCredentials, Set&lt;?&gt; privCredentials)</span>
<span class="line-modified"> 207     {</span>
<span class="line-modified"> 208         collectionNullClean(principals);</span>
<span class="line-modified"> 209         collectionNullClean(pubCredentials);</span>
<span class="line-modified"> 210         collectionNullClean(privCredentials);</span>
<span class="line-modified"> 211 </span>
<span class="line-modified"> 212         this.principals = Collections.synchronizedSet(new SecureSet&lt;&gt;</span>
<span class="line-modified"> 213                                 (this, PRINCIPAL_SET, principals));</span>
<span class="line-modified"> 214         this.pubCredentials = Collections.synchronizedSet(new SecureSet&lt;&gt;</span>
<span class="line-modified"> 215                                 (this, PUB_CREDENTIAL_SET, pubCredentials));</span>
<span class="line-modified"> 216         this.privCredentials = Collections.synchronizedSet(new SecureSet&lt;&gt;</span>
<span class="line-modified"> 217                                 (this, PRIV_CREDENTIAL_SET, privCredentials));</span>


 218         this.readOnly = readOnly;
 219     }
 220 
 221     /**
 222      * Set this {@code Subject} to be read-only.
 223      *
 224      * &lt;p&gt; Modifications (additions and removals) to this Subject&#39;s
 225      * {@code Principal} {@code Set} and
 226      * credential Sets will be disallowed.
 227      * The {@code destroy} operation on this Subject&#39;s credentials will
 228      * still be permitted.
 229      *
 230      * &lt;p&gt; Subsequent attempts to modify the Subject&#39;s {@code Principal}
 231      * and credential Sets will result in an
 232      * {@code IllegalStateException} being thrown.
 233      * Also, once a {@code Subject} is read-only,
 234      * it can not be reset to being writable again.
 235      *
 236      * @throws SecurityException if a security manager is installed and the
 237      *         caller does not have an
</pre>
<hr />
<pre>
 958 
 959     /**
 960      * Reads this object from a stream (i.e., deserializes it)
 961      */
 962     @SuppressWarnings(&quot;unchecked&quot;)
 963     @java.io.Serial
 964     private void readObject(java.io.ObjectInputStream s)
 965                 throws java.io.IOException, ClassNotFoundException {
 966 
 967         ObjectInputStream.GetField gf = s.readFields();
 968 
 969         readOnly = gf.get(&quot;readOnly&quot;, false);
 970 
 971         Set&lt;Principal&gt; inputPrincs = (Set&lt;Principal&gt;)gf.get(&quot;principals&quot;, null);
 972 
 973         Objects.requireNonNull(inputPrincs,
 974                 ResourcesMgr.getString(&quot;invalid.null.input.s.&quot;));
 975 
 976         // Rewrap the principals into a SecureSet
 977         try {

 978             principals = Collections.synchronizedSet(new SecureSet&lt;&gt;
<span class="line-modified"> 979                                 (this, PRINCIPAL_SET, inputPrincs));</span>
 980         } catch (NullPointerException npe) {
 981             // Sometimes people deserialize the principals set only.
 982             // Subject is not accessible, so just don&#39;t fail.
 983             principals = Collections.synchronizedSet
 984                         (new SecureSet&lt;&gt;(this, PRINCIPAL_SET));
 985         }
 986 
 987         // The Credential {@code Set} is not serialized, but we do not
 988         // want the default deserialization routine to set it to null.
 989         this.pubCredentials = Collections.synchronizedSet
 990                         (new SecureSet&lt;&gt;(this, PUB_CREDENTIAL_SET));
 991         this.privCredentials = Collections.synchronizedSet
 992                         (new SecureSet&lt;&gt;(this, PRIV_CREDENTIAL_SET));
 993     }
 994 
 995     /**
 996      * Tests for null-clean collections (both non-null reference and
 997      * no null elements)
 998      *
 999      * @param coll A {@code Collection} to be tested for null references
1000      *
1001      * @throws NullPointerException if the specified collection is either
1002      *            {@code null} or contains a {@code null} element
1003      */
<span class="line-modified">1004     private static void collectionNullClean(Collection&lt;?&gt; coll) {</span>
<span class="line-modified">1005         boolean hasNullElements = false;</span>
1006 
1007         Objects.requireNonNull(coll,
1008                 ResourcesMgr.getString(&quot;invalid.null.input.s.&quot;));
1009 
<span class="line-modified">1010         try {</span>
<span class="line-modified">1011             hasNullElements = coll.contains(null);</span>
<span class="line-modified">1012         } catch (NullPointerException npe) {</span>
<span class="line-modified">1013             // A null-hostile collection may choose to throw</span>
<span class="line-removed">1014             // NullPointerException if contains(null) is called on it</span>
<span class="line-removed">1015             // rather than returning false.</span>
<span class="line-removed">1016             // If this happens we know the collection is null-clean.</span>
<span class="line-removed">1017             hasNullElements = false;</span>
<span class="line-removed">1018         } finally {</span>
<span class="line-removed">1019             if (hasNullElements) {</span>
<span class="line-removed">1020                 throw new NullPointerException</span>
<span class="line-removed">1021                     (ResourcesMgr.getString(&quot;invalid.null.input.s.&quot;));</span>
<span class="line-removed">1022             }</span>
1023         }

1024     }
1025 
1026     /**
1027      * Prevent modifications unless caller has permission.
1028      *
1029      * @serial include
1030      */
1031     private static class SecureSet&lt;E&gt;
1032         implements Set&lt;E&gt;, java.io.Serializable {
1033 
1034         @java.io.Serial
1035         private static final long serialVersionUID = 7911754171111800359L;
1036 
1037         /**
1038          * @serialField this$0 Subject The outer Subject instance.
1039          * @serialField elements LinkedList The elements in this set.
1040          */
1041         @java.io.Serial
1042         private static final ObjectStreamField[] serialPersistentFields = {
1043             new ObjectStreamField(&quot;this$0&quot;, Subject.class),
</pre>
<hr />
<pre>
1049         LinkedList&lt;E&gt; elements;
1050 
1051         /**
1052          * @serial An integer identifying the type of objects contained
1053          *      in this set.  If {@code which == 1},
1054          *      this is a Principal set and all the elements are
1055          *      of type {@code java.security.Principal}.
1056          *      If {@code which == 2}, this is a public credential
1057          *      set and all the elements are of type {@code Object}.
1058          *      If {@code which == 3}, this is a private credential
1059          *      set and all the elements are of type {@code Object}.
1060          */
1061         private int which;
1062 
1063         SecureSet(Subject subject, int which) {
1064             this.subject = subject;
1065             this.which = which;
1066             this.elements = new LinkedList&lt;E&gt;();
1067         }
1068 
<span class="line-modified">1069         SecureSet(Subject subject, int which, Set&lt;? extends E&gt; set) {</span>
1070             this.subject = subject;
1071             this.which = which;
<span class="line-modified">1072             this.elements = new LinkedList&lt;E&gt;(set);</span>
1073         }
1074 
1075         public int size() {
1076             return elements.size();
1077         }
1078 
1079         public Iterator&lt;E&gt; iterator() {
1080             final LinkedList&lt;E&gt; list = elements;
1081             return new Iterator&lt;E&gt;() {
1082                 ListIterator&lt;E&gt; i = list.listIterator(0);
1083 
1084                 public boolean hasNext() {return i.hasNext();}
1085 
1086                 public E next() {
1087                     if (which != Subject.PRIV_CREDENTIAL_SET) {
1088                         return i.next();
1089                     }
1090 
1091                     SecurityManager sm = System.getSecurityManager();
1092                     if (sm != null) {
</pre>
<hr />
<pre>
1225                                                 subject.getPrincipals()));
1226                     }
1227                     next = java.security.AccessController.doPrivileged
1228                         (new java.security.PrivilegedAction&lt;E&gt;() {
1229                         public E run() {
1230                             return e.next();
1231                         }
1232                     });
1233                 }
1234 
1235                 if (next.equals(o)) {
1236                     return true;
1237                 }
1238             }
1239             return false;
1240         }
1241 
1242         public boolean addAll(Collection&lt;? extends E&gt; c) {
1243             boolean result = false;
1244 
<span class="line-modified">1245             collectionNullClean(c);</span>
1246 
1247             for (E item : c) {
1248                 result |= this.add(item);
1249             }
1250 
1251             return result;
1252         }
1253 
1254         public boolean removeAll(Collection&lt;?&gt; c) {
<span class="line-modified">1255             collectionNullClean(c);</span>
1256 
1257             boolean modified = false;
1258             final Iterator&lt;E&gt; e = iterator();
1259             while (e.hasNext()) {
1260                 E next;
1261                 if (which != Subject.PRIV_CREDENTIAL_SET) {
1262                     next = e.next();
1263                 } else {
1264                     next = java.security.AccessController.doPrivileged
1265                         (new java.security.PrivilegedAction&lt;E&gt;() {
1266                         public E run() {
1267                             return e.next();
1268                         }
1269                     });
1270                 }
1271 
1272                 Iterator&lt;?&gt; ce = c.iterator();
1273                 while (ce.hasNext()) {
1274                     if (next.equals(ce.next())) {
1275                             e.remove();
1276                             modified = true;
1277                             break;
1278                         }
1279                 }
1280             }
1281             return modified;
1282         }
1283 
1284         public boolean containsAll(Collection&lt;?&gt; c) {
<span class="line-modified">1285             collectionNullClean(c);</span>
1286 
1287             for (Object item : c) {
1288                 if (this.contains(item) == false) {
1289                     return false;
1290                 }
1291             }
1292 
1293             return true;
1294         }
1295 
1296         public boolean retainAll(Collection&lt;?&gt; c) {
<span class="line-modified">1297             collectionNullClean(c);</span>
1298 
1299             boolean modified = false;
1300             final Iterator&lt;E&gt; e = iterator();
1301             while (e.hasNext()) {
1302                 E next;
1303                 if (which != Subject.PRIV_CREDENTIAL_SET) {
1304                     next = e.next();
1305                 } else {
1306                     next = java.security.AccessController.doPrivileged
1307                         (new java.security.PrivilegedAction&lt;E&gt;() {
1308                         public E run() {
1309                             return e.next();
1310                         }
1311                     });
1312                 }
1313 
1314                 if (c.contains(next) == false) {
1315                     e.remove();
1316                     modified = true;
<span class="line-removed">1317                     }</span>
1318                 }

1319 
1320             return modified;
1321         }
1322 
1323         public void clear() {
1324             final Iterator&lt;E&gt; e = iterator();
1325             while (e.hasNext()) {
1326                 E next;
1327                 if (which != Subject.PRIV_CREDENTIAL_SET) {
1328                     next = e.next();
1329                 } else {
1330                     next = java.security.AccessController.doPrivileged
1331                         (new java.security.PrivilegedAction&lt;E&gt;() {
1332                         public E run() {
1333                             return e.next();
1334                         }
1335                     });
1336                 }
1337                 e.remove();
1338             }
</pre>
<hr />
<pre>
1426                 }
1427             }
1428             ObjectOutputStream.PutField fields = oos.putFields();
1429             fields.put(&quot;this$0&quot;, subject);
1430             fields.put(&quot;elements&quot;, elements);
1431             fields.put(&quot;which&quot;, which);
1432             oos.writeFields();
1433         }
1434 
1435         @SuppressWarnings(&quot;unchecked&quot;)
1436         @java.io.Serial
1437         private void readObject(ObjectInputStream ois)
1438             throws IOException, ClassNotFoundException
1439         {
1440             ObjectInputStream.GetField fields = ois.readFields();
1441             subject = (Subject) fields.get(&quot;this$0&quot;, null);
1442             which = fields.get(&quot;which&quot;, 0);
1443 
1444             LinkedList&lt;E&gt; tmp = (LinkedList&lt;E&gt;) fields.get(&quot;elements&quot;, null);
1445 
<span class="line-modified">1446             Subject.collectionNullClean(tmp);</span>
<span class="line-removed">1447 </span>
<span class="line-removed">1448             if (tmp.getClass() != LinkedList.class) {</span>
<span class="line-removed">1449                 elements = new LinkedList&lt;E&gt;(tmp);</span>
<span class="line-removed">1450             } else {</span>
<span class="line-removed">1451                 elements = tmp;</span>
<span class="line-removed">1452             }</span>
1453         }
1454 
1455     }
1456 
1457     /**
1458      * This class implements a {@code Set} which returns only
1459      * members that are an instance of a specified Class.
1460      */
1461     private class ClassSet&lt;T&gt; extends AbstractSet&lt;T&gt; {
1462 
1463         private int which;
1464         private Class&lt;T&gt; c;
1465         private Set&lt;T&gt; set;
1466 
1467         ClassSet(int which, Class&lt;T&gt; c) {
1468             this.which = which;
1469             this.c = c;
1470             set = new HashSet&lt;T&gt;();
1471 
1472             switch (which) {
</pre>
</td>
<td>
<hr />
<pre>
   1 /*
<span class="line-modified">   2  * Copyright (c) 1998, 2020, Oracle and/or its affiliates. All rights reserved.</span>
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.  Oracle designates this
   8  * particular file as subject to the &quot;Classpath&quot; exception as provided
   9  * by Oracle in the LICENSE file that accompanied this code.
  10  *
  11  * This code is distributed in the hope that it will be useful, but WITHOUT
  12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  14  * version 2 for more details (a copy is included in the LICENSE file that
  15  * accompanied this code).
  16  *
  17  * You should have received a copy of the GNU General Public License version
  18  * 2 along with this work; if not, write to the Free Software Foundation,
  19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  20  *
  21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  22  * or visit www.oracle.com if you need additional information or have any
</pre>
<hr />
<pre>
 186      *
 187      * @param readOnly true if the {@code Subject} is to be read-only,
 188      *          and false otherwise.
 189      *
 190      * @param principals the {@code Set} of Principals
 191      *          to be associated with this {@code Subject}.
 192      *
 193      * @param pubCredentials the {@code Set} of public credentials
 194      *          to be associated with this {@code Subject}.
 195      *
 196      * @param privCredentials the {@code Set} of private credentials
 197      *          to be associated with this {@code Subject}.
 198      *
 199      * @throws NullPointerException if the specified
 200      *          {@code principals}, {@code pubCredentials},
 201      *          or {@code privCredentials} are {@code null},
 202      *          or a null value exists within any of these three
 203      *          Sets.
 204      */
 205     public Subject(boolean readOnly, Set&lt;? extends Principal&gt; principals,
<span class="line-modified"> 206                    Set&lt;?&gt; pubCredentials, Set&lt;?&gt; privCredentials) {</span>
<span class="line-modified"> 207         LinkedList&lt;Principal&gt; principalList</span>
<span class="line-modified"> 208                 = collectionNullClean(principals);</span>
<span class="line-modified"> 209         LinkedList&lt;Object&gt; pubCredsList</span>
<span class="line-modified"> 210                 = collectionNullClean(pubCredentials);</span>
<span class="line-modified"> 211         LinkedList&lt;Object&gt; privCredsList</span>
<span class="line-modified"> 212                 = collectionNullClean(privCredentials);</span>
<span class="line-modified"> 213 </span>
<span class="line-modified"> 214         this.principals = Collections.synchronizedSet(</span>
<span class="line-modified"> 215                 new SecureSet&lt;&gt;(this, PRINCIPAL_SET, principalList));</span>
<span class="line-modified"> 216         this.pubCredentials = Collections.synchronizedSet(</span>
<span class="line-modified"> 217                 new SecureSet&lt;&gt;(this, PUB_CREDENTIAL_SET, pubCredsList));</span>
<span class="line-added"> 218         this.privCredentials = Collections.synchronizedSet(</span>
<span class="line-added"> 219                 new SecureSet&lt;&gt;(this, PRIV_CREDENTIAL_SET, privCredsList));</span>
 220         this.readOnly = readOnly;
 221     }
 222 
 223     /**
 224      * Set this {@code Subject} to be read-only.
 225      *
 226      * &lt;p&gt; Modifications (additions and removals) to this Subject&#39;s
 227      * {@code Principal} {@code Set} and
 228      * credential Sets will be disallowed.
 229      * The {@code destroy} operation on this Subject&#39;s credentials will
 230      * still be permitted.
 231      *
 232      * &lt;p&gt; Subsequent attempts to modify the Subject&#39;s {@code Principal}
 233      * and credential Sets will result in an
 234      * {@code IllegalStateException} being thrown.
 235      * Also, once a {@code Subject} is read-only,
 236      * it can not be reset to being writable again.
 237      *
 238      * @throws SecurityException if a security manager is installed and the
 239      *         caller does not have an
</pre>
<hr />
<pre>
 960 
 961     /**
 962      * Reads this object from a stream (i.e., deserializes it)
 963      */
 964     @SuppressWarnings(&quot;unchecked&quot;)
 965     @java.io.Serial
 966     private void readObject(java.io.ObjectInputStream s)
 967                 throws java.io.IOException, ClassNotFoundException {
 968 
 969         ObjectInputStream.GetField gf = s.readFields();
 970 
 971         readOnly = gf.get(&quot;readOnly&quot;, false);
 972 
 973         Set&lt;Principal&gt; inputPrincs = (Set&lt;Principal&gt;)gf.get(&quot;principals&quot;, null);
 974 
 975         Objects.requireNonNull(inputPrincs,
 976                 ResourcesMgr.getString(&quot;invalid.null.input.s.&quot;));
 977 
 978         // Rewrap the principals into a SecureSet
 979         try {
<span class="line-added"> 980             LinkedList&lt;Principal&gt; principalList = collectionNullClean(inputPrincs);</span>
 981             principals = Collections.synchronizedSet(new SecureSet&lt;&gt;
<span class="line-modified"> 982                                 (this, PRINCIPAL_SET, principalList));</span>
 983         } catch (NullPointerException npe) {
 984             // Sometimes people deserialize the principals set only.
 985             // Subject is not accessible, so just don&#39;t fail.
 986             principals = Collections.synchronizedSet
 987                         (new SecureSet&lt;&gt;(this, PRINCIPAL_SET));
 988         }
 989 
 990         // The Credential {@code Set} is not serialized, but we do not
 991         // want the default deserialization routine to set it to null.
 992         this.pubCredentials = Collections.synchronizedSet
 993                         (new SecureSet&lt;&gt;(this, PUB_CREDENTIAL_SET));
 994         this.privCredentials = Collections.synchronizedSet
 995                         (new SecureSet&lt;&gt;(this, PRIV_CREDENTIAL_SET));
 996     }
 997 
 998     /**
 999      * Tests for null-clean collections (both non-null reference and
1000      * no null elements)
1001      *
1002      * @param coll A {@code Collection} to be tested for null references
1003      *
1004      * @throws NullPointerException if the specified collection is either
1005      *            {@code null} or contains a {@code null} element
1006      */
<span class="line-modified">1007     private static &lt;E&gt; LinkedList&lt;E&gt; collectionNullClean(</span>
<span class="line-modified">1008             Collection&lt;? extends E&gt; coll) {</span>
1009 
1010         Objects.requireNonNull(coll,
1011                 ResourcesMgr.getString(&quot;invalid.null.input.s.&quot;));
1012 
<span class="line-modified">1013         LinkedList&lt;E&gt; output = new LinkedList&lt;&gt;();</span>
<span class="line-modified">1014         for (E e : coll) {</span>
<span class="line-modified">1015             output.add(Objects.requireNonNull(e,</span>
<span class="line-modified">1016                     ResourcesMgr.getString(&quot;invalid.null.input.s.&quot;)));</span>









1017         }
<span class="line-added">1018         return output;</span>
1019     }
1020 
1021     /**
1022      * Prevent modifications unless caller has permission.
1023      *
1024      * @serial include
1025      */
1026     private static class SecureSet&lt;E&gt;
1027         implements Set&lt;E&gt;, java.io.Serializable {
1028 
1029         @java.io.Serial
1030         private static final long serialVersionUID = 7911754171111800359L;
1031 
1032         /**
1033          * @serialField this$0 Subject The outer Subject instance.
1034          * @serialField elements LinkedList The elements in this set.
1035          */
1036         @java.io.Serial
1037         private static final ObjectStreamField[] serialPersistentFields = {
1038             new ObjectStreamField(&quot;this$0&quot;, Subject.class),
</pre>
<hr />
<pre>
1044         LinkedList&lt;E&gt; elements;
1045 
1046         /**
1047          * @serial An integer identifying the type of objects contained
1048          *      in this set.  If {@code which == 1},
1049          *      this is a Principal set and all the elements are
1050          *      of type {@code java.security.Principal}.
1051          *      If {@code which == 2}, this is a public credential
1052          *      set and all the elements are of type {@code Object}.
1053          *      If {@code which == 3}, this is a private credential
1054          *      set and all the elements are of type {@code Object}.
1055          */
1056         private int which;
1057 
1058         SecureSet(Subject subject, int which) {
1059             this.subject = subject;
1060             this.which = which;
1061             this.elements = new LinkedList&lt;E&gt;();
1062         }
1063 
<span class="line-modified">1064         SecureSet(Subject subject, int which, LinkedList&lt;E&gt; list) {</span>
1065             this.subject = subject;
1066             this.which = which;
<span class="line-modified">1067             this.elements = list;</span>
1068         }
1069 
1070         public int size() {
1071             return elements.size();
1072         }
1073 
1074         public Iterator&lt;E&gt; iterator() {
1075             final LinkedList&lt;E&gt; list = elements;
1076             return new Iterator&lt;E&gt;() {
1077                 ListIterator&lt;E&gt; i = list.listIterator(0);
1078 
1079                 public boolean hasNext() {return i.hasNext();}
1080 
1081                 public E next() {
1082                     if (which != Subject.PRIV_CREDENTIAL_SET) {
1083                         return i.next();
1084                     }
1085 
1086                     SecurityManager sm = System.getSecurityManager();
1087                     if (sm != null) {
</pre>
<hr />
<pre>
1220                                                 subject.getPrincipals()));
1221                     }
1222                     next = java.security.AccessController.doPrivileged
1223                         (new java.security.PrivilegedAction&lt;E&gt;() {
1224                         public E run() {
1225                             return e.next();
1226                         }
1227                     });
1228                 }
1229 
1230                 if (next.equals(o)) {
1231                     return true;
1232                 }
1233             }
1234             return false;
1235         }
1236 
1237         public boolean addAll(Collection&lt;? extends E&gt; c) {
1238             boolean result = false;
1239 
<span class="line-modified">1240             c = collectionNullClean(c);</span>
1241 
1242             for (E item : c) {
1243                 result |= this.add(item);
1244             }
1245 
1246             return result;
1247         }
1248 
1249         public boolean removeAll(Collection&lt;?&gt; c) {
<span class="line-modified">1250             c = collectionNullClean(c);</span>
1251 
1252             boolean modified = false;
1253             final Iterator&lt;E&gt; e = iterator();
1254             while (e.hasNext()) {
1255                 E next;
1256                 if (which != Subject.PRIV_CREDENTIAL_SET) {
1257                     next = e.next();
1258                 } else {
1259                     next = java.security.AccessController.doPrivileged
1260                         (new java.security.PrivilegedAction&lt;E&gt;() {
1261                         public E run() {
1262                             return e.next();
1263                         }
1264                     });
1265                 }
1266 
1267                 Iterator&lt;?&gt; ce = c.iterator();
1268                 while (ce.hasNext()) {
1269                     if (next.equals(ce.next())) {
1270                             e.remove();
1271                             modified = true;
1272                             break;
1273                         }
1274                 }
1275             }
1276             return modified;
1277         }
1278 
1279         public boolean containsAll(Collection&lt;?&gt; c) {
<span class="line-modified">1280             c = collectionNullClean(c);</span>
1281 
1282             for (Object item : c) {
1283                 if (this.contains(item) == false) {
1284                     return false;
1285                 }
1286             }
1287 
1288             return true;
1289         }
1290 
1291         public boolean retainAll(Collection&lt;?&gt; c) {
<span class="line-modified">1292             c = collectionNullClean(c);</span>
1293 
1294             boolean modified = false;
1295             final Iterator&lt;E&gt; e = iterator();
1296             while (e.hasNext()) {
1297                 E next;
1298                 if (which != Subject.PRIV_CREDENTIAL_SET) {
1299                     next = e.next();
1300                 } else {
1301                     next = java.security.AccessController.doPrivileged
1302                         (new java.security.PrivilegedAction&lt;E&gt;() {
1303                         public E run() {
1304                             return e.next();
1305                         }
1306                     });
1307                 }
1308 
1309                 if (c.contains(next) == false) {
1310                     e.remove();
1311                     modified = true;

1312                 }
<span class="line-added">1313             }</span>
1314 
1315             return modified;
1316         }
1317 
1318         public void clear() {
1319             final Iterator&lt;E&gt; e = iterator();
1320             while (e.hasNext()) {
1321                 E next;
1322                 if (which != Subject.PRIV_CREDENTIAL_SET) {
1323                     next = e.next();
1324                 } else {
1325                     next = java.security.AccessController.doPrivileged
1326                         (new java.security.PrivilegedAction&lt;E&gt;() {
1327                         public E run() {
1328                             return e.next();
1329                         }
1330                     });
1331                 }
1332                 e.remove();
1333             }
</pre>
<hr />
<pre>
1421                 }
1422             }
1423             ObjectOutputStream.PutField fields = oos.putFields();
1424             fields.put(&quot;this$0&quot;, subject);
1425             fields.put(&quot;elements&quot;, elements);
1426             fields.put(&quot;which&quot;, which);
1427             oos.writeFields();
1428         }
1429 
1430         @SuppressWarnings(&quot;unchecked&quot;)
1431         @java.io.Serial
1432         private void readObject(ObjectInputStream ois)
1433             throws IOException, ClassNotFoundException
1434         {
1435             ObjectInputStream.GetField fields = ois.readFields();
1436             subject = (Subject) fields.get(&quot;this$0&quot;, null);
1437             which = fields.get(&quot;which&quot;, 0);
1438 
1439             LinkedList&lt;E&gt; tmp = (LinkedList&lt;E&gt;) fields.get(&quot;elements&quot;, null);
1440 
<span class="line-modified">1441             elements = Subject.collectionNullClean(tmp);</span>






1442         }
1443 
1444     }
1445 
1446     /**
1447      * This class implements a {@code Set} which returns only
1448      * members that are an instance of a specified Class.
1449      */
1450     private class ClassSet&lt;T&gt; extends AbstractSet&lt;T&gt; {
1451 
1452         private int which;
1453         private Class&lt;T&gt; c;
1454         private Set&lt;T&gt; set;
1455 
1456         ClassSet(int which, Class&lt;T&gt; c) {
1457             this.which = which;
1458             this.c = c;
1459             set = new HashSet&lt;T&gt;();
1460 
1461             switch (which) {
</pre>
</td>
</tr>
</table>
<center><a href="../../../java/security/Provider.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="../../../sun/security/tools/keytool/Resources_ja.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>