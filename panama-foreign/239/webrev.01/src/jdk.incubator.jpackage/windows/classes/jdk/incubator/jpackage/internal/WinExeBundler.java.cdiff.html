<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff src/jdk.incubator.jpackage/windows/classes/jdk/incubator/jpackage/internal/WinExeBundler.java</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="ExecutableRebrander.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="WinMsiBundler.java.cdiff.html" target="_top">next &gt;</a></center>    <h2>src/jdk.incubator.jpackage/windows/classes/jdk/incubator/jpackage/internal/WinExeBundler.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 22,35 ***</span>
   * or visit www.oracle.com if you need additional information or have any
   * questions.
   */
  package jdk.incubator.jpackage.internal;
  
<span class="line-removed">- import java.io.File;</span>
  import java.io.IOException;
  import java.io.InputStream;
  import java.nio.file.Files;
  import java.nio.file.Path;
<span class="line-removed">- import java.nio.file.Paths;</span>
  import java.text.MessageFormat;
  import java.util.Map;
  
  public class WinExeBundler extends AbstractBundler {
  
      static {
          System.loadLibrary(&quot;jpackage&quot;);
      }
  
<span class="line-modified">!     public static final BundlerParamInfo&lt;File&gt; EXE_IMAGE_DIR</span>
              = new StandardBundlerParam&lt;&gt;(
                      &quot;win.exe.imageDir&quot;,
<span class="line-modified">!                     File.class,</span>
                      params -&gt; {
<span class="line-modified">!                         File imagesRoot = IMAGES_ROOT.fetchFrom(params);</span>
<span class="line-modified">!                         if (!imagesRoot.exists()) {</span>
<span class="line-modified">!                             imagesRoot.mkdirs();</span>
                          }
<span class="line-modified">!                         return new File(imagesRoot, &quot;win-exe.image&quot;);</span>
                      },
                      (s, p) -&gt; null);
  
      private final static String EXE_WRAPPER_NAME = &quot;msiwrapper.exe&quot;;
  
<span class="line-new-header">--- 22,37 ---</span>
   * or visit www.oracle.com if you need additional information or have any
   * questions.
   */
  package jdk.incubator.jpackage.internal;
  
  import java.io.IOException;
  import java.io.InputStream;
  import java.nio.file.Files;
  import java.nio.file.Path;
  import java.text.MessageFormat;
  import java.util.Map;
  
  public class WinExeBundler extends AbstractBundler {
  
      static {
          System.loadLibrary(&quot;jpackage&quot;);
      }
  
<span class="line-modified">!     public static final BundlerParamInfo&lt;Path&gt; EXE_IMAGE_DIR</span>
              = new StandardBundlerParam&lt;&gt;(
                      &quot;win.exe.imageDir&quot;,
<span class="line-modified">!                     Path.class,</span>
                      params -&gt; {
<span class="line-modified">!                         Path imagesRoot = IMAGES_ROOT.fetchFrom(params);</span>
<span class="line-modified">!                         if (!Files.exists(imagesRoot)) {</span>
<span class="line-modified">!                             try {</span>
<span class="line-added">+                                 Files.createDirectories(imagesRoot);</span>
<span class="line-added">+                             } catch (IOException ioe) {</span>
<span class="line-added">+                                 return null;</span>
<span class="line-added">+                             }</span>
                          }
<span class="line-modified">!                         return imagesRoot.resolve(&quot;win-exe.image&quot;);</span>
                      },
                      (s, p) -&gt; null);
  
      private final static String EXE_WRAPPER_NAME = &quot;msiwrapper.exe&quot;;
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 68,12 ***</span>
      public String getBundleType() {
          return &quot;INSTALLER&quot;;
      }
  
      @Override
<span class="line-modified">!     public File execute(Map&lt;String, ? super Object&gt; params,</span>
<span class="line-modified">!             File outputParentDir) throws PackagerException {</span>
          return bundle(params, outputParentDir);
      }
  
      @Override
      public boolean supported(boolean platformInstaller) {
<span class="line-new-header">--- 70,12 ---</span>
      public String getBundleType() {
          return &quot;INSTALLER&quot;;
      }
  
      @Override
<span class="line-modified">!     public Path execute(Map&lt;String, ? super Object&gt; params,</span>
<span class="line-modified">!             Path outputParentDir) throws PackagerException {</span>
          return bundle(params, outputParentDir);
      }
  
      @Override
      public boolean supported(boolean platformInstaller) {
</pre>
<hr />
<pre>
<span class="line-old-header">*** 89,64 ***</span>
      public boolean validate(Map&lt;String, ? super Object&gt; params)
              throws ConfigException {
          return msiBundler.validate(params);
      }
  
<span class="line-modified">!     public File bundle(Map&lt;String, ? super Object&gt; params, File outdir)</span>
              throws PackagerException {
  
<span class="line-modified">!         IOUtils.writableOutputDir(outdir.toPath());</span>
  
<span class="line-modified">!         File exeImageDir = EXE_IMAGE_DIR.fetchFrom(params);</span>
  
          // Write msi to temporary directory.
<span class="line-modified">!         File msi = msiBundler.execute(params, exeImageDir);</span>
  
          try {
              new ScriptRunner()
<span class="line-modified">!             .setDirectory(msi.toPath().getParent())</span>
              .setResourceCategoryId(&quot;resource.post-msi-script&quot;)
              .setScriptNameSuffix(&quot;post-msi&quot;)
<span class="line-modified">!             .setEnvironmentVariable(&quot;JpMsiFile&quot;, msi.getAbsolutePath().toString())</span>
              .run(params);
  
              return buildEXE(params, msi, outdir);
          } catch (IOException ex) {
              Log.verbose(ex);
              throw new PackagerException(ex);
          }
      }
  
<span class="line-modified">!     private File buildEXE(Map&lt;String, ? super Object&gt; params, File msi,</span>
<span class="line-modified">!             File outdir) throws IOException {</span>
  
          Log.verbose(MessageFormat.format(
                  I18N.getString(&quot;message.outputting-to-location&quot;),
<span class="line-modified">!                 outdir.getAbsolutePath()));</span>
  
          // Copy template msi wrapper next to msi file
<span class="line-modified">!         final Path exePath = IOUtils.replaceSuffix(msi.toPath(), &quot;.exe&quot;);</span>
          try (InputStream is = OverridableResource.readDefault(EXE_WRAPPER_NAME)) {
              Files.copy(is, exePath);
          }
  
          new ExecutableRebrander().addAction((resourceLock) -&gt; {
              // Embed msi in msi wrapper exe.
<span class="line-modified">!             embedMSI(resourceLock, msi.getAbsolutePath());</span>
          }).rebrandInstaller(params, exePath);
  
<span class="line-modified">!         Path dstExePath = Paths.get(outdir.getAbsolutePath(),</span>
<span class="line-removed">-                 exePath.getFileName().toString());</span>
          Files.deleteIfExists(dstExePath);
  
          Files.copy(exePath, dstExePath);
  
          Log.verbose(MessageFormat.format(
                  I18N.getString(&quot;message.output-location&quot;),
<span class="line-modified">!                 outdir.getAbsolutePath()));</span>
  
<span class="line-modified">!         return dstExePath.toFile();</span>
      }
  
      private final WinMsiBundler msiBundler = new WinMsiBundler();
  
      private static native int embedMSI(long resourceLock, String msiPath);
<span class="line-new-header">--- 91,63 ---</span>
      public boolean validate(Map&lt;String, ? super Object&gt; params)
              throws ConfigException {
          return msiBundler.validate(params);
      }
  
<span class="line-modified">!     public Path bundle(Map&lt;String, ? super Object&gt; params, Path outdir)</span>
              throws PackagerException {
  
<span class="line-modified">!         IOUtils.writableOutputDir(outdir);</span>
  
<span class="line-modified">!         Path exeImageDir = EXE_IMAGE_DIR.fetchFrom(params);</span>
  
          // Write msi to temporary directory.
<span class="line-modified">!         Path msi = msiBundler.execute(params, exeImageDir);</span>
  
          try {
              new ScriptRunner()
<span class="line-modified">!             .setDirectory(msi.getParent())</span>
              .setResourceCategoryId(&quot;resource.post-msi-script&quot;)
              .setScriptNameSuffix(&quot;post-msi&quot;)
<span class="line-modified">!             .setEnvironmentVariable(&quot;JpMsiFile&quot;, msi.toAbsolutePath().toString())</span>
              .run(params);
  
              return buildEXE(params, msi, outdir);
          } catch (IOException ex) {
              Log.verbose(ex);
              throw new PackagerException(ex);
          }
      }
  
<span class="line-modified">!     private Path buildEXE(Map&lt;String, ? super Object&gt; params, Path msi,</span>
<span class="line-modified">!             Path outdir) throws IOException {</span>
  
          Log.verbose(MessageFormat.format(
                  I18N.getString(&quot;message.outputting-to-location&quot;),
<span class="line-modified">!                 outdir.toAbsolutePath().toString()));</span>
  
          // Copy template msi wrapper next to msi file
<span class="line-modified">!         final Path exePath = IOUtils.replaceSuffix(msi, &quot;.exe&quot;);</span>
          try (InputStream is = OverridableResource.readDefault(EXE_WRAPPER_NAME)) {
              Files.copy(is, exePath);
          }
  
          new ExecutableRebrander().addAction((resourceLock) -&gt; {
              // Embed msi in msi wrapper exe.
<span class="line-modified">!             embedMSI(resourceLock, msi.toAbsolutePath().toString());</span>
          }).rebrandInstaller(params, exePath);
  
<span class="line-modified">!         Path dstExePath = outdir.toAbsolutePath().resolve(exePath.getFileName());</span>
          Files.deleteIfExists(dstExePath);
  
          Files.copy(exePath, dstExePath);
  
          Log.verbose(MessageFormat.format(
                  I18N.getString(&quot;message.output-location&quot;),
<span class="line-modified">!                 outdir.toAbsolutePath().toString()));</span>
  
<span class="line-modified">!         return dstExePath;</span>
      }
  
      private final WinMsiBundler msiBundler = new WinMsiBundler();
  
      private static native int embedMSI(long resourceLock, String msiPath);
</pre>
<center><a href="ExecutableRebrander.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="WinMsiBundler.java.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>