<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff src/jdk.incubator.jpackage/macosx/classes/jdk/incubator/jpackage/internal/MacAppImageBuilder.java</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="../../../../../../linux/classes/jdk/incubator/jpackage/internal/LinuxRpmBundler.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="MacAppStoreBundler.java.udiff.html" target="_top">next &gt;</a></center>    <h2>src/jdk.incubator.jpackage/macosx/classes/jdk/incubator/jpackage/internal/MacAppImageBuilder.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -23,12 +23,10 @@</span>
   * questions.
   */
  
  package jdk.incubator.jpackage.internal;
  
<span class="udiff-line-removed">- import java.io.File;</span>
<span class="udiff-line-removed">- import java.io.FileInputStream;</span>
  import java.io.IOException;
  import java.io.InputStream;
  import java.io.Writer;
  import java.nio.file.Files;
  import java.nio.file.Path;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -118,24 +116,25 @@</span>
  
                          return MacAppBundler.getIdentifier(params);
                      },
                      (s, p) -&gt; s);
  
<span class="udiff-line-modified-removed">-     public static final BundlerParamInfo&lt;File&gt; ICON_ICNS =</span>
<span class="udiff-line-modified-added">+     public static final BundlerParamInfo&lt;Path&gt; ICON_ICNS =</span>
              new StandardBundlerParam&lt;&gt;(
              &quot;icon.icns&quot;,
<span class="udiff-line-modified-removed">-             File.class,</span>
<span class="udiff-line-modified-added">+             Path.class,</span>
              params -&gt; {
<span class="udiff-line-modified-removed">-                 File f = ICON.fetchFrom(params);</span>
<span class="udiff-line-modified-removed">-                 if (f != null &amp;&amp; !f.getName().toLowerCase().endsWith(&quot;.icns&quot;)) {</span>
<span class="udiff-line-modified-added">+                 Path f = ICON.fetchFrom(params);</span>
<span class="udiff-line-modified-added">+                 if (f != null &amp;&amp; f.getFileName() != null &amp;&amp; !f.getFileName()</span>
<span class="udiff-line-added">+                         .toString().toLowerCase().endsWith(&quot;.icns&quot;)) {</span>
                      Log.error(MessageFormat.format(
                              I18N.getString(&quot;message.icon-not-icns&quot;), f));
                      return null;
                  }
                  return f;
              },
<span class="udiff-line-modified-removed">-             (s, p) -&gt; new File(s));</span>
<span class="udiff-line-modified-added">+             (s, p) -&gt; Path.of(s));</span>
  
      public static final StandardBundlerParam&lt;Boolean&gt; SIGN_BUNDLE  =
              new StandardBundlerParam&lt;&gt;(
              Arguments.CLIOptions.MAC_SIGN.getId(),
              Boolean.class,
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -240,12 +239,12 @@</span>
              throws IOException {
          Files.createDirectories(macOSDir);
  
          Map&lt;String, ? super Object&gt; originalParams = new HashMap&lt;&gt;(params);
          // Generate PkgInfo
<span class="udiff-line-modified-removed">-         File pkgInfoFile = new File(contentsDir.toFile(), &quot;PkgInfo&quot;);</span>
<span class="udiff-line-modified-removed">-         pkgInfoFile.createNewFile();</span>
<span class="udiff-line-modified-added">+         Path pkgInfoFile = contentsDir.resolve(&quot;PkgInfo&quot;);</span>
<span class="udiff-line-modified-added">+         Files.createFile(pkgInfoFile);</span>
          writePkgInfo(pkgInfoFile);
  
          Path executable = macOSDir.resolve(getLauncherName(params));
  
          // create the main app launcher
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -288,15 +287,13 @@</span>
                          + &quot;.icns&quot;));
  
          // copy file association icons
          for (Map&lt;String, ?
                  super Object&gt; fa : FILE_ASSOCIATIONS.fetchFrom(params)) {
<span class="udiff-line-modified-removed">-             File f = FA_ICON.fetchFrom(fa);</span>
<span class="udiff-line-modified-removed">-             if (f != null &amp;&amp; f.exists()) {</span>
<span class="udiff-line-modified-removed">-                 try (InputStream in2 = new FileInputStream(f)) {</span>
<span class="udiff-line-removed">-                     Files.copy(in2, resourcesDir.resolve(f.getName()));</span>
<span class="udiff-line-removed">-                 }</span>
<span class="udiff-line-modified-added">+             Path f = FA_ICON.fetchFrom(fa);</span>
<span class="udiff-line-modified-added">+             if (IOUtils.exists(f)) {</span>
<span class="udiff-line-modified-added">+                 IOUtils.copyFile(f, resourcesDir.resolve(f.getFileName()));</span>
  
              }
          }
  
          copyRuntimeFiles(params);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -304,15 +301,15 @@</span>
      }
  
      private void copyRuntimeFiles(Map&lt;String, ? super Object&gt; params)
              throws IOException {
          // Generate Info.plist
<span class="udiff-line-modified-removed">-         writeInfoPlist(contentsDir.resolve(&quot;Info.plist&quot;).toFile(), params);</span>
<span class="udiff-line-modified-added">+         writeInfoPlist(contentsDir.resolve(&quot;Info.plist&quot;), params);</span>
  
          // generate java runtime info.plist
          writeRuntimeInfoPlist(
<span class="udiff-line-modified-removed">-                 runtimeDir.resolve(&quot;Contents/Info.plist&quot;).toFile(), params);</span>
<span class="udiff-line-modified-added">+                 runtimeDir.resolve(&quot;Contents/Info.plist&quot;), params);</span>
  
          // copy library
          Path runtimeMacOSDir = Files.createDirectories(
                  runtimeDir.resolve(&quot;Contents/MacOS&quot;));
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -344,12 +341,12 @@</span>
              }
              restoreKeychainList(params);
          }
      }
  
<span class="udiff-line-modified-removed">-     static File getConfig_Entitlements(Map&lt;String, ? super Object&gt; params) {</span>
<span class="udiff-line-modified-removed">-         return new File(CONFIG_ROOT.fetchFrom(params),</span>
<span class="udiff-line-modified-added">+     static Path getConfig_Entitlements(Map&lt;String, ? super Object&gt; params) {</span>
<span class="udiff-line-modified-added">+         return CONFIG_ROOT.fetchFrom(params).resolve(</span>
                  getLauncherName(params) + &quot;.entitlements&quot;);
      }
  
      static void prepareEntitlements(Map&lt;String, ? super Object&gt; params)
              throws IOException {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -380,11 +377,11 @@</span>
              }
              return nm;
          }
      }
  
<span class="udiff-line-modified-removed">-     private void writeRuntimeInfoPlist(File file,</span>
<span class="udiff-line-modified-added">+     private void writeRuntimeInfoPlist(Path file,</span>
              Map&lt;String, ? super Object&gt; params) throws IOException {
          Map&lt;String, String&gt; data = new HashMap&lt;&gt;();
          String identifier = StandardBundlerParam.isRuntimeInstaller(params) ?
                  MAC_CF_BUNDLE_IDENTIFIER.fetchFrom(params) :
                  &quot;com.oracle.java.&quot; + MAC_CF_BUNDLE_IDENTIFIER.fetchFrom(params);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -425,14 +422,14 @@</span>
              sb.append(&quot;  &lt;key&gt;&quot;).append(key).append(&quot;&lt;/key&gt;\n&quot;).append(&quot;  &lt;&quot;)
                      .append(value).append(&quot;/&gt;\n&quot;).append(&quot;\n&quot;);
           }
      }
  
<span class="udiff-line-modified-removed">-     private void writeInfoPlist(File file, Map&lt;String, ? super Object&gt; params)</span>
<span class="udiff-line-modified-added">+     private void writeInfoPlist(Path file, Map&lt;String, ? super Object&gt; params)</span>
              throws IOException {
          Log.verbose(MessageFormat.format(I18N.getString(
<span class="udiff-line-modified-removed">-                 &quot;message.preparing-info-plist&quot;), file.getAbsolutePath()));</span>
<span class="udiff-line-modified-added">+                 &quot;message.preparing-info-plist&quot;), file.toAbsolutePath()));</span>
  
          //prepare config for exe
          //Note: do not need CFBundleDisplayName if we don&#39;t support localization
          Map&lt;String, String&gt; data = new HashMap&lt;&gt;();
          data.put(&quot;DEPLOY_ICON_FILE&quot;, APP_NAME.fetchFrom(params) + &quot;.icns&quot;);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -458,11 +455,11 @@</span>
  
              String itemContentType = MAC_CF_BUNDLE_IDENTIFIER.fetchFrom(params)
                      + &quot;.&quot; + ((extensions == null || extensions.isEmpty())
                      ? &quot;mime&quot; : extensions.get(0));
              String description = FA_DESCRIPTION.fetchFrom(fileAssociation);
<span class="udiff-line-modified-removed">-             File icon = FA_ICON.fetchFrom(fileAssociation);</span>
<span class="udiff-line-modified-added">+             Path icon = FA_ICON.fetchFrom(fileAssociation);</span>
  
              bundleDocumentTypes.append(&quot; &lt;dict&gt;\n&quot;);
              writeStringArrayPlist(bundleDocumentTypes, &quot;LSItemContentTypes&quot;,
                      Arrays.asList(itemContentType));
              writeStringPlist(bundleDocumentTypes, &quot;CFBundleTypeName&quot;, description);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -480,13 +477,13 @@</span>
                      FA_MAC_LSTYPEISPACKAGE.fetchFrom(fileAssociation));
              writeBoolPlist(bundleDocumentTypes, &quot;LSSupportsOpeningDocumentsInPlace&quot;,
                      FA_MAC_LSDOCINPLACE.fetchFrom(fileAssociation));
              writeBoolPlist(bundleDocumentTypes, &quot;UISupportsDocumentBrowser&quot;,
                      FA_MAC_UIDOCBROWSER.fetchFrom(fileAssociation));
<span class="udiff-line-modified-removed">-             if (icon != null &amp;&amp; icon.exists()) {</span>
<span class="udiff-line-modified-added">+             if (IOUtils.exists(icon)) {</span>
                  writeStringPlist(bundleDocumentTypes, &quot;CFBundleTypeIconFile&quot;,
<span class="udiff-line-modified-removed">-                         icon.getName());</span>
<span class="udiff-line-modified-added">+                         icon.getFileName().toString());</span>
              }
              bundleDocumentTypes.append(&quot;  &lt;/dict&gt;\n&quot;);
  
              exportedTypes.append(&quot;  &lt;dict&gt;\n&quot;);
              writeStringPlist(exportedTypes, &quot;UTTypeIdentifier&quot;,
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -494,12 +491,13 @@</span>
              writeStringPlist(exportedTypes, &quot;UTTypeDescription&quot;,
                      description);
              writeStringArrayPlist(exportedTypes, &quot;UTTypeConformsTo&quot;,
                      FA_MAC_UTTYPECONFORMSTO.fetchFrom(fileAssociation));
  
<span class="udiff-line-modified-removed">-             if (icon != null &amp;&amp; icon.exists()) {</span>
<span class="udiff-line-modified-removed">-                 writeStringPlist(exportedTypes, &quot;UTTypeIconFile&quot;, icon.getName());</span>
<span class="udiff-line-modified-added">+             if (IOUtils.exists(icon)) {</span>
<span class="udiff-line-modified-added">+                 writeStringPlist(exportedTypes, &quot;UTTypeIconFile&quot;,</span>
<span class="udiff-line-added">+                         icon.getFileName().toString());</span>
              }
              exportedTypes.append(&quot;\n&quot;)
                      .append(&quot;  &lt;key&gt;UTTypeTagSpecification&lt;/key&gt;\n&quot;)
                      .append(&quot;  &lt;dict&gt;\n&quot;)
                      .append(&quot;\n&quot;);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -530,15 +528,15 @@</span>
                  .setSubstitutionData(data)
                  .setPublicName(&quot;Info.plist&quot;)
                  .saveToFile(file);
      }
  
<span class="udiff-line-modified-removed">-     private void writePkgInfo(File file) throws IOException {</span>
<span class="udiff-line-modified-added">+     private void writePkgInfo(Path file) throws IOException {</span>
          //hardcoded as it does not seem we need to change it ever
          String signature = &quot;????&quot;;
  
<span class="udiff-line-modified-removed">-         try (Writer out = Files.newBufferedWriter(file.toPath())) {</span>
<span class="udiff-line-modified-added">+         try (Writer out = Files.newBufferedWriter(file)) {</span>
              out.write(OS_TYPE_CODE + signature);
              out.flush();
          }
      }
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -555,11 +553,11 @@</span>
          if (keyChain == null || keyChain.isEmpty()) {
              return;
          }
  
          // get current keychain list
<span class="udiff-line-modified-removed">-         String keyChainPath = new File (keyChain).getAbsolutePath().toString();</span>
<span class="udiff-line-modified-added">+         String keyChainPath = Path.of(keyChain).toAbsolutePath().toString();</span>
          List&lt;String&gt; keychainList = new ArrayList&lt;&gt;();
          int ret = IOUtils.getProcessOutput(
                  keychainList, &quot;security&quot;, &quot;list-keychains&quot;);
          if (ret != 0) {
              Log.error(I18N.getString(&quot;message.keychain.error&quot;));
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -619,11 +617,11 @@</span>
          IOUtils.exec(pb);
      }
  
      static void signAppBundle(
              Map&lt;String, ? super Object&gt; params, Path appLocation,
<span class="udiff-line-modified-removed">-             String signingIdentity, String identifierPrefix, File entitlements)</span>
<span class="udiff-line-modified-added">+             String signingIdentity, String identifierPrefix, Path entitlements)</span>
              throws IOException {
          AtomicReference&lt;IOException&gt; toThrow = new AtomicReference&lt;&gt;();
          String appExecutable = &quot;/Contents/MacOS/&quot; + APP_NAME.fetchFrom(params);
          String keyChain = SIGNING_KEYCHAIN.fetchFrom(params);
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -681,12 +679,11 @@</span>
                      args.add(p.toString());
  
                      try {
                          Set&lt;PosixFilePermission&gt; oldPermissions =
                                  Files.getPosixFilePermissions(p);
<span class="udiff-line-modified-removed">-                         File f = p.toFile();</span>
<span class="udiff-line-removed">-                         f.setWritable(true, true);</span>
<span class="udiff-line-modified-added">+                         p.toFile().setWritable(true, true);</span>
  
                          ProcessBuilder pb = new ProcessBuilder(args);
  
                          IOUtils.exec(pb);
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -796,21 +793,19 @@</span>
          if (PREDEFINED_APP_IMAGE.fetchFrom(params) == null) {
              return null;
          }
  
          try {
<span class="udiff-line-modified-removed">-             File infoPList = new File(PREDEFINED_APP_IMAGE.fetchFrom(params) +</span>
<span class="udiff-line-modified-removed">-                                       File.separator + &quot;Contents&quot; +</span>
<span class="udiff-line-removed">-                                       File.separator + &quot;Info.plist&quot;);</span>
<span class="udiff-line-modified-added">+             Path infoPList = PREDEFINED_APP_IMAGE.fetchFrom(params).resolve(&quot;Contents&quot;).</span>
<span class="udiff-line-modified-added">+                     resolve(&quot;Info.plist&quot;);</span>
  
              DocumentBuilderFactory dbf
                      = DocumentBuilderFactory.newDefaultInstance();
              dbf.setFeature(&quot;http://apache.org/xml/features/&quot; +
                             &quot;nonvalidating/load-external-dtd&quot;, false);
              DocumentBuilder b = dbf.newDocumentBuilder();
<span class="udiff-line-modified-removed">-             org.w3c.dom.Document doc = b.parse(new FileInputStream(</span>
<span class="udiff-line-removed">-                     infoPList.getAbsolutePath()));</span>
<span class="udiff-line-modified-added">+             org.w3c.dom.Document doc = b.parse(Files.newInputStream(infoPList));</span>
  
              XPath xPath = XPathFactory.newInstance().newXPath();
              // Query for the value of &lt;string&gt; element preceding &lt;key&gt;
              // element with value equal to CFBundleIdentifier
              String v = (String) xPath.evaluate(
</pre>
<center><a href="../../../../../../linux/classes/jdk/incubator/jpackage/internal/LinuxRpmBundler.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="MacAppStoreBundler.java.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>