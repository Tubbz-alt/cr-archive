<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff src/jdk.incubator.jpackage/macosx/classes/jdk/incubator/jpackage/internal/MacDmgBundler.java</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="MacCertificate.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="MacPkgBundler.java.cdiff.html" target="_top">next &gt;</a></center>    <h2>src/jdk.incubator.jpackage/macosx/classes/jdk/incubator/jpackage/internal/MacDmgBundler.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 67,26 ***</span>
              &quot;mac.dmg.installerName.suffix&quot;,
              String.class,
              params -&gt; &quot;&quot;,
              (s, p) -&gt; s);
  
<span class="line-modified">!     public File bundle(Map&lt;String, ? super Object&gt; params,</span>
<span class="line-modified">!             File outdir) throws PackagerException {</span>
          Log.verbose(MessageFormat.format(I18N.getString(&quot;message.building-dmg&quot;),
                  APP_NAME.fetchFrom(params)));
  
<span class="line-modified">!         IOUtils.writableOutputDir(outdir.toPath());</span>
  
          try {
<span class="line-modified">!             File appLocation = prepareAppBundle(params);</span>
  
              if (appLocation != null &amp;&amp; prepareConfigFiles(params)) {
<span class="line-modified">!                 File configScript = getConfig_Script(params);</span>
<span class="line-modified">!                 if (configScript.exists()) {</span>
                      Log.verbose(MessageFormat.format(
                              I18N.getString(&quot;message.running-script&quot;),
<span class="line-modified">!                             configScript.getAbsolutePath()));</span>
                      IOUtils.run(&quot;bash&quot;, configScript);
                  }
  
                  return buildDMG(params, appLocation, outdir);
              }
<span class="line-new-header">--- 67,26 ---</span>
              &quot;mac.dmg.installerName.suffix&quot;,
              String.class,
              params -&gt; &quot;&quot;,
              (s, p) -&gt; s);
  
<span class="line-modified">!     public Path bundle(Map&lt;String, ? super Object&gt; params,</span>
<span class="line-modified">!             Path outdir) throws PackagerException {</span>
          Log.verbose(MessageFormat.format(I18N.getString(&quot;message.building-dmg&quot;),
                  APP_NAME.fetchFrom(params)));
  
<span class="line-modified">!         IOUtils.writableOutputDir(outdir);</span>
  
          try {
<span class="line-modified">!             Path appLocation = prepareAppBundle(params);</span>
  
              if (appLocation != null &amp;&amp; prepareConfigFiles(params)) {
<span class="line-modified">!                 Path configScript = getConfig_Script(params);</span>
<span class="line-modified">!                 if (IOUtils.exists(configScript)) {</span>
                      Log.verbose(MessageFormat.format(
                              I18N.getString(&quot;message.running-script&quot;),
<span class="line-modified">!                             configScript.toAbsolutePath().toString()));</span>
                      IOUtils.run(&quot;bash&quot;, configScript);
                  }
  
                  return buildDMG(params, appLocation, outdir);
              }
</pre>
<hr />
<pre>
<span class="line-old-header">*** 99,20 ***</span>
  
      private static final String hdiutil = &quot;/usr/bin/hdiutil&quot;;
  
      private void prepareDMGSetupScript(Map&lt;String, ? super Object&gt; params)
                                                                      throws IOException {
<span class="line-modified">!         File dmgSetup = getConfig_VolumeScript(params);</span>
          Log.verbose(MessageFormat.format(
                  I18N.getString(&quot;message.preparing-dmg-setup&quot;),
<span class="line-modified">!                 dmgSetup.getAbsolutePath()));</span>
  
          // We need to use URL for DMG to find it. We cannot use volume name, since
          // user might have open DMG with same volume name already. Url should end with
          // &#39;/&#39; and it should be real path (no symbolic links).
<span class="line-modified">!         File imageDir = IMAGES_ROOT.fetchFrom(params);</span>
<span class="line-modified">!         if (!imageDir.exists()) imageDir.mkdirs(); // Create it, since it does not exist</span>
          Path rootPath = Path.of(imageDir.toString()).toRealPath();
          Path volumePath = rootPath.resolve(APP_NAME.fetchFrom(params));
          String volumeUrl = volumePath.toUri().toString() + File.separator;
  
          // Provide full path to backround image, so we can find it.
<span class="line-new-header">--- 99,23 ---</span>
  
      private static final String hdiutil = &quot;/usr/bin/hdiutil&quot;;
  
      private void prepareDMGSetupScript(Map&lt;String, ? super Object&gt; params)
                                                                      throws IOException {
<span class="line-modified">!         Path dmgSetup = getConfig_VolumeScript(params);</span>
          Log.verbose(MessageFormat.format(
                  I18N.getString(&quot;message.preparing-dmg-setup&quot;),
<span class="line-modified">!                 dmgSetup.toAbsolutePath().toString()));</span>
  
          // We need to use URL for DMG to find it. We cannot use volume name, since
          // user might have open DMG with same volume name already. Url should end with
          // &#39;/&#39; and it should be real path (no symbolic links).
<span class="line-modified">!         Path imageDir = IMAGES_ROOT.fetchFrom(params);</span>
<span class="line-modified">!         if (!Files.exists(imageDir)) {</span>
<span class="line-added">+              // Create it, since it does not exist</span>
<span class="line-added">+              Files.createDirectories(imageDir);</span>
<span class="line-added">+         }</span>
          Path rootPath = Path.of(imageDir.toString()).toRealPath();
          Path volumePath = rootPath.resolve(APP_NAME.fetchFrom(params));
          String volumeUrl = volumePath.toUri().toString() + File.separator;
  
          // Provide full path to backround image, so we can find it.
</pre>
<hr />
<pre>
<span class="line-old-header">*** 132,41 ***</span>
                  .setCategory(I18N.getString(&quot;resource.dmg-setup-script&quot;))
                  .setSubstitutionData(data)
                  .saveToFile(dmgSetup);
      }
  
<span class="line-modified">!     private File getConfig_VolumeScript(Map&lt;String, ? super Object&gt; params) {</span>
<span class="line-modified">!         return new File(CONFIG_ROOT.fetchFrom(params),</span>
                  APP_NAME.fetchFrom(params) + &quot;-dmg-setup.scpt&quot;);
      }
  
<span class="line-modified">!     private File getConfig_VolumeBackground(</span>
              Map&lt;String, ? super Object&gt; params) {
<span class="line-modified">!         return new File(CONFIG_ROOT.fetchFrom(params),</span>
                  APP_NAME.fetchFrom(params) + &quot;-background.tiff&quot;);
      }
  
<span class="line-modified">!     private File getConfig_VolumeIcon(Map&lt;String, ? super Object&gt; params) {</span>
<span class="line-modified">!         return new File(CONFIG_ROOT.fetchFrom(params),</span>
                  APP_NAME.fetchFrom(params) + &quot;-volume.icns&quot;);
      }
  
<span class="line-modified">!     private File getConfig_LicenseFile(Map&lt;String, ? super Object&gt; params) {</span>
<span class="line-modified">!         return new File(CONFIG_ROOT.fetchFrom(params),</span>
                  APP_NAME.fetchFrom(params) + &quot;-license.plist&quot;);
      }
  
      private void prepareLicense(Map&lt;String, ? super Object&gt; params) {
          try {
              String licFileStr = LICENSE_FILE.fetchFrom(params);
              if (licFileStr == null) {
                  return;
              }
  
<span class="line-modified">!             File licFile = new File(licFileStr);</span>
              byte[] licenseContentOriginal =
<span class="line-modified">!                     Files.readAllBytes(licFile.toPath());</span>
              String licenseInBase64 =
                      Base64.getEncoder().encodeToString(licenseContentOriginal);
  
              Map&lt;String, String&gt; data = new HashMap&lt;&gt;();
              data.put(&quot;APPLICATION_LICENSE_TEXT&quot;, licenseInBase64);
<span class="line-new-header">--- 135,41 ---</span>
                  .setCategory(I18N.getString(&quot;resource.dmg-setup-script&quot;))
                  .setSubstitutionData(data)
                  .saveToFile(dmgSetup);
      }
  
<span class="line-modified">!     private Path getConfig_VolumeScript(Map&lt;String, ? super Object&gt; params) {</span>
<span class="line-modified">!         return CONFIG_ROOT.fetchFrom(params).resolve(</span>
                  APP_NAME.fetchFrom(params) + &quot;-dmg-setup.scpt&quot;);
      }
  
<span class="line-modified">!     private Path getConfig_VolumeBackground(</span>
              Map&lt;String, ? super Object&gt; params) {
<span class="line-modified">!         return CONFIG_ROOT.fetchFrom(params).resolve(</span>
                  APP_NAME.fetchFrom(params) + &quot;-background.tiff&quot;);
      }
  
<span class="line-modified">!     private Path getConfig_VolumeIcon(Map&lt;String, ? super Object&gt; params) {</span>
<span class="line-modified">!         return CONFIG_ROOT.fetchFrom(params).resolve(</span>
                  APP_NAME.fetchFrom(params) + &quot;-volume.icns&quot;);
      }
  
<span class="line-modified">!     private Path getConfig_LicenseFile(Map&lt;String, ? super Object&gt; params) {</span>
<span class="line-modified">!         return CONFIG_ROOT.fetchFrom(params).resolve(</span>
                  APP_NAME.fetchFrom(params) + &quot;-license.plist&quot;);
      }
  
      private void prepareLicense(Map&lt;String, ? super Object&gt; params) {
          try {
              String licFileStr = LICENSE_FILE.fetchFrom(params);
              if (licFileStr == null) {
                  return;
              }
  
<span class="line-modified">!             Path licFile = Path.of(licFileStr);</span>
              byte[] licenseContentOriginal =
<span class="line-modified">!                     Files.readAllBytes(licFile);</span>
              String licenseInBase64 =
                      Base64.getEncoder().encodeToString(licenseContentOriginal);
  
              Map&lt;String, String&gt; data = new HashMap&lt;&gt;();
              data.put(&quot;APPLICATION_LICENSE_TEXT&quot;, licenseInBase64);
</pre>
<hr />
<pre>
<span class="line-old-header">*** 203,12 ***</span>
  
          return true;
      }
  
      // name of post-image script
<span class="line-modified">!     private File getConfig_Script(Map&lt;String, ? super Object&gt; params) {</span>
<span class="line-modified">!         return new File(CONFIG_ROOT.fetchFrom(params),</span>
                  APP_NAME.fetchFrom(params) + &quot;-post-image.sh&quot;);
      }
  
      // Location of SetFile utility may be different depending on MacOS version
      // We look for several known places and if none of them work will
<span class="line-new-header">--- 206,12 ---</span>
  
          return true;
      }
  
      // name of post-image script
<span class="line-modified">!     private Path getConfig_Script(Map&lt;String, ? super Object&gt; params) {</span>
<span class="line-modified">!         return CONFIG_ROOT.fetchFrom(params).resolve(</span>
                  APP_NAME.fetchFrom(params) + &quot;-post-image.sh&quot;);
      }
  
      // Location of SetFile utility may be different depending on MacOS version
      // We look for several known places and if none of them work will
</pre>
<hr />
<pre>
<span class="line-old-header">*** 216,13 ***</span>
      private String findSetFileUtility() {
          String typicalPaths[] = {&quot;/Developer/Tools/SetFile&quot;,
                  &quot;/usr/bin/SetFile&quot;, &quot;/Developer/usr/bin/SetFile&quot;};
  
          String setFilePath = null;
<span class="line-modified">!         for (String path: typicalPaths) {</span>
<span class="line-modified">!             File f = new File(path);</span>
<span class="line-modified">!             if (f.exists() &amp;&amp; f.canExecute()) {</span>
                  setFilePath = path;
                  break;
              }
          }
  
<span class="line-new-header">--- 219,13 ---</span>
      private String findSetFileUtility() {
          String typicalPaths[] = {&quot;/Developer/Tools/SetFile&quot;,
                  &quot;/usr/bin/SetFile&quot;, &quot;/Developer/usr/bin/SetFile&quot;};
  
          String setFilePath = null;
<span class="line-modified">!         for (String path : typicalPaths) {</span>
<span class="line-modified">!             Path f = Path.of(path);</span>
<span class="line-modified">!             if (Files.exists(f) &amp;&amp; Files.isExecutable(f)) {</span>
                  setFilePath = path;
                  break;
              }
          }
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 249,80 ***</span>
              Process p = pb.start();
              InputStreamReader isr = new InputStreamReader(p.getInputStream());
              BufferedReader br = new BufferedReader(isr);
              String lineRead = br.readLine();
              if (lineRead != null) {
<span class="line-modified">!                 File f = new File(lineRead);</span>
<span class="line-modified">!                 if (f.exists() &amp;&amp; f.canExecute()) {</span>
<span class="line-modified">!                     return f.getAbsolutePath();</span>
                  }
              }
          } catch (IOException ignored) {}
  
          return null;
      }
  
<span class="line-modified">!     private File buildDMG( Map&lt;String, ? super Object&gt; params,</span>
<span class="line-modified">!             File appLocation, File outdir) throws IOException, PackagerException {</span>
          boolean copyAppImage = false;
<span class="line-modified">!         File imagesRoot = IMAGES_ROOT.fetchFrom(params);</span>
<span class="line-modified">!         if (!imagesRoot.exists()) imagesRoot.mkdirs();</span>
  
<span class="line-modified">!         File protoDMG = new File(imagesRoot,</span>
<span class="line-modified">!                 APP_NAME.fetchFrom(params) +&quot;-tmp.dmg&quot;);</span>
<span class="line-removed">-         File finalDMG = new File(outdir, INSTALLER_NAME.fetchFrom(params)</span>
                  + INSTALLER_SUFFIX.fetchFrom(params) + &quot;.dmg&quot;);
  
<span class="line-modified">!         File srcFolder = APP_IMAGE_TEMP_ROOT.fetchFrom(params);</span>
<span class="line-modified">!         File predefinedImage =</span>
<span class="line-removed">-                 StandardBundlerParam.getPredefinedAppImage(params);</span>
          if (predefinedImage != null) {
              srcFolder = predefinedImage;
          } else if (StandardBundlerParam.isRuntimeInstaller(params)) {
<span class="line-modified">!             Path newRoot = Files.createTempDirectory(</span>
<span class="line-modified">!                 TEMP_ROOT.fetchFrom(params).toPath(), &quot;root-&quot;);</span>
  
              // first, is this already a runtime with
              // &lt;runtime&gt;/Contents/Home - if so we need the Home dir
<span class="line-modified">!             Path original = appLocation.toPath();</span>
<span class="line-modified">!             Path home = original.resolve(&quot;Contents/Home&quot;);</span>
<span class="line-removed">-             Path source = (Files.exists(home)) ? home : original;</span>
  
              // Then we need to put back the &lt;NAME&gt;/Content/Home
              Path root = newRoot.resolve(
                      MAC_CF_BUNDLE_IDENTIFIER.fetchFrom(params));
              Path dest = root.resolve(&quot;Contents/Home&quot;);
  
              IOUtils.copyRecursive(source, dest);
  
<span class="line-modified">!             srcFolder = newRoot.toFile();</span>
          }
  
          Log.verbose(MessageFormat.format(I18N.getString(
<span class="line-modified">!                 &quot;message.creating-dmg-file&quot;), finalDMG.getAbsolutePath()));</span>
  
<span class="line-modified">!         protoDMG.delete();</span>
<span class="line-modified">!         if (finalDMG.exists() &amp;&amp; !finalDMG.delete()) {</span>
              throw new IOException(MessageFormat.format(I18N.getString(
                      &quot;message.dmg-cannot-be-overwritten&quot;),
<span class="line-modified">!                     finalDMG.getAbsolutePath()));</span>
          }
  
<span class="line-modified">!         protoDMG.getParentFile().mkdirs();</span>
<span class="line-modified">!         finalDMG.getParentFile().mkdirs();</span>
  
          String hdiUtilVerbosityFlag = VERBOSE.fetchFrom(params) ?
                  &quot;-verbose&quot; : &quot;-quiet&quot;;
  
          // create temp image
          ProcessBuilder pb = new ProcessBuilder(
                  hdiutil,
                  &quot;create&quot;,
                  hdiUtilVerbosityFlag,
<span class="line-modified">!                 &quot;-srcfolder&quot;, srcFolder.getAbsolutePath(),</span>
                  &quot;-volname&quot;, APP_NAME.fetchFrom(params),
<span class="line-modified">!                 &quot;-ov&quot;, protoDMG.getAbsolutePath(),</span>
                  &quot;-fs&quot;, &quot;HFS+&quot;,
                  &quot;-format&quot;, &quot;UDRW&quot;);
          try {
              IOUtils.exec(pb);
          } catch (IOException ex) {
<span class="line-new-header">--- 252,81 ---</span>
              Process p = pb.start();
              InputStreamReader isr = new InputStreamReader(p.getInputStream());
              BufferedReader br = new BufferedReader(isr);
              String lineRead = br.readLine();
              if (lineRead != null) {
<span class="line-modified">!                 Path f = Path.of(lineRead);</span>
<span class="line-modified">!                 if (Files.exists(f) &amp;&amp; Files.isExecutable(f)) {</span>
<span class="line-modified">!                     return f.toAbsolutePath().toString();</span>
                  }
              }
          } catch (IOException ignored) {}
  
          return null;
      }
  
<span class="line-modified">!     private Path buildDMG( Map&lt;String, ? super Object&gt; params,</span>
<span class="line-modified">!             Path appLocation, Path outdir) throws IOException {</span>
          boolean copyAppImage = false;
<span class="line-modified">!         Path imagesRoot = IMAGES_ROOT.fetchFrom(params);</span>
<span class="line-modified">!         if (!Files.exists(imagesRoot)) {</span>
<span class="line-added">+             Files.createDirectories(imagesRoot);</span>
<span class="line-added">+         }</span>
  
<span class="line-modified">!         Path protoDMG = imagesRoot.resolve(APP_NAME.fetchFrom(params) +&quot;-tmp.dmg&quot;);</span>
<span class="line-modified">!         Path finalDMG = outdir.resolve(INSTALLER_NAME.fetchFrom(params)</span>
                  + INSTALLER_SUFFIX.fetchFrom(params) + &quot;.dmg&quot;);
  
<span class="line-modified">!         Path srcFolder = APP_IMAGE_TEMP_ROOT.fetchFrom(params);</span>
<span class="line-modified">!         Path predefinedImage = StandardBundlerParam.getPredefinedAppImage(params);</span>
          if (predefinedImage != null) {
              srcFolder = predefinedImage;
          } else if (StandardBundlerParam.isRuntimeInstaller(params)) {
<span class="line-modified">!             Path newRoot = Files.createTempDirectory(TEMP_ROOT.fetchFrom(params),</span>
<span class="line-modified">!                     &quot;root-&quot;);</span>
  
              // first, is this already a runtime with
              // &lt;runtime&gt;/Contents/Home - if so we need the Home dir
<span class="line-modified">!             Path home = appLocation.resolve(&quot;Contents/Home&quot;);</span>
<span class="line-modified">!             Path source = (Files.exists(home)) ? home : appLocation;</span>
  
              // Then we need to put back the &lt;NAME&gt;/Content/Home
              Path root = newRoot.resolve(
                      MAC_CF_BUNDLE_IDENTIFIER.fetchFrom(params));
              Path dest = root.resolve(&quot;Contents/Home&quot;);
  
              IOUtils.copyRecursive(source, dest);
  
<span class="line-modified">!             srcFolder = newRoot;</span>
          }
  
          Log.verbose(MessageFormat.format(I18N.getString(
<span class="line-modified">!                 &quot;message.creating-dmg-file&quot;), finalDMG.toAbsolutePath()));</span>
  
<span class="line-modified">!         Files.deleteIfExists(protoDMG);</span>
<span class="line-modified">!         try {</span>
<span class="line-added">+             Files.deleteIfExists(finalDMG);</span>
<span class="line-added">+         } catch (IOException ex) {</span>
              throw new IOException(MessageFormat.format(I18N.getString(
                      &quot;message.dmg-cannot-be-overwritten&quot;),
<span class="line-modified">!                     finalDMG.toAbsolutePath()));</span>
          }
  
<span class="line-modified">!         Files.createDirectories(protoDMG.getParent());</span>
<span class="line-modified">!         Files.createDirectories(finalDMG.getParent());</span>
  
          String hdiUtilVerbosityFlag = VERBOSE.fetchFrom(params) ?
                  &quot;-verbose&quot; : &quot;-quiet&quot;;
  
          // create temp image
          ProcessBuilder pb = new ProcessBuilder(
                  hdiutil,
                  &quot;create&quot;,
                  hdiUtilVerbosityFlag,
<span class="line-modified">!                 &quot;-srcfolder&quot;, srcFolder.toAbsolutePath().toString(),</span>
                  &quot;-volname&quot;, APP_NAME.fetchFrom(params),
<span class="line-modified">!                 &quot;-ov&quot;, protoDMG.toAbsolutePath().toString(),</span>
                  &quot;-fs&quot;, &quot;HFS+&quot;,
                  &quot;-format&quot;, &quot;UDRW&quot;);
          try {
              IOUtils.exec(pb);
          } catch (IOException ex) {
</pre>
<hr />
<pre>
<span class="line-old-header">*** 330,75 ***</span>
  
              // Creating DMG from entire app image failed, so lets try to create empty
              // DMG and copy files manually. See JDK-8248059.
              copyAppImage = true;
  
<span class="line-modified">!             long size = new PathGroup(Map.of(new Object(), srcFolder.toPath()))</span>
<span class="line-removed">-                     .sizeInBytes();</span>
              size += 50 * 1024 * 1024; // Add extra 50 megabytes. Actually DMG size will
              // not be bigger, but it will able to hold additional 50 megabytes of data.
              // We need extra room for icons and background image. When we providing
              // actual files to hdiutil, it will create DMG with ~50 megabytes extra room.
              pb = new ProcessBuilder(
                  hdiutil,
                  &quot;create&quot;,
                  hdiUtilVerbosityFlag,
                  &quot;-size&quot;, String.valueOf(size),
                  &quot;-volname&quot;, APP_NAME.fetchFrom(params),
<span class="line-modified">!                 &quot;-ov&quot;, protoDMG.getAbsolutePath(),</span>
                  &quot;-fs&quot;, &quot;HFS+&quot;);
              IOUtils.exec(pb);
          }
  
          // mount temp image
          pb = new ProcessBuilder(
                  hdiutil,
                  &quot;attach&quot;,
<span class="line-modified">!                 protoDMG.getAbsolutePath(),</span>
                  hdiUtilVerbosityFlag,
<span class="line-modified">!                 &quot;-mountroot&quot;, imagesRoot.getAbsolutePath());</span>
          IOUtils.exec(pb, false, null, true);
  
<span class="line-modified">!         File mountedRoot = new File(imagesRoot.getAbsolutePath(),</span>
<span class="line-removed">-                     APP_NAME.fetchFrom(params));</span>
  
          // Copy app image, since we did not create DMG with it, but instead we created
          // empty one.
          if (copyAppImage) {
              // In case of predefine app image srcFolder will point to app bundle, so if
              // we use it as is we will copy content of app bundle, but we need app bundle
              // folder as well.
<span class="line-modified">!             if (srcFolder.toPath().toString().toLowerCase().endsWith(&quot;.app&quot;)) {</span>
<span class="line-modified">!                 Path destPath = mountedRoot.toPath()</span>
<span class="line-modified">!                         .resolve(srcFolder.toPath().getFileName());</span>
                  Files.createDirectory(destPath);
<span class="line-modified">!                 IOUtils.copyRecursive(srcFolder.toPath(), destPath);</span>
              } else {
<span class="line-modified">!                 IOUtils.copyRecursive(srcFolder.toPath(), mountedRoot.toPath());</span>
              }
          }
  
          try {
              // background image
<span class="line-modified">!             File bgdir = new File(mountedRoot, BACKGROUND_IMAGE_FOLDER);</span>
<span class="line-modified">!             bgdir.mkdirs();</span>
              IOUtils.copyFile(getConfig_VolumeBackground(params),
<span class="line-modified">!                     new File(bgdir, BACKGROUND_IMAGE));</span>
  
              // We will not consider setting background image and creating link
              // to install-dir in DMG as critical error, since it can fail in
              // headless enviroment.
              try {
                  pb = new ProcessBuilder(&quot;osascript&quot;,
<span class="line-modified">!                         getConfig_VolumeScript(params).getAbsolutePath());</span>
                  IOUtils.exec(pb);
              } catch (IOException ex) {
                  Log.verbose(ex);
              }
  
              // volume icon
<span class="line-modified">!             File volumeIconFile = new File(mountedRoot, &quot;.VolumeIcon.icns&quot;);</span>
              IOUtils.copyFile(getConfig_VolumeIcon(params),
                      volumeIconFile);
  
              // Indicate that we want a custom icon
              // NB: attributes of the root directory are ignored
<span class="line-new-header">--- 334,73 ---</span>
  
              // Creating DMG from entire app image failed, so lets try to create empty
              // DMG and copy files manually. See JDK-8248059.
              copyAppImage = true;
  
<span class="line-modified">!             long size = new PathGroup(Map.of(new Object(), srcFolder)).sizeInBytes();</span>
              size += 50 * 1024 * 1024; // Add extra 50 megabytes. Actually DMG size will
              // not be bigger, but it will able to hold additional 50 megabytes of data.
              // We need extra room for icons and background image. When we providing
              // actual files to hdiutil, it will create DMG with ~50 megabytes extra room.
              pb = new ProcessBuilder(
                  hdiutil,
                  &quot;create&quot;,
                  hdiUtilVerbosityFlag,
                  &quot;-size&quot;, String.valueOf(size),
                  &quot;-volname&quot;, APP_NAME.fetchFrom(params),
<span class="line-modified">!                 &quot;-ov&quot;, protoDMG.toAbsolutePath().toString(),</span>
                  &quot;-fs&quot;, &quot;HFS+&quot;);
              IOUtils.exec(pb);
          }
  
          // mount temp image
          pb = new ProcessBuilder(
                  hdiutil,
                  &quot;attach&quot;,
<span class="line-modified">!                 protoDMG.toAbsolutePath().toString(),</span>
                  hdiUtilVerbosityFlag,
<span class="line-modified">!                 &quot;-mountroot&quot;, imagesRoot.toAbsolutePath().toString());</span>
          IOUtils.exec(pb, false, null, true);
  
<span class="line-modified">!         Path mountedRoot = imagesRoot.resolve(APP_NAME.fetchFrom(params));</span>
  
          // Copy app image, since we did not create DMG with it, but instead we created
          // empty one.
          if (copyAppImage) {
              // In case of predefine app image srcFolder will point to app bundle, so if
              // we use it as is we will copy content of app bundle, but we need app bundle
              // folder as well.
<span class="line-modified">!             if (srcFolder.toString().toLowerCase().endsWith(&quot;.app&quot;)) {</span>
<span class="line-modified">!                 Path destPath = mountedRoot</span>
<span class="line-modified">!                         .resolve(srcFolder.getFileName());</span>
                  Files.createDirectory(destPath);
<span class="line-modified">!                 IOUtils.copyRecursive(srcFolder, destPath);</span>
              } else {
<span class="line-modified">!                 IOUtils.copyRecursive(srcFolder, mountedRoot);</span>
              }
          }
  
          try {
              // background image
<span class="line-modified">!             Path bgdir = mountedRoot.resolve(BACKGROUND_IMAGE_FOLDER);</span>
<span class="line-modified">!             Files.createDirectories(bgdir);</span>
              IOUtils.copyFile(getConfig_VolumeBackground(params),
<span class="line-modified">!                     bgdir.resolve(BACKGROUND_IMAGE));</span>
  
              // We will not consider setting background image and creating link
              // to install-dir in DMG as critical error, since it can fail in
              // headless enviroment.
              try {
                  pb = new ProcessBuilder(&quot;osascript&quot;,
<span class="line-modified">!                         getConfig_VolumeScript(params).toAbsolutePath().toString());</span>
                  IOUtils.exec(pb);
              } catch (IOException ex) {
                  Log.verbose(ex);
              }
  
              // volume icon
<span class="line-modified">!             Path volumeIconFile = mountedRoot.resolve(&quot;.VolumeIcon.icns&quot;);</span>
              IOUtils.copyFile(getConfig_VolumeIcon(params),
                      volumeIconFile);
  
              // Indicate that we want a custom icon
              // NB: attributes of the root directory are ignored
</pre>
<hr />
<pre>
<span class="line-old-header">*** 406,26 ***</span>
              // Therefore we have to do this after we mount image
              String setFileUtility = findSetFileUtility();
              if (setFileUtility != null) {
                  //can not find utility =&gt; keep going without icon
                  try {
<span class="line-modified">!                     volumeIconFile.setWritable(true);</span>
                      // The &quot;creator&quot; attribute on a file is a legacy attribute
                      // but it seems Finder excepts these bytes to be
                      // &quot;icnC&quot; for the volume icon
                      // (might not work on Mac 10.13 with old XCode)
                      pb = new ProcessBuilder(
                              setFileUtility,
                              &quot;-c&quot;, &quot;icnC&quot;,
<span class="line-modified">!                             volumeIconFile.getAbsolutePath());</span>
                      IOUtils.exec(pb);
<span class="line-modified">!                     volumeIconFile.setReadOnly();</span>
  
                      pb = new ProcessBuilder(
                              setFileUtility,
                              &quot;-a&quot;, &quot;C&quot;,
<span class="line-modified">!                             mountedRoot.getAbsolutePath());</span>
                      IOUtils.exec(pb);
                  } catch (IOException ex) {
                      Log.error(ex.getMessage());
                      Log.verbose(&quot;Cannot enable custom icon using SetFile utility&quot;);
                  }
<span class="line-new-header">--- 408,26 ---</span>
              // Therefore we have to do this after we mount image
              String setFileUtility = findSetFileUtility();
              if (setFileUtility != null) {
                  //can not find utility =&gt; keep going without icon
                  try {
<span class="line-modified">!                     volumeIconFile.toFile().setWritable(true);</span>
                      // The &quot;creator&quot; attribute on a file is a legacy attribute
                      // but it seems Finder excepts these bytes to be
                      // &quot;icnC&quot; for the volume icon
                      // (might not work on Mac 10.13 with old XCode)
                      pb = new ProcessBuilder(
                              setFileUtility,
                              &quot;-c&quot;, &quot;icnC&quot;,
<span class="line-modified">!                             volumeIconFile.toAbsolutePath().toString());</span>
                      IOUtils.exec(pb);
<span class="line-modified">!                     volumeIconFile.toFile().setReadOnly();</span>
  
                      pb = new ProcessBuilder(
                              setFileUtility,
                              &quot;-a&quot;, &quot;C&quot;,
<span class="line-modified">!                             mountedRoot.toAbsolutePath().toString());</span>
                      IOUtils.exec(pb);
                  } catch (IOException ex) {
                      Log.error(ex.getMessage());
                      Log.verbose(&quot;Cannot enable custom icon using SetFile utility&quot;);
                  }
</pre>
<hr />
<pre>
<span class="line-old-header">*** 438,60 ***</span>
              pb = new ProcessBuilder(
                      hdiutil,
                      &quot;detach&quot;,
                      &quot;-force&quot;,
                      hdiUtilVerbosityFlag,
<span class="line-modified">!                     mountedRoot.getAbsolutePath());</span>
              IOUtils.exec(pb);
          }
  
          // Compress it to a new image
          pb = new ProcessBuilder(
                  hdiutil,
                  &quot;convert&quot;,
<span class="line-modified">!                 protoDMG.getAbsolutePath(),</span>
                  hdiUtilVerbosityFlag,
                  &quot;-format&quot;, &quot;UDZO&quot;,
<span class="line-modified">!                 &quot;-o&quot;, finalDMG.getAbsolutePath());</span>
          IOUtils.exec(pb);
  
          //add license if needed
<span class="line-modified">!         if (getConfig_LicenseFile(params).exists()) {</span>
              //hdiutil unflatten your_image_file.dmg
              pb = new ProcessBuilder(
                      hdiutil,
                      &quot;unflatten&quot;,
<span class="line-modified">!                     finalDMG.getAbsolutePath()</span>
              );
              IOUtils.exec(pb);
  
              //add license
              pb = new ProcessBuilder(
                      hdiutil,
                      &quot;udifrez&quot;,
<span class="line-modified">!                     finalDMG.getAbsolutePath(),</span>
                      &quot;-xml&quot;,
<span class="line-modified">!                     getConfig_LicenseFile(params).getAbsolutePath()</span>
              );
              IOUtils.exec(pb);
  
              //hdiutil flatten your_image_file.dmg
              pb = new ProcessBuilder(
                      hdiutil,
                      &quot;flatten&quot;,
<span class="line-modified">!                     finalDMG.getAbsolutePath()</span>
              );
              IOUtils.exec(pb);
  
          }
  
          //Delete the temporary image
<span class="line-modified">!         protoDMG.delete();</span>
  
          Log.verbose(MessageFormat.format(I18N.getString(
                  &quot;message.output-to-location&quot;),
<span class="line-modified">!                 APP_NAME.fetchFrom(params), finalDMG.getAbsolutePath()));</span>
  
          return finalDMG;
      }
  
  
<span class="line-new-header">--- 440,60 ---</span>
              pb = new ProcessBuilder(
                      hdiutil,
                      &quot;detach&quot;,
                      &quot;-force&quot;,
                      hdiUtilVerbosityFlag,
<span class="line-modified">!                     mountedRoot.toAbsolutePath().toString());</span>
              IOUtils.exec(pb);
          }
  
          // Compress it to a new image
          pb = new ProcessBuilder(
                  hdiutil,
                  &quot;convert&quot;,
<span class="line-modified">!                 protoDMG.toAbsolutePath().toString(),</span>
                  hdiUtilVerbosityFlag,
                  &quot;-format&quot;, &quot;UDZO&quot;,
<span class="line-modified">!                 &quot;-o&quot;, finalDMG.toAbsolutePath().toString());</span>
          IOUtils.exec(pb);
  
          //add license if needed
<span class="line-modified">!         if (Files.exists(getConfig_LicenseFile(params))) {</span>
              //hdiutil unflatten your_image_file.dmg
              pb = new ProcessBuilder(
                      hdiutil,
                      &quot;unflatten&quot;,
<span class="line-modified">!                     finalDMG.toAbsolutePath().toString()</span>
              );
              IOUtils.exec(pb);
  
              //add license
              pb = new ProcessBuilder(
                      hdiutil,
                      &quot;udifrez&quot;,
<span class="line-modified">!                     finalDMG.toAbsolutePath().toString(),</span>
                      &quot;-xml&quot;,
<span class="line-modified">!                     getConfig_LicenseFile(params).toAbsolutePath().toString()</span>
              );
              IOUtils.exec(pb);
  
              //hdiutil flatten your_image_file.dmg
              pb = new ProcessBuilder(
                      hdiutil,
                      &quot;flatten&quot;,
<span class="line-modified">!                     finalDMG.toAbsolutePath().toString()</span>
              );
              IOUtils.exec(pb);
  
          }
  
          //Delete the temporary image
<span class="line-modified">!         Files.deleteIfExists(protoDMG);</span>
  
          Log.verbose(MessageFormat.format(I18N.getString(
                  &quot;message.output-to-location&quot;),
<span class="line-modified">!                 APP_NAME.fetchFrom(params), finalDMG.toAbsolutePath().toString()));</span>
  
          return finalDMG;
      }
  
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 528,12 ***</span>
              }
          }
      }
  
      @Override
<span class="line-modified">!     public File execute(Map&lt;String, ? super Object&gt; params,</span>
<span class="line-modified">!             File outputParentDir) throws PackagerException {</span>
          return bundle(params, outputParentDir);
      }
  
      @Override
      public boolean supported(boolean runtimeInstaller) {
<span class="line-new-header">--- 530,12 ---</span>
              }
          }
      }
  
      @Override
<span class="line-modified">!     public Path execute(Map&lt;String, ? super Object&gt; params,</span>
<span class="line-modified">!             Path outputParentDir) throws PackagerException {</span>
          return bundle(params, outputParentDir);
      }
  
      @Override
      public boolean supported(boolean runtimeInstaller) {
</pre>
<hr />
<pre>
<span class="line-old-header">*** 543,12 ***</span>
      public final static String[] required =
              {&quot;/usr/bin/hdiutil&quot;, &quot;/usr/bin/osascript&quot;};
      public static boolean isSupported() {
          try {
              for (String s : required) {
<span class="line-modified">!                 File f = new File(s);</span>
<span class="line-modified">!                 if (!f.exists() || !f.canExecute()) {</span>
                      return false;
                  }
              }
              return true;
          } catch (Exception e) {
<span class="line-new-header">--- 545,12 ---</span>
      public final static String[] required =
              {&quot;/usr/bin/hdiutil&quot;, &quot;/usr/bin/osascript&quot;};
      public static boolean isSupported() {
          try {
              for (String s : required) {
<span class="line-modified">!                 Path f = Path.of(s);</span>
<span class="line-modified">!                 if (!Files.exists(f) || !Files.isExecutable(f)) {</span>
                      return false;
                  }
              }
              return true;
          } catch (Exception e) {
</pre>
<center><a href="MacCertificate.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="MacPkgBundler.java.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>