<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/jdk.incubator.jpackage/macosx/classes/jdk/incubator/jpackage/internal/MacDmgBundler.java</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="MacCertificate.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="MacPkgBundler.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/jdk.incubator.jpackage/macosx/classes/jdk/incubator/jpackage/internal/MacDmgBundler.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 52     private static final ResourceBundle I18N = ResourceBundle.getBundle(
 53             &quot;jdk.incubator.jpackage.internal.resources.MacResources&quot;);
 54 
 55     // Background image name in resources
 56     static final String DEFAULT_BACKGROUND_IMAGE = &quot;background_dmg.tiff&quot;;
 57     // Backround image name and folder under which it will be stored in DMG
 58     static final String BACKGROUND_IMAGE_FOLDER =&quot;.background&quot;;
 59     static final String BACKGROUND_IMAGE = &quot;background.tiff&quot;;
 60     static final String DEFAULT_DMG_SETUP_SCRIPT = &quot;DMGsetup.scpt&quot;;
 61     static final String TEMPLATE_BUNDLE_ICON = &quot;java.icns&quot;;
 62 
 63     static final String DEFAULT_LICENSE_PLIST=&quot;lic_template.plist&quot;;
 64 
 65     public static final BundlerParamInfo&lt;String&gt; INSTALLER_SUFFIX =
 66             new StandardBundlerParam&lt;&gt; (
 67             &quot;mac.dmg.installerName.suffix&quot;,
 68             String.class,
 69             params -&gt; &quot;&quot;,
 70             (s, p) -&gt; s);
 71 
<span class="line-modified"> 72     public File bundle(Map&lt;String, ? super Object&gt; params,</span>
<span class="line-modified"> 73             File outdir) throws PackagerException {</span>
 74         Log.verbose(MessageFormat.format(I18N.getString(&quot;message.building-dmg&quot;),
 75                 APP_NAME.fetchFrom(params)));
 76 
<span class="line-modified"> 77         IOUtils.writableOutputDir(outdir.toPath());</span>
 78 
 79         try {
<span class="line-modified"> 80             File appLocation = prepareAppBundle(params);</span>
 81 
 82             if (appLocation != null &amp;&amp; prepareConfigFiles(params)) {
<span class="line-modified"> 83                 File configScript = getConfig_Script(params);</span>
<span class="line-modified"> 84                 if (configScript.exists()) {</span>
 85                     Log.verbose(MessageFormat.format(
 86                             I18N.getString(&quot;message.running-script&quot;),
<span class="line-modified"> 87                             configScript.getAbsolutePath()));</span>
 88                     IOUtils.run(&quot;bash&quot;, configScript);
 89                 }
 90 
 91                 return buildDMG(params, appLocation, outdir);
 92             }
 93             return null;
 94         } catch (IOException | PackagerException ex) {
 95             Log.verbose(ex);
 96             throw new PackagerException(ex);
 97         }
 98     }
 99 
100     private static final String hdiutil = &quot;/usr/bin/hdiutil&quot;;
101 
102     private void prepareDMGSetupScript(Map&lt;String, ? super Object&gt; params)
103                                                                     throws IOException {
<span class="line-modified">104         File dmgSetup = getConfig_VolumeScript(params);</span>
105         Log.verbose(MessageFormat.format(
106                 I18N.getString(&quot;message.preparing-dmg-setup&quot;),
<span class="line-modified">107                 dmgSetup.getAbsolutePath()));</span>
108 
109         // We need to use URL for DMG to find it. We cannot use volume name, since
110         // user might have open DMG with same volume name already. Url should end with
111         // &#39;/&#39; and it should be real path (no symbolic links).
<span class="line-modified">112         File imageDir = IMAGES_ROOT.fetchFrom(params);</span>
<span class="line-modified">113         if (!imageDir.exists()) imageDir.mkdirs(); // Create it, since it does not exist</span>



114         Path rootPath = Path.of(imageDir.toString()).toRealPath();
115         Path volumePath = rootPath.resolve(APP_NAME.fetchFrom(params));
116         String volumeUrl = volumePath.toUri().toString() + File.separator;
117 
118         // Provide full path to backround image, so we can find it.
119         Path bgFile = Path.of(rootPath.toString(), APP_NAME.fetchFrom(params),
120                               BACKGROUND_IMAGE_FOLDER, BACKGROUND_IMAGE);
121 
122         //prepare config for exe
123         Map&lt;String, String&gt; data = new HashMap&lt;&gt;();
124         data.put(&quot;DEPLOY_VOLUME_URL&quot;, volumeUrl);
125         data.put(&quot;DEPLOY_BG_FILE&quot;, bgFile.toString());
126         data.put(&quot;DEPLOY_VOLUME_PATH&quot;, volumePath.toString());
127         data.put(&quot;DEPLOY_APPLICATION_NAME&quot;, APP_NAME.fetchFrom(params));
128 
129         data.put(&quot;DEPLOY_INSTALL_LOCATION&quot;, getInstallDir(params));
130 
131         createResource(DEFAULT_DMG_SETUP_SCRIPT, params)
132                 .setCategory(I18N.getString(&quot;resource.dmg-setup-script&quot;))
133                 .setSubstitutionData(data)
134                 .saveToFile(dmgSetup);
135     }
136 
<span class="line-modified">137     private File getConfig_VolumeScript(Map&lt;String, ? super Object&gt; params) {</span>
<span class="line-modified">138         return new File(CONFIG_ROOT.fetchFrom(params),</span>
139                 APP_NAME.fetchFrom(params) + &quot;-dmg-setup.scpt&quot;);
140     }
141 
<span class="line-modified">142     private File getConfig_VolumeBackground(</span>
143             Map&lt;String, ? super Object&gt; params) {
<span class="line-modified">144         return new File(CONFIG_ROOT.fetchFrom(params),</span>
145                 APP_NAME.fetchFrom(params) + &quot;-background.tiff&quot;);
146     }
147 
<span class="line-modified">148     private File getConfig_VolumeIcon(Map&lt;String, ? super Object&gt; params) {</span>
<span class="line-modified">149         return new File(CONFIG_ROOT.fetchFrom(params),</span>
150                 APP_NAME.fetchFrom(params) + &quot;-volume.icns&quot;);
151     }
152 
<span class="line-modified">153     private File getConfig_LicenseFile(Map&lt;String, ? super Object&gt; params) {</span>
<span class="line-modified">154         return new File(CONFIG_ROOT.fetchFrom(params),</span>
155                 APP_NAME.fetchFrom(params) + &quot;-license.plist&quot;);
156     }
157 
158     private void prepareLicense(Map&lt;String, ? super Object&gt; params) {
159         try {
160             String licFileStr = LICENSE_FILE.fetchFrom(params);
161             if (licFileStr == null) {
162                 return;
163             }
164 
<span class="line-modified">165             File licFile = new File(licFileStr);</span>
166             byte[] licenseContentOriginal =
<span class="line-modified">167                     Files.readAllBytes(licFile.toPath());</span>
168             String licenseInBase64 =
169                     Base64.getEncoder().encodeToString(licenseContentOriginal);
170 
171             Map&lt;String, String&gt; data = new HashMap&lt;&gt;();
172             data.put(&quot;APPLICATION_LICENSE_TEXT&quot;, licenseInBase64);
173 
174             createResource(DEFAULT_LICENSE_PLIST, params)
175                     .setCategory(I18N.getString(&quot;resource.license-setup&quot;))
176                     .setSubstitutionData(data)
177                     .saveToFile(getConfig_LicenseFile(params));
178 
179         } catch (IOException ex) {
180             Log.verbose(ex);
181         }
182     }
183 
184     private boolean prepareConfigFiles(Map&lt;String, ? super Object&gt; params)
185             throws IOException {
186 
187         createResource(DEFAULT_BACKGROUND_IMAGE, params)
188                     .setCategory(I18N.getString(&quot;resource.dmg-background&quot;))
189                     .saveToFile(getConfig_VolumeBackground(params));
190 
191         createResource(TEMPLATE_BUNDLE_ICON, params)
192                 .setCategory(I18N.getString(&quot;resource.volume-icon&quot;))
193                 .setExternal(ICON_ICNS.fetchFrom(params))
194                 .saveToFile(getConfig_VolumeIcon(params));
195 
196         createResource(null, params)
197                 .setCategory(I18N.getString(&quot;resource.post-install-script&quot;))
198                 .saveToFile(getConfig_Script(params));
199 
200         prepareLicense(params);
201 
202         prepareDMGSetupScript(params);
203 
204         return true;
205     }
206 
207     // name of post-image script
<span class="line-modified">208     private File getConfig_Script(Map&lt;String, ? super Object&gt; params) {</span>
<span class="line-modified">209         return new File(CONFIG_ROOT.fetchFrom(params),</span>
210                 APP_NAME.fetchFrom(params) + &quot;-post-image.sh&quot;);
211     }
212 
213     // Location of SetFile utility may be different depending on MacOS version
214     // We look for several known places and if none of them work will
215     // try ot find it
216     private String findSetFileUtility() {
217         String typicalPaths[] = {&quot;/Developer/Tools/SetFile&quot;,
218                 &quot;/usr/bin/SetFile&quot;, &quot;/Developer/usr/bin/SetFile&quot;};
219 
220         String setFilePath = null;
<span class="line-modified">221         for (String path: typicalPaths) {</span>
<span class="line-modified">222             File f = new File(path);</span>
<span class="line-modified">223             if (f.exists() &amp;&amp; f.canExecute()) {</span>
224                 setFilePath = path;
225                 break;
226             }
227         }
228 
229         // Validate SetFile, if Xcode is not installed it will run, but exit with error
230         // code
231         if (setFilePath != null) {
232             try {
233                 ProcessBuilder pb = new ProcessBuilder(setFilePath, &quot;-h&quot;);
234                 Process p = pb.start();
235                 int code = p.waitFor();
236                 if (code == 0) {
237                     return setFilePath;
238                 }
239             } catch (Exception ignored) {}
240 
241             // No need for generic find attempt. We found it, but it does not work.
242             // Probably due to missing xcode.
243             return null;
244         }
245 
246         // generic find attempt
247         try {
248             ProcessBuilder pb = new ProcessBuilder(&quot;xcrun&quot;, &quot;-find&quot;, &quot;SetFile&quot;);
249             Process p = pb.start();
250             InputStreamReader isr = new InputStreamReader(p.getInputStream());
251             BufferedReader br = new BufferedReader(isr);
252             String lineRead = br.readLine();
253             if (lineRead != null) {
<span class="line-modified">254                 File f = new File(lineRead);</span>
<span class="line-modified">255                 if (f.exists() &amp;&amp; f.canExecute()) {</span>
<span class="line-modified">256                     return f.getAbsolutePath();</span>
257                 }
258             }
259         } catch (IOException ignored) {}
260 
261         return null;
262     }
263 
<span class="line-modified">264     private File buildDMG( Map&lt;String, ? super Object&gt; params,</span>
<span class="line-modified">265             File appLocation, File outdir) throws IOException, PackagerException {</span>
266         boolean copyAppImage = false;
<span class="line-modified">267         File imagesRoot = IMAGES_ROOT.fetchFrom(params);</span>
<span class="line-modified">268         if (!imagesRoot.exists()) imagesRoot.mkdirs();</span>


269 
<span class="line-modified">270         File protoDMG = new File(imagesRoot,</span>
<span class="line-modified">271                 APP_NAME.fetchFrom(params) +&quot;-tmp.dmg&quot;);</span>
<span class="line-removed">272         File finalDMG = new File(outdir, INSTALLER_NAME.fetchFrom(params)</span>
273                 + INSTALLER_SUFFIX.fetchFrom(params) + &quot;.dmg&quot;);
274 
<span class="line-modified">275         File srcFolder = APP_IMAGE_TEMP_ROOT.fetchFrom(params);</span>
<span class="line-modified">276         File predefinedImage =</span>
<span class="line-removed">277                 StandardBundlerParam.getPredefinedAppImage(params);</span>
278         if (predefinedImage != null) {
279             srcFolder = predefinedImage;
280         } else if (StandardBundlerParam.isRuntimeInstaller(params)) {
<span class="line-modified">281             Path newRoot = Files.createTempDirectory(</span>
<span class="line-modified">282                 TEMP_ROOT.fetchFrom(params).toPath(), &quot;root-&quot;);</span>
283 
284             // first, is this already a runtime with
285             // &lt;runtime&gt;/Contents/Home - if so we need the Home dir
<span class="line-modified">286             Path original = appLocation.toPath();</span>
<span class="line-modified">287             Path home = original.resolve(&quot;Contents/Home&quot;);</span>
<span class="line-removed">288             Path source = (Files.exists(home)) ? home : original;</span>
289 
290             // Then we need to put back the &lt;NAME&gt;/Content/Home
291             Path root = newRoot.resolve(
292                     MAC_CF_BUNDLE_IDENTIFIER.fetchFrom(params));
293             Path dest = root.resolve(&quot;Contents/Home&quot;);
294 
295             IOUtils.copyRecursive(source, dest);
296 
<span class="line-modified">297             srcFolder = newRoot.toFile();</span>
298         }
299 
300         Log.verbose(MessageFormat.format(I18N.getString(
<span class="line-modified">301                 &quot;message.creating-dmg-file&quot;), finalDMG.getAbsolutePath()));</span>
302 
<span class="line-modified">303         protoDMG.delete();</span>
<span class="line-modified">304         if (finalDMG.exists() &amp;&amp; !finalDMG.delete()) {</span>


305             throw new IOException(MessageFormat.format(I18N.getString(
306                     &quot;message.dmg-cannot-be-overwritten&quot;),
<span class="line-modified">307                     finalDMG.getAbsolutePath()));</span>
308         }
309 
<span class="line-modified">310         protoDMG.getParentFile().mkdirs();</span>
<span class="line-modified">311         finalDMG.getParentFile().mkdirs();</span>
312 
313         String hdiUtilVerbosityFlag = VERBOSE.fetchFrom(params) ?
314                 &quot;-verbose&quot; : &quot;-quiet&quot;;
315 
316         // create temp image
317         ProcessBuilder pb = new ProcessBuilder(
318                 hdiutil,
319                 &quot;create&quot;,
320                 hdiUtilVerbosityFlag,
<span class="line-modified">321                 &quot;-srcfolder&quot;, srcFolder.getAbsolutePath(),</span>
322                 &quot;-volname&quot;, APP_NAME.fetchFrom(params),
<span class="line-modified">323                 &quot;-ov&quot;, protoDMG.getAbsolutePath(),</span>
324                 &quot;-fs&quot;, &quot;HFS+&quot;,
325                 &quot;-format&quot;, &quot;UDRW&quot;);
326         try {
327             IOUtils.exec(pb);
328         } catch (IOException ex) {
329             Log.verbose(ex); // Log exception
330 
331             // Creating DMG from entire app image failed, so lets try to create empty
332             // DMG and copy files manually. See JDK-8248059.
333             copyAppImage = true;
334 
<span class="line-modified">335             long size = new PathGroup(Map.of(new Object(), srcFolder.toPath()))</span>
<span class="line-removed">336                     .sizeInBytes();</span>
337             size += 50 * 1024 * 1024; // Add extra 50 megabytes. Actually DMG size will
338             // not be bigger, but it will able to hold additional 50 megabytes of data.
339             // We need extra room for icons and background image. When we providing
340             // actual files to hdiutil, it will create DMG with ~50 megabytes extra room.
341             pb = new ProcessBuilder(
342                 hdiutil,
343                 &quot;create&quot;,
344                 hdiUtilVerbosityFlag,
345                 &quot;-size&quot;, String.valueOf(size),
346                 &quot;-volname&quot;, APP_NAME.fetchFrom(params),
<span class="line-modified">347                 &quot;-ov&quot;, protoDMG.getAbsolutePath(),</span>
348                 &quot;-fs&quot;, &quot;HFS+&quot;);
349             IOUtils.exec(pb);
350         }
351 
352         // mount temp image
353         pb = new ProcessBuilder(
354                 hdiutil,
355                 &quot;attach&quot;,
<span class="line-modified">356                 protoDMG.getAbsolutePath(),</span>
357                 hdiUtilVerbosityFlag,
<span class="line-modified">358                 &quot;-mountroot&quot;, imagesRoot.getAbsolutePath());</span>
359         IOUtils.exec(pb, false, null, true);
360 
<span class="line-modified">361         File mountedRoot = new File(imagesRoot.getAbsolutePath(),</span>
<span class="line-removed">362                     APP_NAME.fetchFrom(params));</span>
363 
364         // Copy app image, since we did not create DMG with it, but instead we created
365         // empty one.
366         if (copyAppImage) {
367             // In case of predefine app image srcFolder will point to app bundle, so if
368             // we use it as is we will copy content of app bundle, but we need app bundle
369             // folder as well.
<span class="line-modified">370             if (srcFolder.toPath().toString().toLowerCase().endsWith(&quot;.app&quot;)) {</span>
<span class="line-modified">371                 Path destPath = mountedRoot.toPath()</span>
<span class="line-modified">372                         .resolve(srcFolder.toPath().getFileName());</span>
373                 Files.createDirectory(destPath);
<span class="line-modified">374                 IOUtils.copyRecursive(srcFolder.toPath(), destPath);</span>
375             } else {
<span class="line-modified">376                 IOUtils.copyRecursive(srcFolder.toPath(), mountedRoot.toPath());</span>
377             }
378         }
379 
380         try {
381             // background image
<span class="line-modified">382             File bgdir = new File(mountedRoot, BACKGROUND_IMAGE_FOLDER);</span>
<span class="line-modified">383             bgdir.mkdirs();</span>
384             IOUtils.copyFile(getConfig_VolumeBackground(params),
<span class="line-modified">385                     new File(bgdir, BACKGROUND_IMAGE));</span>
386 
387             // We will not consider setting background image and creating link
388             // to install-dir in DMG as critical error, since it can fail in
389             // headless enviroment.
390             try {
391                 pb = new ProcessBuilder(&quot;osascript&quot;,
<span class="line-modified">392                         getConfig_VolumeScript(params).getAbsolutePath());</span>
393                 IOUtils.exec(pb);
394             } catch (IOException ex) {
395                 Log.verbose(ex);
396             }
397 
398             // volume icon
<span class="line-modified">399             File volumeIconFile = new File(mountedRoot, &quot;.VolumeIcon.icns&quot;);</span>
400             IOUtils.copyFile(getConfig_VolumeIcon(params),
401                     volumeIconFile);
402 
403             // Indicate that we want a custom icon
404             // NB: attributes of the root directory are ignored
405             // when creating the volume
406             // Therefore we have to do this after we mount image
407             String setFileUtility = findSetFileUtility();
408             if (setFileUtility != null) {
409                 //can not find utility =&gt; keep going without icon
410                 try {
<span class="line-modified">411                     volumeIconFile.setWritable(true);</span>
412                     // The &quot;creator&quot; attribute on a file is a legacy attribute
413                     // but it seems Finder excepts these bytes to be
414                     // &quot;icnC&quot; for the volume icon
415                     // (might not work on Mac 10.13 with old XCode)
416                     pb = new ProcessBuilder(
417                             setFileUtility,
418                             &quot;-c&quot;, &quot;icnC&quot;,
<span class="line-modified">419                             volumeIconFile.getAbsolutePath());</span>
420                     IOUtils.exec(pb);
<span class="line-modified">421                     volumeIconFile.setReadOnly();</span>
422 
423                     pb = new ProcessBuilder(
424                             setFileUtility,
425                             &quot;-a&quot;, &quot;C&quot;,
<span class="line-modified">426                             mountedRoot.getAbsolutePath());</span>
427                     IOUtils.exec(pb);
428                 } catch (IOException ex) {
429                     Log.error(ex.getMessage());
430                     Log.verbose(&quot;Cannot enable custom icon using SetFile utility&quot;);
431                 }
432             } else {
433                 Log.verbose(I18N.getString(&quot;message.setfile.dmg&quot;));
434             }
435 
436         } finally {
437             // Detach the temporary image
438             pb = new ProcessBuilder(
439                     hdiutil,
440                     &quot;detach&quot;,
441                     &quot;-force&quot;,
442                     hdiUtilVerbosityFlag,
<span class="line-modified">443                     mountedRoot.getAbsolutePath());</span>
444             IOUtils.exec(pb);
445         }
446 
447         // Compress it to a new image
448         pb = new ProcessBuilder(
449                 hdiutil,
450                 &quot;convert&quot;,
<span class="line-modified">451                 protoDMG.getAbsolutePath(),</span>
452                 hdiUtilVerbosityFlag,
453                 &quot;-format&quot;, &quot;UDZO&quot;,
<span class="line-modified">454                 &quot;-o&quot;, finalDMG.getAbsolutePath());</span>
455         IOUtils.exec(pb);
456 
457         //add license if needed
<span class="line-modified">458         if (getConfig_LicenseFile(params).exists()) {</span>
459             //hdiutil unflatten your_image_file.dmg
460             pb = new ProcessBuilder(
461                     hdiutil,
462                     &quot;unflatten&quot;,
<span class="line-modified">463                     finalDMG.getAbsolutePath()</span>
464             );
465             IOUtils.exec(pb);
466 
467             //add license
468             pb = new ProcessBuilder(
469                     hdiutil,
470                     &quot;udifrez&quot;,
<span class="line-modified">471                     finalDMG.getAbsolutePath(),</span>
472                     &quot;-xml&quot;,
<span class="line-modified">473                     getConfig_LicenseFile(params).getAbsolutePath()</span>
474             );
475             IOUtils.exec(pb);
476 
477             //hdiutil flatten your_image_file.dmg
478             pb = new ProcessBuilder(
479                     hdiutil,
480                     &quot;flatten&quot;,
<span class="line-modified">481                     finalDMG.getAbsolutePath()</span>
482             );
483             IOUtils.exec(pb);
484 
485         }
486 
487         //Delete the temporary image
<span class="line-modified">488         protoDMG.delete();</span>
489 
490         Log.verbose(MessageFormat.format(I18N.getString(
491                 &quot;message.output-to-location&quot;),
<span class="line-modified">492                 APP_NAME.fetchFrom(params), finalDMG.getAbsolutePath()));</span>
493 
494         return finalDMG;
495     }
496 
497 
498     //////////////////////////////////////////////////////////////////////////
499     // Implement Bundler
500     //////////////////////////////////////////////////////////////////////////
501 
502     @Override
503     public String getName() {
504         return I18N.getString(&quot;dmg.bundler.name&quot;);
505     }
506 
507     @Override
508     public String getID() {
509         return &quot;dmg&quot;;
510     }
511 
512     @Override
513     public boolean validate(Map&lt;String, ? super Object&gt; params)
514             throws ConfigException {
515         try {
516             Objects.requireNonNull(params);
517 
518             //run basic validation to ensure requirements are met
519             //we are not interested in return code, only possible exception
520             validateAppImageAndBundeler(params);
521 
522             return true;
523         } catch (RuntimeException re) {
524             if (re.getCause() instanceof ConfigException) {
525                 throw (ConfigException) re.getCause();
526             } else {
527                 throw new ConfigException(re);
528             }
529         }
530     }
531 
532     @Override
<span class="line-modified">533     public File execute(Map&lt;String, ? super Object&gt; params,</span>
<span class="line-modified">534             File outputParentDir) throws PackagerException {</span>
535         return bundle(params, outputParentDir);
536     }
537 
538     @Override
539     public boolean supported(boolean runtimeInstaller) {
540         return isSupported();
541     }
542 
543     public final static String[] required =
544             {&quot;/usr/bin/hdiutil&quot;, &quot;/usr/bin/osascript&quot;};
545     public static boolean isSupported() {
546         try {
547             for (String s : required) {
<span class="line-modified">548                 File f = new File(s);</span>
<span class="line-modified">549                 if (!f.exists() || !f.canExecute()) {</span>
550                     return false;
551                 }
552             }
553             return true;
554         } catch (Exception e) {
555             return false;
556         }
557     }
558 
559     @Override
560     public boolean isDefault() {
561         return true;
562     }
563 }
</pre>
</td>
<td>
<hr />
<pre>
 52     private static final ResourceBundle I18N = ResourceBundle.getBundle(
 53             &quot;jdk.incubator.jpackage.internal.resources.MacResources&quot;);
 54 
 55     // Background image name in resources
 56     static final String DEFAULT_BACKGROUND_IMAGE = &quot;background_dmg.tiff&quot;;
 57     // Backround image name and folder under which it will be stored in DMG
 58     static final String BACKGROUND_IMAGE_FOLDER =&quot;.background&quot;;
 59     static final String BACKGROUND_IMAGE = &quot;background.tiff&quot;;
 60     static final String DEFAULT_DMG_SETUP_SCRIPT = &quot;DMGsetup.scpt&quot;;
 61     static final String TEMPLATE_BUNDLE_ICON = &quot;java.icns&quot;;
 62 
 63     static final String DEFAULT_LICENSE_PLIST=&quot;lic_template.plist&quot;;
 64 
 65     public static final BundlerParamInfo&lt;String&gt; INSTALLER_SUFFIX =
 66             new StandardBundlerParam&lt;&gt; (
 67             &quot;mac.dmg.installerName.suffix&quot;,
 68             String.class,
 69             params -&gt; &quot;&quot;,
 70             (s, p) -&gt; s);
 71 
<span class="line-modified"> 72     public Path bundle(Map&lt;String, ? super Object&gt; params,</span>
<span class="line-modified"> 73             Path outdir) throws PackagerException {</span>
 74         Log.verbose(MessageFormat.format(I18N.getString(&quot;message.building-dmg&quot;),
 75                 APP_NAME.fetchFrom(params)));
 76 
<span class="line-modified"> 77         IOUtils.writableOutputDir(outdir);</span>
 78 
 79         try {
<span class="line-modified"> 80             Path appLocation = prepareAppBundle(params);</span>
 81 
 82             if (appLocation != null &amp;&amp; prepareConfigFiles(params)) {
<span class="line-modified"> 83                 Path configScript = getConfig_Script(params);</span>
<span class="line-modified"> 84                 if (IOUtils.exists(configScript)) {</span>
 85                     Log.verbose(MessageFormat.format(
 86                             I18N.getString(&quot;message.running-script&quot;),
<span class="line-modified"> 87                             configScript.toAbsolutePath().toString()));</span>
 88                     IOUtils.run(&quot;bash&quot;, configScript);
 89                 }
 90 
 91                 return buildDMG(params, appLocation, outdir);
 92             }
 93             return null;
 94         } catch (IOException | PackagerException ex) {
 95             Log.verbose(ex);
 96             throw new PackagerException(ex);
 97         }
 98     }
 99 
100     private static final String hdiutil = &quot;/usr/bin/hdiutil&quot;;
101 
102     private void prepareDMGSetupScript(Map&lt;String, ? super Object&gt; params)
103                                                                     throws IOException {
<span class="line-modified">104         Path dmgSetup = getConfig_VolumeScript(params);</span>
105         Log.verbose(MessageFormat.format(
106                 I18N.getString(&quot;message.preparing-dmg-setup&quot;),
<span class="line-modified">107                 dmgSetup.toAbsolutePath().toString()));</span>
108 
109         // We need to use URL for DMG to find it. We cannot use volume name, since
110         // user might have open DMG with same volume name already. Url should end with
111         // &#39;/&#39; and it should be real path (no symbolic links).
<span class="line-modified">112         Path imageDir = IMAGES_ROOT.fetchFrom(params);</span>
<span class="line-modified">113         if (!Files.exists(imageDir)) {</span>
<span class="line-added">114              // Create it, since it does not exist</span>
<span class="line-added">115              Files.createDirectories(imageDir);</span>
<span class="line-added">116         }</span>
117         Path rootPath = Path.of(imageDir.toString()).toRealPath();
118         Path volumePath = rootPath.resolve(APP_NAME.fetchFrom(params));
119         String volumeUrl = volumePath.toUri().toString() + File.separator;
120 
121         // Provide full path to backround image, so we can find it.
122         Path bgFile = Path.of(rootPath.toString(), APP_NAME.fetchFrom(params),
123                               BACKGROUND_IMAGE_FOLDER, BACKGROUND_IMAGE);
124 
125         //prepare config for exe
126         Map&lt;String, String&gt; data = new HashMap&lt;&gt;();
127         data.put(&quot;DEPLOY_VOLUME_URL&quot;, volumeUrl);
128         data.put(&quot;DEPLOY_BG_FILE&quot;, bgFile.toString());
129         data.put(&quot;DEPLOY_VOLUME_PATH&quot;, volumePath.toString());
130         data.put(&quot;DEPLOY_APPLICATION_NAME&quot;, APP_NAME.fetchFrom(params));
131 
132         data.put(&quot;DEPLOY_INSTALL_LOCATION&quot;, getInstallDir(params));
133 
134         createResource(DEFAULT_DMG_SETUP_SCRIPT, params)
135                 .setCategory(I18N.getString(&quot;resource.dmg-setup-script&quot;))
136                 .setSubstitutionData(data)
137                 .saveToFile(dmgSetup);
138     }
139 
<span class="line-modified">140     private Path getConfig_VolumeScript(Map&lt;String, ? super Object&gt; params) {</span>
<span class="line-modified">141         return CONFIG_ROOT.fetchFrom(params).resolve(</span>
142                 APP_NAME.fetchFrom(params) + &quot;-dmg-setup.scpt&quot;);
143     }
144 
<span class="line-modified">145     private Path getConfig_VolumeBackground(</span>
146             Map&lt;String, ? super Object&gt; params) {
<span class="line-modified">147         return CONFIG_ROOT.fetchFrom(params).resolve(</span>
148                 APP_NAME.fetchFrom(params) + &quot;-background.tiff&quot;);
149     }
150 
<span class="line-modified">151     private Path getConfig_VolumeIcon(Map&lt;String, ? super Object&gt; params) {</span>
<span class="line-modified">152         return CONFIG_ROOT.fetchFrom(params).resolve(</span>
153                 APP_NAME.fetchFrom(params) + &quot;-volume.icns&quot;);
154     }
155 
<span class="line-modified">156     private Path getConfig_LicenseFile(Map&lt;String, ? super Object&gt; params) {</span>
<span class="line-modified">157         return CONFIG_ROOT.fetchFrom(params).resolve(</span>
158                 APP_NAME.fetchFrom(params) + &quot;-license.plist&quot;);
159     }
160 
161     private void prepareLicense(Map&lt;String, ? super Object&gt; params) {
162         try {
163             String licFileStr = LICENSE_FILE.fetchFrom(params);
164             if (licFileStr == null) {
165                 return;
166             }
167 
<span class="line-modified">168             Path licFile = Path.of(licFileStr);</span>
169             byte[] licenseContentOriginal =
<span class="line-modified">170                     Files.readAllBytes(licFile);</span>
171             String licenseInBase64 =
172                     Base64.getEncoder().encodeToString(licenseContentOriginal);
173 
174             Map&lt;String, String&gt; data = new HashMap&lt;&gt;();
175             data.put(&quot;APPLICATION_LICENSE_TEXT&quot;, licenseInBase64);
176 
177             createResource(DEFAULT_LICENSE_PLIST, params)
178                     .setCategory(I18N.getString(&quot;resource.license-setup&quot;))
179                     .setSubstitutionData(data)
180                     .saveToFile(getConfig_LicenseFile(params));
181 
182         } catch (IOException ex) {
183             Log.verbose(ex);
184         }
185     }
186 
187     private boolean prepareConfigFiles(Map&lt;String, ? super Object&gt; params)
188             throws IOException {
189 
190         createResource(DEFAULT_BACKGROUND_IMAGE, params)
191                     .setCategory(I18N.getString(&quot;resource.dmg-background&quot;))
192                     .saveToFile(getConfig_VolumeBackground(params));
193 
194         createResource(TEMPLATE_BUNDLE_ICON, params)
195                 .setCategory(I18N.getString(&quot;resource.volume-icon&quot;))
196                 .setExternal(ICON_ICNS.fetchFrom(params))
197                 .saveToFile(getConfig_VolumeIcon(params));
198 
199         createResource(null, params)
200                 .setCategory(I18N.getString(&quot;resource.post-install-script&quot;))
201                 .saveToFile(getConfig_Script(params));
202 
203         prepareLicense(params);
204 
205         prepareDMGSetupScript(params);
206 
207         return true;
208     }
209 
210     // name of post-image script
<span class="line-modified">211     private Path getConfig_Script(Map&lt;String, ? super Object&gt; params) {</span>
<span class="line-modified">212         return CONFIG_ROOT.fetchFrom(params).resolve(</span>
213                 APP_NAME.fetchFrom(params) + &quot;-post-image.sh&quot;);
214     }
215 
216     // Location of SetFile utility may be different depending on MacOS version
217     // We look for several known places and if none of them work will
218     // try ot find it
219     private String findSetFileUtility() {
220         String typicalPaths[] = {&quot;/Developer/Tools/SetFile&quot;,
221                 &quot;/usr/bin/SetFile&quot;, &quot;/Developer/usr/bin/SetFile&quot;};
222 
223         String setFilePath = null;
<span class="line-modified">224         for (String path : typicalPaths) {</span>
<span class="line-modified">225             Path f = Path.of(path);</span>
<span class="line-modified">226             if (Files.exists(f) &amp;&amp; Files.isExecutable(f)) {</span>
227                 setFilePath = path;
228                 break;
229             }
230         }
231 
232         // Validate SetFile, if Xcode is not installed it will run, but exit with error
233         // code
234         if (setFilePath != null) {
235             try {
236                 ProcessBuilder pb = new ProcessBuilder(setFilePath, &quot;-h&quot;);
237                 Process p = pb.start();
238                 int code = p.waitFor();
239                 if (code == 0) {
240                     return setFilePath;
241                 }
242             } catch (Exception ignored) {}
243 
244             // No need for generic find attempt. We found it, but it does not work.
245             // Probably due to missing xcode.
246             return null;
247         }
248 
249         // generic find attempt
250         try {
251             ProcessBuilder pb = new ProcessBuilder(&quot;xcrun&quot;, &quot;-find&quot;, &quot;SetFile&quot;);
252             Process p = pb.start();
253             InputStreamReader isr = new InputStreamReader(p.getInputStream());
254             BufferedReader br = new BufferedReader(isr);
255             String lineRead = br.readLine();
256             if (lineRead != null) {
<span class="line-modified">257                 Path f = Path.of(lineRead);</span>
<span class="line-modified">258                 if (Files.exists(f) &amp;&amp; Files.isExecutable(f)) {</span>
<span class="line-modified">259                     return f.toAbsolutePath().toString();</span>
260                 }
261             }
262         } catch (IOException ignored) {}
263 
264         return null;
265     }
266 
<span class="line-modified">267     private Path buildDMG( Map&lt;String, ? super Object&gt; params,</span>
<span class="line-modified">268             Path appLocation, Path outdir) throws IOException {</span>
269         boolean copyAppImage = false;
<span class="line-modified">270         Path imagesRoot = IMAGES_ROOT.fetchFrom(params);</span>
<span class="line-modified">271         if (!Files.exists(imagesRoot)) {</span>
<span class="line-added">272             Files.createDirectories(imagesRoot);</span>
<span class="line-added">273         }</span>
274 
<span class="line-modified">275         Path protoDMG = imagesRoot.resolve(APP_NAME.fetchFrom(params) +&quot;-tmp.dmg&quot;);</span>
<span class="line-modified">276         Path finalDMG = outdir.resolve(INSTALLER_NAME.fetchFrom(params)</span>

277                 + INSTALLER_SUFFIX.fetchFrom(params) + &quot;.dmg&quot;);
278 
<span class="line-modified">279         Path srcFolder = APP_IMAGE_TEMP_ROOT.fetchFrom(params);</span>
<span class="line-modified">280         Path predefinedImage = StandardBundlerParam.getPredefinedAppImage(params);</span>

281         if (predefinedImage != null) {
282             srcFolder = predefinedImage;
283         } else if (StandardBundlerParam.isRuntimeInstaller(params)) {
<span class="line-modified">284             Path newRoot = Files.createTempDirectory(TEMP_ROOT.fetchFrom(params),</span>
<span class="line-modified">285                     &quot;root-&quot;);</span>
286 
287             // first, is this already a runtime with
288             // &lt;runtime&gt;/Contents/Home - if so we need the Home dir
<span class="line-modified">289             Path home = appLocation.resolve(&quot;Contents/Home&quot;);</span>
<span class="line-modified">290             Path source = (Files.exists(home)) ? home : appLocation;</span>

291 
292             // Then we need to put back the &lt;NAME&gt;/Content/Home
293             Path root = newRoot.resolve(
294                     MAC_CF_BUNDLE_IDENTIFIER.fetchFrom(params));
295             Path dest = root.resolve(&quot;Contents/Home&quot;);
296 
297             IOUtils.copyRecursive(source, dest);
298 
<span class="line-modified">299             srcFolder = newRoot;</span>
300         }
301 
302         Log.verbose(MessageFormat.format(I18N.getString(
<span class="line-modified">303                 &quot;message.creating-dmg-file&quot;), finalDMG.toAbsolutePath()));</span>
304 
<span class="line-modified">305         Files.deleteIfExists(protoDMG);</span>
<span class="line-modified">306         try {</span>
<span class="line-added">307             Files.deleteIfExists(finalDMG);</span>
<span class="line-added">308         } catch (IOException ex) {</span>
309             throw new IOException(MessageFormat.format(I18N.getString(
310                     &quot;message.dmg-cannot-be-overwritten&quot;),
<span class="line-modified">311                     finalDMG.toAbsolutePath()));</span>
312         }
313 
<span class="line-modified">314         Files.createDirectories(protoDMG.getParent());</span>
<span class="line-modified">315         Files.createDirectories(finalDMG.getParent());</span>
316 
317         String hdiUtilVerbosityFlag = VERBOSE.fetchFrom(params) ?
318                 &quot;-verbose&quot; : &quot;-quiet&quot;;
319 
320         // create temp image
321         ProcessBuilder pb = new ProcessBuilder(
322                 hdiutil,
323                 &quot;create&quot;,
324                 hdiUtilVerbosityFlag,
<span class="line-modified">325                 &quot;-srcfolder&quot;, srcFolder.toAbsolutePath().toString(),</span>
326                 &quot;-volname&quot;, APP_NAME.fetchFrom(params),
<span class="line-modified">327                 &quot;-ov&quot;, protoDMG.toAbsolutePath().toString(),</span>
328                 &quot;-fs&quot;, &quot;HFS+&quot;,
329                 &quot;-format&quot;, &quot;UDRW&quot;);
330         try {
331             IOUtils.exec(pb);
332         } catch (IOException ex) {
333             Log.verbose(ex); // Log exception
334 
335             // Creating DMG from entire app image failed, so lets try to create empty
336             // DMG and copy files manually. See JDK-8248059.
337             copyAppImage = true;
338 
<span class="line-modified">339             long size = new PathGroup(Map.of(new Object(), srcFolder)).sizeInBytes();</span>

340             size += 50 * 1024 * 1024; // Add extra 50 megabytes. Actually DMG size will
341             // not be bigger, but it will able to hold additional 50 megabytes of data.
342             // We need extra room for icons and background image. When we providing
343             // actual files to hdiutil, it will create DMG with ~50 megabytes extra room.
344             pb = new ProcessBuilder(
345                 hdiutil,
346                 &quot;create&quot;,
347                 hdiUtilVerbosityFlag,
348                 &quot;-size&quot;, String.valueOf(size),
349                 &quot;-volname&quot;, APP_NAME.fetchFrom(params),
<span class="line-modified">350                 &quot;-ov&quot;, protoDMG.toAbsolutePath().toString(),</span>
351                 &quot;-fs&quot;, &quot;HFS+&quot;);
352             IOUtils.exec(pb);
353         }
354 
355         // mount temp image
356         pb = new ProcessBuilder(
357                 hdiutil,
358                 &quot;attach&quot;,
<span class="line-modified">359                 protoDMG.toAbsolutePath().toString(),</span>
360                 hdiUtilVerbosityFlag,
<span class="line-modified">361                 &quot;-mountroot&quot;, imagesRoot.toAbsolutePath().toString());</span>
362         IOUtils.exec(pb, false, null, true);
363 
<span class="line-modified">364         Path mountedRoot = imagesRoot.resolve(APP_NAME.fetchFrom(params));</span>

365 
366         // Copy app image, since we did not create DMG with it, but instead we created
367         // empty one.
368         if (copyAppImage) {
369             // In case of predefine app image srcFolder will point to app bundle, so if
370             // we use it as is we will copy content of app bundle, but we need app bundle
371             // folder as well.
<span class="line-modified">372             if (srcFolder.toString().toLowerCase().endsWith(&quot;.app&quot;)) {</span>
<span class="line-modified">373                 Path destPath = mountedRoot</span>
<span class="line-modified">374                         .resolve(srcFolder.getFileName());</span>
375                 Files.createDirectory(destPath);
<span class="line-modified">376                 IOUtils.copyRecursive(srcFolder, destPath);</span>
377             } else {
<span class="line-modified">378                 IOUtils.copyRecursive(srcFolder, mountedRoot);</span>
379             }
380         }
381 
382         try {
383             // background image
<span class="line-modified">384             Path bgdir = mountedRoot.resolve(BACKGROUND_IMAGE_FOLDER);</span>
<span class="line-modified">385             Files.createDirectories(bgdir);</span>
386             IOUtils.copyFile(getConfig_VolumeBackground(params),
<span class="line-modified">387                     bgdir.resolve(BACKGROUND_IMAGE));</span>
388 
389             // We will not consider setting background image and creating link
390             // to install-dir in DMG as critical error, since it can fail in
391             // headless enviroment.
392             try {
393                 pb = new ProcessBuilder(&quot;osascript&quot;,
<span class="line-modified">394                         getConfig_VolumeScript(params).toAbsolutePath().toString());</span>
395                 IOUtils.exec(pb);
396             } catch (IOException ex) {
397                 Log.verbose(ex);
398             }
399 
400             // volume icon
<span class="line-modified">401             Path volumeIconFile = mountedRoot.resolve(&quot;.VolumeIcon.icns&quot;);</span>
402             IOUtils.copyFile(getConfig_VolumeIcon(params),
403                     volumeIconFile);
404 
405             // Indicate that we want a custom icon
406             // NB: attributes of the root directory are ignored
407             // when creating the volume
408             // Therefore we have to do this after we mount image
409             String setFileUtility = findSetFileUtility();
410             if (setFileUtility != null) {
411                 //can not find utility =&gt; keep going without icon
412                 try {
<span class="line-modified">413                     volumeIconFile.toFile().setWritable(true);</span>
414                     // The &quot;creator&quot; attribute on a file is a legacy attribute
415                     // but it seems Finder excepts these bytes to be
416                     // &quot;icnC&quot; for the volume icon
417                     // (might not work on Mac 10.13 with old XCode)
418                     pb = new ProcessBuilder(
419                             setFileUtility,
420                             &quot;-c&quot;, &quot;icnC&quot;,
<span class="line-modified">421                             volumeIconFile.toAbsolutePath().toString());</span>
422                     IOUtils.exec(pb);
<span class="line-modified">423                     volumeIconFile.toFile().setReadOnly();</span>
424 
425                     pb = new ProcessBuilder(
426                             setFileUtility,
427                             &quot;-a&quot;, &quot;C&quot;,
<span class="line-modified">428                             mountedRoot.toAbsolutePath().toString());</span>
429                     IOUtils.exec(pb);
430                 } catch (IOException ex) {
431                     Log.error(ex.getMessage());
432                     Log.verbose(&quot;Cannot enable custom icon using SetFile utility&quot;);
433                 }
434             } else {
435                 Log.verbose(I18N.getString(&quot;message.setfile.dmg&quot;));
436             }
437 
438         } finally {
439             // Detach the temporary image
440             pb = new ProcessBuilder(
441                     hdiutil,
442                     &quot;detach&quot;,
443                     &quot;-force&quot;,
444                     hdiUtilVerbosityFlag,
<span class="line-modified">445                     mountedRoot.toAbsolutePath().toString());</span>
446             IOUtils.exec(pb);
447         }
448 
449         // Compress it to a new image
450         pb = new ProcessBuilder(
451                 hdiutil,
452                 &quot;convert&quot;,
<span class="line-modified">453                 protoDMG.toAbsolutePath().toString(),</span>
454                 hdiUtilVerbosityFlag,
455                 &quot;-format&quot;, &quot;UDZO&quot;,
<span class="line-modified">456                 &quot;-o&quot;, finalDMG.toAbsolutePath().toString());</span>
457         IOUtils.exec(pb);
458 
459         //add license if needed
<span class="line-modified">460         if (Files.exists(getConfig_LicenseFile(params))) {</span>
461             //hdiutil unflatten your_image_file.dmg
462             pb = new ProcessBuilder(
463                     hdiutil,
464                     &quot;unflatten&quot;,
<span class="line-modified">465                     finalDMG.toAbsolutePath().toString()</span>
466             );
467             IOUtils.exec(pb);
468 
469             //add license
470             pb = new ProcessBuilder(
471                     hdiutil,
472                     &quot;udifrez&quot;,
<span class="line-modified">473                     finalDMG.toAbsolutePath().toString(),</span>
474                     &quot;-xml&quot;,
<span class="line-modified">475                     getConfig_LicenseFile(params).toAbsolutePath().toString()</span>
476             );
477             IOUtils.exec(pb);
478 
479             //hdiutil flatten your_image_file.dmg
480             pb = new ProcessBuilder(
481                     hdiutil,
482                     &quot;flatten&quot;,
<span class="line-modified">483                     finalDMG.toAbsolutePath().toString()</span>
484             );
485             IOUtils.exec(pb);
486 
487         }
488 
489         //Delete the temporary image
<span class="line-modified">490         Files.deleteIfExists(protoDMG);</span>
491 
492         Log.verbose(MessageFormat.format(I18N.getString(
493                 &quot;message.output-to-location&quot;),
<span class="line-modified">494                 APP_NAME.fetchFrom(params), finalDMG.toAbsolutePath().toString()));</span>
495 
496         return finalDMG;
497     }
498 
499 
500     //////////////////////////////////////////////////////////////////////////
501     // Implement Bundler
502     //////////////////////////////////////////////////////////////////////////
503 
504     @Override
505     public String getName() {
506         return I18N.getString(&quot;dmg.bundler.name&quot;);
507     }
508 
509     @Override
510     public String getID() {
511         return &quot;dmg&quot;;
512     }
513 
514     @Override
515     public boolean validate(Map&lt;String, ? super Object&gt; params)
516             throws ConfigException {
517         try {
518             Objects.requireNonNull(params);
519 
520             //run basic validation to ensure requirements are met
521             //we are not interested in return code, only possible exception
522             validateAppImageAndBundeler(params);
523 
524             return true;
525         } catch (RuntimeException re) {
526             if (re.getCause() instanceof ConfigException) {
527                 throw (ConfigException) re.getCause();
528             } else {
529                 throw new ConfigException(re);
530             }
531         }
532     }
533 
534     @Override
<span class="line-modified">535     public Path execute(Map&lt;String, ? super Object&gt; params,</span>
<span class="line-modified">536             Path outputParentDir) throws PackagerException {</span>
537         return bundle(params, outputParentDir);
538     }
539 
540     @Override
541     public boolean supported(boolean runtimeInstaller) {
542         return isSupported();
543     }
544 
545     public final static String[] required =
546             {&quot;/usr/bin/hdiutil&quot;, &quot;/usr/bin/osascript&quot;};
547     public static boolean isSupported() {
548         try {
549             for (String s : required) {
<span class="line-modified">550                 Path f = Path.of(s);</span>
<span class="line-modified">551                 if (!Files.exists(f) || !Files.isExecutable(f)) {</span>
552                     return false;
553                 }
554             }
555             return true;
556         } catch (Exception e) {
557             return false;
558         }
559     }
560 
561     @Override
562     public boolean isDefault() {
563         return true;
564     }
565 }
</pre>
</td>
</tr>
</table>
<center><a href="MacCertificate.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="MacPkgBundler.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>