<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff src/jdk.incubator.jpackage/macosx/classes/jdk/incubator/jpackage/internal/MacPkgBundler.java</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="MacDmgBundler.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="resources/MacResources_ja.properties.cdiff.html" target="_top">next &gt;</a></center>    <h2>src/jdk.incubator.jpackage/macosx/classes/jdk/incubator/jpackage/internal/MacPkgBundler.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 23,11 ***</span>
   * questions.
   */
  
  package jdk.incubator.jpackage.internal;
  
<span class="line-removed">- import java.io.File;</span>
  import java.io.IOException;
  import java.io.PrintWriter;
  import java.net.URI;
  import java.net.URISyntaxException;
  import java.nio.file.Files;
<span class="line-new-header">--- 23,10 ---</span>
</pre>
<hr />
<pre>
<span class="line-old-header">*** 62,34 ***</span>
      private static final String TEMPLATE_PREINSTALL_SCRIPT =
              &quot;preinstall.template&quot;;
      private static final String TEMPLATE_POSTINSTALL_SCRIPT =
              &quot;postinstall.template&quot;;
  
<span class="line-modified">!     private static final BundlerParamInfo&lt;File&gt; PACKAGES_ROOT =</span>
              new StandardBundlerParam&lt;&gt;(
              &quot;mac.pkg.packagesRoot&quot;,
<span class="line-modified">!             File.class,</span>
              params -&gt; {
<span class="line-modified">!                 File packagesRoot =</span>
<span class="line-modified">!                         new File(TEMP_ROOT.fetchFrom(params), &quot;packages&quot;);</span>
<span class="line-modified">!                 packagesRoot.mkdirs();</span>
                  return packagesRoot;
              },
<span class="line-modified">!             (s, p) -&gt; new File(s));</span>
  
  
<span class="line-modified">!     protected final BundlerParamInfo&lt;File&gt; SCRIPTS_DIR =</span>
              new StandardBundlerParam&lt;&gt;(
              &quot;mac.pkg.scriptsDir&quot;,
<span class="line-modified">!             File.class,</span>
              params -&gt; {
<span class="line-modified">!                 File scriptsDir =</span>
<span class="line-modified">!                         new File(CONFIG_ROOT.fetchFrom(params), &quot;scripts&quot;);</span>
<span class="line-modified">!                 scriptsDir.mkdirs();</span>
                  return scriptsDir;
              },
<span class="line-modified">!             (s, p) -&gt; new File(s));</span>
  
      public static final
              BundlerParamInfo&lt;String&gt; DEVELOPER_ID_INSTALLER_SIGNING_KEY =
              new StandardBundlerParam&lt;&gt;(
              &quot;mac.signing-key-developer-id-installer&quot;,
<span class="line-new-header">--- 61,42 ---</span>
      private static final String TEMPLATE_PREINSTALL_SCRIPT =
              &quot;preinstall.template&quot;;
      private static final String TEMPLATE_POSTINSTALL_SCRIPT =
              &quot;postinstall.template&quot;;
  
<span class="line-modified">!     private static final BundlerParamInfo&lt;Path&gt; PACKAGES_ROOT =</span>
              new StandardBundlerParam&lt;&gt;(
              &quot;mac.pkg.packagesRoot&quot;,
<span class="line-modified">!             Path.class,</span>
              params -&gt; {
<span class="line-modified">!                 Path packagesRoot =</span>
<span class="line-modified">!                         TEMP_ROOT.fetchFrom(params).resolve(&quot;packages&quot;);</span>
<span class="line-modified">!                 try {</span>
<span class="line-added">+                     Files.createDirectories(packagesRoot);</span>
<span class="line-added">+                 } catch (IOException ioe) {</span>
<span class="line-added">+                     return null;</span>
<span class="line-added">+                 }</span>
                  return packagesRoot;
              },
<span class="line-modified">!             (s, p) -&gt; Path.of(s));</span>
  
  
<span class="line-modified">!     protected final BundlerParamInfo&lt;Path&gt; SCRIPTS_DIR =</span>
              new StandardBundlerParam&lt;&gt;(
              &quot;mac.pkg.scriptsDir&quot;,
<span class="line-modified">!             Path.class,</span>
              params -&gt; {
<span class="line-modified">!                 Path scriptsDir =</span>
<span class="line-modified">!                         CONFIG_ROOT.fetchFrom(params).resolve(&quot;scripts&quot;);</span>
<span class="line-modified">!                 try {</span>
<span class="line-added">+                     Files.createDirectories(scriptsDir);</span>
<span class="line-added">+                 } catch (IOException ioe) {</span>
<span class="line-added">+                     return null;</span>
<span class="line-added">+                 }</span>
                  return scriptsDir;
              },
<span class="line-modified">!             (s, p) -&gt; Path.of(s));</span>
  
      public static final
              BundlerParamInfo&lt;String&gt; DEVELOPER_ID_INSTALLER_SIGNING_KEY =
              new StandardBundlerParam&lt;&gt;(
              &quot;mac.signing-key-developer-id-installer&quot;,
</pre>
<hr />
<pre>
<span class="line-old-header">*** 119,27 ***</span>
              &quot;mac.pkg.installerName.suffix&quot;,
              String.class,
              params -&gt; &quot;&quot;,
              (s, p) -&gt; s);
  
<span class="line-modified">!     public File bundle(Map&lt;String, ? super Object&gt; params,</span>
<span class="line-modified">!             File outdir) throws PackagerException {</span>
          Log.verbose(MessageFormat.format(I18N.getString(&quot;message.building-pkg&quot;),
                  APP_NAME.fetchFrom(params)));
  
<span class="line-modified">!         IOUtils.writableOutputDir(outdir.toPath());</span>
  
          try {
<span class="line-modified">!             File appImageDir = prepareAppBundle(params);</span>
  
              if (appImageDir != null &amp;&amp; prepareConfigFiles(params)) {
  
<span class="line-modified">!                 File configScript = getConfig_Script(params);</span>
<span class="line-modified">!                 if (configScript.exists()) {</span>
                      Log.verbose(MessageFormat.format(I18N.getString(
                              &quot;message.running-script&quot;),
<span class="line-modified">!                             configScript.getAbsolutePath()));</span>
                      IOUtils.run(&quot;bash&quot;, configScript);
                  }
  
                  return createPKG(params, outdir, appImageDir);
              }
<span class="line-new-header">--- 126,27 ---</span>
              &quot;mac.pkg.installerName.suffix&quot;,
              String.class,
              params -&gt; &quot;&quot;,
              (s, p) -&gt; s);
  
<span class="line-modified">!     public Path bundle(Map&lt;String, ? super Object&gt; params,</span>
<span class="line-modified">!             Path outdir) throws PackagerException {</span>
          Log.verbose(MessageFormat.format(I18N.getString(&quot;message.building-pkg&quot;),
                  APP_NAME.fetchFrom(params)));
  
<span class="line-modified">!         IOUtils.writableOutputDir(outdir);</span>
  
          try {
<span class="line-modified">!             Path appImageDir = prepareAppBundle(params);</span>
  
              if (appImageDir != null &amp;&amp; prepareConfigFiles(params)) {
  
<span class="line-modified">!                 Path configScript = getConfig_Script(params);</span>
<span class="line-modified">!                 if (IOUtils.exists(configScript)) {</span>
                      Log.verbose(MessageFormat.format(I18N.getString(
                              &quot;message.running-script&quot;),
<span class="line-modified">!                             configScript.toAbsolutePath().toString()));</span>
                      IOUtils.run(&quot;bash&quot;, configScript);
                  }
  
                  return createPKG(params, outdir, appImageDir);
              }
</pre>
<hr />
<pre>
<span class="line-old-header">*** 148,37 ***</span>
              Log.verbose(ex);
              throw new PackagerException(ex);
          }
      }
  
<span class="line-modified">!     private File getPackages_AppPackage(Map&lt;String, ? super Object&gt; params) {</span>
<span class="line-modified">!         return new File(PACKAGES_ROOT.fetchFrom(params),</span>
                  APP_NAME.fetchFrom(params) + &quot;-app.pkg&quot;);
      }
  
<span class="line-modified">!     private File getConfig_DistributionXMLFile(</span>
              Map&lt;String, ? super Object&gt; params) {
<span class="line-modified">!         return new File(CONFIG_ROOT.fetchFrom(params), &quot;distribution.dist&quot;);</span>
      }
  
<span class="line-modified">!     private File getConfig_BackgroundImage(Map&lt;String, ? super Object&gt; params) {</span>
<span class="line-modified">!         return new File(CONFIG_ROOT.fetchFrom(params),</span>
                  APP_NAME.fetchFrom(params) + &quot;-background.png&quot;);
      }
  
<span class="line-modified">!     private File getConfig_BackgroundImageDarkAqua(Map&lt;String, ? super Object&gt; params) {</span>
<span class="line-modified">!         return new File(CONFIG_ROOT.fetchFrom(params),</span>
                  APP_NAME.fetchFrom(params) + &quot;-background-darkAqua.png&quot;);
      }
  
<span class="line-modified">!     private File getScripts_PreinstallFile(Map&lt;String, ? super Object&gt; params) {</span>
<span class="line-modified">!         return new File(SCRIPTS_DIR.fetchFrom(params), &quot;preinstall&quot;);</span>
      }
  
<span class="line-modified">!     private File getScripts_PostinstallFile(</span>
              Map&lt;String, ? super Object&gt; params) {
<span class="line-modified">!         return new File(SCRIPTS_DIR.fetchFrom(params), &quot;postinstall&quot;);</span>
      }
  
      private String getAppIdentifier(Map&lt;String, ? super Object&gt; params) {
          return MAC_CF_BUNDLE_IDENTIFIER.fetchFrom(params);
      }
<span class="line-new-header">--- 155,37 ---</span>
              Log.verbose(ex);
              throw new PackagerException(ex);
          }
      }
  
<span class="line-modified">!     private Path getPackages_AppPackage(Map&lt;String, ? super Object&gt; params) {</span>
<span class="line-modified">!         return PACKAGES_ROOT.fetchFrom(params).resolve(</span>
                  APP_NAME.fetchFrom(params) + &quot;-app.pkg&quot;);
      }
  
<span class="line-modified">!     private Path getConfig_DistributionXMLFile(</span>
              Map&lt;String, ? super Object&gt; params) {
<span class="line-modified">!         return CONFIG_ROOT.fetchFrom(params).resolve(&quot;distribution.dist&quot;);</span>
      }
  
<span class="line-modified">!     private Path getConfig_BackgroundImage(Map&lt;String, ? super Object&gt; params) {</span>
<span class="line-modified">!         return CONFIG_ROOT.fetchFrom(params).resolve(</span>
                  APP_NAME.fetchFrom(params) + &quot;-background.png&quot;);
      }
  
<span class="line-modified">!     private Path getConfig_BackgroundImageDarkAqua(Map&lt;String, ? super Object&gt; params) {</span>
<span class="line-modified">!         return CONFIG_ROOT.fetchFrom(params).resolve(</span>
                  APP_NAME.fetchFrom(params) + &quot;-background-darkAqua.png&quot;);
      }
  
<span class="line-modified">!     private Path getScripts_PreinstallFile(Map&lt;String, ? super Object&gt; params) {</span>
<span class="line-modified">!         return SCRIPTS_DIR.fetchFrom(params).resolve(&quot;preinstall&quot;);</span>
      }
  
<span class="line-modified">!     private Path getScripts_PostinstallFile(</span>
              Map&lt;String, ? super Object&gt; params) {
<span class="line-modified">!         return SCRIPTS_DIR.fetchFrom(params).resolve(&quot;postinstall&quot;);</span>
      }
  
      private String getAppIdentifier(Map&lt;String, ? super Object&gt; params) {
          return MAC_CF_BUNDLE_IDENTIFIER.fetchFrom(params);
      }
</pre>
<hr />
<pre>
<span class="line-old-header">*** 197,58 ***</span>
  
          createResource(TEMPLATE_PREINSTALL_SCRIPT, params)
                  .setCategory(I18N.getString(&quot;resource.pkg-preinstall-script&quot;))
                  .setSubstitutionData(data)
                  .saveToFile(getScripts_PreinstallFile(params));
<span class="line-modified">!         getScripts_PreinstallFile(params).setExecutable(true, false);</span>
  
          createResource(TEMPLATE_POSTINSTALL_SCRIPT, params)
                  .setCategory(I18N.getString(&quot;resource.pkg-postinstall-script&quot;))
                  .setSubstitutionData(data)
                  .saveToFile(getScripts_PostinstallFile(params));
<span class="line-modified">!         getScripts_PostinstallFile(params).setExecutable(true, false);</span>
      }
  
      private static String URLEncoding(String pkgName) throws URISyntaxException {
          URI uri = new URI(null, null, pkgName, null);
          return uri.toASCIIString();
      }
  
      private void prepareDistributionXMLFile(Map&lt;String, ? super Object&gt; params)
              throws IOException {
<span class="line-modified">!         File f = getConfig_DistributionXMLFile(params);</span>
  
          Log.verbose(MessageFormat.format(I18N.getString(
<span class="line-modified">!                 &quot;message.preparing-distribution-dist&quot;), f.getAbsolutePath()));</span>
  
<span class="line-modified">!         IOUtils.createXml(f.toPath(), xml -&gt; {</span>
              xml.writeStartElement(&quot;installer-gui-script&quot;);
              xml.writeAttribute(&quot;minSpecVersion&quot;, &quot;1&quot;);
  
              xml.writeStartElement(&quot;title&quot;);
              xml.writeCharacters(APP_NAME.fetchFrom(params));
              xml.writeEndElement();
  
              xml.writeStartElement(&quot;background&quot;);
<span class="line-modified">!             xml.writeAttribute(&quot;file&quot;, getConfig_BackgroundImage(params).getName());</span>
              xml.writeAttribute(&quot;mime-type&quot;, &quot;image/png&quot;);
              xml.writeAttribute(&quot;alignment&quot;, &quot;bottomleft&quot;);
              xml.writeAttribute(&quot;scaling&quot;, &quot;none&quot;);
              xml.writeEndElement();
  
              xml.writeStartElement(&quot;background-darkAqua&quot;);
<span class="line-modified">!             xml.writeAttribute(&quot;file&quot;, getConfig_BackgroundImageDarkAqua(params).getName());</span>
              xml.writeAttribute(&quot;mime-type&quot;, &quot;image/png&quot;);
              xml.writeAttribute(&quot;alignment&quot;, &quot;bottomleft&quot;);
              xml.writeAttribute(&quot;scaling&quot;, &quot;none&quot;);
              xml.writeEndElement();
  
              String licFileStr = LICENSE_FILE.fetchFrom(params);
              if (licFileStr != null) {
<span class="line-modified">!                 File licFile = new File(licFileStr);</span>
                  xml.writeStartElement(&quot;license&quot;);
<span class="line-modified">!                 xml.writeAttribute(&quot;file&quot;, licFile.getAbsolutePath());</span>
                  xml.writeAttribute(&quot;mime-type&quot;, &quot;text/rtf&quot;);
                  xml.writeEndElement();
              }
  
              /*
<span class="line-new-header">--- 204,60 ---</span>
  
          createResource(TEMPLATE_PREINSTALL_SCRIPT, params)
                  .setCategory(I18N.getString(&quot;resource.pkg-preinstall-script&quot;))
                  .setSubstitutionData(data)
                  .saveToFile(getScripts_PreinstallFile(params));
<span class="line-modified">!         getScripts_PreinstallFile(params).toFile().setExecutable(true, false);</span>
  
          createResource(TEMPLATE_POSTINSTALL_SCRIPT, params)
                  .setCategory(I18N.getString(&quot;resource.pkg-postinstall-script&quot;))
                  .setSubstitutionData(data)
                  .saveToFile(getScripts_PostinstallFile(params));
<span class="line-modified">!         getScripts_PostinstallFile(params).toFile().setExecutable(true, false);</span>
      }
  
      private static String URLEncoding(String pkgName) throws URISyntaxException {
          URI uri = new URI(null, null, pkgName, null);
          return uri.toASCIIString();
      }
  
      private void prepareDistributionXMLFile(Map&lt;String, ? super Object&gt; params)
              throws IOException {
<span class="line-modified">!         Path f = getConfig_DistributionXMLFile(params);</span>
  
          Log.verbose(MessageFormat.format(I18N.getString(
<span class="line-modified">!                 &quot;message.preparing-distribution-dist&quot;), f.toAbsolutePath().toString()));</span>
  
<span class="line-modified">!         IOUtils.createXml(f, xml -&gt; {</span>
              xml.writeStartElement(&quot;installer-gui-script&quot;);
              xml.writeAttribute(&quot;minSpecVersion&quot;, &quot;1&quot;);
  
              xml.writeStartElement(&quot;title&quot;);
              xml.writeCharacters(APP_NAME.fetchFrom(params));
              xml.writeEndElement();
  
              xml.writeStartElement(&quot;background&quot;);
<span class="line-modified">!             xml.writeAttribute(&quot;file&quot;,</span>
<span class="line-added">+                     getConfig_BackgroundImage(params).getFileName().toString());</span>
              xml.writeAttribute(&quot;mime-type&quot;, &quot;image/png&quot;);
              xml.writeAttribute(&quot;alignment&quot;, &quot;bottomleft&quot;);
              xml.writeAttribute(&quot;scaling&quot;, &quot;none&quot;);
              xml.writeEndElement();
  
              xml.writeStartElement(&quot;background-darkAqua&quot;);
<span class="line-modified">!             xml.writeAttribute(&quot;file&quot;,</span>
<span class="line-added">+                     getConfig_BackgroundImageDarkAqua(params).getFileName().toString());</span>
              xml.writeAttribute(&quot;mime-type&quot;, &quot;image/png&quot;);
              xml.writeAttribute(&quot;alignment&quot;, &quot;bottomleft&quot;);
              xml.writeAttribute(&quot;scaling&quot;, &quot;none&quot;);
              xml.writeEndElement();
  
              String licFileStr = LICENSE_FILE.fetchFrom(params);
              if (licFileStr != null) {
<span class="line-modified">!                 Path licFile = Path.of(licFileStr);</span>
                  xml.writeStartElement(&quot;license&quot;);
<span class="line-modified">!                 xml.writeAttribute(&quot;file&quot;, licFile.toAbsolutePath().toString());</span>
                  xml.writeAttribute(&quot;mime-type&quot;, &quot;text/rtf&quot;);
                  xml.writeEndElement();
              }
  
              /*
</pre>
<hr />
<pre>
<span class="line-old-header">*** 286,11 ***</span>
              xml.writeAttribute(&quot;id&quot;, appId);
              xml.writeAttribute(&quot;version&quot;, VERSION.fetchFrom(params));
              xml.writeAttribute(&quot;onConclusion&quot;, &quot;none&quot;);
              try {
                  xml.writeCharacters(URLEncoding(
<span class="line-modified">!                         getPackages_AppPackage(params).getName()));</span>
              } catch (URISyntaxException ex) {
                  throw new IOException(ex);
              }
              xml.writeEndElement(); // &lt;/pkg-ref&gt;
  
<span class="line-new-header">--- 295,11 ---</span>
              xml.writeAttribute(&quot;id&quot;, appId);
              xml.writeAttribute(&quot;version&quot;, VERSION.fetchFrom(params));
              xml.writeAttribute(&quot;onConclusion&quot;, &quot;none&quot;);
              try {
                  xml.writeCharacters(URLEncoding(
<span class="line-modified">!                         getPackages_AppPackage(params).getFileName().toString()));</span>
              } catch (URISyntaxException ex) {
                  throw new IOException(ex);
              }
              xml.writeEndElement(); // &lt;/pkg-ref&gt;
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 317,20 ***</span>
  
          return true;
      }
  
      // name of post-image script
<span class="line-modified">!     private File getConfig_Script(Map&lt;String, ? super Object&gt; params) {</span>
<span class="line-modified">!         return new File(CONFIG_ROOT.fetchFrom(params),</span>
                  APP_NAME.fetchFrom(params) + &quot;-post-image.sh&quot;);
      }
  
<span class="line-modified">!     private void patchCPLFile(File cpl) throws IOException {</span>
<span class="line-modified">!         String cplData = Files.readString(cpl.toPath());</span>
          String[] lines = cplData.split(&quot;\n&quot;);
<span class="line-modified">!         try (PrintWriter out = new PrintWriter(Files.newBufferedWriter(</span>
<span class="line-removed">-                 cpl.toPath()))) {</span>
              int skip = 0;
              // Used to skip Java.runtime bundle, since
              // pkgbuild with --root will find two bundles app and Java runtime.
              // We cannot generate component proprty list when using
              // --component argument.
<span class="line-new-header">--- 326,19 ---</span>
  
          return true;
      }
  
      // name of post-image script
<span class="line-modified">!     private Path getConfig_Script(Map&lt;String, ? super Object&gt; params) {</span>
<span class="line-modified">!         return CONFIG_ROOT.fetchFrom(params).resolve(</span>
                  APP_NAME.fetchFrom(params) + &quot;-post-image.sh&quot;);
      }
  
<span class="line-modified">!     private void patchCPLFile(Path cpl) throws IOException {</span>
<span class="line-modified">!         String cplData = Files.readString(cpl);</span>
          String[] lines = cplData.split(&quot;\n&quot;);
<span class="line-modified">!         try (PrintWriter out = new PrintWriter(Files.newBufferedWriter(cpl))) {</span>
              int skip = 0;
              // Used to skip Java.runtime bundle, since
              // pkgbuild with --root will find two bundles app and Java runtime.
              // We cannot generate component proprty list when using
              // --component argument.
</pre>
<hr />
<pre>
<span class="line-old-header">*** 358,72 ***</span>
      // to exclude files/folder, but it will overwrite default one which excludes
      // based on doc &quot;any .svn or CVS directories, and any .DS_Store files&quot;.
      // So easy aproach will be to copy user provided app-image into temp folder
      // if root path contains other files.
      private String getRoot(Map&lt;String, ? super Object&gt; params,
<span class="line-modified">!             File appLocation) throws IOException {</span>
<span class="line-modified">!         String root = appLocation.getParent() == null ?</span>
<span class="line-modified">!                 &quot;.&quot; : appLocation.getParent();</span>
<span class="line-removed">-         File rootDir = new File(root);</span>
  
<span class="line-modified">!         File[] list = rootDir.listFiles();</span>
          if (list != null) { // Should not happend
              // We should only have app image and/or .DS_Store
              if (list.length == 1) {
<span class="line-modified">!                 return root;</span>
              } else if (list.length == 2) {
                  // Check case with app image and .DS_Store
                  if (list[0].toString().toLowerCase().endsWith(&quot;.ds_store&quot;) ||
                      list[1].toString().toLowerCase().endsWith(&quot;.ds_store&quot;)) {
<span class="line-modified">!                     return root; // Only app image and .DS_Store</span>
                  }
              }
          }
  
          // Copy to new root
          Path newRoot = Files.createTempDirectory(
<span class="line-modified">!                 TEMP_ROOT.fetchFrom(params).toPath(), &quot;root-&quot;);</span>
  
          Path source, dest;
  
          if (StandardBundlerParam.isRuntimeInstaller(params)) {
              // firs, is this already a runtime with
              // &lt;runtime&gt;/Contents/Home - if so we need the Home dir
<span class="line-modified">!             Path original = appLocation.toPath();</span>
              Path home = original.resolve(&quot;Contents/Home&quot;);
              source = (Files.exists(home)) ? home : original;
  
              // Then we need to put back the &lt;NAME&gt;/Content/Home
              dest = newRoot.resolve(
                  MAC_CF_BUNDLE_IDENTIFIER.fetchFrom(params) + &quot;/Contents/Home&quot;);
          } else {
<span class="line-modified">!             source = appLocation.toPath();</span>
<span class="line-modified">!             dest = newRoot.resolve(appLocation.getName());</span>
          }
          IOUtils.copyRecursive(source, dest);
  
          return newRoot.toString();
      }
  
<span class="line-modified">!     private File createPKG(Map&lt;String, ? super Object&gt; params,</span>
<span class="line-modified">!             File outdir, File appLocation) {</span>
          // generic find attempt
          try {
<span class="line-modified">!             File appPKG = getPackages_AppPackage(params);</span>
  
              String root = getRoot(params, appLocation);
  
              // Generate default CPL file
<span class="line-modified">!             File cpl = new File(CONFIG_ROOT.fetchFrom(params).getAbsolutePath()</span>
<span class="line-removed">-                     + File.separator + &quot;cpl.plist&quot;);</span>
              ProcessBuilder pb = new ProcessBuilder(&quot;pkgbuild&quot;,
                      &quot;--root&quot;,
                      root,
                      &quot;--install-location&quot;,
                      getInstallDir(params),
                      &quot;--analyze&quot;,
<span class="line-modified">!                     cpl.getAbsolutePath());</span>
  
              IOUtils.exec(pb);
  
              patchCPLFile(cpl);
  
<span class="line-new-header">--- 366,70 ---</span>
      // to exclude files/folder, but it will overwrite default one which excludes
      // based on doc &quot;any .svn or CVS directories, and any .DS_Store files&quot;.
      // So easy aproach will be to copy user provided app-image into temp folder
      // if root path contains other files.
      private String getRoot(Map&lt;String, ? super Object&gt; params,
<span class="line-modified">!             Path appLocation) throws IOException {</span>
<span class="line-modified">!         Path rootDir = appLocation.getParent() == null ?</span>
<span class="line-modified">!                 Path.of(&quot;.&quot;) : appLocation.getParent();</span>
  
<span class="line-modified">!         Path[] list = Files.list(rootDir).toArray(Path[]::new);</span>
          if (list != null) { // Should not happend
              // We should only have app image and/or .DS_Store
              if (list.length == 1) {
<span class="line-modified">!                 return rootDir.toString();</span>
              } else if (list.length == 2) {
                  // Check case with app image and .DS_Store
                  if (list[0].toString().toLowerCase().endsWith(&quot;.ds_store&quot;) ||
                      list[1].toString().toLowerCase().endsWith(&quot;.ds_store&quot;)) {
<span class="line-modified">!                     return rootDir.toString(); // Only app image and .DS_Store</span>
                  }
              }
          }
  
          // Copy to new root
          Path newRoot = Files.createTempDirectory(
<span class="line-modified">!                 TEMP_ROOT.fetchFrom(params), &quot;root-&quot;);</span>
  
          Path source, dest;
  
          if (StandardBundlerParam.isRuntimeInstaller(params)) {
              // firs, is this already a runtime with
              // &lt;runtime&gt;/Contents/Home - if so we need the Home dir
<span class="line-modified">!             Path original = appLocation;</span>
              Path home = original.resolve(&quot;Contents/Home&quot;);
              source = (Files.exists(home)) ? home : original;
  
              // Then we need to put back the &lt;NAME&gt;/Content/Home
              dest = newRoot.resolve(
                  MAC_CF_BUNDLE_IDENTIFIER.fetchFrom(params) + &quot;/Contents/Home&quot;);
          } else {
<span class="line-modified">!             source = appLocation;</span>
<span class="line-modified">!             dest = newRoot.resolve(appLocation.getFileName());</span>
          }
          IOUtils.copyRecursive(source, dest);
  
          return newRoot.toString();
      }
  
<span class="line-modified">!     private Path createPKG(Map&lt;String, ? super Object&gt; params,</span>
<span class="line-modified">!             Path outdir, Path appLocation) {</span>
          // generic find attempt
          try {
<span class="line-modified">!             Path appPKG = getPackages_AppPackage(params);</span>
  
              String root = getRoot(params, appLocation);
  
              // Generate default CPL file
<span class="line-modified">!             Path cpl = CONFIG_ROOT.fetchFrom(params).resolve(&quot;cpl.plist&quot;);</span>
              ProcessBuilder pb = new ProcessBuilder(&quot;pkgbuild&quot;,
                      &quot;--root&quot;,
                      root,
                      &quot;--install-location&quot;,
                      getInstallDir(params),
                      &quot;--analyze&quot;,
<span class="line-modified">!                     cpl.toAbsolutePath().toString());</span>
  
              IOUtils.exec(pb);
  
              patchCPLFile(cpl);
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 434,29 ***</span>
                      &quot;--root&quot;,
                      root,
                      &quot;--install-location&quot;,
                      getInstallDir(params),
                      &quot;--component-plist&quot;,
<span class="line-modified">!                     cpl.getAbsolutePath(),</span>
                      &quot;--scripts&quot;,
<span class="line-modified">!                     SCRIPTS_DIR.fetchFrom(params).getAbsolutePath(),</span>
                      &quot;--identifier&quot;,
                       MAC_CF_BUNDLE_IDENTIFIER.fetchFrom(params),
<span class="line-modified">!                     appPKG.getAbsolutePath());</span>
              IOUtils.exec(pb);
  
              // build final package
<span class="line-modified">!             File finalPKG = new File(outdir, INSTALLER_NAME.fetchFrom(params)</span>
                      + INSTALLER_SUFFIX.fetchFrom(params)
                      + &quot;.pkg&quot;);
<span class="line-modified">!             outdir.mkdirs();</span>
  
              List&lt;String&gt; commandLine = new ArrayList&lt;&gt;();
              commandLine.add(&quot;productbuild&quot;);
  
              commandLine.add(&quot;--resources&quot;);
<span class="line-modified">!             commandLine.add(CONFIG_ROOT.fetchFrom(params).getAbsolutePath());</span>
  
              // maybe sign
              if (Optional.ofNullable(MacAppImageBuilder.
                      SIGN_BUNDLE.fetchFrom(params)).orElse(Boolean.TRUE)) {
                  if (Platform.getMajorVersion() &gt; 10 ||
<span class="line-new-header">--- 440,29 ---</span>
                      &quot;--root&quot;,
                      root,
                      &quot;--install-location&quot;,
                      getInstallDir(params),
                      &quot;--component-plist&quot;,
<span class="line-modified">!                     cpl.toAbsolutePath().toString(),</span>
                      &quot;--scripts&quot;,
<span class="line-modified">!                     SCRIPTS_DIR.fetchFrom(params).toAbsolutePath().toString(),</span>
                      &quot;--identifier&quot;,
                       MAC_CF_BUNDLE_IDENTIFIER.fetchFrom(params),
<span class="line-modified">!                     appPKG.toAbsolutePath().toString());</span>
              IOUtils.exec(pb);
  
              // build final package
<span class="line-modified">!             Path finalPKG = outdir.resolve(INSTALLER_NAME.fetchFrom(params)</span>
                      + INSTALLER_SUFFIX.fetchFrom(params)
                      + &quot;.pkg&quot;);
<span class="line-modified">!             Files.createDirectories(outdir);</span>
  
              List&lt;String&gt; commandLine = new ArrayList&lt;&gt;();
              commandLine.add(&quot;productbuild&quot;);
  
              commandLine.add(&quot;--resources&quot;);
<span class="line-modified">!             commandLine.add(CONFIG_ROOT.fetchFrom(params).toAbsolutePath().toString());</span>
  
              // maybe sign
              if (Optional.ofNullable(MacAppImageBuilder.
                      SIGN_BUNDLE.fetchFrom(params)).orElse(Boolean.TRUE)) {
                  if (Platform.getMajorVersion() &gt; 10 ||
</pre>
<hr />
<pre>
<span class="line-old-header">*** 480,15 ***</span>
                  }
              }
  
              commandLine.add(&quot;--distribution&quot;);
              commandLine.add(
<span class="line-modified">!                     getConfig_DistributionXMLFile(params).getAbsolutePath());</span>
              commandLine.add(&quot;--package-path&quot;);
<span class="line-modified">!             commandLine.add(PACKAGES_ROOT.fetchFrom(params).getAbsolutePath());</span>
  
<span class="line-modified">!             commandLine.add(finalPKG.getAbsolutePath());</span>
  
              pb = new ProcessBuilder(commandLine);
              IOUtils.exec(pb);
  
              return finalPKG;
<span class="line-new-header">--- 486,15 ---</span>
                  }
              }
  
              commandLine.add(&quot;--distribution&quot;);
              commandLine.add(
<span class="line-modified">!                     getConfig_DistributionXMLFile(params).toAbsolutePath().toString());</span>
              commandLine.add(&quot;--package-path&quot;);
<span class="line-modified">!             commandLine.add(PACKAGES_ROOT.fetchFrom(params).toAbsolutePath().toString());</span>
  
<span class="line-modified">!             commandLine.add(finalPKG.toAbsolutePath().toString());</span>
  
              pb = new ProcessBuilder(commandLine);
              IOUtils.exec(pb);
  
              return finalPKG;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 575,12 ***</span>
              }
          }
      }
  
      @Override
<span class="line-modified">!     public File execute(Map&lt;String, ? super Object&gt; params,</span>
<span class="line-modified">!             File outputParentDir) throws PackagerException {</span>
          return bundle(params, outputParentDir);
      }
  
      @Override
      public boolean supported(boolean runtimeInstaller) {
<span class="line-new-header">--- 581,12 ---</span>
              }
          }
      }
  
      @Override
<span class="line-modified">!     public Path execute(Map&lt;String, ? super Object&gt; params,</span>
<span class="line-modified">!             Path outputParentDir) throws PackagerException {</span>
          return bundle(params, outputParentDir);
      }
  
      @Override
      public boolean supported(boolean runtimeInstaller) {
</pre>
<center><a href="MacDmgBundler.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="resources/MacResources_ja.properties.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>