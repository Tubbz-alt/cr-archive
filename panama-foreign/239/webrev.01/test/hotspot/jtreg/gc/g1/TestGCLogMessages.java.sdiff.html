<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff test/hotspot/jtreg/gc/g1/TestGCLogMessages.java</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
<body>
<center><a href="TestEagerReclaimHumongousRegionsClearMarkBits.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="TestRemsetLoggingTools.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>test/hotspot/jtreg/gc/g1/TestGCLogMessages.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
170         new LogMessageWithLevel(&quot;VM Weak&quot;, Level.DEBUG),
171 
172         new LogMessageWithLevelC2OrJVMCIOnly(&quot;DerivedPointerTable Update&quot;, Level.DEBUG),
173         new LogMessageWithLevel(&quot;Start New Collection Set&quot;, Level.DEBUG),
174     };
175 
176     void checkMessagesAtLevel(OutputAnalyzer output, LogMessageWithLevel messages[], Level level) throws Exception {
177         for (LogMessageWithLevel l : messages) {
178             if (level.lessThan(l.level) || !l.isAvailable()) {
179                 output.shouldNotContain(l.message);
180             } else {
181                 output.shouldMatch(&quot;\\[&quot; + l.level + &quot;.*&quot; + l.message);
182             }
183         }
184     }
185 
186     public static void main(String[] args) throws Exception {
187         new TestGCLogMessages().testNormalLogs();
188         new TestGCLogMessages().testConcurrentRefinementLogs();
189         new TestGCLogMessages().testWithToSpaceExhaustionLogs();
<span class="line-modified">190         new TestGCLogMessages().testWithInitialMark();</span>
191         new TestGCLogMessages().testExpandHeap();
192     }
193 
194     private void testNormalLogs() throws Exception {
195 
196         ProcessBuilder pb = ProcessTools.createJavaProcessBuilder(&quot;-XX:+UseG1GC&quot;,
197                                                                   &quot;-Xmx10M&quot;,
198                                                                   GCTest.class.getName());
199 
200         OutputAnalyzer output = new OutputAnalyzer(pb.start());
201         checkMessagesAtLevel(output, allLogMessages, Level.OFF);
202         output.shouldHaveExitValue(0);
203 
204         pb = ProcessTools.createJavaProcessBuilder(&quot;-XX:+UseG1GC&quot;,
205                                                    &quot;-XX:+UseStringDeduplication&quot;,
206                                                    &quot;-Xmx10M&quot;,
207                                                    &quot;-Xlog:gc+phases=debug&quot;,
208                                                    GCTest.class.getName());
209 
210         output = new OutputAnalyzer(pb.start());
</pre>
<hr />
<pre>
249                                                                   &quot;-Xmx32M&quot;,
250                                                                   &quot;-Xmn16M&quot;,
251                                                                   &quot;-Xlog:gc+phases=debug&quot;,
252                                                                   GCTestWithToSpaceExhaustion.class.getName());
253 
254         OutputAnalyzer output = new OutputAnalyzer(pb.start());
255         checkMessagesAtLevel(output, exhFailureMessages, Level.DEBUG);
256         output.shouldHaveExitValue(0);
257 
258         pb = ProcessTools.createJavaProcessBuilder(&quot;-XX:+UseG1GC&quot;,
259                                                    &quot;-Xmx32M&quot;,
260                                                    &quot;-Xmn16M&quot;,
261                                                    &quot;-Xlog:gc+phases=trace&quot;,
262                                                    GCTestWithToSpaceExhaustion.class.getName());
263 
264         output = new OutputAnalyzer(pb.start());
265         checkMessagesAtLevel(output, exhFailureMessages, Level.TRACE);
266         output.shouldHaveExitValue(0);
267     }
268 
<span class="line-modified">269     private void testWithInitialMark() throws Exception {</span>
270         ProcessBuilder pb = ProcessTools.createJavaProcessBuilder(&quot;-XX:+UseG1GC&quot;,
271                                                                   &quot;-Xmx10M&quot;,
272                                                                   &quot;-Xbootclasspath/a:.&quot;,
273                                                                   &quot;-Xlog:gc*=debug&quot;,
274                                                                   &quot;-XX:+UnlockDiagnosticVMOptions&quot;,
275                                                                   &quot;-XX:+WhiteBoxAPI&quot;,
<span class="line-modified">276                                                                   GCTestWithInitialMark.class.getName());</span>
277 
278         OutputAnalyzer output = new OutputAnalyzer(pb.start());
279         output.shouldContain(&quot;Clear Claimed Marks&quot;);
280         output.shouldHaveExitValue(0);
281     }
282 
283     private void testExpandHeap() throws Exception {
284         ProcessBuilder pb = ProcessTools.createJavaProcessBuilder(&quot;-XX:+UseG1GC&quot;,
285                                                                   &quot;-Xmx10M&quot;,
286                                                                   &quot;-Xbootclasspath/a:.&quot;,
287                                                                   &quot;-Xlog:gc+ergo+heap=debug&quot;,
288                                                                   &quot;-XX:+UnlockDiagnosticVMOptions&quot;,
289                                                                   &quot;-XX:+WhiteBoxAPI&quot;,
290                                                                   GCTest.class.getName());
291 
292         OutputAnalyzer output = new OutputAnalyzer(pb.start());
293         output.shouldContain(&quot;Expand the heap. requested expansion amount: &quot;);
294         output.shouldContain(&quot;B expansion amount: &quot;);
295         output.shouldHaveExitValue(0);
296     }
</pre>
<hr />
<pre>
306             }
307             System.out.println(&quot;Done&quot;);
308         }
309     }
310 
311     static class GCTestWithToSpaceExhaustion {
312         private static byte[] garbage;
313         private static byte[] largeObject;
314         public static void main(String [] args) {
315             largeObject = new byte[16*1024*1024];
316             System.out.println(&quot;Creating garbage&quot;);
317             // create 128MB of garbage. This should result in at least one GC,
318             // some of them with to-space exhaustion.
319             for (int i = 0; i &lt; 1024; i++) {
320                 garbage = new byte[128 * 1024];
321             }
322             System.out.println(&quot;Done&quot;);
323         }
324     }
325 
<span class="line-modified">326     static class GCTestWithInitialMark {</span>
327         public static void main(String [] args) {
328             sun.hotspot.WhiteBox WB = sun.hotspot.WhiteBox.getWhiteBox();
329             WB.g1StartConcMarkCycle();
330         }
331     }
332 
333 }
334 
</pre>
</td>
<td>
<hr />
<pre>
170         new LogMessageWithLevel(&quot;VM Weak&quot;, Level.DEBUG),
171 
172         new LogMessageWithLevelC2OrJVMCIOnly(&quot;DerivedPointerTable Update&quot;, Level.DEBUG),
173         new LogMessageWithLevel(&quot;Start New Collection Set&quot;, Level.DEBUG),
174     };
175 
176     void checkMessagesAtLevel(OutputAnalyzer output, LogMessageWithLevel messages[], Level level) throws Exception {
177         for (LogMessageWithLevel l : messages) {
178             if (level.lessThan(l.level) || !l.isAvailable()) {
179                 output.shouldNotContain(l.message);
180             } else {
181                 output.shouldMatch(&quot;\\[&quot; + l.level + &quot;.*&quot; + l.message);
182             }
183         }
184     }
185 
186     public static void main(String[] args) throws Exception {
187         new TestGCLogMessages().testNormalLogs();
188         new TestGCLogMessages().testConcurrentRefinementLogs();
189         new TestGCLogMessages().testWithToSpaceExhaustionLogs();
<span class="line-modified">190         new TestGCLogMessages().testWithConcurrentStart();</span>
191         new TestGCLogMessages().testExpandHeap();
192     }
193 
194     private void testNormalLogs() throws Exception {
195 
196         ProcessBuilder pb = ProcessTools.createJavaProcessBuilder(&quot;-XX:+UseG1GC&quot;,
197                                                                   &quot;-Xmx10M&quot;,
198                                                                   GCTest.class.getName());
199 
200         OutputAnalyzer output = new OutputAnalyzer(pb.start());
201         checkMessagesAtLevel(output, allLogMessages, Level.OFF);
202         output.shouldHaveExitValue(0);
203 
204         pb = ProcessTools.createJavaProcessBuilder(&quot;-XX:+UseG1GC&quot;,
205                                                    &quot;-XX:+UseStringDeduplication&quot;,
206                                                    &quot;-Xmx10M&quot;,
207                                                    &quot;-Xlog:gc+phases=debug&quot;,
208                                                    GCTest.class.getName());
209 
210         output = new OutputAnalyzer(pb.start());
</pre>
<hr />
<pre>
249                                                                   &quot;-Xmx32M&quot;,
250                                                                   &quot;-Xmn16M&quot;,
251                                                                   &quot;-Xlog:gc+phases=debug&quot;,
252                                                                   GCTestWithToSpaceExhaustion.class.getName());
253 
254         OutputAnalyzer output = new OutputAnalyzer(pb.start());
255         checkMessagesAtLevel(output, exhFailureMessages, Level.DEBUG);
256         output.shouldHaveExitValue(0);
257 
258         pb = ProcessTools.createJavaProcessBuilder(&quot;-XX:+UseG1GC&quot;,
259                                                    &quot;-Xmx32M&quot;,
260                                                    &quot;-Xmn16M&quot;,
261                                                    &quot;-Xlog:gc+phases=trace&quot;,
262                                                    GCTestWithToSpaceExhaustion.class.getName());
263 
264         output = new OutputAnalyzer(pb.start());
265         checkMessagesAtLevel(output, exhFailureMessages, Level.TRACE);
266         output.shouldHaveExitValue(0);
267     }
268 
<span class="line-modified">269     private void testWithConcurrentStart() throws Exception {</span>
270         ProcessBuilder pb = ProcessTools.createJavaProcessBuilder(&quot;-XX:+UseG1GC&quot;,
271                                                                   &quot;-Xmx10M&quot;,
272                                                                   &quot;-Xbootclasspath/a:.&quot;,
273                                                                   &quot;-Xlog:gc*=debug&quot;,
274                                                                   &quot;-XX:+UnlockDiagnosticVMOptions&quot;,
275                                                                   &quot;-XX:+WhiteBoxAPI&quot;,
<span class="line-modified">276                                                                   GCTestWithConcurrentStart.class.getName());</span>
277 
278         OutputAnalyzer output = new OutputAnalyzer(pb.start());
279         output.shouldContain(&quot;Clear Claimed Marks&quot;);
280         output.shouldHaveExitValue(0);
281     }
282 
283     private void testExpandHeap() throws Exception {
284         ProcessBuilder pb = ProcessTools.createJavaProcessBuilder(&quot;-XX:+UseG1GC&quot;,
285                                                                   &quot;-Xmx10M&quot;,
286                                                                   &quot;-Xbootclasspath/a:.&quot;,
287                                                                   &quot;-Xlog:gc+ergo+heap=debug&quot;,
288                                                                   &quot;-XX:+UnlockDiagnosticVMOptions&quot;,
289                                                                   &quot;-XX:+WhiteBoxAPI&quot;,
290                                                                   GCTest.class.getName());
291 
292         OutputAnalyzer output = new OutputAnalyzer(pb.start());
293         output.shouldContain(&quot;Expand the heap. requested expansion amount: &quot;);
294         output.shouldContain(&quot;B expansion amount: &quot;);
295         output.shouldHaveExitValue(0);
296     }
</pre>
<hr />
<pre>
306             }
307             System.out.println(&quot;Done&quot;);
308         }
309     }
310 
311     static class GCTestWithToSpaceExhaustion {
312         private static byte[] garbage;
313         private static byte[] largeObject;
314         public static void main(String [] args) {
315             largeObject = new byte[16*1024*1024];
316             System.out.println(&quot;Creating garbage&quot;);
317             // create 128MB of garbage. This should result in at least one GC,
318             // some of them with to-space exhaustion.
319             for (int i = 0; i &lt; 1024; i++) {
320                 garbage = new byte[128 * 1024];
321             }
322             System.out.println(&quot;Done&quot;);
323         }
324     }
325 
<span class="line-modified">326     static class GCTestWithConcurrentStart {</span>
327         public static void main(String [] args) {
328             sun.hotspot.WhiteBox WB = sun.hotspot.WhiteBox.getWhiteBox();
329             WB.g1StartConcMarkCycle();
330         }
331     }
332 
333 }
334 
</pre>
</td>
</tr>
</table>
<center><a href="TestEagerReclaimHumongousRegionsClearMarkBits.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="TestRemsetLoggingTools.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>