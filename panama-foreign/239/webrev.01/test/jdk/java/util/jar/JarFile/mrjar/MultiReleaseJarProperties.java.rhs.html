<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames test/jdk/java/util/jar/JarFile/mrjar/MultiReleaseJarProperties.java</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
<a name="1" id="anc1"></a><span class="line-modified">  2  * Copyright (c) 2015, 2020, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 /*
 25  * @test
 26  * @bug 8132734 8144062 8194070
 27  * @summary Test the System properties for JarFile that support multi-release jar files
<a name="2" id="anc2"></a><span class="line-modified"> 28  * @library /lib/testlibrary/java/util/jar /test/lib/</span>
<span class="line-modified"> 29  * @build CreateMultiReleaseTestJars</span>
<span class="line-added"> 30  *        jdk.test.lib.compiler.Compiler</span>
<span class="line-added"> 31  *        jdk.test.lib.util.JarBuilder</span>
 32  * @run testng MultiReleaseJarProperties
 33  * @run testng/othervm -Djdk.util.jar.version=0   MultiReleaseJarProperties
 34  * @run testng/othervm -Djdk.util.jar.version=8   MultiReleaseJarProperties
 35  * @run testng/othervm -Djdk.util.jar.version=9   MultiReleaseJarProperties
 36  * @run testng/othervm -Djdk.util.jar.version=100 MultiReleaseJarProperties
 37  * @run testng/othervm -Djdk.util.jar.version=8   -Djdk.util.jar.enableMultiRelease=false MultiReleaseJarProperties
 38  * @run testng/othervm -Djdk.util.jar.version=9   -Djdk.util.jar.enableMultiRelease=false MultiReleaseJarProperties
 39  * @run testng/othervm -Djdk.util.jar.version=8   -Djdk.util.jar.enableMultiRelease=force MultiReleaseJarProperties
 40  * @run testng/othervm -Djdk.util.jar.version=9   -Djdk.util.jar.enableMultiRelease=force MultiReleaseJarProperties
 41  * @run testng/othervm -Djdk.util.jar.enableMultiRelease=false MultiReleaseJarProperties
 42  * @run testng/othervm -Djdk.util.jar.enableMultiRelease=force MultiReleaseJarProperties
 43  */
 44 
 45 import java.io.File;
 46 import java.io.IOException;
 47 import java.io.InputStream;
 48 import java.lang.invoke.MethodHandle;
 49 import java.lang.invoke.MethodHandles;
 50 import java.lang.invoke.MethodType;
 51 import java.net.URL;
 52 import java.net.URLClassLoader;
 53 import java.nio.file.Files;
 54 import java.util.jar.JarEntry;
 55 import java.util.jar.JarFile;
 56 
 57 import org.testng.Assert;
 58 import org.testng.annotations.AfterClass;
 59 import org.testng.annotations.BeforeClass;
 60 import org.testng.annotations.Test;
 61 
 62 
 63 public class MultiReleaseJarProperties {
 64     final static int BASE_VERSION = JarFile.baseVersion().major();
 65 
 66     final static String userdir = System.getProperty(&quot;user.dir&quot;, &quot;.&quot;);
 67     final static File multirelease = new File(userdir, &quot;multi-release.jar&quot;);
 68     protected int rtVersion;
 69     boolean force;
 70     protected ClassLoader cldr;
 71     protected Class&lt;?&gt; rootClass;
 72 
 73     @BeforeClass
 74     public void initialize() throws Exception {
 75         CreateMultiReleaseTestJars creator =  new CreateMultiReleaseTestJars();
 76         creator.compileEntries();
 77         creator.buildMultiReleaseJar();
 78         int RUNTIME_VERSION = Runtime.version().major();
 79         rtVersion = Integer.getInteger(&quot;jdk.util.jar.version&quot;, RUNTIME_VERSION);
 80         String mrprop = System.getProperty(&quot;jdk.util.jar.enableMultiRelease&quot;, &quot;&quot;);
 81         if (mrprop.equals(&quot;false&quot;)) {
 82             rtVersion = BASE_VERSION;
 83         } else if (rtVersion &lt; BASE_VERSION) {
 84             rtVersion = BASE_VERSION;
 85         } else if (rtVersion &gt; RUNTIME_VERSION) {
 86             rtVersion = RUNTIME_VERSION;
 87         }
 88         force = mrprop.equals(&quot;force&quot;);
 89 
 90         initializeClassLoader();
 91     }
 92 
 93     protected void initializeClassLoader() throws Exception {
 94         URL[] urls = new URL[]{multirelease.toURI().toURL()};
 95         cldr = new URLClassLoader(urls);
 96         // load any class, Main is convenient and in the root entries
 97         rootClass = cldr.loadClass(&quot;version.Main&quot;);
 98     }
 99 
100     @AfterClass
101     public void close() throws IOException {
102         ((URLClassLoader)cldr).close();
103         Files.delete(multirelease.toPath());
104     }
105 
106     /*
107      * jdk.util.jar.enableMultiRelease=force is a no-op for URLClassLoader
108      */
109     @Test
110     public void testURLClassLoader() throws Throwable {
111         Class&lt;?&gt; vcls = cldr.loadClass(&quot;version.Version&quot;);
112         invokeMethod(vcls, rtVersion);
113     }
114 
115     protected void invokeMethod(Class&lt;?&gt; vcls, int expected) throws Throwable {
116         MethodType mt = MethodType.methodType(int.class);
117         MethodHandle mh = MethodHandles.lookup().findVirtual(vcls, &quot;getVersion&quot;, mt);
118         Assert.assertEquals(expected, (int) mh.invoke(vcls.newInstance()));
119     }
120 
121     /*
122      * jdk.util.jar.enableMultiRelease=force should affect a custom class loader
123      */
124     @Test
125     public void testClassLoader() throws Throwable {
126         try (JarFile jf = new JarFile(multirelease)) {  // do not set runtime versioning
127             ClassLoader cldr = new CustomClassLoader(jf);
128             Class&lt;?&gt; vcls = cldr.loadClass(&quot;version.Version&quot;);
129             if (rtVersion == 9) {
130                 try {
131                     cldr.loadClass(&quot;version.PackagePrivate&quot;);
132                 } catch (ClassNotFoundException x) {
133                     if (force) throw x;
134                 }
135             }
136             invokeMethod(vcls, force ? rtVersion : BASE_VERSION);
137         }
138     }
139 
140     private static class CustomClassLoader extends ClassLoader {
141         private final JarFile jf;
142 
143         CustomClassLoader(JarFile jf) throws Exception {
144             super(null);
145             this.jf = jf;
146         }
147 
148         protected Class&lt;?&gt; findClass(String name) throws ClassNotFoundException {
149             try {
150                 byte[] b;
151                 String entryName = name.replace(&quot;.&quot;, &quot;/&quot;) + &quot;.class&quot;;
152                 JarEntry je = jf.getJarEntry(entryName);
153                 if (je != null) {
154                     try (InputStream is = jf.getInputStream(je)) {
155                         b = new byte[(int) je.getSize()];
156                         is.read(b);
157                     }
158                     return defineClass(name, b, 0, b.length);
159                 }
160                 throw new ClassNotFoundException(name);
161             } catch (IOException x) {
162                 throw new ClassNotFoundException(x.getMessage());
163             }
164         }
165     }
166 
167     @Test
168     public void testGetResourceAsStream() throws Exception {
169         String resource = rtVersion == 9 ? &quot;/version/PackagePrivate.java&quot; : &quot;/version/Version.java&quot;;
170         // use fileRootClass as a base for getting resources
171         getResourceAsStream(rootClass, resource);
172     }
173 
174     protected void getResourceAsStream(Class&lt;?&gt; rootClass, String resource) throws Exception {
175         try (InputStream is = rootClass.getResourceAsStream(resource)) {
176             byte[] bytes = is.readAllBytes();
177             resource = new String(bytes);
178         }
179         String match = &quot;return &quot; + rtVersion + &quot;;&quot;;
180         Assert.assertTrue(resource.contains(match));
181     }
182 
183     @Test
184     public void testGetResource() throws Exception {
185         String resource = rtVersion == 9 ? &quot;/version/PackagePrivate.java&quot; : &quot;/version/Version.java&quot;;
186         // use rootClass as a base for getting resources
187         getResource(rootClass, resource);
188     }
189 
190     protected void getResource(Class&lt;?&gt; rootClass, String resource) throws Exception {
191         URL url = rootClass.getResource(resource);
192         try (InputStream is = url.openStream()) {
193             byte[] bytes = is.readAllBytes();
194             resource = new String(bytes);
195         }
196         String match = &quot;return &quot; + rtVersion + &quot;;&quot;;
197         Assert.assertTrue(resource.contains(match));
198     }
199 }
<a name="3" id="anc3"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="3" type="hidden" />
</body>
</html>