<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff test/jdk/java/security/SecureRandom/DefaultAlgo.java</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
<body>
<center><a href="../KeyAgreement/KeyAgreementTest.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="ThreadSafe.java.cdiff.html" target="_top">next &gt;</a></center>    <h2>test/jdk/java/security/SecureRandom/DefaultAlgo.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 24,24 ***</span>
  import static java.lang.System.out;
  import java.security.Provider;
  import java.security.Security;
  import java.security.SecureRandom;
  import java.security.Provider.Service;
<span class="line-removed">- import java.util.Objects;</span>
  import java.util.Arrays;
  import sun.security.provider.SunEntries;
  
  /**
   * @test
<span class="line-modified">!  * @bug 8228613 8246613</span>
   * @summary Ensure that the default SecureRandom algo used is based
   *     on the registration ordering, and falls to next provider
   *     if none are found
   * @modules java.base/sun.security.provider
   */
  public class DefaultAlgo {
  
      public static void main(String[] args) throws Exception {
          String[] algos = { &quot;A&quot;, &quot;B&quot;, &quot;C&quot; };
          test3rdParty(algos);
          // reverse the order and re-check
          String[] algosReversed = { &quot;C&quot;, &quot;B&quot;, &quot;A&quot; };
<span class="line-new-header">--- 24,26 ---</span>
  import static java.lang.System.out;
  import java.security.Provider;
  import java.security.Security;
  import java.security.SecureRandom;
  import java.security.Provider.Service;
  import java.util.Arrays;
  import sun.security.provider.SunEntries;
  
  /**
   * @test
<span class="line-modified">!  * @bug 8228613 8246613 8248505</span>
   * @summary Ensure that the default SecureRandom algo used is based
   *     on the registration ordering, and falls to next provider
   *     if none are found
   * @modules java.base/sun.security.provider
   */
  public class DefaultAlgo {
  
<span class="line-added">+     private static final String SR_IMPLCLASS =</span>
<span class="line-added">+             &quot;sun.security.provider.SecureRandom&quot;;</span>
<span class="line-added">+ </span>
      public static void main(String[] args) throws Exception {
          String[] algos = { &quot;A&quot;, &quot;B&quot;, &quot;C&quot; };
          test3rdParty(algos);
          // reverse the order and re-check
          String[] algosReversed = { &quot;C&quot;, &quot;B&quot;, &quot;A&quot; };
</pre>
<hr />
<pre>
<span class="line-old-header">*** 49,11 ***</span>
      }
  
      private static void test3rdParty(String[] algos) {
          Provider[] provs = {
              new SampleLegacyProvider(algos),
<span class="line-modified">!             new SampleServiceProvider(algos)</span>
          };
          for (Provider p : provs) {
              checkDefault(p, algos);
          }
      }
<span class="line-new-header">--- 51,12 ---</span>
      }
  
      private static void test3rdParty(String[] algos) {
          Provider[] provs = {
              new SampleLegacyProvider(algos),
<span class="line-modified">!             new SampleServiceProvider(algos),</span>
<span class="line-added">+             new CustomProvider(algos)</span>
          };
          for (Provider p : provs) {
              checkDefault(p, algos);
          }
      }
</pre>
<hr />
<pre>
<span class="line-old-header">*** 70,13 ***</span>
                      algo + &quot;, got &quot; + sr.getAlgorithm());
          }
      }
  
      private static void checkDefault(Provider p, String ... algos) {
<span class="line-removed">-         out.println(p.getName() + &quot; with &quot; + Arrays.toString(algos));</span>
<span class="line-removed">-         int pos = Security.insertProviderAt(p, 1);</span>
          String pName = p.getName();
          boolean isLegacy = pName.equals(&quot;SampleLegacy&quot;);
          try {
              if (isLegacy) {
                  for (String s : algos) {
                      validate(new SecureRandom(), pName, s);
<span class="line-new-header">--- 73,14 ---</span>
                      algo + &quot;, got &quot; + sr.getAlgorithm());
          }
      }
  
      private static void checkDefault(Provider p, String ... algos) {
          String pName = p.getName();
<span class="line-added">+         out.println(pName + &quot; with &quot; + Arrays.toString(algos));</span>
<span class="line-added">+         int pos = Security.insertProviderAt(p, 1);</span>
<span class="line-added">+ </span>
          boolean isLegacy = pName.equals(&quot;SampleLegacy&quot;);
          try {
              if (isLegacy) {
                  for (String s : algos) {
                      validate(new SecureRandom(), pName, s);
</pre>
<hr />
<pre>
<span class="line-old-header">*** 89,29 ***</span>
                  validate(new SecureRandom(), pName, algos[0]);
              }
              out.println(&quot;=&gt; Test Passed&quot;);
          } finally {
              if (pos != -1) {
<span class="line-modified">!                 Security.removeProvider(p.getName());</span>
              }
          }
      }
  
      private static class SampleLegacyProvider extends Provider {
          SampleLegacyProvider(String[] listOfSupportedRNGs) {
              super(&quot;SampleLegacy&quot;, &quot;1.0&quot;, &quot;test provider using legacy put&quot;);
              for (String s : listOfSupportedRNGs) {
<span class="line-modified">!                 put(&quot;SecureRandom.&quot; + s, &quot;sun.security.provider.SecureRandom&quot;);</span>
              }
          }
      }
  
      private static class SampleServiceProvider extends Provider {
          SampleServiceProvider(String[] listOfSupportedRNGs) {
              super(&quot;SampleService&quot;, &quot;1.0&quot;, &quot;test provider using putService&quot;);
              for (String s : listOfSupportedRNGs) {
                  putService(new Provider.Service(this, &quot;SecureRandom&quot;, s,
<span class="line-modified">!                         &quot;sun.security.provider.SecureRandom&quot;, null, null));</span>
              }
          }
      }
  }
<span class="line-new-header">--- 93,64 ---</span>
                  validate(new SecureRandom(), pName, algos[0]);
              }
              out.println(&quot;=&gt; Test Passed&quot;);
          } finally {
              if (pos != -1) {
<span class="line-modified">!                 Security.removeProvider(pName);</span>
<span class="line-added">+             }</span>
<span class="line-added">+             if (isLegacy) {</span>
<span class="line-added">+                 // add back the removed algos</span>
<span class="line-added">+                 for (String s : algos) {</span>
<span class="line-added">+                     p.put(&quot;SecureRandom.&quot; + s, SR_IMPLCLASS);</span>
<span class="line-added">+                 }</span>
              }
          }
      }
  
      private static class SampleLegacyProvider extends Provider {
          SampleLegacyProvider(String[] listOfSupportedRNGs) {
              super(&quot;SampleLegacy&quot;, &quot;1.0&quot;, &quot;test provider using legacy put&quot;);
              for (String s : listOfSupportedRNGs) {
<span class="line-modified">!                 put(&quot;SecureRandom.&quot; + s, SR_IMPLCLASS);</span>
              }
          }
      }
  
      private static class SampleServiceProvider extends Provider {
          SampleServiceProvider(String[] listOfSupportedRNGs) {
              super(&quot;SampleService&quot;, &quot;1.0&quot;, &quot;test provider using putService&quot;);
              for (String s : listOfSupportedRNGs) {
                  putService(new Provider.Service(this, &quot;SecureRandom&quot;, s,
<span class="line-modified">!                         SR_IMPLCLASS, null, null));</span>
<span class="line-added">+             }</span>
<span class="line-added">+         }</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
<span class="line-added">+     // custom provider which overrides putService(...)/getService() and uses</span>
<span class="line-added">+     // its own Service impl</span>
<span class="line-added">+     private static class CustomProvider extends Provider {</span>
<span class="line-added">+         private static class CustomService extends Provider.Service {</span>
<span class="line-added">+             CustomService(Provider p, String type, String algo, String cName) {</span>
<span class="line-added">+                 super(p, type, algo, cName, null, null);</span>
              }
          }
<span class="line-added">+ </span>
<span class="line-added">+         CustomProvider(String[] listOfSupportedRNGs) {</span>
<span class="line-added">+             super(&quot;Custom&quot;, &quot;1.0&quot;, &quot;test provider overrides putService with &quot; +</span>
<span class="line-added">+                     &quot; custom service with legacy registration&quot;);</span>
<span class="line-added">+             for (String s : listOfSupportedRNGs) {</span>
<span class="line-added">+                 putService(new CustomService(this, &quot;SecureRandom&quot;, s ,</span>
<span class="line-added">+                         SR_IMPLCLASS));</span>
<span class="line-added">+             }</span>
<span class="line-added">+         }</span>
<span class="line-added">+         @Override</span>
<span class="line-added">+         protected void putService(Provider.Service s) {</span>
<span class="line-added">+             // convert to legacy puts</span>
<span class="line-added">+             put(s.getType() + &quot;.&quot; + s.getAlgorithm(), s.getClassName());</span>
<span class="line-added">+             put(s.getType() + &quot;:&quot; + s.getAlgorithm(), s);</span>
<span class="line-added">+         }</span>
<span class="line-added">+         @Override</span>
<span class="line-added">+         public Provider.Service getService(String type, String algo) {</span>
<span class="line-added">+             return (Provider.Service) get(type + &quot;:&quot; + algo);</span>
<span class="line-added">+         }</span>
      }
  }
</pre>
<center><a href="../KeyAgreement/KeyAgreementTest.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="ThreadSafe.java.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>