<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff test/jdk/jdk/jfr/event/runtime/TestThreadStartEndEvents.java</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
  </head>
<body>
<center><a href="../../../../javax/swing/plaf/basic/BasicGraphicsUtils/8132119/bug8132119.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="../../../nio/zipfs/jarfs/JFSTester.java.udiff.html" target="_top">next &gt;</a></center>    <h2>test/jdk/jdk/jfr/event/runtime/TestThreadStartEndEvents.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -1,7 +1,7 @@</span>
  /*
<span class="udiff-line-modified-removed">-  * Copyright (c) 2013, 2018, Oracle and/or its affiliates. All rights reserved.</span>
<span class="udiff-line-modified-added">+  * Copyright (c) 2013, 2020, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.  Oracle designates this
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -46,53 +46,69 @@</span>
   * @library /test/lib
   * @run main/othervm jdk.jfr.event.runtime.TestThreadStartEndEvents
   */
  
  /**
<span class="udiff-line-modified-removed">-  * Starts and stops a number of threads in order.</span>
<span class="udiff-line-modified-removed">-  * Verifies that events are in the same order.</span>
<span class="udiff-line-modified-added">+  * Starts a number of threads in order and verifies</span>
<span class="udiff-line-modified-added">+  * that Thread Start events are in that same order.</span>
<span class="udiff-line-added">+  * The order of Thread End events is non-deterministic.</span>
   */
  public class TestThreadStartEndEvents {
      private final static String EVENT_NAME_THREAD_START = EventNames.ThreadStart;
      private final static String EVENT_NAME_THREAD_END = EventNames.ThreadEnd;
      private static final String THREAD_NAME_PREFIX = &quot;TestThread-&quot;;
<span class="udiff-line-added">+     private static int currentThreadIndex = 0;</span>
<span class="udiff-line-added">+     private static int numberOfThreadStartEvents = 0;</span>
<span class="udiff-line-added">+     private static int numberOfThreadEndEvents = 0;</span>
  
      public static void main(String[] args) throws Throwable {
<span class="udiff-line-removed">-         // Test Java Thread Start event</span>
          Recording recording = new Recording();
          recording.enable(EVENT_NAME_THREAD_START).withThreshold(Duration.ofMillis(0));
          recording.enable(EVENT_NAME_THREAD_END).withThreshold(Duration.ofMillis(0));
          recording.start();
          LatchedThread[] threads = startThreads();
          stopThreads(threads);
          recording.stop();
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-         int currThreadIndex = 0;</span>
          List&lt;RecordedEvent&gt; events = Events.fromRecording(recording);
          events.sort((e1, e2) -&gt; e1.getStartTime().compareTo(e2.getStartTime()));
          Events.hasEvents(events);
          for (RecordedEvent event : events) {
              if (!event.getThread().getJavaName().startsWith(THREAD_NAME_PREFIX)) {
                  continue;
              }
              System.out.println(&quot;Event:&quot; + event);
<span class="udiff-line-modified-removed">-             // Threads should be started and stopped in the correct order.</span>
<span class="udiff-line-modified-removed">-             Events.assertEventThread(event, threads[currThreadIndex % threads.length]);</span>
<span class="udiff-line-modified-removed">-             String eventName = currThreadIndex &lt; threads.length ? EVENT_NAME_THREAD_START : EVENT_NAME_THREAD_END;</span>
<span class="udiff-line-modified-removed">-             if (!eventName.equals(event.getEventType().getName())) {</span>
<span class="udiff-line-modified-removed">-                 throw new Exception(&quot;Expected event of type &quot; + eventName + &quot; but got &quot; + event.getEventType().getName());</span>
<span class="udiff-line-modified-removed">-             }</span>
<span class="udiff-line-modified-removed">- </span>
<span class="udiff-line-modified-removed">-             if (eventName == EVENT_NAME_THREAD_START) {</span>
<span class="udiff-line-modified-removed">-                 Events.assertEventThread(event, &quot;parentThread&quot;, Thread.currentThread());</span>
<span class="udiff-line-modified-removed">-                 RecordedStackTrace stackTrace = event.getValue(&quot;stackTrace&quot;);</span>
<span class="udiff-line-removed">-                 assertNotNull(stackTrace);</span>
<span class="udiff-line-removed">-                 RecordedMethod topMethod = stackTrace.getFrames().get(0).getMethod();</span>
<span class="udiff-line-removed">-                 assertEQ(topMethod.getName(), &quot;startThread&quot;);</span>
<span class="udiff-line-modified-added">+             String eventType = event.getEventType().getName();</span>
<span class="udiff-line-modified-added">+             switch (eventType) {</span>
<span class="udiff-line-modified-added">+                 case EVENT_NAME_THREAD_START:</span>
<span class="udiff-line-modified-added">+                     validateThreadStartEvent(event, threads);</span>
<span class="udiff-line-modified-added">+                 break;</span>
<span class="udiff-line-modified-added">+                 case EVENT_NAME_THREAD_END:</span>
<span class="udiff-line-modified-added">+                     validateThreadEndEvent(event);</span>
<span class="udiff-line-modified-added">+                 break;</span>
<span class="udiff-line-modified-added">+                 default:</span>
<span class="udiff-line-modified-added">+                    throw new RuntimeException(&quot;Test encountered an invalid event: &quot; + eventType);</span>
              }
<span class="udiff-line-removed">-             currThreadIndex++;</span>
          }
<span class="udiff-line-added">+         assertEQ(numberOfThreadStartEvents, threads.length);</span>
<span class="udiff-line-added">+         assertEQ(numberOfThreadEndEvents, threads.length);</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     // The order of Thread Start events should corresponding to their start order.</span>
<span class="udiff-line-added">+     private static void validateThreadStartEvent(RecordedEvent event, LatchedThread[] threads) {</span>
<span class="udiff-line-added">+         Events.assertEventThread(event, threads[currentThreadIndex++]);</span>
<span class="udiff-line-added">+         Events.assertEventThread(event, &quot;parentThread&quot;, Thread.currentThread());</span>
<span class="udiff-line-added">+         RecordedStackTrace stackTrace = event.getValue(&quot;stackTrace&quot;);</span>
<span class="udiff-line-added">+         assertNotNull(stackTrace);</span>
<span class="udiff-line-added">+         RecordedMethod topMethod = stackTrace.getFrames().get(0).getMethod();</span>
<span class="udiff-line-added">+         assertEQ(topMethod.getName(), &quot;startThread&quot;);</span>
<span class="udiff-line-added">+         numberOfThreadStartEvents++;</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     // The order of Thread End events is non-deterministic. This is because the event</span>
<span class="udiff-line-added">+     // is committed as part of dismantling the JavaThread in the VM, post thread.isAlive().</span>
<span class="udiff-line-added">+     private static void validateThreadEndEvent(RecordedEvent event) {</span>
<span class="udiff-line-added">+         numberOfThreadEndEvents++;</span>
      }
  
      private static LatchedThread[] startThreads() {
          LatchedThread threads[] = new LatchedThread[10];
          ThreadGroup threadGroup = new ThreadGroup(&quot;TestThreadGroup&quot;);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -145,7 +161,6 @@</span>
  
          public void stopThread() {
              stop.countDown();
          }
      }
<span class="udiff-line-removed">- </span>
  }
</pre>
<center><a href="../../../../javax/swing/plaf/basic/BasicGraphicsUtils/8132119/bug8132119.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="../../../nio/zipfs/jarfs/JFSTester.java.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>