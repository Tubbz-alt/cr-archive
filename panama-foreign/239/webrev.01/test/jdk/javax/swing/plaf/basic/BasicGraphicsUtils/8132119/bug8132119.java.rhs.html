<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames test/jdk/javax/swing/plaf/basic/BasicGraphicsUtils/8132119/bug8132119.java</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
  2  * Copyright (c) 2016, Oracle and/or its affiliates. All rights reserved.
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
<a name="1" id="anc1"></a><span class="line-added"> 23 import java.io.File;</span>
<span class="line-added"> 24 import javax.imageio.ImageIO;</span>
 25 
 26 import java.awt.Color;
 27 import java.awt.Font;
 28 import java.awt.FontMetrics;
 29 import java.awt.Graphics2D;
 30 import java.awt.GraphicsEnvironment;
 31 import java.awt.RenderingHints;
 32 import java.awt.font.FontRenderContext;
 33 import java.awt.font.NumericShaper;
 34 import java.awt.font.TextAttribute;
 35 import java.awt.font.TextLayout;
 36 import java.awt.image.BufferedImage;
 37 import java.util.HashMap;
 38 import javax.swing.JComponent;
 39 import javax.swing.JLabel;
 40 import javax.swing.SwingUtilities;
 41 import javax.swing.UIManager;
 42 import javax.swing.plaf.basic.BasicGraphicsUtils;
 43 import javax.swing.plaf.metal.MetalLookAndFeel;
 44 
 45 /**
 46  * @test
 47  * @bug 8132119 8168992 8169897 8207941
 48  * @author Alexandr Scherbatiy
 49  * @summary Provide public API for text related methods in SwingBasicGraphicsUtils2
 50  */
 51 public class bug8132119 {
 52 
 53     private static final int WIDTH = 50;
 54     private static final int HEIGHT = 50;
 55     private static final Color DRAW_COLOR = Color.RED;
 56     private static final Color BACKGROUND_COLOR = Color.GREEN;
 57     private static final NumericShaper NUMERIC_SHAPER = NumericShaper.getShaper(
 58             NumericShaper.ARABIC);
 59 
 60     public static void main(String[] args) throws Exception {
 61         SwingUtilities.invokeAndWait(bug8132119::testStringMethods);
 62     }
 63 
 64     private static void testStringMethods() {
 65         setMetalLAF();
 66         testStringWidth();
 67         testStringClip();
 68         testDrawEmptyString();
 69         testDrawString(false);
 70         testDrawString(true);
 71         checkNullArguments();
 72     }
 73 
 74     private static void testStringWidth() {
 75 
 76         String str = &quot;12345678910\u036F&quot;;
 77         JComponent comp = createComponent(str);
 78         Font font = comp.getFont();
 79         FontMetrics fontMetrics = comp.getFontMetrics(font);
 80         float stringWidth = BasicGraphicsUtils.getStringWidth(comp, fontMetrics, str);
 81 
 82         if (stringWidth == fontMetrics.stringWidth(str)) {
 83             throw new RuntimeException(&quot;Numeric shaper is not used!&quot;);
 84         }
 85 
 86         if (stringWidth != getLayoutWidth(str, font, NUMERIC_SHAPER)) {
 87             throw new RuntimeException(&quot;Wrong text width!&quot;);
 88         }
 89     }
 90 
 91     private static void testStringClip() {
 92 
 93         String str = &quot;1234567890&quot;;
 94         JComponent comp = createComponent(str);
 95         FontMetrics fontMetrics = comp.getFontMetrics(comp.getFont());
 96 
 97         int width = (int) BasicGraphicsUtils.getStringWidth(comp, fontMetrics, str);
 98 
 99         String clip = BasicGraphicsUtils.getClippedString(comp, fontMetrics, str, width);
100         checkClippedString(str, clip, str);
101 
102         clip = BasicGraphicsUtils.getClippedString(comp, fontMetrics, str, width + 1);
103         checkClippedString(str, clip, str);
104 
105         clip = BasicGraphicsUtils.getClippedString(comp, fontMetrics, str, -1);
106         checkClippedString(str, clip, &quot;...&quot;);
107 
108         clip = BasicGraphicsUtils.getClippedString(comp, fontMetrics, str, 0);
109         checkClippedString(str, clip, &quot;...&quot;);
110 
111         clip = BasicGraphicsUtils.getClippedString(comp, fontMetrics,
112                 str, width - width / str.length());
113         int endIndex = str.length() - 3;
114         checkClippedString(str, clip, str.substring(0, endIndex) + &quot;...&quot;);
115     }
116 
117     private static void checkClippedString(String str, String res, String golden) {
118         if (!golden.equals(res)) {
119             throw new RuntimeException(String.format(&quot;The string &#39;%s&#39; is not &quot;
120                     + &quot;properly clipped. The result is &#39;%s&#39; instead of &#39;%s&#39;&quot;,
121                     str, res, golden));
122         }
123     }
124 
125     private static void testDrawEmptyString() {
126         JLabel label = new JLabel();
127         BufferedImage buffImage = createBufferedImage(50, 50);
128         Graphics2D g2 = buffImage.createGraphics();
129         g2.setColor(DRAW_COLOR);
130         BasicGraphicsUtils.drawString(null, g2, null, 0, 0);
131         BasicGraphicsUtils.drawString(label, g2, null, 0, 0);
132         BasicGraphicsUtils.drawString(null, g2, &quot;&quot;, 0, 0);
133         BasicGraphicsUtils.drawString(label, g2, &quot;&quot;, 0, 0);
134         BasicGraphicsUtils.drawStringUnderlineCharAt(null, g2, null, 3, 0, 0);
135         BasicGraphicsUtils.drawStringUnderlineCharAt(label, g2, null, 3, 0, 0);
136         BasicGraphicsUtils.drawStringUnderlineCharAt(null, g2, &quot;&quot;, 3, 0, 0);
137         BasicGraphicsUtils.drawStringUnderlineCharAt(label, g2, &quot;&quot;, 3, 0, 0);
138         g2.dispose();
139         checkImageIsEmpty(buffImage);
140     }
141 
142     private static void testDrawString(boolean underlined) {
143         String str = &quot;AOB&quot;;
144         JComponent comp = createComponent(str);
145 
146         BufferedImage buffImage = createBufferedImage(WIDTH, HEIGHT);
147         Graphics2D g2 = buffImage.createGraphics();
148 
149         g2.setColor(DRAW_COLOR);
150         g2.setFont(comp.getFont());
151         g2.setRenderingHint(RenderingHints.KEY_TEXT_ANTIALIASING,
152                             RenderingHints.VALUE_TEXT_ANTIALIAS_OFF);
153 
154         FontMetrics fontMetrices = comp.getFontMetrics(comp.getFont());
155         float width = BasicGraphicsUtils.getStringWidth(comp, fontMetrices, str);
<a name="2" id="anc2"></a>
156         int y = 3 * HEIGHT / 4;
157 
158         if (underlined) {
<a name="3" id="anc3"></a><span class="line-modified">159             BasicGraphicsUtils.drawStringUnderlineCharAt(comp, g2, str, 1, 0, y);</span>
160         } else {
<a name="4" id="anc4"></a><span class="line-modified">161             BasicGraphicsUtils.drawString(comp, g2, str, 0, y);</span>
162         }
163         g2.dispose();
164 
<a name="5" id="anc5"></a><span class="line-modified">165         float xx = 0;</span>
<span class="line-modified">166         if (underlined) {</span>
<span class="line-added">167             xx = BasicGraphicsUtils.getStringWidth(comp, fontMetrices, &quot;A&quot;) +</span>
<span class="line-added">168                 BasicGraphicsUtils.getStringWidth(comp, fontMetrices, &quot;O&quot;)/2  - 5;</span>
<span class="line-added">169         } else {</span>
<span class="line-added">170             xx = BasicGraphicsUtils.getStringWidth(comp, fontMetrices, &quot;A&quot;) +</span>
<span class="line-added">171                 BasicGraphicsUtils.getStringWidth(comp, fontMetrices, &quot;O&quot;)/2;</span>
<span class="line-added">172         }</span>
173 
174         checkImageContainsSymbol(buffImage, (int) xx, underlined ? 3 : 2);
175     }
176 
177     private static void checkNullArguments() {
178 
179         Graphics2D g = null;
180         try {
181             String text = &quot;Test&quot;;
182             JComponent component = new JLabel(text);
183             BufferedImage img = createBufferedImage(100, 100);
184             g = img.createGraphics();
185             checkNullArguments(component, g, text);
186         } finally {
187             g.dispose();
188         }
189     }
190 
191     private static void checkNullArguments(JComponent comp, Graphics2D g,
192             String text) {
193 
194         checkNullArgumentsDrawString(comp, g, text);
195         checkNullArgumentsDrawStringUnderlineCharAt(comp, g, text);
196         checkNullArgumentsGetClippedString(comp, text);
197         checkNullArgumentsGetStringWidth(comp, text);
198     }
199 
200     private static void checkNullArgumentsDrawString(JComponent comp, Graphics2D g,
201             String text) {
202 
203         float x = 50;
204         float y = 50;
205         BasicGraphicsUtils.drawString(null, g, text, x, y);
206         BasicGraphicsUtils.drawString(comp, g, null, x, y);
207 
208         try {
209             BasicGraphicsUtils.drawString(comp, null, text, x, y);
210         } catch (NullPointerException e) {
211             return;
212         }
213 
214         throw new RuntimeException(&quot;NPE is not thrown&quot;);
215     }
216 
217     private static void checkNullArgumentsDrawStringUnderlineCharAt(
218             JComponent comp, Graphics2D g, String text) {
219 
220         int x = 50;
221         int y = 50;
222         BasicGraphicsUtils.drawStringUnderlineCharAt(null, g, text, 1, x, y);
223         BasicGraphicsUtils.drawStringUnderlineCharAt(comp, g, null, 1, x, y);
224 
225         try {
226             BasicGraphicsUtils.drawStringUnderlineCharAt(comp, null, text, 1, x, y);
227         } catch (NullPointerException e) {
228             return;
229         }
230 
231         throw new RuntimeException(&quot;NPE is not thrown&quot;);
232     }
233 
234     private static void checkNullArgumentsGetClippedString(
235             JComponent comp, String text) {
236 
237         FontMetrics fontMetrics = comp.getFontMetrics(comp.getFont());
238 
239         BasicGraphicsUtils.getClippedString(null, fontMetrics, text, 1);
240         String result = BasicGraphicsUtils.getClippedString(comp, fontMetrics, null, 1);
241         if (!&quot;&quot;.equals(result)) {
242             throw new RuntimeException(&quot;Empty string is not returned!&quot;);
243         }
244 
245         try {
246             BasicGraphicsUtils.getClippedString(comp, null, text, 1);
247         } catch (NullPointerException e) {
248             return;
249         }
250 
251         throw new RuntimeException(&quot;NPE is not thrown&quot;);
252     }
253 
254     private static void checkNullArgumentsGetStringWidth(JComponent comp,
255             String text) {
256 
257         FontMetrics fontMetrics = comp.getFontMetrics(comp.getFont());
258         BasicGraphicsUtils.getStringWidth(null, fontMetrics, text);
259         float result = BasicGraphicsUtils.getStringWidth(comp, fontMetrics, null);
260 
261         if (result != 0) {
262             throw new RuntimeException(&quot;The string length is not 0&quot;);
263         }
264 
265         try {
266             BasicGraphicsUtils.getStringWidth(comp, null, text);
267         } catch (NullPointerException e) {
268             return;
269         }
270 
271         throw new RuntimeException(&quot;NPE is not thrown&quot;);
272     }
273 
274     private static void setMetalLAF() {
275         try {
276             UIManager.setLookAndFeel(new MetalLookAndFeel());
277         } catch (Exception e) {
278             throw new RuntimeException(e);
279         }
280     }
281 
282     private static JComponent createComponent(String str) {
283         JComponent comp = new JLabel(str);
284         comp.setSize(WIDTH, HEIGHT);
285         comp.putClientProperty(TextAttribute.NUMERIC_SHAPING, NUMERIC_SHAPER);
286         comp.setFont(getFont());
287         return comp;
288     }
289 
290     private static String getFontName(String fn, String[] fontNames) {
291         String fontName = null;
292         for (String name : fontNames) {
293             if (fn.equals(name)) {
294                 fontName = name;
295                 break;
296             }
297         }
298         return fontName;
299     }
300 
301     private static Font getFont() {
302         GraphicsEnvironment ge = GraphicsEnvironment.getLocalGraphicsEnvironment();
303         String[] fontNames = ge.getAvailableFontFamilyNames();
304 
305         // We do not have Arial on all systems so provide some reasonable fallbacks.
306         // In case the fallbacks are not available as well, choose as last fallback
307         // the first font - however this might be a problematic choice.
308         String fontName = getFontName(&quot;Arial&quot;, fontNames);
309         if (fontName == null) {
310             fontName = getFontName(&quot;Bitstream Charter&quot;, fontNames);
311             if (fontName == null) {
312                 fontName = getFontName(&quot;Dialog&quot;, fontNames);
313                 if (fontName == null) {
314                     fontName = fontNames[0];
315                     System.out.println(&quot;warning - preferred fonts not on the system, fall back to first font &quot; + fontName);
316                 }
317             }
318         }
319         return new Font(fontName, Font.PLAIN, 30);
320     }
321 
322     private static float getLayoutWidth(String text, Font font, NumericShaper shaper) {
323         HashMap map = new HashMap();
324         map.put(TextAttribute.FONT, font);
325         map.put(TextAttribute.NUMERIC_SHAPING, shaper);
326         FontRenderContext frc = new FontRenderContext(null, false, false);
327         TextLayout layout = new TextLayout(text, map, frc);
328         return layout.getAdvance();
329     }
330 
331     private static void checkImageIsEmpty(BufferedImage buffImage) {
332         int background = BACKGROUND_COLOR.getRGB();
333 
334         for (int i = 0; i &lt; buffImage.getWidth(); i++) {
335             for (int j = 0; j &lt; buffImage.getHeight(); j++) {
336                 if (background != buffImage.getRGB(i, j)) {
337                     throw new RuntimeException(&quot;Image is not empty!&quot;);
338                 }
339             }
340         }
341     }
342 
343     private static void checkImageContainsSymbol(BufferedImage buffImage,
344             int x, int intersections) {
345 
346         int background = BACKGROUND_COLOR.getRGB();
347         boolean isBackground = true;
348         int backgroundChangesCount = 0;
349 
350         for (int y = 0; y &lt; buffImage.getHeight(); y++) {
351             if (!(isBackground ^ (background != buffImage.getRGB(x, y)))) {
352                 isBackground = !isBackground;
353                 backgroundChangesCount++;
354             }
355         }
356 
<a name="6" id="anc6"></a><span class="line-added">357 </span>
358         if (backgroundChangesCount != intersections * 2) {
<a name="7" id="anc7"></a><span class="line-added">359             try {</span>
<span class="line-added">360                 ImageIO.write(buffImage, &quot;png&quot;, new File(&quot;image.png&quot;));</span>
<span class="line-added">361             } catch (Exception e) {}</span>
362             throw new RuntimeException(&quot;String is not properly drawn!&quot;);
363         }
364     }
365 
366     private static BufferedImage createBufferedImage(int width, int height) {
367         BufferedImage bufffImage = new BufferedImage(width, height,
368                 BufferedImage.TYPE_INT_RGB);
369 
370         Graphics2D g = bufffImage.createGraphics();
371         g.setColor(BACKGROUND_COLOR);
372         g.fillRect(0, 0, width, height);
373         g.dispose();
374         return bufffImage;
375     }
376 }
<a name="8" id="anc8"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="8" type="hidden" />
</body>
</html>