<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames src/hotspot/share/opto/graphKit.cpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
    <script type="text/javascript" src="../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>   1 /*
   2  * Copyright (c) 2001, 2020, Oracle and/or its affiliates. All rights reserved.
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.
   8  *
   9  * This code is distributed in the hope that it will be useful, but WITHOUT
  10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  *
  23  */
  24 
  25 #include &quot;precompiled.hpp&quot;
  26 #include &quot;ci/ciUtilities.hpp&quot;
<a name="1" id="anc1"></a><span class="line-added">  27 &lt;&lt;&lt;&lt;&lt;&lt;&lt; HEAD</span>
  28 #include &quot;classfile/javaClasses.hpp&quot;
<a name="2" id="anc2"></a><span class="line-added">  29 =======</span>
<span class="line-added">  30 #include &quot;ci/ciNativeEntryPoint.hpp&quot;</span>
<span class="line-added">  31 #include &quot;ci/ciObjArray.hpp&quot;</span>
<span class="line-added">  32 #include &quot;asm/register.hpp&quot;</span>
<span class="line-added">  33 &gt;&gt;&gt;&gt;&gt;&gt;&gt; 27368a8b78142d4a66f19daaf9094a0e320d06c0</span>
  34 #include &quot;compiler/compileLog.hpp&quot;
  35 #include &quot;gc/shared/barrierSet.hpp&quot;
  36 #include &quot;gc/shared/c2/barrierSetC2.hpp&quot;
  37 #include &quot;interpreter/interpreter.hpp&quot;
  38 #include &quot;memory/resourceArea.hpp&quot;
  39 #include &quot;opto/addnode.hpp&quot;
  40 #include &quot;opto/castnode.hpp&quot;
  41 #include &quot;opto/convertnode.hpp&quot;
  42 #include &quot;opto/graphKit.hpp&quot;
  43 #include &quot;opto/idealKit.hpp&quot;
  44 #include &quot;opto/intrinsicnode.hpp&quot;
  45 #include &quot;opto/locknode.hpp&quot;
  46 #include &quot;opto/machnode.hpp&quot;
  47 #include &quot;opto/opaquenode.hpp&quot;
  48 #include &quot;opto/parse.hpp&quot;
  49 #include &quot;opto/rootnode.hpp&quot;
  50 #include &quot;opto/runtime.hpp&quot;
  51 #include &quot;opto/subtypenode.hpp&quot;
  52 #include &quot;runtime/deoptimization.hpp&quot;
  53 #include &quot;runtime/sharedRuntime.hpp&quot;
  54 #include &quot;utilities/bitMap.inline.hpp&quot;
  55 #include &quot;utilities/powerOfTwo.hpp&quot;
<a name="3" id="anc3"></a><span class="line-added">  56 #include &quot;utilities/growableArray.hpp&quot;</span>
  57 
  58 //----------------------------GraphKit-----------------------------------------
  59 // Main utility constructor.
  60 GraphKit::GraphKit(JVMState* jvms)
  61   : Phase(Phase::Parser),
  62     _env(C-&gt;env()),
  63     _gvn(*C-&gt;initial_gvn()),
  64     _barrier_set(BarrierSet::barrier_set()-&gt;barrier_set_c2())
  65 {
  66   _exceptions = jvms-&gt;map()-&gt;next_exception();
  67   if (_exceptions != NULL)  jvms-&gt;map()-&gt;set_next_exception(NULL);
  68   set_jvms(jvms);
  69 }
  70 
  71 // Private constructor for parser.
  72 GraphKit::GraphKit()
  73   : Phase(Phase::Parser),
  74     _env(C-&gt;env()),
  75     _gvn(*C-&gt;initial_gvn()),
  76     _barrier_set(BarrierSet::barrier_set()-&gt;barrier_set_c2())
  77 {
  78   _exceptions = NULL;
  79   set_map(NULL);
  80   debug_only(_sp = -99);
  81   debug_only(set_bci(-99));
  82 }
  83 
  84 
  85 
  86 //---------------------------clean_stack---------------------------------------
  87 // Clear away rubbish from the stack area of the JVM state.
  88 // This destroys any arguments that may be waiting on the stack.
  89 void GraphKit::clean_stack(int from_sp) {
  90   SafePointNode* map      = this-&gt;map();
  91   JVMState*      jvms     = this-&gt;jvms();
  92   int            stk_size = jvms-&gt;stk_size();
  93   int            stkoff   = jvms-&gt;stkoff();
  94   Node*          top      = this-&gt;top();
  95   for (int i = from_sp; i &lt; stk_size; i++) {
  96     if (map-&gt;in(stkoff + i) != top) {
  97       map-&gt;set_req(stkoff + i, top);
  98     }
  99   }
 100 }
 101 
 102 
 103 //--------------------------------sync_jvms-----------------------------------
 104 // Make sure our current jvms agrees with our parse state.
 105 JVMState* GraphKit::sync_jvms() const {
 106   JVMState* jvms = this-&gt;jvms();
 107   jvms-&gt;set_bci(bci());       // Record the new bci in the JVMState
 108   jvms-&gt;set_sp(sp());         // Record the new sp in the JVMState
 109   assert(jvms_in_sync(), &quot;jvms is now in sync&quot;);
 110   return jvms;
 111 }
 112 
 113 //--------------------------------sync_jvms_for_reexecute---------------------
 114 // Make sure our current jvms agrees with our parse state.  This version
 115 // uses the reexecute_sp for reexecuting bytecodes.
 116 JVMState* GraphKit::sync_jvms_for_reexecute() {
 117   JVMState* jvms = this-&gt;jvms();
 118   jvms-&gt;set_bci(bci());          // Record the new bci in the JVMState
 119   jvms-&gt;set_sp(reexecute_sp());  // Record the new sp in the JVMState
 120   return jvms;
 121 }
 122 
 123 #ifdef ASSERT
 124 bool GraphKit::jvms_in_sync() const {
 125   Parse* parse = is_Parse();
 126   if (parse == NULL) {
 127     if (bci() !=      jvms()-&gt;bci())          return false;
 128     if (sp()  != (int)jvms()-&gt;sp())           return false;
 129     return true;
 130   }
 131   if (jvms()-&gt;method() != parse-&gt;method())    return false;
 132   if (jvms()-&gt;bci()    != parse-&gt;bci())       return false;
 133   int jvms_sp = jvms()-&gt;sp();
 134   if (jvms_sp          != parse-&gt;sp())        return false;
 135   int jvms_depth = jvms()-&gt;depth();
 136   if (jvms_depth       != parse-&gt;depth())     return false;
 137   return true;
 138 }
 139 
 140 // Local helper checks for special internal merge points
 141 // used to accumulate and merge exception states.
 142 // They are marked by the region&#39;s in(0) edge being the map itself.
 143 // Such merge points must never &quot;escape&quot; into the parser at large,
 144 // until they have been handed to gvn.transform.
 145 static bool is_hidden_merge(Node* reg) {
 146   if (reg == NULL)  return false;
 147   if (reg-&gt;is_Phi()) {
 148     reg = reg-&gt;in(0);
 149     if (reg == NULL)  return false;
 150   }
 151   return reg-&gt;is_Region() &amp;&amp; reg-&gt;in(0) != NULL &amp;&amp; reg-&gt;in(0)-&gt;is_Root();
 152 }
 153 
 154 void GraphKit::verify_map() const {
 155   if (map() == NULL)  return;  // null map is OK
 156   assert(map()-&gt;req() &lt;= jvms()-&gt;endoff(), &quot;no extra garbage on map&quot;);
 157   assert(!map()-&gt;has_exceptions(),    &quot;call add_exception_states_from 1st&quot;);
 158   assert(!is_hidden_merge(control()), &quot;call use_exception_state, not set_map&quot;);
 159 }
 160 
 161 void GraphKit::verify_exception_state(SafePointNode* ex_map) {
 162   assert(ex_map-&gt;next_exception() == NULL, &quot;not already part of a chain&quot;);
 163   assert(has_saved_ex_oop(ex_map), &quot;every exception state has an ex_oop&quot;);
 164 }
 165 #endif
 166 
 167 //---------------------------stop_and_kill_map---------------------------------
 168 // Set _map to NULL, signalling a stop to further bytecode execution.
 169 // First smash the current map&#39;s control to a constant, to mark it dead.
 170 void GraphKit::stop_and_kill_map() {
 171   SafePointNode* dead_map = stop();
 172   if (dead_map != NULL) {
 173     dead_map-&gt;disconnect_inputs(NULL, C); // Mark the map as killed.
 174     assert(dead_map-&gt;is_killed(), &quot;must be so marked&quot;);
 175   }
 176 }
 177 
 178 
 179 //--------------------------------stopped--------------------------------------
 180 // Tell if _map is NULL, or control is top.
 181 bool GraphKit::stopped() {
 182   if (map() == NULL)           return true;
 183   else if (control() == top()) return true;
 184   else                         return false;
 185 }
 186 
 187 
 188 //-----------------------------has_ex_handler----------------------------------
 189 // Tell if this method or any caller method has exception handlers.
 190 bool GraphKit::has_ex_handler() {
 191   for (JVMState* jvmsp = jvms(); jvmsp != NULL; jvmsp = jvmsp-&gt;caller()) {
 192     if (jvmsp-&gt;has_method() &amp;&amp; jvmsp-&gt;method()-&gt;has_exception_handlers()) {
 193       return true;
 194     }
 195   }
 196   return false;
 197 }
 198 
 199 //------------------------------save_ex_oop------------------------------------
 200 // Save an exception without blowing stack contents or other JVM state.
 201 void GraphKit::set_saved_ex_oop(SafePointNode* ex_map, Node* ex_oop) {
 202   assert(!has_saved_ex_oop(ex_map), &quot;clear ex-oop before setting again&quot;);
 203   ex_map-&gt;add_req(ex_oop);
 204   debug_only(verify_exception_state(ex_map));
 205 }
 206 
 207 inline static Node* common_saved_ex_oop(SafePointNode* ex_map, bool clear_it) {
 208   assert(GraphKit::has_saved_ex_oop(ex_map), &quot;ex_oop must be there&quot;);
 209   Node* ex_oop = ex_map-&gt;in(ex_map-&gt;req()-1);
 210   if (clear_it)  ex_map-&gt;del_req(ex_map-&gt;req()-1);
 211   return ex_oop;
 212 }
 213 
 214 //-----------------------------saved_ex_oop------------------------------------
 215 // Recover a saved exception from its map.
 216 Node* GraphKit::saved_ex_oop(SafePointNode* ex_map) {
 217   return common_saved_ex_oop(ex_map, false);
 218 }
 219 
 220 //--------------------------clear_saved_ex_oop---------------------------------
 221 // Erase a previously saved exception from its map.
 222 Node* GraphKit::clear_saved_ex_oop(SafePointNode* ex_map) {
 223   return common_saved_ex_oop(ex_map, true);
 224 }
 225 
 226 #ifdef ASSERT
 227 //---------------------------has_saved_ex_oop----------------------------------
 228 // Erase a previously saved exception from its map.
 229 bool GraphKit::has_saved_ex_oop(SafePointNode* ex_map) {
 230   return ex_map-&gt;req() == ex_map-&gt;jvms()-&gt;endoff()+1;
 231 }
 232 #endif
 233 
 234 //-------------------------make_exception_state--------------------------------
 235 // Turn the current JVM state into an exception state, appending the ex_oop.
 236 SafePointNode* GraphKit::make_exception_state(Node* ex_oop) {
 237   sync_jvms();
 238   SafePointNode* ex_map = stop();  // do not manipulate this map any more
 239   set_saved_ex_oop(ex_map, ex_oop);
 240   return ex_map;
 241 }
 242 
 243 
 244 //--------------------------add_exception_state--------------------------------
 245 // Add an exception to my list of exceptions.
 246 void GraphKit::add_exception_state(SafePointNode* ex_map) {
 247   if (ex_map == NULL || ex_map-&gt;control() == top()) {
 248     return;
 249   }
 250 #ifdef ASSERT
 251   verify_exception_state(ex_map);
 252   if (has_exceptions()) {
 253     assert(ex_map-&gt;jvms()-&gt;same_calls_as(_exceptions-&gt;jvms()), &quot;all collected exceptions must come from the same place&quot;);
 254   }
 255 #endif
 256 
 257   // If there is already an exception of exactly this type, merge with it.
 258   // In particular, null-checks and other low-level exceptions common up here.
 259   Node*       ex_oop  = saved_ex_oop(ex_map);
 260   const Type* ex_type = _gvn.type(ex_oop);
 261   if (ex_oop == top()) {
 262     // No action needed.
 263     return;
 264   }
 265   assert(ex_type-&gt;isa_instptr(), &quot;exception must be an instance&quot;);
 266   for (SafePointNode* e2 = _exceptions; e2 != NULL; e2 = e2-&gt;next_exception()) {
 267     const Type* ex_type2 = _gvn.type(saved_ex_oop(e2));
 268     // We check sp also because call bytecodes can generate exceptions
 269     // both before and after arguments are popped!
 270     if (ex_type2 == ex_type
 271         &amp;&amp; e2-&gt;_jvms-&gt;sp() == ex_map-&gt;_jvms-&gt;sp()) {
 272       combine_exception_states(ex_map, e2);
 273       return;
 274     }
 275   }
 276 
 277   // No pre-existing exception of the same type.  Chain it on the list.
 278   push_exception_state(ex_map);
 279 }
 280 
 281 //-----------------------add_exception_states_from-----------------------------
 282 void GraphKit::add_exception_states_from(JVMState* jvms) {
 283   SafePointNode* ex_map = jvms-&gt;map()-&gt;next_exception();
 284   if (ex_map != NULL) {
 285     jvms-&gt;map()-&gt;set_next_exception(NULL);
 286     for (SafePointNode* next_map; ex_map != NULL; ex_map = next_map) {
 287       next_map = ex_map-&gt;next_exception();
 288       ex_map-&gt;set_next_exception(NULL);
 289       add_exception_state(ex_map);
 290     }
 291   }
 292 }
 293 
 294 //-----------------------transfer_exceptions_into_jvms-------------------------
 295 JVMState* GraphKit::transfer_exceptions_into_jvms() {
 296   if (map() == NULL) {
 297     // We need a JVMS to carry the exceptions, but the map has gone away.
 298     // Create a scratch JVMS, cloned from any of the exception states...
 299     if (has_exceptions()) {
 300       _map = _exceptions;
 301       _map = clone_map();
 302       _map-&gt;set_next_exception(NULL);
 303       clear_saved_ex_oop(_map);
 304       debug_only(verify_map());
 305     } else {
 306       // ...or created from scratch
 307       JVMState* jvms = new (C) JVMState(_method, NULL);
 308       jvms-&gt;set_bci(_bci);
 309       jvms-&gt;set_sp(_sp);
 310       jvms-&gt;set_map(new SafePointNode(TypeFunc::Parms, jvms));
 311       set_jvms(jvms);
 312       for (uint i = 0; i &lt; map()-&gt;req(); i++)  map()-&gt;init_req(i, top());
 313       set_all_memory(top());
 314       while (map()-&gt;req() &lt; jvms-&gt;endoff())  map()-&gt;add_req(top());
 315     }
 316     // (This is a kludge, in case you didn&#39;t notice.)
 317     set_control(top());
 318   }
 319   JVMState* jvms = sync_jvms();
 320   assert(!jvms-&gt;map()-&gt;has_exceptions(), &quot;no exceptions on this map yet&quot;);
 321   jvms-&gt;map()-&gt;set_next_exception(_exceptions);
 322   _exceptions = NULL;   // done with this set of exceptions
 323   return jvms;
 324 }
 325 
 326 static inline void add_n_reqs(Node* dstphi, Node* srcphi) {
 327   assert(is_hidden_merge(dstphi), &quot;must be a special merge node&quot;);
 328   assert(is_hidden_merge(srcphi), &quot;must be a special merge node&quot;);
 329   uint limit = srcphi-&gt;req();
 330   for (uint i = PhiNode::Input; i &lt; limit; i++) {
 331     dstphi-&gt;add_req(srcphi-&gt;in(i));
 332   }
 333 }
 334 static inline void add_one_req(Node* dstphi, Node* src) {
 335   assert(is_hidden_merge(dstphi), &quot;must be a special merge node&quot;);
 336   assert(!is_hidden_merge(src), &quot;must not be a special merge node&quot;);
 337   dstphi-&gt;add_req(src);
 338 }
 339 
 340 //-----------------------combine_exception_states------------------------------
 341 // This helper function combines exception states by building phis on a
 342 // specially marked state-merging region.  These regions and phis are
 343 // untransformed, and can build up gradually.  The region is marked by
 344 // having a control input of its exception map, rather than NULL.  Such
 345 // regions do not appear except in this function, and in use_exception_state.
 346 void GraphKit::combine_exception_states(SafePointNode* ex_map, SafePointNode* phi_map) {
 347   if (failing())  return;  // dying anyway...
 348   JVMState* ex_jvms = ex_map-&gt;_jvms;
 349   assert(ex_jvms-&gt;same_calls_as(phi_map-&gt;_jvms), &quot;consistent call chains&quot;);
 350   assert(ex_jvms-&gt;stkoff() == phi_map-&gt;_jvms-&gt;stkoff(), &quot;matching locals&quot;);
 351   assert(ex_jvms-&gt;sp() == phi_map-&gt;_jvms-&gt;sp(), &quot;matching stack sizes&quot;);
 352   assert(ex_jvms-&gt;monoff() == phi_map-&gt;_jvms-&gt;monoff(), &quot;matching JVMS&quot;);
 353   assert(ex_jvms-&gt;scloff() == phi_map-&gt;_jvms-&gt;scloff(), &quot;matching scalar replaced objects&quot;);
 354   assert(ex_map-&gt;req() == phi_map-&gt;req(), &quot;matching maps&quot;);
 355   uint tos = ex_jvms-&gt;stkoff() + ex_jvms-&gt;sp();
 356   Node*         hidden_merge_mark = root();
 357   Node*         region  = phi_map-&gt;control();
 358   MergeMemNode* phi_mem = phi_map-&gt;merged_memory();
 359   MergeMemNode* ex_mem  = ex_map-&gt;merged_memory();
 360   if (region-&gt;in(0) != hidden_merge_mark) {
 361     // The control input is not (yet) a specially-marked region in phi_map.
 362     // Make it so, and build some phis.
 363     region = new RegionNode(2);
 364     _gvn.set_type(region, Type::CONTROL);
 365     region-&gt;set_req(0, hidden_merge_mark);  // marks an internal ex-state
 366     region-&gt;init_req(1, phi_map-&gt;control());
 367     phi_map-&gt;set_control(region);
 368     Node* io_phi = PhiNode::make(region, phi_map-&gt;i_o(), Type::ABIO);
 369     record_for_igvn(io_phi);
 370     _gvn.set_type(io_phi, Type::ABIO);
 371     phi_map-&gt;set_i_o(io_phi);
 372     for (MergeMemStream mms(phi_mem); mms.next_non_empty(); ) {
 373       Node* m = mms.memory();
 374       Node* m_phi = PhiNode::make(region, m, Type::MEMORY, mms.adr_type(C));
 375       record_for_igvn(m_phi);
 376       _gvn.set_type(m_phi, Type::MEMORY);
 377       mms.set_memory(m_phi);
 378     }
 379   }
 380 
 381   // Either or both of phi_map and ex_map might already be converted into phis.
 382   Node* ex_control = ex_map-&gt;control();
 383   // if there is special marking on ex_map also, we add multiple edges from src
 384   bool add_multiple = (ex_control-&gt;in(0) == hidden_merge_mark);
 385   // how wide was the destination phi_map, originally?
 386   uint orig_width = region-&gt;req();
 387 
 388   if (add_multiple) {
 389     add_n_reqs(region, ex_control);
 390     add_n_reqs(phi_map-&gt;i_o(), ex_map-&gt;i_o());
 391   } else {
 392     // ex_map has no merges, so we just add single edges everywhere
 393     add_one_req(region, ex_control);
 394     add_one_req(phi_map-&gt;i_o(), ex_map-&gt;i_o());
 395   }
 396   for (MergeMemStream mms(phi_mem, ex_mem); mms.next_non_empty2(); ) {
 397     if (mms.is_empty()) {
 398       // get a copy of the base memory, and patch some inputs into it
 399       const TypePtr* adr_type = mms.adr_type(C);
 400       Node* phi = mms.force_memory()-&gt;as_Phi()-&gt;slice_memory(adr_type);
 401       assert(phi-&gt;as_Phi()-&gt;region() == mms.base_memory()-&gt;in(0), &quot;&quot;);
 402       mms.set_memory(phi);
 403       // Prepare to append interesting stuff onto the newly sliced phi:
 404       while (phi-&gt;req() &gt; orig_width)  phi-&gt;del_req(phi-&gt;req()-1);
 405     }
 406     // Append stuff from ex_map:
 407     if (add_multiple) {
 408       add_n_reqs(mms.memory(), mms.memory2());
 409     } else {
 410       add_one_req(mms.memory(), mms.memory2());
 411     }
 412   }
 413   uint limit = ex_map-&gt;req();
 414   for (uint i = TypeFunc::Parms; i &lt; limit; i++) {
 415     // Skip everything in the JVMS after tos.  (The ex_oop follows.)
 416     if (i == tos)  i = ex_jvms-&gt;monoff();
 417     Node* src = ex_map-&gt;in(i);
 418     Node* dst = phi_map-&gt;in(i);
 419     if (src != dst) {
 420       PhiNode* phi;
 421       if (dst-&gt;in(0) != region) {
 422         dst = phi = PhiNode::make(region, dst, _gvn.type(dst));
 423         record_for_igvn(phi);
 424         _gvn.set_type(phi, phi-&gt;type());
 425         phi_map-&gt;set_req(i, dst);
 426         // Prepare to append interesting stuff onto the new phi:
 427         while (dst-&gt;req() &gt; orig_width)  dst-&gt;del_req(dst-&gt;req()-1);
 428       } else {
 429         assert(dst-&gt;is_Phi(), &quot;nobody else uses a hidden region&quot;);
 430         phi = dst-&gt;as_Phi();
 431       }
 432       if (add_multiple &amp;&amp; src-&gt;in(0) == ex_control) {
 433         // Both are phis.
 434         add_n_reqs(dst, src);
 435       } else {
 436         while (dst-&gt;req() &lt; region-&gt;req())  add_one_req(dst, src);
 437       }
 438       const Type* srctype = _gvn.type(src);
 439       if (phi-&gt;type() != srctype) {
 440         const Type* dsttype = phi-&gt;type()-&gt;meet_speculative(srctype);
 441         if (phi-&gt;type() != dsttype) {
 442           phi-&gt;set_type(dsttype);
 443           _gvn.set_type(phi, dsttype);
 444         }
 445       }
 446     }
 447   }
 448   phi_map-&gt;merge_replaced_nodes_with(ex_map);
 449 }
 450 
 451 //--------------------------use_exception_state--------------------------------
 452 Node* GraphKit::use_exception_state(SafePointNode* phi_map) {
 453   if (failing()) { stop(); return top(); }
 454   Node* region = phi_map-&gt;control();
 455   Node* hidden_merge_mark = root();
 456   assert(phi_map-&gt;jvms()-&gt;map() == phi_map, &quot;sanity: 1-1 relation&quot;);
 457   Node* ex_oop = clear_saved_ex_oop(phi_map);
 458   if (region-&gt;in(0) == hidden_merge_mark) {
 459     // Special marking for internal ex-states.  Process the phis now.
 460     region-&gt;set_req(0, region);  // now it&#39;s an ordinary region
 461     set_jvms(phi_map-&gt;jvms());   // ...so now we can use it as a map
 462     // Note: Setting the jvms also sets the bci and sp.
 463     set_control(_gvn.transform(region));
 464     uint tos = jvms()-&gt;stkoff() + sp();
 465     for (uint i = 1; i &lt; tos; i++) {
 466       Node* x = phi_map-&gt;in(i);
 467       if (x-&gt;in(0) == region) {
 468         assert(x-&gt;is_Phi(), &quot;expected a special phi&quot;);
 469         phi_map-&gt;set_req(i, _gvn.transform(x));
 470       }
 471     }
 472     for (MergeMemStream mms(merged_memory()); mms.next_non_empty(); ) {
 473       Node* x = mms.memory();
 474       if (x-&gt;in(0) == region) {
 475         assert(x-&gt;is_Phi(), &quot;nobody else uses a hidden region&quot;);
 476         mms.set_memory(_gvn.transform(x));
 477       }
 478     }
 479     if (ex_oop-&gt;in(0) == region) {
 480       assert(ex_oop-&gt;is_Phi(), &quot;expected a special phi&quot;);
 481       ex_oop = _gvn.transform(ex_oop);
 482     }
 483   } else {
 484     set_jvms(phi_map-&gt;jvms());
 485   }
 486 
 487   assert(!is_hidden_merge(phi_map-&gt;control()), &quot;hidden ex. states cleared&quot;);
 488   assert(!is_hidden_merge(phi_map-&gt;i_o()), &quot;hidden ex. states cleared&quot;);
 489   return ex_oop;
 490 }
 491 
 492 //---------------------------------java_bc-------------------------------------
 493 Bytecodes::Code GraphKit::java_bc() const {
 494   ciMethod* method = this-&gt;method();
 495   int       bci    = this-&gt;bci();
 496   if (method != NULL &amp;&amp; bci != InvocationEntryBci)
 497     return method-&gt;java_code_at_bci(bci);
 498   else
 499     return Bytecodes::_illegal;
 500 }
 501 
 502 void GraphKit::uncommon_trap_if_should_post_on_exceptions(Deoptimization::DeoptReason reason,
 503                                                           bool must_throw) {
 504     // if the exception capability is set, then we will generate code
 505     // to check the JavaThread.should_post_on_exceptions flag to see
 506     // if we actually need to report exception events (for this
 507     // thread).  If we don&#39;t need to report exception events, we will
 508     // take the normal fast path provided by add_exception_events.  If
 509     // exception event reporting is enabled for this thread, we will
 510     // take the uncommon_trap in the BuildCutout below.
 511 
 512     // first must access the should_post_on_exceptions_flag in this thread&#39;s JavaThread
 513     Node* jthread = _gvn.transform(new ThreadLocalNode());
 514     Node* adr = basic_plus_adr(top(), jthread, in_bytes(JavaThread::should_post_on_exceptions_flag_offset()));
 515     Node* should_post_flag = make_load(control(), adr, TypeInt::INT, T_INT, Compile::AliasIdxRaw, MemNode::unordered);
 516 
 517     // Test the should_post_on_exceptions_flag vs. 0
 518     Node* chk = _gvn.transform( new CmpINode(should_post_flag, intcon(0)) );
 519     Node* tst = _gvn.transform( new BoolNode(chk, BoolTest::eq) );
 520 
 521     // Branch to slow_path if should_post_on_exceptions_flag was true
 522     { BuildCutout unless(this, tst, PROB_MAX);
 523       // Do not try anything fancy if we&#39;re notifying the VM on every throw.
 524       // Cf. case Bytecodes::_athrow in parse2.cpp.
 525       uncommon_trap(reason, Deoptimization::Action_none,
 526                     (ciKlass*)NULL, (char*)NULL, must_throw);
 527     }
 528 
 529 }
 530 
 531 //------------------------------builtin_throw----------------------------------
 532 void GraphKit::builtin_throw(Deoptimization::DeoptReason reason, Node* arg) {
 533   bool must_throw = true;
 534 
 535   if (env()-&gt;jvmti_can_post_on_exceptions()) {
 536     // check if we must post exception events, take uncommon trap if so
 537     uncommon_trap_if_should_post_on_exceptions(reason, must_throw);
 538     // here if should_post_on_exceptions is false
 539     // continue on with the normal codegen
 540   }
 541 
 542   // If this particular condition has not yet happened at this
 543   // bytecode, then use the uncommon trap mechanism, and allow for
 544   // a future recompilation if several traps occur here.
 545   // If the throw is hot, try to use a more complicated inline mechanism
 546   // which keeps execution inside the compiled code.
 547   bool treat_throw_as_hot = false;
 548   ciMethodData* md = method()-&gt;method_data();
 549 
 550   if (ProfileTraps) {
 551     if (too_many_traps(reason)) {
 552       treat_throw_as_hot = true;
 553     }
 554     // (If there is no MDO at all, assume it is early in
 555     // execution, and that any deopts are part of the
 556     // startup transient, and don&#39;t need to be remembered.)
 557 
 558     // Also, if there is a local exception handler, treat all throws
 559     // as hot if there has been at least one in this method.
 560     if (C-&gt;trap_count(reason) != 0
 561         &amp;&amp; method()-&gt;method_data()-&gt;trap_count(reason) != 0
 562         &amp;&amp; has_ex_handler()) {
 563         treat_throw_as_hot = true;
 564     }
 565   }
 566 
 567   // If this throw happens frequently, an uncommon trap might cause
 568   // a performance pothole.  If there is a local exception handler,
 569   // and if this particular bytecode appears to be deoptimizing often,
 570   // let us handle the throw inline, with a preconstructed instance.
 571   // Note:   If the deopt count has blown up, the uncommon trap
 572   // runtime is going to flush this nmethod, not matter what.
 573   if (treat_throw_as_hot
 574       &amp;&amp; (!StackTraceInThrowable || OmitStackTraceInFastThrow)) {
 575     // If the throw is local, we use a pre-existing instance and
 576     // punt on the backtrace.  This would lead to a missing backtrace
 577     // (a repeat of 4292742) if the backtrace object is ever asked
 578     // for its backtrace.
 579     // Fixing this remaining case of 4292742 requires some flavor of
 580     // escape analysis.  Leave that for the future.
 581     ciInstance* ex_obj = NULL;
 582     switch (reason) {
 583     case Deoptimization::Reason_null_check:
 584       ex_obj = env()-&gt;NullPointerException_instance();
 585       break;
 586     case Deoptimization::Reason_div0_check:
 587       ex_obj = env()-&gt;ArithmeticException_instance();
 588       break;
 589     case Deoptimization::Reason_range_check:
 590       ex_obj = env()-&gt;ArrayIndexOutOfBoundsException_instance();
 591       break;
 592     case Deoptimization::Reason_class_check:
 593       if (java_bc() == Bytecodes::_aastore) {
 594         ex_obj = env()-&gt;ArrayStoreException_instance();
 595       } else {
 596         ex_obj = env()-&gt;ClassCastException_instance();
 597       }
 598       break;
 599     default:
 600       break;
 601     }
 602     if (failing()) { stop(); return; }  // exception allocation might fail
 603     if (ex_obj != NULL) {
 604       // Cheat with a preallocated exception object.
 605       if (C-&gt;log() != NULL)
 606         C-&gt;log()-&gt;elem(&quot;hot_throw preallocated=&#39;1&#39; reason=&#39;%s&#39;&quot;,
 607                        Deoptimization::trap_reason_name(reason));
 608       const TypeInstPtr* ex_con  = TypeInstPtr::make(ex_obj);
 609       Node*              ex_node = _gvn.transform(ConNode::make(ex_con));
 610 
 611       // Clear the detail message of the preallocated exception object.
 612       // Weblogic sometimes mutates the detail message of exceptions
 613       // using reflection.
 614       int offset = java_lang_Throwable::get_detailMessage_offset();
 615       const TypePtr* adr_typ = ex_con-&gt;add_offset(offset);
 616 
 617       Node *adr = basic_plus_adr(ex_node, ex_node, offset);
 618       const TypeOopPtr* val_type = TypeOopPtr::make_from_klass(env()-&gt;String_klass());
 619       Node *store = access_store_at(ex_node, adr, adr_typ, null(), val_type, T_OBJECT, IN_HEAP);
 620 
 621       add_exception_state(make_exception_state(ex_node));
 622       return;
 623     }
 624   }
 625 
 626   // %%% Maybe add entry to OptoRuntime which directly throws the exc.?
 627   // It won&#39;t be much cheaper than bailing to the interp., since we&#39;ll
 628   // have to pass up all the debug-info, and the runtime will have to
 629   // create the stack trace.
 630 
 631   // Usual case:  Bail to interpreter.
 632   // Reserve the right to recompile if we haven&#39;t seen anything yet.
 633 
 634   ciMethod* m = Deoptimization::reason_is_speculate(reason) ? C-&gt;method() : NULL;
 635   Deoptimization::DeoptAction action = Deoptimization::Action_maybe_recompile;
 636   if (treat_throw_as_hot
 637       &amp;&amp; (method()-&gt;method_data()-&gt;trap_recompiled_at(bci(), m)
 638           || C-&gt;too_many_traps(reason))) {
 639     // We cannot afford to take more traps here.  Suffer in the interpreter.
 640     if (C-&gt;log() != NULL)
 641       C-&gt;log()-&gt;elem(&quot;hot_throw preallocated=&#39;0&#39; reason=&#39;%s&#39; mcount=&#39;%d&#39;&quot;,
 642                      Deoptimization::trap_reason_name(reason),
 643                      C-&gt;trap_count(reason));
 644     action = Deoptimization::Action_none;
 645   }
 646 
 647   // &quot;must_throw&quot; prunes the JVM state to include only the stack, if there
 648   // are no local exception handlers.  This should cut down on register
 649   // allocation time and code size, by drastically reducing the number
 650   // of in-edges on the call to the uncommon trap.
 651 
 652   uncommon_trap(reason, action, (ciKlass*)NULL, (char*)NULL, must_throw);
 653 }
 654 
 655 
 656 //----------------------------PreserveJVMState---------------------------------
 657 PreserveJVMState::PreserveJVMState(GraphKit* kit, bool clone_map) {
 658   debug_only(kit-&gt;verify_map());
 659   _kit    = kit;
 660   _map    = kit-&gt;map();   // preserve the map
 661   _sp     = kit-&gt;sp();
 662   kit-&gt;set_map(clone_map ? kit-&gt;clone_map() : NULL);
 663 #ifdef ASSERT
 664   _bci    = kit-&gt;bci();
 665   Parse* parser = kit-&gt;is_Parse();
 666   int block = (parser == NULL || parser-&gt;block() == NULL) ? -1 : parser-&gt;block()-&gt;rpo();
 667   _block  = block;
 668 #endif
 669 }
 670 PreserveJVMState::~PreserveJVMState() {
 671   GraphKit* kit = _kit;
 672 #ifdef ASSERT
 673   assert(kit-&gt;bci() == _bci, &quot;bci must not shift&quot;);
 674   Parse* parser = kit-&gt;is_Parse();
 675   int block = (parser == NULL || parser-&gt;block() == NULL) ? -1 : parser-&gt;block()-&gt;rpo();
 676   assert(block == _block,    &quot;block must not shift&quot;);
 677 #endif
 678   kit-&gt;set_map(_map);
 679   kit-&gt;set_sp(_sp);
 680 }
 681 
 682 
 683 //-----------------------------BuildCutout-------------------------------------
 684 BuildCutout::BuildCutout(GraphKit* kit, Node* p, float prob, float cnt)
 685   : PreserveJVMState(kit)
 686 {
 687   assert(p-&gt;is_Con() || p-&gt;is_Bool(), &quot;test must be a bool&quot;);
 688   SafePointNode* outer_map = _map;   // preserved map is caller&#39;s
 689   SafePointNode* inner_map = kit-&gt;map();
 690   IfNode* iff = kit-&gt;create_and_map_if(outer_map-&gt;control(), p, prob, cnt);
 691   outer_map-&gt;set_control(kit-&gt;gvn().transform( new IfTrueNode(iff) ));
 692   inner_map-&gt;set_control(kit-&gt;gvn().transform( new IfFalseNode(iff) ));
 693 }
 694 BuildCutout::~BuildCutout() {
 695   GraphKit* kit = _kit;
 696   assert(kit-&gt;stopped(), &quot;cutout code must stop, throw, return, etc.&quot;);
 697 }
 698 
 699 //---------------------------PreserveReexecuteState----------------------------
 700 PreserveReexecuteState::PreserveReexecuteState(GraphKit* kit) {
 701   assert(!kit-&gt;stopped(), &quot;must call stopped() before&quot;);
 702   _kit    =    kit;
 703   _sp     =    kit-&gt;sp();
 704   _reexecute = kit-&gt;jvms()-&gt;_reexecute;
 705 }
 706 PreserveReexecuteState::~PreserveReexecuteState() {
 707   if (_kit-&gt;stopped()) return;
 708   _kit-&gt;jvms()-&gt;_reexecute = _reexecute;
 709   _kit-&gt;set_sp(_sp);
 710 }
 711 
 712 //------------------------------clone_map--------------------------------------
 713 // Implementation of PreserveJVMState
 714 //
 715 // Only clone_map(...) here. If this function is only used in the
 716 // PreserveJVMState class we may want to get rid of this extra
 717 // function eventually and do it all there.
 718 
 719 SafePointNode* GraphKit::clone_map() {
 720   if (map() == NULL)  return NULL;
 721 
 722   // Clone the memory edge first
 723   Node* mem = MergeMemNode::make(map()-&gt;memory());
 724   gvn().set_type_bottom(mem);
 725 
 726   SafePointNode *clonemap = (SafePointNode*)map()-&gt;clone();
 727   JVMState* jvms = this-&gt;jvms();
 728   JVMState* clonejvms = jvms-&gt;clone_shallow(C);
 729   clonemap-&gt;set_memory(mem);
 730   clonemap-&gt;set_jvms(clonejvms);
 731   clonejvms-&gt;set_map(clonemap);
 732   record_for_igvn(clonemap);
 733   gvn().set_type_bottom(clonemap);
 734   return clonemap;
 735 }
 736 
 737 
 738 //-----------------------------set_map_clone-----------------------------------
 739 void GraphKit::set_map_clone(SafePointNode* m) {
 740   _map = m;
 741   _map = clone_map();
 742   _map-&gt;set_next_exception(NULL);
 743   debug_only(verify_map());
 744 }
 745 
 746 
 747 //----------------------------kill_dead_locals---------------------------------
 748 // Detect any locals which are known to be dead, and force them to top.
 749 void GraphKit::kill_dead_locals() {
 750   // Consult the liveness information for the locals.  If any
 751   // of them are unused, then they can be replaced by top().  This
 752   // should help register allocation time and cut down on the size
 753   // of the deoptimization information.
 754 
 755   // This call is made from many of the bytecode handling
 756   // subroutines called from the Big Switch in do_one_bytecode.
 757   // Every bytecode which might include a slow path is responsible
 758   // for killing its dead locals.  The more consistent we
 759   // are about killing deads, the fewer useless phis will be
 760   // constructed for them at various merge points.
 761 
 762   // bci can be -1 (InvocationEntryBci).  We return the entry
 763   // liveness for the method.
 764 
 765   if (method() == NULL || method()-&gt;code_size() == 0) {
 766     // We are building a graph for a call to a native method.
 767     // All locals are live.
 768     return;
 769   }
 770 
 771   ResourceMark rm;
 772 
 773   // Consult the liveness information for the locals.  If any
 774   // of them are unused, then they can be replaced by top().  This
 775   // should help register allocation time and cut down on the size
 776   // of the deoptimization information.
 777   MethodLivenessResult live_locals = method()-&gt;liveness_at_bci(bci());
 778 
 779   int len = (int)live_locals.size();
 780   assert(len &lt;= jvms()-&gt;loc_size(), &quot;too many live locals&quot;);
 781   for (int local = 0; local &lt; len; local++) {
 782     if (!live_locals.at(local)) {
 783       set_local(local, top());
 784     }
 785   }
 786 }
 787 
 788 #ifdef ASSERT
 789 //-------------------------dead_locals_are_killed------------------------------
 790 // Return true if all dead locals are set to top in the map.
 791 // Used to assert &quot;clean&quot; debug info at various points.
 792 bool GraphKit::dead_locals_are_killed() {
 793   if (method() == NULL || method()-&gt;code_size() == 0) {
 794     // No locals need to be dead, so all is as it should be.
 795     return true;
 796   }
 797 
 798   // Make sure somebody called kill_dead_locals upstream.
 799   ResourceMark rm;
 800   for (JVMState* jvms = this-&gt;jvms(); jvms != NULL; jvms = jvms-&gt;caller()) {
 801     if (jvms-&gt;loc_size() == 0)  continue;  // no locals to consult
 802     SafePointNode* map = jvms-&gt;map();
 803     ciMethod* method = jvms-&gt;method();
 804     int       bci    = jvms-&gt;bci();
 805     if (jvms == this-&gt;jvms()) {
 806       bci = this-&gt;bci();  // it might not yet be synched
 807     }
 808     MethodLivenessResult live_locals = method-&gt;liveness_at_bci(bci);
 809     int len = (int)live_locals.size();
 810     if (!live_locals.is_valid() || len == 0)
 811       // This method is trivial, or is poisoned by a breakpoint.
 812       return true;
 813     assert(len == jvms-&gt;loc_size(), &quot;live map consistent with locals map&quot;);
 814     for (int local = 0; local &lt; len; local++) {
 815       if (!live_locals.at(local) &amp;&amp; map-&gt;local(jvms, local) != top()) {
 816         if (PrintMiscellaneous &amp;&amp; (Verbose || WizardMode)) {
 817           tty-&gt;print_cr(&quot;Zombie local %d: &quot;, local);
 818           jvms-&gt;dump();
 819         }
 820         return false;
 821       }
 822     }
 823   }
 824   return true;
 825 }
 826 
 827 #endif //ASSERT
 828 
 829 // Helper function for enforcing certain bytecodes to reexecute if
 830 // deoptimization happens
 831 static bool should_reexecute_implied_by_bytecode(JVMState *jvms, bool is_anewarray) {
 832   ciMethod* cur_method = jvms-&gt;method();
 833   int       cur_bci   = jvms-&gt;bci();
 834   if (cur_method != NULL &amp;&amp; cur_bci != InvocationEntryBci) {
 835     Bytecodes::Code code = cur_method-&gt;java_code_at_bci(cur_bci);
 836     return Interpreter::bytecode_should_reexecute(code) ||
 837            (is_anewarray &amp;&amp; code == Bytecodes::_multianewarray);
 838     // Reexecute _multianewarray bytecode which was replaced with
 839     // sequence of [a]newarray. See Parse::do_multianewarray().
 840     //
 841     // Note: interpreter should not have it set since this optimization
 842     // is limited by dimensions and guarded by flag so in some cases
 843     // multianewarray() runtime calls will be generated and
 844     // the bytecode should not be reexecutes (stack will not be reset).
 845   } else
 846     return false;
 847 }
 848 
 849 // Helper function for adding JVMState and debug information to node
 850 void GraphKit::add_safepoint_edges(SafePointNode* call, bool must_throw) {
 851   // Add the safepoint edges to the call (or other safepoint).
 852 
 853   // Make sure dead locals are set to top.  This
 854   // should help register allocation time and cut down on the size
 855   // of the deoptimization information.
 856   assert(dead_locals_are_killed(), &quot;garbage in debug info before safepoint&quot;);
 857 
 858   // Walk the inline list to fill in the correct set of JVMState&#39;s
 859   // Also fill in the associated edges for each JVMState.
 860 
 861   // If the bytecode needs to be reexecuted we need to put
 862   // the arguments back on the stack.
 863   const bool should_reexecute = jvms()-&gt;should_reexecute();
 864   JVMState* youngest_jvms = should_reexecute ? sync_jvms_for_reexecute() : sync_jvms();
 865 
 866   // NOTE: set_bci (called from sync_jvms) might reset the reexecute bit to
 867   // undefined if the bci is different.  This is normal for Parse but it
 868   // should not happen for LibraryCallKit because only one bci is processed.
 869   assert(!is_LibraryCallKit() || (jvms()-&gt;should_reexecute() == should_reexecute),
 870          &quot;in LibraryCallKit the reexecute bit should not change&quot;);
 871 
 872   // If we are guaranteed to throw, we can prune everything but the
 873   // input to the current bytecode.
 874   bool can_prune_locals = false;
 875   uint stack_slots_not_pruned = 0;
 876   int inputs = 0, depth = 0;
 877   if (must_throw) {
 878     assert(method() == youngest_jvms-&gt;method(), &quot;sanity&quot;);
 879     if (compute_stack_effects(inputs, depth)) {
 880       can_prune_locals = true;
 881       stack_slots_not_pruned = inputs;
 882     }
 883   }
 884 
 885   if (env()-&gt;should_retain_local_variables()) {
 886     // At any safepoint, this method can get breakpointed, which would
 887     // then require an immediate deoptimization.
 888     can_prune_locals = false;  // do not prune locals
 889     stack_slots_not_pruned = 0;
 890   }
 891 
 892   // do not scribble on the input jvms
 893   JVMState* out_jvms = youngest_jvms-&gt;clone_deep(C);
 894   call-&gt;set_jvms(out_jvms); // Start jvms list for call node
 895 
 896   // For a known set of bytecodes, the interpreter should reexecute them if
 897   // deoptimization happens. We set the reexecute state for them here
 898   if (out_jvms-&gt;is_reexecute_undefined() &amp;&amp; //don&#39;t change if already specified
 899       should_reexecute_implied_by_bytecode(out_jvms, call-&gt;is_AllocateArray())) {
 900     out_jvms-&gt;set_should_reexecute(true); //NOTE: youngest_jvms not changed
 901   }
 902 
 903   // Presize the call:
 904   DEBUG_ONLY(uint non_debug_edges = call-&gt;req());
 905   call-&gt;add_req_batch(top(), youngest_jvms-&gt;debug_depth());
 906   assert(call-&gt;req() == non_debug_edges + youngest_jvms-&gt;debug_depth(), &quot;&quot;);
 907 
 908   // Set up edges so that the call looks like this:
 909   //  Call [state:] ctl io mem fptr retadr
 910   //       [parms:] parm0 ... parmN
 911   //       [root:]  loc0 ... locN stk0 ... stkSP mon0 obj0 ... monN objN
 912   //    [...mid:]   loc0 ... locN stk0 ... stkSP mon0 obj0 ... monN objN [...]
 913   //       [young:] loc0 ... locN stk0 ... stkSP mon0 obj0 ... monN objN
 914   // Note that caller debug info precedes callee debug info.
 915 
 916   // Fill pointer walks backwards from &quot;young:&quot; to &quot;root:&quot; in the diagram above:
 917   uint debug_ptr = call-&gt;req();
 918 
 919   // Loop over the map input edges associated with jvms, add them
 920   // to the call node, &amp; reset all offsets to match call node array.
 921   for (JVMState* in_jvms = youngest_jvms; in_jvms != NULL; ) {
 922     uint debug_end   = debug_ptr;
 923     uint debug_start = debug_ptr - in_jvms-&gt;debug_size();
 924     debug_ptr = debug_start;  // back up the ptr
 925 
 926     uint p = debug_start;  // walks forward in [debug_start, debug_end)
 927     uint j, k, l;
 928     SafePointNode* in_map = in_jvms-&gt;map();
 929     out_jvms-&gt;set_map(call);
 930 
 931     if (can_prune_locals) {
 932       assert(in_jvms-&gt;method() == out_jvms-&gt;method(), &quot;sanity&quot;);
 933       // If the current throw can reach an exception handler in this JVMS,
 934       // then we must keep everything live that can reach that handler.
 935       // As a quick and dirty approximation, we look for any handlers at all.
 936       if (in_jvms-&gt;method()-&gt;has_exception_handlers()) {
 937         can_prune_locals = false;
 938       }
 939     }
 940 
 941     // Add the Locals
 942     k = in_jvms-&gt;locoff();
 943     l = in_jvms-&gt;loc_size();
 944     out_jvms-&gt;set_locoff(p);
 945     if (!can_prune_locals) {
 946       for (j = 0; j &lt; l; j++)
 947         call-&gt;set_req(p++, in_map-&gt;in(k+j));
 948     } else {
 949       p += l;  // already set to top above by add_req_batch
 950     }
 951 
 952     // Add the Expression Stack
 953     k = in_jvms-&gt;stkoff();
 954     l = in_jvms-&gt;sp();
 955     out_jvms-&gt;set_stkoff(p);
 956     if (!can_prune_locals) {
 957       for (j = 0; j &lt; l; j++)
 958         call-&gt;set_req(p++, in_map-&gt;in(k+j));
 959     } else if (can_prune_locals &amp;&amp; stack_slots_not_pruned != 0) {
 960       // Divide stack into {S0,...,S1}, where S0 is set to top.
 961       uint s1 = stack_slots_not_pruned;
 962       stack_slots_not_pruned = 0;  // for next iteration
 963       if (s1 &gt; l)  s1 = l;
 964       uint s0 = l - s1;
 965       p += s0;  // skip the tops preinstalled by add_req_batch
 966       for (j = s0; j &lt; l; j++)
 967         call-&gt;set_req(p++, in_map-&gt;in(k+j));
 968     } else {
 969       p += l;  // already set to top above by add_req_batch
 970     }
 971 
 972     // Add the Monitors
 973     k = in_jvms-&gt;monoff();
 974     l = in_jvms-&gt;mon_size();
 975     out_jvms-&gt;set_monoff(p);
 976     for (j = 0; j &lt; l; j++)
 977       call-&gt;set_req(p++, in_map-&gt;in(k+j));
 978 
 979     // Copy any scalar object fields.
 980     k = in_jvms-&gt;scloff();
 981     l = in_jvms-&gt;scl_size();
 982     out_jvms-&gt;set_scloff(p);
 983     for (j = 0; j &lt; l; j++)
 984       call-&gt;set_req(p++, in_map-&gt;in(k+j));
 985 
 986     // Finish the new jvms.
 987     out_jvms-&gt;set_endoff(p);
 988 
 989     assert(out_jvms-&gt;endoff()     == debug_end,             &quot;fill ptr must match&quot;);
 990     assert(out_jvms-&gt;depth()      == in_jvms-&gt;depth(),      &quot;depth must match&quot;);
 991     assert(out_jvms-&gt;loc_size()   == in_jvms-&gt;loc_size(),   &quot;size must match&quot;);
 992     assert(out_jvms-&gt;mon_size()   == in_jvms-&gt;mon_size(),   &quot;size must match&quot;);
 993     assert(out_jvms-&gt;scl_size()   == in_jvms-&gt;scl_size(),   &quot;size must match&quot;);
 994     assert(out_jvms-&gt;debug_size() == in_jvms-&gt;debug_size(), &quot;size must match&quot;);
 995 
 996     // Update the two tail pointers in parallel.
 997     out_jvms = out_jvms-&gt;caller();
 998     in_jvms  = in_jvms-&gt;caller();
 999   }
1000 
1001   assert(debug_ptr == non_debug_edges, &quot;debug info must fit exactly&quot;);
1002 
1003   // Test the correctness of JVMState::debug_xxx accessors:
1004   assert(call-&gt;jvms()-&gt;debug_start() == non_debug_edges, &quot;&quot;);
1005   assert(call-&gt;jvms()-&gt;debug_end()   == call-&gt;req(), &quot;&quot;);
1006   assert(call-&gt;jvms()-&gt;debug_depth() == call-&gt;req() - non_debug_edges, &quot;&quot;);
1007 }
1008 
1009 bool GraphKit::compute_stack_effects(int&amp; inputs, int&amp; depth) {
1010   Bytecodes::Code code = java_bc();
1011   if (code == Bytecodes::_wide) {
1012     code = method()-&gt;java_code_at_bci(bci() + 1);
1013   }
1014 
1015   BasicType rtype = T_ILLEGAL;
1016   int       rsize = 0;
1017 
1018   if (code != Bytecodes::_illegal) {
1019     depth = Bytecodes::depth(code); // checkcast=0, athrow=-1
1020     rtype = Bytecodes::result_type(code); // checkcast=P, athrow=V
1021     if (rtype &lt; T_CONFLICT)
1022       rsize = type2size[rtype];
1023   }
1024 
1025   switch (code) {
1026   case Bytecodes::_illegal:
1027     return false;
1028 
1029   case Bytecodes::_ldc:
1030   case Bytecodes::_ldc_w:
1031   case Bytecodes::_ldc2_w:
1032     inputs = 0;
1033     break;
1034 
1035   case Bytecodes::_dup:         inputs = 1;  break;
1036   case Bytecodes::_dup_x1:      inputs = 2;  break;
1037   case Bytecodes::_dup_x2:      inputs = 3;  break;
1038   case Bytecodes::_dup2:        inputs = 2;  break;
1039   case Bytecodes::_dup2_x1:     inputs = 3;  break;
1040   case Bytecodes::_dup2_x2:     inputs = 4;  break;
1041   case Bytecodes::_swap:        inputs = 2;  break;
1042   case Bytecodes::_arraylength: inputs = 1;  break;
1043 
1044   case Bytecodes::_getstatic:
1045   case Bytecodes::_putstatic:
1046   case Bytecodes::_getfield:
1047   case Bytecodes::_putfield:
1048     {
1049       bool ignored_will_link;
1050       ciField* field = method()-&gt;get_field_at_bci(bci(), ignored_will_link);
1051       int      size  = field-&gt;type()-&gt;size();
1052       bool is_get = (depth &gt;= 0), is_static = (depth &amp; 1);
1053       inputs = (is_static ? 0 : 1);
1054       if (is_get) {
1055         depth = size - inputs;
1056       } else {
1057         inputs += size;        // putxxx pops the value from the stack
1058         depth = - inputs;
1059       }
1060     }
1061     break;
1062 
1063   case Bytecodes::_invokevirtual:
1064   case Bytecodes::_invokespecial:
1065   case Bytecodes::_invokestatic:
1066   case Bytecodes::_invokedynamic:
1067   case Bytecodes::_invokeinterface:
1068     {
1069       bool ignored_will_link;
1070       ciSignature* declared_signature = NULL;
1071       ciMethod* ignored_callee = method()-&gt;get_method_at_bci(bci(), ignored_will_link, &amp;declared_signature);
1072       assert(declared_signature != NULL, &quot;cannot be null&quot;);
1073       inputs   = declared_signature-&gt;arg_size_for_bc(code);
1074       int size = declared_signature-&gt;return_type()-&gt;size();
1075       depth = size - inputs;
1076     }
1077     break;
1078 
1079   case Bytecodes::_multianewarray:
1080     {
1081       ciBytecodeStream iter(method());
1082       iter.reset_to_bci(bci());
1083       iter.next();
1084       inputs = iter.get_dimensions();
1085       assert(rsize == 1, &quot;&quot;);
1086       depth = rsize - inputs;
1087     }
1088     break;
1089 
1090   case Bytecodes::_ireturn:
1091   case Bytecodes::_lreturn:
1092   case Bytecodes::_freturn:
1093   case Bytecodes::_dreturn:
1094   case Bytecodes::_areturn:
1095     assert(rsize == -depth, &quot;&quot;);
1096     inputs = rsize;
1097     break;
1098 
1099   case Bytecodes::_jsr:
1100   case Bytecodes::_jsr_w:
1101     inputs = 0;
1102     depth  = 1;                  // S.B. depth=1, not zero
1103     break;
1104 
1105   default:
1106     // bytecode produces a typed result
1107     inputs = rsize - depth;
1108     assert(inputs &gt;= 0, &quot;&quot;);
1109     break;
1110   }
1111 
1112 #ifdef ASSERT
1113   // spot check
1114   int outputs = depth + inputs;
1115   assert(outputs &gt;= 0, &quot;sanity&quot;);
1116   switch (code) {
1117   case Bytecodes::_checkcast: assert(inputs == 1 &amp;&amp; outputs == 1, &quot;&quot;); break;
1118   case Bytecodes::_athrow:    assert(inputs == 1 &amp;&amp; outputs == 0, &quot;&quot;); break;
1119   case Bytecodes::_aload_0:   assert(inputs == 0 &amp;&amp; outputs == 1, &quot;&quot;); break;
1120   case Bytecodes::_return:    assert(inputs == 0 &amp;&amp; outputs == 0, &quot;&quot;); break;
1121   case Bytecodes::_drem:      assert(inputs == 4 &amp;&amp; outputs == 2, &quot;&quot;); break;
1122   default:                    break;
1123   }
1124 #endif //ASSERT
1125 
1126   return true;
1127 }
1128 
1129 
1130 
1131 //------------------------------basic_plus_adr---------------------------------
1132 Node* GraphKit::basic_plus_adr(Node* base, Node* ptr, Node* offset) {
1133   // short-circuit a common case
1134   if (offset == intcon(0))  return ptr;
1135   return _gvn.transform( new AddPNode(base, ptr, offset) );
1136 }
1137 
1138 Node* GraphKit::ConvI2L(Node* offset) {
1139   // short-circuit a common case
1140   jint offset_con = find_int_con(offset, Type::OffsetBot);
1141   if (offset_con != Type::OffsetBot) {
1142     return longcon((jlong) offset_con);
1143   }
1144   return _gvn.transform( new ConvI2LNode(offset));
1145 }
1146 
1147 Node* GraphKit::ConvI2UL(Node* offset) {
1148   juint offset_con = (juint) find_int_con(offset, Type::OffsetBot);
1149   if (offset_con != (juint) Type::OffsetBot) {
1150     return longcon((julong) offset_con);
1151   }
1152   Node* conv = _gvn.transform( new ConvI2LNode(offset));
1153   Node* mask = _gvn.transform(ConLNode::make((julong) max_juint));
1154   return _gvn.transform( new AndLNode(conv, mask) );
1155 }
1156 
1157 Node* GraphKit::ConvL2I(Node* offset) {
1158   // short-circuit a common case
1159   jlong offset_con = find_long_con(offset, (jlong)Type::OffsetBot);
1160   if (offset_con != (jlong)Type::OffsetBot) {
1161     return intcon((int) offset_con);
1162   }
1163   return _gvn.transform( new ConvL2INode(offset));
1164 }
1165 
1166 //-------------------------load_object_klass-----------------------------------
1167 Node* GraphKit::load_object_klass(Node* obj) {
1168   // Special-case a fresh allocation to avoid building nodes:
1169   Node* akls = AllocateNode::Ideal_klass(obj, &amp;_gvn);
1170   if (akls != NULL)  return akls;
1171   Node* k_adr = basic_plus_adr(obj, oopDesc::klass_offset_in_bytes());
1172   return _gvn.transform(LoadKlassNode::make(_gvn, NULL, immutable_memory(), k_adr, TypeInstPtr::KLASS));
1173 }
1174 
1175 //-------------------------load_array_length-----------------------------------
1176 Node* GraphKit::load_array_length(Node* array) {
1177   // Special-case a fresh allocation to avoid building nodes:
1178   AllocateArrayNode* alloc = AllocateArrayNode::Ideal_array_allocation(array, &amp;_gvn);
1179   Node *alen;
1180   if (alloc == NULL) {
1181     Node *r_adr = basic_plus_adr(array, arrayOopDesc::length_offset_in_bytes());
1182     alen = _gvn.transform( new LoadRangeNode(0, immutable_memory(), r_adr, TypeInt::POS));
1183   } else {
1184     alen = alloc-&gt;Ideal_length();
1185     Node* ccast = alloc-&gt;make_ideal_length(_gvn.type(array)-&gt;is_oopptr(), &amp;_gvn);
1186     if (ccast != alen) {
1187       alen = _gvn.transform(ccast);
1188     }
1189   }
1190   return alen;
1191 }
1192 
1193 //------------------------------do_null_check----------------------------------
1194 // Helper function to do a NULL pointer check.  Returned value is
1195 // the incoming address with NULL casted away.  You are allowed to use the
1196 // not-null value only if you are control dependent on the test.
1197 #ifndef PRODUCT
1198 extern int explicit_null_checks_inserted,
1199            explicit_null_checks_elided;
1200 #endif
1201 Node* GraphKit::null_check_common(Node* value, BasicType type,
1202                                   // optional arguments for variations:
1203                                   bool assert_null,
1204                                   Node* *null_control,
1205                                   bool speculative) {
1206   assert(!assert_null || null_control == NULL, &quot;not both at once&quot;);
1207   if (stopped())  return top();
1208   NOT_PRODUCT(explicit_null_checks_inserted++);
1209 
1210   // Construct NULL check
1211   Node *chk = NULL;
1212   switch(type) {
1213     case T_LONG   : chk = new CmpLNode(value, _gvn.zerocon(T_LONG)); break;
1214     case T_INT    : chk = new CmpINode(value, _gvn.intcon(0)); break;
1215     case T_ARRAY  : // fall through
1216       type = T_OBJECT;  // simplify further tests
1217     case T_OBJECT : {
1218       const Type *t = _gvn.type( value );
1219 
1220       const TypeOopPtr* tp = t-&gt;isa_oopptr();
1221       if (tp != NULL &amp;&amp; tp-&gt;klass() != NULL &amp;&amp; !tp-&gt;klass()-&gt;is_loaded()
1222           // Only for do_null_check, not any of its siblings:
1223           &amp;&amp; !assert_null &amp;&amp; null_control == NULL) {
1224         // Usually, any field access or invocation on an unloaded oop type
1225         // will simply fail to link, since the statically linked class is
1226         // likely also to be unloaded.  However, in -Xcomp mode, sometimes
1227         // the static class is loaded but the sharper oop type is not.
1228         // Rather than checking for this obscure case in lots of places,
1229         // we simply observe that a null check on an unloaded class
1230         // will always be followed by a nonsense operation, so we
1231         // can just issue the uncommon trap here.
1232         // Our access to the unloaded class will only be correct
1233         // after it has been loaded and initialized, which requires
1234         // a trip through the interpreter.
1235 #ifndef PRODUCT
1236         if (WizardMode) { tty-&gt;print(&quot;Null check of unloaded &quot;); tp-&gt;klass()-&gt;print(); tty-&gt;cr(); }
1237 #endif
1238         uncommon_trap(Deoptimization::Reason_unloaded,
1239                       Deoptimization::Action_reinterpret,
1240                       tp-&gt;klass(), &quot;!loaded&quot;);
1241         return top();
1242       }
1243 
1244       if (assert_null) {
1245         // See if the type is contained in NULL_PTR.
1246         // If so, then the value is already null.
1247         if (t-&gt;higher_equal(TypePtr::NULL_PTR)) {
1248           NOT_PRODUCT(explicit_null_checks_elided++);
1249           return value;           // Elided null assert quickly!
1250         }
1251       } else {
1252         // See if mixing in the NULL pointer changes type.
1253         // If so, then the NULL pointer was not allowed in the original
1254         // type.  In other words, &quot;value&quot; was not-null.
1255         if (t-&gt;meet(TypePtr::NULL_PTR) != t-&gt;remove_speculative()) {
1256           // same as: if (!TypePtr::NULL_PTR-&gt;higher_equal(t)) ...
1257           NOT_PRODUCT(explicit_null_checks_elided++);
1258           return value;           // Elided null check quickly!
1259         }
1260       }
1261       chk = new CmpPNode( value, null() );
1262       break;
1263     }
1264 
1265     default:
1266       fatal(&quot;unexpected type: %s&quot;, type2name(type));
1267   }
1268   assert(chk != NULL, &quot;sanity check&quot;);
1269   chk = _gvn.transform(chk);
1270 
1271   BoolTest::mask btest = assert_null ? BoolTest::eq : BoolTest::ne;
1272   BoolNode *btst = new BoolNode( chk, btest);
1273   Node   *tst = _gvn.transform( btst );
1274 
1275   //-----------
1276   // if peephole optimizations occurred, a prior test existed.
1277   // If a prior test existed, maybe it dominates as we can avoid this test.
1278   if (tst != btst &amp;&amp; type == T_OBJECT) {
1279     // At this point we want to scan up the CFG to see if we can
1280     // find an identical test (and so avoid this test altogether).
1281     Node *cfg = control();
1282     int depth = 0;
1283     while( depth &lt; 16 ) {       // Limit search depth for speed
1284       if( cfg-&gt;Opcode() == Op_IfTrue &amp;&amp;
1285           cfg-&gt;in(0)-&gt;in(1) == tst ) {
1286         // Found prior test.  Use &quot;cast_not_null&quot; to construct an identical
1287         // CastPP (and hence hash to) as already exists for the prior test.
1288         // Return that casted value.
1289         if (assert_null) {
1290           replace_in_map(value, null());
1291           return null();  // do not issue the redundant test
1292         }
1293         Node *oldcontrol = control();
1294         set_control(cfg);
1295         Node *res = cast_not_null(value);
1296         set_control(oldcontrol);
1297         NOT_PRODUCT(explicit_null_checks_elided++);
1298         return res;
1299       }
1300       cfg = IfNode::up_one_dom(cfg, /*linear_only=*/ true);
1301       if (cfg == NULL)  break;  // Quit at region nodes
1302       depth++;
1303     }
1304   }
1305 
1306   //-----------
1307   // Branch to failure if null
1308   float ok_prob = PROB_MAX;  // a priori estimate:  nulls never happen
1309   Deoptimization::DeoptReason reason;
1310   if (assert_null) {
1311     reason = Deoptimization::reason_null_assert(speculative);
1312   } else if (type == T_OBJECT) {
1313     reason = Deoptimization::reason_null_check(speculative);
1314   } else {
1315     reason = Deoptimization::Reason_div0_check;
1316   }
1317   // %%% Since Reason_unhandled is not recorded on a per-bytecode basis,
1318   // ciMethodData::has_trap_at will return a conservative -1 if any
1319   // must-be-null assertion has failed.  This could cause performance
1320   // problems for a method after its first do_null_assert failure.
1321   // Consider using &#39;Reason_class_check&#39; instead?
1322 
1323   // To cause an implicit null check, we set the not-null probability
1324   // to the maximum (PROB_MAX).  For an explicit check the probability
1325   // is set to a smaller value.
1326   if (null_control != NULL || too_many_traps(reason)) {
1327     // probability is less likely
1328     ok_prob =  PROB_LIKELY_MAG(3);
1329   } else if (!assert_null &amp;&amp;
1330              (ImplicitNullCheckThreshold &gt; 0) &amp;&amp;
1331              method() != NULL &amp;&amp;
1332              (method()-&gt;method_data()-&gt;trap_count(reason)
1333               &gt;= (uint)ImplicitNullCheckThreshold)) {
1334     ok_prob =  PROB_LIKELY_MAG(3);
1335   }
1336 
1337   if (null_control != NULL) {
1338     IfNode* iff = create_and_map_if(control(), tst, ok_prob, COUNT_UNKNOWN);
1339     Node* null_true = _gvn.transform( new IfFalseNode(iff));
1340     set_control(      _gvn.transform( new IfTrueNode(iff)));
1341 #ifndef PRODUCT
1342     if (null_true == top()) {
1343       explicit_null_checks_elided++;
1344     }
1345 #endif
1346     (*null_control) = null_true;
1347   } else {
1348     BuildCutout unless(this, tst, ok_prob);
1349     // Check for optimizer eliding test at parse time
1350     if (stopped()) {
1351       // Failure not possible; do not bother making uncommon trap.
1352       NOT_PRODUCT(explicit_null_checks_elided++);
1353     } else if (assert_null) {
1354       uncommon_trap(reason,
1355                     Deoptimization::Action_make_not_entrant,
1356                     NULL, &quot;assert_null&quot;);
1357     } else {
1358       replace_in_map(value, zerocon(type));
1359       builtin_throw(reason);
1360     }
1361   }
1362 
1363   // Must throw exception, fall-thru not possible?
1364   if (stopped()) {
1365     return top();               // No result
1366   }
1367 
1368   if (assert_null) {
1369     // Cast obj to null on this path.
1370     replace_in_map(value, zerocon(type));
1371     return zerocon(type);
1372   }
1373 
1374   // Cast obj to not-null on this path, if there is no null_control.
1375   // (If there is a null_control, a non-null value may come back to haunt us.)
1376   if (type == T_OBJECT) {
1377     Node* cast = cast_not_null(value, false);
1378     if (null_control == NULL || (*null_control) == top())
1379       replace_in_map(value, cast);
1380     value = cast;
1381   }
1382 
1383   return value;
1384 }
1385 
1386 
1387 //------------------------------cast_not_null----------------------------------
1388 // Cast obj to not-null on this path
1389 Node* GraphKit::cast_not_null(Node* obj, bool do_replace_in_map) {
1390   const Type *t = _gvn.type(obj);
1391   const Type *t_not_null = t-&gt;join_speculative(TypePtr::NOTNULL);
1392   // Object is already not-null?
1393   if( t == t_not_null ) return obj;
1394 
1395   Node *cast = new CastPPNode(obj,t_not_null);
1396   cast-&gt;init_req(0, control());
1397   cast = _gvn.transform( cast );
1398 
1399   // Scan for instances of &#39;obj&#39; in the current JVM mapping.
1400   // These instances are known to be not-null after the test.
1401   if (do_replace_in_map)
1402     replace_in_map(obj, cast);
1403 
1404   return cast;                  // Return casted value
1405 }
1406 
1407 // Sometimes in intrinsics, we implicitly know an object is not null
1408 // (there&#39;s no actual null check) so we can cast it to not null. In
1409 // the course of optimizations, the input to the cast can become null.
1410 // In that case that data path will die and we need the control path
1411 // to become dead as well to keep the graph consistent. So we have to
1412 // add a check for null for which one branch can&#39;t be taken. It uses
1413 // an Opaque4 node that will cause the check to be removed after loop
1414 // opts so the test goes away and the compiled code doesn&#39;t execute a
1415 // useless check.
1416 Node* GraphKit::must_be_not_null(Node* value, bool do_replace_in_map) {
1417   if (!TypePtr::NULL_PTR-&gt;higher_equal(_gvn.type(value))) {
1418     return value;
1419   }
1420   Node* chk = _gvn.transform(new CmpPNode(value, null()));
1421   Node *tst = _gvn.transform(new BoolNode(chk, BoolTest::ne));
1422   Node* opaq = _gvn.transform(new Opaque4Node(C, tst, intcon(1)));
1423   IfNode *iff = new IfNode(control(), opaq, PROB_MAX, COUNT_UNKNOWN);
1424   _gvn.set_type(iff, iff-&gt;Value(&amp;_gvn));
1425   Node *if_f = _gvn.transform(new IfFalseNode(iff));
1426   Node *frame = _gvn.transform(new ParmNode(C-&gt;start(), TypeFunc::FramePtr));
1427   Node* halt = _gvn.transform(new HaltNode(if_f, frame, &quot;unexpected null in intrinsic&quot;));
1428   C-&gt;root()-&gt;add_req(halt);
1429   Node *if_t = _gvn.transform(new IfTrueNode(iff));
1430   set_control(if_t);
1431   return cast_not_null(value, do_replace_in_map);
1432 }
1433 
1434 
1435 //--------------------------replace_in_map-------------------------------------
1436 void GraphKit::replace_in_map(Node* old, Node* neww) {
1437   if (old == neww) {
1438     return;
1439   }
1440 
1441   map()-&gt;replace_edge(old, neww);
1442 
1443   // Note: This operation potentially replaces any edge
1444   // on the map.  This includes locals, stack, and monitors
1445   // of the current (innermost) JVM state.
1446 
1447   // don&#39;t let inconsistent types from profiling escape this
1448   // method
1449 
1450   const Type* told = _gvn.type(old);
1451   const Type* tnew = _gvn.type(neww);
1452 
1453   if (!tnew-&gt;higher_equal(told)) {
1454     return;
1455   }
1456 
1457   map()-&gt;record_replaced_node(old, neww);
1458 }
1459 
1460 
1461 //=============================================================================
1462 //--------------------------------memory---------------------------------------
1463 Node* GraphKit::memory(uint alias_idx) {
1464   MergeMemNode* mem = merged_memory();
1465   Node* p = mem-&gt;memory_at(alias_idx);
1466   _gvn.set_type(p, Type::MEMORY);  // must be mapped
1467   return p;
1468 }
1469 
1470 //-----------------------------reset_memory------------------------------------
1471 Node* GraphKit::reset_memory() {
1472   Node* mem = map()-&gt;memory();
1473   // do not use this node for any more parsing!
1474   debug_only( map()-&gt;set_memory((Node*)NULL) );
1475   return _gvn.transform( mem );
1476 }
1477 
1478 //------------------------------set_all_memory---------------------------------
1479 void GraphKit::set_all_memory(Node* newmem) {
1480   Node* mergemem = MergeMemNode::make(newmem);
1481   gvn().set_type_bottom(mergemem);
1482   map()-&gt;set_memory(mergemem);
1483 }
1484 
1485 //------------------------------set_all_memory_call----------------------------
1486 void GraphKit::set_all_memory_call(Node* call, bool separate_io_proj) {
1487   Node* newmem = _gvn.transform( new ProjNode(call, TypeFunc::Memory, separate_io_proj) );
1488   set_all_memory(newmem);
1489 }
1490 
1491 //=============================================================================
1492 //
1493 // parser factory methods for MemNodes
1494 //
1495 // These are layered on top of the factory methods in LoadNode and StoreNode,
1496 // and integrate with the parser&#39;s memory state and _gvn engine.
1497 //
1498 
1499 // factory methods in &quot;int adr_idx&quot;
1500 Node* GraphKit::make_load(Node* ctl, Node* adr, const Type* t, BasicType bt,
1501                           int adr_idx,
1502                           MemNode::MemOrd mo,
1503                           LoadNode::ControlDependency control_dependency,
1504                           bool require_atomic_access,
1505                           bool unaligned,
1506                           bool mismatched,
1507                           bool unsafe,
1508                           uint8_t barrier_data) {
1509   assert(adr_idx != Compile::AliasIdxTop, &quot;use other make_load factory&quot; );
1510   const TypePtr* adr_type = NULL; // debug-mode-only argument
1511   debug_only(adr_type = C-&gt;get_adr_type(adr_idx));
1512   Node* mem = memory(adr_idx);
1513   Node* ld;
1514   if (require_atomic_access &amp;&amp; bt == T_LONG) {
1515     ld = LoadLNode::make_atomic(ctl, mem, adr, adr_type, t, mo, control_dependency, unaligned, mismatched, unsafe, barrier_data);
1516   } else if (require_atomic_access &amp;&amp; bt == T_DOUBLE) {
1517     ld = LoadDNode::make_atomic(ctl, mem, adr, adr_type, t, mo, control_dependency, unaligned, mismatched, unsafe, barrier_data);
1518   } else {
1519     ld = LoadNode::make(_gvn, ctl, mem, adr, adr_type, t, bt, mo, control_dependency, unaligned, mismatched, unsafe, barrier_data);
1520   }
1521   ld = _gvn.transform(ld);
1522   if (((bt == T_OBJECT) &amp;&amp; C-&gt;do_escape_analysis()) || C-&gt;eliminate_boxing()) {
1523     // Improve graph before escape analysis and boxing elimination.
1524     record_for_igvn(ld);
1525   }
1526   return ld;
1527 }
1528 
1529 Node* GraphKit::store_to_memory(Node* ctl, Node* adr, Node *val, BasicType bt,
1530                                 int adr_idx,
1531                                 MemNode::MemOrd mo,
1532                                 bool require_atomic_access,
1533                                 bool unaligned,
1534                                 bool mismatched,
1535                                 bool unsafe) {
1536   assert(adr_idx != Compile::AliasIdxTop, &quot;use other store_to_memory factory&quot; );
1537   const TypePtr* adr_type = NULL;
1538   debug_only(adr_type = C-&gt;get_adr_type(adr_idx));
1539   Node *mem = memory(adr_idx);
1540   Node* st;
1541   if (require_atomic_access &amp;&amp; bt == T_LONG) {
1542     st = StoreLNode::make_atomic(ctl, mem, adr, adr_type, val, mo);
1543   } else if (require_atomic_access &amp;&amp; bt == T_DOUBLE) {
1544     st = StoreDNode::make_atomic(ctl, mem, adr, adr_type, val, mo);
1545   } else {
1546     st = StoreNode::make(_gvn, ctl, mem, adr, adr_type, val, bt, mo);
1547   }
1548   if (unaligned) {
1549     st-&gt;as_Store()-&gt;set_unaligned_access();
1550   }
1551   if (mismatched) {
1552     st-&gt;as_Store()-&gt;set_mismatched_access();
1553   }
1554   if (unsafe) {
1555     st-&gt;as_Store()-&gt;set_unsafe_access();
1556   }
1557   st = _gvn.transform(st);
1558   set_memory(st, adr_idx);
1559   // Back-to-back stores can only remove intermediate store with DU info
1560   // so push on worklist for optimizer.
1561   if (mem-&gt;req() &gt; MemNode::Address &amp;&amp; adr == mem-&gt;in(MemNode::Address))
1562     record_for_igvn(st);
1563 
1564   return st;
1565 }
1566 
1567 Node* GraphKit::access_store_at(Node* obj,
1568                                 Node* adr,
1569                                 const TypePtr* adr_type,
1570                                 Node* val,
1571                                 const Type* val_type,
1572                                 BasicType bt,
1573                                 DecoratorSet decorators) {
1574   // Transformation of a value which could be NULL pointer (CastPP #NULL)
1575   // could be delayed during Parse (for example, in adjust_map_after_if()).
1576   // Execute transformation here to avoid barrier generation in such case.
1577   if (_gvn.type(val) == TypePtr::NULL_PTR) {
1578     val = _gvn.makecon(TypePtr::NULL_PTR);
1579   }
1580 
1581   if (stopped()) {
1582     return top(); // Dead path ?
1583   }
1584 
1585   assert(val != NULL, &quot;not dead path&quot;);
1586 
1587   C2AccessValuePtr addr(adr, adr_type);
1588   C2AccessValue value(val, val_type);
1589   C2ParseAccess access(this, decorators | C2_WRITE_ACCESS, bt, obj, addr);
1590   if (access.is_raw()) {
1591     return _barrier_set-&gt;BarrierSetC2::store_at(access, value);
1592   } else {
1593     return _barrier_set-&gt;store_at(access, value);
1594   }
1595 }
1596 
1597 Node* GraphKit::access_load_at(Node* obj,   // containing obj
1598                                Node* adr,   // actual adress to store val at
1599                                const TypePtr* adr_type,
1600                                const Type* val_type,
1601                                BasicType bt,
1602                                DecoratorSet decorators) {
1603   if (stopped()) {
1604     return top(); // Dead path ?
1605   }
1606 
1607   C2AccessValuePtr addr(adr, adr_type);
1608   C2ParseAccess access(this, decorators | C2_READ_ACCESS, bt, obj, addr);
1609   if (access.is_raw()) {
1610     return _barrier_set-&gt;BarrierSetC2::load_at(access, val_type);
1611   } else {
1612     return _barrier_set-&gt;load_at(access, val_type);
1613   }
1614 }
1615 
1616 Node* GraphKit::access_load(Node* adr,   // actual adress to load val at
1617                             const Type* val_type,
1618                             BasicType bt,
1619                             DecoratorSet decorators) {
1620   if (stopped()) {
1621     return top(); // Dead path ?
1622   }
1623 
1624   C2AccessValuePtr addr(adr, NULL);
1625   C2ParseAccess access(this, decorators | C2_READ_ACCESS, bt, NULL, addr);
1626   if (access.is_raw()) {
1627     return _barrier_set-&gt;BarrierSetC2::load_at(access, val_type);
1628   } else {
1629     return _barrier_set-&gt;load_at(access, val_type);
1630   }
1631 }
1632 
1633 Node* GraphKit::access_atomic_cmpxchg_val_at(Node* obj,
1634                                              Node* adr,
1635                                              const TypePtr* adr_type,
1636                                              int alias_idx,
1637                                              Node* expected_val,
1638                                              Node* new_val,
1639                                              const Type* value_type,
1640                                              BasicType bt,
1641                                              DecoratorSet decorators) {
1642   C2AccessValuePtr addr(adr, adr_type);
1643   C2AtomicParseAccess access(this, decorators | C2_READ_ACCESS | C2_WRITE_ACCESS,
1644                         bt, obj, addr, alias_idx);
1645   if (access.is_raw()) {
1646     return _barrier_set-&gt;BarrierSetC2::atomic_cmpxchg_val_at(access, expected_val, new_val, value_type);
1647   } else {
1648     return _barrier_set-&gt;atomic_cmpxchg_val_at(access, expected_val, new_val, value_type);
1649   }
1650 }
1651 
1652 Node* GraphKit::access_atomic_cmpxchg_bool_at(Node* obj,
1653                                               Node* adr,
1654                                               const TypePtr* adr_type,
1655                                               int alias_idx,
1656                                               Node* expected_val,
1657                                               Node* new_val,
1658                                               const Type* value_type,
1659                                               BasicType bt,
1660                                               DecoratorSet decorators) {
1661   C2AccessValuePtr addr(adr, adr_type);
1662   C2AtomicParseAccess access(this, decorators | C2_READ_ACCESS | C2_WRITE_ACCESS,
1663                         bt, obj, addr, alias_idx);
1664   if (access.is_raw()) {
1665     return _barrier_set-&gt;BarrierSetC2::atomic_cmpxchg_bool_at(access, expected_val, new_val, value_type);
1666   } else {
1667     return _barrier_set-&gt;atomic_cmpxchg_bool_at(access, expected_val, new_val, value_type);
1668   }
1669 }
1670 
1671 Node* GraphKit::access_atomic_xchg_at(Node* obj,
1672                                       Node* adr,
1673                                       const TypePtr* adr_type,
1674                                       int alias_idx,
1675                                       Node* new_val,
1676                                       const Type* value_type,
1677                                       BasicType bt,
1678                                       DecoratorSet decorators) {
1679   C2AccessValuePtr addr(adr, adr_type);
1680   C2AtomicParseAccess access(this, decorators | C2_READ_ACCESS | C2_WRITE_ACCESS,
1681                         bt, obj, addr, alias_idx);
1682   if (access.is_raw()) {
1683     return _barrier_set-&gt;BarrierSetC2::atomic_xchg_at(access, new_val, value_type);
1684   } else {
1685     return _barrier_set-&gt;atomic_xchg_at(access, new_val, value_type);
1686   }
1687 }
1688 
1689 Node* GraphKit::access_atomic_add_at(Node* obj,
1690                                      Node* adr,
1691                                      const TypePtr* adr_type,
1692                                      int alias_idx,
1693                                      Node* new_val,
1694                                      const Type* value_type,
1695                                      BasicType bt,
1696                                      DecoratorSet decorators) {
1697   C2AccessValuePtr addr(adr, adr_type);
1698   C2AtomicParseAccess access(this, decorators | C2_READ_ACCESS | C2_WRITE_ACCESS, bt, obj, addr, alias_idx);
1699   if (access.is_raw()) {
1700     return _barrier_set-&gt;BarrierSetC2::atomic_add_at(access, new_val, value_type);
1701   } else {
1702     return _barrier_set-&gt;atomic_add_at(access, new_val, value_type);
1703   }
1704 }
1705 
1706 void GraphKit::access_clone(Node* src, Node* dst, Node* size, bool is_array) {
1707   return _barrier_set-&gt;clone(this, src, dst, size, is_array);
1708 }
1709 
1710 //-------------------------array_element_address-------------------------
1711 Node* GraphKit::array_element_address(Node* ary, Node* idx, BasicType elembt,
1712                                       const TypeInt* sizetype, Node* ctrl) {
1713   uint shift  = exact_log2(type2aelembytes(elembt));
1714   uint header = arrayOopDesc::base_offset_in_bytes(elembt);
1715 
1716   // short-circuit a common case (saves lots of confusing waste motion)
1717   jint idx_con = find_int_con(idx, -1);
1718   if (idx_con &gt;= 0) {
1719     intptr_t offset = header + ((intptr_t)idx_con &lt;&lt; shift);
1720     return basic_plus_adr(ary, offset);
1721   }
1722 
1723   // must be correct type for alignment purposes
1724   Node* base  = basic_plus_adr(ary, header);
1725   idx = Compile::conv_I2X_index(&amp;_gvn, idx, sizetype, ctrl);
1726   Node* scale = _gvn.transform( new LShiftXNode(idx, intcon(shift)) );
1727   return basic_plus_adr(ary, base, scale);
1728 }
1729 
1730 //-------------------------load_array_element-------------------------
1731 Node* GraphKit::load_array_element(Node* ctl, Node* ary, Node* idx, const TypeAryPtr* arytype) {
1732   const Type* elemtype = arytype-&gt;elem();
1733   BasicType elembt = elemtype-&gt;array_element_basic_type();
1734   Node* adr = array_element_address(ary, idx, elembt, arytype-&gt;size());
1735   if (elembt == T_NARROWOOP) {
1736     elembt = T_OBJECT; // To satisfy switch in LoadNode::make()
1737   }
1738   Node* ld = make_load(ctl, adr, elemtype, elembt, arytype, MemNode::unordered);
1739   return ld;
1740 }
1741 
1742 //-------------------------set_arguments_for_java_call-------------------------
1743 // Arguments (pre-popped from the stack) are taken from the JVMS.
1744 void GraphKit::set_arguments_for_java_call(CallJavaNode* call) {
1745   // Add the call arguments:
1746   uint nargs = call-&gt;method()-&gt;arg_size();
1747   for (uint i = 0; i &lt; nargs; i++) {
1748     Node* arg = argument(i);
1749     call-&gt;init_req(i + TypeFunc::Parms, arg);
1750   }
1751 }
1752 
1753 //---------------------------set_edges_for_java_call---------------------------
1754 // Connect a newly created call into the current JVMS.
1755 // A return value node (if any) is returned from set_edges_for_java_call.
1756 void GraphKit::set_edges_for_java_call(CallJavaNode* call, bool must_throw, bool separate_io_proj) {
1757 
1758   // Add the predefined inputs:
1759   call-&gt;init_req( TypeFunc::Control, control() );
1760   call-&gt;init_req( TypeFunc::I_O    , i_o() );
1761   call-&gt;init_req( TypeFunc::Memory , reset_memory() );
1762   call-&gt;init_req( TypeFunc::FramePtr, frameptr() );
1763   call-&gt;init_req( TypeFunc::ReturnAdr, top() );
1764 
1765   add_safepoint_edges(call, must_throw);
1766 
1767   Node* xcall = _gvn.transform(call);
1768 
1769   if (xcall == top()) {
1770     set_control(top());
1771     return;
1772   }
1773   assert(xcall == call, &quot;call identity is stable&quot;);
1774 
1775   // Re-use the current map to produce the result.
1776 
1777   set_control(_gvn.transform(new ProjNode(call, TypeFunc::Control)));
1778   set_i_o(    _gvn.transform(new ProjNode(call, TypeFunc::I_O    , separate_io_proj)));
1779   set_all_memory_call(xcall, separate_io_proj);
1780 
1781   //return xcall;   // no need, caller already has it
1782 }
1783 
1784 Node* GraphKit::set_results_for_java_call(CallJavaNode* call, bool separate_io_proj, bool deoptimize) {
1785   if (stopped())  return top();  // maybe the call folded up?
1786 
1787   // Capture the return value, if any.
1788   Node* ret;
1789   if (call-&gt;method() == NULL ||
1790       call-&gt;method()-&gt;return_type()-&gt;basic_type() == T_VOID)
1791         ret = top();
1792   else  ret = _gvn.transform(new ProjNode(call, TypeFunc::Parms));
1793 
1794   // Note:  Since any out-of-line call can produce an exception,
1795   // we always insert an I_O projection from the call into the result.
1796 
1797   make_slow_call_ex(call, env()-&gt;Throwable_klass(), separate_io_proj, deoptimize);
1798 
1799   if (separate_io_proj) {
1800     // The caller requested separate projections be used by the fall
1801     // through and exceptional paths, so replace the projections for
1802     // the fall through path.
1803     set_i_o(_gvn.transform( new ProjNode(call, TypeFunc::I_O) ));
1804     set_all_memory(_gvn.transform( new ProjNode(call, TypeFunc::Memory) ));
1805   }
1806   return ret;
1807 }
1808 
1809 //--------------------set_predefined_input_for_runtime_call--------------------
1810 // Reading and setting the memory state is way conservative here.
1811 // The real problem is that I am not doing real Type analysis on memory,
1812 // so I cannot distinguish card mark stores from other stores.  Across a GC
1813 // point the Store Barrier and the card mark memory has to agree.  I cannot
1814 // have a card mark store and its barrier split across the GC point from
1815 // either above or below.  Here I get that to happen by reading ALL of memory.
1816 // A better answer would be to separate out card marks from other memory.
1817 // For now, return the input memory state, so that it can be reused
1818 // after the call, if this call has restricted memory effects.
1819 Node* GraphKit::set_predefined_input_for_runtime_call(SafePointNode* call, Node* narrow_mem) {
1820   // Set fixed predefined input arguments
1821   Node* memory = reset_memory();
1822   Node* m = narrow_mem == NULL ? memory : narrow_mem;
1823   call-&gt;init_req( TypeFunc::Control,   control()  );
1824   call-&gt;init_req( TypeFunc::I_O,       top()      ); // does no i/o
1825   call-&gt;init_req( TypeFunc::Memory,    m          ); // may gc ptrs
1826   call-&gt;init_req( TypeFunc::FramePtr,  frameptr() );
1827   call-&gt;init_req( TypeFunc::ReturnAdr, top()      );
1828   return memory;
1829 }
1830 
1831 //-------------------set_predefined_output_for_runtime_call--------------------
1832 // Set control and memory (not i_o) from the call.
1833 // If keep_mem is not NULL, use it for the output state,
1834 // except for the RawPtr output of the call, if hook_mem is TypeRawPtr::BOTTOM.
1835 // If hook_mem is NULL, this call produces no memory effects at all.
1836 // If hook_mem is a Java-visible memory slice (such as arraycopy operands),
1837 // then only that memory slice is taken from the call.
1838 // In the last case, we must put an appropriate memory barrier before
1839 // the call, so as to create the correct anti-dependencies on loads
1840 // preceding the call.
1841 void GraphKit::set_predefined_output_for_runtime_call(Node* call,
1842                                                       Node* keep_mem,
1843                                                       const TypePtr* hook_mem) {
1844   // no i/o
1845   set_control(_gvn.transform( new ProjNode(call,TypeFunc::Control) ));
1846   if (keep_mem) {
1847     // First clone the existing memory state
1848     set_all_memory(keep_mem);
1849     if (hook_mem != NULL) {
1850       // Make memory for the call
1851       Node* mem = _gvn.transform( new ProjNode(call, TypeFunc::Memory) );
1852       // Set the RawPtr memory state only.  This covers all the heap top/GC stuff
1853       // We also use hook_mem to extract specific effects from arraycopy stubs.
1854       set_memory(mem, hook_mem);
1855     }
1856     // ...else the call has NO memory effects.
1857 
1858     // Make sure the call advertises its memory effects precisely.
1859     // This lets us build accurate anti-dependences in gcm.cpp.
1860     assert(C-&gt;alias_type(call-&gt;adr_type()) == C-&gt;alias_type(hook_mem),
1861            &quot;call node must be constructed correctly&quot;);
1862   } else {
1863     assert(hook_mem == NULL, &quot;&quot;);
1864     // This is not a &quot;slow path&quot; call; all memory comes from the call.
1865     set_all_memory_call(call);
1866   }
1867 }
1868 
1869 // Keep track of MergeMems feeding into other MergeMems
1870 static void add_mergemem_users_to_worklist(Unique_Node_List&amp; wl, Node* mem) {
1871   if (!mem-&gt;is_MergeMem()) {
1872     return;
1873   }
1874   for (SimpleDUIterator i(mem); i.has_next(); i.next()) {
1875     Node* use = i.get();
1876     if (use-&gt;is_MergeMem()) {
1877       wl.push(use);
1878     }
1879   }
1880 }
1881 
1882 // Replace the call with the current state of the kit.
1883 void GraphKit::replace_call(CallNode* call, Node* result, bool do_replaced_nodes) {
1884   JVMState* ejvms = NULL;
1885   if (has_exceptions()) {
1886     ejvms = transfer_exceptions_into_jvms();
1887   }
1888 
1889   ReplacedNodes replaced_nodes = map()-&gt;replaced_nodes();
1890   ReplacedNodes replaced_nodes_exception;
1891   Node* ex_ctl = top();
1892 
1893   SafePointNode* final_state = stop();
1894 
1895   // Find all the needed outputs of this call
1896   CallProjections callprojs;
1897   call-&gt;extract_projections(&amp;callprojs, true);
1898 
1899   Unique_Node_List wl;
1900   Node* init_mem = call-&gt;in(TypeFunc::Memory);
1901   Node* final_mem = final_state-&gt;in(TypeFunc::Memory);
1902   Node* final_ctl = final_state-&gt;in(TypeFunc::Control);
1903   Node* final_io = final_state-&gt;in(TypeFunc::I_O);
1904 
1905   // Replace all the old call edges with the edges from the inlining result
1906   if (callprojs.fallthrough_catchproj != NULL) {
1907     C-&gt;gvn_replace_by(callprojs.fallthrough_catchproj, final_ctl);
1908   }
1909   if (callprojs.fallthrough_memproj != NULL) {
1910     if (final_mem-&gt;is_MergeMem()) {
1911       // Parser&#39;s exits MergeMem was not transformed but may be optimized
1912       final_mem = _gvn.transform(final_mem);
1913     }
1914     C-&gt;gvn_replace_by(callprojs.fallthrough_memproj,   final_mem);
1915     add_mergemem_users_to_worklist(wl, final_mem);
1916   }
1917   if (callprojs.fallthrough_ioproj != NULL) {
1918     C-&gt;gvn_replace_by(callprojs.fallthrough_ioproj,    final_io);
1919   }
1920 
1921   // Replace the result with the new result if it exists and is used
1922   if (callprojs.resproj != NULL &amp;&amp; result != NULL) {
1923     C-&gt;gvn_replace_by(callprojs.resproj, result);
1924   }
1925 
1926   if (ejvms == NULL) {
1927     // No exception edges to simply kill off those paths
1928     if (callprojs.catchall_catchproj != NULL) {
1929       C-&gt;gvn_replace_by(callprojs.catchall_catchproj, C-&gt;top());
1930     }
1931     if (callprojs.catchall_memproj != NULL) {
1932       C-&gt;gvn_replace_by(callprojs.catchall_memproj,   C-&gt;top());
1933     }
1934     if (callprojs.catchall_ioproj != NULL) {
1935       C-&gt;gvn_replace_by(callprojs.catchall_ioproj,    C-&gt;top());
1936     }
1937     // Replace the old exception object with top
1938     if (callprojs.exobj != NULL) {
1939       C-&gt;gvn_replace_by(callprojs.exobj, C-&gt;top());
1940     }
1941   } else {
1942     GraphKit ekit(ejvms);
1943 
1944     // Load my combined exception state into the kit, with all phis transformed:
1945     SafePointNode* ex_map = ekit.combine_and_pop_all_exception_states();
1946     replaced_nodes_exception = ex_map-&gt;replaced_nodes();
1947 
1948     Node* ex_oop = ekit.use_exception_state(ex_map);
1949 
1950     if (callprojs.catchall_catchproj != NULL) {
1951       C-&gt;gvn_replace_by(callprojs.catchall_catchproj, ekit.control());
1952       ex_ctl = ekit.control();
1953     }
1954     if (callprojs.catchall_memproj != NULL) {
1955       Node* ex_mem = ekit.reset_memory();
1956       C-&gt;gvn_replace_by(callprojs.catchall_memproj,   ex_mem);
1957       add_mergemem_users_to_worklist(wl, ex_mem);
1958     }
1959     if (callprojs.catchall_ioproj != NULL) {
1960       C-&gt;gvn_replace_by(callprojs.catchall_ioproj,    ekit.i_o());
1961     }
1962 
1963     // Replace the old exception object with the newly created one
1964     if (callprojs.exobj != NULL) {
1965       C-&gt;gvn_replace_by(callprojs.exobj, ex_oop);
1966     }
1967   }
1968 
1969   // Disconnect the call from the graph
1970   call-&gt;disconnect_inputs(NULL, C);
1971   C-&gt;gvn_replace_by(call, C-&gt;top());
1972 
1973   // Clean up any MergeMems that feed other MergeMems since the
1974   // optimizer doesn&#39;t like that.
1975   while (wl.size() &gt; 0) {
1976     _gvn.transform(wl.pop());
1977   }
1978 
1979   if (callprojs.fallthrough_catchproj != NULL &amp;&amp; !final_ctl-&gt;is_top() &amp;&amp; do_replaced_nodes) {
1980     replaced_nodes.apply(C, final_ctl);
1981   }
1982   if (!ex_ctl-&gt;is_top() &amp;&amp; do_replaced_nodes) {
1983     replaced_nodes_exception.apply(C, ex_ctl);
1984   }
1985 }
1986 
1987 
1988 //------------------------------increment_counter------------------------------
1989 // for statistics: increment a VM counter by 1
1990 
1991 void GraphKit::increment_counter(address counter_addr) {
1992   Node* adr1 = makecon(TypeRawPtr::make(counter_addr));
1993   increment_counter(adr1);
1994 }
1995 
1996 void GraphKit::increment_counter(Node* counter_addr) {
1997   int adr_type = Compile::AliasIdxRaw;
1998   Node* ctrl = control();
1999   Node* cnt  = make_load(ctrl, counter_addr, TypeInt::INT, T_INT, adr_type, MemNode::unordered);
2000   Node* incr = _gvn.transform(new AddINode(cnt, _gvn.intcon(1)));
2001   store_to_memory(ctrl, counter_addr, incr, T_INT, adr_type, MemNode::unordered);
2002 }
2003 
2004 
2005 //------------------------------uncommon_trap----------------------------------
2006 // Bail out to the interpreter in mid-method.  Implemented by calling the
2007 // uncommon_trap blob.  This helper function inserts a runtime call with the
2008 // right debug info.
2009 void GraphKit::uncommon_trap(int trap_request,
2010                              ciKlass* klass, const char* comment,
2011                              bool must_throw,
2012                              bool keep_exact_action) {
2013   if (failing())  stop();
2014   if (stopped())  return; // trap reachable?
2015 
2016   // Note:  If ProfileTraps is true, and if a deopt. actually
2017   // occurs here, the runtime will make sure an MDO exists.  There is
2018   // no need to call method()-&gt;ensure_method_data() at this point.
2019 
2020   // Set the stack pointer to the right value for reexecution:
2021   set_sp(reexecute_sp());
2022 
2023 #ifdef ASSERT
2024   if (!must_throw) {
2025     // Make sure the stack has at least enough depth to execute
2026     // the current bytecode.
2027     int inputs, ignored_depth;
2028     if (compute_stack_effects(inputs, ignored_depth)) {
2029       assert(sp() &gt;= inputs, &quot;must have enough JVMS stack to execute %s: sp=%d, inputs=%d&quot;,
2030              Bytecodes::name(java_bc()), sp(), inputs);
2031     }
2032   }
2033 #endif
2034 
2035   Deoptimization::DeoptReason reason = Deoptimization::trap_request_reason(trap_request);
2036   Deoptimization::DeoptAction action = Deoptimization::trap_request_action(trap_request);
2037 
2038   switch (action) {
2039   case Deoptimization::Action_maybe_recompile:
2040   case Deoptimization::Action_reinterpret:
2041     // Temporary fix for 6529811 to allow virtual calls to be sure they
2042     // get the chance to go from mono-&gt;bi-&gt;mega
2043     if (!keep_exact_action &amp;&amp;
2044         Deoptimization::trap_request_index(trap_request) &lt; 0 &amp;&amp;
2045         too_many_recompiles(reason)) {
2046       // This BCI is causing too many recompilations.
2047       if (C-&gt;log() != NULL) {
2048         C-&gt;log()-&gt;elem(&quot;observe that=&#39;trap_action_change&#39; reason=&#39;%s&#39; from=&#39;%s&#39; to=&#39;none&#39;&quot;,
2049                 Deoptimization::trap_reason_name(reason),
2050                 Deoptimization::trap_action_name(action));
2051       }
2052       action = Deoptimization::Action_none;
2053       trap_request = Deoptimization::make_trap_request(reason, action);
2054     } else {
2055       C-&gt;set_trap_can_recompile(true);
2056     }
2057     break;
2058   case Deoptimization::Action_make_not_entrant:
2059     C-&gt;set_trap_can_recompile(true);
2060     break;
2061   case Deoptimization::Action_none:
2062   case Deoptimization::Action_make_not_compilable:
2063     break;
2064   default:
2065 #ifdef ASSERT
2066     fatal(&quot;unknown action %d: %s&quot;, action, Deoptimization::trap_action_name(action));
2067 #endif
2068     break;
2069   }
2070 
2071   if (TraceOptoParse) {
2072     char buf[100];
2073     tty-&gt;print_cr(&quot;Uncommon trap %s at bci:%d&quot;,
2074                   Deoptimization::format_trap_request(buf, sizeof(buf),
2075                                                       trap_request), bci());
2076   }
2077 
2078   CompileLog* log = C-&gt;log();
2079   if (log != NULL) {
2080     int kid = (klass == NULL)? -1: log-&gt;identify(klass);
2081     log-&gt;begin_elem(&quot;uncommon_trap bci=&#39;%d&#39;&quot;, bci());
2082     char buf[100];
2083     log-&gt;print(&quot; %s&quot;, Deoptimization::format_trap_request(buf, sizeof(buf),
2084                                                           trap_request));
2085     if (kid &gt;= 0)         log-&gt;print(&quot; klass=&#39;%d&#39;&quot;, kid);
2086     if (comment != NULL)  log-&gt;print(&quot; comment=&#39;%s&#39;&quot;, comment);
2087     log-&gt;end_elem();
2088   }
2089 
2090   // Make sure any guarding test views this path as very unlikely
2091   Node *i0 = control()-&gt;in(0);
2092   if (i0 != NULL &amp;&amp; i0-&gt;is_If()) {        // Found a guarding if test?
2093     IfNode *iff = i0-&gt;as_If();
2094     float f = iff-&gt;_prob;   // Get prob
2095     if (control()-&gt;Opcode() == Op_IfTrue) {
2096       if (f &gt; PROB_UNLIKELY_MAG(4))
2097         iff-&gt;_prob = PROB_MIN;
2098     } else {
2099       if (f &lt; PROB_LIKELY_MAG(4))
2100         iff-&gt;_prob = PROB_MAX;
2101     }
2102   }
2103 
2104   // Clear out dead values from the debug info.
2105   kill_dead_locals();
2106 
2107   // Now insert the uncommon trap subroutine call
2108   address call_addr = SharedRuntime::uncommon_trap_blob()-&gt;entry_point();
2109   const TypePtr* no_memory_effects = NULL;
2110   // Pass the index of the class to be loaded
2111   Node* call = make_runtime_call(RC_NO_LEAF | RC_UNCOMMON |
2112                                  (must_throw ? RC_MUST_THROW : 0),
2113                                  OptoRuntime::uncommon_trap_Type(),
2114                                  call_addr, &quot;uncommon_trap&quot;, no_memory_effects,
2115                                  intcon(trap_request));
2116   assert(call-&gt;as_CallStaticJava()-&gt;uncommon_trap_request() == trap_request,
2117          &quot;must extract request correctly from the graph&quot;);
2118   assert(trap_request != 0, &quot;zero value reserved by uncommon_trap_request&quot;);
2119 
2120   call-&gt;set_req(TypeFunc::ReturnAdr, returnadr());
2121   // The debug info is the only real input to this call.
2122 
2123   // Halt-and-catch fire here.  The above call should never return!
2124   HaltNode* halt = new HaltNode(control(), frameptr(), &quot;uncommon trap returned which should never happen&quot;
2125                                                        PRODUCT_ONLY(COMMA /*reachable*/false));
2126   _gvn.set_type_bottom(halt);
2127   root()-&gt;add_req(halt);
2128 
2129   stop_and_kill_map();
2130 }
2131 
2132 
2133 //--------------------------just_allocated_object------------------------------
2134 // Report the object that was just allocated.
2135 // It must be the case that there are no intervening safepoints.
2136 // We use this to determine if an object is so &quot;fresh&quot; that
2137 // it does not require card marks.
2138 Node* GraphKit::just_allocated_object(Node* current_control) {
2139   Node* ctrl = current_control;
2140   // Object::&lt;init&gt; is invoked after allocation, most of invoke nodes
2141   // will be reduced, but a region node is kept in parse time, we check
2142   // the pattern and skip the region node if it degraded to a copy.
2143   if (ctrl != NULL &amp;&amp; ctrl-&gt;is_Region() &amp;&amp; ctrl-&gt;req() == 2 &amp;&amp;
2144       ctrl-&gt;as_Region()-&gt;is_copy()) {
2145     ctrl = ctrl-&gt;as_Region()-&gt;is_copy();
2146   }
2147   if (C-&gt;recent_alloc_ctl() == ctrl) {
2148    return C-&gt;recent_alloc_obj();
2149   }
2150   return NULL;
2151 }
2152 
2153 
2154 /**
2155  * Record profiling data exact_kls for Node n with the type system so
2156  * that it can propagate it (speculation)
2157  *
2158  * @param n          node that the type applies to
2159  * @param exact_kls  type from profiling
2160  * @param maybe_null did profiling see null?
2161  *
2162  * @return           node with improved type
2163  */
2164 Node* GraphKit::record_profile_for_speculation(Node* n, ciKlass* exact_kls, ProfilePtrKind ptr_kind) {
2165   const Type* current_type = _gvn.type(n);
2166   assert(UseTypeSpeculation, &quot;type speculation must be on&quot;);
2167 
2168   const TypePtr* speculative = current_type-&gt;speculative();
2169 
2170   // Should the klass from the profile be recorded in the speculative type?
2171   if (current_type-&gt;would_improve_type(exact_kls, jvms()-&gt;depth())) {
2172     const TypeKlassPtr* tklass = TypeKlassPtr::make(exact_kls);
2173     const TypeOopPtr* xtype = tklass-&gt;as_instance_type();
2174     assert(xtype-&gt;klass_is_exact(), &quot;Should be exact&quot;);
2175     // Any reason to believe n is not null (from this profiling or a previous one)?
2176     assert(ptr_kind != ProfileAlwaysNull, &quot;impossible here&quot;);
2177     const TypePtr* ptr = (ptr_kind == ProfileMaybeNull &amp;&amp; current_type-&gt;speculative_maybe_null()) ? TypePtr::BOTTOM : TypePtr::NOTNULL;
2178     // record the new speculative type&#39;s depth
2179     speculative = xtype-&gt;cast_to_ptr_type(ptr-&gt;ptr())-&gt;is_ptr();
2180     speculative = speculative-&gt;with_inline_depth(jvms()-&gt;depth());
2181   } else if (current_type-&gt;would_improve_ptr(ptr_kind)) {
2182     // Profiling report that null was never seen so we can change the
2183     // speculative type to non null ptr.
2184     if (ptr_kind == ProfileAlwaysNull) {
2185       speculative = TypePtr::NULL_PTR;
2186     } else {
2187       assert(ptr_kind == ProfileNeverNull, &quot;nothing else is an improvement&quot;);
2188       const TypePtr* ptr = TypePtr::NOTNULL;
2189       if (speculative != NULL) {
2190         speculative = speculative-&gt;cast_to_ptr_type(ptr-&gt;ptr())-&gt;is_ptr();
2191       } else {
2192         speculative = ptr;
2193       }
2194     }
2195   }
2196 
2197   if (speculative != current_type-&gt;speculative()) {
2198     // Build a type with a speculative type (what we think we know
2199     // about the type but will need a guard when we use it)
2200     const TypeOopPtr* spec_type = TypeOopPtr::make(TypePtr::BotPTR, Type::OffsetBot, TypeOopPtr::InstanceBot, speculative);
2201     // We&#39;re changing the type, we need a new CheckCast node to carry
2202     // the new type. The new type depends on the control: what
2203     // profiling tells us is only valid from here as far as we can
2204     // tell.
2205     Node* cast = new CheckCastPPNode(control(), n, current_type-&gt;remove_speculative()-&gt;join_speculative(spec_type));
2206     cast = _gvn.transform(cast);
2207     replace_in_map(n, cast);
2208     n = cast;
2209   }
2210 
2211   return n;
2212 }
2213 
2214 /**
2215  * Record profiling data from receiver profiling at an invoke with the
2216  * type system so that it can propagate it (speculation)
2217  *
2218  * @param n  receiver node
2219  *
2220  * @return   node with improved type
2221  */
2222 Node* GraphKit::record_profiled_receiver_for_speculation(Node* n) {
2223   if (!UseTypeSpeculation) {
2224     return n;
2225   }
2226   ciKlass* exact_kls = profile_has_unique_klass();
2227   ProfilePtrKind ptr_kind = ProfileMaybeNull;
2228   if ((java_bc() == Bytecodes::_checkcast ||
2229        java_bc() == Bytecodes::_instanceof ||
2230        java_bc() == Bytecodes::_aastore) &amp;&amp;
2231       method()-&gt;method_data()-&gt;is_mature()) {
2232     ciProfileData* data = method()-&gt;method_data()-&gt;bci_to_data(bci());
2233     if (data != NULL) {
2234       if (!data-&gt;as_BitData()-&gt;null_seen()) {
2235         ptr_kind = ProfileNeverNull;
2236       } else {
2237         assert(data-&gt;is_ReceiverTypeData(), &quot;bad profile data type&quot;);
2238         ciReceiverTypeData* call = (ciReceiverTypeData*)data-&gt;as_ReceiverTypeData();
2239         uint i = 0;
2240         for (; i &lt; call-&gt;row_limit(); i++) {
2241           ciKlass* receiver = call-&gt;receiver(i);
2242           if (receiver != NULL) {
2243             break;
2244           }
2245         }
2246         ptr_kind = (i == call-&gt;row_limit()) ? ProfileAlwaysNull : ProfileMaybeNull;
2247       }
2248     }
2249   }
2250   return record_profile_for_speculation(n, exact_kls, ptr_kind);
2251 }
2252 
2253 /**
2254  * Record profiling data from argument profiling at an invoke with the
2255  * type system so that it can propagate it (speculation)
2256  *
2257  * @param dest_method  target method for the call
2258  * @param bc           what invoke bytecode is this?
2259  */
2260 void GraphKit::record_profiled_arguments_for_speculation(ciMethod* dest_method, Bytecodes::Code bc) {
2261   if (!UseTypeSpeculation) {
2262     return;
2263   }
2264   const TypeFunc* tf    = TypeFunc::make(dest_method);
2265   int             nargs = tf-&gt;domain()-&gt;cnt() - TypeFunc::Parms;
2266   int skip = Bytecodes::has_receiver(bc) ? 1 : 0;
2267   for (int j = skip, i = 0; j &lt; nargs &amp;&amp; i &lt; TypeProfileArgsLimit; j++) {
2268     const Type *targ = tf-&gt;domain()-&gt;field_at(j + TypeFunc::Parms);
2269     if (is_reference_type(targ-&gt;basic_type())) {
2270       ProfilePtrKind ptr_kind = ProfileMaybeNull;
2271       ciKlass* better_type = NULL;
2272       if (method()-&gt;argument_profiled_type(bci(), i, better_type, ptr_kind)) {
2273         record_profile_for_speculation(argument(j), better_type, ptr_kind);
2274       }
2275       i++;
2276     }
2277   }
2278 }
2279 
2280 /**
2281  * Record profiling data from parameter profiling at an invoke with
2282  * the type system so that it can propagate it (speculation)
2283  */
2284 void GraphKit::record_profiled_parameters_for_speculation() {
2285   if (!UseTypeSpeculation) {
2286     return;
2287   }
2288   for (int i = 0, j = 0; i &lt; method()-&gt;arg_size() ; i++) {
2289     if (_gvn.type(local(i))-&gt;isa_oopptr()) {
2290       ProfilePtrKind ptr_kind = ProfileMaybeNull;
2291       ciKlass* better_type = NULL;
2292       if (method()-&gt;parameter_profiled_type(j, better_type, ptr_kind)) {
2293         record_profile_for_speculation(local(i), better_type, ptr_kind);
2294       }
2295       j++;
2296     }
2297   }
2298 }
2299 
2300 /**
2301  * Record profiling data from return value profiling at an invoke with
2302  * the type system so that it can propagate it (speculation)
2303  */
2304 void GraphKit::record_profiled_return_for_speculation() {
2305   if (!UseTypeSpeculation) {
2306     return;
2307   }
2308   ProfilePtrKind ptr_kind = ProfileMaybeNull;
2309   ciKlass* better_type = NULL;
2310   if (method()-&gt;return_profiled_type(bci(), better_type, ptr_kind)) {
2311     // If profiling reports a single type for the return value,
2312     // feed it to the type system so it can propagate it as a
2313     // speculative type
2314     record_profile_for_speculation(stack(sp()-1), better_type, ptr_kind);
2315   }
2316 }
2317 
2318 void GraphKit::round_double_result(ciMethod* dest_method) {
2319   if (Matcher::strict_fp_requires_explicit_rounding) {
2320     // If a strict caller invokes a non-strict callee, round a double result.
2321     // A non-strict method may return a double value which has an extended exponent,
2322     // but this must not be visible in a caller which is strict.
2323     BasicType result_type = dest_method-&gt;return_type()-&gt;basic_type();
2324     assert(method() != NULL, &quot;must have caller context&quot;);
2325     if( result_type == T_DOUBLE &amp;&amp; method()-&gt;is_strict() &amp;&amp; !dest_method-&gt;is_strict() ) {
2326       // Destination method&#39;s return value is on top of stack
2327       // dstore_rounding() does gvn.transform
2328       Node *result = pop_pair();
2329       result = dstore_rounding(result);
2330       push_pair(result);
2331     }
2332   }
2333 }
2334 
2335 void GraphKit::round_double_arguments(ciMethod* dest_method) {
2336   if (Matcher::strict_fp_requires_explicit_rounding) {
2337     // (Note:  TypeFunc::make has a cache that makes this fast.)
2338     const TypeFunc* tf    = TypeFunc::make(dest_method);
2339     int             nargs = tf-&gt;domain()-&gt;cnt() - TypeFunc::Parms;
2340     for (int j = 0; j &lt; nargs; j++) {
2341       const Type *targ = tf-&gt;domain()-&gt;field_at(j + TypeFunc::Parms);
2342       if (targ-&gt;basic_type() == T_DOUBLE) {
2343         // If any parameters are doubles, they must be rounded before
2344         // the call, dstore_rounding does gvn.transform
2345         Node *arg = argument(j);
2346         arg = dstore_rounding(arg);
2347         set_argument(j, arg);
2348       }
2349     }
2350   }
2351 }
2352 
2353 // rounding for strict float precision conformance
2354 Node* GraphKit::precision_rounding(Node* n) {
2355   if (Matcher::strict_fp_requires_explicit_rounding) {
2356 #ifdef IA32
2357     if (_method-&gt;flags().is_strict() &amp;&amp; UseSSE == 0) {
2358       return _gvn.transform(new RoundFloatNode(0, n));
2359     }
2360 #else
2361     Unimplemented();
2362 #endif // IA32
2363   }
2364   return n;
2365 }
2366 
2367 // rounding for strict double precision conformance
2368 Node* GraphKit::dprecision_rounding(Node *n) {
2369   if (Matcher::strict_fp_requires_explicit_rounding) {
2370 #ifdef IA32
2371     if (_method-&gt;flags().is_strict() &amp;&amp; UseSSE &lt; 2) {
2372       return _gvn.transform(new RoundDoubleNode(0, n));
2373     }
2374 #else
2375     Unimplemented();
2376 #endif // IA32
2377   }
2378   return n;
2379 }
2380 
2381 // rounding for non-strict double stores
2382 Node* GraphKit::dstore_rounding(Node* n) {
2383   if (Matcher::strict_fp_requires_explicit_rounding) {
2384 #ifdef IA32
2385     if (UseSSE &lt; 2) {
2386       return _gvn.transform(new RoundDoubleNode(0, n));
2387     }
2388 #else
2389     Unimplemented();
2390 #endif // IA32
2391   }
2392   return n;
2393 }
2394 
2395 //=============================================================================
2396 // Generate a fast path/slow path idiom.  Graph looks like:
2397 // [foo] indicates that &#39;foo&#39; is a parameter
2398 //
2399 //              [in]     NULL
2400 //                 \    /
2401 //                  CmpP
2402 //                  Bool ne
2403 //                   If
2404 //                  /  \
2405 //              True    False-&lt;2&gt;
2406 //              / |
2407 //             /  cast_not_null
2408 //           Load  |    |   ^
2409 //        [fast_test]   |   |
2410 // gvn to   opt_test    |   |
2411 //          /    \      |  &lt;1&gt;
2412 //      True     False  |
2413 //        |         \\  |
2414 //   [slow_call]     \[fast_result]
2415 //    Ctl   Val       \      \
2416 //     |               \      \
2417 //    Catch       &lt;1&gt;   \      \
2418 //   /    \        ^     \      \
2419 //  Ex    No_Ex    |      \      \
2420 //  |       \   \  |       \ &lt;2&gt;  \
2421 //  ...      \  [slow_res] |  |    \   [null_result]
2422 //            \         \--+--+---  |  |
2423 //             \           | /    \ | /
2424 //              --------Region     Phi
2425 //
2426 //=============================================================================
2427 // Code is structured as a series of driver functions all called &#39;do_XXX&#39; that
2428 // call a set of helper functions.  Helper functions first, then drivers.
2429 
2430 //------------------------------null_check_oop---------------------------------
2431 // Null check oop.  Set null-path control into Region in slot 3.
2432 // Make a cast-not-nullness use the other not-null control.  Return cast.
2433 Node* GraphKit::null_check_oop(Node* value, Node* *null_control,
2434                                bool never_see_null,
2435                                bool safe_for_replace,
2436                                bool speculative) {
2437   // Initial NULL check taken path
2438   (*null_control) = top();
2439   Node* cast = null_check_common(value, T_OBJECT, false, null_control, speculative);
2440 
2441   // Generate uncommon_trap:
2442   if (never_see_null &amp;&amp; (*null_control) != top()) {
2443     // If we see an unexpected null at a check-cast we record it and force a
2444     // recompile; the offending check-cast will be compiled to handle NULLs.
2445     // If we see more than one offending BCI, then all checkcasts in the
2446     // method will be compiled to handle NULLs.
2447     PreserveJVMState pjvms(this);
2448     set_control(*null_control);
2449     replace_in_map(value, null());
2450     Deoptimization::DeoptReason reason = Deoptimization::reason_null_check(speculative);
2451     uncommon_trap(reason,
2452                   Deoptimization::Action_make_not_entrant);
2453     (*null_control) = top();    // NULL path is dead
2454   }
2455   if ((*null_control) == top() &amp;&amp; safe_for_replace) {
2456     replace_in_map(value, cast);
2457   }
2458 
2459   // Cast away null-ness on the result
2460   return cast;
2461 }
2462 
2463 //------------------------------opt_iff----------------------------------------
2464 // Optimize the fast-check IfNode.  Set the fast-path region slot 2.
2465 // Return slow-path control.
2466 Node* GraphKit::opt_iff(Node* region, Node* iff) {
2467   IfNode *opt_iff = _gvn.transform(iff)-&gt;as_If();
2468 
2469   // Fast path taken; set region slot 2
2470   Node *fast_taken = _gvn.transform( new IfFalseNode(opt_iff) );
2471   region-&gt;init_req(2,fast_taken); // Capture fast-control
2472 
2473   // Fast path not-taken, i.e. slow path
2474   Node *slow_taken = _gvn.transform( new IfTrueNode(opt_iff) );
2475   return slow_taken;
2476 }
2477 
2478 //-----------------------------make_runtime_call-------------------------------
2479 Node* GraphKit::make_runtime_call(int flags,
2480                                   const TypeFunc* call_type, address call_addr,
2481                                   const char* call_name,
2482                                   const TypePtr* adr_type,
2483                                   // The following parms are all optional.
2484                                   // The first NULL ends the list.
2485                                   Node* parm0, Node* parm1,
2486                                   Node* parm2, Node* parm3,
2487                                   Node* parm4, Node* parm5,
2488                                   Node* parm6, Node* parm7) {
2489   assert(call_addr != NULL, &quot;must not call NULL targets&quot;);
2490 
2491   // Slow-path call
2492   bool is_leaf = !(flags &amp; RC_NO_LEAF);
2493   bool has_io  = (!is_leaf &amp;&amp; !(flags &amp; RC_NO_IO));
2494   if (call_name == NULL) {
2495     assert(!is_leaf, &quot;must supply name for leaf&quot;);
2496     call_name = OptoRuntime::stub_name(call_addr);
2497   }
2498   CallNode* call;
2499   if (!is_leaf) {
2500     call = new CallStaticJavaNode(call_type, call_addr, call_name,
2501                                            bci(), adr_type);
2502   } else if (flags &amp; RC_NO_FP) {
2503     call = new CallLeafNoFPNode(call_type, call_addr, call_name, adr_type);
2504   } else {
2505     call = new CallLeafNode(call_type, call_addr, call_name, adr_type);
2506   }
2507 
2508   // The following is similar to set_edges_for_java_call,
2509   // except that the memory effects of the call are restricted to AliasIdxRaw.
2510 
2511   // Slow path call has no side-effects, uses few values
2512   bool wide_in  = !(flags &amp; RC_NARROW_MEM);
2513   bool wide_out = (C-&gt;get_alias_index(adr_type) == Compile::AliasIdxBot);
2514 
2515   Node* prev_mem = NULL;
2516   if (wide_in) {
2517     prev_mem = set_predefined_input_for_runtime_call(call);
2518   } else {
2519     assert(!wide_out, &quot;narrow in =&gt; narrow out&quot;);
2520     Node* narrow_mem = memory(adr_type);
2521     prev_mem = set_predefined_input_for_runtime_call(call, narrow_mem);
2522   }
2523 
2524   // Hook each parm in order.  Stop looking at the first NULL.
2525   if (parm0 != NULL) { call-&gt;init_req(TypeFunc::Parms+0, parm0);
2526   if (parm1 != NULL) { call-&gt;init_req(TypeFunc::Parms+1, parm1);
2527   if (parm2 != NULL) { call-&gt;init_req(TypeFunc::Parms+2, parm2);
2528   if (parm3 != NULL) { call-&gt;init_req(TypeFunc::Parms+3, parm3);
2529   if (parm4 != NULL) { call-&gt;init_req(TypeFunc::Parms+4, parm4);
2530   if (parm5 != NULL) { call-&gt;init_req(TypeFunc::Parms+5, parm5);
2531   if (parm6 != NULL) { call-&gt;init_req(TypeFunc::Parms+6, parm6);
2532   if (parm7 != NULL) { call-&gt;init_req(TypeFunc::Parms+7, parm7);
2533     /* close each nested if ===&gt; */  } } } } } } } }
2534   assert(call-&gt;in(call-&gt;req()-1) != NULL, &quot;must initialize all parms&quot;);
2535 
2536   if (!is_leaf) {
2537     // Non-leaves can block and take safepoints:
2538     add_safepoint_edges(call, ((flags &amp; RC_MUST_THROW) != 0));
2539   }
2540   // Non-leaves can throw exceptions:
2541   if (has_io) {
2542     call-&gt;set_req(TypeFunc::I_O, i_o());
2543   }
2544 
2545   if (flags &amp; RC_UNCOMMON) {
2546     // Set the count to a tiny probability.  Cf. Estimate_Block_Frequency.
2547     // (An &quot;if&quot; probability corresponds roughly to an unconditional count.
2548     // Sort of.)
2549     call-&gt;set_cnt(PROB_UNLIKELY_MAG(4));
2550   }
2551 
2552   Node* c = _gvn.transform(call);
2553   assert(c == call, &quot;cannot disappear&quot;);
2554 
2555   if (wide_out) {
2556     // Slow path call has full side-effects.
2557     set_predefined_output_for_runtime_call(call);
2558   } else {
2559     // Slow path call has few side-effects, and/or sets few values.
2560     set_predefined_output_for_runtime_call(call, prev_mem, adr_type);
2561   }
2562 
2563   if (has_io) {
2564     set_i_o(_gvn.transform(new ProjNode(call, TypeFunc::I_O)));
2565   }
2566   return call;
2567 
2568 }
2569 
<a name="4" id="anc4"></a><span class="line-added">2570 // i2b</span>
<span class="line-added">2571 Node* GraphKit::sign_extend_byte(Node* in) {</span>
<span class="line-added">2572   Node* tmp = _gvn.transform(new LShiftINode(in, _gvn.intcon(24)));</span>
<span class="line-added">2573   return _gvn.transform(new RShiftINode(tmp, _gvn.intcon(24)));</span>
<span class="line-added">2574 }</span>
<span class="line-added">2575 </span>
<span class="line-added">2576 // i2s</span>
<span class="line-added">2577 Node* GraphKit::sign_extend_short(Node* in) {</span>
<span class="line-added">2578   Node* tmp = _gvn.transform(new LShiftINode(in, _gvn.intcon(16)));</span>
<span class="line-added">2579   return _gvn.transform(new RShiftINode(tmp, _gvn.intcon(16)));</span>
<span class="line-added">2580 }</span>
<span class="line-added">2581 </span>
<span class="line-added">2582 //-----------------------------make_native_call-------------------------------</span>
<span class="line-added">2583 Node* GraphKit::make_native_call(const TypeFunc* call_type, uint nargs, ciNativeEntryPoint* nep) {</span>
<span class="line-added">2584   uint n_filtered_args = nargs - 2; // -fallback, -nep;</span>
<span class="line-added">2585   ResourceMark rm;</span>
<span class="line-added">2586   Node** argument_nodes = NEW_RESOURCE_ARRAY(Node*, n_filtered_args);</span>
<span class="line-added">2587   const Type** arg_types = NEW_RESOURCE_ARRAY(const Type*, n_filtered_args);</span>
<span class="line-added">2588   GrowableArray&lt;VMReg&gt; arg_regs(C-&gt;comp_arena(), n_filtered_args, n_filtered_args, VMRegImpl::Bad());</span>
<span class="line-added">2589 </span>
<span class="line-added">2590   VMReg* argRegs = nep-&gt;argMoves();</span>
<span class="line-added">2591   {</span>
<span class="line-added">2592     for (uint vm_arg_pos = 0, java_arg_read_pos = 0;</span>
<span class="line-added">2593         vm_arg_pos &lt; n_filtered_args; vm_arg_pos++) {</span>
<span class="line-added">2594       uint vm_unfiltered_arg_pos = vm_arg_pos + 1; // +1 to skip fallback handle argument</span>
<span class="line-added">2595       Node* node = argument(vm_unfiltered_arg_pos);</span>
<span class="line-added">2596       const Type* type = call_type-&gt;domain()-&gt;field_at(TypeFunc::Parms + vm_unfiltered_arg_pos);</span>
<span class="line-added">2597       VMReg reg = type == Type::HALF</span>
<span class="line-added">2598         ? VMRegImpl::Bad()</span>
<span class="line-added">2599         : argRegs[java_arg_read_pos++];</span>
<span class="line-added">2600 </span>
<span class="line-added">2601       argument_nodes[vm_arg_pos] = node;</span>
<span class="line-added">2602       arg_types[vm_arg_pos] = type;</span>
<span class="line-added">2603       arg_regs.at_put(vm_arg_pos, reg);</span>
<span class="line-added">2604     }</span>
<span class="line-added">2605   }</span>
<span class="line-added">2606 </span>
<span class="line-added">2607   uint n_returns = call_type-&gt;range()-&gt;cnt() - TypeFunc::Parms;</span>
<span class="line-added">2608   GrowableArray&lt;VMReg&gt; ret_regs(C-&gt;comp_arena(), n_returns, n_returns, VMRegImpl::Bad());</span>
<span class="line-added">2609   const Type** ret_types = NEW_RESOURCE_ARRAY(const Type*, n_returns);</span>
<span class="line-added">2610 </span>
<span class="line-added">2611   VMReg* retRegs = nep-&gt;returnMoves();</span>
<span class="line-added">2612   {</span>
<span class="line-added">2613     for (uint vm_ret_pos = 0, java_ret_read_pos = 0;</span>
<span class="line-added">2614         vm_ret_pos &lt; n_returns; vm_ret_pos++) { // 0 or 1</span>
<span class="line-added">2615       const Type* type = call_type-&gt;range()-&gt;field_at(TypeFunc::Parms + vm_ret_pos);</span>
<span class="line-added">2616       VMReg reg = type == Type::HALF</span>
<span class="line-added">2617         ? VMRegImpl::Bad()</span>
<span class="line-added">2618         : retRegs[java_ret_read_pos++];</span>
<span class="line-added">2619 </span>
<span class="line-added">2620       ret_regs.at_put(vm_ret_pos, reg);</span>
<span class="line-added">2621       ret_types[vm_ret_pos] = type;</span>
<span class="line-added">2622     }</span>
<span class="line-added">2623   }</span>
<span class="line-added">2624 </span>
<span class="line-added">2625   const TypeFunc* new_call_type = TypeFunc::make(</span>
<span class="line-added">2626     TypeTuple::make_func(n_filtered_args, arg_types),</span>
<span class="line-added">2627     TypeTuple::make_func(n_returns, ret_types)</span>
<span class="line-added">2628   );</span>
<span class="line-added">2629 </span>
<span class="line-added">2630   address call_addr = nep-&gt;entry_point();</span>
<span class="line-added">2631   if (nep-&gt;need_transition()) {</span>
<span class="line-added">2632     call_addr = SharedRuntime::make_native_invoker(call_addr,</span>
<span class="line-added">2633                                                    nep-&gt;shadow_space(),</span>
<span class="line-added">2634                                                    arg_regs, ret_regs);</span>
<span class="line-added">2635     C-&gt;add_native_stub(call_addr);</span>
<span class="line-added">2636   }</span>
<span class="line-added">2637   assert(call_addr != NULL, &quot;sanity&quot;);</span>
<span class="line-added">2638 </span>
<span class="line-added">2639   CallNativeNode* call = new CallNativeNode(new_call_type, call_addr, nep-&gt;name(), TypePtr::BOTTOM,</span>
<span class="line-added">2640                                             arg_regs,</span>
<span class="line-added">2641                                             ret_regs,</span>
<span class="line-added">2642                                             nep-&gt;shadow_space(),</span>
<span class="line-added">2643                                             nep-&gt;need_transition());</span>
<span class="line-added">2644 </span>
<span class="line-added">2645   if (call-&gt;_need_transition) {</span>
<span class="line-added">2646     add_safepoint_edges(call);</span>
<span class="line-added">2647   }</span>
<span class="line-added">2648 </span>
<span class="line-added">2649   set_predefined_input_for_runtime_call(call);</span>
<span class="line-added">2650 </span>
<span class="line-added">2651   for (uint i = 0; i &lt; n_filtered_args; i++) {</span>
<span class="line-added">2652     call-&gt;init_req(i + TypeFunc::Parms, argument_nodes[i]);</span>
<span class="line-added">2653   }</span>
<span class="line-added">2654 </span>
<span class="line-added">2655   Node* c = gvn().transform(call);</span>
<span class="line-added">2656   assert(c == call, &quot;cannot disappear&quot;);</span>
<span class="line-added">2657 </span>
<span class="line-added">2658   set_predefined_output_for_runtime_call(call);</span>
<span class="line-added">2659 </span>
<span class="line-added">2660   Node* ret;</span>
<span class="line-added">2661   if (method() == NULL || method()-&gt;return_type()-&gt;basic_type() == T_VOID) {</span>
<span class="line-added">2662     ret = top();</span>
<span class="line-added">2663   } else {</span>
<span class="line-added">2664     Node* current_value = NULL;</span>
<span class="line-added">2665     for (uint vm_ret_pos = 0; vm_ret_pos &lt; n_returns; vm_ret_pos++) {</span>
<span class="line-added">2666       if (new_call_type-&gt;range()-&gt;field_at(TypeFunc::Parms + vm_ret_pos)  == Type::HALF) {</span>
<span class="line-added">2667         // FIXME is this needed?</span>
<span class="line-added">2668         gvn().transform(new ProjNode(call, TypeFunc::Parms + vm_ret_pos));</span>
<span class="line-added">2669       } else {</span>
<span class="line-added">2670         assert(current_value == NULL, &quot;Must not overwrite&quot;);</span>
<span class="line-added">2671         current_value = gvn().transform(new ProjNode(call, TypeFunc::Parms + vm_ret_pos));</span>
<span class="line-added">2672       }</span>
<span class="line-added">2673     }</span>
<span class="line-added">2674     assert(current_value != NULL, &quot;Should not be null&quot;);</span>
<span class="line-added">2675     // Unpack native results if needed</span>
<span class="line-added">2676     // Need this method type since it&#39;s unerased</span>
<span class="line-added">2677     switch (nep-&gt;method_type()-&gt;rtype()-&gt;basic_type()) {</span>
<span class="line-added">2678       case T_CHAR:</span>
<span class="line-added">2679         current_value = _gvn.transform(new AndINode(current_value, _gvn.intcon(0xFFFF)));</span>
<span class="line-added">2680         break;</span>
<span class="line-added">2681       case T_BYTE:</span>
<span class="line-added">2682         current_value = sign_extend_byte(current_value);</span>
<span class="line-added">2683         break;</span>
<span class="line-added">2684       case T_SHORT:</span>
<span class="line-added">2685         current_value = sign_extend_short(current_value);</span>
<span class="line-added">2686         break;</span>
<span class="line-added">2687       default: // do nothing</span>
<span class="line-added">2688         break;</span>
<span class="line-added">2689     }</span>
<span class="line-added">2690     ret = current_value;</span>
<span class="line-added">2691   }</span>
<span class="line-added">2692 </span>
<span class="line-added">2693   push_node(method()-&gt;return_type()-&gt;basic_type(), ret);</span>
<span class="line-added">2694 </span>
<span class="line-added">2695   return call;</span>
<span class="line-added">2696 }</span>
<span class="line-added">2697 </span>
2698 //------------------------------merge_memory-----------------------------------
2699 // Merge memory from one path into the current memory state.
2700 void GraphKit::merge_memory(Node* new_mem, Node* region, int new_path) {
2701   for (MergeMemStream mms(merged_memory(), new_mem-&gt;as_MergeMem()); mms.next_non_empty2(); ) {
2702     Node* old_slice = mms.force_memory();
2703     Node* new_slice = mms.memory2();
2704     if (old_slice != new_slice) {
2705       PhiNode* phi;
2706       if (old_slice-&gt;is_Phi() &amp;&amp; old_slice-&gt;as_Phi()-&gt;region() == region) {
2707         if (mms.is_empty()) {
2708           // clone base memory Phi&#39;s inputs for this memory slice
2709           assert(old_slice == mms.base_memory(), &quot;sanity&quot;);
2710           phi = PhiNode::make(region, NULL, Type::MEMORY, mms.adr_type(C));
2711           _gvn.set_type(phi, Type::MEMORY);
2712           for (uint i = 1; i &lt; phi-&gt;req(); i++) {
2713             phi-&gt;init_req(i, old_slice-&gt;in(i));
2714           }
2715         } else {
2716           phi = old_slice-&gt;as_Phi(); // Phi was generated already
2717         }
2718       } else {
2719         phi = PhiNode::make(region, old_slice, Type::MEMORY, mms.adr_type(C));
2720         _gvn.set_type(phi, Type::MEMORY);
2721       }
2722       phi-&gt;set_req(new_path, new_slice);
2723       mms.set_memory(phi);
2724     }
2725   }
2726 }
2727 
2728 //------------------------------make_slow_call_ex------------------------------
2729 // Make the exception handler hookups for the slow call
2730 void GraphKit::make_slow_call_ex(Node* call, ciInstanceKlass* ex_klass, bool separate_io_proj, bool deoptimize) {
2731   if (stopped())  return;
2732 
2733   // Make a catch node with just two handlers:  fall-through and catch-all
2734   Node* i_o  = _gvn.transform( new ProjNode(call, TypeFunc::I_O, separate_io_proj) );
2735   Node* catc = _gvn.transform( new CatchNode(control(), i_o, 2) );
2736   Node* norm = _gvn.transform( new CatchProjNode(catc, CatchProjNode::fall_through_index, CatchProjNode::no_handler_bci) );
2737   Node* excp = _gvn.transform( new CatchProjNode(catc, CatchProjNode::catch_all_index,    CatchProjNode::no_handler_bci) );
2738 
2739   { PreserveJVMState pjvms(this);
2740     set_control(excp);
2741     set_i_o(i_o);
2742 
2743     if (excp != top()) {
2744       if (deoptimize) {
2745         // Deoptimize if an exception is caught. Don&#39;t construct exception state in this case.
2746         uncommon_trap(Deoptimization::Reason_unhandled,
2747                       Deoptimization::Action_none);
2748       } else {
2749         // Create an exception state also.
2750         // Use an exact type if the caller has a specific exception.
2751         const Type* ex_type = TypeOopPtr::make_from_klass_unique(ex_klass)-&gt;cast_to_ptr_type(TypePtr::NotNull);
2752         Node*       ex_oop  = new CreateExNode(ex_type, control(), i_o);
2753         add_exception_state(make_exception_state(_gvn.transform(ex_oop)));
2754       }
2755     }
2756   }
2757 
2758   // Get the no-exception control from the CatchNode.
2759   set_control(norm);
2760 }
2761 
2762 static IfNode* gen_subtype_check_compare(Node* ctrl, Node* in1, Node* in2, BoolTest::mask test, float p, PhaseGVN&amp; gvn, BasicType bt) {
2763   Node* cmp = NULL;
2764   switch(bt) {
2765   case T_INT: cmp = new CmpINode(in1, in2); break;
2766   case T_ADDRESS: cmp = new CmpPNode(in1, in2); break;
2767   default: fatal(&quot;unexpected comparison type %s&quot;, type2name(bt));
2768   }
2769   gvn.transform(cmp);
2770   Node* bol = gvn.transform(new BoolNode(cmp, test));
2771   IfNode* iff = new IfNode(ctrl, bol, p, COUNT_UNKNOWN);
2772   gvn.transform(iff);
2773   if (!bol-&gt;is_Con()) gvn.record_for_igvn(iff);
2774   return iff;
2775 }
2776 
2777 //-------------------------------gen_subtype_check-----------------------------
2778 // Generate a subtyping check.  Takes as input the subtype and supertype.
2779 // Returns 2 values: sets the default control() to the true path and returns
2780 // the false path.  Only reads invariant memory; sets no (visible) memory.
2781 // The PartialSubtypeCheckNode sets the hidden 1-word cache in the encoding
2782 // but that&#39;s not exposed to the optimizer.  This call also doesn&#39;t take in an
2783 // Object; if you wish to check an Object you need to load the Object&#39;s class
2784 // prior to coming here.
2785 Node* Phase::gen_subtype_check(Node* subklass, Node* superklass, Node** ctrl, Node* mem, PhaseGVN&amp; gvn) {
2786   Compile* C = gvn.C;
2787   if ((*ctrl)-&gt;is_top()) {
2788     return C-&gt;top();
2789   }
2790 
2791   // Fast check for identical types, perhaps identical constants.
2792   // The types can even be identical non-constants, in cases
2793   // involving Array.newInstance, Object.clone, etc.
2794   if (subklass == superklass)
2795     return C-&gt;top();             // false path is dead; no test needed.
2796 
2797   if (gvn.type(superklass)-&gt;singleton()) {
2798     ciKlass* superk = gvn.type(superklass)-&gt;is_klassptr()-&gt;klass();
2799     ciKlass* subk   = gvn.type(subklass)-&gt;is_klassptr()-&gt;klass();
2800 
2801     // In the common case of an exact superklass, try to fold up the
2802     // test before generating code.  You may ask, why not just generate
2803     // the code and then let it fold up?  The answer is that the generated
2804     // code will necessarily include null checks, which do not always
2805     // completely fold away.  If they are also needless, then they turn
2806     // into a performance loss.  Example:
2807     //    Foo[] fa = blah(); Foo x = fa[0]; fa[1] = x;
2808     // Here, the type of &#39;fa&#39; is often exact, so the store check
2809     // of fa[1]=x will fold up, without testing the nullness of x.
2810     switch (C-&gt;static_subtype_check(superk, subk)) {
2811     case Compile::SSC_always_false:
2812       {
2813         Node* always_fail = *ctrl;
2814         *ctrl = gvn.C-&gt;top();
2815         return always_fail;
2816       }
2817     case Compile::SSC_always_true:
2818       return C-&gt;top();
2819     case Compile::SSC_easy_test:
2820       {
2821         // Just do a direct pointer compare and be done.
2822         IfNode* iff = gen_subtype_check_compare(*ctrl, subklass, superklass, BoolTest::eq, PROB_STATIC_FREQUENT, gvn, T_ADDRESS);
2823         *ctrl = gvn.transform(new IfTrueNode(iff));
2824         return gvn.transform(new IfFalseNode(iff));
2825       }
2826     case Compile::SSC_full_test:
2827       break;
2828     default:
2829       ShouldNotReachHere();
2830     }
2831   }
2832 
2833   // %%% Possible further optimization:  Even if the superklass is not exact,
2834   // if the subklass is the unique subtype of the superklass, the check
2835   // will always succeed.  We could leave a dependency behind to ensure this.
2836 
2837   // First load the super-klass&#39;s check-offset
2838   Node *p1 = gvn.transform(new AddPNode(superklass, superklass, gvn.MakeConX(in_bytes(Klass::super_check_offset_offset()))));
2839   Node* m = C-&gt;immutable_memory();
2840   Node *chk_off = gvn.transform(new LoadINode(NULL, m, p1, gvn.type(p1)-&gt;is_ptr(), TypeInt::INT, MemNode::unordered));
2841   int cacheoff_con = in_bytes(Klass::secondary_super_cache_offset());
2842   bool might_be_cache = (gvn.find_int_con(chk_off, cacheoff_con) == cacheoff_con);
2843 
2844   // Load from the sub-klass&#39;s super-class display list, or a 1-word cache of
2845   // the secondary superclass list, or a failing value with a sentinel offset
2846   // if the super-klass is an interface or exceptionally deep in the Java
2847   // hierarchy and we have to scan the secondary superclass list the hard way.
2848   // Worst-case type is a little odd: NULL is allowed as a result (usually
2849   // klass loads can never produce a NULL).
2850   Node *chk_off_X = chk_off;
2851 #ifdef _LP64
2852   chk_off_X = gvn.transform(new ConvI2LNode(chk_off_X));
2853 #endif
2854   Node *p2 = gvn.transform(new AddPNode(subklass,subklass,chk_off_X));
2855   // For some types like interfaces the following loadKlass is from a 1-word
2856   // cache which is mutable so can&#39;t use immutable memory.  Other
2857   // types load from the super-class display table which is immutable.
2858   Node *kmem = C-&gt;immutable_memory();
2859   // secondary_super_cache is not immutable but can be treated as such because:
2860   // - no ideal node writes to it in a way that could cause an
2861   //   incorrect/missed optimization of the following Load.
2862   // - it&#39;s a cache so, worse case, not reading the latest value
2863   //   wouldn&#39;t cause incorrect execution
2864   if (might_be_cache &amp;&amp; mem != NULL) {
2865     kmem = mem-&gt;is_MergeMem() ? mem-&gt;as_MergeMem()-&gt;memory_at(C-&gt;get_alias_index(gvn.type(p2)-&gt;is_ptr())) : mem;
2866   }
2867   Node *nkls = gvn.transform(LoadKlassNode::make(gvn, NULL, kmem, p2, gvn.type(p2)-&gt;is_ptr(), TypeKlassPtr::OBJECT_OR_NULL));
2868 
2869   // Compile speed common case: ARE a subtype and we canNOT fail
2870   if( superklass == nkls )
2871     return C-&gt;top();             // false path is dead; no test needed.
2872 
2873   // See if we get an immediate positive hit.  Happens roughly 83% of the
2874   // time.  Test to see if the value loaded just previously from the subklass
2875   // is exactly the superklass.
2876   IfNode *iff1 = gen_subtype_check_compare(*ctrl, superklass, nkls, BoolTest::eq, PROB_LIKELY(0.83f), gvn, T_ADDRESS);
2877   Node *iftrue1 = gvn.transform( new IfTrueNode (iff1));
2878   *ctrl = gvn.transform(new IfFalseNode(iff1));
2879 
2880   // Compile speed common case: Check for being deterministic right now.  If
2881   // chk_off is a constant and not equal to cacheoff then we are NOT a
2882   // subklass.  In this case we need exactly the 1 test above and we can
2883   // return those results immediately.
2884   if (!might_be_cache) {
2885     Node* not_subtype_ctrl = *ctrl;
2886     *ctrl = iftrue1; // We need exactly the 1 test above
2887     return not_subtype_ctrl;
2888   }
2889 
2890   // Gather the various success &amp; failures here
2891   RegionNode *r_ok_subtype = new RegionNode(4);
2892   gvn.record_for_igvn(r_ok_subtype);
2893   RegionNode *r_not_subtype = new RegionNode(3);
2894   gvn.record_for_igvn(r_not_subtype);
2895 
2896   r_ok_subtype-&gt;init_req(1, iftrue1);
2897 
2898   // Check for immediate negative hit.  Happens roughly 11% of the time (which
2899   // is roughly 63% of the remaining cases).  Test to see if the loaded
2900   // check-offset points into the subklass display list or the 1-element
2901   // cache.  If it points to the display (and NOT the cache) and the display
2902   // missed then it&#39;s not a subtype.
2903   Node *cacheoff = gvn.intcon(cacheoff_con);
2904   IfNode *iff2 = gen_subtype_check_compare(*ctrl, chk_off, cacheoff, BoolTest::ne, PROB_LIKELY(0.63f), gvn, T_INT);
2905   r_not_subtype-&gt;init_req(1, gvn.transform(new IfTrueNode (iff2)));
2906   *ctrl = gvn.transform(new IfFalseNode(iff2));
2907 
2908   // Check for self.  Very rare to get here, but it is taken 1/3 the time.
2909   // No performance impact (too rare) but allows sharing of secondary arrays
2910   // which has some footprint reduction.
2911   IfNode *iff3 = gen_subtype_check_compare(*ctrl, subklass, superklass, BoolTest::eq, PROB_LIKELY(0.36f), gvn, T_ADDRESS);
2912   r_ok_subtype-&gt;init_req(2, gvn.transform(new IfTrueNode(iff3)));
2913   *ctrl = gvn.transform(new IfFalseNode(iff3));
2914 
2915   // -- Roads not taken here: --
2916   // We could also have chosen to perform the self-check at the beginning
2917   // of this code sequence, as the assembler does.  This would not pay off
2918   // the same way, since the optimizer, unlike the assembler, can perform
2919   // static type analysis to fold away many successful self-checks.
2920   // Non-foldable self checks work better here in second position, because
2921   // the initial primary superclass check subsumes a self-check for most
2922   // types.  An exception would be a secondary type like array-of-interface,
2923   // which does not appear in its own primary supertype display.
2924   // Finally, we could have chosen to move the self-check into the
2925   // PartialSubtypeCheckNode, and from there out-of-line in a platform
2926   // dependent manner.  But it is worthwhile to have the check here,
2927   // where it can be perhaps be optimized.  The cost in code space is
2928   // small (register compare, branch).
2929 
2930   // Now do a linear scan of the secondary super-klass array.  Again, no real
2931   // performance impact (too rare) but it&#39;s gotta be done.
2932   // Since the code is rarely used, there is no penalty for moving it
2933   // out of line, and it can only improve I-cache density.
2934   // The decision to inline or out-of-line this final check is platform
2935   // dependent, and is found in the AD file definition of PartialSubtypeCheck.
2936   Node* psc = gvn.transform(
2937     new PartialSubtypeCheckNode(*ctrl, subklass, superklass));
2938 
2939   IfNode *iff4 = gen_subtype_check_compare(*ctrl, psc, gvn.zerocon(T_OBJECT), BoolTest::ne, PROB_FAIR, gvn, T_ADDRESS);
2940   r_not_subtype-&gt;init_req(2, gvn.transform(new IfTrueNode (iff4)));
2941   r_ok_subtype -&gt;init_req(3, gvn.transform(new IfFalseNode(iff4)));
2942 
2943   // Return false path; set default control to true path.
2944   *ctrl = gvn.transform(r_ok_subtype);
2945   return gvn.transform(r_not_subtype);
2946 }
2947 
2948 Node* GraphKit::gen_subtype_check(Node* obj_or_subklass, Node* superklass) {
2949   if (ExpandSubTypeCheckAtParseTime) {
2950     MergeMemNode* mem = merged_memory();
2951     Node* ctrl = control();
2952     Node* subklass = obj_or_subklass;
2953     if (!_gvn.type(obj_or_subklass)-&gt;isa_klassptr()) {
2954       subklass = load_object_klass(obj_or_subklass);
2955     }
2956 
2957     Node* n = Phase::gen_subtype_check(subklass, superklass, &amp;ctrl, mem, _gvn);
2958     set_control(ctrl);
2959     return n;
2960   }
2961 
2962   const TypePtr* adr_type = TypeKlassPtr::make(TypePtr::NotNull, C-&gt;env()-&gt;Object_klass(), Type::OffsetBot);
2963   Node* check = _gvn.transform(new SubTypeCheckNode(C, obj_or_subklass, superklass));
2964   Node* bol = _gvn.transform(new BoolNode(check, BoolTest::eq));
2965   IfNode* iff = create_and_xform_if(control(), bol, PROB_STATIC_FREQUENT, COUNT_UNKNOWN);
2966   set_control(_gvn.transform(new IfTrueNode(iff)));
2967   return _gvn.transform(new IfFalseNode(iff));
2968 }
2969 
2970 // Profile-driven exact type check:
2971 Node* GraphKit::type_check_receiver(Node* receiver, ciKlass* klass,
2972                                     float prob,
2973                                     Node* *casted_receiver) {
2974   const TypeKlassPtr* tklass = TypeKlassPtr::make(klass);
2975   Node* recv_klass = load_object_klass(receiver);
2976   Node* want_klass = makecon(tklass);
2977   Node* cmp = _gvn.transform( new CmpPNode(recv_klass, want_klass) );
2978   Node* bol = _gvn.transform( new BoolNode(cmp, BoolTest::eq) );
2979   IfNode* iff = create_and_xform_if(control(), bol, prob, COUNT_UNKNOWN);
2980   set_control( _gvn.transform( new IfTrueNode (iff) ));
2981   Node* fail = _gvn.transform( new IfFalseNode(iff) );
2982 
2983   const TypeOopPtr* recv_xtype = tklass-&gt;as_instance_type();
2984   assert(recv_xtype-&gt;klass_is_exact(), &quot;&quot;);
2985 
2986   // Subsume downstream occurrences of receiver with a cast to
2987   // recv_xtype, since now we know what the type will be.
2988   Node* cast = new CheckCastPPNode(control(), receiver, recv_xtype);
2989   (*casted_receiver) = _gvn.transform(cast);
2990   // (User must make the replace_in_map call.)
2991 
2992   return fail;
2993 }
2994 
2995 //------------------------------subtype_check_receiver-------------------------
2996 Node* GraphKit::subtype_check_receiver(Node* receiver, ciKlass* klass,
2997                                        Node** casted_receiver) {
2998   const TypeKlassPtr* tklass = TypeKlassPtr::make(klass);
2999   Node* want_klass = makecon(tklass);
3000 
3001   Node* slow_ctl = gen_subtype_check(receiver, want_klass);
3002 
3003   // Cast receiver after successful check
3004   const TypeOopPtr* recv_type = tklass-&gt;cast_to_exactness(false)-&gt;is_klassptr()-&gt;as_instance_type();
3005   Node* cast = new CheckCastPPNode(control(), receiver, recv_type);
3006   (*casted_receiver) = _gvn.transform(cast);
3007 
3008   return slow_ctl;
3009 }
3010 
3011 //------------------------------seems_never_null-------------------------------
3012 // Use null_seen information if it is available from the profile.
3013 // If we see an unexpected null at a type check we record it and force a
3014 // recompile; the offending check will be recompiled to handle NULLs.
3015 // If we see several offending BCIs, then all checks in the
3016 // method will be recompiled.
3017 bool GraphKit::seems_never_null(Node* obj, ciProfileData* data, bool&amp; speculating) {
3018   speculating = !_gvn.type(obj)-&gt;speculative_maybe_null();
3019   Deoptimization::DeoptReason reason = Deoptimization::reason_null_check(speculating);
3020   if (UncommonNullCast               // Cutout for this technique
3021       &amp;&amp; obj != null()               // And not the -Xcomp stupid case?
3022       &amp;&amp; !too_many_traps(reason)
3023       ) {
3024     if (speculating) {
3025       return true;
3026     }
3027     if (data == NULL)
3028       // Edge case:  no mature data.  Be optimistic here.
3029       return true;
3030     // If the profile has not seen a null, assume it won&#39;t happen.
3031     assert(java_bc() == Bytecodes::_checkcast ||
3032            java_bc() == Bytecodes::_instanceof ||
3033            java_bc() == Bytecodes::_aastore, &quot;MDO must collect null_seen bit here&quot;);
3034     return !data-&gt;as_BitData()-&gt;null_seen();
3035   }
3036   speculating = false;
3037   return false;
3038 }
3039 
3040 void GraphKit::guard_klass_being_initialized(Node* klass) {
3041   int init_state_off = in_bytes(InstanceKlass::init_state_offset());
3042   Node* adr = basic_plus_adr(top(), klass, init_state_off);
3043   Node* init_state = LoadNode::make(_gvn, NULL, immutable_memory(), adr,
3044                                     adr-&gt;bottom_type()-&gt;is_ptr(), TypeInt::BYTE,
3045                                     T_BYTE, MemNode::unordered);
3046   init_state = _gvn.transform(init_state);
3047 
3048   Node* being_initialized_state = makecon(TypeInt::make(InstanceKlass::being_initialized));
3049 
3050   Node* chk = _gvn.transform(new CmpINode(being_initialized_state, init_state));
3051   Node* tst = _gvn.transform(new BoolNode(chk, BoolTest::eq));
3052 
3053   { BuildCutout unless(this, tst, PROB_MAX);
3054     uncommon_trap(Deoptimization::Reason_initialized, Deoptimization::Action_reinterpret);
3055   }
3056 }
3057 
3058 void GraphKit::guard_init_thread(Node* klass) {
3059   int init_thread_off = in_bytes(InstanceKlass::init_thread_offset());
3060   Node* adr = basic_plus_adr(top(), klass, init_thread_off);
3061 
3062   Node* init_thread = LoadNode::make(_gvn, NULL, immutable_memory(), adr,
3063                                      adr-&gt;bottom_type()-&gt;is_ptr(), TypePtr::NOTNULL,
3064                                      T_ADDRESS, MemNode::unordered);
3065   init_thread = _gvn.transform(init_thread);
3066 
3067   Node* cur_thread = _gvn.transform(new ThreadLocalNode());
3068 
3069   Node* chk = _gvn.transform(new CmpPNode(cur_thread, init_thread));
3070   Node* tst = _gvn.transform(new BoolNode(chk, BoolTest::eq));
3071 
3072   { BuildCutout unless(this, tst, PROB_MAX);
3073     uncommon_trap(Deoptimization::Reason_uninitialized, Deoptimization::Action_none);
3074   }
3075 }
3076 
3077 void GraphKit::clinit_barrier(ciInstanceKlass* ik, ciMethod* context) {
3078   if (ik-&gt;is_being_initialized()) {
3079     if (C-&gt;needs_clinit_barrier(ik, context)) {
3080       Node* klass = makecon(TypeKlassPtr::make(ik));
3081       guard_klass_being_initialized(klass);
3082       guard_init_thread(klass);
3083       insert_mem_bar(Op_MemBarCPUOrder);
3084     }
3085   } else if (ik-&gt;is_initialized()) {
3086     return; // no barrier needed
3087   } else {
3088     uncommon_trap(Deoptimization::Reason_uninitialized,
3089                   Deoptimization::Action_reinterpret,
3090                   NULL);
3091   }
3092 }
3093 
3094 //------------------------maybe_cast_profiled_receiver-------------------------
3095 // If the profile has seen exactly one type, narrow to exactly that type.
3096 // Subsequent type checks will always fold up.
3097 Node* GraphKit::maybe_cast_profiled_receiver(Node* not_null_obj,
3098                                              ciKlass* require_klass,
3099                                              ciKlass* spec_klass,
3100                                              bool safe_for_replace) {
3101   if (!UseTypeProfile || !TypeProfileCasts) return NULL;
3102 
3103   Deoptimization::DeoptReason reason = Deoptimization::reason_class_check(spec_klass != NULL);
3104 
3105   // Make sure we haven&#39;t already deoptimized from this tactic.
3106   if (too_many_traps_or_recompiles(reason))
3107     return NULL;
3108 
3109   // (No, this isn&#39;t a call, but it&#39;s enough like a virtual call
3110   // to use the same ciMethod accessor to get the profile info...)
3111   // If we have a speculative type use it instead of profiling (which
3112   // may not help us)
3113   ciKlass* exact_kls = spec_klass == NULL ? profile_has_unique_klass() : spec_klass;
3114   if (exact_kls != NULL) {// no cast failures here
3115     if (require_klass == NULL ||
3116         C-&gt;static_subtype_check(require_klass, exact_kls) == Compile::SSC_always_true) {
3117       // If we narrow the type to match what the type profile sees or
3118       // the speculative type, we can then remove the rest of the
3119       // cast.
3120       // This is a win, even if the exact_kls is very specific,
3121       // because downstream operations, such as method calls,
3122       // will often benefit from the sharper type.
3123       Node* exact_obj = not_null_obj; // will get updated in place...
3124       Node* slow_ctl  = type_check_receiver(exact_obj, exact_kls, 1.0,
3125                                             &amp;exact_obj);
3126       { PreserveJVMState pjvms(this);
3127         set_control(slow_ctl);
3128         uncommon_trap_exact(reason, Deoptimization::Action_maybe_recompile);
3129       }
3130       if (safe_for_replace) {
3131         replace_in_map(not_null_obj, exact_obj);
3132       }
3133       return exact_obj;
3134     }
3135     // assert(ssc == Compile::SSC_always_true)... except maybe the profile lied to us.
3136   }
3137 
3138   return NULL;
3139 }
3140 
3141 /**
3142  * Cast obj to type and emit guard unless we had too many traps here
3143  * already
3144  *
3145  * @param obj       node being casted
3146  * @param type      type to cast the node to
3147  * @param not_null  true if we know node cannot be null
3148  */
3149 Node* GraphKit::maybe_cast_profiled_obj(Node* obj,
3150                                         ciKlass* type,
3151                                         bool not_null) {
3152   if (stopped()) {
3153     return obj;
3154   }
3155 
3156   // type == NULL if profiling tells us this object is always null
3157   if (type != NULL) {
3158     Deoptimization::DeoptReason class_reason = Deoptimization::Reason_speculate_class_check;
3159     Deoptimization::DeoptReason null_reason = Deoptimization::Reason_speculate_null_check;
3160 
3161     if (!too_many_traps_or_recompiles(null_reason) &amp;&amp;
3162         !too_many_traps_or_recompiles(class_reason)) {
3163       Node* not_null_obj = NULL;
3164       // not_null is true if we know the object is not null and
3165       // there&#39;s no need for a null check
3166       if (!not_null) {
3167         Node* null_ctl = top();
3168         not_null_obj = null_check_oop(obj, &amp;null_ctl, true, true, true);
3169         assert(null_ctl-&gt;is_top(), &quot;no null control here&quot;);
3170       } else {
3171         not_null_obj = obj;
3172       }
3173 
3174       Node* exact_obj = not_null_obj;
3175       ciKlass* exact_kls = type;
3176       Node* slow_ctl  = type_check_receiver(exact_obj, exact_kls, 1.0,
3177                                             &amp;exact_obj);
3178       {
3179         PreserveJVMState pjvms(this);
3180         set_control(slow_ctl);
3181         uncommon_trap_exact(class_reason, Deoptimization::Action_maybe_recompile);
3182       }
3183       replace_in_map(not_null_obj, exact_obj);
3184       obj = exact_obj;
3185     }
3186   } else {
3187     if (!too_many_traps_or_recompiles(Deoptimization::Reason_null_assert)) {
3188       Node* exact_obj = null_assert(obj);
3189       replace_in_map(obj, exact_obj);
3190       obj = exact_obj;
3191     }
3192   }
3193   return obj;
3194 }
3195 
3196 //-------------------------------gen_instanceof--------------------------------
3197 // Generate an instance-of idiom.  Used by both the instance-of bytecode
3198 // and the reflective instance-of call.
3199 Node* GraphKit::gen_instanceof(Node* obj, Node* superklass, bool safe_for_replace) {
3200   kill_dead_locals();           // Benefit all the uncommon traps
3201   assert( !stopped(), &quot;dead parse path should be checked in callers&quot; );
3202   assert(!TypePtr::NULL_PTR-&gt;higher_equal(_gvn.type(superklass)-&gt;is_klassptr()),
3203          &quot;must check for not-null not-dead klass in callers&quot;);
3204 
3205   // Make the merge point
3206   enum { _obj_path = 1, _fail_path, _null_path, PATH_LIMIT };
3207   RegionNode* region = new RegionNode(PATH_LIMIT);
3208   Node*       phi    = new PhiNode(region, TypeInt::BOOL);
3209   C-&gt;set_has_split_ifs(true); // Has chance for split-if optimization
3210 
3211   ciProfileData* data = NULL;
3212   if (java_bc() == Bytecodes::_instanceof) {  // Only for the bytecode
3213     data = method()-&gt;method_data()-&gt;bci_to_data(bci());
3214   }
3215   bool speculative_not_null = false;
3216   bool never_see_null = (ProfileDynamicTypes  // aggressive use of profile
3217                          &amp;&amp; seems_never_null(obj, data, speculative_not_null));
3218 
3219   // Null check; get casted pointer; set region slot 3
3220   Node* null_ctl = top();
3221   Node* not_null_obj = null_check_oop(obj, &amp;null_ctl, never_see_null, safe_for_replace, speculative_not_null);
3222 
3223   // If not_null_obj is dead, only null-path is taken
3224   if (stopped()) {              // Doing instance-of on a NULL?
3225     set_control(null_ctl);
3226     return intcon(0);
3227   }
3228   region-&gt;init_req(_null_path, null_ctl);
3229   phi   -&gt;init_req(_null_path, intcon(0)); // Set null path value
3230   if (null_ctl == top()) {
3231     // Do this eagerly, so that pattern matches like is_diamond_phi
3232     // will work even during parsing.
3233     assert(_null_path == PATH_LIMIT-1, &quot;delete last&quot;);
3234     region-&gt;del_req(_null_path);
3235     phi   -&gt;del_req(_null_path);
3236   }
3237 
3238   // Do we know the type check always succeed?
3239   bool known_statically = false;
3240   if (_gvn.type(superklass)-&gt;singleton()) {
3241     ciKlass* superk = _gvn.type(superklass)-&gt;is_klassptr()-&gt;klass();
3242     ciKlass* subk = _gvn.type(obj)-&gt;is_oopptr()-&gt;klass();
3243     if (subk != NULL &amp;&amp; subk-&gt;is_loaded()) {
3244       int static_res = C-&gt;static_subtype_check(superk, subk);
3245       known_statically = (static_res == Compile::SSC_always_true || static_res == Compile::SSC_always_false);
3246     }
3247   }
3248 
3249   if (!known_statically) {
3250     const TypeOopPtr* obj_type = _gvn.type(obj)-&gt;is_oopptr();
3251     // We may not have profiling here or it may not help us. If we
3252     // have a speculative type use it to perform an exact cast.
3253     ciKlass* spec_obj_type = obj_type-&gt;speculative_type();
3254     if (spec_obj_type != NULL || (ProfileDynamicTypes &amp;&amp; data != NULL)) {
3255       Node* cast_obj = maybe_cast_profiled_receiver(not_null_obj, NULL, spec_obj_type, safe_for_replace);
3256       if (stopped()) {            // Profile disagrees with this path.
3257         set_control(null_ctl);    // Null is the only remaining possibility.
3258         return intcon(0);
3259       }
3260       if (cast_obj != NULL) {
3261         not_null_obj = cast_obj;
3262       }
3263     }
3264   }
3265 
3266   // Generate the subtype check
3267   Node* not_subtype_ctrl = gen_subtype_check(not_null_obj, superklass);
3268 
3269   // Plug in the success path to the general merge in slot 1.
3270   region-&gt;init_req(_obj_path, control());
3271   phi   -&gt;init_req(_obj_path, intcon(1));
3272 
3273   // Plug in the failing path to the general merge in slot 2.
3274   region-&gt;init_req(_fail_path, not_subtype_ctrl);
3275   phi   -&gt;init_req(_fail_path, intcon(0));
3276 
3277   // Return final merged results
3278   set_control( _gvn.transform(region) );
3279   record_for_igvn(region);
3280 
3281   // If we know the type check always succeeds then we don&#39;t use the
3282   // profiling data at this bytecode. Don&#39;t lose it, feed it to the
3283   // type system as a speculative type.
3284   if (safe_for_replace) {
3285     Node* casted_obj = record_profiled_receiver_for_speculation(obj);
3286     replace_in_map(obj, casted_obj);
3287   }
3288 
3289   return _gvn.transform(phi);
3290 }
3291 
3292 //-------------------------------gen_checkcast---------------------------------
3293 // Generate a checkcast idiom.  Used by both the checkcast bytecode and the
3294 // array store bytecode.  Stack must be as-if BEFORE doing the bytecode so the
3295 // uncommon-trap paths work.  Adjust stack after this call.
3296 // If failure_control is supplied and not null, it is filled in with
3297 // the control edge for the cast failure.  Otherwise, an appropriate
3298 // uncommon trap or exception is thrown.
3299 Node* GraphKit::gen_checkcast(Node *obj, Node* superklass,
3300                               Node* *failure_control) {
3301   kill_dead_locals();           // Benefit all the uncommon traps
3302   const TypeKlassPtr *tk = _gvn.type(superklass)-&gt;is_klassptr();
3303   const Type *toop = TypeOopPtr::make_from_klass(tk-&gt;klass());
3304 
3305   // Fast cutout:  Check the case that the cast is vacuously true.
3306   // This detects the common cases where the test will short-circuit
3307   // away completely.  We do this before we perform the null check,
3308   // because if the test is going to turn into zero code, we don&#39;t
3309   // want a residual null check left around.  (Causes a slowdown,
3310   // for example, in some objArray manipulations, such as a[i]=a[j].)
3311   if (tk-&gt;singleton()) {
3312     const TypeOopPtr* objtp = _gvn.type(obj)-&gt;isa_oopptr();
3313     if (objtp != NULL &amp;&amp; objtp-&gt;klass() != NULL) {
3314       switch (C-&gt;static_subtype_check(tk-&gt;klass(), objtp-&gt;klass())) {
3315       case Compile::SSC_always_true:
3316         // If we know the type check always succeed then we don&#39;t use
3317         // the profiling data at this bytecode. Don&#39;t lose it, feed it
3318         // to the type system as a speculative type.
3319         return record_profiled_receiver_for_speculation(obj);
3320       case Compile::SSC_always_false:
3321         // It needs a null check because a null will *pass* the cast check.
3322         // A non-null value will always produce an exception.
3323         return null_assert(obj);
3324       }
3325     }
3326   }
3327 
3328   ciProfileData* data = NULL;
3329   bool safe_for_replace = false;
3330   if (failure_control == NULL) {        // use MDO in regular case only
3331     assert(java_bc() == Bytecodes::_aastore ||
3332            java_bc() == Bytecodes::_checkcast,
3333            &quot;interpreter profiles type checks only for these BCs&quot;);
3334     data = method()-&gt;method_data()-&gt;bci_to_data(bci());
3335     safe_for_replace = true;
3336   }
3337 
3338   // Make the merge point
3339   enum { _obj_path = 1, _null_path, PATH_LIMIT };
3340   RegionNode* region = new RegionNode(PATH_LIMIT);
3341   Node*       phi    = new PhiNode(region, toop);
3342   C-&gt;set_has_split_ifs(true); // Has chance for split-if optimization
3343 
3344   // Use null-cast information if it is available
3345   bool speculative_not_null = false;
3346   bool never_see_null = ((failure_control == NULL)  // regular case only
3347                          &amp;&amp; seems_never_null(obj, data, speculative_not_null));
3348 
3349   // Null check; get casted pointer; set region slot 3
3350   Node* null_ctl = top();
3351   Node* not_null_obj = null_check_oop(obj, &amp;null_ctl, never_see_null, safe_for_replace, speculative_not_null);
3352 
3353   // If not_null_obj is dead, only null-path is taken
3354   if (stopped()) {              // Doing instance-of on a NULL?
3355     set_control(null_ctl);
3356     return null();
3357   }
3358   region-&gt;init_req(_null_path, null_ctl);
3359   phi   -&gt;init_req(_null_path, null());  // Set null path value
3360   if (null_ctl == top()) {
3361     // Do this eagerly, so that pattern matches like is_diamond_phi
3362     // will work even during parsing.
3363     assert(_null_path == PATH_LIMIT-1, &quot;delete last&quot;);
3364     region-&gt;del_req(_null_path);
3365     phi   -&gt;del_req(_null_path);
3366   }
3367 
3368   Node* cast_obj = NULL;
3369   if (tk-&gt;klass_is_exact()) {
3370     // The following optimization tries to statically cast the speculative type of the object
3371     // (for example obtained during profiling) to the type of the superklass and then do a
3372     // dynamic check that the type of the object is what we expect. To work correctly
3373     // for checkcast and aastore the type of superklass should be exact.
3374     const TypeOopPtr* obj_type = _gvn.type(obj)-&gt;is_oopptr();
3375     // We may not have profiling here or it may not help us. If we have
3376     // a speculative type use it to perform an exact cast.
3377     ciKlass* spec_obj_type = obj_type-&gt;speculative_type();
3378     if (spec_obj_type != NULL || data != NULL) {
3379       cast_obj = maybe_cast_profiled_receiver(not_null_obj, tk-&gt;klass(), spec_obj_type, safe_for_replace);
3380       if (cast_obj != NULL) {
3381         if (failure_control != NULL) // failure is now impossible
3382           (*failure_control) = top();
3383         // adjust the type of the phi to the exact klass:
3384         phi-&gt;raise_bottom_type(_gvn.type(cast_obj)-&gt;meet_speculative(TypePtr::NULL_PTR));
3385       }
3386     }
3387   }
3388 
3389   if (cast_obj == NULL) {
3390     // Generate the subtype check
3391     Node* not_subtype_ctrl = gen_subtype_check(not_null_obj, superklass );
3392 
3393     // Plug in success path into the merge
3394     cast_obj = _gvn.transform(new CheckCastPPNode(control(), not_null_obj, toop));
3395     // Failure path ends in uncommon trap (or may be dead - failure impossible)
3396     if (failure_control == NULL) {
3397       if (not_subtype_ctrl != top()) { // If failure is possible
3398         PreserveJVMState pjvms(this);
3399         set_control(not_subtype_ctrl);
3400         builtin_throw(Deoptimization::Reason_class_check, load_object_klass(not_null_obj));
3401       }
3402     } else {
3403       (*failure_control) = not_subtype_ctrl;
3404     }
3405   }
3406 
3407   region-&gt;init_req(_obj_path, control());
3408   phi   -&gt;init_req(_obj_path, cast_obj);
3409 
3410   // A merge of NULL or Casted-NotNull obj
3411   Node* res = _gvn.transform(phi);
3412 
3413   // Note I do NOT always &#39;replace_in_map(obj,result)&#39; here.
3414   //  if( tk-&gt;klass()-&gt;can_be_primary_super()  )
3415     // This means that if I successfully store an Object into an array-of-String
3416     // I &#39;forget&#39; that the Object is really now known to be a String.  I have to
3417     // do this because we don&#39;t have true union types for interfaces - if I store
3418     // a Baz into an array-of-Interface and then tell the optimizer it&#39;s an
3419     // Interface, I forget that it&#39;s also a Baz and cannot do Baz-like field
3420     // references to it.  FIX THIS WHEN UNION TYPES APPEAR!
3421   //  replace_in_map( obj, res );
3422 
3423   // Return final merged results
3424   set_control( _gvn.transform(region) );
3425   record_for_igvn(region);
3426 
3427   return record_profiled_receiver_for_speculation(res);
3428 }
3429 
3430 //------------------------------next_monitor-----------------------------------
3431 // What number should be given to the next monitor?
3432 int GraphKit::next_monitor() {
3433   int current = jvms()-&gt;monitor_depth()* C-&gt;sync_stack_slots();
3434   int next = current + C-&gt;sync_stack_slots();
3435   // Keep the toplevel high water mark current:
3436   if (C-&gt;fixed_slots() &lt; next)  C-&gt;set_fixed_slots(next);
3437   return current;
3438 }
3439 
3440 //------------------------------insert_mem_bar---------------------------------
3441 // Memory barrier to avoid floating things around
3442 // The membar serves as a pinch point between both control and all memory slices.
3443 Node* GraphKit::insert_mem_bar(int opcode, Node* precedent) {
3444   MemBarNode* mb = MemBarNode::make(C, opcode, Compile::AliasIdxBot, precedent);
3445   mb-&gt;init_req(TypeFunc::Control, control());
3446   mb-&gt;init_req(TypeFunc::Memory,  reset_memory());
3447   Node* membar = _gvn.transform(mb);
3448   set_control(_gvn.transform(new ProjNode(membar, TypeFunc::Control)));
3449   set_all_memory_call(membar);
3450   return membar;
3451 }
3452 
3453 //-------------------------insert_mem_bar_volatile----------------------------
3454 // Memory barrier to avoid floating things around
3455 // The membar serves as a pinch point between both control and memory(alias_idx).
3456 // If you want to make a pinch point on all memory slices, do not use this
3457 // function (even with AliasIdxBot); use insert_mem_bar() instead.
3458 Node* GraphKit::insert_mem_bar_volatile(int opcode, int alias_idx, Node* precedent) {
3459   // When Parse::do_put_xxx updates a volatile field, it appends a series
3460   // of MemBarVolatile nodes, one for *each* volatile field alias category.
3461   // The first membar is on the same memory slice as the field store opcode.
3462   // This forces the membar to follow the store.  (Bug 6500685 broke this.)
3463   // All the other membars (for other volatile slices, including AliasIdxBot,
3464   // which stands for all unknown volatile slices) are control-dependent
3465   // on the first membar.  This prevents later volatile loads or stores
3466   // from sliding up past the just-emitted store.
3467 
3468   MemBarNode* mb = MemBarNode::make(C, opcode, alias_idx, precedent);
3469   mb-&gt;set_req(TypeFunc::Control,control());
3470   if (alias_idx == Compile::AliasIdxBot) {
3471     mb-&gt;set_req(TypeFunc::Memory, merged_memory()-&gt;base_memory());
3472   } else {
3473     assert(!(opcode == Op_Initialize &amp;&amp; alias_idx != Compile::AliasIdxRaw), &quot;fix caller&quot;);
3474     mb-&gt;set_req(TypeFunc::Memory, memory(alias_idx));
3475   }
3476   Node* membar = _gvn.transform(mb);
3477   set_control(_gvn.transform(new ProjNode(membar, TypeFunc::Control)));
3478   if (alias_idx == Compile::AliasIdxBot) {
3479     merged_memory()-&gt;set_base_memory(_gvn.transform(new ProjNode(membar, TypeFunc::Memory)));
3480   } else {
3481     set_memory(_gvn.transform(new ProjNode(membar, TypeFunc::Memory)),alias_idx);
3482   }
3483   return membar;
3484 }
3485 
3486 //------------------------------shared_lock------------------------------------
3487 // Emit locking code.
3488 FastLockNode* GraphKit::shared_lock(Node* obj) {
3489   // bci is either a monitorenter bc or InvocationEntryBci
3490   // %%% SynchronizationEntryBCI is redundant; use InvocationEntryBci in interfaces
3491   assert(SynchronizationEntryBCI == InvocationEntryBci, &quot;&quot;);
3492 
3493   if( !GenerateSynchronizationCode )
3494     return NULL;                // Not locking things?
3495   if (stopped())                // Dead monitor?
3496     return NULL;
3497 
3498   assert(dead_locals_are_killed(), &quot;should kill locals before sync. point&quot;);
3499 
3500   // Box the stack location
3501   Node* box = _gvn.transform(new BoxLockNode(next_monitor()));
3502   Node* mem = reset_memory();
3503 
3504   FastLockNode * flock = _gvn.transform(new FastLockNode(0, obj, box) )-&gt;as_FastLock();
3505   if (UseBiasedLocking &amp;&amp; PrintPreciseBiasedLockingStatistics) {
3506     // Create the counters for this fast lock.
3507     flock-&gt;create_lock_counter(sync_jvms()); // sync_jvms used to get current bci
3508   }
3509 
3510   // Create the rtm counters for this fast lock if needed.
3511   flock-&gt;create_rtm_lock_counter(sync_jvms()); // sync_jvms used to get current bci
3512 
3513   // Add monitor to debug info for the slow path.  If we block inside the
3514   // slow path and de-opt, we need the monitor hanging around
3515   map()-&gt;push_monitor( flock );
3516 
3517   const TypeFunc *tf = LockNode::lock_type();
3518   LockNode *lock = new LockNode(C, tf);
3519 
3520   lock-&gt;init_req( TypeFunc::Control, control() );
3521   lock-&gt;init_req( TypeFunc::Memory , mem );
3522   lock-&gt;init_req( TypeFunc::I_O    , top() )     ;   // does no i/o
3523   lock-&gt;init_req( TypeFunc::FramePtr, frameptr() );
3524   lock-&gt;init_req( TypeFunc::ReturnAdr, top() );
3525 
3526   lock-&gt;init_req(TypeFunc::Parms + 0, obj);
3527   lock-&gt;init_req(TypeFunc::Parms + 1, box);
3528   lock-&gt;init_req(TypeFunc::Parms + 2, flock);
3529   add_safepoint_edges(lock);
3530 
3531   lock = _gvn.transform( lock )-&gt;as_Lock();
3532 
3533   // lock has no side-effects, sets few values
3534   set_predefined_output_for_runtime_call(lock, mem, TypeRawPtr::BOTTOM);
3535 
3536   insert_mem_bar(Op_MemBarAcquireLock);
3537 
3538   // Add this to the worklist so that the lock can be eliminated
3539   record_for_igvn(lock);
3540 
3541 #ifndef PRODUCT
3542   if (PrintLockStatistics) {
3543     // Update the counter for this lock.  Don&#39;t bother using an atomic
3544     // operation since we don&#39;t require absolute accuracy.
3545     lock-&gt;create_lock_counter(map()-&gt;jvms());
3546     increment_counter(lock-&gt;counter()-&gt;addr());
3547   }
3548 #endif
3549 
3550   return flock;
3551 }
3552 
3553 
3554 //------------------------------shared_unlock----------------------------------
3555 // Emit unlocking code.
3556 void GraphKit::shared_unlock(Node* box, Node* obj) {
3557   // bci is either a monitorenter bc or InvocationEntryBci
3558   // %%% SynchronizationEntryBCI is redundant; use InvocationEntryBci in interfaces
3559   assert(SynchronizationEntryBCI == InvocationEntryBci, &quot;&quot;);
3560 
3561   if( !GenerateSynchronizationCode )
3562     return;
3563   if (stopped()) {               // Dead monitor?
3564     map()-&gt;pop_monitor();        // Kill monitor from debug info
3565     return;
3566   }
3567 
3568   // Memory barrier to avoid floating things down past the locked region
3569   insert_mem_bar(Op_MemBarReleaseLock);
3570 
3571   const TypeFunc *tf = OptoRuntime::complete_monitor_exit_Type();
3572   UnlockNode *unlock = new UnlockNode(C, tf);
3573 #ifdef ASSERT
3574   unlock-&gt;set_dbg_jvms(sync_jvms());
3575 #endif
3576   uint raw_idx = Compile::AliasIdxRaw;
3577   unlock-&gt;init_req( TypeFunc::Control, control() );
3578   unlock-&gt;init_req( TypeFunc::Memory , memory(raw_idx) );
3579   unlock-&gt;init_req( TypeFunc::I_O    , top() )     ;   // does no i/o
3580   unlock-&gt;init_req( TypeFunc::FramePtr, frameptr() );
3581   unlock-&gt;init_req( TypeFunc::ReturnAdr, top() );
3582 
3583   unlock-&gt;init_req(TypeFunc::Parms + 0, obj);
3584   unlock-&gt;init_req(TypeFunc::Parms + 1, box);
3585   unlock = _gvn.transform(unlock)-&gt;as_Unlock();
3586 
3587   Node* mem = reset_memory();
3588 
3589   // unlock has no side-effects, sets few values
3590   set_predefined_output_for_runtime_call(unlock, mem, TypeRawPtr::BOTTOM);
3591 
3592   // Kill monitor from debug info
3593   map()-&gt;pop_monitor( );
3594 }
3595 
3596 //-------------------------------get_layout_helper-----------------------------
3597 // If the given klass is a constant or known to be an array,
3598 // fetch the constant layout helper value into constant_value
3599 // and return (Node*)NULL.  Otherwise, load the non-constant
3600 // layout helper value, and return the node which represents it.
3601 // This two-faced routine is useful because allocation sites
3602 // almost always feature constant types.
3603 Node* GraphKit::get_layout_helper(Node* klass_node, jint&amp; constant_value) {
3604   const TypeKlassPtr* inst_klass = _gvn.type(klass_node)-&gt;isa_klassptr();
3605   if (!StressReflectiveCode &amp;&amp; inst_klass != NULL) {
3606     ciKlass* klass = inst_klass-&gt;klass();
3607     bool    xklass = inst_klass-&gt;klass_is_exact();
3608     if (xklass || klass-&gt;is_array_klass()) {
3609       jint lhelper = klass-&gt;layout_helper();
3610       if (lhelper != Klass::_lh_neutral_value) {
3611         constant_value = lhelper;
3612         return (Node*) NULL;
3613       }
3614     }
3615   }
3616   constant_value = Klass::_lh_neutral_value;  // put in a known value
3617   Node* lhp = basic_plus_adr(klass_node, klass_node, in_bytes(Klass::layout_helper_offset()));
3618   return make_load(NULL, lhp, TypeInt::INT, T_INT, MemNode::unordered);
3619 }
3620 
3621 // We just put in an allocate/initialize with a big raw-memory effect.
3622 // Hook selected additional alias categories on the initialization.
3623 static void hook_memory_on_init(GraphKit&amp; kit, int alias_idx,
3624                                 MergeMemNode* init_in_merge,
3625                                 Node* init_out_raw) {
3626   DEBUG_ONLY(Node* init_in_raw = init_in_merge-&gt;base_memory());
3627   assert(init_in_merge-&gt;memory_at(alias_idx) == init_in_raw, &quot;&quot;);
3628 
3629   Node* prevmem = kit.memory(alias_idx);
3630   init_in_merge-&gt;set_memory_at(alias_idx, prevmem);
3631   kit.set_memory(init_out_raw, alias_idx);
3632 }
3633 
3634 //---------------------------set_output_for_allocation-------------------------
3635 Node* GraphKit::set_output_for_allocation(AllocateNode* alloc,
3636                                           const TypeOopPtr* oop_type,
3637                                           bool deoptimize_on_exception) {
3638   int rawidx = Compile::AliasIdxRaw;
3639   alloc-&gt;set_req( TypeFunc::FramePtr, frameptr() );
3640   add_safepoint_edges(alloc);
3641   Node* allocx = _gvn.transform(alloc);
3642   set_control( _gvn.transform(new ProjNode(allocx, TypeFunc::Control) ) );
3643   // create memory projection for i_o
3644   set_memory ( _gvn.transform( new ProjNode(allocx, TypeFunc::Memory, true) ), rawidx );
3645   make_slow_call_ex(allocx, env()-&gt;Throwable_klass(), true, deoptimize_on_exception);
3646 
3647   // create a memory projection as for the normal control path
3648   Node* malloc = _gvn.transform(new ProjNode(allocx, TypeFunc::Memory));
3649   set_memory(malloc, rawidx);
3650 
3651   // a normal slow-call doesn&#39;t change i_o, but an allocation does
3652   // we create a separate i_o projection for the normal control path
3653   set_i_o(_gvn.transform( new ProjNode(allocx, TypeFunc::I_O, false) ) );
3654   Node* rawoop = _gvn.transform( new ProjNode(allocx, TypeFunc::Parms) );
3655 
3656   // put in an initialization barrier
3657   InitializeNode* init = insert_mem_bar_volatile(Op_Initialize, rawidx,
3658                                                  rawoop)-&gt;as_Initialize();
3659   assert(alloc-&gt;initialization() == init,  &quot;2-way macro link must work&quot;);
3660   assert(init -&gt;allocation()     == alloc, &quot;2-way macro link must work&quot;);
3661   {
3662     // Extract memory strands which may participate in the new object&#39;s
3663     // initialization, and source them from the new InitializeNode.
3664     // This will allow us to observe initializations when they occur,
3665     // and link them properly (as a group) to the InitializeNode.
3666     assert(init-&gt;in(InitializeNode::Memory) == malloc, &quot;&quot;);
3667     MergeMemNode* minit_in = MergeMemNode::make(malloc);
3668     init-&gt;set_req(InitializeNode::Memory, minit_in);
3669     record_for_igvn(minit_in); // fold it up later, if possible
3670     Node* minit_out = memory(rawidx);
3671     assert(minit_out-&gt;is_Proj() &amp;&amp; minit_out-&gt;in(0) == init, &quot;&quot;);
3672     // Add an edge in the MergeMem for the header fields so an access
3673     // to one of those has correct memory state
3674     set_memory(minit_out, C-&gt;get_alias_index(oop_type-&gt;add_offset(oopDesc::mark_offset_in_bytes())));
3675     set_memory(minit_out, C-&gt;get_alias_index(oop_type-&gt;add_offset(oopDesc::klass_offset_in_bytes())));
3676     if (oop_type-&gt;isa_aryptr()) {
3677       const TypePtr* telemref = oop_type-&gt;add_offset(Type::OffsetBot);
3678       int            elemidx  = C-&gt;get_alias_index(telemref);
3679       hook_memory_on_init(*this, elemidx, minit_in, minit_out);
3680     } else if (oop_type-&gt;isa_instptr()) {
3681       ciInstanceKlass* ik = oop_type-&gt;klass()-&gt;as_instance_klass();
3682       for (int i = 0, len = ik-&gt;nof_nonstatic_fields(); i &lt; len; i++) {
3683         ciField* field = ik-&gt;nonstatic_field_at(i);
3684         if (field-&gt;offset() &gt;= TrackedInitializationLimit * HeapWordSize)
3685           continue;  // do not bother to track really large numbers of fields
3686         // Find (or create) the alias category for this field:
3687         int fieldidx = C-&gt;alias_type(field)-&gt;index();
3688         hook_memory_on_init(*this, fieldidx, minit_in, minit_out);
3689       }
3690     }
3691   }
3692 
3693   // Cast raw oop to the real thing...
3694   Node* javaoop = new CheckCastPPNode(control(), rawoop, oop_type);
3695   javaoop = _gvn.transform(javaoop);
3696   C-&gt;set_recent_alloc(control(), javaoop);
3697   assert(just_allocated_object(control()) == javaoop, &quot;just allocated&quot;);
3698 
3699 #ifdef ASSERT
3700   { // Verify that the AllocateNode::Ideal_allocation recognizers work:
3701     assert(AllocateNode::Ideal_allocation(rawoop, &amp;_gvn) == alloc,
3702            &quot;Ideal_allocation works&quot;);
3703     assert(AllocateNode::Ideal_allocation(javaoop, &amp;_gvn) == alloc,
3704            &quot;Ideal_allocation works&quot;);
3705     if (alloc-&gt;is_AllocateArray()) {
3706       assert(AllocateArrayNode::Ideal_array_allocation(rawoop, &amp;_gvn) == alloc-&gt;as_AllocateArray(),
3707              &quot;Ideal_allocation works&quot;);
3708       assert(AllocateArrayNode::Ideal_array_allocation(javaoop, &amp;_gvn) == alloc-&gt;as_AllocateArray(),
3709              &quot;Ideal_allocation works&quot;);
3710     } else {
3711       assert(alloc-&gt;in(AllocateNode::ALength)-&gt;is_top(), &quot;no length, please&quot;);
3712     }
3713   }
3714 #endif //ASSERT
3715 
3716   return javaoop;
3717 }
3718 
3719 //---------------------------new_instance--------------------------------------
3720 // This routine takes a klass_node which may be constant (for a static type)
3721 // or may be non-constant (for reflective code).  It will work equally well
3722 // for either, and the graph will fold nicely if the optimizer later reduces
3723 // the type to a constant.
3724 // The optional arguments are for specialized use by intrinsics:
3725 //  - If &#39;extra_slow_test&#39; if not null is an extra condition for the slow-path.
3726 //  - If &#39;return_size_val&#39;, report the the total object size to the caller.
3727 //  - deoptimize_on_exception controls how Java exceptions are handled (rethrow vs deoptimize)
3728 Node* GraphKit::new_instance(Node* klass_node,
3729                              Node* extra_slow_test,
3730                              Node* *return_size_val,
3731                              bool deoptimize_on_exception) {
3732   // Compute size in doublewords
3733   // The size is always an integral number of doublewords, represented
3734   // as a positive bytewise size stored in the klass&#39;s layout_helper.
3735   // The layout_helper also encodes (in a low bit) the need for a slow path.
3736   jint  layout_con = Klass::_lh_neutral_value;
3737   Node* layout_val = get_layout_helper(klass_node, layout_con);
3738   int   layout_is_con = (layout_val == NULL);
3739 
3740   if (extra_slow_test == NULL)  extra_slow_test = intcon(0);
3741   // Generate the initial go-slow test.  It&#39;s either ALWAYS (return a
3742   // Node for 1) or NEVER (return a NULL) or perhaps (in the reflective
3743   // case) a computed value derived from the layout_helper.
3744   Node* initial_slow_test = NULL;
3745   if (layout_is_con) {
3746     assert(!StressReflectiveCode, &quot;stress mode does not use these paths&quot;);
3747     bool must_go_slow = Klass::layout_helper_needs_slow_path(layout_con);
3748     initial_slow_test = must_go_slow ? intcon(1) : extra_slow_test;
3749   } else {   // reflective case
3750     // This reflective path is used by Unsafe.allocateInstance.
3751     // (It may be stress-tested by specifying StressReflectiveCode.)
3752     // Basically, we want to get into the VM is there&#39;s an illegal argument.
3753     Node* bit = intcon(Klass::_lh_instance_slow_path_bit);
3754     initial_slow_test = _gvn.transform( new AndINode(layout_val, bit) );
3755     if (extra_slow_test != intcon(0)) {
3756       initial_slow_test = _gvn.transform( new OrINode(initial_slow_test, extra_slow_test) );
3757     }
3758     // (Macro-expander will further convert this to a Bool, if necessary.)
3759   }
3760 
3761   // Find the size in bytes.  This is easy; it&#39;s the layout_helper.
3762   // The size value must be valid even if the slow path is taken.
3763   Node* size = NULL;
3764   if (layout_is_con) {
3765     size = MakeConX(Klass::layout_helper_size_in_bytes(layout_con));
3766   } else {   // reflective case
3767     // This reflective path is used by clone and Unsafe.allocateInstance.
3768     size = ConvI2X(layout_val);
3769 
3770     // Clear the low bits to extract layout_helper_size_in_bytes:
3771     assert((int)Klass::_lh_instance_slow_path_bit &lt; BytesPerLong, &quot;clear bit&quot;);
3772     Node* mask = MakeConX(~ (intptr_t)right_n_bits(LogBytesPerLong));
3773     size = _gvn.transform( new AndXNode(size, mask) );
3774   }
3775   if (return_size_val != NULL) {
3776     (*return_size_val) = size;
3777   }
3778 
3779   // This is a precise notnull oop of the klass.
3780   // (Actually, it need not be precise if this is a reflective allocation.)
3781   // It&#39;s what we cast the result to.
3782   const TypeKlassPtr* tklass = _gvn.type(klass_node)-&gt;isa_klassptr();
3783   if (!tklass)  tklass = TypeKlassPtr::OBJECT;
3784   const TypeOopPtr* oop_type = tklass-&gt;as_instance_type();
3785 
3786   // Now generate allocation code
3787 
3788   // The entire memory state is needed for slow path of the allocation
3789   // since GC and deoptimization can happened.
3790   Node *mem = reset_memory();
3791   set_all_memory(mem); // Create new memory state
3792 
3793   AllocateNode* alloc = new AllocateNode(C, AllocateNode::alloc_type(Type::TOP),
3794                                          control(), mem, i_o(),
3795                                          size, klass_node,
3796                                          initial_slow_test);
3797 
3798   return set_output_for_allocation(alloc, oop_type, deoptimize_on_exception);
3799 }
3800 
3801 //-------------------------------new_array-------------------------------------
3802 // helper for both newarray and anewarray
3803 // The &#39;length&#39; parameter is (obviously) the length of the array.
3804 // See comments on new_instance for the meaning of the other arguments.
3805 Node* GraphKit::new_array(Node* klass_node,     // array klass (maybe variable)
3806                           Node* length,         // number of array elements
3807                           int   nargs,          // number of arguments to push back for uncommon trap
3808                           Node* *return_size_val,
3809                           bool deoptimize_on_exception) {
3810   jint  layout_con = Klass::_lh_neutral_value;
3811   Node* layout_val = get_layout_helper(klass_node, layout_con);
3812   int   layout_is_con = (layout_val == NULL);
3813 
3814   if (!layout_is_con &amp;&amp; !StressReflectiveCode &amp;&amp;
3815       !too_many_traps(Deoptimization::Reason_class_check)) {
3816     // This is a reflective array creation site.
3817     // Optimistically assume that it is a subtype of Object[],
3818     // so that we can fold up all the address arithmetic.
3819     layout_con = Klass::array_layout_helper(T_OBJECT);
3820     Node* cmp_lh = _gvn.transform( new CmpINode(layout_val, intcon(layout_con)) );
3821     Node* bol_lh = _gvn.transform( new BoolNode(cmp_lh, BoolTest::eq) );
3822     { BuildCutout unless(this, bol_lh, PROB_MAX);
3823       inc_sp(nargs);
3824       uncommon_trap(Deoptimization::Reason_class_check,
3825                     Deoptimization::Action_maybe_recompile);
3826     }
3827     layout_val = NULL;
3828     layout_is_con = true;
3829   }
3830 
3831   // Generate the initial go-slow test.  Make sure we do not overflow
3832   // if length is huge (near 2Gig) or negative!  We do not need
3833   // exact double-words here, just a close approximation of needed
3834   // double-words.  We can&#39;t add any offset or rounding bits, lest we
3835   // take a size -1 of bytes and make it positive.  Use an unsigned
3836   // compare, so negative sizes look hugely positive.
3837   int fast_size_limit = FastAllocateSizeLimit;
3838   if (layout_is_con) {
3839     assert(!StressReflectiveCode, &quot;stress mode does not use these paths&quot;);
3840     // Increase the size limit if we have exact knowledge of array type.
3841     int log2_esize = Klass::layout_helper_log2_element_size(layout_con);
3842     fast_size_limit &lt;&lt;= (LogBytesPerLong - log2_esize);
3843   }
3844 
3845   Node* initial_slow_cmp  = _gvn.transform( new CmpUNode( length, intcon( fast_size_limit ) ) );
3846   Node* initial_slow_test = _gvn.transform( new BoolNode( initial_slow_cmp, BoolTest::gt ) );
3847 
3848   // --- Size Computation ---
3849   // array_size = round_to_heap(array_header + (length &lt;&lt; elem_shift));
3850   // where round_to_heap(x) == align_to(x, MinObjAlignmentInBytes)
3851   // and align_to(x, y) == ((x + y-1) &amp; ~(y-1))
3852   // The rounding mask is strength-reduced, if possible.
3853   int round_mask = MinObjAlignmentInBytes - 1;
3854   Node* header_size = NULL;
3855   int   header_size_min  = arrayOopDesc::base_offset_in_bytes(T_BYTE);
3856   // (T_BYTE has the weakest alignment and size restrictions...)
3857   if (layout_is_con) {
3858     int       hsize  = Klass::layout_helper_header_size(layout_con);
3859     int       eshift = Klass::layout_helper_log2_element_size(layout_con);
3860     BasicType etype  = Klass::layout_helper_element_type(layout_con);
3861     if ((round_mask &amp; ~right_n_bits(eshift)) == 0)
3862       round_mask = 0;  // strength-reduce it if it goes away completely
3863     assert((hsize &amp; right_n_bits(eshift)) == 0, &quot;hsize is pre-rounded&quot;);
3864     assert(header_size_min &lt;= hsize, &quot;generic minimum is smallest&quot;);
3865     header_size_min = hsize;
3866     header_size = intcon(hsize + round_mask);
3867   } else {
3868     Node* hss   = intcon(Klass::_lh_header_size_shift);
3869     Node* hsm   = intcon(Klass::_lh_header_size_mask);
3870     Node* hsize = _gvn.transform( new URShiftINode(layout_val, hss) );
3871     hsize       = _gvn.transform( new AndINode(hsize, hsm) );
3872     Node* mask  = intcon(round_mask);
3873     header_size = _gvn.transform( new AddINode(hsize, mask) );
3874   }
3875 
3876   Node* elem_shift = NULL;
3877   if (layout_is_con) {
3878     int eshift = Klass::layout_helper_log2_element_size(layout_con);
3879     if (eshift != 0)
3880       elem_shift = intcon(eshift);
3881   } else {
3882     // There is no need to mask or shift this value.
3883     // The semantics of LShiftINode include an implicit mask to 0x1F.
3884     assert(Klass::_lh_log2_element_size_shift == 0, &quot;use shift in place&quot;);
3885     elem_shift = layout_val;
3886   }
3887 
3888   // Transition to native address size for all offset calculations:
3889   Node* lengthx = ConvI2X(length);
3890   Node* headerx = ConvI2X(header_size);
3891 #ifdef _LP64
3892   { const TypeInt* tilen = _gvn.find_int_type(length);
3893     if (tilen != NULL &amp;&amp; tilen-&gt;_lo &lt; 0) {
3894       // Add a manual constraint to a positive range.  Cf. array_element_address.
3895       jint size_max = fast_size_limit;
3896       if (size_max &gt; tilen-&gt;_hi)  size_max = tilen-&gt;_hi;
3897       const TypeInt* tlcon = TypeInt::make(0, size_max, Type::WidenMin);
3898 
3899       // Only do a narrow I2L conversion if the range check passed.
3900       IfNode* iff = new IfNode(control(), initial_slow_test, PROB_MIN, COUNT_UNKNOWN);
3901       _gvn.transform(iff);
3902       RegionNode* region = new RegionNode(3);
3903       _gvn.set_type(region, Type::CONTROL);
3904       lengthx = new PhiNode(region, TypeLong::LONG);
3905       _gvn.set_type(lengthx, TypeLong::LONG);
3906 
3907       // Range check passed. Use ConvI2L node with narrow type.
3908       Node* passed = IfFalse(iff);
3909       region-&gt;init_req(1, passed);
3910       // Make I2L conversion control dependent to prevent it from
3911       // floating above the range check during loop optimizations.
3912       lengthx-&gt;init_req(1, C-&gt;constrained_convI2L(&amp;_gvn, length, tlcon, passed));
3913 
3914       // Range check failed. Use ConvI2L with wide type because length may be invalid.
3915       region-&gt;init_req(2, IfTrue(iff));
3916       lengthx-&gt;init_req(2, ConvI2X(length));
3917 
3918       set_control(region);
3919       record_for_igvn(region);
3920       record_for_igvn(lengthx);
3921     }
3922   }
3923 #endif
3924 
3925   // Combine header size (plus rounding) and body size.  Then round down.
3926   // This computation cannot overflow, because it is used only in two
3927   // places, one where the length is sharply limited, and the other
3928   // after a successful allocation.
3929   Node* abody = lengthx;
3930   if (elem_shift != NULL)
3931     abody     = _gvn.transform( new LShiftXNode(lengthx, elem_shift) );
3932   Node* size  = _gvn.transform( new AddXNode(headerx, abody) );
3933   if (round_mask != 0) {
3934     Node* mask = MakeConX(~round_mask);
3935     size       = _gvn.transform( new AndXNode(size, mask) );
3936   }
3937   // else if round_mask == 0, the size computation is self-rounding
3938 
3939   if (return_size_val != NULL) {
3940     // This is the size
3941     (*return_size_val) = size;
3942   }
3943 
3944   // Now generate allocation code
3945 
3946   // The entire memory state is needed for slow path of the allocation
3947   // since GC and deoptimization can happened.
3948   Node *mem = reset_memory();
3949   set_all_memory(mem); // Create new memory state
3950 
3951   if (initial_slow_test-&gt;is_Bool()) {
3952     // Hide it behind a CMoveI, or else PhaseIdealLoop::split_up will get sick.
3953     initial_slow_test = initial_slow_test-&gt;as_Bool()-&gt;as_int_value(&amp;_gvn);
3954   }
3955 
3956   // Create the AllocateArrayNode and its result projections
3957   AllocateArrayNode* alloc
3958     = new AllocateArrayNode(C, AllocateArrayNode::alloc_type(TypeInt::INT),
3959                             control(), mem, i_o(),
3960                             size, klass_node,
3961                             initial_slow_test,
3962                             length);
3963 
3964   // Cast to correct type.  Note that the klass_node may be constant or not,
3965   // and in the latter case the actual array type will be inexact also.
3966   // (This happens via a non-constant argument to inline_native_newArray.)
3967   // In any case, the value of klass_node provides the desired array type.
3968   const TypeInt* length_type = _gvn.find_int_type(length);
3969   const TypeOopPtr* ary_type = _gvn.type(klass_node)-&gt;is_klassptr()-&gt;as_instance_type();
3970   if (ary_type-&gt;isa_aryptr() &amp;&amp; length_type != NULL) {
3971     // Try to get a better type than POS for the size
3972     ary_type = ary_type-&gt;is_aryptr()-&gt;cast_to_size(length_type);
3973   }
3974 
3975   Node* javaoop = set_output_for_allocation(alloc, ary_type, deoptimize_on_exception);
3976 
3977   // Cast length on remaining path to be as narrow as possible
3978   if (map()-&gt;find_edge(length) &gt;= 0) {
3979     Node* ccast = alloc-&gt;make_ideal_length(ary_type, &amp;_gvn);
3980     if (ccast != length) {
3981       _gvn.set_type_bottom(ccast);
3982       record_for_igvn(ccast);
3983       replace_in_map(length, ccast);
3984     }
3985   }
3986 
3987   return javaoop;
3988 }
3989 
3990 // The following &quot;Ideal_foo&quot; functions are placed here because they recognize
3991 // the graph shapes created by the functions immediately above.
3992 
3993 //---------------------------Ideal_allocation----------------------------------
3994 // Given an oop pointer or raw pointer, see if it feeds from an AllocateNode.
3995 AllocateNode* AllocateNode::Ideal_allocation(Node* ptr, PhaseTransform* phase) {
3996   if (ptr == NULL) {     // reduce dumb test in callers
3997     return NULL;
3998   }
3999 
4000   BarrierSetC2* bs = BarrierSet::barrier_set()-&gt;barrier_set_c2();
4001   ptr = bs-&gt;step_over_gc_barrier(ptr);
4002 
4003   if (ptr-&gt;is_CheckCastPP()) { // strip only one raw-to-oop cast
4004     ptr = ptr-&gt;in(1);
4005     if (ptr == NULL) return NULL;
4006   }
4007   // Return NULL for allocations with several casts:
4008   //   j.l.reflect.Array.newInstance(jobject, jint)
4009   //   Object.clone()
4010   // to keep more precise type from last cast.
4011   if (ptr-&gt;is_Proj()) {
4012     Node* allo = ptr-&gt;in(0);
4013     if (allo != NULL &amp;&amp; allo-&gt;is_Allocate()) {
4014       return allo-&gt;as_Allocate();
4015     }
4016   }
4017   // Report failure to match.
4018   return NULL;
4019 }
4020 
4021 // Fancy version which also strips off an offset (and reports it to caller).
4022 AllocateNode* AllocateNode::Ideal_allocation(Node* ptr, PhaseTransform* phase,
4023                                              intptr_t&amp; offset) {
4024   Node* base = AddPNode::Ideal_base_and_offset(ptr, phase, offset);
4025   if (base == NULL)  return NULL;
4026   return Ideal_allocation(base, phase);
4027 }
4028 
4029 // Trace Initialize &lt;- Proj[Parm] &lt;- Allocate
4030 AllocateNode* InitializeNode::allocation() {
4031   Node* rawoop = in(InitializeNode::RawAddress);
4032   if (rawoop-&gt;is_Proj()) {
4033     Node* alloc = rawoop-&gt;in(0);
4034     if (alloc-&gt;is_Allocate()) {
4035       return alloc-&gt;as_Allocate();
4036     }
4037   }
4038   return NULL;
4039 }
4040 
4041 // Trace Allocate -&gt; Proj[Parm] -&gt; Initialize
4042 InitializeNode* AllocateNode::initialization() {
4043   ProjNode* rawoop = proj_out_or_null(AllocateNode::RawAddress);
4044   if (rawoop == NULL)  return NULL;
4045   for (DUIterator_Fast imax, i = rawoop-&gt;fast_outs(imax); i &lt; imax; i++) {
4046     Node* init = rawoop-&gt;fast_out(i);
4047     if (init-&gt;is_Initialize()) {
4048       assert(init-&gt;as_Initialize()-&gt;allocation() == this, &quot;2-way link&quot;);
4049       return init-&gt;as_Initialize();
4050     }
4051   }
4052   return NULL;
4053 }
4054 
4055 //----------------------------- loop predicates ---------------------------
4056 
4057 //------------------------------add_predicate_impl----------------------------
4058 void GraphKit::add_empty_predicate_impl(Deoptimization::DeoptReason reason, int nargs) {
4059   // Too many traps seen?
4060   if (too_many_traps(reason)) {
4061 #ifdef ASSERT
4062     if (TraceLoopPredicate) {
4063       int tc = C-&gt;trap_count(reason);
4064       tty-&gt;print(&quot;too many traps=%s tcount=%d in &quot;,
4065                     Deoptimization::trap_reason_name(reason), tc);
4066       method()-&gt;print(); // which method has too many predicate traps
4067       tty-&gt;cr();
4068     }
4069 #endif
4070     // We cannot afford to take more traps here,
4071     // do not generate predicate.
4072     return;
4073   }
4074 
4075   Node *cont    = _gvn.intcon(1);
4076   Node* opq     = _gvn.transform(new Opaque1Node(C, cont));
4077   Node *bol     = _gvn.transform(new Conv2BNode(opq));
4078   IfNode* iff   = create_and_map_if(control(), bol, PROB_MAX, COUNT_UNKNOWN);
4079   Node* iffalse = _gvn.transform(new IfFalseNode(iff));
4080   C-&gt;add_predicate_opaq(opq);
4081   {
4082     PreserveJVMState pjvms(this);
4083     set_control(iffalse);
4084     inc_sp(nargs);
4085     uncommon_trap(reason, Deoptimization::Action_maybe_recompile);
4086   }
4087   Node* iftrue = _gvn.transform(new IfTrueNode(iff));
4088   set_control(iftrue);
4089 }
4090 
4091 //------------------------------add_predicate---------------------------------
4092 void GraphKit::add_empty_predicates(int nargs) {
4093   // These loop predicates remain empty. All concrete loop predicates are inserted above the corresponding
4094   // empty loop predicate later by &#39;PhaseIdealLoop::create_new_if_for_predicate&#39;. All concrete loop predicates of
4095   // a specific kind (normal, profile or limit check) share the same uncommon trap as the empty loop predicate.
4096   if (UseLoopPredicate) {
4097     add_empty_predicate_impl(Deoptimization::Reason_predicate, nargs);
4098   }
4099   if (UseProfiledLoopPredicate) {
4100     add_empty_predicate_impl(Deoptimization::Reason_profile_predicate, nargs);
4101   }
4102   // loop&#39;s limit check predicate should be near the loop.
4103   add_empty_predicate_impl(Deoptimization::Reason_loop_limit_check, nargs);
4104 }
4105 
4106 void GraphKit::sync_kit(IdealKit&amp; ideal) {
4107   set_all_memory(ideal.merged_memory());
4108   set_i_o(ideal.i_o());
4109   set_control(ideal.ctrl());
4110 }
4111 
4112 void GraphKit::final_sync(IdealKit&amp; ideal) {
4113   // Final sync IdealKit and graphKit.
4114   sync_kit(ideal);
4115 }
4116 
4117 Node* GraphKit::load_String_length(Node* str, bool set_ctrl) {
4118   Node* len = load_array_length(load_String_value(str, set_ctrl));
4119   Node* coder = load_String_coder(str, set_ctrl);
4120   // Divide length by 2 if coder is UTF16
4121   return _gvn.transform(new RShiftINode(len, coder));
4122 }
4123 
4124 Node* GraphKit::load_String_value(Node* str, bool set_ctrl) {
4125   int value_offset = java_lang_String::value_offset();
4126   const TypeInstPtr* string_type = TypeInstPtr::make(TypePtr::NotNull, C-&gt;env()-&gt;String_klass(),
4127                                                      false, NULL, 0);
4128   const TypePtr* value_field_type = string_type-&gt;add_offset(value_offset);
4129   const TypeAryPtr* value_type = TypeAryPtr::make(TypePtr::NotNull,
4130                                                   TypeAry::make(TypeInt::BYTE, TypeInt::POS),
4131                                                   ciTypeArrayKlass::make(T_BYTE), true, 0);
4132   Node* p = basic_plus_adr(str, str, value_offset);
4133   Node* load = access_load_at(str, p, value_field_type, value_type, T_OBJECT,
4134                               IN_HEAP | (set_ctrl ? C2_CONTROL_DEPENDENT_LOAD : 0) | MO_UNORDERED);
4135   return load;
4136 }
4137 
4138 Node* GraphKit::load_String_coder(Node* str, bool set_ctrl) {
4139   if (!CompactStrings) {
4140     return intcon(java_lang_String::CODER_UTF16);
4141   }
4142   int coder_offset = java_lang_String::coder_offset();
4143   const TypeInstPtr* string_type = TypeInstPtr::make(TypePtr::NotNull, C-&gt;env()-&gt;String_klass(),
4144                                                      false, NULL, 0);
4145   const TypePtr* coder_field_type = string_type-&gt;add_offset(coder_offset);
4146 
4147   Node* p = basic_plus_adr(str, str, coder_offset);
4148   Node* load = access_load_at(str, p, coder_field_type, TypeInt::BYTE, T_BYTE,
4149                               IN_HEAP | (set_ctrl ? C2_CONTROL_DEPENDENT_LOAD : 0) | MO_UNORDERED);
4150   return load;
4151 }
4152 
4153 void GraphKit::store_String_value(Node* str, Node* value) {
4154   int value_offset = java_lang_String::value_offset();
4155   const TypeInstPtr* string_type = TypeInstPtr::make(TypePtr::NotNull, C-&gt;env()-&gt;String_klass(),
4156                                                      false, NULL, 0);
4157   const TypePtr* value_field_type = string_type-&gt;add_offset(value_offset);
4158 
4159   access_store_at(str,  basic_plus_adr(str, value_offset), value_field_type,
4160                   value, TypeAryPtr::BYTES, T_OBJECT, IN_HEAP | MO_UNORDERED);
4161 }
4162 
4163 void GraphKit::store_String_coder(Node* str, Node* value) {
4164   int coder_offset = java_lang_String::coder_offset();
4165   const TypeInstPtr* string_type = TypeInstPtr::make(TypePtr::NotNull, C-&gt;env()-&gt;String_klass(),
4166                                                      false, NULL, 0);
4167   const TypePtr* coder_field_type = string_type-&gt;add_offset(coder_offset);
4168 
4169   access_store_at(str, basic_plus_adr(str, coder_offset), coder_field_type,
4170                   value, TypeInt::BYTE, T_BYTE, IN_HEAP | MO_UNORDERED);
4171 }
4172 
4173 // Capture src and dst memory state with a MergeMemNode
4174 Node* GraphKit::capture_memory(const TypePtr* src_type, const TypePtr* dst_type) {
4175   if (src_type == dst_type) {
4176     // Types are equal, we don&#39;t need a MergeMemNode
4177     return memory(src_type);
4178   }
4179   MergeMemNode* merge = MergeMemNode::make(map()-&gt;memory());
4180   record_for_igvn(merge); // fold it up later, if possible
4181   int src_idx = C-&gt;get_alias_index(src_type);
4182   int dst_idx = C-&gt;get_alias_index(dst_type);
4183   merge-&gt;set_memory_at(src_idx, memory(src_idx));
4184   merge-&gt;set_memory_at(dst_idx, memory(dst_idx));
4185   return merge;
4186 }
4187 
4188 Node* GraphKit::compress_string(Node* src, const TypeAryPtr* src_type, Node* dst, Node* count) {
4189   assert(Matcher::match_rule_supported(Op_StrCompressedCopy), &quot;Intrinsic not supported&quot;);
4190   assert(src_type == TypeAryPtr::BYTES || src_type == TypeAryPtr::CHARS, &quot;invalid source type&quot;);
4191   // If input and output memory types differ, capture both states to preserve
4192   // the dependency between preceding and subsequent loads/stores.
4193   // For example, the following program:
4194   //  StoreB
4195   //  compress_string
4196   //  LoadB
4197   // has this memory graph (use-&gt;def):
4198   //  LoadB -&gt; compress_string -&gt; CharMem
4199   //             ... -&gt; StoreB -&gt; ByteMem
4200   // The intrinsic hides the dependency between LoadB and StoreB, causing
4201   // the load to read from memory not containing the result of the StoreB.
4202   // The correct memory graph should look like this:
4203   //  LoadB -&gt; compress_string -&gt; MergeMem(CharMem, StoreB(ByteMem))
4204   Node* mem = capture_memory(src_type, TypeAryPtr::BYTES);
4205   StrCompressedCopyNode* str = new StrCompressedCopyNode(control(), mem, src, dst, count);
4206   Node* res_mem = _gvn.transform(new SCMemProjNode(str));
4207   set_memory(res_mem, TypeAryPtr::BYTES);
4208   return str;
4209 }
4210 
4211 void GraphKit::inflate_string(Node* src, Node* dst, const TypeAryPtr* dst_type, Node* count) {
4212   assert(Matcher::match_rule_supported(Op_StrInflatedCopy), &quot;Intrinsic not supported&quot;);
4213   assert(dst_type == TypeAryPtr::BYTES || dst_type == TypeAryPtr::CHARS, &quot;invalid dest type&quot;);
4214   // Capture src and dst memory (see comment in &#39;compress_string&#39;).
4215   Node* mem = capture_memory(TypeAryPtr::BYTES, dst_type);
4216   StrInflatedCopyNode* str = new StrInflatedCopyNode(control(), mem, src, dst, count);
4217   set_memory(_gvn.transform(str), dst_type);
4218 }
4219 
4220 void GraphKit::inflate_string_slow(Node* src, Node* dst, Node* start, Node* count) {
4221   /**
4222    * int i_char = start;
4223    * for (int i_byte = 0; i_byte &lt; count; i_byte++) {
4224    *   dst[i_char++] = (char)(src[i_byte] &amp; 0xff);
4225    * }
4226    */
4227   add_empty_predicates();
4228   RegionNode* head = new RegionNode(3);
4229   head-&gt;init_req(1, control());
4230   gvn().set_type(head, Type::CONTROL);
4231   record_for_igvn(head);
4232 
4233   Node* i_byte = new PhiNode(head, TypeInt::INT);
4234   i_byte-&gt;init_req(1, intcon(0));
4235   gvn().set_type(i_byte, TypeInt::INT);
4236   record_for_igvn(i_byte);
4237 
4238   Node* i_char = new PhiNode(head, TypeInt::INT);
4239   i_char-&gt;init_req(1, start);
4240   gvn().set_type(i_char, TypeInt::INT);
4241   record_for_igvn(i_char);
4242 
4243   Node* mem = PhiNode::make(head, memory(TypeAryPtr::BYTES), Type::MEMORY, TypeAryPtr::BYTES);
4244   gvn().set_type(mem, Type::MEMORY);
4245   record_for_igvn(mem);
4246   set_control(head);
4247   set_memory(mem, TypeAryPtr::BYTES);
4248   Node* ch = load_array_element(control(), src, i_byte, TypeAryPtr::BYTES);
4249   Node* st = store_to_memory(control(), array_element_address(dst, i_char, T_BYTE),
4250                              AndI(ch, intcon(0xff)), T_CHAR, TypeAryPtr::BYTES, MemNode::unordered,
4251                              false, false, true /* mismatched */);
4252 
4253   IfNode* iff = create_and_map_if(head, Bool(CmpI(i_byte, count), BoolTest::lt), PROB_FAIR, COUNT_UNKNOWN);
4254   head-&gt;init_req(2, IfTrue(iff));
4255   mem-&gt;init_req(2, st);
4256   i_byte-&gt;init_req(2, AddI(i_byte, intcon(1)));
4257   i_char-&gt;init_req(2, AddI(i_char, intcon(2)));
4258 
4259   set_control(IfFalse(iff));
4260   set_memory(st, TypeAryPtr::BYTES);
4261 }
4262 
4263 Node* GraphKit::make_constant_from_field(ciField* field, Node* obj) {
4264   if (!field-&gt;is_constant()) {
4265     return NULL; // Field not marked as constant.
4266   }
4267   ciInstance* holder = NULL;
4268   if (!field-&gt;is_static()) {
4269     ciObject* const_oop = obj-&gt;bottom_type()-&gt;is_oopptr()-&gt;const_oop();
4270     if (const_oop != NULL &amp;&amp; const_oop-&gt;is_instance()) {
4271       holder = const_oop-&gt;as_instance();
4272     }
4273   }
4274   const Type* con_type = Type::make_constant_from_field(field, holder, field-&gt;layout_type(),
4275                                                         /*is_unsigned_load=*/false);
4276   if (con_type != NULL) {
4277     return makecon(con_type);
4278   }
4279   return NULL;
4280 }
<a name="5" id="anc5"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="5" type="hidden" />
</body>
</html>