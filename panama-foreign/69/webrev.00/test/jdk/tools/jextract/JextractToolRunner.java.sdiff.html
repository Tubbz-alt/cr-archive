<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff test/jdk/tools/jextract/JextractToolRunner.java</title>
    <link rel="stylesheet" href="../../../../style.css" />
  </head>
<body>
<center><a href="../../java/foreign/TestLayoutConstants.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="testStruct/LibStructTest.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>test/jdk/tools/jextract/JextractToolRunner.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 21  * questions.
 22  */
 23 
 24 import java.io.IOException;
 25 import java.io.PrintWriter;
 26 import java.io.StringWriter;
 27 import java.lang.reflect.Field;
 28 import java.lang.reflect.Method;
 29 import java.net.URL;
 30 import java.net.URLClassLoader;
 31 import java.nio.file.FileVisitResult;
 32 import java.nio.file.Files;
 33 import java.nio.file.Path;
 34 import java.nio.file.Paths;
 35 import java.nio.file.SimpleFileVisitor;
 36 import java.nio.file.attribute.BasicFileAttributes;
 37 import java.util.Objects;
 38 import java.util.spi.ToolProvider;
 39 import jdk.incubator.foreign.MemoryLayout;
 40 import jdk.incubator.foreign.MemoryLayout.PathElement;

 41 import jdk.incubator.foreign.SystemABI.Type;
 42 

 43 import static org.testng.Assert.assertEquals;
 44 import static org.testng.Assert.assertNotEquals;
 45 import static org.testng.Assert.assertNotNull;
 46 import static org.testng.Assert.assertTrue;
 47 import static org.testng.Assert.fail;
 48 
 49 public class JextractToolRunner {
 50     private static String safeFileName(String filename) {
 51         int ext = filename.lastIndexOf(&#39;.&#39;);
 52         return ext != -1 ? filename.substring(0, ext) : filename;
 53     }
 54 
 55     private static final ToolProvider JEXTRACT_TOOL = ToolProvider.findFirst(&quot;jextract&quot;)
 56             .orElseThrow(() -&gt;
 57                     new RuntimeException(&quot;jextract tool not found&quot;)
 58             );
 59 
 60     private final Path inputDir;
 61     private final Path outputDir;
 62 
</pre>
<hr />
<pre>
226         } catch (NoSuchMethodException nsme) {
227             fail(&quot;Expect method &quot; + name);
228         }
229         return null;
230     }
231 
232     protected MemoryLayout findLayout(Class&lt;?&gt; cls, String name) {
233         Field field = findField(cls, name + &quot;$LAYOUT&quot;);
234         assertNotNull(field);
235         assertEquals(field.getType(), MemoryLayout.class);
236         try {
237             return (MemoryLayout)field.get(null);
238         } catch (Exception exp) {
239             System.err.println(exp);
240             assertTrue(false, &quot;should not reach here&quot;);
241         }
242         return null;
243     }
244 
245     protected static void checkFieldABIType(MemoryLayout layout, String fieldName, Type expected) {
<span class="line-modified">246         assertEquals(layout.select(PathElement.groupElement(fieldName)).abiType().orElseThrow(), expected);</span>


247     }
248 
249     protected static class Loader implements AutoCloseable {
250 
251         private final URLClassLoader loader;
252 
253         public Loader(URLClassLoader loader) {
254             this.loader = loader;
255         }
256 
257         public Class&lt;?&gt; loadClass(String className) {
258             try {
259                 return Class.forName(className, false, loader);
260             } catch (ClassNotFoundException e) {
261                 // return null so caller can check if class loading
262                 // was successful with assertNotNull/assertNull
263                 return null;
264             }
265         }
266 
</pre>
</td>
<td>
<hr />
<pre>
 21  * questions.
 22  */
 23 
 24 import java.io.IOException;
 25 import java.io.PrintWriter;
 26 import java.io.StringWriter;
 27 import java.lang.reflect.Field;
 28 import java.lang.reflect.Method;
 29 import java.net.URL;
 30 import java.net.URLClassLoader;
 31 import java.nio.file.FileVisitResult;
 32 import java.nio.file.Files;
 33 import java.nio.file.Path;
 34 import java.nio.file.Paths;
 35 import java.nio.file.SimpleFileVisitor;
 36 import java.nio.file.attribute.BasicFileAttributes;
 37 import java.util.Objects;
 38 import java.util.spi.ToolProvider;
 39 import jdk.incubator.foreign.MemoryLayout;
 40 import jdk.incubator.foreign.MemoryLayout.PathElement;
<span class="line-added"> 41 import jdk.incubator.foreign.SystemABI;</span>
 42 import jdk.incubator.foreign.SystemABI.Type;
 43 
<span class="line-added"> 44 import static jdk.incubator.foreign.SystemABI.NATIVE_TYPE;</span>
 45 import static org.testng.Assert.assertEquals;
 46 import static org.testng.Assert.assertNotEquals;
 47 import static org.testng.Assert.assertNotNull;
 48 import static org.testng.Assert.assertTrue;
 49 import static org.testng.Assert.fail;
 50 
 51 public class JextractToolRunner {
 52     private static String safeFileName(String filename) {
 53         int ext = filename.lastIndexOf(&#39;.&#39;);
 54         return ext != -1 ? filename.substring(0, ext) : filename;
 55     }
 56 
 57     private static final ToolProvider JEXTRACT_TOOL = ToolProvider.findFirst(&quot;jextract&quot;)
 58             .orElseThrow(() -&gt;
 59                     new RuntimeException(&quot;jextract tool not found&quot;)
 60             );
 61 
 62     private final Path inputDir;
 63     private final Path outputDir;
 64 
</pre>
<hr />
<pre>
228         } catch (NoSuchMethodException nsme) {
229             fail(&quot;Expect method &quot; + name);
230         }
231         return null;
232     }
233 
234     protected MemoryLayout findLayout(Class&lt;?&gt; cls, String name) {
235         Field field = findField(cls, name + &quot;$LAYOUT&quot;);
236         assertNotNull(field);
237         assertEquals(field.getType(), MemoryLayout.class);
238         try {
239             return (MemoryLayout)field.get(null);
240         } catch (Exception exp) {
241             System.err.println(exp);
242             assertTrue(false, &quot;should not reach here&quot;);
243         }
244         return null;
245     }
246 
247     protected static void checkFieldABIType(MemoryLayout layout, String fieldName, Type expected) {
<span class="line-modified">248         assertEquals(layout.select(PathElement.groupElement(fieldName)).attribute(NATIVE_TYPE)</span>
<span class="line-added">249                                                                        .map(SystemABI.Type.class::cast)</span>
<span class="line-added">250                                                                        .orElseThrow(), expected);</span>
251     }
252 
253     protected static class Loader implements AutoCloseable {
254 
255         private final URLClassLoader loader;
256 
257         public Loader(URLClassLoader loader) {
258             this.loader = loader;
259         }
260 
261         public Class&lt;?&gt; loadClass(String className) {
262             try {
263                 return Class.forName(className, false, loader);
264             } catch (ClassNotFoundException e) {
265                 // return null so caller can check if class loading
266                 // was successful with assertNotNull/assertNull
267                 return null;
268             }
269         }
270 
</pre>
</td>
</tr>
</table>
<center><a href="../../java/foreign/TestLayoutConstants.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="testStruct/LibStructTest.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>