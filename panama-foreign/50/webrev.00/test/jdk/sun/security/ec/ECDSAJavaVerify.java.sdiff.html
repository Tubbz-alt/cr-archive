<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff test/jdk/sun/security/ec/ECDSAJavaVerify.java</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
<body>
<center><a href="../../../jdk/jfr/event/runtime/TestActiveSettingEvent.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="../ssl/SSLSocketImpl/ClientTimeout.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>test/jdk/sun/security/ec/ECDSAJavaVerify.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 31 import com.sun.jdi.event.MethodEntryEvent;
 32 import com.sun.jdi.request.MethodEntryRequest;
 33 
 34 import java.security.AlgorithmParameters;
 35 import java.security.KeyPair;
 36 import java.security.KeyPairGenerator;
 37 import java.security.SecureRandom;
 38 import java.security.Signature;
 39 import java.security.SignatureException;
 40 import java.security.interfaces.ECPrivateKey;
 41 import java.security.interfaces.ECPublicKey;
 42 import java.security.spec.ECGenParameterSpec;
 43 import java.security.spec.ECParameterSpec;
 44 import java.util.Arrays;
 45 import java.util.List;
 46 import java.util.Map;
 47 import java.util.Random;
 48 
 49 /*
 50  * @test
<span class="line-modified"> 51  * @bug 8237218</span>
<span class="line-removed"> 52  * @summary Support NIST Curves verification in java implementation</span>
 53  * @modules jdk.crypto.ec
 54  *          jdk.jdi

 55  * @run main ECDSAJavaVerify debug



 56  */
 57 
 58 // ATTENTION: This test depends on method names inside the non-exported
 59 // class sun.security.ec.ECDSASignature.
 60 public class ECDSAJavaVerify {
 61 
 62     static final String[] ALL_ALGS = new String[] {
 63             &quot;SHA1withECDSA&quot;, &quot;SHA256withECDSA&quot;, &quot;SHA384withECDSA&quot;, &quot;SHA512withECDSA&quot;};
 64 
 65     static final String[] ALL_CURVES = new String[] {
 66             &quot;secp128r1&quot;, &quot;secp256k1&quot;, &quot;secp256r1&quot;, &quot;secp384r1&quot;, &quot;secp521r1&quot;};
 67 
 68     static final List&lt;String&gt; ALL_JAVA_CURVES
 69             = List.of(&quot;secp256r1&quot;, &quot;secp384r1&quot;, &quot;secp521r1&quot;);
 70 
 71     public static void main(String[] args) throws Exception {
 72         if (args.length == 1) {
 73             // Debugging a new process with no arg
 74             debug();
 75         } else if (args.length == 3) {
</pre>
<hr />
<pre>
103         MethodEntryRequest req = vm.eventRequestManager()
104                 .createMethodEntryRequest();
105         req.addClassFilter(&quot;sun.security.ec.ECDSASignature&quot;);
106         req.enable();
107 
108         int numberOfTests = ALL_ALGS.length * ALL_CURVES.length * 2;
109 
110         // Expected methods to call. &#39;J&#39; for java impl, &#39;N&#39; for native impl
111         char[] expected = new char[numberOfTests];
112 
113         int pos = 0;
114         for (String dummy : ALL_ALGS) {
115             for (String curve : ALL_CURVES) {
116                 char caller = ALL_JAVA_CURVES.contains(curve) ? &#39;J&#39; : &#39;N&#39;;
117                 // For each case, Signature::verify is called twice
118                 expected[pos++] = caller;
119                 expected[pos++] = caller;
120             }
121         }
122 
<span class="line-modified">123         // Test result, init as &#39; &#39;, &#39;-&#39; if run, &#39;x&#39; for unexpected.</span>






124         char[] result = new char[numberOfTests];
<span class="line-modified">125         Arrays.fill(result, &#39; &#39;);</span>
126 
127         String stdout, stderr;
128 
129         try {
130             EventSet eventSet;
131             pos = -1; // will become 0 when entering &#39;engineVerify&#39;
132             while ((eventSet = vm.eventQueue().remove()) != null) {
133                 for (Event event : eventSet) {
134                     if (event instanceof MethodEntryEvent) {
135                         MethodEntryEvent e = (MethodEntryEvent)event;
136                         switch (e.method().name()) {
137                             case &quot;engineVerify&quot;:
<span class="line-modified">138                                 pos++;</span>
<span class="line-removed">139                                 result[pos] = &#39;-&#39;;</span>
140                                 break;
141                             case &quot;verifySignedDigestImpl&quot;: // the java impl
<span class="line-modified">142                                 if (expected[pos] != &#39;J&#39;) {</span>
<span class="line-removed">143                                     result[pos] = &#39;x&#39;;</span>
<span class="line-removed">144                                 }</span>
145                                 break;
<span class="line-modified">146                             case &quot;verifySignedDigest&quot;:</span>
<span class="line-modified">147                                 if (expected[pos] != &#39;N&#39;) { // the native impl</span>
<span class="line-removed">148                                     result[pos] = &#39;x&#39;;</span>
<span class="line-removed">149                                 }</span>
150                                 break;
151                         }
152                     }
153                     vm.resume();
154                 }
155             }
156         } catch (VMDisconnectedException e) {
157             System.out.println(&quot;Virtual Machine is disconnected.&quot;);
158         } finally {
159             stderr = new String(vm.process().getErrorStream().readAllBytes());
160             stdout = new String(vm.process().getInputStream().readAllBytes());
161         }
162 


163         System.out.println(&quot;stderr:\n&quot; + stderr);
164         System.out.println(&quot;stdout:\n&quot; + stdout);
165 
166         String sResult = new String(result);
167 
<span class="line-modified">168         System.out.println(&quot;Expected: &quot; + new String(expected));</span>
<span class="line-modified">169         System.out.println(&quot;  Actual: &quot; + sResult);</span>
170 
<span class="line-modified">171         if (pos != numberOfTests - 1 || sResult.contains(&quot;x&quot;)) {</span>

172             throw new Exception(&quot;Unexpected result&quot;);
173         }
174 
<span class="line-modified">175         if (stdout.contains(&quot;fail&quot;) || !stderr.isEmpty()) {</span>
176             throw new Exception(&quot;Test failed&quot;);
177         }
178     }
179 
180     static class Test {
181 
182         public boolean run(int seed, String sigAlg, String curve)
183                 throws Exception {
184 
185             // A determined SecureRandom based on seed. If there is anything
186             // wrong, we can reproduce the problem using the seed.
187             Random r = new Random(seed);
188             SecureRandom rand = new SecureRandom() {
189                 @Override
190                 public void nextBytes(byte[] bytes) {
191                     r.nextBytes(bytes);
192                 }
193             };
194 
195             AlgorithmParameters ap = AlgorithmParameters.getInstance(&quot;EC&quot;, &quot;SunEC&quot;);
</pre>
</td>
<td>
<hr />
<pre>
 31 import com.sun.jdi.event.MethodEntryEvent;
 32 import com.sun.jdi.request.MethodEntryRequest;
 33 
 34 import java.security.AlgorithmParameters;
 35 import java.security.KeyPair;
 36 import java.security.KeyPairGenerator;
 37 import java.security.SecureRandom;
 38 import java.security.Signature;
 39 import java.security.SignatureException;
 40 import java.security.interfaces.ECPrivateKey;
 41 import java.security.interfaces.ECPublicKey;
 42 import java.security.spec.ECGenParameterSpec;
 43 import java.security.spec.ECParameterSpec;
 44 import java.util.Arrays;
 45 import java.util.List;
 46 import java.util.Map;
 47 import java.util.Random;
 48 
 49 /*
 50  * @test
<span class="line-modified"> 51  * @bug 8237218 8239928</span>

 52  * @modules jdk.crypto.ec
 53  *          jdk.jdi
<span class="line-added"> 54  * @requires os.family != &quot;windows&quot;</span>
 55  * @run main ECDSAJavaVerify debug
<span class="line-added"> 56  * @summary Support NIST Curves verification in java implementation.</span>
<span class="line-added"> 57  *  This test does not run stable on Windows. VMDisconnectedException</span>
<span class="line-added"> 58  *  might not be thrown at all.</span>
 59  */
 60 
 61 // ATTENTION: This test depends on method names inside the non-exported
 62 // class sun.security.ec.ECDSASignature.
 63 public class ECDSAJavaVerify {
 64 
 65     static final String[] ALL_ALGS = new String[] {
 66             &quot;SHA1withECDSA&quot;, &quot;SHA256withECDSA&quot;, &quot;SHA384withECDSA&quot;, &quot;SHA512withECDSA&quot;};
 67 
 68     static final String[] ALL_CURVES = new String[] {
 69             &quot;secp128r1&quot;, &quot;secp256k1&quot;, &quot;secp256r1&quot;, &quot;secp384r1&quot;, &quot;secp521r1&quot;};
 70 
 71     static final List&lt;String&gt; ALL_JAVA_CURVES
 72             = List.of(&quot;secp256r1&quot;, &quot;secp384r1&quot;, &quot;secp521r1&quot;);
 73 
 74     public static void main(String[] args) throws Exception {
 75         if (args.length == 1) {
 76             // Debugging a new process with no arg
 77             debug();
 78         } else if (args.length == 3) {
</pre>
<hr />
<pre>
106         MethodEntryRequest req = vm.eventRequestManager()
107                 .createMethodEntryRequest();
108         req.addClassFilter(&quot;sun.security.ec.ECDSASignature&quot;);
109         req.enable();
110 
111         int numberOfTests = ALL_ALGS.length * ALL_CURVES.length * 2;
112 
113         // Expected methods to call. &#39;J&#39; for java impl, &#39;N&#39; for native impl
114         char[] expected = new char[numberOfTests];
115 
116         int pos = 0;
117         for (String dummy : ALL_ALGS) {
118             for (String curve : ALL_CURVES) {
119                 char caller = ALL_JAVA_CURVES.contains(curve) ? &#39;J&#39; : &#39;N&#39;;
120                 // For each case, Signature::verify is called twice
121                 expected[pos++] = caller;
122                 expected[pos++] = caller;
123             }
124         }
125 
<span class="line-modified">126         // Test result</span>
<span class="line-added">127         // &#39;.&#39;: not run yet</span>
<span class="line-added">128         // &#39;-&#39;: enter engineVerify</span>
<span class="line-added">129         // &#39;v&#39;: expected impl called</span>
<span class="line-added">130         // &#39;x&#39;: unexpected impl called</span>
<span class="line-added">131         // Note: some error cases fail before any impl called. Ex: if there</span>
<span class="line-added">132         // is a DER encoding error.</span>
133         char[] result = new char[numberOfTests];
<span class="line-modified">134         Arrays.fill(result, &#39;.&#39;);</span>
135 
136         String stdout, stderr;
137 
138         try {
139             EventSet eventSet;
140             pos = -1; // will become 0 when entering &#39;engineVerify&#39;
141             while ((eventSet = vm.eventQueue().remove()) != null) {
142                 for (Event event : eventSet) {
143                     if (event instanceof MethodEntryEvent) {
144                         MethodEntryEvent e = (MethodEntryEvent)event;
145                         switch (e.method().name()) {
146                             case &quot;engineVerify&quot;:
<span class="line-modified">147                                 result[++pos] = &#39;-&#39;;</span>

148                                 break;
149                             case &quot;verifySignedDigestImpl&quot;: // the java impl
<span class="line-modified">150                                 result[pos] = expected[pos] != &#39;J&#39; ? &#39;x&#39; : &#39;v&#39;;</span>


151                                 break;
<span class="line-modified">152                             case &quot;verifySignedDigest&quot;: // the native impl</span>
<span class="line-modified">153                                 result[pos] = expected[pos] != &#39;N&#39; ? &#39;x&#39; : &#39;v&#39;;</span>


154                                 break;
155                         }
156                     }
157                     vm.resume();
158                 }
159             }
160         } catch (VMDisconnectedException e) {
161             System.out.println(&quot;Virtual Machine is disconnected.&quot;);
162         } finally {
163             stderr = new String(vm.process().getErrorStream().readAllBytes());
164             stdout = new String(vm.process().getInputStream().readAllBytes());
165         }
166 
<span class="line-added">167         int exitCode = vm.process().waitFor();</span>
<span class="line-added">168         System.out.println(&quot;  exit: &quot; + exitCode);</span>
169         System.out.println(&quot;stderr:\n&quot; + stderr);
170         System.out.println(&quot;stdout:\n&quot; + stdout);
171 
172         String sResult = new String(result);
173 
<span class="line-modified">174         System.out.println(&quot; Cases: &quot; + new String(expected));</span>
<span class="line-modified">175         System.out.println(&quot;Result: &quot; + sResult);</span>
176 
<span class="line-modified">177         if (pos != numberOfTests - 1 || sResult.contains(&quot;x&quot;)</span>
<span class="line-added">178                 || sResult.contains(&quot;.&quot;)) {</span>
179             throw new Exception(&quot;Unexpected result&quot;);
180         }
181 
<span class="line-modified">182         if (stdout.contains(&quot;fail&quot;) || exitCode != 0) {</span>
183             throw new Exception(&quot;Test failed&quot;);
184         }
185     }
186 
187     static class Test {
188 
189         public boolean run(int seed, String sigAlg, String curve)
190                 throws Exception {
191 
192             // A determined SecureRandom based on seed. If there is anything
193             // wrong, we can reproduce the problem using the seed.
194             Random r = new Random(seed);
195             SecureRandom rand = new SecureRandom() {
196                 @Override
197                 public void nextBytes(byte[] bytes) {
198                     r.nextBytes(bytes);
199                 }
200             };
201 
202             AlgorithmParameters ap = AlgorithmParameters.getInstance(&quot;EC&quot;, &quot;SunEC&quot;);
</pre>
</td>
</tr>
</table>
<center><a href="../../../jdk/jfr/event/runtime/TestActiveSettingEvent.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="../ssl/SSLSocketImpl/ClientTimeout.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>