<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/hotspot/share/prims/jni.cpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
  </head>
<body>
<center><a href="../opto/type.hpp.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="jvm.cpp.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/hotspot/share/prims/jni.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 380   }
 381   if ((int)strlen(name) &gt; Symbol::max_length()) {
 382     Exceptions::fthrow(THREAD_AND_LOCATION,
 383                        vmSymbols::java_lang_NoClassDefFoundError(),
 384                        &quot;Class name exceeds maximum length of %d: %s&quot;,
 385                        Symbol::max_length(),
 386                        name);
 387     return 0;
 388   }
 389 
 390   //%note jni_3
 391   Handle protection_domain;
 392   // Find calling class
 393   Klass* k = thread-&gt;security_get_caller_class(0);
 394   // default to the system loader when no context
 395   Handle loader(THREAD, SystemDictionary::java_system_loader());
 396   if (k != NULL) {
 397     // Special handling to make sure JNI_OnLoad and JNI_OnUnload are executed
 398     // in the correct class context.
 399     if (k-&gt;class_loader() == NULL &amp;&amp;
<span class="line-modified"> 400         k-&gt;name() == vmSymbols::java_lang_ClassLoader_NativeLibrary()) {</span>
 401       JavaValue result(T_OBJECT);
 402       JavaCalls::call_static(&amp;result, k,
 403                              vmSymbols::getFromClass_name(),
 404                              vmSymbols::void_class_signature(),
 405                              CHECK_NULL);
<span class="line-modified"> 406       // When invoked from JNI_OnLoad, NativeLibrary::getFromClass returns</span>
 407       // a non-NULL Class object.  When invoked from JNI_OnUnload,
 408       // it will return NULL to indicate no context.
 409       oop mirror = (oop) result.get_jobject();
 410       if (mirror != NULL) {
 411         Klass* fromClass = java_lang_Class::as_Klass(mirror);
 412         loader = Handle(THREAD, fromClass-&gt;class_loader());
 413         protection_domain = Handle(THREAD, fromClass-&gt;protection_domain());
 414       }
 415     } else {
 416       loader = Handle(THREAD, k-&gt;class_loader());
 417     }
 418   }
 419 
 420   TempNewSymbol sym = SymbolTable::new_symbol(name);
 421   result = find_class_from_class_loader(env, sym, true, loader,
 422                                         protection_domain, true, thread);
 423 
 424   if (log_is_enabled(Debug, class, resolve) &amp;&amp; result != NULL) {
 425     trace_class_resolution(java_lang_Class::as_Klass(JNIHandles::resolve_non_null(result)));
 426   }
</pre>
</td>
<td>
<hr />
<pre>
 380   }
 381   if ((int)strlen(name) &gt; Symbol::max_length()) {
 382     Exceptions::fthrow(THREAD_AND_LOCATION,
 383                        vmSymbols::java_lang_NoClassDefFoundError(),
 384                        &quot;Class name exceeds maximum length of %d: %s&quot;,
 385                        Symbol::max_length(),
 386                        name);
 387     return 0;
 388   }
 389 
 390   //%note jni_3
 391   Handle protection_domain;
 392   // Find calling class
 393   Klass* k = thread-&gt;security_get_caller_class(0);
 394   // default to the system loader when no context
 395   Handle loader(THREAD, SystemDictionary::java_system_loader());
 396   if (k != NULL) {
 397     // Special handling to make sure JNI_OnLoad and JNI_OnUnload are executed
 398     // in the correct class context.
 399     if (k-&gt;class_loader() == NULL &amp;&amp;
<span class="line-modified"> 400         k-&gt;name() == vmSymbols::jdk_internal_loader_NativeLibraries()) {</span>
 401       JavaValue result(T_OBJECT);
 402       JavaCalls::call_static(&amp;result, k,
 403                              vmSymbols::getFromClass_name(),
 404                              vmSymbols::void_class_signature(),
 405                              CHECK_NULL);
<span class="line-modified"> 406       // When invoked from JNI_OnLoad, NativeLibraries::getFromClass returns</span>
 407       // a non-NULL Class object.  When invoked from JNI_OnUnload,
 408       // it will return NULL to indicate no context.
 409       oop mirror = (oop) result.get_jobject();
 410       if (mirror != NULL) {
 411         Klass* fromClass = java_lang_Class::as_Klass(mirror);
 412         loader = Handle(THREAD, fromClass-&gt;class_loader());
 413         protection_domain = Handle(THREAD, fromClass-&gt;protection_domain());
 414       }
 415     } else {
 416       loader = Handle(THREAD, k-&gt;class_loader());
 417     }
 418   }
 419 
 420   TempNewSymbol sym = SymbolTable::new_symbol(name);
 421   result = find_class_from_class_loader(env, sym, true, loader,
 422                                         protection_domain, true, thread);
 423 
 424   if (log_is_enabled(Debug, class, resolve) &amp;&amp; result != NULL) {
 425     trace_class_resolution(java_lang_Class::as_Klass(JNIHandles::resolve_non_null(result)));
 426   }
</pre>
</td>
</tr>
</table>
<center><a href="../opto/type.hpp.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="jvm.cpp.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>