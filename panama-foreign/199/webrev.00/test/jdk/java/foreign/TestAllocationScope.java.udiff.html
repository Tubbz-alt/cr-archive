<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff test/jdk/java/foreign/TestAllocationScope.java</title>
    <link rel="stylesheet" href="../../../../style.css" />
  </head>
<body>
<center><a href="../../../../src/jdk.incubator.foreign/share/classes/jdk/internal/foreign/AbstractMemorySegmentImpl.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> next &gt;</center>    <h2>test/jdk/java/foreign/TestAllocationScope.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -25,10 +25,11 @@</span>
  /*
   * @test
   * @run testng TestAllocationScope
   */
  
<span class="udiff-line-added">+ import jdk.incubator.foreign.MemorySegment;</span>
  import jdk.incubator.foreign.NativeAllocationScope;
  import jdk.incubator.foreign.MemoryHandles;
  import jdk.incubator.foreign.MemoryLayouts;
  import jdk.incubator.foreign.MemoryLayout;
  import jdk.incubator.foreign.MemoryAddress;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -36,12 +37,15 @@</span>
  import org.testng.annotations.*;
  
  import java.lang.invoke.VarHandle;
  import java.util.ArrayList;
  import java.util.List;
<span class="udiff-line-added">+ import java.util.concurrent.atomic.AtomicBoolean;</span>
  import java.util.function.Function;
  
<span class="udiff-line-added">+ import static jdk.incubator.foreign.MemorySegment.CLOSE;</span>
<span class="udiff-line-added">+ import static jdk.incubator.foreign.MemorySegment.HANDOFF;</span>
  import static org.testng.Assert.*;
  
  public class TestAllocationScope {
  
      final static int ELEMS = 128;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -101,10 +105,87 @@</span>
                  assertTrue(address.segment().baseAddress().toRawLongValue() % i == 0);
              }
          }
      }
  
<span class="udiff-line-added">+     @Test</span>
<span class="udiff-line-added">+     public void testAttachClose() {</span>
<span class="udiff-line-added">+         MemorySegment s1 = MemorySegment.ofArray(new byte[1]);</span>
<span class="udiff-line-added">+         MemorySegment s2 = MemorySegment.ofArray(new byte[1]);</span>
<span class="udiff-line-added">+         MemorySegment s3 = MemorySegment.ofArray(new byte[1]);</span>
<span class="udiff-line-added">+         assertTrue(s1.isAlive());</span>
<span class="udiff-line-added">+         assertTrue(s2.isAlive());</span>
<span class="udiff-line-added">+         assertTrue(s3.isAlive());</span>
<span class="udiff-line-added">+         try (NativeAllocationScope scope = NativeAllocationScope.boundedScope(10)) {</span>
<span class="udiff-line-added">+             MemorySegment ss1 = scope.claim(s1);</span>
<span class="udiff-line-added">+             assertFalse(s1.isAlive());</span>
<span class="udiff-line-added">+             assertTrue(ss1.isAlive());</span>
<span class="udiff-line-added">+             s1 = ss1;</span>
<span class="udiff-line-added">+             MemorySegment ss2 = scope.claim(s2);</span>
<span class="udiff-line-added">+             assertFalse(s2.isAlive());</span>
<span class="udiff-line-added">+             assertTrue(ss2.isAlive());</span>
<span class="udiff-line-added">+             s2 = ss2;</span>
<span class="udiff-line-added">+             MemorySegment ss3 = scope.claim(s3);</span>
<span class="udiff-line-added">+             assertFalse(s3.isAlive());</span>
<span class="udiff-line-added">+             assertTrue(ss3.isAlive());</span>
<span class="udiff-line-added">+             s3 = ss3;</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+         assertFalse(s1.isAlive());</span>
<span class="udiff-line-added">+         assertFalse(s2.isAlive());</span>
<span class="udiff-line-added">+         assertFalse(s3.isAlive());</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     @Test</span>
<span class="udiff-line-added">+     public void testNoTerminalOps() {</span>
<span class="udiff-line-added">+         try (NativeAllocationScope scope = NativeAllocationScope.boundedScope(10)) {</span>
<span class="udiff-line-added">+             MemorySegment s1 = MemorySegment.ofArray(new byte[1]);</span>
<span class="udiff-line-added">+             MemorySegment attached = scope.claim(s1);</span>
<span class="udiff-line-added">+             int[] terminalOps = {CLOSE, HANDOFF};</span>
<span class="udiff-line-added">+             for (int mode : terminalOps) {</span>
<span class="udiff-line-added">+                 if (attached.hasAccessModes(mode)) {</span>
<span class="udiff-line-added">+                     fail();</span>
<span class="udiff-line-added">+                 }</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     @Test(expectedExceptions = IllegalArgumentException.class)</span>
<span class="udiff-line-added">+     public void testNoReattach() {</span>
<span class="udiff-line-added">+         MemorySegment s1 = MemorySegment.ofArray(new byte[1]);</span>
<span class="udiff-line-added">+         NativeAllocationScope scope1 = NativeAllocationScope.boundedScope(10);</span>
<span class="udiff-line-added">+         NativeAllocationScope scope2 = NativeAllocationScope.boundedScope(10);</span>
<span class="udiff-line-added">+         scope2.claim(scope1.claim(s1));</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     @Test(expectedExceptions = NullPointerException.class)</span>
<span class="udiff-line-added">+     public void testNullClaim() {</span>
<span class="udiff-line-added">+         NativeAllocationScope.boundedScope(10).claim(null);</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     @Test(expectedExceptions = IllegalStateException.class)</span>
<span class="udiff-line-added">+     public void testNotAliveClaim() {</span>
<span class="udiff-line-added">+         MemorySegment segment = MemorySegment.ofArray(new byte[1]);</span>
<span class="udiff-line-added">+         segment.close();</span>
<span class="udiff-line-added">+         NativeAllocationScope.boundedScope(10).claim(segment);</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     @Test</span>
<span class="udiff-line-added">+     public void testNoClaimFromWrongThread() throws InterruptedException {</span>
<span class="udiff-line-added">+         MemorySegment s = MemorySegment.ofArray(new byte[1]);</span>
<span class="udiff-line-added">+         AtomicBoolean failed = new AtomicBoolean(false);</span>
<span class="udiff-line-added">+         Thread t = new Thread(() -&gt; {</span>
<span class="udiff-line-added">+             try {</span>
<span class="udiff-line-added">+                 NativeAllocationScope.boundedScope(10).claim(s);</span>
<span class="udiff-line-added">+             } catch (IllegalArgumentException ex) {</span>
<span class="udiff-line-added">+                 failed.set(true);</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+         });</span>
<span class="udiff-line-added">+         t.start();</span>
<span class="udiff-line-added">+         t.join();</span>
<span class="udiff-line-added">+         assertTrue(failed.get());</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
      @DataProvider(name = &quot;allocationScopes&quot;)
      static Object[][] allocationScopes() {
          return new Object[][] {
                  { (byte)42, (ScopeFactory) NativeAllocationScope::boundedScope, MemoryLayouts.BITS_8_BE, byte.class,
                          (AllocationFunction&lt;Byte&gt;) NativeAllocationScope::allocate,
</pre>
<center><a href="../../../../src/jdk.incubator.foreign/share/classes/jdk/internal/foreign/AbstractMemorySegmentImpl.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> next &gt;</center>  </body>
</html>