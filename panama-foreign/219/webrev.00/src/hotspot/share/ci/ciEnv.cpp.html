<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>New src/hotspot/share/ci/ciEnv.cpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
  </head>
  <body>
    <pre>
   1 /*
   2  * Copyright (c) 1999, 2020, Oracle and/or its affiliates. All rights reserved.
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.
   8  *
   9  * This code is distributed in the hope that it will be useful, but WITHOUT
  10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  *
  23  */
  24 
  25 #include &quot;precompiled.hpp&quot;
  26 #include &quot;jvm.h&quot;
  27 #include &quot;ci/ciConstant.hpp&quot;
  28 #include &quot;ci/ciEnv.hpp&quot;
  29 #include &quot;ci/ciField.hpp&quot;
  30 #include &quot;ci/ciInstance.hpp&quot;
  31 #include &quot;ci/ciInstanceKlass.hpp&quot;
  32 #include &quot;ci/ciMethod.hpp&quot;
  33 #include &quot;ci/ciNullObject.hpp&quot;
  34 #include &quot;ci/ciReplay.hpp&quot;
  35 #include &quot;ci/ciUtilities.inline.hpp&quot;
  36 #include &quot;classfile/symbolTable.hpp&quot;
  37 #include &quot;classfile/systemDictionary.hpp&quot;
  38 #include &quot;classfile/vmSymbols.hpp&quot;
  39 #include &quot;code/codeCache.hpp&quot;
  40 #include &quot;code/scopeDesc.hpp&quot;
  41 #include &quot;compiler/compileBroker.hpp&quot;
  42 #include &quot;compiler/compilerEvent.hpp&quot;
  43 #include &quot;compiler/compileLog.hpp&quot;
  44 #include &quot;compiler/compileTask.hpp&quot;
  45 #include &quot;compiler/disassembler.hpp&quot;
  46 #include &quot;gc/shared/collectedHeap.inline.hpp&quot;
  47 #include &quot;interpreter/linkResolver.hpp&quot;
  48 #include &quot;jfr/jfrEvents.hpp&quot;
  49 #include &quot;logging/log.hpp&quot;
  50 #include &quot;memory/allocation.inline.hpp&quot;
  51 #include &quot;memory/oopFactory.hpp&quot;
  52 #include &quot;memory/resourceArea.hpp&quot;
  53 #include &quot;memory/universe.hpp&quot;
  54 #include &quot;oops/constantPool.inline.hpp&quot;
  55 #include &quot;oops/cpCache.inline.hpp&quot;
  56 #include &quot;oops/method.inline.hpp&quot;
  57 #include &quot;oops/methodData.hpp&quot;
  58 #include &quot;oops/objArrayKlass.hpp&quot;
  59 #include &quot;oops/objArrayOop.inline.hpp&quot;
  60 #include &quot;oops/oop.inline.hpp&quot;
  61 #include &quot;prims/jvmtiExport.hpp&quot;
  62 #include &quot;runtime/handles.inline.hpp&quot;
  63 #include &quot;runtime/init.hpp&quot;
  64 #include &quot;runtime/reflection.hpp&quot;
  65 #include &quot;runtime/jniHandles.inline.hpp&quot;
  66 #include &quot;runtime/safepointVerifiers.hpp&quot;
  67 #include &quot;runtime/sharedRuntime.hpp&quot;
  68 #include &quot;runtime/thread.inline.hpp&quot;
  69 #include &quot;utilities/dtrace.hpp&quot;
  70 #include &quot;utilities/macros.hpp&quot;
  71 #ifdef COMPILER1
  72 #include &quot;c1/c1_Runtime1.hpp&quot;
  73 #endif
  74 #ifdef COMPILER2
  75 #include &quot;opto/runtime.hpp&quot;
  76 #endif
  77 
  78 // ciEnv
  79 //
  80 // This class is the top level broker for requests from the compiler
  81 // to the VM.
  82 
  83 ciObject*              ciEnv::_null_object_instance;
  84 
  85 #define WK_KLASS_DEFN(name, ignore_s) ciInstanceKlass* ciEnv::_##name = NULL;
  86 WK_KLASSES_DO(WK_KLASS_DEFN)
  87 #undef WK_KLASS_DEFN
  88 
  89 ciSymbol*        ciEnv::_unloaded_cisymbol = NULL;
  90 ciInstanceKlass* ciEnv::_unloaded_ciinstance_klass = NULL;
  91 ciObjArrayKlass* ciEnv::_unloaded_ciobjarrayklass = NULL;
  92 
  93 jobject ciEnv::_ArrayIndexOutOfBoundsException_handle = NULL;
  94 jobject ciEnv::_ArrayStoreException_handle = NULL;
  95 jobject ciEnv::_ClassCastException_handle = NULL;
  96 
  97 #ifndef PRODUCT
  98 static bool firstEnv = true;
  99 #endif /* PRODUCT */
 100 
 101 // ------------------------------------------------------------------
 102 // ciEnv::ciEnv
 103 ciEnv::ciEnv(CompileTask* task)
 104   : _ciEnv_arena(mtCompiler) {
 105   VM_ENTRY_MARK;
 106 
 107   // Set up ciEnv::current immediately, for the sake of ciObjectFactory, etc.
 108   thread-&gt;set_env(this);
 109   assert(ciEnv::current() == this, &quot;sanity&quot;);
 110 
 111   _oop_recorder = NULL;
 112   _debug_info = NULL;
 113   _dependencies = NULL;
 114   _failure_reason = NULL;
 115   _inc_decompile_count_on_failure = true;
 116   _compilable = MethodCompilable;
 117   _break_at_compile = false;
 118   _compiler_data = NULL;
 119 #ifndef PRODUCT
 120   assert(!firstEnv, &quot;not initialized properly&quot;);
 121 #endif /* !PRODUCT */
 122 
 123   _num_inlined_bytecodes = 0;
 124   assert(task == NULL || thread-&gt;task() == task, &quot;sanity&quot;);
 125   if (task != NULL) {
 126     task-&gt;mark_started(os::elapsed_counter());
 127   }
 128   _task = task;
 129   _log = NULL;
 130 
 131   // Temporary buffer for creating symbols and such.
 132   _name_buffer = NULL;
 133   _name_buffer_len = 0;
 134 
 135   _arena   = &amp;_ciEnv_arena;
 136   _factory = new (_arena) ciObjectFactory(_arena, 128);
 137 
 138   // Preload commonly referenced system ciObjects.
 139 
 140   // During VM initialization, these instances have not yet been created.
 141   // Assertions ensure that these instances are not accessed before
 142   // their initialization.
 143 
 144   assert(Universe::is_fully_initialized(), &quot;should be complete&quot;);
 145 
 146   oop o = Universe::null_ptr_exception_instance();
 147   assert(o != NULL, &quot;should have been initialized&quot;);
 148   _NullPointerException_instance = get_object(o)-&gt;as_instance();
 149   o = Universe::arithmetic_exception_instance();
 150   assert(o != NULL, &quot;should have been initialized&quot;);
 151   _ArithmeticException_instance = get_object(o)-&gt;as_instance();
 152 
 153   _ArrayIndexOutOfBoundsException_instance = NULL;
 154   _ArrayStoreException_instance = NULL;
 155   _ClassCastException_instance = NULL;
 156   _the_null_string = NULL;
 157   _the_min_jint_string = NULL;
 158 
 159   _jvmti_redefinition_count = 0;
 160   _jvmti_can_hotswap_or_post_breakpoint = false;
 161   _jvmti_can_access_local_variables = false;
 162   _jvmti_can_post_on_exceptions = false;
 163   _jvmti_can_pop_frame = false;
 164 }
 165 
 166 ciEnv::ciEnv(Arena* arena) : _ciEnv_arena(mtCompiler) {
 167   ASSERT_IN_VM;
 168 
 169   // Set up ciEnv::current immediately, for the sake of ciObjectFactory, etc.
 170   CompilerThread* current_thread = CompilerThread::current();
 171   assert(current_thread-&gt;env() == NULL, &quot;must be&quot;);
 172   current_thread-&gt;set_env(this);
 173   assert(ciEnv::current() == this, &quot;sanity&quot;);
 174 
 175   _oop_recorder = NULL;
 176   _debug_info = NULL;
 177   _dependencies = NULL;
 178   _failure_reason = NULL;
 179   _inc_decompile_count_on_failure = true;
 180   _compilable = MethodCompilable_never;
 181   _break_at_compile = false;
 182   _compiler_data = NULL;
 183 #ifndef PRODUCT
 184   assert(firstEnv, &quot;must be first&quot;);
 185   firstEnv = false;
 186 #endif /* !PRODUCT */
 187 
 188   _num_inlined_bytecodes = 0;
 189   _task = NULL;
 190   _log = NULL;
 191 
 192   // Temporary buffer for creating symbols and such.
 193   _name_buffer = NULL;
 194   _name_buffer_len = 0;
 195 
 196   _arena   = arena;
 197   _factory = new (_arena) ciObjectFactory(_arena, 128);
 198 
 199   // Preload commonly referenced system ciObjects.
 200 
 201   // During VM initialization, these instances have not yet been created.
 202   // Assertions ensure that these instances are not accessed before
 203   // their initialization.
 204 
 205   assert(Universe::is_fully_initialized(), &quot;must be&quot;);
 206 
 207   _NullPointerException_instance = NULL;
 208   _ArithmeticException_instance = NULL;
 209   _ArrayIndexOutOfBoundsException_instance = NULL;
 210   _ArrayStoreException_instance = NULL;
 211   _ClassCastException_instance = NULL;
 212   _the_null_string = NULL;
 213   _the_min_jint_string = NULL;
 214 
 215   _jvmti_redefinition_count = 0;
 216   _jvmti_can_hotswap_or_post_breakpoint = false;
 217   _jvmti_can_access_local_variables = false;
 218   _jvmti_can_post_on_exceptions = false;
 219   _jvmti_can_pop_frame = false;
 220 }
 221 
 222 ciEnv::~ciEnv() {
 223   GUARDED_VM_ENTRY(
 224       CompilerThread* current_thread = CompilerThread::current();
 225       _factory-&gt;remove_symbols();
 226       // Need safepoint to clear the env on the thread.  RedefineClasses might
 227       // be reading it.
 228       current_thread-&gt;set_env(NULL);
 229   )
 230 }
 231 
 232 // ------------------------------------------------------------------
 233 // Cache Jvmti state
 234 bool ciEnv::cache_jvmti_state() {
 235   VM_ENTRY_MARK;
 236   // Get Jvmti capabilities under lock to get consistant values.
 237   MutexLocker mu(JvmtiThreadState_lock);
 238   _jvmti_redefinition_count             = JvmtiExport::redefinition_count();
 239   _jvmti_can_hotswap_or_post_breakpoint = JvmtiExport::can_hotswap_or_post_breakpoint();
 240   _jvmti_can_access_local_variables     = JvmtiExport::can_access_local_variables();
 241   _jvmti_can_post_on_exceptions         = JvmtiExport::can_post_on_exceptions();
 242   _jvmti_can_pop_frame                  = JvmtiExport::can_pop_frame();
 243   _jvmti_can_get_owned_monitor_info     = JvmtiExport::can_get_owned_monitor_info();
 244   return _task != NULL &amp;&amp; _task-&gt;method()-&gt;is_old();
 245 }
 246 
 247 bool ciEnv::jvmti_state_changed() const {
 248   // Some classes were redefined
 249   if (_jvmti_redefinition_count != JvmtiExport::redefinition_count()) {
 250     return true;
 251   }
 252 
 253   if (!_jvmti_can_access_local_variables &amp;&amp;
 254       JvmtiExport::can_access_local_variables()) {
 255     return true;
 256   }
 257   if (!_jvmti_can_hotswap_or_post_breakpoint &amp;&amp;
 258       JvmtiExport::can_hotswap_or_post_breakpoint()) {
 259     return true;
 260   }
 261   if (!_jvmti_can_post_on_exceptions &amp;&amp;
 262       JvmtiExport::can_post_on_exceptions()) {
 263     return true;
 264   }
 265   if (!_jvmti_can_pop_frame &amp;&amp;
 266       JvmtiExport::can_pop_frame()) {
 267     return true;
 268   }
 269   if (!_jvmti_can_get_owned_monitor_info &amp;&amp;
 270       JvmtiExport::can_get_owned_monitor_info()) {
 271     return true;
 272   }
 273 
 274   return false;
 275 }
 276 
 277 // ------------------------------------------------------------------
 278 // Cache DTrace flags
 279 void ciEnv::cache_dtrace_flags() {
 280   // Need lock?
 281   _dtrace_extended_probes = ExtendedDTraceProbes;
 282   if (_dtrace_extended_probes) {
 283     _dtrace_monitor_probes  = true;
 284     _dtrace_method_probes   = true;
 285     _dtrace_alloc_probes    = true;
 286   } else {
 287     _dtrace_monitor_probes  = DTraceMonitorProbes;
 288     _dtrace_method_probes   = DTraceMethodProbes;
 289     _dtrace_alloc_probes    = DTraceAllocProbes;
 290   }
 291 }
 292 
 293 // ------------------------------------------------------------------
 294 // helper for lazy exception creation
 295 ciInstance* ciEnv::get_or_create_exception(jobject&amp; handle, Symbol* name) {
 296   VM_ENTRY_MARK;
 297   if (handle == NULL) {
 298     // Cf. universe.cpp, creation of Universe::_null_ptr_exception_instance.
 299     Klass* k = SystemDictionary::find(name, Handle(), Handle(), THREAD);
 300     jobject objh = NULL;
 301     if (!HAS_PENDING_EXCEPTION &amp;&amp; k != NULL) {
 302       oop obj = InstanceKlass::cast(k)-&gt;allocate_instance(THREAD);
 303       if (!HAS_PENDING_EXCEPTION)
 304         objh = JNIHandles::make_global(Handle(THREAD, obj));
 305     }
 306     if (HAS_PENDING_EXCEPTION) {
 307       CLEAR_PENDING_EXCEPTION;
 308     } else {
 309       handle = objh;
 310     }
 311   }
 312   oop obj = JNIHandles::resolve(handle);
 313   return obj == NULL? NULL: get_object(obj)-&gt;as_instance();
 314 }
 315 
 316 ciInstance* ciEnv::ArrayIndexOutOfBoundsException_instance() {
 317   if (_ArrayIndexOutOfBoundsException_instance == NULL) {
 318     _ArrayIndexOutOfBoundsException_instance
 319           = get_or_create_exception(_ArrayIndexOutOfBoundsException_handle,
 320           vmSymbols::java_lang_ArrayIndexOutOfBoundsException());
 321   }
 322   return _ArrayIndexOutOfBoundsException_instance;
 323 }
 324 ciInstance* ciEnv::ArrayStoreException_instance() {
 325   if (_ArrayStoreException_instance == NULL) {
 326     _ArrayStoreException_instance
 327           = get_or_create_exception(_ArrayStoreException_handle,
 328           vmSymbols::java_lang_ArrayStoreException());
 329   }
 330   return _ArrayStoreException_instance;
 331 }
 332 ciInstance* ciEnv::ClassCastException_instance() {
 333   if (_ClassCastException_instance == NULL) {
 334     _ClassCastException_instance
 335           = get_or_create_exception(_ClassCastException_handle,
 336           vmSymbols::java_lang_ClassCastException());
 337   }
 338   return _ClassCastException_instance;
 339 }
 340 
 341 ciInstance* ciEnv::the_null_string() {
 342   if (_the_null_string == NULL) {
 343     VM_ENTRY_MARK;
 344     _the_null_string = get_object(Universe::the_null_string())-&gt;as_instance();
 345   }
 346   return _the_null_string;
 347 }
 348 
 349 ciInstance* ciEnv::the_min_jint_string() {
 350   if (_the_min_jint_string == NULL) {
 351     VM_ENTRY_MARK;
 352     _the_min_jint_string = get_object(Universe::the_min_jint_string())-&gt;as_instance();
 353   }
 354   return _the_min_jint_string;
 355 }
 356 
 357 // ------------------------------------------------------------------
 358 // ciEnv::get_method_from_handle
 359 ciMethod* ciEnv::get_method_from_handle(Method* method) {
 360   VM_ENTRY_MARK;
 361   return get_metadata(method)-&gt;as_method();
 362 }
 363 
 364 // ------------------------------------------------------------------
 365 // ciEnv::array_element_offset_in_bytes
 366 int ciEnv::array_element_offset_in_bytes(ciArray* a_h, ciObject* o_h) {
 367   VM_ENTRY_MARK;
 368   objArrayOop a = (objArrayOop)a_h-&gt;get_oop();
 369   assert(a-&gt;is_objArray(), &quot;&quot;);
 370   int length = a-&gt;length();
 371   oop o = o_h-&gt;get_oop();
 372   for (int i = 0; i &lt; length; i++) {
 373     if (a-&gt;obj_at(i) == o)  return i;
 374   }
 375   return -1;
 376 }
 377 
 378 
 379 // ------------------------------------------------------------------
 380 // ciEnv::check_klass_accessiblity
 381 //
 382 // Note: the logic of this method should mirror the logic of
 383 // ConstantPool::verify_constant_pool_resolve.
 384 bool ciEnv::check_klass_accessibility(ciKlass* accessing_klass,
 385                                       Klass* resolved_klass) {
 386   if (accessing_klass == NULL || !accessing_klass-&gt;is_loaded()) {
 387     return true;
 388   }
 389   if (accessing_klass-&gt;is_obj_array_klass()) {
 390     accessing_klass = accessing_klass-&gt;as_obj_array_klass()-&gt;base_element_klass();
 391   }
 392   if (!accessing_klass-&gt;is_instance_klass()) {
 393     return true;
 394   }
 395 
 396   if (resolved_klass-&gt;is_objArray_klass()) {
 397     // Find the element klass, if this is an array.
 398     resolved_klass = ObjArrayKlass::cast(resolved_klass)-&gt;bottom_klass();
 399   }
 400   if (resolved_klass-&gt;is_instance_klass()) {
 401     return (Reflection::verify_class_access(accessing_klass-&gt;get_Klass(),
 402                                             InstanceKlass::cast(resolved_klass),
 403                                             true) == Reflection::ACCESS_OK);
 404   }
 405   return true;
 406 }
 407 
 408 // ------------------------------------------------------------------
 409 // ciEnv::get_klass_by_name_impl
 410 ciKlass* ciEnv::get_klass_by_name_impl(ciKlass* accessing_klass,
 411                                        const constantPoolHandle&amp; cpool,
 412                                        ciSymbol* name,
 413                                        bool require_local) {
 414   ASSERT_IN_VM;
 415   EXCEPTION_CONTEXT;
 416 
 417   // Now we need to check the SystemDictionary
 418   Symbol* sym = name-&gt;get_symbol();
 419   if (Signature::has_envelope(sym)) {
 420     // This is a name from a signature.  Strip off the trimmings.
 421     // Call recursive to keep scope of strippedsym.
 422     TempNewSymbol strippedsym = Signature::strip_envelope(sym);
 423     ciSymbol* strippedname = get_symbol(strippedsym);
 424     return get_klass_by_name_impl(accessing_klass, cpool, strippedname, require_local);
 425   }
 426 
 427   // Check for prior unloaded klass.  The SystemDictionary&#39;s answers
 428   // can vary over time but the compiler needs consistency.
 429   ciKlass* unloaded_klass = check_get_unloaded_klass(accessing_klass, name);
 430   if (unloaded_klass != NULL) {
 431     if (require_local)  return NULL;
 432     return unloaded_klass;
 433   }
 434 
 435   Handle loader(THREAD, (oop)NULL);
 436   Handle domain(THREAD, (oop)NULL);
 437   if (accessing_klass != NULL) {
 438     loader = Handle(THREAD, accessing_klass-&gt;loader());
 439     domain = Handle(THREAD, accessing_klass-&gt;protection_domain());
 440   }
 441 
 442   // setup up the proper type to return on OOM
 443   ciKlass* fail_type;
 444   if (sym-&gt;char_at(0) == JVM_SIGNATURE_ARRAY) {
 445     fail_type = _unloaded_ciobjarrayklass;
 446   } else {
 447     fail_type = _unloaded_ciinstance_klass;
 448   }
 449   Klass* found_klass;
 450   {
 451     ttyUnlocker ttyul;  // release tty lock to avoid ordering problems
 452     MutexLocker ml(Compile_lock);
 453     Klass* kls;
 454     if (!require_local) {
 455       kls = SystemDictionary::find_constrained_instance_or_array_klass(sym, loader,
 456                                                                        KILL_COMPILE_ON_FATAL_(fail_type));
 457     } else {
 458       kls = SystemDictionary::find_instance_or_array_klass(sym, loader, domain,
 459                                                            KILL_COMPILE_ON_FATAL_(fail_type));
 460     }
 461     found_klass = kls;
 462   }
 463 
 464   // If we fail to find an array klass, look again for its element type.
 465   // The element type may be available either locally or via constraints.
 466   // In either case, if we can find the element type in the system dictionary,
 467   // we must build an array type around it.  The CI requires array klasses
 468   // to be loaded if their element klasses are loaded, except when memory
 469   // is exhausted.
 470   if (Signature::is_array(sym) &amp;&amp;
 471       (sym-&gt;char_at(1) == JVM_SIGNATURE_ARRAY || sym-&gt;char_at(1) == JVM_SIGNATURE_CLASS)) {
 472     // We have an unloaded array.
 473     // Build it on the fly if the element class exists.
 474     SignatureStream ss(sym, false);
 475     ss.skip_array_prefix(1);
 476     // Get element ciKlass recursively.
 477     ciKlass* elem_klass =
 478       get_klass_by_name_impl(accessing_klass,
 479                              cpool,
 480                              get_symbol(ss.as_symbol()),
 481                              require_local);
 482     if (elem_klass != NULL &amp;&amp; elem_klass-&gt;is_loaded()) {
 483       // Now make an array for it
 484       return ciObjArrayKlass::make_impl(elem_klass);
 485     }
 486   }
 487 
 488   if (found_klass == NULL &amp;&amp; !cpool.is_null() &amp;&amp; cpool-&gt;has_preresolution()) {
 489     // Look inside the constant pool for pre-resolved class entries.
 490     for (int i = cpool-&gt;length() - 1; i &gt;= 1; i--) {
 491       if (cpool-&gt;tag_at(i).is_klass()) {
 492         Klass* kls = cpool-&gt;resolved_klass_at(i);
 493         if (kls-&gt;name() == sym) {
 494           found_klass = kls;
 495           break;
 496         }
 497       }
 498     }
 499   }
 500 
 501   if (found_klass != NULL) {
 502     // Found it.  Build a CI handle.
 503     return get_klass(found_klass);
 504   }
 505 
 506   if (require_local)  return NULL;
 507 
 508   // Not yet loaded into the VM, or not governed by loader constraints.
 509   // Make a CI representative for it.
 510   return get_unloaded_klass(accessing_klass, name);
 511 }
 512 
 513 // ------------------------------------------------------------------
 514 // ciEnv::get_klass_by_name
 515 ciKlass* ciEnv::get_klass_by_name(ciKlass* accessing_klass,
 516                                   ciSymbol* klass_name,
 517                                   bool require_local) {
 518   GUARDED_VM_ENTRY(return get_klass_by_name_impl(accessing_klass,
 519                                                  constantPoolHandle(),
 520                                                  klass_name,
 521                                                  require_local);)
 522 }
 523 
 524 // ------------------------------------------------------------------
 525 // ciEnv::get_klass_by_index_impl
 526 //
 527 // Implementation of get_klass_by_index.
 528 ciKlass* ciEnv::get_klass_by_index_impl(const constantPoolHandle&amp; cpool,
 529                                         int index,
 530                                         bool&amp; is_accessible,
 531                                         ciInstanceKlass* accessor) {
 532   EXCEPTION_CONTEXT;
 533   Klass* klass = NULL;
 534   Symbol* klass_name = NULL;
 535 
 536   if (cpool-&gt;tag_at(index).is_symbol()) {
 537     klass_name = cpool-&gt;symbol_at(index);
 538   } else {
 539     // Check if it&#39;s resolved if it&#39;s not a symbol constant pool entry.
 540     klass =  ConstantPool::klass_at_if_loaded(cpool, index);
 541     // Try to look it up by name.
 542     if (klass == NULL) {
 543       klass_name = cpool-&gt;klass_name_at(index);
 544     }
 545   }
 546 
 547   if (klass == NULL) {
 548     // Not found in constant pool.  Use the name to do the lookup.
 549     ciKlass* k = get_klass_by_name_impl(accessor,
 550                                         cpool,
 551                                         get_symbol(klass_name),
 552                                         false);
 553     // Calculate accessibility the hard way.
 554     if (!k-&gt;is_loaded()) {
 555       is_accessible = false;
 556     } else if (k-&gt;loader() != accessor-&gt;loader() &amp;&amp;
 557                get_klass_by_name_impl(accessor, cpool, k-&gt;name(), true) == NULL) {
 558       // Loaded only remotely.  Not linked yet.
 559       is_accessible = false;
 560     } else {
 561       // Linked locally, and we must also check public/private, etc.
 562       is_accessible = check_klass_accessibility(accessor, k-&gt;get_Klass());
 563     }
 564     return k;
 565   }
 566 
 567   // Check for prior unloaded klass.  The SystemDictionary&#39;s answers
 568   // can vary over time but the compiler needs consistency.
 569   ciSymbol* name = get_symbol(klass-&gt;name());
 570   ciKlass* unloaded_klass = check_get_unloaded_klass(accessor, name);
 571   if (unloaded_klass != NULL) {
 572     is_accessible = false;
 573     return unloaded_klass;
 574   }
 575 
 576   // It is known to be accessible, since it was found in the constant pool.
 577   is_accessible = true;
 578   return get_klass(klass);
 579 }
 580 
 581 // ------------------------------------------------------------------
 582 // ciEnv::get_klass_by_index
 583 //
 584 // Get a klass from the constant pool.
 585 ciKlass* ciEnv::get_klass_by_index(const constantPoolHandle&amp; cpool,
 586                                    int index,
 587                                    bool&amp; is_accessible,
 588                                    ciInstanceKlass* accessor) {
 589   GUARDED_VM_ENTRY(return get_klass_by_index_impl(cpool, index, is_accessible, accessor);)
 590 }
 591 
 592 // ------------------------------------------------------------------
 593 // ciEnv::get_constant_by_index_impl
 594 //
 595 // Implementation of get_constant_by_index().
 596 ciConstant ciEnv::get_constant_by_index_impl(const constantPoolHandle&amp; cpool,
 597                                              int pool_index, int cache_index,
 598                                              ciInstanceKlass* accessor) {
 599   bool ignore_will_link;
 600   EXCEPTION_CONTEXT;
 601   int index = pool_index;
 602   if (cache_index &gt;= 0) {
 603     assert(index &lt; 0, &quot;only one kind of index at a time&quot;);
 604     index = cpool-&gt;object_to_cp_index(cache_index);
 605     oop obj = cpool-&gt;resolved_references()-&gt;obj_at(cache_index);
 606     if (obj != NULL) {
 607       if (obj == Universe::the_null_sentinel()) {
 608         return ciConstant(T_OBJECT, get_object(NULL));
 609       }
 610       BasicType bt = T_OBJECT;
 611       if (cpool-&gt;tag_at(index).is_dynamic_constant())
 612         bt = Signature::basic_type(cpool-&gt;uncached_signature_ref_at(index));
 613       if (is_reference_type(bt)) {
 614       } else {
 615         // we have to unbox the primitive value
 616         if (!is_java_primitive(bt))  return ciConstant();
 617         jvalue value;
 618         BasicType bt2 = java_lang_boxing_object::get_value(obj, &amp;value);
 619         assert(bt2 == bt, &quot;&quot;);
 620         switch (bt2) {
 621         case T_DOUBLE:  return ciConstant(value.d);
 622         case T_FLOAT:   return ciConstant(value.f);
 623         case T_LONG:    return ciConstant(value.j);
 624         case T_INT:     return ciConstant(bt2, value.i);
 625         case T_SHORT:   return ciConstant(bt2, value.s);
 626         case T_BYTE:    return ciConstant(bt2, value.b);
 627         case T_CHAR:    return ciConstant(bt2, value.c);
 628         case T_BOOLEAN: return ciConstant(bt2, value.z);
 629         default:  return ciConstant();
 630         }
 631       }
 632       ciObject* ciobj = get_object(obj);
 633       if (ciobj-&gt;is_array()) {
 634         return ciConstant(T_ARRAY, ciobj);
 635       } else {
 636         assert(ciobj-&gt;is_instance(), &quot;should be an instance&quot;);
 637         return ciConstant(T_OBJECT, ciobj);
 638       }
 639     }
 640   }
 641   constantTag tag = cpool-&gt;tag_at(index);
 642   if (tag.is_int()) {
 643     return ciConstant(T_INT, (jint)cpool-&gt;int_at(index));
 644   } else if (tag.is_long()) {
 645     return ciConstant((jlong)cpool-&gt;long_at(index));
 646   } else if (tag.is_float()) {
 647     return ciConstant((jfloat)cpool-&gt;float_at(index));
 648   } else if (tag.is_double()) {
 649     return ciConstant((jdouble)cpool-&gt;double_at(index));
 650   } else if (tag.is_string()) {
 651     oop string = NULL;
 652     assert(cache_index &gt;= 0, &quot;should have a cache index&quot;);
 653     if (cpool-&gt;is_pseudo_string_at(index)) {
 654       string = cpool-&gt;pseudo_string_at(index, cache_index);
 655     } else {
 656       string = cpool-&gt;string_at(index, cache_index, THREAD);
 657       if (HAS_PENDING_EXCEPTION) {
 658         CLEAR_PENDING_EXCEPTION;
 659         record_out_of_memory_failure();
 660         return ciConstant();
 661       }
 662     }
 663     ciObject* constant = get_object(string);
 664     if (constant-&gt;is_array()) {
 665       return ciConstant(T_ARRAY, constant);
 666     } else {
 667       assert (constant-&gt;is_instance(), &quot;must be an instance, or not? &quot;);
 668       return ciConstant(T_OBJECT, constant);
 669     }
 670   } else if (tag.is_klass() || tag.is_unresolved_klass()) {
 671     // 4881222: allow ldc to take a class type
 672     ciKlass* klass = get_klass_by_index_impl(cpool, index, ignore_will_link, accessor);
 673     if (HAS_PENDING_EXCEPTION) {
 674       CLEAR_PENDING_EXCEPTION;
 675       record_out_of_memory_failure();
 676       return ciConstant();
 677     }
 678     assert (klass-&gt;is_instance_klass() || klass-&gt;is_array_klass(),
 679             &quot;must be an instance or array klass &quot;);
 680     return ciConstant(T_OBJECT, klass-&gt;java_mirror());
 681   } else if (tag.is_method_type()) {
 682     // must execute Java code to link this CP entry into cache[i].f1
 683     ciSymbol* signature = get_symbol(cpool-&gt;method_type_signature_at(index));
 684     ciObject* ciobj = get_unloaded_method_type_constant(signature);
 685     return ciConstant(T_OBJECT, ciobj);
 686   } else if (tag.is_method_handle()) {
 687     // must execute Java code to link this CP entry into cache[i].f1
 688     int ref_kind        = cpool-&gt;method_handle_ref_kind_at(index);
 689     int callee_index    = cpool-&gt;method_handle_klass_index_at(index);
 690     ciKlass* callee     = get_klass_by_index_impl(cpool, callee_index, ignore_will_link, accessor);
 691     ciSymbol* name      = get_symbol(cpool-&gt;method_handle_name_ref_at(index));
 692     ciSymbol* signature = get_symbol(cpool-&gt;method_handle_signature_ref_at(index));
 693     ciObject* ciobj     = get_unloaded_method_handle_constant(callee, name, signature, ref_kind);
 694     return ciConstant(T_OBJECT, ciobj);
 695   } else if (tag.is_dynamic_constant()) {
 696     return ciConstant();
 697   } else {
 698     ShouldNotReachHere();
 699     return ciConstant();
 700   }
 701 }
 702 
 703 // ------------------------------------------------------------------
 704 // ciEnv::get_constant_by_index
 705 //
 706 // Pull a constant out of the constant pool.  How appropriate.
 707 //
 708 // Implementation note: this query is currently in no way cached.
 709 ciConstant ciEnv::get_constant_by_index(const constantPoolHandle&amp; cpool,
 710                                         int pool_index, int cache_index,
 711                                         ciInstanceKlass* accessor) {
 712   GUARDED_VM_ENTRY(return get_constant_by_index_impl(cpool, pool_index, cache_index, accessor);)
 713 }
 714 
 715 // ------------------------------------------------------------------
 716 // ciEnv::get_field_by_index_impl
 717 //
 718 // Implementation of get_field_by_index.
 719 //
 720 // Implementation note: the results of field lookups are cached
 721 // in the accessor klass.
 722 ciField* ciEnv::get_field_by_index_impl(ciInstanceKlass* accessor,
 723                                         int index) {
 724   ciConstantPoolCache* cache = accessor-&gt;field_cache();
 725   if (cache == NULL) {
 726     ciField* field = new (arena()) ciField(accessor, index);
 727     return field;
 728   } else {
 729     ciField* field = (ciField*)cache-&gt;get(index);
 730     if (field == NULL) {
 731       field = new (arena()) ciField(accessor, index);
 732       cache-&gt;insert(index, field);
 733     }
 734     return field;
 735   }
 736 }
 737 
 738 // ------------------------------------------------------------------
 739 // ciEnv::get_field_by_index
 740 //
 741 // Get a field by index from a klass&#39;s constant pool.
 742 ciField* ciEnv::get_field_by_index(ciInstanceKlass* accessor,
 743                                    int index) {
 744   GUARDED_VM_ENTRY(return get_field_by_index_impl(accessor, index);)
 745 }
 746 
 747 // ------------------------------------------------------------------
 748 // ciEnv::lookup_method
 749 //
 750 // Perform an appropriate method lookup based on accessor, holder,
 751 // name, signature, and bytecode.
 752 Method* ciEnv::lookup_method(ciInstanceKlass* accessor,
 753                              ciKlass*         holder,
 754                              Symbol*          name,
 755                              Symbol*          sig,
 756                              Bytecodes::Code  bc,
 757                              constantTag      tag) {
 758   // Accessibility checks are performed in ciEnv::get_method_by_index_impl.
 759   assert(check_klass_accessibility(accessor, holder-&gt;get_Klass()), &quot;holder not accessible&quot;);
 760 
 761   InstanceKlass* accessor_klass = accessor-&gt;get_instanceKlass();
 762   Klass* holder_klass = holder-&gt;get_Klass();
 763   Method* dest_method;
 764   LinkInfo link_info(holder_klass, name, sig, accessor_klass, LinkInfo::needs_access_check, tag);
 765   switch (bc) {
 766   case Bytecodes::_invokestatic:
 767     dest_method =
 768       LinkResolver::resolve_static_call_or_null(link_info);
 769     break;
 770   case Bytecodes::_invokespecial:
 771     dest_method =
 772       LinkResolver::resolve_special_call_or_null(link_info);
 773     break;
 774   case Bytecodes::_invokeinterface:
 775     dest_method =
 776       LinkResolver::linktime_resolve_interface_method_or_null(link_info);
 777     break;
 778   case Bytecodes::_invokevirtual:
 779     dest_method =
 780       LinkResolver::linktime_resolve_virtual_method_or_null(link_info);
 781     break;
 782   default: ShouldNotReachHere();
 783   }
 784 
 785   return dest_method;
 786 }
 787 
 788 
 789 // ------------------------------------------------------------------
 790 // ciEnv::get_method_by_index_impl
 791 ciMethod* ciEnv::get_method_by_index_impl(const constantPoolHandle&amp; cpool,
 792                                           int index, Bytecodes::Code bc,
 793                                           ciInstanceKlass* accessor) {
 794   assert(cpool.not_null(), &quot;need constant pool&quot;);
 795   assert(accessor != NULL, &quot;need origin of access&quot;);
 796   if (bc == Bytecodes::_invokedynamic) {
 797     ConstantPoolCacheEntry* cpce = cpool-&gt;invokedynamic_cp_cache_entry_at(index);
 798     bool is_resolved = !cpce-&gt;is_f1_null();
 799     // FIXME: code generation could allow for null (unlinked) call site
 800     // The call site could be made patchable as follows:
 801     // Load the appendix argument from the constant pool.
 802     // Test the appendix argument and jump to a known deopt routine if it is null.
 803     // Jump through a patchable call site, which is initially a deopt routine.
 804     // Patch the call site to the nmethod entry point of the static compiled lambda form.
 805     // As with other two-component call sites, both values must be independently verified.
 806 
 807     if (is_resolved) {
 808       // Get the invoker Method* from the constant pool.
 809       // (The appendix argument, if any, will be noted in the method&#39;s signature.)
 810       Method* adapter = cpce-&gt;f1_as_method();
 811       return get_method(adapter);
 812     }
 813 
 814     // Fake a method that is equivalent to a declared method.
 815     ciInstanceKlass* holder    = get_instance_klass(SystemDictionary::MethodHandle_klass());
 816     ciSymbol*        name      = ciSymbol::invokeBasic_name();
 817     ciSymbol*        signature = get_symbol(cpool-&gt;signature_ref_at(index));
 818     return get_unloaded_method(holder, name, signature, accessor);
 819   } else {
 820     const int holder_index = cpool-&gt;klass_ref_index_at(index);
 821     bool holder_is_accessible;
 822     ciKlass* holder = get_klass_by_index_impl(cpool, holder_index, holder_is_accessible, accessor);
 823 
 824     // Get the method&#39;s name and signature.
 825     Symbol* name_sym = cpool-&gt;name_ref_at(index);
 826     Symbol* sig_sym  = cpool-&gt;signature_ref_at(index);
 827 
 828     if (cpool-&gt;has_preresolution()
 829         || ((holder == ciEnv::MethodHandle_klass() || holder == ciEnv::VarHandle_klass()) &amp;&amp;
 830             MethodHandles::is_signature_polymorphic_name(holder-&gt;get_Klass(), name_sym))) {
 831       // Short-circuit lookups for JSR 292-related call sites.
 832       // That is, do not rely only on name-based lookups, because they may fail
 833       // if the names are not resolvable in the boot class loader (7056328).
 834       switch (bc) {
 835       case Bytecodes::_invokevirtual:
 836       case Bytecodes::_invokeinterface:
 837       case Bytecodes::_invokespecial:
 838       case Bytecodes::_invokestatic:
 839         {
 840           Method* m = ConstantPool::method_at_if_loaded(cpool, index);
 841           if (m != NULL) {
 842             return get_method(m);
 843           }
 844         }
 845         break;
 846       default:
 847         break;
 848       }
 849     }
 850 
 851     if (holder_is_accessible) {  // Our declared holder is loaded.
 852       constantTag tag = cpool-&gt;tag_ref_at(index);
 853       assert(accessor-&gt;get_instanceKlass() == cpool-&gt;pool_holder(), &quot;not the pool holder?&quot;);
 854       Method* m = lookup_method(accessor, holder, name_sym, sig_sym, bc, tag);
 855       if (m != NULL &amp;&amp;
 856           (bc == Bytecodes::_invokestatic
 857            ?  m-&gt;method_holder()-&gt;is_not_initialized()
 858            : !m-&gt;method_holder()-&gt;is_loaded())) {
 859         m = NULL;
 860       }
 861 #ifdef ASSERT
 862       if (m != NULL &amp;&amp; ReplayCompiles &amp;&amp; !ciReplay::is_loaded(m)) {
 863         m = NULL;
 864       }
 865 #endif
 866       if (m != NULL) {
 867         // We found the method.
 868         return get_method(m);
 869       }
 870     }
 871 
 872     // Either the declared holder was not loaded, or the method could
 873     // not be found.  Create a dummy ciMethod to represent the failed
 874     // lookup.
 875     ciSymbol* name      = get_symbol(name_sym);
 876     ciSymbol* signature = get_symbol(sig_sym);
 877     return get_unloaded_method(holder, name, signature, accessor);
 878   }
 879 }
 880 
 881 
 882 // ------------------------------------------------------------------
 883 // ciEnv::get_instance_klass_for_declared_method_holder
 884 ciInstanceKlass* ciEnv::get_instance_klass_for_declared_method_holder(ciKlass* method_holder) {
 885   // For the case of &lt;array&gt;.clone(), the method holder can be a ciArrayKlass
 886   // instead of a ciInstanceKlass.  For that case simply pretend that the
 887   // declared holder is Object.clone since that&#39;s where the call will bottom out.
 888   // A more correct fix would trickle out through many interfaces in CI,
 889   // requiring ciInstanceKlass* to become ciKlass* and many more places would
 890   // require checks to make sure the expected type was found.  Given that this
 891   // only occurs for clone() the more extensive fix seems like overkill so
 892   // instead we simply smear the array type into Object.
 893   guarantee(method_holder != NULL, &quot;no method holder&quot;);
 894   if (method_holder-&gt;is_instance_klass()) {
 895     return method_holder-&gt;as_instance_klass();
 896   } else if (method_holder-&gt;is_array_klass()) {
 897     return current()-&gt;Object_klass();
 898   } else {
 899     ShouldNotReachHere();
 900   }
 901   return NULL;
 902 }
 903 
 904 
 905 // ------------------------------------------------------------------
 906 // ciEnv::get_method_by_index
 907 ciMethod* ciEnv::get_method_by_index(const constantPoolHandle&amp; cpool,
 908                                      int index, Bytecodes::Code bc,
 909                                      ciInstanceKlass* accessor) {
 910   GUARDED_VM_ENTRY(return get_method_by_index_impl(cpool, index, bc, accessor);)
 911 }
 912 
 913 
 914 // ------------------------------------------------------------------
 915 // ciEnv::name_buffer
 916 char *ciEnv::name_buffer(int req_len) {
 917   if (_name_buffer_len &lt; req_len) {
 918     if (_name_buffer == NULL) {
 919       _name_buffer = (char*)arena()-&gt;Amalloc(sizeof(char)*req_len);
 920       _name_buffer_len = req_len;
 921     } else {
 922       _name_buffer =
 923         (char*)arena()-&gt;Arealloc(_name_buffer, _name_buffer_len, req_len);
 924       _name_buffer_len = req_len;
 925     }
 926   }
 927   return _name_buffer;
 928 }
 929 
 930 // ------------------------------------------------------------------
 931 // ciEnv::is_in_vm
 932 bool ciEnv::is_in_vm() {
 933   return JavaThread::current()-&gt;thread_state() == _thread_in_vm;
 934 }
 935 
 936 // ------------------------------------------------------------------
 937 // ciEnv::validate_compile_task_dependencies
 938 //
 939 // Check for changes during compilation (e.g. class loads, evolution,
 940 // breakpoints, call site invalidation).
 941 void ciEnv::validate_compile_task_dependencies(ciMethod* target) {
 942   if (failing())  return;  // no need for further checks
 943 
 944   Dependencies::DepType result = dependencies()-&gt;validate_dependencies(_task);
 945   if (result != Dependencies::end_marker) {
 946     if (result == Dependencies::call_site_target_value) {
 947       _inc_decompile_count_on_failure = false;
 948       record_failure(&quot;call site target change&quot;);
 949     } else if (Dependencies::is_klass_type(result)) {
 950       record_failure(&quot;concurrent class loading&quot;);
 951     } else {
 952       record_failure(&quot;invalid non-klass dependency&quot;);
 953     }
 954   }
 955 }
 956 
 957 // ------------------------------------------------------------------
 958 // ciEnv::register_method
 959 void ciEnv::register_method(ciMethod* target,
 960                             int entry_bci,
 961                             CodeOffsets* offsets,
 962                             int orig_pc_offset,
 963                             CodeBuffer* code_buffer,
 964                             int frame_words,
 965                             OopMapSet* oop_map_set,
 966                             ExceptionHandlerTable* handler_table,
 967                             ImplicitExceptionTable* inc_table,
 968                             AbstractCompiler* compiler,
 969                             bool has_unsafe_access,
 970                             bool has_wide_vectors,
 971                             RTMState  rtm_state,
 972                             address* native_stubs,
 973                             int num_stubs) {
 974   VM_ENTRY_MARK;
 975   nmethod* nm = NULL;
 976   {
 977     // To prevent compile queue updates.
 978     MutexLocker locker(THREAD, MethodCompileQueue_lock);
 979 
 980     // Prevent SystemDictionary::add_to_hierarchy from running
 981     // and invalidating our dependencies until we install this method.
 982     // No safepoints are allowed. Otherwise, class redefinition can occur in between.
 983     MutexLocker ml(Compile_lock);
 984     NoSafepointVerifier nsv;
 985 
 986     // Change in Jvmti state may invalidate compilation.
 987     if (!failing() &amp;&amp; jvmti_state_changed()) {
 988       record_failure(&quot;Jvmti state change invalidated dependencies&quot;);
 989     }
 990 
 991     // Change in DTrace flags may invalidate compilation.
 992     if (!failing() &amp;&amp;
 993         ( (!dtrace_extended_probes() &amp;&amp; ExtendedDTraceProbes) ||
 994           (!dtrace_method_probes() &amp;&amp; DTraceMethodProbes) ||
 995           (!dtrace_alloc_probes() &amp;&amp; DTraceAllocProbes) )) {
 996       record_failure(&quot;DTrace flags change invalidated dependencies&quot;);
 997     }
 998 
 999     if (!failing() &amp;&amp; target-&gt;needs_clinit_barrier() &amp;&amp;
1000         target-&gt;holder()-&gt;is_in_error_state()) {
1001       record_failure(&quot;method holder is in error state&quot;);
1002     }
1003 
1004     if (!failing()) {
1005       if (log() != NULL) {
1006         // Log the dependencies which this compilation declares.
1007         dependencies()-&gt;log_all_dependencies();
1008       }
1009 
1010       // Encode the dependencies now, so we can check them right away.
1011       dependencies()-&gt;encode_content_bytes();
1012 
1013       // Check for {class loads, evolution, breakpoints, ...} during compilation
1014       validate_compile_task_dependencies(target);
1015     }
1016 
1017     methodHandle method(THREAD, target-&gt;get_Method());
1018 
1019 #if INCLUDE_RTM_OPT
1020     if (!failing() &amp;&amp; (rtm_state != NoRTM) &amp;&amp;
1021         (method()-&gt;method_data() != NULL) &amp;&amp;
1022         (method()-&gt;method_data()-&gt;rtm_state() != rtm_state)) {
1023       // Preemptive decompile if rtm state was changed.
1024       record_failure(&quot;RTM state change invalidated rtm code&quot;);
1025     }
1026 #endif
1027 
1028     if (failing()) {
1029       // While not a true deoptimization, it is a preemptive decompile.
1030       MethodData* mdo = method()-&gt;method_data();
1031       if (mdo != NULL &amp;&amp; _inc_decompile_count_on_failure) {
1032         mdo-&gt;inc_decompile_count();
1033       }
1034 
1035       // All buffers in the CodeBuffer are allocated in the CodeCache.
1036       // If the code buffer is created on each compile attempt
1037       // as in C2, then it must be freed.
1038       code_buffer-&gt;free_blob();
1039       return;
1040     }
1041 
1042     assert(offsets-&gt;value(CodeOffsets::Deopt) != -1, &quot;must have deopt entry&quot;);
1043     assert(offsets-&gt;value(CodeOffsets::Exceptions) != -1, &quot;must have exception entry&quot;);
1044 
1045     nm =  nmethod::new_nmethod(method,
1046                                compile_id(),
1047                                entry_bci,
1048                                offsets,
1049                                orig_pc_offset,
1050                                debug_info(), dependencies(), code_buffer,
1051                                frame_words, oop_map_set,
1052                                handler_table, inc_table,
1053                                compiler, task()-&gt;comp_level(),
1054                                native_stubs, num_stubs);
1055 
1056     // Free codeBlobs
1057     code_buffer-&gt;free_blob();
1058 
1059     if (nm != NULL) {
1060       nm-&gt;set_has_unsafe_access(has_unsafe_access);
1061       nm-&gt;set_has_wide_vectors(has_wide_vectors);
1062 #if INCLUDE_RTM_OPT
1063       nm-&gt;set_rtm_state(rtm_state);
1064 #endif
1065 
1066       // Record successful registration.
1067       // (Put nm into the task handle *before* publishing to the Java heap.)
1068       if (task() != NULL) {
1069         task()-&gt;set_code(nm);
1070       }
1071 
1072       if (entry_bci == InvocationEntryBci) {
1073         if (TieredCompilation) {
1074           // If there is an old version we&#39;re done with it
1075           CompiledMethod* old = method-&gt;code();
1076           if (TraceMethodReplacement &amp;&amp; old != NULL) {
1077             ResourceMark rm;
1078             char *method_name = method-&gt;name_and_sig_as_C_string();
1079             tty-&gt;print_cr(&quot;Replacing method %s&quot;, method_name);
1080           }
1081           if (old != NULL) {
1082             old-&gt;make_not_used();
1083           }
1084         }
1085 
1086         LogTarget(Info, nmethod, install) lt;
1087         if (lt.is_enabled()) {
1088           ResourceMark rm;
1089           char *method_name = method-&gt;name_and_sig_as_C_string();
1090           lt.print(&quot;Installing method (%d) %s &quot;,
1091                     task()-&gt;comp_level(), method_name);
1092         }
1093         // Allow the code to be executed
1094         MutexLocker ml(CompiledMethod_lock, Mutex::_no_safepoint_check_flag);
1095         if (nm-&gt;make_in_use()) {
1096           method-&gt;set_code(method, nm);
1097         }
1098       } else {
1099         LogTarget(Info, nmethod, install) lt;
1100         if (lt.is_enabled()) {
1101           ResourceMark rm;
1102           char *method_name = method-&gt;name_and_sig_as_C_string();
1103           lt.print(&quot;Installing osr method (%d) %s @ %d&quot;,
1104                     task()-&gt;comp_level(), method_name, entry_bci);
1105         }
1106         MutexLocker ml(CompiledMethod_lock, Mutex::_no_safepoint_check_flag);
1107         if (nm-&gt;make_in_use()) {
1108           method-&gt;method_holder()-&gt;add_osr_nmethod(nm);
1109         }
1110       }
1111     }
1112   }  // safepoints are allowed again
1113 
1114   if (nm != NULL) {
1115     // JVMTI -- compiled method notification (must be done outside lock)
1116     nm-&gt;post_compiled_method_load_event();
1117   } else {
1118     // The CodeCache is full.
1119     record_failure(&quot;code cache is full&quot;);
1120   }
1121 }
1122 
1123 
1124 // ------------------------------------------------------------------
1125 // ciEnv::find_system_klass
1126 ciKlass* ciEnv::find_system_klass(ciSymbol* klass_name) {
1127   VM_ENTRY_MARK;
1128   return get_klass_by_name_impl(NULL, constantPoolHandle(), klass_name, false);
1129 }
1130 
1131 // ------------------------------------------------------------------
1132 // ciEnv::comp_level
1133 int ciEnv::comp_level() {
1134   if (task() == NULL)  return CompLevel_highest_tier;
1135   return task()-&gt;comp_level();
1136 }
1137 
1138 // ------------------------------------------------------------------
1139 // ciEnv::compile_id
1140 uint ciEnv::compile_id() {
1141   if (task() == NULL)  return 0;
1142   return task()-&gt;compile_id();
1143 }
1144 
1145 // ------------------------------------------------------------------
1146 // ciEnv::notice_inlined_method()
1147 void ciEnv::notice_inlined_method(ciMethod* method) {
1148   _num_inlined_bytecodes += method-&gt;code_size_for_inlining();
1149 }
1150 
1151 // ------------------------------------------------------------------
1152 // ciEnv::num_inlined_bytecodes()
1153 int ciEnv::num_inlined_bytecodes() const {
1154   return _num_inlined_bytecodes;
1155 }
1156 
1157 // ------------------------------------------------------------------
1158 // ciEnv::record_failure()
1159 void ciEnv::record_failure(const char* reason) {
1160   if (_failure_reason == NULL) {
1161     // Record the first failure reason.
1162     _failure_reason = reason;
1163   }
1164 }
1165 
1166 void ciEnv::report_failure(const char* reason) {
1167   EventCompilationFailure event;
1168   if (event.should_commit()) {
1169     CompilerEvent::CompilationFailureEvent::post(event, compile_id(), reason);
1170   }
1171 }
1172 
1173 // ------------------------------------------------------------------
1174 // ciEnv::record_method_not_compilable()
1175 void ciEnv::record_method_not_compilable(const char* reason, bool all_tiers) {
1176   int new_compilable =
1177     all_tiers ? MethodCompilable_never : MethodCompilable_not_at_tier ;
1178 
1179   // Only note transitions to a worse state
1180   if (new_compilable &gt; _compilable) {
1181     if (log() != NULL) {
1182       if (all_tiers) {
1183         log()-&gt;elem(&quot;method_not_compilable&quot;);
1184       } else {
1185         log()-&gt;elem(&quot;method_not_compilable_at_tier level=&#39;%d&#39;&quot;,
1186                     current()-&gt;task()-&gt;comp_level());
1187       }
1188     }
1189     _compilable = new_compilable;
1190 
1191     // Reset failure reason; this one is more important.
1192     _failure_reason = NULL;
1193     record_failure(reason);
1194   }
1195 }
1196 
1197 // ------------------------------------------------------------------
1198 // ciEnv::record_out_of_memory_failure()
1199 void ciEnv::record_out_of_memory_failure() {
1200   // If memory is low, we stop compiling methods.
1201   record_method_not_compilable(&quot;out of memory&quot;);
1202 }
1203 
1204 ciInstance* ciEnv::unloaded_ciinstance() {
1205   GUARDED_VM_ENTRY(return _factory-&gt;get_unloaded_object_constant();)
1206 }
1207 
1208 // ------------------------------------------------------------------
1209 // ciEnv::dump_replay_data*
1210 
1211 // Don&#39;t change thread state and acquire any locks.
1212 // Safe to call from VM error reporter.
1213 
1214 void ciEnv::dump_compile_data(outputStream* out) {
1215   CompileTask* task = this-&gt;task();
1216   if (task) {
1217     Method* method = task-&gt;method();
1218     int entry_bci = task-&gt;osr_bci();
1219     int comp_level = task-&gt;comp_level();
1220     out-&gt;print(&quot;compile %s %s %s %d %d&quot;,
1221                method-&gt;klass_name()-&gt;as_quoted_ascii(),
1222                method-&gt;name()-&gt;as_quoted_ascii(),
1223                method-&gt;signature()-&gt;as_quoted_ascii(),
1224                entry_bci, comp_level);
1225     if (compiler_data() != NULL) {
1226       if (is_c2_compile(comp_level)) {
1227 #ifdef COMPILER2
1228         // Dump C2 inlining data.
1229         ((Compile*)compiler_data())-&gt;dump_inline_data(out);
1230 #endif
1231       } else if (is_c1_compile(comp_level)) {
1232 #ifdef COMPILER1
1233         // Dump C1 inlining data.
1234         ((Compilation*)compiler_data())-&gt;dump_inline_data(out);
1235 #endif
1236       }
1237     }
1238     out-&gt;cr();
1239   }
1240 }
1241 
1242 void ciEnv::dump_replay_data_unsafe(outputStream* out) {
1243   ResourceMark rm;
1244 #if INCLUDE_JVMTI
1245   out-&gt;print_cr(&quot;JvmtiExport can_access_local_variables %d&quot;,     _jvmti_can_access_local_variables);
1246   out-&gt;print_cr(&quot;JvmtiExport can_hotswap_or_post_breakpoint %d&quot;, _jvmti_can_hotswap_or_post_breakpoint);
1247   out-&gt;print_cr(&quot;JvmtiExport can_post_on_exceptions %d&quot;,         _jvmti_can_post_on_exceptions);
1248 #endif // INCLUDE_JVMTI
1249 
1250   GrowableArray&lt;ciMetadata*&gt;* objects = _factory-&gt;get_ci_metadata();
1251   out-&gt;print_cr(&quot;# %d ciObject found&quot;, objects-&gt;length());
1252   for (int i = 0; i &lt; objects-&gt;length(); i++) {
1253     objects-&gt;at(i)-&gt;dump_replay_data(out);
1254   }
1255   dump_compile_data(out);
1256   out-&gt;flush();
1257 }
1258 
1259 void ciEnv::dump_replay_data(outputStream* out) {
1260   GUARDED_VM_ENTRY(
1261     MutexLocker ml(Compile_lock);
1262     dump_replay_data_unsafe(out);
1263   )
1264 }
1265 
1266 void ciEnv::dump_replay_data(int compile_id) {
1267   static char buffer[O_BUFLEN];
1268   int ret = jio_snprintf(buffer, O_BUFLEN, &quot;replay_pid%p_compid%d.log&quot;, os::current_process_id(), compile_id);
1269   if (ret &gt; 0) {
1270     int fd = os::open(buffer, O_RDWR | O_CREAT | O_TRUNC, 0666);
1271     if (fd != -1) {
1272       FILE* replay_data_file = os::open(fd, &quot;w&quot;);
1273       if (replay_data_file != NULL) {
1274         fileStream replay_data_stream(replay_data_file, /*need_close=*/true);
1275         dump_replay_data(&amp;replay_data_stream);
1276         tty-&gt;print_cr(&quot;# Compiler replay data is saved as: %s&quot;, buffer);
1277       } else {
1278         tty-&gt;print_cr(&quot;# Can&#39;t open file to dump replay data.&quot;);
1279       }
1280     }
1281   }
1282 }
1283 
1284 void ciEnv::dump_inline_data(int compile_id) {
1285   static char buffer[O_BUFLEN];
1286   int ret = jio_snprintf(buffer, O_BUFLEN, &quot;inline_pid%p_compid%d.log&quot;, os::current_process_id(), compile_id);
1287   if (ret &gt; 0) {
1288     int fd = os::open(buffer, O_RDWR | O_CREAT | O_TRUNC, 0666);
1289     if (fd != -1) {
1290       FILE* inline_data_file = os::open(fd, &quot;w&quot;);
1291       if (inline_data_file != NULL) {
1292         fileStream replay_data_stream(inline_data_file, /*need_close=*/true);
1293         GUARDED_VM_ENTRY(
1294           MutexLocker ml(Compile_lock);
1295           dump_compile_data(&amp;replay_data_stream);
1296         )
1297         replay_data_stream.flush();
1298         tty-&gt;print(&quot;# Compiler inline data is saved as: &quot;);
1299         tty-&gt;print_cr(&quot;%s&quot;, buffer);
1300       } else {
1301         tty-&gt;print_cr(&quot;# Can&#39;t open file to dump inline data.&quot;);
1302       }
1303     }
1304   }
1305 }
    </pre>
  </body>
</html>