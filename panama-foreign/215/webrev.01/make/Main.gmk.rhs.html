<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames make/Main.gmk</title>
    <link rel="stylesheet" href="../style.css" />
    <script type="text/javascript" src="../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>   1 #
   2 # Copyright (c) 2011, 2020, Oracle and/or its affiliates. All rights reserved.
   3 # DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4 #
   5 # This code is free software; you can redistribute it and/or modify it
   6 # under the terms of the GNU General Public License version 2 only, as
   7 # published by the Free Software Foundation.  Oracle designates this
   8 # particular file as subject to the &quot;Classpath&quot; exception as provided
   9 # by Oracle in the LICENSE file that accompanied this code.
  10 #
  11 # This code is distributed in the hope that it will be useful, but WITHOUT
  12 # ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  13 # FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  14 # version 2 for more details (a copy is included in the LICENSE file that
  15 # accompanied this code).
  16 #
  17 # You should have received a copy of the GNU General Public License version
  18 # 2 along with this work; if not, write to the Free Software Foundation,
  19 # Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  20 #
  21 # Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  22 # or visit www.oracle.com if you need additional information or have any
  23 # questions.
  24 #
  25 
  26 ################################################################################
  27 # This is the main makefile containing most actual top level targets. It needs
  28 # to be called with a SPEC file defined.
  29 ################################################################################
  30 
  31 # Declare default target
  32 default:
  33 
  34 ifeq ($(wildcard $(SPEC)),)
  35   $(error Main.gmk needs SPEC set to a proper spec.gmk)
  36 endif
  37 
  38 # Now load the spec
  39 include $(SPEC)
  40 
  41 # Load the vital tools for all the makefiles.
  42 include $(TOPDIR)/make/common/MakeBase.gmk
  43 include $(TOPDIR)/make/common/Modules.gmk
  44 include $(TOPDIR)/make/common/FindTests.gmk
  45 
  46 include $(TOPDIR)/make/MainSupport.gmk
  47 
  48 # Are we requested to ignore dependencies?
  49 ifneq ($(findstring -only, $(MAKECMDGOALS)), )
  50   DEPS := none
  51 endif
  52 
  53 # Declare ALL_TARGETS as an immediate variable. This variable is a list of all
  54 # valid top level targets. It&#39;s used to declare them all as PHONY and to
  55 # generate the -only targets.
  56 ALL_TARGETS :=
  57 
  58 # Hook to include the corresponding custom file, if present.
  59 $(eval $(call IncludeCustomExtension, Main.gmk))
  60 
  61 # All modules for the current target platform.
  62 ALL_MODULES := $(call FindAllModules)
  63 
  64 ################################################################################
  65 ################################################################################
  66 #
  67 # Recipes for all targets. Only recipes, dependencies are declared later.
  68 #
  69 ################################################################################
  70 
  71 ################################################################################
  72 # Interim/build tools targets, compiling tools used during the build
  73 
  74 $(eval $(call SetupTarget, buildtools-langtools, \
  75     MAKEFILE := ToolsLangtools, \
  76 ))
  77 
  78 $(eval $(call SetupTarget, interim-langtools, \
  79     MAKEFILE := CompileInterimLangtools, \
  80 ))
  81 
  82 $(eval $(call SetupTarget, interim-tzdb, \
  83     MAKEFILE := CopyInterimTZDB, \
  84 ))
  85 
  86 $(eval $(call SetupTarget, buildtools-jdk, \
  87     MAKEFILE := CompileToolsJdk, \
  88     DEPS := interim-langtools interim-tzdb, \
  89 ))
  90 
  91 $(eval $(call SetupTarget, buildtools-modules, \
  92     MAKEFILE := CompileModuleTools, \
  93     DEPS := exploded-image-base, \
  94 ))
  95 
  96 $(eval $(call SetupTarget, buildtools-hotspot, \
  97     MAKEFILE := CompileToolsHotspot, \
  98     DEPS := interim-langtools, \
  99 ))
 100 
 101 ################################################################################
 102 # Special targets for certain modules
 103 
 104 $(eval $(call SetupTarget, generate-exported-symbols, \
 105     MAKEFILE := BuildStatic, \
 106     DEPS := java.base-libs jdk.jdwp.agent-libs, \
 107 ))
 108 
 109 ################################################################################
 110 # Gensrc targets, generating source before java compilation can be done
 111 #
 112 $(eval $(call DeclareRecipesForPhase, GENSRC, \
 113     TARGET_SUFFIX := gensrc-src, \
 114     FILE_PREFIX := Gensrc, \
 115     MAKE_SUBDIR := gensrc, \
 116     CHECK_MODULES := $(ALL_MODULES), \
 117 ))
 118 
 119 $(foreach m, $(GENSRC_MODULES), $(eval $m-gensrc: $m-gensrc-src))
 120 
 121 LANGTOOLS_GENSRC_TARGETS := $(filter $(addsuffix -%, $(LANGTOOLS_MODULES)), $(GENSRC_TARGETS))
 122 INTERIM_LANGTOOLS_GENSRC_TARGETS := $(filter $(addsuffix -%, \
 123     $(INTERIM_LANGTOOLS_BASE_MODULES)), $(GENSRC_TARGETS))
 124 HOTSPOT_GENSRC_TARGETS := $(filter $(addsuffix -%, $(HOTSPOT_MODULES)), $(GENSRC_TARGETS))
 125 JDK_GENSRC_TARGETS := $(filter-out $(LANGTOOLS_GENSRC_TARGETS) \
 126     $(HOTSPOT_GENSRC_TARGETS), $(GENSRC_TARGETS))
 127 
 128 GENSRC_MODULEINFO_MODULES := $(ALL_MODULES)
 129 GENSRC_MODULEINFO_TARGETS := $(addsuffix -gensrc-moduleinfo, \
 130     $(GENSRC_MODULEINFO_MODULES))
 131 
 132 GENSRC_MODULES := $(GENSRC_MODULEINFO_MODULES)
 133 GENSRC_TARGETS += $(sort $(GENSRC_MODULEINFO_TARGETS) \
 134     $(addsuffix -gensrc, $(GENSRC_MODULES)))
 135 
 136 define DeclareModuleInfoRecipe
 137   $1-gensrc-moduleinfo:
 138 	+($(CD) $(TOPDIR)/make &amp;&amp; $(MAKE) $(MAKE_ARGS) \
 139 	    -f common/modules/GensrcModuleInfo.gmk MODULE=$1)
 140 
 141   $1-gensrc: $1-gensrc-moduleinfo
 142 endef
 143 
 144 $(foreach m, $(GENSRC_MODULEINFO_MODULES), $(eval $(call DeclareModuleInfoRecipe,$m)))
 145 
 146 ALL_TARGETS += $(GENSRC_TARGETS)
 147 
 148 ################################################################################
 149 # Generate data targets
 150 $(eval $(call DeclareRecipesForPhase, GENDATA, \
 151     TARGET_SUFFIX := gendata, \
 152     FILE_PREFIX := Gendata, \
 153     MAKE_SUBDIR := gendata, \
 154     CHECK_MODULES := $(ALL_MODULES), \
 155 ))
 156 
 157 ALL_TARGETS += $(GENDATA_TARGETS)
 158 
 159 ################################################################################
 160 # Copy files targets
 161 $(eval $(call DeclareRecipesForPhase, COPY, \
 162     TARGET_SUFFIX := copy, \
 163     FILE_PREFIX := Copy, \
 164     MAKE_SUBDIR := copy, \
 165     CHECK_MODULES := $(ALL_MODULES), \
 166 ))
 167 
 168 ALL_COPY_MODULES += $(COPY_MODULES)
 169 ALL_COPY_TARGETS += $(COPY_TARGETS)
 170 
 171 IMPORT_COPY_MODULES := $(call FindImportedModules)
 172 IMPORT_COPY_TARGETS := $(addsuffix -copy, $(IMPORT_COPY_MODULES))
 173 ALL_COPY_MODULES += $(IMPORT_COPY_MODULES)
 174 ALL_COPY_TARGETS += $(IMPORT_COPY_TARGETS)
 175 
 176 define DeclareImportCopyRecipe
 177   $1-copy:
 178 	+($(CD) $(TOPDIR)/make &amp;&amp; $(MAKE) $(MAKE_ARGS) \
 179 	    -f CopyImportModules.gmk MODULE=$1)
 180 endef
 181 
 182 $(foreach m, $(IMPORT_COPY_MODULES), $(eval $(call DeclareImportCopyRecipe,$m)))
 183 
 184 ALL_TARGETS += $(ALL_COPY_TARGETS)
 185 
 186 ################################################################################
 187 # Targets for compiling all java modules.
 188 JAVA_MODULES := $(ALL_MODULES)
 189 JAVA_TARGETS := $(addsuffix -java, $(JAVA_MODULES))
 190 
 191 define DeclareCompileJavaRecipe
 192   $1-java:
 193 	+($(CD) $(TOPDIR)/make &amp;&amp; $(MAKE) $(MAKE_ARGS) \
 194 	    -f CompileJavaModules.gmk MODULE=$1)
 195 endef
 196 
 197 $(foreach m, $(JAVA_MODULES), $(eval $(call DeclareCompileJavaRecipe,$m)))
 198 
 199 ALL_TARGETS += $(JAVA_TARGETS)
 200 
 201 ################################################################################
 202 # Targets for compiling native libraries
 203 $(eval $(call DeclareRecipesForPhase, LIBS, \
 204     TARGET_SUFFIX := libs, \
 205     FILE_PREFIX := Lib, \
 206     MAKE_SUBDIR := lib, \
 207     CHECK_MODULES := $(ALL_MODULES), \
 208 ))
 209 
 210 ALL_TARGETS += $(LIBS_TARGETS)
 211 
 212 ################################################################################
 213 # Targets for compiling static versions of certain native libraries. These do
 214 # not end up in the jmods or the normal JDK image, but are instead bundled into
 215 # a special deliverable.
 216 $(eval $(call DeclareRecipesForPhase, STATIC_LIBS, \
 217     TARGET_SUFFIX := static-libs, \
 218     FILE_PREFIX := Lib, \
 219     MAKE_SUBDIR := lib, \
 220     CHECK_MODULES := $(ALL_MODULES), \
 221     EXTRA_ARGS := STATIC_LIBS=true, \
 222 ))
 223 
 224 ALL_TARGETS += $(STATIC_LIBS_TARGETS)
 225 
 226 ################################################################################
 227 # Targets for compiling native executables
 228 $(eval $(call DeclareRecipesForPhase, LAUNCHER, \
 229     TARGET_SUFFIX := launchers, \
 230     FILE_PREFIX := Launcher, \
 231     MAKE_SUBDIR := launcher, \
 232     CHECK_MODULES := $(ALL_MODULES), \
 233 ))
 234 
 235 ALL_TARGETS += $(LAUNCHER_TARGETS)
 236 
 237 ################################################################################
 238 # Build hotspot target
 239 
 240 HOTSPOT_VARIANT_TARGETS := $(addprefix hotspot-, $(JVM_VARIANTS))
 241 HOTSPOT_VARIANT_GENSRC_TARGETS := $(addsuffix -gensrc, $(HOTSPOT_VARIANT_TARGETS))
 242 HOTSPOT_VARIANT_LIBS_TARGETS := $(addsuffix -libs, $(HOTSPOT_VARIANT_TARGETS))
 243 
 244 define DeclareHotspotGensrcRecipe
 245   hotspot-$1-gensrc:
 246 	$$(call LogInfo, Building JVM variant &#39;$1&#39; with features &#39;$(JVM_FEATURES_$1)&#39;)
 247 	+($(CD) $(TOPDIR)/make/hotspot &amp;&amp; $(MAKE) $(MAKE_ARGS) -f gensrc/GenerateSources.gmk \
 248 	    JVM_VARIANT=$1)
 249 endef
 250 
 251 $(foreach v, $(JVM_VARIANTS), $(eval $(call DeclareHotspotGensrcRecipe,$v)))
 252 
 253 define DeclareHotspotLibsRecipe
 254   hotspot-$1-libs:
 255 	+($(CD) $(TOPDIR)/make/hotspot &amp;&amp; $(MAKE) $(MAKE_ARGS) -f lib/CompileLibraries.gmk \
 256 	    JVM_VARIANT=$1)
 257 endef
 258 
 259 $(foreach v, $(JVM_VARIANTS), $(eval $(call DeclareHotspotLibsRecipe,$v)))
 260 
 261 $(eval $(call SetupTarget, hotspot-ide-project, \
 262     MAKEFILE := ide/visualstudio/hotspot/CreateVSProject, \
 263     DEPS := hotspot exploded-image, \
 264     ARGS := -I$(TOPDIR)/make/hotspot, \
 265 ))
 266 
 267 ALL_TARGETS += $(HOTSPOT_VARIANT_TARGETS) $(HOTSPOT_VARIANT_GENSRC_TARGETS) \
 268     $(HOTSPOT_VARIANT_LIBS_TARGETS)
 269 
 270 ################################################################################
 271 # Generate libs and launcher targets for creating compile_commands.json fragments
 272 define DeclareCompileCommandsRecipe
 273   $1-compile-commands:
 274 	$$(call LogInfo, Generating compile_commands.json fragments for $1)
 275 	+($(CD) $(TOPDIR)/make &amp;&amp; $(MAKE) $(MAKE_ARGS) -f Main.gmk $1-only \
 276 	    GENERATE_COMPILE_COMMANDS_ONLY=true)
 277 
 278   COMPILE_COMMANDS_TARGETS_$2 += $1-compile-commands
 279 endef
 280 
 281 $(foreach t, $(HOTSPOT_VARIANT_LIBS_TARGETS), \
 282   $(eval $(call DeclareCompileCommandsRecipe,$t,HOTSPOT)) \
 283 )
 284 
 285 $(foreach t, $(LIBS_TARGETS) $(LAUNCHER_TARGETS), \
 286   $(eval $(call DeclareCompileCommandsRecipe,$t,JDK)) \
 287 )
 288 
 289 $(eval $(call SetupTarget, compile-commands, \
 290     MAKEFILE := CompileCommands, \
 291 ))
 292 
 293 $(eval $(call SetupTarget, compile-commands-hotspot, \
 294     MAKEFILE := CompileCommands, \
 295 ))
 296 
 297 ALL_TARGETS += $(COMPILE_COMMANDS_TARGETS_HOTSPOT) $(COMPILE_COMMANDS_TARGETS_JDK)
 298 
 299 ################################################################################
 300 # VS Code projects
 301 
 302 $(eval $(call SetupTarget, vscode-project, \
 303     MAKEFILE := ide/vscode/hotspot/CreateVSCodeProject, \
 304     ARGS := VSCODE_INDEXER=cpptools, \
 305     DEPS := compile-commands, \
 306 ))
 307 
 308 $(eval $(call SetupTarget, vscode-project-clangd, \
 309     MAKEFILE := ide/vscode/hotspot/CreateVSCodeProject, \
 310     ARGS := VSCODE_INDEXER=clangd, \
 311     DEPS := compile-commands, \
 312 ))
 313 
 314 $(eval $(call SetupTarget, vscode-project-rtags, \
 315     MAKEFILE := ide/vscode/hotspot/CreateVSCodeProject, \
 316     ARGS := VSCODE_INDEXER=rtags, \
 317     DEPS := compile-commands, \
 318 ))
 319 
 320 $(eval $(call SetupTarget, vscode-project-ccls, \
 321     MAKEFILE := ide/vscode/hotspot/CreateVSCodeProject, \
 322     ARGS := VSCODE_INDEXER=ccls, \
 323     DEPS := compile-commands, \
 324 ))
 325 
 326 ################################################################################
 327 # Build demos targets
 328 
 329 # The demos are currently linking to libjvm and libjava, just like all other
 330 # jdk libs, even though they don&#39;t need to. To avoid warnings, make sure they
 331 # aren&#39;t built until after libjava and libjvm are available to link to.
 332 $(eval $(call SetupTarget, demos-jdk, \
 333     MAKEFILE := CompileDemos, \
 334     DEPS := java.base-libs exploded-image, \
 335 ))
 336 
 337 $(eval $(call SetupTarget, test-image-demos-jdk, \
 338     MAKEFILE := CompileDemos, \
 339     TARGET := images, \
 340     DEPS := demos-jdk, \
 341 ))
 342 
 343 ################################################################################
 344 # Jigsaw specific data and analysis targets.
 345 
 346 $(eval $(call SetupTarget, generate-summary, \
 347     MAKEFILE := GenerateModuleSummary, \
 348     DEPS := jmods buildtools-modules, \
 349 ))
 350 
 351 ################################################################################
 352 # Jmod targets
 353 
 354 JMOD_MODULES := $(ALL_MODULES)
 355 JMOD_TARGETS := $(addsuffix -jmod, $(JMOD_MODULES))
 356 
 357 define DeclareJmodRecipe
 358   $1-jmod:
 359 	+($(CD) $(TOPDIR)/make &amp;&amp; $(MAKE) $(MAKE_ARGS) -f CreateJmods.gmk \
 360 	    MODULE=$1)
 361 endef
 362 
 363 $(foreach m, $(JMOD_MODULES), $(eval $(call DeclareJmodRecipe,$m)))
 364 
 365 ALL_TARGETS += $(JMOD_TARGETS)
 366 
 367 ################################################################################
 368 # Images targets
 369 
 370 $(eval $(call SetupTarget, store-source-revision, \
 371     MAKEFILE := SourceRevision, \
 372     TARGET := store-source-revision, \
 373 ))
 374 
 375 $(eval $(call SetupTarget, create-source-revision-tracker, \
 376     MAKEFILE := SourceRevision, \
 377     TARGET := create-source-revision-tracker, \
 378 ))
 379 
 380 BOOTCYCLE_TARGET := product-images
 381 bootcycle-images:
 382         ifneq ($(COMPILE_TYPE), cross)
 383 	  $(call LogWarn, Boot cycle build step 2: Building a new JDK image using previously built image)
 384 	  $(call MakeDir, $(OUTPUTDIR)/bootcycle-build)
 385 	  +$(MAKE) $(MAKE_ARGS) -f $(TOPDIR)/make/Init.gmk PARALLEL_TARGETS=$(BOOTCYCLE_TARGET) \
 386 	      LOG_PREFIX=&quot;[bootcycle] &quot; JOBS= SPEC=$(dir $(SPEC))bootcycle-spec.gmk main
 387         else
 388 	  $(call LogWarn, Boot cycle build disabled when cross compiling)
 389         endif
 390 
 391 $(eval $(call SetupTarget, zip-security, \
 392     MAKEFILE := ZipSecurity, \
 393     DEPS := java.base-java java.security.jgss-java java.security.jgss-libs, \
 394 ))
 395 
 396 $(eval $(call SetupTarget, zip-source, \
 397     MAKEFILE := ZipSource, \
 398     DEPS := gensrc, \
 399 ))
 400 
 401 $(eval $(call SetupTarget, jrtfs-jar, \
 402     MAKEFILE := JrtfsJar, \
 403     DEPS := interim-langtools, \
 404 ))
 405 
 406 $(eval $(call SetupTarget, jdk-image, \
 407     MAKEFILE := Images, \
 408     TARGET := jdk, \
 409     DEPS := jmods zip-source demos release-file, \
 410 ))
 411 
 412 $(eval $(call SetupTarget, legacy-jre-image, \
 413     MAKEFILE := Images, \
 414     TARGET := jre, \
 415     DEPS := jmods release-file, \
 416 ))
 417 
 418 $(eval $(call SetupTarget, symbols-image, \
 419     MAKEFILE := Images, \
 420     TARGET := symbols, \
 421 ))
 422 
 423 $(eval $(call SetupTarget, static-libs-image, \
 424     MAKEFILE := StaticLibsImage, \
 425 ))
 426 
 427 $(eval $(call SetupTarget, mac-jdk-bundle, \
 428     MAKEFILE := MacBundles, \
 429     TARGET := jdk-bundle, \
 430     DEPS := jdk-image, \
 431 ))
 432 
 433 $(eval $(call SetupTarget, mac-legacy-jre-bundle, \
 434     MAKEFILE := MacBundles, \
 435     TARGET := jre-bundle, \
 436     DEPS := legacy-jre-image, \
 437 ))
 438 
 439 $(eval $(call SetupTarget, release-file, \
 440     MAKEFILE := ReleaseFile, \
 441     DEPS := create-source-revision-tracker, \
 442 ))
 443 
 444 $(eval $(call SetupTarget, exploded-image-optimize, \
 445     MAKEFILE := ExplodedImageOptimize, \
 446     DEPS := java copy gendata java.base-libs java.base-launchers \
 447         buildtools-modules, \
 448 ))
 449 
 450 $(eval $(call SetupTarget, graal-builder-image, \
 451     MAKEFILE := GraalBuilderImage, \
 452     DEPS := jdk-image static-libs-image, \
 453 ))
 454 
 455 ifeq ($(JCOV_ENABLED), true)
 456   $(eval $(call SetupTarget, jcov-image, \
 457       MAKEFILE := Coverage, \
 458       TARGET := jcov-image, \
 459       DEPS := jdk-image, \
 460   ))
 461 endif
 462 
 463 ALL_TARGETS += bootcycle-images
 464 
 465 ################################################################################
 466 # Docs targets
 467 
 468 # If building full docs, to complete docs-*-api we need both the javadoc and
 469 # modulegraph targets.
 470 $(eval $(call SetupTarget, docs-jdk-api-javadoc, \
 471     MAKEFILE := Docs, \
 472     TARGET := docs-jdk-api-javadoc, \
 473 ))
 474 
 475 $(eval $(call SetupTarget, docs-jdk-api-modulegraph, \
 476     MAKEFILE := Docs, \
 477     TARGET := docs-jdk-api-modulegraph, \
 478     DEPS := exploded-image buildtools-modules, \
 479 ))
 480 
 481 $(eval $(call SetupTarget, docs-javase-api-javadoc, \
 482     MAKEFILE := Docs, \
 483     TARGET := docs-javase-api-javadoc, \
 484 ))
 485 
 486 $(eval $(call SetupTarget, docs-javase-api-modulegraph, \
 487     MAKEFILE := Docs, \
 488     TARGET := docs-javase-api-modulegraph, \
 489     DEPS := exploded-image buildtools-modules, \
 490 ))
 491 
 492 $(eval $(call SetupTarget, docs-reference-api-javadoc, \
 493     MAKEFILE := Docs, \
 494     TARGET := docs-reference-api-javadoc, \
 495 ))
 496 
 497 $(eval $(call SetupTarget, docs-reference-api-modulegraph, \
 498     MAKEFILE := Docs, \
 499     TARGET := docs-reference-api-modulegraph, \
 500     DEPS := exploded-image buildtools-modules, \
 501 ))
 502 
 503 # The gensrc steps for jdk.jdi create html spec files.
 504 $(eval $(call SetupTarget, docs-jdk-specs, \
 505     MAKEFILE := Docs, \
 506     TARGET := docs-jdk-specs, \
 507     DEPS := buildtools-jdk jdk.jdi-gensrc docs-jdk-index, \
 508 ))
 509 
 510 $(eval $(call SetupTarget, docs-jdk-index, \
 511     MAKEFILE := Docs, \
 512     TARGET := docs-jdk-index, \
 513 ))
 514 
 515 $(eval $(call SetupTarget, docs-zip, \
 516     MAKEFILE := Docs, \
 517     TARGET := docs-zip, \
 518     DEPS :=  docs-jdk, \
 519 ))
 520 
 521 $(eval $(call SetupTarget, docs-specs-zip, \
 522     MAKEFILE := Docs, \
 523     TARGET := docs-specs-zip, \
 524     DEPS := docs-jdk-specs, \
 525 ))
 526 
 527 $(eval $(call SetupTarget, update-build-docs, \
 528     MAKEFILE := UpdateBuildDocs, \
 529 ))
 530 
 531 $(eval $(call SetupTarget, update-x11wrappers, \
 532     MAKEFILE := UpdateX11Wrappers, \
 533     DEPS := java.base-copy buildtools-jdk, \
 534 ))
 535 
 536 ################################################################################
 537 # Cross compilation support
 538 
 539 ifeq ($(CREATING_BUILDJDK), true)
 540   # This target is only called by the recursive call below.
 541   create-buildjdk-interim-image-helper: interim-image jdk.jlink-launchers \
 542       java.base-copy jdk.jdeps-launchers
 543 endif
 544 
 545 BUILDJDK_MODULES := $(sort $(foreach m, jdk.jlink $(INTERIM_IMAGE_MODULES), \
 546     $(call FindTransitiveDepsForModule, $m) $m))
 547 
 548 $(eval $(call SetupTarget, create-buildjdk-interim-image, \
 549     MAKEFILE := Main, \
 550     TARGET := create-buildjdk-interim-image-helper, \
 551     ARGS := SPEC=$(dir $(SPEC))buildjdk-spec.gmk \
 552         HOTSPOT_SPEC=$(dir $(SPEC))buildjdk-spec.gmk \
 553         CREATING_BUILDJDK=true \
 554         LOG_PREFIX=&quot;[buildjdk] &quot; \
 555         JAVA_MODULES=&quot;$(BUILDJDK_MODULES)&quot;, \
 556 ))
 557 
 558 ################################################################################
 559 # The interim-image is a small jlinked image that is used to generate artifacts
 560 # at build time for use when linking the real images.
 561 
 562 INTERIM_JMOD_TARGETS := $(addsuffix -interim-jmod, $(INTERIM_IMAGE_MODULES))
 563 
 564 define DeclareInterimJmodRecipe
 565   $1-interim-jmod:
 566 	+($(CD) $(TOPDIR)/make &amp;&amp; $(MAKE) $(MAKE_ARGS) -f CreateJmods.gmk \
 567 	    MODULE=$1 \
 568 	    JMODS_DIR=$(INTERIM_JMODS_DIR) \
 569 	    JMODS_SUPPORT_DIR=$(INTERIM_JMODS_DIR)/support \
 570 	    INTERIM_JMOD=true \
 571 	)
 572 endef
 573 
 574 $(foreach m, $(INTERIM_IMAGE_MODULES), $(eval $(call DeclareInterimJmodRecipe,$m)))
 575 
 576 $(eval $(call SetupTarget, interim-image, \
 577     MAKEFILE := InterimImage, \
 578 ))
 579 
 580 ifeq ($(ENABLE_GENERATE_CLASSLIST), true)
 581   $(eval $(call SetupTarget, generate-link-opt-data, \
 582       MAKEFILE := GenerateLinkOptData, \
 583   ))
 584 endif
 585 
 586 ################################################################################
 587 # Generate test names for all JTReg test groups
 588 #
 589 
 590 define DeclareRunTestRecipe
 591   test-$1:
 592 	+($(CD) $(TOPDIR)/make &amp;&amp; $(MAKE) $(MAKE_ARGS) -f RunTests.gmk \
 593 	    TEST=&quot;$1&quot;)
 594 
 595   exploded-test-$1:
 596 	+($(CD) $(TOPDIR)/make &amp;&amp; $(MAKE) $(MAKE_ARGS) -f RunTests.gmk \
 597 	    TEST=&quot;$1&quot; JDK_IMAGE_DIR=$(JDK_OUTPUTDIR))
 598 endef
 599 
 600 # ALL_NAMED_TESTS is defined in FindTests.gmk
 601 $(foreach t, $(ALL_NAMED_TESTS), $(eval $(call DeclareRunTestRecipe,$t)))
 602 ALL_TEST_TARGETS := $(addprefix test-, $(ALL_NAMED_TESTS))
 603 
 604 # We only support the &quot;exploded-test-gtest&quot; shortcut
 605 ALL_EXPLODED_TESTS := gtest
 606 ALL_EXPLODED_TEST_TARGETS := $(addprefix exploded-test-, $(ALL_EXPLODED_TESTS))
 607 
 608 ALL_TARGETS += $(ALL_TEST_TARGETS) $(ALL_EXPLODED_TEST_TARGETS)
 609 
 610 ################################################################################
 611 # Build tests and microbenchmarks
 612 #
 613 
 614 $(eval $(call SetupTarget, prepare-test-image, \
 615     MAKEFILE := TestImage, \
 616     TARGET := prepare-test-image, \
 617 ))
 618 
 619 $(eval $(call SetupTarget, build-test-hotspot-jtreg-native, \
 620     MAKEFILE := test/JtregNativeHotspot, \
 621     TARGET := build-test-hotspot-jtreg-native, \
 622     DEPS := buildtools-jdk, \
 623 ))
 624 
 625 $(eval $(call SetupTarget, test-image-hotspot-jtreg-native, \
 626     MAKEFILE := test/JtregNativeHotspot, \
 627     TARGET := test-image-hotspot-jtreg-native, \
 628     DEPS := build-test-hotspot-jtreg-native, \
 629 ))
 630 
 631 $(eval $(call SetupTarget, build-test-jdk-jtreg-native, \
 632     MAKEFILE := test/JtregNativeJdk, \
 633     TARGET := build-test-jdk-jtreg-native, \
 634     DEPS := buildtools-jdk java.base-libs, \
 635 ))
 636 
 637 $(eval $(call SetupTarget, test-image-jdk-jtreg-native, \
 638     MAKEFILE := test/JtregNativeJdk, \
 639     TARGET := test-image-jdk-jtreg-native, \
 640     DEPS := build-test-jdk-jtreg-native, \
 641 ))
 642 
 643 $(eval $(call SetupTarget, build-test-libtest-jtreg-native, \
 644     MAKEFILE := test/JtregNativeLibTest, \
 645     TARGET := build-test-libtest-jtreg-native, \
 646     DEPS := buildtools-jdk, \
 647 ))
 648 
 649 $(eval $(call SetupTarget, test-image-libtest-jtreg-native, \
 650     MAKEFILE := test/JtregNativeLibTest, \
 651     TARGET := test-image-libtest-jtreg-native, \
 652     DEPS := build-test-libtest-jtreg-native, \
 653 ))
 654 
 655 $(eval $(call SetupTarget, build-test-hotspot-jtreg-graal, \
 656     MAKEFILE := test/JtregGraalUnit, \
 657     TARGET := build-test-hotspot-jtreg-graal, \
 658     DEPS := exploded-image, \
 659 ))
 660 
 661 $(eval $(call SetupTarget, test-image-hotspot-jtreg-graal, \
 662     MAKEFILE := test/JtregGraalUnit, \
 663     TARGET := test-image-hotspot-jtreg-graal, \
 664     DEPS := build-test-hotspot-jtreg-graal, \
 665 ))
 666 
 667 ifneq ($GTEST_FRAMEWORK_SRC), )
 668   $(eval $(call SetupTarget, test-image-hotspot-gtest, \
 669       MAKEFILE := hotspot/test/GtestImage, \
 670       DEPS := hotspot, \
 671   ))
 672 endif
 673 
 674 $(eval $(call SetupTarget, build-test-lib, \
 675     MAKEFILE := test/BuildTestLib, \
 676     DEPS := exploded-image, \
 677 ))
 678 
 679 ifeq ($(BUILD_FAILURE_HANDLER), true)
 680   # Builds the failure handler jtreg extension
 681   $(eval $(call SetupTarget, build-test-failure-handler, \
 682       MAKEFILE := test/BuildFailureHandler, \
 683       TARGET := build, \
 684       DEPS := interim-langtools, \
 685   ))
 686 
 687   # Copies the failure handler jtreg extension into the test image
 688   $(eval $(call SetupTarget, test-image-failure-handler, \
 689       MAKEFILE := test/BuildFailureHandler, \
 690       TARGET := images, \
 691       DEPS := build-test-failure-handler, \
 692   ))
 693 endif
 694 
 695 $(eval $(call SetupTarget, build-microbenchmark, \
 696     MAKEFILE := test/BuildMicrobenchmark, \
 697     DEPS := interim-langtools exploded-image, \
 698 ))
 699 
 700 ################################################################################
 701 # Run tests
 702 
 703 $(eval $(call SetupTarget, test, \
 704     MAKEFILE := RunTests, \
 705     ARGS := TEST=&quot;$(TEST)&quot;, \
 706     DEPS := jdk-image test-image, \
 707 ))
 708 
 709 $(eval $(call SetupTarget, exploded-test, \
 710     MAKEFILE := RunTests, \
 711     ARGS := TEST=&quot;$(TEST)&quot; JDK_IMAGE_DIR=$(JDK_OUTPUTDIR), \
 712     DEPS := exploded-image test-image, \
 713 ))
 714 
 715 ifeq ($(JCOV_ENABLED), true)
 716   $(eval $(call SetupTarget, jcov-test, \
 717       MAKEFILE := RunTests, \
 718       ARGS := TEST=&quot;$(TEST)&quot; TEST_OPTS_JCOV=true, \
 719       DEPS := jcov-image test-image, \
 720   ))
 721 endif
 722 
 723 ################################################################################
 724 # Bundles
 725 
 726 $(eval $(call SetupTarget, product-bundles, \
 727     MAKEFILE := Bundles, \
 728     TARGET := product-bundles, \
 729     DEPS := product-images, \
 730 ))
 731 
 732 $(eval $(call SetupTarget, legacy-bundles, \
 733     MAKEFILE := Bundles, \
 734     TARGET := legacy-bundles, \
 735     DEPS := legacy-images, \
 736 ))
 737 
 738 $(eval $(call SetupTarget, test-bundles, \
 739     MAKEFILE := Bundles, \
 740     TARGET := test-bundles, \
 741     DEPS := test-image, \
 742 ))
 743 
 744 $(eval $(call SetupTarget, docs-bundles, \
 745     MAKEFILE := Bundles, \
 746     TARGET := docs-bundles, \
 747     DEPS := docs-image, \
 748 ))
 749 
 750 $(eval $(call SetupTarget, static-libs-bundles, \
 751     MAKEFILE := Bundles, \
 752     TARGET := static-libs-bundles, \
 753     DEPS := static-libs-image, \
 754 ))
 755 
 756 ifeq ($(JCOV_ENABLED), true)
 757   $(eval $(call SetupTarget, jcov-bundles, \
 758       MAKEFILE := Bundles, \
 759       TARGET := jcov-bundles, \
 760       DEPS := jcov-image, \
 761   ))
 762 endif
 763 
 764 ################################################################################
 765 # Install targets
 766 
 767 $(eval $(call SetupTarget, install, \
 768     MAKEFILE := Install, \
 769     DEPS := product-images, \
 770 ))
 771 
 772 ################################################################################
 773 #
 774 # Dependency declarations between targets.
 775 #
 776 # These are declared in two groups. First all dependencies between targets that
 777 # have recipes above as these dependencies may be disabled. Then the aggregator
 778 # targets that do not have recipes of their own, which will never have their
 779 # dependencies disabled.
 780 #
 781 ################################################################################
 782 # Targets with recipes above
 783 
 784 # If running an *-only target, parallel execution and dependencies between
 785 # recipe targets are disabled. This makes it possible to run a select set of
 786 # recipe targets in order. It&#39;s the responsibility of the user to make sure
 787 # all prerequisites are fulfilled.
 788 ifeq ($(DEPS), none)
 789   .NOTPARALLEL:
 790 else
 791   $(LANGTOOLS_GENSRC_TARGETS): buildtools-langtools
 792 
 793   interim-langtools: $(INTERIM_LANGTOOLS_GENSRC_TARGETS)
 794 
 795   $(HOTSPOT_GENSRC_TARGETS): interim-langtools buildtools-hotspot
 796 
 797   $(JDK_GENSRC_TARGETS): interim-langtools buildtools-jdk
 798 
 799   $(GENSRC_MODULEINFO_TARGETS): buildtools-jdk
 800 
 801   $(GENDATA_TARGETS): interim-langtools buildtools-jdk
 802 
 803   $(JAVA_TARGETS): interim-langtools
 804 
 805   # Declare dependencies between hotspot-&lt;variant&gt;* targets
 806   $(foreach v, $(JVM_VARIANTS), \
<a name="1" id="anc1"></a><span class="line-modified"> 807       $(eval hotspot-$v-gensrc: java.base-copy buildtools-hotspot) \</span>
 808       $(eval hotspot-$v-libs: hotspot-$v-gensrc java.base-copy) \
 809   )
 810 
 811   # If not already set, set the JVM variant target so that the JVM will be built.
 812   JVM_MAIN_LIB_TARGETS ?= hotspot-$(JVM_VARIANT_MAIN)-libs
 813   JVM_MAIN_GENSRC_TARGETS ?= hotspot-$(JVM_VARIANT_MAIN)-gensrc
 814 
 815   # Building one JVM variant is enough to start building the other libs
 816   $(LIBS_TARGETS): $(JVM_MAIN_LIB_TARGETS)
 817 
 818   # Static libs depend on hotspot gensrc
 819   $(STATIC_LIBS_TARGETS): $(JVM_MAIN_GENSRC_TARGETS)
 820 
 821   $(LAUNCHER_TARGETS): java.base-libs
 822 
 823   ifeq ($(STATIC_BUILD), true)
 824     $(LAUNCHER_TARGETS): generate-exported-symbols
 825   endif
 826 
 827   # Declare dependency from &lt;module&gt;-java to &lt;module&gt;-gensrc
 828   $(foreach m, $(GENSRC_MODULES), $(eval $m-java: $m-gensrc))
 829 
 830   # Declare dependencies between java modules
 831   $(foreach m, $(JAVA_MODULES), \
 832       $(eval $m-java: $(addsuffix -java, $(filter $(JAVA_MODULES), \
 833       $(call FindDepsForModule,$m)))))
 834   # Declare dependencies between the module meta targets
 835   $(foreach m, $(ALL_MODULES), $(eval $m: $(call FindDepsForModule,$m)))
 836 
 837   # Declare dependencies from &lt;module&gt;-lib to &lt;module&gt;-java
 838   # Skip modules that do not have java source.
 839   $(foreach m, $(filter $(JAVA_MODULES), $(LIBS_MODULES)), $(eval $m-libs: $m-java))
 840 
 841   # Declare dependencies from all other &lt;module&gt;-lib to java.base-lib
 842   $(foreach t, $(filter-out java.base-libs, $(LIBS_TARGETS)), \
 843       $(eval $t: java.base-libs))
 844 
 845   # jdk.accessibility depends on java.desktop
 846   jdk.accessibility-libs: java.desktop-libs
 847 
 848   # This dependency needs to be explicitly declared. jdk.jdi-gensrc generates a
 849   # header file used by jdk.jdwp.agent-libs. The jdk.jdwp.agent-gensrc is a
 850   # virtual target.
 851   jdk.jdwp.agent-libs: jdk.jdwp.agent-gensrc
 852 
 853   # The swing beans need to have java base properly generated to avoid errors
 854   # in javadoc. The X11 wrappers need the java.base include files to have been
 855   # copied and processed.
 856   java.desktop-gensrc-src: java.base-gensrc java.base-copy
 857 
 858   # The annotation processing for jdk.internal.vm.compiler
 859   # and jdk.internal.vm.compiler.management needs classes from the current JDK.
 860   jdk.internal.vm.compiler-gensrc-src: $(addsuffix -java, \
 861       $(call FindTransitiveDepsForModule, jdk.internal.vm.compiler))
 862   jdk.internal.vm.compiler.management-gensrc-src: $(addsuffix -java, \
 863       $(call FindTransitiveDepsForModule, jdk.internal.vm.compiler.management))
 864 
 865   # For these modules, the gensrc step is generating a module-info.java.extra
 866   # file to be processed by the gensrc-moduleinfo target.
 867   jdk.internal.vm.compiler-gensrc-moduleinfo: jdk.internal.vm.compiler-gensrc-src
 868   jdk.internal.vm.compiler.management-gensrc-moduleinfo: jdk.internal.vm.compiler.management-gensrc-src
 869 
 870   jdk.jdeps-gendata: java
 871 
 872   # The ct.sym generation uses all the moduleinfos as input
 873   jdk.compiler-gendata: $(GENSRC_MODULEINFO_TARGETS)
 874 
 875   # Declare dependencies between jmod targets.
 876   # java.base jmod needs jrt-fs.jar and access to the other jmods to be built.
 877   # When creating the BUILDJDK, we don&#39;t need to add hashes to java.base, thus
 878   # we don&#39;t need to depend on all other jmods
 879   ifneq ($(CREATING_BUILDJDK), true)
 880     java.base-jmod: jrtfs-jar $(filter-out java.base-jmod, $(JMOD_TARGETS))
 881   endif
 882 
 883   # If not already set, set the JVM target so that the JVM will be built.
 884   JVM_MAIN_TARGETS ?= hotspot
 885 
 886   # Building java.base-jmod requires all of VM (ie hotspot) to be built.
 887   java.base-jmod: $(JVM_MAIN_TARGETS)
 888 
 889   # Declare dependencies from &lt;module&gt;-jmod to all other module targets
 890   $(foreach m, $(JAVA_MODULES), $(eval $m_JMOD_DEPS += $m-java))
 891   $(foreach m, $(GENDATA_MODULES), $(eval $m_JMOD_DEPS += $m-gendata))
 892   $(foreach m, $(LIBS_MODULES), $(eval $m_JMOD_DEPS += $m-libs))
 893   $(foreach m, $(LAUNCHER_MODULES), $(eval $m_JMOD_DEPS += $m-launchers))
 894   $(foreach m, $(COPY_MODULES), $(eval $m_JMOD_DEPS += $m-copy))
 895   $(foreach m, $(ALL_MODULES), $(eval $m-jmod: $($(m)_JMOD_DEPS)))
 896   $(foreach m, $(INTERIM_IMAGE_MODULES), $(eval $m-interim-jmod: $($(m)_JMOD_DEPS)))
 897 
 898   # Setup the minimal set of generated native source dependencies for hotspot
 899   $(foreach v, $(JVM_VARIANTS), \
 900     $(eval hotspot-$v-libs-compile-commands: hotspot-$v-gensrc) \
 901     $(foreach m, $(filter java.desktop jdk.hotspot.agent, $(GENSRC_MODULES)), \
 902       $(eval hotspot-$v-libs-compile-commands: $m-gensrc)) \
 903   )
 904 
 905   # For the full JDK compile commands, create all possible generated sources
 906   $(foreach m, $(GENSRC_MODULES), $(eval $m-libs-compile-commands: $m-gensrc))
 907   $(foreach m, $(filter $(JAVA_MODULES), $(LIBS_MODULES)), $(eval $m-libs-compile-commands: $m-java))
 908 
 909   $(COMPILE_COMMANDS_TARGETS_HOTSPOT): clean-compile-commands
 910   $(COMPILE_COMMANDS_TARGETS_JDK): clean-compile-commands
 911   compile-commands-hotspot: $(COMPILE_COMMANDS_TARGETS_HOTSPOT)
 912   compile-commands: $(COMPILE_COMMANDS_TARGETS_HOTSPOT) $(COMPILE_COMMANDS_TARGETS_JDK)
 913 
 914   # The -static-libs targets depend on -java as well as java.base-copy.
 915   $(foreach m, $(filter $(JAVA_MODULES), $(STATIC_LIBS_MODULES)), \
 916     $(eval $m-static-libs: $m-java java.base-copy))
 917 
 918   # Jmods cannot be created until we have the jmod tool ready to run. During
 919   # a normal build we run it from the exploded image, but when cross compiling
 920   # it&#39;s run from the buildjdk, which is either created at build time or user
 921   # supplied.
 922   ifeq ($(CREATE_BUILDJDK), true)
 923     ifneq ($(CREATING_BUILDJDK), true)
 924       # When cross compiling and buildjdk is to be created, simply depend on
 925       # creating the buildjdk.
 926       $(JMOD_TARGETS): create-buildjdk
 927       buildtools-modules: create-buildjdk
 928     else
 929       # While actually creating the buildjdk, we need to list the bare
 930       # minimum dependencies needed before running jmod, to avoid building
 931       # more than necessary. This includes:
 932       # * all java modules
 933       # * jdk.jlink-launchers
 934       # * copy jvm.cfg (done in java.base-copy)
 935       # * tzdb.dat (done in java.base-gendata)
 936       # Without all of these jimage, jlink and jmod won&#39;t start.
 937       $(JMOD_TARGETS) $(INTERIM_JMOD_TARGETS): java.base-libs java.base-copy \
 938           java.base-gendata jdk.jlink-launchers java
 939     endif
 940   else
 941     # The normal non cross compilation case uses needs to wait for the full
 942     # exploded-image to avoid a race with the optimize target.
 943     $(JMOD_TARGETS) $(INTERIM_JMOD_TARGETS): exploded-image
 944   endif
 945 
 946   # All modules include the main license files from java.base.
 947   $(JMOD_TARGETS): java.base-copy
 948 
 949   zip-security: $(filter jdk.crypto%, $(JAVA_TARGETS))
 950 
 951   ifeq ($(ENABLE_GENERATE_CLASSLIST), true)
 952     ifeq ($(CREATE_BUILDJDK), true)
 953       # If creating a buildjdk, the interim image needs to be based on that.
 954       generate-link-opt-data: create-buildjdk
 955     else ifeq ($(EXTERNAL_BUILDJDK), false)
 956       # If an external buildjdk has been provided, we skip generating an
 957       # interim-image and just use the external buildjdk for generating
 958       # classlist.
 959       generate-link-opt-data: interim-image
 960     endif
 961     generate-link-opt-data: buildtools-jdk
 962 
 963     # The generated classlist needs to go into java.base-jmod.
 964     java.base-jmod jdk.jlink-jmod jdk-image legacy-jre-image: generate-link-opt-data
 965   endif
 966 
 967   symbols-image: $(LIBS_TARGETS) $(LAUNCHER_TARGETS)
 968 
 969   static-libs-image: $(STATIC_LIBS_TARGETS)
 970 
 971   bootcycle-images: jdk-image
 972 
 973   docs-jdk-api-javadoc: $(GENSRC_TARGETS)
 974 
 975   docs-javase-api-javadoc: $(GENSRC_TARGETS)
 976 
 977   docs-reference-api-javadoc: $(GENSRC_TARGETS)
 978 
 979   # If not already set, then set the JVM specific docs targets
 980   JVM_DOCS_TARGETS ?= hotspot-$(JVM_VARIANT_MAIN)-gensrc
 981 
 982   # The gensrc steps for hotspot create html spec files.
 983   docs-jdk-specs: $(JVM_DOCS_TARGETS)
 984 
 985   # Tests
 986   test-make: clean-test-make compile-commands
 987 
 988   test-make-compile-commands: compile-commands
 989 
 990   # Declare dependency for all generated test targets
 991   $(foreach t, $(filter-out test-make%, $(ALL_TEST_TARGETS)), $(eval $t: jdk-image test-image))
 992   $(foreach t, $(ALL_EXPLODED_TEST_TARGETS), $(eval $t: exploded-image test-image))
 993 
 994   interim-image: $(INTERIM_JMOD_TARGETS)
 995 
 996   build-test-hotspot-jtreg-native: hotspot-$(JVM_VARIANT_MAIN)-libs
 997   build-test-libtest-jtreg-native: hotspot-$(JVM_VARIANT_MAIN)-libs
 998 
 999 endif
1000 
1001 ################################################################################
1002 # Virtual targets without recipes
1003 
1004 # If not already set, set the JVM specific tools targets
1005 JVM_TOOLS_TARGETS ?= buildtools-hotspot
1006 buildtools: buildtools-langtools interim-langtools \
1007     buildtools-jdk $(JVM_TOOLS_TARGETS)
1008 
1009 # Declare dependencies from hotspot-&lt;variant&gt; targets
1010 $(foreach v, $(JVM_VARIANTS), \
1011   $(eval hotspot-$v: hotspot-$v-gensrc hotspot-$v-libs) \
1012 )
1013 hotspot: $(HOTSPOT_VARIANT_TARGETS)
1014 
1015 # Create targets hotspot-libs and hotspot-gensrc.
1016 $(foreach v, $(JVM_VARIANTS), \
1017   $(eval hotspot-libs: hotspot-$v-libs) \
1018   $(eval hotspot-gensrc: hotspot-$v-gensrc) \
1019 )
1020 
1021 gensrc: $(GENSRC_TARGETS)
1022 
1023 gendata: $(GENDATA_TARGETS)
1024 
1025 copy: $(ALL_COPY_TARGETS)
1026 
1027 java: $(JAVA_TARGETS)
1028 
1029 libs: $(LIBS_TARGETS)
1030 
1031 static-libs: $(STATIC_LIBS_TARGETS)
1032 
1033 launchers: $(LAUNCHER_TARGETS)
1034 
1035 jmods: $(JMOD_TARGETS)
1036 
1037 # Explicitly declare dependency for virtual target jdk.jdwp.agent-gensrc which
1038 # is actually handled by jdk.jdi-gensrc
1039 jdk.jdwp.agent-gensrc: jdk.jdi-gensrc
1040 
1041 # Declare dependencies from &lt;module&gt; to all the individual targets specific
1042 # to that module &lt;module&gt;-*, that are needed for the exploded image.
1043 $(foreach m, $(GENSRC_MODULES), $(eval $m: $m-gensrc))
1044 $(foreach m, $(JAVA_MODULES), $(eval $m: $m-java))
1045 $(foreach m, $(GENDATA_MODULES), $(eval $m: $m-gendata))
1046 $(foreach m, $(LIBS_MODULES), $(eval $m: $m-libs))
1047 $(foreach m, $(LAUNCHER_MODULES), $(eval $m: $m-launchers))
1048 $(foreach m, $(ALL_COPY_MODULES), $(eval $m: $m-copy))
1049 
1050 # Building java.base includes building all of hotspot.
1051 java.base: $(JVM_MAIN_TARGETS)
1052 
1053 demos: demos-jdk
1054 
1055 # The &quot;exploded image&quot; is a locally runnable JDK in $(OUTPUTDIR)/jdk.
1056 exploded-image-base: $(ALL_MODULES)
1057 exploded-image: exploded-image-base release-file
1058 # When cross compiling, no need to optimize the exploded image since it won&#39;t
1059 # be runnable on the host platform anyway.
1060 ifneq ($(COMPILE_TYPE), cross)
1061   exploded-image: exploded-image-optimize
1062 endif
1063 
1064 create-buildjdk: create-buildjdk-interim-image
1065 
1066 docs-jdk-api: docs-jdk-api-javadoc
1067 docs-javase-api: docs-javase-api-javadoc
1068 docs-reference-api: docs-reference-api-javadoc
1069 
1070 # If we&#39;re building full docs, we must also generate the module graphs to
1071 # get non-broken api documentation.
1072 ifeq ($(ENABLE_FULL_DOCS), true)
1073   docs-jdk-api: docs-jdk-api-modulegraph
1074   docs-javase-api: docs-javase-api-modulegraph
1075   docs-reference-api: docs-reference-api-modulegraph
1076 endif
1077 
1078 docs-jdk: docs-jdk-api docs-jdk-specs docs-jdk-index
1079 docs-javase: docs-javase-api
1080 docs-reference: docs-reference-api
1081 
1082 # alias for backwards compatibility
1083 docs-javadoc: docs-jdk-api
1084 
1085 mac-bundles: mac-jdk-bundle
1086 
1087 # The $(OUTPUTDIR)/images directory contain the resulting deliverables,
1088 # and in line with this, our targets for creating these are named *-image[s].
1089 
1090 # This target builds the product images, e.g. the JDK image
1091 # (and possibly other, more specific versions)
1092 product-images: jdk-image symbols-image exploded-image
1093 
1094 # This target builds the legacy images, e.g. the legacy JRE image
1095 legacy-images: legacy-jre-image
1096 
1097 # zip-security is actually a bundle, but for now it needs to be considered
1098 # an image until this can be cleaned up properly.
1099 product-images: zip-security
1100 
1101 # The module summary cannot be run when:
1102 # * Cross compiling and building a partial BUILDJDK for the build host
1103 # * An external buildjdk has been supplied since it may not match the
1104 #   module selection of the target jdk
1105 ifneq ($(CREATE_BUILDJDK), true)
1106   ifeq ($(EXTERNAL_BUILDJDK), false)
1107     product-images: generate-summary
1108   endif
1109 endif
1110 
1111 ifeq ($(call isTargetOs, macosx), true)
1112   product-images: mac-jdk-bundle
1113 
1114   legacy-images: mac-legacy-jre-bundle
1115 endif
1116 
1117 # This target builds the documentation image
1118 docs-image: docs-jdk
1119 
1120 # This target builds the test image
1121 test-image: prepare-test-image test-image-jdk-jtreg-native test-image-demos-jdk test-image-libtest-jtreg-native
1122 
1123 ifneq ($(JVM_TEST_IMAGE_TARGETS), )
1124   # If JVM_TEST_IMAGE_TARGETS is externally defined, use it instead of the
1125   # standard hotspot set of tests.
1126   test-image: $(JVM_TEST_IMAGE_TARGETS)
1127 else
1128   test-image: test-image-hotspot-jtreg-native
1129   ifneq ($(GTEST_FRAMEWORK_SRC), )
1130     test-image: test-image-hotspot-gtest
1131   endif
1132 
1133   ifeq ($(INCLUDE_GRAAL), true)
1134     test-image: test-image-hotspot-jtreg-graal
1135   endif
1136 endif
1137 
1138 ifeq ($(BUILD_FAILURE_HANDLER), true)
1139   test-image: test-image-failure-handler
1140 endif
1141 
1142 ifneq ($(JMH_CORE_JAR), )
1143   test-image: build-microbenchmark
1144 endif
1145 
1146 ################################################################################
1147 
1148 # all-images builds all our deliverables as images.
1149 all-images: product-images test-image docs-image
1150 
1151 # all-bundles packages all our deliverables as tar.gz bundles.
1152 all-bundles: product-bundles test-bundles docs-bundles static-libs-bundles
1153 
1154 ALL_TARGETS += buildtools hotspot hotspot-libs hotspot-gensrc gensrc gendata \
1155     copy java libs static-libs launchers jmods \
1156     jdk.jdwp.agent-gensrc $(ALL_MODULES) demos \
1157     exploded-image-base exploded-image \
1158     create-buildjdk docs-jdk-api docs-javase-api docs-reference-api docs-jdk \
1159     docs-javase docs-reference docs-javadoc mac-bundles product-images legacy-images \
1160     docs-image test-image all-images \
1161     all-bundles
1162 
1163 ################################################################################
1164 
1165 # Traditional targets typically run by users.
1166 # These can be considered aliases for the targets now named by a more
1167 # &quot;modern&quot; naming scheme.
1168 default: $(DEFAULT_MAKE_TARGET)
1169 jdk: exploded-image
1170 images: product-images
1171 docs: docs-image
1172 bundles: all-bundles
1173 all: all-images
1174 
1175 ALL_TARGETS += default jdk images docs bundles all
1176 
1177 # Aliases used for running tests.
1178 
1179 # Let &quot;run-test&quot; be an alias for &quot;test&quot;
1180 $(foreach t, $(ALL_NAMED_TESTS), $(eval run-test-$t: test-$t))
1181 RUN_TEST_TARGETS := $(addprefix run-test-, $(ALL_NAMED_TESTS))
1182 
1183 run-test: test
1184 exploded-run-test: exploded-test
1185 
1186 # &quot;make check&quot; is a common idiom for running basic testing
1187 check: test-tier1
1188 
1189 # Keep some old names as aliases
1190 test-hotspot-jtreg: test-hotspot_all
1191 test-hotspot-jtreg-native: test-hotspot_native_sanity
1192 test-hotspot-gtest: exploded-test-gtest
1193 test-jdk-jtreg-native: test-jdk_native_sanity
1194 
1195 ALL_TARGETS += $(RUN_TEST_TARGETS) run-test exploded-run-test check \
1196     test-hotspot-jtreg test-hotspot-jtreg-native test-hotspot-gtest \
1197     test-jdk-jtreg-native
1198 
1199 ################################################################################
1200 ################################################################################
1201 #
1202 # Clean targets
1203 #
1204 ################################################################################
1205 # Clean targets are automatically run serially by the Makefile calling this
1206 # file.
1207 
1208 CLEAN_DIRS += hotspot jdk bootcycle-build test buildtools support \
1209     images make-support test-make bundles buildjdk test-results test-support \
1210     support/images
1211 CLEAN_DIR_TARGETS := $(addprefix clean-, $(CLEAN_DIRS))
1212 CLEAN_SUPPORT_DIRS += demos
1213 CLEAN_SUPPORT_DIR_TARGETS := $(addprefix clean-, $(CLEAN_SUPPORT_DIRS))
1214 CLEAN_TESTS += hotspot-jtreg-native jdk-jtreg-native lib
1215 CLEAN_TEST_TARGETS += $(addprefix clean-test-, $(CLEAN_TESTS))
1216 CLEAN_PHASES := gensrc java native include
1217 CLEAN_PHASE_TARGETS := $(addprefix clean-, $(CLEAN_PHASES))
1218 CLEAN_MODULE_TARGETS := $(addprefix clean-, $(ALL_MODULES))
1219 # Construct targets of the form clean-$module-$phase
1220 CLEAN_MODULE_PHASE_TARGETS := $(addprefix clean-, $(foreach m, $(ALL_MODULES), \
1221     $(addprefix $m-, $(CLEAN_PHASES))))
1222 
1223 # Remove everything, except the output from configure.
1224 clean: $(CLEAN_DIR_TARGETS)
1225 	($(CD) $(OUTPUTDIR) &amp;&amp; $(RM) -r build*.log* compile_commands.json)
1226 	$(ECHO) Cleaned all build artifacts.
1227 
1228 clean-docs:
1229 	$(call CleanDocs)
1230 
1231 clean-compile-commands:
1232 	$(call CleanMakeSupportDir,compile-commands)
1233 
1234 $(CLEAN_DIR_TARGETS):
1235 	$(call CleanDir,$(patsubst clean-%, %, $@))
1236 
1237 $(CLEAN_SUPPORT_DIR_TARGETS):
1238 	$(call CleanSupportDir,$(patsubst clean-%, %, $@))
1239 
1240 $(CLEAN_TEST_TARGETS):
1241 	$(call CleanTest,$(patsubst clean-test-%, %, $@))
1242 
1243 $(CLEAN_PHASE_TARGETS):
1244 	$(call Clean-$(patsubst clean-%,%, $@))
1245 
1246 $(CLEAN_MODULE_TARGETS):
1247 	$(call CleanModule,$(patsubst clean-%, %, $@))
1248 
1249 $(CLEAN_MODULE_PHASE_TARGETS):
1250 	$(call Clean-$(word 3, $(subst -,$(SPACE),$@)), \
1251 	    $(word 2, $(subst -,$(SPACE),$@)))
1252 
1253 # When removing the support dir, we must also remove jdk. Building classes has
1254 # the side effect of generating native headers. The headers end up in support
1255 # while classes and touch files end up in jdk.
1256 clean-support: clean-jdk
1257 
1258 clean-test: clean-test-results clean-test-support
1259 
1260 # When cleaning images, also clean the support/images directory.
1261 clean-images: clean-support/images
1262 
1263 # Remove everything, including configure configuration. If the output
1264 # directory was created by configure and now becomes empty, remove it as well.
1265 dist-clean: clean
1266 	($(CD) $(OUTPUTDIR) &amp;&amp; \
1267 	    $(RM) -r *spec.gmk $(CONFIGURESUPPORT_OUTPUTDIR) Makefile compare.sh ide \
1268 	    configure.log* build.log*)
1269 	$(if $(filter $(CONF_NAME),$(notdir $(OUTPUTDIR))), \
1270 	  if test &quot;x`$(LS) $(OUTPUTDIR)`&quot; != x; then \
1271 	    $(ECHO) &quot;Warning: Not removing non-empty configuration directory for &#39;$(CONF_NAME)&#39;&quot; ; \
1272 	  else \
1273 	    ($(CD) $(TOPDIR) &amp;&amp; $(ECHO) &quot;Removing configuration directory for &#39;$(CONF_NAME)&#39;&quot; \
1274 	        &amp;&amp; $(RM) -r $(OUTPUTDIR)) \
1275 	  fi \
1276 	)
1277 	$(ECHO) Cleaned everything, you will have to re-run configure.
1278 
1279 ALL_TARGETS += clean clean-docs clean-compile-commands dist-clean $(CLEAN_DIR_TARGETS) \
1280     $(CLEAN_SUPPORT_DIR_TARGETS) $(CLEAN_TEST_TARGETS) $(CLEAN_PHASE_TARGETS) \
1281     $(CLEAN_MODULE_TARGETS) $(CLEAN_MODULE_PHASE_TARGETS)
1282 
1283 ################################################################################
1284 # Declare *-only targets for each normal target
1285 $(foreach t, $(ALL_TARGETS), $(eval $(t)-only: $(t)))
1286 
1287 ALL_TARGETS += $(addsuffix -only, $(filter-out dist-clean clean%, $(ALL_TARGETS)))
1288 
1289 ################################################################################
1290 
1291 # The following targets are intentionally not added to ALL_TARGETS since they
1292 # are internal only, to support Init.gmk.
1293 
1294 print-targets:
1295 	  @$(ECHO) $(sort $(ALL_TARGETS))
1296 
1297 print-modules:
1298 	  @$(ECHO) $(sort $(ALL_MODULES))
1299 
1300 print-tests:
1301 	  @$(ECHO) $(sort $(ALL_NAMED_TESTS))
1302 
1303 create-main-targets-include:
1304 	  $(call LogInfo, Generating main target list)
1305 	  @$(ECHO) ALL_MAIN_TARGETS := $(sort $(ALL_TARGETS)) &gt; \
1306 	      $(MAKESUPPORT_OUTPUTDIR)/main-targets.gmk
1307 
1308 ################################################################################
1309 # Hook to include the corresponding custom file, if present.
1310 $(eval $(call IncludeCustomExtension, Main-post.gmk))
1311 
1312 .PHONY: $(ALL_TARGETS)
1313 
1314 FRC: # Force target
<a name="2" id="anc2"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="2" type="hidden" />
</body>
</html>