<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>New test/jdk/tools/jpackage/helpers/jdk/jpackage/test/AdditionalLauncher.java</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
  <body>
    <pre>
  1 /*
  2  * Copyright (c) 2019, 2020, Oracle and/or its affiliates. All rights reserved.
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 package jdk.jpackage.test;
 24 
 25 import java.io.IOException;
 26 import java.nio.file.Files;
 27 import java.nio.file.Path;
 28 import java.util.ArrayList;
 29 import java.util.Collection;
 30 import java.util.List;
 31 import java.util.Map;
 32 import java.util.Optional;
 33 import java.util.function.BiConsumer;
 34 import java.util.stream.Stream;
 35 import jdk.jpackage.test.Functional.ThrowingBiConsumer;
 36 
 37 public final class AdditionalLauncher {
 38 
 39     public AdditionalLauncher(String name) {
 40         this.name = name;
 41         this.rawProperties = new ArrayList&lt;&gt;();
 42         setPersistenceHandler(null);
 43     }
 44 
 45     public AdditionalLauncher setDefaultArguments(String... v) {
 46         defaultArguments = new ArrayList&lt;&gt;(List.of(v));
 47         return this;
 48     }
 49 
 50     public AdditionalLauncher addDefaultArguments(String... v) {
 51         if (defaultArguments == null) {
 52             return setDefaultArguments(v);
 53         }
 54 
 55         defaultArguments.addAll(List.of(v));
 56         return this;
 57     }
 58 
 59     public AdditionalLauncher setJavaOptions(String... v) {
 60         javaOptions = new ArrayList&lt;&gt;(List.of(v));
 61         return this;
 62     }
 63 
 64     public AdditionalLauncher addJavaOptions(String... v) {
 65         if (javaOptions == null) {
 66             return setJavaOptions(v);
 67         }
 68 
 69         javaOptions.addAll(List.of(v));
 70         return this;
 71     }
 72 
 73     public AdditionalLauncher addRawProperties(Map.Entry&lt;String, String&gt;... v) {
 74         return addRawProperties(List.of(v));
 75     }
 76 
 77     public AdditionalLauncher addRawProperties(
 78             Collection&lt;Map.Entry&lt;String, String&gt;&gt; v) {
 79         rawProperties.addAll(v);
 80         return this;
 81     }
 82 
 83     public AdditionalLauncher setIcon(Path iconPath) {
 84         if (iconPath == NO_ICON) {
 85             throw new IllegalArgumentException();
 86         }
 87 
 88         icon = iconPath;
 89         return this;
 90     }
 91 
 92     public AdditionalLauncher setNoIcon() {
 93         icon = NO_ICON;
 94         return this;
 95     }
 96 
 97     public AdditionalLauncher setPersistenceHandler(
 98             ThrowingBiConsumer&lt;Path, List&lt;Map.Entry&lt;String, String&gt;&gt;&gt; handler) {
 99         if (handler != null) {
100             createFileHandler = ThrowingBiConsumer.toBiConsumer(handler);
101         } else {
102             createFileHandler = TKit::createPropertiesFile;
103         }
104         return this;
105     }
106 
107     public void applyTo(JPackageCommand cmd) {
108         cmd.addPrerequisiteAction(this::initialize);
109         cmd.addVerifyAction(this::verify);
110     }
111 
112     public void applyTo(PackageTest test) {
113         test.addInitializer(this::initialize);
114         test.addInstallVerifier(this::verify);
115     }
116 
117     private void initialize(JPackageCommand cmd) {
118         final Path propsFile = TKit.workDir().resolve(name + &quot;.properties&quot;);
119 
120         cmd.addArguments(&quot;--add-launcher&quot;, String.format(&quot;%s=%s&quot;, name,
121                     propsFile));
122 
123         List&lt;Map.Entry&lt;String, String&gt;&gt; properties = new ArrayList&lt;&gt;();
124         if (defaultArguments != null) {
125             properties.add(Map.entry(&quot;arguments&quot;,
126                     JPackageCommand.escapeAndJoin(defaultArguments)));
127         }
128 
129         if (javaOptions != null) {
130             properties.add(Map.entry(&quot;java-options&quot;,
131                     JPackageCommand.escapeAndJoin(javaOptions)));
132         }
133 
134         if (icon != null) {
135             final String iconPath;
136             if (icon == NO_ICON) {
137                 iconPath = &quot;&quot;;
138             } else {
139                 iconPath = icon.toAbsolutePath().toString().replace(&#39;\\&#39;, &#39;/&#39;);
140             }
141             properties.add(Map.entry(&quot;icon&quot;, iconPath));
142         }
143 
144         properties.addAll(rawProperties);
145 
146         createFileHandler.accept(propsFile, properties);
147     }
148 
149     private static Path iconInResourceDir(JPackageCommand cmd,
150             String launcherName) {
151         Path resourceDir = cmd.getArgumentValue(&quot;--resource-dir&quot;, () -&gt; null,
152                 Path::of);
153         if (resourceDir != null) {
154             Path icon = resourceDir.resolve(
155                     Optional.ofNullable(launcherName).orElseGet(() -&gt; cmd.name())
156                     + TKit.ICON_SUFFIX);
157             if (Files.exists(icon)) {
158                 return icon;
159             }
160         }
161         return null;
162     }
163 
164     private void verifyIcon(JPackageCommand cmd) throws IOException {
165         var verifier = new LauncherIconVerifier().setLauncherName(name);
166 
167         if (TKit.isOSX()) {
168             // On Mac should be no icon files for additional launchers.
169             verifier.applyTo(cmd);
170             return;
171         }
172 
173         boolean withLinuxDesktopFile = false;
174 
175         final Path effectiveIcon = Optional.ofNullable(icon).orElseGet(
176                 () -&gt; iconInResourceDir(cmd, name));
177         while (effectiveIcon != NO_ICON) {
178             if (effectiveIcon != null) {
179                 withLinuxDesktopFile = true;
180                 verifier.setExpectedIcon(effectiveIcon);
181                 break;
182             }
183 
184             Path customMainLauncherIcon = cmd.getArgumentValue(&quot;--icon&quot;,
185                     () -&gt; iconInResourceDir(cmd, null), Path::of);
186             if (customMainLauncherIcon != null) {
187                 withLinuxDesktopFile = true;
188                 verifier.setExpectedIcon(customMainLauncherIcon);
189                 break;
190             }
191 
192             verifier.setExpectedDefaultIcon();
193             break;
194         }
195 
196         if (TKit.isLinux() &amp;&amp; !cmd.isImagePackageType()) {
197             if (effectiveIcon != NO_ICON &amp;&amp; !withLinuxDesktopFile) {
198                 withLinuxDesktopFile = Stream.of(&quot;--linux-shortcut&quot;).anyMatch(
199                         cmd::hasArgument);
200                 verifier.setExpectedDefaultIcon();
201             }
202             Path desktopFile = LinuxHelper.getDesktopFile(cmd, name);
203             if (withLinuxDesktopFile) {
204                 TKit.assertFileExists(desktopFile);
205             } else {
206                 TKit.assertPathExists(desktopFile, false);
207             }
208         }
209 
210         verifier.applyTo(cmd);
211     }
212 
213     private void verify(JPackageCommand cmd) throws IOException {
214         verifyIcon(cmd);
215 
216         Path launcherPath = cmd.appLauncherPath(name);
217 
218         TKit.assertExecutableFileExists(launcherPath);
219 
220         if (!cmd.canRunLauncher(String.format(
221                 &quot;Not running %s launcher&quot;, launcherPath))) {
222             return;
223         }
224 
225         HelloApp.assertApp(launcherPath)
226         .addDefaultArguments(Optional
227                 .ofNullable(defaultArguments)
228                 .orElseGet(() -&gt; List.of(cmd.getAllArgumentValues(&quot;--arguments&quot;))))
229         .addJavaOptions(Optional
230                 .ofNullable(javaOptions)
231                 .orElseGet(() -&gt; List.of(cmd.getAllArgumentValues(&quot;--java-options&quot;))))
232         .executeAndVerifyOutput();
233     }
234 
235     private List&lt;String&gt; javaOptions;
236     private List&lt;String&gt; defaultArguments;
237     private Path icon;
238     private final String name;
239     private final List&lt;Map.Entry&lt;String, String&gt;&gt; rawProperties;
240     private BiConsumer&lt;Path, List&lt;Map.Entry&lt;String, String&gt;&gt;&gt; createFileHandler;
241 
242     private final static Path NO_ICON = Path.of(&quot;&quot;);
243 }
    </pre>
  </body>
</html>