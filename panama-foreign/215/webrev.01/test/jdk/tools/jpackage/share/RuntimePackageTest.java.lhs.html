<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames test/jdk/tools/jpackage/share/RuntimePackageTest.java</title>
    <link rel="stylesheet" href="../../../../../style.css" />
    <script type="text/javascript" src="../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
  2  * Copyright (c) 2018, 2020, Oracle and/or its affiliates. All rights reserved.
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 import java.io.IOException;
 25 import java.nio.file.Files;
 26 import java.nio.file.Path;
 27 import java.util.HashSet;
 28 import java.util.Optional;
 29 import java.util.Set;
 30 import java.util.stream.Collectors;
<a name="1" id="anc1"></a><span class="line-modified"> 31 import jdk.jpackage.test.*;</span>



 32 import jdk.jpackage.test.Annotations.Test;
 33 
 34 /**
 35  * Test --runtime-image parameter.
 36  * Output of the test should be RuntimePackageTest*.* installer.
 37  * The installer should install Java Runtime without an application.
 38  * Installation directory should not have &quot;app&quot; subfolder and should not have
 39  * an application launcher.
 40  *
 41  *
 42  * Windows:
 43  *
 44  * Java runtime should be installed in %ProgramFiles%\RuntimePackageTest directory.
 45  */
 46 
 47 /*
 48  * @test
 49  * @summary jpackage with --runtime-image
 50  * @library ../helpers
 51  * @key jpackagePlatformPackage
 52  * @build jdk.jpackage.test.*
 53  * @comment Temporary disable for OSX until functionality implemented
 54  * @requires (os.family != &quot;mac&quot;)
 55  * @requires (jpackage.test.SQETest == null)
 56  * @modules jdk.incubator.jpackage/jdk.incubator.jpackage.internal
 57  * @compile RuntimePackageTest.java
 58  * @run main/othervm/timeout=1400 -Xmx512m jdk.jpackage.test.Main
 59  *  --jpt-run=RuntimePackageTest
 60  */
 61 
 62 /*
 63  * @test
 64  * @summary jpackage with --runtime-image
 65  * @library ../helpers
 66  * @key jpackagePlatformPackage
 67  * @build jdk.jpackage.test.*
 68  * @comment Temporary disable for OSX until functionality implemented
 69  * @requires (os.family != &quot;mac&quot;)
 70  * @requires (jpackage.test.SQETest != null)
 71  * @modules jdk.incubator.jpackage/jdk.incubator.jpackage.internal
 72  * @compile RuntimePackageTest.java
 73  * @run main/othervm/timeout=720 -Xmx512m jdk.jpackage.test.Main
 74  *  --jpt-run=RuntimePackageTest.test
 75  */
 76 public class RuntimePackageTest {
 77 
 78     @Test
 79     public static void test() {
 80         init(PackageType.NATIVE).run();
 81     }
 82 
 83     @Test
 84     public static void testUsrInstallDir() {
 85         init(PackageType.LINUX)
 86         .addInitializer(cmd -&gt; cmd.addArguments(&quot;--install-dir&quot;, &quot;/usr&quot;))
 87         .run();
 88     }
 89 
 90     @Test
 91     public static void testUsrInstallDir2() {
 92         init(PackageType.LINUX)
 93         .addInitializer(cmd -&gt; cmd.addArguments(&quot;--install-dir&quot;, &quot;/usr/lib/Java&quot;))
 94         .run();
 95     }
 96 
 97     private static PackageTest init(Set&lt;PackageType&gt; types) {
 98         return new PackageTest()
 99         .forTypes(types)
100         .addInitializer(cmd -&gt; {
101             cmd.addArguments(&quot;--runtime-image&quot;, Optional.ofNullable(
102                     JPackageCommand.DEFAULT_RUNTIME_IMAGE).orElse(Path.of(
103                             System.getProperty(&quot;java.home&quot;))));
104             // Remove --input parameter from jpackage command line as we don&#39;t
105             // create input directory in the test and jpackage fails
106             // if --input references non existant directory.
107             cmd.removeArgumentWithValue(&quot;--input&quot;);
108         })
109         .addInstallVerifier(cmd -&gt; {
110             Set&lt;Path&gt; srcRuntime = listFiles(Path.of(cmd.getArgumentValue(&quot;--runtime-image&quot;)));
111             Set&lt;Path&gt; dstRuntime = listFiles(cmd.appRuntimeDirectory());
112 
113             Set&lt;Path&gt; intersection = new HashSet&lt;&gt;(srcRuntime);
114             intersection.retainAll(dstRuntime);
115 
116             srcRuntime.removeAll(intersection);
117             dstRuntime.removeAll(intersection);
118 
119             assertFileListEmpty(srcRuntime, &quot;Missing&quot;);
120             assertFileListEmpty(dstRuntime, &quot;Unexpected&quot;);
121         });
122     }
123 
124     private static Set&lt;Path&gt; listFiles(Path root) throws IOException {
125         try (var files = Files.walk(root)) {
126             return files.map(root::relativize).collect(Collectors.toSet());
127         }
128     }
129 
130     private static void assertFileListEmpty(Set&lt;Path&gt; paths, String msg) {
131         TKit.assertTrue(paths.isEmpty(), String.format(
132                 &quot;Check there are no %s files in installed image&quot;,
133                 msg.toLowerCase()), () -&gt; {
134             String msg2 = String.format(&quot;%s %d files&quot;, msg, paths.size());
135             TKit.trace(msg2 + &quot;:&quot;);
136             paths.stream().map(Path::toString).sorted().forEachOrdered(
137                     TKit::trace);
138             TKit.trace(&quot;Done&quot;);
139         });
140     }
141 }
<a name="2" id="anc2"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="2" type="hidden" />
</body>
</html>