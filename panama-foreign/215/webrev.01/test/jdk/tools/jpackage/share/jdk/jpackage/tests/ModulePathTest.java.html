<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>New test/jdk/tools/jpackage/share/jdk/jpackage/tests/ModulePathTest.java</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
  <body>
    <pre>
  1 /*
  2  * Copyright (c) 2019, 2020, Oracle and/or its affiliates. All rights reserved.
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 package jdk.jpackage.tests;
 25 
 26 import java.io.File;
 27 import java.io.IOException;
 28 import java.nio.file.Path;
 29 import java.util.Collection;
 30 import java.util.List;
 31 import java.util.function.Function;
 32 import java.util.stream.Collectors;
 33 import java.util.stream.Stream;
 34 import jdk.jpackage.test.TKit;
 35 import jdk.jpackage.test.JavaAppDesc;
 36 import jdk.jpackage.test.HelloApp;
 37 import jdk.jpackage.test.JPackageCommand;
 38 import jdk.jpackage.test.PackageType;
 39 import jdk.jpackage.test.Annotations.Parameter;
 40 import jdk.jpackage.test.Annotations.Parameters;
 41 import jdk.jpackage.test.Annotations.Test;
 42 
 43 
 44 /*
 45  * @test
 46  * @summary jpackage with --module-path testing
 47  * @library ../../../../helpers
 48  * @build jdk.jpackage.test.*
 49  * @modules jdk.incubator.jpackage/jdk.incubator.jpackage.internal
 50  * @compile ModulePathTest.java
 51  * @run main/othervm/timeout=360 -Xmx512m jdk.jpackage.test.Main
 52  *  --jpt-run=jdk.jpackage.tests.ModulePathTest
 53  */
 54 
 55 public final class ModulePathTest {
 56 
 57     @Parameters
 58     public static Collection data() {
 59         return List.of(new String[][]{
 60             {GOOD_PATH, EMPTY_DIR, NON_EXISTING_DIR},
 61             {EMPTY_DIR, NON_EXISTING_DIR, GOOD_PATH},
 62             {GOOD_PATH + &quot;/a/b/c/d&quot;, GOOD_PATH},
 63             {String.join(File.pathSeparator, EMPTY_DIR, NON_EXISTING_DIR,
 64                 GOOD_PATH)},
 65             {String.join(File.pathSeparator, EMPTY_DIR, NON_EXISTING_DIR),
 66                 String.join(File.pathSeparator, EMPTY_DIR, NON_EXISTING_DIR,
 67                 GOOD_PATH)},
 68             {},
 69             {EMPTY_DIR}
 70         });
 71     }
 72 
 73     public ModulePathTest(String... modulePathArgs) {
 74         this.modulePathArgs = List.of(modulePathArgs);
 75     }
 76 
 77     @Test
 78     @Parameter(&quot;benvenuto.jar:com.jar.foo/com.jar.foo.Hello&quot;)
 79     @Parameter(&quot;benvenuto.jmod:com.jmod.foo/com.jmod.foo.JModHello&quot;)
 80     public void test(String javaAppDesc) throws IOException {
 81         JavaAppDesc appDesc = JavaAppDesc.parse(javaAppDesc);
 82 
 83         Path goodModulePath = TKit.createTempDirectory(&quot;modules&quot;);
 84 
 85         Path appBundle = HelloApp.createBundle(appDesc, goodModulePath);
 86 
 87         JPackageCommand cmd = new JPackageCommand()
 88                 .setArgumentValue(&quot;--dest&quot;, TKit.workDir().resolve(&quot;output&quot;))
 89                 .setDefaultAppName()
 90                 .setPackageType(PackageType.IMAGE);
 91 
 92         if (TKit.isWindows()) {
 93             cmd.addArguments(&quot;--win-console&quot;);
 94         }
 95 
 96         cmd.addArguments(&quot;--module&quot;, String.join(&quot;/&quot;, appDesc.moduleName(),
 97                 appDesc.className()));
 98 
 99         // Ignore runtime that can be set for all tests. Usually if default
100         // runtime is set, it is fake one to save time on running jlink and
101         // copying megabytes of data from Java home to application image.
102         // We need proper runtime for this test.
103         cmd.ignoreDefaultRuntime(true);
104 
105         Path emptyDir = TKit.createTempDirectory(&quot;empty-dir&quot;);
106         Path nonExistingDir = TKit.withTempDirectory(&quot;non-existing-dir&quot;, x -&gt; {});
107 
108         Function&lt;String, String&gt; substitute = str -&gt; {
109             String v = str;
110             v = v.replace(GOOD_PATH, goodModulePath.toString());
111             v = v.replace(EMPTY_DIR, emptyDir.toString());
112             v = v.replace(NON_EXISTING_DIR, nonExistingDir.toString());
113             return v;
114         };
115 
116         boolean withGoodPath = modulePathArgs.stream().anyMatch(
117                 s -&gt; s.contains(GOOD_PATH));
118 
119         cmd.addArguments(modulePathArgs.stream().map(arg -&gt; Stream.of(
120                 &quot;--module-path&quot;, substitute.apply(arg))).flatMap(s -&gt; s).collect(
121                 Collectors.toList()));
122 
123         if (withGoodPath) {
124             cmd.executeAndAssertHelloAppImageCreated();
125         } else {
126             final String expectedErrorMessage;
127             if (modulePathArgs.isEmpty()) {
128                 expectedErrorMessage = &quot;Error: Missing argument: --runtime-image or --module-path&quot;;
129             } else {
130                 expectedErrorMessage = String.format(
131                         &quot;Failed to find %s module in module path&quot;, appDesc.moduleName());
132             }
133 
134             List&lt;String&gt; output = cmd
135                     .saveConsoleOutput(true)
136                     .execute(1)
137                     .getOutput();
138             TKit.assertTextStream(expectedErrorMessage).apply(output.stream());
139         }
140     }
141 
142     private final List&lt;String&gt; modulePathArgs;
143 
144     private final static String GOOD_PATH = &quot;@GoodPath@&quot;;
145     private final static String EMPTY_DIR = &quot;@EmptyDir@&quot;;
146     private final static String NON_EXISTING_DIR = &quot;@NonExistingDir@&quot;;
147 }
    </pre>
  </body>
</html>