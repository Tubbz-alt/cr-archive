<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames src/hotspot/os_cpu/bsd_x86/os_bsd_x86.cpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
    <script type="text/javascript" src="../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>   1 /*
   2  * Copyright (c) 1999, 2020, Oracle and/or its affiliates. All rights reserved.
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.
   8  *
   9  * This code is distributed in the hope that it will be useful, but WITHOUT
  10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  *
  23  */
  24 
  25 // no precompiled headers
  26 #include &quot;jvm.h&quot;
  27 #include &quot;asm/macroAssembler.hpp&quot;
  28 #include &quot;classfile/classLoader.hpp&quot;
  29 #include &quot;classfile/systemDictionary.hpp&quot;
  30 #include &quot;classfile/vmSymbols.hpp&quot;
  31 #include &quot;code/codeCache.hpp&quot;
  32 #include &quot;code/icBuffer.hpp&quot;
  33 #include &quot;code/vtableStubs.hpp&quot;
  34 #include &quot;interpreter/interpreter.hpp&quot;
  35 #include &quot;logging/log.hpp&quot;
  36 #include &quot;memory/allocation.inline.hpp&quot;
  37 #include &quot;os_share_bsd.hpp&quot;
  38 #include &quot;prims/jniFastGetField.hpp&quot;
  39 #include &quot;prims/jvm_misc.hpp&quot;
  40 #include &quot;runtime/arguments.hpp&quot;
<a name="1" id="anc1"></a>
  41 #include &quot;runtime/frame.inline.hpp&quot;
  42 #include &quot;runtime/interfaceSupport.inline.hpp&quot;
  43 #include &quot;runtime/java.hpp&quot;
  44 #include &quot;runtime/javaCalls.hpp&quot;
  45 #include &quot;runtime/mutexLocker.hpp&quot;
  46 #include &quot;runtime/osThread.hpp&quot;
  47 #include &quot;runtime/safepointMechanism.hpp&quot;
  48 #include &quot;runtime/sharedRuntime.hpp&quot;
  49 #include &quot;runtime/stubRoutines.hpp&quot;
  50 #include &quot;runtime/thread.inline.hpp&quot;
  51 #include &quot;runtime/timer.hpp&quot;
  52 #include &quot;utilities/align.hpp&quot;
  53 #include &quot;utilities/events.hpp&quot;
  54 #include &quot;utilities/vmError.hpp&quot;
  55 
  56 // put OS-includes here
  57 # include &lt;sys/types.h&gt;
  58 # include &lt;sys/mman.h&gt;
  59 # include &lt;pthread.h&gt;
  60 # include &lt;signal.h&gt;
  61 # include &lt;errno.h&gt;
  62 # include &lt;dlfcn.h&gt;
  63 # include &lt;stdlib.h&gt;
  64 # include &lt;stdio.h&gt;
  65 # include &lt;unistd.h&gt;
  66 # include &lt;sys/resource.h&gt;
  67 # include &lt;pthread.h&gt;
  68 # include &lt;sys/stat.h&gt;
  69 # include &lt;sys/time.h&gt;
  70 # include &lt;sys/utsname.h&gt;
  71 # include &lt;sys/socket.h&gt;
  72 # include &lt;sys/wait.h&gt;
  73 # include &lt;pwd.h&gt;
  74 # include &lt;poll.h&gt;
  75 #ifndef __OpenBSD__
  76 # include &lt;ucontext.h&gt;
  77 #endif
  78 
  79 #if !defined(__APPLE__) &amp;&amp; !defined(__NetBSD__)
  80 # include &lt;pthread_np.h&gt;
  81 #endif
  82 
  83 // needed by current_stack_region() workaround for Mavericks
  84 #if defined(__APPLE__)
  85 # include &lt;errno.h&gt;
  86 # include &lt;sys/types.h&gt;
  87 # include &lt;sys/sysctl.h&gt;
  88 # define DEFAULT_MAIN_THREAD_STACK_PAGES 2048
  89 # define OS_X_10_9_0_KERNEL_MAJOR_VERSION 13
  90 #endif
  91 
  92 #ifdef AMD64
  93 #define SPELL_REG_SP &quot;rsp&quot;
  94 #define SPELL_REG_FP &quot;rbp&quot;
  95 #else
  96 #define SPELL_REG_SP &quot;esp&quot;
  97 #define SPELL_REG_FP &quot;ebp&quot;
  98 #endif // AMD64
  99 
 100 #ifdef __FreeBSD__
 101 # define context_trapno uc_mcontext.mc_trapno
 102 # ifdef AMD64
 103 #  define context_pc uc_mcontext.mc_rip
 104 #  define context_sp uc_mcontext.mc_rsp
 105 #  define context_fp uc_mcontext.mc_rbp
 106 #  define context_rip uc_mcontext.mc_rip
 107 #  define context_rsp uc_mcontext.mc_rsp
 108 #  define context_rbp uc_mcontext.mc_rbp
 109 #  define context_rax uc_mcontext.mc_rax
 110 #  define context_rbx uc_mcontext.mc_rbx
 111 #  define context_rcx uc_mcontext.mc_rcx
 112 #  define context_rdx uc_mcontext.mc_rdx
 113 #  define context_rsi uc_mcontext.mc_rsi
 114 #  define context_rdi uc_mcontext.mc_rdi
 115 #  define context_r8  uc_mcontext.mc_r8
 116 #  define context_r9  uc_mcontext.mc_r9
 117 #  define context_r10 uc_mcontext.mc_r10
 118 #  define context_r11 uc_mcontext.mc_r11
 119 #  define context_r12 uc_mcontext.mc_r12
 120 #  define context_r13 uc_mcontext.mc_r13
 121 #  define context_r14 uc_mcontext.mc_r14
 122 #  define context_r15 uc_mcontext.mc_r15
 123 #  define context_flags uc_mcontext.mc_flags
 124 #  define context_err uc_mcontext.mc_err
 125 # else
 126 #  define context_pc uc_mcontext.mc_eip
 127 #  define context_sp uc_mcontext.mc_esp
 128 #  define context_fp uc_mcontext.mc_ebp
 129 #  define context_eip uc_mcontext.mc_eip
 130 #  define context_esp uc_mcontext.mc_esp
 131 #  define context_eax uc_mcontext.mc_eax
 132 #  define context_ebx uc_mcontext.mc_ebx
 133 #  define context_ecx uc_mcontext.mc_ecx
 134 #  define context_edx uc_mcontext.mc_edx
 135 #  define context_ebp uc_mcontext.mc_ebp
 136 #  define context_esi uc_mcontext.mc_esi
 137 #  define context_edi uc_mcontext.mc_edi
 138 #  define context_eflags uc_mcontext.mc_eflags
 139 #  define context_trapno uc_mcontext.mc_trapno
 140 # endif
 141 #endif
 142 
 143 #ifdef __APPLE__
 144 # if __DARWIN_UNIX03 &amp;&amp; (MAC_OS_X_VERSION_MAX_ALLOWED &gt;= MAC_OS_X_VERSION_10_5)
 145   // 10.5 UNIX03 member name prefixes
 146   #define DU3_PREFIX(s, m) __ ## s.__ ## m
 147 # else
 148   #define DU3_PREFIX(s, m) s ## . ## m
 149 # endif
 150 
 151 # ifdef AMD64
 152 #  define context_pc context_rip
 153 #  define context_sp context_rsp
 154 #  define context_fp context_rbp
 155 #  define context_rip uc_mcontext-&gt;DU3_PREFIX(ss,rip)
 156 #  define context_rsp uc_mcontext-&gt;DU3_PREFIX(ss,rsp)
 157 #  define context_rax uc_mcontext-&gt;DU3_PREFIX(ss,rax)
 158 #  define context_rbx uc_mcontext-&gt;DU3_PREFIX(ss,rbx)
 159 #  define context_rcx uc_mcontext-&gt;DU3_PREFIX(ss,rcx)
 160 #  define context_rdx uc_mcontext-&gt;DU3_PREFIX(ss,rdx)
 161 #  define context_rbp uc_mcontext-&gt;DU3_PREFIX(ss,rbp)
 162 #  define context_rsi uc_mcontext-&gt;DU3_PREFIX(ss,rsi)
 163 #  define context_rdi uc_mcontext-&gt;DU3_PREFIX(ss,rdi)
 164 #  define context_r8  uc_mcontext-&gt;DU3_PREFIX(ss,r8)
 165 #  define context_r9  uc_mcontext-&gt;DU3_PREFIX(ss,r9)
 166 #  define context_r10 uc_mcontext-&gt;DU3_PREFIX(ss,r10)
 167 #  define context_r11 uc_mcontext-&gt;DU3_PREFIX(ss,r11)
 168 #  define context_r12 uc_mcontext-&gt;DU3_PREFIX(ss,r12)
 169 #  define context_r13 uc_mcontext-&gt;DU3_PREFIX(ss,r13)
 170 #  define context_r14 uc_mcontext-&gt;DU3_PREFIX(ss,r14)
 171 #  define context_r15 uc_mcontext-&gt;DU3_PREFIX(ss,r15)
 172 #  define context_flags uc_mcontext-&gt;DU3_PREFIX(ss,rflags)
 173 #  define context_trapno uc_mcontext-&gt;DU3_PREFIX(es,trapno)
 174 #  define context_err uc_mcontext-&gt;DU3_PREFIX(es,err)
 175 # else
 176 #  define context_pc context_eip
 177 #  define context_sp context_esp
 178 #  define context_fp context_ebp
 179 #  define context_eip uc_mcontext-&gt;DU3_PREFIX(ss,eip)
 180 #  define context_esp uc_mcontext-&gt;DU3_PREFIX(ss,esp)
 181 #  define context_eax uc_mcontext-&gt;DU3_PREFIX(ss,eax)
 182 #  define context_ebx uc_mcontext-&gt;DU3_PREFIX(ss,ebx)
 183 #  define context_ecx uc_mcontext-&gt;DU3_PREFIX(ss,ecx)
 184 #  define context_edx uc_mcontext-&gt;DU3_PREFIX(ss,edx)
 185 #  define context_ebp uc_mcontext-&gt;DU3_PREFIX(ss,ebp)
 186 #  define context_esi uc_mcontext-&gt;DU3_PREFIX(ss,esi)
 187 #  define context_edi uc_mcontext-&gt;DU3_PREFIX(ss,edi)
 188 #  define context_eflags uc_mcontext-&gt;DU3_PREFIX(ss,eflags)
 189 #  define context_trapno uc_mcontext-&gt;DU3_PREFIX(es,trapno)
 190 # endif
 191 #endif
 192 
 193 #ifdef __OpenBSD__
 194 # define context_trapno sc_trapno
 195 # ifdef AMD64
 196 #  define context_pc sc_rip
 197 #  define context_sp sc_rsp
 198 #  define context_fp sc_rbp
 199 #  define context_rip sc_rip
 200 #  define context_rsp sc_rsp
 201 #  define context_rbp sc_rbp
 202 #  define context_rax sc_rax
 203 #  define context_rbx sc_rbx
 204 #  define context_rcx sc_rcx
 205 #  define context_rdx sc_rdx
 206 #  define context_rsi sc_rsi
 207 #  define context_rdi sc_rdi
 208 #  define context_r8  sc_r8
 209 #  define context_r9  sc_r9
 210 #  define context_r10 sc_r10
 211 #  define context_r11 sc_r11
 212 #  define context_r12 sc_r12
 213 #  define context_r13 sc_r13
 214 #  define context_r14 sc_r14
 215 #  define context_r15 sc_r15
 216 #  define context_flags sc_rflags
 217 #  define context_err sc_err
 218 # else
 219 #  define context_pc sc_eip
 220 #  define context_sp sc_esp
 221 #  define context_fp sc_ebp
 222 #  define context_eip sc_eip
 223 #  define context_esp sc_esp
 224 #  define context_eax sc_eax
 225 #  define context_ebx sc_ebx
 226 #  define context_ecx sc_ecx
 227 #  define context_edx sc_edx
 228 #  define context_ebp sc_ebp
 229 #  define context_esi sc_esi
 230 #  define context_edi sc_edi
 231 #  define context_eflags sc_eflags
 232 #  define context_trapno sc_trapno
 233 # endif
 234 #endif
 235 
 236 #ifdef __NetBSD__
 237 # define context_trapno uc_mcontext.__gregs[_REG_TRAPNO]
 238 # ifdef AMD64
 239 #  define __register_t __greg_t
 240 #  define context_pc uc_mcontext.__gregs[_REG_RIP]
 241 #  define context_sp uc_mcontext.__gregs[_REG_URSP]
 242 #  define context_fp uc_mcontext.__gregs[_REG_RBP]
 243 #  define context_rip uc_mcontext.__gregs[_REG_RIP]
 244 #  define context_rsp uc_mcontext.__gregs[_REG_URSP]
 245 #  define context_rax uc_mcontext.__gregs[_REG_RAX]
 246 #  define context_rbx uc_mcontext.__gregs[_REG_RBX]
 247 #  define context_rcx uc_mcontext.__gregs[_REG_RCX]
 248 #  define context_rdx uc_mcontext.__gregs[_REG_RDX]
 249 #  define context_rbp uc_mcontext.__gregs[_REG_RBP]
 250 #  define context_rsi uc_mcontext.__gregs[_REG_RSI]
 251 #  define context_rdi uc_mcontext.__gregs[_REG_RDI]
 252 #  define context_r8  uc_mcontext.__gregs[_REG_R8]
 253 #  define context_r9  uc_mcontext.__gregs[_REG_R9]
 254 #  define context_r10 uc_mcontext.__gregs[_REG_R10]
 255 #  define context_r11 uc_mcontext.__gregs[_REG_R11]
 256 #  define context_r12 uc_mcontext.__gregs[_REG_R12]
 257 #  define context_r13 uc_mcontext.__gregs[_REG_R13]
 258 #  define context_r14 uc_mcontext.__gregs[_REG_R14]
 259 #  define context_r15 uc_mcontext.__gregs[_REG_R15]
 260 #  define context_flags uc_mcontext.__gregs[_REG_RFL]
 261 #  define context_err uc_mcontext.__gregs[_REG_ERR]
 262 # else
 263 #  define context_pc uc_mcontext.__gregs[_REG_EIP]
 264 #  define context_sp uc_mcontext.__gregs[_REG_UESP]
 265 #  define context_fp uc_mcontext.__gregs[_REG_EBP]
 266 #  define context_eip uc_mcontext.__gregs[_REG_EIP]
 267 #  define context_esp uc_mcontext.__gregs[_REG_UESP]
 268 #  define context_eax uc_mcontext.__gregs[_REG_EAX]
 269 #  define context_ebx uc_mcontext.__gregs[_REG_EBX]
 270 #  define context_ecx uc_mcontext.__gregs[_REG_ECX]
 271 #  define context_edx uc_mcontext.__gregs[_REG_EDX]
 272 #  define context_ebp uc_mcontext.__gregs[_REG_EBP]
 273 #  define context_esi uc_mcontext.__gregs[_REG_ESI]
 274 #  define context_edi uc_mcontext.__gregs[_REG_EDI]
 275 #  define context_eflags uc_mcontext.__gregs[_REG_EFL]
 276 #  define context_trapno uc_mcontext.__gregs[_REG_TRAPNO]
 277 # endif
 278 #endif
 279 
 280 address os::current_stack_pointer() {
 281 #if defined(__clang__) || defined(__llvm__)
 282   void *esp;
 283   __asm__(&quot;mov %%&quot; SPELL_REG_SP &quot;, %0&quot;:&quot;=r&quot;(esp));
 284   return (address) esp;
 285 #else
 286   register void *esp __asm__ (SPELL_REG_SP);
 287   return (address) esp;
 288 #endif
 289 }
 290 
 291 char* os::non_memory_address_word() {
 292   // Must never look like an address returned by reserve_memory,
 293   // even in its subfields (as defined by the CPU immediate fields,
 294   // if the CPU splits constants across multiple instructions).
 295 
 296   return (char*) -1;
 297 }
 298 
 299 address os::Bsd::ucontext_get_pc(const ucontext_t * uc) {
 300   return (address)uc-&gt;context_pc;
 301 }
 302 
 303 void os::Bsd::ucontext_set_pc(ucontext_t * uc, address pc) {
 304   uc-&gt;context_pc = (intptr_t)pc ;
 305 }
 306 
 307 intptr_t* os::Bsd::ucontext_get_sp(const ucontext_t * uc) {
 308   return (intptr_t*)uc-&gt;context_sp;
 309 }
 310 
 311 intptr_t* os::Bsd::ucontext_get_fp(const ucontext_t * uc) {
 312   return (intptr_t*)uc-&gt;context_fp;
 313 }
 314 
<a name="2" id="anc2"></a><span class="line-modified"> 315 address os::fetch_frame_from_context(const void* ucVoid,</span>
















 316                     intptr_t** ret_sp, intptr_t** ret_fp) {
 317 
<a name="3" id="anc3"></a><span class="line-modified"> 318   address  epc;</span>
 319   const ucontext_t* uc = (const ucontext_t*)ucVoid;
 320 
 321   if (uc != NULL) {
<a name="4" id="anc4"></a><span class="line-modified"> 322     epc = os::Bsd::ucontext_get_pc(uc);</span>
 323     if (ret_sp) *ret_sp = os::Bsd::ucontext_get_sp(uc);
 324     if (ret_fp) *ret_fp = os::Bsd::ucontext_get_fp(uc);
 325   } else {
<a name="5" id="anc5"></a><span class="line-modified"> 326     epc = NULL;</span>

 327     if (ret_sp) *ret_sp = (intptr_t *)NULL;
 328     if (ret_fp) *ret_fp = (intptr_t *)NULL;
 329   }
 330 
 331   return epc;
 332 }
 333 
 334 frame os::fetch_frame_from_context(const void* ucVoid) {
 335   intptr_t* sp;
 336   intptr_t* fp;
<a name="6" id="anc6"></a><span class="line-modified"> 337   address epc = fetch_frame_from_context(ucVoid, &amp;sp, &amp;fp);</span>
<span class="line-modified"> 338   return frame(sp, fp, epc);</span>







 339 }
 340 
 341 bool os::Bsd::get_frame_at_stack_banging_point(JavaThread* thread, ucontext_t* uc, frame* fr) {
 342   address pc = (address) os::Bsd::ucontext_get_pc(uc);
 343   if (Interpreter::contains(pc)) {
 344     // interpreter performs stack banging after the fixed frame header has
 345     // been generated while the compilers perform it before. To maintain
 346     // semantic consistency between interpreted and compiled frames, the
 347     // method returns the Java sender of the current frame.
<a name="7" id="anc7"></a><span class="line-modified"> 348     *fr = os::fetch_frame_from_context(uc);</span>
 349     if (!fr-&gt;is_first_java_frame()) {
 350       // get_frame_at_stack_banging_point() is only called when we
 351       // have well defined stacks so java_sender() calls do not need
 352       // to assert safe_for_sender() first.
 353       *fr = fr-&gt;java_sender();
 354     }
 355   } else {
 356     // more complex code with compiled code
 357     assert(!Interpreter::contains(pc), &quot;Interpreted methods should have been handled above&quot;);
 358     CodeBlob* cb = CodeCache::find_blob(pc);
 359     if (cb == NULL || !cb-&gt;is_nmethod() || cb-&gt;is_frame_complete_at(pc)) {
 360       // Not sure where the pc points to, fallback to default
 361       // stack overflow handling
 362       return false;
 363     } else {
<a name="8" id="anc8"></a><span class="line-modified"> 364       *fr = os::fetch_frame_from_context(uc);</span>
 365       // in compiled code, the stack banging is performed just after the return pc
 366       // has been pushed on the stack
 367       *fr = frame(fr-&gt;sp() + 1, fr-&gt;fp(), (address)*(fr-&gt;sp()));
 368       if (!fr-&gt;is_java_frame()) {
 369         // See java_sender() comment above.
 370         *fr = fr-&gt;java_sender();
 371       }
 372     }
 373   }
 374   assert(fr-&gt;is_java_frame(), &quot;Safety check&quot;);
 375   return true;
 376 }
 377 
 378 // By default, gcc always save frame pointer (%ebp/%rbp) on stack. It may get
 379 // turned off by -fomit-frame-pointer,
 380 frame os::get_sender_for_C_frame(frame* fr) {
 381   return frame(fr-&gt;sender_sp(), fr-&gt;link(), fr-&gt;sender_pc());
 382 }
 383 
 384 intptr_t* _get_previous_fp() {
 385 #if defined(__clang__) || defined(__llvm__)
 386   intptr_t **ebp;
 387   __asm__(&quot;mov %%&quot; SPELL_REG_FP &quot;, %0&quot;:&quot;=r&quot;(ebp));
 388 #else
 389   register intptr_t **ebp __asm__ (SPELL_REG_FP);
 390 #endif
 391   // ebp is for this frame (_get_previous_fp). We want the ebp for the
 392   // caller of os::current_frame*(), so go up two frames. However, for
 393   // optimized builds, _get_previous_fp() will be inlined, so only go
 394   // up 1 frame in that case.
 395 #ifdef _NMT_NOINLINE_
 396   return **(intptr_t***)ebp;
 397 #else
 398   return *ebp;
 399 #endif
 400 }
 401 
 402 
 403 frame os::current_frame() {
 404   intptr_t* fp = _get_previous_fp();
 405   frame myframe((intptr_t*)os::current_stack_pointer(),
 406                 (intptr_t*)fp,
 407                 CAST_FROM_FN_PTR(address, os::current_frame));
 408   if (os::is_first_C_frame(&amp;myframe)) {
 409     // stack is not walkable
 410     return frame();
 411   } else {
 412     return os::get_sender_for_C_frame(&amp;myframe);
 413   }
 414 }
 415 
 416 // Utility functions
 417 
 418 // From IA32 System Programming Guide
 419 enum {
 420   trap_page_fault = 0xE
 421 };
 422 
 423 extern &quot;C&quot; JNIEXPORT int
 424 JVM_handle_bsd_signal(int sig,
 425                         siginfo_t* info,
 426                         void* ucVoid,
 427                         int abort_if_unrecognized) {
 428   ucontext_t* uc = (ucontext_t*) ucVoid;
 429 
 430   Thread* t = Thread::current_or_null_safe();
 431 
 432   // Must do this before SignalHandlerMark, if crash protection installed we will longjmp away
 433   // (no destructors can be run)
 434   os::ThreadCrashProtection::check_crash_protection(sig, t);
 435 
 436   SignalHandlerMark shm(t);
 437 
 438   // Note: it&#39;s not uncommon that JNI code uses signal/sigset to install
 439   // then restore certain signal handler (e.g. to temporarily block SIGPIPE,
 440   // or have a SIGILL handler when detecting CPU type). When that happens,
 441   // JVM_handle_bsd_signal() might be invoked with junk info/ucVoid. To
 442   // avoid unnecessary crash when libjsig is not preloaded, try handle signals
 443   // that do not require siginfo/ucontext first.
 444 
 445   if (sig == SIGPIPE || sig == SIGXFSZ) {
 446     // allow chained handler to go first
 447     if (os::Bsd::chained_handler(sig, info, ucVoid)) {
 448       return true;
 449     } else {
 450       // Ignoring SIGPIPE/SIGXFSZ - see bugs 4229104 or 6499219
 451       return true;
 452     }
 453   }
 454 
 455   JavaThread* thread = NULL;
 456   VMThread* vmthread = NULL;
 457   if (os::Bsd::signal_handlers_are_installed) {
 458     if (t != NULL ){
 459       if(t-&gt;is_Java_thread()) {
 460         thread = (JavaThread*)t;
 461       }
 462       else if(t-&gt;is_VM_thread()){
 463         vmthread = (VMThread *)t;
 464       }
 465     }
 466   }
 467 /*
 468   NOTE: does not seem to work on bsd.
 469   if (info == NULL || info-&gt;si_code &lt;= 0 || info-&gt;si_code == SI_NOINFO) {
 470     // can&#39;t decode this kind of signal
 471     info = NULL;
 472   } else {
 473     assert(sig == info-&gt;si_signo, &quot;bad siginfo&quot;);
 474   }
 475 */
 476   // decide if this trap can be handled by a stub
 477   address stub = NULL;
 478 
 479   address pc          = NULL;
 480 
 481   //%note os_trap_1
 482   if (info != NULL &amp;&amp; uc != NULL &amp;&amp; thread != NULL) {
 483     pc = (address) os::Bsd::ucontext_get_pc(uc);
 484 
 485     if (StubRoutines::is_safefetch_fault(pc)) {
 486       os::Bsd::ucontext_set_pc(uc, StubRoutines::continuation_for_safefetch_fault(pc));
 487       return 1;
 488     }
 489 
 490     // Handle ALL stack overflow variations here
 491     if (sig == SIGSEGV || sig == SIGBUS) {
 492       address addr = (address) info-&gt;si_addr;
 493 
 494       // check if fault address is within thread stack
 495       if (thread-&gt;is_in_full_stack(addr)) {
 496         // stack overflow
 497         if (thread-&gt;in_stack_yellow_reserved_zone(addr)) {
 498           if (thread-&gt;thread_state() == _thread_in_Java) {
 499             if (thread-&gt;in_stack_reserved_zone(addr)) {
 500               frame fr;
 501               if (os::Bsd::get_frame_at_stack_banging_point(thread, uc, &amp;fr)) {
 502                 assert(fr.is_java_frame(), &quot;Must be a Java frame&quot;);
 503                 frame activation = SharedRuntime::look_for_reserved_stack_annotated_method(thread, fr);
 504                 if (activation.sp() != NULL) {
 505                   thread-&gt;disable_stack_reserved_zone();
 506                   if (activation.is_interpreted_frame()) {
 507                     thread-&gt;set_reserved_stack_activation((address)(
 508                       activation.fp() + frame::interpreter_frame_initial_sp_offset));
 509                   } else {
 510                     thread-&gt;set_reserved_stack_activation((address)activation.unextended_sp());
 511                   }
 512                   return 1;
 513                 }
 514               }
 515             }
 516             // Throw a stack overflow exception.  Guard pages will be reenabled
 517             // while unwinding the stack.
 518             thread-&gt;disable_stack_yellow_reserved_zone();
 519             stub = SharedRuntime::continuation_for_implicit_exception(thread, pc, SharedRuntime::STACK_OVERFLOW);
 520           } else {
 521             // Thread was in the vm or native code.  Return and try to finish.
 522             thread-&gt;disable_stack_yellow_reserved_zone();
 523             return 1;
 524           }
 525         } else if (thread-&gt;in_stack_red_zone(addr)) {
 526           // Fatal red zone violation.  Disable the guard pages and fall through
 527           // to handle_unexpected_exception way down below.
 528           thread-&gt;disable_stack_red_zone();
 529           tty-&gt;print_raw_cr(&quot;An irrecoverable stack overflow has occurred.&quot;);
 530         }
 531       }
 532     }
 533 
 534     if ((sig == SIGSEGV || sig == SIGBUS) &amp;&amp; VM_Version::is_cpuinfo_segv_addr(pc)) {
 535       // Verify that OS save/restore AVX registers.
 536       stub = VM_Version::cpuinfo_cont_addr();
 537     }
 538 
 539     // We test if stub is already set (by the stack overflow code
 540     // above) so it is not overwritten by the code that follows. This
 541     // check is not required on other platforms, because on other
 542     // platforms we check for SIGSEGV only or SIGBUS only, where here
 543     // we have to check for both SIGSEGV and SIGBUS.
 544     if (thread-&gt;thread_state() == _thread_in_Java &amp;&amp; stub == NULL) {
 545       // Java thread running in Java code =&gt; find exception handler if any
 546       // a fault inside compiled code, the interpreter, or a stub
 547 
 548       if ((sig == SIGSEGV || sig == SIGBUS) &amp;&amp; SafepointMechanism::is_poll_address((address)info-&gt;si_addr)) {
 549         stub = SharedRuntime::get_poll_stub(pc);
 550 #if defined(__APPLE__)
 551       // 32-bit Darwin reports a SIGBUS for nearly all memory access exceptions.
 552       // 64-bit Darwin may also use a SIGBUS (seen with compressed oops).
 553       // Catching SIGBUS here prevents the implicit SIGBUS NULL check below from
 554       // being called, so only do so if the implicit NULL check is not necessary.
 555       } else if (sig == SIGBUS &amp;&amp; !MacroAssembler::uses_implicit_null_check(info-&gt;si_addr)) {
 556 #else
 557       } else if (sig == SIGBUS /* &amp;&amp; info-&gt;si_code == BUS_OBJERR */) {
 558 #endif
 559         // BugId 4454115: A read from a MappedByteBuffer can fault
 560         // here if the underlying file has been truncated.
 561         // Do not crash the VM in such a case.
 562         CodeBlob* cb = CodeCache::find_blob_unsafe(pc);
 563         CompiledMethod* nm = (cb != NULL) ? cb-&gt;as_compiled_method_or_null() : NULL;
 564         bool is_unsafe_arraycopy = thread-&gt;doing_unsafe_access() &amp;&amp; UnsafeCopyMemory::contains_pc(pc);
 565         if ((nm != NULL &amp;&amp; nm-&gt;has_unsafe_access()) || is_unsafe_arraycopy) {
 566           address next_pc = Assembler::locate_next_instruction(pc);
 567           if (is_unsafe_arraycopy) {
 568             next_pc = UnsafeCopyMemory::page_error_continue_pc(pc);
 569           }
 570           stub = SharedRuntime::handle_unsafe_access(thread, next_pc);
 571         }
 572       }
 573       else
 574 
 575 #ifdef AMD64
 576       if (sig == SIGFPE  &amp;&amp;
 577           (info-&gt;si_code == FPE_INTDIV || info-&gt;si_code == FPE_FLTDIV)) {
 578         stub =
 579           SharedRuntime::
 580           continuation_for_implicit_exception(thread,
 581                                               pc,
 582                                               SharedRuntime::
 583                                               IMPLICIT_DIVIDE_BY_ZERO);
 584 #ifdef __APPLE__
 585       } else if (sig == SIGFPE &amp;&amp; info-&gt;si_code == FPE_NOOP) {
 586         int op = pc[0];
 587 
 588         // Skip REX
 589         if ((pc[0] &amp; 0xf0) == 0x40) {
 590           op = pc[1];
 591         } else {
 592           op = pc[0];
 593         }
 594 
 595         // Check for IDIV
 596         if (op == 0xF7) {
 597           stub = SharedRuntime::continuation_for_implicit_exception(thread, pc, SharedRuntime:: IMPLICIT_DIVIDE_BY_ZERO);
 598         } else {
 599           // TODO: handle more cases if we are using other x86 instructions
 600           //   that can generate SIGFPE signal.
 601           tty-&gt;print_cr(&quot;unknown opcode 0x%X with SIGFPE.&quot;, op);
 602           fatal(&quot;please update this code.&quot;);
 603         }
 604 #endif /* __APPLE__ */
 605 
 606 #else
 607       if (sig == SIGFPE /* &amp;&amp; info-&gt;si_code == FPE_INTDIV */) {
 608         // HACK: si_code does not work on bsd 2.2.12-20!!!
 609         int op = pc[0];
 610         if (op == 0xDB) {
 611           // FIST
 612           // TODO: The encoding of D2I in i486.ad can cause an exception
 613           // prior to the fist instruction if there was an invalid operation
 614           // pending. We want to dismiss that exception. From the win_32
 615           // side it also seems that if it really was the fist causing
 616           // the exception that we do the d2i by hand with different
 617           // rounding. Seems kind of weird.
 618           // NOTE: that we take the exception at the NEXT floating point instruction.
 619           assert(pc[0] == 0xDB, &quot;not a FIST opcode&quot;);
 620           assert(pc[1] == 0x14, &quot;not a FIST opcode&quot;);
 621           assert(pc[2] == 0x24, &quot;not a FIST opcode&quot;);
 622           return true;
 623         } else if (op == 0xF7) {
 624           // IDIV
 625           stub = SharedRuntime::continuation_for_implicit_exception(thread, pc, SharedRuntime::IMPLICIT_DIVIDE_BY_ZERO);
 626         } else {
 627           // TODO: handle more cases if we are using other x86 instructions
 628           //   that can generate SIGFPE signal on bsd.
 629           tty-&gt;print_cr(&quot;unknown opcode 0x%X with SIGFPE.&quot;, op);
 630           fatal(&quot;please update this code.&quot;);
 631         }
 632 #endif // AMD64
 633       } else if ((sig == SIGSEGV || sig == SIGBUS) &amp;&amp;
 634                  MacroAssembler::uses_implicit_null_check(info-&gt;si_addr)) {
 635           // Determination of interpreter/vtable stub/compiled code null exception
 636           stub = SharedRuntime::continuation_for_implicit_exception(thread, pc, SharedRuntime::IMPLICIT_NULL);
 637       }
 638     } else if ((thread-&gt;thread_state() == _thread_in_vm ||
 639                 thread-&gt;thread_state() == _thread_in_native) &amp;&amp;
 640                sig == SIGBUS &amp;&amp; /* info-&gt;si_code == BUS_OBJERR &amp;&amp; */
 641                thread-&gt;doing_unsafe_access()) {
 642         address next_pc = Assembler::locate_next_instruction(pc);
 643         if (UnsafeCopyMemory::contains_pc(pc)) {
 644           next_pc = UnsafeCopyMemory::page_error_continue_pc(pc);
 645         }
 646         stub = SharedRuntime::handle_unsafe_access(thread, next_pc);
 647     }
 648 
 649     // jni_fast_Get&lt;Primitive&gt;Field can trap at certain pc&#39;s if a GC kicks in
 650     // and the heap gets shrunk before the field access.
 651     if ((sig == SIGSEGV) || (sig == SIGBUS)) {
 652       address addr = JNI_FastGetField::find_slowcase_pc(pc);
 653       if (addr != (address)-1) {
 654         stub = addr;
 655       }
 656     }
 657   }
 658 
 659 #ifndef AMD64
 660   // Execution protection violation
 661   //
 662   // This should be kept as the last step in the triage.  We don&#39;t
 663   // have a dedicated trap number for a no-execute fault, so be
 664   // conservative and allow other handlers the first shot.
 665   //
 666   // Note: We don&#39;t test that info-&gt;si_code == SEGV_ACCERR here.
 667   // this si_code is so generic that it is almost meaningless; and
 668   // the si_code for this condition may change in the future.
 669   // Furthermore, a false-positive should be harmless.
 670   if (UnguardOnExecutionViolation &gt; 0 &amp;&amp;
 671       (sig == SIGSEGV || sig == SIGBUS) &amp;&amp;
 672       uc-&gt;context_trapno == trap_page_fault) {
 673     int page_size = os::vm_page_size();
 674     address addr = (address) info-&gt;si_addr;
 675     address pc = os::Bsd::ucontext_get_pc(uc);
 676     // Make sure the pc and the faulting address are sane.
 677     //
 678     // If an instruction spans a page boundary, and the page containing
 679     // the beginning of the instruction is executable but the following
 680     // page is not, the pc and the faulting address might be slightly
 681     // different - we still want to unguard the 2nd page in this case.
 682     //
 683     // 15 bytes seems to be a (very) safe value for max instruction size.
 684     bool pc_is_near_addr =
 685       (pointer_delta((void*) addr, (void*) pc, sizeof(char)) &lt; 15);
 686     bool instr_spans_page_boundary =
 687       (align_down((intptr_t) pc ^ (intptr_t) addr,
 688                        (intptr_t) page_size) &gt; 0);
 689 
 690     if (pc == addr || (pc_is_near_addr &amp;&amp; instr_spans_page_boundary)) {
 691       static volatile address last_addr =
 692         (address) os::non_memory_address_word();
 693 
 694       // In conservative mode, don&#39;t unguard unless the address is in the VM
 695       if (addr != last_addr &amp;&amp;
 696           (UnguardOnExecutionViolation &gt; 1 || os::address_is_in_vm(addr))) {
 697 
 698         // Set memory to RWX and retry
 699         address page_start = align_down(addr, page_size);
 700         bool res = os::protect_memory((char*) page_start, page_size,
 701                                       os::MEM_PROT_RWX);
 702 
 703         log_debug(os)(&quot;Execution protection violation &quot;
 704                       &quot;at &quot; INTPTR_FORMAT
 705                       &quot;, unguarding &quot; INTPTR_FORMAT &quot;: %s, errno=%d&quot;, p2i(addr),
 706                       p2i(page_start), (res ? &quot;success&quot; : &quot;failed&quot;), errno);
 707         stub = pc;
 708 
 709         // Set last_addr so if we fault again at the same address, we don&#39;t end
 710         // up in an endless loop.
 711         //
 712         // There are two potential complications here.  Two threads trapping at
 713         // the same address at the same time could cause one of the threads to
 714         // think it already unguarded, and abort the VM.  Likely very rare.
 715         //
 716         // The other race involves two threads alternately trapping at
 717         // different addresses and failing to unguard the page, resulting in
 718         // an endless loop.  This condition is probably even more unlikely than
 719         // the first.
 720         //
 721         // Although both cases could be avoided by using locks or thread local
 722         // last_addr, these solutions are unnecessary complication: this
 723         // handler is a best-effort safety net, not a complete solution.  It is
 724         // disabled by default and should only be used as a workaround in case
 725         // we missed any no-execute-unsafe VM code.
 726 
 727         last_addr = addr;
 728       }
 729     }
 730   }
 731 #endif // !AMD64
 732 
 733   if (stub != NULL) {
 734     // save all thread context in case we need to restore it
 735     if (thread != NULL) thread-&gt;set_saved_exception_pc(pc);
 736 
 737     os::Bsd::ucontext_set_pc(uc, stub);
 738     return true;
 739   }
 740 
 741   // signal-chaining
 742   if (os::Bsd::chained_handler(sig, info, ucVoid)) {
 743      return true;
 744   }
 745 
 746   if (!abort_if_unrecognized) {
 747     // caller wants another chance, so give it to him
 748     return false;
 749   }
 750 
 751   if (pc == NULL &amp;&amp; uc != NULL) {
 752     pc = os::Bsd::ucontext_get_pc(uc);
 753   }
 754 
 755   // unmask current signal
 756   sigset_t newset;
 757   sigemptyset(&amp;newset);
 758   sigaddset(&amp;newset, sig);
 759   sigprocmask(SIG_UNBLOCK, &amp;newset, NULL);
 760 
 761   VMError::report_and_die(t, sig, pc, info, ucVoid);
 762 
 763   ShouldNotReachHere();
 764   return false;
 765 }
 766 
 767 // From solaris_i486.s ported to bsd_i486.s
 768 extern &quot;C&quot; void fixcw();
 769 
 770 void os::Bsd::init_thread_fpu_state(void) {
 771 #ifndef AMD64
 772   // Set fpu to 53 bit precision. This happens too early to use a stub.
 773   fixcw();
 774 #endif // !AMD64
 775 }
 776 
 777 
 778 // Check that the bsd kernel version is 2.4 or higher since earlier
 779 // versions do not support SSE without patches.
 780 bool os::supports_sse() {
 781   return true;
 782 }
 783 
 784 bool os::is_allocatable(size_t bytes) {
 785 #ifdef AMD64
 786   // unused on amd64?
 787   return true;
 788 #else
 789 
 790   if (bytes &lt; 2 * G) {
 791     return true;
 792   }
 793 
 794   char* addr = reserve_memory(bytes, NULL);
 795 
 796   if (addr != NULL) {
 797     release_memory(addr, bytes);
 798   }
 799 
 800   return addr != NULL;
 801 #endif // AMD64
 802 }
 803 
 804 ////////////////////////////////////////////////////////////////////////////////
 805 // thread stack
 806 
 807 // Minimum usable stack sizes required to get to user code. Space for
 808 // HotSpot guard pages is added later.
 809 size_t os::Posix::_compiler_thread_min_stack_allowed = 48 * K;
 810 size_t os::Posix::_java_thread_min_stack_allowed = 48 * K;
 811 #ifdef _LP64
 812 size_t os::Posix::_vm_internal_thread_min_stack_allowed = 64 * K;
 813 #else
 814 size_t os::Posix::_vm_internal_thread_min_stack_allowed = (48 DEBUG_ONLY(+ 4)) * K;
 815 #endif // _LP64
 816 
 817 #ifndef AMD64
 818 #ifdef __GNUC__
 819 #define GET_GS() ({int gs; __asm__ volatile(&quot;movw %%gs, %w0&quot;:&quot;=q&quot;(gs)); gs&amp;0xffff;})
 820 #endif
 821 #endif // AMD64
 822 
 823 // return default stack size for thr_type
 824 size_t os::Posix::default_stack_size(os::ThreadType thr_type) {
 825   // default stack size (compiler thread needs larger stack)
 826 #ifdef AMD64
 827   size_t s = (thr_type == os::compiler_thread ? 4 * M : 1 * M);
 828 #else
 829   size_t s = (thr_type == os::compiler_thread ? 2 * M : 512 * K);
 830 #endif // AMD64
 831   return s;
 832 }
 833 
 834 
 835 // Java thread:
 836 //
 837 //   Low memory addresses
 838 //    +------------------------+
 839 //    |                        |\  Java thread created by VM does not have glibc
 840 //    |    glibc guard page    | - guard, attached Java thread usually has
 841 //    |                        |/  1 glibc guard page.
 842 // P1 +------------------------+ Thread::stack_base() - Thread::stack_size()
 843 //    |                        |\
 844 //    |  HotSpot Guard Pages   | - red, yellow and reserved pages
 845 //    |                        |/
 846 //    +------------------------+ JavaThread::stack_reserved_zone_base()
 847 //    |                        |\
 848 //    |      Normal Stack      | -
 849 //    |                        |/
 850 // P2 +------------------------+ Thread::stack_base()
 851 //
 852 // Non-Java thread:
 853 //
 854 //   Low memory addresses
 855 //    +------------------------+
 856 //    |                        |\
 857 //    |  glibc guard page      | - usually 1 page
 858 //    |                        |/
 859 // P1 +------------------------+ Thread::stack_base() - Thread::stack_size()
 860 //    |                        |\
 861 //    |      Normal Stack      | -
 862 //    |                        |/
 863 // P2 +------------------------+ Thread::stack_base()
 864 //
 865 // ** P1 (aka bottom) and size ( P2 = P1 - size) are the address and stack size returned from
 866 //    pthread_attr_getstack()
 867 
 868 static void current_stack_region(address * bottom, size_t * size) {
 869 #ifdef __APPLE__
 870   pthread_t self = pthread_self();
 871   void *stacktop = pthread_get_stackaddr_np(self);
 872   *size = pthread_get_stacksize_np(self);
 873   // workaround for OS X 10.9.0 (Mavericks)
 874   // pthread_get_stacksize_np returns 128 pages even though the actual size is 2048 pages
 875   if (pthread_main_np() == 1) {
 876     // At least on Mac OS 10.12 we have observed stack sizes not aligned
 877     // to pages boundaries. This can be provoked by e.g. setrlimit() (ulimit -s xxxx in the
 878     // shell). Apparently Mac OS actually rounds upwards to next multiple of page size,
 879     // however, we round downwards here to be on the safe side.
 880     *size = align_down(*size, getpagesize());
 881 
 882     if ((*size) &lt; (DEFAULT_MAIN_THREAD_STACK_PAGES * (size_t)getpagesize())) {
 883       char kern_osrelease[256];
 884       size_t kern_osrelease_size = sizeof(kern_osrelease);
 885       int ret = sysctlbyname(&quot;kern.osrelease&quot;, kern_osrelease, &amp;kern_osrelease_size, NULL, 0);
 886       if (ret == 0) {
 887         // get the major number, atoi will ignore the minor amd micro portions of the version string
 888         if (atoi(kern_osrelease) &gt;= OS_X_10_9_0_KERNEL_MAJOR_VERSION) {
 889           *size = (DEFAULT_MAIN_THREAD_STACK_PAGES*getpagesize());
 890         }
 891       }
 892     }
 893   }
 894   *bottom = (address) stacktop - *size;
 895 #elif defined(__OpenBSD__)
 896   stack_t ss;
 897   int rslt = pthread_stackseg_np(pthread_self(), &amp;ss);
 898 
 899   if (rslt != 0)
 900     fatal(&quot;pthread_stackseg_np failed with error = %d&quot;, rslt);
 901 
 902   *bottom = (address)((char *)ss.ss_sp - ss.ss_size);
 903   *size   = ss.ss_size;
 904 #else
 905   pthread_attr_t attr;
 906 
 907   int rslt = pthread_attr_init(&amp;attr);
 908 
 909   // JVM needs to know exact stack location, abort if it fails
 910   if (rslt != 0)
 911     fatal(&quot;pthread_attr_init failed with error = %d&quot;, rslt);
 912 
 913   rslt = pthread_attr_get_np(pthread_self(), &amp;attr);
 914 
 915   if (rslt != 0)
 916     fatal(&quot;pthread_attr_get_np failed with error = %d&quot;, rslt);
 917 
 918   if (pthread_attr_getstackaddr(&amp;attr, (void **)bottom) != 0 ||
 919     pthread_attr_getstacksize(&amp;attr, size) != 0) {
 920     fatal(&quot;Can not locate current stack attributes!&quot;);
 921   }
 922 
 923   pthread_attr_destroy(&amp;attr);
 924 #endif
 925   assert(os::current_stack_pointer() &gt;= *bottom &amp;&amp;
 926          os::current_stack_pointer() &lt; *bottom + *size, &quot;just checking&quot;);
 927 }
 928 
 929 address os::current_stack_base() {
 930   address bottom;
 931   size_t size;
 932   current_stack_region(&amp;bottom, &amp;size);
 933   return (bottom + size);
 934 }
 935 
 936 size_t os::current_stack_size() {
 937   // stack size includes normal stack and HotSpot guard pages
 938   address bottom;
 939   size_t size;
 940   current_stack_region(&amp;bottom, &amp;size);
 941   return size;
 942 }
 943 
 944 /////////////////////////////////////////////////////////////////////////////
 945 // helper functions for fatal error handler
 946 
 947 void os::print_context(outputStream *st, const void *context) {
 948   if (context == NULL) return;
 949 
 950   const ucontext_t *uc = (const ucontext_t*)context;
 951   st-&gt;print_cr(&quot;Registers:&quot;);
 952 #ifdef AMD64
 953   st-&gt;print(  &quot;RAX=&quot; INTPTR_FORMAT, (intptr_t)uc-&gt;context_rax);
 954   st-&gt;print(&quot;, RBX=&quot; INTPTR_FORMAT, (intptr_t)uc-&gt;context_rbx);
 955   st-&gt;print(&quot;, RCX=&quot; INTPTR_FORMAT, (intptr_t)uc-&gt;context_rcx);
 956   st-&gt;print(&quot;, RDX=&quot; INTPTR_FORMAT, (intptr_t)uc-&gt;context_rdx);
 957   st-&gt;cr();
 958   st-&gt;print(  &quot;RSP=&quot; INTPTR_FORMAT, (intptr_t)uc-&gt;context_rsp);
 959   st-&gt;print(&quot;, RBP=&quot; INTPTR_FORMAT, (intptr_t)uc-&gt;context_rbp);
 960   st-&gt;print(&quot;, RSI=&quot; INTPTR_FORMAT, (intptr_t)uc-&gt;context_rsi);
 961   st-&gt;print(&quot;, RDI=&quot; INTPTR_FORMAT, (intptr_t)uc-&gt;context_rdi);
 962   st-&gt;cr();
 963   st-&gt;print(  &quot;R8 =&quot; INTPTR_FORMAT, (intptr_t)uc-&gt;context_r8);
 964   st-&gt;print(&quot;, R9 =&quot; INTPTR_FORMAT, (intptr_t)uc-&gt;context_r9);
 965   st-&gt;print(&quot;, R10=&quot; INTPTR_FORMAT, (intptr_t)uc-&gt;context_r10);
 966   st-&gt;print(&quot;, R11=&quot; INTPTR_FORMAT, (intptr_t)uc-&gt;context_r11);
 967   st-&gt;cr();
 968   st-&gt;print(  &quot;R12=&quot; INTPTR_FORMAT, (intptr_t)uc-&gt;context_r12);
 969   st-&gt;print(&quot;, R13=&quot; INTPTR_FORMAT, (intptr_t)uc-&gt;context_r13);
 970   st-&gt;print(&quot;, R14=&quot; INTPTR_FORMAT, (intptr_t)uc-&gt;context_r14);
 971   st-&gt;print(&quot;, R15=&quot; INTPTR_FORMAT, (intptr_t)uc-&gt;context_r15);
 972   st-&gt;cr();
 973   st-&gt;print(  &quot;RIP=&quot; INTPTR_FORMAT, (intptr_t)uc-&gt;context_rip);
 974   st-&gt;print(&quot;, EFLAGS=&quot; INTPTR_FORMAT, (intptr_t)uc-&gt;context_flags);
 975   st-&gt;print(&quot;, ERR=&quot; INTPTR_FORMAT, (intptr_t)uc-&gt;context_err);
 976   st-&gt;cr();
 977   st-&gt;print(&quot;  TRAPNO=&quot; INTPTR_FORMAT, (intptr_t)uc-&gt;context_trapno);
 978 #else
 979   st-&gt;print(  &quot;EAX=&quot; INTPTR_FORMAT, (intptr_t)uc-&gt;context_eax);
 980   st-&gt;print(&quot;, EBX=&quot; INTPTR_FORMAT, (intptr_t)uc-&gt;context_ebx);
 981   st-&gt;print(&quot;, ECX=&quot; INTPTR_FORMAT, (intptr_t)uc-&gt;context_ecx);
 982   st-&gt;print(&quot;, EDX=&quot; INTPTR_FORMAT, (intptr_t)uc-&gt;context_edx);
 983   st-&gt;cr();
 984   st-&gt;print(  &quot;ESP=&quot; INTPTR_FORMAT, (intptr_t)uc-&gt;context_esp);
 985   st-&gt;print(&quot;, EBP=&quot; INTPTR_FORMAT, (intptr_t)uc-&gt;context_ebp);
 986   st-&gt;print(&quot;, ESI=&quot; INTPTR_FORMAT, (intptr_t)uc-&gt;context_esi);
 987   st-&gt;print(&quot;, EDI=&quot; INTPTR_FORMAT, (intptr_t)uc-&gt;context_edi);
 988   st-&gt;cr();
 989   st-&gt;print(  &quot;EIP=&quot; INTPTR_FORMAT, (intptr_t)uc-&gt;context_eip);
 990   st-&gt;print(&quot;, EFLAGS=&quot; INTPTR_FORMAT, (intptr_t)uc-&gt;context_eflags);
 991 #endif // AMD64
 992   st-&gt;cr();
 993   st-&gt;cr();
 994 
 995   intptr_t *sp = (intptr_t *)os::Bsd::ucontext_get_sp(uc);
 996   st-&gt;print_cr(&quot;Top of Stack: (sp=&quot; INTPTR_FORMAT &quot;)&quot;, (intptr_t)sp);
 997   print_hex_dump(st, (address)sp, (address)(sp + 8*sizeof(intptr_t)), sizeof(intptr_t));
 998   st-&gt;cr();
 999 
1000   // Note: it may be unsafe to inspect memory near pc. For example, pc may
1001   // point to garbage if entry point in an nmethod is corrupted. Leave
1002   // this at the end, and hope for the best.
1003   address pc = os::Bsd::ucontext_get_pc(uc);
1004   print_instructions(st, pc, sizeof(char));
1005   st-&gt;cr();
1006 }
1007 
1008 void os::print_register_info(outputStream *st, const void *context) {
1009   if (context == NULL) return;
1010 
1011   const ucontext_t *uc = (const ucontext_t*)context;
1012 
1013   st-&gt;print_cr(&quot;Register to memory mapping:&quot;);
1014   st-&gt;cr();
1015 
1016   // this is horrendously verbose but the layout of the registers in the
1017   // context does not match how we defined our abstract Register set, so
1018   // we can&#39;t just iterate through the gregs area
1019 
1020   // this is only for the &quot;general purpose&quot; registers
1021 
1022 #ifdef AMD64
1023   st-&gt;print(&quot;RAX=&quot;); print_location(st, uc-&gt;context_rax);
1024   st-&gt;print(&quot;RBX=&quot;); print_location(st, uc-&gt;context_rbx);
1025   st-&gt;print(&quot;RCX=&quot;); print_location(st, uc-&gt;context_rcx);
1026   st-&gt;print(&quot;RDX=&quot;); print_location(st, uc-&gt;context_rdx);
1027   st-&gt;print(&quot;RSP=&quot;); print_location(st, uc-&gt;context_rsp);
1028   st-&gt;print(&quot;RBP=&quot;); print_location(st, uc-&gt;context_rbp);
1029   st-&gt;print(&quot;RSI=&quot;); print_location(st, uc-&gt;context_rsi);
1030   st-&gt;print(&quot;RDI=&quot;); print_location(st, uc-&gt;context_rdi);
1031   st-&gt;print(&quot;R8 =&quot;); print_location(st, uc-&gt;context_r8);
1032   st-&gt;print(&quot;R9 =&quot;); print_location(st, uc-&gt;context_r9);
1033   st-&gt;print(&quot;R10=&quot;); print_location(st, uc-&gt;context_r10);
1034   st-&gt;print(&quot;R11=&quot;); print_location(st, uc-&gt;context_r11);
1035   st-&gt;print(&quot;R12=&quot;); print_location(st, uc-&gt;context_r12);
1036   st-&gt;print(&quot;R13=&quot;); print_location(st, uc-&gt;context_r13);
1037   st-&gt;print(&quot;R14=&quot;); print_location(st, uc-&gt;context_r14);
1038   st-&gt;print(&quot;R15=&quot;); print_location(st, uc-&gt;context_r15);
1039 #else
1040   st-&gt;print(&quot;EAX=&quot;); print_location(st, uc-&gt;context_eax);
1041   st-&gt;print(&quot;EBX=&quot;); print_location(st, uc-&gt;context_ebx);
1042   st-&gt;print(&quot;ECX=&quot;); print_location(st, uc-&gt;context_ecx);
1043   st-&gt;print(&quot;EDX=&quot;); print_location(st, uc-&gt;context_edx);
1044   st-&gt;print(&quot;ESP=&quot;); print_location(st, uc-&gt;context_esp);
1045   st-&gt;print(&quot;EBP=&quot;); print_location(st, uc-&gt;context_ebp);
1046   st-&gt;print(&quot;ESI=&quot;); print_location(st, uc-&gt;context_esi);
1047   st-&gt;print(&quot;EDI=&quot;); print_location(st, uc-&gt;context_edi);
1048 #endif // AMD64
1049 
1050   st-&gt;cr();
1051 }
1052 
1053 void os::setup_fpu() {
1054 #ifndef AMD64
1055   address fpu_cntrl = StubRoutines::addr_fpu_cntrl_wrd_std();
1056   __asm__ volatile (  &quot;fldcw (%0)&quot; :
1057                       : &quot;r&quot; (fpu_cntrl) : &quot;memory&quot;);
1058 #endif // !AMD64
1059 }
1060 
1061 #ifndef PRODUCT
1062 void os::verify_stack_alignment() {
1063 }
1064 #endif
1065 
1066 int os::extra_bang_size_in_bytes() {
1067   // JDK-8050147 requires the full cache line bang for x86.
1068   return VM_Version::L1_line_size();
1069 }
<a name="9" id="anc9"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="9" type="hidden" />
</body>
</html>