<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/hotspot/share/classfile/classLoaderData.cpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
  </head>
<body>
<center><a href="../ci/ciInstanceKlass.hpp.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="classLoaderData.hpp.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/hotspot/share/classfile/classLoaderData.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 38 // metaspace holding its klass definitions).
 39 // The System Dictionary and related data structures (e.g., placeholder table,
 40 // loader constraints table) as well as the runtime representation of classes
 41 // only reference ClassLoaderData.
 42 //
 43 // Instances of java.lang.ClassLoader holds a pointer to a ClassLoaderData that
 44 // that represent the loader&#39;s &quot;linking domain&quot; in the JVM.
 45 //
 46 // The bootstrap loader (represented by NULL) also has a ClassLoaderData,
 47 // the singleton class the_null_class_loader_data().
 48 
 49 #include &quot;precompiled.hpp&quot;
 50 #include &quot;classfile/classLoaderData.inline.hpp&quot;
 51 #include &quot;classfile/classLoaderDataGraph.inline.hpp&quot;
 52 #include &quot;classfile/dictionary.hpp&quot;
 53 #include &quot;classfile/javaClasses.hpp&quot;
 54 #include &quot;classfile/moduleEntry.hpp&quot;
 55 #include &quot;classfile/packageEntry.hpp&quot;
 56 #include &quot;classfile/symbolTable.hpp&quot;
 57 #include &quot;classfile/systemDictionary.hpp&quot;

 58 #include &quot;logging/log.hpp&quot;
 59 #include &quot;logging/logStream.hpp&quot;
 60 #include &quot;memory/allocation.inline.hpp&quot;
 61 #include &quot;memory/metadataFactory.hpp&quot;
 62 #include &quot;memory/resourceArea.hpp&quot;
 63 #include &quot;oops/access.inline.hpp&quot;
 64 #include &quot;oops/oop.inline.hpp&quot;
 65 #include &quot;oops/oopHandle.inline.hpp&quot;
 66 #include &quot;oops/weakHandle.inline.hpp&quot;
 67 #include &quot;runtime/atomic.hpp&quot;
 68 #include &quot;runtime/handles.inline.hpp&quot;
 69 #include &quot;runtime/mutex.hpp&quot;
 70 #include &quot;runtime/safepoint.hpp&quot;
 71 #include &quot;utilities/growableArray.hpp&quot;
 72 #include &quot;utilities/macros.hpp&quot;
 73 #include &quot;utilities/ostream.hpp&quot;
 74 
 75 ClassLoaderData * ClassLoaderData::_the_null_class_loader_data = NULL;
 76 
 77 void ClassLoaderData::init_null_class_loader_data() {
</pre>
<hr />
<pre>
470     } else {
471       ClassLoaderDataGraph::inc_instance_classes(1);
472     }
473   }
474 
475   if (publicize) {
476     LogTarget(Trace, class, loader, data) lt;
477     if (lt.is_enabled()) {
478       ResourceMark rm;
479       LogStream ls(lt);
480       ls.print(&quot;Adding k: &quot; PTR_FORMAT &quot; %s to &quot;, p2i(k), k-&gt;external_name());
481       print_value_on(&amp;ls);
482       ls.cr();
483     }
484   }
485 }
486 
487 void ClassLoaderData::initialize_holder(Handle loader_or_mirror) {
488   if (loader_or_mirror() != NULL) {
489     assert(_holder.is_null(), &quot;never replace holders&quot;);
<span class="line-modified">490     _holder = WeakHandle&lt;vm_weak_data&gt;::create(loader_or_mirror);</span>
491   }
492 }
493 
494 // Remove a klass from the _klasses list for scratch_class during redefinition
495 // or parsed class in the case of an error.
496 void ClassLoaderData::remove_class(Klass* scratch_class) {
497   assert_locked_or_safepoint(ClassLoaderDataGraph_lock);
498 
499   // Adjust global class iterator.
500   ClassLoaderDataGraph::adjust_saved_class(scratch_class);
501 
502   Klass* prev = NULL;
503   for (Klass* k = _klasses; k != NULL; k = k-&gt;next_link()) {
504     if (k == scratch_class) {
505       if (prev == NULL) {
506         _klasses = k-&gt;next_link();
507       } else {
508         Klass* next = k-&gt;next_link();
509         prev-&gt;set_next_link(next);
510       }
</pre>
<hr />
<pre>
637   void do_klass(Klass* k) {
638     if (k-&gt;is_array_klass()) {
639       _array_class_released ++;
640     } else {
641       assert(k-&gt;is_instance_klass(), &quot;Must be&quot;);
642       _instance_class_released ++;
643     }
644     k-&gt;release_C_heap_structures();
645   }
646 };
647 
648 ClassLoaderData::~ClassLoaderData() {
649   // Release C heap structures for all the classes.
650   ReleaseKlassClosure cl;
651   classes_do(&amp;cl);
652 
653   ClassLoaderDataGraph::dec_array_classes(cl.array_class_released());
654   ClassLoaderDataGraph::dec_instance_classes(cl.instance_class_released());
655 
656   // Release the WeakHandle
<span class="line-modified">657   _holder.release();</span>
658 
659   // Release C heap allocated hashtable for all the packages.
660   if (_packages != NULL) {
661     // Destroy the table itself
662     delete _packages;
663     _packages = NULL;
664   }
665 
666   // Release C heap allocated hashtable for all the modules.
667   if (_modules != NULL) {
668     // Destroy the table itself
669     delete _modules;
670     _modules = NULL;
671   }
672 
673   // Release C heap allocated hashtable for the dictionary
674   if (_dictionary != NULL) {
675     // Destroy the table itself
676     delete _dictionary;
677     _dictionary = NULL;
</pre>
</td>
<td>
<hr />
<pre>
 38 // metaspace holding its klass definitions).
 39 // The System Dictionary and related data structures (e.g., placeholder table,
 40 // loader constraints table) as well as the runtime representation of classes
 41 // only reference ClassLoaderData.
 42 //
 43 // Instances of java.lang.ClassLoader holds a pointer to a ClassLoaderData that
 44 // that represent the loader&#39;s &quot;linking domain&quot; in the JVM.
 45 //
 46 // The bootstrap loader (represented by NULL) also has a ClassLoaderData,
 47 // the singleton class the_null_class_loader_data().
 48 
 49 #include &quot;precompiled.hpp&quot;
 50 #include &quot;classfile/classLoaderData.inline.hpp&quot;
 51 #include &quot;classfile/classLoaderDataGraph.inline.hpp&quot;
 52 #include &quot;classfile/dictionary.hpp&quot;
 53 #include &quot;classfile/javaClasses.hpp&quot;
 54 #include &quot;classfile/moduleEntry.hpp&quot;
 55 #include &quot;classfile/packageEntry.hpp&quot;
 56 #include &quot;classfile/symbolTable.hpp&quot;
 57 #include &quot;classfile/systemDictionary.hpp&quot;
<span class="line-added"> 58 #include &quot;gc/shared/oopStorageSet.hpp&quot;</span>
 59 #include &quot;logging/log.hpp&quot;
 60 #include &quot;logging/logStream.hpp&quot;
 61 #include &quot;memory/allocation.inline.hpp&quot;
 62 #include &quot;memory/metadataFactory.hpp&quot;
 63 #include &quot;memory/resourceArea.hpp&quot;
 64 #include &quot;oops/access.inline.hpp&quot;
 65 #include &quot;oops/oop.inline.hpp&quot;
 66 #include &quot;oops/oopHandle.inline.hpp&quot;
 67 #include &quot;oops/weakHandle.inline.hpp&quot;
 68 #include &quot;runtime/atomic.hpp&quot;
 69 #include &quot;runtime/handles.inline.hpp&quot;
 70 #include &quot;runtime/mutex.hpp&quot;
 71 #include &quot;runtime/safepoint.hpp&quot;
 72 #include &quot;utilities/growableArray.hpp&quot;
 73 #include &quot;utilities/macros.hpp&quot;
 74 #include &quot;utilities/ostream.hpp&quot;
 75 
 76 ClassLoaderData * ClassLoaderData::_the_null_class_loader_data = NULL;
 77 
 78 void ClassLoaderData::init_null_class_loader_data() {
</pre>
<hr />
<pre>
471     } else {
472       ClassLoaderDataGraph::inc_instance_classes(1);
473     }
474   }
475 
476   if (publicize) {
477     LogTarget(Trace, class, loader, data) lt;
478     if (lt.is_enabled()) {
479       ResourceMark rm;
480       LogStream ls(lt);
481       ls.print(&quot;Adding k: &quot; PTR_FORMAT &quot; %s to &quot;, p2i(k), k-&gt;external_name());
482       print_value_on(&amp;ls);
483       ls.cr();
484     }
485   }
486 }
487 
488 void ClassLoaderData::initialize_holder(Handle loader_or_mirror) {
489   if (loader_or_mirror() != NULL) {
490     assert(_holder.is_null(), &quot;never replace holders&quot;);
<span class="line-modified">491     _holder = WeakHandle(OopStorageSet::vm_weak(), loader_or_mirror);</span>
492   }
493 }
494 
495 // Remove a klass from the _klasses list for scratch_class during redefinition
496 // or parsed class in the case of an error.
497 void ClassLoaderData::remove_class(Klass* scratch_class) {
498   assert_locked_or_safepoint(ClassLoaderDataGraph_lock);
499 
500   // Adjust global class iterator.
501   ClassLoaderDataGraph::adjust_saved_class(scratch_class);
502 
503   Klass* prev = NULL;
504   for (Klass* k = _klasses; k != NULL; k = k-&gt;next_link()) {
505     if (k == scratch_class) {
506       if (prev == NULL) {
507         _klasses = k-&gt;next_link();
508       } else {
509         Klass* next = k-&gt;next_link();
510         prev-&gt;set_next_link(next);
511       }
</pre>
<hr />
<pre>
638   void do_klass(Klass* k) {
639     if (k-&gt;is_array_klass()) {
640       _array_class_released ++;
641     } else {
642       assert(k-&gt;is_instance_klass(), &quot;Must be&quot;);
643       _instance_class_released ++;
644     }
645     k-&gt;release_C_heap_structures();
646   }
647 };
648 
649 ClassLoaderData::~ClassLoaderData() {
650   // Release C heap structures for all the classes.
651   ReleaseKlassClosure cl;
652   classes_do(&amp;cl);
653 
654   ClassLoaderDataGraph::dec_array_classes(cl.array_class_released());
655   ClassLoaderDataGraph::dec_instance_classes(cl.instance_class_released());
656 
657   // Release the WeakHandle
<span class="line-modified">658   _holder.release(OopStorageSet::vm_weak());</span>
659 
660   // Release C heap allocated hashtable for all the packages.
661   if (_packages != NULL) {
662     // Destroy the table itself
663     delete _packages;
664     _packages = NULL;
665   }
666 
667   // Release C heap allocated hashtable for all the modules.
668   if (_modules != NULL) {
669     // Destroy the table itself
670     delete _modules;
671     _modules = NULL;
672   }
673 
674   // Release C heap allocated hashtable for the dictionary
675   if (_dictionary != NULL) {
676     // Destroy the table itself
677     delete _dictionary;
678     _dictionary = NULL;
</pre>
</td>
</tr>
</table>
<center><a href="../ci/ciInstanceKlass.hpp.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="classLoaderData.hpp.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>