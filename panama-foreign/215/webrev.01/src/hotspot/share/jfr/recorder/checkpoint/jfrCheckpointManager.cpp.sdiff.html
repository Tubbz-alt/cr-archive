<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/hotspot/share/jfr/recorder/checkpoint/jfrCheckpointManager.cpp</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
  </head>
<body>
<center><a href="../../../interpreter/templateTable.hpp.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="types/jfrTypeSet.cpp.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/hotspot/share/jfr/recorder/checkpoint/jfrCheckpointManager.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
410       JfrCheckpointWriter writer(true, thread);
411       JfrTypeSet::serialize(&amp;writer, &amp;leakp_writer, false, false);
412       ObjectSampleCheckpoint::on_type_set(leakp_writer);
413     } else {
414       JfrCheckpointWriter writer(true, thread);
415       JfrTypeSet::serialize(&amp;writer, NULL, false, false);
416     }
417   }
418   write();
419 }
420 
421 void JfrCheckpointManager::on_unloading_classes() {
422   assert_locked_or_safepoint(ClassLoaderDataGraph_lock);
423   JfrCheckpointWriter writer(Thread::current());
424   JfrTypeSet::on_unloading_classes(&amp;writer);
425   if (LeakProfiler::is_running()) {
426     ObjectSampleCheckpoint::on_type_set_unload(writer);
427   }
428 }
429 
<span class="line-modified">430 class JavaThreadToVM : public StackObj {</span>
<span class="line-modified">431  private:</span>
<span class="line-modified">432   JavaThread* _jt;</span>
<span class="line-modified">433  public:</span>
<span class="line-modified">434   JavaThreadToVM(Thread* thread) : _jt(thread-&gt;is_Java_thread() ? (JavaThread*)thread : NULL) {</span>
<span class="line-modified">435     if (_jt != NULL) {</span>
<span class="line-modified">436       assert(_jt-&gt;thread_state() == _thread_in_native, &quot;invariant&quot;);</span>
<span class="line-removed">437       _jt-&gt;set_thread_state(_thread_in_vm);</span>
<span class="line-removed">438     }</span>
<span class="line-removed">439   }</span>
<span class="line-removed">440   ~JavaThreadToVM() {</span>
<span class="line-removed">441     if (_jt != NULL) {</span>
<span class="line-removed">442       _jt-&gt;set_thread_state(_thread_in_native);</span>
<span class="line-removed">443     }</span>
<span class="line-removed">444   }</span>
<span class="line-removed">445 };</span>
446 
447 size_t JfrCheckpointManager::flush_type_set() {
448   size_t elements = 0;
449   if (JfrTraceIdEpoch::has_changed_tag_state()) {
<span class="line-modified">450     Thread* const t = Thread::current();</span>
<span class="line-modified">451     // can safepoint here (if JavaThread)</span>
<span class="line-modified">452     JavaThreadToVM transition(t);</span>
<span class="line-modified">453     ResetNoHandleMark rnhm;</span>
<span class="line-modified">454     MutexLocker cld_lock(t, ClassLoaderDataGraph_lock);</span>
<span class="line-modified">455     MutexLocker module_lock(t, Module_lock);</span>
<span class="line-modified">456     JfrCheckpointWriter writer(t);</span>
<span class="line-modified">457     elements = JfrTypeSet::serialize(&amp;writer, NULL, false, true);</span>

458   }
459   if (is_constant_pending()) {
460     WriteOperation wo(_chunkwriter);
461     MutexedWriteOperation mwo(wo);
462     assert(_mspace-&gt;live_list_is_nonempty(), &quot;invariant&quot;);
463     process_live_list(mwo, _mspace);
464   }
465   return elements;
466 }
467 
468 void JfrCheckpointManager::create_thread_blob(Thread* thread) {
469   JfrTypeManager::create_thread_blob(thread);
470 }
471 
472 void JfrCheckpointManager::write_thread_checkpoint(Thread* thread) {
473   JfrTypeManager::write_thread_checkpoint(thread);
474 }
475 
476 class JfrNotifyClosure : public ThreadClosure {
477  public:
</pre>
</td>
<td>
<hr />
<pre>
410       JfrCheckpointWriter writer(true, thread);
411       JfrTypeSet::serialize(&amp;writer, &amp;leakp_writer, false, false);
412       ObjectSampleCheckpoint::on_type_set(leakp_writer);
413     } else {
414       JfrCheckpointWriter writer(true, thread);
415       JfrTypeSet::serialize(&amp;writer, NULL, false, false);
416     }
417   }
418   write();
419 }
420 
421 void JfrCheckpointManager::on_unloading_classes() {
422   assert_locked_or_safepoint(ClassLoaderDataGraph_lock);
423   JfrCheckpointWriter writer(Thread::current());
424   JfrTypeSet::on_unloading_classes(&amp;writer);
425   if (LeakProfiler::is_running()) {
426     ObjectSampleCheckpoint::on_type_set_unload(writer);
427   }
428 }
429 
<span class="line-modified">430 static size_t flush_type_set(Thread* thread) {</span>
<span class="line-modified">431   assert(thread != NULL, &quot;invariant&quot;);</span>
<span class="line-modified">432   JfrCheckpointWriter writer(thread);</span>
<span class="line-modified">433   MutexLocker cld_lock(thread, ClassLoaderDataGraph_lock);</span>
<span class="line-modified">434   MutexLocker module_lock(thread, Module_lock);</span>
<span class="line-modified">435   return JfrTypeSet::serialize(&amp;writer, NULL, false, true);</span>
<span class="line-modified">436 }</span>









437 
438 size_t JfrCheckpointManager::flush_type_set() {
439   size_t elements = 0;
440   if (JfrTraceIdEpoch::has_changed_tag_state()) {
<span class="line-modified">441     Thread* const thread = Thread::current();</span>
<span class="line-modified">442     if (thread-&gt;is_Java_thread()) {</span>
<span class="line-modified">443       // can safepoint here</span>
<span class="line-modified">444       ThreadInVMfromNative transition((JavaThread*)thread);</span>
<span class="line-modified">445       ResetNoHandleMark rnhm;</span>
<span class="line-modified">446       elements = ::flush_type_set(thread);</span>
<span class="line-modified">447     } else {</span>
<span class="line-modified">448       elements = ::flush_type_set(thread);</span>
<span class="line-added">449     }</span>
450   }
451   if (is_constant_pending()) {
452     WriteOperation wo(_chunkwriter);
453     MutexedWriteOperation mwo(wo);
454     assert(_mspace-&gt;live_list_is_nonempty(), &quot;invariant&quot;);
455     process_live_list(mwo, _mspace);
456   }
457   return elements;
458 }
459 
460 void JfrCheckpointManager::create_thread_blob(Thread* thread) {
461   JfrTypeManager::create_thread_blob(thread);
462 }
463 
464 void JfrCheckpointManager::write_thread_checkpoint(Thread* thread) {
465   JfrTypeManager::write_thread_checkpoint(thread);
466 }
467 
468 class JfrNotifyClosure : public ThreadClosure {
469  public:
</pre>
</td>
</tr>
</table>
<center><a href="../../../interpreter/templateTable.hpp.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="types/jfrTypeSet.cpp.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>