<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>New src/hotspot/cpu/s390/templateInterpreterGenerator_s390.cpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
  </head>
  <body>
    <pre>
   1 /*
   2  * Copyright (c) 2016, 2020, Oracle and/or its affiliates. All rights reserved.
   3  * Copyright (c) 2016, 2020 SAP SE. All rights reserved.
   4  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   5  *
   6  * This code is free software; you can redistribute it and/or modify it
   7  * under the terms of the GNU General Public License version 2 only, as
   8  * published by the Free Software Foundation.
   9  *
  10  * This code is distributed in the hope that it will be useful, but WITHOUT
  11  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  12  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  13  * version 2 for more details (a copy is included in the LICENSE file that
  14  * accompanied this code).
  15  *
  16  * You should have received a copy of the GNU General Public License version
  17  * 2 along with this work; if not, write to the Free Software Foundation,
  18  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  19  *
  20  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  21  * or visit www.oracle.com if you need additional information or have any
  22  * questions.
  23  *
  24  */
  25 
  26 #include &quot;precompiled.hpp&quot;
  27 #include &quot;asm/macroAssembler.inline.hpp&quot;
  28 #include &quot;gc/shared/barrierSetAssembler.hpp&quot;
  29 #include &quot;interpreter/abstractInterpreter.hpp&quot;
  30 #include &quot;interpreter/bytecodeHistogram.hpp&quot;
  31 #include &quot;interpreter/interpreter.hpp&quot;
  32 #include &quot;interpreter/interpreterRuntime.hpp&quot;
  33 #include &quot;interpreter/interp_masm.hpp&quot;
  34 #include &quot;interpreter/templateInterpreterGenerator.hpp&quot;
  35 #include &quot;interpreter/templateTable.hpp&quot;
  36 #include &quot;oops/arrayOop.hpp&quot;
  37 #include &quot;oops/methodData.hpp&quot;
  38 #include &quot;oops/oop.inline.hpp&quot;
  39 #include &quot;prims/jvmtiExport.hpp&quot;
  40 #include &quot;prims/jvmtiThreadState.hpp&quot;
  41 #include &quot;runtime/arguments.hpp&quot;
  42 #include &quot;runtime/deoptimization.hpp&quot;
  43 #include &quot;runtime/frame.inline.hpp&quot;
  44 #include &quot;runtime/sharedRuntime.hpp&quot;
  45 #include &quot;runtime/stubRoutines.hpp&quot;
  46 #include &quot;runtime/synchronizer.hpp&quot;
  47 #include &quot;runtime/timer.hpp&quot;
  48 #include &quot;runtime/vframeArray.hpp&quot;
  49 #include &quot;utilities/debug.hpp&quot;
  50 
  51 
  52 // Size of interpreter code.  Increase if too small.  Interpreter will
  53 // fail with a guarantee (&quot;not enough space for interpreter generation&quot;);
  54 // if too small.
  55 // Run with +PrintInterpreter to get the VM to print out the size.
  56 // Max size with JVMTI
  57 int TemplateInterpreter::InterpreterCodeSize = 320*K;
  58 
  59 #undef  __
  60 #ifdef PRODUCT
  61   #define __ _masm-&gt;
  62 #else
  63   #define __ _masm-&gt;
  64 //  #define __ (Verbose ? (_masm-&gt;block_comment(FILE_AND_LINE),_masm):_masm)-&gt;
  65 #endif
  66 
  67 #define BLOCK_COMMENT(str) __ block_comment(str)
  68 #define BIND(label)        __ bind(label); BLOCK_COMMENT(#label &quot;:&quot;)
  69 
  70 #define oop_tmp_offset     _z_ijava_state_neg(oop_tmp)
  71 
  72 //-----------------------------------------------------------------------------
  73 
  74 address TemplateInterpreterGenerator::generate_slow_signature_handler() {
  75   //
  76   // New slow_signature handler that respects the z/Architecture
  77   // C calling conventions.
  78   //
  79   // We get called by the native entry code with our output register
  80   // area == 8. First we call InterpreterRuntime::get_result_handler
  81   // to copy the pointer to the signature string temporarily to the
  82   // first C-argument and to return the result_handler in
  83   // Z_RET. Since native_entry will copy the jni-pointer to the
  84   // first C-argument slot later on, it&#39;s OK to occupy this slot
  85   // temporarily. Then we copy the argument list on the java
  86   // expression stack into native varargs format on the native stack
  87   // and load arguments into argument registers. Integer arguments in
  88   // the varargs vector will be sign-extended to 8 bytes.
  89   //
  90   // On entry:
  91   //   Z_ARG1  - intptr_t*       Address of java argument list in memory.
  92   //   Z_state - zeroInterpreter* Address of interpreter state for
  93   //                              this method
  94   //   Z_method
  95   //
  96   // On exit (just before return instruction):
  97   //   Z_RET contains the address of the result_handler.
  98   //   Z_ARG2 is not updated for static methods and contains &quot;this&quot; otherwise.
  99   //   Z_ARG3-Z_ARG5 contain the first 3 arguments of types other than float and double.
 100   //   Z_FARG1-Z_FARG4 contain the first 4 arguments of type float or double.
 101 
 102   const int LogSizeOfCase = 3;
 103 
 104   const int max_fp_register_arguments   = Argument::n_float_register_parameters;
 105   const int max_int_register_arguments  = Argument::n_register_parameters - 2;  // First 2 are reserved.
 106 
 107   const Register arg_java       = Z_tmp_2;
 108   const Register arg_c          = Z_tmp_3;
 109   const Register signature      = Z_R1_scratch; // Is a string.
 110   const Register fpcnt          = Z_R0_scratch;
 111   const Register argcnt         = Z_tmp_4;
 112   const Register intSlot        = Z_tmp_1;
 113   const Register sig_end        = Z_tmp_1; // Assumed end of signature (only used in do_object).
 114   const Register target_sp      = Z_tmp_1;
 115   const FloatRegister floatSlot = Z_F1;
 116 
 117   const int d_signature         = _z_abi(gpr6); // Only spill space, register contents not affected.
 118   const int d_fpcnt             = _z_abi(gpr7); // Only spill space, register contents not affected.
 119 
 120   unsigned int entry_offset = __ offset();
 121 
 122   BLOCK_COMMENT(&quot;slow_signature_handler {&quot;);
 123 
 124   // We use target_sp for storing arguments in the C frame.
 125   __ save_return_pc();
 126   __ push_frame_abi160(4*BytesPerWord);                 // Reserve space to save the tmp_[1..4] registers.
 127   __ z_stmg(Z_R10, Z_R13, frame::z_abi_160_size, Z_SP); // Save registers only after frame is pushed.
 128 
 129   __ z_lgr(arg_java, Z_ARG1);
 130 
 131   Register   method = Z_ARG2; // Directly load into correct argument register.
 132 
 133   __ get_method(method);
 134   __ call_VM_leaf(CAST_FROM_FN_PTR(address, InterpreterRuntime::get_signature), Z_thread, method);
 135 
 136   // Move signature to callee saved register.
 137   // Don&#39;t directly write to stack. Frame is used by VM call.
 138   __ z_lgr(Z_tmp_1, Z_RET);
 139 
 140   // Reload method. Register may have been altered by VM call.
 141   __ get_method(method);
 142 
 143   // Get address of result handler.
 144   __ call_VM_leaf(CAST_FROM_FN_PTR(address, InterpreterRuntime::get_result_handler), Z_thread, method);
 145 
 146   // Save signature address to stack.
 147   __ z_stg(Z_tmp_1, d_signature, Z_SP);
 148 
 149   // Don&#39;t overwrite return value (Z_RET, Z_ARG1) in rest of the method !
 150 
 151   {
 152     Label   isStatic;
 153 
 154     // Test if static.
 155     // We can test the bit directly.
 156     // Path is Z_method-&gt;_access_flags._flags.
 157     // We only support flag bits in the least significant byte (assert !).
 158     // Therefore add 3 to address that byte within &quot;_flags&quot;.
 159     // Reload method. VM call above may have destroyed register contents
 160     __ get_method(method);
 161     __ testbit(method2_(method, access_flags), JVM_ACC_STATIC_BIT);
 162     method = noreg;  // end of life
 163     __ z_btrue(isStatic);
 164 
 165     // For non-static functions, pass &quot;this&quot; in Z_ARG2 and copy it to 2nd C-arg slot.
 166     // Need to box the Java object here, so we use arg_java
 167     // (address of current Java stack slot) as argument and
 168     // don&#39;t dereference it as in case of ints, floats, etc..
 169     __ z_lgr(Z_ARG2, arg_java);
 170     __ add2reg(arg_java, -BytesPerWord);
 171     __ bind(isStatic);
 172   }
 173 
 174   // argcnt == 0 corresponds to 3rd C argument.
 175   //   arg #1 (result handler) and
 176   //   arg #2 (this, for non-statics), unused else
 177   // are reserved and pre-filled above.
 178   // arg_java points to the corresponding Java argument here. It
 179   // has been decremented by one argument (this) in case of non-static.
 180   __ clear_reg(argcnt, true, false);  // Don&#39;t set CC.
 181   __ z_lg(target_sp, 0, Z_SP);
 182   __ add2reg(arg_c, _z_abi(remaining_cargs), target_sp);
 183   // No floating-point args parsed so far.
 184   __ clear_mem(Address(Z_SP, d_fpcnt), 8);
 185 
 186   NearLabel   move_intSlot_to_ARG, move_floatSlot_to_FARG;
 187   NearLabel   loop_start, loop_start_restore, loop_end;
 188   NearLabel   do_int, do_long, do_float, do_double;
 189   NearLabel   do_dontreachhere, do_object, do_array, do_boxed;
 190 
 191 #ifdef ASSERT
 192   // Signature needs to point to &#39;(&#39; (== 0x28) at entry.
 193   __ z_lg(signature, d_signature, Z_SP);
 194   __ z_cli(0, signature, (int) &#39;(&#39;);
 195   __ z_brne(do_dontreachhere);
 196 #endif
 197 
 198   __ bind(loop_start_restore);
 199   __ z_lg(signature, d_signature, Z_SP);  // Restore signature ptr, destroyed by move_XX_to_ARG.
 200 
 201   BIND(loop_start);
 202   // Advance to next argument type token from the signature.
 203   __ add2reg(signature, 1);
 204 
 205   // Use CLI, works well on all CPU versions.
 206     __ z_cli(0, signature, (int) &#39;)&#39;);
 207     __ z_bre(loop_end);                // end of signature
 208     __ z_cli(0, signature, (int) &#39;L&#39;);
 209     __ z_bre(do_object);               // object     #9
 210     __ z_cli(0, signature, (int) &#39;F&#39;);
 211     __ z_bre(do_float);                // float      #7
 212     __ z_cli(0, signature, (int) &#39;J&#39;);
 213     __ z_bre(do_long);                 // long       #6
 214     __ z_cli(0, signature, (int) &#39;B&#39;);
 215     __ z_bre(do_int);                  // byte       #1
 216     __ z_cli(0, signature, (int) &#39;Z&#39;);
 217     __ z_bre(do_int);                  // boolean    #2
 218     __ z_cli(0, signature, (int) &#39;C&#39;);
 219     __ z_bre(do_int);                  // char       #3
 220     __ z_cli(0, signature, (int) &#39;S&#39;);
 221     __ z_bre(do_int);                  // short      #4
 222     __ z_cli(0, signature, (int) &#39;I&#39;);
 223     __ z_bre(do_int);                  // int        #5
 224     __ z_cli(0, signature, (int) &#39;D&#39;);
 225     __ z_bre(do_double);               // double     #8
 226     __ z_cli(0, signature, (int) &#39;[&#39;);
 227     __ z_bre(do_array);                // array      #10
 228 
 229   __ bind(do_dontreachhere);
 230 
 231   __ unimplemented(&quot;ShouldNotReachHere in slow_signature_handler&quot;, 120);
 232 
 233   // Array argument
 234   BIND(do_array);
 235 
 236   {
 237     Label   start_skip, end_skip;
 238 
 239     __ bind(start_skip);
 240 
 241     // Advance to next type tag from signature.
 242     __ add2reg(signature, 1);
 243 
 244     // Use CLI, works well on all CPU versions.
 245     __ z_cli(0, signature, (int) &#39;[&#39;);
 246     __ z_bre(start_skip);               // Skip further brackets.
 247 
 248     __ z_cli(0, signature, (int) &#39;9&#39;);
 249     __ z_brh(end_skip);                 // no optional size
 250 
 251     __ z_cli(0, signature, (int) &#39;0&#39;);
 252     __ z_brnl(start_skip);              // Skip optional size.
 253 
 254     __ bind(end_skip);
 255 
 256     __ z_cli(0, signature, (int) &#39;L&#39;);
 257     __ z_brne(do_boxed);                // If not array of objects: go directly to do_boxed.
 258   }
 259 
 260   //  OOP argument
 261   BIND(do_object);
 262   // Pass by an object&#39;s type name.
 263   {
 264     Label   L;
 265 
 266     __ add2reg(sig_end, 4095, signature);     // Assume object type name is shorter than 4k.
 267     __ load_const_optimized(Z_R0, (int) &#39;;&#39;); // Type name terminator (must be in Z_R0!).
 268     __ MacroAssembler::search_string(sig_end, signature);
 269     __ z_brl(L);
 270     __ z_illtrap();  // No semicolon found: internal error or object name too long.
 271     __ bind(L);
 272     __ z_lgr(signature, sig_end);
 273     // fallthru to do_boxed
 274   }
 275 
 276   // Need to box the Java object here, so we use arg_java
 277   // (address of current Java stack slot) as argument and
 278   // don&#39;t dereference it as in case of ints, floats, etc..
 279 
 280   // UNBOX argument
 281   // Load reference and check for NULL.
 282   Label  do_int_Entry4Boxed;
 283   __ bind(do_boxed);
 284   {
 285     __ load_and_test_long(intSlot, Address(arg_java));
 286     __ z_bre(do_int_Entry4Boxed);
 287     __ z_lgr(intSlot, arg_java);
 288     __ z_bru(do_int_Entry4Boxed);
 289   }
 290 
 291   // INT argument
 292 
 293   // (also for byte, boolean, char, short)
 294   // Use lgf for load (sign-extend) and stg for store.
 295   BIND(do_int);
 296   __ z_lgf(intSlot, 0, arg_java);
 297 
 298   __ bind(do_int_Entry4Boxed);
 299   __ add2reg(arg_java, -BytesPerWord);
 300   // If argument fits into argument register, go and handle it, otherwise continue.
 301   __ compare32_and_branch(argcnt, max_int_register_arguments,
 302                           Assembler::bcondLow, move_intSlot_to_ARG);
 303   __ z_stg(intSlot, 0, arg_c);
 304   __ add2reg(arg_c, BytesPerWord);
 305   __ z_bru(loop_start);
 306 
 307   // LONG argument
 308 
 309   BIND(do_long);
 310   __ add2reg(arg_java, -2*BytesPerWord);  // Decrement first to have positive displacement for lg.
 311   __ z_lg(intSlot, BytesPerWord, arg_java);
 312   // If argument fits into argument register, go and handle it, otherwise continue.
 313   __ compare32_and_branch(argcnt, max_int_register_arguments,
 314                           Assembler::bcondLow, move_intSlot_to_ARG);
 315   __ z_stg(intSlot, 0, arg_c);
 316   __ add2reg(arg_c, BytesPerWord);
 317   __ z_bru(loop_start);
 318 
 319   // FLOAT argumen
 320 
 321   BIND(do_float);
 322   __ z_le(floatSlot, 0, arg_java);
 323   __ add2reg(arg_java, -BytesPerWord);
 324   assert(max_fp_register_arguments &lt;= 255, &quot;always true&quot;);  // safety net
 325   __ z_cli(d_fpcnt+7, Z_SP, max_fp_register_arguments);
 326   __ z_brl(move_floatSlot_to_FARG);
 327   __ z_ste(floatSlot, 4, arg_c);
 328   __ add2reg(arg_c, BytesPerWord);
 329   __ z_bru(loop_start);
 330 
 331   // DOUBLE argument
 332 
 333   BIND(do_double);
 334   __ add2reg(arg_java, -2*BytesPerWord);  // Decrement first to have positive displacement for lg.
 335   __ z_ld(floatSlot, BytesPerWord, arg_java);
 336   assert(max_fp_register_arguments &lt;= 255, &quot;always true&quot;);  // safety net
 337   __ z_cli(d_fpcnt+7, Z_SP, max_fp_register_arguments);
 338   __ z_brl(move_floatSlot_to_FARG);
 339   __ z_std(floatSlot, 0, arg_c);
 340   __ add2reg(arg_c, BytesPerWord);
 341   __ z_bru(loop_start);
 342 
 343   // Method exit, all arguments proocessed.
 344   __ bind(loop_end);
 345   __ z_lmg(Z_R10, Z_R13, frame::z_abi_160_size, Z_SP); // restore registers before frame is popped.
 346   __ pop_frame();
 347   __ restore_return_pc();
 348   __ z_br(Z_R14);
 349 
 350   // Copy int arguments.
 351 
 352   Label  iarg_caselist;   // Distance between each case has to be a power of 2
 353                           // (= 1 &lt;&lt; LogSizeOfCase).
 354   __ align(16);
 355   BIND(iarg_caselist);
 356   __ z_lgr(Z_ARG3, intSlot);    // 4 bytes
 357   __ z_bru(loop_start_restore); // 4 bytes
 358 
 359   __ z_lgr(Z_ARG4, intSlot);
 360   __ z_bru(loop_start_restore);
 361 
 362   __ z_lgr(Z_ARG5, intSlot);
 363   __ z_bru(loop_start_restore);
 364 
 365   __ align(16);
 366   __ bind(move_intSlot_to_ARG);
 367   __ z_stg(signature, d_signature, Z_SP);       // Spill since signature == Z_R1_scratch.
 368   __ z_larl(Z_R1_scratch, iarg_caselist);
 369   __ z_sllg(Z_R0_scratch, argcnt, LogSizeOfCase);
 370   __ add2reg(argcnt, 1);
 371   __ z_agr(Z_R1_scratch, Z_R0_scratch);
 372   __ z_bcr(Assembler::bcondAlways, Z_R1_scratch);
 373 
 374   // Copy float arguments.
 375 
 376   Label  farg_caselist;   // Distance between each case has to be a power of 2
 377                           // (= 1 &lt;&lt; logSizeOfCase, padded with nop.
 378   __ align(16);
 379   BIND(farg_caselist);
 380   __ z_ldr(Z_FARG1, floatSlot); // 2 bytes
 381   __ z_bru(loop_start_restore); // 4 bytes
 382   __ z_nop();                   // 2 bytes
 383 
 384   __ z_ldr(Z_FARG2, floatSlot);
 385   __ z_bru(loop_start_restore);
 386   __ z_nop();
 387 
 388   __ z_ldr(Z_FARG3, floatSlot);
 389   __ z_bru(loop_start_restore);
 390   __ z_nop();
 391 
 392   __ z_ldr(Z_FARG4, floatSlot);
 393   __ z_bru(loop_start_restore);
 394   __ z_nop();
 395 
 396   __ align(16);
 397   __ bind(move_floatSlot_to_FARG);
 398   __ z_stg(signature, d_signature, Z_SP);        // Spill since signature == Z_R1_scratch.
 399   __ z_lg(Z_R0_scratch, d_fpcnt, Z_SP);          // Need old value for indexing.
 400   __ add2mem_64(Address(Z_SP, d_fpcnt), 1, Z_R1_scratch); // Increment index.
 401   __ z_larl(Z_R1_scratch, farg_caselist);
 402   __ z_sllg(Z_R0_scratch, Z_R0_scratch, LogSizeOfCase);
 403   __ z_agr(Z_R1_scratch, Z_R0_scratch);
 404   __ z_bcr(Assembler::bcondAlways, Z_R1_scratch);
 405 
 406   BLOCK_COMMENT(&quot;} slow_signature_handler&quot;);
 407 
 408   return __ addr_at(entry_offset);
 409 }
 410 
 411 address TemplateInterpreterGenerator::generate_result_handler_for (BasicType type) {
 412   address entry = __ pc();
 413 
 414   assert(Z_tos == Z_RET, &quot;Result handler: must move result!&quot;);
 415   assert(Z_ftos == Z_FRET, &quot;Result handler: must move float result!&quot;);
 416 
 417   switch (type) {
 418     case T_BOOLEAN:
 419       __ c2bool(Z_tos);
 420       break;
 421     case T_CHAR:
 422       __ and_imm(Z_tos, 0xffff);
 423       break;
 424     case T_BYTE:
 425       __ z_lbr(Z_tos, Z_tos);
 426       break;
 427     case T_SHORT:
 428       __ z_lhr(Z_tos, Z_tos);
 429       break;
 430     case T_INT:
 431     case T_LONG:
 432     case T_VOID:
 433     case T_FLOAT:
 434     case T_DOUBLE:
 435       break;
 436     case T_OBJECT:
 437       // Retrieve result from frame...
 438       __ mem2reg_opt(Z_tos, Address(Z_fp, oop_tmp_offset));
 439       // and verify it.
 440       __ verify_oop(Z_tos);
 441       break;
 442     default:
 443       ShouldNotReachHere();
 444   }
 445   __ z_br(Z_R14);      // Return from result handler.
 446   return entry;
 447 }
 448 
 449 // Abstract method entry.
 450 // Attempt to execute abstract method. Throw exception.
 451 address TemplateInterpreterGenerator::generate_abstract_entry(void) {
 452   unsigned int entry_offset = __ offset();
 453 
 454   // Caller could be the call_stub or a compiled method (x86 version is wrong!).
 455 
 456   BLOCK_COMMENT(&quot;abstract_entry {&quot;);
 457 
 458   // Implement call of InterpreterRuntime::throw_AbstractMethodError.
 459   __ set_top_ijava_frame_at_SP_as_last_Java_frame(Z_SP, Z_R1);
 460   __ save_return_pc();       // Save Z_R14.
 461   __ push_frame_abi160(0);   // Without new frame the RT call could overwrite the saved Z_R14.
 462 
 463   __ call_VM_leaf(CAST_FROM_FN_PTR(address, InterpreterRuntime::throw_AbstractMethodErrorWithMethod),
 464                   Z_thread, Z_method);
 465 
 466   __ pop_frame();
 467   __ restore_return_pc();    // Restore Z_R14.
 468   __ reset_last_Java_frame();
 469 
 470   // Restore caller sp for c2i case.
 471   __ resize_frame_absolute(Z_R10, Z_R0, true); // Cut the stack back to where the caller started.
 472 
 473   // branch to SharedRuntime::generate_forward_exception() which handles all possible callers,
 474   // i.e. call stub, compiled method, interpreted method.
 475   __ load_absolute_address(Z_tmp_1, StubRoutines::forward_exception_entry());
 476   __ z_br(Z_tmp_1);
 477 
 478   BLOCK_COMMENT(&quot;} abstract_entry&quot;);
 479 
 480   return __ addr_at(entry_offset);
 481 }
 482 
 483 address TemplateInterpreterGenerator::generate_Reference_get_entry(void) {
 484   // Inputs:
 485   //  Z_ARG1 - receiver
 486   //
 487   // What we do:
 488   //  - Load the referent field address.
 489   //  - Load the value in the referent field.
 490   //  - Pass that value to the pre-barrier.
 491   //
 492   // In the case of G1 this will record the value of the
 493   // referent in an SATB buffer if marking is active.
 494   // This will cause concurrent marking to mark the referent
 495   // field as live.
 496 
 497   Register  scratch1 = Z_tmp_2;
 498   Register  scratch2 = Z_tmp_3;
 499   Register  pre_val  = Z_RET;   // return value
 500   // Z_esp is callers operand stack pointer, i.e. it points to the parameters.
 501   Register  Rargp    = Z_esp;
 502 
 503   Label     slow_path;
 504   address   entry = __ pc();
 505 
 506   const int referent_offset = java_lang_ref_Reference::referent_offset();
 507 
 508   BLOCK_COMMENT(&quot;Reference_get {&quot;);
 509 
 510   //  If the receiver is null then it is OK to jump to the slow path.
 511   __ load_and_test_long(pre_val, Address(Rargp, Interpreter::stackElementSize)); // Get receiver.
 512   __ z_bre(slow_path);
 513 
 514   //  Load the value of the referent field.
 515   __ load_heap_oop(pre_val, Address(pre_val, referent_offset), scratch1, scratch2, ON_WEAK_OOP_REF);
 516 
 517   // Restore caller sp for c2i case.
 518   __ resize_frame_absolute(Z_R10, Z_R0, true); // Cut the stack back to where the caller started.
 519   __ z_br(Z_R14);
 520 
 521   // Branch to previously generated regular method entry.
 522   __ bind(slow_path);
 523 
 524   address meth_entry = Interpreter::entry_for_kind(Interpreter::zerolocals);
 525   __ jump_to_entry(meth_entry, Z_R1);
 526 
 527   BLOCK_COMMENT(&quot;} Reference_get&quot;);
 528 
 529   return entry;
 530 }
 531 
 532 address TemplateInterpreterGenerator::generate_StackOverflowError_handler() {
 533   address entry = __ pc();
 534 
 535   DEBUG_ONLY(__ verify_esp(Z_esp, Z_ARG5));
 536 
 537   // Restore bcp under the assumption that the current frame is still
 538   // interpreted.
 539   __ restore_bcp();
 540 
 541   // Expression stack must be empty before entering the VM if an
 542   // exception happened.
 543   __ empty_expression_stack();
 544   // Throw exception.
 545   __ call_VM(noreg,
 546              CAST_FROM_FN_PTR(address, InterpreterRuntime::throw_StackOverflowError));
 547   return entry;
 548 }
 549 
 550 //
 551 // Args:
 552 //   Z_ARG2: oop of array
 553 //   Z_ARG3: aberrant index
 554 //
 555 address TemplateInterpreterGenerator::generate_ArrayIndexOutOfBounds_handler() {
 556   address entry = __ pc();
 557   address excp = CAST_FROM_FN_PTR(address, InterpreterRuntime::throw_ArrayIndexOutOfBoundsException);
 558 
 559   // Expression stack must be empty before entering the VM if an
 560   // exception happened.
 561   __ empty_expression_stack();
 562 
 563   // Setup parameters.
 564   // Pass register with array to create more detailed exceptions.
 565   __ call_VM(noreg, excp, Z_ARG2, Z_ARG3);
 566   return entry;
 567 }
 568 
 569 address TemplateInterpreterGenerator::generate_ClassCastException_handler() {
 570   address entry = __ pc();
 571 
 572   // Object is at TOS.
 573   __ pop_ptr(Z_ARG2);
 574 
 575   // Expression stack must be empty before entering the VM if an
 576   // exception happened.
 577   __ empty_expression_stack();
 578 
 579   __ call_VM(Z_ARG1,
 580              CAST_FROM_FN_PTR(address, InterpreterRuntime::throw_ClassCastException),
 581              Z_ARG2);
 582 
 583   DEBUG_ONLY(__ should_not_reach_here();)
 584 
 585   return entry;
 586 }
 587 
 588 address TemplateInterpreterGenerator::generate_exception_handler_common(const char* name, const char* message, bool pass_oop) {
 589   assert(!pass_oop || message == NULL, &quot;either oop or message but not both&quot;);
 590   address entry = __ pc();
 591 
 592   BLOCK_COMMENT(&quot;exception_handler_common {&quot;);
 593 
 594   // Expression stack must be empty before entering the VM if an
 595   // exception happened.
 596   __ empty_expression_stack();
 597   if (name != NULL) {
 598     __ load_absolute_address(Z_ARG2, (address)name);
 599   } else {
 600     __ clear_reg(Z_ARG2, true, false);
 601   }
 602 
 603   if (pass_oop) {
 604     __ call_VM(Z_tos,
 605                CAST_FROM_FN_PTR(address, InterpreterRuntime::create_klass_exception),
 606                Z_ARG2, Z_tos /*object (see TT::aastore())*/);
 607   } else {
 608     if (message != NULL) {
 609       __ load_absolute_address(Z_ARG3, (address)message);
 610     } else {
 611       __ clear_reg(Z_ARG3, true, false);
 612     }
 613     __ call_VM(Z_tos,
 614                CAST_FROM_FN_PTR(address, InterpreterRuntime::create_exception),
 615                Z_ARG2, Z_ARG3);
 616   }
 617   // Throw exception.
 618   __ load_absolute_address(Z_R1_scratch, Interpreter::throw_exception_entry());
 619   __ z_br(Z_R1_scratch);
 620 
 621   BLOCK_COMMENT(&quot;} exception_handler_common&quot;);
 622 
 623   return entry;
 624 }
 625 
 626 address TemplateInterpreterGenerator::generate_return_entry_for (TosState state, int step, size_t index_size) {
 627   address entry = __ pc();
 628 
 629   BLOCK_COMMENT(&quot;return_entry {&quot;);
 630 
 631   // Pop i2c extension or revert top-2-parent-resize done by interpreted callees.
 632   Register sp_before_i2c_extension = Z_bcp;
 633   __ z_lg(Z_fp, _z_abi(callers_sp), Z_SP); // Restore frame pointer.
 634   __ z_lg(sp_before_i2c_extension, Address(Z_fp, _z_ijava_state_neg(top_frame_sp)));
 635   __ resize_frame_absolute(sp_before_i2c_extension, Z_locals/*tmp*/, true/*load_fp*/);
 636 
 637   // TODO(ZASM): necessary??
 638   //  // and NULL it as marker that esp is now tos until next java call
 639   //  __ movptr(Address(rbp, frame::interpreter_frame_last_sp_offset * wordSize), (int32_t)NULL_WORD);
 640 
 641   __ restore_bcp();
 642   __ restore_locals();
 643   __ restore_esp();
 644 
 645   if (state == atos) {
 646     __ profile_return_type(Z_tmp_1, Z_tos, Z_tmp_2);
 647   }
 648 
 649   Register cache  = Z_tmp_1;
 650   Register size   = Z_tmp_1;
 651   Register offset = Z_tmp_2;
 652   const int flags_offset = in_bytes(ConstantPoolCache::base_offset() +
 653                                     ConstantPoolCacheEntry::flags_offset());
 654   __ get_cache_and_index_at_bcp(cache, offset, 1, index_size);
 655 
 656   // #args is in rightmost byte of the _flags field.
 657   __ z_llgc(size, Address(cache, offset, flags_offset+(sizeof(size_t)-1)));
 658   __ z_sllg(size, size, Interpreter::logStackElementSize); // Each argument size in bytes.
 659   __ z_agr(Z_esp, size);                                   // Pop arguments.
 660 
 661   __ check_and_handle_popframe(Z_thread);
 662   __ check_and_handle_earlyret(Z_thread);
 663 
 664   __ dispatch_next(state, step);
 665 
 666   BLOCK_COMMENT(&quot;} return_entry&quot;);
 667 
 668   return entry;
 669 }
 670 
 671 address TemplateInterpreterGenerator::generate_deopt_entry_for(TosState state,
 672                                                                int step,
 673                                                                address continuation) {
 674   address entry = __ pc();
 675 
 676   BLOCK_COMMENT(&quot;deopt_entry {&quot;);
 677 
 678   // TODO(ZASM): necessary? NULL last_sp until next java call
 679   // __ movptr(Address(rbp, frame::interpreter_frame_last_sp_offset * wordSize), (int32_t)NULL_WORD);
 680   __ z_lg(Z_fp, _z_abi(callers_sp), Z_SP); // Restore frame pointer.
 681   __ restore_bcp();
 682   __ restore_locals();
 683   __ restore_esp();
 684 
 685   // Handle exceptions.
 686   {
 687     Label L;
 688     __ load_and_test_long(Z_R0/*pending_exception*/, thread_(pending_exception));
 689     __ z_bre(L);
 690     __ call_VM(noreg,
 691                CAST_FROM_FN_PTR(address,
 692                                 InterpreterRuntime::throw_pending_exception));
 693     __ should_not_reach_here();
 694     __ bind(L);
 695   }
 696   if (continuation == NULL) {
 697     __ dispatch_next(state, step);
 698   } else {
 699     __ jump_to_entry(continuation, Z_R1_scratch);
 700   }
 701 
 702   BLOCK_COMMENT(&quot;} deopt_entry&quot;);
 703 
 704   return entry;
 705 }
 706 
 707 address TemplateInterpreterGenerator::generate_safept_entry_for (TosState state,
 708                                                                 address runtime_entry) {
 709   address entry = __ pc();
 710   __ push(state);
 711   __ call_VM(noreg, runtime_entry);
 712   __ dispatch_via(vtos, Interpreter::_normal_table.table_for (vtos));
 713   return entry;
 714 }
 715 
 716 //
 717 // Helpers for commoning out cases in the various type of method entries.
 718 //
 719 
 720 // Increment invocation count &amp; check for overflow.
 721 //
 722 // Note: checking for negative value instead of overflow
 723 // so we have a &#39;sticky&#39; overflow test.
 724 //
 725 // Z_ARG2: method (see generate_fixed_frame())
 726 //
 727 void TemplateInterpreterGenerator::generate_counter_incr(Label* overflow, Label* profile_method, Label* profile_method_continue) {
 728   Label done;
 729   Register method = Z_ARG2; // Generate_fixed_frame() copies Z_method into Z_ARG2.
 730   Register m_counters = Z_ARG4;
 731 
 732   BLOCK_COMMENT(&quot;counter_incr {&quot;);
 733 
 734   // Note: In tiered we increment either counters in method or in MDO depending
 735   // if we are profiling or not.
 736   if (TieredCompilation) {
 737     int increment = InvocationCounter::count_increment;
 738     if (ProfileInterpreter) {
 739       NearLabel no_mdo;
 740       Register mdo = m_counters;
 741       // Are we profiling?
 742       __ load_and_test_long(mdo, method2_(method, method_data));
 743       __ branch_optimized(Assembler::bcondZero, no_mdo);
 744       // Increment counter in the MDO.
 745       const Address mdo_invocation_counter(mdo, MethodData::invocation_counter_offset() +
 746                                            InvocationCounter::counter_offset());
 747       const Address mask(mdo, MethodData::invoke_mask_offset());
 748       __ increment_mask_and_jump(mdo_invocation_counter, increment, mask,
 749                                  Z_R1_scratch, false, Assembler::bcondZero,
 750                                  overflow);
 751       __ z_bru(done);
 752       __ bind(no_mdo);
 753     }
 754 
 755     // Increment counter in MethodCounters.
 756     const Address invocation_counter(m_counters,
 757                                      MethodCounters::invocation_counter_offset() +
 758                                      InvocationCounter::counter_offset());
 759     // Get address of MethodCounters object.
 760     __ get_method_counters(method, m_counters, done);
 761     const Address mask(m_counters, MethodCounters::invoke_mask_offset());
 762     __ increment_mask_and_jump(invocation_counter,
 763                                increment, mask,
 764                                Z_R1_scratch, false, Assembler::bcondZero,
 765                                overflow);
 766   } else {
 767     Register counter_sum = Z_ARG3; // The result of this piece of code.
 768     Register tmp         = Z_R1_scratch;
 769 #ifdef ASSERT
 770     {
 771       NearLabel ok;
 772       __ get_method(tmp);
 773       __ compare64_and_branch(method, tmp, Assembler::bcondEqual, ok);
 774       __ z_illtrap(0x66);
 775       __ bind(ok);
 776     }
 777 #endif
 778 
 779     // Get address of MethodCounters object.
 780     __ get_method_counters(method, m_counters, done);
 781     // Update standard invocation counters.
 782     __ increment_invocation_counter(m_counters, counter_sum);
 783     if (ProfileInterpreter) {
 784       __ add2mem_32(Address(m_counters, MethodCounters::interpreter_invocation_counter_offset()), 1, tmp);
 785       if (profile_method != NULL) {
 786         const Address profile_limit(m_counters, MethodCounters::interpreter_profile_limit_offset());
 787         __ z_cl(counter_sum, profile_limit);
 788         __ branch_optimized(Assembler::bcondLow, *profile_method_continue);
 789         // If no method data exists, go to profile_method.
 790         __ test_method_data_pointer(tmp, *profile_method);
 791       }
 792     }
 793 
 794     const Address invocation_limit(m_counters, MethodCounters::interpreter_invocation_limit_offset());
 795     __ z_cl(counter_sum, invocation_limit);
 796     __ branch_optimized(Assembler::bcondNotLow, *overflow);
 797   }
 798 
 799   __ bind(done);
 800 
 801   BLOCK_COMMENT(&quot;} counter_incr&quot;);
 802 }
 803 
 804 void TemplateInterpreterGenerator::generate_counter_overflow(Label&amp; do_continue) {
 805   // InterpreterRuntime::frequency_counter_overflow takes two
 806   // arguments, the first (thread) is passed by call_VM, the second
 807   // indicates if the counter overflow occurs at a backwards branch
 808   // (NULL bcp). We pass zero for it. The call returns the address
 809   // of the verified entry point for the method or NULL if the
 810   // compilation did not complete (either went background or bailed
 811   // out).
 812   __ clear_reg(Z_ARG2);
 813   __ call_VM(noreg,
 814              CAST_FROM_FN_PTR(address, InterpreterRuntime::frequency_counter_overflow),
 815              Z_ARG2);
 816   __ z_bru(do_continue);
 817 }
 818 
 819 void TemplateInterpreterGenerator::generate_stack_overflow_check(Register frame_size, Register tmp1) {
 820   Register tmp2 = Z_R1_scratch;
 821   const int page_size = os::vm_page_size();
 822   NearLabel after_frame_check;
 823 
 824   BLOCK_COMMENT(&quot;stack_overflow_check {&quot;);
 825 
 826   assert_different_registers(frame_size, tmp1);
 827 
 828   // Stack banging is sufficient overflow check if frame_size &lt; page_size.
 829   if (Immediate::is_uimm(page_size, 15)) {
 830     __ z_chi(frame_size, page_size);
 831     __ z_brl(after_frame_check);
 832   } else {
 833     __ load_const_optimized(tmp1, page_size);
 834     __ compareU32_and_branch(frame_size, tmp1, Assembler::bcondLow, after_frame_check);
 835   }
 836 
 837   // Get the stack base, and in debug, verify it is non-zero.
 838   __ z_lg(tmp1, thread_(stack_base));
 839 #ifdef ASSERT
 840   address reentry = NULL;
 841   NearLabel base_not_zero;
 842   __ compareU64_and_branch(tmp1, (intptr_t)0L, Assembler::bcondNotEqual, base_not_zero);
 843   reentry = __ stop_chain_static(reentry, &quot;stack base is zero in generate_stack_overflow_check&quot;);
 844   __ bind(base_not_zero);
 845 #endif
 846 
 847   // Get the stack size, and in debug, verify it is non-zero.
 848   assert(sizeof(size_t) == sizeof(intptr_t), &quot;wrong load size&quot;);
 849   __ z_lg(tmp2, thread_(stack_size));
 850 #ifdef ASSERT
 851   NearLabel size_not_zero;
 852   __ compareU64_and_branch(tmp2, (intptr_t)0L, Assembler::bcondNotEqual, size_not_zero);
 853   reentry = __ stop_chain_static(reentry, &quot;stack size is zero in generate_stack_overflow_check&quot;);
 854   __ bind(size_not_zero);
 855 #endif
 856 
 857   // Compute the beginning of the protected zone minus the requested frame size.
 858   __ z_sgr(tmp1, tmp2);
 859   __ add2reg(tmp1, JavaThread::stack_guard_zone_size());
 860 
 861   // Add in the size of the frame (which is the same as subtracting it from the
 862   // SP, which would take another register.
 863   __ z_agr(tmp1, frame_size);
 864 
 865   // The frame is greater than one page in size, so check against
 866   // the bottom of the stack.
 867   __ compareU64_and_branch(Z_SP, tmp1, Assembler::bcondHigh, after_frame_check);
 868 
 869   // The stack will overflow, throw an exception.
 870 
 871   // Restore SP to sender&#39;s sp. This is necessary if the sender&#39;s frame is an
 872   // extended compiled frame (see gen_c2i_adapter()) and safer anyway in case of
 873   // JSR292 adaptations.
 874   __ resize_frame_absolute(Z_R10, tmp1, true/*load_fp*/);
 875 
 876   // Note also that the restored frame is not necessarily interpreted.
 877   // Use the shared runtime version of the StackOverflowError.
 878   assert(StubRoutines::throw_StackOverflowError_entry() != NULL, &quot;stub not yet generated&quot;);
 879   AddressLiteral stub(StubRoutines::throw_StackOverflowError_entry());
 880   __ load_absolute_address(tmp1, StubRoutines::throw_StackOverflowError_entry());
 881   __ z_br(tmp1);
 882 
 883   // If you get to here, then there is enough stack space.
 884   __ bind(after_frame_check);
 885 
 886   BLOCK_COMMENT(&quot;} stack_overflow_check&quot;);
 887 }
 888 
 889 // Allocate monitor and lock method (asm interpreter).
 890 //
 891 // Args:
 892 //   Z_locals: locals
 893 
 894 void TemplateInterpreterGenerator::lock_method(void) {
 895 
 896   BLOCK_COMMENT(&quot;lock_method {&quot;);
 897 
 898   // Synchronize method.
 899   const Register method = Z_tmp_2;
 900   __ get_method(method);
 901 
 902 #ifdef ASSERT
 903   address reentry = NULL;
 904   {
 905     Label L;
 906     __ testbit(method2_(method, access_flags), JVM_ACC_SYNCHRONIZED_BIT);
 907     __ z_btrue(L);
 908     reentry = __ stop_chain_static(reentry, &quot;method doesn&#39;t need synchronization&quot;);
 909     __ bind(L);
 910   }
 911 #endif // ASSERT
 912 
 913   // Get synchronization object.
 914   const Register object = Z_tmp_2;
 915 
 916   {
 917     Label     done;
 918     Label     static_method;
 919 
 920     __ testbit(method2_(method, access_flags), JVM_ACC_STATIC_BIT);
 921     __ z_btrue(static_method);
 922 
 923     // non-static method: Load receiver obj from stack.
 924     __ mem2reg_opt(object, Address(Z_locals, Interpreter::local_offset_in_bytes(0)));
 925     __ z_bru(done);
 926 
 927     __ bind(static_method);
 928 
 929     // Lock the java mirror.
 930     // Load mirror from interpreter frame.
 931     __ z_lg(object, _z_ijava_state_neg(mirror), Z_fp);
 932 
 933 #ifdef ASSERT
 934     {
 935       NearLabel L;
 936       __ compare64_and_branch(object, (intptr_t) 0, Assembler::bcondNotEqual, L);
 937       reentry = __ stop_chain_static(reentry, &quot;synchronization object is NULL&quot;);
 938       __ bind(L);
 939     }
 940 #endif // ASSERT
 941 
 942     __ bind(done);
 943   }
 944 
 945   __ add_monitor_to_stack(true, Z_ARG3, Z_ARG4, Z_ARG5); // Allocate monitor elem.
 946   // Store object and lock it.
 947   __ get_monitors(Z_tmp_1);
 948   __ reg2mem_opt(object, Address(Z_tmp_1, BasicObjectLock::obj_offset_in_bytes()));
 949   __ lock_object(Z_tmp_1, object);
 950 
 951   BLOCK_COMMENT(&quot;} lock_method&quot;);
 952 }
 953 
 954 // Generate a fixed interpreter frame. This is identical setup for
 955 // interpreted methods and for native methods hence the shared code.
 956 //
 957 // Registers alive
 958 //   Z_thread   - JavaThread*
 959 //   Z_SP       - old stack pointer
 960 //   Z_method   - callee&#39;s method
 961 //   Z_esp      - parameter list (slot &#39;above&#39; last param)
 962 //   Z_R14      - return pc, to be stored in caller&#39;s frame
 963 //   Z_R10      - sender sp, note: Z_tmp_1 is Z_R10!
 964 //
 965 // Registers updated
 966 //   Z_SP       - new stack pointer
 967 //   Z_esp      - callee&#39;s operand stack pointer
 968 //                points to the slot above the value on top
 969 //   Z_locals   - used to access locals: locals[i] := *(Z_locals - i*BytesPerWord)
 970 //   Z_bcp      - the bytecode pointer
 971 //   Z_fp       - the frame pointer, thereby killing Z_method
 972 //   Z_ARG2     - copy of Z_method
 973 //
 974 void TemplateInterpreterGenerator::generate_fixed_frame(bool native_call) {
 975 
 976   //  stack layout
 977   //
 978   //   F1 [TOP_IJAVA_FRAME_ABI]              &lt;-- Z_SP, Z_R10 (see note below)
 979   //      [F1&#39;s operand stack (unused)]
 980   //      [F1&#39;s outgoing Java arguments]     &lt;-- Z_esp
 981   //      [F1&#39;s operand stack (non args)]
 982   //      [monitors]      (optional)
 983   //      [IJAVA_STATE]
 984   //
 985   //   F2 [PARENT_IJAVA_FRAME_ABI]
 986   //      ...
 987   //
 988   //  0x000
 989   //
 990   // Note: Z_R10, the sender sp, will be below Z_SP if F1 was extended by a c2i adapter.
 991 
 992   //=============================================================================
 993   // Allocate space for locals other than the parameters, the
 994   // interpreter state, monitors, and the expression stack.
 995 
 996   const Register local_count  = Z_ARG5;
 997   const Register fp           = Z_tmp_2;
 998   const Register const_method = Z_ARG1;
 999 
1000   BLOCK_COMMENT(&quot;generate_fixed_frame {&quot;);
1001   {
1002   // local registers
1003   const Register top_frame_size  = Z_ARG2;
1004   const Register sp_after_resize = Z_ARG3;
1005   const Register max_stack       = Z_ARG4;
1006 
1007   __ z_lg(const_method, Address(Z_method, Method::const_offset()));
1008   __ z_llgh(max_stack, Address(const_method, ConstMethod::size_of_parameters_offset()));
1009   __ z_sllg(Z_locals /*parameter_count bytes*/, max_stack /*parameter_count*/, LogBytesPerWord);
1010 
1011   if (native_call) {
1012     // If we&#39;re calling a native method, we replace max_stack (which is
1013     // zero) with space for the worst-case signature handler varargs
1014     // vector, which is:
1015     //   max_stack = max(Argument::n_register_parameters, parameter_count+2);
1016     //
1017     // We add two slots to the parameter_count, one for the jni
1018     // environment and one for a possible native mirror. We allocate
1019     // space for at least the number of ABI registers, even though
1020     // InterpreterRuntime::slow_signature_handler won&#39;t write more than
1021     // parameter_count+2 words when it creates the varargs vector at the
1022     // top of the stack. The generated slow signature handler will just
1023     // load trash into registers beyond the necessary number. We&#39;re
1024     // still going to cut the stack back by the ABI register parameter
1025     // count so as to get SP+16 pointing at the ABI outgoing parameter
1026     // area, so we need to allocate at least that much even though we&#39;re
1027     // going to throw it away.
1028     //
1029     __ add2reg(max_stack, 2);
1030 
1031     NearLabel passing_args_on_stack;
1032 
1033     // max_stack in bytes
1034     __ z_sllg(max_stack, max_stack, LogBytesPerWord);
1035 
1036     int argument_registers_in_bytes = Argument::n_register_parameters &lt;&lt; LogBytesPerWord;
1037     __ compare64_and_branch(max_stack, argument_registers_in_bytes, Assembler::bcondNotLow, passing_args_on_stack);
1038 
1039     __ load_const_optimized(max_stack, argument_registers_in_bytes);
1040 
1041     __ bind(passing_args_on_stack);
1042   } else {
1043     // !native_call
1044     // local_count = method-&gt;constMethod-&gt;max_locals();
1045     __ z_llgh(local_count, Address(const_method, ConstMethod::size_of_locals_offset()));
1046 
1047     // Calculate number of non-parameter locals (in slots):
1048     __ z_sgr(local_count, max_stack);
1049 
1050     // max_stack = method-&gt;max_stack();
1051     __ z_llgh(max_stack, Address(const_method, ConstMethod::max_stack_offset()));
1052     // max_stack in bytes
1053     __ z_sllg(max_stack, max_stack, LogBytesPerWord);
1054   }
1055 
1056   // Resize (i.e. normally shrink) the top frame F1 ...
1057   //   F1      [TOP_IJAVA_FRAME_ABI]          &lt;-- Z_SP, Z_R10
1058   //           F1&#39;s operand stack (free)
1059   //           ...
1060   //           F1&#39;s operand stack (free)      &lt;-- Z_esp
1061   //           F1&#39;s outgoing Java arg m
1062   //           ...
1063   //           F1&#39;s outgoing Java arg 0
1064   //           ...
1065   //
1066   //  ... into a parent frame (Z_R10 holds F1&#39;s SP before any modification, see also above)
1067   //
1068   //           +......................+
1069   //           :                      :        &lt;-- Z_R10, saved below as F0&#39;s z_ijava_state.sender_sp
1070   //           :                      :
1071   //   F1      [PARENT_IJAVA_FRAME_ABI]        &lt;-- Z_SP       \
1072   //           F0&#39;s non arg local                             | = delta
1073   //           ...                                            |
1074   //           F0&#39;s non arg local              &lt;-- Z_esp      /
1075   //           F1&#39;s outgoing Java arg m
1076   //           ...
1077   //           F1&#39;s outgoing Java arg 0
1078   //           ...
1079   //
1080   // then push the new top frame F0.
1081   //
1082   //   F0      [TOP_IJAVA_FRAME_ABI]    = frame::z_top_ijava_frame_abi_size \
1083   //           [operand stack]          = max_stack                          | = top_frame_size
1084   //           [IJAVA_STATE]            = frame::z_ijava_state_size         /
1085 
1086   // sp_after_resize = Z_esp - delta
1087   //
1088   // delta = PARENT_IJAVA_FRAME_ABI + (locals_count - params_count)
1089 
1090   __ add2reg(sp_after_resize, (Interpreter::stackElementSize) - (frame::z_parent_ijava_frame_abi_size), Z_esp);
1091   if (!native_call) {
1092     __ z_sllg(Z_R0_scratch, local_count, LogBytesPerWord); // Params have already been subtracted from local_count.
1093     __ z_slgr(sp_after_resize, Z_R0_scratch);
1094   }
1095 
1096   // top_frame_size = TOP_IJAVA_FRAME_ABI + max_stack + size of interpreter state
1097   __ add2reg(top_frame_size,
1098              frame::z_top_ijava_frame_abi_size +
1099              frame::z_ijava_state_size,
1100              max_stack);
1101 
1102   if (!native_call) {
1103     // Stack overflow check.
1104     // Native calls don&#39;t need the stack size check since they have no
1105     // expression stack and the arguments are already on the stack and
1106     // we only add a handful of words to the stack.
1107     Register frame_size = max_stack; // Reuse the register for max_stack.
1108     __ z_lgr(frame_size, Z_SP);
1109     __ z_sgr(frame_size, sp_after_resize);
1110     __ z_agr(frame_size, top_frame_size);
1111     generate_stack_overflow_check(frame_size, fp/*tmp1*/);
1112   }
1113 
1114   DEBUG_ONLY(__ z_cg(Z_R14, _z_abi16(return_pc), Z_SP));
1115   __ asm_assert_eq(&quot;killed Z_R14&quot;, 0);
1116   __ resize_frame_absolute(sp_after_resize, fp, true);
1117   __ save_return_pc(Z_R14);
1118 
1119   // ... and push the new frame F0.
1120   __ push_frame(top_frame_size, fp, true /*copy_sp*/, false);
1121   }
1122 
1123   //=============================================================================
1124   // Initialize the new frame F0: initialize interpreter state.
1125 
1126   {
1127   // locals
1128   const Register local_addr = Z_ARG4;
1129 
1130   BLOCK_COMMENT(&quot;generate_fixed_frame: initialize interpreter state {&quot;);
1131 
1132 #ifdef ASSERT
1133   // Set the magic number (using local_addr as tmp register).
1134   __ load_const_optimized(local_addr, frame::z_istate_magic_number);
1135   __ z_stg(local_addr, _z_ijava_state_neg(magic), fp);
1136 #endif
1137 
1138   // Save sender SP from F1 (i.e. before it was potentially modified by an
1139   // adapter) into F0&#39;s interpreter state. We use it as well to revert
1140   // resizing the frame above.
1141   __ z_stg(Z_R10, _z_ijava_state_neg(sender_sp), fp);
1142 
1143   // Load cp cache and save it at the end of this block.
1144   __ z_lg(Z_R1_scratch, Address(const_method, ConstMethod::constants_offset()));
1145   __ z_lg(Z_R1_scratch, Address(Z_R1_scratch, ConstantPool::cache_offset_in_bytes()));
1146 
1147   // z_ijava_state-&gt;method = method;
1148   __ z_stg(Z_method, _z_ijava_state_neg(method), fp);
1149 
1150   // Point locals at the first argument. Method&#39;s locals are the
1151   // parameters on top of caller&#39;s expression stack.
1152   // Tos points past last Java argument.
1153 
1154   __ z_agr(Z_locals, Z_esp);
1155   // z_ijava_state-&gt;locals - i*BytesPerWord points to i-th Java local (i starts at 0)
1156   // z_ijava_state-&gt;locals = Z_esp + parameter_count bytes
1157   __ z_stg(Z_locals, _z_ijava_state_neg(locals), fp);
1158 
1159   // z_ijava_state-&gt;oop_temp = NULL;
1160   __ store_const(Address(fp, oop_tmp_offset), 0);
1161 
1162   // Initialize z_ijava_state-&gt;mdx.
1163   Register Rmdp = Z_bcp;
1164   // native_call: assert that mdo == NULL
1165   const bool check_for_mdo = !native_call DEBUG_ONLY(|| native_call);
1166   if (ProfileInterpreter &amp;&amp; check_for_mdo) {
1167     Label get_continue;
1168 
1169     __ load_and_test_long(Rmdp, method_(method_data));
1170     __ z_brz(get_continue);
1171     DEBUG_ONLY(if (native_call) __ stop(&quot;native methods don&#39;t have a mdo&quot;));
1172     __ add2reg(Rmdp, in_bytes(MethodData::data_offset()));
1173     __ bind(get_continue);
1174   }
1175   __ z_stg(Rmdp, _z_ijava_state_neg(mdx), fp);
1176 
1177   // Initialize z_ijava_state-&gt;bcp and Z_bcp.
1178   if (native_call) {
1179     __ clear_reg(Z_bcp); // Must initialize. Will get written into frame where GC reads it.
1180   } else {
1181     __ add2reg(Z_bcp, in_bytes(ConstMethod::codes_offset()), const_method);
1182   }
1183   __ z_stg(Z_bcp, _z_ijava_state_neg(bcp), fp);
1184 
1185   // no monitors and empty operand stack
1186   // =&gt; z_ijava_state-&gt;monitors points to the top slot in IJAVA_STATE.
1187   // =&gt; Z_ijava_state-&gt;esp points one slot above into the operand stack.
1188   // z_ijava_state-&gt;monitors = fp - frame::z_ijava_state_size - Interpreter::stackElementSize;
1189   // z_ijava_state-&gt;esp = Z_esp = z_ijava_state-&gt;monitors;
1190   __ add2reg(Z_esp, -frame::z_ijava_state_size, fp);
1191   __ z_stg(Z_esp, _z_ijava_state_neg(monitors), fp);
1192   __ add2reg(Z_esp, -Interpreter::stackElementSize);
1193   __ z_stg(Z_esp, _z_ijava_state_neg(esp), fp);
1194 
1195   // z_ijava_state-&gt;cpoolCache = Z_R1_scratch (see load above);
1196   __ z_stg(Z_R1_scratch, _z_ijava_state_neg(cpoolCache), fp);
1197 
1198   // Get mirror and store it in the frame as GC root for this Method*.
1199   __ load_mirror_from_const_method(Z_R1_scratch, const_method);
1200   __ z_stg(Z_R1_scratch, _z_ijava_state_neg(mirror), fp);
1201 
1202   BLOCK_COMMENT(&quot;} generate_fixed_frame: initialize interpreter state&quot;);
1203 
1204   //=============================================================================
1205   if (!native_call) {
1206     // Local_count is already num_locals_slots - num_param_slots.
1207     // Start of locals: local_addr = Z_locals - locals size + 1 slot
1208     __ z_llgh(Z_R0_scratch, Address(const_method, ConstMethod::size_of_locals_offset()));
1209     __ add2reg(local_addr, BytesPerWord, Z_locals);
1210     __ z_sllg(Z_R0_scratch, Z_R0_scratch, LogBytesPerWord);
1211     __ z_sgr(local_addr, Z_R0_scratch);
1212 
1213     __ Clear_Array(local_count, local_addr, Z_ARG2);
1214   }
1215 
1216   }
1217   // Finally set the frame pointer, destroying Z_method.
1218   assert(Z_fp == Z_method, &quot;maybe set Z_fp earlier if other register than Z_method&quot;);
1219   // Oprofile analysis suggests to keep a copy in a register to be used by
1220   // generate_counter_incr().
1221   __ z_lgr(Z_ARG2, Z_method);
1222   __ z_lgr(Z_fp, fp);
1223 
1224   BLOCK_COMMENT(&quot;} generate_fixed_frame&quot;);
1225 }
1226 
1227 // Various method entries
1228 
1229 // Math function, frame manager must set up an interpreter state, etc.
1230 address TemplateInterpreterGenerator::generate_math_entry(AbstractInterpreter::MethodKind kind) {
1231 
1232   // Decide what to do: Use same platform specific instructions and runtime calls as compilers.
1233   bool use_instruction = false;
1234   address runtime_entry = NULL;
1235   int num_args = 1;
1236   bool double_precision = true;
1237 
1238   // s390 specific:
1239   switch (kind) {
1240     case Interpreter::java_lang_math_sqrt:
1241     case Interpreter::java_lang_math_abs:  use_instruction = true; break;
1242     case Interpreter::java_lang_math_fmaF:
1243     case Interpreter::java_lang_math_fmaD: use_instruction = UseFMA; break;
1244     default: break; // Fall back to runtime call.
1245   }
1246 
1247   switch (kind) {
1248     case Interpreter::java_lang_math_sin  : runtime_entry = CAST_FROM_FN_PTR(address, SharedRuntime::dsin);   break;
1249     case Interpreter::java_lang_math_cos  : runtime_entry = CAST_FROM_FN_PTR(address, SharedRuntime::dcos);   break;
1250     case Interpreter::java_lang_math_tan  : runtime_entry = CAST_FROM_FN_PTR(address, SharedRuntime::dtan);   break;
1251     case Interpreter::java_lang_math_abs  : /* run interpreted */ break;
1252     case Interpreter::java_lang_math_sqrt : /* runtime_entry = CAST_FROM_FN_PTR(address, SharedRuntime::dsqrt); not available */ break;
1253     case Interpreter::java_lang_math_log  : runtime_entry = CAST_FROM_FN_PTR(address, SharedRuntime::dlog);   break;
1254     case Interpreter::java_lang_math_log10: runtime_entry = CAST_FROM_FN_PTR(address, SharedRuntime::dlog10); break;
1255     case Interpreter::java_lang_math_pow  : runtime_entry = CAST_FROM_FN_PTR(address, SharedRuntime::dpow); num_args = 2; break;
1256     case Interpreter::java_lang_math_exp  : runtime_entry = CAST_FROM_FN_PTR(address, SharedRuntime::dexp);   break;
1257     case Interpreter::java_lang_math_fmaF : /* run interpreted */ num_args = 3; double_precision = false; break;
1258     case Interpreter::java_lang_math_fmaD : /* run interpreted */ num_args = 3; break;
1259     default: ShouldNotReachHere();
1260   }
1261 
1262   // Use normal entry if neither instruction nor runtime call is used.
1263   if (!use_instruction &amp;&amp; runtime_entry == NULL) return NULL;
1264 
1265   address entry = __ pc();
1266 
1267   if (use_instruction) {
1268     switch (kind) {
1269       case Interpreter::java_lang_math_sqrt:
1270         // Can use memory operand directly.
1271         __ z_sqdb(Z_FRET, Interpreter::stackElementSize, Z_esp);
1272         break;
1273       case Interpreter::java_lang_math_abs:
1274         // Load operand from stack.
1275         __ mem2freg_opt(Z_FRET, Address(Z_esp, Interpreter::stackElementSize));
1276         __ z_lpdbr(Z_FRET);
1277         break;
1278       case Interpreter::java_lang_math_fmaF:
1279         __ mem2freg_opt(Z_FRET,  Address(Z_esp,     Interpreter::stackElementSize)); // result reg = arg3
1280         __ mem2freg_opt(Z_FARG2, Address(Z_esp, 3 * Interpreter::stackElementSize)); // arg1
1281         __ z_maeb(Z_FRET, Z_FARG2, Address(Z_esp, 2 * Interpreter::stackElementSize));
1282         break;
1283       case Interpreter::java_lang_math_fmaD:
1284         __ mem2freg_opt(Z_FRET,  Address(Z_esp,     Interpreter::stackElementSize)); // result reg = arg3
1285         __ mem2freg_opt(Z_FARG2, Address(Z_esp, 5 * Interpreter::stackElementSize)); // arg1
1286         __ z_madb(Z_FRET, Z_FARG2, Address(Z_esp, 3 * Interpreter::stackElementSize));
1287         break;
1288       default: ShouldNotReachHere();
1289     }
1290   } else {
1291     // Load arguments
1292     assert(num_args &lt;= 4, &quot;passed in registers&quot;);
1293     if (double_precision) {
1294       int offset = (2 * num_args - 1) * Interpreter::stackElementSize;
1295       for (int i = 0; i &lt; num_args; ++i) {
1296         __ mem2freg_opt(as_FloatRegister(Z_FARG1-&gt;encoding() + 2 * i), Address(Z_esp, offset));
1297         offset -= 2 * Interpreter::stackElementSize;
1298       }
1299     } else {
1300       int offset = num_args * Interpreter::stackElementSize;
1301       for (int i = 0; i &lt; num_args; ++i) {
1302         __ mem2freg_opt(as_FloatRegister(Z_FARG1-&gt;encoding() + 2 * i), Address(Z_esp, offset));
1303         offset -= Interpreter::stackElementSize;
1304       }
1305     }
1306     // Call runtime
1307     __ save_return_pc();       // Save Z_R14.
1308     __ push_frame_abi160(0);   // Without new frame the RT call could overwrite the saved Z_R14.
1309 
1310     __ call_VM_leaf(runtime_entry);
1311 
1312     __ pop_frame();
1313     __ restore_return_pc();    // Restore Z_R14.
1314   }
1315 
1316   // Pop c2i arguments (if any) off when we return.
1317   __ resize_frame_absolute(Z_R10, Z_R0, true); // Cut the stack back to where the caller started.
1318 
1319   __ z_br(Z_R14);
1320 
1321   return entry;
1322 }
1323 
1324 // Interpreter stub for calling a native method. (asm interpreter).
1325 // This sets up a somewhat different looking stack for calling the
1326 // native method than the typical interpreter frame setup.
1327 address TemplateInterpreterGenerator::generate_native_entry(bool synchronized) {
1328   // Determine code generation flags.
1329   bool inc_counter = UseCompiler || CountCompiledCalls || LogTouchedMethods;
1330 
1331   // Interpreter entry for ordinary Java methods.
1332   //
1333   // Registers alive
1334   //   Z_SP          - stack pointer
1335   //   Z_thread      - JavaThread*
1336   //   Z_method      - callee&#39;s method (method to be invoked)
1337   //   Z_esp         - operand (or expression) stack pointer of caller. one slot above last arg.
1338   //   Z_R10         - sender sp (before modifications, e.g. by c2i adapter
1339   //                   and as well by generate_fixed_frame below)
1340   //   Z_R14         - return address to caller (call_stub or c2i_adapter)
1341   //
1342   // Registers updated
1343   //   Z_SP          - stack pointer
1344   //   Z_fp          - callee&#39;s framepointer
1345   //   Z_esp         - callee&#39;s operand stack pointer
1346   //                   points to the slot above the value on top
1347   //   Z_locals      - used to access locals: locals[i] := *(Z_locals - i*BytesPerWord)
1348   //   Z_tos         - integer result, if any
1349   //   z_ftos        - floating point result, if any
1350   //
1351   // Stack layout at this point:
1352   //
1353   //   F1      [TOP_IJAVA_FRAME_ABI]         &lt;-- Z_SP, Z_R10 (Z_R10 will be below Z_SP if
1354   //                                                          frame was extended by c2i adapter)
1355   //           [outgoing Java arguments]     &lt;-- Z_esp
1356   //           ...
1357   //   PARENT  [PARENT_IJAVA_FRAME_ABI]
1358   //           ...
1359   //
1360 
1361   address entry_point = __ pc();
1362 
1363   // Make sure registers are different!
1364   assert_different_registers(Z_thread, Z_method, Z_esp);
1365 
1366   BLOCK_COMMENT(&quot;native_entry {&quot;);
1367 
1368   // Make sure method is native and not abstract.
1369 #ifdef ASSERT
1370   address reentry = NULL;
1371   { Label L;
1372     __ testbit(method_(access_flags), JVM_ACC_NATIVE_BIT);
1373     __ z_btrue(L);
1374     reentry = __ stop_chain_static(reentry, &quot;tried to execute non-native method as native&quot;);
1375     __ bind(L);
1376   }
1377   { Label L;
1378     __ testbit(method_(access_flags), JVM_ACC_ABSTRACT_BIT);
1379     __ z_bfalse(L);
1380     reentry = __ stop_chain_static(reentry, &quot;tried to execute abstract method as non-abstract&quot;);
1381     __ bind(L);
1382   }
1383 #endif // ASSERT
1384 
1385 #ifdef ASSERT
1386   // Save the return PC into the callers frame for assertion in generate_fixed_frame.
1387   __ save_return_pc(Z_R14);
1388 #endif
1389 
1390   // Generate the code to allocate the interpreter stack frame.
1391   generate_fixed_frame(true);
1392 
1393   const Address do_not_unlock_if_synchronized(Z_thread, JavaThread::do_not_unlock_if_synchronized_offset());
1394   // Since at this point in the method invocation the exception handler
1395   // would try to exit the monitor of synchronized methods which hasn&#39;t
1396   // been entered yet, we set the thread local variable
1397   // _do_not_unlock_if_synchronized to true. If any exception was thrown by
1398   // runtime, exception handling i.e. unlock_if_synchronized_method will
1399   // check this thread local flag.
1400   __ z_mvi(do_not_unlock_if_synchronized, true);
1401 
1402   // Increment invocation count and check for overflow.
1403   NearLabel invocation_counter_overflow;
1404   if (inc_counter) {
1405     generate_counter_incr(&amp;invocation_counter_overflow, NULL, NULL);
1406   }
1407 
1408   Label continue_after_compile;
1409   __ bind(continue_after_compile);
1410 
1411   bang_stack_shadow_pages(true);
1412 
1413   // Reset the _do_not_unlock_if_synchronized flag.
1414   __ z_mvi(do_not_unlock_if_synchronized, false);
1415 
1416   // Check for synchronized methods.
1417   // This mst happen AFTER invocation_counter check and stack overflow check,
1418   // so method is not locked if overflows.
1419   if (synchronized) {
1420     lock_method();
1421   } else {
1422     // No synchronization necessary.
1423 #ifdef ASSERT
1424     { Label L;
1425       __ get_method(Z_R1_scratch);
1426       __ testbit(method2_(Z_R1_scratch, access_flags), JVM_ACC_SYNCHRONIZED_BIT);
1427       __ z_bfalse(L);
1428       reentry = __ stop_chain_static(reentry, &quot;method needs synchronization&quot;);
1429       __ bind(L);
1430     }
1431 #endif // ASSERT
1432   }
1433 
1434   // start execution
1435 
1436   // jvmti support
1437   __ notify_method_entry();
1438 
1439   //=============================================================================
1440   // Get and call the signature handler.
1441   const Register Rmethod                 = Z_tmp_2;
1442   const Register signature_handler_entry = Z_tmp_1;
1443   const Register Rresult_handler         = Z_tmp_3;
1444   Label call_signature_handler;
1445 
1446   assert_different_registers(Z_fp, Rmethod, signature_handler_entry, Rresult_handler);
1447   assert(Rresult_handler-&gt;is_nonvolatile(), &quot;Rresult_handler must be in a non-volatile register&quot;);
1448 
1449   // Reload method.
1450   __ get_method(Rmethod);
1451 
1452   // Check for signature handler.
1453   __ load_and_test_long(signature_handler_entry, method2_(Rmethod, signature_handler));
1454   __ z_brne(call_signature_handler);
1455 
1456   // Method has never been called. Either generate a specialized
1457   // handler or point to the slow one.
1458   __ call_VM(noreg, CAST_FROM_FN_PTR(address, InterpreterRuntime::prepare_native_call),
1459              Rmethod);
1460 
1461   // Reload method.
1462   __ get_method(Rmethod);
1463 
1464   // Reload signature handler, it must have been created/assigned in the meantime.
1465   __ z_lg(signature_handler_entry, method2_(Rmethod, signature_handler));
1466 
1467   __ bind(call_signature_handler);
1468 
1469   // We have a TOP_IJAVA_FRAME here, which belongs to us.
1470   __ set_top_ijava_frame_at_SP_as_last_Java_frame(Z_SP, Z_R1/*tmp*/);
1471 
1472   // Call signature handler and pass locals address in Z_ARG1.
1473   __ z_lgr(Z_ARG1, Z_locals);
1474   __ call_stub(signature_handler_entry);
1475   // Save result handler returned by signature handler.
1476   __ z_lgr(Rresult_handler, Z_RET);
1477 
1478   // Reload method (the slow signature handler may block for GC).
1479   __ get_method(Rmethod);
1480 
1481   // Pass mirror handle if static call.
1482   {
1483     Label method_is_not_static;
1484     __ testbit(method2_(Rmethod, access_flags), JVM_ACC_STATIC_BIT);
1485     __ z_bfalse(method_is_not_static);
1486     // Load mirror from interpreter frame.
1487     __ z_lg(Z_R1, _z_ijava_state_neg(mirror), Z_fp);
1488     // z_ijava_state.oop_temp = pool_holder-&gt;klass_part()-&gt;java_mirror();
1489     __ z_stg(Z_R1, oop_tmp_offset, Z_fp);
1490     // Pass handle to mirror as 2nd argument to JNI method.
1491     __ add2reg(Z_ARG2, oop_tmp_offset, Z_fp);
1492     __ bind(method_is_not_static);
1493   }
1494 
1495   // Pass JNIEnv address as first parameter.
1496   __ add2reg(Z_ARG1, in_bytes(JavaThread::jni_environment_offset()), Z_thread);
1497 
1498   // Note: last java frame has been set above already. The pc from there
1499   // is precise enough.
1500 
1501   // Get native function entry point before we change the thread state.
1502   __ z_lg(Z_R1/*native_method_entry*/, method2_(Rmethod, native_function));
1503 
1504   //=============================================================================
1505   // Transition from _thread_in_Java to _thread_in_native. As soon as
1506   // we make this change the safepoint code needs to be certain that
1507   // the last Java frame we established is good. The pc in that frame
1508   // just need to be near here not an actual return address.
1509 #ifdef ASSERT
1510   {
1511     NearLabel L;
1512     __ mem2reg_opt(Z_R14, Address(Z_thread, JavaThread::thread_state_offset()), false /*32 bits*/);
1513     __ compareU32_and_branch(Z_R14, _thread_in_Java, Assembler::bcondEqual, L);
1514     reentry = __ stop_chain_static(reentry, &quot;Wrong thread state in native stub&quot;);
1515     __ bind(L);
1516   }
1517 #endif
1518 
1519   // Memory ordering: Z does not reorder store/load with subsequent load. That&#39;s strong enough.
1520   __ set_thread_state(_thread_in_native);
1521 
1522   //=============================================================================
1523   // Call the native method. Argument registers must not have been
1524   // overwritten since &quot;__ call_stub(signature_handler);&quot; (except for
1525   // ARG1 and ARG2 for static methods).
1526 
1527   __ call_c(Z_R1/*native_method_entry*/);
1528 
1529   // NOTE: frame::interpreter_frame_result() depends on these stores.
1530   __ z_stg(Z_RET, _z_ijava_state_neg(lresult), Z_fp);
1531   __ freg2mem_opt(Z_FRET, Address(Z_fp, _z_ijava_state_neg(fresult)));
1532   const Register Rlresult = signature_handler_entry;
1533   assert(Rlresult-&gt;is_nonvolatile(), &quot;Rlresult must be in a non-volatile register&quot;);
1534   __ z_lgr(Rlresult, Z_RET);
1535 
1536   // Z_method may no longer be valid, because of GC.
1537 
1538   // Block, if necessary, before resuming in _thread_in_Java state.
1539   // In order for GC to work, don&#39;t clear the last_Java_sp until after
1540   // blocking.
1541 
1542   //=============================================================================
1543   // Switch thread to &quot;native transition&quot; state before reading the
1544   // synchronization state. This additional state is necessary
1545   // because reading and testing the synchronization state is not
1546   // atomic w.r.t. GC, as this scenario demonstrates: Java thread A,
1547   // in _thread_in_native state, loads _not_synchronized and is
1548   // preempted. VM thread changes sync state to synchronizing and
1549   // suspends threads for GC. Thread A is resumed to finish this
1550   // native method, but doesn&#39;t block here since it didn&#39;t see any
1551   // synchronization is progress, and escapes.
1552 
1553   __ set_thread_state(_thread_in_native_trans);
1554   __ z_fence();
1555 
1556   // Now before we return to java we must look for a current safepoint
1557   // (a new safepoint can not start since we entered native_trans).
1558   // We must check here because a current safepoint could be modifying
1559   // the callers registers right this moment.
1560 
1561   // Check for safepoint operation in progress and/or pending suspend requests.
1562   {
1563     Label Continue, do_safepoint;
1564     __ safepoint_poll(do_safepoint, Z_R1);
1565     // Check for suspend.
1566     __ load_and_test_int(Z_R0/*suspend_flags*/, thread_(suspend_flags));
1567     __ z_bre(Continue); // 0 -&gt; no flag set -&gt; not suspended
1568     __ bind(do_safepoint);
1569     __ z_lgr(Z_ARG1, Z_thread);
1570     __ call_c(CAST_FROM_FN_PTR(address, JavaThread::check_special_condition_for_native_trans));
1571     __ bind(Continue);
1572   }
1573 
1574   //=============================================================================
1575   // Back in Interpreter Frame.
1576 
1577   // We are in thread_in_native_trans here and back in the normal
1578   // interpreter frame. We don&#39;t have to do anything special about
1579   // safepoints and we can switch to Java mode anytime we are ready.
1580 
1581   // Note: frame::interpreter_frame_result has a dependency on how the
1582   // method result is saved across the call to post_method_exit. For
1583   // native methods it assumes that the non-FPU/non-void result is
1584   // saved in z_ijava_state.lresult and a FPU result in z_ijava_state.fresult. If
1585   // this changes then the interpreter_frame_result implementation
1586   // will need to be updated too.
1587 
1588   //=============================================================================
1589   // Back in Java.
1590 
1591   // Memory ordering: Z does not reorder store/load with subsequent
1592   // load. That&#39;s strong enough.
1593   __ set_thread_state(_thread_in_Java);
1594 
1595   __ reset_last_Java_frame();
1596 
1597   // We reset the JNI handle block only after unboxing the result; see below.
1598 
1599   // The method register is junk from after the thread_in_native transition
1600   // until here. Also can&#39;t call_VM until the bcp has been
1601   // restored. Need bcp for throwing exception below so get it now.
1602   __ get_method(Rmethod);
1603 
1604   // Restore Z_bcp to have legal interpreter frame,
1605   // i.e., bci == 0 &lt;=&gt; Z_bcp == code_base().
1606   __ z_lg(Z_bcp, Address(Rmethod, Method::const_offset())); // get constMethod
1607   __ add2reg(Z_bcp, in_bytes(ConstMethod::codes_offset())); // get codebase
1608 
1609   if (CheckJNICalls) {
1610     // clear_pending_jni_exception_check
1611     __ clear_mem(Address(Z_thread, JavaThread::pending_jni_exception_check_fn_offset()), sizeof(oop));
1612   }
1613 
1614   // Check if the native method returns an oop, and if so, move it
1615   // from the jni handle to z_ijava_state.oop_temp. This is
1616   // necessary, because we reset the jni handle block below.
1617   // NOTE: frame::interpreter_frame_result() depends on this, too.
1618   { NearLabel no_oop_result;
1619   __ load_absolute_address(Z_R1, AbstractInterpreter::result_handler(T_OBJECT));
1620   __ compareU64_and_branch(Z_R1, Rresult_handler, Assembler::bcondNotEqual, no_oop_result);
1621   __ resolve_jobject(Rlresult, /* tmp1 */ Rmethod, /* tmp2 */ Z_R1);
1622   __ z_stg(Rlresult, oop_tmp_offset, Z_fp);
1623   __ bind(no_oop_result);
1624   }
1625 
1626   // Reset handle block.
1627   __ z_lg(Z_R1/*active_handles*/, thread_(active_handles));
1628   __ clear_mem(Address(Z_R1, JNIHandleBlock::top_offset_in_bytes()), 4);
1629 
1630   // Handle exceptions (exception handling will handle unlocking!).
1631   {
1632     Label L;
1633     __ load_and_test_long(Z_R0/*pending_exception*/, thread_(pending_exception));
1634     __ z_bre(L);
1635     __ MacroAssembler::call_VM(noreg,
1636                                CAST_FROM_FN_PTR(address,
1637                                InterpreterRuntime::throw_pending_exception));
1638     __ should_not_reach_here();
1639     __ bind(L);
1640   }
1641 
1642   if (synchronized) {
1643     Register Rfirst_monitor = Z_ARG2;
1644     __ add2reg(Rfirst_monitor, -(frame::z_ijava_state_size + (int)sizeof(BasicObjectLock)), Z_fp);
1645 #ifdef ASSERT
1646     NearLabel ok;
1647     __ z_lg(Z_R1, _z_ijava_state_neg(monitors), Z_fp);
1648     __ compareU64_and_branch(Rfirst_monitor, Z_R1, Assembler::bcondEqual, ok);
1649     reentry = __ stop_chain_static(reentry, &quot;native_entry:unlock: inconsistent z_ijava_state.monitors&quot;);
1650     __ bind(ok);
1651 #endif
1652     __ unlock_object(Rfirst_monitor);
1653   }
1654 
1655   // JVMTI support. Result has already been saved above to the frame.
1656   __ notify_method_exit(true/*native_method*/, ilgl, InterpreterMacroAssembler::NotifyJVMTI);
1657 
1658   // Move native method result back into proper registers and return.
1659   __ mem2freg_opt(Z_FRET, Address(Z_fp, _z_ijava_state_neg(fresult)));
1660   __ mem2reg_opt(Z_RET, Address(Z_fp, _z_ijava_state_neg(lresult)));
1661   __ call_stub(Rresult_handler);
1662 
1663   // Pop the native method&#39;s interpreter frame.
1664   __ pop_interpreter_frame(Z_R14 /*return_pc*/, Z_ARG2/*tmp1*/, Z_ARG3/*tmp2*/);
1665 
1666   // Return to caller.
1667   __ z_br(Z_R14);
1668 
1669   if (inc_counter) {
1670     // Handle overflow of counter and compile method.
1671     __ bind(invocation_counter_overflow);
1672     generate_counter_overflow(continue_after_compile);
1673   }
1674 
1675   BLOCK_COMMENT(&quot;} native_entry&quot;);
1676 
1677   return entry_point;
1678 }
1679 
1680 //
1681 // Generic interpreted method entry to template interpreter.
1682 //
1683 address TemplateInterpreterGenerator::generate_normal_entry(bool synchronized) {
1684   address entry_point = __ pc();
1685 
1686   bool inc_counter = UseCompiler || CountCompiledCalls || LogTouchedMethods;
1687 
1688   // Interpreter entry for ordinary Java methods.
1689   //
1690   // Registers alive
1691   //   Z_SP       - stack pointer
1692   //   Z_thread   - JavaThread*
1693   //   Z_method   - callee&#39;s method (method to be invoked)
1694   //   Z_esp      - operand (or expression) stack pointer of caller. one slot above last arg.
1695   //   Z_R10      - sender sp (before modifications, e.g. by c2i adapter
1696   //                           and as well by generate_fixed_frame below)
1697   //   Z_R14      - return address to caller (call_stub or c2i_adapter)
1698   //
1699   // Registers updated
1700   //   Z_SP       - stack pointer
1701   //   Z_fp       - callee&#39;s framepointer
1702   //   Z_esp      - callee&#39;s operand stack pointer
1703   //                points to the slot above the value on top
1704   //   Z_locals   - used to access locals: locals[i] := *(Z_locals - i*BytesPerWord)
1705   //   Z_tos      - integer result, if any
1706   //   z_ftos     - floating point result, if any
1707   //
1708   //
1709   // stack layout at this point:
1710   //
1711   //   F1      [TOP_IJAVA_FRAME_ABI]         &lt;-- Z_SP, Z_R10 (Z_R10 will be below Z_SP if
1712   //                                                          frame was extended by c2i adapter)
1713   //           [outgoing Java arguments]     &lt;-- Z_esp
1714   //           ...
1715   //   PARENT  [PARENT_IJAVA_FRAME_ABI]
1716   //           ...
1717   //
1718   // stack layout before dispatching the first bytecode:
1719   //
1720   //   F0      [TOP_IJAVA_FRAME_ABI]         &lt;-- Z_SP
1721   //           [operand stack]               &lt;-- Z_esp
1722   //           monitor (optional, can grow)
1723   //           [IJAVA_STATE]
1724   //   F1      [PARENT_IJAVA_FRAME_ABI]      &lt;-- Z_fp (== *Z_SP)
1725   //           [F0&#39;s locals]                 &lt;-- Z_locals
1726   //           [F1&#39;s operand stack]
1727   //           [F1&#39;s monitors] (optional)
1728   //           [IJAVA_STATE]
1729 
1730   // Make sure registers are different!
1731   assert_different_registers(Z_thread, Z_method, Z_esp);
1732 
1733   BLOCK_COMMENT(&quot;normal_entry {&quot;);
1734 
1735   // Make sure method is not native and not abstract.
1736   // Rethink these assertions - they can be simplified and shared.
1737 #ifdef ASSERT
1738   address reentry = NULL;
1739   { Label L;
1740     __ testbit(method_(access_flags), JVM_ACC_NATIVE_BIT);
1741     __ z_bfalse(L);
1742     reentry = __ stop_chain_static(reentry, &quot;tried to execute native method as non-native&quot;);
1743     __ bind(L);
1744   }
1745   { Label L;
1746     __ testbit(method_(access_flags), JVM_ACC_ABSTRACT_BIT);
1747     __ z_bfalse(L);
1748     reentry = __ stop_chain_static(reentry, &quot;tried to execute abstract method as non-abstract&quot;);
1749     __ bind(L);
1750   }
1751 #endif // ASSERT
1752 
1753 #ifdef ASSERT
1754   // Save the return PC into the callers frame for assertion in generate_fixed_frame.
1755   __ save_return_pc(Z_R14);
1756 #endif
1757 
1758   // Generate the code to allocate the interpreter stack frame.
1759   generate_fixed_frame(false);
1760 
1761   const Address do_not_unlock_if_synchronized(Z_thread, JavaThread::do_not_unlock_if_synchronized_offset());
1762   // Since at this point in the method invocation the exception handler
1763   // would try to exit the monitor of synchronized methods which hasn&#39;t
1764   // been entered yet, we set the thread local variable
1765   // _do_not_unlock_if_synchronized to true. If any exception was thrown by
1766   // runtime, exception handling i.e. unlock_if_synchronized_method will
1767   // check this thread local flag.
1768   __ z_mvi(do_not_unlock_if_synchronized, true);
1769 
1770   __ profile_parameters_type(Z_tmp_2, Z_ARG3, Z_ARG4);
1771 
1772   // Increment invocation counter and check for overflow.
1773   //
1774   // Note: checking for negative value instead of overflow so we have a &#39;sticky&#39;
1775   // overflow test (may be of importance as soon as we have true MT/MP).
1776   NearLabel invocation_counter_overflow;
1777   NearLabel profile_method;
1778   NearLabel profile_method_continue;
1779   NearLabel Lcontinue;
1780   if (inc_counter) {
1781     generate_counter_incr(&amp;invocation_counter_overflow, &amp;profile_method, &amp;profile_method_continue);
1782     if (ProfileInterpreter) {
1783       __ bind(profile_method_continue);
1784     }
1785   }
1786   __ bind(Lcontinue);
1787 
1788   bang_stack_shadow_pages(false);
1789 
1790   // Reset the _do_not_unlock_if_synchronized flag.
1791   __ z_mvi(do_not_unlock_if_synchronized, false);
1792 
1793   // Check for synchronized methods.
1794   // Must happen AFTER invocation_counter check and stack overflow check,
1795   // so method is not locked if overflows.
1796   if (synchronized) {
1797     // Allocate monitor and lock method.
1798     lock_method();
1799   } else {
1800 #ifdef ASSERT
1801     { Label L;
1802       __ get_method(Z_R1_scratch);
1803       __ testbit(method2_(Z_R1_scratch, access_flags), JVM_ACC_SYNCHRONIZED_BIT);
1804       __ z_bfalse(L);
1805       reentry = __ stop_chain_static(reentry, &quot;method needs synchronization&quot;);
1806       __ bind(L);
1807     }
1808 #endif // ASSERT
1809   }
1810 
1811   // start execution
1812 
1813 #ifdef ASSERT
1814   __ verify_esp(Z_esp, Z_R1_scratch);
1815 
1816   __ verify_thread();
1817 #endif
1818 
1819   // jvmti support
1820   __ notify_method_entry();
1821 
1822   // Start executing instructions.
1823   __ dispatch_next(vtos);
1824   // Dispatch_next does not return.
1825   DEBUG_ONLY(__ should_not_reach_here());
1826 
1827   // Invocation counter overflow.
1828   if (inc_counter) {
1829     if (ProfileInterpreter) {
1830       // We have decided to profile this method in the interpreter.
1831       __ bind(profile_method);
1832 
1833       __ call_VM(noreg, CAST_FROM_FN_PTR(address, InterpreterRuntime::profile_method));
1834       __ set_method_data_pointer_for_bcp();
1835       __ z_bru(profile_method_continue);
1836     }
1837 
1838     // Handle invocation counter overflow.
1839     __ bind(invocation_counter_overflow);
1840     generate_counter_overflow(Lcontinue);
1841   }
1842 
1843   BLOCK_COMMENT(&quot;} normal_entry&quot;);
1844 
1845   return entry_point;
1846 }
1847 
1848 
1849 /**
1850  * Method entry for static native methods:
1851  *   int java.util.zip.CRC32.update(int crc, int b)
1852  */
1853 address TemplateInterpreterGenerator::generate_CRC32_update_entry() {
1854 
1855   if (UseCRC32Intrinsics) {
1856     uint64_t entry_off = __ offset();
1857     Label    slow_path;
1858 
1859     // If we need a safepoint check, generate full interpreter entry.
1860     __ safepoint_poll(slow_path, Z_R1);
1861 
1862     BLOCK_COMMENT(&quot;CRC32_update {&quot;);
1863 
1864     // We don&#39;t generate local frame and don&#39;t align stack because
1865     // we not even call stub code (we generate the code inline)
1866     // and there is no safepoint on this path.
1867 
1868     // Load java parameters.
1869     // Z_esp is callers operand stack pointer, i.e. it points to the parameters.
1870     const Register argP    = Z_esp;
1871     const Register crc     = Z_ARG1;  // crc value
1872     const Register data    = Z_ARG2;  // address of java byte value (kernel_crc32 needs address)
1873     const Register dataLen = Z_ARG3;  // source data len (1 byte). Not used because calling the single-byte emitter.
1874     const Register table   = Z_ARG4;  // address of crc32 table
1875 
1876     // Arguments are reversed on java expression stack.
1877     __ z_la(data, 3+1*wordSize, argP);  // byte value (stack address).
1878                                         // Being passed as an int, the single byte is at offset +3.
1879     __ z_llgf(crc, 2 * wordSize, argP); // Current crc state, zero extend to 64 bit to have a clean register.
1880 
1881     StubRoutines::zarch::generate_load_crc_table_addr(_masm, table);
1882     __ kernel_crc32_singleByte(crc, data, dataLen, table, Z_R1, true);
1883 
1884     // Restore caller sp for c2i case.
1885     __ resize_frame_absolute(Z_R10, Z_R0, true); // Cut the stack back to where the caller started.
1886 
1887     __ z_br(Z_R14);
1888 
1889     BLOCK_COMMENT(&quot;} CRC32_update&quot;);
1890 
1891     // Use a previously generated vanilla native entry as the slow path.
1892     BIND(slow_path);
1893     __ jump_to_entry(Interpreter::entry_for_kind(Interpreter::native), Z_R1);
1894     return __ addr_at(entry_off);
1895   }
1896 
1897   return NULL;
1898 }
1899 
1900 
1901 /**
1902  * Method entry for static native methods:
1903  *   int java.util.zip.CRC32.updateBytes(     int crc, byte[] b,  int off, int len)
1904  *   int java.util.zip.CRC32.updateByteBuffer(int crc, long* buf, int off, int len)
1905  */
1906 address TemplateInterpreterGenerator::generate_CRC32_updateBytes_entry(AbstractInterpreter::MethodKind kind) {
1907 
1908   if (UseCRC32Intrinsics) {
1909     uint64_t entry_off = __ offset();
1910     Label    slow_path;
1911 
1912     // If we need a safepoint check, generate full interpreter entry.
1913     __ safepoint_poll(slow_path, Z_R1);
1914 
1915     // We don&#39;t generate local frame and don&#39;t align stack because
1916     // we call stub code and there is no safepoint on this path.
1917 
1918     // Load parameters.
1919     // Z_esp is callers operand stack pointer, i.e. it points to the parameters.
1920     const Register argP    = Z_esp;
1921     const Register crc     = Z_ARG1;  // crc value
1922     const Register data    = Z_ARG2;  // address of java byte array
1923     const Register dataLen = Z_ARG3;  // source data len
1924     const Register table   = Z_ARG4;  // address of crc32 table
1925     const Register t0      = Z_R10;   // work reg for kernel* emitters
1926     const Register t1      = Z_R11;   // work reg for kernel* emitters
1927     const Register t2      = Z_R12;   // work reg for kernel* emitters
1928     const Register t3      = Z_R13;   // work reg for kernel* emitters
1929 
1930     // Arguments are reversed on java expression stack.
1931     // Calculate address of start element.
1932     if (kind == Interpreter::java_util_zip_CRC32_updateByteBuffer) { // Used for &quot;updateByteBuffer direct&quot;.
1933       // crc     @ (SP + 5W) (32bit)
1934       // buf     @ (SP + 3W) (64bit ptr to long array)
1935       // off     @ (SP + 2W) (32bit)
1936       // dataLen @ (SP + 1W) (32bit)
1937       // data = buf + off
1938       BLOCK_COMMENT(&quot;CRC32_updateByteBuffer {&quot;);
1939       __ z_llgf(crc,    5*wordSize, argP);  // current crc state
1940       __ z_lg(data,     3*wordSize, argP);  // start of byte buffer
1941       __ z_agf(data,    2*wordSize, argP);  // Add byte buffer offset.
1942       __ z_lgf(dataLen, 1*wordSize, argP);  // #bytes to process
1943     } else {                                                         // Used for &quot;updateBytes update&quot;.
1944       // crc     @ (SP + 4W) (32bit)
1945       // buf     @ (SP + 3W) (64bit ptr to byte array)
1946       // off     @ (SP + 2W) (32bit)
1947       // dataLen @ (SP + 1W) (32bit)
1948       // data = buf + off + base_offset
1949       BLOCK_COMMENT(&quot;CRC32_updateBytes {&quot;);
1950       __ z_llgf(crc,    4*wordSize, argP);  // current crc state
1951       __ z_lg(data,     3*wordSize, argP);  // start of byte buffer
1952       __ z_agf(data,    2*wordSize, argP);  // Add byte buffer offset.
1953       __ z_lgf(dataLen, 1*wordSize, argP);  // #bytes to process
1954       __ z_aghi(data, arrayOopDesc::base_offset_in_bytes(T_BYTE));
1955     }
1956 
1957     StubRoutines::zarch::generate_load_crc_table_addr(_masm, table);
1958 
1959     __ resize_frame(-(6*8), Z_R0, true); // Resize frame to provide add&#39;l space to spill 5 registers.
1960     __ z_stmg(t0, t3, 1*8, Z_SP);        // Spill regs 10..13 to make them available as work registers.
1961     __ kernel_crc32_1word(crc, data, dataLen, table, t0, t1, t2, t3, true);
1962     __ z_lmg(t0, t3, 1*8, Z_SP);         // Spill regs 10..13 back from stack.
1963 
1964     // Restore caller sp for c2i case.
1965     __ resize_frame_absolute(Z_R10, Z_R0, true); // Cut the stack back to where the caller started.
1966 
1967     __ z_br(Z_R14);
1968 
1969     BLOCK_COMMENT(&quot;} CRC32_update{Bytes|ByteBuffer}&quot;);
1970 
1971     // Use a previously generated vanilla native entry as the slow path.
1972     BIND(slow_path);
1973     __ jump_to_entry(Interpreter::entry_for_kind(Interpreter::native), Z_R1);
1974     return __ addr_at(entry_off);
1975   }
1976 
1977   return NULL;
1978 }
1979 
1980 
1981 /**
1982  * Method entry for intrinsic-candidate (non-native) methods:
1983  *   int java.util.zip.CRC32C.updateBytes(           int crc, byte[] b,  int off, int end)
1984  *   int java.util.zip.CRC32C.updateDirectByteBuffer(int crc, long* buf, int off, int end)
1985  * Unlike CRC32, CRC32C does not have any methods marked as native
1986  * CRC32C also uses an &quot;end&quot; variable instead of the length variable CRC32 uses
1987  */
1988 address TemplateInterpreterGenerator::generate_CRC32C_updateBytes_entry(AbstractInterpreter::MethodKind kind) {
1989 
1990   if (UseCRC32CIntrinsics) {
1991     uint64_t entry_off = __ offset();
1992 
1993     // We don&#39;t generate local frame and don&#39;t align stack because
1994     // we call stub code and there is no safepoint on this path.
1995 
1996     // Load parameters.
1997     // Z_esp is callers operand stack pointer, i.e. it points to the parameters.
1998     const Register argP    = Z_esp;
1999     const Register crc     = Z_ARG1;  // crc value
2000     const Register data    = Z_ARG2;  // address of java byte array
2001     const Register dataLen = Z_ARG3;  // source data len
2002     const Register table   = Z_ARG4;  // address of crc32 table
2003     const Register t0      = Z_R10;   // work reg for kernel* emitters
2004     const Register t1      = Z_R11;   // work reg for kernel* emitters
2005     const Register t2      = Z_R12;   // work reg for kernel* emitters
2006     const Register t3      = Z_R13;   // work reg for kernel* emitters
2007 
2008     // Arguments are reversed on java expression stack.
2009     // Calculate address of start element.
2010     if (kind == Interpreter::java_util_zip_CRC32C_updateDirectByteBuffer) { // Used for &quot;updateByteBuffer direct&quot;.
2011       // crc     @ (SP + 5W) (32bit)
2012       // buf     @ (SP + 3W) (64bit ptr to long array)
2013       // off     @ (SP + 2W) (32bit)
2014       // dataLen @ (SP + 1W) (32bit)
2015       // data = buf + off
2016       BLOCK_COMMENT(&quot;CRC32C_updateDirectByteBuffer {&quot;);
2017       __ z_llgf(crc,    5*wordSize, argP);  // current crc state
2018       __ z_lg(data,     3*wordSize, argP);  // start of byte buffer
2019       __ z_agf(data,    2*wordSize, argP);  // Add byte buffer offset.
2020       __ z_lgf(dataLen, 1*wordSize, argP);  // #bytes to process, calculated as
2021       __ z_sgf(dataLen, Address(argP, 2*wordSize));  // (end_index - offset)
2022     } else {                                                                // Used for &quot;updateBytes update&quot;.
2023       // crc     @ (SP + 4W) (32bit)
2024       // buf     @ (SP + 3W) (64bit ptr to byte array)
2025       // off     @ (SP + 2W) (32bit)
2026       // dataLen @ (SP + 1W) (32bit)
2027       // data = buf + off + base_offset
2028       BLOCK_COMMENT(&quot;CRC32C_updateBytes {&quot;);
2029       __ z_llgf(crc,    4*wordSize, argP);  // current crc state
2030       __ z_lg(data,     3*wordSize, argP);  // start of byte buffer
2031       __ z_agf(data,    2*wordSize, argP);  // Add byte buffer offset.
2032       __ z_lgf(dataLen, 1*wordSize, argP);  // #bytes to process, calculated as
2033       __ z_sgf(dataLen, Address(argP, 2*wordSize));  // (end_index - offset)
2034       __ z_aghi(data, arrayOopDesc::base_offset_in_bytes(T_BYTE));
2035     }
2036 
2037     StubRoutines::zarch::generate_load_crc32c_table_addr(_masm, table);
2038 
2039     __ resize_frame(-(6*8), Z_R0, true); // Resize frame to provide add&#39;l space to spill 5 registers.
2040     __ z_stmg(t0, t3, 1*8, Z_SP);        // Spill regs 10..13 to make them available as work registers.
2041     __ kernel_crc32_1word(crc, data, dataLen, table, t0, t1, t2, t3, false);
2042     __ z_lmg(t0, t3, 1*8, Z_SP);         // Spill regs 10..13 back from stack.
2043 
2044     // Restore caller sp for c2i case.
2045     __ resize_frame_absolute(Z_R10, Z_R0, true); // Cut the stack back to where the caller started.
2046 
2047     __ z_br(Z_R14);
2048 
2049     BLOCK_COMMENT(&quot;} CRC32C_update{Bytes|DirectByteBuffer}&quot;);
2050     return __ addr_at(entry_off);
2051   }
2052 
2053   return NULL;
2054 }
2055 
2056 void TemplateInterpreterGenerator::bang_stack_shadow_pages(bool native_call) {
2057   // Quick &amp; dirty stack overflow checking: bang the stack &amp; handle trap.
2058   // Note that we do the banging after the frame is setup, since the exception
2059   // handling code expects to find a valid interpreter frame on the stack.
2060   // Doing the banging earlier fails if the caller frame is not an interpreter
2061   // frame.
2062   // (Also, the exception throwing code expects to unlock any synchronized
2063   // method receiver, so do the banging after locking the receiver.)
2064 
2065   // Bang each page in the shadow zone. We can&#39;t assume it&#39;s been done for
2066   // an interpreter frame with greater than a page of locals, so each page
2067   // needs to be checked. Only true for non-native. For native, we only bang the last page.
2068   if (UseStackBanging) {
2069     const int page_size      = os::vm_page_size();
2070     const int n_shadow_pages = (int)(JavaThread::stack_shadow_zone_size()/page_size);
2071     const int start_page_num = native_call ? n_shadow_pages : 1;
2072     for (int pages = start_page_num; pages &lt;= n_shadow_pages; pages++) {
2073       __ bang_stack_with_offset(pages*page_size);
2074     }
2075   }
2076 }
2077 
2078 //-----------------------------------------------------------------------------
2079 // Exceptions
2080 
2081 void TemplateInterpreterGenerator::generate_throw_exception() {
2082 
2083   BLOCK_COMMENT(&quot;throw_exception {&quot;);
2084 
2085   // Entry point in previous activation (i.e., if the caller was interpreted).
2086   Interpreter::_rethrow_exception_entry = __ pc();
2087   __ z_lg(Z_fp, _z_abi(callers_sp), Z_SP); // Frame accessors use Z_fp.
2088   // Z_ARG1 (==Z_tos): exception
2089   // Z_ARG2          : Return address/pc that threw exception.
2090   __ restore_bcp();    // R13 points to call/send.
2091   __ restore_locals();
2092 
2093   // Fallthrough, no need to restore Z_esp.
2094 
2095   // Entry point for exceptions thrown within interpreter code.
2096   Interpreter::_throw_exception_entry = __ pc();
2097   // Expression stack is undefined here.
2098   // Z_ARG1 (==Z_tos): exception
2099   // Z_bcp: exception bcp
2100   __ verify_oop(Z_ARG1);
2101   __ z_lgr(Z_ARG2, Z_ARG1);
2102 
2103   // Expression stack must be empty before entering the VM in case of
2104   // an exception.
2105   __ empty_expression_stack();
2106   // Find exception handler address and preserve exception oop.
2107   const Register Rpreserved_exc_oop = Z_tmp_1;
2108   __ call_VM(Rpreserved_exc_oop,
2109              CAST_FROM_FN_PTR(address, InterpreterRuntime::exception_handler_for_exception),
2110              Z_ARG2);
2111   // Z_RET: exception handler entry point
2112   // Z_bcp: bcp for exception handler
2113   __ push_ptr(Rpreserved_exc_oop); // Push exception which is now the only value on the stack.
2114   __ z_br(Z_RET); // Jump to exception handler (may be _remove_activation_entry!).
2115 
2116   // If the exception is not handled in the current frame the frame is
2117   // removed and the exception is rethrown (i.e. exception
2118   // continuation is _rethrow_exception).
2119   //
2120   // Note: At this point the bci is still the bci for the instruction
2121   // which caused the exception and the expression stack is
2122   // empty. Thus, for any VM calls at this point, GC will find a legal
2123   // oop map (with empty expression stack).
2124 
2125   //
2126   // JVMTI PopFrame support
2127   //
2128 
2129   Interpreter::_remove_activation_preserving_args_entry = __ pc();
2130   __ z_lg(Z_fp, _z_parent_ijava_frame_abi(callers_sp), Z_SP);
2131   __ empty_expression_stack();
2132   // Set the popframe_processing bit in pending_popframe_condition
2133   // indicating that we are currently handling popframe, so that
2134   // call_VMs that may happen later do not trigger new popframe
2135   // handling cycles.
2136   __ load_sized_value(Z_tmp_1, Address(Z_thread, JavaThread::popframe_condition_offset()), 4, false /*signed*/);
2137   __ z_oill(Z_tmp_1, JavaThread::popframe_processing_bit);
2138   __ z_sty(Z_tmp_1, thread_(popframe_condition));
2139 
2140   {
2141     // Check to see whether we are returning to a deoptimized frame.
2142     // (The PopFrame call ensures that the caller of the popped frame is
2143     // either interpreted or compiled and deoptimizes it if compiled.)
2144     // In this case, we can&#39;t call dispatch_next() after the frame is
2145     // popped, but instead must save the incoming arguments and restore
2146     // them after deoptimization has occurred.
2147     //
2148     // Note that we don&#39;t compare the return PC against the
2149     // deoptimization blob&#39;s unpack entry because of the presence of
2150     // adapter frames in C2.
2151     NearLabel caller_not_deoptimized;
2152     __ z_lg(Z_ARG1, _z_parent_ijava_frame_abi(return_pc), Z_fp);
2153     __ call_VM_leaf(CAST_FROM_FN_PTR(address, InterpreterRuntime::interpreter_contains), Z_ARG1);
2154     __ compareU64_and_branch(Z_RET, (intptr_t)0, Assembler::bcondNotEqual, caller_not_deoptimized);
2155 
2156     // Compute size of arguments for saving when returning to
2157     // deoptimized caller.
2158     __ get_method(Z_ARG2);
2159     __ z_lg(Z_ARG2, Address(Z_ARG2, Method::const_offset()));
2160     __ z_llgh(Z_ARG2, Address(Z_ARG2, ConstMethod::size_of_parameters_offset()));
2161     __ z_sllg(Z_ARG2, Z_ARG2, Interpreter::logStackElementSize); // slots 2 bytes
2162     __ restore_locals();
2163     // Compute address of args to be saved.
2164     __ z_lgr(Z_ARG3, Z_locals);
2165     __ z_slgr(Z_ARG3, Z_ARG2);
2166     __ add2reg(Z_ARG3, wordSize);
2167     // Save these arguments.
2168     __ call_VM_leaf(CAST_FROM_FN_PTR(address, Deoptimization::popframe_preserve_args),
2169                     Z_thread, Z_ARG2, Z_ARG3);
2170 
2171     __ remove_activation(vtos, Z_R14,
2172                          /* throw_monitor_exception */ false,
2173                          /* install_monitor_exception */ false,
2174                          /* notify_jvmdi */ false);
2175 
2176     // Inform deoptimization that it is responsible for restoring
2177     // these arguments.
2178     __ store_const(thread_(popframe_condition),
2179                    JavaThread::popframe_force_deopt_reexecution_bit,
2180                    Z_tmp_1, false);
2181 
2182     // Continue in deoptimization handler.
2183     __ z_br(Z_R14);
2184 
2185     __ bind(caller_not_deoptimized);
2186   }
2187 
2188   // Clear the popframe condition flag.
2189   __ clear_mem(thread_(popframe_condition), sizeof(int));
2190 
2191   __ remove_activation(vtos,
2192                        noreg,  // Retaddr is not used.
2193                        false,  // throw_monitor_exception
2194                        false,  // install_monitor_exception
2195                        false); // notify_jvmdi
2196   __ z_lg(Z_fp, _z_abi(callers_sp), Z_SP); // Restore frame pointer.
2197   __ restore_bcp();
2198   __ restore_locals();
2199   __ restore_esp();
2200   // The method data pointer was incremented already during
2201   // call profiling. We have to restore the mdp for the current bcp.
2202   if (ProfileInterpreter) {
2203     __ set_method_data_pointer_for_bcp();
2204   }
2205 #if INCLUDE_JVMTI
2206   {
2207     Label L_done;
2208 
2209     __ z_cli(0, Z_bcp, Bytecodes::_invokestatic);
2210     __ z_brc(Assembler::bcondNotEqual, L_done);
2211 
2212     // The member name argument must be restored if _invokestatic is
2213     // re-executed after a PopFrame call.  Detect such a case in the
2214     // InterpreterRuntime function and return the member name
2215     // argument, or NULL.
2216     __ z_lg(Z_ARG2, Address(Z_locals));
2217     __ get_method(Z_ARG3);
2218     __ call_VM(Z_tmp_1,
2219                CAST_FROM_FN_PTR(address, InterpreterRuntime::member_name_arg_or_null),
2220                Z_ARG2, Z_ARG3, Z_bcp);
2221 
2222     __ z_ltgr(Z_tmp_1, Z_tmp_1);
2223     __ z_brc(Assembler::bcondEqual, L_done);
2224 
2225     __ z_stg(Z_tmp_1, Address(Z_esp, wordSize));
2226     __ bind(L_done);
2227   }
2228 #endif // INCLUDE_JVMTI
2229   __ dispatch_next(vtos);
2230   // End of PopFrame support.
2231   Interpreter::_remove_activation_entry = __ pc();
2232 
2233   // In between activations - previous activation type unknown yet
2234   // compute continuation point - the continuation point expects the
2235   // following registers set up:
2236   //
2237   // Z_ARG1 (==Z_tos): exception
2238   // Z_ARG2          : return address/pc that threw exception
2239 
2240   Register return_pc = Z_tmp_1;
2241   Register handler   = Z_tmp_2;
2242    assert(return_pc-&gt;is_nonvolatile(), &quot;use non-volatile reg. to preserve exception pc&quot;);
2243    assert(handler-&gt;is_nonvolatile(),   &quot;use non-volatile reg. to handler pc&quot;);
2244   __ asm_assert_ijava_state_magic(return_pc/*tmp*/); // The top frame should be an interpreter frame.
2245   __ z_lg(return_pc, _z_parent_ijava_frame_abi(return_pc), Z_fp);
2246 
2247   // Moved removing the activation after VM call, because the new top
2248   // frame does not necessarily have the z_abi_160 required for a VM
2249   // call (e.g. if it is compiled).
2250 
2251   __ super_call_VM_leaf(CAST_FROM_FN_PTR(address,
2252                                          SharedRuntime::exception_handler_for_return_address),
2253                         Z_thread, return_pc);
2254   __ z_lgr(handler, Z_RET); // Save exception handler.
2255 
2256   // Preserve exception over this code sequence.
2257   __ pop_ptr(Z_ARG1);
2258   __ set_vm_result(Z_ARG1);
2259   // Remove the activation (without doing throws on illegalMonitorExceptions).
2260   __ remove_activation(vtos, noreg/*ret.pc already loaded*/, false/*throw exc*/, true/*install exc*/, false/*notify jvmti*/);
2261   __ z_lg(Z_fp, _z_abi(callers_sp), Z_SP); // Restore frame pointer.
2262 
2263   __ get_vm_result(Z_ARG1);     // Restore exception.
2264   __ verify_oop(Z_ARG1);
2265   __ z_lgr(Z_ARG2, return_pc);  // Restore return address.
2266 
2267 #ifdef ASSERT
2268   // The return_pc in the new top frame is dead... at least that&#39;s my
2269   // current understanding. To assert this I overwrite it.
2270   // Note: for compiled frames the handler is the deopt blob
2271   // which writes Z_ARG2 into the return_pc slot.
2272   __ load_const_optimized(return_pc, 0xb00b1);
2273   __ z_stg(return_pc, _z_parent_ijava_frame_abi(return_pc), Z_SP);
2274 #endif
2275 
2276   // Z_ARG1 (==Z_tos): exception
2277   // Z_ARG2          : return address/pc that threw exception
2278 
2279   // Note that an &quot;issuing PC&quot; is actually the next PC after the call.
2280   __ z_br(handler);         // Jump to exception handler of caller.
2281 
2282   BLOCK_COMMENT(&quot;} throw_exception&quot;);
2283 }
2284 
2285 //
2286 // JVMTI ForceEarlyReturn support
2287 //
2288 address TemplateInterpreterGenerator::generate_earlyret_entry_for (TosState state) {
2289   address entry = __ pc();
2290 
2291   BLOCK_COMMENT(&quot;earlyret_entry {&quot;);
2292 
2293   __ z_lg(Z_fp, _z_parent_ijava_frame_abi(callers_sp), Z_SP);
2294   __ restore_bcp();
2295   __ restore_locals();
2296   __ restore_esp();
2297   __ empty_expression_stack();
2298   __ load_earlyret_value(state);
2299 
2300   Register RjvmtiState = Z_tmp_1;
2301   __ z_lg(RjvmtiState, thread_(jvmti_thread_state));
2302   __ store_const(Address(RjvmtiState, JvmtiThreadState::earlyret_state_offset()),
2303                  JvmtiThreadState::earlyret_inactive, 4, 4, Z_R0_scratch);
2304 
2305   if (state == itos) {
2306     // Narrow result if state is itos but result type is smaller.
2307     // Need to narrow in the return bytecode rather than in generate_return_entry
2308     // since compiled code callers expect the result to already be narrowed.
2309     __ narrow(Z_tos, Z_tmp_1); /* fall through */
2310   }
2311   __ remove_activation(state,
2312                        Z_tmp_1, // retaddr
2313                        false,   // throw_monitor_exception
2314                        false,   // install_monitor_exception
2315                        true);   // notify_jvmdi
2316   __ z_br(Z_tmp_1);
2317 
2318   BLOCK_COMMENT(&quot;} earlyret_entry&quot;);
2319 
2320   return entry;
2321 }
2322 
2323 //-----------------------------------------------------------------------------
2324 // Helper for vtos entry point generation.
2325 
2326 void TemplateInterpreterGenerator::set_vtos_entry_points(Template* t,
2327                                                          address&amp; bep,
2328                                                          address&amp; cep,
2329                                                          address&amp; sep,
2330                                                          address&amp; aep,
2331                                                          address&amp; iep,
2332                                                          address&amp; lep,
2333                                                          address&amp; fep,
2334                                                          address&amp; dep,
2335                                                          address&amp; vep) {
2336   assert(t-&gt;is_valid() &amp;&amp; t-&gt;tos_in() == vtos, &quot;illegal template&quot;);
2337   Label L;
2338   aep = __ pc(); __ push_ptr(); __ z_bru(L);
2339   fep = __ pc(); __ push_f();   __ z_bru(L);
2340   dep = __ pc(); __ push_d();   __ z_bru(L);
2341   lep = __ pc(); __ push_l();   __ z_bru(L);
2342   bep = cep = sep =
2343   iep = __ pc(); __ push_i();
2344   vep = __ pc();
2345   __ bind(L);
2346   generate_and_dispatch(t);
2347 }
2348 
2349 //-----------------------------------------------------------------------------
2350 
2351 #ifndef PRODUCT
2352 address TemplateInterpreterGenerator::generate_trace_code(TosState state) {
2353   address entry = __ pc();
2354   NearLabel counter_below_trace_threshold;
2355 
2356   if (TraceBytecodesAt &gt; 0) {
2357     // Skip runtime call, if the trace threshold is not yet reached.
2358     __ load_absolute_address(Z_tmp_1, (address)&amp;BytecodeCounter::_counter_value);
2359     __ load_absolute_address(Z_tmp_2, (address)&amp;TraceBytecodesAt);
2360     __ load_sized_value(Z_tmp_1, Address(Z_tmp_1), 4, false /*signed*/);
2361     __ load_sized_value(Z_tmp_2, Address(Z_tmp_2), 8, false /*signed*/);
2362     __ compareU64_and_branch(Z_tmp_1, Z_tmp_2, Assembler::bcondLow, counter_below_trace_threshold);
2363   }
2364 
2365   int offset2 = state == ltos || state == dtos ? 2 : 1;
2366 
2367   __ push(state);
2368   // Preserved return pointer is in Z_R14.
2369   // InterpreterRuntime::trace_bytecode() preserved and returns the value passed as second argument.
2370   __ z_lgr(Z_ARG2, Z_R14);
2371   __ z_lg(Z_ARG3, Address(Z_esp, Interpreter::expr_offset_in_bytes(0)));
2372   if (WizardMode) {
2373     __ z_lgr(Z_ARG4, Z_esp); // Trace Z_esp in WizardMode.
2374   } else {
2375     __ z_lg(Z_ARG4, Address(Z_esp, Interpreter::expr_offset_in_bytes(offset2)));
2376   }
2377   __ call_VM(noreg, CAST_FROM_FN_PTR(address, InterpreterRuntime::trace_bytecode), Z_ARG2, Z_ARG3, Z_ARG4);
2378   __ z_lgr(Z_R14, Z_RET); // Estore return address (see above).
2379   __ pop(state);
2380 
2381   __ bind(counter_below_trace_threshold);
2382   __ z_br(Z_R14); // return
2383 
2384   return entry;
2385 }
2386 
2387 // Make feasible for old CPUs.
2388 void TemplateInterpreterGenerator::count_bytecode() {
2389   __ load_absolute_address(Z_R1_scratch, (address) &amp;BytecodeCounter::_counter_value);
2390   __ add2mem_32(Address(Z_R1_scratch), 1, Z_R0_scratch);
2391 }
2392 
2393 void TemplateInterpreterGenerator::histogram_bytecode(Template * t) {
2394   __ load_absolute_address(Z_R1_scratch, (address)&amp;BytecodeHistogram::_counters[ t-&gt;bytecode() ]);
2395   __ add2mem_32(Address(Z_R1_scratch), 1, Z_tmp_1);
2396 }
2397 
2398 void TemplateInterpreterGenerator::histogram_bytecode_pair(Template * t) {
2399   Address  index_addr(Z_tmp_1, (intptr_t) 0);
2400   Register index = Z_tmp_2;
2401 
2402   // Load previous index.
2403   __ load_absolute_address(Z_tmp_1, (address) &amp;BytecodePairHistogram::_index);
2404   __ mem2reg_opt(index, index_addr, false);
2405 
2406   // Mask with current bytecode and store as new previous index.
2407   __ z_srl(index, BytecodePairHistogram::log2_number_of_codes);
2408   __ load_const_optimized(Z_R0_scratch,
2409                           (int)t-&gt;bytecode() &lt;&lt; BytecodePairHistogram::log2_number_of_codes);
2410   __ z_or(index, Z_R0_scratch);
2411   __ reg2mem_opt(index, index_addr, false);
2412 
2413   // Load counter array&#39;s address.
2414   __ z_lgfr(index, index);   // Sign extend for addressing.
2415   __ z_sllg(index, index, LogBytesPerInt);  // index2bytes
2416   __ load_absolute_address(Z_R1_scratch,
2417                            (address) &amp;BytecodePairHistogram::_counters);
2418   // Add index and increment counter.
2419   __ z_agr(Z_R1_scratch, index);
2420   __ add2mem_32(Address(Z_R1_scratch), 1, Z_tmp_1);
2421 }
2422 
2423 void TemplateInterpreterGenerator::trace_bytecode(Template* t) {
2424   // Call a little run-time stub to avoid blow-up for each bytecode.
2425   // The run-time runtime saves the right registers, depending on
2426   // the tosca in-state for the given template.
2427   address entry = Interpreter::trace_code(t-&gt;tos_in());
2428   guarantee(entry != NULL, &quot;entry must have been generated&quot;);
2429   __ call_stub(entry);
2430 }
2431 
2432 void TemplateInterpreterGenerator::stop_interpreter_at() {
2433   NearLabel L;
2434 
2435   __ load_absolute_address(Z_tmp_1, (address)&amp;BytecodeCounter::_counter_value);
2436   __ load_absolute_address(Z_tmp_2, (address)&amp;StopInterpreterAt);
2437   __ load_sized_value(Z_tmp_1, Address(Z_tmp_1), 4, false /*signed*/);
2438   __ load_sized_value(Z_tmp_2, Address(Z_tmp_2), 8, false /*signed*/);
2439   __ compareU64_and_branch(Z_tmp_1, Z_tmp_2, Assembler::bcondLow, L);
2440   assert(Z_tmp_1-&gt;is_nonvolatile(), &quot;must be nonvolatile to preserve Z_tos&quot;);
2441   assert(Z_F8-&gt;is_nonvolatile(), &quot;must be nonvolatile to preserve Z_ftos&quot;);
2442   __ z_lgr(Z_tmp_1, Z_tos);      // Save tos.
2443   __ z_lgr(Z_tmp_2, Z_bytecode); // Save Z_bytecode.
2444   __ z_ldr(Z_F8, Z_ftos);        // Save ftos.
2445   // Use -XX:StopInterpreterAt=&lt;num&gt; to set the limit
2446   // and break at breakpoint().
2447   __ call_VM(noreg, CAST_FROM_FN_PTR(address, breakpoint), false);
2448   __ z_lgr(Z_tos, Z_tmp_1);      // Restore tos.
2449   __ z_lgr(Z_bytecode, Z_tmp_2); // Save Z_bytecode.
2450   __ z_ldr(Z_ftos, Z_F8);        // Restore ftos.
2451   __ bind(L);
2452 }
2453 
2454 #endif // !PRODUCT
    </pre>
  </body>
</html>