<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>New src/hotspot/share/memory/filemap.cpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
  </head>
  <body>
    <pre>
   1 /*
   2  * Copyright (c) 2003, 2020, Oracle and/or its affiliates. All rights reserved.
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.
   8  *
   9  * This code is distributed in the hope that it will be useful, but WITHOUT
  10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  *
  23  */
  24 
  25 #include &quot;precompiled.hpp&quot;
  26 #include &quot;jvm.h&quot;
  27 #include &quot;classfile/classFileStream.hpp&quot;
  28 #include &quot;classfile/classLoader.inline.hpp&quot;
  29 #include &quot;classfile/classLoaderData.inline.hpp&quot;
  30 #include &quot;classfile/classLoaderExt.hpp&quot;
  31 #include &quot;classfile/symbolTable.hpp&quot;
  32 #include &quot;classfile/systemDictionaryShared.hpp&quot;
  33 #include &quot;classfile/altHashing.hpp&quot;
  34 #include &quot;logging/log.hpp&quot;
  35 #include &quot;logging/logStream.hpp&quot;
  36 #include &quot;logging/logMessage.hpp&quot;
  37 #include &quot;memory/archiveUtils.inline.hpp&quot;
  38 #include &quot;memory/dynamicArchive.hpp&quot;
  39 #include &quot;memory/filemap.hpp&quot;
  40 #include &quot;memory/heapShared.inline.hpp&quot;
  41 #include &quot;memory/iterator.inline.hpp&quot;
  42 #include &quot;memory/metadataFactory.hpp&quot;
  43 #include &quot;memory/metaspaceClosure.hpp&quot;
  44 #include &quot;memory/metaspaceShared.hpp&quot;
  45 #include &quot;memory/oopFactory.hpp&quot;
  46 #include &quot;memory/universe.hpp&quot;
  47 #include &quot;oops/compressedOops.hpp&quot;
  48 #include &quot;oops/compressedOops.inline.hpp&quot;
  49 #include &quot;oops/objArrayOop.hpp&quot;
  50 #include &quot;oops/oop.inline.hpp&quot;
  51 #include &quot;prims/jvmtiExport.hpp&quot;
  52 #include &quot;runtime/arguments.hpp&quot;
  53 #include &quot;runtime/java.hpp&quot;
  54 #include &quot;runtime/mutexLocker.hpp&quot;
  55 #include &quot;runtime/os.inline.hpp&quot;
  56 #include &quot;runtime/vm_version.hpp&quot;
  57 #include &quot;services/memTracker.hpp&quot;
  58 #include &quot;utilities/align.hpp&quot;
  59 #include &quot;utilities/bitMap.inline.hpp&quot;
  60 #include &quot;utilities/classpathStream.hpp&quot;
  61 #include &quot;utilities/defaultStream.hpp&quot;
  62 #if INCLUDE_G1GC
  63 #include &quot;gc/g1/g1CollectedHeap.hpp&quot;
  64 #include &quot;gc/g1/heapRegion.hpp&quot;
  65 #endif
  66 
  67 # include &lt;sys/stat.h&gt;
  68 # include &lt;errno.h&gt;
  69 
  70 #ifndef O_BINARY       // if defined (Win32) use binary files.
  71 #define O_BINARY 0     // otherwise do nothing.
  72 #endif
  73 
  74 // Complain and stop. All error conditions occurring during the writing of
  75 // an archive file should stop the process.  Unrecoverable errors during
  76 // the reading of the archive file should stop the process.
  77 
  78 static void fail_exit(const char *msg, va_list ap) {
  79   // This occurs very early during initialization: tty is not initialized.
  80   jio_fprintf(defaultStream::error_stream(),
  81               &quot;An error has occurred while processing the&quot;
  82               &quot; shared archive file.\n&quot;);
  83   jio_vfprintf(defaultStream::error_stream(), msg, ap);
  84   jio_fprintf(defaultStream::error_stream(), &quot;\n&quot;);
  85   // Do not change the text of the below message because some tests check for it.
  86   vm_exit_during_initialization(&quot;Unable to use shared archive.&quot;, NULL);
  87 }
  88 
  89 
  90 void FileMapInfo::fail_stop(const char *msg, ...) {
  91         va_list ap;
  92   va_start(ap, msg);
  93   fail_exit(msg, ap);   // Never returns.
  94   va_end(ap);           // for completeness.
  95 }
  96 
  97 
  98 // Complain and continue.  Recoverable errors during the reading of the
  99 // archive file may continue (with sharing disabled).
 100 //
 101 // If we continue, then disable shared spaces and close the file.
 102 
 103 void FileMapInfo::fail_continue(const char *msg, ...) {
 104   va_list ap;
 105   va_start(ap, msg);
 106   if (PrintSharedArchiveAndExit &amp;&amp; _validating_shared_path_table) {
 107     // If we are doing PrintSharedArchiveAndExit and some of the classpath entries
 108     // do not validate, we can still continue &quot;limping&quot; to validate the remaining
 109     // entries. No need to quit.
 110     tty-&gt;print(&quot;[&quot;);
 111     tty-&gt;vprint(msg, ap);
 112     tty-&gt;print_cr(&quot;]&quot;);
 113   } else {
 114     if (RequireSharedSpaces) {
 115       fail_exit(msg, ap);
 116     } else {
 117       if (log_is_enabled(Info, cds)) {
 118         ResourceMark rm;
 119         LogStream ls(Log(cds)::info());
 120         ls.print(&quot;UseSharedSpaces: &quot;);
 121         ls.vprint_cr(msg, ap);
 122       }
 123     }
 124   }
 125   va_end(ap);
 126 }
 127 
 128 // Fill in the fileMapInfo structure with data about this VM instance.
 129 
 130 // This method copies the vm version info into header_version.  If the version is too
 131 // long then a truncated version, which has a hash code appended to it, is copied.
 132 //
 133 // Using a template enables this method to verify that header_version is an array of
 134 // length JVM_IDENT_MAX.  This ensures that the code that writes to the CDS file and
 135 // the code that reads the CDS file will both use the same size buffer.  Hence, will
 136 // use identical truncation.  This is necessary for matching of truncated versions.
 137 template &lt;int N&gt; static void get_header_version(char (&amp;header_version) [N]) {
 138   assert(N == JVM_IDENT_MAX, &quot;Bad header_version size&quot;);
 139 
 140   const char *vm_version = VM_Version::internal_vm_info_string();
 141   const int version_len = (int)strlen(vm_version);
 142 
 143   memset(header_version, 0, JVM_IDENT_MAX);
 144 
 145   if (version_len &lt; (JVM_IDENT_MAX-1)) {
 146     strcpy(header_version, vm_version);
 147 
 148   } else {
 149     // Get the hash value.  Use a static seed because the hash needs to return the same
 150     // value over multiple jvm invocations.
 151     unsigned int hash = AltHashing::murmur3_32(8191, (const jbyte*)vm_version, version_len);
 152 
 153     // Truncate the ident, saving room for the 8 hex character hash value.
 154     strncpy(header_version, vm_version, JVM_IDENT_MAX-9);
 155 
 156     // Append the hash code as eight hex digits.
 157     sprintf(&amp;header_version[JVM_IDENT_MAX-9], &quot;%08x&quot;, hash);
 158     header_version[JVM_IDENT_MAX-1] = 0;  // Null terminate.
 159   }
 160 
 161   assert(header_version[JVM_IDENT_MAX-1] == 0, &quot;must be&quot;);
 162 }
 163 
 164 FileMapInfo::FileMapInfo(bool is_static) {
 165   memset((void*)this, 0, sizeof(FileMapInfo));
 166   _is_static = is_static;
 167   size_t header_size;
 168   if (is_static) {
 169     assert(_current_info == NULL, &quot;must be singleton&quot;); // not thread safe
 170     _current_info = this;
 171     header_size = sizeof(FileMapHeader);
 172   } else {
 173     assert(_dynamic_archive_info == NULL, &quot;must be singleton&quot;); // not thread safe
 174     _dynamic_archive_info = this;
 175     header_size = sizeof(DynamicArchiveHeader);
 176   }
 177   _header = (FileMapHeader*)os::malloc(header_size, mtInternal);
 178   memset((void*)_header, 0, header_size);
 179   _header-&gt;set_header_size(header_size);
 180   _header-&gt;set_version(INVALID_CDS_ARCHIVE_VERSION);
 181   _header-&gt;set_has_platform_or_app_classes(true);
 182   _file_offset = 0;
 183   _file_open = false;
 184 }
 185 
 186 FileMapInfo::~FileMapInfo() {
 187   if (_is_static) {
 188     assert(_current_info == this, &quot;must be singleton&quot;); // not thread safe
 189     _current_info = NULL;
 190   } else {
 191     assert(_dynamic_archive_info == this, &quot;must be singleton&quot;); // not thread safe
 192     _dynamic_archive_info = NULL;
 193   }
 194 }
 195 
 196 void FileMapInfo::populate_header(size_t alignment) {
 197   header()-&gt;populate(this, alignment);
 198 }
 199 
 200 void FileMapHeader::populate(FileMapInfo* mapinfo, size_t alignment) {
 201   if (DynamicDumpSharedSpaces) {
 202     _magic = CDS_DYNAMIC_ARCHIVE_MAGIC;
 203   } else {
 204     _magic = CDS_ARCHIVE_MAGIC;
 205   }
 206   _version = CURRENT_CDS_ARCHIVE_VERSION;
 207   _alignment = alignment;
 208   _obj_alignment = ObjectAlignmentInBytes;
 209   _compact_strings = CompactStrings;
 210   if (HeapShared::is_heap_object_archiving_allowed()) {
 211     _narrow_oop_mode = CompressedOops::mode();
 212     _narrow_oop_base = CompressedOops::base();
 213     _narrow_oop_shift = CompressedOops::shift();
 214     _heap_end = CompressedOops::end();
 215   }
 216   _compressed_oops = UseCompressedOops;
 217   _compressed_class_ptrs = UseCompressedClassPointers;
 218   _max_heap_size = MaxHeapSize;
 219   _narrow_klass_shift = CompressedKlassPointers::shift();
 220   _use_optimized_module_handling = MetaspaceShared::use_optimized_module_handling();
 221 
 222   // The following fields are for sanity checks for whether this archive
 223   // will function correctly with this JVM and the bootclasspath it&#39;s
 224   // invoked with.
 225 
 226   // JVM version string ... changes on each build.
 227   get_header_version(_jvm_ident);
 228 
 229   _app_class_paths_start_index = ClassLoaderExt::app_class_paths_start_index();
 230   _app_module_paths_start_index = ClassLoaderExt::app_module_paths_start_index();
 231   _num_module_paths = ClassLoader::num_module_path_entries();
 232   _max_used_path_index = ClassLoaderExt::max_used_path_index();
 233 
 234   _verify_local = BytecodeVerificationLocal;
 235   _verify_remote = BytecodeVerificationRemote;
 236   _has_platform_or_app_classes = ClassLoaderExt::has_platform_or_app_classes();
 237   _requested_base_address = (char*)SharedBaseAddress;
 238   _mapped_base_address = (char*)SharedBaseAddress;
 239   _allow_archiving_with_java_agent = AllowArchivingWithJavaAgent;
 240   // the following 2 fields will be set in write_header for dynamic archive header
 241   _base_archive_name_size = 0;
 242   _base_archive_is_default = false;
 243 
 244   if (!DynamicDumpSharedSpaces) {
 245     set_shared_path_table(mapinfo-&gt;_shared_path_table);
 246   }
 247 }
 248 
 249 void SharedClassPathEntry::init_as_non_existent(const char* path, TRAPS) {
 250   _type = non_existent_entry;
 251   set_name(path, THREAD);
 252 }
 253 
 254 void SharedClassPathEntry::init(bool is_modules_image,
 255                                 bool is_module_path,
 256                                 ClassPathEntry* cpe, TRAPS) {
 257   Arguments::assert_is_dumping_archive();
 258   _timestamp = 0;
 259   _filesize  = 0;
 260   _from_class_path_attr = false;
 261 
 262   struct stat st;
 263   if (os::stat(cpe-&gt;name(), &amp;st) == 0) {
 264     if ((st.st_mode &amp; S_IFMT) == S_IFDIR) {
 265       _type = dir_entry;
 266     } else {
 267       // The timestamp of the modules_image is not checked at runtime.
 268       if (is_modules_image) {
 269         _type = modules_image_entry;
 270       } else {
 271         _type = jar_entry;
 272         _timestamp = st.st_mtime;
 273         _from_class_path_attr = cpe-&gt;from_class_path_attr();
 274       }
 275       _filesize = st.st_size;
 276       _is_module_path = is_module_path;
 277     }
 278   } else {
 279     // The file/dir must exist, or it would not have been added
 280     // into ClassLoader::classpath_entry().
 281     //
 282     // If we can&#39;t access a jar file in the boot path, then we can&#39;t
 283     // make assumptions about where classes get loaded from.
 284     FileMapInfo::fail_stop(&quot;Unable to open file %s.&quot;, cpe-&gt;name());
 285   }
 286 
 287   // No need to save the name of the module file, as it will be computed at run time
 288   // to allow relocation of the JDK directory.
 289   const char* name = is_modules_image  ? &quot;&quot; : cpe-&gt;name();
 290   set_name(name, THREAD);
 291 }
 292 
 293 void SharedClassPathEntry::set_name(const char* name, TRAPS) {
 294   size_t len = strlen(name) + 1;
 295   _name = MetadataFactory::new_array&lt;char&gt;(ClassLoaderData::the_null_class_loader_data(), (int)len, THREAD);
 296   strcpy(_name-&gt;data(), name);
 297 }
 298 
 299 void SharedClassPathEntry::copy_from(SharedClassPathEntry* ent, ClassLoaderData* loader_data, TRAPS) {
 300   _type = ent-&gt;_type;
 301   _is_module_path = ent-&gt;_is_module_path;
 302   _timestamp = ent-&gt;_timestamp;
 303   _filesize = ent-&gt;_filesize;
 304   _from_class_path_attr = ent-&gt;_from_class_path_attr;
 305   set_name(ent-&gt;name(), THREAD);
 306 
 307   if (ent-&gt;is_jar() &amp;&amp; !ent-&gt;is_signed() &amp;&amp; ent-&gt;manifest() != NULL) {
 308     Array&lt;u1&gt;* buf = MetadataFactory::new_array&lt;u1&gt;(loader_data,
 309                                                     ent-&gt;manifest_size(),
 310                                                     THREAD);
 311     char* p = (char*)(buf-&gt;data());
 312     memcpy(p, ent-&gt;manifest(), ent-&gt;manifest_size());
 313     set_manifest(buf);
 314   }
 315 }
 316 
 317 const char* SharedClassPathEntry::name() const {
 318   if (UseSharedSpaces &amp;&amp; is_modules_image()) {
 319     // In order to validate the runtime modules image file size against the archived
 320     // size information, we need to obtain the runtime modules image path. The recorded
 321     // dump time modules image path in the archive may be different from the runtime path
 322     // if the JDK image has beed moved after generating the archive.
 323     return ClassLoader::get_jrt_entry()-&gt;name();
 324   } else {
 325     return _name-&gt;data();
 326   }
 327 }
 328 
 329 bool SharedClassPathEntry::validate(bool is_class_path) const {
 330   assert(UseSharedSpaces, &quot;runtime only&quot;);
 331 
 332   struct stat st;
 333   const char* name = this-&gt;name();
 334 
 335   bool ok = true;
 336   log_info(class, path)(&quot;checking shared classpath entry: %s&quot;, name);
 337   if (os::stat(name, &amp;st) != 0 &amp;&amp; is_class_path) {
 338     // If the archived module path entry does not exist at runtime, it is not fatal
 339     // (no need to invalid the shared archive) because the shared runtime visibility check
 340     // filters out any archived module classes that do not have a matching runtime
 341     // module path location.
 342     FileMapInfo::fail_continue(&quot;Required classpath entry does not exist: %s&quot;, name);
 343     ok = false;
 344   } else if (is_dir()) {
 345     if (!os::dir_is_empty(name)) {
 346       FileMapInfo::fail_continue(&quot;directory is not empty: %s&quot;, name);
 347       ok = false;
 348     }
 349   } else if ((has_timestamp() &amp;&amp; _timestamp != st.st_mtime) ||
 350              _filesize != st.st_size) {
 351     ok = false;
 352     if (PrintSharedArchiveAndExit) {
 353       FileMapInfo::fail_continue(_timestamp != st.st_mtime ?
 354                                  &quot;Timestamp mismatch&quot; :
 355                                  &quot;File size mismatch&quot;);
 356     } else {
 357       FileMapInfo::fail_continue(&quot;A jar file is not the one used while building&quot;
 358                                  &quot; the shared archive file: %s&quot;, name);
 359     }
 360   }
 361 
 362   if (PrintSharedArchiveAndExit &amp;&amp; !ok) {
 363     // If PrintSharedArchiveAndExit is enabled, don&#39;t report failure to the
 364     // caller. Please see above comments for more details.
 365     ok = true;
 366     MetaspaceShared::set_archive_loading_failed();
 367   }
 368   return ok;
 369 }
 370 
 371 bool SharedClassPathEntry::check_non_existent() const {
 372   assert(_type == non_existent_entry, &quot;must be&quot;);
 373   log_info(class, path)(&quot;should be non-existent: %s&quot;, name());
 374   struct stat st;
 375   if (os::stat(name(), &amp;st) != 0) {
 376     log_info(class, path)(&quot;ok&quot;);
 377     return true; // file doesn&#39;t exist
 378   } else {
 379     return false;
 380   }
 381 }
 382 
 383 
 384 void SharedClassPathEntry::metaspace_pointers_do(MetaspaceClosure* it) {
 385   it-&gt;push(&amp;_name);
 386   it-&gt;push(&amp;_manifest);
 387 }
 388 
 389 void SharedPathTable::metaspace_pointers_do(MetaspaceClosure* it) {
 390   it-&gt;push(&amp;_table);
 391   for (int i=0; i&lt;_size; i++) {
 392     path_at(i)-&gt;metaspace_pointers_do(it);
 393   }
 394 }
 395 
 396 void SharedPathTable::dumptime_init(ClassLoaderData* loader_data, Thread* THREAD) {
 397   size_t entry_size = sizeof(SharedClassPathEntry);
 398   int num_entries = 0;
 399   num_entries += ClassLoader::num_boot_classpath_entries();
 400   num_entries += ClassLoader::num_app_classpath_entries();
 401   num_entries += ClassLoader::num_module_path_entries();
 402   num_entries += FileMapInfo::num_non_existent_class_paths();
 403   size_t bytes = entry_size * num_entries;
 404 
 405   _table = MetadataFactory::new_array&lt;u8&gt;(loader_data, (int)bytes, THREAD);
 406   _size = num_entries;
 407 }
 408 
 409 // Make a copy of the _shared_path_table for use during dynamic CDS dump.
 410 // It is needed because some Java code continues to execute after dynamic dump has finished.
 411 // However, during dynamic dump, we have modified FileMapInfo::_shared_path_table so
 412 // FileMapInfo::shared_path(i) returns incorrect information in ClassLoader::record_result().
 413 void FileMapInfo::copy_shared_path_table(ClassLoaderData* loader_data, Thread* THREAD) {
 414   size_t entry_size = sizeof(SharedClassPathEntry);
 415   size_t bytes = entry_size * _shared_path_table.size();
 416 
 417   _saved_shared_path_table = SharedPathTable(MetadataFactory::new_array&lt;u8&gt;(loader_data, (int)bytes, THREAD),
 418                                              _shared_path_table.size());
 419 
 420   for (int i = 0; i &lt; _shared_path_table.size(); i++) {
 421     _saved_shared_path_table.path_at(i)-&gt;copy_from(shared_path(i), loader_data, THREAD);
 422   }
 423 }
 424 
 425 void FileMapInfo::allocate_shared_path_table() {
 426   Arguments::assert_is_dumping_archive();
 427 
 428   EXCEPTION_MARK; // The following calls should never throw, but would exit VM on error.
 429   ClassLoaderData* loader_data = ClassLoaderData::the_null_class_loader_data();
 430   ClassPathEntry* jrt = ClassLoader::get_jrt_entry();
 431 
 432   assert(jrt != NULL,
 433          &quot;No modular java runtime image present when allocating the CDS classpath entry table&quot;);
 434 
 435   _shared_path_table.dumptime_init(loader_data, THREAD);
 436 
 437   // 1. boot class path
 438   int i = 0;
 439   i = add_shared_classpaths(i, &quot;boot&quot;,   jrt, THREAD);
 440   i = add_shared_classpaths(i, &quot;app&quot;,    ClassLoader::app_classpath_entries(), THREAD);
 441   i = add_shared_classpaths(i, &quot;module&quot;, ClassLoader::module_path_entries(), THREAD);
 442 
 443   for (int x = 0; x &lt; num_non_existent_class_paths(); x++, i++) {
 444     const char* path = _non_existent_class_paths-&gt;at(x);
 445     shared_path(i)-&gt;init_as_non_existent(path, THREAD);
 446   }
 447 
 448   assert(i == _shared_path_table.size(), &quot;number of shared path entry mismatch&quot;);
 449 
 450   copy_shared_path_table(loader_data, THREAD);
 451 }
 452 
 453 int FileMapInfo::add_shared_classpaths(int i, const char* which, ClassPathEntry *cpe, TRAPS) {
 454   while (cpe != NULL) {
 455     bool is_jrt = (cpe == ClassLoader::get_jrt_entry());
 456     bool is_module_path = i &gt;= ClassLoaderExt::app_module_paths_start_index();
 457     const char* type = (is_jrt ? &quot;jrt&quot; : (cpe-&gt;is_jar_file() ? &quot;jar&quot; : &quot;dir&quot;));
 458     log_info(class, path)(&quot;add %s shared path (%s) %s&quot;, which, type, cpe-&gt;name());
 459     SharedClassPathEntry* ent = shared_path(i);
 460     ent-&gt;init(is_jrt, is_module_path, cpe, THREAD);
 461     if (cpe-&gt;is_jar_file()) {
 462       update_jar_manifest(cpe, ent, THREAD);
 463     }
 464     if (is_jrt) {
 465       cpe = ClassLoader::get_next_boot_classpath_entry(cpe);
 466     } else {
 467       cpe = cpe-&gt;next();
 468     }
 469     i++;
 470   }
 471 
 472   return i;
 473 }
 474 
 475 void FileMapInfo::check_nonempty_dir_in_shared_path_table() {
 476   Arguments::assert_is_dumping_archive();
 477 
 478   bool has_nonempty_dir = false;
 479 
 480   int last = _shared_path_table.size() - 1;
 481   if (last &gt; ClassLoaderExt::max_used_path_index()) {
 482      // no need to check any path beyond max_used_path_index
 483      last = ClassLoaderExt::max_used_path_index();
 484   }
 485 
 486   for (int i = 0; i &lt;= last; i++) {
 487     SharedClassPathEntry *e = shared_path(i);
 488     if (e-&gt;is_dir()) {
 489       const char* path = e-&gt;name();
 490       if (!os::dir_is_empty(path)) {
 491         log_error(cds)(&quot;Error: non-empty directory &#39;%s&#39;&quot;, path);
 492         has_nonempty_dir = true;
 493       }
 494     }
 495   }
 496 
 497   if (has_nonempty_dir) {
 498     ClassLoader::exit_with_path_failure(&quot;Cannot have non-empty directory in paths&quot;, NULL);
 499   }
 500 }
 501 
 502 void FileMapInfo::record_non_existent_class_path_entry(const char* path) {
 503   Arguments::assert_is_dumping_archive();
 504   log_info(class, path)(&quot;non-existent Class-Path entry %s&quot;, path);
 505   if (_non_existent_class_paths == NULL) {
 506     _non_existent_class_paths = new (ResourceObj::C_HEAP, mtClass)GrowableArray&lt;const char*&gt;(10, mtClass);
 507   }
 508   _non_existent_class_paths-&gt;append(os::strdup(path));
 509 }
 510 
 511 int FileMapInfo::num_non_existent_class_paths() {
 512   Arguments::assert_is_dumping_archive();
 513   if (_non_existent_class_paths != NULL) {
 514     return _non_existent_class_paths-&gt;length();
 515   } else {
 516     return 0;
 517   }
 518 }
 519 
 520 int FileMapInfo::get_module_shared_path_index(Symbol* location) {
 521   if (location-&gt;starts_with(&quot;jrt:&quot;, 4) &amp;&amp; get_number_of_shared_paths() &gt; 0) {
 522     assert(shared_path(0)-&gt;is_modules_image(), &quot;first shared_path must be the modules image&quot;);
 523     return 0;
 524   }
 525 
 526   if (ClassLoaderExt::app_module_paths_start_index() &gt;= get_number_of_shared_paths()) {
 527     // The archive(s) were created without --module-path option
 528     return -1;
 529   }
 530 
 531   if (!location-&gt;starts_with(&quot;file:&quot;, 5)) {
 532     return -1;
 533   }
 534 
 535   // skip_uri_protocol was also called during dump time -- see ClassLoaderExt::process_module_table()
 536   ResourceMark rm;
 537   const char* file = ClassLoader::skip_uri_protocol(location-&gt;as_C_string());
 538   for (int i = ClassLoaderExt::app_module_paths_start_index(); i &lt; get_number_of_shared_paths(); i++) {
 539     SharedClassPathEntry* ent = shared_path(i);
 540     assert(ent-&gt;in_named_module(), &quot;must be&quot;);
 541     bool cond = strcmp(file, ent-&gt;name()) == 0;
 542     log_debug(class, path)(&quot;get_module_shared_path_index (%d) %s : %s = %s&quot;, i,
 543                            location-&gt;as_C_string(), ent-&gt;name(), cond ? &quot;same&quot; : &quot;different&quot;);
 544     if (cond) {
 545       return i;
 546     }
 547   }
 548 
 549   return -1;
 550 }
 551 
 552 class ManifestStream: public ResourceObj {
 553   private:
 554   u1*   _buffer_start; // Buffer bottom
 555   u1*   _buffer_end;   // Buffer top (one past last element)
 556   u1*   _current;      // Current buffer position
 557 
 558  public:
 559   // Constructor
 560   ManifestStream(u1* buffer, int length) : _buffer_start(buffer),
 561                                            _current(buffer) {
 562     _buffer_end = buffer + length;
 563   }
 564 
 565   static bool is_attr(u1* attr, const char* name) {
 566     return strncmp((const char*)attr, name, strlen(name)) == 0;
 567   }
 568 
 569   static char* copy_attr(u1* value, size_t len) {
 570     char* buf = NEW_RESOURCE_ARRAY(char, len + 1);
 571     strncpy(buf, (char*)value, len);
 572     buf[len] = 0;
 573     return buf;
 574   }
 575 
 576   // The return value indicates if the JAR is signed or not
 577   bool check_is_signed() {
 578     u1* attr = _current;
 579     bool isSigned = false;
 580     while (_current &lt; _buffer_end) {
 581       if (*_current == &#39;\n&#39;) {
 582         *_current = &#39;\0&#39;;
 583         u1* value = (u1*)strchr((char*)attr, &#39;:&#39;);
 584         if (value != NULL) {
 585           assert(*(value+1) == &#39; &#39;, &quot;Unrecognized format&quot; );
 586           if (strstr((char*)attr, &quot;-Digest&quot;) != NULL) {
 587             isSigned = true;
 588             break;
 589           }
 590         }
 591         *_current = &#39;\n&#39;; // restore
 592         attr = _current + 1;
 593       }
 594       _current ++;
 595     }
 596     return isSigned;
 597   }
 598 };
 599 
 600 void FileMapInfo::update_jar_manifest(ClassPathEntry *cpe, SharedClassPathEntry* ent, TRAPS) {
 601   ClassLoaderData* loader_data = ClassLoaderData::the_null_class_loader_data();
 602   ResourceMark rm(THREAD);
 603   jint manifest_size;
 604 
 605   assert(cpe-&gt;is_jar_file() &amp;&amp; ent-&gt;is_jar(), &quot;the shared class path entry is not a JAR file&quot;);
 606   char* manifest = ClassLoaderExt::read_manifest(cpe, &amp;manifest_size, CHECK);
 607   if (manifest != NULL) {
 608     ManifestStream* stream = new ManifestStream((u1*)manifest,
 609                                                 manifest_size);
 610     if (stream-&gt;check_is_signed()) {
 611       ent-&gt;set_is_signed();
 612     } else {
 613       // Copy the manifest into the shared archive
 614       manifest = ClassLoaderExt::read_raw_manifest(cpe, &amp;manifest_size, CHECK);
 615       Array&lt;u1&gt;* buf = MetadataFactory::new_array&lt;u1&gt;(loader_data,
 616                                                       manifest_size,
 617                                                       THREAD);
 618       char* p = (char*)(buf-&gt;data());
 619       memcpy(p, manifest, manifest_size);
 620       ent-&gt;set_manifest(buf);
 621     }
 622   }
 623 }
 624 
 625 char* FileMapInfo::skip_first_path_entry(const char* path) {
 626   size_t path_sep_len = strlen(os::path_separator());
 627   char* p = strstr((char*)path, os::path_separator());
 628   if (p != NULL) {
 629     debug_only( {
 630       size_t image_name_len = strlen(MODULES_IMAGE_NAME);
 631       assert(strncmp(p - image_name_len, MODULES_IMAGE_NAME, image_name_len) == 0,
 632              &quot;first entry must be the modules image&quot;);
 633     } );
 634     p += path_sep_len;
 635   } else {
 636     debug_only( {
 637       assert(ClassLoader::string_ends_with(path, MODULES_IMAGE_NAME),
 638              &quot;first entry must be the modules image&quot;);
 639     } );
 640   }
 641   return p;
 642 }
 643 
 644 int FileMapInfo::num_paths(const char* path) {
 645   if (path == NULL) {
 646     return 0;
 647   }
 648   int npaths = 1;
 649   char* p = (char*)path;
 650   while (p != NULL) {
 651     char* prev = p;
 652     p = strstr((char*)p, os::path_separator());
 653     if (p != NULL) {
 654       p++;
 655       // don&#39;t count empty path
 656       if ((p - prev) &gt; 1) {
 657        npaths++;
 658       }
 659     }
 660   }
 661   return npaths;
 662 }
 663 
 664 GrowableArray&lt;const char*&gt;* FileMapInfo::create_path_array(const char* paths) {
 665   GrowableArray&lt;const char*&gt;* path_array = new GrowableArray&lt;const char*&gt;(10);
 666 
 667   ClasspathStream cp_stream(paths);
 668   while (cp_stream.has_next()) {
 669     const char* path = cp_stream.get_next();
 670     struct stat st;
 671     if (os::stat(path, &amp;st) == 0) {
 672       path_array-&gt;append(path);
 673     }
 674   }
 675   return path_array;
 676 }
 677 
 678 bool FileMapInfo::classpath_failure(const char* msg, const char* name) {
 679   ClassLoader::trace_class_path(msg, name);
 680   if (PrintSharedArchiveAndExit) {
 681     MetaspaceShared::set_archive_loading_failed();
 682   }
 683   return false;
 684 }
 685 
 686 bool FileMapInfo::check_paths(int shared_path_start_idx, int num_paths, GrowableArray&lt;const char*&gt;* rp_array) {
 687   int i = 0;
 688   int j = shared_path_start_idx;
 689   bool mismatch = false;
 690   while (i &lt; num_paths &amp;&amp; !mismatch) {
 691     while (shared_path(j)-&gt;from_class_path_attr()) {
 692       // shared_path(j) was expanded from the JAR file attribute &quot;Class-Path:&quot;
 693       // during dump time. It&#39;s not included in the -classpath VM argument.
 694       j++;
 695     }
 696     if (!os::same_files(shared_path(j)-&gt;name(), rp_array-&gt;at(i))) {
 697       mismatch = true;
 698     }
 699     i++;
 700     j++;
 701   }
 702   return mismatch;
 703 }
 704 
 705 bool FileMapInfo::validate_boot_class_paths() {
 706   //
 707   // - Archive contains boot classes only - relaxed boot path check:
 708   //   Extra path elements appended to the boot path at runtime are allowed.
 709   //
 710   // - Archive contains application or platform classes - strict boot path check:
 711   //   Validate the entire runtime boot path, which must be compatible
 712   //   with the dump time boot path. Appending boot path at runtime is not
 713   //   allowed.
 714   //
 715 
 716   // The first entry in boot path is the modules_image (guaranteed by
 717   // ClassLoader::setup_boot_search_path()). Skip the first entry. The
 718   // path of the runtime modules_image may be different from the dump
 719   // time path (e.g. the JDK image is copied to a different location
 720   // after generating the shared archive), which is acceptable. For most
 721   // common cases, the dump time boot path might contain modules_image only.
 722   char* runtime_boot_path = Arguments::get_sysclasspath();
 723   char* rp = skip_first_path_entry(runtime_boot_path);
 724   assert(shared_path(0)-&gt;is_modules_image(), &quot;first shared_path must be the modules image&quot;);
 725   int dp_len = header()-&gt;app_class_paths_start_index() - 1; // ignore the first path to the module image
 726   bool mismatch = false;
 727 
 728   bool relaxed_check = !header()-&gt;has_platform_or_app_classes();
 729   if (dp_len == 0 &amp;&amp; rp == NULL) {
 730     return true;   // ok, both runtime and dump time boot paths have modules_images only
 731   } else if (dp_len == 0 &amp;&amp; rp != NULL) {
 732     if (relaxed_check) {
 733       return true;   // ok, relaxed check, runtime has extra boot append path entries
 734     } else {
 735       mismatch = true;
 736     }
 737   } else if (dp_len &gt; 0 &amp;&amp; rp != NULL) {
 738     int num;
 739     ResourceMark rm;
 740     GrowableArray&lt;const char*&gt;* rp_array = create_path_array(rp);
 741     int rp_len = rp_array-&gt;length();
 742     if (rp_len &gt;= dp_len) {
 743       if (relaxed_check) {
 744         // only check the leading entries in the runtime boot path, up to
 745         // the length of the dump time boot path
 746         num = dp_len;
 747       } else {
 748         // check the full runtime boot path, must match with dump time
 749         num = rp_len;
 750       }
 751       mismatch = check_paths(1, num, rp_array);
 752     }
 753   }
 754 
 755   if (mismatch) {
 756     // The paths are different
 757     return classpath_failure(&quot;[BOOT classpath mismatch, actual =&quot;, runtime_boot_path);
 758   }
 759   return true;
 760 }
 761 
 762 bool FileMapInfo::validate_app_class_paths(int shared_app_paths_len) {
 763   const char *appcp = Arguments::get_appclasspath();
 764   assert(appcp != NULL, &quot;NULL app classpath&quot;);
 765   int rp_len = num_paths(appcp);
 766   bool mismatch = false;
 767   if (rp_len &lt; shared_app_paths_len) {
 768     return classpath_failure(&quot;Run time APP classpath is shorter than the one at dump time: &quot;, appcp);
 769   }
 770   if (shared_app_paths_len != 0 &amp;&amp; rp_len != 0) {
 771     // Prefix is OK: E.g., dump with -cp foo.jar, but run with -cp foo.jar:bar.jar.
 772     ResourceMark rm;
 773     GrowableArray&lt;const char*&gt;* rp_array = create_path_array(appcp);
 774     if (rp_array-&gt;length() == 0) {
 775       // None of the jar file specified in the runtime -cp exists.
 776       return classpath_failure(&quot;None of the jar file specified in the runtime -cp exists: -Djava.class.path=&quot;, appcp);
 777     }
 778 
 779     // Handling of non-existent entries in the classpath: we eliminate all the non-existent
 780     // entries from both the dump time classpath (ClassLoader::update_class_path_entry_list)
 781     // and the runtime classpath (FileMapInfo::create_path_array), and check the remaining
 782     // entries. E.g.:
 783     //
 784     // dump : -cp a.jar:NE1:NE2:b.jar  -&gt; a.jar:b.jar -&gt; recorded in archive.
 785     // run 1: -cp NE3:a.jar:NE4:b.jar  -&gt; a.jar:b.jar -&gt; matched
 786     // run 2: -cp x.jar:NE4:b.jar      -&gt; x.jar:b.jar -&gt; mismatched
 787 
 788     int j = header()-&gt;app_class_paths_start_index();
 789     mismatch = check_paths(j, shared_app_paths_len, rp_array);
 790     if (mismatch) {
 791       return classpath_failure(&quot;[APP classpath mismatch, actual: -Djava.class.path=&quot;, appcp);
 792     }
 793   }
 794   return true;
 795 }
 796 
 797 void FileMapInfo::log_paths(const char* msg, int start_idx, int end_idx) {
 798   LogTarget(Info, class, path) lt;
 799   if (lt.is_enabled()) {
 800     LogStream ls(lt);
 801     ls.print(&quot;%s&quot;, msg);
 802     const char* prefix = &quot;&quot;;
 803     for (int i = start_idx; i &lt; end_idx; i++) {
 804       ls.print(&quot;%s%s&quot;, prefix, shared_path(i)-&gt;name());
 805       prefix = os::path_separator();
 806     }
 807     ls.cr();
 808   }
 809 }
 810 
 811 bool FileMapInfo::validate_shared_path_table() {
 812   assert(UseSharedSpaces, &quot;runtime only&quot;);
 813 
 814   _validating_shared_path_table = true;
 815 
 816   // Load the shared path table info from the archive header
 817   _shared_path_table = header()-&gt;shared_path_table();
 818   if (DynamicDumpSharedSpaces) {
 819     // Only support dynamic dumping with the usage of the default CDS archive
 820     // or a simple base archive.
 821     // If the base layer archive contains additional path component besides
 822     // the runtime image and the -cp, dynamic dumping is disabled.
 823     //
 824     // When dynamic archiving is enabled, the _shared_path_table is overwritten
 825     // to include the application path and stored in the top layer archive.
 826     assert(shared_path(0)-&gt;is_modules_image(), &quot;first shared_path must be the modules image&quot;);
 827     if (header()-&gt;app_class_paths_start_index() &gt; 1) {
 828       DynamicDumpSharedSpaces = false;
 829       warning(
 830         &quot;Dynamic archiving is disabled because base layer archive has appended boot classpath&quot;);
 831     }
 832     if (header()-&gt;num_module_paths() &gt; 0) {
 833       DynamicDumpSharedSpaces = false;
 834       warning(
 835         &quot;Dynamic archiving is disabled because base layer archive has module path&quot;);
 836     }
 837   }
 838 
 839   log_paths(&quot;Expecting BOOT path=&quot;, 0, header()-&gt;app_class_paths_start_index());
 840   log_paths(&quot;Expecting -Djava.class.path=&quot;, header()-&gt;app_class_paths_start_index(), header()-&gt;app_module_paths_start_index());
 841 
 842   int module_paths_start_index = header()-&gt;app_module_paths_start_index();
 843   int shared_app_paths_len = 0;
 844 
 845   // validate the path entries up to the _max_used_path_index
 846   for (int i=0; i &lt; header()-&gt;max_used_path_index() + 1; i++) {
 847     if (i &lt; module_paths_start_index) {
 848       if (shared_path(i)-&gt;validate()) {
 849         // Only count the app class paths not from the &quot;Class-path&quot; attribute of a jar manifest.
 850         if (!shared_path(i)-&gt;from_class_path_attr() &amp;&amp; i &gt;= header()-&gt;app_class_paths_start_index()) {
 851           shared_app_paths_len++;
 852         }
 853         log_info(class, path)(&quot;ok&quot;);
 854       } else {
 855         if (_dynamic_archive_info != NULL &amp;&amp; _dynamic_archive_info-&gt;_is_static) {
 856           assert(!UseSharedSpaces, &quot;UseSharedSpaces should be disabled&quot;);
 857         }
 858         return false;
 859       }
 860     } else if (i &gt;= module_paths_start_index) {
 861       if (shared_path(i)-&gt;validate(false /* not a class path entry */)) {
 862         log_info(class, path)(&quot;ok&quot;);
 863       } else {
 864         if (_dynamic_archive_info != NULL &amp;&amp; _dynamic_archive_info-&gt;_is_static) {
 865           assert(!UseSharedSpaces, &quot;UseSharedSpaces should be disabled&quot;);
 866         }
 867         return false;
 868       }
 869     }
 870   }
 871 
 872   if (header()-&gt;max_used_path_index() == 0) {
 873     // default archive only contains the module image in the bootclasspath
 874     assert(shared_path(0)-&gt;is_modules_image(), &quot;first shared_path must be the modules image&quot;);
 875   } else {
 876     if (!validate_boot_class_paths() || !validate_app_class_paths(shared_app_paths_len)) {
 877       fail_continue(&quot;shared class paths mismatch (hint: enable -Xlog:class+path=info to diagnose the failure)&quot;);
 878       return false;
 879     }
 880   }
 881 
 882   validate_non_existent_class_paths();
 883 
 884   _validating_shared_path_table = false;
 885 
 886 #if INCLUDE_JVMTI
 887   if (_classpath_entries_for_jvmti != NULL) {
 888     os::free(_classpath_entries_for_jvmti);
 889   }
 890   size_t sz = sizeof(ClassPathEntry*) * get_number_of_shared_paths();
 891   _classpath_entries_for_jvmti = (ClassPathEntry**)os::malloc(sz, mtClass);
 892   memset((void*)_classpath_entries_for_jvmti, 0, sz);
 893 #endif
 894 
 895   return true;
 896 }
 897 
 898 void FileMapInfo::validate_non_existent_class_paths() {
 899   // All of the recorded non-existent paths came from the Class-Path: attribute from the JAR
 900   // files on the app classpath. If any of these are found to exist during runtime,
 901   // it will change how classes are loading for the app loader. For safety, disable
 902   // loading of archived platform/app classes (currently there&#39;s no way to disable just the
 903   // app classes).
 904 
 905   assert(UseSharedSpaces, &quot;runtime only&quot;);
 906   for (int i = header()-&gt;app_module_paths_start_index() + header()-&gt;num_module_paths();
 907        i &lt; get_number_of_shared_paths();
 908        i++) {
 909     SharedClassPathEntry* ent = shared_path(i);
 910     if (!ent-&gt;check_non_existent()) {
 911       warning(&quot;Archived non-system classes are disabled because the &quot;
 912               &quot;file %s exists&quot;, ent-&gt;name());
 913       header()-&gt;set_has_platform_or_app_classes(false);
 914     }
 915   }
 916 }
 917 
 918 bool FileMapInfo::check_archive(const char* archive_name, bool is_static) {
 919   int fd = os::open(archive_name, O_RDONLY | O_BINARY, 0);
 920   if (fd &lt; 0) {
 921     // do not vm_exit_during_initialization here because Arguments::init_shared_archive_paths()
 922     // requires a shared archive name. The open_for_read() function will log a message regarding
 923     // failure in opening a shared archive.
 924     return false;
 925   }
 926 
 927   size_t sz = is_static ? sizeof(FileMapHeader) : sizeof(DynamicArchiveHeader);
 928   void* header = os::malloc(sz, mtInternal);
 929   memset(header, 0, sz);
 930   size_t n = os::read(fd, header, (unsigned int)sz);
 931   if (n != sz) {
 932     os::free(header);
 933     os::close(fd);
 934     vm_exit_during_initialization(&quot;Unable to read header from shared archive&quot;, archive_name);
 935     return false;
 936   }
 937   if (is_static) {
 938     FileMapHeader* static_header = (FileMapHeader*)header;
 939     if (static_header-&gt;magic() != CDS_ARCHIVE_MAGIC) {
 940       os::free(header);
 941       os::close(fd);
 942       vm_exit_during_initialization(&quot;Not a base shared archive&quot;, archive_name);
 943       return false;
 944     }
 945   } else {
 946     DynamicArchiveHeader* dynamic_header = (DynamicArchiveHeader*)header;
 947     if (dynamic_header-&gt;magic() != CDS_DYNAMIC_ARCHIVE_MAGIC) {
 948       os::free(header);
 949       os::close(fd);
 950       vm_exit_during_initialization(&quot;Not a top shared archive&quot;, archive_name);
 951       return false;
 952     }
 953   }
 954   os::free(header);
 955   os::close(fd);
 956   return true;
 957 }
 958 
 959 bool FileMapInfo::get_base_archive_name_from_header(const char* archive_name,
 960                                                     int* size, char** base_archive_name) {
 961   int fd = os::open(archive_name, O_RDONLY | O_BINARY, 0);
 962   if (fd &lt; 0) {
 963     *size = 0;
 964     return false;
 965   }
 966 
 967   // read the header as a dynamic archive header
 968   size_t sz = sizeof(DynamicArchiveHeader);
 969   DynamicArchiveHeader* dynamic_header = (DynamicArchiveHeader*)os::malloc(sz, mtInternal);
 970   size_t n = os::read(fd, dynamic_header, (unsigned int)sz);
 971   if (n != sz) {
 972     fail_continue(&quot;Unable to read the file header.&quot;);
 973     os::free(dynamic_header);
 974     os::close(fd);
 975     return false;
 976   }
 977   if (dynamic_header-&gt;magic() != CDS_DYNAMIC_ARCHIVE_MAGIC) {
 978     // Not a dynamic header, no need to proceed further.
 979     *size = 0;
 980     os::free(dynamic_header);
 981     os::close(fd);
 982     return false;
 983   }
 984   if (dynamic_header-&gt;base_archive_is_default()) {
 985     *base_archive_name = Arguments::get_default_shared_archive_path();
 986   } else {
 987     // read the base archive name
 988     size_t name_size = dynamic_header-&gt;base_archive_name_size();
 989     if (name_size == 0) {
 990       os::free(dynamic_header);
 991       os::close(fd);
 992       return false;
 993     }
 994     *base_archive_name = NEW_C_HEAP_ARRAY(char, name_size, mtInternal);
 995     n = os::read(fd, *base_archive_name, (unsigned int)name_size);
 996     if (n != name_size) {
 997       fail_continue(&quot;Unable to read the base archive name from the header.&quot;);
 998       FREE_C_HEAP_ARRAY(char, *base_archive_name);
 999       *base_archive_name = NULL;
1000       os::free(dynamic_header);
1001       os::close(fd);
1002       return false;
1003     }
1004   }
1005 
1006   os::free(dynamic_header);
1007   os::close(fd);
1008   return true;
1009 }
1010 
1011 // Read the FileMapInfo information from the file.
1012 
1013 bool FileMapInfo::init_from_file(int fd) {
1014   size_t sz = is_static() ? sizeof(FileMapHeader) : sizeof(DynamicArchiveHeader);
1015   size_t n = os::read(fd, header(), (unsigned int)sz);
1016   if (n != sz) {
1017     fail_continue(&quot;Unable to read the file header.&quot;);
1018     return false;
1019   }
1020 
1021   if (!Arguments::has_jimage()) {
1022     FileMapInfo::fail_continue(&quot;The shared archive file cannot be used with an exploded module build.&quot;);
1023     return false;
1024   }
1025 
1026   unsigned int expected_magic = is_static() ? CDS_ARCHIVE_MAGIC : CDS_DYNAMIC_ARCHIVE_MAGIC;
1027   if (header()-&gt;magic() != expected_magic) {
1028     log_info(cds)(&quot;_magic expected: 0x%08x&quot;, expected_magic);
1029     log_info(cds)(&quot;         actual: 0x%08x&quot;, header()-&gt;magic());
1030     FileMapInfo::fail_continue(&quot;The shared archive file has a bad magic number.&quot;);
1031     return false;
1032   }
1033 
1034   if (header()-&gt;version() != CURRENT_CDS_ARCHIVE_VERSION) {
1035     log_info(cds)(&quot;_version expected: %d&quot;, CURRENT_CDS_ARCHIVE_VERSION);
1036     log_info(cds)(&quot;           actual: %d&quot;, header()-&gt;version());
1037     fail_continue(&quot;The shared archive file has the wrong version.&quot;);
1038     return false;
1039   }
1040 
1041   if (header()-&gt;header_size() != sz) {
1042     log_info(cds)(&quot;_header_size expected: &quot; SIZE_FORMAT, sz);
1043     log_info(cds)(&quot;               actual: &quot; SIZE_FORMAT, header()-&gt;header_size());
1044     FileMapInfo::fail_continue(&quot;The shared archive file has an incorrect header size.&quot;);
1045     return false;
1046   }
1047 
1048   const char* actual_ident = header()-&gt;jvm_ident();
1049 
1050   if (actual_ident[JVM_IDENT_MAX-1] != 0) {
1051     FileMapInfo::fail_continue(&quot;JVM version identifier is corrupted.&quot;);
1052     return false;
1053   }
1054 
1055   char expected_ident[JVM_IDENT_MAX];
1056   get_header_version(expected_ident);
1057   if (strncmp(actual_ident, expected_ident, JVM_IDENT_MAX-1) != 0) {
1058     log_info(cds)(&quot;_jvm_ident expected: %s&quot;, expected_ident);
1059     log_info(cds)(&quot;             actual: %s&quot;, actual_ident);
1060     FileMapInfo::fail_continue(&quot;The shared archive file was created by a different&quot;
1061                   &quot; version or build of HotSpot&quot;);
1062     return false;
1063   }
1064 
1065   if (VerifySharedSpaces) {
1066     int expected_crc = header()-&gt;compute_crc();
1067     if (expected_crc != header()-&gt;crc()) {
1068       log_info(cds)(&quot;_crc expected: %d&quot;, expected_crc);
1069       log_info(cds)(&quot;       actual: %d&quot;, header()-&gt;crc());
1070       FileMapInfo::fail_continue(&quot;Header checksum verification failed.&quot;);
1071       return false;
1072     }
1073   }
1074 
1075   _file_offset = n + header()-&gt;base_archive_name_size(); // accounts for the size of _base_archive_name
1076 
1077   if (is_static()) {
1078     // just checking the last region is sufficient since the archive is written
1079     // in sequential order
1080     size_t len = lseek(fd, 0, SEEK_END);
1081     FileMapRegion* si = space_at(MetaspaceShared::last_valid_region);
1082     // The last space might be empty
1083     if (si-&gt;file_offset() &gt; len || len - si-&gt;file_offset() &lt; si-&gt;used()) {
1084       fail_continue(&quot;The shared archive file has been truncated.&quot;);
1085       return false;
1086     }
1087   }
1088 
1089   return true;
1090 }
1091 
1092 void FileMapInfo::seek_to_position(size_t pos) {
1093   if (lseek(_fd, (long)pos, SEEK_SET) &lt; 0) {
1094     fail_stop(&quot;Unable to seek to position &quot; SIZE_FORMAT, pos);
1095   }
1096 }
1097 
1098 // Read the FileMapInfo information from the file.
1099 bool FileMapInfo::open_for_read() {
1100   if (_file_open) {
1101     return true;
1102   }
1103   if (is_static()) {
1104     _full_path = Arguments::GetSharedArchivePath();
1105   } else {
1106     _full_path = Arguments::GetSharedDynamicArchivePath();
1107   }
1108   log_info(cds)(&quot;trying to map %s&quot;, _full_path);
1109   int fd = os::open(_full_path, O_RDONLY | O_BINARY, 0);
1110   if (fd &lt; 0) {
1111     if (errno == ENOENT) {
1112       fail_continue(&quot;Specified shared archive not found (%s).&quot;, _full_path);
1113     } else {
1114       fail_continue(&quot;Failed to open shared archive file (%s).&quot;,
1115                     os::strerror(errno));
1116     }
1117     return false;
1118   } else {
1119     log_info(cds)(&quot;Opened archive %s.&quot;, _full_path);
1120   }
1121 
1122   _fd = fd;
1123   _file_open = true;
1124   return true;
1125 }
1126 
1127 // Write the FileMapInfo information to the file.
1128 
1129 void FileMapInfo::open_for_write(const char* path) {
1130   if (path == NULL) {
1131     _full_path = Arguments::GetSharedArchivePath();
1132   } else {
1133     _full_path = path;
1134   }
1135   LogMessage(cds) msg;
1136   if (msg.is_info()) {
1137     msg.info(&quot;Dumping shared data to file: &quot;);
1138     msg.info(&quot;   %s&quot;, _full_path);
1139   }
1140 
1141 #ifdef _WINDOWS  // On Windows, need WRITE permission to remove the file.
1142     chmod(_full_path, _S_IREAD | _S_IWRITE);
1143 #endif
1144 
1145   // Use remove() to delete the existing file because, on Unix, this will
1146   // allow processes that have it open continued access to the file.
1147   remove(_full_path);
1148   int fd = os::open(_full_path, O_RDWR | O_CREAT | O_TRUNC | O_BINARY, 0444);
1149   if (fd &lt; 0) {
1150     fail_stop(&quot;Unable to create shared archive file %s: (%s).&quot;, _full_path,
1151               os::strerror(errno));
1152   }
1153   _fd = fd;
1154   _file_open = true;
1155 
1156   // Seek past the header. We will write the header after all regions are written
1157   // and their CRCs computed.
1158   size_t header_bytes = header()-&gt;header_size();
1159   if (header()-&gt;magic() == CDS_DYNAMIC_ARCHIVE_MAGIC) {
1160     header_bytes += strlen(Arguments::GetSharedArchivePath()) + 1;
1161   }
1162 
1163   header_bytes = align_up(header_bytes, os::vm_allocation_granularity());
1164   _file_offset = header_bytes;
1165   seek_to_position(_file_offset);
1166 }
1167 
1168 
1169 // Write the header to the file, seek to the next allocation boundary.
1170 
1171 void FileMapInfo::write_header() {
1172   _file_offset = 0;
1173   seek_to_position(_file_offset);
1174   char* base_archive_name = NULL;
1175   if (header()-&gt;magic() == CDS_DYNAMIC_ARCHIVE_MAGIC) {
1176     base_archive_name = (char*)Arguments::GetSharedArchivePath();
1177     header()-&gt;set_base_archive_name_size(strlen(base_archive_name) + 1);
1178     header()-&gt;set_base_archive_is_default(FLAG_IS_DEFAULT(SharedArchiveFile));
1179   }
1180 
1181   assert(is_file_position_aligned(), &quot;must be&quot;);
1182   write_bytes(header(), header()-&gt;header_size());
1183   if (base_archive_name != NULL) {
1184     write_bytes(base_archive_name, header()-&gt;base_archive_name_size());
1185   }
1186 }
1187 
1188 size_t FileMapRegion::used_aligned() const {
1189   return align_up(used(), os::vm_allocation_granularity());
1190 }
1191 
1192 void FileMapRegion::init(int region_index, char* base, size_t size, bool read_only,
1193                          bool allow_exec, int crc) {
1194   _is_heap_region = HeapShared::is_heap_region(region_index);
1195   _is_bitmap_region = (region_index == MetaspaceShared::bm);
1196   _mapping_offset = 0;
1197 
1198   if (_is_heap_region) {
1199     assert(!DynamicDumpSharedSpaces, &quot;must be&quot;);
1200     assert((base - (char*)CompressedKlassPointers::base()) % HeapWordSize == 0, &quot;Sanity&quot;);
1201     if (base != NULL) {
1202       _mapping_offset = (size_t)CompressedOops::encode_not_null((oop)base);
1203       assert(_mapping_offset == (size_t)(uint32_t)_mapping_offset, &quot;must be 32-bit only&quot;);
1204     }
1205   } else {
1206     if (base != NULL) {
1207       assert(base &gt;= (char*)SharedBaseAddress, &quot;must be&quot;);
1208       _mapping_offset = base - (char*)SharedBaseAddress;
1209     }
1210   }
1211   _used = size;
1212   _read_only = read_only;
1213   _allow_exec = allow_exec;
1214   _crc = crc;
1215   _mapped_from_file = false;
1216   _mapped_base = NULL;
1217 }
1218 
1219 static const char* region_names[] = {
1220   &quot;mc&quot;, &quot;rw&quot;, &quot;ro&quot;, &quot;bm&quot;, &quot;ca0&quot;, &quot;ca1&quot;, &quot;oa0&quot;, &quot;oa1&quot;
1221 };
1222 
1223 void FileMapInfo::write_region(int region, char* base, size_t size,
1224                                bool read_only, bool allow_exec) {
1225   Arguments::assert_is_dumping_archive();
1226 
1227   FileMapRegion* si = space_at(region);
1228   char* target_base;
1229 
1230   const int num_regions = sizeof(region_names)/sizeof(region_names[0]);
1231   assert(0 &lt;= region &amp;&amp; region &lt; num_regions, &quot;sanity&quot;);
1232 
1233   if (region == MetaspaceShared::bm) {
1234     target_base = NULL; // always NULL for bm region.
1235   } else {
1236     if (DynamicDumpSharedSpaces) {
1237       assert(!HeapShared::is_heap_region(region), &quot;dynamic archive doesn&#39;t support heap regions&quot;);
1238       target_base = DynamicArchive::buffer_to_target(base);
1239     } else {
1240       target_base = base;
1241     }
1242   }
1243 
1244   si-&gt;set_file_offset(_file_offset);
1245   char* requested_base = (target_base == NULL) ? NULL : target_base + MetaspaceShared::final_delta();
1246   int crc = ClassLoader::crc32(0, base, (jint)size);
1247   if (size &gt; 0) {
1248     log_debug(cds)(&quot;Shared file region (%-3s)  %d: &quot; SIZE_FORMAT_W(8)
1249                    &quot; bytes, addr &quot; INTPTR_FORMAT &quot; file offset &quot; SIZE_FORMAT_HEX_W(08)
1250                    &quot; crc 0x%08x&quot;,
1251                    region_names[region], region, size, p2i(requested_base), _file_offset, crc);
1252   }
1253   si-&gt;init(region, target_base, size, read_only, allow_exec, crc);
1254 
1255   if (base != NULL) {
1256     write_bytes_aligned(base, size);
1257   }
1258 }
1259 
1260 size_t FileMapInfo::set_oopmaps_offset(GrowableArray&lt;ArchiveHeapOopmapInfo&gt;* oopmaps, size_t curr_size) {
1261   for (int i = 0; i &lt; oopmaps-&gt;length(); i++) {
1262     oopmaps-&gt;at(i)._offset = curr_size;
1263     curr_size += oopmaps-&gt;at(i)._oopmap_size_in_bytes;
1264   }
1265   return curr_size;
1266 }
1267 
1268 size_t FileMapInfo::write_oopmaps(GrowableArray&lt;ArchiveHeapOopmapInfo&gt;* oopmaps, size_t curr_offset, uintptr_t* buffer) {
1269   for (int i = 0; i &lt; oopmaps-&gt;length(); i++) {
1270     memcpy(((char*)buffer) + curr_offset, oopmaps-&gt;at(i)._oopmap, oopmaps-&gt;at(i)._oopmap_size_in_bytes);
1271     curr_offset += oopmaps-&gt;at(i)._oopmap_size_in_bytes;
1272   }
1273   return curr_offset;
1274 }
1275 
1276 void FileMapInfo::write_bitmap_region(const CHeapBitMap* ptrmap,
1277                                       GrowableArray&lt;ArchiveHeapOopmapInfo&gt;* closed_oopmaps,
1278                                       GrowableArray&lt;ArchiveHeapOopmapInfo&gt;* open_oopmaps) {
1279   ResourceMark rm;
1280   size_t size_in_bits = ptrmap-&gt;size();
1281   size_t size_in_bytes = ptrmap-&gt;size_in_bytes();
1282 
1283   if (closed_oopmaps != NULL &amp;&amp; open_oopmaps != NULL) {
1284     size_in_bytes = set_oopmaps_offset(closed_oopmaps, size_in_bytes);
1285     size_in_bytes = set_oopmaps_offset(open_oopmaps, size_in_bytes);
1286   }
1287 
1288   uintptr_t* buffer = (uintptr_t*)NEW_RESOURCE_ARRAY(char, size_in_bytes);
1289   ptrmap-&gt;write_to(buffer, ptrmap-&gt;size_in_bytes());
1290   header()-&gt;set_ptrmap_size_in_bits(size_in_bits);
1291 
1292   if (closed_oopmaps != NULL &amp;&amp; open_oopmaps != NULL) {
1293     size_t curr_offset = write_oopmaps(closed_oopmaps, ptrmap-&gt;size_in_bytes(), buffer);
1294     write_oopmaps(open_oopmaps, curr_offset, buffer);
1295   }
1296 
1297   write_region(MetaspaceShared::bm, (char*)buffer, size_in_bytes, /*read_only=*/true, /*allow_exec=*/false);
1298 }
1299 
1300 // Write out the given archive heap memory regions.  GC code combines multiple
1301 // consecutive archive GC regions into one MemRegion whenever possible and
1302 // produces the &#39;heap_mem&#39; array.
1303 //
1304 // If the archive heap memory size is smaller than a single dump time GC region
1305 // size, there is only one MemRegion in the array.
1306 //
1307 // If the archive heap memory size is bigger than one dump time GC region size,
1308 // the &#39;heap_mem&#39; array may contain more than one consolidated MemRegions. When
1309 // the first/bottom archive GC region is a partial GC region (with the empty
1310 // portion at the higher address within the region), one MemRegion is used for
1311 // the bottom partial archive GC region. The rest of the consecutive archive
1312 // GC regions are combined into another MemRegion.
1313 //
1314 // Here&#39;s the mapping from (archive heap GC regions) -&gt; (GrowableArray&lt;MemRegion&gt; *regions).
1315 //   + We have 1 or more archive heap regions: ah0, ah1, ah2 ..... ahn
1316 //   + We have 1 or 2 consolidated heap memory regions: r0 and r1
1317 //
1318 // If there&#39;s a single archive GC region (ah0), then r0 == ah0, and r1 is empty.
1319 // Otherwise:
1320 //
1321 // &quot;X&quot; represented space that&#39;s occupied by heap objects.
1322 // &quot;_&quot; represented unused spaced in the heap region.
1323 //
1324 //
1325 //    |ah0       | ah1 | ah2| ...... | ahn|
1326 //    |XXXXXX|__ |XXXXX|XXXX|XXXXXXXX|XXXX|
1327 //    |&lt;-r0-&gt;|   |&lt;- r1 -----------------&gt;|
1328 //            ^^^
1329 //             |
1330 //             +-- gap
1331 size_t FileMapInfo::write_archive_heap_regions(GrowableArray&lt;MemRegion&gt; *heap_mem,
1332                                                GrowableArray&lt;ArchiveHeapOopmapInfo&gt; *oopmaps,
1333                                                int first_region_id, int max_num_regions) {
1334   assert(max_num_regions &lt;= 2, &quot;Only support maximum 2 memory regions&quot;);
1335 
1336   int arr_len = heap_mem == NULL ? 0 : heap_mem-&gt;length();
1337   if(arr_len &gt; max_num_regions) {
1338     fail_stop(&quot;Unable to write archive heap memory regions: &quot;
1339               &quot;number of memory regions exceeds maximum due to fragmentation. &quot;
1340               &quot;Please increase java heap size &quot;
1341               &quot;(current MaxHeapSize is &quot; SIZE_FORMAT &quot;, InitialHeapSize is &quot; SIZE_FORMAT &quot;).&quot;,
1342               MaxHeapSize, InitialHeapSize);
1343   }
1344 
1345   size_t total_size = 0;
1346   for (int i = 0; i &lt; max_num_regions; i++) {
1347     char* start = NULL;
1348     size_t size = 0;
1349     if (i &lt; arr_len) {
1350       start = (char*)heap_mem-&gt;at(i).start();
1351       size = heap_mem-&gt;at(i).byte_size();
1352       total_size += size;
1353     }
1354 
1355     int region_idx = i + first_region_id;
1356     write_region(region_idx, start, size, false, false);
1357     if (size &gt; 0) {
1358       space_at(region_idx)-&gt;init_oopmap(oopmaps-&gt;at(i)._offset,
1359                                         oopmaps-&gt;at(i)._oopmap_size_in_bits);
1360     }
1361   }
1362   return total_size;
1363 }
1364 
1365 // Dump bytes to file -- at the current file position.
1366 
1367 void FileMapInfo::write_bytes(const void* buffer, size_t nbytes) {
1368   assert(_file_open, &quot;must be&quot;);
1369   size_t n = os::write(_fd, buffer, (unsigned int)nbytes);
1370   if (n != nbytes) {
1371     // If the shared archive is corrupted, close it and remove it.
1372     close();
1373     remove(_full_path);
1374     fail_stop(&quot;Unable to write to shared archive file.&quot;);
1375   }
1376   _file_offset += nbytes;
1377 }
1378 
1379 bool FileMapInfo::is_file_position_aligned() const {
1380   return _file_offset == align_up(_file_offset,
1381                                   os::vm_allocation_granularity());
1382 }
1383 
1384 // Align file position to an allocation unit boundary.
1385 
1386 void FileMapInfo::align_file_position() {
1387   assert(_file_open, &quot;must be&quot;);
1388   size_t new_file_offset = align_up(_file_offset,
1389                                     os::vm_allocation_granularity());
1390   if (new_file_offset != _file_offset) {
1391     _file_offset = new_file_offset;
1392     // Seek one byte back from the target and write a byte to insure
1393     // that the written file is the correct length.
1394     _file_offset -= 1;
1395     seek_to_position(_file_offset);
1396     char zero = 0;
1397     write_bytes(&amp;zero, 1);
1398   }
1399 }
1400 
1401 
1402 // Dump bytes to file -- at the current file position.
1403 
1404 void FileMapInfo::write_bytes_aligned(const void* buffer, size_t nbytes) {
1405   align_file_position();
1406   write_bytes(buffer, nbytes);
1407   align_file_position();
1408 }
1409 
1410 void FileMapInfo::set_final_requested_base(char* b) {
1411   header()-&gt;set_final_requested_base(b);
1412 }
1413 
1414 // Close the shared archive file.  This does NOT unmap mapped regions.
1415 
1416 void FileMapInfo::close() {
1417   if (_file_open) {
1418     if (::close(_fd) &lt; 0) {
1419       fail_stop(&quot;Unable to close the shared archive file.&quot;);
1420     }
1421     _file_open = false;
1422     _fd = -1;
1423   }
1424 }
1425 
1426 
1427 // JVM/TI RedefineClasses() support:
1428 // Remap the shared readonly space to shared readwrite, private.
1429 bool FileMapInfo::remap_shared_readonly_as_readwrite() {
1430   int idx = MetaspaceShared::ro;
1431   FileMapRegion* si = space_at(idx);
1432   if (!si-&gt;read_only()) {
1433     // the space is already readwrite so we are done
1434     return true;
1435   }
1436   size_t used = si-&gt;used();
1437   size_t size = align_up(used, os::vm_allocation_granularity());
1438   if (!open_for_read()) {
1439     return false;
1440   }
1441   char *addr = region_addr(idx);
1442   char *base = os::remap_memory(_fd, _full_path, si-&gt;file_offset(),
1443                                 addr, size, false /* !read_only */,
1444                                 si-&gt;allow_exec());
1445   close();
1446   // These have to be errors because the shared region is now unmapped.
1447   if (base == NULL) {
1448     log_error(cds)(&quot;Unable to remap shared readonly space (errno=%d).&quot;, errno);
1449     vm_exit(1);
1450   }
1451   if (base != addr) {
1452     log_error(cds)(&quot;Unable to remap shared readonly space (errno=%d).&quot;, errno);
1453     vm_exit(1);
1454   }
1455   si-&gt;set_read_only(false);
1456   return true;
1457 }
1458 
1459 // Memory map a region in the address space.
1460 static const char* shared_region_name[] = { &quot;MiscCode&quot;, &quot;ReadWrite&quot;, &quot;ReadOnly&quot;, &quot;Bitmap&quot;,
1461                                             &quot;String1&quot;, &quot;String2&quot;, &quot;OpenArchive1&quot;, &quot;OpenArchive2&quot; };
1462 
1463 MapArchiveResult FileMapInfo::map_regions(int regions[], int num_regions, char* mapped_base_address, ReservedSpace rs) {
1464   DEBUG_ONLY(FileMapRegion* last_region = NULL);
1465   intx addr_delta = mapped_base_address - header()-&gt;requested_base_address();
1466 
1467   // Make sure we don&#39;t attempt to use header()-&gt;mapped_base_address() unless
1468   // it&#39;s been successfully mapped.
1469   DEBUG_ONLY(header()-&gt;set_mapped_base_address((char*)(uintptr_t)0xdeadbeef);)
1470 
1471   for (int r = 0; r &lt; num_regions; r++) {
1472     int idx = regions[r];
1473     MapArchiveResult result = map_region(idx, addr_delta, mapped_base_address, rs);
1474     if (result != MAP_ARCHIVE_SUCCESS) {
1475       return result;
1476     }
1477     FileMapRegion* si = space_at(idx);
1478     DEBUG_ONLY(if (last_region != NULL) {
1479         // Ensure that the OS won&#39;t be able to allocate new memory spaces between any mapped
1480         // regions, or else it would mess up the simple comparision in MetaspaceObj::is_shared().
1481         assert(si-&gt;mapped_base() == last_region-&gt;mapped_end(), &quot;must have no gaps&quot;);
1482       }
1483       last_region = si;)
1484     log_info(cds)(&quot;Mapped %s region #%d at base &quot; INTPTR_FORMAT &quot; top &quot; INTPTR_FORMAT &quot; (%s)&quot;, is_static() ? &quot;static &quot; : &quot;dynamic&quot;,
1485                   idx, p2i(si-&gt;mapped_base()), p2i(si-&gt;mapped_end()),
1486                   shared_region_name[idx]);
1487 
1488   }
1489 
1490   header()-&gt;set_mapped_base_address(header()-&gt;requested_base_address() + addr_delta);
1491   if (addr_delta != 0 &amp;&amp; !relocate_pointers(addr_delta)) {
1492     return MAP_ARCHIVE_OTHER_FAILURE;
1493   }
1494 
1495   return MAP_ARCHIVE_SUCCESS;
1496 }
1497 
1498 bool FileMapInfo::read_region(int i, char* base, size_t size) {
1499   assert(MetaspaceShared::use_windows_memory_mapping(), &quot;used by windows only&quot;);
1500   FileMapRegion* si = space_at(i);
1501   log_info(cds)(&quot;Commit %s region #%d at base &quot; INTPTR_FORMAT &quot; top &quot; INTPTR_FORMAT &quot; (%s)%s&quot;,
1502                 is_static() ? &quot;static &quot; : &quot;dynamic&quot;, i, p2i(base), p2i(base + size),
1503                 shared_region_name[i], si-&gt;allow_exec() ? &quot; exec&quot; : &quot;&quot;);
1504   if (!os::commit_memory(base, size, si-&gt;allow_exec())) {
1505     log_error(cds)(&quot;Failed to commit %s region #%d (%s)&quot;, is_static() ? &quot;static &quot; : &quot;dynamic&quot;,
1506                    i, shared_region_name[i]);
1507     return false;
1508   }
1509   if (lseek(_fd, (long)si-&gt;file_offset(), SEEK_SET) != (int)si-&gt;file_offset() ||
1510       read_bytes(base, size) != size) {
1511     return false;
1512   }
1513   return true;
1514 }
1515 
1516 MapArchiveResult FileMapInfo::map_region(int i, intx addr_delta, char* mapped_base_address, ReservedSpace rs) {
1517   assert(!HeapShared::is_heap_region(i), &quot;sanity&quot;);
1518   FileMapRegion* si = space_at(i);
1519   size_t size = si-&gt;used_aligned();
1520   char *requested_addr = mapped_base_address + si-&gt;mapping_offset();
1521   assert(si-&gt;mapped_base() == NULL, &quot;must be not mapped yet&quot;);
1522   assert(requested_addr != NULL, &quot;must be specified&quot;);
1523 
1524   si-&gt;set_mapped_from_file(false);
1525 
1526   if (MetaspaceShared::use_windows_memory_mapping()) {
1527     // Windows cannot remap read-only shared memory to read-write when required for
1528     // RedefineClasses, which is also used by JFR.  Always map windows regions as RW.
1529     si-&gt;set_read_only(false);
1530   } else if (JvmtiExport::can_modify_any_class() || JvmtiExport::can_walk_any_space() ||
1531              Arguments::has_jfr_option()) {
1532     // If a tool agent is in use (debugging enabled), or JFR, we must map the address space RW
1533     si-&gt;set_read_only(false);
1534   } else if (addr_delta != 0) {
1535     si-&gt;set_read_only(false); // Need to patch the pointers
1536   }
1537 
1538   if (MetaspaceShared::use_windows_memory_mapping() &amp;&amp; rs.is_reserved()) {
1539     // This is the second time we try to map the archive(s). We have already created a ReservedSpace
1540     // that covers all the FileMapRegions to ensure all regions can be mapped. However, Windows
1541     // can&#39;t mmap into a ReservedSpace, so we just os::read() the data. We&#39;re going to patch all the
1542     // regions anyway, so there&#39;s no benefit for mmap anyway.
1543     if (!read_region(i, requested_addr, size)) {
1544       log_info(cds)(&quot;Failed to read %s shared space into reserved space at &quot; INTPTR_FORMAT,
1545                     shared_region_name[i], p2i(requested_addr));
1546       return MAP_ARCHIVE_OTHER_FAILURE; // oom or I/O error.
1547     }
1548   } else {
1549     // Note that this may either be a &quot;fresh&quot; mapping into unreserved address
1550     // space (Windows, first mapping attempt), or a mapping into pre-reserved
1551     // space (Posix). See also comment in MetaspaceShared::map_archives().
1552     char* base = os::map_memory(_fd, _full_path, si-&gt;file_offset(),
1553                                 requested_addr, size, si-&gt;read_only(),
1554                                 si-&gt;allow_exec(), mtClassShared);
1555     if (base != requested_addr) {
1556       log_info(cds)(&quot;Unable to map %s shared space at &quot; INTPTR_FORMAT,
1557                     shared_region_name[i], p2i(requested_addr));
1558       _memory_mapping_failed = true;
1559       return MAP_ARCHIVE_MMAP_FAILURE;
1560     }
1561     si-&gt;set_mapped_from_file(true);
1562   }
1563   si-&gt;set_mapped_base(requested_addr);
1564 
1565   if (VerifySharedSpaces &amp;&amp; !verify_region_checksum(i)) {
1566     return MAP_ARCHIVE_OTHER_FAILURE;
1567   }
1568 
1569   return MAP_ARCHIVE_SUCCESS;
1570 }
1571 
1572 // The return value is the location of the archive relocation bitmap.
1573 char* FileMapInfo::map_bitmap_region() {
1574   FileMapRegion* si = space_at(MetaspaceShared::bm);
1575   if (si-&gt;mapped_base() != NULL) {
1576     return si-&gt;mapped_base();
1577   }
1578   bool read_only = true, allow_exec = false;
1579   char* requested_addr = NULL; // allow OS to pick any location
1580   char* bitmap_base = os::map_memory(_fd, _full_path, si-&gt;file_offset(),
1581                                      requested_addr, si-&gt;used_aligned(), read_only, allow_exec, mtClassShared);
1582   if (bitmap_base == NULL) {
1583     log_error(cds)(&quot;failed to map relocation bitmap&quot;);
1584     return NULL;
1585   }
1586 
1587   if (VerifySharedSpaces &amp;&amp; !region_crc_check(bitmap_base, si-&gt;used_aligned(), si-&gt;crc())) {
1588     log_error(cds)(&quot;relocation bitmap CRC error&quot;);
1589     if (!os::unmap_memory(bitmap_base, si-&gt;used_aligned())) {
1590       fatal(&quot;os::unmap_memory of relocation bitmap failed&quot;);
1591     }
1592     return NULL;
1593   }
1594 
1595   si-&gt;set_mapped_base(bitmap_base);
1596   si-&gt;set_mapped_from_file(true);
1597   return bitmap_base;
1598 }
1599 
1600 bool FileMapInfo::relocate_pointers(intx addr_delta) {
1601   log_debug(cds, reloc)(&quot;runtime archive relocation start&quot;);
1602   char* bitmap_base = map_bitmap_region();
1603 
1604   if (bitmap_base == NULL) {
1605     return false;
1606   } else {
1607     size_t ptrmap_size_in_bits = header()-&gt;ptrmap_size_in_bits();
1608     log_debug(cds, reloc)(&quot;mapped relocation bitmap @ &quot; INTPTR_FORMAT &quot; (&quot; SIZE_FORMAT &quot; bits)&quot;,
1609                           p2i(bitmap_base), ptrmap_size_in_bits);
1610 
1611     BitMapView ptrmap((BitMap::bm_word_t*)bitmap_base, ptrmap_size_in_bits);
1612 
1613     // Patch all pointers in the the mapped region that are marked by ptrmap.
1614     address patch_base = (address)mapped_base();
1615     address patch_end  = (address)mapped_end();
1616 
1617     // the current value of the pointers to be patched must be within this
1618     // range (i.e., must be between the requesed base address, and the of the current archive).
1619     // Note: top archive may point to objects in the base archive, but not the other way around.
1620     address valid_old_base = (address)header()-&gt;requested_base_address();
1621     address valid_old_end  = valid_old_base + mapping_end_offset();
1622 
1623     // after patching, the pointers must point inside this range
1624     // (the requested location of the archive, as mapped at runtime).
1625     address valid_new_base = (address)header()-&gt;mapped_base_address();
1626     address valid_new_end  = (address)mapped_end();
1627 
1628     SharedDataRelocator&lt;false&gt; patcher((address*)patch_base, (address*)patch_end, valid_old_base, valid_old_end,
1629                                        valid_new_base, valid_new_end, addr_delta);
1630     ptrmap.iterate(&amp;patcher);
1631 
1632     // The MetaspaceShared::bm region will be unmapped in MetaspaceShared::initialize_shared_spaces().
1633 
1634     log_debug(cds, reloc)(&quot;runtime archive relocation done&quot;);
1635     return true;
1636   }
1637 }
1638 
1639 size_t FileMapInfo::read_bytes(void* buffer, size_t count) {
1640   assert(_file_open, &quot;Archive file is not open&quot;);
1641   size_t n = os::read(_fd, buffer, (unsigned int)count);
1642   if (n != count) {
1643     // Close the file if there&#39;s a problem reading it.
1644     close();
1645     return 0;
1646   }
1647   _file_offset += count;
1648   return count;
1649 }
1650 
1651 address FileMapInfo::decode_start_address(FileMapRegion* spc, bool with_current_oop_encoding_mode) {
1652   size_t offset = spc-&gt;mapping_offset();
1653   assert(offset == (size_t)(uint32_t)offset, &quot;must be 32-bit only&quot;);
1654   uint n = (uint)offset;
1655   if (with_current_oop_encoding_mode) {
1656     return cast_from_oop&lt;address&gt;(CompressedOops::decode_not_null(n));
1657   } else {
1658     return cast_from_oop&lt;address&gt;(HeapShared::decode_from_archive(n));
1659   }
1660 }
1661 
1662 static MemRegion *closed_archive_heap_ranges = NULL;
1663 static MemRegion *open_archive_heap_ranges = NULL;
1664 static int num_closed_archive_heap_ranges = 0;
1665 static int num_open_archive_heap_ranges = 0;
1666 
1667 #if INCLUDE_CDS_JAVA_HEAP
1668 bool FileMapInfo::has_heap_regions() {
1669   return (space_at(MetaspaceShared::first_closed_archive_heap_region)-&gt;used() &gt; 0);
1670 }
1671 
1672 // Returns the address range of the archived heap regions computed using the
1673 // current oop encoding mode. This range may be different than the one seen at
1674 // dump time due to encoding mode differences. The result is used in determining
1675 // if/how these regions should be relocated at run time.
1676 MemRegion FileMapInfo::get_heap_regions_range_with_current_oop_encoding_mode() {
1677   address start = (address) max_uintx;
1678   address end   = NULL;
1679 
1680   for (int i = MetaspaceShared::first_closed_archive_heap_region;
1681            i &lt;= MetaspaceShared::last_valid_region;
1682            i++) {
1683     FileMapRegion* si = space_at(i);
1684     size_t size = si-&gt;used();
1685     if (size &gt; 0) {
1686       address s = start_address_as_decoded_with_current_oop_encoding_mode(si);
1687       address e = s + size;
1688       if (start &gt; s) {
1689         start = s;
1690       }
1691       if (end &lt; e) {
1692         end = e;
1693       }
1694     }
1695   }
1696   assert(end != NULL, &quot;must have at least one used heap region&quot;);
1697   return MemRegion((HeapWord*)start, (HeapWord*)end);
1698 }
1699 
1700 //
1701 // Map the closed and open archive heap objects to the runtime java heap.
1702 //
1703 // The shared objects are mapped at (or close to ) the java heap top in
1704 // closed archive regions. The mapped objects contain no out-going
1705 // references to any other java heap regions. GC does not write into the
1706 // mapped closed archive heap region.
1707 //
1708 // The open archive heap objects are mapped below the shared objects in
1709 // the runtime java heap. The mapped open archive heap data only contains
1710 // references to the shared objects and open archive objects initially.
1711 // During runtime execution, out-going references to any other java heap
1712 // regions may be added. GC may mark and update references in the mapped
1713 // open archive objects.
1714 void FileMapInfo::map_heap_regions_impl() {
1715   if (!HeapShared::is_heap_object_archiving_allowed()) {
1716     log_info(cds)(&quot;CDS heap data is being ignored. UseG1GC, &quot;
1717                   &quot;UseCompressedOops and UseCompressedClassPointers are required.&quot;);
1718     return;
1719   }
1720 
1721   if (JvmtiExport::should_post_class_file_load_hook() &amp;&amp; JvmtiExport::has_early_class_hook_env()) {
1722     ShouldNotReachHere(); // CDS should have been disabled.
1723     // The archived objects are mapped at JVM start-up, but we don&#39;t know if
1724     // j.l.String or j.l.Class might be replaced by the ClassFileLoadHook,
1725     // which would make the archived String or mirror objects invalid. Let&#39;s be safe and not
1726     // use the archived objects. These 2 classes are loaded during the JVMTI &quot;early&quot; stage.
1727     //
1728     // If JvmtiExport::has_early_class_hook_env() is false, the classes of some objects
1729     // in the archived subgraphs may be replaced by the ClassFileLoadHook. But that&#39;s OK
1730     // because we won&#39;t install an archived object subgraph if the klass of any of the
1731     // referenced objects are replaced. See HeapShared::initialize_from_archived_subgraph().
1732   }
1733 
1734   log_info(cds)(&quot;CDS archive was created with max heap size = &quot; SIZE_FORMAT &quot;M, and the following configuration:&quot;,
1735                 max_heap_size()/M);
1736   log_info(cds)(&quot;    narrow_klass_base = &quot; PTR_FORMAT &quot;, narrow_klass_shift = %d&quot;,
1737                 p2i(narrow_klass_base()), narrow_klass_shift());
1738   log_info(cds)(&quot;    narrow_oop_mode = %d, narrow_oop_base = &quot; PTR_FORMAT &quot;, narrow_oop_shift = %d&quot;,
1739                 narrow_oop_mode(), p2i(narrow_oop_base()), narrow_oop_shift());
1740 
1741   log_info(cds)(&quot;The current max heap size = &quot; SIZE_FORMAT &quot;M, HeapRegion::GrainBytes = &quot; SIZE_FORMAT,
1742                 MaxHeapSize/M, HeapRegion::GrainBytes);
1743   log_info(cds)(&quot;    narrow_klass_base = &quot; PTR_FORMAT &quot;, narrow_klass_shift = %d&quot;,
1744                 p2i(CompressedKlassPointers::base()), CompressedKlassPointers::shift());
1745   log_info(cds)(&quot;    narrow_oop_mode = %d, narrow_oop_base = &quot; PTR_FORMAT &quot;, narrow_oop_shift = %d&quot;,
1746                 CompressedOops::mode(), p2i(CompressedOops::base()), CompressedOops::shift());
1747 
1748   if (narrow_klass_base() != CompressedKlassPointers::base() ||
1749       narrow_klass_shift() != CompressedKlassPointers::shift()) {
1750     log_info(cds)(&quot;CDS heap data cannot be used because the archive was created with an incompatible narrow klass encoding mode.&quot;);
1751     return;
1752   }
1753 
1754   if (narrow_oop_mode() != CompressedOops::mode() ||
1755       narrow_oop_base() != CompressedOops::base() ||
1756       narrow_oop_shift() != CompressedOops::shift()) {
1757     log_info(cds)(&quot;CDS heap data need to be relocated because the archive was created with an incompatible oop encoding mode.&quot;);
1758     _heap_pointers_need_patching = true;
1759   } else {
1760     MemRegion range = get_heap_regions_range_with_current_oop_encoding_mode();
1761     if (!CompressedOops::is_in(range)) {
1762       log_info(cds)(&quot;CDS heap data need to be relocated because&quot;);
1763       log_info(cds)(&quot;the desired range &quot; PTR_FORMAT &quot; - &quot;  PTR_FORMAT, p2i(range.start()), p2i(range.end()));
1764       log_info(cds)(&quot;is outside of the heap &quot; PTR_FORMAT &quot; - &quot;  PTR_FORMAT, p2i(CompressedOops::begin()), p2i(CompressedOops::end()));
1765       _heap_pointers_need_patching = true;
1766     }
1767   }
1768 
1769   ptrdiff_t delta = 0;
1770   if (_heap_pointers_need_patching) {
1771     //   dumptime heap end  ------------v
1772     //   [      |archived heap regions| ]         runtime heap end ------v
1773     //                                       [   |archived heap regions| ]
1774     //                                  |&lt;-----delta--------------------&gt;|
1775     //
1776     // At dump time, the archived heap regions were near the top of the heap.
1777     // At run time, they may not be inside the heap, so we move them so
1778     // that they are now near the top of the runtime time. This can be done by
1779     // the simple math of adding the delta as shown above.
1780     address dumptime_heap_end = header()-&gt;heap_end();
1781     address runtime_heap_end = (address)CompressedOops::end();
1782     delta = runtime_heap_end - dumptime_heap_end;
1783   }
1784 
1785   log_info(cds)(&quot;CDS heap data relocation delta = &quot; INTX_FORMAT &quot; bytes&quot;, delta);
1786   HeapShared::init_narrow_oop_decoding(narrow_oop_base() + delta, narrow_oop_shift());
1787 
1788   FileMapRegion* si = space_at(MetaspaceShared::first_closed_archive_heap_region);
1789   address relocated_closed_heap_region_bottom = start_address_as_decoded_from_archive(si);
1790   if (!is_aligned(relocated_closed_heap_region_bottom, HeapRegion::GrainBytes)) {
1791     // Align the bottom of the closed archive heap regions at G1 region boundary.
1792     // This will avoid the situation where the highest open region and the lowest
1793     // closed region sharing the same G1 region. Otherwise we will fail to map the
1794     // open regions.
1795     size_t align = size_t(relocated_closed_heap_region_bottom) % HeapRegion::GrainBytes;
1796     delta -= align;
1797     log_info(cds)(&quot;CDS heap data need to be relocated lower by a further &quot; SIZE_FORMAT
1798                   &quot; bytes to &quot; INTX_FORMAT &quot; to be aligned with HeapRegion::GrainBytes&quot;,
1799                   align, delta);
1800     HeapShared::init_narrow_oop_decoding(narrow_oop_base() + delta, narrow_oop_shift());
1801     _heap_pointers_need_patching = true;
1802     relocated_closed_heap_region_bottom = start_address_as_decoded_from_archive(si);
1803   }
1804   assert(is_aligned(relocated_closed_heap_region_bottom, HeapRegion::GrainBytes),
1805          &quot;must be&quot;);
1806 
1807   // Map the closed_archive_heap regions, GC does not write into the regions.
1808   if (map_heap_data(&amp;closed_archive_heap_ranges,
1809                     MetaspaceShared::first_closed_archive_heap_region,
1810                     MetaspaceShared::max_closed_archive_heap_region,
1811                     &amp;num_closed_archive_heap_ranges)) {
1812     HeapShared::set_closed_archive_heap_region_mapped();
1813 
1814     // Now, map open_archive heap regions, GC can write into the regions.
1815     if (map_heap_data(&amp;open_archive_heap_ranges,
1816                       MetaspaceShared::first_open_archive_heap_region,
1817                       MetaspaceShared::max_open_archive_heap_region,
1818                       &amp;num_open_archive_heap_ranges,
1819                       true /* open */)) {
1820       HeapShared::set_open_archive_heap_region_mapped();
1821     }
1822   }
1823 }
1824 
1825 void FileMapInfo::map_heap_regions() {
1826   if (has_heap_regions()) {
1827     map_heap_regions_impl();
1828   }
1829 
1830   if (!HeapShared::closed_archive_heap_region_mapped()) {
1831     assert(closed_archive_heap_ranges == NULL &amp;&amp;
1832            num_closed_archive_heap_ranges == 0, &quot;sanity&quot;);
1833   }
1834 
1835   if (!HeapShared::open_archive_heap_region_mapped()) {
1836     assert(open_archive_heap_ranges == NULL &amp;&amp; num_open_archive_heap_ranges == 0, &quot;sanity&quot;);
1837   }
1838 }
1839 
1840 bool FileMapInfo::map_heap_data(MemRegion **heap_mem, int first,
1841                                 int max, int* num, bool is_open_archive) {
1842   MemRegion* regions = MemRegion::create_array(max, mtInternal);
1843 
1844   struct Cleanup {
1845     MemRegion* _regions;
1846     uint _length;
1847     bool _aborted;
1848     Cleanup(MemRegion* regions, uint length) : _regions(regions), _length(length), _aborted(true) { }
1849     ~Cleanup() { if (_aborted) { MemRegion::destroy_array(_regions, _length); } }
1850   } cleanup(regions, max);
1851 
1852   FileMapRegion* si;
1853   int region_num = 0;
1854 
1855   for (int i = first;
1856            i &lt; first + max; i++) {
1857     si = space_at(i);
1858     size_t size = si-&gt;used();
1859     if (size &gt; 0) {
1860       HeapWord* start = (HeapWord*)start_address_as_decoded_from_archive(si);
1861       regions[region_num] = MemRegion(start, size / HeapWordSize);
1862       region_num ++;
1863       log_info(cds)(&quot;Trying to map heap data: region[%d] at &quot; INTPTR_FORMAT &quot;, size = &quot; SIZE_FORMAT_W(8) &quot; bytes&quot;,
1864                     i, p2i(start), size);
1865     }
1866   }
1867 
1868   if (region_num == 0) {
1869     return false; // no archived java heap data
1870   }
1871 
1872   // Check that ranges are within the java heap
1873   if (!G1CollectedHeap::heap()-&gt;check_archive_addresses(regions, region_num)) {
1874     log_info(cds)(&quot;UseSharedSpaces: Unable to allocate region, range is not within java heap.&quot;);
1875     return false;
1876   }
1877 
1878   // allocate from java heap
1879   if (!G1CollectedHeap::heap()-&gt;alloc_archive_regions(
1880              regions, region_num, is_open_archive)) {
1881     log_info(cds)(&quot;UseSharedSpaces: Unable to allocate region, java heap range is already in use.&quot;);
1882     return false;
1883   }
1884 
1885   // Map the archived heap data. No need to call MemTracker::record_virtual_memory_type()
1886   // for mapped regions as they are part of the reserved java heap, which is
1887   // already recorded.
1888   for (int i = 0; i &lt; region_num; i++) {
1889     si = space_at(first + i);
1890     char* addr = (char*)regions[i].start();
1891     char* base = os::map_memory(_fd, _full_path, si-&gt;file_offset(),
1892                                 addr, regions[i].byte_size(), si-&gt;read_only(),
1893                                 si-&gt;allow_exec());
1894     if (base == NULL || base != addr) {
1895       // dealloc the regions from java heap
1896       dealloc_archive_heap_regions(regions, region_num);
1897       log_info(cds)(&quot;UseSharedSpaces: Unable to map at required address in java heap. &quot;
1898                     INTPTR_FORMAT &quot;, size = &quot; SIZE_FORMAT &quot; bytes&quot;,
1899                     p2i(addr), regions[i].byte_size());
1900       return false;
1901     }
1902 
1903     if (VerifySharedSpaces &amp;&amp; !region_crc_check(addr, regions[i].byte_size(), si-&gt;crc())) {
1904       // dealloc the regions from java heap
1905       dealloc_archive_heap_regions(regions, region_num);
1906       log_info(cds)(&quot;UseSharedSpaces: mapped heap regions are corrupt&quot;);
1907       return false;
1908     }
1909   }
1910 
1911   cleanup._aborted = false;
1912   // the shared heap data is mapped successfully
1913   *heap_mem = regions;
1914   *num = region_num;
1915   return true;
1916 }
1917 
1918 void FileMapInfo::patch_archived_heap_embedded_pointers() {
1919   if (!_heap_pointers_need_patching) {
1920     return;
1921   }
1922 
1923   patch_archived_heap_embedded_pointers(closed_archive_heap_ranges,
1924                                         num_closed_archive_heap_ranges,
1925                                         MetaspaceShared::first_closed_archive_heap_region);
1926 
1927   patch_archived_heap_embedded_pointers(open_archive_heap_ranges,
1928                                         num_open_archive_heap_ranges,
1929                                         MetaspaceShared::first_open_archive_heap_region);
1930 }
1931 
1932 void FileMapInfo::patch_archived_heap_embedded_pointers(MemRegion* ranges, int num_ranges,
1933                                                         int first_region_idx) {
1934   char* bitmap_base = map_bitmap_region();
1935   if (bitmap_base == NULL) {
1936     return;
1937   }
1938   for (int i=0; i&lt;num_ranges; i++) {
1939     FileMapRegion* si = space_at(i + first_region_idx);
1940     HeapShared::patch_archived_heap_embedded_pointers(
1941       ranges[i],
1942       (address)(space_at(MetaspaceShared::bm)-&gt;mapped_base()) + si-&gt;oopmap_offset(),
1943       si-&gt;oopmap_size_in_bits());
1944   }
1945 }
1946 
1947 // This internally allocates objects using SystemDictionary::Object_klass(), so it
1948 // must be called after the well-known classes are resolved.
1949 void FileMapInfo::fixup_mapped_heap_regions() {
1950   // If any closed regions were found, call the fill routine to make them parseable.
1951   // Note that closed_archive_heap_ranges may be non-NULL even if no ranges were found.
1952   if (num_closed_archive_heap_ranges != 0) {
1953     assert(closed_archive_heap_ranges != NULL,
1954            &quot;Null closed_archive_heap_ranges array with non-zero count&quot;);
1955     G1CollectedHeap::heap()-&gt;fill_archive_regions(closed_archive_heap_ranges,
1956                                                   num_closed_archive_heap_ranges);
1957   }
1958 
1959   // do the same for mapped open archive heap regions
1960   if (num_open_archive_heap_ranges != 0) {
1961     assert(open_archive_heap_ranges != NULL, &quot;NULL open_archive_heap_ranges array with non-zero count&quot;);
1962     G1CollectedHeap::heap()-&gt;fill_archive_regions(open_archive_heap_ranges,
1963                                                   num_open_archive_heap_ranges);
1964   }
1965 }
1966 
1967 // dealloc the archive regions from java heap
1968 void FileMapInfo::dealloc_archive_heap_regions(MemRegion* regions, int num) {
1969   if (num &gt; 0) {
1970     assert(regions != NULL, &quot;Null archive ranges array with non-zero count&quot;);
1971     G1CollectedHeap::heap()-&gt;dealloc_archive_regions(regions, num);
1972   }
1973 }
1974 #endif // INCLUDE_CDS_JAVA_HEAP
1975 
1976 bool FileMapInfo::region_crc_check(char* buf, size_t size, int expected_crc) {
1977   int crc = ClassLoader::crc32(0, buf, (jint)size);
1978   if (crc != expected_crc) {
1979     fail_continue(&quot;Checksum verification failed.&quot;);
1980     return false;
1981   }
1982   return true;
1983 }
1984 
1985 bool FileMapInfo::verify_region_checksum(int i) {
1986   assert(VerifySharedSpaces, &quot;sanity&quot;);
1987   size_t sz = space_at(i)-&gt;used();
1988 
1989   if (sz == 0) {
1990     return true; // no data
1991   } else {
1992     return region_crc_check(region_addr(i), sz, space_at(i)-&gt;crc());
1993   }
1994 }
1995 
1996 void FileMapInfo::unmap_regions(int regions[], int num_regions) {
1997   for (int r = 0; r &lt; num_regions; r++) {
1998     int idx = regions[r];
1999     unmap_region(idx);
2000   }
2001 }
2002 
2003 // Unmap a memory region in the address space.
2004 
2005 void FileMapInfo::unmap_region(int i) {
2006   assert(!HeapShared::is_heap_region(i), &quot;sanity&quot;);
2007   FileMapRegion* si = space_at(i);
2008   char* mapped_base = si-&gt;mapped_base();
2009   size_t used = si-&gt;used();
2010   size_t size = align_up(used, os::vm_allocation_granularity());
2011 
2012   if (mapped_base != NULL) {
2013     if (size &gt; 0 &amp;&amp; si-&gt;mapped_from_file()) {
2014       log_info(cds)(&quot;Unmapping region #%d at base &quot; INTPTR_FORMAT &quot; (%s)&quot;, i, p2i(mapped_base),
2015                     shared_region_name[i]);
2016       if (!os::unmap_memory(mapped_base, size)) {
2017         fatal(&quot;os::unmap_memory failed&quot;);
2018       }
2019     }
2020     si-&gt;set_mapped_base(NULL);
2021   }
2022 }
2023 
2024 void FileMapInfo::assert_mark(bool check) {
2025   if (!check) {
2026     fail_stop(&quot;Mark mismatch while restoring from shared file.&quot;);
2027   }
2028 }
2029 
2030 void FileMapInfo::metaspace_pointers_do(MetaspaceClosure* it, bool use_copy) {
2031   if (use_copy) {
2032     _saved_shared_path_table.metaspace_pointers_do(it);
2033   } else {
2034     _shared_path_table.metaspace_pointers_do(it);
2035   }
2036 }
2037 
2038 FileMapInfo* FileMapInfo::_current_info = NULL;
2039 FileMapInfo* FileMapInfo::_dynamic_archive_info = NULL;
2040 bool FileMapInfo::_heap_pointers_need_patching = false;
2041 SharedPathTable FileMapInfo::_shared_path_table;
2042 SharedPathTable FileMapInfo::_saved_shared_path_table;
2043 bool FileMapInfo::_validating_shared_path_table = false;
2044 bool FileMapInfo::_memory_mapping_failed = false;
2045 GrowableArray&lt;const char*&gt;* FileMapInfo::_non_existent_class_paths = NULL;
2046 
2047 // Open the shared archive file, read and validate the header
2048 // information (version, boot classpath, etc.).  If initialization
2049 // fails, shared spaces are disabled and the file is closed. [See
2050 // fail_continue.]
2051 //
2052 // Validation of the archive is done in two steps:
2053 //
2054 // [1] validate_header() - done here.
2055 // [2] validate_shared_path_table - this is done later, because the table is in the RW
2056 //     region of the archive, which is not mapped yet.
2057 bool FileMapInfo::initialize() {
2058   assert(UseSharedSpaces, &quot;UseSharedSpaces expected.&quot;);
2059 
2060   if (JvmtiExport::should_post_class_file_load_hook() &amp;&amp; JvmtiExport::has_early_class_hook_env()) {
2061     // CDS assumes that no classes resolved in SystemDictionary::resolve_well_known_classes
2062     // are replaced at runtime by JVMTI ClassFileLoadHook. All of those classes are resolved
2063     // during the JVMTI &quot;early&quot; stage, so we can still use CDS if
2064     // JvmtiExport::has_early_class_hook_env() is false.
2065     FileMapInfo::fail_continue(&quot;CDS is disabled because early JVMTI ClassFileLoadHook is in use.&quot;);
2066     return false;
2067   }
2068 
2069   if (!open_for_read()) {
2070     return false;
2071   }
2072   if (!init_from_file(_fd)) {
2073     return false;
2074   }
2075   if (!validate_header()) {
2076     return false;
2077   }
2078   return true;
2079 }
2080 
2081 char* FileMapInfo::region_addr(int idx) {
2082   FileMapRegion* si = space_at(idx);
2083   if (HeapShared::is_heap_region(idx)) {
2084     assert(DumpSharedSpaces, &quot;The following doesn&#39;t work at runtime&quot;);
2085     return si-&gt;used() &gt; 0 ?
2086           (char*)start_address_as_decoded_with_current_oop_encoding_mode(si) : NULL;
2087   } else {
2088     return si-&gt;mapped_base();
2089   }
2090 }
2091 
2092 // The 3 core spaces are MC-&gt;RW-&gt;RO
2093 FileMapRegion* FileMapInfo::first_core_space() const {
2094   return space_at(MetaspaceShared::mc);
2095 }
2096 
2097 FileMapRegion* FileMapInfo::last_core_space() const {
2098   return space_at(MetaspaceShared::ro);
2099 }
2100 
2101 int FileMapHeader::compute_crc() {
2102   char* start = (char*)this;
2103   // start computing from the field after _crc
2104   char* buf = (char*)&amp;_crc + sizeof(_crc);
2105   size_t sz = _header_size - (buf - start);
2106   int crc = ClassLoader::crc32(0, buf, (jint)sz);
2107   return crc;
2108 }
2109 
2110 // This function should only be called during run time with UseSharedSpaces enabled.
2111 bool FileMapHeader::validate() {
2112   if (_obj_alignment != ObjectAlignmentInBytes) {
2113     FileMapInfo::fail_continue(&quot;The shared archive file&#39;s ObjectAlignmentInBytes of %d&quot;
2114                   &quot; does not equal the current ObjectAlignmentInBytes of &quot; INTX_FORMAT &quot;.&quot;,
2115                   _obj_alignment, ObjectAlignmentInBytes);
2116     return false;
2117   }
2118   if (_compact_strings != CompactStrings) {
2119     FileMapInfo::fail_continue(&quot;The shared archive file&#39;s CompactStrings setting (%s)&quot;
2120                   &quot; does not equal the current CompactStrings setting (%s).&quot;,
2121                   _compact_strings ? &quot;enabled&quot; : &quot;disabled&quot;,
2122                   CompactStrings   ? &quot;enabled&quot; : &quot;disabled&quot;);
2123     return false;
2124   }
2125 
2126   // This must be done after header validation because it might change the
2127   // header data
2128   const char* prop = Arguments::get_property(&quot;java.system.class.loader&quot;);
2129   if (prop != NULL) {
2130     warning(&quot;Archived non-system classes are disabled because the &quot;
2131             &quot;java.system.class.loader property is specified (value = \&quot;%s\&quot;). &quot;
2132             &quot;To use archived non-system classes, this property must not be set&quot;, prop);
2133     _has_platform_or_app_classes = false;
2134   }
2135 
2136   // For backwards compatibility, we don&#39;t check the verification setting
2137   // if the archive only contains system classes.
2138   if (_has_platform_or_app_classes &amp;&amp;
2139       ((!_verify_local &amp;&amp; BytecodeVerificationLocal) ||
2140        (!_verify_remote &amp;&amp; BytecodeVerificationRemote))) {
2141     FileMapInfo::fail_continue(&quot;The shared archive file was created with less restrictive &quot;
2142                   &quot;verification setting than the current setting.&quot;);
2143     return false;
2144   }
2145 
2146   // Java agents are allowed during run time. Therefore, the following condition is not
2147   // checked: (!_allow_archiving_with_java_agent &amp;&amp; AllowArchivingWithJavaAgent)
2148   // Note: _allow_archiving_with_java_agent is set in the shared archive during dump time
2149   // while AllowArchivingWithJavaAgent is set during the current run.
2150   if (_allow_archiving_with_java_agent &amp;&amp; !AllowArchivingWithJavaAgent) {
2151     FileMapInfo::fail_continue(&quot;The setting of the AllowArchivingWithJavaAgent is different &quot;
2152                                &quot;from the setting in the shared archive.&quot;);
2153     return false;
2154   }
2155 
2156   if (_allow_archiving_with_java_agent) {
2157     warning(&quot;This archive was created with AllowArchivingWithJavaAgent. It should be used &quot;
2158             &quot;for testing purposes only and should not be used in a production environment&quot;);
2159   }
2160 
2161   log_info(cds)(&quot;Archive was created with UseCompressedOops = %d, UseCompressedClassPointers = %d&quot;,
2162                           compressed_oops(), compressed_class_pointers());
2163   if (compressed_oops() != UseCompressedOops || compressed_class_pointers() != UseCompressedClassPointers) {
2164     FileMapInfo::fail_continue(&quot;Unable to use shared archive.\nThe saved state of UseCompressedOops and UseCompressedClassPointers is &quot;
2165                                &quot;different from runtime, CDS will be disabled.&quot;);
2166     return false;
2167   }
2168 
2169   if (!_use_optimized_module_handling) {
2170     MetaspaceShared::disable_optimized_module_handling();
2171     log_info(cds)(&quot;use_optimized_module_handling disabled: archive was created without optimized module handling&quot;);
2172   }
2173 
2174   return true;
2175 }
2176 
2177 bool FileMapInfo::validate_header() {
2178   if (!header()-&gt;validate()) {
2179     return false;
2180   }
2181   if (_is_static) {
2182     return true;
2183   } else {
2184     return DynamicArchive::validate(this);
2185   }
2186 }
2187 
2188 // Check if a given address is within one of the shared regions
2189 bool FileMapInfo::is_in_shared_region(const void* p, int idx) {
2190   assert(idx == MetaspaceShared::ro ||
2191          idx == MetaspaceShared::rw ||
2192          idx == MetaspaceShared::mc, &quot;invalid region index&quot;);
2193   char* base = region_addr(idx);
2194   if (p &gt;= base &amp;&amp; p &lt; base + space_at(idx)-&gt;used()) {
2195     return true;
2196   }
2197   return false;
2198 }
2199 
2200 // Unmap mapped regions of shared space.
2201 void FileMapInfo::stop_sharing_and_unmap(const char* msg) {
2202   MetaspaceShared::set_shared_metaspace_range(NULL, NULL, NULL);
2203 
2204   FileMapInfo *map_info = FileMapInfo::current_info();
2205   if (map_info) {
2206     map_info-&gt;fail_continue(&quot;%s&quot;, msg);
2207     for (int i = 0; i &lt; MetaspaceShared::num_non_heap_spaces; i++) {
2208       if (!HeapShared::is_heap_region(i)) {
2209         map_info-&gt;unmap_region(i);
2210       }
2211     }
2212     // Dealloc the archive heap regions only without unmapping. The regions are part
2213     // of the java heap. Unmapping of the heap regions are managed by GC.
2214     map_info-&gt;dealloc_archive_heap_regions(open_archive_heap_ranges,
2215                                            num_open_archive_heap_ranges);
2216     map_info-&gt;dealloc_archive_heap_regions(closed_archive_heap_ranges,
2217                                            num_closed_archive_heap_ranges);
2218   } else if (DumpSharedSpaces) {
2219     fail_stop(&quot;%s&quot;, msg);
2220   }
2221 }
2222 
2223 #if INCLUDE_JVMTI
2224 ClassPathEntry** FileMapInfo::_classpath_entries_for_jvmti = NULL;
2225 
2226 ClassPathEntry* FileMapInfo::get_classpath_entry_for_jvmti(int i, TRAPS) {
2227   ClassPathEntry* ent = _classpath_entries_for_jvmti[i];
2228   if (ent == NULL) {
2229     if (i == 0) {
2230       ent = ClassLoader::get_jrt_entry();
2231       assert(ent != NULL, &quot;must be&quot;);
2232     } else {
2233       SharedClassPathEntry* scpe = shared_path(i);
2234       assert(scpe-&gt;is_jar(), &quot;must be&quot;); // other types of scpe will not produce archived classes
2235 
2236       const char* path = scpe-&gt;name();
2237       struct stat st;
2238       if (os::stat(path, &amp;st) != 0) {
2239         char *msg = NEW_RESOURCE_ARRAY_IN_THREAD(THREAD, char, strlen(path) + 128); ;
2240         jio_snprintf(msg, strlen(path) + 127, &quot;error in opening JAR file %s&quot;, path);
2241         THROW_MSG_(vmSymbols::java_io_IOException(), msg, NULL);
2242       } else {
2243         ent = ClassLoader::create_class_path_entry(path, &amp;st, /*throw_exception=*/true, false, false, CHECK_NULL);
2244       }
2245     }
2246 
2247     MutexLocker mu(THREAD, CDSClassFileStream_lock);
2248     if (_classpath_entries_for_jvmti[i] == NULL) {
2249       _classpath_entries_for_jvmti[i] = ent;
2250     } else {
2251       // Another thread has beat me to creating this entry
2252       delete ent;
2253       ent = _classpath_entries_for_jvmti[i];
2254     }
2255   }
2256 
2257   return ent;
2258 }
2259 
2260 ClassFileStream* FileMapInfo::open_stream_for_jvmti(InstanceKlass* ik, Handle class_loader, TRAPS) {
2261   int path_index = ik-&gt;shared_classpath_index();
2262   assert(path_index &gt;= 0, &quot;should be called for shared built-in classes only&quot;);
2263   assert(path_index &lt; (int)get_number_of_shared_paths(), &quot;sanity&quot;);
2264 
2265   ClassPathEntry* cpe = get_classpath_entry_for_jvmti(path_index, CHECK_NULL);
2266   assert(cpe != NULL, &quot;must be&quot;);
2267 
2268   Symbol* name = ik-&gt;name();
2269   const char* const class_name = name-&gt;as_C_string();
2270   const char* const file_name = ClassLoader::file_name_for_class_name(class_name,
2271                                                                       name-&gt;utf8_length());
2272   ClassLoaderData* loader_data = ClassLoaderData::class_loader_data(class_loader());
2273   ClassFileStream* cfs = cpe-&gt;open_stream_for_loader(file_name, loader_data, THREAD);
2274   assert(cfs != NULL, &quot;must be able to read the classfile data of shared classes for built-in loaders.&quot;);
2275   log_debug(cds, jvmti)(&quot;classfile data for %s [%d: %s] = %d bytes&quot;, class_name, path_index,
2276                         cfs-&gt;source(), cfs-&gt;length());
2277   return cfs;
2278 }
2279 
2280 #endif
    </pre>
  </body>
</html>