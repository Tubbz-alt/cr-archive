<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/hotspot/share/interpreter/interpreterRuntime.cpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
  </head>
<body>
<center><a href="interpreter.hpp.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="interpreterRuntime.hpp.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/hotspot/share/interpreter/interpreterRuntime.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 336       // and fall through...
 337     }
 338     if (trap_mdo != NULL) {
 339       // Update per-method count of trap events.  The interpreter
 340       // is updating the MDO to simulate the effect of compiler traps.
 341       Deoptimization::update_method_data_from_interpreter(trap_mdo, trap_bci, reason);
 342     }
 343   }
 344 }
 345 
 346 // Assume the compiler is (or will be) interested in this event.
 347 // If necessary, create an MDO to hold the information, and record it.
 348 void InterpreterRuntime::note_trap(JavaThread* thread, int reason, TRAPS) {
 349   assert(ProfileTraps, &quot;call me only if profiling&quot;);
 350   LastFrameAccessor last_frame(thread);
 351   methodHandle trap_method(thread, last_frame.method());
 352   int trap_bci = trap_method-&gt;bci_from(last_frame.bcp());
 353   note_trap_inner(thread, reason, trap_method, trap_bci, THREAD);
 354 }
 355 
<span class="line-removed"> 356 #ifdef CC_INTERP</span>
<span class="line-removed"> 357 // As legacy note_trap, but we have more arguments.</span>
<span class="line-removed"> 358 JRT_ENTRY(void, InterpreterRuntime::note_trap(JavaThread* thread, int reason, Method *method, int trap_bci))</span>
<span class="line-removed"> 359   methodHandle trap_method(thread, method);</span>
<span class="line-removed"> 360   note_trap_inner(thread, reason, trap_method, trap_bci, THREAD);</span>
<span class="line-removed"> 361 JRT_END</span>
<span class="line-removed"> 362 </span>
<span class="line-removed"> 363 // Class Deoptimization is not visible in BytecodeInterpreter, so we need a wrapper</span>
<span class="line-removed"> 364 // for each exception.</span>
<span class="line-removed"> 365 void InterpreterRuntime::note_nullCheck_trap(JavaThread* thread, Method *method, int trap_bci)</span>
<span class="line-removed"> 366   { if (ProfileTraps) note_trap(thread, Deoptimization::Reason_null_check, method, trap_bci); }</span>
<span class="line-removed"> 367 void InterpreterRuntime::note_div0Check_trap(JavaThread* thread, Method *method, int trap_bci)</span>
<span class="line-removed"> 368   { if (ProfileTraps) note_trap(thread, Deoptimization::Reason_div0_check, method, trap_bci); }</span>
<span class="line-removed"> 369 void InterpreterRuntime::note_rangeCheck_trap(JavaThread* thread, Method *method, int trap_bci)</span>
<span class="line-removed"> 370   { if (ProfileTraps) note_trap(thread, Deoptimization::Reason_range_check, method, trap_bci); }</span>
<span class="line-removed"> 371 void InterpreterRuntime::note_classCheck_trap(JavaThread* thread, Method *method, int trap_bci)</span>
<span class="line-removed"> 372   { if (ProfileTraps) note_trap(thread, Deoptimization::Reason_class_check, method, trap_bci); }</span>
<span class="line-removed"> 373 void InterpreterRuntime::note_arrayCheck_trap(JavaThread* thread, Method *method, int trap_bci)</span>
<span class="line-removed"> 374   { if (ProfileTraps) note_trap(thread, Deoptimization::Reason_array_check, method, trap_bci); }</span>
<span class="line-removed"> 375 #endif // CC_INTERP</span>
<span class="line-removed"> 376 </span>
<span class="line-removed"> 377 </span>
 378 static Handle get_preinitialized_exception(Klass* k, TRAPS) {
 379   // get klass
 380   InstanceKlass* klass = InstanceKlass::cast(k);
 381   assert(klass-&gt;is_initialized(),
 382          &quot;this klass should have been initialized during VM initialization&quot;);
 383   // create instance - do not call constructor since we may have no
 384   // (java) stack space left (should assert constructor is empty)
 385   Handle exception;
 386   oop exception_oop = klass-&gt;allocate_instance(CHECK_(exception));
 387   exception = Handle(THREAD, exception_oop);
 388   if (StackTraceInThrowable) {
 389     java_lang_Throwable::fill_in_stack_trace(exception);
 390   }
 391   return exception;
 392 }
 393 
 394 // Special handling for stack overflow: since we don&#39;t have any (java) stack
 395 // space left we use the pre-allocated &amp; pre-initialized StackOverflowError
 396 // klass to create an stack overflow error instance.  We do not call its
 397 // constructor for the same reason (it is empty, anyway).
</pre>
<hr />
<pre>
 484 // invoke w/o arguments (i.e., as if one were inside the call).
 485 JRT_ENTRY(address, InterpreterRuntime::exception_handler_for_exception(JavaThread* thread, oopDesc* exception))
 486 
 487   LastFrameAccessor last_frame(thread);
 488   Handle             h_exception(thread, exception);
 489   methodHandle       h_method   (thread, last_frame.method());
 490   constantPoolHandle h_constants(thread, h_method-&gt;constants());
 491   bool               should_repeat;
 492   int                handler_bci;
 493   int                current_bci = last_frame.bci();
 494 
 495   if (thread-&gt;frames_to_pop_failed_realloc() &gt; 0) {
 496     // Allocation of scalar replaced object used in this frame
 497     // failed. Unconditionally pop the frame.
 498     thread-&gt;dec_frames_to_pop_failed_realloc();
 499     thread-&gt;set_vm_result(h_exception());
 500     // If the method is synchronized we already unlocked the monitor
 501     // during deoptimization so the interpreter needs to skip it when
 502     // the frame is popped.
 503     thread-&gt;set_do_not_unlock_if_synchronized(true);
<span class="line-removed"> 504 #ifdef CC_INTERP</span>
<span class="line-removed"> 505     return (address) -1;</span>
<span class="line-removed"> 506 #else</span>
 507     return Interpreter::remove_activation_entry();
<span class="line-removed"> 508 #endif</span>
 509   }
 510 
 511   // Need to do this check first since when _do_not_unlock_if_synchronized
 512   // is set, we don&#39;t want to trigger any classloading which may make calls
 513   // into java, or surprisingly find a matching exception handler for bci 0
 514   // since at this moment the method hasn&#39;t been &quot;officially&quot; entered yet.
 515   if (thread-&gt;do_not_unlock_if_synchronized()) {
 516     ResourceMark rm;
 517     assert(current_bci == 0,  &quot;bci isn&#39;t zero for do_not_unlock_if_synchronized&quot;);
 518     thread-&gt;set_vm_result(exception);
<span class="line-removed"> 519 #ifdef CC_INTERP</span>
<span class="line-removed"> 520     return (address) -1;</span>
<span class="line-removed"> 521 #else</span>
 522     return Interpreter::remove_activation_entry();
<span class="line-removed"> 523 #endif</span>
 524   }
 525 
 526   do {
 527     should_repeat = false;
 528 
 529     // assertions
 530 #ifdef ASSERT
 531     assert(h_exception.not_null(), &quot;NULL exceptions should be handled by athrow&quot;);
 532     // Check that exception is a subclass of Throwable, otherwise we have a VerifyError
 533     if (!(h_exception-&gt;is_a(SystemDictionary::Throwable_klass()))) {
 534       if (ExitVMOnVerifyError) vm_exit(-1);
 535       ShouldNotReachHere();
 536     }
 537 #endif
 538 
 539     // tracing
 540     if (log_is_enabled(Info, exceptions)) {
 541       ResourceMark rm(thread);
 542       stringStream tempst;
 543       tempst.print(&quot;interpreter method &lt;%s&gt;\n&quot;
</pre>
<hr />
<pre>
 573     }
 574   } while (should_repeat == true);
 575 
 576 #if INCLUDE_JVMCI
 577   if (EnableJVMCI &amp;&amp; h_method-&gt;method_data() != NULL) {
 578     ResourceMark rm(thread);
 579     ProfileData* pdata = h_method-&gt;method_data()-&gt;allocate_bci_to_data(current_bci, NULL);
 580     if (pdata != NULL &amp;&amp; pdata-&gt;is_BitData()) {
 581       BitData* bit_data = (BitData*) pdata;
 582       bit_data-&gt;set_exception_seen();
 583     }
 584   }
 585 #endif
 586 
 587   // notify JVMTI of an exception throw; JVMTI will detect if this is a first
 588   // time throw or a stack unwinding throw and accordingly notify the debugger
 589   if (JvmtiExport::can_post_on_exceptions()) {
 590     JvmtiExport::post_exception_throw(thread, h_method(), last_frame.bcp(), h_exception());
 591   }
 592 
<span class="line-removed"> 593 #ifdef CC_INTERP</span>
<span class="line-removed"> 594   address continuation = (address)(intptr_t) handler_bci;</span>
<span class="line-removed"> 595 #else</span>
 596   address continuation = NULL;
<span class="line-removed"> 597 #endif</span>
 598   address handler_pc = NULL;
 599   if (handler_bci &lt; 0 || !thread-&gt;reguard_stack((address) &amp;continuation)) {
 600     // Forward exception to callee (leaving bci/bcp untouched) because (a) no
 601     // handler in this method, or (b) after a stack overflow there is not yet
 602     // enough stack space available to reprotect the stack.
<span class="line-removed"> 603 #ifndef CC_INTERP</span>
 604     continuation = Interpreter::remove_activation_entry();
<span class="line-removed"> 605 #endif</span>
 606 #if COMPILER2_OR_JVMCI
 607     // Count this for compilation purposes
 608     h_method-&gt;interpreter_throwout_increment(THREAD);
 609 #endif
 610   } else {
 611     // handler in this method =&gt; change bci/bcp to handler bci/bcp and continue there
 612     handler_pc = h_method-&gt;code_base() + handler_bci;
<span class="line-modified"> 613 #ifndef CC_INTERP</span>
 614     set_bcp_and_mdp(handler_pc, thread);
 615     continuation = Interpreter::dispatch_table(vtos)[*handler_pc];


 616 #endif
 617   }

 618   // notify debugger of an exception catch
 619   // (this is good for exceptions caught in native methods as well)
 620   if (JvmtiExport::can_post_on_exceptions()) {
 621     JvmtiExport::notice_unwind_due_to_exception(thread, h_method(), handler_pc, h_exception(), (handler_pc != NULL));
 622   }
 623 
 624   thread-&gt;set_vm_result(h_exception());
 625   return continuation;
 626 JRT_END
 627 
 628 
 629 JRT_ENTRY(void, InterpreterRuntime::throw_pending_exception(JavaThread* thread))
 630   assert(thread-&gt;has_pending_exception(), &quot;must only ne called if there&#39;s an exception pending&quot;);
 631   // nothing to do - eventually we should remove this code entirely (see comments @ call sites)
 632 JRT_END
 633 
 634 
 635 JRT_ENTRY(void, InterpreterRuntime::throw_AbstractMethodError(JavaThread* thread))
 636   THROW(vmSymbols::java_lang_AbstractMethodError());
 637 JRT_END
</pre>
</td>
<td>
<hr />
<pre>
 336       // and fall through...
 337     }
 338     if (trap_mdo != NULL) {
 339       // Update per-method count of trap events.  The interpreter
 340       // is updating the MDO to simulate the effect of compiler traps.
 341       Deoptimization::update_method_data_from_interpreter(trap_mdo, trap_bci, reason);
 342     }
 343   }
 344 }
 345 
 346 // Assume the compiler is (or will be) interested in this event.
 347 // If necessary, create an MDO to hold the information, and record it.
 348 void InterpreterRuntime::note_trap(JavaThread* thread, int reason, TRAPS) {
 349   assert(ProfileTraps, &quot;call me only if profiling&quot;);
 350   LastFrameAccessor last_frame(thread);
 351   methodHandle trap_method(thread, last_frame.method());
 352   int trap_bci = trap_method-&gt;bci_from(last_frame.bcp());
 353   note_trap_inner(thread, reason, trap_method, trap_bci, THREAD);
 354 }
 355 






















 356 static Handle get_preinitialized_exception(Klass* k, TRAPS) {
 357   // get klass
 358   InstanceKlass* klass = InstanceKlass::cast(k);
 359   assert(klass-&gt;is_initialized(),
 360          &quot;this klass should have been initialized during VM initialization&quot;);
 361   // create instance - do not call constructor since we may have no
 362   // (java) stack space left (should assert constructor is empty)
 363   Handle exception;
 364   oop exception_oop = klass-&gt;allocate_instance(CHECK_(exception));
 365   exception = Handle(THREAD, exception_oop);
 366   if (StackTraceInThrowable) {
 367     java_lang_Throwable::fill_in_stack_trace(exception);
 368   }
 369   return exception;
 370 }
 371 
 372 // Special handling for stack overflow: since we don&#39;t have any (java) stack
 373 // space left we use the pre-allocated &amp; pre-initialized StackOverflowError
 374 // klass to create an stack overflow error instance.  We do not call its
 375 // constructor for the same reason (it is empty, anyway).
</pre>
<hr />
<pre>
 462 // invoke w/o arguments (i.e., as if one were inside the call).
 463 JRT_ENTRY(address, InterpreterRuntime::exception_handler_for_exception(JavaThread* thread, oopDesc* exception))
 464 
 465   LastFrameAccessor last_frame(thread);
 466   Handle             h_exception(thread, exception);
 467   methodHandle       h_method   (thread, last_frame.method());
 468   constantPoolHandle h_constants(thread, h_method-&gt;constants());
 469   bool               should_repeat;
 470   int                handler_bci;
 471   int                current_bci = last_frame.bci();
 472 
 473   if (thread-&gt;frames_to_pop_failed_realloc() &gt; 0) {
 474     // Allocation of scalar replaced object used in this frame
 475     // failed. Unconditionally pop the frame.
 476     thread-&gt;dec_frames_to_pop_failed_realloc();
 477     thread-&gt;set_vm_result(h_exception());
 478     // If the method is synchronized we already unlocked the monitor
 479     // during deoptimization so the interpreter needs to skip it when
 480     // the frame is popped.
 481     thread-&gt;set_do_not_unlock_if_synchronized(true);



 482     return Interpreter::remove_activation_entry();

 483   }
 484 
 485   // Need to do this check first since when _do_not_unlock_if_synchronized
 486   // is set, we don&#39;t want to trigger any classloading which may make calls
 487   // into java, or surprisingly find a matching exception handler for bci 0
 488   // since at this moment the method hasn&#39;t been &quot;officially&quot; entered yet.
 489   if (thread-&gt;do_not_unlock_if_synchronized()) {
 490     ResourceMark rm;
 491     assert(current_bci == 0,  &quot;bci isn&#39;t zero for do_not_unlock_if_synchronized&quot;);
 492     thread-&gt;set_vm_result(exception);



 493     return Interpreter::remove_activation_entry();

 494   }
 495 
 496   do {
 497     should_repeat = false;
 498 
 499     // assertions
 500 #ifdef ASSERT
 501     assert(h_exception.not_null(), &quot;NULL exceptions should be handled by athrow&quot;);
 502     // Check that exception is a subclass of Throwable, otherwise we have a VerifyError
 503     if (!(h_exception-&gt;is_a(SystemDictionary::Throwable_klass()))) {
 504       if (ExitVMOnVerifyError) vm_exit(-1);
 505       ShouldNotReachHere();
 506     }
 507 #endif
 508 
 509     // tracing
 510     if (log_is_enabled(Info, exceptions)) {
 511       ResourceMark rm(thread);
 512       stringStream tempst;
 513       tempst.print(&quot;interpreter method &lt;%s&gt;\n&quot;
</pre>
<hr />
<pre>
 543     }
 544   } while (should_repeat == true);
 545 
 546 #if INCLUDE_JVMCI
 547   if (EnableJVMCI &amp;&amp; h_method-&gt;method_data() != NULL) {
 548     ResourceMark rm(thread);
 549     ProfileData* pdata = h_method-&gt;method_data()-&gt;allocate_bci_to_data(current_bci, NULL);
 550     if (pdata != NULL &amp;&amp; pdata-&gt;is_BitData()) {
 551       BitData* bit_data = (BitData*) pdata;
 552       bit_data-&gt;set_exception_seen();
 553     }
 554   }
 555 #endif
 556 
 557   // notify JVMTI of an exception throw; JVMTI will detect if this is a first
 558   // time throw or a stack unwinding throw and accordingly notify the debugger
 559   if (JvmtiExport::can_post_on_exceptions()) {
 560     JvmtiExport::post_exception_throw(thread, h_method(), last_frame.bcp(), h_exception());
 561   }
 562 



 563   address continuation = NULL;

 564   address handler_pc = NULL;
 565   if (handler_bci &lt; 0 || !thread-&gt;reguard_stack((address) &amp;continuation)) {
 566     // Forward exception to callee (leaving bci/bcp untouched) because (a) no
 567     // handler in this method, or (b) after a stack overflow there is not yet
 568     // enough stack space available to reprotect the stack.

 569     continuation = Interpreter::remove_activation_entry();

 570 #if COMPILER2_OR_JVMCI
 571     // Count this for compilation purposes
 572     h_method-&gt;interpreter_throwout_increment(THREAD);
 573 #endif
 574   } else {
 575     // handler in this method =&gt; change bci/bcp to handler bci/bcp and continue there
 576     handler_pc = h_method-&gt;code_base() + handler_bci;
<span class="line-modified"> 577 #ifndef ZERO</span>
 578     set_bcp_and_mdp(handler_pc, thread);
 579     continuation = Interpreter::dispatch_table(vtos)[*handler_pc];
<span class="line-added"> 580 #else</span>
<span class="line-added"> 581     continuation = (address)(intptr_t) handler_bci;</span>
 582 #endif
 583   }
<span class="line-added"> 584 </span>
 585   // notify debugger of an exception catch
 586   // (this is good for exceptions caught in native methods as well)
 587   if (JvmtiExport::can_post_on_exceptions()) {
 588     JvmtiExport::notice_unwind_due_to_exception(thread, h_method(), handler_pc, h_exception(), (handler_pc != NULL));
 589   }
 590 
 591   thread-&gt;set_vm_result(h_exception());
 592   return continuation;
 593 JRT_END
 594 
 595 
 596 JRT_ENTRY(void, InterpreterRuntime::throw_pending_exception(JavaThread* thread))
 597   assert(thread-&gt;has_pending_exception(), &quot;must only ne called if there&#39;s an exception pending&quot;);
 598   // nothing to do - eventually we should remove this code entirely (see comments @ call sites)
 599 JRT_END
 600 
 601 
 602 JRT_ENTRY(void, InterpreterRuntime::throw_AbstractMethodError(JavaThread* thread))
 603   THROW(vmSymbols::java_lang_AbstractMethodError());
 604 JRT_END
</pre>
</td>
</tr>
</table>
<center><a href="interpreter.hpp.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="interpreterRuntime.hpp.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>