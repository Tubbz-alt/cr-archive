<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>New src/hotspot/os/bsd/os_bsd.cpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
  </head>
  <body>
    <pre>
   1 /*
   2  * Copyright (c) 1999, 2020, Oracle and/or its affiliates. All rights reserved.
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.
   8  *
   9  * This code is distributed in the hope that it will be useful, but WITHOUT
  10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  *
  23  */
  24 
  25 // no precompiled headers
  26 #include &quot;jvm.h&quot;
  27 #include &quot;classfile/classLoader.hpp&quot;
  28 #include &quot;classfile/systemDictionary.hpp&quot;
  29 #include &quot;classfile/vmSymbols.hpp&quot;
  30 #include &quot;code/icBuffer.hpp&quot;
  31 #include &quot;code/vtableStubs.hpp&quot;
  32 #include &quot;compiler/compileBroker.hpp&quot;
  33 #include &quot;compiler/disassembler.hpp&quot;
  34 #include &quot;interpreter/interpreter.hpp&quot;
  35 #include &quot;logging/log.hpp&quot;
  36 #include &quot;logging/logStream.hpp&quot;
  37 #include &quot;memory/allocation.inline.hpp&quot;
  38 #include &quot;memory/filemap.hpp&quot;
  39 #include &quot;oops/oop.inline.hpp&quot;
  40 #include &quot;os_bsd.inline.hpp&quot;
  41 #include &quot;os_posix.inline.hpp&quot;
  42 #include &quot;os_share_bsd.hpp&quot;
  43 #include &quot;prims/jniFastGetField.hpp&quot;
  44 #include &quot;prims/jvm_misc.hpp&quot;
  45 #include &quot;runtime/arguments.hpp&quot;
  46 #include &quot;runtime/atomic.hpp&quot;
  47 #include &quot;runtime/globals.hpp&quot;
  48 #include &quot;runtime/interfaceSupport.inline.hpp&quot;
  49 #include &quot;runtime/java.hpp&quot;
  50 #include &quot;runtime/javaCalls.hpp&quot;
  51 #include &quot;runtime/mutexLocker.hpp&quot;
  52 #include &quot;runtime/objectMonitor.hpp&quot;
  53 #include &quot;runtime/osThread.hpp&quot;
  54 #include &quot;runtime/perfMemory.hpp&quot;
  55 #include &quot;runtime/semaphore.hpp&quot;
  56 #include &quot;runtime/sharedRuntime.hpp&quot;
  57 #include &quot;runtime/statSampler.hpp&quot;
  58 #include &quot;runtime/stubRoutines.hpp&quot;
  59 #include &quot;runtime/thread.inline.hpp&quot;
  60 #include &quot;runtime/threadCritical.hpp&quot;
  61 #include &quot;runtime/timer.hpp&quot;
  62 #include &quot;services/attachListener.hpp&quot;
  63 #include &quot;services/memTracker.hpp&quot;
  64 #include &quot;services/runtimeService.hpp&quot;
  65 #include &quot;utilities/align.hpp&quot;
  66 #include &quot;utilities/decoder.hpp&quot;
  67 #include &quot;utilities/defaultStream.hpp&quot;
  68 #include &quot;utilities/events.hpp&quot;
  69 #include &quot;utilities/growableArray.hpp&quot;
  70 #include &quot;utilities/vmError.hpp&quot;
  71 
  72 // put OS-includes here
  73 # include &lt;dlfcn.h&gt;
  74 # include &lt;errno.h&gt;
  75 # include &lt;fcntl.h&gt;
  76 # include &lt;inttypes.h&gt;
  77 # include &lt;poll.h&gt;
  78 # include &lt;pthread.h&gt;
  79 # include &lt;pwd.h&gt;
  80 # include &lt;signal.h&gt;
  81 # include &lt;stdint.h&gt;
  82 # include &lt;stdio.h&gt;
  83 # include &lt;string.h&gt;
  84 # include &lt;sys/ioctl.h&gt;
  85 # include &lt;sys/mman.h&gt;
  86 # include &lt;sys/param.h&gt;
  87 # include &lt;sys/resource.h&gt;
  88 # include &lt;sys/socket.h&gt;
  89 # include &lt;sys/stat.h&gt;
  90 # include &lt;sys/syscall.h&gt;
  91 # include &lt;sys/sysctl.h&gt;
  92 # include &lt;sys/time.h&gt;
  93 # include &lt;sys/times.h&gt;
  94 # include &lt;sys/types.h&gt;
  95 # include &lt;sys/wait.h&gt;
  96 # include &lt;time.h&gt;
  97 # include &lt;unistd.h&gt;
  98 
  99 #if defined(__FreeBSD__) || defined(__NetBSD__)
 100   #include &lt;elf.h&gt;
 101 #endif
 102 
 103 #ifdef __APPLE__
 104   #include &lt;mach-o/dyld.h&gt;
 105 #endif
 106 
 107 #ifndef MAP_ANONYMOUS
 108   #define MAP_ANONYMOUS MAP_ANON
 109 #endif
 110 
 111 #define MAX_PATH    (2 * K)
 112 
 113 // for timer info max values which include all bits
 114 #define ALL_64_BITS CONST64(0xFFFFFFFFFFFFFFFF)
 115 
 116 ////////////////////////////////////////////////////////////////////////////////
 117 // global variables
 118 julong os::Bsd::_physical_memory = 0;
 119 
 120 #ifdef __APPLE__
 121 mach_timebase_info_data_t os::Bsd::_timebase_info = {0, 0};
 122 volatile uint64_t         os::Bsd::_max_abstime   = 0;
 123 #else
 124 int (*os::Bsd::_clock_gettime)(clockid_t, struct timespec *) = NULL;
 125 #endif
 126 pthread_t os::Bsd::_main_thread;
 127 int os::Bsd::_page_size = -1;
 128 
 129 static jlong initial_time_count=0;
 130 
 131 static int clock_tics_per_sec = 100;
 132 
 133 // For diagnostics to print a message once. see run_periodic_checks
 134 static sigset_t check_signal_done;
 135 static bool check_signals = true;
 136 
 137 // Signal number used to suspend/resume a thread
 138 
 139 // do not use any signal number less than SIGSEGV, see 4355769
 140 static int SR_signum = SIGUSR2;
 141 sigset_t SR_sigset;
 142 
 143 #ifdef __APPLE__
 144 static const int processor_id_unassigned = -1;
 145 static const int processor_id_assigning = -2;
 146 static const int processor_id_map_size = 256;
 147 static volatile int processor_id_map[processor_id_map_size];
 148 static volatile int processor_id_next = 0;
 149 #endif
 150 
 151 ////////////////////////////////////////////////////////////////////////////////
 152 // utility functions
 153 
 154 static int SR_initialize();
 155 
 156 julong os::available_memory() {
 157   return Bsd::available_memory();
 158 }
 159 
 160 // available here means free
 161 julong os::Bsd::available_memory() {
 162   uint64_t available = physical_memory() &gt;&gt; 2;
 163 #ifdef __APPLE__
 164   mach_msg_type_number_t count = HOST_VM_INFO64_COUNT;
 165   vm_statistics64_data_t vmstat;
 166   kern_return_t kerr = host_statistics64(mach_host_self(), HOST_VM_INFO64,
 167                                          (host_info64_t)&amp;vmstat, &amp;count);
 168   assert(kerr == KERN_SUCCESS,
 169          &quot;host_statistics64 failed - check mach_host_self() and count&quot;);
 170   if (kerr == KERN_SUCCESS) {
 171     available = vmstat.free_count * os::vm_page_size();
 172   }
 173 #endif
 174   return available;
 175 }
 176 
 177 // for more info see :
 178 // https://man.openbsd.org/sysctl.2
 179 void os::Bsd::print_uptime_info(outputStream* st) {
 180   struct timeval boottime;
 181   size_t len = sizeof(boottime);
 182   int mib[2];
 183   mib[0] = CTL_KERN;
 184   mib[1] = KERN_BOOTTIME;
 185 
 186   if (sysctl(mib, 2, &amp;boottime, &amp;len, NULL, 0) &gt;= 0) {
 187     time_t bootsec = boottime.tv_sec;
 188     time_t currsec = time(NULL);
 189     os::print_dhm(st, &quot;OS uptime:&quot;, (long) difftime(currsec, bootsec));
 190   }
 191 }
 192 
 193 julong os::physical_memory() {
 194   return Bsd::physical_memory();
 195 }
 196 
 197 // Return true if user is running as root.
 198 
 199 bool os::have_special_privileges() {
 200   static bool init = false;
 201   static bool privileges = false;
 202   if (!init) {
 203     privileges = (getuid() != geteuid()) || (getgid() != getegid());
 204     init = true;
 205   }
 206   return privileges;
 207 }
 208 
 209 
 210 
 211 // Cpu architecture string
 212 #if   defined(ZERO)
 213 static char cpu_arch[] = ZERO_LIBARCH;
 214 #elif defined(IA64)
 215 static char cpu_arch[] = &quot;ia64&quot;;
 216 #elif defined(IA32)
 217 static char cpu_arch[] = &quot;i386&quot;;
 218 #elif defined(AMD64)
 219 static char cpu_arch[] = &quot;amd64&quot;;
 220 #elif defined(ARM)
 221 static char cpu_arch[] = &quot;arm&quot;;
 222 #elif defined(PPC32)
 223 static char cpu_arch[] = &quot;ppc&quot;;
 224 #else
 225   #error Add appropriate cpu_arch setting
 226 #endif
 227 
 228 // Compiler variant
 229 #ifdef COMPILER2
 230   #define COMPILER_VARIANT &quot;server&quot;
 231 #else
 232   #define COMPILER_VARIANT &quot;client&quot;
 233 #endif
 234 
 235 
 236 void os::Bsd::initialize_system_info() {
 237   int mib[2];
 238   size_t len;
 239   int cpu_val;
 240   julong mem_val;
 241 
 242   // get processors count via hw.ncpus sysctl
 243   mib[0] = CTL_HW;
 244   mib[1] = HW_NCPU;
 245   len = sizeof(cpu_val);
 246   if (sysctl(mib, 2, &amp;cpu_val, &amp;len, NULL, 0) != -1 &amp;&amp; cpu_val &gt;= 1) {
 247     assert(len == sizeof(cpu_val), &quot;unexpected data size&quot;);
 248     set_processor_count(cpu_val);
 249   } else {
 250     set_processor_count(1);   // fallback
 251   }
 252 
 253 #ifdef __APPLE__
 254   // initialize processor id map
 255   for (int i = 0; i &lt; processor_id_map_size; i++) {
 256     processor_id_map[i] = processor_id_unassigned;
 257   }
 258 #endif
 259 
 260   // get physical memory via hw.memsize sysctl (hw.memsize is used
 261   // since it returns a 64 bit value)
 262   mib[0] = CTL_HW;
 263 
 264 #if defined (HW_MEMSIZE) // Apple
 265   mib[1] = HW_MEMSIZE;
 266 #elif defined(HW_PHYSMEM) // Most of BSD
 267   mib[1] = HW_PHYSMEM;
 268 #elif defined(HW_REALMEM) // Old FreeBSD
 269   mib[1] = HW_REALMEM;
 270 #else
 271   #error No ways to get physmem
 272 #endif
 273 
 274   len = sizeof(mem_val);
 275   if (sysctl(mib, 2, &amp;mem_val, &amp;len, NULL, 0) != -1) {
 276     assert(len == sizeof(mem_val), &quot;unexpected data size&quot;);
 277     _physical_memory = mem_val;
 278   } else {
 279     _physical_memory = 256 * 1024 * 1024;       // fallback (XXXBSD?)
 280   }
 281 
 282 #ifdef __OpenBSD__
 283   {
 284     // limit _physical_memory memory view on OpenBSD since
 285     // datasize rlimit restricts us anyway.
 286     struct rlimit limits;
 287     getrlimit(RLIMIT_DATA, &amp;limits);
 288     _physical_memory = MIN2(_physical_memory, (julong)limits.rlim_cur);
 289   }
 290 #endif
 291 }
 292 
 293 #ifdef __APPLE__
 294 static const char *get_home() {
 295   const char *home_dir = ::getenv(&quot;HOME&quot;);
 296   if ((home_dir == NULL) || (*home_dir == &#39;\0&#39;)) {
 297     struct passwd *passwd_info = getpwuid(geteuid());
 298     if (passwd_info != NULL) {
 299       home_dir = passwd_info-&gt;pw_dir;
 300     }
 301   }
 302 
 303   return home_dir;
 304 }
 305 #endif
 306 
 307 void os::init_system_properties_values() {
 308   // The next steps are taken in the product version:
 309   //
 310   // Obtain the JAVA_HOME value from the location of libjvm.so.
 311   // This library should be located at:
 312   // &lt;JAVA_HOME&gt;/jre/lib/&lt;arch&gt;/{client|server}/libjvm.so.
 313   //
 314   // If &quot;/jre/lib/&quot; appears at the right place in the path, then we
 315   // assume libjvm.so is installed in a JDK and we use this path.
 316   //
 317   // Otherwise exit with message: &quot;Could not create the Java virtual machine.&quot;
 318   //
 319   // The following extra steps are taken in the debugging version:
 320   //
 321   // If &quot;/jre/lib/&quot; does NOT appear at the right place in the path
 322   // instead of exit check for $JAVA_HOME environment variable.
 323   //
 324   // If it is defined and we are able to locate $JAVA_HOME/jre/lib/&lt;arch&gt;,
 325   // then we append a fake suffix &quot;hotspot/libjvm.so&quot; to this path so
 326   // it looks like libjvm.so is installed there
 327   // &lt;JAVA_HOME&gt;/jre/lib/&lt;arch&gt;/hotspot/libjvm.so.
 328   //
 329   // Otherwise exit.
 330   //
 331   // Important note: if the location of libjvm.so changes this
 332   // code needs to be changed accordingly.
 333 
 334   // See ld(1):
 335   //      The linker uses the following search paths to locate required
 336   //      shared libraries:
 337   //        1: ...
 338   //        ...
 339   //        7: The default directories, normally /lib and /usr/lib.
 340 #ifndef DEFAULT_LIBPATH
 341   #ifndef OVERRIDE_LIBPATH
 342     #define DEFAULT_LIBPATH &quot;/lib:/usr/lib&quot;
 343   #else
 344     #define DEFAULT_LIBPATH OVERRIDE_LIBPATH
 345   #endif
 346 #endif
 347 
 348 // Base path of extensions installed on the system.
 349 #define SYS_EXT_DIR     &quot;/usr/java/packages&quot;
 350 #define EXTENSIONS_DIR  &quot;/lib/ext&quot;
 351 
 352 #ifndef __APPLE__
 353 
 354   // Buffer that fits several sprintfs.
 355   // Note that the space for the colon and the trailing null are provided
 356   // by the nulls included by the sizeof operator.
 357   const size_t bufsize =
 358     MAX2((size_t)MAXPATHLEN,  // For dll_dir &amp; friends.
 359          (size_t)MAXPATHLEN + sizeof(EXTENSIONS_DIR) + sizeof(SYS_EXT_DIR) + sizeof(EXTENSIONS_DIR)); // extensions dir
 360   char *buf = NEW_C_HEAP_ARRAY(char, bufsize, mtInternal);
 361 
 362   // sysclasspath, java_home, dll_dir
 363   {
 364     char *pslash;
 365     os::jvm_path(buf, bufsize);
 366 
 367     // Found the full path to libjvm.so.
 368     // Now cut the path to &lt;java_home&gt;/jre if we can.
 369     *(strrchr(buf, &#39;/&#39;)) = &#39;\0&#39;; // Get rid of /libjvm.so.
 370     pslash = strrchr(buf, &#39;/&#39;);
 371     if (pslash != NULL) {
 372       *pslash = &#39;\0&#39;;            // Get rid of /{client|server|hotspot}.
 373     }
 374     Arguments::set_dll_dir(buf);
 375 
 376     if (pslash != NULL) {
 377       pslash = strrchr(buf, &#39;/&#39;);
 378       if (pslash != NULL) {
 379         *pslash = &#39;\0&#39;;          // Get rid of /&lt;arch&gt;.
 380         pslash = strrchr(buf, &#39;/&#39;);
 381         if (pslash != NULL) {
 382           *pslash = &#39;\0&#39;;        // Get rid of /lib.
 383         }
 384       }
 385     }
 386     Arguments::set_java_home(buf);
 387     if (!set_boot_path(&#39;/&#39;, &#39;:&#39;)) {
 388       vm_exit_during_initialization(&quot;Failed setting boot class path.&quot;, NULL);
 389     }
 390   }
 391 
 392   // Where to look for native libraries.
 393   //
 394   // Note: Due to a legacy implementation, most of the library path
 395   // is set in the launcher. This was to accomodate linking restrictions
 396   // on legacy Bsd implementations (which are no longer supported).
 397   // Eventually, all the library path setting will be done here.
 398   //
 399   // However, to prevent the proliferation of improperly built native
 400   // libraries, the new path component /usr/java/packages is added here.
 401   // Eventually, all the library path setting will be done here.
 402   {
 403     // Get the user setting of LD_LIBRARY_PATH, and prepended it. It
 404     // should always exist (until the legacy problem cited above is
 405     // addressed).
 406     const char *v = ::getenv(&quot;LD_LIBRARY_PATH&quot;);
 407     const char *v_colon = &quot;:&quot;;
 408     if (v == NULL) { v = &quot;&quot;; v_colon = &quot;&quot;; }
 409     // That&#39;s +1 for the colon and +1 for the trailing &#39;\0&#39;.
 410     char *ld_library_path = NEW_C_HEAP_ARRAY(char,
 411                                              strlen(v) + 1 +
 412                                              sizeof(SYS_EXT_DIR) + sizeof(&quot;/lib/&quot;) + strlen(cpu_arch) + sizeof(DEFAULT_LIBPATH) + 1,
 413                                              mtInternal);
 414     sprintf(ld_library_path, &quot;%s%s&quot; SYS_EXT_DIR &quot;/lib/%s:&quot; DEFAULT_LIBPATH, v, v_colon, cpu_arch);
 415     Arguments::set_library_path(ld_library_path);
 416     FREE_C_HEAP_ARRAY(char, ld_library_path);
 417   }
 418 
 419   // Extensions directories.
 420   sprintf(buf, &quot;%s&quot; EXTENSIONS_DIR &quot;:&quot; SYS_EXT_DIR EXTENSIONS_DIR, Arguments::get_java_home());
 421   Arguments::set_ext_dirs(buf);
 422 
 423   FREE_C_HEAP_ARRAY(char, buf);
 424 
 425 #else // __APPLE__
 426 
 427   #define SYS_EXTENSIONS_DIR   &quot;/Library/Java/Extensions&quot;
 428   #define SYS_EXTENSIONS_DIRS  SYS_EXTENSIONS_DIR &quot;:/Network&quot; SYS_EXTENSIONS_DIR &quot;:/System&quot; SYS_EXTENSIONS_DIR &quot;:/usr/lib/java&quot;
 429 
 430   const char *user_home_dir = get_home();
 431   // The null in SYS_EXTENSIONS_DIRS counts for the size of the colon after user_home_dir.
 432   size_t system_ext_size = strlen(user_home_dir) + sizeof(SYS_EXTENSIONS_DIR) +
 433     sizeof(SYS_EXTENSIONS_DIRS);
 434 
 435   // Buffer that fits several sprintfs.
 436   // Note that the space for the colon and the trailing null are provided
 437   // by the nulls included by the sizeof operator.
 438   const size_t bufsize =
 439     MAX2((size_t)MAXPATHLEN,  // for dll_dir &amp; friends.
 440          (size_t)MAXPATHLEN + sizeof(EXTENSIONS_DIR) + system_ext_size); // extensions dir
 441   char *buf = NEW_C_HEAP_ARRAY(char, bufsize, mtInternal);
 442 
 443   // sysclasspath, java_home, dll_dir
 444   {
 445     char *pslash;
 446     os::jvm_path(buf, bufsize);
 447 
 448     // Found the full path to libjvm.so.
 449     // Now cut the path to &lt;java_home&gt;/jre if we can.
 450     *(strrchr(buf, &#39;/&#39;)) = &#39;\0&#39;; // Get rid of /libjvm.so.
 451     pslash = strrchr(buf, &#39;/&#39;);
 452     if (pslash != NULL) {
 453       *pslash = &#39;\0&#39;;            // Get rid of /{client|server|hotspot}.
 454     }
 455 #ifdef STATIC_BUILD
 456     strcat(buf, &quot;/lib&quot;);
 457 #endif
 458 
 459     Arguments::set_dll_dir(buf);
 460 
 461     if (pslash != NULL) {
 462       pslash = strrchr(buf, &#39;/&#39;);
 463       if (pslash != NULL) {
 464         *pslash = &#39;\0&#39;;          // Get rid of /lib.
 465       }
 466     }
 467     Arguments::set_java_home(buf);
 468     set_boot_path(&#39;/&#39;, &#39;:&#39;);
 469   }
 470 
 471   // Where to look for native libraries.
 472   //
 473   // Note: Due to a legacy implementation, most of the library path
 474   // is set in the launcher. This was to accomodate linking restrictions
 475   // on legacy Bsd implementations (which are no longer supported).
 476   // Eventually, all the library path setting will be done here.
 477   //
 478   // However, to prevent the proliferation of improperly built native
 479   // libraries, the new path component /usr/java/packages is added here.
 480   // Eventually, all the library path setting will be done here.
 481   {
 482     // Get the user setting of LD_LIBRARY_PATH, and prepended it. It
 483     // should always exist (until the legacy problem cited above is
 484     // addressed).
 485     // Prepend the default path with the JAVA_LIBRARY_PATH so that the app launcher code
 486     // can specify a directory inside an app wrapper
 487     const char *l = ::getenv(&quot;JAVA_LIBRARY_PATH&quot;);
 488     const char *l_colon = &quot;:&quot;;
 489     if (l == NULL) { l = &quot;&quot;; l_colon = &quot;&quot;; }
 490 
 491     const char *v = ::getenv(&quot;DYLD_LIBRARY_PATH&quot;);
 492     const char *v_colon = &quot;:&quot;;
 493     if (v == NULL) { v = &quot;&quot;; v_colon = &quot;&quot;; }
 494 
 495     // Apple&#39;s Java6 has &quot;.&quot; at the beginning of java.library.path.
 496     // OpenJDK on Windows has &quot;.&quot; at the end of java.library.path.
 497     // OpenJDK on Linux and Solaris don&#39;t have &quot;.&quot; in java.library.path
 498     // at all. To ease the transition from Apple&#39;s Java6 to OpenJDK7,
 499     // &quot;.&quot; is appended to the end of java.library.path. Yes, this
 500     // could cause a change in behavior, but Apple&#39;s Java6 behavior
 501     // can be achieved by putting &quot;.&quot; at the beginning of the
 502     // JAVA_LIBRARY_PATH environment variable.
 503     char *ld_library_path = NEW_C_HEAP_ARRAY(char,
 504                                              strlen(v) + 1 + strlen(l) + 1 +
 505                                              system_ext_size + 3,
 506                                              mtInternal);
 507     sprintf(ld_library_path, &quot;%s%s%s%s%s&quot; SYS_EXTENSIONS_DIR &quot;:&quot; SYS_EXTENSIONS_DIRS &quot;:.&quot;,
 508             v, v_colon, l, l_colon, user_home_dir);
 509     Arguments::set_library_path(ld_library_path);
 510     FREE_C_HEAP_ARRAY(char, ld_library_path);
 511   }
 512 
 513   // Extensions directories.
 514   //
 515   // Note that the space for the colon and the trailing null are provided
 516   // by the nulls included by the sizeof operator (so actually one byte more
 517   // than necessary is allocated).
 518   sprintf(buf, &quot;%s&quot; SYS_EXTENSIONS_DIR &quot;:%s&quot; EXTENSIONS_DIR &quot;:&quot; SYS_EXTENSIONS_DIRS,
 519           user_home_dir, Arguments::get_java_home());
 520   Arguments::set_ext_dirs(buf);
 521 
 522   FREE_C_HEAP_ARRAY(char, buf);
 523 
 524 #undef SYS_EXTENSIONS_DIR
 525 #undef SYS_EXTENSIONS_DIRS
 526 
 527 #endif // __APPLE__
 528 
 529 #undef SYS_EXT_DIR
 530 #undef EXTENSIONS_DIR
 531 }
 532 
 533 ////////////////////////////////////////////////////////////////////////////////
 534 // breakpoint support
 535 
 536 void os::breakpoint() {
 537   BREAKPOINT;
 538 }
 539 
 540 extern &quot;C&quot; void breakpoint() {
 541   // use debugger to set breakpoint here
 542 }
 543 
 544 ////////////////////////////////////////////////////////////////////////////////
 545 // signal support
 546 
 547 debug_only(static bool signal_sets_initialized = false);
 548 static sigset_t unblocked_sigs, vm_sigs;
 549 
 550 void os::Bsd::signal_sets_init() {
 551   // Should also have an assertion stating we are still single-threaded.
 552   assert(!signal_sets_initialized, &quot;Already initialized&quot;);
 553   // Fill in signals that are necessarily unblocked for all threads in
 554   // the VM. Currently, we unblock the following signals:
 555   // SHUTDOWN{1,2,3}_SIGNAL: for shutdown hooks support (unless over-ridden
 556   //                         by -Xrs (=ReduceSignalUsage));
 557   // BREAK_SIGNAL which is unblocked only by the VM thread and blocked by all
 558   // other threads. The &quot;ReduceSignalUsage&quot; boolean tells us not to alter
 559   // the dispositions or masks wrt these signals.
 560   // Programs embedding the VM that want to use the above signals for their
 561   // own purposes must, at this time, use the &quot;-Xrs&quot; option to prevent
 562   // interference with shutdown hooks and BREAK_SIGNAL thread dumping.
 563   // (See bug 4345157, and other related bugs).
 564   // In reality, though, unblocking these signals is really a nop, since
 565   // these signals are not blocked by default.
 566   sigemptyset(&amp;unblocked_sigs);
 567   sigaddset(&amp;unblocked_sigs, SIGILL);
 568   sigaddset(&amp;unblocked_sigs, SIGSEGV);
 569   sigaddset(&amp;unblocked_sigs, SIGBUS);
 570   sigaddset(&amp;unblocked_sigs, SIGFPE);
 571   sigaddset(&amp;unblocked_sigs, SR_signum);
 572 
 573   if (!ReduceSignalUsage) {
 574     if (!os::Posix::is_sig_ignored(SHUTDOWN1_SIGNAL)) {
 575       sigaddset(&amp;unblocked_sigs, SHUTDOWN1_SIGNAL);
 576 
 577     }
 578     if (!os::Posix::is_sig_ignored(SHUTDOWN2_SIGNAL)) {
 579       sigaddset(&amp;unblocked_sigs, SHUTDOWN2_SIGNAL);
 580     }
 581     if (!os::Posix::is_sig_ignored(SHUTDOWN3_SIGNAL)) {
 582       sigaddset(&amp;unblocked_sigs, SHUTDOWN3_SIGNAL);
 583     }
 584   }
 585   // Fill in signals that are blocked by all but the VM thread.
 586   sigemptyset(&amp;vm_sigs);
 587   if (!ReduceSignalUsage) {
 588     sigaddset(&amp;vm_sigs, BREAK_SIGNAL);
 589   }
 590   debug_only(signal_sets_initialized = true);
 591 
 592 }
 593 
 594 // These are signals that are unblocked while a thread is running Java.
 595 // (For some reason, they get blocked by default.)
 596 sigset_t* os::Bsd::unblocked_signals() {
 597   assert(signal_sets_initialized, &quot;Not initialized&quot;);
 598   return &amp;unblocked_sigs;
 599 }
 600 
 601 // These are the signals that are blocked while a (non-VM) thread is
 602 // running Java. Only the VM thread handles these signals.
 603 sigset_t* os::Bsd::vm_signals() {
 604   assert(signal_sets_initialized, &quot;Not initialized&quot;);
 605   return &amp;vm_sigs;
 606 }
 607 
 608 void os::Bsd::hotspot_sigmask(Thread* thread) {
 609 
 610   //Save caller&#39;s signal mask before setting VM signal mask
 611   sigset_t caller_sigmask;
 612   pthread_sigmask(SIG_BLOCK, NULL, &amp;caller_sigmask);
 613 
 614   OSThread* osthread = thread-&gt;osthread();
 615   osthread-&gt;set_caller_sigmask(caller_sigmask);
 616 
 617   pthread_sigmask(SIG_UNBLOCK, os::Bsd::unblocked_signals(), NULL);
 618 
 619   if (!ReduceSignalUsage) {
 620     if (thread-&gt;is_VM_thread()) {
 621       // Only the VM thread handles BREAK_SIGNAL ...
 622       pthread_sigmask(SIG_UNBLOCK, vm_signals(), NULL);
 623     } else {
 624       // ... all other threads block BREAK_SIGNAL
 625       pthread_sigmask(SIG_BLOCK, vm_signals(), NULL);
 626     }
 627   }
 628 }
 629 
 630 
 631 //////////////////////////////////////////////////////////////////////////////
 632 // create new thread
 633 
 634 #ifdef __APPLE__
 635 // library handle for calling objc_registerThreadWithCollector()
 636 // without static linking to the libobjc library
 637   #define OBJC_LIB &quot;/usr/lib/libobjc.dylib&quot;
 638   #define OBJC_GCREGISTER &quot;objc_registerThreadWithCollector&quot;
 639 typedef void (*objc_registerThreadWithCollector_t)();
 640 extern &quot;C&quot; objc_registerThreadWithCollector_t objc_registerThreadWithCollectorFunction;
 641 objc_registerThreadWithCollector_t objc_registerThreadWithCollectorFunction = NULL;
 642 #endif
 643 
 644 // Thread start routine for all newly created threads
 645 static void *thread_native_entry(Thread *thread) {
 646 
 647   thread-&gt;record_stack_base_and_size();
 648 
 649   // Try to randomize the cache line index of hot stack frames.
 650   // This helps when threads of the same stack traces evict each other&#39;s
 651   // cache lines. The threads can be either from the same JVM instance, or
 652   // from different JVM instances. The benefit is especially true for
 653   // processors with hyperthreading technology.
 654   static int counter = 0;
 655   int pid = os::current_process_id();
 656   alloca(((pid ^ counter++) &amp; 7) * 128);
 657 
 658   thread-&gt;initialize_thread_current();
 659 
 660   OSThread* osthread = thread-&gt;osthread();
 661   Monitor* sync = osthread-&gt;startThread_lock();
 662 
 663   osthread-&gt;set_thread_id(os::Bsd::gettid());
 664 
 665   log_info(os, thread)(&quot;Thread is alive (tid: &quot; UINTX_FORMAT &quot;, pthread id: &quot; UINTX_FORMAT &quot;).&quot;,
 666     os::current_thread_id(), (uintx) pthread_self());
 667 
 668 #ifdef __APPLE__
 669   // Store unique OS X thread id used by SA
 670   osthread-&gt;set_unique_thread_id();
 671 #endif
 672 
 673   // initialize signal mask for this thread
 674   os::Bsd::hotspot_sigmask(thread);
 675 
 676   // initialize floating point control register
 677   os::Bsd::init_thread_fpu_state();
 678 
 679 #ifdef __APPLE__
 680   // register thread with objc gc
 681   if (objc_registerThreadWithCollectorFunction != NULL) {
 682     objc_registerThreadWithCollectorFunction();
 683   }
 684 #endif
 685 
 686   // handshaking with parent thread
 687   {
 688     MutexLocker ml(sync, Mutex::_no_safepoint_check_flag);
 689 
 690     // notify parent thread
 691     osthread-&gt;set_state(INITIALIZED);
 692     sync-&gt;notify_all();
 693 
 694     // wait until os::start_thread()
 695     while (osthread-&gt;get_state() == INITIALIZED) {
 696       sync-&gt;wait_without_safepoint_check();
 697     }
 698   }
 699 
 700   // call one more level start routine
 701   thread-&gt;call_run();
 702 
 703   // Note: at this point the thread object may already have deleted itself.
 704   // Prevent dereferencing it from here on out.
 705   thread = NULL;
 706 
 707   log_info(os, thread)(&quot;Thread finished (tid: &quot; UINTX_FORMAT &quot;, pthread id: &quot; UINTX_FORMAT &quot;).&quot;,
 708     os::current_thread_id(), (uintx) pthread_self());
 709 
 710   return 0;
 711 }
 712 
 713 bool os::create_thread(Thread* thread, ThreadType thr_type,
 714                        size_t req_stack_size) {
 715   assert(thread-&gt;osthread() == NULL, &quot;caller responsible&quot;);
 716 
 717   // Allocate the OSThread object
 718   OSThread* osthread = new OSThread(NULL, NULL);
 719   if (osthread == NULL) {
 720     return false;
 721   }
 722 
 723   // set the correct thread state
 724   osthread-&gt;set_thread_type(thr_type);
 725 
 726   // Initial state is ALLOCATED but not INITIALIZED
 727   osthread-&gt;set_state(ALLOCATED);
 728 
 729   thread-&gt;set_osthread(osthread);
 730 
 731   // init thread attributes
 732   pthread_attr_t attr;
 733   pthread_attr_init(&amp;attr);
 734   pthread_attr_setdetachstate(&amp;attr, PTHREAD_CREATE_DETACHED);
 735 
 736   // calculate stack size if it&#39;s not specified by caller
 737   size_t stack_size = os::Posix::get_initial_stack_size(thr_type, req_stack_size);
 738   int status = pthread_attr_setstacksize(&amp;attr, stack_size);
 739   assert_status(status == 0, status, &quot;pthread_attr_setstacksize&quot;);
 740 
 741   ThreadState state;
 742 
 743   {
 744     pthread_t tid;
 745     int ret = pthread_create(&amp;tid, &amp;attr, (void* (*)(void*)) thread_native_entry, thread);
 746 
 747     char buf[64];
 748     if (ret == 0) {
 749       log_info(os, thread)(&quot;Thread started (pthread id: &quot; UINTX_FORMAT &quot;, attributes: %s). &quot;,
 750         (uintx) tid, os::Posix::describe_pthread_attr(buf, sizeof(buf), &amp;attr));
 751     } else {
 752       log_warning(os, thread)(&quot;Failed to start thread - pthread_create failed (%s) for attributes: %s.&quot;,
 753         os::errno_name(ret), os::Posix::describe_pthread_attr(buf, sizeof(buf), &amp;attr));
 754       // Log some OS information which might explain why creating the thread failed.
 755       log_info(os, thread)(&quot;Number of threads approx. running in the VM: %d&quot;, Threads::number_of_threads());
 756       LogStream st(Log(os, thread)::info());
 757       os::Posix::print_rlimit_info(&amp;st);
 758       os::print_memory_info(&amp;st);
 759     }
 760 
 761     pthread_attr_destroy(&amp;attr);
 762 
 763     if (ret != 0) {
 764       // Need to clean up stuff we&#39;ve allocated so far
 765       thread-&gt;set_osthread(NULL);
 766       delete osthread;
 767       return false;
 768     }
 769 
 770     // Store pthread info into the OSThread
 771     osthread-&gt;set_pthread_id(tid);
 772 
 773     // Wait until child thread is either initialized or aborted
 774     {
 775       Monitor* sync_with_child = osthread-&gt;startThread_lock();
 776       MutexLocker ml(sync_with_child, Mutex::_no_safepoint_check_flag);
 777       while ((state = osthread-&gt;get_state()) == ALLOCATED) {
 778         sync_with_child-&gt;wait_without_safepoint_check();
 779       }
 780     }
 781 
 782   }
 783 
 784   // Aborted due to thread limit being reached
 785   if (state == ZOMBIE) {
 786     thread-&gt;set_osthread(NULL);
 787     delete osthread;
 788     return false;
 789   }
 790 
 791   // The thread is returned suspended (in state INITIALIZED),
 792   // and is started higher up in the call chain
 793   assert(state == INITIALIZED, &quot;race condition&quot;);
 794   return true;
 795 }
 796 
 797 /////////////////////////////////////////////////////////////////////////////
 798 // attach existing thread
 799 
 800 // bootstrap the main thread
 801 bool os::create_main_thread(JavaThread* thread) {
 802   assert(os::Bsd::_main_thread == pthread_self(), &quot;should be called inside main thread&quot;);
 803   return create_attached_thread(thread);
 804 }
 805 
 806 bool os::create_attached_thread(JavaThread* thread) {
 807 #ifdef ASSERT
 808   thread-&gt;verify_not_published();
 809 #endif
 810 
 811   // Allocate the OSThread object
 812   OSThread* osthread = new OSThread(NULL, NULL);
 813 
 814   if (osthread == NULL) {
 815     return false;
 816   }
 817 
 818   osthread-&gt;set_thread_id(os::Bsd::gettid());
 819 
 820 #ifdef __APPLE__
 821   // Store unique OS X thread id used by SA
 822   osthread-&gt;set_unique_thread_id();
 823 #endif
 824 
 825   // Store pthread info into the OSThread
 826   osthread-&gt;set_pthread_id(::pthread_self());
 827 
 828   // initialize floating point control register
 829   os::Bsd::init_thread_fpu_state();
 830 
 831   // Initial thread state is RUNNABLE
 832   osthread-&gt;set_state(RUNNABLE);
 833 
 834   thread-&gt;set_osthread(osthread);
 835 
 836   // initialize signal mask for this thread
 837   // and save the caller&#39;s signal mask
 838   os::Bsd::hotspot_sigmask(thread);
 839 
 840   log_info(os, thread)(&quot;Thread attached (tid: &quot; UINTX_FORMAT &quot;, pthread id: &quot; UINTX_FORMAT &quot;).&quot;,
 841     os::current_thread_id(), (uintx) pthread_self());
 842 
 843   return true;
 844 }
 845 
 846 void os::pd_start_thread(Thread* thread) {
 847   OSThread * osthread = thread-&gt;osthread();
 848   assert(osthread-&gt;get_state() != INITIALIZED, &quot;just checking&quot;);
 849   Monitor* sync_with_child = osthread-&gt;startThread_lock();
 850   MutexLocker ml(sync_with_child, Mutex::_no_safepoint_check_flag);
 851   sync_with_child-&gt;notify();
 852 }
 853 
 854 // Free Bsd resources related to the OSThread
 855 void os::free_thread(OSThread* osthread) {
 856   assert(osthread != NULL, &quot;osthread not set&quot;);
 857 
 858   // We are told to free resources of the argument thread,
 859   // but we can only really operate on the current thread.
 860   assert(Thread::current()-&gt;osthread() == osthread,
 861          &quot;os::free_thread but not current thread&quot;);
 862 
 863   // Restore caller&#39;s signal mask
 864   sigset_t sigmask = osthread-&gt;caller_sigmask();
 865   pthread_sigmask(SIG_SETMASK, &amp;sigmask, NULL);
 866 
 867   delete osthread;
 868 }
 869 
 870 ////////////////////////////////////////////////////////////////////////////////
 871 // time support
 872 
 873 // Time since start-up in seconds to a fine granularity.
 874 // Used by VMSelfDestructTimer and the MemProfiler.
 875 double os::elapsedTime() {
 876 
 877   return ((double)os::elapsed_counter()) / os::elapsed_frequency();
 878 }
 879 
 880 jlong os::elapsed_counter() {
 881   return javaTimeNanos() - initial_time_count;
 882 }
 883 
 884 jlong os::elapsed_frequency() {
 885   return NANOSECS_PER_SEC; // nanosecond resolution
 886 }
 887 
 888 bool os::supports_vtime() { return true; }
 889 
 890 double os::elapsedVTime() {
 891   // better than nothing, but not much
 892   return elapsedTime();
 893 }
 894 
 895 jlong os::javaTimeMillis() {
 896   timeval time;
 897   int status = gettimeofday(&amp;time, NULL);
 898   assert(status != -1, &quot;bsd error&quot;);
 899   return jlong(time.tv_sec) * 1000  +  jlong(time.tv_usec / 1000);
 900 }
 901 
 902 void os::javaTimeSystemUTC(jlong &amp;seconds, jlong &amp;nanos) {
 903   timeval time;
 904   int status = gettimeofday(&amp;time, NULL);
 905   assert(status != -1, &quot;bsd error&quot;);
 906   seconds = jlong(time.tv_sec);
 907   nanos = jlong(time.tv_usec) * 1000;
 908 }
 909 
 910 #ifndef __APPLE__
 911   #ifndef CLOCK_MONOTONIC
 912     #define CLOCK_MONOTONIC (1)
 913   #endif
 914 #endif
 915 
 916 #ifdef __APPLE__
 917 void os::Bsd::clock_init() {
 918   mach_timebase_info(&amp;_timebase_info);
 919 }
 920 #else
 921 void os::Bsd::clock_init() {
 922   struct timespec res;
 923   struct timespec tp;
 924   if (::clock_getres(CLOCK_MONOTONIC, &amp;res) == 0 &amp;&amp;
 925       ::clock_gettime(CLOCK_MONOTONIC, &amp;tp)  == 0) {
 926     // yes, monotonic clock is supported
 927     _clock_gettime = ::clock_gettime;
 928   }
 929 }
 930 #endif
 931 
 932 
 933 
 934 #ifdef __APPLE__
 935 
 936 jlong os::javaTimeNanos() {
 937   const uint64_t tm = mach_absolute_time();
 938   const uint64_t now = (tm * Bsd::_timebase_info.numer) / Bsd::_timebase_info.denom;
 939   const uint64_t prev = Bsd::_max_abstime;
 940   if (now &lt;= prev) {
 941     return prev;   // same or retrograde time;
 942   }
 943   const uint64_t obsv = Atomic::cmpxchg(&amp;Bsd::_max_abstime, prev, now);
 944   assert(obsv &gt;= prev, &quot;invariant&quot;);   // Monotonicity
 945   // If the CAS succeeded then we&#39;re done and return &quot;now&quot;.
 946   // If the CAS failed and the observed value &quot;obsv&quot; is &gt;= now then
 947   // we should return &quot;obsv&quot;.  If the CAS failed and now &gt; obsv &gt; prv then
 948   // some other thread raced this thread and installed a new value, in which case
 949   // we could either (a) retry the entire operation, (b) retry trying to install now
 950   // or (c) just return obsv.  We use (c).   No loop is required although in some cases
 951   // we might discard a higher &quot;now&quot; value in deference to a slightly lower but freshly
 952   // installed obsv value.   That&#39;s entirely benign -- it admits no new orderings compared
 953   // to (a) or (b) -- and greatly reduces coherence traffic.
 954   // We might also condition (c) on the magnitude of the delta between obsv and now.
 955   // Avoiding excessive CAS operations to hot RW locations is critical.
 956   // See https://blogs.oracle.com/dave/entry/cas_and_cache_trivia_invalidate
 957   return (prev == obsv) ? now : obsv;
 958 }
 959 
 960 #else // __APPLE__
 961 
 962 jlong os::javaTimeNanos() {
 963   if (os::supports_monotonic_clock()) {
 964     struct timespec tp;
 965     int status = Bsd::_clock_gettime(CLOCK_MONOTONIC, &amp;tp);
 966     assert(status == 0, &quot;gettime error&quot;);
 967     jlong result = jlong(tp.tv_sec) * (1000 * 1000 * 1000) + jlong(tp.tv_nsec);
 968     return result;
 969   } else {
 970     timeval time;
 971     int status = gettimeofday(&amp;time, NULL);
 972     assert(status != -1, &quot;bsd error&quot;);
 973     jlong usecs = jlong(time.tv_sec) * (1000 * 1000) + jlong(time.tv_usec);
 974     return 1000 * usecs;
 975   }
 976 }
 977 
 978 #endif // __APPLE__
 979 
 980 void os::javaTimeNanos_info(jvmtiTimerInfo *info_ptr) {
 981   if (os::supports_monotonic_clock()) {
 982     info_ptr-&gt;max_value = ALL_64_BITS;
 983 
 984     // CLOCK_MONOTONIC - amount of time since some arbitrary point in the past
 985     info_ptr-&gt;may_skip_backward = false;      // not subject to resetting or drifting
 986     info_ptr-&gt;may_skip_forward = false;       // not subject to resetting or drifting
 987   } else {
 988     // gettimeofday - based on time in seconds since the Epoch thus does not wrap
 989     info_ptr-&gt;max_value = ALL_64_BITS;
 990 
 991     // gettimeofday is a real time clock so it skips
 992     info_ptr-&gt;may_skip_backward = true;
 993     info_ptr-&gt;may_skip_forward = true;
 994   }
 995 
 996   info_ptr-&gt;kind = JVMTI_TIMER_ELAPSED;                // elapsed not CPU time
 997 }
 998 
 999 // Return the real, user, and system times in seconds from an
1000 // arbitrary fixed point in the past.
1001 bool os::getTimesSecs(double* process_real_time,
1002                       double* process_user_time,
1003                       double* process_system_time) {
1004   struct tms ticks;
1005   clock_t real_ticks = times(&amp;ticks);
1006 
1007   if (real_ticks == (clock_t) (-1)) {
1008     return false;
1009   } else {
1010     double ticks_per_second = (double) clock_tics_per_sec;
1011     *process_user_time = ((double) ticks.tms_utime) / ticks_per_second;
1012     *process_system_time = ((double) ticks.tms_stime) / ticks_per_second;
1013     *process_real_time = ((double) real_ticks) / ticks_per_second;
1014 
1015     return true;
1016   }
1017 }
1018 
1019 
1020 char * os::local_time_string(char *buf, size_t buflen) {
1021   struct tm t;
1022   time_t long_time;
1023   time(&amp;long_time);
1024   localtime_r(&amp;long_time, &amp;t);
1025   jio_snprintf(buf, buflen, &quot;%d-%02d-%02d %02d:%02d:%02d&quot;,
1026                t.tm_year + 1900, t.tm_mon + 1, t.tm_mday,
1027                t.tm_hour, t.tm_min, t.tm_sec);
1028   return buf;
1029 }
1030 
1031 struct tm* os::localtime_pd(const time_t* clock, struct tm*  res) {
1032   return localtime_r(clock, res);
1033 }
1034 
1035 ////////////////////////////////////////////////////////////////////////////////
1036 // runtime exit support
1037 
1038 // Note: os::shutdown() might be called very early during initialization, or
1039 // called from signal handler. Before adding something to os::shutdown(), make
1040 // sure it is async-safe and can handle partially initialized VM.
1041 void os::shutdown() {
1042 
1043   // allow PerfMemory to attempt cleanup of any persistent resources
1044   perfMemory_exit();
1045 
1046   // needs to remove object in file system
1047   AttachListener::abort();
1048 
1049   // flush buffered output, finish log files
1050   ostream_abort();
1051 
1052   // Check for abort hook
1053   abort_hook_t abort_hook = Arguments::abort_hook();
1054   if (abort_hook != NULL) {
1055     abort_hook();
1056   }
1057 
1058 }
1059 
1060 // Note: os::abort() might be called very early during initialization, or
1061 // called from signal handler. Before adding something to os::abort(), make
1062 // sure it is async-safe and can handle partially initialized VM.
1063 void os::abort(bool dump_core, void* siginfo, const void* context) {
1064   os::shutdown();
1065   if (dump_core) {
1066     ::abort(); // dump core
1067   }
1068 
1069   ::exit(1);
1070 }
1071 
1072 // Die immediately, no exit hook, no abort hook, no cleanup.
1073 // Dump a core file, if possible, for debugging.
1074 void os::die() {
1075   if (TestUnresponsiveErrorHandler &amp;&amp; !CreateCoredumpOnCrash) {
1076     // For TimeoutInErrorHandlingTest.java, we just kill the VM
1077     // and don&#39;t take the time to generate a core file.
1078     os::signal_raise(SIGKILL);
1079   } else {
1080     // _exit() on BsdThreads only kills current thread
1081     ::abort();
1082   }
1083 }
1084 
1085 // Information of current thread in variety of formats
1086 pid_t os::Bsd::gettid() {
1087   int retval = -1;
1088 
1089 #ifdef __APPLE__ // XNU kernel
1090   mach_port_t port = mach_thread_self();
1091   guarantee(MACH_PORT_VALID(port), &quot;just checking&quot;);
1092   mach_port_deallocate(mach_task_self(), port);
1093   return (pid_t)port;
1094 
1095 #else
1096   #ifdef __FreeBSD__
1097   retval = syscall(SYS_thr_self);
1098   #else
1099     #ifdef __OpenBSD__
1100   retval = syscall(SYS_getthrid);
1101     #else
1102       #ifdef __NetBSD__
1103   retval = (pid_t) syscall(SYS__lwp_self);
1104       #endif
1105     #endif
1106   #endif
1107 #endif
1108 
1109   if (retval == -1) {
1110     return getpid();
1111   }
1112 }
1113 
1114 intx os::current_thread_id() {
1115 #ifdef __APPLE__
1116   return (intx)os::Bsd::gettid();
1117 #else
1118   return (intx)::pthread_self();
1119 #endif
1120 }
1121 
1122 int os::current_process_id() {
1123   return (int)(getpid());
1124 }
1125 
1126 // DLL functions
1127 
1128 const char* os::dll_file_extension() { return JNI_LIB_SUFFIX; }
1129 
1130 // This must be hard coded because it&#39;s the system&#39;s temporary
1131 // directory not the java application&#39;s temp directory, ala java.io.tmpdir.
1132 #ifdef __APPLE__
1133 // macosx has a secure per-user temporary directory
1134 char temp_path_storage[PATH_MAX];
1135 const char* os::get_temp_directory() {
1136   static char *temp_path = NULL;
1137   if (temp_path == NULL) {
1138     int pathSize = confstr(_CS_DARWIN_USER_TEMP_DIR, temp_path_storage, PATH_MAX);
1139     if (pathSize == 0 || pathSize &gt; PATH_MAX) {
1140       strlcpy(temp_path_storage, &quot;/tmp/&quot;, sizeof(temp_path_storage));
1141     }
1142     temp_path = temp_path_storage;
1143   }
1144   return temp_path;
1145 }
1146 #else // __APPLE__
1147 const char* os::get_temp_directory() { return &quot;/tmp&quot;; }
1148 #endif // __APPLE__
1149 
1150 // check if addr is inside libjvm.so
1151 bool os::address_is_in_vm(address addr) {
1152   static address libjvm_base_addr;
1153   Dl_info dlinfo;
1154 
1155   if (libjvm_base_addr == NULL) {
1156     if (dladdr(CAST_FROM_FN_PTR(void *, os::address_is_in_vm), &amp;dlinfo) != 0) {
1157       libjvm_base_addr = (address)dlinfo.dli_fbase;
1158     }
1159     assert(libjvm_base_addr !=NULL, &quot;Cannot obtain base address for libjvm&quot;);
1160   }
1161 
1162   if (dladdr((void *)addr, &amp;dlinfo) != 0) {
1163     if (libjvm_base_addr == (address)dlinfo.dli_fbase) return true;
1164   }
1165 
1166   return false;
1167 }
1168 
1169 
1170 #define MACH_MAXSYMLEN 256
1171 
1172 bool os::dll_address_to_function_name(address addr, char *buf,
1173                                       int buflen, int *offset,
1174                                       bool demangle) {
1175   // buf is not optional, but offset is optional
1176   assert(buf != NULL, &quot;sanity check&quot;);
1177 
1178   Dl_info dlinfo;
1179   char localbuf[MACH_MAXSYMLEN];
1180 
1181   if (dladdr((void*)addr, &amp;dlinfo) != 0) {
1182     // see if we have a matching symbol
1183     if (dlinfo.dli_saddr != NULL &amp;&amp; dlinfo.dli_sname != NULL) {
1184       if (!(demangle &amp;&amp; Decoder::demangle(dlinfo.dli_sname, buf, buflen))) {
1185         jio_snprintf(buf, buflen, &quot;%s&quot;, dlinfo.dli_sname);
1186       }
1187       if (offset != NULL) *offset = addr - (address)dlinfo.dli_saddr;
1188       return true;
1189     }
1190     // no matching symbol so try for just file info
1191     if (dlinfo.dli_fname != NULL &amp;&amp; dlinfo.dli_fbase != NULL) {
1192       if (Decoder::decode((address)(addr - (address)dlinfo.dli_fbase),
1193                           buf, buflen, offset, dlinfo.dli_fname, demangle)) {
1194         return true;
1195       }
1196     }
1197 
1198     // Handle non-dynamic manually:
1199     if (dlinfo.dli_fbase != NULL &amp;&amp;
1200         Decoder::decode(addr, localbuf, MACH_MAXSYMLEN, offset,
1201                         dlinfo.dli_fbase)) {
1202       if (!(demangle &amp;&amp; Decoder::demangle(localbuf, buf, buflen))) {
1203         jio_snprintf(buf, buflen, &quot;%s&quot;, localbuf);
1204       }
1205       return true;
1206     }
1207   }
1208   buf[0] = &#39;\0&#39;;
1209   if (offset != NULL) *offset = -1;
1210   return false;
1211 }
1212 
1213 // ported from solaris version
1214 bool os::dll_address_to_library_name(address addr, char* buf,
1215                                      int buflen, int* offset) {
1216   // buf is not optional, but offset is optional
1217   assert(buf != NULL, &quot;sanity check&quot;);
1218 
1219   Dl_info dlinfo;
1220 
1221   if (dladdr((void*)addr, &amp;dlinfo) != 0) {
1222     if (dlinfo.dli_fname != NULL) {
1223       jio_snprintf(buf, buflen, &quot;%s&quot;, dlinfo.dli_fname);
1224     }
1225     if (dlinfo.dli_fbase != NULL &amp;&amp; offset != NULL) {
1226       *offset = addr - (address)dlinfo.dli_fbase;
1227     }
1228     return true;
1229   }
1230 
1231   buf[0] = &#39;\0&#39;;
1232   if (offset) *offset = -1;
1233   return false;
1234 }
1235 
1236 // Loads .dll/.so and
1237 // in case of error it checks if .dll/.so was built for the
1238 // same architecture as Hotspot is running on
1239 
1240 #ifdef __APPLE__
1241 void * os::dll_load(const char *filename, char *ebuf, int ebuflen) {
1242 #ifdef STATIC_BUILD
1243   return os::get_default_process_handle();
1244 #else
1245   log_info(os)(&quot;attempting shared library load of %s&quot;, filename);
1246 
1247   void * result= ::dlopen(filename, RTLD_LAZY);
1248   if (result != NULL) {
1249     Events::log(NULL, &quot;Loaded shared library %s&quot;, filename);
1250     // Successful loading
1251     log_info(os)(&quot;shared library load of %s was successful&quot;, filename);
1252     return result;
1253   }
1254 
1255   const char* error_report = ::dlerror();
1256   if (error_report == NULL) {
1257     error_report = &quot;dlerror returned no error description&quot;;
1258   }
1259   if (ebuf != NULL &amp;&amp; ebuflen &gt; 0) {
1260     // Read system error message into ebuf
1261     ::strncpy(ebuf, error_report, ebuflen-1);
1262     ebuf[ebuflen-1]=&#39;\0&#39;;
1263   }
1264   Events::log(NULL, &quot;Loading shared library %s failed, %s&quot;, filename, error_report);
1265   log_info(os)(&quot;shared library load of %s failed, %s&quot;, filename, error_report);
1266 
1267   return NULL;
1268 #endif // STATIC_BUILD
1269 }
1270 #else
1271 void * os::dll_load(const char *filename, char *ebuf, int ebuflen) {
1272 #ifdef STATIC_BUILD
1273   return os::get_default_process_handle();
1274 #else
1275   log_info(os)(&quot;attempting shared library load of %s&quot;, filename);
1276   void * result= ::dlopen(filename, RTLD_LAZY);
1277   if (result != NULL) {
1278     Events::log(NULL, &quot;Loaded shared library %s&quot;, filename);
1279     // Successful loading
1280     log_info(os)(&quot;shared library load of %s was successful&quot;, filename);
1281     return result;
1282   }
1283 
1284   Elf32_Ehdr elf_head;
1285 
1286   const char* const error_report = ::dlerror();
1287   if (error_report == NULL) {
1288     error_report = &quot;dlerror returned no error description&quot;;
1289   }
1290   if (ebuf != NULL &amp;&amp; ebuflen &gt; 0) {
1291     // Read system error message into ebuf
1292     ::strncpy(ebuf, error_report, ebuflen-1);
1293     ebuf[ebuflen-1]=&#39;\0&#39;;
1294   }
1295   Events::log(NULL, &quot;Loading shared library %s failed, %s&quot;, filename, error_report);
1296   log_info(os)(&quot;shared library load of %s failed, %s&quot;, filename, error_report);
1297 
1298   int diag_msg_max_length=ebuflen-strlen(ebuf);
1299   char* diag_msg_buf=ebuf+strlen(ebuf);
1300 
1301   if (diag_msg_max_length==0) {
1302     // No more space in ebuf for additional diagnostics message
1303     return NULL;
1304   }
1305 
1306 
1307   int file_descriptor= ::open(filename, O_RDONLY | O_NONBLOCK);
1308 
1309   if (file_descriptor &lt; 0) {
1310     // Can&#39;t open library, report dlerror() message
1311     return NULL;
1312   }
1313 
1314   bool failed_to_read_elf_head=
1315     (sizeof(elf_head)!=
1316      (::read(file_descriptor, &amp;elf_head,sizeof(elf_head))));
1317 
1318   ::close(file_descriptor);
1319   if (failed_to_read_elf_head) {
1320     // file i/o error - report dlerror() msg
1321     return NULL;
1322   }
1323 
1324   typedef struct {
1325     Elf32_Half  code;         // Actual value as defined in elf.h
1326     Elf32_Half  compat_class; // Compatibility of archs at VM&#39;s sense
1327     char        elf_class;    // 32 or 64 bit
1328     char        endianess;    // MSB or LSB
1329     char*       name;         // String representation
1330   } arch_t;
1331 
1332   #ifndef EM_486
1333     #define EM_486          6               /* Intel 80486 */
1334   #endif
1335 
1336   #ifndef EM_MIPS_RS3_LE
1337     #define EM_MIPS_RS3_LE  10              /* MIPS */
1338   #endif
1339 
1340   #ifndef EM_PPC64
1341     #define EM_PPC64        21              /* PowerPC64 */
1342   #endif
1343 
1344   #ifndef EM_S390
1345     #define EM_S390         22              /* IBM System/390 */
1346   #endif
1347 
1348   #ifndef EM_IA_64
1349     #define EM_IA_64        50              /* HP/Intel IA-64 */
1350   #endif
1351 
1352   #ifndef EM_X86_64
1353     #define EM_X86_64       62              /* AMD x86-64 */
1354   #endif
1355 
1356   static const arch_t arch_array[]={
1357     {EM_386,         EM_386,     ELFCLASS32, ELFDATA2LSB, (char*)&quot;IA 32&quot;},
1358     {EM_486,         EM_386,     ELFCLASS32, ELFDATA2LSB, (char*)&quot;IA 32&quot;},
1359     {EM_IA_64,       EM_IA_64,   ELFCLASS64, ELFDATA2LSB, (char*)&quot;IA 64&quot;},
1360     {EM_X86_64,      EM_X86_64,  ELFCLASS64, ELFDATA2LSB, (char*)&quot;AMD 64&quot;},
1361     {EM_PPC,         EM_PPC,     ELFCLASS32, ELFDATA2MSB, (char*)&quot;Power PC 32&quot;},
1362     {EM_PPC64,       EM_PPC64,   ELFCLASS64, ELFDATA2MSB, (char*)&quot;Power PC 64&quot;},
1363     {EM_ARM,         EM_ARM,     ELFCLASS32,   ELFDATA2LSB, (char*)&quot;ARM&quot;},
1364     {EM_S390,        EM_S390,    ELFCLASSNONE, ELFDATA2MSB, (char*)&quot;IBM System/390&quot;},
1365     {EM_ALPHA,       EM_ALPHA,   ELFCLASS64, ELFDATA2LSB, (char*)&quot;Alpha&quot;},
1366     {EM_MIPS_RS3_LE, EM_MIPS_RS3_LE, ELFCLASS32, ELFDATA2LSB, (char*)&quot;MIPSel&quot;},
1367     {EM_MIPS,        EM_MIPS,    ELFCLASS32, ELFDATA2MSB, (char*)&quot;MIPS&quot;},
1368     {EM_PARISC,      EM_PARISC,  ELFCLASS32, ELFDATA2MSB, (char*)&quot;PARISC&quot;},
1369     {EM_68K,         EM_68K,     ELFCLASS32, ELFDATA2MSB, (char*)&quot;M68k&quot;}
1370   };
1371 
1372   #if  (defined IA32)
1373   static  Elf32_Half running_arch_code=EM_386;
1374   #elif   (defined AMD64)
1375   static  Elf32_Half running_arch_code=EM_X86_64;
1376   #elif  (defined IA64)
1377   static  Elf32_Half running_arch_code=EM_IA_64;
1378   #elif  (defined __powerpc64__)
1379   static  Elf32_Half running_arch_code=EM_PPC64;
1380   #elif  (defined __powerpc__)
1381   static  Elf32_Half running_arch_code=EM_PPC;
1382   #elif  (defined ARM)
1383   static  Elf32_Half running_arch_code=EM_ARM;
1384   #elif  (defined S390)
1385   static  Elf32_Half running_arch_code=EM_S390;
1386   #elif  (defined ALPHA)
1387   static  Elf32_Half running_arch_code=EM_ALPHA;
1388   #elif  (defined MIPSEL)
1389   static  Elf32_Half running_arch_code=EM_MIPS_RS3_LE;
1390   #elif  (defined PARISC)
1391   static  Elf32_Half running_arch_code=EM_PARISC;
1392   #elif  (defined MIPS)
1393   static  Elf32_Half running_arch_code=EM_MIPS;
1394   #elif  (defined M68K)
1395   static  Elf32_Half running_arch_code=EM_68K;
1396   #else
1397     #error Method os::dll_load requires that one of following is defined:\
1398          IA32, AMD64, IA64, __powerpc__, ARM, S390, ALPHA, MIPS, MIPSEL, PARISC, M68K
1399   #endif
1400 
1401   // Identify compatability class for VM&#39;s architecture and library&#39;s architecture
1402   // Obtain string descriptions for architectures
1403 
1404   arch_t lib_arch={elf_head.e_machine,0,elf_head.e_ident[EI_CLASS], elf_head.e_ident[EI_DATA], NULL};
1405   int running_arch_index=-1;
1406 
1407   for (unsigned int i=0; i &lt; ARRAY_SIZE(arch_array); i++) {
1408     if (running_arch_code == arch_array[i].code) {
1409       running_arch_index    = i;
1410     }
1411     if (lib_arch.code == arch_array[i].code) {
1412       lib_arch.compat_class = arch_array[i].compat_class;
1413       lib_arch.name         = arch_array[i].name;
1414     }
1415   }
1416 
1417   assert(running_arch_index != -1,
1418          &quot;Didn&#39;t find running architecture code (running_arch_code) in arch_array&quot;);
1419   if (running_arch_index == -1) {
1420     // Even though running architecture detection failed
1421     // we may still continue with reporting dlerror() message
1422     return NULL;
1423   }
1424 
1425   if (lib_arch.endianess != arch_array[running_arch_index].endianess) {
1426     ::snprintf(diag_msg_buf, diag_msg_max_length-1,&quot; (Possible cause: endianness mismatch)&quot;);
1427     return NULL;
1428   }
1429 
1430 #ifndef S390
1431   if (lib_arch.elf_class != arch_array[running_arch_index].elf_class) {
1432     ::snprintf(diag_msg_buf, diag_msg_max_length-1,&quot; (Possible cause: architecture word width mismatch)&quot;);
1433     return NULL;
1434   }
1435 #endif // !S390
1436 
1437   if (lib_arch.compat_class != arch_array[running_arch_index].compat_class) {
1438     if (lib_arch.name!=NULL) {
1439       ::snprintf(diag_msg_buf, diag_msg_max_length-1,
1440                  &quot; (Possible cause: can&#39;t load %s-bit .so on a %s-bit platform)&quot;,
1441                  lib_arch.name, arch_array[running_arch_index].name);
1442     } else {
1443       ::snprintf(diag_msg_buf, diag_msg_max_length-1,
1444                  &quot; (Possible cause: can&#39;t load this .so (machine code=0x%x) on a %s-bit platform)&quot;,
1445                  lib_arch.code,
1446                  arch_array[running_arch_index].name);
1447     }
1448   }
1449 
1450   return NULL;
1451 #endif // STATIC_BUILD
1452 }
1453 #endif // !__APPLE__
1454 
1455 void* os::get_default_process_handle() {
1456 #ifdef __APPLE__
1457   // MacOS X needs to use RTLD_FIRST instead of RTLD_LAZY
1458   // to avoid finding unexpected symbols on second (or later)
1459   // loads of a library.
1460   return (void*)::dlopen(NULL, RTLD_FIRST);
1461 #else
1462   return (void*)::dlopen(NULL, RTLD_LAZY);
1463 #endif
1464 }
1465 
1466 // XXX: Do we need a lock around this as per Linux?
1467 void* os::dll_lookup(void* handle, const char* name) {
1468   return dlsym(handle, name);
1469 }
1470 
1471 int _print_dll_info_cb(const char * name, address base_address, address top_address, void * param) {
1472   outputStream * out = (outputStream *) param;
1473   out-&gt;print_cr(INTPTR_FORMAT &quot; \t%s&quot;, (intptr_t)base_address, name);
1474   return 0;
1475 }
1476 
1477 void os::print_dll_info(outputStream *st) {
1478   st-&gt;print_cr(&quot;Dynamic libraries:&quot;);
1479   if (get_loaded_modules_info(_print_dll_info_cb, (void *)st)) {
1480     st-&gt;print_cr(&quot;Error: Cannot print dynamic libraries.&quot;);
1481   }
1482 }
1483 
1484 int os::get_loaded_modules_info(os::LoadedModulesCallbackFunc callback, void *param) {
1485 #ifdef RTLD_DI_LINKMAP
1486   Dl_info dli;
1487   void *handle;
1488   Link_map *map;
1489   Link_map *p;
1490 
1491   if (dladdr(CAST_FROM_FN_PTR(void *, os::print_dll_info), &amp;dli) == 0 ||
1492       dli.dli_fname == NULL) {
1493     return 1;
1494   }
1495   handle = dlopen(dli.dli_fname, RTLD_LAZY);
1496   if (handle == NULL) {
1497     return 1;
1498   }
1499   dlinfo(handle, RTLD_DI_LINKMAP, &amp;map);
1500   if (map == NULL) {
1501     dlclose(handle);
1502     return 1;
1503   }
1504 
1505   while (map-&gt;l_prev != NULL)
1506     map = map-&gt;l_prev;
1507 
1508   while (map != NULL) {
1509     // Value for top_address is returned as 0 since we don&#39;t have any information about module size
1510     if (callback(map-&gt;l_name, (address)map-&gt;l_addr, (address)0, param)) {
1511       dlclose(handle);
1512       return 1;
1513     }
1514     map = map-&gt;l_next;
1515   }
1516 
1517   dlclose(handle);
1518 #elif defined(__APPLE__)
1519   for (uint32_t i = 1; i &lt; _dyld_image_count(); i++) {
1520     // Value for top_address is returned as 0 since we don&#39;t have any information about module size
1521     if (callback(_dyld_get_image_name(i), (address)_dyld_get_image_header(i), (address)0, param)) {
1522       return 1;
1523     }
1524   }
1525   return 0;
1526 #else
1527   return 1;
1528 #endif
1529 }
1530 
1531 void os::get_summary_os_info(char* buf, size_t buflen) {
1532   // These buffers are small because we want this to be brief
1533   // and not use a lot of stack while generating the hs_err file.
1534   char os[100];
1535   size_t size = sizeof(os);
1536   int mib_kern[] = { CTL_KERN, KERN_OSTYPE };
1537   if (sysctl(mib_kern, 2, os, &amp;size, NULL, 0) &lt; 0) {
1538 #ifdef __APPLE__
1539       strncpy(os, &quot;Darwin&quot;, sizeof(os));
1540 #elif __OpenBSD__
1541       strncpy(os, &quot;OpenBSD&quot;, sizeof(os));
1542 #else
1543       strncpy(os, &quot;BSD&quot;, sizeof(os));
1544 #endif
1545   }
1546 
1547   char release[100];
1548   size = sizeof(release);
1549   int mib_release[] = { CTL_KERN, KERN_OSRELEASE };
1550   if (sysctl(mib_release, 2, release, &amp;size, NULL, 0) &lt; 0) {
1551       // if error, leave blank
1552       strncpy(release, &quot;&quot;, sizeof(release));
1553   }
1554   snprintf(buf, buflen, &quot;%s %s&quot;, os, release);
1555 }
1556 
1557 void os::print_os_info_brief(outputStream* st) {
1558   os::Posix::print_uname_info(st);
1559 }
1560 
1561 void os::print_os_info(outputStream* st) {
1562   st-&gt;print(&quot;OS:&quot;);
1563 
1564   os::Posix::print_uname_info(st);
1565 
1566   os::Bsd::print_uptime_info(st);
1567 
1568   os::Posix::print_rlimit_info(st);
1569 
1570   os::Posix::print_load_average(st);
1571 
1572   VM_Version::print_platform_virtualization_info(st);
1573 }
1574 
1575 void os::pd_print_cpu_info(outputStream* st, char* buf, size_t buflen) {
1576   // Nothing to do for now.
1577 }
1578 
1579 void os::get_summary_cpu_info(char* buf, size_t buflen) {
1580   unsigned int mhz;
1581   size_t size = sizeof(mhz);
1582   int mib[] = { CTL_HW, HW_CPU_FREQ };
1583   if (sysctl(mib, 2, &amp;mhz, &amp;size, NULL, 0) &lt; 0) {
1584     mhz = 1;  // looks like an error but can be divided by
1585   } else {
1586     mhz /= 1000000;  // reported in millions
1587   }
1588 
1589   char model[100];
1590   size = sizeof(model);
1591   int mib_model[] = { CTL_HW, HW_MODEL };
1592   if (sysctl(mib_model, 2, model, &amp;size, NULL, 0) &lt; 0) {
1593     strncpy(model, cpu_arch, sizeof(model));
1594   }
1595 
1596   char machine[100];
1597   size = sizeof(machine);
1598   int mib_machine[] = { CTL_HW, HW_MACHINE };
1599   if (sysctl(mib_machine, 2, machine, &amp;size, NULL, 0) &lt; 0) {
1600       strncpy(machine, &quot;&quot;, sizeof(machine));
1601   }
1602 
1603   snprintf(buf, buflen, &quot;%s %s %d MHz&quot;, model, machine, mhz);
1604 }
1605 
1606 void os::print_memory_info(outputStream* st) {
1607   xsw_usage swap_usage;
1608   size_t size = sizeof(swap_usage);
1609 
1610   st-&gt;print(&quot;Memory:&quot;);
1611   st-&gt;print(&quot; %dk page&quot;, os::vm_page_size()&gt;&gt;10);
1612 
1613   st-&gt;print(&quot;, physical &quot; UINT64_FORMAT &quot;k&quot;,
1614             os::physical_memory() &gt;&gt; 10);
1615   st-&gt;print(&quot;(&quot; UINT64_FORMAT &quot;k free)&quot;,
1616             os::available_memory() &gt;&gt; 10);
1617 
1618   if((sysctlbyname(&quot;vm.swapusage&quot;, &amp;swap_usage, &amp;size, NULL, 0) == 0) || (errno == ENOMEM)) {
1619     if (size &gt;= offset_of(xsw_usage, xsu_used)) {
1620       st-&gt;print(&quot;, swap &quot; UINT64_FORMAT &quot;k&quot;,
1621                 ((julong) swap_usage.xsu_total) &gt;&gt; 10);
1622       st-&gt;print(&quot;(&quot; UINT64_FORMAT &quot;k free)&quot;,
1623                 ((julong) swap_usage.xsu_avail) &gt;&gt; 10);
1624     }
1625   }
1626 
1627   st-&gt;cr();
1628 }
1629 
1630 static void print_signal_handler(outputStream* st, int sig,
1631                                  char* buf, size_t buflen);
1632 
1633 void os::print_signal_handlers(outputStream* st, char* buf, size_t buflen) {
1634   st-&gt;print_cr(&quot;Signal Handlers:&quot;);
1635   print_signal_handler(st, SIGSEGV, buf, buflen);
1636   print_signal_handler(st, SIGBUS , buf, buflen);
1637   print_signal_handler(st, SIGFPE , buf, buflen);
1638   print_signal_handler(st, SIGPIPE, buf, buflen);
1639   print_signal_handler(st, SIGXFSZ, buf, buflen);
1640   print_signal_handler(st, SIGILL , buf, buflen);
1641   print_signal_handler(st, SR_signum, buf, buflen);
1642   print_signal_handler(st, SHUTDOWN1_SIGNAL, buf, buflen);
1643   print_signal_handler(st, SHUTDOWN2_SIGNAL , buf, buflen);
1644   print_signal_handler(st, SHUTDOWN3_SIGNAL , buf, buflen);
1645   print_signal_handler(st, BREAK_SIGNAL, buf, buflen);
1646 }
1647 
1648 static char saved_jvm_path[MAXPATHLEN] = {0};
1649 
1650 // Find the full path to the current module, libjvm
1651 void os::jvm_path(char *buf, jint buflen) {
1652   // Error checking.
1653   if (buflen &lt; MAXPATHLEN) {
1654     assert(false, &quot;must use a large-enough buffer&quot;);
1655     buf[0] = &#39;\0&#39;;
1656     return;
1657   }
1658   // Lazy resolve the path to current module.
1659   if (saved_jvm_path[0] != 0) {
1660     strcpy(buf, saved_jvm_path);
1661     return;
1662   }
1663 
1664   char dli_fname[MAXPATHLEN];
1665   bool ret = dll_address_to_library_name(
1666                                          CAST_FROM_FN_PTR(address, os::jvm_path),
1667                                          dli_fname, sizeof(dli_fname), NULL);
1668   assert(ret, &quot;cannot locate libjvm&quot;);
1669   char *rp = NULL;
1670   if (ret &amp;&amp; dli_fname[0] != &#39;\0&#39;) {
1671     rp = os::Posix::realpath(dli_fname, buf, buflen);
1672   }
1673   if (rp == NULL) {
1674     return;
1675   }
1676 
1677   if (Arguments::sun_java_launcher_is_altjvm()) {
1678     // Support for the java launcher&#39;s &#39;-XXaltjvm=&lt;path&gt;&#39; option. Typical
1679     // value for buf is &quot;&lt;JAVA_HOME&gt;/jre/lib/&lt;arch&gt;/&lt;vmtype&gt;/libjvm.so&quot;
1680     // or &quot;&lt;JAVA_HOME&gt;/jre/lib/&lt;vmtype&gt;/libjvm.dylib&quot;. If &quot;/jre/lib/&quot;
1681     // appears at the right place in the string, then assume we are
1682     // installed in a JDK and we&#39;re done. Otherwise, check for a
1683     // JAVA_HOME environment variable and construct a path to the JVM
1684     // being overridden.
1685 
1686     const char *p = buf + strlen(buf) - 1;
1687     for (int count = 0; p &gt; buf &amp;&amp; count &lt; 5; ++count) {
1688       for (--p; p &gt; buf &amp;&amp; *p != &#39;/&#39;; --p)
1689         /* empty */ ;
1690     }
1691 
1692     if (strncmp(p, &quot;/jre/lib/&quot;, 9) != 0) {
1693       // Look for JAVA_HOME in the environment.
1694       char* java_home_var = ::getenv(&quot;JAVA_HOME&quot;);
1695       if (java_home_var != NULL &amp;&amp; java_home_var[0] != 0) {
1696         char* jrelib_p;
1697         int len;
1698 
1699         // Check the current module name &quot;libjvm&quot;
1700         p = strrchr(buf, &#39;/&#39;);
1701         assert(strstr(p, &quot;/libjvm&quot;) == p, &quot;invalid library name&quot;);
1702 
1703         rp = os::Posix::realpath(java_home_var, buf, buflen);
1704         if (rp == NULL) {
1705           return;
1706         }
1707 
1708         // determine if this is a legacy image or modules image
1709         // modules image doesn&#39;t have &quot;jre&quot; subdirectory
1710         len = strlen(buf);
1711         assert(len &lt; buflen, &quot;Ran out of buffer space&quot;);
1712         jrelib_p = buf + len;
1713 
1714         // Add the appropriate library subdir
1715         snprintf(jrelib_p, buflen-len, &quot;/jre/lib&quot;);
1716         if (0 != access(buf, F_OK)) {
1717           snprintf(jrelib_p, buflen-len, &quot;/lib&quot;);
1718         }
1719 
1720         // Add the appropriate client or server subdir
1721         len = strlen(buf);
1722         jrelib_p = buf + len;
1723         snprintf(jrelib_p, buflen-len, &quot;/%s&quot;, COMPILER_VARIANT);
1724         if (0 != access(buf, F_OK)) {
1725           snprintf(jrelib_p, buflen-len, &quot;%s&quot;, &quot;&quot;);
1726         }
1727 
1728         // If the path exists within JAVA_HOME, add the JVM library name
1729         // to complete the path to JVM being overridden.  Otherwise fallback
1730         // to the path to the current library.
1731         if (0 == access(buf, F_OK)) {
1732           // Use current module name &quot;libjvm&quot;
1733           len = strlen(buf);
1734           snprintf(buf + len, buflen-len, &quot;/libjvm%s&quot;, JNI_LIB_SUFFIX);
1735         } else {
1736           // Fall back to path of current library
1737           rp = os::Posix::realpath(dli_fname, buf, buflen);
1738           if (rp == NULL) {
1739             return;
1740           }
1741         }
1742       }
1743     }
1744   }
1745 
1746   strncpy(saved_jvm_path, buf, MAXPATHLEN);
1747   saved_jvm_path[MAXPATHLEN - 1] = &#39;\0&#39;;
1748 }
1749 
1750 void os::print_jni_name_prefix_on(outputStream* st, int args_size) {
1751   // no prefix required, not even &quot;_&quot;
1752 }
1753 
1754 void os::print_jni_name_suffix_on(outputStream* st, int args_size) {
1755   // no suffix required
1756 }
1757 
1758 ////////////////////////////////////////////////////////////////////////////////
1759 // sun.misc.Signal support
1760 
1761 static void UserHandler(int sig, void *siginfo, void *context) {
1762   // Ctrl-C is pressed during error reporting, likely because the error
1763   // handler fails to abort. Let VM die immediately.
1764   if (sig == SIGINT &amp;&amp; VMError::is_error_reported()) {
1765     os::die();
1766   }
1767 
1768   os::signal_notify(sig);
1769 }
1770 
1771 void* os::user_handler() {
1772   return CAST_FROM_FN_PTR(void*, UserHandler);
1773 }
1774 
1775 extern &quot;C&quot; {
1776   typedef void (*sa_handler_t)(int);
1777   typedef void (*sa_sigaction_t)(int, siginfo_t *, void *);
1778 }
1779 
1780 void* os::signal(int signal_number, void* handler) {
1781   struct sigaction sigAct, oldSigAct;
1782 
1783   sigfillset(&amp;(sigAct.sa_mask));
1784   sigAct.sa_flags   = SA_RESTART|SA_SIGINFO;
1785   sigAct.sa_handler = CAST_TO_FN_PTR(sa_handler_t, handler);
1786 
1787   if (sigaction(signal_number, &amp;sigAct, &amp;oldSigAct)) {
1788     // -1 means registration failed
1789     return (void *)-1;
1790   }
1791 
1792   return CAST_FROM_FN_PTR(void*, oldSigAct.sa_handler);
1793 }
1794 
1795 void os::signal_raise(int signal_number) {
1796   ::raise(signal_number);
1797 }
1798 
1799 // The following code is moved from os.cpp for making this
1800 // code platform specific, which it is by its very nature.
1801 
1802 // Will be modified when max signal is changed to be dynamic
1803 int os::sigexitnum_pd() {
1804   return NSIG;
1805 }
1806 
1807 // a counter for each possible signal value
1808 static volatile jint pending_signals[NSIG+1] = { 0 };
1809 static Semaphore* sig_sem = NULL;
1810 
1811 static void jdk_misc_signal_init() {
1812   // Initialize signal structures
1813   ::memset((void*)pending_signals, 0, sizeof(pending_signals));
1814 
1815   // Initialize signal semaphore
1816   sig_sem = new Semaphore();
1817 }
1818 
1819 void os::signal_notify(int sig) {
1820   if (sig_sem != NULL) {
1821     Atomic::inc(&amp;pending_signals[sig]);
1822     sig_sem-&gt;signal();
1823   } else {
1824     // Signal thread is not created with ReduceSignalUsage and jdk_misc_signal_init
1825     // initialization isn&#39;t called.
1826     assert(ReduceSignalUsage, &quot;signal semaphore should be created&quot;);
1827   }
1828 }
1829 
1830 static int check_pending_signals() {
1831   for (;;) {
1832     for (int i = 0; i &lt; NSIG + 1; i++) {
1833       jint n = pending_signals[i];
1834       if (n &gt; 0 &amp;&amp; n == Atomic::cmpxchg(&amp;pending_signals[i], n, n - 1)) {
1835         return i;
1836       }
1837     }
1838     JavaThread *thread = JavaThread::current();
1839     ThreadBlockInVM tbivm(thread);
1840 
1841     bool threadIsSuspended;
1842     do {
1843       thread-&gt;set_suspend_equivalent();
1844       // cleared by handle_special_suspend_equivalent_condition() or java_suspend_self()
1845       sig_sem-&gt;wait();
1846 
1847       // were we externally suspended while we were waiting?
1848       threadIsSuspended = thread-&gt;handle_special_suspend_equivalent_condition();
1849       if (threadIsSuspended) {
1850         // The semaphore has been incremented, but while we were waiting
1851         // another thread suspended us. We don&#39;t want to continue running
1852         // while suspended because that would surprise the thread that
1853         // suspended us.
1854         sig_sem-&gt;signal();
1855 
1856         thread-&gt;java_suspend_self();
1857       }
1858     } while (threadIsSuspended);
1859   }
1860 }
1861 
1862 int os::signal_wait() {
1863   return check_pending_signals();
1864 }
1865 
1866 ////////////////////////////////////////////////////////////////////////////////
1867 // Virtual Memory
1868 
1869 int os::vm_page_size() {
1870   // Seems redundant as all get out
1871   assert(os::Bsd::page_size() != -1, &quot;must call os::init&quot;);
1872   return os::Bsd::page_size();
1873 }
1874 
1875 // Solaris allocates memory by pages.
1876 int os::vm_allocation_granularity() {
1877   assert(os::Bsd::page_size() != -1, &quot;must call os::init&quot;);
1878   return os::Bsd::page_size();
1879 }
1880 
1881 static void warn_fail_commit_memory(char* addr, size_t size, bool exec,
1882                                     int err) {
1883   warning(&quot;INFO: os::commit_memory(&quot; INTPTR_FORMAT &quot;, &quot; SIZE_FORMAT
1884           &quot;, %d) failed; error=&#39;%s&#39; (errno=%d)&quot;, (intptr_t)addr, size, exec,
1885            os::errno_name(err), err);
1886 }
1887 
1888 // NOTE: Bsd kernel does not really reserve the pages for us.
1889 //       All it does is to check if there are enough free pages
1890 //       left at the time of mmap(). This could be a potential
1891 //       problem.
1892 bool os::pd_commit_memory(char* addr, size_t size, bool exec) {
1893   int prot = exec ? PROT_READ|PROT_WRITE|PROT_EXEC : PROT_READ|PROT_WRITE;
1894 #ifdef __OpenBSD__
1895   // XXX: Work-around mmap/MAP_FIXED bug temporarily on OpenBSD
1896   Events::log(NULL, &quot;Protecting memory [&quot; INTPTR_FORMAT &quot;,&quot; INTPTR_FORMAT &quot;] with protection modes %x&quot;, p2i(addr), p2i(addr+size), prot);
1897   if (::mprotect(addr, size, prot) == 0) {
1898     return true;
1899   }
1900 #else
1901   uintptr_t res = (uintptr_t) ::mmap(addr, size, prot,
1902                                      MAP_PRIVATE|MAP_FIXED|MAP_ANONYMOUS, -1, 0);
1903   if (res != (uintptr_t) MAP_FAILED) {
1904     return true;
1905   }
1906 #endif
1907 
1908   // Warn about any commit errors we see in non-product builds just
1909   // in case mmap() doesn&#39;t work as described on the man page.
1910   NOT_PRODUCT(warn_fail_commit_memory(addr, size, exec, errno);)
1911 
1912   return false;
1913 }
1914 
1915 bool os::pd_commit_memory(char* addr, size_t size, size_t alignment_hint,
1916                           bool exec) {
1917   // alignment_hint is ignored on this OS
1918   return pd_commit_memory(addr, size, exec);
1919 }
1920 
1921 void os::pd_commit_memory_or_exit(char* addr, size_t size, bool exec,
1922                                   const char* mesg) {
1923   assert(mesg != NULL, &quot;mesg must be specified&quot;);
1924   if (!pd_commit_memory(addr, size, exec)) {
1925     // add extra info in product mode for vm_exit_out_of_memory():
1926     PRODUCT_ONLY(warn_fail_commit_memory(addr, size, exec, errno);)
1927     vm_exit_out_of_memory(size, OOM_MMAP_ERROR, &quot;%s&quot;, mesg);
1928   }
1929 }
1930 
1931 void os::pd_commit_memory_or_exit(char* addr, size_t size,
1932                                   size_t alignment_hint, bool exec,
1933                                   const char* mesg) {
1934   // alignment_hint is ignored on this OS
1935   pd_commit_memory_or_exit(addr, size, exec, mesg);
1936 }
1937 
1938 void os::pd_realign_memory(char *addr, size_t bytes, size_t alignment_hint) {
1939 }
1940 
1941 void os::pd_free_memory(char *addr, size_t bytes, size_t alignment_hint) {
1942   ::madvise(addr, bytes, MADV_DONTNEED);
1943 }
1944 
1945 void os::numa_make_global(char *addr, size_t bytes) {
1946 }
1947 
1948 void os::numa_make_local(char *addr, size_t bytes, int lgrp_hint) {
1949 }
1950 
1951 bool os::numa_topology_changed()   { return false; }
1952 
1953 size_t os::numa_get_groups_num() {
1954   return 1;
1955 }
1956 
1957 int os::numa_get_group_id() {
1958   return 0;
1959 }
1960 
1961 size_t os::numa_get_leaf_groups(int *ids, size_t size) {
1962   if (size &gt; 0) {
1963     ids[0] = 0;
1964     return 1;
1965   }
1966   return 0;
1967 }
1968 
1969 int os::numa_get_group_id_for_address(const void* address) {
1970   return 0;
1971 }
1972 
1973 bool os::get_page_info(char *start, page_info* info) {
1974   return false;
1975 }
1976 
1977 char *os::scan_pages(char *start, char* end, page_info* page_expected, page_info* page_found) {
1978   return end;
1979 }
1980 
1981 
1982 bool os::pd_uncommit_memory(char* addr, size_t size) {
1983 #ifdef __OpenBSD__
1984   // XXX: Work-around mmap/MAP_FIXED bug temporarily on OpenBSD
1985   Events::log(NULL, &quot;Protecting memory [&quot; INTPTR_FORMAT &quot;,&quot; INTPTR_FORMAT &quot;] with PROT_NONE&quot;, p2i(addr), p2i(addr+size));
1986   return ::mprotect(addr, size, PROT_NONE) == 0;
1987 #else
1988   uintptr_t res = (uintptr_t) ::mmap(addr, size, PROT_NONE,
1989                                      MAP_PRIVATE|MAP_FIXED|MAP_NORESERVE|MAP_ANONYMOUS, -1, 0);
1990   return res  != (uintptr_t) MAP_FAILED;
1991 #endif
1992 }
1993 
1994 bool os::pd_create_stack_guard_pages(char* addr, size_t size) {
1995   return os::commit_memory(addr, size, !ExecMem);
1996 }
1997 
1998 // If this is a growable mapping, remove the guard pages entirely by
1999 // munmap()ping them.  If not, just call uncommit_memory().
2000 bool os::remove_stack_guard_pages(char* addr, size_t size) {
2001   return os::uncommit_memory(addr, size);
2002 }
2003 
2004 // If &#39;fixed&#39; is true, anon_mmap() will attempt to reserve anonymous memory
2005 // at &#39;requested_addr&#39;. If there are existing memory mappings at the same
2006 // location, however, they will be overwritten. If &#39;fixed&#39; is false,
2007 // &#39;requested_addr&#39; is only treated as a hint, the return value may or
2008 // may not start from the requested address. Unlike Bsd mmap(), this
2009 // function returns NULL to indicate failure.
2010 static char* anon_mmap(char* requested_addr, size_t bytes, bool fixed) {
2011   char * addr;
2012   int flags;
2013 
2014   flags = MAP_PRIVATE | MAP_NORESERVE | MAP_ANONYMOUS;
2015   if (fixed) {
2016     assert((uintptr_t)requested_addr % os::Bsd::page_size() == 0, &quot;unaligned address&quot;);
2017     flags |= MAP_FIXED;
2018   }
2019 
2020   // Map reserved/uncommitted pages PROT_NONE so we fail early if we
2021   // touch an uncommitted page. Otherwise, the read/write might
2022   // succeed if we have enough swap space to back the physical page.
2023   addr = (char*)::mmap(requested_addr, bytes, PROT_NONE,
2024                        flags, -1, 0);
2025 
2026   return addr == MAP_FAILED ? NULL : addr;
2027 }
2028 
2029 static int anon_munmap(char * addr, size_t size) {
2030   return ::munmap(addr, size) == 0;
2031 }
2032 
2033 char* os::pd_reserve_memory(size_t bytes, char* requested_addr,
2034                             size_t alignment_hint) {
2035   return anon_mmap(requested_addr, bytes, (requested_addr != NULL));
2036 }
2037 
2038 bool os::pd_release_memory(char* addr, size_t size) {
2039   return anon_munmap(addr, size);
2040 }
2041 
2042 static bool bsd_mprotect(char* addr, size_t size, int prot) {
2043   // Bsd wants the mprotect address argument to be page aligned.
2044   char* bottom = (char*)align_down((intptr_t)addr, os::Bsd::page_size());
2045 
2046   // According to SUSv3, mprotect() should only be used with mappings
2047   // established by mmap(), and mmap() always maps whole pages. Unaligned
2048   // &#39;addr&#39; likely indicates problem in the VM (e.g. trying to change
2049   // protection of malloc&#39;ed or statically allocated memory). Check the
2050   // caller if you hit this assert.
2051   assert(addr == bottom, &quot;sanity check&quot;);
2052 
2053   size = align_up(pointer_delta(addr, bottom, 1) + size, os::Bsd::page_size());
2054   Events::log(NULL, &quot;Protecting memory [&quot; INTPTR_FORMAT &quot;,&quot; INTPTR_FORMAT &quot;] with protection modes %x&quot;, p2i(bottom), p2i(bottom+size), prot);
2055   return ::mprotect(bottom, size, prot) == 0;
2056 }
2057 
2058 // Set protections specified
2059 bool os::protect_memory(char* addr, size_t bytes, ProtType prot,
2060                         bool is_committed) {
2061   unsigned int p = 0;
2062   switch (prot) {
2063   case MEM_PROT_NONE: p = PROT_NONE; break;
2064   case MEM_PROT_READ: p = PROT_READ; break;
2065   case MEM_PROT_RW:   p = PROT_READ|PROT_WRITE; break;
2066   case MEM_PROT_RWX:  p = PROT_READ|PROT_WRITE|PROT_EXEC; break;
2067   default:
2068     ShouldNotReachHere();
2069   }
2070   // is_committed is unused.
2071   return bsd_mprotect(addr, bytes, p);
2072 }
2073 
2074 bool os::guard_memory(char* addr, size_t size) {
2075   return bsd_mprotect(addr, size, PROT_NONE);
2076 }
2077 
2078 bool os::unguard_memory(char* addr, size_t size) {
2079   return bsd_mprotect(addr, size, PROT_READ|PROT_WRITE);
2080 }
2081 
2082 bool os::Bsd::hugetlbfs_sanity_check(bool warn, size_t page_size) {
2083   return false;
2084 }
2085 
2086 // Large page support
2087 
2088 static size_t _large_page_size = 0;
2089 
2090 void os::large_page_init() {
2091 }
2092 
2093 
2094 char* os::pd_reserve_memory_special(size_t bytes, size_t alignment, char* req_addr, bool exec) {
2095   fatal(&quot;os::reserve_memory_special should not be called on BSD.&quot;);
2096   return NULL;
2097 }
2098 
2099 bool os::pd_release_memory_special(char* base, size_t bytes) {
2100   fatal(&quot;os::release_memory_special should not be called on BSD.&quot;);
2101   return false;
2102 }
2103 
2104 size_t os::large_page_size() {
2105   return _large_page_size;
2106 }
2107 
2108 bool os::can_commit_large_page_memory() {
2109   // Does not matter, we do not support huge pages.
2110   return false;
2111 }
2112 
2113 bool os::can_execute_large_page_memory() {
2114   // Does not matter, we do not support huge pages.
2115   return false;
2116 }
2117 
2118 char* os::pd_attempt_reserve_memory_at(size_t bytes, char* requested_addr, int file_desc) {
2119   assert(file_desc &gt;= 0, &quot;file_desc is not valid&quot;);
2120   char* result = pd_attempt_reserve_memory_at(bytes, requested_addr);
2121   if (result != NULL) {
2122     if (replace_existing_mapping_with_file_mapping(result, bytes, file_desc) == NULL) {
2123       vm_exit_during_initialization(err_msg(&quot;Error in mapping Java heap at the given filesystem directory&quot;));
2124     }
2125   }
2126   return result;
2127 }
2128 
2129 // Reserve memory at an arbitrary address, only if that area is
2130 // available (and not reserved for something else).
2131 
2132 char* os::pd_attempt_reserve_memory_at(size_t bytes, char* requested_addr) {
2133   // Assert only that the size is a multiple of the page size, since
2134   // that&#39;s all that mmap requires, and since that&#39;s all we really know
2135   // about at this low abstraction level.  If we need higher alignment,
2136   // we can either pass an alignment to this method or verify alignment
2137   // in one of the methods further up the call chain.  See bug 5044738.
2138   assert(bytes % os::vm_page_size() == 0, &quot;reserving unexpected size block&quot;);
2139 
2140   // Repeatedly allocate blocks until the block is allocated at the
2141   // right spot.
2142 
2143   // Bsd mmap allows caller to pass an address as hint; give it a try first,
2144   // if kernel honors the hint then we can return immediately.
2145   char * addr = anon_mmap(requested_addr, bytes, false);
2146   if (addr == requested_addr) {
2147     return requested_addr;
2148   }
2149 
2150   if (addr != NULL) {
2151     // mmap() is successful but it fails to reserve at the requested address
2152     anon_munmap(addr, bytes);
2153   }
2154 
2155   return NULL;
2156 }
2157 
2158 // Sleep forever; naked call to OS-specific sleep; use with CAUTION
2159 void os::infinite_sleep() {
2160   while (true) {    // sleep forever ...
2161     ::sleep(100);   // ... 100 seconds at a time
2162   }
2163 }
2164 
2165 // Used to convert frequent JVM_Yield() to nops
2166 bool os::dont_yield() {
2167   return DontYieldALot;
2168 }
2169 
2170 void os::naked_yield() {
2171   sched_yield();
2172 }
2173 
2174 ////////////////////////////////////////////////////////////////////////////////
2175 // thread priority support
2176 
2177 // Note: Normal Bsd applications are run with SCHED_OTHER policy. SCHED_OTHER
2178 // only supports dynamic priority, static priority must be zero. For real-time
2179 // applications, Bsd supports SCHED_RR which allows static priority (1-99).
2180 // However, for large multi-threaded applications, SCHED_RR is not only slower
2181 // than SCHED_OTHER, but also very unstable (my volano tests hang hard 4 out
2182 // of 5 runs - Sep 2005).
2183 //
2184 // The following code actually changes the niceness of kernel-thread/LWP. It
2185 // has an assumption that setpriority() only modifies one kernel-thread/LWP,
2186 // not the entire user process, and user level threads are 1:1 mapped to kernel
2187 // threads. It has always been the case, but could change in the future. For
2188 // this reason, the code should not be used as default (ThreadPriorityPolicy=0).
2189 // It is only used when ThreadPriorityPolicy=1 and may require system level permission
2190 // (e.g., root privilege or CAP_SYS_NICE capability).
2191 
2192 #if !defined(__APPLE__)
2193 int os::java_to_os_priority[CriticalPriority + 1] = {
2194   19,              // 0 Entry should never be used
2195 
2196    0,              // 1 MinPriority
2197    3,              // 2
2198    6,              // 3
2199 
2200   10,              // 4
2201   15,              // 5 NormPriority
2202   18,              // 6
2203 
2204   21,              // 7
2205   25,              // 8
2206   28,              // 9 NearMaxPriority
2207 
2208   31,              // 10 MaxPriority
2209 
2210   31               // 11 CriticalPriority
2211 };
2212 #else
2213 // Using Mach high-level priority assignments
2214 int os::java_to_os_priority[CriticalPriority + 1] = {
2215    0,              // 0 Entry should never be used (MINPRI_USER)
2216 
2217   27,              // 1 MinPriority
2218   28,              // 2
2219   29,              // 3
2220 
2221   30,              // 4
2222   31,              // 5 NormPriority (BASEPRI_DEFAULT)
2223   32,              // 6
2224 
2225   33,              // 7
2226   34,              // 8
2227   35,              // 9 NearMaxPriority
2228 
2229   36,              // 10 MaxPriority
2230 
2231   36               // 11 CriticalPriority
2232 };
2233 #endif
2234 
2235 static int prio_init() {
2236   if (ThreadPriorityPolicy == 1) {
2237     if (geteuid() != 0) {
2238       if (!FLAG_IS_DEFAULT(ThreadPriorityPolicy) &amp;&amp; !FLAG_IS_JIMAGE_RESOURCE(ThreadPriorityPolicy)) {
2239         warning(&quot;-XX:ThreadPriorityPolicy=1 may require system level permission, &quot; \
2240                 &quot;e.g., being the root user. If the necessary permission is not &quot; \
2241                 &quot;possessed, changes to priority will be silently ignored.&quot;);
2242       }
2243     }
2244   }
2245   if (UseCriticalJavaThreadPriority) {
2246     os::java_to_os_priority[MaxPriority] = os::java_to_os_priority[CriticalPriority];
2247   }
2248   return 0;
2249 }
2250 
2251 OSReturn os::set_native_priority(Thread* thread, int newpri) {
2252   if (!UseThreadPriorities || ThreadPriorityPolicy == 0) return OS_OK;
2253 
2254 #ifdef __OpenBSD__
2255   // OpenBSD pthread_setprio starves low priority threads
2256   return OS_OK;
2257 #elif defined(__FreeBSD__)
2258   int ret = pthread_setprio(thread-&gt;osthread()-&gt;pthread_id(), newpri);
2259   return (ret == 0) ? OS_OK : OS_ERR;
2260 #elif defined(__APPLE__) || defined(__NetBSD__)
2261   struct sched_param sp;
2262   int policy;
2263 
2264   if (pthread_getschedparam(thread-&gt;osthread()-&gt;pthread_id(), &amp;policy, &amp;sp) != 0) {
2265     return OS_ERR;
2266   }
2267 
2268   sp.sched_priority = newpri;
2269   if (pthread_setschedparam(thread-&gt;osthread()-&gt;pthread_id(), policy, &amp;sp) != 0) {
2270     return OS_ERR;
2271   }
2272 
2273   return OS_OK;
2274 #else
2275   int ret = setpriority(PRIO_PROCESS, thread-&gt;osthread()-&gt;thread_id(), newpri);
2276   return (ret == 0) ? OS_OK : OS_ERR;
2277 #endif
2278 }
2279 
2280 OSReturn os::get_native_priority(const Thread* const thread, int *priority_ptr) {
2281   if (!UseThreadPriorities || ThreadPriorityPolicy == 0) {
2282     *priority_ptr = java_to_os_priority[NormPriority];
2283     return OS_OK;
2284   }
2285 
2286   errno = 0;
2287 #if defined(__OpenBSD__) || defined(__FreeBSD__)
2288   *priority_ptr = pthread_getprio(thread-&gt;osthread()-&gt;pthread_id());
2289 #elif defined(__APPLE__) || defined(__NetBSD__)
2290   int policy;
2291   struct sched_param sp;
2292 
2293   int res = pthread_getschedparam(thread-&gt;osthread()-&gt;pthread_id(), &amp;policy, &amp;sp);
2294   if (res != 0) {
2295     *priority_ptr = -1;
2296     return OS_ERR;
2297   } else {
2298     *priority_ptr = sp.sched_priority;
2299     return OS_OK;
2300   }
2301 #else
2302   *priority_ptr = getpriority(PRIO_PROCESS, thread-&gt;osthread()-&gt;thread_id());
2303 #endif
2304   return (*priority_ptr != -1 || errno == 0 ? OS_OK : OS_ERR);
2305 }
2306 
2307 ////////////////////////////////////////////////////////////////////////////////
2308 // suspend/resume support
2309 
2310 //  The low-level signal-based suspend/resume support is a remnant from the
2311 //  old VM-suspension that used to be for java-suspension, safepoints etc,
2312 //  within hotspot. Currently used by JFR&#39;s OSThreadSampler
2313 //
2314 //  The remaining code is greatly simplified from the more general suspension
2315 //  code that used to be used.
2316 //
2317 //  The protocol is quite simple:
2318 //  - suspend:
2319 //      - sends a signal to the target thread
2320 //      - polls the suspend state of the osthread using a yield loop
2321 //      - target thread signal handler (SR_handler) sets suspend state
2322 //        and blocks in sigsuspend until continued
2323 //  - resume:
2324 //      - sets target osthread state to continue
2325 //      - sends signal to end the sigsuspend loop in the SR_handler
2326 //
2327 //  Note that the SR_lock plays no role in this suspend/resume protocol,
2328 //  but is checked for NULL in SR_handler as a thread termination indicator.
2329 //  The SR_lock is, however, used by JavaThread::java_suspend()/java_resume() APIs.
2330 //
2331 //  Note that resume_clear_context() and suspend_save_context() are needed
2332 //  by SR_handler(), so that fetch_frame_from_context() works,
2333 //  which in part is used by:
2334 //    - Forte Analyzer: AsyncGetCallTrace()
2335 //    - StackBanging: get_frame_at_stack_banging_point()
2336 
2337 static void resume_clear_context(OSThread *osthread) {
2338   osthread-&gt;set_ucontext(NULL);
2339   osthread-&gt;set_siginfo(NULL);
2340 }
2341 
2342 static void suspend_save_context(OSThread *osthread, siginfo_t* siginfo, ucontext_t* context) {
2343   osthread-&gt;set_ucontext(context);
2344   osthread-&gt;set_siginfo(siginfo);
2345 }
2346 
2347 // Handler function invoked when a thread&#39;s execution is suspended or
2348 // resumed. We have to be careful that only async-safe functions are
2349 // called here (Note: most pthread functions are not async safe and
2350 // should be avoided.)
2351 //
2352 // Note: sigwait() is a more natural fit than sigsuspend() from an
2353 // interface point of view, but sigwait() prevents the signal hander
2354 // from being run. libpthread would get very confused by not having
2355 // its signal handlers run and prevents sigwait()&#39;s use with the
2356 // mutex granting granting signal.
2357 //
2358 // Currently only ever called on the VMThread or JavaThread
2359 //
2360 #ifdef __APPLE__
2361 static OSXSemaphore sr_semaphore;
2362 #else
2363 static PosixSemaphore sr_semaphore;
2364 #endif
2365 
2366 static void SR_handler(int sig, siginfo_t* siginfo, ucontext_t* context) {
2367   // Save and restore errno to avoid confusing native code with EINTR
2368   // after sigsuspend.
2369   int old_errno = errno;
2370 
2371   Thread* thread = Thread::current_or_null_safe();
2372   assert(thread != NULL, &quot;Missing current thread in SR_handler&quot;);
2373 
2374   // On some systems we have seen signal delivery get &quot;stuck&quot; until the signal
2375   // mask is changed as part of thread termination. Check that the current thread
2376   // has not already terminated (via SR_lock()) - else the following assertion
2377   // will fail because the thread is no longer a JavaThread as the ~JavaThread
2378   // destructor has completed.
2379 
2380   if (thread-&gt;SR_lock() == NULL) {
2381     return;
2382   }
2383 
2384   assert(thread-&gt;is_VM_thread() || thread-&gt;is_Java_thread(), &quot;Must be VMThread or JavaThread&quot;);
2385 
2386   OSThread* osthread = thread-&gt;osthread();
2387 
2388   os::SuspendResume::State current = osthread-&gt;sr.state();
2389   if (current == os::SuspendResume::SR_SUSPEND_REQUEST) {
2390     suspend_save_context(osthread, siginfo, context);
2391 
2392     // attempt to switch the state, we assume we had a SUSPEND_REQUEST
2393     os::SuspendResume::State state = osthread-&gt;sr.suspended();
2394     if (state == os::SuspendResume::SR_SUSPENDED) {
2395       sigset_t suspend_set;  // signals for sigsuspend()
2396 
2397       // get current set of blocked signals and unblock resume signal
2398       pthread_sigmask(SIG_BLOCK, NULL, &amp;suspend_set);
2399       sigdelset(&amp;suspend_set, SR_signum);
2400 
2401       sr_semaphore.signal();
2402       // wait here until we are resumed
2403       while (1) {
2404         sigsuspend(&amp;suspend_set);
2405 
2406         os::SuspendResume::State result = osthread-&gt;sr.running();
2407         if (result == os::SuspendResume::SR_RUNNING) {
2408           sr_semaphore.signal();
2409           break;
2410         } else if (result != os::SuspendResume::SR_SUSPENDED) {
2411           ShouldNotReachHere();
2412         }
2413       }
2414 
2415     } else if (state == os::SuspendResume::SR_RUNNING) {
2416       // request was cancelled, continue
2417     } else {
2418       ShouldNotReachHere();
2419     }
2420 
2421     resume_clear_context(osthread);
2422   } else if (current == os::SuspendResume::SR_RUNNING) {
2423     // request was cancelled, continue
2424   } else if (current == os::SuspendResume::SR_WAKEUP_REQUEST) {
2425     // ignore
2426   } else {
2427     // ignore
2428   }
2429 
2430   errno = old_errno;
2431 }
2432 
2433 
2434 static int SR_initialize() {
2435   struct sigaction act;
2436   char *s;
2437   // Get signal number to use for suspend/resume
2438   if ((s = ::getenv(&quot;_JAVA_SR_SIGNUM&quot;)) != 0) {
2439     int sig = ::strtol(s, 0, 10);
2440     if (sig &gt; MAX2(SIGSEGV, SIGBUS) &amp;&amp;  // See 4355769.
2441         sig &lt; NSIG) {                   // Must be legal signal and fit into sigflags[].
2442       SR_signum = sig;
2443     } else {
2444       warning(&quot;You set _JAVA_SR_SIGNUM=%d. It must be in range [%d, %d]. Using %d instead.&quot;,
2445               sig, MAX2(SIGSEGV, SIGBUS)+1, NSIG-1, SR_signum);
2446     }
2447   }
2448 
2449   assert(SR_signum &gt; SIGSEGV &amp;&amp; SR_signum &gt; SIGBUS,
2450          &quot;SR_signum must be greater than max(SIGSEGV, SIGBUS), see 4355769&quot;);
2451 
2452   sigemptyset(&amp;SR_sigset);
2453   sigaddset(&amp;SR_sigset, SR_signum);
2454 
2455   // Set up signal handler for suspend/resume
2456   act.sa_flags = SA_RESTART|SA_SIGINFO;
2457   act.sa_handler = (void (*)(int)) SR_handler;
2458 
2459   // SR_signum is blocked by default.
2460   // 4528190 - We also need to block pthread restart signal (32 on all
2461   // supported Bsd platforms). Note that BsdThreads need to block
2462   // this signal for all threads to work properly. So we don&#39;t have
2463   // to use hard-coded signal number when setting up the mask.
2464   pthread_sigmask(SIG_BLOCK, NULL, &amp;act.sa_mask);
2465 
2466   if (sigaction(SR_signum, &amp;act, 0) == -1) {
2467     return -1;
2468   }
2469 
2470   // Save signal flag
2471   os::Bsd::set_our_sigflags(SR_signum, act.sa_flags);
2472   return 0;
2473 }
2474 
2475 static int sr_notify(OSThread* osthread) {
2476   int status = pthread_kill(osthread-&gt;pthread_id(), SR_signum);
2477   assert_status(status == 0, status, &quot;pthread_kill&quot;);
2478   return status;
2479 }
2480 
2481 // &quot;Randomly&quot; selected value for how long we want to spin
2482 // before bailing out on suspending a thread, also how often
2483 // we send a signal to a thread we want to resume
2484 static const int RANDOMLY_LARGE_INTEGER = 1000000;
2485 static const int RANDOMLY_LARGE_INTEGER2 = 100;
2486 
2487 // returns true on success and false on error - really an error is fatal
2488 // but this seems the normal response to library errors
2489 static bool do_suspend(OSThread* osthread) {
2490   assert(osthread-&gt;sr.is_running(), &quot;thread should be running&quot;);
2491   assert(!sr_semaphore.trywait(), &quot;semaphore has invalid state&quot;);
2492 
2493   // mark as suspended and send signal
2494   if (osthread-&gt;sr.request_suspend() != os::SuspendResume::SR_SUSPEND_REQUEST) {
2495     // failed to switch, state wasn&#39;t running?
2496     ShouldNotReachHere();
2497     return false;
2498   }
2499 
2500   if (sr_notify(osthread) != 0) {
2501     ShouldNotReachHere();
2502   }
2503 
2504   // managed to send the signal and switch to SUSPEND_REQUEST, now wait for SUSPENDED
2505   while (true) {
2506     if (sr_semaphore.timedwait(2)) {
2507       break;
2508     } else {
2509       // timeout
2510       os::SuspendResume::State cancelled = osthread-&gt;sr.cancel_suspend();
2511       if (cancelled == os::SuspendResume::SR_RUNNING) {
2512         return false;
2513       } else if (cancelled == os::SuspendResume::SR_SUSPENDED) {
2514         // make sure that we consume the signal on the semaphore as well
2515         sr_semaphore.wait();
2516         break;
2517       } else {
2518         ShouldNotReachHere();
2519         return false;
2520       }
2521     }
2522   }
2523 
2524   guarantee(osthread-&gt;sr.is_suspended(), &quot;Must be suspended&quot;);
2525   return true;
2526 }
2527 
2528 static void do_resume(OSThread* osthread) {
2529   assert(osthread-&gt;sr.is_suspended(), &quot;thread should be suspended&quot;);
2530   assert(!sr_semaphore.trywait(), &quot;invalid semaphore state&quot;);
2531 
2532   if (osthread-&gt;sr.request_wakeup() != os::SuspendResume::SR_WAKEUP_REQUEST) {
2533     // failed to switch to WAKEUP_REQUEST
2534     ShouldNotReachHere();
2535     return;
2536   }
2537 
2538   while (true) {
2539     if (sr_notify(osthread) == 0) {
2540       if (sr_semaphore.timedwait(2)) {
2541         if (osthread-&gt;sr.is_running()) {
2542           return;
2543         }
2544       }
2545     } else {
2546       ShouldNotReachHere();
2547     }
2548   }
2549 
2550   guarantee(osthread-&gt;sr.is_running(), &quot;Must be running!&quot;);
2551 }
2552 
2553 ///////////////////////////////////////////////////////////////////////////////////
2554 // signal handling (except suspend/resume)
2555 
2556 // This routine may be used by user applications as a &quot;hook&quot; to catch signals.
2557 // The user-defined signal handler must pass unrecognized signals to this
2558 // routine, and if it returns true (non-zero), then the signal handler must
2559 // return immediately.  If the flag &quot;abort_if_unrecognized&quot; is true, then this
2560 // routine will never retun false (zero), but instead will execute a VM panic
2561 // routine kill the process.
2562 //
2563 // If this routine returns false, it is OK to call it again.  This allows
2564 // the user-defined signal handler to perform checks either before or after
2565 // the VM performs its own checks.  Naturally, the user code would be making
2566 // a serious error if it tried to handle an exception (such as a null check
2567 // or breakpoint) that the VM was generating for its own correct operation.
2568 //
2569 // This routine may recognize any of the following kinds of signals:
2570 //    SIGBUS, SIGSEGV, SIGILL, SIGFPE, SIGQUIT, SIGPIPE, SIGXFSZ, SIGUSR1.
2571 // It should be consulted by handlers for any of those signals.
2572 //
2573 // The caller of this routine must pass in the three arguments supplied
2574 // to the function referred to in the &quot;sa_sigaction&quot; (not the &quot;sa_handler&quot;)
2575 // field of the structure passed to sigaction().  This routine assumes that
2576 // the sa_flags field passed to sigaction() includes SA_SIGINFO and SA_RESTART.
2577 //
2578 // Note that the VM will print warnings if it detects conflicting signal
2579 // handlers, unless invoked with the option &quot;-XX:+AllowUserSignalHandlers&quot;.
2580 //
2581 extern &quot;C&quot; JNIEXPORT int JVM_handle_bsd_signal(int signo, siginfo_t* siginfo,
2582                                                void* ucontext,
2583                                                int abort_if_unrecognized);
2584 
2585 static void signalHandler(int sig, siginfo_t* info, void* uc) {
2586   assert(info != NULL &amp;&amp; uc != NULL, &quot;it must be old kernel&quot;);
2587   int orig_errno = errno;  // Preserve errno value over signal handler.
2588   JVM_handle_bsd_signal(sig, info, uc, true);
2589   errno = orig_errno;
2590 }
2591 
2592 
2593 // This boolean allows users to forward their own non-matching signals
2594 // to JVM_handle_bsd_signal, harmlessly.
2595 bool os::Bsd::signal_handlers_are_installed = false;
2596 
2597 // For signal-chaining
2598 bool os::Bsd::libjsig_is_loaded = false;
2599 typedef struct sigaction *(*get_signal_t)(int);
2600 get_signal_t os::Bsd::get_signal_action = NULL;
2601 
2602 struct sigaction* os::Bsd::get_chained_signal_action(int sig) {
2603   struct sigaction *actp = NULL;
2604 
2605   if (libjsig_is_loaded) {
2606     // Retrieve the old signal handler from libjsig
2607     actp = (*get_signal_action)(sig);
2608   }
2609   if (actp == NULL) {
2610     // Retrieve the preinstalled signal handler from jvm
2611     actp = os::Posix::get_preinstalled_handler(sig);
2612   }
2613 
2614   return actp;
2615 }
2616 
2617 static bool call_chained_handler(struct sigaction *actp, int sig,
2618                                  siginfo_t *siginfo, void *context) {
2619   // Call the old signal handler
2620   if (actp-&gt;sa_handler == SIG_DFL) {
2621     // It&#39;s more reasonable to let jvm treat it as an unexpected exception
2622     // instead of taking the default action.
2623     return false;
2624   } else if (actp-&gt;sa_handler != SIG_IGN) {
2625     if ((actp-&gt;sa_flags &amp; SA_NODEFER) == 0) {
2626       // automaticlly block the signal
2627       sigaddset(&amp;(actp-&gt;sa_mask), sig);
2628     }
2629 
2630     sa_handler_t hand;
2631     sa_sigaction_t sa;
2632     bool siginfo_flag_set = (actp-&gt;sa_flags &amp; SA_SIGINFO) != 0;
2633     // retrieve the chained handler
2634     if (siginfo_flag_set) {
2635       sa = actp-&gt;sa_sigaction;
2636     } else {
2637       hand = actp-&gt;sa_handler;
2638     }
2639 
2640     if ((actp-&gt;sa_flags &amp; SA_RESETHAND) != 0) {
2641       actp-&gt;sa_handler = SIG_DFL;
2642     }
2643 
2644     // try to honor the signal mask
2645     sigset_t oset;
2646     pthread_sigmask(SIG_SETMASK, &amp;(actp-&gt;sa_mask), &amp;oset);
2647 
2648     // call into the chained handler
2649     if (siginfo_flag_set) {
2650       (*sa)(sig, siginfo, context);
2651     } else {
2652       (*hand)(sig);
2653     }
2654 
2655     // restore the signal mask
2656     pthread_sigmask(SIG_SETMASK, &amp;oset, 0);
2657   }
2658   // Tell jvm&#39;s signal handler the signal is taken care of.
2659   return true;
2660 }
2661 
2662 bool os::Bsd::chained_handler(int sig, siginfo_t* siginfo, void* context) {
2663   bool chained = false;
2664   // signal-chaining
2665   if (UseSignalChaining) {
2666     struct sigaction *actp = get_chained_signal_action(sig);
2667     if (actp != NULL) {
2668       chained = call_chained_handler(actp, sig, siginfo, context);
2669     }
2670   }
2671   return chained;
2672 }
2673 
2674 // for diagnostic
2675 int sigflags[NSIG];
2676 
2677 int os::Bsd::get_our_sigflags(int sig) {
2678   assert(sig &gt; 0 &amp;&amp; sig &lt; NSIG, &quot;vm signal out of expected range&quot;);
2679   return sigflags[sig];
2680 }
2681 
2682 void os::Bsd::set_our_sigflags(int sig, int flags) {
2683   assert(sig &gt; 0 &amp;&amp; sig &lt; NSIG, &quot;vm signal out of expected range&quot;);
2684   if (sig &gt; 0 &amp;&amp; sig &lt; NSIG) {
2685     sigflags[sig] = flags;
2686   }
2687 }
2688 
2689 void os::Bsd::set_signal_handler(int sig, bool set_installed) {
2690   // Check for overwrite.
2691   struct sigaction oldAct;
2692   sigaction(sig, (struct sigaction*)NULL, &amp;oldAct);
2693 
2694   void* oldhand = oldAct.sa_sigaction
2695                 ? CAST_FROM_FN_PTR(void*,  oldAct.sa_sigaction)
2696                 : CAST_FROM_FN_PTR(void*,  oldAct.sa_handler);
2697   if (oldhand != CAST_FROM_FN_PTR(void*, SIG_DFL) &amp;&amp;
2698       oldhand != CAST_FROM_FN_PTR(void*, SIG_IGN) &amp;&amp;
2699       oldhand != CAST_FROM_FN_PTR(void*, (sa_sigaction_t)signalHandler)) {
2700     if (AllowUserSignalHandlers || !set_installed) {
2701       // Do not overwrite; user takes responsibility to forward to us.
2702       return;
2703     } else if (UseSignalChaining) {
2704       // save the old handler in jvm
2705       os::Posix::save_preinstalled_handler(sig, oldAct);
2706       // libjsig also interposes the sigaction() call below and saves the
2707       // old sigaction on it own.
2708     } else {
2709       fatal(&quot;Encountered unexpected pre-existing sigaction handler &quot;
2710             &quot;%#lx for signal %d.&quot;, (long)oldhand, sig);
2711     }
2712   }
2713 
2714   struct sigaction sigAct;
2715   sigfillset(&amp;(sigAct.sa_mask));
2716   sigAct.sa_handler = SIG_DFL;
2717   if (!set_installed) {
2718     sigAct.sa_flags = SA_SIGINFO|SA_RESTART;
2719   } else {
2720     sigAct.sa_sigaction = signalHandler;
2721     sigAct.sa_flags = SA_SIGINFO|SA_RESTART;
2722   }
2723 #ifdef __APPLE__
2724   // Needed for main thread as XNU (Mac OS X kernel) will only deliver SIGSEGV
2725   // (which starts as SIGBUS) on main thread with faulting address inside &quot;stack+guard pages&quot;
2726   // if the signal handler declares it will handle it on alternate stack.
2727   // Notice we only declare we will handle it on alt stack, but we are not
2728   // actually going to use real alt stack - this is just a workaround.
2729   // Please see ux_exception.c, method catch_mach_exception_raise for details
2730   // link http://www.opensource.apple.com/source/xnu/xnu-2050.18.24/bsd/uxkern/ux_exception.c
2731   if (sig == SIGSEGV) {
2732     sigAct.sa_flags |= SA_ONSTACK;
2733   }
2734 #endif
2735 
2736   // Save flags, which are set by ours
2737   assert(sig &gt; 0 &amp;&amp; sig &lt; NSIG, &quot;vm signal out of expected range&quot;);
2738   sigflags[sig] = sigAct.sa_flags;
2739 
2740   int ret = sigaction(sig, &amp;sigAct, &amp;oldAct);
2741   assert(ret == 0, &quot;check&quot;);
2742 
2743   void* oldhand2  = oldAct.sa_sigaction
2744                   ? CAST_FROM_FN_PTR(void*, oldAct.sa_sigaction)
2745                   : CAST_FROM_FN_PTR(void*, oldAct.sa_handler);
2746   assert(oldhand2 == oldhand, &quot;no concurrent signal handler installation&quot;);
2747 }
2748 
2749 // install signal handlers for signals that HotSpot needs to
2750 // handle in order to support Java-level exception handling.
2751 
2752 void os::Bsd::install_signal_handlers() {
2753   if (!signal_handlers_are_installed) {
2754     signal_handlers_are_installed = true;
2755 
2756     // signal-chaining
2757     typedef void (*signal_setting_t)();
2758     signal_setting_t begin_signal_setting = NULL;
2759     signal_setting_t end_signal_setting = NULL;
2760     begin_signal_setting = CAST_TO_FN_PTR(signal_setting_t,
2761                                           dlsym(RTLD_DEFAULT, &quot;JVM_begin_signal_setting&quot;));
2762     if (begin_signal_setting != NULL) {
2763       end_signal_setting = CAST_TO_FN_PTR(signal_setting_t,
2764                                           dlsym(RTLD_DEFAULT, &quot;JVM_end_signal_setting&quot;));
2765       get_signal_action = CAST_TO_FN_PTR(get_signal_t,
2766                                          dlsym(RTLD_DEFAULT, &quot;JVM_get_signal_action&quot;));
2767       libjsig_is_loaded = true;
2768       assert(UseSignalChaining, &quot;should enable signal-chaining&quot;);
2769     }
2770     if (libjsig_is_loaded) {
2771       // Tell libjsig jvm is setting signal handlers
2772       (*begin_signal_setting)();
2773     }
2774 
2775     set_signal_handler(SIGSEGV, true);
2776     set_signal_handler(SIGPIPE, true);
2777     set_signal_handler(SIGBUS, true);
2778     set_signal_handler(SIGILL, true);
2779     set_signal_handler(SIGFPE, true);
2780     set_signal_handler(SIGXFSZ, true);
2781 
2782 #if defined(__APPLE__)
2783     // In Mac OS X 10.4, CrashReporter will write a crash log for all &#39;fatal&#39; signals, including
2784     // signals caught and handled by the JVM. To work around this, we reset the mach task
2785     // signal handler that&#39;s placed on our process by CrashReporter. This disables
2786     // CrashReporter-based reporting.
2787     //
2788     // This work-around is not necessary for 10.5+, as CrashReporter no longer intercedes
2789     // on caught fatal signals.
2790     //
2791     // Additionally, gdb installs both standard BSD signal handlers, and mach exception
2792     // handlers. By replacing the existing task exception handler, we disable gdb&#39;s mach
2793     // exception handling, while leaving the standard BSD signal handlers functional.
2794     kern_return_t kr;
2795     kr = task_set_exception_ports(mach_task_self(),
2796                                   EXC_MASK_BAD_ACCESS | EXC_MASK_ARITHMETIC,
2797                                   MACH_PORT_NULL,
2798                                   EXCEPTION_STATE_IDENTITY,
2799                                   MACHINE_THREAD_STATE);
2800 
2801     assert(kr == KERN_SUCCESS, &quot;could not set mach task signal handler&quot;);
2802 #endif
2803 
2804     if (libjsig_is_loaded) {
2805       // Tell libjsig jvm finishes setting signal handlers
2806       (*end_signal_setting)();
2807     }
2808 
2809     // We don&#39;t activate signal checker if libjsig is in place, we trust ourselves
2810     // and if UserSignalHandler is installed all bets are off
2811     if (CheckJNICalls) {
2812       if (libjsig_is_loaded) {
2813         log_debug(jni, resolve)(&quot;Info: libjsig is activated, all active signal checking is disabled&quot;);
2814         check_signals = false;
2815       }
2816       if (AllowUserSignalHandlers) {
2817         log_debug(jni, resolve)(&quot;Info: AllowUserSignalHandlers is activated, all active signal checking is disabled&quot;);
2818         check_signals = false;
2819       }
2820     }
2821   }
2822 }
2823 
2824 
2825 /////
2826 // glibc on Bsd platform uses non-documented flag
2827 // to indicate, that some special sort of signal
2828 // trampoline is used.
2829 // We will never set this flag, and we should
2830 // ignore this flag in our diagnostic
2831 #ifdef SIGNIFICANT_SIGNAL_MASK
2832   #undef SIGNIFICANT_SIGNAL_MASK
2833 #endif
2834 #define SIGNIFICANT_SIGNAL_MASK (~0x04000000)
2835 
2836 static const char* get_signal_handler_name(address handler,
2837                                            char* buf, int buflen) {
2838   int offset;
2839   bool found = os::dll_address_to_library_name(handler, buf, buflen, &amp;offset);
2840   if (found) {
2841     // skip directory names
2842     const char *p1, *p2;
2843     p1 = buf;
2844     size_t len = strlen(os::file_separator());
2845     while ((p2 = strstr(p1, os::file_separator())) != NULL) p1 = p2 + len;
2846     jio_snprintf(buf, buflen, &quot;%s+0x%x&quot;, p1, offset);
2847   } else {
2848     jio_snprintf(buf, buflen, PTR_FORMAT, handler);
2849   }
2850   return buf;
2851 }
2852 
2853 static void print_signal_handler(outputStream* st, int sig,
2854                                  char* buf, size_t buflen) {
2855   struct sigaction sa;
2856 
2857   sigaction(sig, NULL, &amp;sa);
2858 
2859   // See comment for SIGNIFICANT_SIGNAL_MASK define
2860   sa.sa_flags &amp;= SIGNIFICANT_SIGNAL_MASK;
2861 
2862   st-&gt;print(&quot;%s: &quot;, os::exception_name(sig, buf, buflen));
2863 
2864   address handler = (sa.sa_flags &amp; SA_SIGINFO)
2865     ? CAST_FROM_FN_PTR(address, sa.sa_sigaction)
2866     : CAST_FROM_FN_PTR(address, sa.sa_handler);
2867 
2868   if (handler == CAST_FROM_FN_PTR(address, SIG_DFL)) {
2869     st-&gt;print(&quot;SIG_DFL&quot;);
2870   } else if (handler == CAST_FROM_FN_PTR(address, SIG_IGN)) {
2871     st-&gt;print(&quot;SIG_IGN&quot;);
2872   } else {
2873     st-&gt;print(&quot;[%s]&quot;, get_signal_handler_name(handler, buf, buflen));
2874   }
2875 
2876   st-&gt;print(&quot;, sa_mask[0]=&quot;);
2877   os::Posix::print_signal_set_short(st, &amp;sa.sa_mask);
2878 
2879   address rh = VMError::get_resetted_sighandler(sig);
2880   // May be, handler was resetted by VMError?
2881   if (rh != NULL) {
2882     handler = rh;
2883     sa.sa_flags = VMError::get_resetted_sigflags(sig) &amp; SIGNIFICANT_SIGNAL_MASK;
2884   }
2885 
2886   st-&gt;print(&quot;, sa_flags=&quot;);
2887   os::Posix::print_sa_flags(st, sa.sa_flags);
2888 
2889   // Check: is it our handler?
2890   if (handler == CAST_FROM_FN_PTR(address, (sa_sigaction_t)signalHandler) ||
2891       handler == CAST_FROM_FN_PTR(address, (sa_sigaction_t)SR_handler)) {
2892     // It is our signal handler
2893     // check for flags, reset system-used one!
2894     if ((int)sa.sa_flags != os::Bsd::get_our_sigflags(sig)) {
2895       st-&gt;print(
2896                 &quot;, flags was changed from &quot; PTR32_FORMAT &quot;, consider using jsig library&quot;,
2897                 os::Bsd::get_our_sigflags(sig));
2898     }
2899   }
2900   st-&gt;cr();
2901 }
2902 
2903 
2904 #define DO_SIGNAL_CHECK(sig)                      \
2905   do {                                            \
2906     if (!sigismember(&amp;check_signal_done, sig)) {  \
2907       os::Bsd::check_signal_handler(sig);         \
2908     }                                             \
2909   } while (0)
2910 
2911 // This method is a periodic task to check for misbehaving JNI applications
2912 // under CheckJNI, we can add any periodic checks here
2913 
2914 void os::run_periodic_checks() {
2915 
2916   if (check_signals == false) return;
2917 
2918   // SEGV and BUS if overridden could potentially prevent
2919   // generation of hs*.log in the event of a crash, debugging
2920   // such a case can be very challenging, so we absolutely
2921   // check the following for a good measure:
2922   DO_SIGNAL_CHECK(SIGSEGV);
2923   DO_SIGNAL_CHECK(SIGILL);
2924   DO_SIGNAL_CHECK(SIGFPE);
2925   DO_SIGNAL_CHECK(SIGBUS);
2926   DO_SIGNAL_CHECK(SIGPIPE);
2927   DO_SIGNAL_CHECK(SIGXFSZ);
2928 
2929 
2930   // ReduceSignalUsage allows the user to override these handlers
2931   // see comments at the very top and jvm_md.h
2932   if (!ReduceSignalUsage) {
2933     DO_SIGNAL_CHECK(SHUTDOWN1_SIGNAL);
2934     DO_SIGNAL_CHECK(SHUTDOWN2_SIGNAL);
2935     DO_SIGNAL_CHECK(SHUTDOWN3_SIGNAL);
2936     DO_SIGNAL_CHECK(BREAK_SIGNAL);
2937   }
2938 
2939   DO_SIGNAL_CHECK(SR_signum);
2940 }
2941 
2942 typedef int (*os_sigaction_t)(int, const struct sigaction *, struct sigaction *);
2943 
2944 static os_sigaction_t os_sigaction = NULL;
2945 
2946 void os::Bsd::check_signal_handler(int sig) {
2947   char buf[O_BUFLEN];
2948   address jvmHandler = NULL;
2949 
2950 
2951   struct sigaction act;
2952   if (os_sigaction == NULL) {
2953     // only trust the default sigaction, in case it has been interposed
2954     os_sigaction = (os_sigaction_t)dlsym(RTLD_DEFAULT, &quot;sigaction&quot;);
2955     if (os_sigaction == NULL) return;
2956   }
2957 
2958   os_sigaction(sig, (struct sigaction*)NULL, &amp;act);
2959 
2960 
2961   act.sa_flags &amp;= SIGNIFICANT_SIGNAL_MASK;
2962 
2963   address thisHandler = (act.sa_flags &amp; SA_SIGINFO)
2964     ? CAST_FROM_FN_PTR(address, act.sa_sigaction)
2965     : CAST_FROM_FN_PTR(address, act.sa_handler);
2966 
2967 
2968   switch (sig) {
2969   case SIGSEGV:
2970   case SIGBUS:
2971   case SIGFPE:
2972   case SIGPIPE:
2973   case SIGILL:
2974   case SIGXFSZ:
2975     jvmHandler = CAST_FROM_FN_PTR(address, (sa_sigaction_t)signalHandler);
2976     break;
2977 
2978   case SHUTDOWN1_SIGNAL:
2979   case SHUTDOWN2_SIGNAL:
2980   case SHUTDOWN3_SIGNAL:
2981   case BREAK_SIGNAL:
2982     jvmHandler = (address)user_handler();
2983     break;
2984 
2985   default:
2986     if (sig == SR_signum) {
2987       jvmHandler = CAST_FROM_FN_PTR(address, (sa_sigaction_t)SR_handler);
2988     } else {
2989       return;
2990     }
2991     break;
2992   }
2993 
2994   if (thisHandler != jvmHandler) {
2995     tty-&gt;print(&quot;Warning: %s handler &quot;, exception_name(sig, buf, O_BUFLEN));
2996     tty-&gt;print(&quot;expected:%s&quot;, get_signal_handler_name(jvmHandler, buf, O_BUFLEN));
2997     tty-&gt;print_cr(&quot;  found:%s&quot;, get_signal_handler_name(thisHandler, buf, O_BUFLEN));
2998     // No need to check this sig any longer
2999     sigaddset(&amp;check_signal_done, sig);
3000     // Running under non-interactive shell, SHUTDOWN2_SIGNAL will be reassigned SIG_IGN
3001     if (sig == SHUTDOWN2_SIGNAL &amp;&amp; !isatty(fileno(stdin))) {
3002       tty-&gt;print_cr(&quot;Running in non-interactive shell, %s handler is replaced by shell&quot;,
3003                     exception_name(sig, buf, O_BUFLEN));
3004     }
3005   } else if(os::Bsd::get_our_sigflags(sig) != 0 &amp;&amp; (int)act.sa_flags != os::Bsd::get_our_sigflags(sig)) {
3006     tty-&gt;print(&quot;Warning: %s handler flags &quot;, exception_name(sig, buf, O_BUFLEN));
3007     tty-&gt;print(&quot;expected:&quot;);
3008     os::Posix::print_sa_flags(tty, os::Bsd::get_our_sigflags(sig));
3009     tty-&gt;cr();
3010     tty-&gt;print(&quot;  found:&quot;);
3011     os::Posix::print_sa_flags(tty, act.sa_flags);
3012     tty-&gt;cr();
3013     // No need to check this sig any longer
3014     sigaddset(&amp;check_signal_done, sig);
3015   }
3016 
3017   // Dump all the signal
3018   if (sigismember(&amp;check_signal_done, sig)) {
3019     print_signal_handlers(tty, buf, O_BUFLEN);
3020   }
3021 }
3022 
3023 extern void report_error(char* file_name, int line_no, char* title,
3024                          char* format, ...);
3025 
3026 // this is called _before_ the most of global arguments have been parsed
3027 void os::init(void) {
3028   char dummy;   // used to get a guess on initial stack address
3029 
3030   clock_tics_per_sec = CLK_TCK;
3031 
3032   init_random(1234567);
3033 
3034   Bsd::set_page_size(getpagesize());
3035   if (Bsd::page_size() == -1) {
3036     fatal(&quot;os_bsd.cpp: os::init: sysconf failed (%s)&quot;, os::strerror(errno));
3037   }
3038   init_page_sizes((size_t) Bsd::page_size());
3039 
3040   Bsd::initialize_system_info();
3041 
3042   // _main_thread points to the thread that created/loaded the JVM.
3043   Bsd::_main_thread = pthread_self();
3044 
3045   Bsd::clock_init();
3046   initial_time_count = javaTimeNanos();
3047 
3048   os::Posix::init();
3049 }
3050 
3051 // To install functions for atexit system call
3052 extern &quot;C&quot; {
3053   static void perfMemory_exit_helper() {
3054     perfMemory_exit();
3055   }
3056 }
3057 
3058 // this is called _after_ the global arguments have been parsed
3059 jint os::init_2(void) {
3060 
3061   // This could be set after os::Posix::init() but all platforms
3062   // have to set it the same so we have to mirror Solaris.
3063   DEBUG_ONLY(os::set_mutex_init_done();)
3064 
3065   os::Posix::init_2();
3066 
3067   // initialize suspend/resume support - must do this before signal_sets_init()
3068   if (SR_initialize() != 0) {
3069     perror(&quot;SR_initialize failed&quot;);
3070     return JNI_ERR;
3071   }
3072 
3073   Bsd::signal_sets_init();
3074   Bsd::install_signal_handlers();
3075   // Initialize data for jdk.internal.misc.Signal
3076   if (!ReduceSignalUsage) {
3077     jdk_misc_signal_init();
3078   }
3079 
3080   // Check and sets minimum stack sizes against command line options
3081   if (Posix::set_minimum_stack_sizes() == JNI_ERR) {
3082     return JNI_ERR;
3083   }
3084 
3085   // Not supported.
3086   FLAG_SET_ERGO(UseNUMA, false);
3087   FLAG_SET_ERGO(UseNUMAInterleaving, false);
3088 
3089   if (MaxFDLimit) {
3090     // set the number of file descriptors to max. print out error
3091     // if getrlimit/setrlimit fails but continue regardless.
3092     struct rlimit nbr_files;
3093     int status = getrlimit(RLIMIT_NOFILE, &amp;nbr_files);
3094     if (status != 0) {
3095       log_info(os)(&quot;os::init_2 getrlimit failed: %s&quot;, os::strerror(errno));
3096     } else {
3097       nbr_files.rlim_cur = nbr_files.rlim_max;
3098 
3099 #ifdef __APPLE__
3100       // Darwin returns RLIM_INFINITY for rlim_max, but fails with EINVAL if
3101       // you attempt to use RLIM_INFINITY. As per setrlimit(2), OPEN_MAX must
3102       // be used instead
3103       nbr_files.rlim_cur = MIN(OPEN_MAX, nbr_files.rlim_cur);
3104 #endif
3105 
3106       status = setrlimit(RLIMIT_NOFILE, &amp;nbr_files);
3107       if (status != 0) {
3108         log_info(os)(&quot;os::init_2 setrlimit failed: %s&quot;, os::strerror(errno));
3109       }
3110     }
3111   }
3112 
3113   // at-exit methods are called in the reverse order of their registration.
3114   // atexit functions are called on return from main or as a result of a
3115   // call to exit(3C). There can be only 32 of these functions registered
3116   // and atexit() does not set errno.
3117 
3118   if (PerfAllowAtExitRegistration) {
3119     // only register atexit functions if PerfAllowAtExitRegistration is set.
3120     // atexit functions can be delayed until process exit time, which
3121     // can be problematic for embedded VM situations. Embedded VMs should
3122     // call DestroyJavaVM() to assure that VM resources are released.
3123 
3124     // note: perfMemory_exit_helper atexit function may be removed in
3125     // the future if the appropriate cleanup code can be added to the
3126     // VM_Exit VMOperation&#39;s doit method.
3127     if (atexit(perfMemory_exit_helper) != 0) {
3128       warning(&quot;os::init_2 atexit(perfMemory_exit_helper) failed&quot;);
3129     }
3130   }
3131 
3132   // initialize thread priority policy
3133   prio_init();
3134 
3135 #ifdef __APPLE__
3136   // dynamically link to objective c gc registration
3137   void *handleLibObjc = dlopen(OBJC_LIB, RTLD_LAZY);
3138   if (handleLibObjc != NULL) {
3139     objc_registerThreadWithCollectorFunction = (objc_registerThreadWithCollector_t) dlsym(handleLibObjc, OBJC_GCREGISTER);
3140   }
3141 #endif
3142 
3143   return JNI_OK;
3144 }
3145 
3146 int os::active_processor_count() {
3147   // User has overridden the number of active processors
3148   if (ActiveProcessorCount &gt; 0) {
3149     log_trace(os)(&quot;active_processor_count: &quot;
3150                   &quot;active processor count set by user : %d&quot;,
3151                   ActiveProcessorCount);
3152     return ActiveProcessorCount;
3153   }
3154 
3155   return _processor_count;
3156 }
3157 
3158 #ifdef __APPLE__
3159 uint os::processor_id() {
3160   // Get the initial APIC id and return the associated processor id. The initial APIC
3161   // id is limited to 8-bits, which means we can have at most 256 unique APIC ids. If
3162   // the system has more processors (or the initial APIC ids are discontiguous) the
3163   // APIC id will be truncated and more than one processor will potentially share the
3164   // same processor id. This is not optimal, but unlikely to happen in practice. Should
3165   // this become a real problem we could switch to using x2APIC ids, which are 32-bit
3166   // wide. However, note that x2APIC is Intel-specific, and the wider number space
3167   // would require a more complicated mapping approach.
3168   uint eax = 0x1;
3169   uint ebx;
3170   uint ecx = 0;
3171   uint edx;
3172 
3173   __asm__ (&quot;cpuid\n\t&quot; : &quot;+a&quot; (eax), &quot;+b&quot; (ebx), &quot;+c&quot; (ecx), &quot;+d&quot; (edx) : );
3174 
3175   uint apic_id = (ebx &gt;&gt; 24) &amp; (processor_id_map_size - 1);
3176   int processor_id = Atomic::load(&amp;processor_id_map[apic_id]);
3177 
3178   while (processor_id &lt; 0) {
3179     // Assign processor id to APIC id
3180     processor_id = Atomic::cmpxchg(&amp;processor_id_map[apic_id], processor_id_unassigned, processor_id_assigning);
3181     if (processor_id == processor_id_unassigned) {
3182       processor_id = Atomic::fetch_and_add(&amp;processor_id_next, 1) % os::processor_count();
3183       Atomic::store(&amp;processor_id_map[apic_id], processor_id);
3184     }
3185   }
3186 
3187   assert(processor_id &gt;= 0 &amp;&amp; processor_id &lt; os::processor_count(), &quot;invalid processor id&quot;);
3188 
3189   return (uint)processor_id;
3190 }
3191 #endif
3192 
3193 void os::set_native_thread_name(const char *name) {
3194 #if defined(__APPLE__) &amp;&amp; MAC_OS_X_VERSION_MIN_REQUIRED &gt; MAC_OS_X_VERSION_10_5
3195   // This is only supported in Snow Leopard and beyond
3196   if (name != NULL) {
3197     // Add a &quot;Java: &quot; prefix to the name
3198     char buf[MAXTHREADNAMESIZE];
3199     snprintf(buf, sizeof(buf), &quot;Java: %s&quot;, name);
3200     pthread_setname_np(buf);
3201   }
3202 #endif
3203 }
3204 
3205 bool os::bind_to_processor(uint processor_id) {
3206   // Not yet implemented.
3207   return false;
3208 }
3209 
3210 void os::SuspendedThreadTask::internal_do_task() {
3211   if (do_suspend(_thread-&gt;osthread())) {
3212     SuspendedThreadTaskContext context(_thread, _thread-&gt;osthread()-&gt;ucontext());
3213     do_task(context);
3214     do_resume(_thread-&gt;osthread());
3215   }
3216 }
3217 
3218 ////////////////////////////////////////////////////////////////////////////////
3219 // debug support
3220 
3221 bool os::find(address addr, outputStream* st) {
3222   Dl_info dlinfo;
3223   memset(&amp;dlinfo, 0, sizeof(dlinfo));
3224   if (dladdr(addr, &amp;dlinfo) != 0) {
3225     st-&gt;print(INTPTR_FORMAT &quot;: &quot;, (intptr_t)addr);
3226     if (dlinfo.dli_sname != NULL &amp;&amp; dlinfo.dli_saddr != NULL) {
3227       st-&gt;print(&quot;%s+%#x&quot;, dlinfo.dli_sname,
3228                 (uint)((uintptr_t)addr - (uintptr_t)dlinfo.dli_saddr));
3229     } else if (dlinfo.dli_fbase != NULL) {
3230       st-&gt;print(&quot;&lt;offset %#x&gt;&quot;, (uint)((uintptr_t)addr - (uintptr_t)dlinfo.dli_fbase));
3231     } else {
3232       st-&gt;print(&quot;&lt;absolute address&gt;&quot;);
3233     }
3234     if (dlinfo.dli_fname != NULL) {
3235       st-&gt;print(&quot; in %s&quot;, dlinfo.dli_fname);
3236     }
3237     if (dlinfo.dli_fbase != NULL) {
3238       st-&gt;print(&quot; at &quot; INTPTR_FORMAT, (intptr_t)dlinfo.dli_fbase);
3239     }
3240     st-&gt;cr();
3241 
3242     if (Verbose) {
3243       // decode some bytes around the PC
3244       address begin = clamp_address_in_page(addr-40, addr, os::vm_page_size());
3245       address end   = clamp_address_in_page(addr+40, addr, os::vm_page_size());
3246       address       lowest = (address) dlinfo.dli_sname;
3247       if (!lowest)  lowest = (address) dlinfo.dli_fbase;
3248       if (begin &lt; lowest)  begin = lowest;
3249       Dl_info dlinfo2;
3250       if (dladdr(end, &amp;dlinfo2) != 0 &amp;&amp; dlinfo2.dli_saddr != dlinfo.dli_saddr
3251           &amp;&amp; end &gt; dlinfo2.dli_saddr &amp;&amp; dlinfo2.dli_saddr &gt; begin) {
3252         end = (address) dlinfo2.dli_saddr;
3253       }
3254       Disassembler::decode(begin, end, st);
3255     }
3256     return true;
3257   }
3258   return false;
3259 }
3260 
3261 ////////////////////////////////////////////////////////////////////////////////
3262 // misc
3263 
3264 // This does not do anything on Bsd. This is basically a hook for being
3265 // able to use structured exception handling (thread-local exception filters)
3266 // on, e.g., Win32.
3267 void os::os_exception_wrapper(java_call_t f, JavaValue* value,
3268                               const methodHandle&amp; method, JavaCallArguments* args,
3269                               Thread* thread) {
3270   f(value, method, args, thread);
3271 }
3272 
3273 void os::print_statistics() {
3274 }
3275 
3276 bool os::message_box(const char* title, const char* message) {
3277   int i;
3278   fdStream err(defaultStream::error_fd());
3279   for (i = 0; i &lt; 78; i++) err.print_raw(&quot;=&quot;);
3280   err.cr();
3281   err.print_raw_cr(title);
3282   for (i = 0; i &lt; 78; i++) err.print_raw(&quot;-&quot;);
3283   err.cr();
3284   err.print_raw_cr(message);
3285   for (i = 0; i &lt; 78; i++) err.print_raw(&quot;=&quot;);
3286   err.cr();
3287 
3288   char buf[16];
3289   // Prevent process from exiting upon &quot;read error&quot; without consuming all CPU
3290   while (::read(0, buf, sizeof(buf)) &lt;= 0) { ::sleep(100); }
3291 
3292   return buf[0] == &#39;y&#39; || buf[0] == &#39;Y&#39;;
3293 }
3294 
3295 static inline struct timespec get_mtime(const char* filename) {
3296   struct stat st;
3297   int ret = os::stat(filename, &amp;st);
3298   assert(ret == 0, &quot;failed to stat() file &#39;%s&#39;: %s&quot;, filename, os::strerror(errno));
3299 #ifdef __APPLE__
3300   return st.st_mtimespec;
3301 #else
3302   return st.st_mtim;
3303 #endif
3304 }
3305 
3306 int os::compare_file_modified_times(const char* file1, const char* file2) {
3307   struct timespec filetime1 = get_mtime(file1);
3308   struct timespec filetime2 = get_mtime(file2);
3309   int diff = filetime1.tv_sec - filetime2.tv_sec;
3310   if (diff == 0) {
3311     return filetime1.tv_nsec - filetime2.tv_nsec;
3312   }
3313   return diff;
3314 }
3315 
3316 // Is a (classpath) directory empty?
3317 bool os::dir_is_empty(const char* path) {
3318   DIR *dir = NULL;
3319   struct dirent *ptr;
3320 
3321   dir = opendir(path);
3322   if (dir == NULL) return true;
3323 
3324   // Scan the directory
3325   bool result = true;
3326   while (result &amp;&amp; (ptr = readdir(dir)) != NULL) {
3327     if (strcmp(ptr-&gt;d_name, &quot;.&quot;) != 0 &amp;&amp; strcmp(ptr-&gt;d_name, &quot;..&quot;) != 0) {
3328       result = false;
3329     }
3330   }
3331   closedir(dir);
3332   return result;
3333 }
3334 
3335 // This code originates from JDK&#39;s sysOpen and open64_w
3336 // from src/solaris/hpi/src/system_md.c
3337 
3338 int os::open(const char *path, int oflag, int mode) {
3339   if (strlen(path) &gt; MAX_PATH - 1) {
3340     errno = ENAMETOOLONG;
3341     return -1;
3342   }
3343   int fd;
3344 
3345   fd = ::open(path, oflag, mode);
3346   if (fd == -1) return -1;
3347 
3348   // If the open succeeded, the file might still be a directory
3349   {
3350     struct stat buf;
3351     int ret = ::fstat(fd, &amp;buf);
3352     int st_mode = buf.st_mode;
3353 
3354     if (ret != -1) {
3355       if ((st_mode &amp; S_IFMT) == S_IFDIR) {
3356         errno = EISDIR;
3357         ::close(fd);
3358         return -1;
3359       }
3360     } else {
3361       ::close(fd);
3362       return -1;
3363     }
3364   }
3365 
3366   // All file descriptors that are opened in the JVM and not
3367   // specifically destined for a subprocess should have the
3368   // close-on-exec flag set.  If we don&#39;t set it, then careless 3rd
3369   // party native code might fork and exec without closing all
3370   // appropriate file descriptors (e.g. as we do in closeDescriptors in
3371   // UNIXProcess.c), and this in turn might:
3372   //
3373   // - cause end-of-file to fail to be detected on some file
3374   //   descriptors, resulting in mysterious hangs, or
3375   //
3376   // - might cause an fopen in the subprocess to fail on a system
3377   //   suffering from bug 1085341.
3378   //
3379   // (Yes, the default setting of the close-on-exec flag is a Unix
3380   // design flaw)
3381   //
3382   // See:
3383   // 1085341: 32-bit stdio routines should support file descriptors &gt;255
3384   // 4843136: (process) pipe file descriptor from Runtime.exec not being closed
3385   // 6339493: (process) Runtime.exec does not close all file descriptors on Solaris 9
3386   //
3387 #ifdef FD_CLOEXEC
3388   {
3389     int flags = ::fcntl(fd, F_GETFD);
3390     if (flags != -1) {
3391       ::fcntl(fd, F_SETFD, flags | FD_CLOEXEC);
3392     }
3393   }
3394 #endif
3395 
3396   return fd;
3397 }
3398 
3399 
3400 // create binary file, rewriting existing file if required
3401 int os::create_binary_file(const char* path, bool rewrite_existing) {
3402   int oflags = O_WRONLY | O_CREAT;
3403   if (!rewrite_existing) {
3404     oflags |= O_EXCL;
3405   }
3406   return ::open(path, oflags, S_IREAD | S_IWRITE);
3407 }
3408 
3409 // return current position of file pointer
3410 jlong os::current_file_offset(int fd) {
3411   return (jlong)::lseek(fd, (off_t)0, SEEK_CUR);
3412 }
3413 
3414 // move file pointer to the specified offset
3415 jlong os::seek_to_file_offset(int fd, jlong offset) {
3416   return (jlong)::lseek(fd, (off_t)offset, SEEK_SET);
3417 }
3418 
3419 // This code originates from JDK&#39;s sysAvailable
3420 // from src/solaris/hpi/src/native_threads/src/sys_api_td.c
3421 
3422 int os::available(int fd, jlong *bytes) {
3423   jlong cur, end;
3424   int mode;
3425   struct stat buf;
3426 
3427   if (::fstat(fd, &amp;buf) &gt;= 0) {
3428     mode = buf.st_mode;
3429     if (S_ISCHR(mode) || S_ISFIFO(mode) || S_ISSOCK(mode)) {
3430       int n;
3431       if (::ioctl(fd, FIONREAD, &amp;n) &gt;= 0) {
3432         *bytes = n;
3433         return 1;
3434       }
3435     }
3436   }
3437   if ((cur = ::lseek(fd, 0L, SEEK_CUR)) == -1) {
3438     return 0;
3439   } else if ((end = ::lseek(fd, 0L, SEEK_END)) == -1) {
3440     return 0;
3441   } else if (::lseek(fd, cur, SEEK_SET) == -1) {
3442     return 0;
3443   }
3444   *bytes = end - cur;
3445   return 1;
3446 }
3447 
3448 // Map a block of memory.
3449 char* os::pd_map_memory(int fd, const char* file_name, size_t file_offset,
3450                         char *addr, size_t bytes, bool read_only,
3451                         bool allow_exec) {
3452   int prot;
3453   int flags;
3454 
3455   if (read_only) {
3456     prot = PROT_READ;
3457     flags = MAP_SHARED;
3458   } else {
3459     prot = PROT_READ | PROT_WRITE;
3460     flags = MAP_PRIVATE;
3461   }
3462 
3463   if (allow_exec) {
3464     prot |= PROT_EXEC;
3465   }
3466 
3467   if (addr != NULL) {
3468     flags |= MAP_FIXED;
3469   }
3470 
3471   char* mapped_address = (char*)mmap(addr, (size_t)bytes, prot, flags,
3472                                      fd, file_offset);
3473   if (mapped_address == MAP_FAILED) {
3474     return NULL;
3475   }
3476   return mapped_address;
3477 }
3478 
3479 
3480 // Remap a block of memory.
3481 char* os::pd_remap_memory(int fd, const char* file_name, size_t file_offset,
3482                           char *addr, size_t bytes, bool read_only,
3483                           bool allow_exec) {
3484   // same as map_memory() on this OS
3485   return os::map_memory(fd, file_name, file_offset, addr, bytes, read_only,
3486                         allow_exec);
3487 }
3488 
3489 
3490 // Unmap a block of memory.
3491 bool os::pd_unmap_memory(char* addr, size_t bytes) {
3492   return munmap(addr, bytes) == 0;
3493 }
3494 
3495 // current_thread_cpu_time(bool) and thread_cpu_time(Thread*, bool)
3496 // are used by JVM M&amp;M and JVMTI to get user+sys or user CPU time
3497 // of a thread.
3498 //
3499 // current_thread_cpu_time() and thread_cpu_time(Thread*) returns
3500 // the fast estimate available on the platform.
3501 
3502 jlong os::current_thread_cpu_time() {
3503 #ifdef __APPLE__
3504   return os::thread_cpu_time(Thread::current(), true /* user + sys */);
3505 #else
3506   Unimplemented();
3507   return 0;
3508 #endif
3509 }
3510 
3511 jlong os::thread_cpu_time(Thread* thread) {
3512 #ifdef __APPLE__
3513   return os::thread_cpu_time(thread, true /* user + sys */);
3514 #else
3515   Unimplemented();
3516   return 0;
3517 #endif
3518 }
3519 
3520 jlong os::current_thread_cpu_time(bool user_sys_cpu_time) {
3521 #ifdef __APPLE__
3522   return os::thread_cpu_time(Thread::current(), user_sys_cpu_time);
3523 #else
3524   Unimplemented();
3525   return 0;
3526 #endif
3527 }
3528 
3529 jlong os::thread_cpu_time(Thread *thread, bool user_sys_cpu_time) {
3530 #ifdef __APPLE__
3531   struct thread_basic_info tinfo;
3532   mach_msg_type_number_t tcount = THREAD_INFO_MAX;
3533   kern_return_t kr;
3534   thread_t mach_thread;
3535 
3536   mach_thread = thread-&gt;osthread()-&gt;thread_id();
3537   kr = thread_info(mach_thread, THREAD_BASIC_INFO, (thread_info_t)&amp;tinfo, &amp;tcount);
3538   if (kr != KERN_SUCCESS) {
3539     return -1;
3540   }
3541 
3542   if (user_sys_cpu_time) {
3543     jlong nanos;
3544     nanos = ((jlong) tinfo.system_time.seconds + tinfo.user_time.seconds) * (jlong)1000000000;
3545     nanos += ((jlong) tinfo.system_time.microseconds + (jlong) tinfo.user_time.microseconds) * (jlong)1000;
3546     return nanos;
3547   } else {
3548     return ((jlong)tinfo.user_time.seconds * 1000000000) + ((jlong)tinfo.user_time.microseconds * (jlong)1000);
3549   }
3550 #else
3551   Unimplemented();
3552   return 0;
3553 #endif
3554 }
3555 
3556 
3557 void os::current_thread_cpu_time_info(jvmtiTimerInfo *info_ptr) {
3558   info_ptr-&gt;max_value = ALL_64_BITS;       // will not wrap in less than 64 bits
3559   info_ptr-&gt;may_skip_backward = false;     // elapsed time not wall time
3560   info_ptr-&gt;may_skip_forward = false;      // elapsed time not wall time
3561   info_ptr-&gt;kind = JVMTI_TIMER_TOTAL_CPU;  // user+system time is returned
3562 }
3563 
3564 void os::thread_cpu_time_info(jvmtiTimerInfo *info_ptr) {
3565   info_ptr-&gt;max_value = ALL_64_BITS;       // will not wrap in less than 64 bits
3566   info_ptr-&gt;may_skip_backward = false;     // elapsed time not wall time
3567   info_ptr-&gt;may_skip_forward = false;      // elapsed time not wall time
3568   info_ptr-&gt;kind = JVMTI_TIMER_TOTAL_CPU;  // user+system time is returned
3569 }
3570 
3571 bool os::is_thread_cpu_time_supported() {
3572 #ifdef __APPLE__
3573   return true;
3574 #else
3575   return false;
3576 #endif
3577 }
3578 
3579 // System loadavg support.  Returns -1 if load average cannot be obtained.
3580 // Bsd doesn&#39;t yet have a (official) notion of processor sets,
3581 // so just return the system wide load average.
3582 int os::loadavg(double loadavg[], int nelem) {
3583   return ::getloadavg(loadavg, nelem);
3584 }
3585 
3586 void os::pause() {
3587   char filename[MAX_PATH];
3588   if (PauseAtStartupFile &amp;&amp; PauseAtStartupFile[0]) {
3589     jio_snprintf(filename, MAX_PATH, &quot;%s&quot;, PauseAtStartupFile);
3590   } else {
3591     jio_snprintf(filename, MAX_PATH, &quot;./vm.paused.%d&quot;, current_process_id());
3592   }
3593 
3594   int fd = ::open(filename, O_WRONLY | O_CREAT | O_TRUNC, 0666);
3595   if (fd != -1) {
3596     struct stat buf;
3597     ::close(fd);
3598     while (::stat(filename, &amp;buf) == 0) {
3599       (void)::poll(NULL, 0, 100);
3600     }
3601   } else {
3602     jio_fprintf(stderr,
3603                 &quot;Could not open pause file &#39;%s&#39;, continuing immediately.\n&quot;, filename);
3604   }
3605 }
3606 
3607 // Darwin has no &quot;environ&quot; in a dynamic library.
3608 #ifdef __APPLE__
3609   #include &lt;crt_externs.h&gt;
3610   #define environ (*_NSGetEnviron())
3611 #else
3612 extern char** environ;
3613 #endif
3614 
3615 // Run the specified command in a separate process. Return its exit value,
3616 // or -1 on failure (e.g. can&#39;t fork a new process).
3617 // Unlike system(), this function can be called from signal handler. It
3618 // doesn&#39;t block SIGINT et al.
3619 int os::fork_and_exec(char* cmd, bool use_vfork_if_available) {
3620   const char * argv[4] = {&quot;sh&quot;, &quot;-c&quot;, cmd, NULL};
3621 
3622   // fork() in BsdThreads/NPTL is not async-safe. It needs to run
3623   // pthread_atfork handlers and reset pthread library. All we need is a
3624   // separate process to execve. Make a direct syscall to fork process.
3625   // On IA64 there&#39;s no fork syscall, we have to use fork() and hope for
3626   // the best...
3627   pid_t pid = fork();
3628 
3629   if (pid &lt; 0) {
3630     // fork failed
3631     return -1;
3632 
3633   } else if (pid == 0) {
3634     // child process
3635 
3636     // execve() in BsdThreads will call pthread_kill_other_threads_np()
3637     // first to kill every thread on the thread list. Because this list is
3638     // not reset by fork() (see notes above), execve() will instead kill
3639     // every thread in the parent process. We know this is the only thread
3640     // in the new process, so make a system call directly.
3641     // IA64 should use normal execve() from glibc to match the glibc fork()
3642     // above.
3643     execve(&quot;/bin/sh&quot;, (char* const*)argv, environ);
3644 
3645     // execve failed
3646     _exit(-1);
3647 
3648   } else  {
3649     // copied from J2SE ..._waitForProcessExit() in UNIXProcess_md.c; we don&#39;t
3650     // care about the actual exit code, for now.
3651 
3652     int status;
3653 
3654     // Wait for the child process to exit.  This returns immediately if
3655     // the child has already exited. */
3656     while (waitpid(pid, &amp;status, 0) &lt; 0) {
3657       switch (errno) {
3658       case ECHILD: return 0;
3659       case EINTR: break;
3660       default: return -1;
3661       }
3662     }
3663 
3664     if (WIFEXITED(status)) {
3665       // The child exited normally; get its exit code.
3666       return WEXITSTATUS(status);
3667     } else if (WIFSIGNALED(status)) {
3668       // The child exited because of a signal
3669       // The best value to return is 0x80 + signal number,
3670       // because that is what all Unix shells do, and because
3671       // it allows callers to distinguish between process exit and
3672       // process death by signal.
3673       return 0x80 + WTERMSIG(status);
3674     } else {
3675       // Unknown exit code; pass it through
3676       return status;
3677     }
3678   }
3679 }
3680 
3681 // Get the kern.corefile setting, or otherwise the default path to the core file
3682 // Returns the length of the string
3683 int os::get_core_path(char* buffer, size_t bufferSize) {
3684   int n = 0;
3685 #ifdef __APPLE__
3686   char coreinfo[MAX_PATH];
3687   size_t sz = sizeof(coreinfo);
3688   int ret = sysctlbyname(&quot;kern.corefile&quot;, coreinfo, &amp;sz, NULL, 0);
3689   if (ret == 0) {
3690     char *pid_pos = strstr(coreinfo, &quot;%P&quot;);
3691     // skip over the &quot;%P&quot; to preserve any optional custom user pattern
3692     const char* tail = (pid_pos != NULL) ? (pid_pos + 2) : &quot;&quot;;
3693 
3694     if (pid_pos != NULL) {
3695       *pid_pos = &#39;\0&#39;;
3696       n = jio_snprintf(buffer, bufferSize, &quot;%s%d%s&quot;, coreinfo, os::current_process_id(), tail);
3697     } else {
3698       n = jio_snprintf(buffer, bufferSize, &quot;%s&quot;, coreinfo);
3699     }
3700   } else
3701 #endif
3702   {
3703     n = jio_snprintf(buffer, bufferSize, &quot;/cores/core.%d&quot;, os::current_process_id());
3704   }
3705   // Truncate if theoretical string was longer than bufferSize
3706   n = MIN2(n, (int)bufferSize);
3707 
3708   return n;
3709 }
3710 
3711 bool os::supports_map_sync() {
3712   return false;
3713 }
3714 
3715 #ifndef PRODUCT
3716 void TestReserveMemorySpecial_test() {
3717   // No tests available for this platform
3718 }
3719 #endif
3720 
3721 bool os::start_debugging(char *buf, int buflen) {
3722   int len = (int)strlen(buf);
3723   char *p = &amp;buf[len];
3724 
3725   jio_snprintf(p, buflen-len,
3726              &quot;\n\n&quot;
3727              &quot;Do you want to debug the problem?\n\n&quot;
3728              &quot;To debug, run &#39;gdb /proc/%d/exe %d&#39;; then switch to thread &quot; INTX_FORMAT &quot; (&quot; INTPTR_FORMAT &quot;)\n&quot;
3729              &quot;Enter &#39;yes&#39; to launch gdb automatically (PATH must include gdb)\n&quot;
3730              &quot;Otherwise, press RETURN to abort...&quot;,
3731              os::current_process_id(), os::current_process_id(),
3732              os::current_thread_id(), os::current_thread_id());
3733 
3734   bool yes = os::message_box(&quot;Unexpected Error&quot;, buf);
3735 
3736   if (yes) {
3737     // yes, user asked VM to launch debugger
3738     jio_snprintf(buf, sizeof(buf), &quot;gdb /proc/%d/exe %d&quot;,
3739                      os::current_process_id(), os::current_process_id());
3740 
3741     os::fork_and_exec(buf);
3742     yes = false;
3743   }
3744   return yes;
3745 }
    </pre>
  </body>
</html>