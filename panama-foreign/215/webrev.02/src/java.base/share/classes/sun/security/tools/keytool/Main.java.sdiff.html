<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/java.base/share/classes/sun/security/tools/keytool/Main.java</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="../KeyStoreUtil.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="Resources.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/java.base/share/classes/sun/security/tools/keytool/Main.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 243             ALIAS, KEYPASS, KEYALG, KEYSIZE, KEYSTORE,
 244             STOREPASS, STORETYPE, PROVIDERNAME, ADDPROVIDER,
 245             PROVIDERCLASS, PROVIDERPATH, V, PROTECTED),
 246         IMPORTKEYSTORE(&quot;Imports.one.or.all.entries.from.another.keystore&quot;,
 247             SRCKEYSTORE, DESTKEYSTORE, SRCSTORETYPE,
 248             DESTSTORETYPE, SRCSTOREPASS, DESTSTOREPASS,
 249             SRCPROTECTED, DESTPROTECTED, SRCPROVIDERNAME, DESTPROVIDERNAME,
 250             SRCALIAS, DESTALIAS, SRCKEYPASS, DESTKEYPASS,
 251             NOPROMPT, ADDPROVIDER, PROVIDERCLASS, PROVIDERPATH,
 252             V),
 253         KEYPASSWD(&quot;Changes.the.key.password.of.an.entry&quot;,
 254             ALIAS, KEYPASS, NEW, KEYSTORE, STOREPASS,
 255             STORETYPE, PROVIDERNAME, ADDPROVIDER, PROVIDERCLASS,
 256             PROVIDERPATH, V),
 257         LIST(&quot;Lists.entries.in.a.keystore&quot;,
 258             RFC, ALIAS, KEYSTORE, CACERTS, STOREPASS, STORETYPE,
 259             PROVIDERNAME, ADDPROVIDER, PROVIDERCLASS,
 260             PROVIDERPATH, V, PROTECTED),
 261         PRINTCERT(&quot;Prints.the.content.of.a.certificate&quot;,
 262             RFC, FILEIN, SSLSERVER, JARFILE,

 263             PROVIDERNAME, ADDPROVIDER, PROVIDERCLASS,
<span class="line-modified"> 264             PROVIDERPATH, V),</span>
 265         PRINTCERTREQ(&quot;Prints.the.content.of.a.certificate.request&quot;,
 266             FILEIN, V),
 267         PRINTCRL(&quot;Prints.the.content.of.a.CRL.file&quot;,
<span class="line-modified"> 268             FILEIN, V),</span>


 269         STOREPASSWD(&quot;Changes.the.store.password.of.a.keystore&quot;,
 270             NEW, KEYSTORE, CACERTS, STOREPASS, STORETYPE, PROVIDERNAME,
 271             ADDPROVIDER, PROVIDERCLASS, PROVIDERPATH, V),
 272         SHOWINFO(&quot;showinfo.command.help&quot;,
 273             TLS, V),
 274 
 275         // Undocumented start here, KEYCLONE is used a marker in -help;
 276 
 277         KEYCLONE(&quot;Clones.a.key.entry&quot;,
 278             ALIAS, DESTALIAS, KEYPASS, NEW, STORETYPE,
 279             KEYSTORE, STOREPASS, PROVIDERNAME, ADDPROVIDER,
 280             PROVIDERCLASS, PROVIDERPATH, V),
 281         SELFCERT(&quot;Generates.a.self.signed.certificate&quot;,
 282             ALIAS, SIGALG, DNAME, STARTDATE, EXT, VALIDITY, KEYPASS,
 283             STORETYPE, KEYSTORE, STOREPASS, PROVIDERNAME,
 284             ADDPROVIDER, PROVIDERCLASS, PROVIDERPATH, V),
 285         GENCRL(&quot;Generates.CRL&quot;,
 286             RFC, FILEOUT, ID,
 287             ALIAS, SIGALG, KEYPASS, KEYSTORE,
 288             STOREPASS, STORETYPE, PROVIDERNAME, ADDPROVIDER,
</pre>
<hr />
<pre>
 702             System.err.println(rb.getString(&quot;Illegal.option.&quot;) + args[i]);
 703             tinyHelp();
 704         }
 705 
 706         if (command == null) {
 707             if (help) {
 708                 usage();
 709             } else {
 710                 System.err.println(rb.getString(&quot;Usage.error.no.command.provided&quot;));
 711                 tinyHelp();
 712             }
 713         } else if (help) {
 714             usage();
 715             command = null;
 716         }
 717 
 718         return args;
 719     }
 720 
 721     boolean isKeyStoreRelated(Command cmd) {
<span class="line-modified"> 722         return cmd != PRINTCERT &amp;&amp; cmd != PRINTCERTREQ &amp;&amp; cmd != SHOWINFO;</span>
 723     }
 724 
 725     /**
 726      * Execute the commands.
 727      */
 728     void doCommands(PrintStream out) throws Exception {
 729 
 730         if (cacerts) {
 731             if (ksfname != null || storetype != null) {
 732                 throw new IllegalArgumentException(rb.getString
 733                         (&quot;the.keystore.or.storetype.option.cannot.be.used.with.the.cacerts.option&quot;));
 734             }
 735             ksfname = KeyStoreUtil.getCacerts();
 736         }
 737 
 738         if (P11KEYSTORE.equalsIgnoreCase(storetype) ||
 739                 KeyStoreUtil.isWindowsKeyStore(storetype)) {
 740             token = true;
 741             if (ksfname == null) {
 742                 ksfname = NONE;
</pre>
<hr />
<pre>
 887 
 888         // Check if keystore exists.
 889         // If no keystore has been specified at the command line, try to use
 890         // the default, which is located in $HOME/.keystore.
 891         // No need to check if isKeyStoreRelated(command) is false.
 892 
 893         // DO NOT open the existing keystore if this is an in-place import.
 894         // The keystore should be created as brand new.
 895         if (isKeyStoreRelated(command) &amp;&amp; !nullStream &amp;&amp; !inplaceImport) {
 896             try {
 897                 ksfile = new File(ksfname);
 898                 // Check if keystore file is empty
 899                 if (ksfile.exists() &amp;&amp; ksfile.length() == 0) {
 900                     throw new Exception(rb.getString
 901                             (&quot;Keystore.file.exists.but.is.empty.&quot;) + ksfname);
 902                 }
 903                 ksStream = new FileInputStream(ksfile);
 904             } catch (FileNotFoundException e) {
 905                 // These commands do not need the keystore to be existing.
 906                 // Either it will create a new one or the keystore is
<span class="line-modified"> 907                 // optional (i.e. PRINTCRL).</span>
 908                 if (command != GENKEYPAIR &amp;&amp;
 909                         command != GENSECKEY &amp;&amp;
 910                         command != IDENTITYDB &amp;&amp;
 911                         command != IMPORTCERT &amp;&amp;
 912                         command != IMPORTPASS &amp;&amp;
 913                         command != IMPORTKEYSTORE &amp;&amp;
<span class="line-modified"> 914                         command != PRINTCRL) {</span>

 915                     throw new Exception(rb.getString
 916                             (&quot;Keystore.file.does.not.exist.&quot;) + ksfname);
 917                 }
 918             }
 919         }
 920 
 921         if ((command == KEYCLONE || command == CHANGEALIAS)
 922                 &amp;&amp; dest == null) {
 923             dest = getAlias(&quot;destination&quot;);
 924             if (&quot;&quot;.equals(dest)) {
 925                 throw new Exception(rb.getString
 926                         (&quot;Must.specify.destination.alias&quot;));
 927             }
 928         }
 929 
 930         if (command == DELETE &amp;&amp; alias == null) {
 931             alias = getAlias(null);
 932             if (&quot;&quot;.equals(alias)) {
 933                 throw new Exception(rb.getString(&quot;Must.specify.alias&quot;));
 934             }
</pre>
<hr />
<pre>
1056                             char[] storePassAgain = Password.readPassword(System.in);
1057                             passwords.add(storePassAgain);
1058                             if (!Arrays.equals(storePass, storePassAgain)) {
1059                                 System.err.println
1060                                         (rb.getString(&quot;They.don.t.match.Try.again&quot;));
1061                                 storePass = null;
1062                             }
1063                         }
1064 
1065                         count++;
1066                     } while ((storePass == null) &amp;&amp; count &lt; 3);
1067 
1068 
1069                     if (storePass == null) {
1070                         System.err.println
1071                                 (rb.getString(&quot;Too.many.failures.try.later&quot;));
1072                         return;
1073                     }
1074                 } else {
1075                     // here we have EXPORTCERT and LIST (info valid until STOREPASSWD)
<span class="line-modified">1076                     if (command != PRINTCRL) {</span>
1077                         System.err.print(rb.getString(&quot;Enter.keystore.password.&quot;));
1078                         System.err.flush();
1079                         storePass = Password.readPassword(System.in);
1080                         passwords.add(storePass);
1081                     }
1082                 }
1083             }
1084 
1085             // Now load a nullStream-based keystore,
1086             // or verify the integrity of an input stream-based keystore
1087             if (nullStream) {
1088                 keyStore.load(null, storePass);
1089             } else if (ksStream != null) {
1090                 ksStream = new FileInputStream(ksfile);
1091                 keyStore.load(ksStream, storePass);
1092                 ksStream.close();
1093             }
1094         }
1095 
1096         if (storePass != null &amp;&amp; P12KEYSTORE.equalsIgnoreCase(storetype)) {
1097             MessageFormat form = new MessageFormat(rb.getString(
1098                 &quot;Warning.Different.store.and.key.passwords.not.supported.for.PKCS12.KeyStores.Ignoring.user.specified.command.value.&quot;));
1099             if (keyPass != null &amp;&amp; !Arrays.equals(storePass, keyPass)) {
1100                 Object[] source = {&quot;-keypass&quot;};
1101                 System.err.println(form.format(source));
1102                 keyPass = storePass;
1103             }
1104             if (destKeyPass != null &amp;&amp; !Arrays.equals(storePass, destKeyPass)) {
1105                 Object[] source = {&quot;-destkeypass&quot;};
1106                 System.err.println(form.format(source));
1107                 destKeyPass = storePass;
1108             }
1109         }
1110 
<span class="line-modified">1111         // -trustcacerts can only be specified on -importcert.</span>
<span class="line-modified">1112         // Reset it so that warnings on CA cert will remain for</span>
<span class="line-modified">1113         // -printcert, etc.</span>
<span class="line-modified">1114         if (command != IMPORTCERT) {</span>
1115             trustcacerts = false;
1116         }
1117 
1118         if (trustcacerts) {
1119             caks = KeyStoreUtil.getCacertsKeyStore();
1120         }
1121 
1122         // Perform the specified command
1123         if (command == CERTREQ) {
1124             if (filename != null) {
1125                 try (PrintStream ps = new PrintStream(new FileOutputStream
1126                                                       (filename))) {
1127                     doCertReq(alias, sigAlgName, ps);
1128                 }
1129             } else {
1130                 doCertReq(alias, sigAlgName, out);
1131             }
1132             if (verbose &amp;&amp; filename != null) {
1133                 MessageFormat form = new MessageFormat(rb.getString
1134                         (&quot;Certification.request.stored.in.file.filename.&quot;));
</pre>
<hr />
<pre>
2425                 new MessageFormat(rb.getString
2426                         (&quot;Your.keystore.contains.keyStore.size.entries&quot;));
2427         Object[] source = {keyStore.size()};
2428         out.println(form.format(source));
2429         out.println();
2430 
2431         List&lt;String&gt; aliases = Collections.list(keyStore.aliases());
2432         aliases.sort(String::compareTo);
2433         for (String alias : aliases) {
2434             doPrintEntry(&quot;&lt;&quot; + alias + &quot;&gt;&quot;, alias, out);
2435             if (verbose || rfc) {
2436                 out.println(rb.getString(&quot;NEWLINE&quot;));
2437                 out.println(rb.getString
2438                         (&quot;STAR&quot;));
2439                 out.println(rb.getString
2440                         (&quot;STARNN&quot;));
2441             }
2442         }
2443     }
2444 
<span class="line-removed">2445     private static &lt;T&gt; Iterable&lt;T&gt; e2i(final Enumeration&lt;T&gt; e) {</span>
<span class="line-removed">2446         return new Iterable&lt;T&gt;() {</span>
<span class="line-removed">2447             @Override</span>
<span class="line-removed">2448             public Iterator&lt;T&gt; iterator() {</span>
<span class="line-removed">2449                 return new Iterator&lt;T&gt;() {</span>
<span class="line-removed">2450                     @Override</span>
<span class="line-removed">2451                     public boolean hasNext() {</span>
<span class="line-removed">2452                         return e.hasMoreElements();</span>
<span class="line-removed">2453                     }</span>
<span class="line-removed">2454                     @Override</span>
<span class="line-removed">2455                     public T next() {</span>
<span class="line-removed">2456                         return e.nextElement();</span>
<span class="line-removed">2457                     }</span>
<span class="line-removed">2458                     public void remove() {</span>
<span class="line-removed">2459                         throw new UnsupportedOperationException(&quot;Not supported yet.&quot;);</span>
<span class="line-removed">2460                     }</span>
<span class="line-removed">2461                 };</span>
<span class="line-removed">2462             }</span>
<span class="line-removed">2463         };</span>
<span class="line-removed">2464     }</span>
<span class="line-removed">2465 </span>
2466     /**
2467      * Loads CRLs from a source. This method is also called in JarSigner.
2468      * @param src the source, which means System.in if null, or a URI,
2469      *        or a bare file path name
2470      */
2471     public static Collection&lt;? extends CRL&gt; loadCRLs(String src) throws Exception {
2472         InputStream in = null;
2473         URI uri = null;
2474         if (src == null) {
2475             in = System.in;
2476         } else {
2477             try {
2478                 uri = new URI(src);
2479                 if (uri.getScheme().equals(&quot;ldap&quot;)) {
2480                     // No input stream for LDAP
2481                 } else {
2482                     in = uri.toURL().openStream();
2483                 }
2484             } catch (Exception e) {
2485                 try {
</pre>
<hr />
<pre>
2539                 for (GeneralName name: names.names()) {
2540                     if (name.getType() == GeneralNameInterface.NAME_URI) {
2541                         URIName uriName = (URIName)name.getName();
2542                         for (CRL crl: loadCRLs(uriName.getName())) {
2543                             if (crl instanceof X509CRL) {
2544                                 crls.add((X509CRL)crl);
2545                             }
2546                         }
2547                         break;  // Different name should point to same CRL
2548                     }
2549                 }
2550             }
2551         }
2552         return crls;
2553     }
2554 
2555     private static String verifyCRL(KeyStore ks, CRL crl)
2556             throws Exception {
2557         X509CRLImpl xcrl = (X509CRLImpl)crl;
2558         X500Principal issuer = xcrl.getIssuerX500Principal();
<span class="line-modified">2559         for (String s: e2i(ks.aliases())) {</span>
2560             Certificate cert = ks.getCertificate(s);
2561             if (cert instanceof X509Certificate) {
2562                 X509Certificate xcert = (X509Certificate)cert;
2563                 if (xcert.getSubjectX500Principal().equals(issuer)) {
2564                     try {
2565                         ((X509CRLImpl)crl).verify(cert.getPublicKey());
2566                         return s;
2567                     } catch (Exception e) {
2568                     }
2569                 }
2570             }
2571         }
2572         return null;
2573     }
2574 
2575     private void doPrintCRL(String src, PrintStream out)
2576             throws Exception {
2577         for (CRL crl: loadCRLs(src)) {
2578             printCRL(crl, out);
2579             String issuer = null;
</pre>
<hr />
<pre>
2588                             &quot;cacerts&quot;,
2589                             withWeak(signer.getPublicKey()));
2590                     out.println();
2591                 }
2592             }
2593             if (issuer == null &amp;&amp; keyStore != null) {
2594                 issuer = verifyCRL(keyStore, crl);
2595                 if (issuer != null) {
2596                     signer = keyStore.getCertificate(issuer);
2597                     out.printf(rb.getString(
2598                             &quot;verified.by.s.in.s.weak&quot;),
2599                             issuer,
2600                             &quot;keystore&quot;,
2601                             withWeak(signer.getPublicKey()));
2602                     out.println();
2603                 }
2604             }
2605             if (issuer == null) {
2606                 out.println(rb.getString
2607                         (&quot;STAR&quot;));
<span class="line-modified">2608                 out.println(rb.getString</span>
<span class="line-modified">2609                         (&quot;warning.not.verified.make.sure.keystore.is.correct&quot;));</span>





2610                 out.println(rb.getString
2611                         (&quot;STARNN&quot;));
2612             }
2613             checkWeak(rb.getString(&quot;the.crl&quot;), crl, signer == null ? null : signer.getPublicKey());
2614         }
2615     }
2616 
2617     private void printCRL(CRL crl, PrintStream out)
2618             throws Exception {
2619         X509CRL xcrl = (X509CRL)crl;
2620         if (rfc) {
2621             out.println(&quot;-----BEGIN X509 CRL-----&quot;);
2622             out.println(Base64.getMimeEncoder(64, CRLF).encodeToString(xcrl.getEncoded()));
2623             out.println(&quot;-----END X509 CRL-----&quot;);
2624         } else {
2625             String s;
2626             if (crl instanceof X509CRLImpl) {
2627                 X509CRLImpl x509crl = (X509CRLImpl) crl;
2628                 s = x509crl.toStringWithAlgName(withWeak(&quot;&quot; + x509crl.getSigAlgId()));
2629             } else {
</pre>
</td>
<td>
<hr />
<pre>
 243             ALIAS, KEYPASS, KEYALG, KEYSIZE, KEYSTORE,
 244             STOREPASS, STORETYPE, PROVIDERNAME, ADDPROVIDER,
 245             PROVIDERCLASS, PROVIDERPATH, V, PROTECTED),
 246         IMPORTKEYSTORE(&quot;Imports.one.or.all.entries.from.another.keystore&quot;,
 247             SRCKEYSTORE, DESTKEYSTORE, SRCSTORETYPE,
 248             DESTSTORETYPE, SRCSTOREPASS, DESTSTOREPASS,
 249             SRCPROTECTED, DESTPROTECTED, SRCPROVIDERNAME, DESTPROVIDERNAME,
 250             SRCALIAS, DESTALIAS, SRCKEYPASS, DESTKEYPASS,
 251             NOPROMPT, ADDPROVIDER, PROVIDERCLASS, PROVIDERPATH,
 252             V),
 253         KEYPASSWD(&quot;Changes.the.key.password.of.an.entry&quot;,
 254             ALIAS, KEYPASS, NEW, KEYSTORE, STOREPASS,
 255             STORETYPE, PROVIDERNAME, ADDPROVIDER, PROVIDERCLASS,
 256             PROVIDERPATH, V),
 257         LIST(&quot;Lists.entries.in.a.keystore&quot;,
 258             RFC, ALIAS, KEYSTORE, CACERTS, STOREPASS, STORETYPE,
 259             PROVIDERNAME, ADDPROVIDER, PROVIDERCLASS,
 260             PROVIDERPATH, V, PROTECTED),
 261         PRINTCERT(&quot;Prints.the.content.of.a.certificate&quot;,
 262             RFC, FILEIN, SSLSERVER, JARFILE,
<span class="line-added"> 263             KEYSTORE, STOREPASS, STORETYPE, TRUSTCACERTS,</span>
 264             PROVIDERNAME, ADDPROVIDER, PROVIDERCLASS,
<span class="line-modified"> 265             PROVIDERPATH, V, PROTECTED),</span>
 266         PRINTCERTREQ(&quot;Prints.the.content.of.a.certificate.request&quot;,
 267             FILEIN, V),
 268         PRINTCRL(&quot;Prints.the.content.of.a.CRL.file&quot;,
<span class="line-modified"> 269             FILEIN, KEYSTORE, STOREPASS, STORETYPE, TRUSTCACERTS,</span>
<span class="line-added"> 270             PROVIDERNAME, ADDPROVIDER, PROVIDERCLASS, PROVIDERPATH,</span>
<span class="line-added"> 271             V, PROTECTED),</span>
 272         STOREPASSWD(&quot;Changes.the.store.password.of.a.keystore&quot;,
 273             NEW, KEYSTORE, CACERTS, STOREPASS, STORETYPE, PROVIDERNAME,
 274             ADDPROVIDER, PROVIDERCLASS, PROVIDERPATH, V),
 275         SHOWINFO(&quot;showinfo.command.help&quot;,
 276             TLS, V),
 277 
 278         // Undocumented start here, KEYCLONE is used a marker in -help;
 279 
 280         KEYCLONE(&quot;Clones.a.key.entry&quot;,
 281             ALIAS, DESTALIAS, KEYPASS, NEW, STORETYPE,
 282             KEYSTORE, STOREPASS, PROVIDERNAME, ADDPROVIDER,
 283             PROVIDERCLASS, PROVIDERPATH, V),
 284         SELFCERT(&quot;Generates.a.self.signed.certificate&quot;,
 285             ALIAS, SIGALG, DNAME, STARTDATE, EXT, VALIDITY, KEYPASS,
 286             STORETYPE, KEYSTORE, STOREPASS, PROVIDERNAME,
 287             ADDPROVIDER, PROVIDERCLASS, PROVIDERPATH, V),
 288         GENCRL(&quot;Generates.CRL&quot;,
 289             RFC, FILEOUT, ID,
 290             ALIAS, SIGALG, KEYPASS, KEYSTORE,
 291             STOREPASS, STORETYPE, PROVIDERNAME, ADDPROVIDER,
</pre>
<hr />
<pre>
 705             System.err.println(rb.getString(&quot;Illegal.option.&quot;) + args[i]);
 706             tinyHelp();
 707         }
 708 
 709         if (command == null) {
 710             if (help) {
 711                 usage();
 712             } else {
 713                 System.err.println(rb.getString(&quot;Usage.error.no.command.provided&quot;));
 714                 tinyHelp();
 715             }
 716         } else if (help) {
 717             usage();
 718             command = null;
 719         }
 720 
 721         return args;
 722     }
 723 
 724     boolean isKeyStoreRelated(Command cmd) {
<span class="line-modified"> 725         return cmd != PRINTCERTREQ &amp;&amp; cmd != SHOWINFO;</span>
 726     }
 727 
 728     /**
 729      * Execute the commands.
 730      */
 731     void doCommands(PrintStream out) throws Exception {
 732 
 733         if (cacerts) {
 734             if (ksfname != null || storetype != null) {
 735                 throw new IllegalArgumentException(rb.getString
 736                         (&quot;the.keystore.or.storetype.option.cannot.be.used.with.the.cacerts.option&quot;));
 737             }
 738             ksfname = KeyStoreUtil.getCacerts();
 739         }
 740 
 741         if (P11KEYSTORE.equalsIgnoreCase(storetype) ||
 742                 KeyStoreUtil.isWindowsKeyStore(storetype)) {
 743             token = true;
 744             if (ksfname == null) {
 745                 ksfname = NONE;
</pre>
<hr />
<pre>
 890 
 891         // Check if keystore exists.
 892         // If no keystore has been specified at the command line, try to use
 893         // the default, which is located in $HOME/.keystore.
 894         // No need to check if isKeyStoreRelated(command) is false.
 895 
 896         // DO NOT open the existing keystore if this is an in-place import.
 897         // The keystore should be created as brand new.
 898         if (isKeyStoreRelated(command) &amp;&amp; !nullStream &amp;&amp; !inplaceImport) {
 899             try {
 900                 ksfile = new File(ksfname);
 901                 // Check if keystore file is empty
 902                 if (ksfile.exists() &amp;&amp; ksfile.length() == 0) {
 903                     throw new Exception(rb.getString
 904                             (&quot;Keystore.file.exists.but.is.empty.&quot;) + ksfname);
 905                 }
 906                 ksStream = new FileInputStream(ksfile);
 907             } catch (FileNotFoundException e) {
 908                 // These commands do not need the keystore to be existing.
 909                 // Either it will create a new one or the keystore is
<span class="line-modified"> 910                 // optional (i.e. PRINTCRL and PRINTCERT).</span>
 911                 if (command != GENKEYPAIR &amp;&amp;
 912                         command != GENSECKEY &amp;&amp;
 913                         command != IDENTITYDB &amp;&amp;
 914                         command != IMPORTCERT &amp;&amp;
 915                         command != IMPORTPASS &amp;&amp;
 916                         command != IMPORTKEYSTORE &amp;&amp;
<span class="line-modified"> 917                         command != PRINTCRL &amp;&amp;</span>
<span class="line-added"> 918                         command != PRINTCERT) {</span>
 919                     throw new Exception(rb.getString
 920                             (&quot;Keystore.file.does.not.exist.&quot;) + ksfname);
 921                 }
 922             }
 923         }
 924 
 925         if ((command == KEYCLONE || command == CHANGEALIAS)
 926                 &amp;&amp; dest == null) {
 927             dest = getAlias(&quot;destination&quot;);
 928             if (&quot;&quot;.equals(dest)) {
 929                 throw new Exception(rb.getString
 930                         (&quot;Must.specify.destination.alias&quot;));
 931             }
 932         }
 933 
 934         if (command == DELETE &amp;&amp; alias == null) {
 935             alias = getAlias(null);
 936             if (&quot;&quot;.equals(alias)) {
 937                 throw new Exception(rb.getString(&quot;Must.specify.alias&quot;));
 938             }
</pre>
<hr />
<pre>
1060                             char[] storePassAgain = Password.readPassword(System.in);
1061                             passwords.add(storePassAgain);
1062                             if (!Arrays.equals(storePass, storePassAgain)) {
1063                                 System.err.println
1064                                         (rb.getString(&quot;They.don.t.match.Try.again&quot;));
1065                                 storePass = null;
1066                             }
1067                         }
1068 
1069                         count++;
1070                     } while ((storePass == null) &amp;&amp; count &lt; 3);
1071 
1072 
1073                     if (storePass == null) {
1074                         System.err.println
1075                                 (rb.getString(&quot;Too.many.failures.try.later&quot;));
1076                         return;
1077                     }
1078                 } else {
1079                     // here we have EXPORTCERT and LIST (info valid until STOREPASSWD)
<span class="line-modified">1080                     if (command != PRINTCRL &amp;&amp; command != PRINTCERT) {</span>
1081                         System.err.print(rb.getString(&quot;Enter.keystore.password.&quot;));
1082                         System.err.flush();
1083                         storePass = Password.readPassword(System.in);
1084                         passwords.add(storePass);
1085                     }
1086                 }
1087             }
1088 
1089             // Now load a nullStream-based keystore,
1090             // or verify the integrity of an input stream-based keystore
1091             if (nullStream) {
1092                 keyStore.load(null, storePass);
1093             } else if (ksStream != null) {
1094                 ksStream = new FileInputStream(ksfile);
1095                 keyStore.load(ksStream, storePass);
1096                 ksStream.close();
1097             }
1098         }
1099 
1100         if (storePass != null &amp;&amp; P12KEYSTORE.equalsIgnoreCase(storetype)) {
1101             MessageFormat form = new MessageFormat(rb.getString(
1102                 &quot;Warning.Different.store.and.key.passwords.not.supported.for.PKCS12.KeyStores.Ignoring.user.specified.command.value.&quot;));
1103             if (keyPass != null &amp;&amp; !Arrays.equals(storePass, keyPass)) {
1104                 Object[] source = {&quot;-keypass&quot;};
1105                 System.err.println(form.format(source));
1106                 keyPass = storePass;
1107             }
1108             if (destKeyPass != null &amp;&amp; !Arrays.equals(storePass, destKeyPass)) {
1109                 Object[] source = {&quot;-destkeypass&quot;};
1110                 System.err.println(form.format(source));
1111                 destKeyPass = storePass;
1112             }
1113         }
1114 
<span class="line-modified">1115         // -trustcacerts can be specified on -importcert, -printcert or -printcrl.</span>
<span class="line-modified">1116         // Reset it so that warnings on CA cert will remain for other command.</span>
<span class="line-modified">1117         if (command != IMPORTCERT &amp;&amp; command != PRINTCERT</span>
<span class="line-modified">1118                 &amp;&amp; command != PRINTCRL) {</span>
1119             trustcacerts = false;
1120         }
1121 
1122         if (trustcacerts) {
1123             caks = KeyStoreUtil.getCacertsKeyStore();
1124         }
1125 
1126         // Perform the specified command
1127         if (command == CERTREQ) {
1128             if (filename != null) {
1129                 try (PrintStream ps = new PrintStream(new FileOutputStream
1130                                                       (filename))) {
1131                     doCertReq(alias, sigAlgName, ps);
1132                 }
1133             } else {
1134                 doCertReq(alias, sigAlgName, out);
1135             }
1136             if (verbose &amp;&amp; filename != null) {
1137                 MessageFormat form = new MessageFormat(rb.getString
1138                         (&quot;Certification.request.stored.in.file.filename.&quot;));
</pre>
<hr />
<pre>
2429                 new MessageFormat(rb.getString
2430                         (&quot;Your.keystore.contains.keyStore.size.entries&quot;));
2431         Object[] source = {keyStore.size()};
2432         out.println(form.format(source));
2433         out.println();
2434 
2435         List&lt;String&gt; aliases = Collections.list(keyStore.aliases());
2436         aliases.sort(String::compareTo);
2437         for (String alias : aliases) {
2438             doPrintEntry(&quot;&lt;&quot; + alias + &quot;&gt;&quot;, alias, out);
2439             if (verbose || rfc) {
2440                 out.println(rb.getString(&quot;NEWLINE&quot;));
2441                 out.println(rb.getString
2442                         (&quot;STAR&quot;));
2443                 out.println(rb.getString
2444                         (&quot;STARNN&quot;));
2445             }
2446         }
2447     }
2448 





















2449     /**
2450      * Loads CRLs from a source. This method is also called in JarSigner.
2451      * @param src the source, which means System.in if null, or a URI,
2452      *        or a bare file path name
2453      */
2454     public static Collection&lt;? extends CRL&gt; loadCRLs(String src) throws Exception {
2455         InputStream in = null;
2456         URI uri = null;
2457         if (src == null) {
2458             in = System.in;
2459         } else {
2460             try {
2461                 uri = new URI(src);
2462                 if (uri.getScheme().equals(&quot;ldap&quot;)) {
2463                     // No input stream for LDAP
2464                 } else {
2465                     in = uri.toURL().openStream();
2466                 }
2467             } catch (Exception e) {
2468                 try {
</pre>
<hr />
<pre>
2522                 for (GeneralName name: names.names()) {
2523                     if (name.getType() == GeneralNameInterface.NAME_URI) {
2524                         URIName uriName = (URIName)name.getName();
2525                         for (CRL crl: loadCRLs(uriName.getName())) {
2526                             if (crl instanceof X509CRL) {
2527                                 crls.add((X509CRL)crl);
2528                             }
2529                         }
2530                         break;  // Different name should point to same CRL
2531                     }
2532                 }
2533             }
2534         }
2535         return crls;
2536     }
2537 
2538     private static String verifyCRL(KeyStore ks, CRL crl)
2539             throws Exception {
2540         X509CRLImpl xcrl = (X509CRLImpl)crl;
2541         X500Principal issuer = xcrl.getIssuerX500Principal();
<span class="line-modified">2542         for (String s: Collections.list(ks.aliases())) {</span>
2543             Certificate cert = ks.getCertificate(s);
2544             if (cert instanceof X509Certificate) {
2545                 X509Certificate xcert = (X509Certificate)cert;
2546                 if (xcert.getSubjectX500Principal().equals(issuer)) {
2547                     try {
2548                         ((X509CRLImpl)crl).verify(cert.getPublicKey());
2549                         return s;
2550                     } catch (Exception e) {
2551                     }
2552                 }
2553             }
2554         }
2555         return null;
2556     }
2557 
2558     private void doPrintCRL(String src, PrintStream out)
2559             throws Exception {
2560         for (CRL crl: loadCRLs(src)) {
2561             printCRL(crl, out);
2562             String issuer = null;
</pre>
<hr />
<pre>
2571                             &quot;cacerts&quot;,
2572                             withWeak(signer.getPublicKey()));
2573                     out.println();
2574                 }
2575             }
2576             if (issuer == null &amp;&amp; keyStore != null) {
2577                 issuer = verifyCRL(keyStore, crl);
2578                 if (issuer != null) {
2579                     signer = keyStore.getCertificate(issuer);
2580                     out.printf(rb.getString(
2581                             &quot;verified.by.s.in.s.weak&quot;),
2582                             issuer,
2583                             &quot;keystore&quot;,
2584                             withWeak(signer.getPublicKey()));
2585                     out.println();
2586                 }
2587             }
2588             if (issuer == null) {
2589                 out.println(rb.getString
2590                         (&quot;STAR&quot;));
<span class="line-modified">2591                 if (trustcacerts) {</span>
<span class="line-modified">2592                     out.println(rb.getString</span>
<span class="line-added">2593                             (&quot;warning.not.verified.make.sure.keystore.is.correct&quot;));</span>
<span class="line-added">2594                 } else {</span>
<span class="line-added">2595                     out.println(rb.getString</span>
<span class="line-added">2596                             (&quot;warning.not.verified.make.sure.keystore.is.correct.or.specify.trustcacerts&quot;));</span>
<span class="line-added">2597                 }</span>
2598                 out.println(rb.getString
2599                         (&quot;STARNN&quot;));
2600             }
2601             checkWeak(rb.getString(&quot;the.crl&quot;), crl, signer == null ? null : signer.getPublicKey());
2602         }
2603     }
2604 
2605     private void printCRL(CRL crl, PrintStream out)
2606             throws Exception {
2607         X509CRL xcrl = (X509CRL)crl;
2608         if (rfc) {
2609             out.println(&quot;-----BEGIN X509 CRL-----&quot;);
2610             out.println(Base64.getMimeEncoder(64, CRLF).encodeToString(xcrl.getEncoded()));
2611             out.println(&quot;-----END X509 CRL-----&quot;);
2612         } else {
2613             String s;
2614             if (crl instanceof X509CRLImpl) {
2615                 X509CRLImpl x509crl = (X509CRLImpl) crl;
2616                 s = x509crl.toStringWithAlgName(withWeak(&quot;&quot; + x509crl.getSigAlgId()));
2617             } else {
</pre>
</td>
</tr>
</table>
<center><a href="../KeyStoreUtil.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="Resources.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>