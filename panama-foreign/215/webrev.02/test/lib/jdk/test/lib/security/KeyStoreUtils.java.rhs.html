<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames test/lib/jdk/test/lib/security/KeyStoreUtils.java</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
  2  * Copyright (c) 2019, 2020, Oracle and/or its affiliates. All rights reserved.
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 package jdk.test.lib.security;
 25 
<a name="1" id="anc1"></a><span class="line-added"> 26 import java.io.*;</span>
 27 import java.io.ByteArrayInputStream;
 28 import java.io.FileInputStream;
 29 import java.io.InputStream;
 30 import java.security.KeyStore;
 31 import java.security.PrivateKey;
 32 import java.security.cert.Certificate;
<a name="2" id="anc2"></a><span class="line-added"> 33 import java.security.cert.CertificateFactory;</span>
<span class="line-added"> 34 import java.security.KeyStore;</span>
 35 import java.util.ArrayList;
 36 import java.util.Base64;
 37 import java.util.List;
 38 
 39 /*
 40  * Utilities for creating key store.
 41  */
 42 public class KeyStoreUtils {
 43 
 44     private static final String DEFAULT_TYPE = KeyStore.getDefaultType();
 45 
 46     /**
 47      * Create key store with a given input stream.
 48      *
 49      * @param type the key store type
 50      * @param input the input stream containing a key store
 51      * @param password the password used to check the integrity of the key store
 52      * @return the key store
 53      * @throws Exception on errors
 54      */
 55     public static KeyStore loadKeyStore(String type, InputStream input,
 56             String password) throws Exception {
 57         KeyStore keyStore = KeyStore.getInstance(type);
 58         try {
 59             keyStore.load(input,
 60                     password == null ? null : password.toCharArray());
 61             return keyStore;
 62         } finally {
 63             if (input != null) {
 64                 input.close();
 65             }
 66         }
 67     }
 68 
 69     /**
 70      * Create key store with a given input stream.
 71      *
 72      * @param input the input stream containing a key store
 73      * @param password the password used to check the integrity of the key store
 74      * @return the key store
 75      * @throws Exception on errors
 76      */
 77     public static KeyStore loadKeyStore(InputStream input, String password)
 78             throws Exception {
 79         return loadKeyStore(DEFAULT_TYPE, input, password);
 80     }
 81 
 82     /**
 83      * Create key store with given Base64-encoded string.
 84      *
 85      * @param keyStoreBase64 the Base64-encoded string containing a key store
 86      * @param password the password used to check the integrity of the key store
 87      * @return the key store
 88      * @throws Exception on errors
 89      */
 90     public static KeyStore loadKeyStoreBase64(String keyStoreBase64,
 91             String password) throws Exception {
 92         return loadKeyStore(DEFAULT_TYPE, new ByteArrayInputStream(
 93                 Base64.getDecoder().decode(keyStoreBase64)), password);
 94     }
 95 
 96     /**
 97      * Create key store with a given file.
 98      *
 99      * @param type the key store type
100      * @param path the path to file containing a key store
101      * @param password the password used to check the integrity of the key store
102      * @return the key store
103      * @throws Exception on errors
104      */
105     public static KeyStore loadKeyStore(String type, String path,
106             String password) throws Exception {
107         return loadKeyStore(type, new FileInputStream(path), password);
108     }
109 
110     /**
111      * Create key store with a given file.
112      *
113      * @param path the path to file containing a key store
114      * @param password the password used to check the integrity of the key store
115      * @return the key store
116      * @throws Exception on errors
117      */
118     public static KeyStore loadKeyStore(String path, String password)
119             throws Exception {
120         return loadKeyStore(DEFAULT_TYPE, path, password);
121     }
122 
123     /**
124      * Create trust store with given certificates and corresponding aliases.
125      *
126      * @param type the key store type
127      * @param certStrs the certificates added to the trust store
128      * @param aliases the aliases corresponding to the trust entries respectively
129      * @return the trust store
130      * @throws Exception on errors
131      */
132     public static KeyStore createTrustStore(String type, String[] certStrs,
133             String[] aliases) throws Exception {
134         if (aliases != null &amp;&amp; aliases.length != certStrs.length) {
135             throw new IllegalArgumentException(
136                     &quot;The counts of certs and aliases are not matching.&quot;);
137         }
138 
139         KeyStore trustStore = initKeyStore(type);
140 
141         for (int i = 0; i &lt; certStrs.length; i++) {
142             String alias = aliases == null ? &quot;trust-&quot; + i : aliases[i];
143             trustStore.setCertificateEntry(alias,
144                     CertUtils.getCertFromString(certStrs[i]));
145         }
146 
147         return trustStore;
148     }
149 
150     /**
151      * Create trust store with given certificates.
152      *
153      * @param type the key store type
154      * @param certStrs the certificates added to the trust store
155      * @return the trust store
156      * @throws Exception on errors
157      */
158     public static KeyStore createTrustStore(String type, String[] certStrs)
159             throws Exception {
160         return createTrustStore(type, certStrs, null);
161     }
162 
163     /**
164      * Create trust store with given certificates and corresponding aliases.
165      *
166      * @param certStrs the certificates added to the trust store
167      * @param aliases the aliases corresponding to the trust entries respectively
168      * @return the trust store
169      * @throws Exception on errors
170      */
171     public static KeyStore createTrustStore(String[] certStrs, String[] aliases)
172             throws Exception {
173         return createTrustStore(DEFAULT_TYPE, certStrs, aliases);
174     }
175 
176     /**
177      * Create trust store with given certificates.
178      *
179      * @param certStrs the certificates added to the trust store
180      * @return the trust store
181      * @throws Exception on errors
182      */
183     public static KeyStore createTrustStore(String[] certStrs) throws Exception {
184         return createTrustStore(DEFAULT_TYPE, certStrs, null);
185     }
186 
187     /**
188      * Create key store with given entries and corresponding aliases.
189      *
190      * @param type the key store type
191      * @param entries the key entries added to the key store
192      * @param aliases the aliases corresponding to the key entries respectively
193      * @return the key store
194      * @throws Exception on errors
195      */
196     public static KeyStore createKeyStore(String type, KeyEntry[] entries,
197             String[] aliases) throws Exception {
198         if (aliases != null &amp;&amp; aliases.length != entries.length) {
199             throw new IllegalArgumentException(
200                     &quot;The counts of entries and aliases are not matching.&quot;);
201         }
202 
203         KeyStore keyStore = initKeyStore(type);
204 
205         for (int i = 0; i &lt; entries.length; i++) {
206             KeyEntry entry = entries[i];
207             PrivateKey key = CertUtils.getKeyFromString(
208                     entry.keyAlgo, entry.keyStr);
209             char[] password = entry.password == null
210                     ? null
211                     : entry.password.toCharArray();
212             Certificate[] chain = new Certificate[entry.certStrs.length];
213             for (int j = 0; j &lt; chain.length; j++) {
214                 chain[j] = CertUtils.getCertFromString(entry.certStrs[j]);
215             }
216 
217             String alias = aliases == null ? &quot;cert-&quot; + i : aliases[i];
218             keyStore.setKeyEntry(alias, key, password, chain);
219         }
220 
221         return keyStore;
222     }
223 
224     /**
225      * Create key store with given entries.
226      *
227      * @param type the key store type
228      * @param entries the key entries added to the key store
229      * @return the key store
230      * @throws Exception on errors
231      */
232     public static KeyStore createKeyStore(String type, KeyEntry[] entries)
233             throws Exception {
234         return createKeyStore(type, entries, null);
235     }
236 
237     /**
238      * Create key store with given entries and corresponding aliases.
239      *
240      * @param entries the key entries added to the key store
241      * @param aliases the aliases corresponding to the key entries respectively
242      * @return the key store
243      * @throws Exception on errors
244      */
245     public static KeyStore createKeyStore(KeyEntry[] entries, String[] aliases)
246             throws Exception {
247         return createKeyStore(DEFAULT_TYPE, entries, aliases);
248     }
249 
250     /**
251      * Create key store with given entries.
252      *
253      * @param entries the key entries added to the key store
254      * @return the key store
255      * @throws Exception on errors
256      */
257     public static KeyStore createKeyStore(KeyEntry[] entries) throws Exception {
258         return createKeyStore(DEFAULT_TYPE, entries, null);
259     }
260 
261     // Initialize key store with given store type.
262     // Note that it always has no password.
263     private static KeyStore initKeyStore(String type) throws Exception {
264         KeyStore keyStore = KeyStore.getInstance(type);
265         keyStore.load(null, null);
266         return keyStore;
267     }
268 
269     /**
270      * The default trust store that contains RSA, ECDSA, RSASSA-PSS and DSA
271      * certificates.
272      */
273     public static KeyStore defaultTrustStore() throws Exception {
274         return createTrustStore(
275                 new String[] { CertUtils.RSA_CERT, CertUtils.ECDSA_CERT,
276                         CertUtils.RSASSAPSS_CERT, CertUtils.DSA_CERT });
277     }
278 
279     /**
280      * The default key store that contains RSA, ECDSA, RSASSA-PSS and DSA
281      * certificates.
282      */
283     public static KeyStore defaultKeyStore() throws Exception {
284         List&lt;KeyEntry&gt; entries = new ArrayList&lt;&gt;();
285         entries.add(new KeyEntry(&quot;RSA&quot;, CertUtils.RSA_KEY,
286                 new String[] { CertUtils.RSA_CERT }));
287         entries.add(new KeyEntry(&quot;EC&quot;, CertUtils.ECDSA_KEY,
288                 new String[] { CertUtils.ECDSA_CERT }));
289         entries.add(new KeyEntry(&quot;RSASSA-PSS&quot;, CertUtils.RSASSAPSS_KEY,
290                 new String[] { CertUtils.RSASSAPSS_CERT }));
291         entries.add(new KeyEntry(&quot;DSA&quot;, CertUtils.DSA_KEY,
292                 new String[] { CertUtils.DSA_CERT }));
293         return createKeyStore(entries.toArray(new KeyEntry[entries.size()]));
294     }
<a name="3" id="anc3"></a><span class="line-added">295 </span>
<span class="line-added">296     /**</span>
<span class="line-added">297      * Creates cacerts keystore with the trusted certificate(s)</span>
<span class="line-added">298      * @param args arguments to cacerts keystore name and trusted certificates</span>
<span class="line-added">299      * @throws Exception if there is an error</span>
<span class="line-added">300      *</span>
<span class="line-added">301      */</span>
<span class="line-added">302     public static void createCacerts(String ks, String... crts) throws Exception {</span>
<span class="line-added">303         try (OutputStream os = new FileOutputStream(ks)) {</span>
<span class="line-added">304             KeyStore k = KeyStore.getInstance(&quot;JKS&quot;);</span>
<span class="line-added">305             k.load(null, null);</span>
<span class="line-added">306             CertificateFactory cf = CertificateFactory.getInstance(&quot;X.509&quot;);</span>
<span class="line-added">307             for (int pos = 0; pos &lt; crts.length; pos++) {</span>
<span class="line-added">308                 try (InputStream is = new FileInputStream(crts[pos])) {</span>
<span class="line-added">309                     k.setCertificateEntry(&quot;root&quot; + pos,</span>
<span class="line-added">310                             cf.generateCertificate(is));</span>
<span class="line-added">311                 }</span>
<span class="line-added">312             }</span>
<span class="line-added">313             k.store(os, &quot;changeit&quot;.toCharArray());</span>
<span class="line-added">314         }</span>
<span class="line-added">315     }</span>
316 }
<a name="4" id="anc4"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="4" type="hidden" />
</body>
</html>