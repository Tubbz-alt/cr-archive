<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/jdk.incubator.foreign/share/classes/jdk/internal/foreign/abi/SharedUtils.java</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="../../../incubator/foreign/CSupport.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="x64/sysv/SysVVaList.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/jdk.incubator.foreign/share/classes/jdk/internal/foreign/abi/SharedUtils.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 20  *
 21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 22  * or visit www.oracle.com if you need additional information or have any
 23  * questions.
 24  */
 25 package jdk.internal.foreign.abi;
 26 
 27 import jdk.incubator.foreign.CSupport;
 28 import jdk.incubator.foreign.ForeignLinker;
 29 import jdk.incubator.foreign.FunctionDescriptor;
 30 import jdk.incubator.foreign.GroupLayout;
 31 import jdk.incubator.foreign.MemoryAddress;
 32 import jdk.incubator.foreign.MemoryHandles;
 33 import jdk.incubator.foreign.MemoryLayout;
 34 import jdk.incubator.foreign.MemorySegment;
 35 import jdk.incubator.foreign.SequenceLayout;
 36 import jdk.incubator.foreign.ValueLayout;
 37 import jdk.internal.foreign.MemoryAddressImpl;
 38 import jdk.internal.foreign.Utils;
 39 import jdk.internal.foreign.abi.aarch64.AArch64Linker;

 40 import jdk.internal.foreign.abi.x64.sysv.SysVx64Linker;
 41 import jdk.internal.foreign.abi.x64.windows.Windowsx64Linker;
 42 
 43 import java.lang.invoke.MethodHandle;
 44 import java.lang.invoke.MethodHandles;
 45 import java.lang.invoke.MethodType;
 46 import java.lang.invoke.VarHandle;
 47 import java.util.List;
 48 import java.util.function.Consumer;
 49 import java.util.stream.IntStream;
 50 
 51 import static java.lang.invoke.MethodHandles.collectArguments;
 52 import static java.lang.invoke.MethodHandles.identity;
 53 import static java.lang.invoke.MethodHandles.insertArguments;
 54 import static java.lang.invoke.MethodHandles.permuteArguments;
 55 import static java.lang.invoke.MethodType.methodType;
 56 import static jdk.incubator.foreign.CSupport.*;
 57 
 58 public class SharedUtils {
 59 
</pre>
<hr />
<pre>
256             default -&gt; throw new IllegalStateException(&quot;Unknown linker name: &quot; + name);
257         };
258     }
259 
260     public static VarHandle vhPrimitiveOrAddress(Class&lt;?&gt; carrier, MemoryLayout layout) {
261         return carrier == MemoryAddress.class
262             ? MemoryHandles.asAddressVarHandle(layout.varHandle(primitiveCarrierForSize(layout.byteSize())))
263             : layout.varHandle(carrier);
264     }
265 
266     public static VaList newVaListOfAddress(MemoryAddress ma) {
267         String name = CSupport.getSystemLinker().name();
268         return switch(name) {
269             case Win64.NAME -&gt; Windowsx64Linker.newVaListOfAddress(ma);
270             case SysV.NAME -&gt; SysVx64Linker.newVaListOfAddress(ma);
271             case AArch64.NAME -&gt; throw new UnsupportedOperationException(&quot;Not yet implemented for this platform&quot;);
272             default -&gt; throw new IllegalStateException(&quot;Unknown linker name: &quot; + name);
273         };
274     }
275 






































276     public static class SimpleVaArg {
277         public final Class&lt;?&gt; carrier;
278         public final MemoryLayout layout;
279         public final Object value;
280 
281         public SimpleVaArg(Class&lt;?&gt; carrier, MemoryLayout layout, Object value) {
282             this.carrier = carrier;
283             this.layout = layout;
284             this.value = value;
285         }
286 
287         public VarHandle varHandle() {
288             return carrier == MemoryAddress.class
289                 ? MemoryHandles.asAddressVarHandle(layout.varHandle(primitiveCarrierForSize(layout.byteSize())))
290                 : layout.varHandle(carrier);
291         }
292     }































































293 }
</pre>
</td>
<td>
<hr />
<pre>
 20  *
 21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 22  * or visit www.oracle.com if you need additional information or have any
 23  * questions.
 24  */
 25 package jdk.internal.foreign.abi;
 26 
 27 import jdk.incubator.foreign.CSupport;
 28 import jdk.incubator.foreign.ForeignLinker;
 29 import jdk.incubator.foreign.FunctionDescriptor;
 30 import jdk.incubator.foreign.GroupLayout;
 31 import jdk.incubator.foreign.MemoryAddress;
 32 import jdk.incubator.foreign.MemoryHandles;
 33 import jdk.incubator.foreign.MemoryLayout;
 34 import jdk.incubator.foreign.MemorySegment;
 35 import jdk.incubator.foreign.SequenceLayout;
 36 import jdk.incubator.foreign.ValueLayout;
 37 import jdk.internal.foreign.MemoryAddressImpl;
 38 import jdk.internal.foreign.Utils;
 39 import jdk.internal.foreign.abi.aarch64.AArch64Linker;
<span class="line-added"> 40 import jdk.internal.foreign.abi.x64.sysv.SysVVaList;</span>
 41 import jdk.internal.foreign.abi.x64.sysv.SysVx64Linker;
 42 import jdk.internal.foreign.abi.x64.windows.Windowsx64Linker;
 43 
 44 import java.lang.invoke.MethodHandle;
 45 import java.lang.invoke.MethodHandles;
 46 import java.lang.invoke.MethodType;
 47 import java.lang.invoke.VarHandle;
 48 import java.util.List;
 49 import java.util.function.Consumer;
 50 import java.util.stream.IntStream;
 51 
 52 import static java.lang.invoke.MethodHandles.collectArguments;
 53 import static java.lang.invoke.MethodHandles.identity;
 54 import static java.lang.invoke.MethodHandles.insertArguments;
 55 import static java.lang.invoke.MethodHandles.permuteArguments;
 56 import static java.lang.invoke.MethodType.methodType;
 57 import static jdk.incubator.foreign.CSupport.*;
 58 
 59 public class SharedUtils {
 60 
</pre>
<hr />
<pre>
257             default -&gt; throw new IllegalStateException(&quot;Unknown linker name: &quot; + name);
258         };
259     }
260 
261     public static VarHandle vhPrimitiveOrAddress(Class&lt;?&gt; carrier, MemoryLayout layout) {
262         return carrier == MemoryAddress.class
263             ? MemoryHandles.asAddressVarHandle(layout.varHandle(primitiveCarrierForSize(layout.byteSize())))
264             : layout.varHandle(carrier);
265     }
266 
267     public static VaList newVaListOfAddress(MemoryAddress ma) {
268         String name = CSupport.getSystemLinker().name();
269         return switch(name) {
270             case Win64.NAME -&gt; Windowsx64Linker.newVaListOfAddress(ma);
271             case SysV.NAME -&gt; SysVx64Linker.newVaListOfAddress(ma);
272             case AArch64.NAME -&gt; throw new UnsupportedOperationException(&quot;Not yet implemented for this platform&quot;);
273             default -&gt; throw new IllegalStateException(&quot;Unknown linker name: &quot; + name);
274         };
275     }
276 
<span class="line-added">277     public static VaList emptyVaList() {</span>
<span class="line-added">278         String name = CSupport.getSystemLinker().name();</span>
<span class="line-added">279         return switch(name) {</span>
<span class="line-added">280             case Win64.NAME -&gt; Windowsx64Linker.emptyVaList();</span>
<span class="line-added">281             case SysV.NAME -&gt; SysVx64Linker.emptyVaList();</span>
<span class="line-added">282             case AArch64.NAME -&gt; throw new UnsupportedOperationException(&quot;Not yet implemented for this platform&quot;);</span>
<span class="line-added">283             default -&gt; throw new IllegalStateException(&quot;Unknown linker name: &quot; + name);</span>
<span class="line-added">284         };</span>
<span class="line-added">285     }</span>
<span class="line-added">286 </span>
<span class="line-added">287     public static MethodType convertVaListCarriers(MethodType mt, Class&lt;?&gt; carrier) {</span>
<span class="line-added">288         Class&lt;?&gt;[] params = new Class&lt;?&gt;[mt.parameterCount()];</span>
<span class="line-added">289         for (int i = 0; i &lt; params.length; i++) {</span>
<span class="line-added">290             Class&lt;?&gt; pType = mt.parameterType(i);</span>
<span class="line-added">291             params[i] = ((pType == VaList.class) ? carrier : pType);</span>
<span class="line-added">292         }</span>
<span class="line-added">293         return methodType(mt.returnType(), params);</span>
<span class="line-added">294     }</span>
<span class="line-added">295 </span>
<span class="line-added">296     public static MethodHandle unboxVaLists(MethodType type, MethodHandle handle, MethodHandle unboxer) {</span>
<span class="line-added">297         for (int i = 0; i &lt; type.parameterCount(); i++) {</span>
<span class="line-added">298             if (type.parameterType(i) == VaList.class) {</span>
<span class="line-added">299                handle = MethodHandles.filterArguments(handle, i, unboxer);</span>
<span class="line-added">300             }</span>
<span class="line-added">301         }</span>
<span class="line-added">302         return handle;</span>
<span class="line-added">303     }</span>
<span class="line-added">304 </span>
<span class="line-added">305     public static MethodHandle boxVaLists(MethodHandle handle, MethodHandle boxer) {</span>
<span class="line-added">306         MethodType type = handle.type();</span>
<span class="line-added">307         for (int i = 0; i &lt; type.parameterCount(); i++) {</span>
<span class="line-added">308             if (type.parameterType(i) == VaList.class) {</span>
<span class="line-added">309                handle = MethodHandles.filterArguments(handle, i, boxer);</span>
<span class="line-added">310             }</span>
<span class="line-added">311         }</span>
<span class="line-added">312         return handle;</span>
<span class="line-added">313     }</span>
<span class="line-added">314 </span>
315     public static class SimpleVaArg {
316         public final Class&lt;?&gt; carrier;
317         public final MemoryLayout layout;
318         public final Object value;
319 
320         public SimpleVaArg(Class&lt;?&gt; carrier, MemoryLayout layout, Object value) {
321             this.carrier = carrier;
322             this.layout = layout;
323             this.value = value;
324         }
325 
326         public VarHandle varHandle() {
327             return carrier == MemoryAddress.class
328                 ? MemoryHandles.asAddressVarHandle(layout.varHandle(primitiveCarrierForSize(layout.byteSize())))
329                 : layout.varHandle(carrier);
330         }
331     }
<span class="line-added">332 </span>
<span class="line-added">333     public static class EmptyVaList implements CSupport.VaList {</span>
<span class="line-added">334 </span>
<span class="line-added">335         private final MemoryAddress address;</span>
<span class="line-added">336 </span>
<span class="line-added">337         public EmptyVaList(MemoryAddress address) {</span>
<span class="line-added">338             this.address = address;</span>
<span class="line-added">339         }</span>
<span class="line-added">340 </span>
<span class="line-added">341         private static UnsupportedOperationException uoe() {</span>
<span class="line-added">342             return new UnsupportedOperationException(&quot;Empty VaList&quot;);</span>
<span class="line-added">343         }</span>
<span class="line-added">344 </span>
<span class="line-added">345         @Override</span>
<span class="line-added">346         public int vargAsInt(MemoryLayout layout) {</span>
<span class="line-added">347             throw uoe();</span>
<span class="line-added">348         }</span>
<span class="line-added">349 </span>
<span class="line-added">350         @Override</span>
<span class="line-added">351         public long vargAsLong(MemoryLayout layout) {</span>
<span class="line-added">352             throw uoe();</span>
<span class="line-added">353         }</span>
<span class="line-added">354 </span>
<span class="line-added">355         @Override</span>
<span class="line-added">356         public double vargAsDouble(MemoryLayout layout) {</span>
<span class="line-added">357             throw uoe();</span>
<span class="line-added">358         }</span>
<span class="line-added">359 </span>
<span class="line-added">360         @Override</span>
<span class="line-added">361         public MemoryAddress vargAsAddress(MemoryLayout layout) {</span>
<span class="line-added">362             throw uoe();</span>
<span class="line-added">363         }</span>
<span class="line-added">364 </span>
<span class="line-added">365         @Override</span>
<span class="line-added">366         public MemorySegment vargAsSegment(MemoryLayout layout) {</span>
<span class="line-added">367             throw uoe();</span>
<span class="line-added">368         }</span>
<span class="line-added">369 </span>
<span class="line-added">370         @Override</span>
<span class="line-added">371         public void skip(MemoryLayout... layouts) {</span>
<span class="line-added">372             throw uoe();</span>
<span class="line-added">373         }</span>
<span class="line-added">374 </span>
<span class="line-added">375         @Override</span>
<span class="line-added">376         public boolean isAlive() {</span>
<span class="line-added">377             return true;</span>
<span class="line-added">378         }</span>
<span class="line-added">379 </span>
<span class="line-added">380         @Override</span>
<span class="line-added">381         public void close() {</span>
<span class="line-added">382             throw uoe();</span>
<span class="line-added">383         }</span>
<span class="line-added">384 </span>
<span class="line-added">385         @Override</span>
<span class="line-added">386         public VaList copy() {</span>
<span class="line-added">387             return this;</span>
<span class="line-added">388         }</span>
<span class="line-added">389 </span>
<span class="line-added">390         @Override</span>
<span class="line-added">391         public MemoryAddress address() {</span>
<span class="line-added">392             return address;</span>
<span class="line-added">393         }</span>
<span class="line-added">394     }</span>
395 }
</pre>
</td>
</tr>
</table>
<center><a href="../../../incubator/foreign/CSupport.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="x64/sysv/SysVVaList.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>