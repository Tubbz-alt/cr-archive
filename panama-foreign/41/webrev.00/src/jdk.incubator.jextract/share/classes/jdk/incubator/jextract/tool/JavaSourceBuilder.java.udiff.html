<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff src/jdk.incubator.jextract/share/classes/jdk/incubator/jextract/tool/JavaSourceBuilder.java</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center>&lt; prev <a href="../../../../../../../../index.html" target="_top">index</a> next &gt;</center>    <h2>src/jdk.incubator.jextract/share/classes/jdk/incubator/jextract/tool/JavaSourceBuilder.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -40,10 +40,11 @@</span>
  import java.util.ArrayList;
  import java.util.List;
  import java.util.stream.Collectors;
  import java.util.stream.IntStream;
  import java.util.stream.Stream;
<span class="udiff-line-added">+ import javax.lang.model.SourceVersion;</span>
  
  /**
   * A helper class to generate header interface class in source form.
   * After aggregating various constituents of a .java source, build
   * method is called to get overall generated source string.
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -120,11 +121,11 @@</span>
      }
  
      protected void addLayout(String elementName, MemoryLayout layout) {
          incrAlign();
          indent();
<span class="udiff-line-modified-removed">-         sb.append(PUB_MODS + &quot;MemoryLayout &quot; + elementName + &quot;$LAYOUT = &quot;);</span>
<span class="udiff-line-modified-added">+         sb.append(PUB_MODS + &quot;MemoryLayout &quot; + javaSafeIdentifier(elementName) + &quot;$LAYOUT = &quot;);</span>
          addLayout(layout);
          sb.append(&quot;;\n&quot;);
          decrAlign();
      }
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -194,13 +195,14 @@</span>
      }
  
      protected void addVarHandle(String name, Class&lt;?&gt; type, String parentName) {
          incrAlign();
          indent();
<span class="udiff-line-added">+         parentName = parentName != null? javaSafeIdentifier(parentName) : parentName;</span>
<span class="udiff-line-added">+         name = javaSafeIdentifier(name);</span>
          String vhName = parentName != null ?
<span class="udiff-line-modified-removed">-                 parentName + &quot;$&quot; + name :</span>
<span class="udiff-line-removed">-                 name;</span>
<span class="udiff-line-modified-added">+                 parentName + &quot;$&quot; + name : name;</span>
          sb.append(PUB_MODS + &quot;VarHandle &quot; + vhName + &quot; = &quot;);
          if (parentName != null) {
              addHandlePath(type, parentName, name);
          } else {
              addHandlePath(type, name);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -228,11 +230,11 @@</span>
      }
  
      protected void addMethodHandle(Declaration.Function funcTree, MethodType mtype, FunctionDescriptor desc) {
          incrAlign();
          indent();
<span class="udiff-line-modified-removed">-         sb.append(PUB_MODS + &quot;MethodHandle &quot; + funcTree.name() + &quot; = &quot;);</span>
<span class="udiff-line-modified-added">+         sb.append(PUB_MODS + &quot;MethodHandle &quot; + javaSafeIdentifier(funcTree.name()) + &quot; = &quot;);</span>
          sb.append(&quot;RuntimeHelper.downcallHandle(\n&quot;);
          incrAlign();
          indent();
          sb.append(&quot;LIBRARIES, \&quot;&quot; + funcTree.name() + &quot;\&quot;&quot;);
          sb.append(&quot;,\n&quot;);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -283,11 +285,11 @@</span>
      }
  
      protected void addAddress(String name) {
          incrAlign();
          indent();
<span class="udiff-line-modified-removed">-         sb.append(PUB_MODS + &quot;MemoryAddress &quot; + name + &quot;$ADDR&quot; + &quot; = &quot;);</span>
<span class="udiff-line-modified-added">+         sb.append(PUB_MODS + &quot;MemoryAddress &quot; + javaSafeIdentifier(name) + &quot;$ADDR&quot; + &quot; = &quot;);</span>
          addAddressLookup(name);
          sb.append(&quot;;\n&quot;);
          decrAlign();
      }
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -295,11 +297,11 @@</span>
          incrAlign();
          indent();
          if (type == MemoryAddress.class || type == MemorySegment.class) {
              //todo, skip for now (address constants and string constants)
          } else {
<span class="udiff-line-modified-removed">-             sb.append(PUB_MODS + type.getName() + &quot; &quot; + name);</span>
<span class="udiff-line-modified-added">+             sb.append(PUB_MODS + type.getName() + &quot; &quot; + javaSafeIdentifier(name));</span>
              sb.append(&quot; = &quot;);
              if (type == float.class) {
                  sb.append(value);
                  sb.append(&quot;f&quot;);
              } else if (type == long.class) {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -339,19 +341,20 @@</span>
      }
  
      protected void addStaticFunctionWrapper(Declaration.Function f, MethodType mtype) {
          incrAlign();
          indent();
<span class="udiff-line-modified-removed">-         sb.append(PUB_MODS + mtype.returnType().getName() + &quot; &quot; + f.name() + &quot; (&quot;);</span>
<span class="udiff-line-modified-added">+         sb.append(PUB_MODS + mtype.returnType().getName() + &quot; &quot; + javaSafeIdentifier(f.name()) + &quot; (&quot;);</span>
          String delim = &quot;&quot;;
          List&lt;String&gt; pNames = new ArrayList&lt;&gt;();
          final int numParams = f.parameters().size();
          for (int i = 0 ; i &lt; numParams; i++) {
              String pName = f.parameters().get(i).name();
              if (pName.isEmpty()) {
                  pName = &quot;x&quot; + i;
              }
<span class="udiff-line-added">+             pName = javaSafeIdentifier(pName);</span>
              pNames.add(pName);
              sb.append(delim + mtype.parameterType(i).getName() + &quot; &quot; + pName);
              delim = &quot;, &quot;;
          }
          if (f.type().varargs()) {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -398,11 +401,11 @@</span>
      }
  
      void addFunctionalInterface(String name, MethodType mtype) {
          incrAlign();
          indent();
<span class="udiff-line-modified-removed">-         sb.append(&quot;public interface &quot; + name + &quot; {\n&quot;);</span>
<span class="udiff-line-modified-added">+         sb.append(&quot;public interface &quot; + javaSafeIdentifier(name) + &quot; {\n&quot;);</span>
          incrAlign();
          indent();
          sb.append(mtype.returnType().getName() + &quot; apply(&quot;);
          String delim = &quot;&quot;;
          for (int i = 0 ; i &lt; mtype.parameterCount() ; i++) {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -432,11 +435,12 @@</span>
      }
  
      void addGetter(String name, Class&lt;?&gt; type, Declaration parent) {
          incrAlign();
          indent();
<span class="udiff-line-modified-removed">-         String vhName = (parent != null ? (parent.name() + &quot;$&quot;) : &quot;&quot;) + name;</span>
<span class="udiff-line-modified-added">+         name = javaSafeIdentifier(name);</span>
<span class="udiff-line-added">+         String vhName = (parent != null ? (javaSafeIdentifier(parent.name()) + &quot;$&quot;) : &quot;&quot;) + name;</span>
          String param = parent != null ? (MemorySegment.class.getName() + &quot; seg&quot;) : &quot;&quot;;
          sb.append(PUB_MODS + type.getName() + &quot; &quot; + vhName + &quot;$get(&quot; + param + &quot;) {\n&quot;);
          incrAlign();
          indent();
          String vhParam = parent != null ?
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -449,11 +453,12 @@</span>
      }
  
      void addSetter(String name, Class&lt;?&gt; type, Declaration parent) {
          incrAlign();
          indent();
<span class="udiff-line-modified-removed">-         String vhName = (parent != null ? (parent.name() + &quot;$&quot;) : &quot;&quot;) + name;</span>
<span class="udiff-line-modified-added">+         name = javaSafeIdentifier(name);</span>
<span class="udiff-line-added">+         String vhName = (parent != null ? (javaSafeIdentifier(parent.name()) + &quot;$&quot;) : &quot;&quot;) + name;</span>
          String param = parent != null ? (MemorySegment.class.getName() + &quot; seg, &quot;) : &quot;&quot;;
          sb.append(PUB_MODS + &quot;void &quot; + vhName + &quot;$set(&quot; + param + type.getName() + &quot; x) {\n&quot;);
          incrAlign();
          indent();
          String vhParam = parent != null ?
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -482,6 +487,14 @@</span>
      }
  
      protected void decrAlign() {
          align--;
      }
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     protected final String javaSafeIdentifier(String name) {</span>
<span class="udiff-line-added">+         // We never get the problem of Java non-identifiers (like 123, ab-xy) as</span>
<span class="udiff-line-added">+         // C identifiers. But we may have a java keyword used as a C identifier.</span>
<span class="udiff-line-added">+         assert SourceVersion.isIdentifier(name);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         return SourceVersion.isKeyword(name)? (name + &quot;_&quot;) : name;</span>
<span class="udiff-line-added">+     }</span>
  }
</pre>
<center>&lt; prev <a href="../../../../../../../../index.html" target="_top">index</a> next &gt;</center>  </body>
</html>