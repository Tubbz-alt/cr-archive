<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff test/hotspot/jtreg/compiler/c2/aarch64/TestVolatiles.java</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
  </head>
<body>
<center><a href="../../../ProblemList.txt.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="../../jvmci/events/JvmciNotifyBootstrapFinishedEventTest.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>test/hotspot/jtreg/compiler/c2/aarch64/TestVolatiles.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
   1 /*
<span class="line-modified">   2  * Copyright (c) 2018, Red Hat, Inc. All rights reserved.</span>
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.
   8  *
   9  * This code is distributed in the hope that it will be useful, but WITHOUT
  10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  */
</pre>
<hr />
<pre>
  57 import jdk.test.lib.process.ProcessTools;
  58 import sun.hotspot.WhiteBox;
  59 
  60 // runner class that spawns a new JVM to exercises a combination of
  61 // volatile MemOp and GC. The ops are compiled with the dmb --&gt;
  62 // ldar/stlr transforms either enabled or disabled. this runner parses
  63 // the PrintOptoAssembly output checking that the generated code is
  64 // correct.
  65 
  66 public class TestVolatiles {
  67     public void runtest(String classname, String testType) throws Throwable {
  68         // n.b. clients omit the package name for the class
  69         String fullclassname = &quot;compiler.c2.aarch64.&quot; + classname;
  70         // build up a command line for the spawned JVM
  71         String[] procArgs;
  72         int argcount;
  73         // add one or two extra arguments according to test type
  74         // i.e. GC type plus GC conifg
  75         switch(testType) {
  76         case &quot;G1&quot;:
<span class="line-modified">  77             argcount = 9;</span>
  78             procArgs = new String[argcount];
  79             procArgs[argcount - 2] = &quot;-XX:+UseG1GC&quot;;
  80             break;
  81         case &quot;Parallel&quot;:
<span class="line-modified">  82             argcount = 9;</span>
  83             procArgs = new String[argcount];
  84             procArgs[argcount - 2] = &quot;-XX:+UseParallelGC&quot;;
  85             break;
  86         case &quot;Serial&quot;:
<span class="line-modified">  87             argcount = 9;</span>
  88             procArgs = new String[argcount];
  89             procArgs[argcount - 2] = &quot;-XX:+UseSerialGC&quot;;
  90             break;
  91         case &quot;Shenandoah&quot;:
<span class="line-modified">  92             argcount = 10;</span>
  93             procArgs = new String[argcount];
  94             procArgs[argcount - 3] = &quot;-XX:+UnlockExperimentalVMOptions&quot;;
  95             procArgs[argcount - 2] = &quot;-XX:+UseShenandoahGC&quot;;
  96             break;
  97         case &quot;ShenandoahIU&quot;:
<span class="line-modified">  98             argcount = 11;</span>
  99             procArgs = new String[argcount];
 100             procArgs[argcount - 4] = &quot;-XX:+UnlockExperimentalVMOptions&quot;;
 101             procArgs[argcount - 3] = &quot;-XX:+UseShenandoahGC&quot;;
 102             procArgs[argcount - 2] = &quot;-XX:ShenandoahGCMode=iu&quot;;
 103             break;
 104         default:
 105             throw new RuntimeException(&quot;unexpected test type &quot; + testType);
 106         }
 107 
 108         // fill in arguments common to all cases
 109 
 110         // the first round of test enables transform of barriers to
 111         // use acquiring loads and releasing stores by setting arg
 112         // zero appropriately. this arg is reset in the second run to
 113         // disable the transform.
 114 
<span class="line-modified"> 115         procArgs[0] = &quot;-XX:-UseBarriersForVolatile&quot;;</span>
<span class="line-modified"> 116         procArgs[1] = &quot;-XX:+UseCompressedOops&quot;;</span>
<span class="line-modified"> 117 </span>
<span class="line-modified"> 118         procArgs[2] = &quot;-XX:-TieredCompilation&quot;;</span>
<span class="line-modified"> 119         procArgs[3] = &quot;-XX:+PrintOptoAssembly&quot;;</span>
<span class="line-modified"> 120         procArgs[4] = &quot;-XX:CompileCommand=compileonly,&quot; + fullclassname + &quot;::&quot; + &quot;test*&quot;;</span>
<span class="line-removed"> 121         procArgs[5] = &quot;--add-exports&quot;;</span>
<span class="line-removed"> 122         procArgs[6] = &quot;java.base/jdk.internal.misc=ALL-UNNAMED&quot;;</span>
 123         procArgs[argcount - 1] = fullclassname;
 124 
<span class="line-modified"> 125         runtest(classname, testType, false, true, procArgs);</span>
<span class="line-removed"> 126         // rerun the test class without the transform applied and</span>
<span class="line-removed"> 127         // check the alternative generation is as expected</span>
<span class="line-removed"> 128 </span>
<span class="line-removed"> 129         procArgs[0] = &quot;-XX:+UseBarriersForVolatile&quot;;</span>
<span class="line-removed"> 130         runtest(classname, testType, true, true, procArgs);</span>
 131 
 132         if (!classname.equals(&quot;TestUnsafeVolatileGAA&quot;)) {
<span class="line-modified"> 133             procArgs[0] = &quot;-XX:-UseBarriersForVolatile&quot;;</span>
<span class="line-modified"> 134             procArgs[1] = &quot;-XX:-UseCompressedOops&quot;;</span>
<span class="line-removed"> 135             runtest(classname, testType, false, false, procArgs);</span>
<span class="line-removed"> 136 </span>
<span class="line-removed"> 137             procArgs[0] = &quot;-XX:+UseBarriersForVolatile&quot;;</span>
<span class="line-removed"> 138             runtest(classname, testType, true, false, procArgs);</span>
 139         }
 140     }
 141 
 142 
<span class="line-modified"> 143     public void runtest(String classname, String testType, boolean useBarriersForVolatile, boolean useCompressedOops, String[] procArgs) throws Throwable {</span>
 144         ProcessBuilder pb = ProcessTools.createJavaProcessBuilder(procArgs);
 145         OutputAnalyzer output = new OutputAnalyzer(pb.start());
 146 
 147         output.stderrShouldBeEmptyIgnoreVMWarnings();
 148         output.stdoutShouldNotBeEmpty();
 149         output.shouldHaveExitValue(0);
 150 
 151         // check the output for the correct asm sequence as
 152         // appropriate to test class, test type and whether transform
 153         // was applied
 154 
<span class="line-modified"> 155         checkoutput(output, classname, testType, useBarriersForVolatile, useCompressedOops);</span>
 156     }
 157 
 158     // skip through output returning a line containing the desireed
 159     // substring or null
 160     private String skipTo(Iterator&lt;String&gt; iter, String substring)
 161     {
 162         while (iter.hasNext()) {
 163             String nextLine = iter.next();
 164             if (nextLine.matches(&quot;.*&quot; + substring + &quot;.*&quot;)) {
 165                 return nextLine;
 166             }
 167         }
 168         return null;
 169     }
 170 
 171     // locate the start of compiler output for the desired method and
 172     // then check that each expected instruction occurs in the output
 173     // in the order supplied. throw an excpetion if not found.
 174     // n.b. the spawned JVM&#39;s output is included in the exception
 175     // message to make it easeir to identify what is missing.
</pre>
<hr />
<pre>
 206             if (do_throw) {
 207                 throw new RuntimeException(&quot;Wrong method &quot; + match + &quot;!\n  -- expecting &quot; + methodname + &quot;\n\n&quot; + output.getOutput());
 208             }
 209             return false;
 210         }
 211         // make sure we can match each expected term in order
 212         for (String s : expected) {
 213             match = skipTo(iter, s);
 214             if (match == null) {
 215                 if (do_throw) {
 216                     throw new RuntimeException(&quot;Missing expected output &quot; + s + &quot;!\n\n&quot; + output.getOutput());
 217                 }
 218                 return false;
 219             }
 220         }
 221         return true;
 222     }
 223 
 224     // check for expected asm output from a volatile load
 225 
<span class="line-modified"> 226     private void checkload(OutputAnalyzer output, String testType, boolean useBarriersForVolatile, boolean useCompressedOops) throws Throwable</span>
 227     {
 228         Iterator&lt;String&gt; iter = output.asLines().listIterator();
 229 
 230         // we shoud see this same sequence for normal or unsafe volatile load
 231         // for both int and Object fields
 232 
 233         String[] matches;
<span class="line-modified"> 234 </span>
<span class="line-modified"> 235         if (!useBarriersForVolatile) {</span>
<span class="line-modified"> 236             matches = new String[] {</span>
<span class="line-modified"> 237                 &quot;ldarw&quot;,</span>
<span class="line-modified"> 238                 &quot;membar_acquire \\(elided\\)&quot;,</span>
<span class="line-removed"> 239                 &quot;ret&quot;</span>
<span class="line-removed"> 240             };</span>
<span class="line-removed"> 241         } else {</span>
<span class="line-removed"> 242             matches = new String[] {</span>
<span class="line-removed"> 243                 &quot;ldrw&quot;,</span>
<span class="line-removed"> 244                 &quot;membar_acquire&quot;,</span>
<span class="line-removed"> 245                 &quot;dmb ish&quot;,</span>
<span class="line-removed"> 246                 &quot;ret&quot;</span>
<span class="line-removed"> 247             };</span>
<span class="line-removed"> 248         }</span>
<span class="line-removed"> 249 </span>
 250         checkCompile(iter, &quot;testInt&quot;, matches, output, true);
 251 
<span class="line-modified"> 252         if (!useBarriersForVolatile) {</span>
<span class="line-modified"> 253             matches = new String[] {</span>
<span class="line-modified"> 254                 useCompressedOops ? &quot;ldarw?&quot; : &quot;ldar&quot;,</span>
<span class="line-modified"> 255                 &quot;membar_acquire \\(elided\\)&quot;,</span>
<span class="line-modified"> 256                 &quot;ret&quot;</span>
<span class="line-removed"> 257             };</span>
<span class="line-removed"> 258         } else {</span>
<span class="line-removed"> 259             matches = new String[] {</span>
<span class="line-removed"> 260                 useCompressedOops ? &quot;ldrw?&quot; : &quot;ldr&quot;,</span>
<span class="line-removed"> 261                 &quot;membar_acquire&quot;,</span>
<span class="line-removed"> 262                 &quot;dmb ish&quot;,</span>
<span class="line-removed"> 263                 &quot;ret&quot;</span>
<span class="line-removed"> 264             };</span>
<span class="line-removed"> 265         }</span>
<span class="line-removed"> 266 </span>
 267         checkCompile(iter, &quot;testObj&quot;, matches, output, true);
 268 
 269     }
 270 
 271     // check for expected asm output from a volatile store
 272 
<span class="line-modified"> 273     private void checkstore(OutputAnalyzer output, String testType, boolean useBarriersForVolatile, boolean useCompressedOops) throws Throwable</span>
 274     {
 275         Iterator&lt;String&gt; iter = output.asLines().listIterator();
 276 
 277         String[] matches;
 278 
 279         // non object stores are straightforward
<span class="line-modified"> 280         if (!useBarriersForVolatile) {</span>
<span class="line-modified"> 281             // this is the sequence of instructions for all cases</span>












 282             matches = new String[] {
 283                 &quot;membar_release \\(elided\\)&quot;,
<span class="line-modified"> 284                 &quot;stlrw&quot;,</span>
 285                 &quot;membar_volatile \\(elided\\)&quot;,
 286                 &quot;ret&quot;
 287             };
<span class="line-modified"> 288         } else {</span>
<span class="line-modified"> 289             // this is the alternative sequence of instructions</span>






 290             matches = new String[] {
<span class="line-modified"> 291                 &quot;membar_release&quot;,</span>
<span class="line-modified"> 292                 &quot;dmb ish&quot;,</span>
<span class="line-modified"> 293                 &quot;strw&quot;,</span>

 294                 &quot;membar_volatile&quot;,
 295                 &quot;dmb ish&quot;,











 296                 &quot;ret&quot;
 297             };
<span class="line-modified"> 298         }</span>
<span class="line-removed"> 299 </span>
<span class="line-removed"> 300         checkCompile(iter, &quot;testInt&quot;, matches, output, true);</span>
<span class="line-removed"> 301 </span>
<span class="line-removed"> 302         // object stores will be as above except for when the GC</span>
<span class="line-removed"> 303         // introduces barriers for card marking</span>
<span class="line-removed"> 304 </span>
<span class="line-removed"> 305         if (!useBarriersForVolatile) {</span>
<span class="line-removed"> 306             switch (testType) {</span>
<span class="line-removed"> 307             default:</span>
<span class="line-removed"> 308                 // this is the basic sequence of instructions</span>
<span class="line-removed"> 309                 matches = new String[] {</span>
<span class="line-removed"> 310                     &quot;membar_release \\(elided\\)&quot;,</span>
<span class="line-removed"> 311                     useCompressedOops ? &quot;stlrw?&quot; : &quot;stlr&quot;,</span>
<span class="line-removed"> 312                     &quot;membar_volatile \\(elided\\)&quot;,</span>
<span class="line-removed"> 313                     &quot;ret&quot;</span>
<span class="line-removed"> 314                 };</span>
<span class="line-removed"> 315                 break;</span>
<span class="line-removed"> 316             case &quot;G1&quot;:</span>
<span class="line-removed"> 317                 // a card mark volatile barrier should be generated</span>
<span class="line-removed"> 318                 // before the card mark strb</span>
<span class="line-removed"> 319                 //</span>
<span class="line-removed"> 320                 // following the fix for 8225776 the G1 barrier is now</span>
<span class="line-removed"> 321                 // scheduled out of line after the membar volatile and</span>
<span class="line-removed"> 322                 // and subsequent return</span>
<span class="line-removed"> 323                 matches = new String[] {</span>
<span class="line-removed"> 324                     &quot;membar_release \\(elided\\)&quot;,</span>
<span class="line-removed"> 325                     useCompressedOops ? &quot;stlrw?&quot; : &quot;stlr&quot;,</span>
<span class="line-removed"> 326                     &quot;membar_volatile \\(elided\\)&quot;,</span>
<span class="line-removed"> 327                     &quot;ret&quot;,</span>
<span class="line-removed"> 328                     &quot;membar_volatile&quot;,</span>
<span class="line-removed"> 329                     &quot;dmb ish&quot;,</span>
<span class="line-removed"> 330                     &quot;strb&quot;</span>
<span class="line-removed"> 331                 };</span>
<span class="line-removed"> 332                 break;</span>
<span class="line-removed"> 333             case &quot;Shenandoah&quot;:</span>
<span class="line-removed"> 334             case &quot;ShenandoahIU&quot;:</span>
<span class="line-removed"> 335                  // Shenandoah generates normal object graphs for</span>
<span class="line-removed"> 336                  // volatile stores</span>
<span class="line-removed"> 337                 matches = new String[] {</span>
<span class="line-removed"> 338                     &quot;membar_release \\(elided\\)&quot;,</span>
<span class="line-removed"> 339                     useCompressedOops ? &quot;stlrw?&quot; : &quot;stlr&quot;,</span>
<span class="line-removed"> 340                     &quot;membar_volatile \\(elided\\)&quot;,</span>
<span class="line-removed"> 341                     &quot;ret&quot;</span>
<span class="line-removed"> 342                 };</span>
<span class="line-removed"> 343                 break;</span>
<span class="line-removed"> 344             }</span>
<span class="line-removed"> 345         } else {</span>
<span class="line-removed"> 346             switch (testType) {</span>
<span class="line-removed"> 347             default:</span>
<span class="line-removed"> 348                 // this is the basic sequence of instructions</span>
<span class="line-removed"> 349                 matches = new String[] {</span>
<span class="line-removed"> 350                     &quot;membar_release&quot;,</span>
<span class="line-removed"> 351                     &quot;dmb ish&quot;,</span>
<span class="line-removed"> 352                     useCompressedOops ? &quot;strw?&quot; : &quot;str&quot;,</span>
<span class="line-removed"> 353                     &quot;membar_volatile&quot;,</span>
<span class="line-removed"> 354                     &quot;dmb ish&quot;,</span>
<span class="line-removed"> 355                     &quot;ret&quot;</span>
<span class="line-removed"> 356                 };</span>
<span class="line-removed"> 357                 break;</span>
<span class="line-removed"> 358             case &quot;G1&quot;:</span>
<span class="line-removed"> 359                 // a card mark volatile barrier should be generated</span>
<span class="line-removed"> 360                 // before the card mark strb</span>
<span class="line-removed"> 361                 //</span>
<span class="line-removed"> 362                 // following the fix for 8225776 the G1 barrier is now</span>
<span class="line-removed"> 363                 // scheduled out of line after the membar volatile and</span>
<span class="line-removed"> 364                 // and subsequent return</span>
<span class="line-removed"> 365                 matches = new String[] {</span>
<span class="line-removed"> 366                     &quot;membar_release&quot;,</span>
<span class="line-removed"> 367                     &quot;dmb ish&quot;,</span>
<span class="line-removed"> 368                     useCompressedOops ? &quot;strw?&quot; : &quot;str&quot;,</span>
<span class="line-removed"> 369                     &quot;membar_volatile&quot;,</span>
<span class="line-removed"> 370                     &quot;dmb ish&quot;,</span>
<span class="line-removed"> 371                     &quot;ret&quot;,</span>
<span class="line-removed"> 372                     &quot;membar_volatile&quot;,</span>
<span class="line-removed"> 373                     &quot;dmb ish&quot;,</span>
<span class="line-removed"> 374                     &quot;strb&quot;</span>
<span class="line-removed"> 375                 };</span>
<span class="line-removed"> 376                 break;</span>
<span class="line-removed"> 377             case &quot;CMSCondMark&quot;:</span>
<span class="line-removed"> 378                 // a card mark volatile barrier should be generated</span>
<span class="line-removed"> 379                 // before the card mark strb from the StoreCM and the</span>
<span class="line-removed"> 380                 // storestore barrier from the StoreCM should be elided</span>
<span class="line-removed"> 381                 matches = new String[] {</span>
<span class="line-removed"> 382                     &quot;membar_release&quot;,</span>
<span class="line-removed"> 383                     &quot;dmb ish&quot;,</span>
<span class="line-removed"> 384                     useCompressedOops ? &quot;strw?&quot; : &quot;str&quot;,</span>
<span class="line-removed"> 385                     &quot;membar_volatile&quot;,</span>
<span class="line-removed"> 386                     &quot;dmb ish&quot;,</span>
<span class="line-removed"> 387                     &quot;storestore \\(elided\\)&quot;,</span>
<span class="line-removed"> 388                     &quot;strb&quot;,</span>
<span class="line-removed"> 389                     &quot;membar_volatile&quot;,</span>
<span class="line-removed"> 390                     &quot;dmb ish&quot;,</span>
<span class="line-removed"> 391                     &quot;ret&quot;</span>
<span class="line-removed"> 392                 };</span>
<span class="line-removed"> 393                 break;</span>
<span class="line-removed"> 394             case &quot;CMS&quot;:</span>
<span class="line-removed"> 395                 // a volatile card mark membar should not be generated</span>
<span class="line-removed"> 396                 // before the card mark strb from the StoreCM and the</span>
<span class="line-removed"> 397                 // storestore barrier from the StoreCM should be generated</span>
<span class="line-removed"> 398                 // as &quot;dmb ishst&quot;</span>
<span class="line-removed"> 399                 matches = new String[] {</span>
<span class="line-removed"> 400                     &quot;membar_release&quot;,</span>
<span class="line-removed"> 401                     &quot;dmb ish&quot;,</span>
<span class="line-removed"> 402                     useCompressedOops ? &quot;strw?&quot; : &quot;str&quot;,</span>
<span class="line-removed"> 403                     &quot;storestore&quot;,</span>
<span class="line-removed"> 404                     &quot;dmb ishst&quot;,</span>
<span class="line-removed"> 405                     &quot;strb&quot;,</span>
<span class="line-removed"> 406                     &quot;membar_volatile&quot;,</span>
<span class="line-removed"> 407                     &quot;dmb ish&quot;,</span>
<span class="line-removed"> 408                     &quot;ret&quot;</span>
<span class="line-removed"> 409                 };</span>
<span class="line-removed"> 410                 break;</span>
<span class="line-removed"> 411 </span>
<span class="line-removed"> 412             case &quot;Shenandoah&quot;:</span>
<span class="line-removed"> 413             case &quot;ShenandoahIU&quot;:</span>
<span class="line-removed"> 414                  // Shenandoah generates normal object graphs for</span>
<span class="line-removed"> 415                  // volatile stores</span>
<span class="line-removed"> 416                 matches = new String[] {</span>
<span class="line-removed"> 417                     &quot;membar_release&quot;,</span>
<span class="line-removed"> 418                     &quot;dmb ish&quot;,</span>
<span class="line-removed"> 419                     useCompressedOops ? &quot;strw?&quot; : &quot;str&quot;,</span>
<span class="line-removed"> 420                     &quot;membar_volatile&quot;,</span>
<span class="line-removed"> 421                     &quot;dmb ish&quot;,</span>
<span class="line-removed"> 422                     &quot;ret&quot;</span>
<span class="line-removed"> 423                 };</span>
<span class="line-removed"> 424                 break;</span>
<span class="line-removed"> 425             }</span>
 426         }
 427 
 428         checkCompile(iter, &quot;testObj&quot;, matches, output, true);
 429     }
 430 
 431     // check for expected asm output from a volatile cas
 432 
<span class="line-modified"> 433     private void checkcas(OutputAnalyzer output, String testType, boolean useBarriersForVolatile, boolean useCompressedOops) throws Throwable</span>
 434     {
 435         Iterator&lt;String&gt; iter = output.asLines().listIterator();
 436 
 437         String[] matches;
 438         String[][] tests = {
 439             { &quot;testInt&quot;, &quot;cmpxchgw&quot; },
 440             { &quot;testLong&quot;, &quot;cmpxchg&quot; },
 441             { &quot;testByte&quot;, &quot;cmpxchgb&quot; },
 442             { &quot;testShort&quot;, &quot;cmpxchgs&quot; },
 443         };
 444 
 445         for (String[] test : tests) {
 446             // non object stores are straightforward
<span class="line-modified"> 447             if (!useBarriersForVolatile) {</span>
<span class="line-modified"> 448                 // this is the sequence of instructions for all cases</span>
<span class="line-modified"> 449                 matches = new String[] {</span>
<span class="line-modified"> 450                     &quot;membar_release \\(elided\\)&quot;,</span>
<span class="line-modified"> 451                     test[1] + &quot;_acq&quot;,</span>
<span class="line-modified"> 452                     &quot;membar_acquire \\(elided\\)&quot;,</span>
<span class="line-modified"> 453                     &quot;ret&quot;</span>
<span class="line-removed"> 454                 };</span>
<span class="line-removed"> 455             } else {</span>
<span class="line-removed"> 456                 // this is the alternative sequence of instructions</span>
<span class="line-removed"> 457                 matches = new String[] {</span>
<span class="line-removed"> 458                     &quot;membar_release&quot;,</span>
<span class="line-removed"> 459                     &quot;dmb ish&quot;,</span>
<span class="line-removed"> 460                     test[1] + &quot; &quot;,</span>
<span class="line-removed"> 461                     &quot;membar_acquire&quot;,</span>
<span class="line-removed"> 462                     &quot;dmb ish&quot;,</span>
<span class="line-removed"> 463                     &quot;ret&quot;</span>
<span class="line-removed"> 464                 };</span>
<span class="line-removed"> 465             }</span>
<span class="line-removed"> 466 </span>
 467             checkCompile(iter, test[0], matches, output, true);
 468         }
 469 
 470         // object stores will be as above except for when the GC
 471         // introduces barriers for card marking
<span class="line-modified"> 472 </span>
<span class="line-modified"> 473         if (!useBarriersForVolatile) {</span>
<span class="line-modified"> 474             switch (testType) {</span>
<span class="line-modified"> 475             default:</span>
<span class="line-modified"> 476                 // this is the basic sequence of instructions</span>
<span class="line-modified"> 477                 matches = new String[] {</span>
<span class="line-modified"> 478                     &quot;membar_release \\(elided\\)&quot;,</span>
<span class="line-modified"> 479                     useCompressedOops ? &quot;cmpxchgw?_acq&quot; : &quot;cmpxchg_acq&quot;,</span>
<span class="line-modified"> 480                     &quot;strb&quot;,</span>
<span class="line-modified"> 481                     &quot;membar_acquire \\(elided\\)&quot;,</span>
<span class="line-modified"> 482                     &quot;ret&quot;</span>
<span class="line-modified"> 483                 };</span>
<span class="line-modified"> 484                 break;</span>
<span class="line-modified"> 485             case &quot;G1&quot;:</span>
<span class="line-modified"> 486                 // a card mark volatile barrier should be generated</span>
<span class="line-modified"> 487                 // before the card mark strb</span>
<span class="line-modified"> 488                 //</span>
<span class="line-modified"> 489                 // following the fix for 8225776 the G1 barrier is now</span>
<span class="line-modified"> 490                 // scheduled out of line after the membar acquire and</span>
<span class="line-modified"> 491                 // and subsequent return</span>
<span class="line-modified"> 492                 matches = new String[] {</span>
<span class="line-modified"> 493                     &quot;membar_release \\(elided\\)&quot;,</span>
<span class="line-modified"> 494                     useCompressedOops ? &quot;cmpxchgw?_acq&quot; : &quot;cmpxchg_acq&quot;,</span>
<span class="line-modified"> 495                     &quot;membar_acquire \\(elided\\)&quot;,</span>
<span class="line-modified"> 496                     &quot;ret&quot;,</span>
<span class="line-modified"> 497                     &quot;membar_volatile&quot;,</span>
<span class="line-modified"> 498                     &quot;dmb ish&quot;,</span>
<span class="line-modified"> 499                     &quot;strb&quot;</span>
<span class="line-modified"> 500                 };</span>
<span class="line-modified"> 501                 break;</span>
<span class="line-modified"> 502             case &quot;Shenandoah&quot;:</span>
<span class="line-modified"> 503             case &quot;ShenandoahIU&quot;:</span>
<span class="line-modified"> 504                 // For volatile CAS, Shenanodoah generates normal</span>
<span class="line-modified"> 505                 // graphs with a shenandoah-specific cmpxchg</span>
<span class="line-modified"> 506                 matches = new String[] {</span>
<span class="line-modified"> 507                     &quot;membar_release \\(elided\\)&quot;,</span>
<span class="line-modified"> 508                     useCompressedOops ? &quot;cmpxchgw?_acq_shenandoah&quot; : &quot;cmpxchg_acq_shenandoah&quot;,</span>
<span class="line-modified"> 509                     &quot;membar_acquire \\(elided\\)&quot;,</span>
<span class="line-modified"> 510                     &quot;ret&quot;</span>
<span class="line-removed"> 511                 };</span>
<span class="line-removed"> 512                 break;</span>
<span class="line-removed"> 513             }</span>
<span class="line-removed"> 514         } else {</span>
<span class="line-removed"> 515             switch (testType) {</span>
<span class="line-removed"> 516             default:</span>
<span class="line-removed"> 517                 // this is the basic sequence of instructions</span>
<span class="line-removed"> 518                 matches = new String[] {</span>
<span class="line-removed"> 519                     &quot;membar_release&quot;,</span>
<span class="line-removed"> 520                     &quot;dmb ish&quot;,</span>
<span class="line-removed"> 521                     useCompressedOops ? &quot;cmpxchgw? &quot; : &quot;cmpxchg &quot;,</span>
<span class="line-removed"> 522                     &quot;membar_acquire&quot;,</span>
<span class="line-removed"> 523                     &quot;dmb ish&quot;,</span>
<span class="line-removed"> 524                     &quot;ret&quot;</span>
<span class="line-removed"> 525                 };</span>
<span class="line-removed"> 526                 break;</span>
<span class="line-removed"> 527             case &quot;G1&quot;:</span>
<span class="line-removed"> 528                 // a card mark volatile barrier should be generated</span>
<span class="line-removed"> 529                 // before the card mark strb</span>
<span class="line-removed"> 530                 //</span>
<span class="line-removed"> 531                 // following the fix for 8225776 the G1 barrier is now</span>
<span class="line-removed"> 532                 // scheduled out of line after the membar acquire and</span>
<span class="line-removed"> 533                 // and subsequent return</span>
<span class="line-removed"> 534                 matches = new String[] {</span>
<span class="line-removed"> 535                     &quot;membar_release&quot;,</span>
<span class="line-removed"> 536                     &quot;dmb ish&quot;,</span>
<span class="line-removed"> 537                     useCompressedOops ? &quot;cmpxchgw? &quot; : &quot;cmpxchg &quot;,</span>
<span class="line-removed"> 538                     &quot;membar_acquire&quot;,</span>
<span class="line-removed"> 539                     &quot;dmb ish&quot;,</span>
<span class="line-removed"> 540                     &quot;ret&quot;,</span>
<span class="line-removed"> 541                     &quot;membar_volatile&quot;,</span>
<span class="line-removed"> 542                     &quot;dmb ish&quot;,</span>
<span class="line-removed"> 543                     &quot;strb&quot;</span>
<span class="line-removed"> 544                 };</span>
<span class="line-removed"> 545                 break;</span>
<span class="line-removed"> 546             case &quot;CMSCondMark&quot;:</span>
<span class="line-removed"> 547                 // a card mark volatile barrier should be generated</span>
<span class="line-removed"> 548                 // before the card mark strb from the StoreCM and the</span>
<span class="line-removed"> 549                 // storestore barrier from the StoreCM should be elided</span>
<span class="line-removed"> 550                 matches = new String[] {</span>
<span class="line-removed"> 551                     &quot;membar_release&quot;,</span>
<span class="line-removed"> 552                     &quot;dmb ish&quot;,</span>
<span class="line-removed"> 553                     useCompressedOops ? &quot;cmpxchgw? &quot; : &quot;cmpxchg &quot;,</span>
<span class="line-removed"> 554                     &quot;membar_volatile&quot;,</span>
<span class="line-removed"> 555                     &quot;dmb ish&quot;,</span>
<span class="line-removed"> 556                     &quot;storestore \\(elided\\)&quot;,</span>
<span class="line-removed"> 557                     &quot;strb&quot;,</span>
<span class="line-removed"> 558                     &quot;membar_acquire&quot;,</span>
<span class="line-removed"> 559                     &quot;dmb ish&quot;,</span>
<span class="line-removed"> 560                     &quot;ret&quot;</span>
<span class="line-removed"> 561                 };</span>
<span class="line-removed"> 562                 break;</span>
<span class="line-removed"> 563             case &quot;CMS&quot;:</span>
<span class="line-removed"> 564                 // a volatile card mark membar should not be generated</span>
<span class="line-removed"> 565                 // before the card mark strb from the StoreCM and the</span>
<span class="line-removed"> 566                 // storestore barrier from the StoreCM should be generated</span>
<span class="line-removed"> 567                 // as &quot;dmb ishst&quot;</span>
<span class="line-removed"> 568                 matches = new String[] {</span>
<span class="line-removed"> 569                     &quot;membar_release&quot;,</span>
<span class="line-removed"> 570                     &quot;dmb ish&quot;,</span>
<span class="line-removed"> 571                     useCompressedOops ? &quot;cmpxchgw? &quot; : &quot;cmpxchg &quot;,</span>
<span class="line-removed"> 572                     &quot;storestore&quot;,</span>
<span class="line-removed"> 573                     &quot;dmb ishst&quot;,</span>
<span class="line-removed"> 574                     &quot;strb&quot;,</span>
<span class="line-removed"> 575                     &quot;membar_acquire&quot;,</span>
<span class="line-removed"> 576                     &quot;dmb ish&quot;,</span>
<span class="line-removed"> 577                     &quot;ret&quot;</span>
<span class="line-removed"> 578                 };</span>
<span class="line-removed"> 579                 break;</span>
<span class="line-removed"> 580             case &quot;Shenandoah&quot;:</span>
<span class="line-removed"> 581             case &quot;ShenandoahIU&quot;:</span>
<span class="line-removed"> 582                 // For volatile CAS, Shenanodoah generates normal</span>
<span class="line-removed"> 583                 // graphs with a shenandoah-specific cmpxchg</span>
<span class="line-removed"> 584                 matches = new String[] {</span>
<span class="line-removed"> 585                     &quot;membar_release&quot;,</span>
<span class="line-removed"> 586                     &quot;dmb ish&quot;,</span>
<span class="line-removed"> 587                     useCompressedOops ? &quot;cmpxchgw?_shenandoah&quot; : &quot;cmpxchg_shenandoah&quot;,</span>
<span class="line-removed"> 588                     &quot;membar_acquire&quot;,</span>
<span class="line-removed"> 589                     &quot;dmb ish&quot;,</span>
<span class="line-removed"> 590                     &quot;ret&quot;</span>
<span class="line-removed"> 591                 };</span>
<span class="line-removed"> 592                 break;</span>
<span class="line-removed"> 593             }</span>
 594         }
<span class="line-removed"> 595 </span>
 596         checkCompile(iter, &quot;testObj&quot;, matches, output, true);
 597     }
 598 
<span class="line-modified"> 599     private void checkcae(OutputAnalyzer output, String testType, boolean useBarriersForVolatile, boolean useCompressedOops) throws Throwable</span>
 600     {
 601         ListIterator&lt;String&gt; iter = output.asLines().listIterator();
 602 
 603         String[] matches;
 604         String[][] tests = {
 605             { &quot;testInt&quot;, &quot;cmpxchgw&quot; },
 606             { &quot;testLong&quot;, &quot;cmpxchg&quot; },
 607             { &quot;testByte&quot;, &quot;cmpxchgb&quot; },
 608             { &quot;testShort&quot;, &quot;cmpxchgs&quot; },
 609         };
 610 
 611         for (String[] test : tests) {
 612             // non object stores are straightforward
<span class="line-modified"> 613             if (!useBarriersForVolatile) {</span>
<span class="line-modified"> 614                 // this is the sequence of instructions for all cases</span>
<span class="line-modified"> 615                 matches = new String[] {</span>
<span class="line-modified"> 616                     &quot;membar_release \\(elided\\)&quot;,</span>
<span class="line-modified"> 617                     test[1] + &quot;_acq&quot;,</span>
<span class="line-modified"> 618                     &quot;membar_acquire \\(elided\\)&quot;,</span>
<span class="line-modified"> 619                     &quot;ret&quot;</span>
<span class="line-removed"> 620                 };</span>
<span class="line-removed"> 621             } else {</span>
<span class="line-removed"> 622                 // this is the alternative sequence of instructions</span>
<span class="line-removed"> 623                 matches = new String[] {</span>
<span class="line-removed"> 624                     &quot;membar_release&quot;,</span>
<span class="line-removed"> 625                     &quot;dmb ish&quot;,</span>
<span class="line-removed"> 626                     test[1] + &quot; &quot;,</span>
<span class="line-removed"> 627                     &quot;membar_acquire&quot;,</span>
<span class="line-removed"> 628                     &quot;dmb ish&quot;,</span>
<span class="line-removed"> 629                     &quot;ret&quot;</span>
<span class="line-removed"> 630                 };</span>
<span class="line-removed"> 631             }</span>
<span class="line-removed"> 632 </span>
 633             checkCompile(iter, test[0], matches, output, true);
 634         }
 635 
 636         // object stores will be as above except for when the GC
 637         // introduces barriers for card marking










 638 
<span class="line-modified"> 639         if (!useBarriersForVolatile) {</span>
<span class="line-modified"> 640             switch (testType) {</span>
<span class="line-modified"> 641             default:</span>
<span class="line-modified"> 642                 // this is the basic sequence of instructions</span>
<span class="line-modified"> 643                 matches = new String[] {</span>
<span class="line-removed"> 644                     &quot;membar_release \\(elided\\)&quot;,</span>
<span class="line-removed"> 645                     &quot;strb&quot;,</span>
<span class="line-removed"> 646                     useCompressedOops ? &quot;cmpxchgw?_acq&quot; : &quot;cmpxchg_acq&quot;,</span>
<span class="line-removed"> 647                     &quot;membar_acquire \\(elided\\)&quot;,</span>
<span class="line-removed"> 648                     &quot;ret&quot;</span>
<span class="line-removed"> 649                 };</span>
 650 
<span class="line-removed"> 651                 // card marking store may be scheduled before or after</span>
<span class="line-removed"> 652                 // the cmpxchg so try both sequences.</span>
<span class="line-removed"> 653                 int idx = iter.nextIndex();</span>
<span class="line-removed"> 654                 if (!checkCompile(iter, &quot;testObj&quot;, matches, output, false)) {</span>
<span class="line-removed"> 655                     iter = output.asLines().listIterator(idx);</span>
<span class="line-removed"> 656 </span>
<span class="line-removed"> 657                     matches = new String[] {</span>
<span class="line-removed"> 658                         &quot;membar_release \\(elided\\)&quot;,</span>
<span class="line-removed"> 659                         useCompressedOops ? &quot;cmpxchgw?_acq&quot; : &quot;cmpxchg_acq&quot;,</span>
<span class="line-removed"> 660                         &quot;strb&quot;,</span>
<span class="line-removed"> 661                         &quot;membar_acquire \\(elided\\)&quot;,</span>
<span class="line-removed"> 662                         &quot;ret&quot;</span>
<span class="line-removed"> 663                     };</span>
<span class="line-removed"> 664 </span>
<span class="line-removed"> 665                     checkCompile(iter, &quot;testObj&quot;, matches, output, true);</span>
<span class="line-removed"> 666                 }</span>
<span class="line-removed"> 667                 return;</span>
<span class="line-removed"> 668 </span>
<span class="line-removed"> 669             case &quot;G1&quot;:</span>
<span class="line-removed"> 670                 // a card mark volatile barrier should be generated</span>
<span class="line-removed"> 671                 // before the card mark strb</span>
<span class="line-removed"> 672                 //</span>
<span class="line-removed"> 673                 // following the fix for 8225776 the G1 barrier is now</span>
<span class="line-removed"> 674                 // scheduled out of line after the membar acquire and</span>
<span class="line-removed"> 675                 // and subsequent return</span>
 676                 matches = new String[] {
 677                     &quot;membar_release \\(elided\\)&quot;,
 678                     useCompressedOops ? &quot;cmpxchgw?_acq&quot; : &quot;cmpxchg_acq&quot;,
<span class="line-removed"> 679                     &quot;membar_acquire \\(elided\\)&quot;,</span>
<span class="line-removed"> 680                     &quot;ret&quot;,</span>
<span class="line-removed"> 681                     &quot;membar_volatile&quot;,</span>
<span class="line-removed"> 682                     &quot;dmb ish&quot;,</span>
<span class="line-removed"> 683                     &quot;strb&quot;</span>
<span class="line-removed"> 684                 };</span>
<span class="line-removed"> 685                 break;</span>
<span class="line-removed"> 686             case &quot;Shenandoah&quot;:</span>
<span class="line-removed"> 687             case &quot;ShenandoahIU&quot;:</span>
<span class="line-removed"> 688                 // For volatile CAS, Shenanodoah generates normal</span>
<span class="line-removed"> 689                 // graphs with a shenandoah-specific cmpxchg</span>
<span class="line-removed"> 690                 matches = new String[] {</span>
<span class="line-removed"> 691                     &quot;membar_release \\(elided\\)&quot;,</span>
<span class="line-removed"> 692                     useCompressedOops ? &quot;cmpxchgw?_acq_shenandoah&quot; : &quot;cmpxchg_acq_shenandoah&quot;,</span>
<span class="line-removed"> 693                     &quot;membar_acquire \\(elided\\)&quot;,</span>
<span class="line-removed"> 694                     &quot;ret&quot;</span>
<span class="line-removed"> 695                 };</span>
<span class="line-removed"> 696                 break;</span>
<span class="line-removed"> 697             }</span>
<span class="line-removed"> 698         } else {</span>
<span class="line-removed"> 699             switch (testType) {</span>
<span class="line-removed"> 700             default:</span>
<span class="line-removed"> 701                 // this is the basic sequence of instructions</span>
<span class="line-removed"> 702                 matches = new String[] {</span>
<span class="line-removed"> 703                     &quot;membar_release&quot;,</span>
<span class="line-removed"> 704                     &quot;dmb ish&quot;,</span>
<span class="line-removed"> 705                     useCompressedOops ? &quot;cmpxchgw? &quot; : &quot;cmpxchg &quot;,</span>
<span class="line-removed"> 706                     &quot;membar_acquire&quot;,</span>
<span class="line-removed"> 707                     &quot;dmb ish&quot;,</span>
<span class="line-removed"> 708                     &quot;ret&quot;</span>
<span class="line-removed"> 709                 };</span>
<span class="line-removed"> 710                 break;</span>
<span class="line-removed"> 711             case &quot;G1&quot;:</span>
<span class="line-removed"> 712                 // a card mark volatile barrier should be generated</span>
<span class="line-removed"> 713                 // before the card mark strb</span>
<span class="line-removed"> 714                 //</span>
<span class="line-removed"> 715                 // following the fix for 8225776 the G1 barrier is now</span>
<span class="line-removed"> 716                 // scheduled out of line after the membar acquire and</span>
<span class="line-removed"> 717                 // and subsequent return</span>
<span class="line-removed"> 718                 matches = new String[] {</span>
<span class="line-removed"> 719                     &quot;membar_release&quot;,</span>
<span class="line-removed"> 720                     &quot;dmb ish&quot;,</span>
<span class="line-removed"> 721                     useCompressedOops ? &quot;cmpxchgw? &quot; : &quot;cmpxchg &quot;,</span>
<span class="line-removed"> 722                     &quot;membar_acquire&quot;,</span>
<span class="line-removed"> 723                     &quot;dmb ish&quot;,</span>
<span class="line-removed"> 724                     &quot;ret&quot;,</span>
<span class="line-removed"> 725                     &quot;membar_volatile&quot;,</span>
<span class="line-removed"> 726                     &quot;dmb ish&quot;,</span>
<span class="line-removed"> 727                     &quot;strb&quot;</span>
<span class="line-removed"> 728                 };</span>
<span class="line-removed"> 729                 break;</span>
<span class="line-removed"> 730             case &quot;CMSCondMark&quot;:</span>
<span class="line-removed"> 731                 // a card mark volatile barrier should be generated</span>
<span class="line-removed"> 732                 // before the card mark strb from the StoreCM and the</span>
<span class="line-removed"> 733                 // storestore barrier from the StoreCM should be elided</span>
<span class="line-removed"> 734                 matches = new String[] {</span>
<span class="line-removed"> 735                     &quot;membar_release&quot;,</span>
<span class="line-removed"> 736                     &quot;dmb ish&quot;,</span>
<span class="line-removed"> 737                     useCompressedOops ? &quot;cmpxchgw? &quot; : &quot;cmpxchg &quot;,</span>
<span class="line-removed"> 738                     &quot;membar_volatile&quot;,</span>
<span class="line-removed"> 739                     &quot;dmb ish&quot;,</span>
<span class="line-removed"> 740                     &quot;storestore \\(elided\\)&quot;,</span>
 741                     &quot;strb&quot;,
<span class="line-modified"> 742                     &quot;membar_acquire&quot;,</span>
<span class="line-removed"> 743                     &quot;dmb ish&quot;,</span>
<span class="line-removed"> 744                     &quot;ret&quot;</span>
<span class="line-removed"> 745                 };</span>
<span class="line-removed"> 746                 break;</span>
<span class="line-removed"> 747             case &quot;CMS&quot;:</span>
<span class="line-removed"> 748                 // a volatile card mark membar should not be generated</span>
<span class="line-removed"> 749                 // before the card mark strb from the StoreCM and the</span>
<span class="line-removed"> 750                 // storestore barrier from the StoreCM should be generated</span>
<span class="line-removed"> 751                 // as &quot;dmb ishst&quot;</span>
<span class="line-removed"> 752                 matches = new String[] {</span>
<span class="line-removed"> 753                     &quot;membar_release&quot;,</span>
<span class="line-removed"> 754                     &quot;dmb ish&quot;,</span>
<span class="line-removed"> 755                     useCompressedOops ? &quot;cmpxchgw? &quot; : &quot;cmpxchg &quot;,</span>
<span class="line-removed"> 756                     &quot;storestore&quot;,</span>
<span class="line-removed"> 757                     &quot;dmb ishst&quot;,</span>
<span class="line-removed"> 758                     &quot;strb&quot;,</span>
<span class="line-removed"> 759                     &quot;membar_acquire&quot;,</span>
<span class="line-removed"> 760                     &quot;dmb ish&quot;,</span>
<span class="line-removed"> 761                     &quot;ret&quot;</span>
<span class="line-removed"> 762                 };</span>
<span class="line-removed"> 763                 break;</span>
<span class="line-removed"> 764             case &quot;Shenandoah&quot;:</span>
<span class="line-removed"> 765             case &quot;ShenandoahIU&quot;:</span>
<span class="line-removed"> 766                 // For volatile CAS, Shenanodoah generates normal</span>
<span class="line-removed"> 767                 // graphs with a shenandoah-specific cmpxchg</span>
<span class="line-removed"> 768                 matches = new String[] {</span>
<span class="line-removed"> 769                     &quot;membar_release&quot;,</span>
<span class="line-removed"> 770                     &quot;dmb ish&quot;,</span>
<span class="line-removed"> 771                     useCompressedOops ? &quot;cmpxchgw?_shenandoah&quot; : &quot;cmpxchg_shenandoah&quot;,</span>
<span class="line-removed"> 772                     &quot;membar_acquire&quot;,</span>
<span class="line-removed"> 773                     &quot;dmb ish&quot;,</span>
 774                     &quot;ret&quot;
 775                 };
<span class="line-modified"> 776                 break;</span>

 777             }
<span class="line-modified"> 778         }</span>
 779 





























 780         checkCompile(iter, &quot;testObj&quot;, matches, output, true);
 781     }
 782 
<span class="line-modified"> 783     private void checkgas(OutputAnalyzer output, String testType, boolean useBarriersForVolatile, boolean useCompressedOops) throws Throwable</span>
 784     {
 785         Iterator&lt;String&gt; iter = output.asLines().listIterator();
 786 
 787         String[] matches;
 788         String[][] tests = {
 789             { &quot;testInt&quot;, &quot;atomic_xchgw&quot; },
 790             { &quot;testLong&quot;, &quot;atomic_xchg&quot; },
 791         };
 792 
 793         for (String[] test : tests) {
 794             // non object stores are straightforward
<span class="line-modified"> 795             if (!useBarriersForVolatile) {</span>
<span class="line-modified"> 796                 // this is the sequence of instructions for all cases</span>
<span class="line-modified"> 797                 matches = new String[] {</span>
<span class="line-modified"> 798                     &quot;membar_release \\(elided\\)&quot;,</span>
<span class="line-modified"> 799                     test[1] + &quot;_acq&quot;,</span>
<span class="line-modified"> 800                     &quot;membar_acquire \\(elided\\)&quot;,</span>
<span class="line-modified"> 801                     &quot;ret&quot;</span>
<span class="line-removed"> 802                 };</span>
<span class="line-removed"> 803             } else {</span>
<span class="line-removed"> 804                 // this is the alternative sequence of instructions</span>
<span class="line-removed"> 805                 matches = new String[] {</span>
<span class="line-removed"> 806                     &quot;membar_release&quot;,</span>
<span class="line-removed"> 807                     &quot;dmb ish&quot;,</span>
<span class="line-removed"> 808                     test[1] + &quot; &quot;,</span>
<span class="line-removed"> 809                     &quot;membar_acquire&quot;,</span>
<span class="line-removed"> 810                     &quot;dmb ish&quot;,</span>
<span class="line-removed"> 811                     &quot;ret&quot;</span>
<span class="line-removed"> 812                 };</span>
<span class="line-removed"> 813             }</span>
<span class="line-removed"> 814 </span>
 815             checkCompile(iter, test[0], matches, output, true);
 816         }
 817 
 818         // object stores will be as above except for when the GC
 819         // introduces barriers for card marking
<span class="line-modified"> 820 </span>
<span class="line-modified"> 821         if (!useBarriersForVolatile) {</span>
<span class="line-modified"> 822             switch (testType) {</span>
<span class="line-modified"> 823             default:</span>
<span class="line-modified"> 824                 // this is the basic sequence of instructions</span>
<span class="line-modified"> 825                 matches = new String[] {</span>
<span class="line-modified"> 826                     &quot;membar_release \\(elided\\)&quot;,</span>
<span class="line-modified"> 827                     useCompressedOops ? &quot;atomic_xchgw?_acq&quot; : &quot;atomic_xchg_acq&quot;,</span>
<span class="line-modified"> 828                     &quot;strb&quot;,</span>
<span class="line-modified"> 829                     &quot;membar_acquire \\(elided\\)&quot;,</span>
<span class="line-modified"> 830                     &quot;ret&quot;</span>
<span class="line-modified"> 831                 };</span>
<span class="line-modified"> 832                 break;</span>
<span class="line-modified"> 833             case &quot;G1&quot;:</span>
<span class="line-modified"> 834                 // a card mark volatile barrier should be generated</span>
<span class="line-modified"> 835                 // before the card mark strb</span>
<span class="line-modified"> 836                 //</span>
<span class="line-modified"> 837                 // following the fix for 8225776 the G1 barrier is now</span>
<span class="line-modified"> 838                 // scheduled out of line after the membar acquire and</span>
<span class="line-modified"> 839                 // and subsequent return</span>
<span class="line-modified"> 840                 matches = new String[] {</span>
<span class="line-modified"> 841                     &quot;membar_release \\(elided\\)&quot;,</span>
<span class="line-modified"> 842                     useCompressedOops ? &quot;atomic_xchgw?_acq&quot; : &quot;atomic_xchg_acq&quot;,</span>
<span class="line-modified"> 843                     &quot;membar_acquire \\(elided\\)&quot;,</span>
<span class="line-modified"> 844                     &quot;ret&quot;,</span>
<span class="line-modified"> 845                     &quot;membar_volatile&quot;,</span>
<span class="line-modified"> 846                     &quot;dmb ish&quot;,</span>
<span class="line-modified"> 847                     &quot;strb&quot;</span>
<span class="line-modified"> 848                 };</span>
<span class="line-modified"> 849                 break;</span>
<span class="line-modified"> 850             case &quot;Shenandoah&quot;:</span>
<span class="line-modified"> 851             case &quot;ShenandoahIU&quot;:</span>
<span class="line-modified"> 852                 matches = new String[] {</span>
<span class="line-modified"> 853                     &quot;membar_release \\(elided\\)&quot;,</span>
<span class="line-modified"> 854                     useCompressedOops ? &quot;atomic_xchgw?_acq&quot; : &quot;atomic_xchg_acq&quot;,</span>
<span class="line-modified"> 855                     &quot;membar_acquire \\(elided\\)&quot;,</span>
<span class="line-modified"> 856                     &quot;ret&quot;</span>
<span class="line-removed"> 857                 };</span>
<span class="line-removed"> 858                 break;</span>
<span class="line-removed"> 859             }</span>
<span class="line-removed"> 860         } else {</span>
<span class="line-removed"> 861             switch (testType) {</span>
<span class="line-removed"> 862             default:</span>
<span class="line-removed"> 863                 // this is the basic sequence of instructions</span>
<span class="line-removed"> 864                 matches = new String[] {</span>
<span class="line-removed"> 865                     &quot;membar_release&quot;,</span>
<span class="line-removed"> 866                     &quot;dmb ish&quot;,</span>
<span class="line-removed"> 867                     useCompressedOops ? &quot;atomic_xchgw? &quot; : &quot;atomic_xchg &quot;,</span>
<span class="line-removed"> 868                     &quot;membar_acquire&quot;,</span>
<span class="line-removed"> 869                     &quot;dmb ish&quot;,</span>
<span class="line-removed"> 870                     &quot;ret&quot;</span>
<span class="line-removed"> 871                 };</span>
<span class="line-removed"> 872                 break;</span>
<span class="line-removed"> 873             case &quot;G1&quot;:</span>
<span class="line-removed"> 874                 // a card mark volatile barrier should be generated</span>
<span class="line-removed"> 875                 // before the card mark strb</span>
<span class="line-removed"> 876                 //</span>
<span class="line-removed"> 877                 // following the fix for 8225776 the G1 barrier is now</span>
<span class="line-removed"> 878                 // scheduled out of line after the membar acquire and</span>
<span class="line-removed"> 879                 // and subsequent return</span>
<span class="line-removed"> 880                 matches = new String[] {</span>
<span class="line-removed"> 881                     &quot;membar_release&quot;,</span>
<span class="line-removed"> 882                     &quot;dmb ish&quot;,</span>
<span class="line-removed"> 883                     useCompressedOops ? &quot;atomic_xchgw? &quot; : &quot;atomic_xchg &quot;,</span>
<span class="line-removed"> 884                     &quot;membar_acquire&quot;,</span>
<span class="line-removed"> 885                     &quot;dmb ish&quot;,</span>
<span class="line-removed"> 886                     &quot;ret&quot;,</span>
<span class="line-removed"> 887                     &quot;membar_volatile&quot;,</span>
<span class="line-removed"> 888                     &quot;dmb ish&quot;,</span>
<span class="line-removed"> 889                     &quot;strb&quot;</span>
<span class="line-removed"> 890                 };</span>
<span class="line-removed"> 891                 break;</span>
<span class="line-removed"> 892             case &quot;CMSCondMark&quot;:</span>
<span class="line-removed"> 893                 // a card mark volatile barrier should be generated</span>
<span class="line-removed"> 894                 // before the card mark strb from the StoreCM and the</span>
<span class="line-removed"> 895                 // storestore barrier from the StoreCM should be elided</span>
<span class="line-removed"> 896                 matches = new String[] {</span>
<span class="line-removed"> 897                     &quot;membar_release&quot;,</span>
<span class="line-removed"> 898                     &quot;dmb ish&quot;,</span>
<span class="line-removed"> 899                     useCompressedOops ? &quot;atomic_xchgw? &quot; : &quot;atomic_xchg &quot;,</span>
<span class="line-removed"> 900                     &quot;membar_volatile&quot;,</span>
<span class="line-removed"> 901                     &quot;dmb ish&quot;,</span>
<span class="line-removed"> 902                     &quot;storestore \\(elided\\)&quot;,</span>
<span class="line-removed"> 903                     &quot;strb&quot;,</span>
<span class="line-removed"> 904                     &quot;membar_acquire&quot;,</span>
<span class="line-removed"> 905                     &quot;dmb ish&quot;,</span>
<span class="line-removed"> 906                     &quot;ret&quot;</span>
<span class="line-removed"> 907                 };</span>
<span class="line-removed"> 908                 break;</span>
<span class="line-removed"> 909             case &quot;CMS&quot;:</span>
<span class="line-removed"> 910                 // a volatile card mark membar should not be generated</span>
<span class="line-removed"> 911                 // before the card mark strb from the StoreCM and the</span>
<span class="line-removed"> 912                 // storestore barrier from the StoreCM should be generated</span>
<span class="line-removed"> 913                 // as &quot;dmb ishst&quot;</span>
<span class="line-removed"> 914                 matches = new String[] {</span>
<span class="line-removed"> 915                     &quot;membar_release&quot;,</span>
<span class="line-removed"> 916                     &quot;dmb ish&quot;,</span>
<span class="line-removed"> 917                     useCompressedOops ? &quot;atomic_xchgw? &quot; : &quot;atomic_xchg &quot;,</span>
<span class="line-removed"> 918                     &quot;storestore&quot;,</span>
<span class="line-removed"> 919                     &quot;dmb ishst&quot;,</span>
<span class="line-removed"> 920                     &quot;strb&quot;,</span>
<span class="line-removed"> 921                     &quot;membar_acquire&quot;,</span>
<span class="line-removed"> 922                     &quot;dmb ish&quot;,</span>
<span class="line-removed"> 923                     &quot;ret&quot;</span>
<span class="line-removed"> 924                 };</span>
<span class="line-removed"> 925                 break;</span>
<span class="line-removed"> 926             case &quot;Shenandoah&quot;:</span>
<span class="line-removed"> 927             case &quot;ShenandoahIU&quot;:</span>
<span class="line-removed"> 928                 matches = new String[] {</span>
<span class="line-removed"> 929                     &quot;membar_release&quot;,</span>
<span class="line-removed"> 930                     &quot;dmb ish&quot;,</span>
<span class="line-removed"> 931                     useCompressedOops ? &quot;atomic_xchgw? &quot; : &quot;atomic_xchg &quot;,</span>
<span class="line-removed"> 932                     &quot;membar_acquire&quot;,</span>
<span class="line-removed"> 933                     &quot;dmb ish&quot;,</span>
<span class="line-removed"> 934                     &quot;ret&quot;</span>
<span class="line-removed"> 935                 };</span>
<span class="line-removed"> 936                 break;</span>
<span class="line-removed"> 937             }</span>
 938         }
 939 
 940         checkCompile(iter, &quot;testObj&quot;, matches, output, true);
 941     }
 942 
<span class="line-modified"> 943     private void checkgaa(OutputAnalyzer output, String testType, boolean useBarriersForVolatile) throws Throwable</span>
 944     {
 945         Iterator&lt;String&gt; iter = output.asLines().listIterator();
 946 
 947         String[] matches;
 948         String[][] tests = {
 949             { &quot;testInt&quot;, &quot;get_and_addI&quot; },
 950             { &quot;testLong&quot;, &quot;get_and_addL&quot; },
 951         };
 952 
 953         for (String[] test : tests) {
 954             // non object stores are straightforward
<span class="line-modified"> 955             if (!useBarriersForVolatile) {</span>
<span class="line-modified"> 956                 // this is the sequence of instructions for all cases</span>
<span class="line-modified"> 957                 matches = new String[] {</span>
<span class="line-modified"> 958                     &quot;membar_release \\(elided\\)&quot;,</span>
<span class="line-modified"> 959                     test[1] + &quot;_acq&quot;,</span>
<span class="line-modified"> 960                     &quot;membar_acquire \\(elided\\)&quot;,</span>
<span class="line-modified"> 961                     &quot;ret&quot;</span>
<span class="line-removed"> 962                 };</span>
<span class="line-removed"> 963             } else {</span>
<span class="line-removed"> 964                 // this is the alternative sequence of instructions</span>
<span class="line-removed"> 965                 matches = new String[] {</span>
<span class="line-removed"> 966                     &quot;membar_release&quot;,</span>
<span class="line-removed"> 967                     &quot;dmb ish&quot;,</span>
<span class="line-removed"> 968                     test[1] + &quot; &quot;,</span>
<span class="line-removed"> 969                     &quot;membar_acquire&quot;,</span>
<span class="line-removed"> 970                     &quot;dmb ish&quot;,</span>
<span class="line-removed"> 971                     &quot;ret&quot;</span>
<span class="line-removed"> 972                 };</span>
<span class="line-removed"> 973             }</span>
<span class="line-removed"> 974 </span>
 975             checkCompile(iter, test[0], matches, output, true);
 976         }
 977 
 978     }
 979 
 980     // perform a check appropriate to the classname
 981 
<span class="line-modified"> 982     private void checkoutput(OutputAnalyzer output, String classname, String testType, boolean useBarriersForVolatile, boolean useCompressedOops) throws Throwable</span>
 983     {
 984         // trace call to allow eyeball check of what is being checked
 985         System.out.println(&quot;checkoutput(&quot; +
 986                            classname + &quot;, &quot; +
<span class="line-modified"> 987                            testType + &quot;, &quot; +</span>
<span class="line-removed"> 988                            useBarriersForVolatile + &quot;)\n&quot; +</span>
 989                            output.getOutput());
 990 
 991         switch (classname) {
 992         case &quot;TestVolatileLoad&quot;:
<span class="line-modified"> 993             checkload(output, testType, useBarriersForVolatile, useCompressedOops);</span>
 994             break;
 995         case &quot;TestVolatileStore&quot;:
<span class="line-modified"> 996             checkstore(output, testType, useBarriersForVolatile, useCompressedOops);</span>
 997             break;
 998         case &quot;TestUnsafeVolatileLoad&quot;:
<span class="line-modified"> 999             checkload(output, testType, useBarriersForVolatile, useCompressedOops);</span>
1000             break;
1001         case &quot;TestUnsafeVolatileStore&quot;:
<span class="line-modified">1002             checkstore(output, testType, useBarriersForVolatile, useCompressedOops);</span>
1003             break;
1004         case &quot;TestUnsafeVolatileCAS&quot;:
1005         case &quot;TestUnsafeVolatileWeakCAS&quot;:
<span class="line-modified">1006             checkcas(output, testType, useBarriersForVolatile, useCompressedOops);</span>
1007             break;
1008         case &quot;TestUnsafeVolatileCAE&quot;:
<span class="line-modified">1009             checkcae(output, testType, useBarriersForVolatile, useCompressedOops);</span>
1010             break;
1011         case &quot;TestUnsafeVolatileGAS&quot;:
<span class="line-modified">1012             checkgas(output, testType, useBarriersForVolatile, useCompressedOops);</span>
1013             break;
1014         case &quot;TestUnsafeVolatileGAA&quot;:
<span class="line-modified">1015             checkgaa(output, testType, useBarriersForVolatile);</span>
1016             break;
1017         }
1018     }
1019 }
</pre>
</td>
<td>
<hr />
<pre>
   1 /*
<span class="line-modified">   2  * Copyright (c) 2018, 2020, Red Hat, Inc. All rights reserved.</span>
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.
   8  *
   9  * This code is distributed in the hope that it will be useful, but WITHOUT
  10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  */
</pre>
<hr />
<pre>
  57 import jdk.test.lib.process.ProcessTools;
  58 import sun.hotspot.WhiteBox;
  59 
  60 // runner class that spawns a new JVM to exercises a combination of
  61 // volatile MemOp and GC. The ops are compiled with the dmb --&gt;
  62 // ldar/stlr transforms either enabled or disabled. this runner parses
  63 // the PrintOptoAssembly output checking that the generated code is
  64 // correct.
  65 
  66 public class TestVolatiles {
  67     public void runtest(String classname, String testType) throws Throwable {
  68         // n.b. clients omit the package name for the class
  69         String fullclassname = &quot;compiler.c2.aarch64.&quot; + classname;
  70         // build up a command line for the spawned JVM
  71         String[] procArgs;
  72         int argcount;
  73         // add one or two extra arguments according to test type
  74         // i.e. GC type plus GC conifg
  75         switch(testType) {
  76         case &quot;G1&quot;:
<span class="line-modified">  77             argcount = 8;</span>
  78             procArgs = new String[argcount];
  79             procArgs[argcount - 2] = &quot;-XX:+UseG1GC&quot;;
  80             break;
  81         case &quot;Parallel&quot;:
<span class="line-modified">  82             argcount = 8;</span>
  83             procArgs = new String[argcount];
  84             procArgs[argcount - 2] = &quot;-XX:+UseParallelGC&quot;;
  85             break;
  86         case &quot;Serial&quot;:
<span class="line-modified">  87             argcount = 8;</span>
  88             procArgs = new String[argcount];
  89             procArgs[argcount - 2] = &quot;-XX:+UseSerialGC&quot;;
  90             break;
  91         case &quot;Shenandoah&quot;:
<span class="line-modified">  92             argcount = 9;</span>
  93             procArgs = new String[argcount];
  94             procArgs[argcount - 3] = &quot;-XX:+UnlockExperimentalVMOptions&quot;;
  95             procArgs[argcount - 2] = &quot;-XX:+UseShenandoahGC&quot;;
  96             break;
  97         case &quot;ShenandoahIU&quot;:
<span class="line-modified">  98             argcount = 10;</span>
  99             procArgs = new String[argcount];
 100             procArgs[argcount - 4] = &quot;-XX:+UnlockExperimentalVMOptions&quot;;
 101             procArgs[argcount - 3] = &quot;-XX:+UseShenandoahGC&quot;;
 102             procArgs[argcount - 2] = &quot;-XX:ShenandoahGCMode=iu&quot;;
 103             break;
 104         default:
 105             throw new RuntimeException(&quot;unexpected test type &quot; + testType);
 106         }
 107 
 108         // fill in arguments common to all cases
 109 
 110         // the first round of test enables transform of barriers to
 111         // use acquiring loads and releasing stores by setting arg
 112         // zero appropriately. this arg is reset in the second run to
 113         // disable the transform.
 114 
<span class="line-modified"> 115         procArgs[0] = &quot;-XX:+UseCompressedOops&quot;;</span>
<span class="line-modified"> 116         procArgs[1] = &quot;-XX:-TieredCompilation&quot;;</span>
<span class="line-modified"> 117         procArgs[2] = &quot;-XX:+PrintOptoAssembly&quot;;</span>
<span class="line-modified"> 118         procArgs[3] = &quot;-XX:CompileCommand=compileonly,&quot; + fullclassname + &quot;::&quot; + &quot;test*&quot;;</span>
<span class="line-modified"> 119         procArgs[4] = &quot;--add-exports&quot;;</span>
<span class="line-modified"> 120         procArgs[5] = &quot;java.base/jdk.internal.misc=ALL-UNNAMED&quot;;</span>


 121         procArgs[argcount - 1] = fullclassname;
 122 
<span class="line-modified"> 123         runtest(classname, testType, true, procArgs);</span>





 124 
 125         if (!classname.equals(&quot;TestUnsafeVolatileGAA&quot;)) {
<span class="line-modified"> 126             procArgs[0] = &quot;-XX:-UseCompressedOops&quot;;</span>
<span class="line-modified"> 127             runtest(classname, testType, false, procArgs);</span>




 128         }
 129     }
 130 
 131 
<span class="line-modified"> 132     public void runtest(String classname, String testType, boolean useCompressedOops, String[] procArgs) throws Throwable {</span>
 133         ProcessBuilder pb = ProcessTools.createJavaProcessBuilder(procArgs);
 134         OutputAnalyzer output = new OutputAnalyzer(pb.start());
 135 
 136         output.stderrShouldBeEmptyIgnoreVMWarnings();
 137         output.stdoutShouldNotBeEmpty();
 138         output.shouldHaveExitValue(0);
 139 
 140         // check the output for the correct asm sequence as
 141         // appropriate to test class, test type and whether transform
 142         // was applied
 143 
<span class="line-modified"> 144         checkoutput(output, classname, testType, useCompressedOops);</span>
 145     }
 146 
 147     // skip through output returning a line containing the desireed
 148     // substring or null
 149     private String skipTo(Iterator&lt;String&gt; iter, String substring)
 150     {
 151         while (iter.hasNext()) {
 152             String nextLine = iter.next();
 153             if (nextLine.matches(&quot;.*&quot; + substring + &quot;.*&quot;)) {
 154                 return nextLine;
 155             }
 156         }
 157         return null;
 158     }
 159 
 160     // locate the start of compiler output for the desired method and
 161     // then check that each expected instruction occurs in the output
 162     // in the order supplied. throw an excpetion if not found.
 163     // n.b. the spawned JVM&#39;s output is included in the exception
 164     // message to make it easeir to identify what is missing.
</pre>
<hr />
<pre>
 195             if (do_throw) {
 196                 throw new RuntimeException(&quot;Wrong method &quot; + match + &quot;!\n  -- expecting &quot; + methodname + &quot;\n\n&quot; + output.getOutput());
 197             }
 198             return false;
 199         }
 200         // make sure we can match each expected term in order
 201         for (String s : expected) {
 202             match = skipTo(iter, s);
 203             if (match == null) {
 204                 if (do_throw) {
 205                     throw new RuntimeException(&quot;Missing expected output &quot; + s + &quot;!\n\n&quot; + output.getOutput());
 206                 }
 207                 return false;
 208             }
 209         }
 210         return true;
 211     }
 212 
 213     // check for expected asm output from a volatile load
 214 
<span class="line-modified"> 215     private void checkload(OutputAnalyzer output, String testType, boolean useCompressedOops) throws Throwable</span>
 216     {
 217         Iterator&lt;String&gt; iter = output.asLines().listIterator();
 218 
 219         // we shoud see this same sequence for normal or unsafe volatile load
 220         // for both int and Object fields
 221 
 222         String[] matches;
<span class="line-modified"> 223         matches = new String[] {</span>
<span class="line-modified"> 224             &quot;ldarw&quot;,</span>
<span class="line-modified"> 225             &quot;membar_acquire \\(elided\\)&quot;,</span>
<span class="line-modified"> 226             &quot;ret&quot;</span>
<span class="line-modified"> 227         };</span>











 228         checkCompile(iter, &quot;testInt&quot;, matches, output, true);
 229 
<span class="line-modified"> 230         matches = new String[] {</span>
<span class="line-modified"> 231             useCompressedOops ? &quot;ldarw?&quot; : &quot;ldar&quot;,</span>
<span class="line-modified"> 232             &quot;membar_acquire \\(elided\\)&quot;,</span>
<span class="line-modified"> 233             &quot;ret&quot;</span>
<span class="line-modified"> 234         };</span>










 235         checkCompile(iter, &quot;testObj&quot;, matches, output, true);
 236 
 237     }
 238 
 239     // check for expected asm output from a volatile store
 240 
<span class="line-modified"> 241     private void checkstore(OutputAnalyzer output, String testType, boolean useCompressedOops) throws Throwable</span>
 242     {
 243         Iterator&lt;String&gt; iter = output.asLines().listIterator();
 244 
 245         String[] matches;
 246 
 247         // non object stores are straightforward
<span class="line-modified"> 248         // this is the sequence of instructions for all cases</span>
<span class="line-modified"> 249         matches = new String[] {</span>
<span class="line-added"> 250             &quot;membar_release \\(elided\\)&quot;,</span>
<span class="line-added"> 251             &quot;stlrw&quot;,</span>
<span class="line-added"> 252             &quot;membar_volatile \\(elided\\)&quot;,</span>
<span class="line-added"> 253             &quot;ret&quot;</span>
<span class="line-added"> 254         };</span>
<span class="line-added"> 255         checkCompile(iter, &quot;testInt&quot;, matches, output, true);</span>
<span class="line-added"> 256 </span>
<span class="line-added"> 257         // object stores will be as above except for when the GC</span>
<span class="line-added"> 258         // introduces barriers for card marking</span>
<span class="line-added"> 259         switch (testType) {</span>
<span class="line-added"> 260         default:</span>
<span class="line-added"> 261             // this is the basic sequence of instructions</span>
 262             matches = new String[] {
 263                 &quot;membar_release \\(elided\\)&quot;,
<span class="line-modified"> 264                 useCompressedOops ? &quot;stlrw?&quot; : &quot;stlr&quot;,</span>
 265                 &quot;membar_volatile \\(elided\\)&quot;,
 266                 &quot;ret&quot;
 267             };
<span class="line-modified"> 268             break;</span>
<span class="line-modified"> 269         case &quot;G1&quot;:</span>
<span class="line-added"> 270             // a card mark volatile barrier should be generated</span>
<span class="line-added"> 271             // before the card mark strb</span>
<span class="line-added"> 272             //</span>
<span class="line-added"> 273             // following the fix for 8225776 the G1 barrier is now</span>
<span class="line-added"> 274             // scheduled out of line after the membar volatile and</span>
<span class="line-added"> 275             // and subsequent return</span>
 276             matches = new String[] {
<span class="line-modified"> 277                 &quot;membar_release \\(elided\\)&quot;,</span>
<span class="line-modified"> 278                 useCompressedOops ? &quot;stlrw?&quot; : &quot;stlr&quot;,</span>
<span class="line-modified"> 279                 &quot;membar_volatile \\(elided\\)&quot;,</span>
<span class="line-added"> 280                 &quot;ret&quot;,</span>
 281                 &quot;membar_volatile&quot;,
 282                 &quot;dmb ish&quot;,
<span class="line-added"> 283                 &quot;strb&quot;</span>
<span class="line-added"> 284             };</span>
<span class="line-added"> 285             break;</span>
<span class="line-added"> 286         case &quot;Shenandoah&quot;:</span>
<span class="line-added"> 287         case &quot;ShenandoahIU&quot;:</span>
<span class="line-added"> 288              // Shenandoah generates normal object graphs for</span>
<span class="line-added"> 289              // volatile stores</span>
<span class="line-added"> 290             matches = new String[] {</span>
<span class="line-added"> 291                 &quot;membar_release \\(elided\\)&quot;,</span>
<span class="line-added"> 292                 useCompressedOops ? &quot;stlrw?&quot; : &quot;stlr&quot;,</span>
<span class="line-added"> 293                 &quot;membar_volatile \\(elided\\)&quot;,</span>
 294                 &quot;ret&quot;
 295             };
<span class="line-modified"> 296             break;</span>































































































































 297         }
 298 
 299         checkCompile(iter, &quot;testObj&quot;, matches, output, true);
 300     }
 301 
 302     // check for expected asm output from a volatile cas
 303 
<span class="line-modified"> 304     private void checkcas(OutputAnalyzer output, String testType, boolean useCompressedOops) throws Throwable</span>
 305     {
 306         Iterator&lt;String&gt; iter = output.asLines().listIterator();
 307 
 308         String[] matches;
 309         String[][] tests = {
 310             { &quot;testInt&quot;, &quot;cmpxchgw&quot; },
 311             { &quot;testLong&quot;, &quot;cmpxchg&quot; },
 312             { &quot;testByte&quot;, &quot;cmpxchgb&quot; },
 313             { &quot;testShort&quot;, &quot;cmpxchgs&quot; },
 314         };
 315 
 316         for (String[] test : tests) {
 317             // non object stores are straightforward
<span class="line-modified"> 318             // this is the sequence of instructions for all cases</span>
<span class="line-modified"> 319             matches = new String[] {</span>
<span class="line-modified"> 320                 &quot;membar_release \\(elided\\)&quot;,</span>
<span class="line-modified"> 321                 test[1] + &quot;_acq&quot;,</span>
<span class="line-modified"> 322                 &quot;membar_acquire \\(elided\\)&quot;,</span>
<span class="line-modified"> 323                 &quot;ret&quot;</span>
<span class="line-modified"> 324             };</span>













 325             checkCompile(iter, test[0], matches, output, true);
 326         }
 327 
 328         // object stores will be as above except for when the GC
 329         // introduces barriers for card marking
<span class="line-modified"> 330         switch (testType) {</span>
<span class="line-modified"> 331         default:</span>
<span class="line-modified"> 332             // this is the basic sequence of instructions</span>
<span class="line-modified"> 333             matches = new String[] {</span>
<span class="line-modified"> 334                 &quot;membar_release \\(elided\\)&quot;,</span>
<span class="line-modified"> 335                 useCompressedOops ? &quot;cmpxchgw?_acq&quot; : &quot;cmpxchg_acq&quot;,</span>
<span class="line-modified"> 336                 &quot;strb&quot;,</span>
<span class="line-modified"> 337                 &quot;membar_acquire \\(elided\\)&quot;,</span>
<span class="line-modified"> 338                 &quot;ret&quot;</span>
<span class="line-modified"> 339             };</span>
<span class="line-modified"> 340             break;</span>
<span class="line-modified"> 341         case &quot;G1&quot;:</span>
<span class="line-modified"> 342             // a card mark volatile barrier should be generated</span>
<span class="line-modified"> 343             // before the card mark strb</span>
<span class="line-modified"> 344             //</span>
<span class="line-modified"> 345             // following the fix for 8225776 the G1 barrier is now</span>
<span class="line-modified"> 346             // scheduled out of line after the membar acquire and</span>
<span class="line-modified"> 347             // and subsequent return</span>
<span class="line-modified"> 348             matches = new String[] {</span>
<span class="line-modified"> 349                 &quot;membar_release \\(elided\\)&quot;,</span>
<span class="line-modified"> 350                 useCompressedOops ? &quot;cmpxchgw?_acq&quot; : &quot;cmpxchg_acq&quot;,</span>
<span class="line-modified"> 351                 &quot;membar_acquire \\(elided\\)&quot;,</span>
<span class="line-modified"> 352                 &quot;ret&quot;,</span>
<span class="line-modified"> 353                 &quot;membar_volatile&quot;,</span>
<span class="line-modified"> 354                 &quot;dmb ish&quot;,</span>
<span class="line-modified"> 355                 &quot;strb&quot;</span>
<span class="line-modified"> 356             };</span>
<span class="line-modified"> 357             break;</span>
<span class="line-modified"> 358         case &quot;Shenandoah&quot;:</span>
<span class="line-modified"> 359         case &quot;ShenandoahIU&quot;:</span>
<span class="line-modified"> 360             // For volatile CAS, Shenanodoah generates normal</span>
<span class="line-modified"> 361             // graphs with a shenandoah-specific cmpxchg</span>
<span class="line-modified"> 362             matches = new String[] {</span>
<span class="line-modified"> 363                 &quot;membar_release \\(elided\\)&quot;,</span>
<span class="line-modified"> 364                 useCompressedOops ? &quot;cmpxchgw?_acq_shenandoah&quot; : &quot;cmpxchg_acq_shenandoah&quot;,</span>
<span class="line-modified"> 365                 &quot;membar_acquire \\(elided\\)&quot;,</span>
<span class="line-modified"> 366                 &quot;ret&quot;</span>
<span class="line-modified"> 367             };</span>
<span class="line-modified"> 368             break;</span>



















































































 369         }

 370         checkCompile(iter, &quot;testObj&quot;, matches, output, true);
 371     }
 372 
<span class="line-modified"> 373     private void checkcae(OutputAnalyzer output, String testType, boolean useCompressedOops) throws Throwable</span>
 374     {
 375         ListIterator&lt;String&gt; iter = output.asLines().listIterator();
 376 
 377         String[] matches;
 378         String[][] tests = {
 379             { &quot;testInt&quot;, &quot;cmpxchgw&quot; },
 380             { &quot;testLong&quot;, &quot;cmpxchg&quot; },
 381             { &quot;testByte&quot;, &quot;cmpxchgb&quot; },
 382             { &quot;testShort&quot;, &quot;cmpxchgs&quot; },
 383         };
 384 
 385         for (String[] test : tests) {
 386             // non object stores are straightforward
<span class="line-modified"> 387             // this is the sequence of instructions for all cases</span>
<span class="line-modified"> 388             matches = new String[] {</span>
<span class="line-modified"> 389                 &quot;membar_release \\(elided\\)&quot;,</span>
<span class="line-modified"> 390                 test[1] + &quot;_acq&quot;,</span>
<span class="line-modified"> 391                 &quot;membar_acquire \\(elided\\)&quot;,</span>
<span class="line-modified"> 392                 &quot;ret&quot;</span>
<span class="line-modified"> 393             };</span>













 394             checkCompile(iter, test[0], matches, output, true);
 395         }
 396 
 397         // object stores will be as above except for when the GC
 398         // introduces barriers for card marking
<span class="line-added"> 399         switch (testType) {</span>
<span class="line-added"> 400         default:</span>
<span class="line-added"> 401             // this is the basic sequence of instructions</span>
<span class="line-added"> 402             matches = new String[] {</span>
<span class="line-added"> 403                 &quot;membar_release \\(elided\\)&quot;,</span>
<span class="line-added"> 404                 &quot;strb&quot;,</span>
<span class="line-added"> 405                 useCompressedOops ? &quot;cmpxchgw?_acq&quot; : &quot;cmpxchg_acq&quot;,</span>
<span class="line-added"> 406                 &quot;membar_acquire \\(elided\\)&quot;,</span>
<span class="line-added"> 407                 &quot;ret&quot;</span>
<span class="line-added"> 408             };</span>
 409 
<span class="line-modified"> 410             // card marking store may be scheduled before or after</span>
<span class="line-modified"> 411             // the cmpxchg so try both sequences.</span>
<span class="line-modified"> 412             int idx = iter.nextIndex();</span>
<span class="line-modified"> 413             if (!checkCompile(iter, &quot;testObj&quot;, matches, output, false)) {</span>
<span class="line-modified"> 414                 iter = output.asLines().listIterator(idx);</span>






 415 

























 416                 matches = new String[] {
 417                     &quot;membar_release \\(elided\\)&quot;,
 418                     useCompressedOops ? &quot;cmpxchgw?_acq&quot; : &quot;cmpxchg_acq&quot;,






























































 419                     &quot;strb&quot;,
<span class="line-modified"> 420                     &quot;membar_acquire \\(elided\\)&quot;,</span>































 421                     &quot;ret&quot;
 422                 };
<span class="line-modified"> 423 </span>
<span class="line-added"> 424                 checkCompile(iter, &quot;testObj&quot;, matches, output, true);</span>
 425             }
<span class="line-modified"> 426             return;</span>
 427 
<span class="line-added"> 428         case &quot;G1&quot;:</span>
<span class="line-added"> 429             // a card mark volatile barrier should be generated</span>
<span class="line-added"> 430             // before the card mark strb</span>
<span class="line-added"> 431             //</span>
<span class="line-added"> 432             // following the fix for 8225776 the G1 barrier is now</span>
<span class="line-added"> 433             // scheduled out of line after the membar acquire and</span>
<span class="line-added"> 434             // and subsequent return</span>
<span class="line-added"> 435             matches = new String[] {</span>
<span class="line-added"> 436                 &quot;membar_release \\(elided\\)&quot;,</span>
<span class="line-added"> 437                 useCompressedOops ? &quot;cmpxchgw?_acq&quot; : &quot;cmpxchg_acq&quot;,</span>
<span class="line-added"> 438                 &quot;membar_acquire \\(elided\\)&quot;,</span>
<span class="line-added"> 439                 &quot;ret&quot;,</span>
<span class="line-added"> 440                 &quot;membar_volatile&quot;,</span>
<span class="line-added"> 441                 &quot;dmb ish&quot;,</span>
<span class="line-added"> 442                 &quot;strb&quot;</span>
<span class="line-added"> 443             };</span>
<span class="line-added"> 444             break;</span>
<span class="line-added"> 445         case &quot;Shenandoah&quot;:</span>
<span class="line-added"> 446         case &quot;ShenandoahIU&quot;:</span>
<span class="line-added"> 447             // For volatile CAS, Shenanodoah generates normal</span>
<span class="line-added"> 448             // graphs with a shenandoah-specific cmpxchg</span>
<span class="line-added"> 449             matches = new String[] {</span>
<span class="line-added"> 450                 &quot;membar_release \\(elided\\)&quot;,</span>
<span class="line-added"> 451                 useCompressedOops ? &quot;cmpxchgw?_acq_shenandoah&quot; : &quot;cmpxchg_acq_shenandoah&quot;,</span>
<span class="line-added"> 452                 &quot;membar_acquire \\(elided\\)&quot;,</span>
<span class="line-added"> 453                 &quot;ret&quot;</span>
<span class="line-added"> 454             };</span>
<span class="line-added"> 455             break;</span>
<span class="line-added"> 456         }</span>
 457         checkCompile(iter, &quot;testObj&quot;, matches, output, true);
 458     }
 459 
<span class="line-modified"> 460     private void checkgas(OutputAnalyzer output, String testType, boolean useCompressedOops) throws Throwable</span>
 461     {
 462         Iterator&lt;String&gt; iter = output.asLines().listIterator();
 463 
 464         String[] matches;
 465         String[][] tests = {
 466             { &quot;testInt&quot;, &quot;atomic_xchgw&quot; },
 467             { &quot;testLong&quot;, &quot;atomic_xchg&quot; },
 468         };
 469 
 470         for (String[] test : tests) {
 471             // non object stores are straightforward
<span class="line-modified"> 472             // this is the sequence of instructions for all cases</span>
<span class="line-modified"> 473             matches = new String[] {</span>
<span class="line-modified"> 474                 &quot;membar_release \\(elided\\)&quot;,</span>
<span class="line-modified"> 475                 test[1] + &quot;_acq&quot;,</span>
<span class="line-modified"> 476                 &quot;membar_acquire \\(elided\\)&quot;,</span>
<span class="line-modified"> 477                 &quot;ret&quot;</span>
<span class="line-modified"> 478             };</span>













 479             checkCompile(iter, test[0], matches, output, true);
 480         }
 481 
 482         // object stores will be as above except for when the GC
 483         // introduces barriers for card marking
<span class="line-modified"> 484         switch (testType) {</span>
<span class="line-modified"> 485         default:</span>
<span class="line-modified"> 486             // this is the basic sequence of instructions</span>
<span class="line-modified"> 487             matches = new String[] {</span>
<span class="line-modified"> 488                 &quot;membar_release \\(elided\\)&quot;,</span>
<span class="line-modified"> 489                 useCompressedOops ? &quot;atomic_xchgw?_acq&quot; : &quot;atomic_xchg_acq&quot;,</span>
<span class="line-modified"> 490                 &quot;strb&quot;,</span>
<span class="line-modified"> 491                 &quot;membar_acquire \\(elided\\)&quot;,</span>
<span class="line-modified"> 492                 &quot;ret&quot;</span>
<span class="line-modified"> 493             };</span>
<span class="line-modified"> 494             break;</span>
<span class="line-modified"> 495         case &quot;G1&quot;:</span>
<span class="line-modified"> 496             // a card mark volatile barrier should be generated</span>
<span class="line-modified"> 497             // before the card mark strb</span>
<span class="line-modified"> 498             //</span>
<span class="line-modified"> 499             // following the fix for 8225776 the G1 barrier is now</span>
<span class="line-modified"> 500             // scheduled out of line after the membar acquire and</span>
<span class="line-modified"> 501             // and subsequent return</span>
<span class="line-modified"> 502             matches = new String[] {</span>
<span class="line-modified"> 503                 &quot;membar_release \\(elided\\)&quot;,</span>
<span class="line-modified"> 504                 useCompressedOops ? &quot;atomic_xchgw?_acq&quot; : &quot;atomic_xchg_acq&quot;,</span>
<span class="line-modified"> 505                 &quot;membar_acquire \\(elided\\)&quot;,</span>
<span class="line-modified"> 506                 &quot;ret&quot;,</span>
<span class="line-modified"> 507                 &quot;membar_volatile&quot;,</span>
<span class="line-modified"> 508                 &quot;dmb ish&quot;,</span>
<span class="line-modified"> 509                 &quot;strb&quot;</span>
<span class="line-modified"> 510             };</span>
<span class="line-modified"> 511             break;</span>
<span class="line-modified"> 512         case &quot;Shenandoah&quot;:</span>
<span class="line-modified"> 513         case &quot;ShenandoahIU&quot;:</span>
<span class="line-modified"> 514             matches = new String[] {</span>
<span class="line-modified"> 515                 &quot;membar_release \\(elided\\)&quot;,</span>
<span class="line-modified"> 516                 useCompressedOops ? &quot;atomic_xchgw?_acq&quot; : &quot;atomic_xchg_acq&quot;,</span>
<span class="line-modified"> 517                 &quot;membar_acquire \\(elided\\)&quot;,</span>
<span class="line-modified"> 518                 &quot;ret&quot;</span>
<span class="line-modified"> 519             };</span>
<span class="line-modified"> 520             break;</span>

















































































 521         }
 522 
 523         checkCompile(iter, &quot;testObj&quot;, matches, output, true);
 524     }
 525 
<span class="line-modified"> 526     private void checkgaa(OutputAnalyzer output, String testType) throws Throwable</span>
 527     {
 528         Iterator&lt;String&gt; iter = output.asLines().listIterator();
 529 
 530         String[] matches;
 531         String[][] tests = {
 532             { &quot;testInt&quot;, &quot;get_and_addI&quot; },
 533             { &quot;testLong&quot;, &quot;get_and_addL&quot; },
 534         };
 535 
 536         for (String[] test : tests) {
 537             // non object stores are straightforward
<span class="line-modified"> 538             // this is the sequence of instructions for all cases</span>
<span class="line-modified"> 539             matches = new String[] {</span>
<span class="line-modified"> 540                 &quot;membar_release \\(elided\\)&quot;,</span>
<span class="line-modified"> 541                 test[1] + &quot;_acq&quot;,</span>
<span class="line-modified"> 542                 &quot;membar_acquire \\(elided\\)&quot;,</span>
<span class="line-modified"> 543                 &quot;ret&quot;</span>
<span class="line-modified"> 544             };</span>













 545             checkCompile(iter, test[0], matches, output, true);
 546         }
 547 
 548     }
 549 
 550     // perform a check appropriate to the classname
 551 
<span class="line-modified"> 552     private void checkoutput(OutputAnalyzer output, String classname, String testType, boolean useCompressedOops) throws Throwable</span>
 553     {
 554         // trace call to allow eyeball check of what is being checked
 555         System.out.println(&quot;checkoutput(&quot; +
 556                            classname + &quot;, &quot; +
<span class="line-modified"> 557                            testType + &quot;)\n&quot; +</span>

 558                            output.getOutput());
 559 
 560         switch (classname) {
 561         case &quot;TestVolatileLoad&quot;:
<span class="line-modified"> 562             checkload(output, testType, useCompressedOops);</span>
 563             break;
 564         case &quot;TestVolatileStore&quot;:
<span class="line-modified"> 565             checkstore(output, testType, useCompressedOops);</span>
 566             break;
 567         case &quot;TestUnsafeVolatileLoad&quot;:
<span class="line-modified"> 568             checkload(output, testType, useCompressedOops);</span>
 569             break;
 570         case &quot;TestUnsafeVolatileStore&quot;:
<span class="line-modified"> 571             checkstore(output, testType, useCompressedOops);</span>
 572             break;
 573         case &quot;TestUnsafeVolatileCAS&quot;:
 574         case &quot;TestUnsafeVolatileWeakCAS&quot;:
<span class="line-modified"> 575             checkcas(output, testType, useCompressedOops);</span>
 576             break;
 577         case &quot;TestUnsafeVolatileCAE&quot;:
<span class="line-modified"> 578             checkcae(output, testType, useCompressedOops);</span>
 579             break;
 580         case &quot;TestUnsafeVolatileGAS&quot;:
<span class="line-modified"> 581             checkgas(output, testType, useCompressedOops);</span>
 582             break;
 583         case &quot;TestUnsafeVolatileGAA&quot;:
<span class="line-modified"> 584             checkgaa(output, testType);</span>
 585             break;
 586         }
 587     }
 588 }
</pre>
</td>
</tr>
</table>
<center><a href="../../../ProblemList.txt.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="../../jvmci/events/JvmciNotifyBootstrapFinishedEventTest.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>