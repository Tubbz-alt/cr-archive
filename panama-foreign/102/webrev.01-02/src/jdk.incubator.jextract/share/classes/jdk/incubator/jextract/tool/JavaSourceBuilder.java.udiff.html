<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff src/jdk.incubator.jextract/share/classes/jdk/incubator/jextract/tool/JavaSourceBuilder.java</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="ConstantHelper.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="OutputFactory.java.udiff.html" target="_top">next &gt;</a></center>    <h2>src/jdk.incubator.jextract/share/classes/jdk/incubator/jextract/tool/JavaSourceBuilder.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -39,10 +39,14 @@</span>
   * A helper class to generate header interface class in source form.
   * After aggregating various constituents of a .java source, build
   * method is called to get overall generated source string.
   */
  class JavaSourceBuilder {
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     private static final String PUB_CLS_MODS = &quot;public final &quot;;</span>
<span class="udiff-line-added">+     private static final String PUB_MODS = &quot;public static final &quot;;</span>
<span class="udiff-line-added">+ </span>
      private final String pkgName;
      private final String[] libraryNames;
      // buffer
      protected StringBuffer sb;
      // current line alignment (number of 4-spaces)
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -60,37 +64,15 @@</span>
  
      JavaSourceBuilder(String pkgName, String[] libraryNames) {
          this(0, pkgName, libraryNames);
      }
  
<span class="udiff-line-removed">-     final String PUB_CLS_MODS = &quot;public final &quot;;</span>
<span class="udiff-line-removed">-     final String PUB_MODS = &quot;public static final &quot;;</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     private void addPackagePrefix() {</span>
<span class="udiff-line-removed">-         assert pkgName.indexOf(&#39;/&#39;) == -1 : &quot;package name invalid: &quot; + pkgName;</span>
<span class="udiff-line-removed">-         sb.append(&quot;// Generated by jextract\n\n&quot;);</span>
<span class="udiff-line-removed">-         if (!pkgName.isEmpty()) {</span>
<span class="udiff-line-removed">-             sb.append(&quot;package &quot;);</span>
<span class="udiff-line-removed">-             sb.append(pkgName);</span>
<span class="udiff-line-removed">-             sb.append(&quot;;\n\n&quot;);</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     private void addImportSection() {</span>
<span class="udiff-line-removed">-         sb.append(&quot;import java.lang.invoke.MethodHandle;\n&quot;);</span>
<span class="udiff-line-removed">-         sb.append(&quot;import java.lang.invoke.VarHandle;\n&quot;);</span>
<span class="udiff-line-removed">-         sb.append(&quot;import jdk.incubator.foreign.*;\n&quot;);</span>
<span class="udiff-line-removed">-         sb.append(&quot;import jdk.incubator.foreign.MemoryLayout.PathElement;\n&quot;);</span>
<span class="udiff-line-removed">-         sb.append(&quot;import static &quot;);</span>
<span class="udiff-line-removed">-         sb.append(OutputFactory.C_LANG_CONSTANTS_HOLDER);</span>
<span class="udiff-line-removed">-         sb.append(&quot;.*;\n&quot;);</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- </span>
      public void classBegin(String name) {
          className = name;
          String qualName = pkgName.isEmpty() ? name : pkgName + &quot;.&quot; + name;
<span class="udiff-line-modified-removed">-         constantHelper = new ConstantHelper(qualName, ClassDesc.of(pkgName, &quot;RuntimeHelper&quot;), libraryNames);</span>
<span class="udiff-line-modified-added">+         constantHelper = new ConstantHelper(qualName,</span>
<span class="udiff-line-added">+                 ClassDesc.of(pkgName, &quot;RuntimeHelper&quot;), ClassDesc.of(pkgName, &quot;Cstring&quot;), libraryNames);</span>
  
          addPackagePrefix();
          addImportSection();
  
          indent();
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -102,82 +84,44 @@</span>
      public void classEnd() {
          indent();
          sb.append(&quot;}\n\n&quot;);
      }
  
<span class="udiff-line-modified-removed">-     private String getterCall(DirectMethodHandleDesc desc) {</span>
<span class="udiff-line-removed">-         return desc.owner().displayName() + &quot;.&quot; + desc.methodName() + &quot;()&quot;;</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     private void emitForwardGetter(DirectMethodHandleDesc desc) {</span>
<span class="udiff-line-removed">-         incrAlign();</span>
<span class="udiff-line-removed">-         indent();</span>
<span class="udiff-line-removed">-         sb.append(PUB_MODS + displayName(desc.invocationType().returnType()) + &quot; &quot; + desc.methodName() + &quot;() {\n&quot;);</span>
<span class="udiff-line-removed">-         incrAlign();</span>
<span class="udiff-line-removed">-         indent();</span>
<span class="udiff-line-removed">-         sb.append(&quot;return &quot; + getterCall(desc) + &quot;;\n&quot;);</span>
<span class="udiff-line-removed">-         decrAlign();</span>
<span class="udiff-line-removed">-         indent();</span>
<span class="udiff-line-removed">-         sb.append(&quot;}\n&quot;);</span>
<span class="udiff-line-removed">-         decrAlign();</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     private String displayName(ClassDesc returnType) {</span>
<span class="udiff-line-removed">-         return returnType.displayName(); // TODO shorten based on imports</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     private String getFunction(String javaName, FunctionDescriptor fDesc) {</span>
<span class="udiff-line-removed">-         return getterCall(constantHelper.addFunctionDesc(javaName, fDesc));</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     private String getMethodHandle(String javaName, String nativeName, MethodType mt, FunctionDescriptor fDesc, boolean varargs) {</span>
<span class="udiff-line-removed">-         return getterCall(constantHelper.addMethodHandle(javaName, nativeName, mt, fDesc, varargs));</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     private String getVarHandle(String javaName, String nativeName, MemoryLayout layout, Class&lt;?&gt; type, MemoryLayout parentLayout) {</span>
<span class="udiff-line-removed">-         return getterCall(constantHelper.addVarHandle(javaName, nativeName, layout, type, parentLayout));</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     private String getAddress(String javaName, String nativeName) {</span>
<span class="udiff-line-removed">-         return getterCall(constantHelper.addAddress(javaName, nativeName));</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     public void addLayout(String javaName, MemoryLayout layout) {</span>
<span class="udiff-line-modified-added">+     public void addLayoutGetter(String javaName, MemoryLayout layout) {</span>
          emitForwardGetter(constantHelper.addLayout(javaName, layout));
      }
  
<span class="udiff-line-modified-removed">-     public void addVarHandle(String javaName, String nativeName, MemoryLayout layout, Class&lt;?&gt; type, MemoryLayout parentLayout) {</span>
<span class="udiff-line-modified-added">+     public void addVarHandleGetter(String javaName, String nativeName, MemoryLayout layout, Class&lt;?&gt; type, MemoryLayout parentLayout) {</span>
          emitForwardGetter(constantHelper.addVarHandle(javaName, nativeName, layout, type, parentLayout));
      }
  
<span class="udiff-line-modified-removed">-     public void addMethodHandle(String javaName, String nativeName, MethodType mtype, FunctionDescriptor desc, boolean varargs) {</span>
<span class="udiff-line-modified-added">+     public void addMethodHandleGetter(String javaName, String nativeName, MethodType mtype, FunctionDescriptor desc, boolean varargs) {</span>
          emitForwardGetter(constantHelper.addMethodHandle(javaName, nativeName, mtype, desc, varargs));
      }
  
<span class="udiff-line-modified-removed">-     public void addAddress(String javaName, String nativeName) {</span>
<span class="udiff-line-modified-added">+     public void addAddressGetter(String javaName, String nativeName) {</span>
          emitForwardGetter(constantHelper.addAddress(javaName, nativeName));
      }
  
<span class="udiff-line-modified-removed">-     public void addConstant(String javaName, Class&lt;?&gt; type, Object value) {</span>
<span class="udiff-line-modified-added">+     public void addConstantGetter(String javaName, Class&lt;?&gt; type, Object value) {</span>
          emitForwardGetter(constantHelper.addConstant(javaName, type, value));
      }
  
      public void addFunctionalFactory(String className, MethodType mtype, FunctionDescriptor fDesc) {
          incrAlign();
          indent();
          sb.append(PUB_MODS + &quot;MemoryAddress &quot; + className + &quot;$make(&quot; + className + &quot; fi) {\n&quot;);
          incrAlign();
          indent();
<span class="udiff-line-modified-removed">-         sb.append(&quot;return RuntimeHelper.upcallStub(&quot; + className + &quot;.class, fi, &quot; + getFunction(className, fDesc) + &quot;, &quot; +</span>
<span class="udiff-line-modified-added">+         sb.append(&quot;return RuntimeHelper.upcallStub(&quot; + className + &quot;.class, fi, &quot; + functionGetCallString(className, fDesc) + &quot;, &quot; +</span>
                  &quot;\&quot;&quot; + mtype.toMethodDescriptorString() + &quot;\&quot;);\n&quot;);
          decrAlign();
          indent();
          sb.append(&quot;}\n&quot;);
          decrAlign();
      }
  
<span class="udiff-line-removed">- </span>
      public void addStaticFunctionWrapper(String javaName, String nativeName, MethodType mtype, FunctionDescriptor desc, boolean varargs, List&lt;String&gt; paramNames) {
          incrAlign();
          indent();
          sb.append(PUB_MODS + mtype.returnType().getName() + &quot; &quot; + javaName + &quot; (&quot;);
          String delim = &quot;&quot;;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -207,11 +151,11 @@</span>
          incrAlign();
          indent();
          if (!mtype.returnType().equals(void.class)) {
              sb.append(&quot;return (&quot; + mtype.returnType().getName() + &quot;)&quot;);
          }
<span class="udiff-line-modified-removed">-         sb.append(getMethodHandle(javaName, nativeName, mtype, desc, varargs) + &quot;.invokeExact(&quot; + String.join(&quot;, &quot;, pNames) + &quot;);\n&quot;);</span>
<span class="udiff-line-modified-added">+         sb.append(methodHandleGetCallString(javaName, nativeName, mtype, desc, varargs) + &quot;.invokeExact(&quot; + String.join(&quot;, &quot;, pNames) + &quot;);\n&quot;);</span>
          decrAlign();
          indent();
          sb.append(&quot;} catch (Throwable ex) {\n&quot;);
          incrAlign();
          indent();
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -251,13 +195,13 @@</span>
          String param = parentLayout != null ? (MemorySegment.class.getName() + &quot; seg&quot;) : &quot;&quot;;
          sb.append(PUB_MODS + type.getName() + &quot; &quot; + javaName + &quot;$get(&quot; + param + &quot;) {\n&quot;);
          incrAlign();
          indent();
          String vhParam = parentLayout != null ?
<span class="udiff-line-modified-removed">-                 &quot;seg.baseAddress()&quot; : getAddress(javaName, nativeName);</span>
<span class="udiff-line-modified-added">+                 &quot;seg.baseAddress()&quot; : addressGetCallString(javaName, nativeName);</span>
          sb.append(&quot;return (&quot; + type.getName() + &quot;)&quot;
<span class="udiff-line-modified-removed">-                 + getVarHandle(javaName, nativeName, layout, type, parentLayout) + &quot;.get(&quot; + vhParam + &quot;);\n&quot;);</span>
<span class="udiff-line-modified-added">+                 + varHandleGetCallString(javaName, nativeName, layout, type, parentLayout) + &quot;.get(&quot; + vhParam + &quot;);\n&quot;);</span>
          decrAlign();
          indent();
          sb.append(&quot;}\n&quot;);
          decrAlign();
      }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -268,12 +212,12 @@</span>
          String param = parentLayout != null ? (MemorySegment.class.getName() + &quot; seg, &quot;) : &quot;&quot;;
          sb.append(PUB_MODS + &quot;void &quot; + javaName + &quot;$set(&quot; + param + type.getName() + &quot; x) {\n&quot;);
          incrAlign();
          indent();
          String vhParam = parentLayout != null ?
<span class="udiff-line-modified-removed">-                 &quot;seg.baseAddress()&quot; : getAddress(javaName, nativeName);</span>
<span class="udiff-line-modified-removed">-         sb.append(getVarHandle(javaName, nativeName, layout, type, parentLayout) + &quot;.set(&quot; + vhParam + &quot;, x);\n&quot;);</span>
<span class="udiff-line-modified-added">+                 &quot;seg.baseAddress()&quot; : addressGetCallString(javaName, nativeName);</span>
<span class="udiff-line-modified-added">+         sb.append(varHandleGetCallString(javaName, nativeName, layout, type, parentLayout) + &quot;.set(&quot; + vhParam + &quot;, x);\n&quot;);</span>
          decrAlign();
          indent();
          sb.append(&quot;}\n&quot;);
          decrAlign();
      }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -284,10 +228,69 @@</span>
          List&lt;JavaFileObject&gt; outputs = new ArrayList&lt;&gt;(constantHelper.getClasses());
          outputs.add(Utils.fileFromString(pkgName, className, res));
          return outputs;
      }
  
<span class="udiff-line-added">+     // Utility</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     private void addPackagePrefix() {</span>
<span class="udiff-line-added">+         assert pkgName.indexOf(&#39;/&#39;) == -1 : &quot;package name invalid: &quot; + pkgName;</span>
<span class="udiff-line-added">+         sb.append(&quot;// Generated by jextract\n\n&quot;);</span>
<span class="udiff-line-added">+         if (!pkgName.isEmpty()) {</span>
<span class="udiff-line-added">+             sb.append(&quot;package &quot;);</span>
<span class="udiff-line-added">+             sb.append(pkgName);</span>
<span class="udiff-line-added">+             sb.append(&quot;;\n\n&quot;);</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     private void addImportSection() {</span>
<span class="udiff-line-added">+         sb.append(&quot;import java.lang.invoke.MethodHandle;\n&quot;);</span>
<span class="udiff-line-added">+         sb.append(&quot;import java.lang.invoke.VarHandle;\n&quot;);</span>
<span class="udiff-line-added">+         sb.append(&quot;import jdk.incubator.foreign.*;\n&quot;);</span>
<span class="udiff-line-added">+         sb.append(&quot;import jdk.incubator.foreign.MemoryLayout.PathElement;\n&quot;);</span>
<span class="udiff-line-added">+         sb.append(&quot;import static &quot;);</span>
<span class="udiff-line-added">+         sb.append(OutputFactory.C_LANG_CONSTANTS_HOLDER);</span>
<span class="udiff-line-added">+         sb.append(&quot;.*;\n&quot;);</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     private void emitForwardGetter(DirectMethodHandleDesc desc) {</span>
<span class="udiff-line-added">+         incrAlign();</span>
<span class="udiff-line-added">+         indent();</span>
<span class="udiff-line-added">+         sb.append(PUB_MODS + displayName(desc.invocationType().returnType()) + &quot; &quot; + desc.methodName() + &quot;() {\n&quot;);</span>
<span class="udiff-line-added">+         incrAlign();</span>
<span class="udiff-line-added">+         indent();</span>
<span class="udiff-line-added">+         sb.append(&quot;return &quot; + getCallString(desc) + &quot;;\n&quot;);</span>
<span class="udiff-line-added">+         decrAlign();</span>
<span class="udiff-line-added">+         indent();</span>
<span class="udiff-line-added">+         sb.append(&quot;}\n&quot;);</span>
<span class="udiff-line-added">+         decrAlign();</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     private String getCallString(DirectMethodHandleDesc desc) {</span>
<span class="udiff-line-added">+         return desc.owner().displayName() + &quot;.&quot; + desc.methodName() + &quot;()&quot;;</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     private String displayName(ClassDesc returnType) {</span>
<span class="udiff-line-added">+         return returnType.displayName(); // TODO shorten based on imports</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     private String functionGetCallString(String javaName, FunctionDescriptor fDesc) {</span>
<span class="udiff-line-added">+         return getCallString(constantHelper.addFunctionDesc(javaName, fDesc));</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     private String methodHandleGetCallString(String javaName, String nativeName, MethodType mt, FunctionDescriptor fDesc, boolean varargs) {</span>
<span class="udiff-line-added">+         return getCallString(constantHelper.addMethodHandle(javaName, nativeName, mt, fDesc, varargs));</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     private String varHandleGetCallString(String javaName, String nativeName, MemoryLayout layout, Class&lt;?&gt; type, MemoryLayout parentLayout) {</span>
<span class="udiff-line-added">+         return getCallString(constantHelper.addVarHandle(javaName, nativeName, layout, type, parentLayout));</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     private String addressGetCallString(String javaName, String nativeName) {</span>
<span class="udiff-line-added">+         return getCallString(constantHelper.addAddress(javaName, nativeName));</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
      private void indent() {
          for (int i = 0; i &lt; align; i++) {
              sb.append(&quot;    &quot;);
          }
      }
</pre>
<center><a href="ConstantHelper.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="OutputFactory.java.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>