<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff src/jdk.incubator.jextract/share/classes/jdk/incubator/jextract/tool/JavaSourceBuilder.java</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="../../../../../../../jdk.incubator.foreign/share/classes/jdk/incubator/foreign/MemoryLayouts.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="Main.java.udiff.html" target="_top">next &gt;</a></center>    <h2>src/jdk.incubator.jextract/share/classes/jdk/incubator/jextract/tool/JavaSourceBuilder.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -22,354 +22,179 @@</span>
   * or visit www.oracle.com if you need additional information or have any
   * questions.
   */
  package jdk.incubator.jextract.tool;
  
<span class="udiff-line-removed">- import jdk.incubator.jextract.Declaration;</span>
  import jdk.incubator.foreign.FunctionDescriptor;
<span class="udiff-line-removed">- import jdk.incubator.foreign.GroupLayout;</span>
<span class="udiff-line-removed">- import jdk.incubator.foreign.MemoryAddress;</span>
  import jdk.incubator.foreign.MemoryLayout;
  import jdk.incubator.foreign.MemorySegment;
<span class="udiff-line-removed">- import jdk.incubator.foreign.SequenceLayout;</span>
<span class="udiff-line-removed">- import jdk.incubator.foreign.SystemABI;</span>
<span class="udiff-line-removed">- import jdk.incubator.foreign.ValueLayout;</span>
<span class="udiff-line-removed">- import jdk.internal.foreign.InternalForeign;</span>
  
<span class="udiff-line-added">+ import javax.tools.JavaFileObject;</span>
<span class="udiff-line-added">+ import java.lang.constant.ClassDesc;</span>
<span class="udiff-line-added">+ import java.lang.constant.DirectMethodHandleDesc;</span>
  import java.lang.invoke.MethodType;
  import java.util.ArrayList;
  import java.util.List;
<span class="udiff-line-removed">- import java.util.stream.Collectors;</span>
<span class="udiff-line-removed">- import java.util.stream.Stream;</span>
<span class="udiff-line-removed">- import javax.lang.model.SourceVersion;</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">- import static jdk.incubator.foreign.SystemABI.NATIVE_TYPE;</span>
  
  /**
   * A helper class to generate header interface class in source form.
   * After aggregating various constituents of a .java source, build
   * method is called to get overall generated source string.
   */
  class JavaSourceBuilder {
<span class="udiff-line-modified-removed">-     private static final String ABI = InternalForeign.getInstancePrivileged().getSystemABI().name();</span>
<span class="udiff-line-modified-added">+     private final String pkgName;</span>
<span class="udiff-line-added">+     private final String[] libraryNames;</span>
      // buffer
      protected StringBuffer sb;
      // current line alignment (number of 4-spaces)
      protected int align;
  
<span class="udiff-line-modified-removed">-     JavaSourceBuilder(int align) {</span>
<span class="udiff-line-modified-added">+     private String className = null;</span>
<span class="udiff-line-added">+     private ConstantHelper constantHelper;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     JavaSourceBuilder(int align, String pkgName, String[] libraryNames) {</span>
          this.align = align;
<span class="udiff-line-added">+         this.libraryNames = libraryNames;</span>
          this.sb = new StringBuffer();
<span class="udiff-line-added">+         this.pkgName = pkgName;</span>
      }
  
<span class="udiff-line-modified-removed">-     JavaSourceBuilder() {</span>
<span class="udiff-line-modified-removed">-         this(0);</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     protected int align() {</span>
<span class="udiff-line-removed">-         return align;</span>
<span class="udiff-line-modified-added">+     JavaSourceBuilder(String pkgName, String[] libraryNames) {</span>
<span class="udiff-line-modified-added">+         this(0, pkgName, libraryNames);</span>
      }
  
      final String PUB_CLS_MODS = &quot;public final &quot;;
      final String PUB_MODS = &quot;public static final &quot;;
<span class="udiff-line-removed">-     final String PRI_MODS = &quot;private static final &quot;;</span>
  
<span class="udiff-line-modified-removed">-     protected void addPackagePrefix(String pkgName) {</span>
<span class="udiff-line-modified-added">+     private void addPackagePrefix() {</span>
          assert pkgName.indexOf(&#39;/&#39;) == -1 : &quot;package name invalid: &quot; + pkgName;
          sb.append(&quot;// Generated by jextract\n\n&quot;);
          if (!pkgName.isEmpty()) {
              sb.append(&quot;package &quot;);
              sb.append(pkgName);
              sb.append(&quot;;\n\n&quot;);
          }
<span class="udiff-line-removed">-         addImportSection();</span>
      }
  
<span class="udiff-line-modified-removed">-     protected void addImportSection() {</span>
<span class="udiff-line-modified-added">+     private void addImportSection() {</span>
          sb.append(&quot;import java.lang.invoke.MethodHandle;\n&quot;);
          sb.append(&quot;import java.lang.invoke.VarHandle;\n&quot;);
          sb.append(&quot;import jdk.incubator.foreign.*;\n&quot;);
          sb.append(&quot;import jdk.incubator.foreign.MemoryLayout.PathElement;\n&quot;);
          sb.append(&quot;import static &quot;);
<span class="udiff-line-modified-removed">-         sb.append(HandleSourceFactory.C_LANG_CONSTANTS_HOLDER);</span>
<span class="udiff-line-modified-added">+         sb.append(OutputFactory.C_LANG_CONSTANTS_HOLDER);</span>
          sb.append(&quot;.*;\n&quot;);
      }
  
<span class="udiff-line-modified-removed">-     protected void classBegin(String name) {</span>
<span class="udiff-line-modified-added">+     public void classBegin(String name) {</span>
<span class="udiff-line-added">+         className = name;</span>
<span class="udiff-line-added">+         String qualName = pkgName.isEmpty() ? name : pkgName + &quot;.&quot; + name;</span>
<span class="udiff-line-added">+         constantHelper = new ConstantHelper(qualName, ClassDesc.of(pkgName, &quot;RuntimeHelper&quot;), libraryNames);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         addPackagePrefix();</span>
<span class="udiff-line-added">+         addImportSection();</span>
<span class="udiff-line-added">+ </span>
          indent();
          sb.append(PUB_CLS_MODS + &quot;class &quot;);
          sb.append(name);
          sb.append(&quot; {\n\n&quot;);
      }
  
<span class="udiff-line-modified-removed">-     protected void classEnd() {</span>
<span class="udiff-line-modified-added">+     public void classEnd() {</span>
          indent();
          sb.append(&quot;}\n\n&quot;);
      }
  
<span class="udiff-line-modified-removed">-     protected void addLibraries(String[] libraryNames) {</span>
<span class="udiff-line-modified-removed">-         incrAlign();</span>
<span class="udiff-line-removed">-         indent();</span>
<span class="udiff-line-removed">-         sb.append(PRI_MODS + &quot;LibraryLookup[] LIBRARIES = RuntimeHelper.libraries(&quot;);</span>
<span class="udiff-line-removed">-         sb.append(stringArray(libraryNames) + &quot;);\n&quot;);</span>
<span class="udiff-line-removed">-         decrAlign();</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     private String stringArray(String[] elements) {</span>
<span class="udiff-line-removed">-         return Stream.of(elements)</span>
<span class="udiff-line-removed">-                 .map(n -&gt; &quot;\&quot;&quot; + n + &quot;\&quot;&quot;)</span>
<span class="udiff-line-removed">-                 .collect(Collectors.joining(&quot;,&quot;, &quot;new String[] {&quot;, &quot;}&quot;));</span>
<span class="udiff-line-modified-added">+     private String getterCall(DirectMethodHandleDesc desc) {</span>
<span class="udiff-line-modified-added">+         return desc.owner().displayName() + &quot;.&quot; + desc.methodName() + &quot;()&quot;;</span>
      }
  
<span class="udiff-line-modified-removed">-     protected void addLayout(String elementName, MemoryLayout layout) {</span>
<span class="udiff-line-modified-added">+     private void emitForwardGetter(DirectMethodHandleDesc desc) {</span>
<span class="udiff-line-added">+         incrAlign();</span>
<span class="udiff-line-added">+         indent();</span>
<span class="udiff-line-added">+         sb.append(PUB_MODS + displayName(desc.invocationType().returnType()) + &quot; &quot; + desc.methodName() + &quot;() {\n&quot;);</span>
          incrAlign();
          indent();
<span class="udiff-line-modified-removed">-         sb.append(PUB_MODS + &quot;MemoryLayout &quot; + javaSafeIdentifier(elementName) + &quot;$LAYOUT = &quot;);</span>
<span class="udiff-line-modified-removed">-         addLayout(layout);</span>
<span class="udiff-line-modified-removed">-         sb.append(&quot;;\n&quot;);</span>
<span class="udiff-line-modified-added">+         sb.append(&quot;return &quot; + getterCall(desc) + &quot;;\n&quot;);</span>
<span class="udiff-line-modified-added">+         decrAlign();</span>
<span class="udiff-line-modified-added">+         indent();</span>
<span class="udiff-line-added">+         sb.append(&quot;}\n&quot;);</span>
          decrAlign();
      }
  
<span class="udiff-line-modified-removed">-     private void addLayout(MemoryLayout l) {</span>
<span class="udiff-line-modified-removed">-         if (l instanceof ValueLayout) {</span>
<span class="udiff-line-removed">-             SystemABI.Type type = l.attribute(NATIVE_TYPE)</span>
<span class="udiff-line-removed">-                                    .map(SystemABI.Type.class::cast)</span>
<span class="udiff-line-removed">-                                    .orElseThrow(()-&gt;new AssertionError(&quot;Should not get here: &quot; + l));</span>
<span class="udiff-line-removed">-             sb.append(TypeTranslator.typeToLayoutName(type));</span>
<span class="udiff-line-removed">-         } else if (l instanceof SequenceLayout) {</span>
<span class="udiff-line-removed">-             sb.append(&quot;MemoryLayout.ofSequence(&quot;);</span>
<span class="udiff-line-removed">-             if (((SequenceLayout) l).elementCount().isPresent()) {</span>
<span class="udiff-line-removed">-                 sb.append(((SequenceLayout) l).elementCount().getAsLong() + &quot;, &quot;);</span>
<span class="udiff-line-removed">-             }</span>
<span class="udiff-line-removed">-             addLayout(((SequenceLayout) l).elementLayout());</span>
<span class="udiff-line-removed">-             sb.append(&quot;)&quot;);</span>
<span class="udiff-line-removed">-         } else if (l instanceof GroupLayout) {</span>
<span class="udiff-line-removed">-             SystemABI.Type type = l.attribute(NATIVE_TYPE)</span>
<span class="udiff-line-removed">-                                    .map(SystemABI.Type.class::cast)</span>
<span class="udiff-line-removed">-                                    .orElse(null);</span>
<span class="udiff-line-removed">-             if (type == SystemABI.Type.COMPLEX_LONG_DOUBLE) {</span>
<span class="udiff-line-removed">-                 if (!ABI.equals(SystemABI.ABI_SYSV)) {</span>
<span class="udiff-line-removed">-                     throw new RuntimeException(&quot;complex long double is supported only for SysV ABI&quot;);</span>
<span class="udiff-line-removed">-                 } else {</span>
<span class="udiff-line-removed">-                     sb.append(&quot;C_COMPLEX_LONGDOUBLE&quot;);</span>
<span class="udiff-line-removed">-                 }</span>
<span class="udiff-line-removed">-             } else {</span>
<span class="udiff-line-removed">-                 if (((GroupLayout) l).isStruct()) {</span>
<span class="udiff-line-removed">-                     sb.append(&quot;MemoryLayout.ofStruct(\n&quot;);</span>
<span class="udiff-line-removed">-                 } else {</span>
<span class="udiff-line-removed">-                     sb.append(&quot;MemoryLayout.ofUnion(\n&quot;);</span>
<span class="udiff-line-removed">-                 }</span>
<span class="udiff-line-removed">-                 incrAlign();</span>
<span class="udiff-line-removed">-                 String delim = &quot;&quot;;</span>
<span class="udiff-line-removed">-                 for (MemoryLayout e : ((GroupLayout) l).memberLayouts()) {</span>
<span class="udiff-line-removed">-                     sb.append(delim);</span>
<span class="udiff-line-removed">-                     indent();</span>
<span class="udiff-line-removed">-                     addLayout(e);</span>
<span class="udiff-line-removed">-                     delim = &quot;,\n&quot;;</span>
<span class="udiff-line-removed">-                 }</span>
<span class="udiff-line-removed">-                 sb.append(&quot;\n&quot;);</span>
<span class="udiff-line-removed">-                 decrAlign();</span>
<span class="udiff-line-removed">-                 indent();</span>
<span class="udiff-line-removed">-                 sb.append(&quot;)&quot;);</span>
<span class="udiff-line-removed">-             }</span>
<span class="udiff-line-removed">-         } else {</span>
<span class="udiff-line-removed">-             //padding</span>
<span class="udiff-line-removed">-             sb.append(&quot;MemoryLayout.ofPaddingBits(&quot; + l.bitSize() + &quot;)&quot;);</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">-         if (l.name().isPresent()) {</span>
<span class="udiff-line-removed">-             sb.append(&quot;.withName(\&quot;&quot; +  l.name().get() + &quot;\&quot;)&quot;);</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-modified-added">+     private String displayName(ClassDesc returnType) {</span>
<span class="udiff-line-modified-added">+         return returnType.displayName(); // TODO shorten based on imports</span>
      }
  
<span class="udiff-line-modified-removed">-     protected void addVarHandle(String name, Class&lt;?&gt; type, String parentName) {</span>
<span class="udiff-line-modified-removed">-         incrAlign();</span>
<span class="udiff-line-removed">-         indent();</span>
<span class="udiff-line-removed">-         parentName = parentName != null? javaSafeIdentifier(parentName) : parentName;</span>
<span class="udiff-line-removed">-         name = javaSafeIdentifier(name);</span>
<span class="udiff-line-removed">-         String vhName = parentName != null ?</span>
<span class="udiff-line-removed">-                 parentName + &quot;$&quot; + name : name;</span>
<span class="udiff-line-removed">-         sb.append(PUB_MODS + &quot;VarHandle &quot; + vhName + &quot; = &quot;);</span>
<span class="udiff-line-removed">-         if (parentName != null) {</span>
<span class="udiff-line-removed">-             addHandlePath(type, parentName, name);</span>
<span class="udiff-line-removed">-         } else {</span>
<span class="udiff-line-removed">-             addHandlePath(type, name);</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">-         sb.append(&quot;;\n&quot;);</span>
<span class="udiff-line-removed">-         decrAlign();</span>
<span class="udiff-line-modified-added">+     private String getFunction(String javaName, FunctionDescriptor fDesc) {</span>
<span class="udiff-line-modified-added">+         return getterCall(constantHelper.addFunctionDesc(javaName, fDesc));</span>
      }
  
<span class="udiff-line-modified-removed">-     protected void addHandlePath(Class&lt;?&gt; type, String strName, String fieldName) {</span>
<span class="udiff-line-modified-removed">-         String ty = type.getName();</span>
<span class="udiff-line-removed">-         boolean isAddress = ty.contains(&quot;MemoryAddress&quot;);</span>
<span class="udiff-line-removed">-         if (isAddress) {</span>
<span class="udiff-line-removed">-             sb.append(&quot;MemoryHandles.asAddressVarHandle(&quot;);</span>
<span class="udiff-line-removed">-             ty = &quot;long&quot;;</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">-         sb.append(strName + &quot;$LAYOUT.varHandle(&quot; + ty + &quot;.class, &quot;);</span>
<span class="udiff-line-removed">-         sb.append(&quot;PathElement.groupElement(\&quot;&quot; + fieldName +&quot;\&quot;)&quot;);</span>
<span class="udiff-line-removed">-         sb.append(&quot;)&quot;);</span>
<span class="udiff-line-removed">-         if (isAddress) {</span>
<span class="udiff-line-removed">-             sb.append(&quot;)&quot;);</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-modified-added">+     private String getMethodHandle(String javaName, String nativeName, MethodType mt, FunctionDescriptor fDesc, boolean varargs) {</span>
<span class="udiff-line-modified-added">+         return getterCall(constantHelper.addMethodHandle(javaName, nativeName, mt, fDesc, varargs));</span>
      }
  
<span class="udiff-line-modified-removed">-     protected void addHandlePath(Class&lt;?&gt; type, String varName) {</span>
<span class="udiff-line-modified-removed">-         String ty = type.getName();</span>
<span class="udiff-line-removed">-         boolean isAddress = ty.contains(&quot;MemoryAddress&quot;);</span>
<span class="udiff-line-removed">-         if (isAddress) {</span>
<span class="udiff-line-removed">-             sb.append(&quot;MemoryHandles.asAddressVarHandle(&quot;);</span>
<span class="udiff-line-removed">-             ty = &quot;long&quot;;</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">-         sb.append(varName + &quot;$LAYOUT.varHandle(&quot; + ty + &quot;.class)&quot;);</span>
<span class="udiff-line-removed">-         if (isAddress) {</span>
<span class="udiff-line-removed">-             sb.append(&quot;)&quot;);</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-modified-added">+     private String getVarHandle(String javaName, String nativeName, MemoryLayout layout, Class&lt;?&gt; type, MemoryLayout parentLayout) {</span>
<span class="udiff-line-modified-added">+         return getterCall(constantHelper.addVarHandle(javaName, nativeName, layout, type, parentLayout));</span>
      }
  
<span class="udiff-line-modified-removed">-     protected void addMethodHandle(Declaration.Function funcTree, MethodType mtype, FunctionDescriptor desc) {</span>
<span class="udiff-line-modified-removed">-         incrAlign();</span>
<span class="udiff-line-removed">-         indent();</span>
<span class="udiff-line-removed">-         sb.append(PUB_MODS + &quot;MethodHandle &quot; + javaSafeIdentifier(funcTree.name()) + &quot; = &quot;);</span>
<span class="udiff-line-removed">-         sb.append(&quot;RuntimeHelper.downcallHandle(\n&quot;);</span>
<span class="udiff-line-removed">-         incrAlign();</span>
<span class="udiff-line-removed">-         indent();</span>
<span class="udiff-line-removed">-         sb.append(&quot;LIBRARIES, \&quot;&quot; + funcTree.name() + &quot;\&quot;&quot;);</span>
<span class="udiff-line-removed">-         sb.append(&quot;,\n&quot;);</span>
<span class="udiff-line-removed">-         indent();</span>
<span class="udiff-line-removed">-         sb.append(&quot;\&quot;&quot; + mtype.toMethodDescriptorString() + &quot;\&quot;,\n&quot;);</span>
<span class="udiff-line-removed">-         indent();</span>
<span class="udiff-line-removed">-         addFunction(desc);</span>
<span class="udiff-line-removed">-         sb.append(&quot;,\n&quot;);</span>
<span class="udiff-line-removed">-         indent();</span>
<span class="udiff-line-removed">-         sb.append(funcTree.type().varargs());</span>
<span class="udiff-line-removed">-         decrAlign();</span>
<span class="udiff-line-removed">-         sb.append(&quot;\n&quot;);</span>
<span class="udiff-line-removed">-         indent();</span>
<span class="udiff-line-removed">-         sb.append(&quot;);\n&quot;);</span>
<span class="udiff-line-removed">-         decrAlign();</span>
<span class="udiff-line-modified-added">+     private String getAddress(String javaName, String nativeName) {</span>
<span class="udiff-line-modified-added">+         return getterCall(constantHelper.addAddress(javaName, nativeName));</span>
      }
  
<span class="udiff-line-modified-removed">-     protected void addAddressLookup(String name) {</span>
<span class="udiff-line-modified-removed">-         sb.append(&quot;RuntimeHelper.lookupGlobalVariable(LIBRARIES, \&quot;&quot; + name + &quot;\&quot;)&quot;);</span>
<span class="udiff-line-modified-added">+     public void addLayout(String javaName, MemoryLayout layout) {</span>
<span class="udiff-line-modified-added">+         emitForwardGetter(constantHelper.addLayout(javaName, layout));</span>
      }
  
<span class="udiff-line-modified-removed">-     private void addFunction(FunctionDescriptor f) {</span>
<span class="udiff-line-modified-removed">-         final boolean noArgs = f.argumentLayouts().isEmpty();</span>
<span class="udiff-line-removed">-         if (f.returnLayout().isPresent()) {</span>
<span class="udiff-line-removed">-             sb.append(&quot;FunctionDescriptor.of(&quot;);</span>
<span class="udiff-line-removed">-             addLayout(f.returnLayout().get());</span>
<span class="udiff-line-removed">-             if (!noArgs) {</span>
<span class="udiff-line-removed">-                 sb.append(&quot;, &quot;);</span>
<span class="udiff-line-removed">-             }</span>
<span class="udiff-line-removed">-         } else {</span>
<span class="udiff-line-removed">-             sb.append(&quot;FunctionDescriptor.ofVoid(&quot;);</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">-         if (!noArgs) {</span>
<span class="udiff-line-removed">-             sb.append(&quot;\n&quot;);</span>
<span class="udiff-line-removed">-             incrAlign();</span>
<span class="udiff-line-removed">-             String delim = &quot;&quot;;</span>
<span class="udiff-line-removed">-             for (MemoryLayout e : f.argumentLayouts()) {</span>
<span class="udiff-line-removed">-                 sb.append(delim);</span>
<span class="udiff-line-removed">-                 indent();</span>
<span class="udiff-line-removed">-                 addLayout(e);</span>
<span class="udiff-line-removed">-                 delim = &quot;,\n&quot;;</span>
<span class="udiff-line-removed">-             }</span>
<span class="udiff-line-removed">-             sb.append(&quot;\n&quot;);</span>
<span class="udiff-line-removed">-             decrAlign();</span>
<span class="udiff-line-removed">-             indent();</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">-         sb.append(&quot;)&quot;);</span>
<span class="udiff-line-modified-added">+     public void addVarHandle(String javaName, String nativeName, MemoryLayout layout, Class&lt;?&gt; type, MemoryLayout parentLayout) {</span>
<span class="udiff-line-modified-added">+         emitForwardGetter(constantHelper.addVarHandle(javaName, nativeName, layout, type, parentLayout));</span>
      }
  
<span class="udiff-line-modified-removed">-     protected void addAddress(String name) {</span>
<span class="udiff-line-modified-removed">-         incrAlign();</span>
<span class="udiff-line-removed">-         indent();</span>
<span class="udiff-line-removed">-         sb.append(PUB_MODS + &quot;MemoryAddress &quot; + javaSafeIdentifier(name) + &quot;$ADDR&quot; + &quot; = &quot;);</span>
<span class="udiff-line-removed">-         addAddressLookup(name);</span>
<span class="udiff-line-removed">-         sb.append(&quot;;\n&quot;);</span>
<span class="udiff-line-removed">-         decrAlign();</span>
<span class="udiff-line-modified-added">+     public void addMethodHandle(String javaName, String nativeName, MethodType mtype, FunctionDescriptor desc, boolean varargs) {</span>
<span class="udiff-line-modified-added">+         emitForwardGetter(constantHelper.addMethodHandle(javaName, nativeName, mtype, desc, varargs));</span>
      }
  
<span class="udiff-line-modified-removed">-     protected void addConstant(String name, Class&lt;?&gt; type, Object value) {</span>
<span class="udiff-line-modified-removed">-         incrAlign();</span>
<span class="udiff-line-removed">-         indent();</span>
<span class="udiff-line-removed">-         if (type == MemoryAddress.class || type == MemorySegment.class) {</span>
<span class="udiff-line-removed">-             //todo, skip for now (address constants and string constants)</span>
<span class="udiff-line-removed">-         } else {</span>
<span class="udiff-line-removed">-             sb.append(PUB_MODS + type.getName() + &quot; &quot; + javaSafeIdentifier(name));</span>
<span class="udiff-line-removed">-             sb.append(&quot; = &quot;);</span>
<span class="udiff-line-removed">-             if (type == float.class) {</span>
<span class="udiff-line-removed">-                 float f = ((Number)value).floatValue();</span>
<span class="udiff-line-removed">-                 if (Float.isNaN(f)) {</span>
<span class="udiff-line-removed">-                     sb.append(&quot;Float.NaN&quot;);</span>
<span class="udiff-line-removed">-                 } else if (Float.isInfinite(f)) {</span>
<span class="udiff-line-removed">-                     sb.append(f &gt; 0? &quot;Float.POSITIVE_INFINITY&quot; : &quot;Float.NEGATIVE_INFINITY&quot;);</span>
<span class="udiff-line-removed">-                 } else {</span>
<span class="udiff-line-removed">-                     sb.append(value);</span>
<span class="udiff-line-removed">-                     sb.append(&quot;f&quot;);</span>
<span class="udiff-line-removed">-                 }</span>
<span class="udiff-line-removed">-             } else if (type == long.class) {</span>
<span class="udiff-line-removed">-                 sb.append(value);</span>
<span class="udiff-line-removed">-                 sb.append(&quot;L&quot;);</span>
<span class="udiff-line-removed">-             } else if (type == double.class) {</span>
<span class="udiff-line-removed">-                 double d = ((Number)value).doubleValue();</span>
<span class="udiff-line-removed">-                 if (Double.isNaN(d)) {</span>
<span class="udiff-line-removed">-                     sb.append(&quot;Double.NaN&quot;);</span>
<span class="udiff-line-removed">-                 } else if (Double.isInfinite(d)) {</span>
<span class="udiff-line-removed">-                     sb.append(d &gt; 0? &quot;Double.POSITIVE_INFINITY&quot; : &quot;Double.NEGATIVE_INFINITY&quot;);</span>
<span class="udiff-line-removed">-                 } else {</span>
<span class="udiff-line-removed">-                    sb.append(value);</span>
<span class="udiff-line-removed">-                    sb.append(&quot;d&quot;);</span>
<span class="udiff-line-removed">-                 }</span>
<span class="udiff-line-removed">-             } else {</span>
<span class="udiff-line-removed">-                 sb.append(&quot;(&quot; + type.getName() + &quot;)&quot;);</span>
<span class="udiff-line-removed">-                 sb.append(value + &quot;L&quot;);</span>
<span class="udiff-line-removed">-             }</span>
<span class="udiff-line-removed">-             sb.append(&quot;;\n&quot;);</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-         decrAlign();</span>
<span class="udiff-line-modified-added">+     public void addAddress(String javaName, String nativeName) {</span>
<span class="udiff-line-modified-added">+         emitForwardGetter(constantHelper.addAddress(javaName, nativeName));</span>
      }
  
<span class="udiff-line-modified-removed">-     static int funcIntfCounter = 0;</span>
<span class="udiff-line-modified-added">+     public void addConstant(String javaName, Class&lt;?&gt; type, Object value) {</span>
<span class="udiff-line-added">+         emitForwardGetter(constantHelper.addConstant(javaName, type, value));</span>
<span class="udiff-line-added">+     }</span>
  
<span class="udiff-line-modified-removed">-     protected void addUpcallFactory(FunctionDescriptor desc) {</span>
<span class="udiff-line-removed">-         String fnName = &quot;FI&quot; + funcIntfCounter++;</span>
<span class="udiff-line-modified-added">+     public void addFunctionalFactory(String className, MethodType mtype, FunctionDescriptor fDesc) {</span>
          incrAlign();
          indent();
<span class="udiff-line-modified-removed">-         sb.append(PRI_MODS + &quot;FunctionDescriptor &quot; + fnName + &quot;$DESC = &quot;);</span>
<span class="udiff-line-removed">-         addFunction(desc);</span>
<span class="udiff-line-removed">-         sb.append(&quot;;\n&quot;);</span>
<span class="udiff-line-removed">-         indent();</span>
<span class="udiff-line-removed">-         sb.append(PUB_MODS + &quot;MemoryAddress &quot; + fnName + &quot;$make(MethodHandle handle) {\n&quot;);</span>
<span class="udiff-line-modified-added">+         sb.append(PUB_MODS + &quot;MemoryAddress &quot; + className + &quot;$make(&quot; + className + &quot; fi) {\n&quot;);</span>
          incrAlign();
          indent();
<span class="udiff-line-modified-removed">-         sb.append(&quot;return RuntimeHelper.upcallStub(handle, &quot; + fnName + &quot;$DESC);\n&quot;);</span>
<span class="udiff-line-modified-added">+         sb.append(&quot;return RuntimeHelper.upcallStub(&quot; + className + &quot;.class, fi, &quot; + getFunction(className, fDesc) + &quot;, &quot; +</span>
<span class="udiff-line-added">+                 &quot;\&quot;&quot; + mtype.toMethodDescriptorString() + &quot;\&quot;);\n&quot;);</span>
          decrAlign();
          indent();
          sb.append(&quot;}\n&quot;);
          decrAlign();
      }
  
<span class="udiff-line-modified-removed">-     protected void addStaticFunctionWrapper(Declaration.Function f, MethodType mtype) {</span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-added">+     public void addStaticFunctionWrapper(String javaName, String nativeName, MethodType mtype, FunctionDescriptor desc, boolean varargs, List&lt;String&gt; paramNames) {</span>
          incrAlign();
          indent();
<span class="udiff-line-modified-removed">-         sb.append(PUB_MODS + mtype.returnType().getName() + &quot; &quot; + javaSafeIdentifier(f.name()) + &quot; (&quot;);</span>
<span class="udiff-line-modified-added">+         sb.append(PUB_MODS + mtype.returnType().getName() + &quot; &quot; + javaName + &quot; (&quot;);</span>
          String delim = &quot;&quot;;
          List&lt;String&gt; pNames = new ArrayList&lt;&gt;();
<span class="udiff-line-modified-removed">-         final int numParams = f.parameters().size();</span>
<span class="udiff-line-modified-added">+         final int numParams = paramNames.size();</span>
          for (int i = 0 ; i &lt; numParams; i++) {
<span class="udiff-line-modified-removed">-             String pName = f.parameters().get(i).name();</span>
<span class="udiff-line-modified-added">+             String pName = paramNames.get(i);</span>
              if (pName.isEmpty()) {
                  pName = &quot;x&quot; + i;
              }
<span class="udiff-line-removed">-             pName = javaSafeIdentifier(pName);</span>
              pNames.add(pName);
              sb.append(delim + mtype.parameterType(i).getName() + &quot; &quot; + pName);
              delim = &quot;, &quot;;
          }
<span class="udiff-line-modified-removed">-         if (f.type().varargs()) {</span>
<span class="udiff-line-modified-added">+         if (varargs) {</span>
              String lastArg = &quot;x&quot; + numParams;
              if (numParams &gt; 0) {
                  sb.append(&quot;, &quot;);
              }
              sb.append(&quot;Object... &quot; + lastArg);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -382,11 +207,11 @@</span>
          incrAlign();
          indent();
          if (!mtype.returnType().equals(void.class)) {
              sb.append(&quot;return (&quot; + mtype.returnType().getName() + &quot;)&quot;);
          }
<span class="udiff-line-modified-removed">-         sb.append(f.name() + &quot;.invokeExact(&quot; + String.join(&quot;, &quot;, pNames) + &quot;);\n&quot;);</span>
<span class="udiff-line-modified-added">+         sb.append(getMethodHandle(javaName, nativeName, mtype, desc, varargs) + &quot;.invokeExact(&quot; + String.join(&quot;, &quot;, pNames) + &quot;);\n&quot;);</span>
          decrAlign();
          indent();
          sb.append(&quot;} catch (Throwable ex) {\n&quot;);
          incrAlign();
          indent();
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -398,24 +223,14 @@</span>
          indent();
          sb.append(&quot;}\n&quot;);
          decrAlign();
      }
  
<span class="udiff-line-modified-removed">-     void addDescriptor(String name, FunctionDescriptor desc) {</span>
<span class="udiff-line-modified-added">+     public void addFunctionalInterface(String name, MethodType mtype) {</span>
          incrAlign();
          indent();
<span class="udiff-line-modified-removed">-         sb.append(PRI_MODS + &quot;FunctionDescriptor &quot; + name + &quot;$DESC = &quot;);</span>
<span class="udiff-line-removed">-         addFunction(desc);</span>
<span class="udiff-line-removed">-         sb.append(&quot;;\n&quot;);</span>
<span class="udiff-line-removed">-         decrAlign();</span>
<span class="udiff-line-removed">-         indent();</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     void addFunctionalInterface(String name, MethodType mtype) {</span>
<span class="udiff-line-removed">-         incrAlign();</span>
<span class="udiff-line-removed">-         indent();</span>
<span class="udiff-line-removed">-         sb.append(&quot;public interface &quot; + javaSafeIdentifier(name) + &quot; {\n&quot;);</span>
<span class="udiff-line-modified-added">+         sb.append(&quot;public interface &quot; + name + &quot; {\n&quot;);</span>
          incrAlign();
          indent();
          sb.append(mtype.returnType().getName() + &quot; apply(&quot;);
          String delim = &quot;&quot;;
          for (int i = 0 ; i &lt; mtype.parameterCount() ; i++) {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -428,83 +243,61 @@</span>
          sb.append(&quot;}\n&quot;);
          decrAlign();
          indent();
      }
  
<span class="udiff-line-modified-removed">-     protected void addFunctionalFactory(String name, MethodType mtype) {</span>
<span class="udiff-line-modified-added">+     public void addGetter(String javaName, String nativeName, MemoryLayout layout, Class&lt;?&gt; type, MemoryLayout parentLayout) {</span>
          incrAlign();
          indent();
<span class="udiff-line-modified-removed">-         sb.append(PUB_MODS + &quot;MemoryAddress &quot; + name + &quot;$make(&quot; + name + &quot; fi) {\n&quot;);</span>
<span class="udiff-line-modified-added">+         String param = parentLayout != null ? (MemorySegment.class.getName() + &quot; seg&quot;) : &quot;&quot;;</span>
<span class="udiff-line-added">+         sb.append(PUB_MODS + type.getName() + &quot; &quot; + javaName + &quot;$get(&quot; + param + &quot;) {\n&quot;);</span>
          incrAlign();
          indent();
<span class="udiff-line-modified-removed">-         sb.append(&quot;return RuntimeHelper.upcallStub(&quot; + name + &quot;.class, fi, &quot; + name + &quot;$DESC, &quot; +</span>
<span class="udiff-line-modified-removed">-                 &quot;\&quot;&quot; + mtype.toMethodDescriptorString() + &quot;\&quot;);\n&quot;);</span>
<span class="udiff-line-modified-added">+         String vhParam = parentLayout != null ?</span>
<span class="udiff-line-modified-added">+                 &quot;seg.baseAddress()&quot; : getAddress(javaName, nativeName);</span>
<span class="udiff-line-added">+         sb.append(&quot;return (&quot; + type.getName() + &quot;)&quot;</span>
<span class="udiff-line-added">+                 + getVarHandle(javaName, nativeName, layout, type, parentLayout) + &quot;.get(&quot; + vhParam + &quot;);\n&quot;);</span>
          decrAlign();
          indent();
          sb.append(&quot;}\n&quot;);
          decrAlign();
      }
  
<span class="udiff-line-modified-removed">-     void addGetter(String name, Class&lt;?&gt; type, String parent) {</span>
<span class="udiff-line-modified-added">+     public void addSetter(String javaName, String nativeName, MemoryLayout layout, Class&lt;?&gt; type, MemoryLayout parentLayout) {</span>
          incrAlign();
          indent();
<span class="udiff-line-modified-removed">-         name = javaSafeIdentifier(name);</span>
<span class="udiff-line-modified-removed">-         String vhName = (parent != null ? (javaSafeIdentifier(parent) + &quot;$&quot;) : &quot;&quot;) + name;</span>
<span class="udiff-line-removed">-         String param = parent != null ? (MemorySegment.class.getName() + &quot; seg&quot;) : &quot;&quot;;</span>
<span class="udiff-line-removed">-         sb.append(PUB_MODS + type.getName() + &quot; &quot; + vhName + &quot;$get(&quot; + param + &quot;) {\n&quot;);</span>
<span class="udiff-line-modified-added">+         String param = parentLayout != null ? (MemorySegment.class.getName() + &quot; seg, &quot;) : &quot;&quot;;</span>
<span class="udiff-line-modified-added">+         sb.append(PUB_MODS + &quot;void &quot; + javaName + &quot;$set(&quot; + param + type.getName() + &quot; x) {\n&quot;);</span>
          incrAlign();
          indent();
<span class="udiff-line-modified-removed">-         String vhParam = parent != null ?</span>
<span class="udiff-line-modified-removed">-                 &quot;seg.baseAddress()&quot; : name + &quot;$ADDR&quot;;</span>
<span class="udiff-line-modified-removed">-         sb.append(&quot;return (&quot; + type.getName() + &quot;)&quot; + vhName + &quot;.get(&quot; + vhParam + &quot;);\n&quot;);</span>
<span class="udiff-line-modified-added">+         String vhParam = parentLayout != null ?</span>
<span class="udiff-line-modified-added">+                 &quot;seg.baseAddress()&quot; : getAddress(javaName, nativeName);</span>
<span class="udiff-line-modified-added">+         sb.append(getVarHandle(javaName, nativeName, layout, type, parentLayout) + &quot;.set(&quot; + vhParam + &quot;, x);\n&quot;);</span>
          decrAlign();
          indent();
          sb.append(&quot;}\n&quot;);
          decrAlign();
      }
  
<span class="udiff-line-modified-removed">-     void addSetter(String name, Class&lt;?&gt; type, String parent) {</span>
<span class="udiff-line-removed">-         incrAlign();</span>
<span class="udiff-line-removed">-         indent();</span>
<span class="udiff-line-removed">-         name = javaSafeIdentifier(name);</span>
<span class="udiff-line-removed">-         String vhName = (parent != null ? (javaSafeIdentifier(parent) + &quot;$&quot;) : &quot;&quot;) + name;</span>
<span class="udiff-line-removed">-         String param = parent != null ? (MemorySegment.class.getName() + &quot; seg, &quot;) : &quot;&quot;;</span>
<span class="udiff-line-removed">-         sb.append(PUB_MODS + &quot;void &quot; + vhName + &quot;$set(&quot; + param + type.getName() + &quot; x) {\n&quot;);</span>
<span class="udiff-line-removed">-         incrAlign();</span>
<span class="udiff-line-removed">-         indent();</span>
<span class="udiff-line-removed">-         String vhParam = parent != null ?</span>
<span class="udiff-line-removed">-                 &quot;seg.baseAddress()&quot; : name + &quot;$ADDR&quot;;</span>
<span class="udiff-line-removed">-         sb.append(vhName + &quot;.set(&quot; + vhParam + &quot;, x);\n&quot;);</span>
<span class="udiff-line-removed">-         decrAlign();</span>
<span class="udiff-line-removed">-         indent();</span>
<span class="udiff-line-removed">-         sb.append(&quot;}\n&quot;);</span>
<span class="udiff-line-removed">-         decrAlign();</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     protected String build() {</span>
<span class="udiff-line-modified-added">+     public List&lt;JavaFileObject&gt; build() {</span>
          String res = sb.toString();
          this.sb = null;
<span class="udiff-line-modified-removed">-         return res.toString();</span>
<span class="udiff-line-modified-added">+         List&lt;JavaFileObject&gt; outputs = new ArrayList&lt;&gt;(constantHelper.getClasses());</span>
<span class="udiff-line-added">+         outputs.add(Utils.fileFromString(pkgName, className, res));</span>
<span class="udiff-line-added">+         return outputs;</span>
      }
  
<span class="udiff-line-modified-removed">-     protected void indent() {</span>
<span class="udiff-line-modified-added">+     private void indent() {</span>
          for (int i = 0; i &lt; align; i++) {
              sb.append(&quot;    &quot;);
          }
      }
  
<span class="udiff-line-modified-removed">-     protected void incrAlign() {</span>
<span class="udiff-line-modified-added">+     private void incrAlign() {</span>
          align++;
      }
  
<span class="udiff-line-modified-removed">-     protected void decrAlign() {</span>
<span class="udiff-line-modified-added">+     private void decrAlign() {</span>
          align--;
      }
  
<span class="udiff-line-removed">-     protected final String javaSafeIdentifier(String name) {</span>
<span class="udiff-line-removed">-         // We never get the problem of Java non-identifiers (like 123, ab-xy) as</span>
<span class="udiff-line-removed">-         // C identifiers. But we may have a java keyword used as a C identifier.</span>
<span class="udiff-line-removed">-         assert SourceVersion.isIdentifier(name);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-         return SourceVersion.isKeyword(name)? (name + &quot;_&quot;) : name;</span>
<span class="udiff-line-removed">-     }</span>
  }
</pre>
<center><a href="../../../../../../../jdk.incubator.foreign/share/classes/jdk/incubator/foreign/MemoryLayouts.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="Main.java.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>