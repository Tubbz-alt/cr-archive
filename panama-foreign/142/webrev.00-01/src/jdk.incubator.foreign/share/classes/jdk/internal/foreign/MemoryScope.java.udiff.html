<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff src/jdk.incubator.foreign/share/classes/jdk/internal/foreign/MemoryScope.java</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
  </head>
<body>
<center>&lt; prev <a href="../../../../../../../index.html" target="_top">index</a> next &gt;</center>    <h2>src/jdk.incubator.foreign/share/classes/jdk/internal/foreign/MemoryScope.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -131,39 +131,32 @@</span>
              throw new IllegalStateException(&quot;This scope is already closed&quot;);
          }
      }
  
      private static final class Root extends MemoryScope {
<span class="udiff-line-modified-removed">-         private final LongAdder acquires;</span>
<span class="udiff-line-modified-removed">-         private final LongAdder releases;</span>
<span class="udiff-line-modified-added">+         private final LongAdder acquires = new LongAdder();</span>
<span class="udiff-line-modified-added">+         private final LongAdder releases = new LongAdder();</span>
          private final Object ref;
          private final Runnable cleanupAction;
  
<span class="udiff-line-modified-removed">-         private Root(LongAdder acquires, LongAdder releases, Object ref, Runnable cleanupAction) {</span>
<span class="udiff-line-removed">-             this.acquires = acquires;</span>
<span class="udiff-line-removed">-             this.releases = releases;</span>
<span class="udiff-line-modified-added">+         private Root(Object ref, Runnable cleanupAction) {</span>
              this.ref = ref;
              this.cleanupAction = cleanupAction;
          }
  
<span class="udiff-line-removed">-         private Root(Object ref, Runnable cleanupAction) {</span>
<span class="udiff-line-removed">-             this(new LongAdder(), new LongAdder(), ref, cleanupAction);</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">- </span>
          @Override
          MemoryScope acquire() {
              // increment acquires 1st
              acquires.increment();
              // check state 2nd
<span class="udiff-line-modified-removed">-             int state = (int) STATE.getVolatile(this);</span>
<span class="udiff-line-modified-removed">-             while (state &gt; STATE_OPEN) {</span>
<span class="udiff-line-modified-added">+             int state;</span>
<span class="udiff-line-modified-added">+             while ((state  = (int) STATE.getVolatile(this)) &gt; STATE_OPEN) {</span>
                  if (state == STATE_CLOSED) {
                      releases.increment();
                      throw new IllegalStateException(&quot;This scope is already closed&quot;);
                  }
                  Thread.onSpinWait();
<span class="udiff-line-removed">-                 state = (int) STATE.getVolatile(this);</span>
              }
              return new Child();
          }
  
          @Override
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -178,14 +171,12 @@</span>
  
          private MemoryScope closeOrDup(boolean close) {
              if (state == STATE_CLOSED) {
                  throw new IllegalStateException(&quot;This scope is already closed&quot;);
              }
<span class="udiff-line-modified-removed">-             // pre-allocate duped scope so we don&#39;t get OOME later and be left with this scope closed;</span>
<span class="udiff-line-modified-removed">-             // we only return this instance if releases.sum() == acquires.sum(), so both LongAdder(s)</span>
<span class="udiff-line-removed">-             // can be reused...</span>
<span class="udiff-line-removed">-             var duped = close ? null : new Root(acquires, releases, ref, cleanupAction);</span>
<span class="udiff-line-modified-added">+             // pre-allocate duped scope so we don&#39;t get OOME later and be left with this scope closed</span>
<span class="udiff-line-modified-added">+             var duped = close ? null : new Root(ref, cleanupAction);</span>
              // modify state to STATE_CLOSING 1st
              STATE.setVolatile(this, STATE_CLOSING);
              // check for absence of active acquired children 2nd
              // IMPORTANT: 1st sum releases, then sum acquires !!!
              if (releases.sum() != acquires.sum()) {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -199,11 +190,10 @@</span>
                  if (cleanupAction != null) {
                      cleanupAction.run();
                  }
                  return null;
              } else {
<span class="udiff-line-removed">-                 // assert releases.sum() == acquires.sum() &amp;&amp; state == STATE_CLOSED;</span>
                  return duped;
              }
          }
  
          private final class Child extends MemoryScope {
</pre>
<center>&lt; prev <a href="../../../../../../../index.html" target="_top">index</a> next &gt;</center>  </body>
</html>