<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff make/common/JavaCompilation.gmk</title>
    <link rel="stylesheet" href="../../style.css" />
  </head>
<body>
<center><a href="../autoconf/spec.gmk.in.sdiff.html" target="_top">&lt; prev</a> <a href="../../index.html" target="_top">index</a> <a href="modules/CopyCommon.gmk.sdiff.html" target="_top">next &gt;</a></center>    <h2>make/common/JavaCompilation.gmk</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  6 # under the terms of the GNU General Public License version 2 only, as
  7 # published by the Free Software Foundation.  Oracle designates this
  8 # particular file as subject to the &quot;Classpath&quot; exception as provided
  9 # by Oracle in the LICENSE file that accompanied this code.
 10 #
 11 # This code is distributed in the hope that it will be useful, but WITHOUT
 12 # ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 13 # FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 14 # version 2 for more details (a copy is included in the LICENSE file that
 15 # accompanied this code).
 16 #
 17 # You should have received a copy of the GNU General Public License version
 18 # 2 along with this work; if not, write to the Free Software Foundation,
 19 # Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 20 #
 21 # Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 22 # or visit www.oracle.com if you need additional information or have any
 23 # questions.
 24 #
 25 
<span class="line-removed"> 26 # When you read this source. Remember that $(sort ...) has the side effect</span>
<span class="line-removed"> 27 # of removing duplicates. It is actually this side effect that is</span>
<span class="line-removed"> 28 # desired whenever sort is used below!</span>
<span class="line-removed"> 29 </span>
 30 ifndef _JAVA_COMPILATION_GMK
 31 _JAVA_COMPILATION_GMK := 1
 32 
 33 ifeq (,$(_MAKEBASE_GMK))
 34   $(error You must include MakeBase.gmk prior to including JavaCompilation.gmk)
 35 endif
 36 
 37 # Java compilation needs SetupJarArchive and/or SetupZipArchive, if we&#39;re
 38 # generating a jar file or a source zip.
 39 include JarArchive.gmk
 40 include ZipArchive.gmk
 41 
<span class="line-modified"> 42 # Setup make rules for defining a Java compiler, which is needed to compile</span>
<span class="line-modified"> 43 # Java code. This rule generates no output.</span>
<span class="line-modified"> 44 #</span>
<span class="line-modified"> 45 # Parameter 1 is the name of the compiler definition. This name needs to be</span>
<span class="line-modified"> 46 # passed to SetupJavaCompilation. This name is used as variable prefix.</span>
<span class="line-modified"> 47 #</span>
<span class="line-modified"> 48 # Remaining parameters are named arguments. These include:</span>
<span class="line-modified"> 49 #   JVM:=The jvm used to run the javac command</span>
<span class="line-modified"> 50 #   JAVAC:=The javac jar and bootstrap classpath changes, or just bin/javac if JVM is left out</span>
<span class="line-modified"> 51 #   FLAGS:=Flags to be supplied to javac</span>
<span class="line-modified"> 52 #   SERVER_DIR:=Use a javac server (-XDserver) and store the server related files here</span>
<span class="line-modified"> 53 #   SERVER_JVM:=Use this JVM for the server. Defaults to the JVM above.</span>
<span class="line-modified"> 54 #   DISABLE_SJAVAC:=Set to true if this setup does not support sjavac</span>
<span class="line-modified"> 55 SetupJavaCompiler = $(NamedParamsMacroTemplate)</span>
<span class="line-modified"> 56 define SetupJavaCompilerBody</span>
<span class="line-modified"> 57   # The port file contains the tcp/ip on which the server listens</span>
<span class="line-removed"> 58   # and the cookie necessary to talk to the server.</span>
<span class="line-removed"> 59   $1_SJAVAC_PORTFILE:=$$($1_SERVER_DIR)/server.port</span>
<span class="line-removed"> 60   # You can use a different JVM to run the background javac server.</span>
<span class="line-removed"> 61   ifeq ($$($1_SERVER_JVM),)</span>
<span class="line-removed"> 62     # It defaults to the same JVM that is used to start the javac command.</span>
<span class="line-removed"> 63     $1_SERVER_JVM:=$$($1_JVM)</span>
<span class="line-removed"> 64   endif</span>
<span class="line-removed"> 65 endef</span>
 66 
 67 define add_file_to_copy
 68   # param 1 = BUILD_MYPACKAGE
 69   # parma 2 = The source file to copy.
 70   $2_TARGET:=$2
 71   # Remove the source prefix.
 72   $$(foreach i,$$($1_SRC),$$(eval $$(call remove_string,$$i,$2_TARGET)))
 73   # To allow for automatic overrides, do not create a rule for a target file that
 74   # already has one
 75   ifneq ($$($1_COPY_$$($2_TARGET)), 1)
 76     $1_COPY_$$($2_TARGET) := 1
 77     # Now we can setup the dependency that will trigger the copying.
 78     $$($1_BIN)$$($1_MODULE_SUBDIR)$$($2_TARGET) : $2
<span class="line-modified"> 79 	$$(call LogInfo, Copying $$(patsubst $(OUTPUTDIR)/%,%, $$@))</span>
 80 	$$(install-file)
 81 	$(CHMOD) -f ug+w $$@
 82 
 83     # And do not forget this target
 84     $1_ALL_COPY_TARGETS += $$($1_BIN)$$($1_MODULE_SUBDIR)$$($2_TARGET)
 85   endif
 86 endef
 87 
 88 # This macro is used only for properties files that are to be
<span class="line-modified"> 89 # copied over to the classes directory in cleaned form:</span>
<span class="line-removed"> 90 # Previously this was inconsistently done in different repositories.</span>
<span class="line-removed"> 91 # This is the new clean standard. Though it is to be superseded by</span>
<span class="line-removed"> 92 # a standard annotation processor from with sjavac.</span>
 93 #
 94 # An empty echo ensures that the input to sed always ends with a newline.
 95 # Certain implementations (e.g. Solaris) will skip the last line without
 96 # it.
 97 #
 98 # The sed expression does this:
 99 # 1. Add a backslash before any :, = or ! that do not have a backslash already.
100 # 2. Apply the file unicode2x.sed which does a whole bunch of \u00XX to \xXX
101 #    conversions.
102 # 3. Delete all lines starting with #.
103 # 4. Delete empty lines.
104 # 5. Append lines ending with \ with the next line.
105 # 6. Remove leading and trailing white space. Note that tabs must be explicit
106 #    as sed on macosx does not understand &#39;\t&#39;.
107 # 7. Replace the first \= with just =.
108 # 8. Finally it&#39;s all sorted to create a stable output.
109 #
110 # It is assumed that = is the character used for separating names and values.
111 define add_file_to_clean
112   # param 1 = BUILD_MYPACKAGE
113   # parma 2 = The source file to copy and clean.
114   $2_TARGET:=$2
115   # Remove the source prefix.
116   $$(foreach i,$$($1_SRC),$$(eval $$(call remove_string,$$i,$2_TARGET)))
117   # Now we can setup the depency that will trigger the copying.
118   # To allow for automatic overrides, do not create a rule for a target file that
119   # already has one
120   ifneq ($$($1_CLEAN_$$($2_TARGET)), 1)
121     $1_CLEAN_$$($2_TARGET) := 1
122     $$($1_BIN)$$($1_MODULE_SUBDIR)$$($2_TARGET) : $2
<span class="line-modified">123 	$$(call LogInfo, Cleaning $$(patsubst $(OUTPUTDIR)/%,%, $$@))</span>
124 	$$(call MakeTargetDir)
125 	( $(CAT) $$&lt; &amp;&amp; $(ECHO) &quot;&quot; ) \
126 	    | $(SED) -e &#39;s/\([^\\]\):/\1\\:/g&#39; -e &#39;s/\([^\\]\)=/\1\\=/g&#39; \
127 	        -e &#39;s/\([^\\]\)!/\1\\!/g&#39; -e &#39;s/^[ 	]*#.*/#/g&#39; \
<span class="line-modified">128 	    | $(SED) -f &quot;$(TOPDIR)/make/common/support/unicode2x.sed&quot; \</span>
129 	    | $(SED) -e &#39;/^#/d&#39; -e &#39;/^$$$$/d&#39; \
130 	        -e :a -e &#39;/\\$$$$/N; s/\\\n//; ta&#39; \
131 	        -e &#39;s/^[ 	]*//;s/[ 	]*$$$$//&#39; \
132 	        -e &#39;s/\\=/=/&#39; \
133 	    | $(SORT) &gt; $$@
134 	$(CHMOD) -f ug+w $$@
135 
136     # And do not forget this target
137     $1_ALL_COPY_CLEAN_TARGETS += $$($1_BIN)$$($1_MODULE_SUBDIR)$$($2_TARGET)
138   endif
139 endef
140 
141 define remove_string
142   $2 := $$(subst $1,,$$($2))
143 endef
144 
145 # Setup make rules for compiling Java source code to class files and/or a
146 # resulting jar file.
147 #
148 # Parameter 1 is the name of the rule. This name is used as variable prefix,
149 # and the targets generated are listed in a variable by that name.
150 #
151 # The target for public API digest is returned in $1_API_TARGET.
152 #
153 # Remaining parameters are named arguments. These include:
<span class="line-modified">154 #   SETUP:=must point to a previously setup java compiler, for example: SETUP:=BOOTJAVAC</span>
<span class="line-modified">155 #   JVM:=path to ..bin/java</span>
<span class="line-modified">156 #   ADD_JAVAC_FLAGS:=javac flags to append to the default ones.</span>



157 #   DISABLED_WARNINGS:=list of Xlint warnings that should be disabled
158 #   SRC:=one or more directories to search for sources. The order of the source roots
159 #        is significant. The first found file of a certain name has priority.
160 #   BIN:=store classes here
161 #   MODULE:=Name of module being compiled. If set, classes are put in BIN/MODULE.
162 #   CLASSPATH:=a list of additional entries to set as classpath to javac
163 #   INCLUDES:=myapp.foo means will only compile java files in myapp.foo or any of its sub-packages.
164 #   EXCLUDES:=myapp.foo means will do not compile java files in myapp.foo or any of its sub-packages.
165 #   COPY:=.prp means copy all prp files to the corresponding package in BIN.
166 #   COPY_FILES:=myapp/foo/setting.txt means copy this file over to the package myapp/foo
167 #   CLEAN:=.properties means copy and clean all properties file to the corresponding package in BIN.
168 #   CLEAN_FILES:=myapp/foo/setting.txt means clean this file over to the package myapp/foo
169 #   SRCZIP:=Create a src.zip based on the found sources and copied files.
170 #   INCLUDE_FILES:=&quot;com/sun/SolarisFoobar.java&quot; means only compile this file!
171 #   EXCLUDE_FILES:=&quot;com/sun/SolarisFoobar.java&quot; means do not compile this particular file!
172 #       &quot;SolarisFoobar.java&quot; means do not compile SolarisFoobar, wherever it is found.
173 #   EXTRA_FILES:=List of extra source files to include in compilation. Can be used to
174 #       specify files that need to be generated by other rules first.
175 #   HEADERS:=path to directory where all generated c-headers are written.
176 #   DEPENDS:=Extra dependecy
<span class="line-removed">177 #   DISABLE_SJAVAC:=Explicitly disable the use of sjavac for this compilation unit.</span>
178 #   KEEP_DUPS:=Do not remove duplicate file names from different source roots.
179 #   FAIL_NO_SRC:=Set to false to not fail the build if no source files are found,
180 #        default is true.
<span class="line-removed">181 #   DEBUG_SYMBOLS:=Set to false to disable generation of debug symbols.</span>
182 #   CREATE_API_DIGEST:=Set to true to use a javac plugin to generate a public API
183 #        hash which can be used for down stream dependencies to only rebuild
<span class="line-modified">184 #        when the API changes. Implicitly used in sjavac.</span>
185 #   KEEP_ALL_TRANSLATIONS:=Set to true to skip translation filtering
186 SetupJavaCompilation = $(NamedParamsMacroTemplate)
187 define SetupJavaCompilationBody
188 
189   # Verify arguments
190   ifeq ($$($1_BIN),)
191     $$(error Must specify BIN (in $1))
192   endif
193 
<span class="line-modified">194   # Extract the info from the java compiler setup.</span>
<span class="line-modified">195   $1_JVM := $$($$($1_SETUP)_JVM)</span>
<span class="line-modified">196   $1_JAVAC := $$($$($1_SETUP)_JAVAC)</span>
<span class="line-modified">197   $1_FLAGS :=</span>
<span class="line-modified">198   ifneq ($$($1_DEBUG_SYMBOLS), false)</span>
<span class="line-modified">199     $1_FLAGS := -g</span>






















































200   endif
<span class="line-modified">201   $1_FLAGS += $$($$($1_SETUP)_FLAGS) $$($1_ADD_JAVAC_FLAGS) $(JAVAC_FLAGS)</span>








202 
203   ifneq ($$($1_DISABLED_WARNINGS), )
204     $1_FLAGS += -Xlint:$$(call CommaList, $$(addprefix -, $$($1_DISABLED_WARNINGS)))
205   endif
206 
207   ifneq ($$($1_CLASSPATH), )
208     $1_FLAGS += -cp $$(call PathList, $$($1_CLASSPATH))
209   endif
210 
<span class="line-removed">211   ifeq ($$($1_JAVAC),)</span>
<span class="line-removed">212     $$(error The Java compilation $1 refers to a non-existant java compiler setup $$($1_SETUP))</span>
<span class="line-removed">213   endif</span>
<span class="line-removed">214   $1_SJAVAC_PORTFILE := $$($$($1_SETUP)_SJAVAC_PORTFILE)</span>
<span class="line-removed">215   $1_SERVER_JVM := $$($$($1_SETUP)_SERVER_JVM)</span>
<span class="line-removed">216   $1_DISABLE_SJAVAC := $$($$($1_SETUP)_DISABLE_SJAVAC)</span>
<span class="line-removed">217 </span>
218   ifneq ($$($1_MODULE), )
219     $1_MODULE_SUBDIR := /$$($1_MODULE)
220   endif
221 
222   # Make sure the dirs exist, or that one of the EXTRA_FILES, that may not
223   # exist yet, is in it.
224   $$(foreach d, $$($1_SRC), \
225     $$(if $$(wildcard $$d), , \
226       $$(if $$(filter $$d%, $$($1_EXTRA_FILES)), , \
227         $$(error SRC specified to SetupJavaCompilation $1 contains missing directory &gt;$$d&lt;) \
228       ) \
229     ) \
230   )
231   $$(call MakeDir,$$($1_BIN))
232   # Order src files according to the order of the src dirs. Correct ordering is
233   # needed for correct overriding between different source roots.
234   $1_ALL_SRC_RAW := $$(call FindFiles, $$($1_SRC))
235   $1_ALL_SRCS := $$($1_EXTRA_FILES) \
236       $$(foreach d, $$($1_SRC), $$(filter $$d%, $$($1_ALL_SRC_RAW)))
237 
</pre>
<hr />
<pre>
247   endif
248   ifneq ($$($1_EXCLUDES), )
249     $1_EXCLUDE_PATTERN += $$(foreach i, $$($1_SRC), $$(addprefix $$i/, $$(addsuffix /%, $$($1_EXCLUDES))))
250   endif
251   ifneq ($$($1_INCLUDES), )
252     $1_INCLUDE_PATTERN += $$(foreach i, $$($1_SRC), $$(addprefix $$i/, $$(addsuffix /%, $$($1_INCLUDES))))
253   endif
254 
255   # Apply include/exclude patterns to java sources
256   ifneq ($$($1_EXCLUDE_PATTERN), )
257     $1_SRCS := $$(filter-out $$($1_EXCLUDE_PATTERN), $$($1_SRCS))
258   endif
259   ifneq ($$($1_INCLUDE_PATTERN), )
260     $1_SRCS := $$(filter $$($1_INCLUDE_PATTERN) $$($1_EXTRA_FILES), $$($1_SRCS))
261   endif
262 
263   ifneq ($$($1_KEEP_DUPS), true)
264     # Remove duplicate source files by keeping the first found of each duplicate.
265     # This allows for automatic overrides with custom or platform specific versions
266     # source files.
<span class="line-removed">267     #</span>
<span class="line-removed">268     # For the smart javac wrapper case, add each removed file to an extra exclude</span>
<span class="line-removed">269     # file list to prevent sjavac from finding duplicate sources.</span>
270     $1_SRCS := $$(strip $$(foreach s, $$($1_SRCS), \
271         $$(eval relative_src := $$(call remove-prefixes, $$($1_SRC), $$(s))) \
272         $$(if $$($1_$$(relative_src)), \
<span class="line-modified">273           $$(eval $1_SJAVAC_EXCLUDE_FILES += $$(s)), \</span>
274           $$(eval $1_$$(relative_src) := 1) $$(s))))
275   endif
276 
277   # Filter out any excluded translations
278   ifneq ($$($1_KEEP_ALL_TRANSLATIONS), true)
279     $1_SRCS := $$(call FilterExcludedTranslations, $$($1_SRCS), .java)
280   endif
281 
282   ifeq ($$(strip $$($1_SRCS)), )
283     ifneq ($$($1_FAIL_NO_SRC), false)
284       $$(error No source files found for $1)
285     endif
286   else
287 
288     $1_SAFE_NAME := $$(strip $$(subst /,_, $1))
289 
290     # All files below META-INF are always copied.
291     $1_ALL_COPIES := $$(filter $$(addsuffix /META-INF%,$$($1_SRC)),$$($1_ALL_SRCS))
292     # Find all files to be copied from source to bin.
293     ifneq (,$$($1_COPY)$$($1_COPY_FILES))
</pre>
<hr />
<pre>
326       endif
327       ifneq (,$$($1_EXCLUDE_PATTERN))
328         $1_ALL_CLEANS := $$(filter-out $$($1_EXCLUDE_PATTERN),$$($1_ALL_CLEANS))
329       endif
330       # Filter out any excluded translations
331       ifneq ($$($1_KEEP_ALL_TRANSLATIONS), true)
332         $1_ALL_CLEANS := $$(call FilterExcludedTranslations, $$($1_ALL_CLEANS), .properties)
333       endif
334       ifneq (,$$($1_ALL_CLEANS))
335         # Yep, there are files to be copied and cleaned!
336         $1_ALL_COPY_CLEAN_TARGETS:=
337             $$(foreach i,$$($1_ALL_CLEANS),$$(eval $$(call add_file_to_clean,$1,$$i)))
338         # Now we can depend on $$($1_ALL_COPY_CLEAN_TARGETS) to copy all files!
339       endif
340     endif
341 
342     # Create a sed expression to remove the source roots and to replace / with .
343     # and remove .java at the end.
344     $1_REWRITE_INTO_CLASSES:=$$(foreach i,$$($1_SRC),-e &#39;s|$$i/||g&#39;) -e &#39;s|/|.|g&#39; -e &#39;s|.java$$$$||g&#39;
345 
<span class="line-removed">346     # Create SJAVAC variable from JAVAC variable. Expects $1_JAVAC to be</span>
<span class="line-removed">347     # &quot;bootclasspathprepend -cp .../javac.jar com.sun.tools.javac.Main&quot;</span>
<span class="line-removed">348     # and javac is simply replaced with sjavac.</span>
<span class="line-removed">349     $1_SJAVAC:=$$(subst com.sun.tools.javac.Main,com.sun.tools.sjavac.Main,$$($1_JAVAC))</span>
<span class="line-removed">350 </span>
<span class="line-removed">351     # Set the $1_REMOTE to spawn a background javac server.</span>
<span class="line-removed">352     $1_REMOTE:=--server:portfile=$$($1_SJAVAC_PORTFILE),id=$1,sjavac=$$(subst \</span>
<span class="line-removed">353         $$(SPACE),%20,$$(subst $$(COMMA),%2C,$$(strip $$($1_SERVER_JVM) $$($1_SJAVAC))))</span>
<span class="line-removed">354 </span>
355     $1_COMPILE_TARGET := $$($1_BIN)$$($1_MODULE_SUBDIR)/_the.$1_batch
356     $1_API_TARGET := $$($1_BIN)$$($1_MODULE_SUBDIR)/_the.$1_pubapi
357 
<span class="line-modified">358     ifeq ($$($1_DISABLE_SJAVAC)x$$(ENABLE_SJAVAC),xyes)</span>
<span class="line-modified">359       # Using sjavac to compile.</span>
<span class="line-modified">360 </span>
<span class="line-modified">361       # Create the sjavac wrapper command line. Sjavac doesn&#39;t handle patterns that</span>
<span class="line-removed">362       # match the absolute path, only the part inside each src dir. Instead -i and</span>
<span class="line-removed">363       # -x flags apply only to the next -src arg on the command line.</span>
<span class="line-removed">364       $1_EXCLUDE_FILES_ABS := $$(filter /%, $$($1_EXCLUDE_FILES)) $$($1_SJAVAC_EXCLUDE_FILES)</span>
<span class="line-removed">365       $1_EXCLUDE_FILES_REL := $$(filter-out /%, $$($1_EXCLUDE_FILES))</span>
<span class="line-removed">366       $1_SJAVAC_ARGS_STRING := $$(foreach s, $$(patsubst %/, %, $$($1_SRC)), \</span>
<span class="line-removed">367           $$(addprefix -x ,$$(addsuffix /**,$$($1_EXCLUDES))) \</span>
<span class="line-removed">368           $$(addprefix -i ,$$(addsuffix /**,$$($1_INCLUDES))) \</span>
<span class="line-removed">369           $$(addprefix -x **,$$(strip $$($1_EXCLUDE_FILES_REL))) \</span>
<span class="line-removed">370           $$(addprefix -i **,$$(strip $$($1_INCLUDE_FILES))) \</span>
<span class="line-removed">371           $$(addprefix -x , $$(strip $$(patsubst $$(s)/%, %, $$(filter $$(s)/%, $$($1_EXCLUDE_FILES_ABS))))) \</span>
<span class="line-removed">372           -src $$(s))</span>
<span class="line-removed">373 </span>
<span class="line-removed">374       ifneq ($$(word 20, $$($1_SJAVAC_ARGS_STRING)), )</span>
<span class="line-removed">375         $1_SJAVAC_ARGS_FILE := $$($1_BIN)/_the.$1_args</span>
<span class="line-removed">376         $1_SJAVAC_ARGS := @$$($1_SJAVAC_ARGS_FILE)</span>
<span class="line-removed">377       else</span>
<span class="line-removed">378         $1_SJAVAC_ARGS := $$($1_SJAVAC_ARGS_STRING)</span>
<span class="line-removed">379       endif</span>
<span class="line-removed">380 </span>
<span class="line-removed">381 </span>
<span class="line-removed">382       ifneq (,$$($1_HEADERS))</span>
<span class="line-removed">383         $1_HEADERS_ARG := -h $$($1_HEADERS)</span>
<span class="line-removed">384       endif</span>
<span class="line-removed">385 </span>
<span class="line-removed">386       $1_VARDEPS := $$($1_JVM) $$($1_SJAVAC) $$($1_SJAVAC_ARGS_STRING) $$($1_FLAGS) \</span>
<span class="line-removed">387           $$($1_HEADERS_ARG) $$($1_BIN) $$($1_EXCLUDES) $$($1_INCLUDES) \</span>
<span class="line-removed">388           $$($1_EXCLUDE_FILES) $$($1_INCLUDE_FILES)</span>
<span class="line-removed">389       $1_VARDEPS_FILE := $$(call DependOnVariable, $1_VARDEPS, \</span>
<span class="line-removed">390           $$($1_BIN)$$($1_MODULE_SUBDIR)/_the.$1.vardeps)</span>
<span class="line-removed">391 </span>
<span class="line-removed">392       $$($1_COMPILE_TARGET): $$($1_SRCS) $$($1_DEPENDS) $$($1_VARDEPS_FILE)</span>
<span class="line-removed">393 		$$(call MakeDir, $$(@D) $$(dir $$($1_SJAVAC_PORTFILE)))</span>
<span class="line-removed">394 		$$(eval $$(call ListPathsSafely,$1_SRCS, $$@.tmp))</span>
<span class="line-removed">395                 ifneq ($$($1_SJAVAC_ARGS_FILE), )</span>
<span class="line-removed">396 		  $$(eval $$(call ListPathsSafely,$1_SJAVAC_ARGS_STRING, $$($1_SJAVAC_ARGS_FILE)))</span>
<span class="line-removed">397                 endif</span>
<span class="line-removed">398 		$$(call LogWarn, Compiling $1)</span>
<span class="line-removed">399 		$$(call ExecuteWithLog, $$($1_BIN)$$($1_MODULE_SUBDIR)/_the.$$($1_SAFE_NAME)_batch, \</span>
<span class="line-removed">400 		    $$($1_JVM) $$($1_SJAVAC) \</span>
<span class="line-removed">401 		        $$($1_REMOTE) \</span>
<span class="line-removed">402 		        -j 1 \</span>
<span class="line-removed">403 		        --permit-unidentified-artifacts \</span>
<span class="line-removed">404 		        --permit-sources-without-package \</span>
<span class="line-removed">405 		        --compare-found-sources $$@.tmp \</span>
<span class="line-removed">406 		        --log=$(LOG_LEVEL) \</span>
<span class="line-removed">407 		        --state-dir=$$($1_BIN)$$($1_MODULE_SUBDIR) \</span>
<span class="line-removed">408 		        $$($1_SJAVAC_ARGS) \</span>
<span class="line-removed">409 		        $$($1_FLAGS) \</span>
<span class="line-removed">410 		        $$($1_HEADERS_ARG) \</span>
<span class="line-removed">411 		        -d $$($1_BIN)) &amp;&amp; \</span>
<span class="line-removed">412 		$(MV) $$@.tmp $$@</span>
<span class="line-removed">413                 # Create a pubapi file that only changes when the pubapi changes. Dependent</span>
<span class="line-removed">414                 # compilations can use this file to only get recompiled when pubapi has changed.</span>
<span class="line-removed">415                 # Grep returns 1 if no matching lines are found. Do not fail for this.</span>
<span class="line-removed">416 		$(GREP) -e &quot;^I&quot; $$($1_BIN)$$($1_MODULE_SUBDIR)/javac_state \</span>
<span class="line-removed">417 		    &gt; $$($1_API_TARGET).tmp || test &quot;$$$$?&quot; = &quot;1&quot;</span>
<span class="line-removed">418 		if [ ! -f $$($1_API_TARGET) ] \</span>
<span class="line-removed">419 		    || [ &quot;`$(DIFF) $$($1_API_TARGET) $$($1_API_TARGET).tmp`&quot; != &quot;&quot; ]; then \</span>
<span class="line-removed">420 		  $(MV) $$($1_API_TARGET).tmp $$($1_API_TARGET); \</span>
<span class="line-removed">421 		fi</span>
<span class="line-removed">422 </span>
<span class="line-removed">423     else</span>
<span class="line-removed">424       # Using plain javac to batch compile everything.</span>
<span class="line-removed">425 </span>
<span class="line-removed">426       # When building in batch, put headers in a temp dir to filter out those that actually</span>
<span class="line-removed">427       # changed before copying them to the real header dir.</span>
<span class="line-removed">428       ifneq (,$$($1_HEADERS))</span>
<span class="line-removed">429         $1_HEADERS_ARG := -h $$($1_HEADERS).$1.tmp</span>
430 
<span class="line-modified">431         $$($1_HEADERS)/_the.$1_headers: $$($1_COMPILE_TARGET)</span>
432 		$$(call MakeTargetDir)
433 		if [ -d &quot;$$($1_HEADERS).$1.tmp&quot; ]; then \
434 		  for f in `$(CD) $$($1_HEADERS).$1.tmp &amp;&amp; $(FIND) . -type f`; do \
435 		    if [ ! -f &quot;$$($1_HEADERS)/$$$$f&quot; ] \
436 		        || [ &quot;`$(DIFF) $$($1_HEADERS)/$$$$f $$($1_HEADERS).$1.tmp/$$$$f`&quot; != &quot;&quot; ]; then \
437 		      $(MKDIR) -p `$(DIRNAME) $$($1_HEADERS)/$$$$f`; \
438 		      $(CP) -f $$($1_HEADERS).$1.tmp/$$$$f $$($1_HEADERS)/$$$$f; \
439 		    fi; \
440 		  done; \
441 		fi
442 		$(RM) -r $$($1_HEADERS).$1.tmp
443 		$(TOUCH) $$@
444 
<span class="line-modified">445         $1_HEADER_TARGETS := $$($1_HEADERS)/_the.$1_headers</span>
<span class="line-modified">446       endif</span>
<span class="line-removed">447 </span>
<span class="line-removed">448       $1_VARDEPS := $$($1_JVM) $$($1_JAVAC) $$($1_FLAGS) $$($1_BIN) \</span>
<span class="line-removed">449           $$($1_HEADERS_ARG) $$($1_EXCLUDES) $$($1_INCLUDES) \</span>
<span class="line-removed">450           $$($1_EXCLUDE_FILES) $$($1_INCLUDE_FILES)</span>
<span class="line-removed">451       $1_VARDEPS_FILE := $$(call DependOnVariable, $1_VARDEPS, \</span>
<span class="line-removed">452           $$($1_BIN)$$($1_MODULE_SUBDIR)/_the.$1.vardeps)</span>
453 
<span class="line-modified">454       ifeq ($$($1_DISABLE_SJAVAC)x$(ENABLE_JAVAC_SERVER), xyes)</span>
<span class="line-modified">455         $1_JAVAC_CMD := $$($1_SJAVAC) $$($1_REMOTE)</span>
<span class="line-modified">456       else</span>
<span class="line-modified">457         $1_JAVAC_CMD := $$($1_JAVAC)</span>
<span class="line-modified">458       endif</span>
459 
<span class="line-modified">460       ifeq ($$($1_CREATE_API_DIGEST), true)</span>
<span class="line-modified">461         $1_API_DIGEST_FLAGS := \</span>
<span class="line-modified">462             -classpath $(BUILDTOOLS_OUTPUTDIR)/depend \</span>
<span class="line-modified">463             -Xplugin:&quot;depend $$($1_API_TARGET)&quot; \</span>
<span class="line-modified">464             #</span>
465 
<span class="line-modified">466         $1_EXTRA_DEPS := $(BUILDTOOLS_OUTPUTDIR)/depend/_the.COMPILE_DEPEND_batch</span>
<span class="line-modified">467       endif</span>
468 
<span class="line-modified">469       # When not using sjavac, pass along all sources to javac using an @file.</span>
<span class="line-modified">470       $$($1_COMPILE_TARGET): $$($1_SRCS) $$($1_DEPENDS) $$($1_VARDEPS_FILE) \</span>
<span class="line-modified">471           $$($1_EXTRA_DEPS)</span>
472 		$$(call MakeDir, $$(@D))
473 		$$(eval $$(call ListPathsSafely,$1_SRCS, $$@.tmp))
474 		$$(call LogWarn, Compiling $$(words $$($1_SRCS)) files for $1)
475 		$$(call ExecuteWithLog, $$($1_BIN)$$($1_MODULE_SUBDIR)/_the.$$($1_SAFE_NAME)_batch, \
<span class="line-modified">476 		    $$($1_JVM) $$($1_JAVAC_CMD) $$($1_FLAGS) \</span>
<span class="line-removed">477 		        -implicit:none \</span>
478 		        $$($1_API_DIGEST_FLAGS) \
479 		        -d $$($1_BIN) $$($1_HEADERS_ARG) @$$@.tmp) &amp;&amp; \
480 		$(MV) $$@.tmp $$@
<span class="line-removed">481     endif</span>
482 
483     # Add all targets to main variable
484     $1 := $$($1_ALL_COPY_TARGETS) $$($1_ALL_COPY_CLEAN_TARGETS) $$($1_COMPILE_TARGET) \
485         $$($1_HEADER_TARGETS)
486 
487     # Check if a jar file was specified, then setup the rules for the jar.
488     ifneq (,$$($1_JAR))
489       # If no suffixes was explicitly set for this jar file.
490       # Use class and the cleaned/copied properties file suffixes as the default
491       # for the types of files to be put into the jar.
492       ifeq (,$$($1_SUFFIXES))
493         $1_SUFFIXES:=.class $$($1_CLEAN) $$($1_COPY)
494       endif
495 
496       $$(eval $$(call SetupJarArchive, ARCHIVE_$1, \
497           DEPENDENCIES:=$$($1), \
498           SRCS:=$$($1_BIN)$$($1_MODULE_SUBDIR), \
499           SUFFIXES:=$$($1_SUFFIXES), \
500           EXCLUDE:=$$($1_EXCLUDES), \
501           INCLUDES:=$$($1_INCLUDES), \
502           EXTRA_FILES:=$$($1_ALL_COPY_TARGETS) $$($1_ALL_COPY_CLEAN_TARGETS), \
503           JAR:=$$($1_JAR), \
504           JARMAIN:=$$($1_JARMAIN), \
505           MANIFEST:=$$($1_MANIFEST), \
506           EXTRA_MANIFEST_ATTR:=$$($1_EXTRA_MANIFEST_ATTR), \
507           JARINDEX:=$$($1_JARINDEX), \
508           HEADERS:=$$($1_HEADERS), \
<span class="line-removed">509           SETUP:=$$($1_SETUP), \</span>
510       ))
511 
512       # Add jar to target list
513       $1 += $$($1_JAR)
514     endif
515 
516     # Check if a srczip was specified, then setup the rules for the srczip.
517     ifneq (,$$($1_SRCZIP))
518       $$(eval $$(call SetupZipArchive, ZIP_ARCHIVE_$1, \
519           SRC:=$$($1_SRC), \
520           ZIP:=$$($1_SRCZIP), \
521           INCLUDES:=$$($1_INCLUDES), \
522           EXCLUDES:=$$($1_EXCLUDES), \
523           EXCLUDE_FILES:=$$($1_EXCLUDE_FILES)))
524 
525       # Add zip to target list
526       $1 += $$($1_SRCZIP)
527     endif
528   endif # Source files found
529 endef
</pre>
</td>
<td>
<hr />
<pre>
  6 # under the terms of the GNU General Public License version 2 only, as
  7 # published by the Free Software Foundation.  Oracle designates this
  8 # particular file as subject to the &quot;Classpath&quot; exception as provided
  9 # by Oracle in the LICENSE file that accompanied this code.
 10 #
 11 # This code is distributed in the hope that it will be useful, but WITHOUT
 12 # ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 13 # FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 14 # version 2 for more details (a copy is included in the LICENSE file that
 15 # accompanied this code).
 16 #
 17 # You should have received a copy of the GNU General Public License version
 18 # 2 along with this work; if not, write to the Free Software Foundation,
 19 # Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 20 #
 21 # Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 22 # or visit www.oracle.com if you need additional information or have any
 23 # questions.
 24 #
 25 




 26 ifndef _JAVA_COMPILATION_GMK
 27 _JAVA_COMPILATION_GMK := 1
 28 
 29 ifeq (,$(_MAKEBASE_GMK))
 30   $(error You must include MakeBase.gmk prior to including JavaCompilation.gmk)
 31 endif
 32 
 33 # Java compilation needs SetupJarArchive and/or SetupZipArchive, if we&#39;re
 34 # generating a jar file or a source zip.
 35 include JarArchive.gmk
 36 include ZipArchive.gmk
 37 
<span class="line-modified"> 38 ###</span>
<span class="line-modified"> 39 ### Definitions for common release targets</span>
<span class="line-modified"> 40 ###</span>
<span class="line-modified"> 41 </span>
<span class="line-modified"> 42 # Create classes that can run on the bootjdk</span>
<span class="line-modified"> 43 TARGET_RELEASE_BOOTJDK := $(BOOT_JDK_SOURCETARGET)</span>
<span class="line-modified"> 44 </span>
<span class="line-modified"> 45 # Create classes that can be used in (or be a part of) the new jdk we&#39;re building</span>
<span class="line-modified"> 46 TARGET_RELEASE_NEWJDK := -source $(JDK_SOURCE_TARGET_VERSION) -target $(JDK_SOURCE_TARGET_VERSION)</span>
<span class="line-modified"> 47 </span>
<span class="line-modified"> 48 # Create classes that can be used in JDK 8, for legacy support</span>
<span class="line-modified"> 49 TARGET_RELEASE_JDK8 := --release 8</span>
<span class="line-modified"> 50 </span>
<span class="line-modified"> 51 # Create classes for the new jdk, relying only on the modules of the new jdk</span>
<span class="line-modified"> 52 TARGET_RELEASE_NEWJDK_UPGRADED := $(TARGET_RELEASE_NEWJDK) \</span>
<span class="line-modified"> 53     --upgrade-module-path $(JDK_OUTPUTDIR)/modules --system none</span>








 54 
 55 define add_file_to_copy
 56   # param 1 = BUILD_MYPACKAGE
 57   # parma 2 = The source file to copy.
 58   $2_TARGET:=$2
 59   # Remove the source prefix.
 60   $$(foreach i,$$($1_SRC),$$(eval $$(call remove_string,$$i,$2_TARGET)))
 61   # To allow for automatic overrides, do not create a rule for a target file that
 62   # already has one
 63   ifneq ($$($1_COPY_$$($2_TARGET)), 1)
 64     $1_COPY_$$($2_TARGET) := 1
 65     # Now we can setup the dependency that will trigger the copying.
 66     $$($1_BIN)$$($1_MODULE_SUBDIR)$$($2_TARGET) : $2
<span class="line-modified"> 67 	$$(call LogInfo, Copying $$(patsubst $$(OUTPUTDIR)/%,%, $$@))</span>
 68 	$$(install-file)
 69 	$(CHMOD) -f ug+w $$@
 70 
 71     # And do not forget this target
 72     $1_ALL_COPY_TARGETS += $$($1_BIN)$$($1_MODULE_SUBDIR)$$($2_TARGET)
 73   endif
 74 endef
 75 
 76 # This macro is used only for properties files that are to be
<span class="line-modified"> 77 # copied over to the classes directory in cleaned form.</span>



 78 #
 79 # An empty echo ensures that the input to sed always ends with a newline.
 80 # Certain implementations (e.g. Solaris) will skip the last line without
 81 # it.
 82 #
 83 # The sed expression does this:
 84 # 1. Add a backslash before any :, = or ! that do not have a backslash already.
 85 # 2. Apply the file unicode2x.sed which does a whole bunch of \u00XX to \xXX
 86 #    conversions.
 87 # 3. Delete all lines starting with #.
 88 # 4. Delete empty lines.
 89 # 5. Append lines ending with \ with the next line.
 90 # 6. Remove leading and trailing white space. Note that tabs must be explicit
 91 #    as sed on macosx does not understand &#39;\t&#39;.
 92 # 7. Replace the first \= with just =.
 93 # 8. Finally it&#39;s all sorted to create a stable output.
 94 #
 95 # It is assumed that = is the character used for separating names and values.
 96 define add_file_to_clean
 97   # param 1 = BUILD_MYPACKAGE
 98   # parma 2 = The source file to copy and clean.
 99   $2_TARGET:=$2
100   # Remove the source prefix.
101   $$(foreach i,$$($1_SRC),$$(eval $$(call remove_string,$$i,$2_TARGET)))
102   # Now we can setup the depency that will trigger the copying.
103   # To allow for automatic overrides, do not create a rule for a target file that
104   # already has one
105   ifneq ($$($1_CLEAN_$$($2_TARGET)), 1)
106     $1_CLEAN_$$($2_TARGET) := 1
107     $$($1_BIN)$$($1_MODULE_SUBDIR)$$($2_TARGET) : $2
<span class="line-modified">108 	$$(call LogInfo, Cleaning $$(patsubst $$(OUTPUTDIR)/%,%, $$@))</span>
109 	$$(call MakeTargetDir)
110 	( $(CAT) $$&lt; &amp;&amp; $(ECHO) &quot;&quot; ) \
111 	    | $(SED) -e &#39;s/\([^\\]\):/\1\\:/g&#39; -e &#39;s/\([^\\]\)=/\1\\=/g&#39; \
112 	        -e &#39;s/\([^\\]\)!/\1\\!/g&#39; -e &#39;s/^[ 	]*#.*/#/g&#39; \
<span class="line-modified">113 	    | $(SED) -f &quot;$$(TOPDIR)/make/common/support/unicode2x.sed&quot; \</span>
114 	    | $(SED) -e &#39;/^#/d&#39; -e &#39;/^$$$$/d&#39; \
115 	        -e :a -e &#39;/\\$$$$/N; s/\\\n//; ta&#39; \
116 	        -e &#39;s/^[ 	]*//;s/[ 	]*$$$$//&#39; \
117 	        -e &#39;s/\\=/=/&#39; \
118 	    | $(SORT) &gt; $$@
119 	$(CHMOD) -f ug+w $$@
120 
121     # And do not forget this target
122     $1_ALL_COPY_CLEAN_TARGETS += $$($1_BIN)$$($1_MODULE_SUBDIR)$$($2_TARGET)
123   endif
124 endef
125 
126 define remove_string
127   $2 := $$(subst $1,,$$($2))
128 endef
129 
130 # Setup make rules for compiling Java source code to class files and/or a
131 # resulting jar file.
132 #
133 # Parameter 1 is the name of the rule. This name is used as variable prefix,
134 # and the targets generated are listed in a variable by that name.
135 #
136 # The target for public API digest is returned in $1_API_TARGET.
137 #
138 # Remaining parameters are named arguments. These include:
<span class="line-modified">139 #   SMALL_JAVA:=set to false to run javac as a &quot;big&quot; java app</span>
<span class="line-modified">140 #   COMPILER:=bootjdk or interim, the latter is default</span>
<span class="line-modified">141 #   TARGET_RELEASE:=javac flags to set the targeted jdk release (-source/-target or --release)</span>
<span class="line-added">142 #   Defaults to $(TARGET_RELEASE_NEWJDK).</span>
<span class="line-added">143 #   JAVAC_FLAGS:=javac flags to append to the default ones.</span>
<span class="line-added">144 #   JAVA_FLAGS:=flags to be appended to the java launching the compiler</span>
145 #   DISABLED_WARNINGS:=list of Xlint warnings that should be disabled
146 #   SRC:=one or more directories to search for sources. The order of the source roots
147 #        is significant. The first found file of a certain name has priority.
148 #   BIN:=store classes here
149 #   MODULE:=Name of module being compiled. If set, classes are put in BIN/MODULE.
150 #   CLASSPATH:=a list of additional entries to set as classpath to javac
151 #   INCLUDES:=myapp.foo means will only compile java files in myapp.foo or any of its sub-packages.
152 #   EXCLUDES:=myapp.foo means will do not compile java files in myapp.foo or any of its sub-packages.
153 #   COPY:=.prp means copy all prp files to the corresponding package in BIN.
154 #   COPY_FILES:=myapp/foo/setting.txt means copy this file over to the package myapp/foo
155 #   CLEAN:=.properties means copy and clean all properties file to the corresponding package in BIN.
156 #   CLEAN_FILES:=myapp/foo/setting.txt means clean this file over to the package myapp/foo
157 #   SRCZIP:=Create a src.zip based on the found sources and copied files.
158 #   INCLUDE_FILES:=&quot;com/sun/SolarisFoobar.java&quot; means only compile this file!
159 #   EXCLUDE_FILES:=&quot;com/sun/SolarisFoobar.java&quot; means do not compile this particular file!
160 #       &quot;SolarisFoobar.java&quot; means do not compile SolarisFoobar, wherever it is found.
161 #   EXTRA_FILES:=List of extra source files to include in compilation. Can be used to
162 #       specify files that need to be generated by other rules first.
163 #   HEADERS:=path to directory where all generated c-headers are written.
164 #   DEPENDS:=Extra dependecy

165 #   KEEP_DUPS:=Do not remove duplicate file names from different source roots.
166 #   FAIL_NO_SRC:=Set to false to not fail the build if no source files are found,
167 #        default is true.

168 #   CREATE_API_DIGEST:=Set to true to use a javac plugin to generate a public API
169 #        hash which can be used for down stream dependencies to only rebuild
<span class="line-modified">170 #        when the API changes.</span>
171 #   KEEP_ALL_TRANSLATIONS:=Set to true to skip translation filtering
172 SetupJavaCompilation = $(NamedParamsMacroTemplate)
173 define SetupJavaCompilationBody
174 
175   # Verify arguments
176   ifeq ($$($1_BIN),)
177     $$(error Must specify BIN (in $1))
178   endif
179 
<span class="line-modified">180   ifeq ($$($1_SMALL_JAVA), )</span>
<span class="line-modified">181     # If unspecified, default to true</span>
<span class="line-modified">182     $1_SMALL_JAVA := true</span>
<span class="line-modified">183   endif</span>
<span class="line-modified">184 </span>
<span class="line-modified">185   ifeq ($$($1_COMPILER), )</span>
<span class="line-added">186     # If unspecified, default to interim compiler</span>
<span class="line-added">187     $1_COMPILER := interim</span>
<span class="line-added">188   endif</span>
<span class="line-added">189 </span>
<span class="line-added">190   ifeq ($$($1_COMPILER), bootjdk)</span>
<span class="line-added">191     # Javac server is not available when using the bootjdk compiler.</span>
<span class="line-added">192     $1_JAVAC_CMD := $$(JAVAC)</span>
<span class="line-added">193 </span>
<span class="line-added">194     ifeq ($$($1_SMALL_JAVA), true)</span>
<span class="line-added">195       $1_FLAGS += $$(addprefix -J, $$(JAVA_FLAGS_SMALL))</span>
<span class="line-added">196     endif</span>
<span class="line-added">197     ifeq ($$($1_JAVA_FLAGS), true)</span>
<span class="line-added">198       $1_FLAGS += $$(addprefix -J, $$($1_JAVA_FLAGS))</span>
<span class="line-added">199     endif</span>
<span class="line-added">200 </span>
<span class="line-added">201     ifeq ($$($1_TARGET_RELEASE), )</span>
<span class="line-added">202       # If unspecified, default to the new jdk we&#39;re building</span>
<span class="line-added">203       $1_TARGET_RELEASE := $$(TARGET_RELEASE_BOOTJDK)</span>
<span class="line-added">204     endif</span>
<span class="line-added">205   else ifeq ($$($1_COMPILER), interim)</span>
<span class="line-added">206     # Use java server if it is enabled, and the user does not want a specialized</span>
<span class="line-added">207     # class path.</span>
<span class="line-added">208     ifeq ($$(ENABLE_JAVAC_SERVER)+$$($1_CLASSPATH), true+)</span>
<span class="line-added">209       $1_JAVAC := $$(INTERIM_LANGTOOLS_ARGS) -m jdk.compiler.interim/com.sun.tools.sjavac.Main</span>
<span class="line-added">210 </span>
<span class="line-added">211       # How to launch the server. This must use JAVA_DETACH, which is the &quot;big&quot; java</span>
<span class="line-added">212       # with an ability to detach from fixpath (on Windows)</span>
<span class="line-added">213       # This will be executed by the client, if needed.</span>
<span class="line-added">214       $1_JAVAC_SERVER_CMD := $$(JAVA_DETACH) $$($1_JAVA_FLAGS) $$($1_JAVAC)</span>
<span class="line-added">215       $1_ESCAPED_CMD := $$(subst $$(SPACE),%20,$$(subst $$(COMMA),%2C,$$(strip $$($1_JAVAC_SERVER_CMD))))</span>
<span class="line-added">216 </span>
<span class="line-added">217       # The port file contains the tcp/ip on which the server listens</span>
<span class="line-added">218       # and the cookie necessary to talk to the server.</span>
<span class="line-added">219       $1_JAVA_SERVER_FLAGS := --server:portfile=$$(SJAVAC_SERVER_DIR)/server.port,sjavac=$$($1_ESCAPED_CMD)</span>
<span class="line-added">220 </span>
<span class="line-added">221       # Always use small to launch client</span>
<span class="line-added">222       $1_JAVAC_CMD := $$(JAVA_SMALL) $$($1_JAVA_FLAGS) $$($1_JAVAC) $$($1_JAVA_SERVER_FLAGS)</span>
<span class="line-added">223     else</span>
<span class="line-added">224       # No javac server</span>
<span class="line-added">225       $1_JAVAC := $$(INTERIM_LANGTOOLS_ARGS) -m jdk.compiler.interim/com.sun.tools.javac.Main</span>
<span class="line-added">226 </span>
<span class="line-added">227       ifeq ($$($1_SMALL_JAVA), true)</span>
<span class="line-added">228        $1_JAVAC_CMD := $$(JAVA_SMALL) $$($1_JAVA_FLAGS) $$($1_JAVAC)</span>
<span class="line-added">229       else</span>
<span class="line-added">230        $1_JAVAC_CMD := $$(JAVA) $$($1_JAVA_FLAGS) $$($1_JAVAC)</span>
<span class="line-added">231       endif</span>
<span class="line-added">232     endif</span>
<span class="line-added">233 </span>
<span class="line-added">234     ifeq ($$($1_TARGET_RELEASE), )</span>
<span class="line-added">235       # If unspecified, default to the new jdk we&#39;re building</span>
<span class="line-added">236       $1_TARGET_RELEASE := $$(TARGET_RELEASE_NEWJDK)</span>
<span class="line-added">237     endif</span>
<span class="line-added">238   else</span>
<span class="line-added">239     $$(error Invalid value for COMPILER in SetupJavaCompilation for $1: &#39;$$($1_COMPILER)&#39;)</span>
240   endif
<span class="line-modified">241 </span>
<span class="line-added">242   # Allow overriding on the command line</span>
<span class="line-added">243   JAVA_WARNINGS_ARE_ERRORS ?= -Werror</span>
<span class="line-added">244 </span>
<span class="line-added">245   # Tell javac to do exactly as told and no more</span>
<span class="line-added">246   PARANOIA_FLAGS := -implicit:none -Xprefer:source -XDignore.symbol.file=true -encoding ascii</span>
<span class="line-added">247 </span>
<span class="line-added">248   $1_FLAGS += -g -Xlint:all --doclint-format html5 $$($1_TARGET_RELEASE) $$(PARANOIA_FLAGS) $$(JAVA_WARNINGS_ARE_ERRORS)</span>
<span class="line-added">249   $1_FLAGS += $$($1_JAVAC_FLAGS)</span>
250 
251   ifneq ($$($1_DISABLED_WARNINGS), )
252     $1_FLAGS += -Xlint:$$(call CommaList, $$(addprefix -, $$($1_DISABLED_WARNINGS)))
253   endif
254 
255   ifneq ($$($1_CLASSPATH), )
256     $1_FLAGS += -cp $$(call PathList, $$($1_CLASSPATH))
257   endif
258 







259   ifneq ($$($1_MODULE), )
260     $1_MODULE_SUBDIR := /$$($1_MODULE)
261   endif
262 
263   # Make sure the dirs exist, or that one of the EXTRA_FILES, that may not
264   # exist yet, is in it.
265   $$(foreach d, $$($1_SRC), \
266     $$(if $$(wildcard $$d), , \
267       $$(if $$(filter $$d%, $$($1_EXTRA_FILES)), , \
268         $$(error SRC specified to SetupJavaCompilation $1 contains missing directory &gt;$$d&lt;) \
269       ) \
270     ) \
271   )
272   $$(call MakeDir,$$($1_BIN))
273   # Order src files according to the order of the src dirs. Correct ordering is
274   # needed for correct overriding between different source roots.
275   $1_ALL_SRC_RAW := $$(call FindFiles, $$($1_SRC))
276   $1_ALL_SRCS := $$($1_EXTRA_FILES) \
277       $$(foreach d, $$($1_SRC), $$(filter $$d%, $$($1_ALL_SRC_RAW)))
278 
</pre>
<hr />
<pre>
288   endif
289   ifneq ($$($1_EXCLUDES), )
290     $1_EXCLUDE_PATTERN += $$(foreach i, $$($1_SRC), $$(addprefix $$i/, $$(addsuffix /%, $$($1_EXCLUDES))))
291   endif
292   ifneq ($$($1_INCLUDES), )
293     $1_INCLUDE_PATTERN += $$(foreach i, $$($1_SRC), $$(addprefix $$i/, $$(addsuffix /%, $$($1_INCLUDES))))
294   endif
295 
296   # Apply include/exclude patterns to java sources
297   ifneq ($$($1_EXCLUDE_PATTERN), )
298     $1_SRCS := $$(filter-out $$($1_EXCLUDE_PATTERN), $$($1_SRCS))
299   endif
300   ifneq ($$($1_INCLUDE_PATTERN), )
301     $1_SRCS := $$(filter $$($1_INCLUDE_PATTERN) $$($1_EXTRA_FILES), $$($1_SRCS))
302   endif
303 
304   ifneq ($$($1_KEEP_DUPS), true)
305     # Remove duplicate source files by keeping the first found of each duplicate.
306     # This allows for automatic overrides with custom or platform specific versions
307     # source files.



308     $1_SRCS := $$(strip $$(foreach s, $$($1_SRCS), \
309         $$(eval relative_src := $$(call remove-prefixes, $$($1_SRC), $$(s))) \
310         $$(if $$($1_$$(relative_src)), \
<span class="line-modified">311           , \</span>
312           $$(eval $1_$$(relative_src) := 1) $$(s))))
313   endif
314 
315   # Filter out any excluded translations
316   ifneq ($$($1_KEEP_ALL_TRANSLATIONS), true)
317     $1_SRCS := $$(call FilterExcludedTranslations, $$($1_SRCS), .java)
318   endif
319 
320   ifeq ($$(strip $$($1_SRCS)), )
321     ifneq ($$($1_FAIL_NO_SRC), false)
322       $$(error No source files found for $1)
323     endif
324   else
325 
326     $1_SAFE_NAME := $$(strip $$(subst /,_, $1))
327 
328     # All files below META-INF are always copied.
329     $1_ALL_COPIES := $$(filter $$(addsuffix /META-INF%,$$($1_SRC)),$$($1_ALL_SRCS))
330     # Find all files to be copied from source to bin.
331     ifneq (,$$($1_COPY)$$($1_COPY_FILES))
</pre>
<hr />
<pre>
364       endif
365       ifneq (,$$($1_EXCLUDE_PATTERN))
366         $1_ALL_CLEANS := $$(filter-out $$($1_EXCLUDE_PATTERN),$$($1_ALL_CLEANS))
367       endif
368       # Filter out any excluded translations
369       ifneq ($$($1_KEEP_ALL_TRANSLATIONS), true)
370         $1_ALL_CLEANS := $$(call FilterExcludedTranslations, $$($1_ALL_CLEANS), .properties)
371       endif
372       ifneq (,$$($1_ALL_CLEANS))
373         # Yep, there are files to be copied and cleaned!
374         $1_ALL_COPY_CLEAN_TARGETS:=
375             $$(foreach i,$$($1_ALL_CLEANS),$$(eval $$(call add_file_to_clean,$1,$$i)))
376         # Now we can depend on $$($1_ALL_COPY_CLEAN_TARGETS) to copy all files!
377       endif
378     endif
379 
380     # Create a sed expression to remove the source roots and to replace / with .
381     # and remove .java at the end.
382     $1_REWRITE_INTO_CLASSES:=$$(foreach i,$$($1_SRC),-e &#39;s|$$i/||g&#39;) -e &#39;s|/|.|g&#39; -e &#39;s|.java$$$$||g&#39;
383 









384     $1_COMPILE_TARGET := $$($1_BIN)$$($1_MODULE_SUBDIR)/_the.$1_batch
385     $1_API_TARGET := $$($1_BIN)$$($1_MODULE_SUBDIR)/_the.$1_pubapi
386 
<span class="line-modified">387     # Put headers in a temp dir to filter out those that actually</span>
<span class="line-modified">388     # changed before copying them to the real header dir.</span>
<span class="line-modified">389     ifneq (,$$($1_HEADERS))</span>
<span class="line-modified">390       $1_HEADERS_ARG := -h $$($1_HEADERS).$1.tmp</span>




































































391 
<span class="line-modified">392       $$($1_HEADERS)/_the.$1_headers: $$($1_COMPILE_TARGET)</span>
393 		$$(call MakeTargetDir)
394 		if [ -d &quot;$$($1_HEADERS).$1.tmp&quot; ]; then \
395 		  for f in `$(CD) $$($1_HEADERS).$1.tmp &amp;&amp; $(FIND) . -type f`; do \
396 		    if [ ! -f &quot;$$($1_HEADERS)/$$$$f&quot; ] \
397 		        || [ &quot;`$(DIFF) $$($1_HEADERS)/$$$$f $$($1_HEADERS).$1.tmp/$$$$f`&quot; != &quot;&quot; ]; then \
398 		      $(MKDIR) -p `$(DIRNAME) $$($1_HEADERS)/$$$$f`; \
399 		      $(CP) -f $$($1_HEADERS).$1.tmp/$$$$f $$($1_HEADERS)/$$$$f; \
400 		    fi; \
401 		  done; \
402 		fi
403 		$(RM) -r $$($1_HEADERS).$1.tmp
404 		$(TOUCH) $$@
405 
<span class="line-modified">406       $1_HEADER_TARGETS := $$($1_HEADERS)/_the.$1_headers</span>
<span class="line-modified">407     endif</span>






408 
<span class="line-modified">409     $1_VARDEPS := $$($1_JAVAC_CMD) $$($1_FLAGS) $$($1_BIN) \</span>
<span class="line-modified">410         $$($1_HEADERS_ARG) $$($1_EXCLUDES) $$($1_INCLUDES) \</span>
<span class="line-modified">411         $$($1_EXCLUDE_FILES) $$($1_INCLUDE_FILES)</span>
<span class="line-modified">412     $1_VARDEPS_FILE := $$(call DependOnVariable, $1_VARDEPS, \</span>
<span class="line-modified">413         $$($1_BIN)$$($1_MODULE_SUBDIR)/_the.$1.vardeps)</span>
414 
<span class="line-modified">415     ifeq ($$($1_CREATE_API_DIGEST), true)</span>
<span class="line-modified">416       $1_API_DIGEST_FLAGS := \</span>
<span class="line-modified">417           -classpath $$(BUILDTOOLS_OUTPUTDIR)/depend \</span>
<span class="line-modified">418           -Xplugin:&quot;depend $$($1_API_TARGET)&quot; \</span>
<span class="line-modified">419           #</span>
420 
<span class="line-modified">421       $1_EXTRA_DEPS := $$(BUILDTOOLS_OUTPUTDIR)/depend/_the.COMPILE_DEPEND_batch</span>
<span class="line-modified">422     endif</span>
423 
<span class="line-modified">424     # Pass along all sources to javac using an @file.</span>
<span class="line-modified">425     $$($1_COMPILE_TARGET): $$($1_SRCS) $$($1_DEPENDS) $$($1_VARDEPS_FILE) \</span>
<span class="line-modified">426         $$($1_EXTRA_DEPS)</span>
427 		$$(call MakeDir, $$(@D))
428 		$$(eval $$(call ListPathsSafely,$1_SRCS, $$@.tmp))
429 		$$(call LogWarn, Compiling $$(words $$($1_SRCS)) files for $1)
430 		$$(call ExecuteWithLog, $$($1_BIN)$$($1_MODULE_SUBDIR)/_the.$$($1_SAFE_NAME)_batch, \
<span class="line-modified">431 		    $$($1_JAVAC_CMD) $$($1_FLAGS) \</span>

432 		        $$($1_API_DIGEST_FLAGS) \
433 		        -d $$($1_BIN) $$($1_HEADERS_ARG) @$$@.tmp) &amp;&amp; \
434 		$(MV) $$@.tmp $$@

435 
436     # Add all targets to main variable
437     $1 := $$($1_ALL_COPY_TARGETS) $$($1_ALL_COPY_CLEAN_TARGETS) $$($1_COMPILE_TARGET) \
438         $$($1_HEADER_TARGETS)
439 
440     # Check if a jar file was specified, then setup the rules for the jar.
441     ifneq (,$$($1_JAR))
442       # If no suffixes was explicitly set for this jar file.
443       # Use class and the cleaned/copied properties file suffixes as the default
444       # for the types of files to be put into the jar.
445       ifeq (,$$($1_SUFFIXES))
446         $1_SUFFIXES:=.class $$($1_CLEAN) $$($1_COPY)
447       endif
448 
449       $$(eval $$(call SetupJarArchive, ARCHIVE_$1, \
450           DEPENDENCIES:=$$($1), \
451           SRCS:=$$($1_BIN)$$($1_MODULE_SUBDIR), \
452           SUFFIXES:=$$($1_SUFFIXES), \
453           EXCLUDE:=$$($1_EXCLUDES), \
454           INCLUDES:=$$($1_INCLUDES), \
455           EXTRA_FILES:=$$($1_ALL_COPY_TARGETS) $$($1_ALL_COPY_CLEAN_TARGETS), \
456           JAR:=$$($1_JAR), \
457           JARMAIN:=$$($1_JARMAIN), \
458           MANIFEST:=$$($1_MANIFEST), \
459           EXTRA_MANIFEST_ATTR:=$$($1_EXTRA_MANIFEST_ATTR), \
460           JARINDEX:=$$($1_JARINDEX), \
461           HEADERS:=$$($1_HEADERS), \

462       ))
463 
464       # Add jar to target list
465       $1 += $$($1_JAR)
466     endif
467 
468     # Check if a srczip was specified, then setup the rules for the srczip.
469     ifneq (,$$($1_SRCZIP))
470       $$(eval $$(call SetupZipArchive, ZIP_ARCHIVE_$1, \
471           SRC:=$$($1_SRC), \
472           ZIP:=$$($1_SRCZIP), \
473           INCLUDES:=$$($1_INCLUDES), \
474           EXCLUDES:=$$($1_EXCLUDES), \
475           EXCLUDE_FILES:=$$($1_EXCLUDE_FILES)))
476 
477       # Add zip to target list
478       $1 += $$($1_SRCZIP)
479     endif
480   endif # Source files found
481 endef
</pre>
</td>
</tr>
</table>
<center><a href="../autoconf/spec.gmk.in.sdiff.html" target="_top">&lt; prev</a> <a href="../../index.html" target="_top">index</a> <a href="modules/CopyCommon.gmk.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>