<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff make/autoconf/boot-jdk.m4</title>
    <link rel="stylesheet" href="../../style.css" />
  </head>
<body>
<center><a href="../ToolsLangtools.gmk.sdiff.html" target="_top">&lt; prev</a> <a href="../../index.html" target="_top">index</a> <a href="bootcycle-spec.gmk.in.sdiff.html" target="_top">next &gt;</a></center>    <h2>make/autoconf/boot-jdk.m4</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
330     AC_MSG_NOTICE([Could not find a valid Boot JDK. $HELP_MSG])
331     AC_MSG_NOTICE([This might be fixed by explicitly setting --with-boot-jdk])
332     AC_MSG_ERROR([Cannot continue])
333   fi
334 
335   AC_SUBST(BOOT_JDK)
336 
337   # Setup tools from the Boot JDK.
338   BOOTJDK_CHECK_TOOL_IN_BOOTJDK(JAVA, java$EXE_SUFFIX)
339   BOOTJDK_CHECK_TOOL_IN_BOOTJDK(JAVAC, javac$EXE_SUFFIX)
340   BOOTJDK_CHECK_TOOL_IN_BOOTJDK(JAVADOC, javadoc$EXE_SUFFIX)
341   BOOTJDK_CHECK_TOOL_IN_BOOTJDK(JAR, jar$EXE_SUFFIX)
342   BOOTJDK_CHECK_TOOL_IN_BOOTJDK(JARSIGNER, jarsigner$EXE_SUFFIX)
343 
344   # Finally, set some other options...
345 
346   # When compiling code to be executed by the Boot JDK, force compatibility with the
347   # oldest supported bootjdk.
348   OLDEST_BOOT_JDK=`$ECHO $DEFAULT_ACCEPTABLE_BOOT_VERSIONS \
349       | $TR &quot; &quot; &quot;\n&quot; | $SORT -n | $HEAD -n1`
<span class="line-modified">350   BOOT_JDK_SOURCETARGET=&quot;-source $OLDEST_BOOT_JDK -target $OLDEST_BOOT_JDK&quot;</span>

351   AC_SUBST(BOOT_JDK_SOURCETARGET)
352 
<span class="line-removed">353   AC_SUBST(JAVAC_FLAGS)</span>
<span class="line-removed">354 </span>
355   # Check if the boot jdk is 32 or 64 bit
356   if &quot;$JAVA&quot; -version 2&gt;&amp;1 | $GREP -q &quot;64-Bit&quot;; then
357     BOOT_JDK_BITS=&quot;64&quot;
358   else
359     BOOT_JDK_BITS=&quot;32&quot;
360   fi
361   AC_MSG_CHECKING([if Boot JDK is 32 or 64 bits])
362   AC_MSG_RESULT([$BOOT_JDK_BITS])
363 
364   # Try to enable CDS
365   AC_MSG_CHECKING([for local Boot JDK Class Data Sharing (CDS)])
366   BOOT_JDK_CDS_ARCHIVE=$CONFIGURESUPPORT_OUTPUTDIR/classes.jsa
367   UTIL_ADD_JVM_ARG_IF_OK([-XX:+UnlockDiagnosticVMOptions -XX:-VerifySharedSpaces -XX:SharedArchiveFile=$BOOT_JDK_CDS_ARCHIVE],boot_jdk_cds_args,[$JAVA])
368 
369   if test &quot;x$boot_jdk_cds_args&quot; != x; then
370     # Try creating a CDS archive
371     &quot;$JAVA&quot; $boot_jdk_cds_args -Xshare:dump &gt; /dev/null 2&gt;&amp;1
372     if test $? -eq 0; then
373       BOOTJDK_USE_LOCAL_CDS=true
374       AC_MSG_RESULT([yes, created])
</pre>
<hr />
<pre>
416   else
417     # Otherwise optimistically use the system-wide one, if one is present
418     UTIL_ADD_JVM_ARG_IF_OK([-Xshare:auto],boot_jdk_jvmargs,[$JAVA])
419   fi
420 
421   # Finally append user provided options to allow them to override.
422   UTIL_ADD_JVM_ARG_IF_OK([$USER_BOOT_JDK_OPTIONS],boot_jdk_jvmargs,[$JAVA])
423 
424   AC_MSG_RESULT([$boot_jdk_jvmargs])
425 
426   # For now, general JAVA_FLAGS are the same as the boot jdk jvmargs
427   JAVA_FLAGS=$boot_jdk_jvmargs
428   AC_SUBST(JAVA_FLAGS)
429 
430   AC_MSG_CHECKING([flags for boot jdk java command for big workloads])
431 
432   # Starting amount of heap memory.
433   UTIL_ADD_JVM_ARG_IF_OK([-Xms64M],boot_jdk_jvmargs_big,[$JAVA])
434   BOOTCYCLE_JVM_ARGS_BIG=-Xms64M
435 
<span class="line-modified">436   # Maximum amount of heap memory and stack size.</span>
437   JVM_HEAP_LIMIT_32=&quot;768&quot;
438   # Running a 64 bit JVM allows for and requires a bigger heap
439   JVM_HEAP_LIMIT_64=&quot;1600&quot;
<span class="line-removed">440   STACK_SIZE_32=768</span>
<span class="line-removed">441   STACK_SIZE_64=1536</span>
442   JVM_HEAP_LIMIT_GLOBAL=`expr $MEMORY_SIZE / 2`
443   if test &quot;$JVM_HEAP_LIMIT_GLOBAL&quot; -lt &quot;$JVM_HEAP_LIMIT_32&quot;; then
444     JVM_HEAP_LIMIT_32=$JVM_HEAP_LIMIT_GLOBAL
445   fi
446   if test &quot;$JVM_HEAP_LIMIT_GLOBAL&quot; -lt &quot;$JVM_HEAP_LIMIT_64&quot;; then
447     JVM_HEAP_LIMIT_64=$JVM_HEAP_LIMIT_GLOBAL
448   fi
449   if test &quot;$JVM_HEAP_LIMIT_GLOBAL&quot; -lt &quot;512&quot;; then
450     JVM_HEAP_LIMIT_32=512
451     JVM_HEAP_LIMIT_64=512
452   fi
453 
454   if test &quot;x$BOOT_JDK_BITS&quot; = &quot;x32&quot;; then
<span class="line-removed">455     STACK_SIZE=$STACK_SIZE_32</span>
456     JVM_MAX_HEAP=$JVM_HEAP_LIMIT_32
457   else
<span class="line-removed">458     STACK_SIZE=$STACK_SIZE_64</span>
459     JVM_MAX_HEAP=$JVM_HEAP_LIMIT_64
460   fi
461   UTIL_ADD_JVM_ARG_IF_OK([-Xmx${JVM_MAX_HEAP}M],boot_jdk_jvmargs_big,[$JAVA])
<span class="line-removed">462   UTIL_ADD_JVM_ARG_IF_OK([-XX:ThreadStackSize=$STACK_SIZE],boot_jdk_jvmargs_big,[$JAVA])</span>
463 
464   AC_MSG_RESULT([$boot_jdk_jvmargs_big])
465 
466   JAVA_FLAGS_BIG=$boot_jdk_jvmargs_big
467   AC_SUBST(JAVA_FLAGS_BIG)
468 
469   if test &quot;x$OPENJDK_TARGET_CPU_BITS&quot; = &quot;x32&quot;; then
470     BOOTCYCLE_MAX_HEAP=$JVM_HEAP_LIMIT_32
<span class="line-removed">471     BOOTCYCLE_STACK_SIZE=$STACK_SIZE_32</span>
472   else
473     BOOTCYCLE_MAX_HEAP=$JVM_HEAP_LIMIT_64
<span class="line-removed">474     BOOTCYCLE_STACK_SIZE=$STACK_SIZE_64</span>
475   fi
476   BOOTCYCLE_JVM_ARGS_BIG=&quot;$BOOTCYCLE_JVM_ARGS_BIG -Xmx${BOOTCYCLE_MAX_HEAP}M&quot;
<span class="line-removed">477   BOOTCYCLE_JVM_ARGS_BIG=&quot;$BOOTCYCLE_JVM_ARGS_BIG -XX:ThreadStackSize=$BOOTCYCLE_STACK_SIZE&quot;</span>
478   AC_MSG_CHECKING([flags for bootcycle boot jdk java command for big workloads])
479   AC_MSG_RESULT([$BOOTCYCLE_JVM_ARGS_BIG])
480   AC_SUBST(BOOTCYCLE_JVM_ARGS_BIG)
481 
<span class="line-removed">482   # By default, the main javac compilations use big</span>
<span class="line-removed">483   JAVA_FLAGS_JAVAC=&quot;$JAVA_FLAGS_BIG&quot;</span>
<span class="line-removed">484   AC_SUBST(JAVA_FLAGS_JAVAC)</span>
<span class="line-removed">485 </span>
486   AC_MSG_CHECKING([flags for boot jdk java command for small workloads])
487 
488   # Use serial gc for small short lived tools if possible
489   UTIL_ADD_JVM_ARG_IF_OK([-XX:+UseSerialGC],boot_jdk_jvmargs_small,[$JAVA])
490   UTIL_ADD_JVM_ARG_IF_OK([-Xms32M],boot_jdk_jvmargs_small,[$JAVA])
491   UTIL_ADD_JVM_ARG_IF_OK([-Xmx512M],boot_jdk_jvmargs_small,[$JAVA])
492   UTIL_ADD_JVM_ARG_IF_OK([-XX:TieredStopAtLevel=1],boot_jdk_jvmargs_small,[$JAVA])
493 
494   AC_MSG_RESULT([$boot_jdk_jvmargs_small])
495 
496   JAVA_FLAGS_SMALL=$boot_jdk_jvmargs_small
497   AC_SUBST(JAVA_FLAGS_SMALL)
498 





499   JAVA_TOOL_FLAGS_SMALL=&quot;&quot;
500   for f in $JAVA_FLAGS_SMALL; do
501     JAVA_TOOL_FLAGS_SMALL=&quot;$JAVA_TOOL_FLAGS_SMALL -J$f&quot;
502   done
503   AC_SUBST(JAVA_TOOL_FLAGS_SMALL)
504 ])
505 
506 # BUILD_JDK: the location of the latest JDK that can run
507 #   on the host system and supports the target class file version
508 #   generated in this JDK build.  This variable should only be
509 #   used after the launchers are built.
510 #
511 
512 # Execute the check given as argument, and verify the result.
513 # If the JDK was previously found, do nothing.
514 # $1 A command line (typically autoconf macro) to execute
515 AC_DEFUN([BOOTJDK_CHECK_BUILD_JDK],
516 [
517   if test &quot;x$BUILD_JDK_FOUND&quot; = xno; then
518     # Execute the test
</pre>
</td>
<td>
<hr />
<pre>
330     AC_MSG_NOTICE([Could not find a valid Boot JDK. $HELP_MSG])
331     AC_MSG_NOTICE([This might be fixed by explicitly setting --with-boot-jdk])
332     AC_MSG_ERROR([Cannot continue])
333   fi
334 
335   AC_SUBST(BOOT_JDK)
336 
337   # Setup tools from the Boot JDK.
338   BOOTJDK_CHECK_TOOL_IN_BOOTJDK(JAVA, java$EXE_SUFFIX)
339   BOOTJDK_CHECK_TOOL_IN_BOOTJDK(JAVAC, javac$EXE_SUFFIX)
340   BOOTJDK_CHECK_TOOL_IN_BOOTJDK(JAVADOC, javadoc$EXE_SUFFIX)
341   BOOTJDK_CHECK_TOOL_IN_BOOTJDK(JAR, jar$EXE_SUFFIX)
342   BOOTJDK_CHECK_TOOL_IN_BOOTJDK(JARSIGNER, jarsigner$EXE_SUFFIX)
343 
344   # Finally, set some other options...
345 
346   # When compiling code to be executed by the Boot JDK, force compatibility with the
347   # oldest supported bootjdk.
348   OLDEST_BOOT_JDK=`$ECHO $DEFAULT_ACCEPTABLE_BOOT_VERSIONS \
349       | $TR &quot; &quot; &quot;\n&quot; | $SORT -n | $HEAD -n1`
<span class="line-modified">350   # -Xlint:-options is added to avoid &quot;warning: [options] system modules path not set in conjunction with -source&quot;</span>
<span class="line-added">351   BOOT_JDK_SOURCETARGET=&quot;-source $OLDEST_BOOT_JDK -target $OLDEST_BOOT_JDK -Xlint:-options&quot;</span>
352   AC_SUBST(BOOT_JDK_SOURCETARGET)
353 


354   # Check if the boot jdk is 32 or 64 bit
355   if &quot;$JAVA&quot; -version 2&gt;&amp;1 | $GREP -q &quot;64-Bit&quot;; then
356     BOOT_JDK_BITS=&quot;64&quot;
357   else
358     BOOT_JDK_BITS=&quot;32&quot;
359   fi
360   AC_MSG_CHECKING([if Boot JDK is 32 or 64 bits])
361   AC_MSG_RESULT([$BOOT_JDK_BITS])
362 
363   # Try to enable CDS
364   AC_MSG_CHECKING([for local Boot JDK Class Data Sharing (CDS)])
365   BOOT_JDK_CDS_ARCHIVE=$CONFIGURESUPPORT_OUTPUTDIR/classes.jsa
366   UTIL_ADD_JVM_ARG_IF_OK([-XX:+UnlockDiagnosticVMOptions -XX:-VerifySharedSpaces -XX:SharedArchiveFile=$BOOT_JDK_CDS_ARCHIVE],boot_jdk_cds_args,[$JAVA])
367 
368   if test &quot;x$boot_jdk_cds_args&quot; != x; then
369     # Try creating a CDS archive
370     &quot;$JAVA&quot; $boot_jdk_cds_args -Xshare:dump &gt; /dev/null 2&gt;&amp;1
371     if test $? -eq 0; then
372       BOOTJDK_USE_LOCAL_CDS=true
373       AC_MSG_RESULT([yes, created])
</pre>
<hr />
<pre>
415   else
416     # Otherwise optimistically use the system-wide one, if one is present
417     UTIL_ADD_JVM_ARG_IF_OK([-Xshare:auto],boot_jdk_jvmargs,[$JAVA])
418   fi
419 
420   # Finally append user provided options to allow them to override.
421   UTIL_ADD_JVM_ARG_IF_OK([$USER_BOOT_JDK_OPTIONS],boot_jdk_jvmargs,[$JAVA])
422 
423   AC_MSG_RESULT([$boot_jdk_jvmargs])
424 
425   # For now, general JAVA_FLAGS are the same as the boot jdk jvmargs
426   JAVA_FLAGS=$boot_jdk_jvmargs
427   AC_SUBST(JAVA_FLAGS)
428 
429   AC_MSG_CHECKING([flags for boot jdk java command for big workloads])
430 
431   # Starting amount of heap memory.
432   UTIL_ADD_JVM_ARG_IF_OK([-Xms64M],boot_jdk_jvmargs_big,[$JAVA])
433   BOOTCYCLE_JVM_ARGS_BIG=-Xms64M
434 
<span class="line-modified">435   # Maximum amount of heap memory.</span>
436   JVM_HEAP_LIMIT_32=&quot;768&quot;
437   # Running a 64 bit JVM allows for and requires a bigger heap
438   JVM_HEAP_LIMIT_64=&quot;1600&quot;


439   JVM_HEAP_LIMIT_GLOBAL=`expr $MEMORY_SIZE / 2`
440   if test &quot;$JVM_HEAP_LIMIT_GLOBAL&quot; -lt &quot;$JVM_HEAP_LIMIT_32&quot;; then
441     JVM_HEAP_LIMIT_32=$JVM_HEAP_LIMIT_GLOBAL
442   fi
443   if test &quot;$JVM_HEAP_LIMIT_GLOBAL&quot; -lt &quot;$JVM_HEAP_LIMIT_64&quot;; then
444     JVM_HEAP_LIMIT_64=$JVM_HEAP_LIMIT_GLOBAL
445   fi
446   if test &quot;$JVM_HEAP_LIMIT_GLOBAL&quot; -lt &quot;512&quot;; then
447     JVM_HEAP_LIMIT_32=512
448     JVM_HEAP_LIMIT_64=512
449   fi
450 
451   if test &quot;x$BOOT_JDK_BITS&quot; = &quot;x32&quot;; then

452     JVM_MAX_HEAP=$JVM_HEAP_LIMIT_32
453   else

454     JVM_MAX_HEAP=$JVM_HEAP_LIMIT_64
455   fi
456   UTIL_ADD_JVM_ARG_IF_OK([-Xmx${JVM_MAX_HEAP}M],boot_jdk_jvmargs_big,[$JAVA])

457 
458   AC_MSG_RESULT([$boot_jdk_jvmargs_big])
459 
460   JAVA_FLAGS_BIG=$boot_jdk_jvmargs_big
461   AC_SUBST(JAVA_FLAGS_BIG)
462 
463   if test &quot;x$OPENJDK_TARGET_CPU_BITS&quot; = &quot;x32&quot;; then
464     BOOTCYCLE_MAX_HEAP=$JVM_HEAP_LIMIT_32

465   else
466     BOOTCYCLE_MAX_HEAP=$JVM_HEAP_LIMIT_64

467   fi
468   BOOTCYCLE_JVM_ARGS_BIG=&quot;$BOOTCYCLE_JVM_ARGS_BIG -Xmx${BOOTCYCLE_MAX_HEAP}M&quot;

469   AC_MSG_CHECKING([flags for bootcycle boot jdk java command for big workloads])
470   AC_MSG_RESULT([$BOOTCYCLE_JVM_ARGS_BIG])
471   AC_SUBST(BOOTCYCLE_JVM_ARGS_BIG)
472 




473   AC_MSG_CHECKING([flags for boot jdk java command for small workloads])
474 
475   # Use serial gc for small short lived tools if possible
476   UTIL_ADD_JVM_ARG_IF_OK([-XX:+UseSerialGC],boot_jdk_jvmargs_small,[$JAVA])
477   UTIL_ADD_JVM_ARG_IF_OK([-Xms32M],boot_jdk_jvmargs_small,[$JAVA])
478   UTIL_ADD_JVM_ARG_IF_OK([-Xmx512M],boot_jdk_jvmargs_small,[$JAVA])
479   UTIL_ADD_JVM_ARG_IF_OK([-XX:TieredStopAtLevel=1],boot_jdk_jvmargs_small,[$JAVA])
480 
481   AC_MSG_RESULT([$boot_jdk_jvmargs_small])
482 
483   JAVA_FLAGS_SMALL=$boot_jdk_jvmargs_small
484   AC_SUBST(JAVA_FLAGS_SMALL)
485 
<span class="line-added">486   # Don&#39;t presuppose SerialGC is present in the buildjdk. Also, we cannot test</span>
<span class="line-added">487   # the buildjdk, but on the other hand we know what it will support.</span>
<span class="line-added">488   BUILDJDK_JAVA_FLAGS_SMALL=&quot;-Xms32M -Xmx512M -XX:TieredStopAtLevel=1&quot;</span>
<span class="line-added">489   AC_SUBST(BUILDJDK_JAVA_FLAGS_SMALL)</span>
<span class="line-added">490 </span>
491   JAVA_TOOL_FLAGS_SMALL=&quot;&quot;
492   for f in $JAVA_FLAGS_SMALL; do
493     JAVA_TOOL_FLAGS_SMALL=&quot;$JAVA_TOOL_FLAGS_SMALL -J$f&quot;
494   done
495   AC_SUBST(JAVA_TOOL_FLAGS_SMALL)
496 ])
497 
498 # BUILD_JDK: the location of the latest JDK that can run
499 #   on the host system and supports the target class file version
500 #   generated in this JDK build.  This variable should only be
501 #   used after the launchers are built.
502 #
503 
504 # Execute the check given as argument, and verify the result.
505 # If the JDK was previously found, do nothing.
506 # $1 A command line (typically autoconf macro) to execute
507 AC_DEFUN([BOOTJDK_CHECK_BUILD_JDK],
508 [
509   if test &quot;x$BUILD_JDK_FOUND&quot; = xno; then
510     # Execute the test
</pre>
</td>
</tr>
</table>
<center><a href="../ToolsLangtools.gmk.sdiff.html" target="_top">&lt; prev</a> <a href="../../index.html" target="_top">index</a> <a href="bootcycle-spec.gmk.in.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>