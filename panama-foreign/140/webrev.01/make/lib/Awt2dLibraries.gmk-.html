<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Old make/lib/Awt2dLibraries.gmk</title>
    <link rel="stylesheet" href="../../style.css" />
  </head>
  <body>
    <pre>
  1 #
  2 # Copyright (c) 2011, 2019, Oracle and/or its affiliates. All rights reserved.
  3 # DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4 #
  5 # This code is free software; you can redistribute it and/or modify it
  6 # under the terms of the GNU General Public License version 2 only, as
  7 # published by the Free Software Foundation.  Oracle designates this
  8 # particular file as subject to the &quot;Classpath&quot; exception as provided
  9 # by Oracle in the LICENSE file that accompanied this code.
 10 #
 11 # This code is distributed in the hope that it will be useful, but WITHOUT
 12 # ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 13 # FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 14 # version 2 for more details (a copy is included in the LICENSE file that
 15 # accompanied this code).
 16 #
 17 # You should have received a copy of the GNU General Public License version
 18 # 2 along with this work; if not, write to the Free Software Foundation,
 19 # Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 20 #
 21 # Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 22 # or visit www.oracle.com if you need additional information or have any
 23 # questions.
 24 #
 25 
 26 $(eval $(call IncludeCustomExtension, lib/Awt2dLibraries-pre.gmk))
 27 
 28 WIN_AWT_LIB := $(SUPPORT_OUTPUTDIR)/native/$(MODULE)/libawt/awt.lib
 29 
 30 LIBAWT_DEFAULT_HEADER_DIRS := \
 31     libawt/awt/image \
 32     libawt/awt/image/cvutils \
 33     libawt/java2d \
 34     libawt/java2d/loops \
 35     libawt/java2d/pipe \
 36     #
 37 
 38 ################################################################################
 39 
 40 BUILD_LIBMLIB_CFLAGS := -D__USE_J2D_NAMES -D__MEDIALIB_OLD_NAMES -DMLIB_NO_LIBSUNMATH
 41 
 42 ifeq ($(call isTargetCpuBits, 64), true)
 43   BUILD_LIBMLIB_CFLAGS += -DMLIB_OS64BIT
 44 endif
 45 
 46 $(eval $(call SetupJdkLibrary, BUILD_LIBMLIB_IMAGE, \
 47     NAME := mlib_image, \
 48     EXTRA_SRC := common/awt/medialib, \
 49     EXCLUDE_FILES := mlib_c_ImageBlendTable.c, \
 50     EXCLUDE_SRC_PATTERNS := $(BUILD_LIBMLIB_EXCLUDE_SRC_PATTERNS), \
 51     OPTIMIZATION := HIGHEST, \
 52     CFLAGS := $(CFLAGS_JDKLIB) \
 53         $(BUILD_LIBMLIB_CFLAGS), \
 54     DISABLED_WARNINGS_gcc := unused-function, \
 55     LDFLAGS := $(LDFLAGS_JDKLIB) \
 56         $(call SET_SHARED_LIBRARY_ORIGIN), \
 57     LIBS := $(JDKLIB_LIBS), \
 58     LIBS_unix := $(LIBM) $(LIBDL), \
 59 ))
 60 
 61 $(BUILD_LIBMLIB_IMAGE): $(call FindLib, java.base, java)
 62 
 63 TARGETS += $(BUILD_LIBMLIB_IMAGE)
 64 
 65 ################################################################################
 66 
 67 LIBAWT_EXTRA_SRC := \
 68     common/awt/debug \
 69     $(TOPDIR)/src/$(MODULE)/$(OPENJDK_TARGET_OS_TYPE)/native/common/awt \
 70     #
 71 
 72 ifeq ($(call And, $(call isTargetOs, solaris) $(call isTargetCpuArch, sparc)), true)
 73   LIBAWT_EXTRA_SRC += $(TOPDIR)/src/$(MODULE)/share/native/common/awt/medialib
 74 endif
 75 
 76 ifeq ($(call isTargetOs, windows), true)
 77   LIBAWT_EXTRA_SRC += \
 78       $(TOPDIR)/src/$(MODULE)/share/native/common/awt/utility \
 79       $(TOPDIR)/src/$(MODULE)/share/native/common/font \
 80       $(TOPDIR)/src/$(MODULE)/share/native/common/java2d/opengl \
 81       $(TOPDIR)/src/$(MODULE)/$(OPENJDK_TARGET_OS_TYPE)/native/common/awt/systemscale \
 82       #
 83 endif
 84 
 85 ifeq ($(call isTargetOs, solaris linux macosx aix), true)
 86   LIBAWT_EXFILES += awt_Font.c CUPSfuncs.c fontpath.c X11Color.c
 87 endif
 88 
 89 ifeq ($(call isTargetOs, macosx), true)
 90   LIBAWT_EXFILES += initIDs.c awt/image/cvutils/img_colors.c
 91 endif
 92 
 93 ifeq ($(call isTargetOs, windows), true)
 94   LIBAWT_EXFILES += \
 95       java2d/d3d/D3DShaderGen.c \
 96       awt/image/cvutils/img_colors.c \
 97       #
 98 endif
 99 
100 LIBAWT_EXTRA_HEADER_DIRS := \
101     $(LIBAWT_DEFAULT_HEADER_DIRS) \
102     $(call GetJavaHeaderDir, java.base) \
103     libawt/awt/medialib \
104     libawt/java2d/d3d \
105     libawt/java2d/opengl \
106     libawt/java2d/windows \
107     libawt/windows \
108     common/awt/medialib \
109     libmlib_image \
110     include \
111     java.base:libjava \
112     java.base:include \
113     #
114 
115 LIBAWT_CFLAGS += -D__MEDIALIB_OLD_NAMES -D__USE_J2D_NAMES $(X_CFLAGS)
116 
117 ifeq ($(call And, $(call isTargetOs, solaris) $(call isTargetCpu, sparcv9)), true)
118   LIBAWT_ASFLAGS = -P -xarch=v9a
119 endif
120 
121 ifeq ($(call isTargetOs, solaris), false)
122   LIBAWT_CFLAGS += -DMLIB_NO_LIBSUNMATH
123 endif
124 
125 ifeq ($(call isTargetOs, windows), true)
126   LIBAWT_CFLAGS += -EHsc -DUNICODE -D_UNICODE
127   ifeq ($(call isTargetCpuBits, 64), true)
128     LIBAWT_CFLAGS += -DMLIB_OS64BIT
129   endif
130 
131   LIBAWT_RC_FLAGS ?= -I $(TOPDIR)/src/java.base/windows/native/launcher/icons
132   LIBAWT_VERSIONINFO_RESOURCE := $(TOPDIR)/src/$(MODULE)/windows/native/libawt/windows/awt.rc
133 endif
134 
135 ifeq ($(call isTargetOs, linux), true)
136   # FIXME: This is probably not what we want to do, but keep it now for compatibility.
137   LIBAWT_CFLAGS += $(EXPORT_ALL_SYMBOLS)
138 endif
139 
140 # Turn off all warnings for debug_mem.c This is needed because the specific warning
141 # about initializing a declared &#39;extern&#39; cannot be turned off individually. Only
142 # applies to debug builds.
143 ifeq ($(TOOLCHAIN_TYPE), gcc)
144   BUILD_LIBAWT_debug_mem.c_CFLAGS := -w
145   # This option improves performance of MaskFill in Java2D by 20% for some gcc
146   LIBAWT_CFLAGS += -fgcse-after-reload
147 endif
148 
149 $(eval $(call SetupJdkLibrary, BUILD_LIBAWT, \
150     NAME := awt, \
151     EXTRA_SRC := $(LIBAWT_EXTRA_SRC), \
152     EXCLUDES := $(LIBAWT_EXCLUDES), \
153     EXCLUDE_FILES := $(LIBAWT_EXFILES), \
154     OPTIMIZATION := LOW, \
155     CFLAGS := $(CFLAGS_JDKLIB) $(LIBAWT_CFLAGS), \
156     EXTRA_HEADER_DIRS := $(LIBAWT_EXTRA_HEADER_DIRS), \
157     DISABLED_WARNINGS_gcc := sign-compare unused-result maybe-uninitialized \
158         format-nonliteral parentheses unused-value unused-function, \
159     DISABLED_WARNINGS_clang := logical-op-parentheses extern-initializer \
160         sign-compare format-nonliteral, \
161     DISABLED_WARNINGS_microsoft := 4244 4267 4996, \
162     ASFLAGS := $(LIBAWT_ASFLAGS), \
163     LDFLAGS := $(LDFLAGS_JDKLIB) $(call SET_SHARED_LIBRARY_ORIGIN), \
164     LDFLAGS_macosx := -L$(INSTALL_LIBRARIES_HERE), \
165     LDFLAGS_windows := -delayload:user32.dll -delayload:gdi32.dll \
166         -delayload:shell32.dll -delayload:winmm.dll \
167         -delayload:winspool.drv -delayload:imm32.dll \
168         -delayload:ole32.dll -delayload:comdlg32.dll \
169         -delayload:comctl32.dll -delayload:shlwapi.dll, \
170     LIBS_unix := -ljvm -ljava $(LIBM), \
171     LIBS_linux :=  $(LIBDL), \
172     LIBS_solaris := $(LIBDL), \
173     LIBS_aix := $(LIBDL),\
174     LIBS_macosx := -lmlib_image \
175         -framework Cocoa \
176         -framework OpenGL \
177         -framework JavaNativeFoundation \
178         -framework JavaRuntimeSupport \
179         -framework ApplicationServices \
180         -framework AudioToolbox, \
181     LIBS_windows := kernel32.lib user32.lib gdi32.lib winspool.lib \
182         imm32.lib ole32.lib uuid.lib shell32.lib \
183         comdlg32.lib winmm.lib comctl32.lib shlwapi.lib \
184         delayimp.lib jvm.lib $(WIN_JAVA_LIB) advapi32.lib, \
185     VERSIONINFO_RESOURCE := $(LIBAWT_VERSIONINFO_RESOURCE), \
186     RC_FLAGS := $(RC_FLAGS) $(LIBAWT_RC_FLAGS) \
187         -D &quot;JDK_FNAME=awt.dll&quot; \
188         -D &quot;JDK_INTERNAL_NAME=awt&quot; \
189         -D &quot;JDK_FTYPE=0x2L&quot;, \
190 ))
191 
192 $(BUILD_LIBAWT): $(call FindLib, java.base, java)
193 
194 ifeq ($(call isTargetOs, macosx), true)
195   $(BUILD_LIBAWT): $(BUILD_LIBMLIB_IMAGE)
196 endif
197 
198 TARGETS += $(BUILD_LIBAWT)
199 
200 ################################################################################
201 
202 ifeq ($(call isTargetOs, windows macosx), false)
203   ifeq ($(ENABLE_HEADLESS_ONLY), false)
204 
205     LIBAWT_XAWT_EXTRA_SRC := \
206         common/awt \
207         common/java2d \
208         common/font \
209         #
210 
211     LIBAWT_XAWT_EXCLUDES := medialib debug
212 
213     LIBAWT_XAWT_EXTRA_HEADER_DIRS := \
214         $(LIBAWT_DEFAULT_HEADER_DIRS) \
215         libawt_xawt/awt \
216         include \
217         common/awt/debug \
218         common/awt/systemscale \
219         common/font \
220         common/java2d/opengl \
221         common/java2d/x11 \
222         #
223 
224     LIBAWT_XAWT_CFLAGS += -DXAWT -DXAWT_HACK \
225         $(FONTCONFIG_CFLAGS) \
226         $(CUPS_CFLAGS)
227 
228     ifeq ($(call isTargetOs, solaris), true)
229       LIBAWT_XAWT_CFLAGS += -DFUNCPROTO=15
230     endif
231 
232     ifeq ($(call isTargetOs, linux), true)
233       ifeq ($(DISABLE_XRENDER), true)
234         LIBAWT_XAWT_CFLAGS += -DDISABLE_XRENDER_BY_DEFAULT=true
235       endif
236     endif
237 
238     LIBAWT_XAWT_LIBS := $(LIBM) -lawt -lXext -lX11 -lXrender $(LIBDL) -lXtst -lXi -ljava -ljvm
239 
240     ifeq ($(call isTargetOs, linux), true)
241       LIBAWT_XAWT_LIBS += -lpthread
242     endif
243 
244     ifeq ($(TOOLCHAIN_TYPE), gcc)
245       # Turn off all warnings for the following files since they contain warnings
246       # that cannot be turned of individually.
247       # redefining a macro
248       BUILD_LIBAWT_XAWT_gtk2_interface.c_CFLAGS := -w
249       # comparison between pointer and integer
250       BUILD_LIBAWT_XAWT_awt_Font.c_CFLAGS := -w
251       # initializing a declared &#39;extern&#39;
252       BUILD_LIBAWT_XAWT_debug_mem.c_CFLAGS := -w
253     endif
254 
255     $(eval $(call SetupJdkLibrary, BUILD_LIBAWT_XAWT, \
256         NAME := awt_xawt, \
257         EXTRA_SRC := $(LIBAWT_XAWT_EXTRA_SRC), \
258         EXTRA_HEADER_DIRS := $(LIBAWT_XAWT_EXTRA_HEADER_DIRS), \
259         EXCLUDES := $(LIBAWT_XAWT_EXCLUDES), \
260         OPTIMIZATION := LOW, \
261         CFLAGS := $(CFLAGS_JDKLIB) $(LIBAWT_XAWT_CFLAGS) \
262             $(X_CFLAGS), \
263         WARNINGS_AS_ERRORS_xlc := false, \
264         DISABLED_WARNINGS_gcc := type-limits pointer-to-int-cast \
265             unused-result maybe-uninitialized format \
266             format-security int-to-pointer-cast parentheses \
267             implicit-fallthrough undef unused-function, \
268         DISABLED_WARNINGS_clang := parentheses format undef \
269             logical-op-parentheses format-nonliteral int-conversion, \
270         DISABLED_WARNINGS_solstudio := E_ASSIGNMENT_TYPE_MISMATCH \
271              E_NON_CONST_INIT, \
272         LDFLAGS := $(LDFLAGS_JDKLIB) \
273             $(call SET_SHARED_LIBRARY_ORIGIN) \
274             -L$(INSTALL_LIBRARIES_HERE), \
275         LIBS :=  $(X_LIBS) $(LIBAWT_XAWT_LIBS), \
276     ))
277 
278     $(BUILD_LIBAWT_XAWT): $(call FindLib, java.base, java)
279 
280     $(BUILD_LIBAWT_XAWT): $(BUILD_LIBAWT)
281 
282     TARGETS += $(BUILD_LIBAWT_XAWT)
283 
284   endif
285 endif
286 
287 ################################################################################
288 
289 # The fast floor code loses precision.
290 LCMS_CFLAGS=-DCMS_DONT_USE_FAST_FLOOR
291 
292 ifeq ($(USE_EXTERNAL_LCMS), true)
293   # If we&#39;re using an external library, we&#39;ll just need the wrapper part.
294   # By including it explicitly, all other files will be excluded.
295   BUILD_LIBLCMS_INCLUDE_FILES := LCMS.c
296   # If we&#39;re using an external library, we can&#39;t include our own SRC path
297   # as includes, instead the system headers should be used.
298   LIBLCMS_HEADERS_FROM_SRC := false
299 else
300   BUILD_LIBLCMS_INCLUDE_FILES :=
301 endif
302 
303 $(eval $(call SetupJdkLibrary, BUILD_LIBLCMS, \
304     NAME := lcms, \
305     INCLUDE_FILES := $(BUILD_LIBLCMS_INCLUDE_FILES), \
306     OPTIMIZATION := HIGHEST, \
307     CFLAGS := $(CFLAGS_JDKLIB) \
308         $(LCMS_CFLAGS), \
309     CFLAGS_windows := -DCMS_IS_WINDOWS_, \
310     EXTRA_HEADER_DIRS := \
311         common/awt/debug \
312         libawt/java2d, \
313     HEADERS_FROM_SRC := $(LIBLCMS_HEADERS_FROM_SRC), \
314     DISABLED_WARNINGS_gcc := format-nonliteral type-limits \
315         misleading-indentation undef unused-function stringop-truncation, \
316     DISABLED_WARNINGS_clang := tautological-compare format-nonliteral undef, \
317     DISABLED_WARNINGS_solstudio := E_STATEMENT_NOT_REACHED, \
318     DISABLED_WARNINGS_microsoft := 4819, \
319     LDFLAGS := $(LDFLAGS_JDKLIB) \
320         $(call SET_SHARED_LIBRARY_ORIGIN), \
321     LDFLAGS_unix := -L$(INSTALL_LIBRARIES_HERE), \
322     LIBS_unix := -lawt -ljvm -ljava $(LCMS_LIBS) $(LIBM), \
323     LIBS_windows := $(WIN_AWT_LIB) $(WIN_JAVA_LIB), \
324 ))
325 
326 TARGETS += $(BUILD_LIBLCMS)
327 
328 $(BUILD_LIBLCMS): $(BUILD_LIBAWT)
329 
330 ################################################################################
331 
332 # &quot;DISABLED_WARNINGS_gcc := clobbered&quot; rationale:
333 # Suppress gcc warnings like &quot;variable might be clobbered by &#39;longjmp&#39;
334 # or &#39;vfork&#39;&quot;: this warning indicates that some variable is placed to
335 # a register by optimized compiler and it&#39;s value might be lost on longjmp().
336 # Recommended way to avoid such warning is to declare the variable as
337 # volatile to prevent the optimization. However, this approach does not
338 # work because we have to declare all variables as volatile in result.
339 
340 ifeq ($(USE_EXTERNAL_LIBJPEG), true)
341   LIBJPEG_LIBS := -ljpeg
342   BUILD_LIBJAVAJPEG_INCLUDE_FILES := \
343       imageioJPEG.c \
344       jpegdecoder.c
345   # If we&#39;re using an external library, we can&#39;t include our own SRC path
346   # as includes, instead the system headers should be used.
347   LIBJPEG_HEADERS_FROM_SRC := false
348 else
349   LIBJPEG_LIBS :=
350   BUILD_LIBJAVAJPEG_INCLUDE_FILES :=
351 endif
352 
353 $(eval $(call SetupJdkLibrary, BUILD_LIBJAVAJPEG, \
354     NAME := javajpeg, \
355     INCLUDE_FILES := $(BUILD_LIBJAVAJPEG_INCLUDE_FILES), \
356     OPTIMIZATION := HIGHEST, \
357     CFLAGS := $(CFLAGS_JDKLIB), \
358     HEADERS_FROM_SRC := $(LIBJPEG_HEADERS_FROM_SRC), \
359     DISABLED_WARNINGS_gcc := clobbered implicit-fallthrough shift-negative-value, \
360     LDFLAGS := $(LDFLAGS_JDKLIB) \
361         $(call SET_SHARED_LIBRARY_ORIGIN), \
362     LIBS := $(LIBJPEG_LIBS) $(JDKLIB_LIBS), \
363     LIBS_windows := $(WIN_JAVA_LIB) jvm.lib, \
364 ))
365 
366 $(BUILD_LIBJAVAJPEG): $(call FindLib, java.base, java)
367 
368 TARGETS += $(BUILD_LIBJAVAJPEG)
369 
370 ################################################################################
371 
372 # Mac and Windows only use the native AWT lib, do not build libawt_headless
373 ifeq ($(call isTargetOs, windows macosx), false)
374 
375   LIBAWT_HEADLESS_EXTRA_SRC := \
376       common/font \
377       common/java2d \
378       $(TOPDIR)/src/$(MODULE)/$(OPENJDK_TARGET_OS_TYPE)/native/common/awt \
379       #
380 
381   LIBAWT_HEADLESS_EXCLUDES := medialib
382 
383   LIBAWT_HEADLESS_EXTRA_HEADER_DIRS := \
384       $(LIBAWT_DEFAULT_HEADER_DIRS) \
385       common/awt/debug \
386       common/font \
387       common/java2d/opengl \
388       #
389 
390   LIBAWT_HEADLESS_CFLAGS := $(CUPS_CFLAGS) $(FONTCONFIG_CFLAGS) $(X_CFLAGS) \
391       -DHEADLESS=true
392 
393   $(eval $(call SetupJdkLibrary, BUILD_LIBAWT_HEADLESS, \
394       NAME := awt_headless, \
395       EXTRA_SRC := $(LIBAWT_HEADLESS_EXTRA_SRC), \
396       EXCLUDES := $(LIBAWT_HEADLESS_EXCLUDES), \
397       OPTIMIZATION := LOW, \
398       CFLAGS := $(CFLAGS_JDKLIB) \
399           $(LIBAWT_HEADLESS_CFLAGS), \
400       EXTRA_HEADER_DIRS := $(LIBAWT_HEADLESS_EXTRA_HEADER_DIRS), \
401       DISABLED_WARNINGS_gcc := unused-function, \
402       DISABLED_WARNINGS_solstudio := E_EMPTY_TRANSLATION_UNIT, \
403       LDFLAGS := $(LDFLAGS_JDKLIB) \
404           $(call SET_SHARED_LIBRARY_ORIGIN), \
405       LDFLAGS_unix := -L$(INSTALL_LIBRARIES_HERE), \
406       LIBS_unix := -lawt -ljvm -ljava, \
407       LIBS_linux := $(LIBM) $(LIBDL), \
408       LIBS_solaris := $(LIBM) $(LIBDL) $(LIBCXX), \
409   ))
410 
411   $(BUILD_LIBAWT_HEADLESS): $(BUILD_LIBAWT)
412 
413   TARGETS += $(BUILD_LIBAWT_HEADLESS)
414 
415 endif
416 
417 ################################################################################
418 
419 ifeq ($(FREETYPE_TO_USE), system)
420   # For use by libfontmanager:
421   LIBFREETYPE_CFLAGS := $(FREETYPE_CFLAGS)
422   LIBFREETYPE_LIBS := $(FREETYPE_LIBS)
423 else
424   BUILD_LIBFREETYPE_HEADER_DIRS := $(TOPDIR)/src/$(MODULE)/share/native/libfreetype/include
425   BUILD_LIBFREETYPE_CFLAGS := -DFT2_BUILD_LIBRARY $(EXPORT_ALL_SYMBOLS)
426 
427   # For use by libfontmanager:
428   LIBFREETYPE_CFLAGS := -I$(BUILD_LIBFREETYPE_HEADER_DIRS)
429   ifeq ($(call isTargetOs, windows), true)
430     LIBFREETYPE_LIBS := $(SUPPORT_OUTPUTDIR)/native/$(MODULE)/libfreetype/freetype.lib
431     # freetype now requires you to manually define this (see ftconfig.h)
432     BUILD_LIBFREETYPE_CFLAGS += -DDLL_EXPORT
433   else
434     LIBFREETYPE_LIBS := -lfreetype
435   endif
436 
437   $(eval $(call SetupJdkLibrary, BUILD_LIBFREETYPE, \
438       NAME := freetype, \
439       OPTIMIZATION := HIGHEST, \
440       CFLAGS := $(CFLAGS_JDKLIB) \
441           $(BUILD_LIBFREETYPE_CFLAGS), \
442       EXTRA_HEADER_DIRS := $(BUILD_LIBFREETYPE_HEADER_DIRS), \
443       DISABLED_WARNINGS_solstudio := \
444          E_STATEMENT_NOT_REACHED \
445          E_END_OF_LOOP_CODE_NOT_REACHED, \
446       DISABLED_WARNINGS_microsoft := 4018 4267 4244 4312 4819, \
447       DISABLED_WARNINGS_gcc := implicit-fallthrough cast-function-type bad-function-cast, \
448       LDFLAGS := $(LDFLAGS_JDKLIB) \
449           $(call SET_SHARED_LIBRARY_ORIGIN), \
450   ))
451 
452   TARGETS += $(BUILD_LIBFREETYPE)
453 endif
454 
455 ###########################################################################
456 
457 #### Begin harfbuzz configuration
458 
459 HARFBUZZ_CFLAGS := -DHAVE_OT -DHAVE_FALLBACK -DHAVE_UCDN -DHAVE_ROUND
460 
461 ifeq ($(call isTargetOs, windows), false)
462   HARFBUZZ_CFLAGS += -DGETPAGESIZE -DHAVE_MPROTECT -DHAVE_PTHREAD \
463                       -DHAVE_SYSCONF -DHAVE_SYS_MMAN_H -DHAVE_UNISTD_H \
464                       -DHB_NO_PRAGMA_GCC_DIAGNOSTIC
465 endif
466 ifeq ($(call isTargetOs, linux macosx), true)
467   HARFBUZZ_CFLAGS += -DHAVE_INTEL_ATOMIC_PRIMITIVES
468 endif
469 ifeq ($(call isTargetOs, solaris), true)
470   HARFBUZZ_CFLAGS += -DHAVE_SOLARIS_ATOMIC_OPS
471 endif
472 ifeq ($(call isTargetOs, macosx), true)
473   HARFBUZZ_CFLAGS += -DHAVE_CORETEXT
474 endif
475 ifeq ($(call isTargetOs, macosx), false)
476   LIBFONTMANAGER_EXCLUDE_FILES += harfbuzz/hb-coretext.cc
477 endif
478 # hb-ft.cc is not presently needed, and requires freetype 2.4.2 or later.
479 LIBFONTMANAGER_EXCLUDE_FILES += harfbuzz/hb-ft.cc
480 
481 LIBFONTMANAGER_CFLAGS += $(HARFBUZZ_CFLAGS)
482 
483 #### End harfbuzz configuration
484 
485 LIBFONTMANAGER_EXTRA_HEADER_DIRS := \
486     libfontmanager/harfbuzz \
487     libfontmanager/harfbuzz/hb-ucdn \
488     common/awt \
489     common/font \
490     libawt/java2d \
491     libawt/java2d/pipe \
492     libawt/java2d/loops \
493     #
494 
495 LIBFONTMANAGER_CFLAGS += $(LIBFREETYPE_CFLAGS)
496 BUILD_LIBFONTMANAGER_FONTLIB += $(LIBFREETYPE_LIBS)
497 
498 LIBFONTMANAGER_OPTIMIZATION := HIGH
499 
500 ifeq ($(call isTargetOs, windows), true)
501   LIBFONTMANAGER_EXCLUDE_FILES += X11FontScaler.c \
502       X11TextRenderer.c
503   LIBFONTMANAGER_OPTIMIZATION := HIGHEST
504 else ifeq ($(call isTargetOs, macosx), true)
505   LIBFONTMANAGER_EXCLUDE_FILES += X11FontScaler.c \
506       X11TextRenderer.c \
507       fontpath.c \
508       lcdglyph.c
509 else
510   LIBFONTMANAGER_EXCLUDE_FILES += fontpath.c \
511       lcdglyph.c
512 endif
513 
514 LIBFONTMANAGER_CFLAGS += $(X_CFLAGS) -DLE_STANDALONE -DHEADLESS
515 
516 ifeq ($(TOOLCHAIN_TYPE), gcc)
517   # Turn off all warnings for sunFont.c. This is needed because the specific warning
518   # about discarding &#39;const&#39; qualifier cannot be turned off individually.
519   BUILD_LIBFONTMANAGER_sunFont.c_CFLAGS := -w
520 endif
521 
522 # LDFLAGS clarification:
523 #   Filter relevant linker flags disallowing unresolved symbols as we cannot
524 #   build-time decide to which library to link against (libawt_headless or
525 #   libawt_xawt). See JDK-8196516 for details.
526 $(eval $(call SetupJdkLibrary, BUILD_LIBFONTMANAGER, \
527     NAME := fontmanager, \
528     EXCLUDE_FILES := $(LIBFONTMANAGER_EXCLUDE_FILES) \
529         AccelGlyphCache.c, \
530     TOOLCHAIN := TOOLCHAIN_LINK_CXX, \
531     CFLAGS := $(CFLAGS_JDKLIB) $(LIBFONTMANAGER_CFLAGS), \
532     CXXFLAGS := $(CXXFLAGS_JDKLIB) $(LIBFONTMANAGER_CFLAGS), \
533     OPTIMIZATION := $(LIBFONTMANAGER_OPTIMIZATION), \
534     CFLAGS_windows = -DCC_NOEX, \
535     EXTRA_HEADER_DIRS := $(LIBFONTMANAGER_EXTRA_HEADER_DIRS), \
536     WARNINGS_AS_ERRORS_xlc := false, \
537     DISABLED_WARNINGS_gcc := sign-compare int-to-pointer-cast \
538         type-limits missing-field-initializers implicit-fallthrough \
539         strict-aliasing undef unused-function, \
540     DISABLED_WARNINGS_CXX_gcc := reorder delete-non-virtual-dtor strict-overflow \
541         maybe-uninitialized class-memaccess, \
542     DISABLED_WARNINGS_clang := unused-value incompatible-pointer-types \
543         tautological-constant-out-of-range-compare int-to-pointer-cast \
544         sign-compare undef missing-field-initializers, \
545     DISABLED_WARNINGS_C_solstudio = \
546         E_INTEGER_OVERFLOW_DETECTED \
547         E_ARG_INCOMPATIBLE_WITH_ARG_L \
548         E_ENUM_VAL_OVERFLOWS_INT_MAX, \
549     DISABLED_WARNINGS_CXX_solstudio := \
550         truncwarn wvarhidenmem wvarhidemem wbadlkginit identexpected \
551         hidevf w_novirtualdescr arrowrtn2 refmemnoconstr_aggr unknownpragma \
552         doubunder wunreachable, \
553     DISABLED_WARNINGS_microsoft := 4267 4244 4018 4090 4996 4146 4334 4819 4101 4068 4805 4138, \
554     LDFLAGS := $(subst -Xlinker -z -Xlinker defs,, \
555         $(subst -Wl$(COMMA)-z$(COMMA)defs,,$(LDFLAGS_JDKLIB))) $(LDFLAGS_CXX_JDK) \
556         $(call SET_SHARED_LIBRARY_ORIGIN), \
557     LDFLAGS_unix := -L$(INSTALL_LIBRARIES_HERE), \
558     LDFLAGS_aix := -Wl$(COMMA)-berok, \
559     LIBS := $(BUILD_LIBFONTMANAGER_FONTLIB), \
560     LIBS_unix := -lawt -ljava -ljvm $(LIBM) $(LIBCXX), \
561     LIBS_macosx := -lawt_lwawt -framework CoreText -framework CoreFoundation \
562         -framework CoreGraphics, \
563     LIBS_windows := $(WIN_JAVA_LIB) advapi32.lib user32.lib gdi32.lib \
564         $(WIN_AWT_LIB), \
565 ))
566 
567 $(BUILD_LIBFONTMANAGER): $(BUILD_LIBAWT)
568 
569 ifeq ($(call isTargetOs, macosx), true)
570   $(BUILD_LIBFONTMANAGER): $(call FindLib, $(MODULE), awt_lwawt)
571 endif
572 
573 ifeq ($(FREETYPE_TO_USE), bundled)
574   $(BUILD_LIBFONTMANAGER): $(BUILD_LIBFREETYPE)
575 endif
576 
577 TARGETS += $(BUILD_LIBFONTMANAGER)
578 
579 ################################################################################
580 
581 ifeq ($(call isTargetOs, windows), true)
582 
583   LIBJAWT_CFLAGS := -EHsc -DUNICODE -D_UNICODE
584 
585   LIBJAWT_EXTRA_HEADER_DIRS := \
586       include \
587       common/awt/debug \
588       libawt/awt/image/cvutils \
589       libawt/java2d \
590       libawt/java2d/windows \
591       libawt/windows \
592       java.base:include \
593       java.base:libjava \
594       #
595 
596   ifeq ($(call isTargetCpu, x86), true)
597     KERNEL32_LIB := kernel32.lib
598   endif
599 
600   $(eval $(call SetupJdkLibrary, BUILD_LIBJAWT, \
601       NAME := jawt, \
602       OPTIMIZATION := LOW, \
603       CFLAGS := $(CXXFLAGS_JDKLIB) \
604           $(LIBJAWT_CFLAGS), \
605       EXTRA_HEADER_DIRS := $(LIBJAWT_EXTRA_HEADER_DIRS), \
606       LDFLAGS := $(LDFLAGS_JDKLIB) $(LDFLAGS_CXX_JDK), \
607       LIBS := $(JDKLIB_LIBS) $(KERNEL32_LIB) advapi32.lib $(WIN_AWT_LIB), \
608   ))
609 
610   $(BUILD_LIBJAWT): $(BUILD_LIBAWT)
611 
612   $(eval $(call SetupCopyFiles, COPY_JAWT_LIB, \
613       FILES := $(BUILD_LIBJAWT_IMPORT_LIBRARY), \
614       DEST := $(SUPPORT_OUTPUTDIR)/modules_libs/$(MODULE), \
615   ))
616 
617   $(COPY_JAWT_LIB): $(BUILD_LIBJAWT)
618 
619   TARGETS += $(COPY_JAWT_LIB)
620 
621 else # not windows
622 
623   ifeq ($(call isTargetOs, macosx), true)
624     # libjawt on macosx do not use the unix code
625     LIBJAWT_EXCLUDE_SRC_PATTERNS := /unix/
626   endif
627 
628   ifeq ($(call isTargetOs, macosx), true)
629     JAWT_LIBS := -lawt_lwawt
630   else
631     JAWT_LIBS :=
632     ifeq ($(call isTargetOs, solaris), false)
633       JAWT_LIBS += -lawt
634     endif
635     ifeq ($(ENABLE_HEADLESS_ONLY), false)
636       JAWT_LIBS += -lawt_xawt
637     else
638       JAWT_LIBS += -lawt_headless
639       ifeq ($(call isTargetOs, linux), true)
640         JAWT_CFLAGS += -DHEADLESS
641       endif
642     endif
643   endif
644 
645   $(eval $(call SetupJdkLibrary, BUILD_LIBJAWT, \
646       NAME := jawt, \
647       EXCLUDE_SRC_PATTERNS := $(LIBJAWT_EXCLUDE_SRC_PATTERNS), \
648       INCLUDE_FILES := $(JAWT_FILES), \
649       OPTIMIZATION := LOW, \
650       CFLAGS := $(CFLAGS_JDKLIB) \
651           $(JAWT_CFLAGS), \
652       DISABLED_WARNINGS_clang := sign-compare, \
653       EXTRA_HEADER_DIRS := \
654           include \
655           common/awt, \
656       LDFLAGS := $(LDFLAGS_JDKLIB) \
657           $(call SET_SHARED_LIBRARY_ORIGIN), \
658       LDFLAGS_unix := -L$(INSTALL_LIBRARIES_HERE), \
659       LDFLAGS_macosx := -Wl$(COMMA)-rpath$(COMMA)@loader_path, \
660       LIBS_unix := $(JAWT_LIBS) $(JDKLIB_LIBS), \
661       LIBS_solaris := $(X_LIBS) -lXrender, \
662       LIBS_macosx := -framework Cocoa, \
663   ))
664 
665   ifeq ($(ENABLE_HEADLESS_ONLY), false)
666     $(BUILD_LIBJAWT): $(BUILD_LIBAWT_XAWT)
667   else
668     $(BUILD_LIBJAWT): $(call FindLib, $(MODULE), awt_headless)
669   endif
670 
671   ifeq ($(call isTargetOs, macosx), true)
672    $(BUILD_LIBJAWT): $(call FindLib, $(MODULE), awt_lwawt)
673   endif
674 
675 endif
676 
677 TARGETS += $(BUILD_LIBJAWT)
678 
679 ################################################################################
680 
681 ifeq ($(ENABLE_HEADLESS_ONLY), false)
682 
683   LIBSPLASHSCREEN_EXTRA_SRC := \
684       common/awt/systemscale \
685       #
686 
687   ifeq ($(USE_EXTERNAL_LIBGIF), false)
688     LIBSPLASHSCREEN_HEADER_DIRS += libsplashscreen/giflib
689   else
690     LIBSPLASHSCREEN_EXCLUDES := giflib
691     GIFLIB_LIBS := -lgif
692   endif
693 
694   ifeq ($(USE_EXTERNAL_LIBJPEG), false)
695     # While the following ought to work, it will currently pull in the closed
696     # additions to this library, and this was not done previously in the build.
697     # LIBSPLASHSCREEN_EXTRA_SRC += libjavajpeg
698     LIBSPLASHSCREEN_EXTRA_SRC += $(TOPDIR)/src/java.desktop/share/native/libjavajpeg
699   else
700     LIBJPEG_LIBS := -ljpeg
701   endif
702 
703   ifeq ($(USE_EXTERNAL_LIBPNG), false)
704     LIBSPLASHSCREEN_HEADER_DIRS += libsplashscreen/libpng
705   else
706     LIBSPLASHSCREEN_EXCLUDES += libpng
707   endif
708 
709   ifeq ($(USE_EXTERNAL_LIBZ), false)
710     LIBSPLASHSCREEN_EXTRA_SRC += java.base:libzip/zlib
711   endif
712 
713   ifeq ($(call isTargetOs, macosx), true)
714     # libsplashscreen on macosx do not use the unix code
715     LIBSPLASHSCREEN_EXCLUDE_SRC_PATTERNS := /unix/
716   endif
717 
718   LIBSPLASHSCREEN_CFLAGS += -DSPLASHSCREEN -DPNG_NO_MMX_CODE \
719                             -DPNG_ARM_NEON_OPT=0 -DPNG_ARM_NEON_IMPLEMENTATION=0
720 
721   ifeq ($(call isTargetOs, linux), true)
722     ifeq ($(call isTargetCpuArch, ppc), true)
723       LIBSPLASHSCREEN_CFLAGS += -DPNG_POWERPC_VSX_OPT=0
724     endif
725   endif
726 
727   ifeq ($(call isTargetOs, macosx), true)
728     LIBSPLASHSCREEN_CFLAGS += -DWITH_MACOSX
729 
730     BUILD_LIBSPLASHSCREEN_java_awt_SplashScreen.c_CFLAGS := -x objective-c -O0
731     BUILD_LIBSPLASHSCREEN_splashscreen_gfx_impl.c_CFLAGS := -x objective-c -O0
732     BUILD_LIBSPLASHSCREEN_splashscreen_gif.c_CFLAGS := -x objective-c -O0
733     BUILD_LIBSPLASHSCREEN_splashscreen_impl.c_CFLAGS := -x objective-c -O0
734     BUILD_LIBSPLASHSCREEN_splashscreen_jpeg.c_CFLAGS := -x objective-c -O0
735     BUILD_LIBSPLASHSCREEN_splashscreen_png.c_CFLAGS := -x objective-c -O0
736     BUILD_LIBSPLASHSCREEN_splashscreen_sys.m_CFLAGS := -O0
737 
738   else ifeq ($(call isTargetOs, windows), true)
739     LIBSPLASHSCREEN_CFLAGS += -DWITH_WIN32
740   else
741     LIBSPLASHSCREEN_CFLAGS += -DWITH_X11 $(X_CFLAGS)
742   endif
743 
744   LIBSPLASHSCREEN_LIBS :=
745 
746   ifeq ($(call isTargetOs, macosx), true)
747     LIBSPLASHSCREEN_LIBS += \
748         $(LIBM) -lpthread -liconv -losxapp \
749         -framework ApplicationServices \
750         -framework Foundation \
751         -framework Security \
752         -framework Cocoa \
753         -framework JavaNativeFoundation
754   else ifeq ($(call isTargetOs, windows), true)
755     LIBSPLASHSCREEN_LIBS += kernel32.lib user32.lib gdi32.lib delayimp.lib $(WIN_JAVA_LIB) jvm.lib
756   else
757     LIBSPLASHSCREEN_LIBS += $(X_LIBS) -lX11 -lXext $(LIBM) -lpthread -ldl
758   endif
759 
760   LIBSPLASHSCREEN_HEADER_DIRS += \
761       libosxapp \
762       java.base:include \
763       java.base:libjava \
764       #
765 
766   $(eval $(call SetupJdkLibrary, BUILD_LIBSPLASHSCREEN, \
767       NAME := splashscreen, \
768       EXTRA_SRC := $(LIBSPLASHSCREEN_EXTRA_SRC), \
769       EXCLUDE_SRC_PATTERNS := $(LIBSPLASHSCREEN_EXCLUDE_SRC_PATTERNS), \
770       EXCLUDE_FILES := imageioJPEG.c jpegdecoder.c pngtest.c, \
771       EXCLUDES := $(LIBSPLASHSCREEN_EXCLUDES), \
772       OPTIMIZATION := LOW, \
773       CFLAGS := $(CFLAGS_JDKLIB) $(LIBSPLASHSCREEN_CFLAGS) \
774           $(GIFLIB_CFLAGS) $(LIBJPEG_CFLAGS) $(PNG_CFLAGS) $(LIBZ_CFLAGS), \
775       EXTRA_HEADER_DIRS := $(LIBSPLASHSCREEN_HEADER_DIRS), \
776       DISABLED_WARNINGS_gcc := sign-compare type-limits unused-result \
777           maybe-uninitialized shift-negative-value implicit-fallthrough \
778           unused-function, \
779       DISABLED_WARNINGS_clang := incompatible-pointer-types sign-compare, \
780       DISABLED_WARNINGS_solstudio := E_STATEMENT_NOT_REACHED, \
781       DISABLED_WARNINGS_microsoft := 4018 4244 4267, \
782       LDFLAGS := $(LDFLAGS_JDKLIB) \
783           $(call SET_SHARED_LIBRARY_ORIGIN), \
784       LDFLAGS_macosx := -L$(INSTALL_LIBRARIES_HERE), \
785       LDFLAGS_windows := -delayload:user32.dll, \
786       LIBS := $(JDKLIB_LIBS) $(LIBSPLASHSCREEN_LIBS) $(LIBZ_LIBS) \
787           $(GIFLIB_LIBS) $(LIBJPEG_LIBS) $(PNG_LIBS), \
788       LIBS_aix := -liconv, \
789   ))
790 
791   TARGETS += $(BUILD_LIBSPLASHSCREEN)
792 
793   ifeq ($(call isTargetOs, macosx), true)
794     $(BUILD_LIBSPLASHSCREEN): $(call FindLib, $(MODULE), osxapp)
795   endif
796 
797 endif
798 
799 ################################################################################
800 
801 ifeq ($(call isTargetOs, macosx), true)
802 
803   LIBAWT_LWAWT_EXTRA_SRC := \
804       $(TOPDIR)/src/$(MODULE)/unix/native/common/awt \
805       $(TOPDIR)/src/$(MODULE)/share/native/common/font \
806       $(TOPDIR)/src/$(MODULE)/share/native/common/java2d \
807       #
808 
809   LIBAWT_LWAWT_EXTRA_HEADER_DIRS := \
810       $(LIBAWT_DEFAULT_HEADER_DIRS) \
811       libawt_lwawt/awt \
812       libawt_lwawt/font \
813       libawt_lwawt/java2d/opengl \
814       include \
815       common/awt/debug \
816       common/java2d/opengl \
817       libosxapp \
818       #
819 
820   LIBAWT_LWAWT_CFLAGS := $(X_CFLAGS) $(X_LIBS)
821 
822   LIBAWT_LWAWT_EXFILES := fontpath.c awt_Font.c X11Color.c
823   LIBAWT_LWAWT_EXCLUDES := $(TOPDIR)/src/$(MODULE)/unix/native/common/awt/medialib
824 
825   $(eval $(call SetupJdkLibrary, BUILD_LIBAWT_LWAWT, \
826       NAME := awt_lwawt, \
827       EXTRA_SRC := $(LIBAWT_LWAWT_EXTRA_SRC), \
828       INCLUDE_FILES := $(LIBAWT_LWAWT_FILES), \
829       EXCLUDE_FILES := $(LIBAWT_LWAWT_EXFILES), \
830       EXCLUDES := $(LIBAWT_LWAWT_EXCLUDES), \
831       OPTIMIZATION := LOW, \
832       CFLAGS := $(CFLAGS_JDKLIB) \
833           $(LIBAWT_LWAWT_CFLAGS), \
834       EXTRA_HEADER_DIRS := $(LIBAWT_LWAWT_EXTRA_HEADER_DIRS), \
835       DISABLED_WARNINGS_clang := incomplete-implementation enum-conversion \
836           deprecated-declarations objc-method-access bitwise-op-parentheses \
837           incompatible-pointer-types parentheses-equality extra-tokens \
838           sign-compare semicolon-before-method-body format-nonliteral undef \
839           pointer-arith, \
840       LDFLAGS := $(LDFLAGS_JDKLIB) \
841           $(call SET_SHARED_LIBRARY_ORIGIN) \
842           -L$(INSTALL_LIBRARIES_HERE), \
843       LIBS := -lawt -lmlib_image -losxapp -ljvm $(LIBM) \
844           -framework Accelerate \
845           -framework ApplicationServices \
846           -framework AudioToolbox \
847           -framework Carbon \
848           -framework Cocoa \
849           -framework Security \
850           -framework ExceptionHandling \
851           -framework JavaNativeFoundation \
852           -framework JavaRuntimeSupport \
853           -framework OpenGL \
854           -framework QuartzCore -ljava, \
855   ))
856 
857   TARGETS += $(BUILD_LIBAWT_LWAWT)
858 
859   $(BUILD_LIBAWT_LWAWT): $(BUILD_LIBAWT)
860 
861   $(BUILD_LIBAWT_LWAWT): $(BUILD_LIBMLIB_IMAGE)
862 
863   $(BUILD_LIBAWT_LWAWT): $(call FindLib, $(MODULE), osxapp)
864 
865   $(BUILD_LIBAWT_LWAWT): $(call FindLib, java.base, java)
866 
867 endif
868 
869 ################################################################################
870 
871 ifeq ($(call isTargetOs, macosx), true)
872 
873   $(eval $(call SetupJdkLibrary, BUILD_LIBOSXUI, \
874       NAME := osxui, \
875       OPTIMIZATION := LOW, \
876       CFLAGS := $(CFLAGS_JDKLIB), \
877       EXTRA_HEADER_DIRS := \
878           libawt_lwawt/awt \
879           libosxapp, \
880       DISABLED_WARNINGS_clang := deprecated-declarations sign-compare, \
881       LDFLAGS := $(LDFLAGS_JDKLIB) \
882           $(call SET_SHARED_LIBRARY_ORIGIN) \
883           -Wl$(COMMA)-rpath$(COMMA)@loader_path \
884           -L$(INSTALL_LIBRARIES_HERE), \
885       LIBS := -lawt -losxapp -lawt_lwawt \
886           -framework Cocoa \
887           -framework Carbon \
888           -framework ApplicationServices \
889           -framework JavaNativeFoundation \
890           -framework JavaRuntimeSupport \
891           -ljava -ljvm, \
892   ))
893 
894   TARGETS += $(BUILD_LIBOSXUI)
895 
896   $(BUILD_LIBOSXUI): $(BUILD_LIBAWT)
897 
898   $(BUILD_LIBOSXUI): $(call FindLib, $(MODULE), osxapp)
899 
900   $(BUILD_LIBOSXUI): $(BUILD_LIBAWT_LWAWT)
901 
902 endif
903 
904 ################################################################################
905 
906 # Hook to include the corresponding custom file, if present.
907 $(eval $(call IncludeCustomExtension, lib/Awt2dLibraries.gmk))
    </pre>
  </body>
</html>