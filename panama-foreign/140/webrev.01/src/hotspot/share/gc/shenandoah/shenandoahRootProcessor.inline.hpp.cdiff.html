<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff src/hotspot/share/gc/shenandoah/shenandoahRootProcessor.inline.hpp</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
<body>
<center><a href="shenandoahRootProcessor.hpp.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="shenandoahStringDedup.cpp.cdiff.html" target="_top">next &gt;</a></center>    <h2>src/hotspot/share/gc/shenandoah/shenandoahRootProcessor.inline.hpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 38,37 ***</span>
  #include &quot;memory/resourceArea.hpp&quot;
  #include &quot;prims/resolvedMethodTable.hpp&quot;
  #include &quot;runtime/safepoint.hpp&quot;
  
  template &lt;bool CONCURRENT&gt;
<span class="line-modified">! inline ShenandoahVMRoot&lt;CONCURRENT&gt;::ShenandoahVMRoot(OopStorage* storage, ShenandoahPhaseTimings::GCParPhases phase) :</span>
<span class="line-modified">!   _itr(storage), _phase(phase) {</span>
  }
  
  template &lt;bool CONCURRENT&gt;
  template &lt;typename Closure&gt;
  inline void ShenandoahVMRoot&lt;CONCURRENT&gt;::oops_do(Closure* cl, uint worker_id) {
<span class="line-modified">!   if (CONCURRENT) {</span>
<span class="line-modified">!     _itr.oops_do(cl);</span>
<span class="line-removed">-   } else {</span>
<span class="line-removed">-     ShenandoahWorkerTimingsTracker timer(_phase, worker_id);</span>
<span class="line-removed">-     _itr.oops_do(cl);</span>
<span class="line-removed">-   }</span>
  }
  
  template &lt;bool CONCURRENT&gt;
<span class="line-modified">! inline ShenandoahWeakRoot&lt;CONCURRENT&gt;::ShenandoahWeakRoot(OopStorage* storage, ShenandoahPhaseTimings::GCParPhases phase) :</span>
<span class="line-modified">!   ShenandoahVMRoot&lt;CONCURRENT&gt;(storage, phase) {</span>
  }
  
<span class="line-modified">! inline ShenandoahWeakRoot&lt;false&gt;::ShenandoahWeakRoot(OopStorage* storage, ShenandoahPhaseTimings::GCParPhases phase) :</span>
<span class="line-modified">!   _itr(storage), _phase(phase) {</span>
  }
  
  template &lt;typename IsAliveClosure, typename KeepAliveClosure&gt;
  void ShenandoahWeakRoot&lt;false /* concurrent */&gt;::weak_oops_do(IsAliveClosure* is_alive, KeepAliveClosure* keep_alive, uint worker_id) {
<span class="line-modified">!   ShenandoahWorkerTimingsTracker timer(_phase, worker_id);</span>
    _itr.weak_oops_do(is_alive, keep_alive);
  }
  
  template &lt;bool CONCURRENT&gt;
  ShenandoahWeakRoots&lt;CONCURRENT&gt;::ShenandoahWeakRoots() :
<span class="line-new-header">--- 38,36 ---</span>
  #include &quot;memory/resourceArea.hpp&quot;
  #include &quot;prims/resolvedMethodTable.hpp&quot;
  #include &quot;runtime/safepoint.hpp&quot;
  
  template &lt;bool CONCURRENT&gt;
<span class="line-modified">! inline ShenandoahVMRoot&lt;CONCURRENT&gt;::ShenandoahVMRoot(OopStorage* storage,</span>
<span class="line-modified">!         ShenandoahPhaseTimings::Phase phase, ShenandoahPhaseTimings::ParPhase par_phase) :</span>
<span class="line-added">+   _itr(storage), _phase(phase), _par_phase(par_phase) {</span>
  }
  
  template &lt;bool CONCURRENT&gt;
  template &lt;typename Closure&gt;
  inline void ShenandoahVMRoot&lt;CONCURRENT&gt;::oops_do(Closure* cl, uint worker_id) {
<span class="line-modified">!   ShenandoahWorkerTimingsTracker timer(_phase, _par_phase, worker_id);</span>
<span class="line-modified">!   _itr.oops_do(cl);</span>
  }
  
  template &lt;bool CONCURRENT&gt;
<span class="line-modified">! inline ShenandoahWeakRoot&lt;CONCURRENT&gt;::ShenandoahWeakRoot(OopStorage* storage,</span>
<span class="line-modified">!   ShenandoahPhaseTimings::Phase phase, ShenandoahPhaseTimings::ParPhase par_phase) :</span>
<span class="line-added">+   ShenandoahVMRoot&lt;CONCURRENT&gt;(storage, phase, par_phase) {</span>
  }
  
<span class="line-modified">! inline ShenandoahWeakRoot&lt;false&gt;::ShenandoahWeakRoot(OopStorage* storage,</span>
<span class="line-modified">!   ShenandoahPhaseTimings::Phase phase,  ShenandoahPhaseTimings::ParPhase par_phase) :</span>
<span class="line-added">+   _itr(storage), _phase(phase), _par_phase(par_phase) {</span>
  }
  
  template &lt;typename IsAliveClosure, typename KeepAliveClosure&gt;
  void ShenandoahWeakRoot&lt;false /* concurrent */&gt;::weak_oops_do(IsAliveClosure* is_alive, KeepAliveClosure* keep_alive, uint worker_id) {
<span class="line-modified">!   ShenandoahWorkerTimingsTracker timer(_phase, _par_phase, worker_id);</span>
    _itr.weak_oops_do(is_alive, keep_alive);
  }
  
  template &lt;bool CONCURRENT&gt;
  ShenandoahWeakRoots&lt;CONCURRENT&gt;::ShenandoahWeakRoots() :
</pre>
<hr />
<pre>
<span class="line-old-header">*** 85,15 ***</span>
    _string_table_roots.oops_do(cl, worker_id);
    _resolved_method_table_roots.oops_do(cl, worker_id);
    _vm_roots.oops_do(cl, worker_id);
  }
  
<span class="line-modified">! inline ShenandoahWeakRoots&lt;false /* concurrent */&gt;::ShenandoahWeakRoots() :</span>
<span class="line-modified">!   _jni_roots(OopStorageSet::jni_weak(), ShenandoahPhaseTimings::JNIWeakRoots),</span>
<span class="line-modified">!   _string_table_roots(OopStorageSet::string_table_weak(), ShenandoahPhaseTimings::StringTableRoots),</span>
<span class="line-modified">!   _resolved_method_table_roots(OopStorageSet::resolved_method_table_weak(), ShenandoahPhaseTimings::ResolvedMethodTableRoots),</span>
<span class="line-modified">!   _vm_roots(OopStorageSet::vm_weak(), ShenandoahPhaseTimings::VMWeakRoots) {</span>
  }
  
  template &lt;typename IsAliveClosure, typename KeepAliveClosure&gt;
  void ShenandoahWeakRoots&lt;false /* concurrent*/&gt;::weak_oops_do(IsAliveClosure* is_alive, KeepAliveClosure* keep_alive, uint worker_id) {
    _jni_roots.weak_oops_do(is_alive, keep_alive, worker_id);
<span class="line-new-header">--- 84,15 ---</span>
    _string_table_roots.oops_do(cl, worker_id);
    _resolved_method_table_roots.oops_do(cl, worker_id);
    _vm_roots.oops_do(cl, worker_id);
  }
  
<span class="line-modified">! inline ShenandoahWeakRoots&lt;false /* concurrent */&gt;::ShenandoahWeakRoots(ShenandoahPhaseTimings::Phase phase) :</span>
<span class="line-modified">!   _jni_roots(OopStorageSet::jni_weak(), phase, ShenandoahPhaseTimings::JNIWeakRoots),</span>
<span class="line-modified">!   _string_table_roots(OopStorageSet::string_table_weak(), phase, ShenandoahPhaseTimings::StringTableRoots),</span>
<span class="line-modified">!   _resolved_method_table_roots(OopStorageSet::resolved_method_table_weak(), phase, ShenandoahPhaseTimings::ResolvedMethodTableRoots),</span>
<span class="line-modified">!   _vm_roots(OopStorageSet::vm_weak(), phase, ShenandoahPhaseTimings::VMWeakRoots) {</span>
  }
  
  template &lt;typename IsAliveClosure, typename KeepAliveClosure&gt;
  void ShenandoahWeakRoots&lt;false /* concurrent*/&gt;::weak_oops_do(IsAliveClosure* is_alive, KeepAliveClosure* keep_alive, uint worker_id) {
    _jni_roots.weak_oops_do(is_alive, keep_alive, worker_id);
</pre>
<hr />
<pre>
<span class="line-old-header">*** 107,24 ***</span>
    AlwaysTrueClosure always_true;
    weak_oops_do&lt;AlwaysTrueClosure, Closure&gt;(&amp;always_true, cl, worker_id);
  }
  
  template &lt;bool CONCURRENT&gt;
<span class="line-modified">! ShenandoahVMRoots&lt;CONCURRENT&gt;::ShenandoahVMRoots() :</span>
<span class="line-modified">!   _jni_handle_roots(OopStorageSet::jni_global(), ShenandoahPhaseTimings::JNIRoots),</span>
<span class="line-modified">!   _vm_global_roots(OopStorageSet::vm_global(), ShenandoahPhaseTimings::VMGlobalRoots) {</span>
  }
  
  template &lt;bool CONCURRENT&gt;
  template &lt;typename T&gt;
  void ShenandoahVMRoots&lt;CONCURRENT&gt;::oops_do(T* cl, uint worker_id) {
    _jni_handle_roots.oops_do(cl, worker_id);
    _vm_global_roots.oops_do(cl, worker_id);
  }
  
  template &lt;bool CONCURRENT, bool SINGLE_THREADED&gt;
<span class="line-modified">! ShenandoahClassLoaderDataRoots&lt;CONCURRENT, SINGLE_THREADED&gt;::ShenandoahClassLoaderDataRoots() {</span>
    if (!SINGLE_THREADED) {
      ClassLoaderDataGraph::clear_claimed_marks();
    }
    if (CONCURRENT) {
      ClassLoaderDataGraph_lock-&gt;lock();
<span class="line-new-header">--- 106,25 ---</span>
    AlwaysTrueClosure always_true;
    weak_oops_do&lt;AlwaysTrueClosure, Closure&gt;(&amp;always_true, cl, worker_id);
  }
  
  template &lt;bool CONCURRENT&gt;
<span class="line-modified">! ShenandoahVMRoots&lt;CONCURRENT&gt;::ShenandoahVMRoots(ShenandoahPhaseTimings::Phase phase) :</span>
<span class="line-modified">!   _jni_handle_roots(OopStorageSet::jni_global(), phase, ShenandoahPhaseTimings::JNIRoots),</span>
<span class="line-modified">!   _vm_global_roots(OopStorageSet::vm_global(), phase, ShenandoahPhaseTimings::VMGlobalRoots) {</span>
  }
  
  template &lt;bool CONCURRENT&gt;
  template &lt;typename T&gt;
  void ShenandoahVMRoots&lt;CONCURRENT&gt;::oops_do(T* cl, uint worker_id) {
    _jni_handle_roots.oops_do(cl, worker_id);
    _vm_global_roots.oops_do(cl, worker_id);
  }
  
  template &lt;bool CONCURRENT, bool SINGLE_THREADED&gt;
<span class="line-modified">! ShenandoahClassLoaderDataRoots&lt;CONCURRENT, SINGLE_THREADED&gt;::ShenandoahClassLoaderDataRoots(ShenandoahPhaseTimings::Phase phase) :</span>
<span class="line-added">+   _phase(phase) {</span>
    if (!SINGLE_THREADED) {
      ClassLoaderDataGraph::clear_claimed_marks();
    }
    if (CONCURRENT) {
      ClassLoaderDataGraph_lock-&gt;lock();
</pre>
<hr />
<pre>
<span class="line-old-header">*** 143,40 ***</span>
  void ShenandoahClassLoaderDataRoots&lt;CONCURRENT, SINGLE_THREADED&gt;::always_strong_cld_do(CLDClosure* clds, uint worker_id) {
    if (SINGLE_THREADED) {
      assert(SafepointSynchronize::is_at_safepoint(), &quot;Must be at a safepoint&quot;);
      assert(Thread::current()-&gt;is_VM_thread(), &quot;Single threaded CLDG iteration can only be done by VM thread&quot;);
      ClassLoaderDataGraph::always_strong_cld_do(clds);
<span class="line-removed">-   } else if (CONCURRENT) {</span>
<span class="line-removed">-      ClassLoaderDataGraph::always_strong_cld_do(clds);</span>
    } else {
<span class="line-modified">!    ShenandoahWorkerTimingsTracker timer(ShenandoahPhaseTimings::CLDGRoots, worker_id);</span>
<span class="line-modified">!    ClassLoaderDataGraph::always_strong_cld_do(clds);</span>
    }
  }
  
  template &lt;bool CONCURRENT, bool SINGLE_THREADED&gt;
  void ShenandoahClassLoaderDataRoots&lt;CONCURRENT, SINGLE_THREADED&gt;::cld_do(CLDClosure* clds, uint worker_id) {
    if (SINGLE_THREADED) {
      assert(SafepointSynchronize::is_at_safepoint(), &quot;Must be at a safepoint&quot;);
      assert(Thread::current()-&gt;is_VM_thread(), &quot;Single threaded CLDG iteration can only be done by VM thread&quot;);
      ClassLoaderDataGraph::cld_do(clds);
<span class="line-modified">!   } else if (CONCURRENT) {</span>
<span class="line-modified">!     ClassLoaderDataGraph::cld_do(clds);</span>
<span class="line-removed">-   }  else {</span>
<span class="line-removed">-     ShenandoahWorkerTimingsTracker timer(ShenandoahPhaseTimings::CLDGRoots, worker_id);</span>
      ClassLoaderDataGraph::cld_do(clds);
    }
  }
  
  template &lt;typename ITR&gt;
<span class="line-modified">! ShenandoahCodeCacheRoots&lt;ITR&gt;::ShenandoahCodeCacheRoots() {</span>
    nmethod::oops_do_marking_prologue();
  }
  
  template &lt;typename ITR&gt;
  void ShenandoahCodeCacheRoots&lt;ITR&gt;::code_blobs_do(CodeBlobClosure* blob_cl, uint worker_id) {
<span class="line-modified">!   ShenandoahWorkerTimingsTracker timer(ShenandoahPhaseTimings::CodeCacheRoots, worker_id);</span>
    _coderoots_iterator.possibly_parallel_blobs_do(blob_cl);
  }
  
  template &lt;typename ITR&gt;
  ShenandoahCodeCacheRoots&lt;ITR&gt;::~ShenandoahCodeCacheRoots() {
<span class="line-new-header">--- 143,36 ---</span>
  void ShenandoahClassLoaderDataRoots&lt;CONCURRENT, SINGLE_THREADED&gt;::always_strong_cld_do(CLDClosure* clds, uint worker_id) {
    if (SINGLE_THREADED) {
      assert(SafepointSynchronize::is_at_safepoint(), &quot;Must be at a safepoint&quot;);
      assert(Thread::current()-&gt;is_VM_thread(), &quot;Single threaded CLDG iteration can only be done by VM thread&quot;);
      ClassLoaderDataGraph::always_strong_cld_do(clds);
    } else {
<span class="line-modified">!     ShenandoahWorkerTimingsTracker timer(_phase, ShenandoahPhaseTimings::CLDGRoots, worker_id);</span>
<span class="line-modified">!     ClassLoaderDataGraph::always_strong_cld_do(clds);</span>
    }
  }
  
  template &lt;bool CONCURRENT, bool SINGLE_THREADED&gt;
  void ShenandoahClassLoaderDataRoots&lt;CONCURRENT, SINGLE_THREADED&gt;::cld_do(CLDClosure* clds, uint worker_id) {
    if (SINGLE_THREADED) {
      assert(SafepointSynchronize::is_at_safepoint(), &quot;Must be at a safepoint&quot;);
      assert(Thread::current()-&gt;is_VM_thread(), &quot;Single threaded CLDG iteration can only be done by VM thread&quot;);
      ClassLoaderDataGraph::cld_do(clds);
<span class="line-modified">!   } else {</span>
<span class="line-modified">!     ShenandoahWorkerTimingsTracker timer(_phase, ShenandoahPhaseTimings::CLDGRoots, worker_id);</span>
      ClassLoaderDataGraph::cld_do(clds);
    }
  }
  
  template &lt;typename ITR&gt;
<span class="line-modified">! ShenandoahCodeCacheRoots&lt;ITR&gt;::ShenandoahCodeCacheRoots(ShenandoahPhaseTimings::Phase phase) : _phase(phase) {</span>
    nmethod::oops_do_marking_prologue();
  }
  
  template &lt;typename ITR&gt;
  void ShenandoahCodeCacheRoots&lt;ITR&gt;::code_blobs_do(CodeBlobClosure* blob_cl, uint worker_id) {
<span class="line-modified">!   ShenandoahWorkerTimingsTracker timer(_phase, ShenandoahPhaseTimings::CodeCacheRoots, worker_id);</span>
    _coderoots_iterator.possibly_parallel_blobs_do(blob_cl);
  }
  
  template &lt;typename ITR&gt;
  ShenandoahCodeCacheRoots&lt;ITR&gt;::~ShenandoahCodeCacheRoots() {
</pre>
<hr />
<pre>
<span class="line-old-header">*** 201,11 ***</span>
  };
  
  template &lt;typename ITR&gt;
  ShenandoahRootScanner&lt;ITR&gt;::ShenandoahRootScanner(uint n_workers, ShenandoahPhaseTimings::Phase phase) :
    ShenandoahRootProcessor(phase),
<span class="line-modified">!   _thread_roots(n_workers &gt; 1) {</span>
  }
  
  template &lt;typename ITR&gt;
  void ShenandoahRootScanner&lt;ITR&gt;::roots_do(uint worker_id, OopClosure* oops) {
    CLDToOopClosure clds_cl(oops, ClassLoaderData::_claim_strong);
<span class="line-new-header">--- 197,16 ---</span>
  };
  
  template &lt;typename ITR&gt;
  ShenandoahRootScanner&lt;ITR&gt;::ShenandoahRootScanner(uint n_workers, ShenandoahPhaseTimings::Phase phase) :
    ShenandoahRootProcessor(phase),
<span class="line-modified">!   _serial_roots(phase),</span>
<span class="line-added">+   _thread_roots(phase, n_workers &gt; 1),</span>
<span class="line-added">+   _code_roots(phase),</span>
<span class="line-added">+   _vm_roots(phase),</span>
<span class="line-added">+   _dedup_roots(phase),</span>
<span class="line-added">+   _cld_roots(phase) {</span>
  }
  
  template &lt;typename ITR&gt;
  void ShenandoahRootScanner&lt;ITR&gt;::roots_do(uint worker_id, OopClosure* oops) {
    CLDToOopClosure clds_cl(oops, ClassLoaderData::_claim_strong);
</pre>
<center><a href="shenandoahRootProcessor.hpp.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="shenandoahStringDedup.cpp.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>