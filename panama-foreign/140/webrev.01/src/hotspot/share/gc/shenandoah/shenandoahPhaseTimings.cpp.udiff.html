<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff src/hotspot/share/gc/shenandoah/shenandoahPhaseTimings.cpp</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
<body>
<center><a href="shenandoahParallelCleaning.inline.hpp.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="shenandoahPhaseTimings.hpp.udiff.html" target="_top">next &gt;</a></center>    <h2>src/hotspot/share/gc/shenandoah/shenandoahPhaseTimings.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -36,28 +36,28 @@</span>
  #define SHENANDOAH_PHASE_NAME_FORMAT &quot;%-28s&quot;
  #define SHENANDOAH_S_TIME_FORMAT &quot;%8.3lf&quot;
  #define SHENANDOAH_US_TIME_FORMAT &quot;%8.0lf&quot;
  #define SHENANDOAH_US_WORKER_TIME_FORMAT &quot;%3.0lf&quot;
  
<span class="udiff-line-modified-removed">- #define GC_PHASE_DECLARE_NAME(type, title) \</span>
<span class="udiff-line-modified-added">+ #define SHENANDOAH_PHASE_DECLARE_NAME(type, title) \</span>
    title,
  
  const char* ShenandoahPhaseTimings::_phase_names[] = {
<span class="udiff-line-modified-removed">-   SHENANDOAH_GC_PHASE_DO(GC_PHASE_DECLARE_NAME)</span>
<span class="udiff-line-modified-added">+   SHENANDOAH_PHASE_DO(SHENANDOAH_PHASE_DECLARE_NAME)</span>
  };
  
<span class="udiff-line-modified-removed">- #undef GC_PHASE_DECLARE_NAME</span>
<span class="udiff-line-modified-added">+ #undef SHENANDOAH_PHASE_DECLARE_NAME</span>
  
<span class="udiff-line-modified-removed">- ShenandoahPhaseTimings::ShenandoahPhaseTimings() {</span>
<span class="udiff-line-modified-removed">-   _max_workers = MAX2(ConcGCThreads, ParallelGCThreads);</span>
<span class="udiff-line-modified-added">+ ShenandoahPhaseTimings::ShenandoahPhaseTimings(uint max_workers) :</span>
<span class="udiff-line-modified-added">+   _max_workers(max_workers) {</span>
    assert(_max_workers &gt; 0, &quot;Must have some GC threads&quot;);
  
    // Initialize everything to sane defaults
    for (uint i = 0; i &lt; _num_phases; i++) {
  #define SHENANDOAH_WORKER_DATA_NULL(type, title) \
      _worker_data[i] = NULL;
<span class="udiff-line-modified-removed">-     SHENANDOAH_GC_PAR_PHASE_DO(,, SHENANDOAH_WORKER_DATA_NULL)</span>
<span class="udiff-line-modified-added">+     SHENANDOAH_PAR_PHASE_DO(,, SHENANDOAH_WORKER_DATA_NULL)</span>
  #undef SHENANDOAH_WORKER_DATA_NULL
      _cycle_data[i] = 0;
    }
  
    // Then punch in the worker-related data.
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -66,29 +66,27 @@</span>
    for (uint i = 0; i &lt; _num_phases; i++) {
      if (is_worker_phase(Phase(i))) {
        int c = 0;
  #define SHENANDOAH_WORKER_DATA_INIT(type, title) \
        if (c++ != 0) _worker_data[i + c] = new ShenandoahWorkerData(title, _max_workers);
<span class="udiff-line-modified-removed">-       SHENANDOAH_GC_PAR_PHASE_DO(,, SHENANDOAH_WORKER_DATA_INIT)</span>
<span class="udiff-line-modified-added">+       SHENANDOAH_PAR_PHASE_DO(,, SHENANDOAH_WORKER_DATA_INIT)</span>
  #undef SHENANDOAH_WORKER_DATA_INIT
      }
    }
  
    _policy = ShenandoahHeap::heap()-&gt;shenandoah_policy();
    assert(_policy != NULL, &quot;Can not be NULL&quot;);
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-   _current_worker_phase = _invalid_phase;</span>
  }
  
<span class="udiff-line-modified-removed">- ShenandoahPhaseTimings::Phase ShenandoahPhaseTimings::worker_par_phase(Phase phase, GCParPhases par_phase) {</span>
<span class="udiff-line-modified-added">+ ShenandoahPhaseTimings::Phase ShenandoahPhaseTimings::worker_par_phase(Phase phase, ParPhase par_phase) {</span>
    assert(is_worker_phase(phase), &quot;Phase should accept worker phase times: %s&quot;, phase_name(phase));
    Phase p = Phase(phase + 1 + par_phase);
    assert(p &gt;= 0 &amp;&amp; p &lt; _num_phases, &quot;Out of bound for: %s&quot;, phase_name(phase));
    return p;
  }
  
<span class="udiff-line-modified-removed">- ShenandoahWorkerData* ShenandoahPhaseTimings::worker_data(Phase phase, GCParPhases par_phase) {</span>
<span class="udiff-line-modified-added">+ ShenandoahWorkerData* ShenandoahPhaseTimings::worker_data(Phase phase, ParPhase par_phase) {</span>
    Phase p = worker_par_phase(phase, par_phase);
    ShenandoahWorkerData* wd = _worker_data[p];
    assert(wd != NULL, &quot;Counter initialized: %s&quot;, phase_name(p));
    return wd;
  }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -107,10 +105,28 @@</span>
      case full_gc_purge_class_unload:
      case full_gc_purge_weak_par:
      case purge_class_unload:
      case purge_weak_par:
      case heap_iteration_roots:
<span class="udiff-line-added">+     case conc_weak_roots:</span>
<span class="udiff-line-added">+     case conc_strong_roots:</span>
<span class="udiff-line-added">+       return true;</span>
<span class="udiff-line-added">+     default:</span>
<span class="udiff-line-added">+       return false;</span>
<span class="udiff-line-added">+   }</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ bool ShenandoahPhaseTimings::is_root_work_phase(Phase phase) {</span>
<span class="udiff-line-added">+   switch (phase) {</span>
<span class="udiff-line-added">+     case scan_roots:</span>
<span class="udiff-line-added">+     case update_roots:</span>
<span class="udiff-line-added">+     case init_evac:</span>
<span class="udiff-line-added">+     case final_update_refs_roots:</span>
<span class="udiff-line-added">+     case degen_gc_update_roots:</span>
<span class="udiff-line-added">+     case full_gc_scan_roots:</span>
<span class="udiff-line-added">+     case full_gc_update_roots:</span>
<span class="udiff-line-added">+     case full_gc_adjust_roots:</span>
        return true;
      default:
        return false;
    }
  }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -130,31 +146,26 @@</span>
  }
  
  void ShenandoahPhaseTimings::record_workers_start(Phase phase) {
    assert(is_worker_phase(phase), &quot;Phase should accept worker phase times: %s&quot;, phase_name(phase));
  
<span class="udiff-line-modified-removed">-   assert(_current_worker_phase == _invalid_phase, &quot;Should not be set yet: requested %s, existing %s&quot;,</span>
<span class="udiff-line-modified-removed">-          phase_name(phase), phase_name(_current_worker_phase));</span>
<span class="udiff-line-removed">-   _current_worker_phase = phase;</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-   for (uint i = 1; i &lt; GCParPhasesSentinel; i++) {</span>
<span class="udiff-line-removed">-     worker_data(phase, GCParPhases(i))-&gt;reset();</span>
<span class="udiff-line-modified-added">+   for (uint i = 1; i &lt; _num_par_phases; i++) {</span>
<span class="udiff-line-modified-added">+     worker_data(phase, ParPhase(i))-&gt;reset();</span>
    }
  }
  
  void ShenandoahPhaseTimings::record_workers_end(Phase phase) {
    assert(is_worker_phase(phase), &quot;Phase should accept worker phase times: %s&quot;, phase_name(phase));
<span class="udiff-line-removed">-   _current_worker_phase = _invalid_phase;</span>
  }
  
  void ShenandoahPhaseTimings::flush_par_workers_to_cycle() {
    for (uint pi = 0; pi &lt; _num_phases; pi++) {
      Phase phase = Phase(pi);
      if (is_worker_phase(phase)) {
        double s = 0;
<span class="udiff-line-modified-removed">-       for (uint i = 1; i &lt; GCParPhasesSentinel; i++) {</span>
<span class="udiff-line-modified-removed">-         double t = worker_data(phase, GCParPhases(i))-&gt;sum();</span>
<span class="udiff-line-modified-added">+       for (uint i = 1; i &lt; _num_par_phases; i++) {</span>
<span class="udiff-line-modified-added">+         double t = worker_data(phase, ParPhase(i))-&gt;sum();</span>
          // add to each line in phase
          set_cycle_data(Phase(phase + i + 1), t);
          s += t;
        }
        // add to total for phase
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -180,11 +191,11 @@</span>
      double v = _cycle_data[i] * 1000000.0;
      if (v &gt; 0) {
        out-&gt;print(SHENANDOAH_PHASE_NAME_FORMAT &quot; &quot; SHENANDOAH_US_TIME_FORMAT &quot; us&quot;, _phase_names[i], v);
        if (_worker_data[i] != NULL) {
          out-&gt;print(&quot;, workers (us): &quot;);
<span class="udiff-line-modified-removed">-         for (size_t c = 0; c &lt; _max_workers; c++) {</span>
<span class="udiff-line-modified-added">+         for (uint c = 0; c &lt; _max_workers; c++) {</span>
            double tv = _worker_data[i]-&gt;get(c);
            if (tv != ShenandoahWorkerData::uninitialized()) {
              out-&gt;print(SHENANDOAH_US_WORKER_TIME_FORMAT &quot;, &quot;, tv * 1000000.0);
            } else {
              out-&gt;print(&quot;%3s, &quot;, &quot;---&quot;);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -231,23 +242,25 @@</span>
        );
      }
    }
  }
  
<span class="udiff-line-modified-removed">- ShenandoahWorkerTimingsTracker::ShenandoahWorkerTimingsTracker(ShenandoahPhaseTimings::GCParPhases par_phase, uint worker_id) :</span>
<span class="udiff-line-modified-removed">-         _timings(ShenandoahHeap::heap()-&gt;phase_timings()), _phase(_timings-&gt;current_worker_phase()),</span>
<span class="udiff-line-modified-removed">-         _par_phase(par_phase), _worker_id(worker_id) {</span>
<span class="udiff-line-modified-added">+ ShenandoahWorkerTimingsTracker::ShenandoahWorkerTimingsTracker(ShenandoahPhaseTimings::Phase phase,</span>
<span class="udiff-line-modified-added">+         ShenandoahPhaseTimings::ParPhase par_phase, uint worker_id) :</span>
<span class="udiff-line-modified-added">+         _timings(ShenandoahHeap::heap()-&gt;phase_timings()),</span>
<span class="udiff-line-added">+         _phase(phase), _par_phase(par_phase), _worker_id(worker_id) {</span>
<span class="udiff-line-added">+ </span>
    assert(_timings-&gt;worker_data(_phase, _par_phase)-&gt;get(_worker_id) == ShenandoahWorkerData::uninitialized(),
           &quot;Should not be set yet: %s&quot;, ShenandoahPhaseTimings::phase_name(_timings-&gt;worker_par_phase(_phase, _par_phase)));
    _start_time = os::elapsedTime();
  }
  
  ShenandoahWorkerTimingsTracker::~ShenandoahWorkerTimingsTracker() {
    _timings-&gt;worker_data(_phase, _par_phase)-&gt;set(_worker_id, os::elapsedTime() - _start_time);
  
<span class="udiff-line-modified-removed">-   if (ShenandoahGCPhase::is_root_work_phase()) {</span>
<span class="udiff-line-modified-removed">-     ShenandoahPhaseTimings::Phase root_phase = ShenandoahGCPhase::current_phase();</span>
<span class="udiff-line-modified-added">+   if (ShenandoahPhaseTimings::is_root_work_phase(_phase)) {</span>
<span class="udiff-line-modified-added">+     ShenandoahPhaseTimings::Phase root_phase = _phase;</span>
      ShenandoahPhaseTimings::Phase cur_phase = _timings-&gt;worker_par_phase(root_phase, _par_phase);
      _event.commit(GCId::current(), _worker_id, ShenandoahPhaseTimings::phase_name(cur_phase));
    }
  }
  
</pre>
<center><a href="shenandoahParallelCleaning.inline.hpp.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="shenandoahPhaseTimings.hpp.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>