<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/hotspot/share/classfile/classLoaderStats.cpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
  </head>
<body>
<center><a href="classLoaderHierarchyDCmd.cpp.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="classLoaderStats.hpp.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/hotspot/share/classfile/classLoaderStats.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 57     _stats-&gt;put(cl, cls);
 58     _total_loaders++;
 59   } else {
 60     cls = *cls_ptr;
 61   }
 62 
 63   if (!cld-&gt;has_class_mirror_holder()) {
 64     cls-&gt;_cld = cld;
 65   }
 66 
 67   cls-&gt;_class_loader = cl;
 68   if (cl != NULL) {
 69     cls-&gt;_parent = java_lang_ClassLoader::parent(cl);
 70     addEmptyParents(cls-&gt;_parent);
 71   }
 72 
 73   ClassStatsClosure csc;
 74   cld-&gt;classes_do(&amp;csc);
 75   bool is_hidden = false;
 76   if(cld-&gt;has_class_mirror_holder()) {
<span class="line-modified"> 77     // if cld has a class holder then it must be either hidden or unsafe anonymous.</span>
<span class="line-modified"> 78     Klass* k = cld-&gt;klasses();</span>
<span class="line-modified"> 79     // if it&#39;s an array class then need to see if bottom class is hidden.</span>
<span class="line-removed"> 80     if (k-&gt;is_array_klass()) {</span>
<span class="line-removed"> 81       k = ObjArrayKlass::cast(k)-&gt;bottom_klass();</span>
<span class="line-removed"> 82     }</span>
<span class="line-removed"> 83     is_hidden = k-&gt;is_hidden();</span>
<span class="line-removed"> 84     if (is_hidden) {</span>
<span class="line-removed"> 85       cls-&gt;_hidden_classes_count += csc._num_classes;</span>
<span class="line-removed"> 86     } else {</span>
<span class="line-removed"> 87       cls-&gt;_anon_classes_count += csc._num_classes;</span>
<span class="line-removed"> 88     }</span>
 89   } else {
 90     cls-&gt;_classes_count = csc._num_classes;
 91   }
 92   _total_classes += csc._num_classes;
 93 
 94   ClassLoaderMetaspace* ms = cld-&gt;metaspace_or_null();
 95   if (ms != NULL) {
 96     if(cld-&gt;has_class_mirror_holder()) {
<span class="line-modified"> 97       if (is_hidden) {</span>
<span class="line-modified"> 98         cls-&gt;_hidden_chunk_sz += ms-&gt;allocated_chunks_bytes();</span>
<span class="line-removed"> 99         cls-&gt;_hidden_block_sz += ms-&gt;allocated_blocks_bytes();</span>
<span class="line-removed">100       } else {</span>
<span class="line-removed">101         cls-&gt;_anon_chunk_sz += ms-&gt;allocated_chunks_bytes();</span>
<span class="line-removed">102         cls-&gt;_anon_block_sz += ms-&gt;allocated_blocks_bytes();</span>
<span class="line-removed">103       }</span>
104     } else {
105       cls-&gt;_chunk_sz = ms-&gt;allocated_chunks_bytes();
106       cls-&gt;_block_sz = ms-&gt;allocated_blocks_bytes();
107     }
108     _total_chunk_sz += ms-&gt;allocated_chunks_bytes();
109     _total_block_sz += ms-&gt;allocated_blocks_bytes();
110   }
111 }
112 
113 
114 // Handles the difference in pointer width on 32 and 64 bit platforms
115 #ifdef _LP64
116   #define SPACE &quot;%8s&quot;
117 #else
118   #define SPACE &quot;%s&quot;
119 #endif
120 
121 
122 bool ClassLoaderStatsClosure::do_entry(oop const&amp; key, ClassLoaderStats* const&amp; cls) {
123   Klass* class_loader_klass = (cls-&gt;_class_loader == NULL ? NULL : cls-&gt;_class_loader-&gt;klass());
124   Klass* parent_klass = (cls-&gt;_parent == NULL ? NULL : cls-&gt;_parent-&gt;klass());
125 
126   _out-&gt;print(INTPTR_FORMAT &quot;  &quot; INTPTR_FORMAT &quot;  &quot; INTPTR_FORMAT &quot;  &quot; UINTX_FORMAT_W(6) &quot;  &quot; SIZE_FORMAT_W(8) &quot;  &quot; SIZE_FORMAT_W(8) &quot;  &quot;,
127       p2i(class_loader_klass), p2i(parent_klass), p2i(cls-&gt;_cld),
128       cls-&gt;_classes_count,
129       cls-&gt;_chunk_sz, cls-&gt;_block_sz);
130   if (class_loader_klass != NULL) {
131     _out-&gt;print(&quot;%s&quot;, class_loader_klass-&gt;external_name());
132   } else {
133     _out-&gt;print(&quot;&lt;boot class loader&gt;&quot;);
134   }
135   _out-&gt;cr();
<span class="line-removed">136   if (cls-&gt;_anon_classes_count &gt; 0) {</span>
<span class="line-removed">137     _out-&gt;print_cr(SPACE SPACE SPACE &quot;                                    &quot; UINTX_FORMAT_W(6) &quot;  &quot; SIZE_FORMAT_W(8) &quot;  &quot; SIZE_FORMAT_W(8) &quot;   + unsafe anonymous classes&quot;,</span>
<span class="line-removed">138         &quot;&quot;, &quot;&quot;, &quot;&quot;,</span>
<span class="line-removed">139         cls-&gt;_anon_classes_count,</span>
<span class="line-removed">140         cls-&gt;_anon_chunk_sz, cls-&gt;_anon_block_sz);</span>
<span class="line-removed">141   }</span>
142   if (cls-&gt;_hidden_classes_count &gt; 0) {
143     _out-&gt;print_cr(SPACE SPACE SPACE &quot;                                    &quot; UINTX_FORMAT_W(6) &quot;  &quot; SIZE_FORMAT_W(8) &quot;  &quot; SIZE_FORMAT_W(8) &quot;   + hidden classes&quot;,
144         &quot;&quot;, &quot;&quot;, &quot;&quot;,
145         cls-&gt;_hidden_classes_count,
146         cls-&gt;_hidden_chunk_sz, cls-&gt;_hidden_block_sz);
147   }
148   return true;
149 }
150 
151 
152 void ClassLoaderStatsClosure::print() {
153   _out-&gt;print_cr(&quot;ClassLoader&quot; SPACE &quot; Parent&quot; SPACE &quot;      CLD*&quot; SPACE &quot;       Classes   ChunkSz   BlockSz  Type&quot;, &quot;&quot;, &quot;&quot;, &quot;&quot;);
154   _stats-&gt;iterate(this);
155   _out-&gt;print(&quot;Total = &quot; UINTX_FORMAT_W(-6), _total_loaders);
156   _out-&gt;print(SPACE SPACE SPACE &quot;                      &quot;, &quot;&quot;, &quot;&quot;, &quot;&quot;);
157   _out-&gt;print_cr(UINTX_FORMAT_W(6) &quot;  &quot; SIZE_FORMAT_W(8) &quot;  &quot; SIZE_FORMAT_W(8) &quot;  &quot;,
158       _total_classes,
159       _total_chunk_sz,
160       _total_block_sz);
161   _out-&gt;print_cr(&quot;ChunkSz: Total size of all allocated metaspace chunks&quot;);
</pre>
</td>
<td>
<hr />
<pre>
 57     _stats-&gt;put(cl, cls);
 58     _total_loaders++;
 59   } else {
 60     cls = *cls_ptr;
 61   }
 62 
 63   if (!cld-&gt;has_class_mirror_holder()) {
 64     cls-&gt;_cld = cld;
 65   }
 66 
 67   cls-&gt;_class_loader = cl;
 68   if (cl != NULL) {
 69     cls-&gt;_parent = java_lang_ClassLoader::parent(cl);
 70     addEmptyParents(cls-&gt;_parent);
 71   }
 72 
 73   ClassStatsClosure csc;
 74   cld-&gt;classes_do(&amp;csc);
 75   bool is_hidden = false;
 76   if(cld-&gt;has_class_mirror_holder()) {
<span class="line-modified"> 77     // If cld has a class holder then it must be either hidden or unsafe anonymous.</span>
<span class="line-modified"> 78     // Either way, count it as a hidden class.</span>
<span class="line-modified"> 79     cls-&gt;_hidden_classes_count += csc._num_classes;</span>









 80   } else {
 81     cls-&gt;_classes_count = csc._num_classes;
 82   }
 83   _total_classes += csc._num_classes;
 84 
 85   ClassLoaderMetaspace* ms = cld-&gt;metaspace_or_null();
 86   if (ms != NULL) {
 87     if(cld-&gt;has_class_mirror_holder()) {
<span class="line-modified"> 88       cls-&gt;_hidden_chunk_sz += ms-&gt;allocated_chunks_bytes();</span>
<span class="line-modified"> 89       cls-&gt;_hidden_block_sz += ms-&gt;allocated_blocks_bytes();</span>





 90     } else {
 91       cls-&gt;_chunk_sz = ms-&gt;allocated_chunks_bytes();
 92       cls-&gt;_block_sz = ms-&gt;allocated_blocks_bytes();
 93     }
 94     _total_chunk_sz += ms-&gt;allocated_chunks_bytes();
 95     _total_block_sz += ms-&gt;allocated_blocks_bytes();
 96   }
 97 }
 98 
 99 
100 // Handles the difference in pointer width on 32 and 64 bit platforms
101 #ifdef _LP64
102   #define SPACE &quot;%8s&quot;
103 #else
104   #define SPACE &quot;%s&quot;
105 #endif
106 
107 
108 bool ClassLoaderStatsClosure::do_entry(oop const&amp; key, ClassLoaderStats* const&amp; cls) {
109   Klass* class_loader_klass = (cls-&gt;_class_loader == NULL ? NULL : cls-&gt;_class_loader-&gt;klass());
110   Klass* parent_klass = (cls-&gt;_parent == NULL ? NULL : cls-&gt;_parent-&gt;klass());
111 
112   _out-&gt;print(INTPTR_FORMAT &quot;  &quot; INTPTR_FORMAT &quot;  &quot; INTPTR_FORMAT &quot;  &quot; UINTX_FORMAT_W(6) &quot;  &quot; SIZE_FORMAT_W(8) &quot;  &quot; SIZE_FORMAT_W(8) &quot;  &quot;,
113       p2i(class_loader_klass), p2i(parent_klass), p2i(cls-&gt;_cld),
114       cls-&gt;_classes_count,
115       cls-&gt;_chunk_sz, cls-&gt;_block_sz);
116   if (class_loader_klass != NULL) {
117     _out-&gt;print(&quot;%s&quot;, class_loader_klass-&gt;external_name());
118   } else {
119     _out-&gt;print(&quot;&lt;boot class loader&gt;&quot;);
120   }
121   _out-&gt;cr();






122   if (cls-&gt;_hidden_classes_count &gt; 0) {
123     _out-&gt;print_cr(SPACE SPACE SPACE &quot;                                    &quot; UINTX_FORMAT_W(6) &quot;  &quot; SIZE_FORMAT_W(8) &quot;  &quot; SIZE_FORMAT_W(8) &quot;   + hidden classes&quot;,
124         &quot;&quot;, &quot;&quot;, &quot;&quot;,
125         cls-&gt;_hidden_classes_count,
126         cls-&gt;_hidden_chunk_sz, cls-&gt;_hidden_block_sz);
127   }
128   return true;
129 }
130 
131 
132 void ClassLoaderStatsClosure::print() {
133   _out-&gt;print_cr(&quot;ClassLoader&quot; SPACE &quot; Parent&quot; SPACE &quot;      CLD*&quot; SPACE &quot;       Classes   ChunkSz   BlockSz  Type&quot;, &quot;&quot;, &quot;&quot;, &quot;&quot;);
134   _stats-&gt;iterate(this);
135   _out-&gt;print(&quot;Total = &quot; UINTX_FORMAT_W(-6), _total_loaders);
136   _out-&gt;print(SPACE SPACE SPACE &quot;                      &quot;, &quot;&quot;, &quot;&quot;, &quot;&quot;);
137   _out-&gt;print_cr(UINTX_FORMAT_W(6) &quot;  &quot; SIZE_FORMAT_W(8) &quot;  &quot; SIZE_FORMAT_W(8) &quot;  &quot;,
138       _total_classes,
139       _total_chunk_sz,
140       _total_block_sz);
141   _out-&gt;print_cr(&quot;ChunkSz: Total size of all allocated metaspace chunks&quot;);
</pre>
</td>
</tr>
</table>
<center><a href="classLoaderHierarchyDCmd.cpp.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="classLoaderStats.hpp.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>