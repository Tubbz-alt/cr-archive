<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/hotspot/share/classfile/systemDictionaryShared.cpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
  </head>
<body>
<center><a href="classLoaderStats.hpp.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="systemDictionaryShared.hpp.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/hotspot/share/classfile/systemDictionaryShared.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 463                                                    TRAPS) {
 464   assert(SystemDictionary::is_system_class_loader(class_loader()), &quot;unexpected class loader&quot;);
 465   // get_package_name() returns a NULL handle if the class is in unnamed package
 466   Handle pkgname_string = get_package_name(class_name, CHECK);
 467   if (pkgname_string.not_null()) {
 468     Klass* app_classLoader_klass = SystemDictionary::jdk_internal_loader_ClassLoaders_AppClassLoader_klass();
 469     JavaValue result(T_OBJECT);
 470     JavaCallArguments args(3);
 471     args.set_receiver(class_loader);
 472     args.push_oop(pkgname_string);
 473     args.push_oop(manifest);
 474     args.push_oop(url);
 475     JavaCalls::call_virtual(&amp;result, app_classLoader_klass,
 476                             vmSymbols::defineOrCheckPackage_name(),
 477                             vmSymbols::defineOrCheckPackage_signature(),
 478                             &amp;args,
 479                             CHECK);
 480   }
 481 }
 482 
<span class="line-removed"> 483 // Define Package for shared app/platform classes from named module</span>
<span class="line-removed"> 484 void SystemDictionaryShared::define_shared_package(Symbol* class_name,</span>
<span class="line-removed"> 485                                                    Handle class_loader,</span>
<span class="line-removed"> 486                                                    ModuleEntry* mod_entry,</span>
<span class="line-removed"> 487                                                    TRAPS) {</span>
<span class="line-removed"> 488   assert(mod_entry != NULL, &quot;module_entry should not be NULL&quot;);</span>
<span class="line-removed"> 489   Handle module_handle(THREAD, mod_entry-&gt;module());</span>
<span class="line-removed"> 490 </span>
<span class="line-removed"> 491   Handle pkg_name = get_package_name(class_name, CHECK);</span>
<span class="line-removed"> 492   assert(pkg_name.not_null(), &quot;Package should not be null for class in named module&quot;);</span>
<span class="line-removed"> 493 </span>
<span class="line-removed"> 494   Klass* classLoader_klass;</span>
<span class="line-removed"> 495   if (SystemDictionary::is_system_class_loader(class_loader())) {</span>
<span class="line-removed"> 496     classLoader_klass = SystemDictionary::jdk_internal_loader_ClassLoaders_AppClassLoader_klass();</span>
<span class="line-removed"> 497   } else {</span>
<span class="line-removed"> 498     assert(SystemDictionary::is_platform_class_loader(class_loader()), &quot;unexpected classloader&quot;);</span>
<span class="line-removed"> 499     classLoader_klass = SystemDictionary::jdk_internal_loader_ClassLoaders_PlatformClassLoader_klass();</span>
<span class="line-removed"> 500   }</span>
<span class="line-removed"> 501 </span>
<span class="line-removed"> 502   JavaValue result(T_OBJECT);</span>
<span class="line-removed"> 503   JavaCallArguments args(2);</span>
<span class="line-removed"> 504   args.set_receiver(class_loader);</span>
<span class="line-removed"> 505   args.push_oop(pkg_name);</span>
<span class="line-removed"> 506   args.push_oop(module_handle);</span>
<span class="line-removed"> 507   JavaCalls::call_virtual(&amp;result, classLoader_klass,</span>
<span class="line-removed"> 508                           vmSymbols::definePackage_name(),</span>
<span class="line-removed"> 509                           vmSymbols::definePackage_signature(),</span>
<span class="line-removed"> 510                           &amp;args,</span>
<span class="line-removed"> 511                           CHECK);</span>
<span class="line-removed"> 512 }</span>
<span class="line-removed"> 513 </span>
 514 // Get the ProtectionDomain associated with the CodeSource from the classloader.
 515 Handle SystemDictionaryShared::get_protection_domain_from_classloader(Handle class_loader,
 516                                                                       Handle url, TRAPS) {
 517   // CodeSource cs = new CodeSource(url, null);
 518   Handle cs = JavaCalls::construct_new_instance(SystemDictionary::CodeSource_klass(),
 519                   vmSymbols::url_code_signer_array_void_signature(),
 520                   url, Handle(), CHECK_NH);
 521 
 522   // protection_domain = SecureClassLoader.getProtectionDomain(cs);
 523   Klass* secureClassLoader_klass = SystemDictionary::SecureClassLoader_klass();
 524   JavaValue obj_result(T_OBJECT);
 525   JavaCalls::call_virtual(&amp;obj_result, class_loader, secureClassLoader_klass,
 526                           vmSymbols::getProtectionDomain_name(),
 527                           vmSymbols::getProtectionDomain_signature(),
 528                           cs, CHECK_NH);
 529   return Handle(THREAD, (oop)obj_result.get_jobject());
 530 }
 531 
 532 // Returns the ProtectionDomain associated with the JAR file identified by the url.
 533 Handle SystemDictionaryShared::get_shared_protection_domain(Handle class_loader,
</pre>
<hr />
<pre>
 582   assert(protection_domain.not_null(), &quot;sanity&quot;);
 583   return protection_domain;
 584 }
 585 
 586 // Initializes the java.lang.Package and java.security.ProtectionDomain objects associated with
 587 // the given InstanceKlass.
 588 // Returns the ProtectionDomain for the InstanceKlass.
 589 Handle SystemDictionaryShared::init_security_info(Handle class_loader, InstanceKlass* ik, PackageEntry* pkg_entry, TRAPS) {
 590   Handle pd;
 591 
 592   if (ik != NULL) {
 593     int index = ik-&gt;shared_classpath_index();
 594     assert(index &gt;= 0, &quot;Sanity&quot;);
 595     SharedClassPathEntry* ent = FileMapInfo::shared_path(index);
 596     Symbol* class_name = ik-&gt;name();
 597 
 598     if (ent-&gt;is_modules_image()) {
 599       // For shared app/platform classes originated from the run-time image:
 600       //   The ProtectionDomains are cached in the corresponding ModuleEntries
 601       //   for fast access by the VM.
<span class="line-modified"> 602       if (pkg_entry != NULL) {</span>
<span class="line-modified"> 603         ModuleEntry* mod_entry = pkg_entry-&gt;module();</span>
<span class="line-modified"> 604         pd = get_shared_protection_domain(class_loader, mod_entry, THREAD);</span>
<span class="line-modified"> 605         define_shared_package(class_name, class_loader, mod_entry, CHECK_(pd));</span>
<span class="line-modified"> 606       }</span>
 607     } else {
 608       // For shared app/platform classes originated from JAR files on the class path:
 609       //   Each of the 3 SystemDictionaryShared::_shared_xxx arrays has the same length
 610       //   as the shared classpath table in the shared archive (see
 611       //   FileMap::_shared_path_table in filemap.hpp for details).
 612       //
 613       //   If a shared InstanceKlass k is loaded from the class path, let
 614       //
 615       //     index = k-&gt;shared_classpath_index():
 616       //
 617       //   FileMap::_shared_path_table[index] identifies the JAR file that contains k.
 618       //
 619       //   k&#39;s protection domain is:
 620       //
 621       //     ProtectionDomain pd = _shared_protection_domains[index];
 622       //
 623       //   and k&#39;s Package is initialized using
 624       //
 625       //     manifest = _shared_jar_manifests[index];
 626       //     url = _shared_jar_urls[index];
</pre>
</td>
<td>
<hr />
<pre>
 463                                                    TRAPS) {
 464   assert(SystemDictionary::is_system_class_loader(class_loader()), &quot;unexpected class loader&quot;);
 465   // get_package_name() returns a NULL handle if the class is in unnamed package
 466   Handle pkgname_string = get_package_name(class_name, CHECK);
 467   if (pkgname_string.not_null()) {
 468     Klass* app_classLoader_klass = SystemDictionary::jdk_internal_loader_ClassLoaders_AppClassLoader_klass();
 469     JavaValue result(T_OBJECT);
 470     JavaCallArguments args(3);
 471     args.set_receiver(class_loader);
 472     args.push_oop(pkgname_string);
 473     args.push_oop(manifest);
 474     args.push_oop(url);
 475     JavaCalls::call_virtual(&amp;result, app_classLoader_klass,
 476                             vmSymbols::defineOrCheckPackage_name(),
 477                             vmSymbols::defineOrCheckPackage_signature(),
 478                             &amp;args,
 479                             CHECK);
 480   }
 481 }
 482 































 483 // Get the ProtectionDomain associated with the CodeSource from the classloader.
 484 Handle SystemDictionaryShared::get_protection_domain_from_classloader(Handle class_loader,
 485                                                                       Handle url, TRAPS) {
 486   // CodeSource cs = new CodeSource(url, null);
 487   Handle cs = JavaCalls::construct_new_instance(SystemDictionary::CodeSource_klass(),
 488                   vmSymbols::url_code_signer_array_void_signature(),
 489                   url, Handle(), CHECK_NH);
 490 
 491   // protection_domain = SecureClassLoader.getProtectionDomain(cs);
 492   Klass* secureClassLoader_klass = SystemDictionary::SecureClassLoader_klass();
 493   JavaValue obj_result(T_OBJECT);
 494   JavaCalls::call_virtual(&amp;obj_result, class_loader, secureClassLoader_klass,
 495                           vmSymbols::getProtectionDomain_name(),
 496                           vmSymbols::getProtectionDomain_signature(),
 497                           cs, CHECK_NH);
 498   return Handle(THREAD, (oop)obj_result.get_jobject());
 499 }
 500 
 501 // Returns the ProtectionDomain associated with the JAR file identified by the url.
 502 Handle SystemDictionaryShared::get_shared_protection_domain(Handle class_loader,
</pre>
<hr />
<pre>
 551   assert(protection_domain.not_null(), &quot;sanity&quot;);
 552   return protection_domain;
 553 }
 554 
 555 // Initializes the java.lang.Package and java.security.ProtectionDomain objects associated with
 556 // the given InstanceKlass.
 557 // Returns the ProtectionDomain for the InstanceKlass.
 558 Handle SystemDictionaryShared::init_security_info(Handle class_loader, InstanceKlass* ik, PackageEntry* pkg_entry, TRAPS) {
 559   Handle pd;
 560 
 561   if (ik != NULL) {
 562     int index = ik-&gt;shared_classpath_index();
 563     assert(index &gt;= 0, &quot;Sanity&quot;);
 564     SharedClassPathEntry* ent = FileMapInfo::shared_path(index);
 565     Symbol* class_name = ik-&gt;name();
 566 
 567     if (ent-&gt;is_modules_image()) {
 568       // For shared app/platform classes originated from the run-time image:
 569       //   The ProtectionDomains are cached in the corresponding ModuleEntries
 570       //   for fast access by the VM.
<span class="line-modified"> 571       // all packages from module image are already created during VM bootstrap in</span>
<span class="line-modified"> 572       // Modules::define_module().</span>
<span class="line-modified"> 573       assert(pkg_entry != NULL, &quot;archived class in module image cannot be from unnamed package&quot;);</span>
<span class="line-modified"> 574       ModuleEntry* mod_entry = pkg_entry-&gt;module();</span>
<span class="line-modified"> 575       pd = get_shared_protection_domain(class_loader, mod_entry, THREAD);</span>
 576     } else {
 577       // For shared app/platform classes originated from JAR files on the class path:
 578       //   Each of the 3 SystemDictionaryShared::_shared_xxx arrays has the same length
 579       //   as the shared classpath table in the shared archive (see
 580       //   FileMap::_shared_path_table in filemap.hpp for details).
 581       //
 582       //   If a shared InstanceKlass k is loaded from the class path, let
 583       //
 584       //     index = k-&gt;shared_classpath_index():
 585       //
 586       //   FileMap::_shared_path_table[index] identifies the JAR file that contains k.
 587       //
 588       //   k&#39;s protection domain is:
 589       //
 590       //     ProtectionDomain pd = _shared_protection_domains[index];
 591       //
 592       //   and k&#39;s Package is initialized using
 593       //
 594       //     manifest = _shared_jar_manifests[index];
 595       //     url = _shared_jar_urls[index];
</pre>
</td>
</tr>
</table>
<center><a href="classLoaderStats.hpp.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="systemDictionaryShared.hpp.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>