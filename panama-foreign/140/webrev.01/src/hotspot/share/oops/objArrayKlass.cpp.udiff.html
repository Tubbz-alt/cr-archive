<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff src/hotspot/share/oops/objArrayKlass.cpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
  </head>
<body>
<center><a href="klass.hpp.udiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="objArrayKlass.hpp.udiff.html" target="_top">next &gt;</a></center>    <h2>src/hotspot/share/oops/objArrayKlass.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -52,12 +52,12 @@</span>
    int size = ArrayKlass::static_size(ObjArrayKlass::header_size());
  
    return new (loader_data, size, THREAD) ObjArrayKlass(n, k, name);
  }
  
<span class="udiff-line-modified-removed">- Klass* ObjArrayKlass::allocate_objArray_klass(ClassLoaderData* loader_data,</span>
<span class="udiff-line-modified-removed">-                                                 int n, Klass* element_klass, TRAPS) {</span>
<span class="udiff-line-modified-added">+ ObjArrayKlass* ObjArrayKlass::allocate_objArray_klass(ClassLoaderData* loader_data,</span>
<span class="udiff-line-modified-added">+                                                       int n, Klass* element_klass, TRAPS) {</span>
  
    // Eagerly allocate the direct array supertype.
    Klass* super_klass = NULL;
    if (!Universe::is_bootstrapping() || SystemDictionary::Object_klass_loaded()) {
      Klass* element_super = element_klass-&gt;super();
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -86,23 +86,21 @@</span>
              elem_super-&gt;array_klass(CHECK_NULL);
            }
            // Now retry from the beginning
            ek = element_klass-&gt;array_klass(n, CHECK_NULL);
          }  // re-lock
<span class="udiff-line-modified-removed">-         return ek;</span>
<span class="udiff-line-modified-added">+         return ObjArrayKlass::cast(ek);</span>
        }
      } else {
        // The element type is already Object.  Object[] has direct super of Object.
        super_klass = SystemDictionary::Object_klass();
      }
    }
  
    // Create type name for klass.
    Symbol* name = NULL;
<span class="udiff-line-modified-removed">-   if (!element_klass-&gt;is_instance_klass() ||</span>
<span class="udiff-line-removed">-       (name = InstanceKlass::cast(element_klass)-&gt;array_name()) == NULL) {</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-modified-added">+   {</span>
      ResourceMark rm(THREAD);
      char *name_str = element_klass-&gt;name()-&gt;as_C_string();
      int len = element_klass-&gt;name()-&gt;utf8_length();
      char *new_str = NEW_RESOURCE_ARRAY(char, len + 4);
      int idx = 0;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -114,15 +112,11 @@</span>
      idx += len;
      if (element_klass-&gt;is_instance_klass()) {
        new_str[idx++] = JVM_SIGNATURE_ENDCLASS;
      }
      new_str[idx++] = &#39;\0&#39;;
<span class="udiff-line-modified-removed">-     name = SymbolTable::new_permanent_symbol(new_str);</span>
<span class="udiff-line-removed">-     if (element_klass-&gt;is_instance_klass()) {</span>
<span class="udiff-line-removed">-       InstanceKlass* ik = InstanceKlass::cast(element_klass);</span>
<span class="udiff-line-removed">-       ik-&gt;set_array_name(name);</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-modified-added">+     name = SymbolTable::new_symbol(new_str);</span>
    }
  
    // Initialize instance variables
    ObjArrayKlass* oak = ObjArrayKlass::allocate(loader_data, n, element_klass, name, CHECK_NULL);
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -141,30 +135,26 @@</span>
  
    return oak;
  }
  
  ObjArrayKlass::ObjArrayKlass(int n, Klass* element_klass, Symbol* name) : ArrayKlass(name, ID) {
<span class="udiff-line-modified-removed">-   this-&gt;set_dimension(n);</span>
<span class="udiff-line-modified-removed">-   this-&gt;set_element_klass(element_klass);</span>
<span class="udiff-line-removed">-   // decrement refcount because object arrays are not explicitly freed.  The</span>
<span class="udiff-line-removed">-   // InstanceKlass array_name() keeps the name counted while the klass is</span>
<span class="udiff-line-removed">-   // loaded.</span>
<span class="udiff-line-removed">-   name-&gt;decrement_refcount();</span>
<span class="udiff-line-modified-added">+   set_dimension(n);</span>
<span class="udiff-line-modified-added">+   set_element_klass(element_klass);</span>
  
    Klass* bk;
    if (element_klass-&gt;is_objArray_klass()) {
      bk = ObjArrayKlass::cast(element_klass)-&gt;bottom_klass();
    } else {
      bk = element_klass;
    }
    assert(bk != NULL &amp;&amp; (bk-&gt;is_instance_klass() || bk-&gt;is_typeArray_klass()), &quot;invalid bottom klass&quot;);
<span class="udiff-line-modified-removed">-   this-&gt;set_bottom_klass(bk);</span>
<span class="udiff-line-modified-removed">-   this-&gt;set_class_loader_data(bk-&gt;class_loader_data());</span>
<span class="udiff-line-modified-added">+   set_bottom_klass(bk);</span>
<span class="udiff-line-modified-added">+   set_class_loader_data(bk-&gt;class_loader_data());</span>
  
<span class="udiff-line-modified-removed">-   this-&gt;set_layout_helper(array_layout_helper(T_OBJECT));</span>
<span class="udiff-line-modified-removed">-   assert(this-&gt;is_array_klass(), &quot;sanity&quot;);</span>
<span class="udiff-line-modified-removed">-   assert(this-&gt;is_objArray_klass(), &quot;sanity&quot;);</span>
<span class="udiff-line-modified-added">+   set_layout_helper(array_layout_helper(T_OBJECT));</span>
<span class="udiff-line-modified-added">+   assert(is_array_klass(), &quot;sanity&quot;);</span>
<span class="udiff-line-modified-added">+   assert(is_objArray_klass(), &quot;sanity&quot;);</span>
  }
  
  int ObjArrayKlass::oop_size(oop obj) const {
    assert(obj-&gt;is_objArray(), &quot;must be object array&quot;);
    return objArrayOop(obj)-&gt;object_size();
</pre>
<center><a href="klass.hpp.udiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="objArrayKlass.hpp.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>