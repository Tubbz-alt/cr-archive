<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames src/hotspot/os/solaris/os_solaris.cpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
    <script type="text/javascript" src="../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>   1 /*
   2  * Copyright (c) 1997, 2020, Oracle and/or its affiliates. All rights reserved.
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.
   8  *
   9  * This code is distributed in the hope that it will be useful, but WITHOUT
  10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  *
  23  */
  24 
  25 // no precompiled headers
  26 #include &quot;jvm.h&quot;
  27 #include &quot;classfile/classLoader.hpp&quot;
  28 #include &quot;classfile/systemDictionary.hpp&quot;
  29 #include &quot;classfile/vmSymbols.hpp&quot;
  30 #include &quot;code/icBuffer.hpp&quot;
  31 #include &quot;code/vtableStubs.hpp&quot;
  32 #include &quot;compiler/compileBroker.hpp&quot;
  33 #include &quot;compiler/disassembler.hpp&quot;
  34 #include &quot;interpreter/interpreter.hpp&quot;
  35 #include &quot;logging/log.hpp&quot;
  36 #include &quot;logging/logStream.hpp&quot;
  37 #include &quot;memory/allocation.inline.hpp&quot;
  38 #include &quot;memory/filemap.hpp&quot;
  39 #include &quot;memory/universe.hpp&quot;
  40 #include &quot;oops/oop.inline.hpp&quot;
  41 #include &quot;os_share_solaris.hpp&quot;
  42 #include &quot;os_solaris.inline.hpp&quot;
  43 #include &quot;prims/jniFastGetField.hpp&quot;
  44 #include &quot;prims/jvm_misc.hpp&quot;
  45 #include &quot;runtime/arguments.hpp&quot;
  46 #include &quot;runtime/atomic.hpp&quot;
  47 #include &quot;runtime/extendedPC.hpp&quot;
  48 #include &quot;runtime/globals.hpp&quot;
  49 #include &quot;runtime/interfaceSupport.inline.hpp&quot;
  50 #include &quot;runtime/java.hpp&quot;
  51 #include &quot;runtime/javaCalls.hpp&quot;
  52 #include &quot;runtime/mutexLocker.hpp&quot;
  53 #include &quot;runtime/objectMonitor.hpp&quot;
  54 #include &quot;runtime/orderAccess.hpp&quot;
  55 #include &quot;runtime/osThread.hpp&quot;
  56 #include &quot;runtime/perfMemory.hpp&quot;
  57 #include &quot;runtime/sharedRuntime.hpp&quot;
  58 #include &quot;runtime/statSampler.hpp&quot;
  59 #include &quot;runtime/stubRoutines.hpp&quot;
  60 #include &quot;runtime/thread.inline.hpp&quot;
  61 #include &quot;runtime/threadCritical.hpp&quot;
  62 #include &quot;runtime/timer.hpp&quot;
  63 #include &quot;runtime/vm_version.hpp&quot;
  64 #include &quot;semaphore_posix.hpp&quot;
  65 #include &quot;services/attachListener.hpp&quot;
  66 #include &quot;services/memTracker.hpp&quot;
  67 #include &quot;services/runtimeService.hpp&quot;
  68 #include &quot;utilities/align.hpp&quot;
  69 #include &quot;utilities/decoder.hpp&quot;
  70 #include &quot;utilities/defaultStream.hpp&quot;
  71 #include &quot;utilities/events.hpp&quot;
  72 #include &quot;utilities/growableArray.hpp&quot;
  73 #include &quot;utilities/macros.hpp&quot;
  74 #include &quot;utilities/vmError.hpp&quot;
  75 
  76 // put OS-includes here
  77 # include &lt;dlfcn.h&gt;
  78 # include &lt;errno.h&gt;
  79 # include &lt;exception&gt;
  80 # include &lt;link.h&gt;
  81 # include &lt;poll.h&gt;
  82 # include &lt;pthread.h&gt;
  83 # include &lt;setjmp.h&gt;
  84 # include &lt;signal.h&gt;
  85 # include &lt;stdio.h&gt;
  86 # include &lt;alloca.h&gt;
  87 # include &lt;sys/filio.h&gt;
  88 # include &lt;sys/ipc.h&gt;
  89 # include &lt;sys/lwp.h&gt;
  90 # include &lt;sys/machelf.h&gt;     // for elf Sym structure used by dladdr1
  91 # include &lt;sys/mman.h&gt;
  92 # include &lt;sys/processor.h&gt;
  93 # include &lt;sys/procset.h&gt;
  94 # include &lt;sys/pset.h&gt;
  95 # include &lt;sys/resource.h&gt;
  96 # include &lt;sys/shm.h&gt;
  97 # include &lt;sys/socket.h&gt;
  98 # include &lt;sys/stat.h&gt;
  99 # include &lt;sys/systeminfo.h&gt;
 100 # include &lt;sys/time.h&gt;
 101 # include &lt;sys/times.h&gt;
 102 # include &lt;sys/types.h&gt;
 103 # include &lt;sys/wait.h&gt;
 104 # include &lt;sys/utsname.h&gt;
 105 # include &lt;thread.h&gt;
 106 # include &lt;unistd.h&gt;
 107 # include &lt;sys/priocntl.h&gt;
 108 # include &lt;sys/rtpriocntl.h&gt;
 109 # include &lt;sys/tspriocntl.h&gt;
 110 # include &lt;sys/iapriocntl.h&gt;
 111 # include &lt;sys/fxpriocntl.h&gt;
 112 # include &lt;sys/loadavg.h&gt;
 113 # include &lt;string.h&gt;
 114 # include &lt;stdio.h&gt;
 115 
 116 # define _STRUCTURED_PROC 1  //  this gets us the new structured proc interfaces of 5.6 &amp; later
 117 # include &lt;sys/procfs.h&gt;     //  see comment in &lt;sys/procfs.h&gt;
 118 
 119 #define MAX_PATH (2 * K)
 120 
 121 // for timer info max values which include all bits
 122 #define ALL_64_BITS CONST64(0xFFFFFFFFFFFFFFFF)
 123 
 124 
 125 // Here are some liblgrp types from sys/lgrp_user.h to be able to
 126 // compile on older systems without this header file.
 127 
 128 #ifndef MADV_ACCESS_LWP
 129   #define  MADV_ACCESS_LWP   7       /* next LWP to access heavily */
 130 #endif
 131 #ifndef MADV_ACCESS_MANY
 132   #define  MADV_ACCESS_MANY  8       /* many processes to access heavily */
 133 #endif
 134 
 135 #ifndef LGRP_RSRC_CPU
 136   #define LGRP_RSRC_CPU      0       /* CPU resources */
 137 #endif
 138 #ifndef LGRP_RSRC_MEM
 139   #define LGRP_RSRC_MEM      1       /* memory resources */
 140 #endif
 141 
 142 // Values for ThreadPriorityPolicy == 1
 143 int prio_policy1[CriticalPriority+1] = {
 144   -99999,  0, 16,  32,  48,  64,
 145           80, 96, 112, 124, 127, 127 };
 146 
 147 // System parameters used internally
 148 static clock_t clock_tics_per_sec = 100;
 149 
 150 // Track if we have called enable_extended_FILE_stdio (on Solaris 10u4+)
 151 static bool enabled_extended_FILE_stdio = false;
 152 
 153 // For diagnostics to print a message once. see run_periodic_checks
 154 static bool check_addr0_done = false;
 155 static sigset_t check_signal_done;
 156 static bool check_signals = true;
 157 
 158 address os::Solaris::handler_start;  // start pc of thr_sighndlrinfo
 159 address os::Solaris::handler_end;    // end pc of thr_sighndlrinfo
 160 
 161 address os::Solaris::_main_stack_base = NULL;  // 4352906 workaround
 162 
 163 os::Solaris::pthread_setname_np_func_t os::Solaris::_pthread_setname_np = NULL;
 164 
 165 // &quot;default&quot; initializers for missing libc APIs
 166 extern &quot;C&quot; {
 167   static int lwp_mutex_init(mutex_t *mx, int scope, void *arg) { memset(mx, 0, sizeof(mutex_t)); return 0; }
 168   static int lwp_mutex_destroy(mutex_t *mx)                 { return 0; }
 169 
 170   static int lwp_cond_init(cond_t *cv, int scope, void *arg){ memset(cv, 0, sizeof(cond_t)); return 0; }
 171   static int lwp_cond_destroy(cond_t *cv)                   { return 0; }
 172 }
 173 
 174 // &quot;default&quot; initializers for pthread-based synchronization
 175 extern &quot;C&quot; {
 176   static int pthread_mutex_default_init(mutex_t *mx, int scope, void *arg) { memset(mx, 0, sizeof(mutex_t)); return 0; }
 177   static int pthread_cond_default_init(cond_t *cv, int scope, void *arg){ memset(cv, 0, sizeof(cond_t)); return 0; }
 178 }
 179 
 180 static void unpackTime(timespec* absTime, bool isAbsolute, jlong time);
 181 
 182 static inline size_t adjust_stack_size(address base, size_t size) {
 183   if ((ssize_t)size &lt; 0) {
 184     // 4759953: Compensate for ridiculous stack size.
 185     size = max_intx;
 186   }
 187   if (size &gt; (size_t)base) {
 188     // 4812466: Make sure size doesn&#39;t allow the stack to wrap the address space.
 189     size = (size_t)base;
 190   }
 191   return size;
 192 }
 193 
 194 static inline stack_t get_stack_info() {
 195   stack_t st;
 196   int retval = thr_stksegment(&amp;st);
 197   st.ss_size = adjust_stack_size((address)st.ss_sp, st.ss_size);
 198   assert(retval == 0, &quot;incorrect return value from thr_stksegment&quot;);
 199   assert((address)&amp;st &lt; (address)st.ss_sp, &quot;Invalid stack base returned&quot;);
 200   assert((address)&amp;st &gt; (address)st.ss_sp-st.ss_size, &quot;Invalid stack size returned&quot;);
 201   return st;
 202 }
 203 
 204 static void _handle_uncaught_cxx_exception() {
 205   VMError::report_and_die(&quot;An uncaught C++ exception&quot;);
 206 }
 207 
 208 bool os::is_primordial_thread(void) {
 209   int r = thr_main();
 210   guarantee(r == 0 || r == 1, &quot;CR6501650 or CR6493689&quot;);
 211   return r == 1;
 212 }
 213 
 214 address os::current_stack_base() {
 215   bool _is_primordial_thread = is_primordial_thread();
 216 
 217   // Workaround 4352906, avoid calls to thr_stksegment by
 218   // thr_main after the first one (it looks like we trash
 219   // some data, causing the value for ss_sp to be incorrect).
 220   if (!_is_primordial_thread || os::Solaris::_main_stack_base == NULL) {
 221     stack_t st = get_stack_info();
 222     if (_is_primordial_thread) {
 223       // cache initial value of stack base
 224       os::Solaris::_main_stack_base = (address)st.ss_sp;
 225     }
 226     return (address)st.ss_sp;
 227   } else {
 228     guarantee(os::Solaris::_main_stack_base != NULL, &quot;Attempt to use null cached stack base&quot;);
 229     return os::Solaris::_main_stack_base;
 230   }
 231 }
 232 
 233 size_t os::current_stack_size() {
 234   size_t size;
 235 
 236   if (!is_primordial_thread()) {
 237     size = get_stack_info().ss_size;
 238   } else {
 239     struct rlimit limits;
 240     getrlimit(RLIMIT_STACK, &amp;limits);
 241     size = adjust_stack_size(os::Solaris::_main_stack_base, (size_t)limits.rlim_cur);
 242   }
 243   // base may not be page aligned
 244   address base = current_stack_base();
 245   address bottom = align_up(base - size, os::vm_page_size());;
 246   return (size_t)(base - bottom);
 247 }
 248 
 249 struct tm* os::localtime_pd(const time_t* clock, struct tm*  res) {
 250   return localtime_r(clock, res);
 251 }
 252 
 253 void os::Solaris::try_enable_extended_io() {
 254   typedef int (*enable_extended_FILE_stdio_t)(int, int);
 255 
 256   if (!UseExtendedFileIO) {
 257     return;
 258   }
 259 
 260   enable_extended_FILE_stdio_t enabler =
 261     (enable_extended_FILE_stdio_t) dlsym(RTLD_DEFAULT,
 262                                          &quot;enable_extended_FILE_stdio&quot;);
 263   if (enabler) {
 264     enabler(-1, -1);
 265   }
 266 }
 267 
 268 jint os::Solaris::_os_thread_limit = 0;
 269 volatile jint os::Solaris::_os_thread_count = 0;
 270 
 271 julong os::available_memory() {
 272   return Solaris::available_memory();
 273 }
 274 
 275 julong os::Solaris::available_memory() {
 276   return (julong)sysconf(_SC_AVPHYS_PAGES) * os::vm_page_size();
 277 }
 278 
 279 julong os::Solaris::_physical_memory = 0;
 280 
 281 julong os::physical_memory() {
 282   return Solaris::physical_memory();
 283 }
 284 
 285 static hrtime_t first_hrtime = 0;
 286 static const hrtime_t hrtime_hz = 1000*1000*1000;
 287 static volatile hrtime_t max_hrtime = 0;
 288 
 289 
 290 void os::Solaris::initialize_system_info() {
 291   set_processor_count(sysconf(_SC_NPROCESSORS_CONF));
 292   _physical_memory = (julong)sysconf(_SC_PHYS_PAGES) *
 293                                      (julong)sysconf(_SC_PAGESIZE);
 294 }
 295 
 296 uint os::processor_id() {
 297   const processorid_t id = ::getcpuid();
 298   assert(id &gt;= 0 &amp;&amp; id &lt; _processor_count, &quot;Invalid processor id&quot;);
 299   return (uint)id;
 300 }
 301 
 302 int os::active_processor_count() {
 303   // User has overridden the number of active processors
 304   if (ActiveProcessorCount &gt; 0) {
 305     log_trace(os)(&quot;active_processor_count: &quot;
 306                   &quot;active processor count set by user : %d&quot;,
 307                   ActiveProcessorCount);
 308     return ActiveProcessorCount;
 309   }
 310 
 311   int online_cpus = sysconf(_SC_NPROCESSORS_ONLN);
 312   pid_t pid = getpid();
 313   psetid_t pset = PS_NONE;
 314   // Are we running in a processor set or is there any processor set around?
 315   if (pset_bind(PS_QUERY, P_PID, pid, &amp;pset) == 0) {
 316     uint_t pset_cpus;
 317     // Query the number of cpus available to us.
 318     if (pset_info(pset, NULL, &amp;pset_cpus, NULL) == 0) {
 319       assert(pset_cpus &gt; 0 &amp;&amp; pset_cpus &lt;= online_cpus, &quot;sanity check&quot;);
 320       return pset_cpus;
 321     }
 322   }
 323   // Otherwise return number of online cpus
 324   return online_cpus;
 325 }
 326 
 327 void os::set_native_thread_name(const char *name) {
 328   if (Solaris::_pthread_setname_np != NULL) {
 329     // Only the first 31 bytes of &#39;name&#39; are processed by pthread_setname_np
 330     // but we explicitly copy into a size-limited buffer to avoid any
 331     // possible overflow.
 332     char buf[32];
 333     snprintf(buf, sizeof(buf), &quot;%s&quot;, name);
 334     buf[sizeof(buf) - 1] = &#39;\0&#39;;
 335     Solaris::_pthread_setname_np(pthread_self(), buf);
 336   }
 337 }
 338 
 339 bool os::bind_to_processor(uint processor_id) {
 340   // We assume that a processorid_t can be stored in a uint.
 341   assert(sizeof(uint) == sizeof(processorid_t),
 342          &quot;can&#39;t convert uint to processorid_t&quot;);
 343   int bind_result =
 344     processor_bind(P_LWPID,                       // bind LWP.
 345                    P_MYID,                        // bind current LWP.
 346                    (processorid_t) processor_id,  // id.
 347                    NULL);                         // don&#39;t return old binding.
 348   return (bind_result == 0);
 349 }
 350 
 351 // Return true if user is running as root.
 352 
 353 bool os::have_special_privileges() {
 354   static bool init = false;
 355   static bool privileges = false;
 356   if (!init) {
 357     privileges = (getuid() != geteuid()) || (getgid() != getegid());
 358     init = true;
 359   }
 360   return privileges;
 361 }
 362 
 363 
 364 void os::init_system_properties_values() {
 365   // The next steps are taken in the product version:
 366   //
 367   // Obtain the JAVA_HOME value from the location of libjvm.so.
 368   // This library should be located at:
 369   // &lt;JAVA_HOME&gt;/jre/lib/&lt;arch&gt;/{client|server}/libjvm.so.
 370   //
 371   // If &quot;/jre/lib/&quot; appears at the right place in the path, then we
 372   // assume libjvm.so is installed in a JDK and we use this path.
 373   //
 374   // Otherwise exit with message: &quot;Could not create the Java virtual machine.&quot;
 375   //
 376   // The following extra steps are taken in the debugging version:
 377   //
 378   // If &quot;/jre/lib/&quot; does NOT appear at the right place in the path
 379   // instead of exit check for $JAVA_HOME environment variable.
 380   //
 381   // If it is defined and we are able to locate $JAVA_HOME/jre/lib/&lt;arch&gt;,
 382   // then we append a fake suffix &quot;hotspot/libjvm.so&quot; to this path so
 383   // it looks like libjvm.so is installed there
 384   // &lt;JAVA_HOME&gt;/jre/lib/&lt;arch&gt;/hotspot/libjvm.so.
 385   //
 386   // Otherwise exit.
 387   //
 388   // Important note: if the location of libjvm.so changes this
 389   // code needs to be changed accordingly.
 390 
 391 // Base path of extensions installed on the system.
 392 #define SYS_EXT_DIR     &quot;/usr/jdk/packages&quot;
 393 #define EXTENSIONS_DIR  &quot;/lib/ext&quot;
 394 
 395   // Buffer that fits several sprintfs.
 396   // Note that the space for the colon and the trailing null are provided
 397   // by the nulls included by the sizeof operator.
 398   const size_t bufsize =
 399     MAX3((size_t)MAXPATHLEN,  // For dll_dir &amp; friends.
 400          sizeof(SYS_EXT_DIR) + sizeof(&quot;/lib/&quot;), // invariant ld_library_path
 401          (size_t)MAXPATHLEN + sizeof(EXTENSIONS_DIR) + sizeof(SYS_EXT_DIR) + sizeof(EXTENSIONS_DIR)); // extensions dir
 402   char *buf = NEW_C_HEAP_ARRAY(char, bufsize, mtInternal);
 403 
 404   // sysclasspath, java_home, dll_dir
 405   {
 406     char *pslash;
 407     os::jvm_path(buf, bufsize);
 408 
 409     // Found the full path to libjvm.so.
 410     // Now cut the path to &lt;java_home&gt;/jre if we can.
 411     *(strrchr(buf, &#39;/&#39;)) = &#39;\0&#39;; // Get rid of /libjvm.so.
 412     pslash = strrchr(buf, &#39;/&#39;);
 413     if (pslash != NULL) {
 414       *pslash = &#39;\0&#39;;            // Get rid of /{client|server|hotspot}.
 415     }
 416     Arguments::set_dll_dir(buf);
 417 
 418     if (pslash != NULL) {
 419       pslash = strrchr(buf, &#39;/&#39;);
 420       if (pslash != NULL) {
 421         *pslash = &#39;\0&#39;;        // Get rid of /lib.
 422       }
 423     }
 424     Arguments::set_java_home(buf);
 425     if (!set_boot_path(&#39;/&#39;, &#39;:&#39;)) {
 426       vm_exit_during_initialization(&quot;Failed setting boot class path.&quot;, NULL);
 427     }
 428   }
 429 
 430   // Where to look for native libraries.
 431   {
 432     // Use dlinfo() to determine the correct java.library.path.
 433     //
 434     // If we&#39;re launched by the Java launcher, and the user
 435     // does not set java.library.path explicitly on the commandline,
 436     // the Java launcher sets LD_LIBRARY_PATH for us and unsets
 437     // LD_LIBRARY_PATH_32 and LD_LIBRARY_PATH_64.  In this case
 438     // dlinfo returns LD_LIBRARY_PATH + crle settings (including
 439     // /usr/lib), which is exactly what we want.
 440     //
 441     // If the user does set java.library.path, it completely
 442     // overwrites this setting, and always has.
 443     //
 444     // If we&#39;re not launched by the Java launcher, we may
 445     // get here with any/all of the LD_LIBRARY_PATH[_32|64]
 446     // settings.  Again, dlinfo does exactly what we want.
 447 
 448     Dl_serinfo     info_sz, *info = &amp;info_sz;
 449     Dl_serpath     *path;
 450     char           *library_path;
 451     char           *common_path = buf;
 452 
 453     // Determine search path count and required buffer size.
 454     if (dlinfo(RTLD_SELF, RTLD_DI_SERINFOSIZE, (void *)info) == -1) {
 455       FREE_C_HEAP_ARRAY(char, buf);
 456       vm_exit_during_initialization(&quot;dlinfo SERINFOSIZE request&quot;, dlerror());
 457     }
 458 
 459     // Allocate new buffer and initialize.
 460     info = (Dl_serinfo*)NEW_C_HEAP_ARRAY(char, info_sz.dls_size, mtInternal);
 461     info-&gt;dls_size = info_sz.dls_size;
 462     info-&gt;dls_cnt = info_sz.dls_cnt;
 463 
 464     // Obtain search path information.
 465     if (dlinfo(RTLD_SELF, RTLD_DI_SERINFO, (void *)info) == -1) {
 466       FREE_C_HEAP_ARRAY(char, buf);
 467       FREE_C_HEAP_ARRAY(char, info);
 468       vm_exit_during_initialization(&quot;dlinfo SERINFO request&quot;, dlerror());
 469     }
 470 
 471     path = &amp;info-&gt;dls_serpath[0];
 472 
 473     // Note: Due to a legacy implementation, most of the library path
 474     // is set in the launcher. This was to accomodate linking restrictions
 475     // on legacy Solaris implementations (which are no longer supported).
 476     // Eventually, all the library path setting will be done here.
 477     //
 478     // However, to prevent the proliferation of improperly built native
 479     // libraries, the new path component /usr/jdk/packages is added here.
 480 
 481     // Construct the invariant part of ld_library_path.
 482     sprintf(common_path, SYS_EXT_DIR &quot;/lib&quot;);
 483 
 484     // Struct size is more than sufficient for the path components obtained
 485     // through the dlinfo() call, so only add additional space for the path
 486     // components explicitly added here.
 487     size_t library_path_size = info-&gt;dls_size + strlen(common_path);
 488     library_path = NEW_C_HEAP_ARRAY(char, library_path_size, mtInternal);
 489     library_path[0] = &#39;\0&#39;;
 490 
 491     // Construct the desired Java library path from the linker&#39;s library
 492     // search path.
 493     //
 494     // For compatibility, it is optimal that we insert the additional path
 495     // components specific to the Java VM after those components specified
 496     // in LD_LIBRARY_PATH (if any) but before those added by the ld.so
 497     // infrastructure.
 498     if (info-&gt;dls_cnt == 0) { // Not sure this can happen, but allow for it.
 499       strcpy(library_path, common_path);
 500     } else {
 501       int inserted = 0;
 502       int i;
 503       for (i = 0; i &lt; info-&gt;dls_cnt; i++, path++) {
 504         uint_t flags = path-&gt;dls_flags &amp; LA_SER_MASK;
 505         if (((flags &amp; LA_SER_LIBPATH) == 0) &amp;&amp; !inserted) {
 506           strcat(library_path, common_path);
 507           strcat(library_path, os::path_separator());
 508           inserted = 1;
 509         }
 510         strcat(library_path, path-&gt;dls_name);
 511         strcat(library_path, os::path_separator());
 512       }
 513       // Eliminate trailing path separator.
 514       library_path[strlen(library_path)-1] = &#39;\0&#39;;
 515     }
 516 
 517     // happens before argument parsing - can&#39;t use a trace flag
 518     // tty-&gt;print_raw(&quot;init_system_properties_values: native lib path: &quot;);
 519     // tty-&gt;print_raw_cr(library_path);
 520 
 521     // Callee copies into its own buffer.
 522     Arguments::set_library_path(library_path);
 523 
 524     FREE_C_HEAP_ARRAY(char, library_path);
 525     FREE_C_HEAP_ARRAY(char, info);
 526   }
 527 
 528   // Extensions directories.
 529   sprintf(buf, &quot;%s&quot; EXTENSIONS_DIR &quot;:&quot; SYS_EXT_DIR EXTENSIONS_DIR, Arguments::get_java_home());
 530   Arguments::set_ext_dirs(buf);
 531 
 532   FREE_C_HEAP_ARRAY(char, buf);
 533 
 534 #undef SYS_EXT_DIR
 535 #undef EXTENSIONS_DIR
 536 }
 537 
 538 void os::breakpoint() {
 539   BREAKPOINT;
 540 }
 541 
 542 extern &quot;C&quot; void breakpoint() {
 543   // use debugger to set breakpoint here
 544 }
 545 
 546 static thread_t main_thread;
 547 
 548 // Thread start routine for all newly created threads
 549 extern &quot;C&quot; void* thread_native_entry(void* thread_addr) {
 550 
 551   Thread* thread = (Thread*)thread_addr;
 552 
 553   thread-&gt;record_stack_base_and_size();
 554 
 555   // Try to randomize the cache line index of hot stack frames.
 556   // This helps when threads of the same stack traces evict each other&#39;s
 557   // cache lines. The threads can be either from the same JVM instance, or
 558   // from different JVM instances. The benefit is especially true for
 559   // processors with hyperthreading technology.
 560   static int counter = 0;
 561   int pid = os::current_process_id();
 562   alloca(((pid ^ counter++) &amp; 7) * 128);
 563 
 564   int prio;
 565 
 566   thread-&gt;initialize_thread_current();
 567 
 568   OSThread* osthr = thread-&gt;osthread();
 569 
 570   osthr-&gt;set_lwp_id(_lwp_self());  // Store lwp in case we are bound
 571 
 572   log_info(os, thread)(&quot;Thread is alive (tid: &quot; UINTX_FORMAT &quot;).&quot;,
 573     os::current_thread_id());
 574 
 575   if (UseNUMA) {
 576     int lgrp_id = os::numa_get_group_id();
 577     if (lgrp_id != -1) {
 578       thread-&gt;set_lgrp_id(lgrp_id);
 579     }
 580   }
 581 
 582   // Our priority was set when we were created, and stored in the
 583   // osthread, but couldn&#39;t be passed through to our LWP until now.
 584   // So read back the priority and set it again.
 585 
 586   if (osthr-&gt;thread_id() != -1) {
 587     if (UseThreadPriorities) {
 588       int prio = osthr-&gt;native_priority();
 589       if (ThreadPriorityVerbose) {
 590         tty-&gt;print_cr(&quot;Starting Thread &quot; INTPTR_FORMAT &quot;, LWP is &quot;
 591                       INTPTR_FORMAT &quot;, setting priority: %d\n&quot;,
 592                       osthr-&gt;thread_id(), osthr-&gt;lwp_id(), prio);
 593       }
 594       os::set_native_priority(thread, prio);
 595     }
 596   } else if (ThreadPriorityVerbose) {
 597     warning(&quot;Can&#39;t set priority in _start routine, thread id hasn&#39;t been set\n&quot;);
 598   }
 599 
 600   assert(osthr-&gt;get_state() == RUNNABLE, &quot;invalid os thread state&quot;);
 601 
 602   // initialize signal mask for this thread
 603   os::Solaris::hotspot_sigmask(thread);
 604 
 605   os::Solaris::init_thread_fpu_state();
 606   std::set_terminate(_handle_uncaught_cxx_exception);
 607 
 608   thread-&gt;call_run();
 609 
 610   // Note: at this point the thread object may already have deleted itself.
 611   // Do not dereference it from here on out.
 612 
 613   // One less thread is executing
 614   // When the VMThread gets here, the main thread may have already exited
 615   // which frees the CodeHeap containing the Atomic::dec code
 616   if (thread != VMThread::vm_thread() &amp;&amp; VMThread::vm_thread() != NULL) {
 617     Atomic::dec(&amp;os::Solaris::_os_thread_count);
 618   }
 619 
 620   log_info(os, thread)(&quot;Thread finished (tid: &quot; UINTX_FORMAT &quot;).&quot;, os::current_thread_id());
 621 
 622   if (UseDetachedThreads) {
 623     thr_exit(NULL);
 624     ShouldNotReachHere();
 625   }
 626   return NULL;
 627 }
 628 
 629 static OSThread* create_os_thread(Thread* thread, thread_t thread_id) {
 630   // Allocate the OSThread object
 631   OSThread* osthread = new OSThread(NULL, NULL);
 632   if (osthread == NULL) return NULL;
 633 
 634   // Store info on the Solaris thread into the OSThread
 635   osthread-&gt;set_thread_id(thread_id);
 636   osthread-&gt;set_lwp_id(_lwp_self());
 637 
 638   if (UseNUMA) {
 639     int lgrp_id = os::numa_get_group_id();
 640     if (lgrp_id != -1) {
 641       thread-&gt;set_lgrp_id(lgrp_id);
 642     }
 643   }
 644 
 645   if (ThreadPriorityVerbose) {
 646     tty-&gt;print_cr(&quot;In create_os_thread, Thread &quot; INTPTR_FORMAT &quot;, LWP is &quot; INTPTR_FORMAT &quot;\n&quot;,
 647                   osthread-&gt;thread_id(), osthread-&gt;lwp_id());
 648   }
 649 
 650   // Initial thread state is INITIALIZED, not SUSPENDED
 651   osthread-&gt;set_state(INITIALIZED);
 652 
 653   return osthread;
 654 }
 655 
 656 void os::Solaris::hotspot_sigmask(Thread* thread) {
 657   //Save caller&#39;s signal mask
 658   sigset_t sigmask;
 659   pthread_sigmask(SIG_SETMASK, NULL, &amp;sigmask);
 660   OSThread *osthread = thread-&gt;osthread();
 661   osthread-&gt;set_caller_sigmask(sigmask);
 662 
 663   pthread_sigmask(SIG_UNBLOCK, os::Solaris::unblocked_signals(), NULL);
 664   if (!ReduceSignalUsage) {
 665     if (thread-&gt;is_VM_thread()) {
 666       // Only the VM thread handles BREAK_SIGNAL ...
 667       pthread_sigmask(SIG_UNBLOCK, vm_signals(), NULL);
 668     } else {
 669       // ... all other threads block BREAK_SIGNAL
 670       assert(!sigismember(vm_signals(), SIGINT), &quot;SIGINT should not be blocked&quot;);
 671       pthread_sigmask(SIG_BLOCK, vm_signals(), NULL);
 672     }
 673   }
 674 }
 675 
 676 bool os::create_attached_thread(JavaThread* thread) {
 677 #ifdef ASSERT
 678   thread-&gt;verify_not_published();
 679 #endif
 680   OSThread* osthread = create_os_thread(thread, thr_self());
 681   if (osthread == NULL) {
 682     return false;
 683   }
 684 
 685   // Initial thread state is RUNNABLE
 686   osthread-&gt;set_state(RUNNABLE);
 687   thread-&gt;set_osthread(osthread);
 688 
 689   // initialize signal mask for this thread
 690   // and save the caller&#39;s signal mask
 691   os::Solaris::hotspot_sigmask(thread);
 692 
 693   log_info(os, thread)(&quot;Thread attached (tid: &quot; UINTX_FORMAT &quot;).&quot;,
 694     os::current_thread_id());
 695 
 696   return true;
 697 }
 698 
 699 bool os::create_main_thread(JavaThread* thread) {
 700 #ifdef ASSERT
 701   thread-&gt;verify_not_published();
 702 #endif
 703   if (_starting_thread == NULL) {
 704     _starting_thread = create_os_thread(thread, main_thread);
 705     if (_starting_thread == NULL) {
 706       return false;
 707     }
 708   }
 709 
 710   // The primodial thread is runnable from the start
 711   _starting_thread-&gt;set_state(RUNNABLE);
 712 
 713   thread-&gt;set_osthread(_starting_thread);
 714 
 715   // initialize signal mask for this thread
 716   // and save the caller&#39;s signal mask
 717   os::Solaris::hotspot_sigmask(thread);
 718 
 719   return true;
 720 }
 721 
 722 // Helper function to trace thread attributes, similar to os::Posix::describe_pthread_attr()
 723 static char* describe_thr_create_attributes(char* buf, size_t buflen,
 724                                             size_t stacksize, long flags) {
 725   stringStream ss(buf, buflen);
 726   ss.print(&quot;stacksize: &quot; SIZE_FORMAT &quot;k, &quot;, stacksize / 1024);
 727   ss.print(&quot;flags: &quot;);
 728   #define PRINT_FLAG(f) if (flags &amp; f) ss.print( #f &quot; &quot;);
 729   #define ALL(X) \
 730     X(THR_SUSPENDED) \
 731     X(THR_DETACHED) \
 732     X(THR_BOUND) \
 733     X(THR_NEW_LWP) \
 734     X(THR_DAEMON)
 735   ALL(PRINT_FLAG)
 736   #undef ALL
 737   #undef PRINT_FLAG
 738   return buf;
 739 }
 740 
 741 // return default stack size for thr_type
 742 size_t os::Posix::default_stack_size(os::ThreadType thr_type) {
 743   // default stack size when not specified by caller is 1M (2M for LP64)
 744   size_t s = (BytesPerWord &gt;&gt; 2) * K * K;
 745   return s;
 746 }
 747 
 748 bool os::create_thread(Thread* thread, ThreadType thr_type,
 749                        size_t req_stack_size) {
 750   // Allocate the OSThread object
 751   OSThread* osthread = new OSThread(NULL, NULL);
 752   if (osthread == NULL) {
 753     return false;
 754   }
 755 
 756   if (ThreadPriorityVerbose) {
 757     char *thrtyp;
 758     switch (thr_type) {
 759     case vm_thread:
 760       thrtyp = (char *)&quot;vm&quot;;
 761       break;
 762     case cgc_thread:
 763       thrtyp = (char *)&quot;cgc&quot;;
 764       break;
 765     case pgc_thread:
 766       thrtyp = (char *)&quot;pgc&quot;;
 767       break;
 768     case java_thread:
 769       thrtyp = (char *)&quot;java&quot;;
 770       break;
 771     case compiler_thread:
 772       thrtyp = (char *)&quot;compiler&quot;;
 773       break;
 774     case watcher_thread:
 775       thrtyp = (char *)&quot;watcher&quot;;
 776       break;
 777     default:
 778       thrtyp = (char *)&quot;unknown&quot;;
 779       break;
 780     }
 781     tty-&gt;print_cr(&quot;In create_thread, creating a %s thread\n&quot;, thrtyp);
 782   }
 783 
 784   // calculate stack size if it&#39;s not specified by caller
 785   size_t stack_size = os::Posix::get_initial_stack_size(thr_type, req_stack_size);
 786 
 787   // Initial state is ALLOCATED but not INITIALIZED
 788   osthread-&gt;set_state(ALLOCATED);
 789 
 790   if (os::Solaris::_os_thread_count &gt; os::Solaris::_os_thread_limit) {
 791     // We got lots of threads. Check if we still have some address space left.
 792     // Need to be at least 5Mb of unreserved address space. We do check by
 793     // trying to reserve some.
 794     const size_t VirtualMemoryBangSize = 20*K*K;
 795     char* mem = os::reserve_memory(VirtualMemoryBangSize);
 796     if (mem == NULL) {
 797       delete osthread;
 798       return false;
 799     } else {
 800       // Release the memory again
 801       os::release_memory(mem, VirtualMemoryBangSize);
 802     }
 803   }
 804 
 805   // Setup osthread because the child thread may need it.
 806   thread-&gt;set_osthread(osthread);
 807 
 808   // Create the Solaris thread
 809   thread_t tid = 0;
 810   long     flags = (UseDetachedThreads ? THR_DETACHED : 0) | THR_SUSPENDED;
 811   int      status;
 812 
 813   // Mark that we don&#39;t have an lwp or thread id yet.
 814   // In case we attempt to set the priority before the thread starts.
 815   osthread-&gt;set_lwp_id(-1);
 816   osthread-&gt;set_thread_id(-1);
 817 
 818   status = thr_create(NULL, stack_size, thread_native_entry, thread, flags, &amp;tid);
 819 
 820   char buf[64];
 821   if (status == 0) {
 822     log_info(os, thread)(&quot;Thread started (tid: &quot; UINTX_FORMAT &quot;, attributes: %s). &quot;,
 823       (uintx) tid, describe_thr_create_attributes(buf, sizeof(buf), stack_size, flags));
 824   } else {
 825     log_warning(os, thread)(&quot;Failed to start thread - thr_create failed (%s) for attributes: %s.&quot;,
 826       os::errno_name(status), describe_thr_create_attributes(buf, sizeof(buf), stack_size, flags));
 827     // Log some OS information which might explain why creating the thread failed.
 828     log_info(os, thread)(&quot;Number of threads approx. running in the VM: %d&quot;, Threads::number_of_threads());
 829     LogStream st(Log(os, thread)::info());
 830     os::Posix::print_rlimit_info(&amp;st);
 831     os::print_memory_info(&amp;st);
 832   }
 833 
 834   if (status != 0) {
 835     thread-&gt;set_osthread(NULL);
 836     // Need to clean up stuff we&#39;ve allocated so far
 837     delete osthread;
 838     return false;
 839   }
 840 
 841   Atomic::inc(&amp;os::Solaris::_os_thread_count);
 842 
 843   // Store info on the Solaris thread into the OSThread
 844   osthread-&gt;set_thread_id(tid);
 845 
 846   // Remember that we created this thread so we can set priority on it
 847   osthread-&gt;set_vm_created();
 848 
 849   // Most thread types will set an explicit priority before starting the thread,
 850   // but for those that don&#39;t we need a valid value to read back in thread_native_entry.
 851   osthread-&gt;set_native_priority(NormPriority);
 852 
 853   // Initial thread state is INITIALIZED, not SUSPENDED
 854   osthread-&gt;set_state(INITIALIZED);
 855 
 856   // The thread is returned suspended (in state INITIALIZED), and is started higher up in the call chain
 857   return true;
 858 }
 859 
 860 debug_only(static bool signal_sets_initialized = false);
 861 static sigset_t unblocked_sigs, vm_sigs;
 862 
 863 void os::Solaris::signal_sets_init() {
 864   // Should also have an assertion stating we are still single-threaded.
 865   assert(!signal_sets_initialized, &quot;Already initialized&quot;);
 866   // Fill in signals that are necessarily unblocked for all threads in
 867   // the VM. Currently, we unblock the following signals:
 868   // SHUTDOWN{1,2,3}_SIGNAL: for shutdown hooks support (unless over-ridden
 869   //                         by -Xrs (=ReduceSignalUsage));
 870   // BREAK_SIGNAL which is unblocked only by the VM thread and blocked by all
 871   // other threads. The &quot;ReduceSignalUsage&quot; boolean tells us not to alter
 872   // the dispositions or masks wrt these signals.
 873   // Programs embedding the VM that want to use the above signals for their
 874   // own purposes must, at this time, use the &quot;-Xrs&quot; option to prevent
 875   // interference with shutdown hooks and BREAK_SIGNAL thread dumping.
 876   // (See bug 4345157, and other related bugs).
 877   // In reality, though, unblocking these signals is really a nop, since
 878   // these signals are not blocked by default.
 879   sigemptyset(&amp;unblocked_sigs);
 880   sigaddset(&amp;unblocked_sigs, SIGILL);
 881   sigaddset(&amp;unblocked_sigs, SIGSEGV);
 882   sigaddset(&amp;unblocked_sigs, SIGBUS);
 883   sigaddset(&amp;unblocked_sigs, SIGFPE);
 884   sigaddset(&amp;unblocked_sigs, ASYNC_SIGNAL);
 885 
 886   if (!ReduceSignalUsage) {
 887     if (!os::Posix::is_sig_ignored(SHUTDOWN1_SIGNAL)) {
 888       sigaddset(&amp;unblocked_sigs, SHUTDOWN1_SIGNAL);
 889     }
 890     if (!os::Posix::is_sig_ignored(SHUTDOWN2_SIGNAL)) {
 891       sigaddset(&amp;unblocked_sigs, SHUTDOWN2_SIGNAL);
 892     }
 893     if (!os::Posix::is_sig_ignored(SHUTDOWN3_SIGNAL)) {
 894       sigaddset(&amp;unblocked_sigs, SHUTDOWN3_SIGNAL);
 895     }
 896   }
 897   // Fill in signals that are blocked by all but the VM thread.
 898   sigemptyset(&amp;vm_sigs);
 899   if (!ReduceSignalUsage) {
 900     sigaddset(&amp;vm_sigs, BREAK_SIGNAL);
 901   }
 902   debug_only(signal_sets_initialized = true);
 903 
 904   // For diagnostics only used in run_periodic_checks
 905   sigemptyset(&amp;check_signal_done);
 906 }
 907 
 908 // These are signals that are unblocked while a thread is running Java.
 909 // (For some reason, they get blocked by default.)
 910 sigset_t* os::Solaris::unblocked_signals() {
 911   assert(signal_sets_initialized, &quot;Not initialized&quot;);
 912   return &amp;unblocked_sigs;
 913 }
 914 
 915 // These are the signals that are blocked while a (non-VM) thread is
 916 // running Java. Only the VM thread handles these signals.
 917 sigset_t* os::Solaris::vm_signals() {
 918   assert(signal_sets_initialized, &quot;Not initialized&quot;);
 919   return &amp;vm_sigs;
 920 }
 921 
 922 // CR 7190089: on Solaris, primordial thread&#39;s stack needs adjusting.
 923 // Without the adjustment, stack size is incorrect if stack is set to unlimited (ulimit -s unlimited).
 924 void os::Solaris::correct_stack_boundaries_for_primordial_thread(Thread* thr) {
 925   assert(is_primordial_thread(), &quot;Call only for primordial thread&quot;);
 926 
 927   JavaThread* jt = (JavaThread *)thr;
 928   assert(jt != NULL, &quot;Sanity check&quot;);
 929   size_t stack_size;
 930   address base = jt-&gt;stack_base();
 931   if (Arguments::created_by_java_launcher()) {
 932     // Use 2MB to allow for Solaris 7 64 bit mode.
 933     stack_size = JavaThread::stack_size_at_create() == 0
 934       ? 2048*K : JavaThread::stack_size_at_create();
 935 
 936     // There are rare cases when we may have already used more than
 937     // the basic stack size allotment before this method is invoked.
 938     // Attempt to allow for a normally sized java_stack.
 939     size_t current_stack_offset = (size_t)(base - (address)&amp;stack_size);
 940     stack_size += ReservedSpace::page_align_size_down(current_stack_offset);
 941   } else {
 942     // 6269555: If we were not created by a Java launcher, i.e. if we are
 943     // running embedded in a native application, treat the primordial thread
 944     // as much like a native attached thread as possible.  This means using
 945     // the current stack size from thr_stksegment(), unless it is too large
 946     // to reliably setup guard pages.  A reasonable max size is 8MB.
 947     size_t current_size = os::current_stack_size();
 948     // This should never happen, but just in case....
 949     if (current_size == 0) current_size = 2 * K * K;
 950     stack_size = current_size &gt; (8 * K * K) ? (8 * K * K) : current_size;
 951   }
 952   address bottom = align_up(base - stack_size, os::vm_page_size());;
 953   stack_size = (size_t)(base - bottom);
 954 
 955   assert(stack_size &gt; 0, &quot;Stack size calculation problem&quot;);
 956 
 957   if (stack_size &gt; jt-&gt;stack_size()) {
 958 #ifndef PRODUCT
 959     struct rlimit limits;
 960     getrlimit(RLIMIT_STACK, &amp;limits);
 961     size_t size = adjust_stack_size(base, (size_t)limits.rlim_cur);
 962     assert(size &gt;= jt-&gt;stack_size(), &quot;Stack size problem in main thread&quot;);
 963 #endif
 964     tty-&gt;print_cr(&quot;Stack size of %d Kb exceeds current limit of %d Kb.\n&quot;
 965                   &quot;(Stack sizes are rounded up to a multiple of the system page size.)\n&quot;
 966                   &quot;See limit(1) to increase the stack size limit.&quot;,
 967                   stack_size / K, jt-&gt;stack_size() / K);
 968     vm_exit(1);
 969   }
 970   assert(jt-&gt;stack_size() &gt;= stack_size,
 971          &quot;Attempt to map more stack than was allocated&quot;);
 972   jt-&gt;set_stack_size(stack_size);
 973 
 974 }
 975 
 976 
 977 
 978 // Free Solaris resources related to the OSThread
 979 void os::free_thread(OSThread* osthread) {
 980   assert(osthread != NULL, &quot;os::free_thread but osthread not set&quot;);
 981 
 982   // We are told to free resources of the argument thread,
 983   // but we can only really operate on the current thread.
 984   assert(Thread::current()-&gt;osthread() == osthread,
 985          &quot;os::free_thread but not current thread&quot;);
 986 
 987   // Restore caller&#39;s signal mask
 988   sigset_t sigmask = osthread-&gt;caller_sigmask();
 989   pthread_sigmask(SIG_SETMASK, &amp;sigmask, NULL);
 990 
 991   delete osthread;
 992 }
 993 
 994 void os::pd_start_thread(Thread* thread) {
 995   int status = thr_continue(thread-&gt;osthread()-&gt;thread_id());
 996   assert_status(status == 0, status, &quot;thr_continue failed&quot;);
 997 }
 998 
 999 
1000 intx os::current_thread_id() {
1001   return (intx)thr_self();
1002 }
1003 
1004 static pid_t _initial_pid = 0;
1005 
1006 int os::current_process_id() {
1007   return (int)(_initial_pid ? _initial_pid : getpid());
1008 }
1009 
1010 // gethrtime() should be monotonic according to the documentation,
1011 // but some virtualized platforms are known to break this guarantee.
1012 // getTimeNanos() must be guaranteed not to move backwards, so we
1013 // are forced to add a check here.
1014 inline hrtime_t getTimeNanos() {
1015   const hrtime_t now = gethrtime();
1016   const hrtime_t prev = max_hrtime;
1017   if (now &lt;= prev) {
1018     return prev;   // same or retrograde time;
1019   }
1020   const hrtime_t obsv = Atomic::cmpxchg(&amp;max_hrtime, prev, now);
1021   assert(obsv &gt;= prev, &quot;invariant&quot;);   // Monotonicity
1022   // If the CAS succeeded then we&#39;re done and return &quot;now&quot;.
1023   // If the CAS failed and the observed value &quot;obsv&quot; is &gt;= now then
1024   // we should return &quot;obsv&quot;.  If the CAS failed and now &gt; obsv &gt; prv then
1025   // some other thread raced this thread and installed a new value, in which case
1026   // we could either (a) retry the entire operation, (b) retry trying to install now
1027   // or (c) just return obsv.  We use (c).   No loop is required although in some cases
1028   // we might discard a higher &quot;now&quot; value in deference to a slightly lower but freshly
1029   // installed obsv value.   That&#39;s entirely benign -- it admits no new orderings compared
1030   // to (a) or (b) -- and greatly reduces coherence traffic.
1031   // We might also condition (c) on the magnitude of the delta between obsv and now.
1032   // Avoiding excessive CAS operations to hot RW locations is critical.
1033   // See https://blogs.oracle.com/dave/entry/cas_and_cache_trivia_invalidate
1034   return (prev == obsv) ? now : obsv;
1035 }
1036 
1037 // Time since start-up in seconds to a fine granularity.
1038 // Used by VMSelfDestructTimer and the MemProfiler.
1039 double os::elapsedTime() {
1040   return (double)(getTimeNanos() - first_hrtime) / (double)hrtime_hz;
1041 }
1042 
1043 jlong os::elapsed_counter() {
1044   return (jlong)(getTimeNanos() - first_hrtime);
1045 }
1046 
1047 jlong os::elapsed_frequency() {
1048   return hrtime_hz;
1049 }
1050 
1051 // Return the real, user, and system times in seconds from an
1052 // arbitrary fixed point in the past.
1053 bool os::getTimesSecs(double* process_real_time,
1054                       double* process_user_time,
1055                       double* process_system_time) {
1056   struct tms ticks;
1057   clock_t real_ticks = times(&amp;ticks);
1058 
1059   if (real_ticks == (clock_t) (-1)) {
1060     return false;
1061   } else {
1062     double ticks_per_second = (double) clock_tics_per_sec;
1063     *process_user_time = ((double) ticks.tms_utime) / ticks_per_second;
1064     *process_system_time = ((double) ticks.tms_stime) / ticks_per_second;
1065     // For consistency return the real time from getTimeNanos()
1066     // converted to seconds.
1067     *process_real_time = ((double) getTimeNanos()) / ((double) NANOUNITS);
1068 
1069     return true;
1070   }
1071 }
1072 
1073 bool os::supports_vtime() { return true; }
1074 
1075 double os::elapsedVTime() {
1076   return (double)gethrvtime() / (double)hrtime_hz;
1077 }
1078 
1079 // Must return millis since Jan 1 1970 for JVM_CurrentTimeMillis
1080 jlong os::javaTimeMillis() {
1081   timeval t;
1082   if (gettimeofday(&amp;t, NULL) == -1) {
1083     fatal(&quot;os::javaTimeMillis: gettimeofday (%s)&quot;, os::strerror(errno));
1084   }
1085   return jlong(t.tv_sec) * 1000  +  jlong(t.tv_usec) / 1000;
1086 }
1087 
1088 // Must return seconds+nanos since Jan 1 1970. This must use the same
1089 // time source as javaTimeMillis and can&#39;t use get_nsec_fromepoch as
1090 // we need better than 1ms accuracy
1091 void os::javaTimeSystemUTC(jlong &amp;seconds, jlong &amp;nanos) {
1092   timeval t;
1093   if (gettimeofday(&amp;t, NULL) == -1) {
1094     fatal(&quot;os::javaTimeSystemUTC: gettimeofday (%s)&quot;, os::strerror(errno));
1095   }
1096   seconds = jlong(t.tv_sec);
1097   nanos = jlong(t.tv_usec) * 1000;
1098 }
1099 
1100 
1101 jlong os::javaTimeNanos() {
1102   return (jlong)getTimeNanos();
1103 }
1104 
1105 void os::javaTimeNanos_info(jvmtiTimerInfo *info_ptr) {
1106   info_ptr-&gt;max_value = ALL_64_BITS;      // gethrtime() uses all 64 bits
1107   info_ptr-&gt;may_skip_backward = false;    // not subject to resetting or drifting
1108   info_ptr-&gt;may_skip_forward = false;     // not subject to resetting or drifting
1109   info_ptr-&gt;kind = JVMTI_TIMER_ELAPSED;   // elapsed not CPU time
1110 }
1111 
1112 char * os::local_time_string(char *buf, size_t buflen) {
1113   struct tm t;
1114   time_t long_time;
1115   time(&amp;long_time);
1116   localtime_r(&amp;long_time, &amp;t);
1117   jio_snprintf(buf, buflen, &quot;%d-%02d-%02d %02d:%02d:%02d&quot;,
1118                t.tm_year + 1900, t.tm_mon + 1, t.tm_mday,
1119                t.tm_hour, t.tm_min, t.tm_sec);
1120   return buf;
1121 }
1122 
1123 // Note: os::shutdown() might be called very early during initialization, or
1124 // called from signal handler. Before adding something to os::shutdown(), make
1125 // sure it is async-safe and can handle partially initialized VM.
1126 void os::shutdown() {
1127 
1128   // allow PerfMemory to attempt cleanup of any persistent resources
1129   perfMemory_exit();
1130 
1131   // needs to remove object in file system
1132   AttachListener::abort();
1133 
1134   // flush buffered output, finish log files
1135   ostream_abort();
1136 
1137   // Check for abort hook
1138   abort_hook_t abort_hook = Arguments::abort_hook();
1139   if (abort_hook != NULL) {
1140     abort_hook();
1141   }
1142 }
1143 
1144 // Note: os::abort() might be called very early during initialization, or
1145 // called from signal handler. Before adding something to os::abort(), make
1146 // sure it is async-safe and can handle partially initialized VM.
1147 void os::abort(bool dump_core, void* siginfo, const void* context) {
1148   os::shutdown();
1149   if (dump_core) {
1150 #ifndef PRODUCT
1151     fdStream out(defaultStream::output_fd());
1152     out.print_raw(&quot;Current thread is &quot;);
1153     char buf[16];
1154     jio_snprintf(buf, sizeof(buf), UINTX_FORMAT, os::current_thread_id());
1155     out.print_raw_cr(buf);
1156     out.print_raw_cr(&quot;Dumping core ...&quot;);
1157 #endif
1158     ::abort(); // dump core (for debugging)
1159   }
1160 
1161   ::exit(1);
1162 }
1163 
1164 // Die immediately, no exit hook, no abort hook, no cleanup.
1165 // Dump a core file, if possible, for debugging.
1166 void os::die() {
1167   if (TestUnresponsiveErrorHandler &amp;&amp; !CreateCoredumpOnCrash) {
1168     // For TimeoutInErrorHandlingTest.java, we just kill the VM
1169     // and don&#39;t take the time to generate a core file.
1170     os::signal_raise(SIGKILL);
1171   } else {
1172     ::abort();
1173   }
1174 }
1175 
1176 // DLL functions
1177 
1178 const char* os::dll_file_extension() { return &quot;.so&quot;; }
1179 
1180 // This must be hard coded because it&#39;s the system&#39;s temporary
1181 // directory not the java application&#39;s temp directory, ala java.io.tmpdir.
1182 const char* os::get_temp_directory() { return &quot;/tmp&quot;; }
1183 
1184 // check if addr is inside libjvm.so
1185 bool os::address_is_in_vm(address addr) {
1186   static address libjvm_base_addr;
1187   Dl_info dlinfo;
1188 
1189   if (libjvm_base_addr == NULL) {
1190     if (dladdr(CAST_FROM_FN_PTR(void *, os::address_is_in_vm), &amp;dlinfo) != 0) {
1191       libjvm_base_addr = (address)dlinfo.dli_fbase;
1192     }
1193     assert(libjvm_base_addr !=NULL, &quot;Cannot obtain base address for libjvm&quot;);
1194   }
1195 
1196   if (dladdr((void *)addr, &amp;dlinfo) != 0) {
1197     if (libjvm_base_addr == (address)dlinfo.dli_fbase) return true;
1198   }
1199 
1200   return false;
1201 }
1202 
1203 typedef int (*dladdr1_func_type)(void *, Dl_info *, void **, int);
1204 static dladdr1_func_type dladdr1_func = NULL;
1205 
1206 bool os::dll_address_to_function_name(address addr, char *buf,
1207                                       int buflen, int * offset,
1208                                       bool demangle) {
1209   // buf is not optional, but offset is optional
1210   assert(buf != NULL, &quot;sanity check&quot;);
1211 
1212   Dl_info dlinfo;
1213 
1214   // dladdr1_func was initialized in os::init()
1215   if (dladdr1_func != NULL) {
1216     // yes, we have dladdr1
1217 
1218     // Support for dladdr1 is checked at runtime; it may be
1219     // available even if the vm is built on a machine that does
1220     // not have dladdr1 support.  Make sure there is a value for
1221     // RTLD_DL_SYMENT.
1222 #ifndef RTLD_DL_SYMENT
1223   #define RTLD_DL_SYMENT 1
1224 #endif
1225 #ifdef _LP64
1226     Elf64_Sym * info;
1227 #else
1228     Elf32_Sym * info;
1229 #endif
1230     if (dladdr1_func((void *)addr, &amp;dlinfo, (void **)&amp;info,
1231                      RTLD_DL_SYMENT) != 0) {
1232       // see if we have a matching symbol that covers our address
1233       if (dlinfo.dli_saddr != NULL &amp;&amp;
1234           (char *)dlinfo.dli_saddr + info-&gt;st_size &gt; (char *)addr) {
1235         if (dlinfo.dli_sname != NULL) {
1236           if (!(demangle &amp;&amp; Decoder::demangle(dlinfo.dli_sname, buf, buflen))) {
1237             jio_snprintf(buf, buflen, &quot;%s&quot;, dlinfo.dli_sname);
1238           }
1239           if (offset != NULL) *offset = addr - (address)dlinfo.dli_saddr;
1240           return true;
1241         }
1242       }
1243       // no matching symbol so try for just file info
1244       if (dlinfo.dli_fname != NULL &amp;&amp; dlinfo.dli_fbase != NULL) {
1245         if (Decoder::decode((address)(addr - (address)dlinfo.dli_fbase),
1246                             buf, buflen, offset, dlinfo.dli_fname, demangle)) {
1247           return true;
1248         }
1249       }
1250     }
1251     buf[0] = &#39;\0&#39;;
1252     if (offset != NULL) *offset  = -1;
1253     return false;
1254   }
1255 
1256   // no, only dladdr is available
1257   if (dladdr((void *)addr, &amp;dlinfo) != 0) {
1258     // see if we have a matching symbol
1259     if (dlinfo.dli_saddr != NULL &amp;&amp; dlinfo.dli_sname != NULL) {
1260       if (!(demangle &amp;&amp; Decoder::demangle(dlinfo.dli_sname, buf, buflen))) {
1261         jio_snprintf(buf, buflen, dlinfo.dli_sname);
1262       }
1263       if (offset != NULL) *offset = addr - (address)dlinfo.dli_saddr;
1264       return true;
1265     }
1266     // no matching symbol so try for just file info
1267     if (dlinfo.dli_fname != NULL &amp;&amp; dlinfo.dli_fbase != NULL) {
1268       if (Decoder::decode((address)(addr - (address)dlinfo.dli_fbase),
1269                           buf, buflen, offset, dlinfo.dli_fname, demangle)) {
1270         return true;
1271       }
1272     }
1273   }
1274   buf[0] = &#39;\0&#39;;
1275   if (offset != NULL) *offset  = -1;
1276   return false;
1277 }
1278 
1279 bool os::dll_address_to_library_name(address addr, char* buf,
1280                                      int buflen, int* offset) {
1281   // buf is not optional, but offset is optional
1282   assert(buf != NULL, &quot;sanity check&quot;);
1283 
1284   Dl_info dlinfo;
1285 
1286   if (dladdr((void*)addr, &amp;dlinfo) != 0) {
1287     if (dlinfo.dli_fname != NULL) {
1288       jio_snprintf(buf, buflen, &quot;%s&quot;, dlinfo.dli_fname);
1289     }
1290     if (dlinfo.dli_fbase != NULL &amp;&amp; offset != NULL) {
1291       *offset = addr - (address)dlinfo.dli_fbase;
1292     }
1293     return true;
1294   }
1295 
1296   buf[0] = &#39;\0&#39;;
1297   if (offset) *offset = -1;
1298   return false;
1299 }
1300 
1301 int os::get_loaded_modules_info(os::LoadedModulesCallbackFunc callback, void *param) {
1302   Dl_info dli;
1303   // Sanity check?
1304   if (dladdr(CAST_FROM_FN_PTR(void *, os::get_loaded_modules_info), &amp;dli) == 0 ||
1305       dli.dli_fname == NULL) {
1306     return 1;
1307   }
1308 
1309   void * handle = dlopen(dli.dli_fname, RTLD_LAZY);
1310   if (handle == NULL) {
1311     return 1;
1312   }
1313 
1314   Link_map *map;
1315   dlinfo(handle, RTLD_DI_LINKMAP, &amp;map);
1316   if (map == NULL) {
1317     dlclose(handle);
1318     return 1;
1319   }
1320 
1321   while (map-&gt;l_prev != NULL) {
1322     map = map-&gt;l_prev;
1323   }
1324 
1325   while (map != NULL) {
1326     // Iterate through all map entries and call callback with fields of interest
1327     if(callback(map-&gt;l_name, (address)map-&gt;l_addr, (address)0, param)) {
1328       dlclose(handle);
1329       return 1;
1330     }
1331     map = map-&gt;l_next;
1332   }
1333 
1334   dlclose(handle);
1335   return 0;
1336 }
1337 
1338 int _print_dll_info_cb(const char * name, address base_address, address top_address, void * param) {
1339   outputStream * out = (outputStream *) param;
1340   out-&gt;print_cr(PTR_FORMAT &quot; \t%s&quot;, base_address, name);
1341   return 0;
1342 }
1343 
1344 void os::print_dll_info(outputStream * st) {
1345   st-&gt;print_cr(&quot;Dynamic libraries:&quot;); st-&gt;flush();
1346   if (get_loaded_modules_info(_print_dll_info_cb, (void *)st)) {
1347     st-&gt;print_cr(&quot;Error: Cannot print dynamic libraries.&quot;);
1348   }
1349 }
1350 
1351 static void change_endianness(Elf32_Half&amp; val) {
1352   unsigned char *ptr = (unsigned char *)&amp;val;
1353   unsigned char swp = ptr[0];
1354   ptr[0] = ptr[1];
1355   ptr[1] = swp;
1356 }
1357 
1358 // Loads .dll/.so and
1359 // in case of error it checks if .dll/.so was built for the
1360 // same architecture as Hotspot is running on
1361 
1362 void * os::dll_load(const char *filename, char *ebuf, int ebuflen) {
1363   log_info(os)(&quot;attempting shared library load of %s&quot;, filename);
1364 
1365   void * result= ::dlopen(filename, RTLD_LAZY);
1366   if (result != NULL) {
1367     // Successful loading
1368     Events::log(NULL, &quot;Loaded shared library %s&quot;, filename);
1369     log_info(os)(&quot;shared library load of %s was successful&quot;, filename);
1370     return result;
1371   }
1372 
1373   Elf32_Ehdr elf_head;
1374   const char* error_report = ::dlerror();
1375   if (error_report == NULL) {
1376     error_report = &quot;dlerror returned no error description&quot;;
1377   }
1378   if (ebuf != NULL &amp;&amp; ebuflen &gt; 0) {
1379     ::strncpy(ebuf, error_report, ebuflen-1);
1380     ebuf[ebuflen-1]=&#39;\0&#39;;
1381   }
1382 
1383   Events::log(NULL, &quot;Loading shared library %s failed, %s&quot;, filename, error_report);
1384   log_info(os)(&quot;shared library load of %s failed, %s&quot;, filename, error_report);
1385 
1386   int diag_msg_max_length=ebuflen-strlen(ebuf);
1387   char* diag_msg_buf=ebuf+strlen(ebuf);
1388 
1389   if (diag_msg_max_length==0) {
1390     // No more space in ebuf for additional diagnostics message
1391     return NULL;
1392   }
1393 
1394 
1395   int file_descriptor= ::open(filename, O_RDONLY | O_NONBLOCK);
1396 
1397   if (file_descriptor &lt; 0) {
1398     // Can&#39;t open library, report dlerror() message
1399     return NULL;
1400   }
1401 
1402   bool failed_to_read_elf_head=
1403     (sizeof(elf_head)!=
1404      (::read(file_descriptor, &amp;elf_head,sizeof(elf_head))));
1405 
1406   ::close(file_descriptor);
1407   if (failed_to_read_elf_head) {
1408     // file i/o error - report dlerror() msg
1409     return NULL;
1410   }
1411 
1412   if (elf_head.e_ident[EI_DATA] != LITTLE_ENDIAN_ONLY(ELFDATA2LSB) BIG_ENDIAN_ONLY(ELFDATA2MSB)) {
1413     // handle invalid/out of range endianness values
1414     if (elf_head.e_ident[EI_DATA] == 0 || elf_head.e_ident[EI_DATA] &gt; 2) {
1415       return NULL;
1416     }
1417     change_endianness(elf_head.e_machine);
1418   }
1419 
1420   typedef struct {
1421     Elf32_Half    code;         // Actual value as defined in elf.h
1422     Elf32_Half    compat_class; // Compatibility of archs at VM&#39;s sense
1423     unsigned char elf_class;    // 32 or 64 bit
1424     unsigned char endianess;    // MSB or LSB
1425     char*         name;         // String representation
1426   } arch_t;
1427 
<a name="1" id="anc1"></a>



1428   static const arch_t arch_array[]={
1429     {EM_386,         EM_386,     ELFCLASS32, ELFDATA2LSB, (char*)&quot;IA 32&quot;},
1430     {EM_486,         EM_386,     ELFCLASS32, ELFDATA2LSB, (char*)&quot;IA 32&quot;},
1431     {EM_IA_64,       EM_IA_64,   ELFCLASS64, ELFDATA2LSB, (char*)&quot;IA 64&quot;},
1432     {EM_X86_64,      EM_X86_64,  ELFCLASS64, ELFDATA2LSB, (char*)&quot;AMD 64&quot;},
1433     {EM_SPARC,       EM_SPARC,   ELFCLASS32, ELFDATA2MSB, (char*)&quot;Sparc 32&quot;},
1434     {EM_SPARC32PLUS, EM_SPARC,   ELFCLASS32, ELFDATA2MSB, (char*)&quot;Sparc 32&quot;},
1435     {EM_SPARCV9,     EM_SPARCV9, ELFCLASS64, ELFDATA2MSB, (char*)&quot;Sparc v9 64&quot;},
1436     {EM_PPC,         EM_PPC,     ELFCLASS32, ELFDATA2MSB, (char*)&quot;Power PC 32&quot;},
1437     {EM_PPC64,       EM_PPC64,   ELFCLASS64, ELFDATA2MSB, (char*)&quot;Power PC 64&quot;},
1438     {EM_ARM,         EM_ARM,     ELFCLASS32, ELFDATA2LSB, (char*)&quot;ARM&quot;},
1439     // we only support 64 bit z architecture
1440     {EM_S390,        EM_S390,    ELFCLASS64, ELFDATA2MSB, (char*)&quot;IBM System/390&quot;},
1441     {EM_AARCH64,     EM_AARCH64, ELFCLASS64, ELFDATA2LSB, (char*)&quot;AARCH64&quot;}
1442   };
1443 
1444 #if  (defined IA32)
1445   static  Elf32_Half running_arch_code=EM_386;
1446 #elif   (defined AMD64)
1447   static  Elf32_Half running_arch_code=EM_X86_64;
1448 #elif  (defined IA64)
1449   static  Elf32_Half running_arch_code=EM_IA_64;
1450 #elif  (defined __sparc) &amp;&amp; (defined _LP64)
1451   static  Elf32_Half running_arch_code=EM_SPARCV9;
1452 #elif  (defined __sparc) &amp;&amp; (!defined _LP64)
1453   static  Elf32_Half running_arch_code=EM_SPARC;
1454 #elif  (defined __powerpc64__)
1455   static  Elf32_Half running_arch_code=EM_PPC64;
1456 #elif  (defined __powerpc__)
1457   static  Elf32_Half running_arch_code=EM_PPC;
1458 #elif (defined ARM)
1459   static  Elf32_Half running_arch_code=EM_ARM;
1460 #else
1461   #error Method os::dll_load requires that one of following is defined:\
1462        IA32, AMD64, IA64, __sparc, __powerpc__, ARM, ARM
1463 #endif
1464 
1465   // Identify compatibility class for VM&#39;s architecture and library&#39;s architecture
1466   // Obtain string descriptions for architectures
1467 
1468   arch_t lib_arch={elf_head.e_machine,0,elf_head.e_ident[EI_CLASS], elf_head.e_ident[EI_DATA], NULL};
1469   int running_arch_index=-1;
1470 
1471   for (unsigned int i=0; i &lt; ARRAY_SIZE(arch_array); i++) {
1472     if (running_arch_code == arch_array[i].code) {
1473       running_arch_index    = i;
1474     }
1475     if (lib_arch.code == arch_array[i].code) {
1476       lib_arch.compat_class = arch_array[i].compat_class;
1477       lib_arch.name         = arch_array[i].name;
1478     }
1479   }
1480 
1481   assert(running_arch_index != -1,
1482          &quot;Didn&#39;t find running architecture code (running_arch_code) in arch_array&quot;);
1483   if (running_arch_index == -1) {
1484     // Even though running architecture detection failed
1485     // we may still continue with reporting dlerror() message
1486     return NULL;
1487   }
1488 
1489   if (lib_arch.compat_class != arch_array[running_arch_index].compat_class) {
1490     if (lib_arch.name != NULL) {
1491       ::snprintf(diag_msg_buf, diag_msg_max_length-1,
1492                  &quot; (Possible cause: can&#39;t load %s .so on a %s platform)&quot;,
1493                  lib_arch.name, arch_array[running_arch_index].name);
1494     } else {
1495       ::snprintf(diag_msg_buf, diag_msg_max_length-1,
1496                  &quot; (Possible cause: can&#39;t load this .so (machine code=0x%x) on a %s platform)&quot;,
1497                  lib_arch.code, arch_array[running_arch_index].name);
1498     }
1499     return NULL;
1500   }
1501 
1502   if (lib_arch.endianess != arch_array[running_arch_index].endianess) {
1503     ::snprintf(diag_msg_buf, diag_msg_max_length-1,&quot; (Possible cause: endianness mismatch)&quot;);
1504     return NULL;
1505   }
1506 
1507   // ELF file class/capacity : 0 - invalid, 1 - 32bit, 2 - 64bit
1508   if (lib_arch.elf_class &gt; 2 || lib_arch.elf_class &lt; 1) {
1509     ::snprintf(diag_msg_buf, diag_msg_max_length-1, &quot; (Possible cause: invalid ELF file class)&quot;);
1510     return NULL;
1511   }
1512 
1513   if (lib_arch.elf_class != arch_array[running_arch_index].elf_class) {
1514     ::snprintf(diag_msg_buf, diag_msg_max_length-1,
1515                &quot; (Possible cause: architecture word width mismatch, can&#39;t load %d-bit .so on a %d-bit platform)&quot;,
1516                (int) lib_arch.elf_class * 32, arch_array[running_arch_index].elf_class * 32);
1517     return NULL;
1518   }
1519 
1520   return NULL;
1521 }
1522 
1523 void* os::dll_lookup(void* handle, const char* name) {
1524   return dlsym(handle, name);
1525 }
1526 
1527 void* os::get_default_process_handle() {
1528   return (void*)::dlopen(NULL, RTLD_LAZY);
1529 }
1530 
1531 static inline time_t get_mtime(const char* filename) {
1532   struct stat st;
1533   int ret = os::stat(filename, &amp;st);
1534   assert(ret == 0, &quot;failed to stat() file &#39;%s&#39;: %s&quot;, filename, os::strerror(errno));
1535   return st.st_mtime;
1536 }
1537 
1538 int os::compare_file_modified_times(const char* file1, const char* file2) {
1539   time_t t1 = get_mtime(file1);
1540   time_t t2 = get_mtime(file2);
1541   return t1 - t2;
1542 }
1543 
1544 static bool _print_ascii_file(const char* filename, outputStream* st) {
1545   int fd = ::open(filename, O_RDONLY);
1546   if (fd == -1) {
1547     return false;
1548   }
1549 
1550   char buf[32];
1551   int bytes;
1552   while ((bytes = ::read(fd, buf, sizeof(buf))) &gt; 0) {
1553     st-&gt;print_raw(buf, bytes);
1554   }
1555 
1556   ::close(fd);
1557 
1558   return true;
1559 }
1560 
1561 void os::print_os_info_brief(outputStream* st) {
1562   os::Solaris::print_distro_info(st);
1563 
1564   os::Posix::print_uname_info(st);
1565 
1566   os::Solaris::print_libversion_info(st);
1567 }
1568 
1569 void os::print_os_info(outputStream* st) {
1570   st-&gt;print(&quot;OS:&quot;);
1571 
1572   os::Solaris::print_distro_info(st);
1573 
1574   os::Posix::print_uname_info(st);
1575 
1576   os::Posix::print_uptime_info(st);
1577 
1578   os::Solaris::print_libversion_info(st);
1579 
1580   os::Posix::print_rlimit_info(st);
1581 
1582   os::Posix::print_load_average(st);
1583 }
1584 
1585 void os::Solaris::print_distro_info(outputStream* st) {
1586   if (!_print_ascii_file(&quot;/etc/release&quot;, st)) {
1587     st-&gt;print(&quot;Solaris&quot;);
1588   }
1589   st-&gt;cr();
1590 }
1591 
1592 void os::get_summary_os_info(char* buf, size_t buflen) {
1593   strncpy(buf, &quot;Solaris&quot;, buflen);  // default to plain solaris
1594   FILE* fp = fopen(&quot;/etc/release&quot;, &quot;r&quot;);
1595   if (fp != NULL) {
1596     char tmp[256];
1597     // Only get the first line and chop out everything but the os name.
1598     if (fgets(tmp, sizeof(tmp), fp)) {
1599       char* ptr = tmp;
1600       // skip past whitespace characters
1601       while (*ptr != &#39;\0&#39; &amp;&amp; (*ptr == &#39; &#39; || *ptr == &#39;\t&#39; || *ptr == &#39;\n&#39;)) ptr++;
1602       if (*ptr != &#39;\0&#39;) {
1603         char* nl = strchr(ptr, &#39;\n&#39;);
1604         if (nl != NULL) *nl = &#39;\0&#39;;
1605         strncpy(buf, ptr, buflen);
1606       }
1607     }
1608     fclose(fp);
1609   }
1610 }
1611 
1612 void os::Solaris::print_libversion_info(outputStream* st) {
1613   st-&gt;print(&quot;  (T2 libthread)&quot;);
1614   st-&gt;cr();
1615 }
1616 
1617 static bool check_addr0(outputStream* st) {
1618   jboolean status = false;
1619   const int read_chunk = 200;
1620   int ret = 0;
1621   int nmap = 0;
1622   int fd = ::open(&quot;/proc/self/map&quot;,O_RDONLY);
1623   if (fd &gt;= 0) {
1624     prmap_t *p = NULL;
1625     char *mbuff = (char *) calloc(read_chunk, sizeof(prmap_t));
1626     if (NULL == mbuff) {
1627       ::close(fd);
1628       return status;
1629     }
1630     while ((ret = ::read(fd, mbuff, read_chunk*sizeof(prmap_t))) &gt; 0) {
1631       //check if read() has not read partial data
1632       if( 0 != ret % sizeof(prmap_t)){
1633         break;
1634       }
1635       nmap = ret / sizeof(prmap_t);
1636       p = (prmap_t *)mbuff;
1637       for(int i = 0; i &lt; nmap; i++){
1638         if (p-&gt;pr_vaddr == 0x0) {
1639           st-&gt;print(&quot;Warning: Address: &quot; PTR_FORMAT &quot;, Size: &quot; SIZE_FORMAT &quot;K, &quot;,p-&gt;pr_vaddr, p-&gt;pr_size/1024);
1640           st-&gt;print(&quot;Mapped file: %s, &quot;, p-&gt;pr_mapname[0] == &#39;\0&#39; ? &quot;None&quot; : p-&gt;pr_mapname);
1641           st-&gt;print(&quot;Access: &quot;);
1642           st-&gt;print(&quot;%s&quot;,(p-&gt;pr_mflags &amp; MA_READ)  ? &quot;r&quot; : &quot;-&quot;);
1643           st-&gt;print(&quot;%s&quot;,(p-&gt;pr_mflags &amp; MA_WRITE) ? &quot;w&quot; : &quot;-&quot;);
1644           st-&gt;print(&quot;%s&quot;,(p-&gt;pr_mflags &amp; MA_EXEC)  ? &quot;x&quot; : &quot;-&quot;);
1645           st-&gt;cr();
1646           status = true;
1647         }
1648         p++;
1649       }
1650     }
1651     free(mbuff);
1652     ::close(fd);
1653   }
1654   return status;
1655 }
1656 
1657 void os::get_summary_cpu_info(char* buf, size_t buflen) {
1658   // Get MHz with system call. We don&#39;t seem to already have this.
1659   processor_info_t stats;
1660   processorid_t id = getcpuid();
1661   int clock = 0;
1662   if (processor_info(id, &amp;stats) != -1) {
1663     clock = stats.pi_clock;  // pi_processor_type isn&#39;t more informative than below
1664   }
1665 #ifdef AMD64
1666   snprintf(buf, buflen, &quot;x86 64 bit %d MHz&quot;, clock);
1667 #else
1668   // must be sparc
1669   snprintf(buf, buflen, &quot;Sparcv9 64 bit %d MHz&quot;, clock);
1670 #endif
1671 }
1672 
1673 void os::pd_print_cpu_info(outputStream* st, char* buf, size_t buflen) {
1674   // Nothing to do for now.
1675 }
1676 
1677 void os::print_memory_info(outputStream* st) {
1678   st-&gt;print(&quot;Memory:&quot;);
1679   st-&gt;print(&quot; %dk page&quot;, os::vm_page_size()&gt;&gt;10);
1680   st-&gt;print(&quot;, physical &quot; UINT64_FORMAT &quot;k&quot;, os::physical_memory()&gt;&gt;10);
1681   st-&gt;print(&quot;(&quot; UINT64_FORMAT &quot;k free)&quot;, os::available_memory() &gt;&gt; 10);
1682   st-&gt;cr();
1683   (void) check_addr0(st);
1684 }
1685 
1686 // Moved from whole group, because we need them here for diagnostic
1687 // prints.
1688 static int Maxsignum = 0;
1689 static int *ourSigFlags = NULL;
1690 
1691 int os::Solaris::get_our_sigflags(int sig) {
1692   assert(ourSigFlags!=NULL, &quot;signal data structure not initialized&quot;);
1693   assert(sig &gt; 0 &amp;&amp; sig &lt; Maxsignum, &quot;vm signal out of expected range&quot;);
1694   return ourSigFlags[sig];
1695 }
1696 
1697 void os::Solaris::set_our_sigflags(int sig, int flags) {
1698   assert(ourSigFlags!=NULL, &quot;signal data structure not initialized&quot;);
1699   assert(sig &gt; 0 &amp;&amp; sig &lt; Maxsignum, &quot;vm signal out of expected range&quot;);
1700   ourSigFlags[sig] = flags;
1701 }
1702 
1703 
1704 static const char* get_signal_handler_name(address handler,
1705                                            char* buf, int buflen) {
1706   int offset;
1707   bool found = os::dll_address_to_library_name(handler, buf, buflen, &amp;offset);
1708   if (found) {
1709     // skip directory names
1710     const char *p1, *p2;
1711     p1 = buf;
1712     size_t len = strlen(os::file_separator());
1713     while ((p2 = strstr(p1, os::file_separator())) != NULL) p1 = p2 + len;
1714     jio_snprintf(buf, buflen, &quot;%s+0x%x&quot;, p1, offset);
1715   } else {
1716     jio_snprintf(buf, buflen, PTR_FORMAT, handler);
1717   }
1718   return buf;
1719 }
1720 
1721 static void print_signal_handler(outputStream* st, int sig,
1722                                  char* buf, size_t buflen) {
1723   struct sigaction sa;
1724 
1725   sigaction(sig, NULL, &amp;sa);
1726 
1727   st-&gt;print(&quot;%s: &quot;, os::exception_name(sig, buf, buflen));
1728 
1729   address handler = (sa.sa_flags &amp; SA_SIGINFO)
1730                   ? CAST_FROM_FN_PTR(address, sa.sa_sigaction)
1731                   : CAST_FROM_FN_PTR(address, sa.sa_handler);
1732 
1733   if (handler == CAST_FROM_FN_PTR(address, SIG_DFL)) {
1734     st-&gt;print(&quot;SIG_DFL&quot;);
1735   } else if (handler == CAST_FROM_FN_PTR(address, SIG_IGN)) {
1736     st-&gt;print(&quot;SIG_IGN&quot;);
1737   } else {
1738     st-&gt;print(&quot;[%s]&quot;, get_signal_handler_name(handler, buf, buflen));
1739   }
1740 
1741   st-&gt;print(&quot;, sa_mask[0]=&quot;);
1742   os::Posix::print_signal_set_short(st, &amp;sa.sa_mask);
1743 
1744   address rh = VMError::get_resetted_sighandler(sig);
1745   // May be, handler was resetted by VMError?
1746   if (rh != NULL) {
1747     handler = rh;
1748     sa.sa_flags = VMError::get_resetted_sigflags(sig);
1749   }
1750 
1751   st-&gt;print(&quot;, sa_flags=&quot;);
1752   os::Posix::print_sa_flags(st, sa.sa_flags);
1753 
1754   // Check: is it our handler?
1755   if (handler == CAST_FROM_FN_PTR(address, signalHandler)) {
1756     // It is our signal handler
1757     // check for flags
1758     if (sa.sa_flags != os::Solaris::get_our_sigflags(sig)) {
1759       st-&gt;print(
1760                 &quot;, flags was changed from &quot; PTR32_FORMAT &quot;, consider using jsig library&quot;,
1761                 os::Solaris::get_our_sigflags(sig));
1762     }
1763   }
1764   st-&gt;cr();
1765 }
1766 
1767 void os::print_signal_handlers(outputStream* st, char* buf, size_t buflen) {
1768   st-&gt;print_cr(&quot;Signal Handlers:&quot;);
1769   print_signal_handler(st, SIGSEGV, buf, buflen);
1770   print_signal_handler(st, SIGBUS , buf, buflen);
1771   print_signal_handler(st, SIGFPE , buf, buflen);
1772   print_signal_handler(st, SIGPIPE, buf, buflen);
1773   print_signal_handler(st, SIGXFSZ, buf, buflen);
1774   print_signal_handler(st, SIGILL , buf, buflen);
1775   print_signal_handler(st, ASYNC_SIGNAL, buf, buflen);
1776   print_signal_handler(st, BREAK_SIGNAL, buf, buflen);
1777   print_signal_handler(st, SHUTDOWN1_SIGNAL , buf, buflen);
1778   print_signal_handler(st, SHUTDOWN2_SIGNAL , buf, buflen);
1779   print_signal_handler(st, SHUTDOWN3_SIGNAL, buf, buflen);
1780 }
1781 
1782 static char saved_jvm_path[MAXPATHLEN] = { 0 };
1783 
1784 // Find the full path to the current module, libjvm.so
1785 void os::jvm_path(char *buf, jint buflen) {
1786   // Error checking.
1787   if (buflen &lt; MAXPATHLEN) {
1788     assert(false, &quot;must use a large-enough buffer&quot;);
1789     buf[0] = &#39;\0&#39;;
1790     return;
1791   }
1792   // Lazy resolve the path to current module.
1793   if (saved_jvm_path[0] != 0) {
1794     strcpy(buf, saved_jvm_path);
1795     return;
1796   }
1797 
1798   Dl_info dlinfo;
1799   int ret = dladdr(CAST_FROM_FN_PTR(void *, os::jvm_path), &amp;dlinfo);
1800   assert(ret != 0, &quot;cannot locate libjvm&quot;);
1801   if (ret != 0 &amp;&amp; dlinfo.dli_fname != NULL) {
1802     if (os::Posix::realpath((char *)dlinfo.dli_fname, buf, buflen) == NULL) {
1803       return;
1804     }
1805   } else {
1806     buf[0] = &#39;\0&#39;;
1807     return;
1808   }
1809 
1810   if (Arguments::sun_java_launcher_is_altjvm()) {
1811     // Support for the java launcher&#39;s &#39;-XXaltjvm=&lt;path&gt;&#39; option. Typical
1812     // value for buf is &quot;&lt;JAVA_HOME&gt;/jre/lib/&lt;arch&gt;/&lt;vmtype&gt;/libjvm.so&quot;.
1813     // If &quot;/jre/lib/&quot; appears at the right place in the string, then
1814     // assume we are installed in a JDK and we&#39;re done.  Otherwise, check
1815     // for a JAVA_HOME environment variable and fix up the path so it
1816     // looks like libjvm.so is installed there (append a fake suffix
1817     // hotspot/libjvm.so).
1818     const char *p = buf + strlen(buf) - 1;
1819     for (int count = 0; p &gt; buf &amp;&amp; count &lt; 5; ++count) {
1820       for (--p; p &gt; buf &amp;&amp; *p != &#39;/&#39;; --p)
1821         /* empty */ ;
1822     }
1823 
1824     if (strncmp(p, &quot;/jre/lib/&quot;, 9) != 0) {
1825       // Look for JAVA_HOME in the environment.
1826       char* java_home_var = ::getenv(&quot;JAVA_HOME&quot;);
1827       if (java_home_var != NULL &amp;&amp; java_home_var[0] != 0) {
1828         char* jrelib_p;
1829         int   len;
1830 
1831         // Check the current module name &quot;libjvm.so&quot;.
1832         p = strrchr(buf, &#39;/&#39;);
1833         assert(strstr(p, &quot;/libjvm&quot;) == p, &quot;invalid library name&quot;);
1834 
1835         if (os::Posix::realpath(java_home_var, buf, buflen) == NULL) {
1836           return;
1837         }
1838         // determine if this is a legacy image or modules image
1839         // modules image doesn&#39;t have &quot;jre&quot; subdirectory
1840         len = strlen(buf);
1841         assert(len &lt; buflen, &quot;Ran out of buffer space&quot;);
1842         jrelib_p = buf + len;
1843         snprintf(jrelib_p, buflen-len, &quot;/jre/lib&quot;);
1844         if (0 != access(buf, F_OK)) {
1845           snprintf(jrelib_p, buflen-len, &quot;/lib&quot;);
1846         }
1847 
1848         if (0 == access(buf, F_OK)) {
1849           // Use current module name &quot;libjvm.so&quot;
1850           len = strlen(buf);
1851           snprintf(buf + len, buflen-len, &quot;/hotspot/libjvm.so&quot;);
1852         } else {
1853           // Go back to path of .so
1854           if (os::Posix::realpath((char *)dlinfo.dli_fname, buf, buflen) == NULL) {
1855             return;
1856           }
1857         }
1858       }
1859     }
1860   }
1861 
1862   strncpy(saved_jvm_path, buf, MAXPATHLEN);
1863   saved_jvm_path[MAXPATHLEN - 1] = &#39;\0&#39;;
1864 }
1865 
1866 
1867 void os::print_jni_name_prefix_on(outputStream* st, int args_size) {
1868   // no prefix required, not even &quot;_&quot;
1869 }
1870 
1871 
1872 void os::print_jni_name_suffix_on(outputStream* st, int args_size) {
1873   // no suffix required
1874 }
1875 
1876 // sun.misc.Signal
1877 
1878 extern &quot;C&quot; {
1879   static void UserHandler(int sig, void *siginfo, void *context) {
1880     // Ctrl-C is pressed during error reporting, likely because the error
1881     // handler fails to abort. Let VM die immediately.
1882     if (sig == SIGINT &amp;&amp; VMError::is_error_reported()) {
1883       os::die();
1884     }
1885 
1886     os::signal_notify(sig);
1887     // We do not need to reinstate the signal handler each time...
1888   }
1889 }
1890 
1891 void* os::user_handler() {
1892   return CAST_FROM_FN_PTR(void*, UserHandler);
1893 }
1894 
1895 extern &quot;C&quot; {
1896   typedef void (*sa_handler_t)(int);
1897   typedef void (*sa_sigaction_t)(int, siginfo_t *, void *);
1898 }
1899 
1900 void* os::signal(int signal_number, void* handler) {
1901   struct sigaction sigAct, oldSigAct;
1902   sigfillset(&amp;(sigAct.sa_mask));
1903   sigAct.sa_flags = SA_RESTART &amp; ~SA_RESETHAND;
1904   sigAct.sa_flags |= SA_SIGINFO;
1905   sigAct.sa_handler = CAST_TO_FN_PTR(sa_handler_t, handler);
1906 
1907   if (sigaction(signal_number, &amp;sigAct, &amp;oldSigAct)) {
1908     // -1 means registration failed
1909     return (void *)-1;
1910   }
1911 
1912   return CAST_FROM_FN_PTR(void*, oldSigAct.sa_handler);
1913 }
1914 
1915 void os::signal_raise(int signal_number) {
1916   raise(signal_number);
1917 }
1918 
1919 // The following code is moved from os.cpp for making this
1920 // code platform specific, which it is by its very nature.
1921 
1922 // a counter for each possible signal value
1923 static int Sigexit = 0;
1924 static jint *pending_signals = NULL;
1925 static int *preinstalled_sigs = NULL;
1926 static struct sigaction *chainedsigactions = NULL;
1927 static Semaphore* sig_sem = NULL;
1928 
1929 int os::sigexitnum_pd() {
1930   assert(Sigexit &gt; 0, &quot;signal memory not yet initialized&quot;);
1931   return Sigexit;
1932 }
1933 
1934 void os::Solaris::init_signal_mem() {
1935   // Initialize signal structures
1936   Maxsignum = SIGRTMAX;
1937   Sigexit = Maxsignum+1;
1938   assert(Maxsignum &gt;0, &quot;Unable to obtain max signal number&quot;);
1939 
1940   // Initialize signal structures
1941   // pending_signals has one int per signal
1942   // The additional signal is for SIGEXIT - exit signal to signal_thread
1943   pending_signals = (jint *)os::malloc(sizeof(jint) * (Sigexit+1), mtInternal);
1944   memset(pending_signals, 0, (sizeof(jint) * (Sigexit+1)));
1945 
1946   if (UseSignalChaining) {
1947     chainedsigactions = (struct sigaction *)malloc(sizeof(struct sigaction)
1948                                                    * (Maxsignum + 1), mtInternal);
1949     memset(chainedsigactions, 0, (sizeof(struct sigaction) * (Maxsignum + 1)));
1950     preinstalled_sigs = (int *)os::malloc(sizeof(int) * (Maxsignum + 1), mtInternal);
1951     memset(preinstalled_sigs, 0, (sizeof(int) * (Maxsignum + 1)));
1952   }
1953   ourSigFlags = (int*)malloc(sizeof(int) * (Maxsignum + 1), mtInternal);
1954   memset(ourSigFlags, 0, sizeof(int) * (Maxsignum + 1));
1955 }
1956 
1957 static void jdk_misc_signal_init() {
1958   // Initialize signal semaphore
1959   sig_sem = new Semaphore();
1960 }
1961 
1962 void os::signal_notify(int sig) {
1963   if (sig_sem != NULL) {
1964     Atomic::inc(&amp;pending_signals[sig]);
1965     sig_sem-&gt;signal();
1966   } else {
1967     // Signal thread is not created with ReduceSignalUsage and jdk_misc_signal_init
1968     // initialization isn&#39;t called.
1969     assert(ReduceSignalUsage, &quot;signal semaphore should be created&quot;);
1970   }
1971 }
1972 
1973 static int check_pending_signals() {
1974   int ret;
1975   while (true) {
1976     for (int i = 0; i &lt; Sigexit + 1; i++) {
1977       jint n = pending_signals[i];
1978       if (n &gt; 0 &amp;&amp; n == Atomic::cmpxchg(&amp;pending_signals[i], n, n - 1)) {
1979         return i;
1980       }
1981     }
1982     JavaThread *thread = JavaThread::current();
1983     ThreadBlockInVM tbivm(thread);
1984 
1985     bool threadIsSuspended;
1986     do {
1987       thread-&gt;set_suspend_equivalent();
1988       sig_sem-&gt;wait();
1989 
1990       // were we externally suspended while we were waiting?
1991       threadIsSuspended = thread-&gt;handle_special_suspend_equivalent_condition();
1992       if (threadIsSuspended) {
1993         // The semaphore has been incremented, but while we were waiting
1994         // another thread suspended us. We don&#39;t want to continue running
1995         // while suspended because that would surprise the thread that
1996         // suspended us.
1997         sig_sem-&gt;signal();
1998 
1999         thread-&gt;java_suspend_self();
2000       }
2001     } while (threadIsSuspended);
2002   }
2003 }
2004 
2005 int os::signal_wait() {
2006   return check_pending_signals();
2007 }
2008 
2009 ////////////////////////////////////////////////////////////////////////////////
2010 // Virtual Memory
2011 
2012 static int page_size = -1;
2013 
2014 int os::vm_page_size() {
2015   assert(page_size != -1, &quot;must call os::init&quot;);
2016   return page_size;
2017 }
2018 
2019 // Solaris allocates memory by pages.
2020 int os::vm_allocation_granularity() {
2021   assert(page_size != -1, &quot;must call os::init&quot;);
2022   return page_size;
2023 }
2024 
2025 static bool recoverable_mmap_error(int err) {
2026   // See if the error is one we can let the caller handle. This
2027   // list of errno values comes from the Solaris mmap(2) man page.
2028   switch (err) {
2029   case EBADF:
2030   case EINVAL:
2031   case ENOTSUP:
2032     // let the caller deal with these errors
2033     return true;
2034 
2035   default:
2036     // Any remaining errors on this OS can cause our reserved mapping
2037     // to be lost. That can cause confusion where different data
2038     // structures think they have the same memory mapped. The worst
2039     // scenario is if both the VM and a library think they have the
2040     // same memory mapped.
2041     return false;
2042   }
2043 }
2044 
2045 static void warn_fail_commit_memory(char* addr, size_t bytes, bool exec,
2046                                     int err) {
2047   warning(&quot;INFO: os::commit_memory(&quot; PTR_FORMAT &quot;, &quot; SIZE_FORMAT
2048           &quot;, %d) failed; error=&#39;%s&#39; (errno=%d)&quot;, addr, bytes, exec,
2049           os::strerror(err), err);
2050 }
2051 
2052 static void warn_fail_commit_memory(char* addr, size_t bytes,
2053                                     size_t alignment_hint, bool exec,
2054                                     int err) {
2055   warning(&quot;INFO: os::commit_memory(&quot; PTR_FORMAT &quot;, &quot; SIZE_FORMAT
2056           &quot;, &quot; SIZE_FORMAT &quot;, %d) failed; error=&#39;%s&#39; (errno=%d)&quot;, addr, bytes,
2057           alignment_hint, exec, os::strerror(err), err);
2058 }
2059 
2060 int os::Solaris::commit_memory_impl(char* addr, size_t bytes, bool exec) {
2061   int prot = exec ? PROT_READ|PROT_WRITE|PROT_EXEC : PROT_READ|PROT_WRITE;
2062   size_t size = bytes;
2063   char *res = Solaris::mmap_chunk(addr, size, MAP_PRIVATE|MAP_FIXED, prot);
2064   if (res != NULL) {
2065     if (UseNUMAInterleaving) {
2066         numa_make_global(addr, bytes);
2067     }
2068     return 0;
2069   }
2070 
2071   int err = errno;  // save errno from mmap() call in mmap_chunk()
2072 
2073   if (!recoverable_mmap_error(err)) {
2074     warn_fail_commit_memory(addr, bytes, exec, err);
2075     vm_exit_out_of_memory(bytes, OOM_MMAP_ERROR, &quot;committing reserved memory.&quot;);
2076   }
2077 
2078   return err;
2079 }
2080 
2081 bool os::pd_commit_memory(char* addr, size_t bytes, bool exec) {
2082   return Solaris::commit_memory_impl(addr, bytes, exec) == 0;
2083 }
2084 
2085 void os::pd_commit_memory_or_exit(char* addr, size_t bytes, bool exec,
2086                                   const char* mesg) {
2087   assert(mesg != NULL, &quot;mesg must be specified&quot;);
2088   int err = os::Solaris::commit_memory_impl(addr, bytes, exec);
2089   if (err != 0) {
2090     // the caller wants all commit errors to exit with the specified mesg:
2091     warn_fail_commit_memory(addr, bytes, exec, err);
2092     vm_exit_out_of_memory(bytes, OOM_MMAP_ERROR, &quot;%s&quot;, mesg);
2093   }
2094 }
2095 
2096 size_t os::Solaris::page_size_for_alignment(size_t alignment) {
2097   assert(is_aligned(alignment, (size_t) vm_page_size()),
2098          SIZE_FORMAT &quot; is not aligned to &quot; SIZE_FORMAT,
2099          alignment, (size_t) vm_page_size());
2100 
2101   for (int i = 0; _page_sizes[i] != 0; i++) {
2102     if (is_aligned(alignment, _page_sizes[i])) {
2103       return _page_sizes[i];
2104     }
2105   }
2106 
2107   return (size_t) vm_page_size();
2108 }
2109 
2110 int os::Solaris::commit_memory_impl(char* addr, size_t bytes,
2111                                     size_t alignment_hint, bool exec) {
2112   int err = Solaris::commit_memory_impl(addr, bytes, exec);
2113   if (err == 0 &amp;&amp; UseLargePages &amp;&amp; alignment_hint &gt; 0) {
2114     assert(is_aligned(bytes, alignment_hint),
2115            SIZE_FORMAT &quot; is not aligned to &quot; SIZE_FORMAT, bytes, alignment_hint);
2116 
2117     // The syscall memcntl requires an exact page size (see man memcntl for details).
2118     size_t page_size = page_size_for_alignment(alignment_hint);
2119     if (page_size &gt; (size_t) vm_page_size()) {
2120       (void)Solaris::setup_large_pages(addr, bytes, page_size);
2121     }
2122   }
2123   return err;
2124 }
2125 
2126 bool os::pd_commit_memory(char* addr, size_t bytes, size_t alignment_hint,
2127                           bool exec) {
2128   return Solaris::commit_memory_impl(addr, bytes, alignment_hint, exec) == 0;
2129 }
2130 
2131 void os::pd_commit_memory_or_exit(char* addr, size_t bytes,
2132                                   size_t alignment_hint, bool exec,
2133                                   const char* mesg) {
2134   assert(mesg != NULL, &quot;mesg must be specified&quot;);
2135   int err = os::Solaris::commit_memory_impl(addr, bytes, alignment_hint, exec);
2136   if (err != 0) {
2137     // the caller wants all commit errors to exit with the specified mesg:
2138     warn_fail_commit_memory(addr, bytes, alignment_hint, exec, err);
2139     vm_exit_out_of_memory(bytes, OOM_MMAP_ERROR, &quot;%s&quot;, mesg);
2140   }
2141 }
2142 
2143 // Uncommit the pages in a specified region.
2144 void os::pd_free_memory(char* addr, size_t bytes, size_t alignment_hint) {
2145   if (madvise(addr, bytes, MADV_FREE) &lt; 0) {
2146     debug_only(warning(&quot;MADV_FREE failed.&quot;));
2147     return;
2148   }
2149 }
2150 
2151 bool os::pd_create_stack_guard_pages(char* addr, size_t size) {
2152   return os::commit_memory(addr, size, !ExecMem);
2153 }
2154 
2155 bool os::remove_stack_guard_pages(char* addr, size_t size) {
2156   return os::uncommit_memory(addr, size);
2157 }
2158 
2159 // Change the page size in a given range.
2160 void os::pd_realign_memory(char *addr, size_t bytes, size_t alignment_hint) {
2161   assert((intptr_t)addr % alignment_hint == 0, &quot;Address should be aligned.&quot;);
2162   assert((intptr_t)(addr + bytes) % alignment_hint == 0, &quot;End should be aligned.&quot;);
2163   if (UseLargePages) {
2164     size_t page_size = Solaris::page_size_for_alignment(alignment_hint);
2165     if (page_size &gt; (size_t) vm_page_size()) {
2166       Solaris::setup_large_pages(addr, bytes, page_size);
2167     }
2168   }
2169 }
2170 
2171 // Tell the OS to make the range local to the first-touching LWP
2172 void os::numa_make_local(char *addr, size_t bytes, int lgrp_hint) {
2173   assert((intptr_t)addr % os::vm_page_size() == 0, &quot;Address should be page-aligned.&quot;);
2174   if (madvise(addr, bytes, MADV_ACCESS_LWP) &lt; 0) {
2175     debug_only(warning(&quot;MADV_ACCESS_LWP failed.&quot;));
2176   }
2177 }
2178 
2179 // Tell the OS that this range would be accessed from different LWPs.
2180 void os::numa_make_global(char *addr, size_t bytes) {
2181   assert((intptr_t)addr % os::vm_page_size() == 0, &quot;Address should be page-aligned.&quot;);
2182   if (madvise(addr, bytes, MADV_ACCESS_MANY) &lt; 0) {
2183     debug_only(warning(&quot;MADV_ACCESS_MANY failed.&quot;));
2184   }
2185 }
2186 
2187 // Get the number of the locality groups.
2188 size_t os::numa_get_groups_num() {
2189   size_t n = Solaris::lgrp_nlgrps(Solaris::lgrp_cookie());
2190   return n != -1 ? n : 1;
2191 }
2192 
2193 // Get a list of leaf locality groups. A leaf lgroup is group that
2194 // doesn&#39;t have any children. Typical leaf group is a CPU or a CPU/memory
2195 // board. An LWP is assigned to one of these groups upon creation.
2196 size_t os::numa_get_leaf_groups(int *ids, size_t size) {
2197   if ((ids[0] = Solaris::lgrp_root(Solaris::lgrp_cookie())) == -1) {
2198     ids[0] = 0;
2199     return 1;
2200   }
2201   int result_size = 0, top = 1, bottom = 0, cur = 0;
2202   for (int k = 0; k &lt; size; k++) {
2203     int r = Solaris::lgrp_children(Solaris::lgrp_cookie(), ids[cur],
2204                                    (Solaris::lgrp_id_t*)&amp;ids[top], size - top);
2205     if (r == -1) {
2206       ids[0] = 0;
2207       return 1;
2208     }
2209     if (!r) {
2210       // That&#39;s a leaf node.
2211       assert(bottom &lt;= cur, &quot;Sanity check&quot;);
2212       // Check if the node has memory
2213       if (Solaris::lgrp_resources(Solaris::lgrp_cookie(), ids[cur],
2214                                   NULL, 0, LGRP_RSRC_MEM) &gt; 0) {
2215         ids[bottom++] = ids[cur];
2216       }
2217     }
2218     top += r;
2219     cur++;
2220   }
2221   if (bottom == 0) {
2222     // Handle a situation, when the OS reports no memory available.
2223     // Assume UMA architecture.
2224     ids[0] = 0;
2225     return 1;
2226   }
2227   return bottom;
2228 }
2229 
2230 // Detect the topology change. Typically happens during CPU plugging-unplugging.
2231 bool os::numa_topology_changed() {
2232   int is_stale = Solaris::lgrp_cookie_stale(Solaris::lgrp_cookie());
2233   if (is_stale != -1 &amp;&amp; is_stale) {
2234     Solaris::lgrp_fini(Solaris::lgrp_cookie());
2235     Solaris::lgrp_cookie_t c = Solaris::lgrp_init(Solaris::LGRP_VIEW_CALLER);
2236     assert(c != 0, &quot;Failure to initialize LGRP API&quot;);
2237     Solaris::set_lgrp_cookie(c);
2238     return true;
2239   }
2240   return false;
2241 }
2242 
2243 // Get the group id of the current LWP.
2244 int os::numa_get_group_id() {
2245   int lgrp_id = Solaris::lgrp_home(P_LWPID, P_MYID);
2246   if (lgrp_id == -1) {
2247     return 0;
2248   }
2249   const int size = os::numa_get_groups_num();
2250   int *ids = (int*)alloca(size * sizeof(int));
2251 
2252   // Get the ids of all lgroups with memory; r is the count.
2253   int r = Solaris::lgrp_resources(Solaris::lgrp_cookie(), lgrp_id,
2254                                   (Solaris::lgrp_id_t*)ids, size, LGRP_RSRC_MEM);
2255   if (r &lt;= 0) {
2256     return 0;
2257   }
2258   return ids[os::random() % r];
2259 }
2260 
2261 int os::numa_get_group_id_for_address(const void* address) {
2262   return 0;
2263 }
2264 
2265 // Request information about the page.
2266 bool os::get_page_info(char *start, page_info* info) {
2267   const uint_t info_types[] = { MEMINFO_VLGRP, MEMINFO_VPAGESIZE };
2268   uint64_t addr = (uintptr_t)start;
2269   uint64_t outdata[2];
2270   uint_t validity = 0;
2271 
2272   if (meminfo(&amp;addr, 1, info_types, 2, outdata, &amp;validity) &lt; 0) {
2273     return false;
2274   }
2275 
2276   info-&gt;size = 0;
2277   info-&gt;lgrp_id = -1;
2278 
2279   if ((validity &amp; 1) != 0) {
2280     if ((validity &amp; 2) != 0) {
2281       info-&gt;lgrp_id = outdata[0];
2282     }
2283     if ((validity &amp; 4) != 0) {
2284       info-&gt;size = outdata[1];
2285     }
2286     return true;
2287   }
2288   return false;
2289 }
2290 
2291 // Scan the pages from start to end until a page different than
2292 // the one described in the info parameter is encountered.
2293 char *os::scan_pages(char *start, char* end, page_info* page_expected,
2294                      page_info* page_found) {
2295   const uint_t info_types[] = { MEMINFO_VLGRP, MEMINFO_VPAGESIZE };
2296   const size_t types = sizeof(info_types) / sizeof(info_types[0]);
2297   uint64_t addrs[MAX_MEMINFO_CNT], outdata[types * MAX_MEMINFO_CNT + 1];
2298   uint_t validity[MAX_MEMINFO_CNT];
2299 
2300   size_t page_size = MAX2((size_t)os::vm_page_size(), page_expected-&gt;size);
2301   uint64_t p = (uint64_t)start;
2302   while (p &lt; (uint64_t)end) {
2303     addrs[0] = p;
2304     size_t addrs_count = 1;
2305     while (addrs_count &lt; MAX_MEMINFO_CNT &amp;&amp; addrs[addrs_count - 1] + page_size &lt; (uint64_t)end) {
2306       addrs[addrs_count] = addrs[addrs_count - 1] + page_size;
2307       addrs_count++;
2308     }
2309 
2310     if (meminfo(addrs, addrs_count, info_types, types, outdata, validity) &lt; 0) {
2311       return NULL;
2312     }
2313 
2314     size_t i = 0;
2315     for (; i &lt; addrs_count; i++) {
2316       if ((validity[i] &amp; 1) != 0) {
2317         if ((validity[i] &amp; 4) != 0) {
2318           if (outdata[types * i + 1] != page_expected-&gt;size) {
2319             break;
2320           }
2321         } else if (page_expected-&gt;size != 0) {
2322           break;
2323         }
2324 
2325         if ((validity[i] &amp; 2) != 0 &amp;&amp; page_expected-&gt;lgrp_id &gt; 0) {
2326           if (outdata[types * i] != page_expected-&gt;lgrp_id) {
2327             break;
2328           }
2329         }
2330       } else {
2331         return NULL;
2332       }
2333     }
2334 
2335     if (i &lt; addrs_count) {
2336       if ((validity[i] &amp; 2) != 0) {
2337         page_found-&gt;lgrp_id = outdata[types * i];
2338       } else {
2339         page_found-&gt;lgrp_id = -1;
2340       }
2341       if ((validity[i] &amp; 4) != 0) {
2342         page_found-&gt;size = outdata[types * i + 1];
2343       } else {
2344         page_found-&gt;size = 0;
2345       }
2346       return (char*)addrs[i];
2347     }
2348 
2349     p = addrs[addrs_count - 1] + page_size;
2350   }
2351   return end;
2352 }
2353 
2354 bool os::pd_uncommit_memory(char* addr, size_t bytes) {
2355   size_t size = bytes;
2356   // Map uncommitted pages PROT_NONE so we fail early if we touch an
2357   // uncommitted page. Otherwise, the read/write might succeed if we
2358   // have enough swap space to back the physical page.
2359   return
2360     NULL != Solaris::mmap_chunk(addr, size,
2361                                 MAP_PRIVATE|MAP_FIXED|MAP_NORESERVE,
2362                                 PROT_NONE);
2363 }
2364 
2365 char* os::Solaris::mmap_chunk(char *addr, size_t size, int flags, int prot) {
2366   char *b = (char *)mmap(addr, size, prot, flags, os::Solaris::_dev_zero_fd, 0);
2367 
2368   if (b == MAP_FAILED) {
2369     return NULL;
2370   }
2371   return b;
2372 }
2373 
2374 char* os::Solaris::anon_mmap(char* requested_addr, size_t bytes,
2375                              size_t alignment_hint, bool fixed) {
2376   char* addr = requested_addr;
2377   int flags = MAP_PRIVATE | MAP_NORESERVE;
2378 
2379   assert(!(fixed &amp;&amp; (alignment_hint &gt; 0)),
2380          &quot;alignment hint meaningless with fixed mmap&quot;);
2381 
2382   if (fixed) {
2383     flags |= MAP_FIXED;
2384   } else if (alignment_hint &gt; (size_t) vm_page_size()) {
2385     flags |= MAP_ALIGN;
2386     addr = (char*) alignment_hint;
2387   }
2388 
2389   // Map uncommitted pages PROT_NONE so we fail early if we touch an
2390   // uncommitted page. Otherwise, the read/write might succeed if we
2391   // have enough swap space to back the physical page.
2392   return mmap_chunk(addr, bytes, flags, PROT_NONE);
2393 }
2394 
2395 char* os::pd_reserve_memory(size_t bytes, char* requested_addr,
2396                             size_t alignment_hint) {
2397   char* addr = Solaris::anon_mmap(requested_addr, bytes, alignment_hint,
2398                                   (requested_addr != NULL));
2399 
2400   guarantee(requested_addr == NULL || requested_addr == addr,
2401             &quot;OS failed to return requested mmap address.&quot;);
2402   return addr;
2403 }
2404 
2405 char* os::pd_attempt_reserve_memory_at(size_t bytes, char* requested_addr, int file_desc) {
2406   assert(file_desc &gt;= 0, &quot;file_desc is not valid&quot;);
2407   char* result = pd_attempt_reserve_memory_at(bytes, requested_addr);
2408   if (result != NULL) {
2409     if (replace_existing_mapping_with_file_mapping(result, bytes, file_desc) == NULL) {
2410       vm_exit_during_initialization(err_msg(&quot;Error in mapping Java heap at the given filesystem directory&quot;));
2411     }
2412   }
2413   return result;
2414 }
2415 
2416 // Reserve memory at an arbitrary address, only if that area is
2417 // available (and not reserved for something else).
2418 
2419 char* os::pd_attempt_reserve_memory_at(size_t bytes, char* requested_addr) {
2420   // Assert only that the size is a multiple of the page size, since
2421   // that&#39;s all that mmap requires, and since that&#39;s all we really know
2422   // about at this low abstraction level.  If we need higher alignment,
2423   // we can either pass an alignment to this method or verify alignment
2424   // in one of the methods further up the call chain.  See bug 5044738.
2425   assert(bytes % os::vm_page_size() == 0, &quot;reserving unexpected size block&quot;);
2426 
2427   // Since snv_84, Solaris attempts to honor the address hint - see 5003415.
2428   char* addr = Solaris::anon_mmap(requested_addr, bytes, 0, false);
2429 
2430   volatile int err = errno;
2431   if (addr == requested_addr) {
2432     return addr;
2433   }
2434 
2435   if (addr != NULL) {
2436     pd_unmap_memory(addr, bytes);
2437   }
2438 
2439   return NULL;
2440 }
2441 
2442 bool os::pd_release_memory(char* addr, size_t bytes) {
2443   size_t size = bytes;
2444   return munmap(addr, size) == 0;
2445 }
2446 
2447 static bool solaris_mprotect(char* addr, size_t bytes, int prot) {
2448   assert(addr == (char*)align_down((uintptr_t)addr, os::vm_page_size()),
2449          &quot;addr must be page aligned&quot;);
2450   Events::log(NULL, &quot;Protecting memory [&quot; INTPTR_FORMAT &quot;,&quot; INTPTR_FORMAT &quot;] with protection modes %x&quot;, p2i(addr), p2i(addr+bytes), prot);
2451   int retVal = mprotect(addr, bytes, prot);
2452   return retVal == 0;
2453 }
2454 
2455 // Protect memory (Used to pass readonly pages through
2456 // JNI GetArray&lt;type&gt;Elements with empty arrays.)
2457 // Also, used for serialization page and for compressed oops null pointer
2458 // checking.
2459 bool os::protect_memory(char* addr, size_t bytes, ProtType prot,
2460                         bool is_committed) {
2461   unsigned int p = 0;
2462   switch (prot) {
2463   case MEM_PROT_NONE: p = PROT_NONE; break;
2464   case MEM_PROT_READ: p = PROT_READ; break;
2465   case MEM_PROT_RW:   p = PROT_READ|PROT_WRITE; break;
2466   case MEM_PROT_RWX:  p = PROT_READ|PROT_WRITE|PROT_EXEC; break;
2467   default:
2468     ShouldNotReachHere();
2469   }
2470   // is_committed is unused.
2471   return solaris_mprotect(addr, bytes, p);
2472 }
2473 
2474 // guard_memory and unguard_memory only happens within stack guard pages.
2475 // Since ISM pertains only to the heap, guard and unguard memory should not
2476 /// happen with an ISM region.
2477 bool os::guard_memory(char* addr, size_t bytes) {
2478   return solaris_mprotect(addr, bytes, PROT_NONE);
2479 }
2480 
2481 bool os::unguard_memory(char* addr, size_t bytes) {
2482   return solaris_mprotect(addr, bytes, PROT_READ|PROT_WRITE);
2483 }
2484 
2485 // Large page support
2486 static size_t _large_page_size = 0;
2487 
2488 // Insertion sort for small arrays (descending order).
2489 static void insertion_sort_descending(size_t* array, int len) {
2490   for (int i = 0; i &lt; len; i++) {
2491     size_t val = array[i];
2492     for (size_t key = i; key &gt; 0 &amp;&amp; array[key - 1] &lt; val; --key) {
2493       size_t tmp = array[key];
2494       array[key] = array[key - 1];
2495       array[key - 1] = tmp;
2496     }
2497   }
2498 }
2499 
2500 bool os::Solaris::mpss_sanity_check(bool warn, size_t* page_size) {
2501   const unsigned int usable_count = VM_Version::page_size_count();
2502   if (usable_count == 1) {
2503     return false;
2504   }
2505 
2506   // Find the right getpagesizes interface.  When solaris 11 is the minimum
2507   // build platform, getpagesizes() (without the &#39;2&#39;) can be called directly.
2508   typedef int (*gps_t)(size_t[], int);
2509   gps_t gps_func = CAST_TO_FN_PTR(gps_t, dlsym(RTLD_DEFAULT, &quot;getpagesizes2&quot;));
2510   if (gps_func == NULL) {
2511     gps_func = CAST_TO_FN_PTR(gps_t, dlsym(RTLD_DEFAULT, &quot;getpagesizes&quot;));
2512     if (gps_func == NULL) {
2513       if (warn) {
2514         warning(&quot;MPSS is not supported by the operating system.&quot;);
2515       }
2516       return false;
2517     }
2518   }
2519 
2520   // Fill the array of page sizes.
2521   int n = (*gps_func)(_page_sizes, page_sizes_max);
2522   assert(n &gt; 0, &quot;Solaris bug?&quot;);
2523 
2524   if (n == page_sizes_max) {
2525     // Add a sentinel value (necessary only if the array was completely filled
2526     // since it is static (zeroed at initialization)).
2527     _page_sizes[--n] = 0;
2528     DEBUG_ONLY(warning(&quot;increase the size of the os::_page_sizes array.&quot;);)
2529   }
2530   assert(_page_sizes[n] == 0, &quot;missing sentinel&quot;);
2531   trace_page_sizes(&quot;available page sizes&quot;, _page_sizes, n);
2532 
2533   if (n == 1) return false;     // Only one page size available.
2534 
2535   // Skip sizes larger than 4M (or LargePageSizeInBytes if it was set) and
2536   // select up to usable_count elements.  First sort the array, find the first
2537   // acceptable value, then copy the usable sizes to the top of the array and
2538   // trim the rest.  Make sure to include the default page size :-).
2539   //
2540   // A better policy could get rid of the 4M limit by taking the sizes of the
2541   // important VM memory regions (java heap and possibly the code cache) into
2542   // account.
2543   insertion_sort_descending(_page_sizes, n);
2544   const size_t size_limit =
2545     FLAG_IS_DEFAULT(LargePageSizeInBytes) ? 4 * M : LargePageSizeInBytes;
2546   int beg;
2547   for (beg = 0; beg &lt; n &amp;&amp; _page_sizes[beg] &gt; size_limit; ++beg) /* empty */;
2548   const int end = MIN2((int)usable_count, n) - 1;
2549   for (int cur = 0; cur &lt; end; ++cur, ++beg) {
2550     _page_sizes[cur] = _page_sizes[beg];
2551   }
2552   _page_sizes[end] = vm_page_size();
2553   _page_sizes[end + 1] = 0;
2554 
2555   if (_page_sizes[end] &gt; _page_sizes[end - 1]) {
2556     // Default page size is not the smallest; sort again.
2557     insertion_sort_descending(_page_sizes, end + 1);
2558   }
2559   *page_size = _page_sizes[0];
2560 
2561   trace_page_sizes(&quot;usable page sizes&quot;, _page_sizes, end + 1);
2562   return true;
2563 }
2564 
2565 void os::large_page_init() {
2566   if (UseLargePages) {
2567     // print a warning if any large page related flag is specified on command line
2568     bool warn_on_failure = !FLAG_IS_DEFAULT(UseLargePages)        ||
2569                            !FLAG_IS_DEFAULT(LargePageSizeInBytes);
2570 
2571     UseLargePages = Solaris::mpss_sanity_check(warn_on_failure, &amp;_large_page_size);
2572   }
2573 }
2574 
2575 bool os::Solaris::is_valid_page_size(size_t bytes) {
2576   for (int i = 0; _page_sizes[i] != 0; i++) {
2577     if (_page_sizes[i] == bytes) {
2578       return true;
2579     }
2580   }
2581   return false;
2582 }
2583 
2584 bool os::Solaris::setup_large_pages(caddr_t start, size_t bytes, size_t align) {
2585   assert(is_valid_page_size(align), SIZE_FORMAT &quot; is not a valid page size&quot;, align);
2586   assert(is_aligned((void*) start, align),
2587          PTR_FORMAT &quot; is not aligned to &quot; SIZE_FORMAT, p2i((void*) start), align);
2588   assert(is_aligned(bytes, align),
2589          SIZE_FORMAT &quot; is not aligned to &quot; SIZE_FORMAT, bytes, align);
2590 
2591   // Signal to OS that we want large pages for addresses
2592   // from addr, addr + bytes
2593   struct memcntl_mha mpss_struct;
2594   mpss_struct.mha_cmd = MHA_MAPSIZE_VA;
2595   mpss_struct.mha_pagesize = align;
2596   mpss_struct.mha_flags = 0;
2597   // Upon successful completion, memcntl() returns 0
2598   if (memcntl(start, bytes, MC_HAT_ADVISE, (caddr_t) &amp;mpss_struct, 0, 0)) {
2599     debug_only(warning(&quot;Attempt to use MPSS failed.&quot;));
2600     return false;
2601   }
2602   return true;
2603 }
2604 
2605 char* os::pd_reserve_memory_special(size_t size, size_t alignment, char* addr, bool exec) {
2606   fatal(&quot;os::reserve_memory_special should not be called on Solaris.&quot;);
2607   return NULL;
2608 }
2609 
2610 bool os::pd_release_memory_special(char* base, size_t bytes) {
2611   fatal(&quot;os::release_memory_special should not be called on Solaris.&quot;);
2612   return false;
2613 }
2614 
2615 size_t os::large_page_size() {
2616   return _large_page_size;
2617 }
2618 
2619 // MPSS allows application to commit large page memory on demand; with ISM
2620 // the entire memory region must be allocated as shared memory.
2621 bool os::can_commit_large_page_memory() {
2622   return true;
2623 }
2624 
2625 bool os::can_execute_large_page_memory() {
2626   return true;
2627 }
2628 
2629 // Sleep forever; naked call to OS-specific sleep; use with CAUTION
2630 void os::infinite_sleep() {
2631   while (true) {    // sleep forever ...
2632     ::sleep(100);   // ... 100 seconds at a time
2633   }
2634 }
2635 
2636 // Used to convert frequent JVM_Yield() to nops
2637 bool os::dont_yield() {
2638   if (DontYieldALot) {
2639     static hrtime_t last_time = 0;
2640     hrtime_t diff = getTimeNanos() - last_time;
2641 
2642     if (diff &lt; DontYieldALotInterval * 1000000) {
2643       return true;
2644     }
2645 
2646     last_time += diff;
2647 
2648     return false;
2649   } else {
2650     return false;
2651   }
2652 }
2653 
2654 // Note that yield semantics are defined by the scheduling class to which
2655 // the thread currently belongs.  Typically, yield will _not yield to
2656 // other equal or higher priority threads that reside on the dispatch queues
2657 // of other CPUs.
2658 
2659 void os::naked_yield() {
2660   thr_yield();
2661 }
2662 
2663 // Interface for setting lwp priorities.  We are using T2 libthread,
2664 // which forces the use of bound threads, so all of our threads will
2665 // be assigned to real lwp&#39;s.  Using the thr_setprio function is
2666 // meaningless in this mode so we must adjust the real lwp&#39;s priority.
2667 // The routines below implement the getting and setting of lwp priorities.
2668 //
2669 // Note: There are three priority scales used on Solaris.  Java priotities
2670 //       which range from 1 to 10, libthread &quot;thr_setprio&quot; scale which range
2671 //       from 0 to 127, and the current scheduling class of the process we
2672 //       are running in.  This is typically from -60 to +60.
2673 //       The setting of the lwp priorities in done after a call to thr_setprio
2674 //       so Java priorities are mapped to libthread priorities and we map from
2675 //       the latter to lwp priorities.  We don&#39;t keep priorities stored in
2676 //       Java priorities since some of our worker threads want to set priorities
2677 //       higher than all Java threads.
2678 //
2679 // For related information:
2680 // (1)  man -s 2 priocntl
2681 // (2)  man -s 4 priocntl
2682 // (3)  man dispadmin
2683 // =    librt.so
2684 // =    libthread/common/rtsched.c - thrp_setlwpprio().
2685 // =    ps -cL &lt;pid&gt; ... to validate priority.
2686 // =    sched_get_priority_min and _max
2687 //              pthread_create
2688 //              sched_setparam
2689 //              pthread_setschedparam
2690 //
2691 // Assumptions:
2692 // +    We assume that all threads in the process belong to the same
2693 //              scheduling class.   IE. an homogenous process.
2694 // +    Must be root or in IA group to change change &quot;interactive&quot; attribute.
2695 //              Priocntl() will fail silently.  The only indication of failure is when
2696 //              we read-back the value and notice that it hasn&#39;t changed.
2697 // +    Interactive threads enter the runq at the head, non-interactive at the tail.
2698 // +    For RT, change timeslice as well.  Invariant:
2699 //              constant &quot;priority integral&quot;
2700 //              Konst == TimeSlice * (60-Priority)
2701 //              Given a priority, compute appropriate timeslice.
2702 // +    Higher numerical values have higher priority.
2703 
2704 // sched class attributes
2705 typedef struct {
2706   int   schedPolicy;              // classID
2707   int   maxPrio;
2708   int   minPrio;
2709 } SchedInfo;
2710 
2711 
2712 static SchedInfo tsLimits, iaLimits, rtLimits, fxLimits;
2713 
2714 #ifdef ASSERT
2715 static int  ReadBackValidate = 1;
2716 #endif
2717 static int  myClass     = 0;
2718 static int  myMin       = 0;
2719 static int  myMax       = 0;
2720 static int  myCur       = 0;
2721 static bool priocntl_enable = false;
2722 
2723 static const int criticalPrio = FXCriticalPriority;
2724 static int java_MaxPriority_to_os_priority = 0; // Saved mapping
2725 
2726 
2727 // lwp_priocntl_init
2728 //
2729 // Try to determine the priority scale for our process.
2730 //
2731 // Return errno or 0 if OK.
2732 //
2733 static int lwp_priocntl_init() {
2734   int rslt;
2735   pcinfo_t ClassInfo;
2736   pcparms_t ParmInfo;
2737   int i;
2738 
2739   if (!UseThreadPriorities) return 0;
2740 
2741   // If ThreadPriorityPolicy is 1, switch tables
2742   if (ThreadPriorityPolicy == 1) {
2743     for (i = 0; i &lt; CriticalPriority+1; i++)
2744       os::java_to_os_priority[i] = prio_policy1[i];
2745   }
2746   if (UseCriticalJavaThreadPriority) {
2747     // MaxPriority always maps to the FX scheduling class and criticalPrio.
2748     // See set_native_priority() and set_lwp_class_and_priority().
2749     // Save original MaxPriority mapping in case attempt to
2750     // use critical priority fails.
2751     java_MaxPriority_to_os_priority = os::java_to_os_priority[MaxPriority];
2752     // Set negative to distinguish from other priorities
2753     os::java_to_os_priority[MaxPriority] = -criticalPrio;
2754   }
2755 
2756   // Get IDs for a set of well-known scheduling classes.
2757   // TODO-FIXME: GETCLINFO returns the current # of classes in the
2758   // the system.  We should have a loop that iterates over the
2759   // classID values, which are known to be &quot;small&quot; integers.
2760 
2761   strcpy(ClassInfo.pc_clname, &quot;TS&quot;);
2762   ClassInfo.pc_cid = -1;
2763   rslt = priocntl(P_ALL, 0, PC_GETCID, (caddr_t)&amp;ClassInfo);
2764   if (rslt &lt; 0) return errno;
2765   assert(ClassInfo.pc_cid != -1, &quot;cid for TS class is -1&quot;);
2766   tsLimits.schedPolicy = ClassInfo.pc_cid;
2767   tsLimits.maxPrio = ((tsinfo_t*)ClassInfo.pc_clinfo)-&gt;ts_maxupri;
2768   tsLimits.minPrio = -tsLimits.maxPrio;
2769 
2770   strcpy(ClassInfo.pc_clname, &quot;IA&quot;);
2771   ClassInfo.pc_cid = -1;
2772   rslt = priocntl(P_ALL, 0, PC_GETCID, (caddr_t)&amp;ClassInfo);
2773   if (rslt &lt; 0) return errno;
2774   assert(ClassInfo.pc_cid != -1, &quot;cid for IA class is -1&quot;);
2775   iaLimits.schedPolicy = ClassInfo.pc_cid;
2776   iaLimits.maxPrio = ((iainfo_t*)ClassInfo.pc_clinfo)-&gt;ia_maxupri;
2777   iaLimits.minPrio = -iaLimits.maxPrio;
2778 
2779   strcpy(ClassInfo.pc_clname, &quot;RT&quot;);
2780   ClassInfo.pc_cid = -1;
2781   rslt = priocntl(P_ALL, 0, PC_GETCID, (caddr_t)&amp;ClassInfo);
2782   if (rslt &lt; 0) return errno;
2783   assert(ClassInfo.pc_cid != -1, &quot;cid for RT class is -1&quot;);
2784   rtLimits.schedPolicy = ClassInfo.pc_cid;
2785   rtLimits.maxPrio = ((rtinfo_t*)ClassInfo.pc_clinfo)-&gt;rt_maxpri;
2786   rtLimits.minPrio = 0;
2787 
2788   strcpy(ClassInfo.pc_clname, &quot;FX&quot;);
2789   ClassInfo.pc_cid = -1;
2790   rslt = priocntl(P_ALL, 0, PC_GETCID, (caddr_t)&amp;ClassInfo);
2791   if (rslt &lt; 0) return errno;
2792   assert(ClassInfo.pc_cid != -1, &quot;cid for FX class is -1&quot;);
2793   fxLimits.schedPolicy = ClassInfo.pc_cid;
2794   fxLimits.maxPrio = ((fxinfo_t*)ClassInfo.pc_clinfo)-&gt;fx_maxupri;
2795   fxLimits.minPrio = 0;
2796 
2797   // Query our &quot;current&quot; scheduling class.
2798   // This will normally be IA, TS or, rarely, FX or RT.
2799   memset(&amp;ParmInfo, 0, sizeof(ParmInfo));
2800   ParmInfo.pc_cid = PC_CLNULL;
2801   rslt = priocntl(P_PID, P_MYID, PC_GETPARMS, (caddr_t)&amp;ParmInfo);
2802   if (rslt &lt; 0) return errno;
2803   myClass = ParmInfo.pc_cid;
2804 
2805   // We now know our scheduling classId, get specific information
2806   // about the class.
2807   ClassInfo.pc_cid = myClass;
2808   ClassInfo.pc_clname[0] = 0;
2809   rslt = priocntl((idtype)0, 0, PC_GETCLINFO, (caddr_t)&amp;ClassInfo);
2810   if (rslt &lt; 0) return errno;
2811 
2812   if (ThreadPriorityVerbose) {
2813     tty-&gt;print_cr(&quot;lwp_priocntl_init: Class=%d(%s)...&quot;, myClass, ClassInfo.pc_clname);
2814   }
2815 
2816   memset(&amp;ParmInfo, 0, sizeof(pcparms_t));
2817   ParmInfo.pc_cid = PC_CLNULL;
2818   rslt = priocntl(P_PID, P_MYID, PC_GETPARMS, (caddr_t)&amp;ParmInfo);
2819   if (rslt &lt; 0) return errno;
2820 
2821   if (ParmInfo.pc_cid == rtLimits.schedPolicy) {
2822     myMin = rtLimits.minPrio;
2823     myMax = rtLimits.maxPrio;
2824   } else if (ParmInfo.pc_cid == iaLimits.schedPolicy) {
2825     iaparms_t *iaInfo  = (iaparms_t*)ParmInfo.pc_clparms;
2826     myMin = iaLimits.minPrio;
2827     myMax = iaLimits.maxPrio;
2828     myMax = MIN2(myMax, (int)iaInfo-&gt;ia_uprilim);       // clamp - restrict
2829   } else if (ParmInfo.pc_cid == tsLimits.schedPolicy) {
2830     tsparms_t *tsInfo  = (tsparms_t*)ParmInfo.pc_clparms;
2831     myMin = tsLimits.minPrio;
2832     myMax = tsLimits.maxPrio;
2833     myMax = MIN2(myMax, (int)tsInfo-&gt;ts_uprilim);       // clamp - restrict
2834   } else if (ParmInfo.pc_cid == fxLimits.schedPolicy) {
2835     fxparms_t *fxInfo = (fxparms_t*)ParmInfo.pc_clparms;
2836     myMin = fxLimits.minPrio;
2837     myMax = fxLimits.maxPrio;
2838     myMax = MIN2(myMax, (int)fxInfo-&gt;fx_uprilim);       // clamp - restrict
2839   } else {
2840     // No clue - punt
2841     if (ThreadPriorityVerbose) {
2842       tty-&gt;print_cr(&quot;Unknown scheduling class: %s ... \n&quot;,
2843                     ClassInfo.pc_clname);
2844     }
2845     return EINVAL;      // no clue, punt
2846   }
2847 
2848   if (ThreadPriorityVerbose) {
2849     tty-&gt;print_cr(&quot;Thread priority Range: [%d..%d]\n&quot;, myMin, myMax);
2850   }
2851 
2852   priocntl_enable = true;  // Enable changing priorities
2853   return 0;
2854 }
2855 
2856 #define IAPRI(x)        ((iaparms_t *)((x).pc_clparms))
2857 #define RTPRI(x)        ((rtparms_t *)((x).pc_clparms))
2858 #define TSPRI(x)        ((tsparms_t *)((x).pc_clparms))
2859 #define FXPRI(x)        ((fxparms_t *)((x).pc_clparms))
2860 
2861 
2862 // scale_to_lwp_priority
2863 //
2864 // Convert from the libthread &quot;thr_setprio&quot; scale to our current
2865 // lwp scheduling class scale.
2866 //
2867 static int scale_to_lwp_priority(int rMin, int rMax, int x) {
2868   int v;
2869 
2870   if (x == 127) return rMax;            // avoid round-down
2871   v = (((x*(rMax-rMin)))/128)+rMin;
2872   return v;
2873 }
2874 
2875 
2876 // set_lwp_class_and_priority
2877 int set_lwp_class_and_priority(int ThreadID, int lwpid,
2878                                int newPrio, int new_class, bool scale) {
2879   int rslt;
2880   int Actual, Expected, prv;
2881   pcparms_t ParmInfo;                   // for GET-SET
2882 #ifdef ASSERT
2883   pcparms_t ReadBack;                   // for readback
2884 #endif
2885 
2886   // Set priority via PC_GETPARMS, update, PC_SETPARMS
2887   // Query current values.
2888   // TODO: accelerate this by eliminating the PC_GETPARMS call.
2889   // Cache &quot;pcparms_t&quot; in global ParmCache.
2890   // TODO: elide set-to-same-value
2891 
2892   // If something went wrong on init, don&#39;t change priorities.
2893   if (!priocntl_enable) {
2894     if (ThreadPriorityVerbose) {
2895       tty-&gt;print_cr(&quot;Trying to set priority but init failed, ignoring&quot;);
2896     }
2897     return EINVAL;
2898   }
2899 
2900   // If lwp hasn&#39;t started yet, just return
2901   // the _start routine will call us again.
2902   if (lwpid &lt;= 0) {
2903     if (ThreadPriorityVerbose) {
2904       tty-&gt;print_cr(&quot;deferring the set_lwp_class_and_priority of thread &quot;
2905                     INTPTR_FORMAT &quot; to %d, lwpid not set&quot;,
2906                     ThreadID, newPrio);
2907     }
2908     return 0;
2909   }
2910 
2911   if (ThreadPriorityVerbose) {
2912     tty-&gt;print_cr (&quot;set_lwp_class_and_priority(&quot;
2913                    INTPTR_FORMAT &quot;@&quot; INTPTR_FORMAT &quot; %d) &quot;,
2914                    ThreadID, lwpid, newPrio);
2915   }
2916 
2917   memset(&amp;ParmInfo, 0, sizeof(pcparms_t));
2918   ParmInfo.pc_cid = PC_CLNULL;
2919   rslt = priocntl(P_LWPID, lwpid, PC_GETPARMS, (caddr_t)&amp;ParmInfo);
2920   if (rslt &lt; 0) return errno;
2921 
2922   int cur_class = ParmInfo.pc_cid;
2923   ParmInfo.pc_cid = (id_t)new_class;
2924 
2925   if (new_class == rtLimits.schedPolicy) {
2926     rtparms_t *rtInfo  = (rtparms_t*)ParmInfo.pc_clparms;
2927     rtInfo-&gt;rt_pri     = scale ? scale_to_lwp_priority(rtLimits.minPrio,
2928                                                        rtLimits.maxPrio, newPrio)
2929                                : newPrio;
2930     rtInfo-&gt;rt_tqsecs  = RT_NOCHANGE;
2931     rtInfo-&gt;rt_tqnsecs = RT_NOCHANGE;
2932     if (ThreadPriorityVerbose) {
2933       tty-&gt;print_cr(&quot;RT: %d-&gt;%d\n&quot;, newPrio, rtInfo-&gt;rt_pri);
2934     }
2935   } else if (new_class == iaLimits.schedPolicy) {
2936     iaparms_t* iaInfo  = (iaparms_t*)ParmInfo.pc_clparms;
2937     int maxClamped     = MIN2(iaLimits.maxPrio,
2938                               cur_class == new_class
2939                               ? (int)iaInfo-&gt;ia_uprilim : iaLimits.maxPrio);
2940     iaInfo-&gt;ia_upri    = scale ? scale_to_lwp_priority(iaLimits.minPrio,
2941                                                        maxClamped, newPrio)
2942                                : newPrio;
2943     iaInfo-&gt;ia_uprilim = cur_class == new_class
2944                            ? IA_NOCHANGE : (pri_t)iaLimits.maxPrio;
2945     iaInfo-&gt;ia_mode    = IA_NOCHANGE;
2946     if (ThreadPriorityVerbose) {
2947       tty-&gt;print_cr(&quot;IA: [%d...%d] %d-&gt;%d\n&quot;,
2948                     iaLimits.minPrio, maxClamped, newPrio, iaInfo-&gt;ia_upri);
2949     }
2950   } else if (new_class == tsLimits.schedPolicy) {
2951     tsparms_t* tsInfo  = (tsparms_t*)ParmInfo.pc_clparms;
2952     int maxClamped     = MIN2(tsLimits.maxPrio,
2953                               cur_class == new_class
2954                               ? (int)tsInfo-&gt;ts_uprilim : tsLimits.maxPrio);
2955     tsInfo-&gt;ts_upri    = scale ? scale_to_lwp_priority(tsLimits.minPrio,
2956                                                        maxClamped, newPrio)
2957                                : newPrio;
2958     tsInfo-&gt;ts_uprilim = cur_class == new_class
2959                            ? TS_NOCHANGE : (pri_t)tsLimits.maxPrio;
2960     if (ThreadPriorityVerbose) {
2961       tty-&gt;print_cr(&quot;TS: [%d...%d] %d-&gt;%d\n&quot;,
2962                     tsLimits.minPrio, maxClamped, newPrio, tsInfo-&gt;ts_upri);
2963     }
2964   } else if (new_class == fxLimits.schedPolicy) {
2965     fxparms_t* fxInfo  = (fxparms_t*)ParmInfo.pc_clparms;
2966     int maxClamped     = MIN2(fxLimits.maxPrio,
2967                               cur_class == new_class
2968                               ? (int)fxInfo-&gt;fx_uprilim : fxLimits.maxPrio);
2969     fxInfo-&gt;fx_upri    = scale ? scale_to_lwp_priority(fxLimits.minPrio,
2970                                                        maxClamped, newPrio)
2971                                : newPrio;
2972     fxInfo-&gt;fx_uprilim = cur_class == new_class
2973                            ? FX_NOCHANGE : (pri_t)fxLimits.maxPrio;
2974     fxInfo-&gt;fx_tqsecs  = FX_NOCHANGE;
2975     fxInfo-&gt;fx_tqnsecs = FX_NOCHANGE;
2976     if (ThreadPriorityVerbose) {
2977       tty-&gt;print_cr(&quot;FX: [%d...%d] %d-&gt;%d\n&quot;,
2978                     fxLimits.minPrio, maxClamped, newPrio, fxInfo-&gt;fx_upri);
2979     }
2980   } else {
2981     if (ThreadPriorityVerbose) {
2982       tty-&gt;print_cr(&quot;Unknown new scheduling class %d\n&quot;, new_class);
2983     }
2984     return EINVAL;    // no clue, punt
2985   }
2986 
2987   rslt = priocntl(P_LWPID, lwpid, PC_SETPARMS, (caddr_t)&amp;ParmInfo);
2988   if (ThreadPriorityVerbose &amp;&amp; rslt) {
2989     tty-&gt;print_cr (&quot;PC_SETPARMS -&gt;%d %d\n&quot;, rslt, errno);
2990   }
2991   if (rslt &lt; 0) return errno;
2992 
2993 #ifdef ASSERT
2994   // Sanity check: read back what we just attempted to set.
2995   // In theory it could have changed in the interim ...
2996   //
2997   // The priocntl system call is tricky.
2998   // Sometimes it&#39;ll validate the priority value argument and
2999   // return EINVAL if unhappy.  At other times it fails silently.
3000   // Readbacks are prudent.
3001 
3002   if (!ReadBackValidate) return 0;
3003 
3004   memset(&amp;ReadBack, 0, sizeof(pcparms_t));
3005   ReadBack.pc_cid = PC_CLNULL;
3006   rslt = priocntl(P_LWPID, lwpid, PC_GETPARMS, (caddr_t)&amp;ReadBack);
3007   assert(rslt &gt;= 0, &quot;priocntl failed&quot;);
3008   Actual = Expected = 0xBAD;
3009   assert(ParmInfo.pc_cid == ReadBack.pc_cid, &quot;cid&#39;s don&#39;t match&quot;);
3010   if (ParmInfo.pc_cid == rtLimits.schedPolicy) {
3011     Actual   = RTPRI(ReadBack)-&gt;rt_pri;
3012     Expected = RTPRI(ParmInfo)-&gt;rt_pri;
3013   } else if (ParmInfo.pc_cid == iaLimits.schedPolicy) {
3014     Actual   = IAPRI(ReadBack)-&gt;ia_upri;
3015     Expected = IAPRI(ParmInfo)-&gt;ia_upri;
3016   } else if (ParmInfo.pc_cid == tsLimits.schedPolicy) {
3017     Actual   = TSPRI(ReadBack)-&gt;ts_upri;
3018     Expected = TSPRI(ParmInfo)-&gt;ts_upri;
3019   } else if (ParmInfo.pc_cid == fxLimits.schedPolicy) {
3020     Actual   = FXPRI(ReadBack)-&gt;fx_upri;
3021     Expected = FXPRI(ParmInfo)-&gt;fx_upri;
3022   } else {
3023     if (ThreadPriorityVerbose) {
3024       tty-&gt;print_cr(&quot;set_lwp_class_and_priority: unexpected class in readback: %d\n&quot;,
3025                     ParmInfo.pc_cid);
3026     }
3027   }
3028 
3029   if (Actual != Expected) {
3030     if (ThreadPriorityVerbose) {
3031       tty-&gt;print_cr (&quot;set_lwp_class_and_priority(%d %d) Class=%d: actual=%d vs expected=%d\n&quot;,
3032                      lwpid, newPrio, ReadBack.pc_cid, Actual, Expected);
3033     }
3034   }
3035 #endif
3036 
3037   return 0;
3038 }
3039 
3040 // Solaris only gives access to 128 real priorities at a time,
3041 // so we expand Java&#39;s ten to fill this range.  This would be better
3042 // if we dynamically adjusted relative priorities.
3043 //
3044 // The ThreadPriorityPolicy option allows us to select 2 different
3045 // priority scales.
3046 //
3047 // ThreadPriorityPolicy=0
3048 // Since the Solaris&#39; default priority is MaximumPriority, we do not
3049 // set a priority lower than Max unless a priority lower than
3050 // NormPriority is requested.
3051 //
3052 // ThreadPriorityPolicy=1
3053 // This mode causes the priority table to get filled with
3054 // linear values.  NormPriority get&#39;s mapped to 50% of the
3055 // Maximum priority an so on.  This will cause VM threads
3056 // to get unfair treatment against other Solaris processes
3057 // which do not explicitly alter their thread priorities.
3058 
3059 int os::java_to_os_priority[CriticalPriority + 1] = {
3060   -99999,         // 0 Entry should never be used
3061 
3062   0,              // 1 MinPriority
3063   32,             // 2
3064   64,             // 3
3065 
3066   96,             // 4
3067   127,            // 5 NormPriority
3068   127,            // 6
3069 
3070   127,            // 7
3071   127,            // 8
3072   127,            // 9 NearMaxPriority
3073 
3074   127,            // 10 MaxPriority
3075 
3076   -criticalPrio   // 11 CriticalPriority
3077 };
3078 
3079 OSReturn os::set_native_priority(Thread* thread, int newpri) {
3080   OSThread* osthread = thread-&gt;osthread();
3081 
3082   // Save requested priority in case the thread hasn&#39;t been started
3083   osthread-&gt;set_native_priority(newpri);
3084 
3085   // Check for critical priority request
3086   bool fxcritical = false;
3087   if (newpri == -criticalPrio) {
3088     fxcritical = true;
3089     newpri = criticalPrio;
3090   }
3091 
3092   assert(newpri &gt;= MinimumPriority &amp;&amp; newpri &lt;= MaximumPriority, &quot;bad priority mapping&quot;);
3093   if (!UseThreadPriorities) return OS_OK;
3094 
3095   int status = 0;
3096 
3097   if (!fxcritical) {
3098     // Use thr_setprio only if we have a priority that thr_setprio understands
3099     status = thr_setprio(thread-&gt;osthread()-&gt;thread_id(), newpri);
3100   }
3101 
3102   int lwp_status =
3103           set_lwp_class_and_priority(osthread-&gt;thread_id(),
3104                                      osthread-&gt;lwp_id(),
3105                                      newpri,
3106                                      fxcritical ? fxLimits.schedPolicy : myClass,
3107                                      !fxcritical);
3108   if (lwp_status != 0 &amp;&amp; fxcritical) {
3109     // Try again, this time without changing the scheduling class
3110     newpri = java_MaxPriority_to_os_priority;
3111     lwp_status = set_lwp_class_and_priority(osthread-&gt;thread_id(),
3112                                             osthread-&gt;lwp_id(),
3113                                             newpri, myClass, false);
3114   }
3115   status |= lwp_status;
3116   return (status == 0) ? OS_OK : OS_ERR;
3117 }
3118 
3119 
3120 OSReturn os::get_native_priority(const Thread* const thread,
3121                                  int *priority_ptr) {
3122   int p;
3123   if (!UseThreadPriorities) {
3124     *priority_ptr = NormalPriority;
3125     return OS_OK;
3126   }
3127   int status = thr_getprio(thread-&gt;osthread()-&gt;thread_id(), &amp;p);
3128   if (status != 0) {
3129     return OS_ERR;
3130   }
3131   *priority_ptr = p;
3132   return OS_OK;
3133 }
3134 
3135 ////////////////////////////////////////////////////////////////////////////////
3136 // suspend/resume support
3137 
3138 //  The low-level signal-based suspend/resume support is a remnant from the
3139 //  old VM-suspension that used to be for java-suspension, safepoints etc,
3140 //  within hotspot. Currently used by JFR&#39;s OSThreadSampler
3141 //
3142 //  The remaining code is greatly simplified from the more general suspension
3143 //  code that used to be used.
3144 //
3145 //  The protocol is quite simple:
3146 //  - suspend:
3147 //      - sends a signal to the target thread
3148 //      - polls the suspend state of the osthread using a yield loop
3149 //      - target thread signal handler (SR_handler) sets suspend state
3150 //        and blocks in sigsuspend until continued
3151 //  - resume:
3152 //      - sets target osthread state to continue
3153 //      - sends signal to end the sigsuspend loop in the SR_handler
3154 //
3155 //  Note that the SR_lock plays no role in this suspend/resume protocol,
3156 //  but is checked for NULL in SR_handler as a thread termination indicator.
3157 //  The SR_lock is, however, used by JavaThread::java_suspend()/java_resume() APIs.
3158 //
3159 //  Note that resume_clear_context() and suspend_save_context() are needed
3160 //  by SR_handler(), so that fetch_frame_from_ucontext() works,
3161 //  which in part is used by:
3162 //    - Forte Analyzer: AsyncGetCallTrace()
3163 //    - StackBanging: get_frame_at_stack_banging_point()
3164 //    - JFR: get_topframe()--&gt;....--&gt;get_valid_uc_in_signal_handler()
3165 
3166 static void resume_clear_context(OSThread *osthread) {
3167   osthread-&gt;set_ucontext(NULL);
3168 }
3169 
3170 static void suspend_save_context(OSThread *osthread, ucontext_t* context) {
3171   osthread-&gt;set_ucontext(context);
3172 }
3173 
3174 static PosixSemaphore sr_semaphore;
3175 
3176 void os::Solaris::SR_handler(Thread* thread, ucontext_t* context) {
3177   // Save and restore errno to avoid confusing native code with EINTR
3178   // after sigsuspend.
3179   int old_errno = errno;
3180 
3181   OSThread* osthread = thread-&gt;osthread();
3182   assert(thread-&gt;is_VM_thread() || thread-&gt;is_Java_thread(), &quot;Must be VMThread or JavaThread&quot;);
3183 
3184   os::SuspendResume::State current = osthread-&gt;sr.state();
3185   if (current == os::SuspendResume::SR_SUSPEND_REQUEST) {
3186     suspend_save_context(osthread, context);
3187 
3188     // attempt to switch the state, we assume we had a SUSPEND_REQUEST
3189     os::SuspendResume::State state = osthread-&gt;sr.suspended();
3190     if (state == os::SuspendResume::SR_SUSPENDED) {
3191       sigset_t suspend_set;  // signals for sigsuspend()
3192 
3193       // get current set of blocked signals and unblock resume signal
3194       pthread_sigmask(SIG_BLOCK, NULL, &amp;suspend_set);
3195       sigdelset(&amp;suspend_set, ASYNC_SIGNAL);
3196 
3197       sr_semaphore.signal();
3198       // wait here until we are resumed
3199       while (1) {
3200         sigsuspend(&amp;suspend_set);
3201 
3202         os::SuspendResume::State result = osthread-&gt;sr.running();
3203         if (result == os::SuspendResume::SR_RUNNING) {
3204           sr_semaphore.signal();
3205           break;
3206         }
3207       }
3208 
3209     } else if (state == os::SuspendResume::SR_RUNNING) {
3210       // request was cancelled, continue
3211     } else {
3212       ShouldNotReachHere();
3213     }
3214 
3215     resume_clear_context(osthread);
3216   } else if (current == os::SuspendResume::SR_RUNNING) {
3217     // request was cancelled, continue
3218   } else if (current == os::SuspendResume::SR_WAKEUP_REQUEST) {
3219     // ignore
3220   } else {
3221     // ignore
3222   }
3223 
3224   errno = old_errno;
3225 }
3226 
3227 void os::print_statistics() {
3228 }
3229 
3230 bool os::message_box(const char* title, const char* message) {
3231   int i;
3232   fdStream err(defaultStream::error_fd());
3233   for (i = 0; i &lt; 78; i++) err.print_raw(&quot;=&quot;);
3234   err.cr();
3235   err.print_raw_cr(title);
3236   for (i = 0; i &lt; 78; i++) err.print_raw(&quot;-&quot;);
3237   err.cr();
3238   err.print_raw_cr(message);
3239   for (i = 0; i &lt; 78; i++) err.print_raw(&quot;=&quot;);
3240   err.cr();
3241 
3242   char buf[16];
3243   // Prevent process from exiting upon &quot;read error&quot; without consuming all CPU
3244   while (::read(0, buf, sizeof(buf)) &lt;= 0) { ::sleep(100); }
3245 
3246   return buf[0] == &#39;y&#39; || buf[0] == &#39;Y&#39;;
3247 }
3248 
3249 static int sr_notify(OSThread* osthread) {
3250   int status = thr_kill(osthread-&gt;thread_id(), ASYNC_SIGNAL);
3251   assert_status(status == 0, status, &quot;thr_kill&quot;);
3252   return status;
3253 }
3254 
3255 // &quot;Randomly&quot; selected value for how long we want to spin
3256 // before bailing out on suspending a thread, also how often
3257 // we send a signal to a thread we want to resume
3258 static const int RANDOMLY_LARGE_INTEGER = 1000000;
3259 static const int RANDOMLY_LARGE_INTEGER2 = 100;
3260 
3261 static bool do_suspend(OSThread* osthread) {
3262   assert(osthread-&gt;sr.is_running(), &quot;thread should be running&quot;);
3263   assert(!sr_semaphore.trywait(), &quot;semaphore has invalid state&quot;);
3264 
3265   // mark as suspended and send signal
3266   if (osthread-&gt;sr.request_suspend() != os::SuspendResume::SR_SUSPEND_REQUEST) {
3267     // failed to switch, state wasn&#39;t running?
3268     ShouldNotReachHere();
3269     return false;
3270   }
3271 
3272   if (sr_notify(osthread) != 0) {
3273     ShouldNotReachHere();
3274   }
3275 
3276   // managed to send the signal and switch to SUSPEND_REQUEST, now wait for SUSPENDED
3277   while (true) {
3278     if (sr_semaphore.timedwait(2000)) {
3279       break;
3280     } else {
3281       // timeout
3282       os::SuspendResume::State cancelled = osthread-&gt;sr.cancel_suspend();
3283       if (cancelled == os::SuspendResume::SR_RUNNING) {
3284         return false;
3285       } else if (cancelled == os::SuspendResume::SR_SUSPENDED) {
3286         // make sure that we consume the signal on the semaphore as well
3287         sr_semaphore.wait();
3288         break;
3289       } else {
3290         ShouldNotReachHere();
3291         return false;
3292       }
3293     }
3294   }
3295 
3296   guarantee(osthread-&gt;sr.is_suspended(), &quot;Must be suspended&quot;);
3297   return true;
3298 }
3299 
3300 static void do_resume(OSThread* osthread) {
3301   assert(osthread-&gt;sr.is_suspended(), &quot;thread should be suspended&quot;);
3302   assert(!sr_semaphore.trywait(), &quot;invalid semaphore state&quot;);
3303 
3304   if (osthread-&gt;sr.request_wakeup() != os::SuspendResume::SR_WAKEUP_REQUEST) {
3305     // failed to switch to WAKEUP_REQUEST
3306     ShouldNotReachHere();
3307     return;
3308   }
3309 
3310   while (true) {
3311     if (sr_notify(osthread) == 0) {
3312       if (sr_semaphore.timedwait(2)) {
3313         if (osthread-&gt;sr.is_running()) {
3314           return;
3315         }
3316       }
3317     } else {
3318       ShouldNotReachHere();
3319     }
3320   }
3321 
3322   guarantee(osthread-&gt;sr.is_running(), &quot;Must be running!&quot;);
3323 }
3324 
3325 void os::SuspendedThreadTask::internal_do_task() {
3326   if (do_suspend(_thread-&gt;osthread())) {
3327     SuspendedThreadTaskContext context(_thread, _thread-&gt;osthread()-&gt;ucontext());
3328     do_task(context);
3329     do_resume(_thread-&gt;osthread());
3330   }
3331 }
3332 
3333 // This does not do anything on Solaris. This is basically a hook for being
3334 // able to use structured exception handling (thread-local exception filters) on, e.g., Win32.
3335 void os::os_exception_wrapper(java_call_t f, JavaValue* value,
3336                               const methodHandle&amp; method, JavaCallArguments* args,
3337                               Thread* thread) {
3338   f(value, method, args, thread);
3339 }
3340 
3341 // This routine may be used by user applications as a &quot;hook&quot; to catch signals.
3342 // The user-defined signal handler must pass unrecognized signals to this
3343 // routine, and if it returns true (non-zero), then the signal handler must
3344 // return immediately.  If the flag &quot;abort_if_unrecognized&quot; is true, then this
3345 // routine will never retun false (zero), but instead will execute a VM panic
3346 // routine kill the process.
3347 //
3348 // If this routine returns false, it is OK to call it again.  This allows
3349 // the user-defined signal handler to perform checks either before or after
3350 // the VM performs its own checks.  Naturally, the user code would be making
3351 // a serious error if it tried to handle an exception (such as a null check
3352 // or breakpoint) that the VM was generating for its own correct operation.
3353 //
3354 // This routine may recognize any of the following kinds of signals:
3355 // SIGBUS, SIGSEGV, SIGILL, SIGFPE, BREAK_SIGNAL, SIGPIPE, SIGXFSZ,
3356 // ASYNC_SIGNAL.
3357 // It should be consulted by handlers for any of those signals.
3358 //
3359 // The caller of this routine must pass in the three arguments supplied
3360 // to the function referred to in the &quot;sa_sigaction&quot; (not the &quot;sa_handler&quot;)
3361 // field of the structure passed to sigaction().  This routine assumes that
3362 // the sa_flags field passed to sigaction() includes SA_SIGINFO and SA_RESTART.
3363 //
3364 // Note that the VM will print warnings if it detects conflicting signal
3365 // handlers, unless invoked with the option &quot;-XX:+AllowUserSignalHandlers&quot;.
3366 //
3367 extern &quot;C&quot; JNIEXPORT int JVM_handle_solaris_signal(int signo,
3368                                                    siginfo_t* siginfo,
3369                                                    void* ucontext,
3370                                                    int abort_if_unrecognized);
3371 
3372 
3373 void signalHandler(int sig, siginfo_t* info, void* ucVoid) {
3374   int orig_errno = errno;  // Preserve errno value over signal handler.
3375   JVM_handle_solaris_signal(sig, info, ucVoid, true);
3376   errno = orig_errno;
3377 }
3378 
3379 // This boolean allows users to forward their own non-matching signals
3380 // to JVM_handle_solaris_signal, harmlessly.
3381 bool os::Solaris::signal_handlers_are_installed = false;
3382 
3383 // For signal-chaining
3384 bool os::Solaris::libjsig_is_loaded = false;
3385 typedef struct sigaction *(*get_signal_t)(int);
3386 get_signal_t os::Solaris::get_signal_action = NULL;
3387 
3388 struct sigaction* os::Solaris::get_chained_signal_action(int sig) {
3389   struct sigaction *actp = NULL;
3390 
3391   if ((libjsig_is_loaded)  &amp;&amp; (sig &lt;= Maxsignum)) {
3392     // Retrieve the old signal handler from libjsig
3393     actp = (*get_signal_action)(sig);
3394   }
3395   if (actp == NULL) {
3396     // Retrieve the preinstalled signal handler from jvm
3397     actp = get_preinstalled_handler(sig);
3398   }
3399 
3400   return actp;
3401 }
3402 
3403 static bool call_chained_handler(struct sigaction *actp, int sig,
3404                                  siginfo_t *siginfo, void *context) {
3405   // Call the old signal handler
3406   if (actp-&gt;sa_handler == SIG_DFL) {
3407     // It&#39;s more reasonable to let jvm treat it as an unexpected exception
3408     // instead of taking the default action.
3409     return false;
3410   } else if (actp-&gt;sa_handler != SIG_IGN) {
3411     if ((actp-&gt;sa_flags &amp; SA_NODEFER) == 0) {
3412       // automaticlly block the signal
3413       sigaddset(&amp;(actp-&gt;sa_mask), sig);
3414     }
3415 
3416     sa_handler_t hand;
3417     sa_sigaction_t sa;
3418     bool siginfo_flag_set = (actp-&gt;sa_flags &amp; SA_SIGINFO) != 0;
3419     // retrieve the chained handler
3420     if (siginfo_flag_set) {
3421       sa = actp-&gt;sa_sigaction;
3422     } else {
3423       hand = actp-&gt;sa_handler;
3424     }
3425 
3426     if ((actp-&gt;sa_flags &amp; SA_RESETHAND) != 0) {
3427       actp-&gt;sa_handler = SIG_DFL;
3428     }
3429 
3430     // try to honor the signal mask
3431     sigset_t oset;
3432     pthread_sigmask(SIG_SETMASK, &amp;(actp-&gt;sa_mask), &amp;oset);
3433 
3434     // call into the chained handler
3435     if (siginfo_flag_set) {
3436       (*sa)(sig, siginfo, context);
3437     } else {
3438       (*hand)(sig);
3439     }
3440 
3441     // restore the signal mask
3442     pthread_sigmask(SIG_SETMASK, &amp;oset, 0);
3443   }
3444   // Tell jvm&#39;s signal handler the signal is taken care of.
3445   return true;
3446 }
3447 
3448 bool os::Solaris::chained_handler(int sig, siginfo_t* siginfo, void* context) {
3449   bool chained = false;
3450   // signal-chaining
3451   if (UseSignalChaining) {
3452     struct sigaction *actp = get_chained_signal_action(sig);
3453     if (actp != NULL) {
3454       chained = call_chained_handler(actp, sig, siginfo, context);
3455     }
3456   }
3457   return chained;
3458 }
3459 
3460 struct sigaction* os::Solaris::get_preinstalled_handler(int sig) {
3461   assert((chainedsigactions != (struct sigaction *)NULL) &amp;&amp;
3462          (preinstalled_sigs != (int *)NULL), &quot;signals not yet initialized&quot;);
3463   if (preinstalled_sigs[sig] != 0) {
3464     return &amp;chainedsigactions[sig];
3465   }
3466   return NULL;
3467 }
3468 
3469 void os::Solaris::save_preinstalled_handler(int sig,
3470                                             struct sigaction&amp; oldAct) {
3471   assert(sig &gt; 0 &amp;&amp; sig &lt;= Maxsignum, &quot;vm signal out of expected range&quot;);
3472   assert((chainedsigactions != (struct sigaction *)NULL) &amp;&amp;
3473          (preinstalled_sigs != (int *)NULL), &quot;signals not yet initialized&quot;);
3474   chainedsigactions[sig] = oldAct;
3475   preinstalled_sigs[sig] = 1;
3476 }
3477 
3478 void os::Solaris::set_signal_handler(int sig, bool set_installed,
3479                                      bool oktochain) {
3480   // Check for overwrite.
3481   struct sigaction oldAct;
3482   sigaction(sig, (struct sigaction*)NULL, &amp;oldAct);
3483   void* oldhand =
3484       oldAct.sa_sigaction ? CAST_FROM_FN_PTR(void*,  oldAct.sa_sigaction)
3485                           : CAST_FROM_FN_PTR(void*,  oldAct.sa_handler);
3486   if (oldhand != CAST_FROM_FN_PTR(void*, SIG_DFL) &amp;&amp;
3487       oldhand != CAST_FROM_FN_PTR(void*, SIG_IGN) &amp;&amp;
3488       oldhand != CAST_FROM_FN_PTR(void*, signalHandler)) {
3489     if (AllowUserSignalHandlers || !set_installed) {
3490       // Do not overwrite; user takes responsibility to forward to us.
3491       return;
3492     } else if (UseSignalChaining) {
3493       if (oktochain) {
3494         // save the old handler in jvm
3495         save_preinstalled_handler(sig, oldAct);
3496       } else {
3497         vm_exit_during_initialization(&quot;Signal chaining not allowed for VM interrupt signal.&quot;);
3498       }
3499       // libjsig also interposes the sigaction() call below and saves the
3500       // old sigaction on it own.
3501     } else {
3502       fatal(&quot;Encountered unexpected pre-existing sigaction handler &quot;
3503             &quot;%#lx for signal %d.&quot;, (long)oldhand, sig);
3504     }
3505   }
3506 
3507   struct sigaction sigAct;
3508   sigfillset(&amp;(sigAct.sa_mask));
3509   sigAct.sa_handler = SIG_DFL;
3510 
3511   sigAct.sa_sigaction = signalHandler;
3512   // Handle SIGSEGV on alternate signal stack if
3513   // not using stack banging
3514   if (!UseStackBanging &amp;&amp; sig == SIGSEGV) {
3515     sigAct.sa_flags = SA_SIGINFO | SA_RESTART | SA_ONSTACK;
3516   } else {
3517     sigAct.sa_flags = SA_SIGINFO | SA_RESTART;
3518   }
3519   os::Solaris::set_our_sigflags(sig, sigAct.sa_flags);
3520 
3521   sigaction(sig, &amp;sigAct, &amp;oldAct);
3522 
3523   void* oldhand2 = oldAct.sa_sigaction ? CAST_FROM_FN_PTR(void*, oldAct.sa_sigaction)
3524                                        : CAST_FROM_FN_PTR(void*, oldAct.sa_handler);
3525   assert(oldhand2 == oldhand, &quot;no concurrent signal handler installation&quot;);
3526 }
3527 
3528 
3529 #define DO_SIGNAL_CHECK(sig)                      \
3530   do {                                            \
3531     if (!sigismember(&amp;check_signal_done, sig)) {  \
3532       os::Solaris::check_signal_handler(sig);     \
3533     }                                             \
3534   } while (0)
3535 
3536 // This method is a periodic task to check for misbehaving JNI applications
3537 // under CheckJNI, we can add any periodic checks here
3538 
3539 void os::run_periodic_checks() {
3540   // A big source of grief is hijacking virt. addr 0x0 on Solaris,
3541   // thereby preventing a NULL checks.
3542   if (!check_addr0_done) check_addr0_done = check_addr0(tty);
3543 
3544   if (check_signals == false) return;
3545 
3546   // SEGV and BUS if overridden could potentially prevent
3547   // generation of hs*.log in the event of a crash, debugging
3548   // such a case can be very challenging, so we absolutely
3549   // check for the following for a good measure:
3550   DO_SIGNAL_CHECK(SIGSEGV);
3551   DO_SIGNAL_CHECK(SIGILL);
3552   DO_SIGNAL_CHECK(SIGFPE);
3553   DO_SIGNAL_CHECK(SIGBUS);
3554   DO_SIGNAL_CHECK(SIGPIPE);
3555   DO_SIGNAL_CHECK(SIGXFSZ);
3556   DO_SIGNAL_CHECK(ASYNC_SIGNAL);
3557 
3558   // ReduceSignalUsage allows the user to override these handlers
3559   // see comments at the very top and jvm_solaris.h
3560   if (!ReduceSignalUsage) {
3561     DO_SIGNAL_CHECK(SHUTDOWN1_SIGNAL);
3562     DO_SIGNAL_CHECK(SHUTDOWN2_SIGNAL);
3563     DO_SIGNAL_CHECK(SHUTDOWN3_SIGNAL);
3564     DO_SIGNAL_CHECK(BREAK_SIGNAL);
3565   }
3566 }
3567 
3568 typedef int (*os_sigaction_t)(int, const struct sigaction *, struct sigaction *);
3569 
3570 static os_sigaction_t os_sigaction = NULL;
3571 
3572 void os::Solaris::check_signal_handler(int sig) {
3573   char buf[O_BUFLEN];
3574   address jvmHandler = NULL;
3575 
3576   struct sigaction act;
3577   if (os_sigaction == NULL) {
3578     // only trust the default sigaction, in case it has been interposed
3579     os_sigaction = (os_sigaction_t)dlsym(RTLD_DEFAULT, &quot;sigaction&quot;);
3580     if (os_sigaction == NULL) return;
3581   }
3582 
3583   os_sigaction(sig, (struct sigaction*)NULL, &amp;act);
3584 
3585   address thisHandler = (act.sa_flags &amp; SA_SIGINFO)
3586     ? CAST_FROM_FN_PTR(address, act.sa_sigaction)
3587     : CAST_FROM_FN_PTR(address, act.sa_handler);
3588 
3589 
3590   switch (sig) {
3591   case SIGSEGV:
3592   case SIGBUS:
3593   case SIGFPE:
3594   case SIGPIPE:
3595   case SIGXFSZ:
3596   case SIGILL:
3597   case ASYNC_SIGNAL:
3598     jvmHandler = CAST_FROM_FN_PTR(address, signalHandler);
3599     break;
3600 
3601   case SHUTDOWN1_SIGNAL:
3602   case SHUTDOWN2_SIGNAL:
3603   case SHUTDOWN3_SIGNAL:
3604   case BREAK_SIGNAL:
3605     jvmHandler = (address)user_handler();
3606     break;
3607 
3608   default:
3609       return;
3610   }
3611 
3612   if (thisHandler != jvmHandler) {
3613     tty-&gt;print(&quot;Warning: %s handler &quot;, exception_name(sig, buf, O_BUFLEN));
3614     tty-&gt;print(&quot;expected:%s&quot;, get_signal_handler_name(jvmHandler, buf, O_BUFLEN));
3615     tty-&gt;print_cr(&quot;  found:%s&quot;, get_signal_handler_name(thisHandler, buf, O_BUFLEN));
3616     // No need to check this sig any longer
3617     sigaddset(&amp;check_signal_done, sig);
3618     // Running under non-interactive shell, SHUTDOWN2_SIGNAL will be reassigned SIG_IGN
3619     if (sig == SHUTDOWN2_SIGNAL &amp;&amp; !isatty(fileno(stdin))) {
3620       tty-&gt;print_cr(&quot;Running in non-interactive shell, %s handler is replaced by shell&quot;,
3621                     exception_name(sig, buf, O_BUFLEN));
3622     }
3623   } else if(os::Solaris::get_our_sigflags(sig) != 0 &amp;&amp; act.sa_flags != os::Solaris::get_our_sigflags(sig)) {
3624     tty-&gt;print(&quot;Warning: %s handler flags &quot;, exception_name(sig, buf, O_BUFLEN));
3625     tty-&gt;print(&quot;expected:&quot;);
3626     os::Posix::print_sa_flags(tty, os::Solaris::get_our_sigflags(sig));
3627     tty-&gt;cr();
3628     tty-&gt;print(&quot;  found:&quot;);
3629     os::Posix::print_sa_flags(tty, act.sa_flags);
3630     tty-&gt;cr();
3631     // No need to check this sig any longer
3632     sigaddset(&amp;check_signal_done, sig);
3633   }
3634 
3635   // Print all the signal handler state
3636   if (sigismember(&amp;check_signal_done, sig)) {
3637     print_signal_handlers(tty, buf, O_BUFLEN);
3638   }
3639 
3640 }
3641 
3642 void os::Solaris::install_signal_handlers() {
3643   signal_handlers_are_installed = true;
3644 
3645   // signal-chaining
3646   typedef void (*signal_setting_t)();
3647   signal_setting_t begin_signal_setting = NULL;
3648   signal_setting_t end_signal_setting = NULL;
3649   begin_signal_setting = CAST_TO_FN_PTR(signal_setting_t,
3650                                         dlsym(RTLD_DEFAULT, &quot;JVM_begin_signal_setting&quot;));
3651   if (begin_signal_setting != NULL) {
3652     end_signal_setting = CAST_TO_FN_PTR(signal_setting_t,
3653                                         dlsym(RTLD_DEFAULT, &quot;JVM_end_signal_setting&quot;));
3654     get_signal_action = CAST_TO_FN_PTR(get_signal_t,
3655                                        dlsym(RTLD_DEFAULT, &quot;JVM_get_signal_action&quot;));
3656     libjsig_is_loaded = true;
3657     assert(UseSignalChaining, &quot;should enable signal-chaining&quot;);
3658   }
3659   if (libjsig_is_loaded) {
3660     // Tell libjsig jvm is setting signal handlers
3661     (*begin_signal_setting)();
3662   }
3663 
3664   set_signal_handler(SIGSEGV, true, true);
3665   set_signal_handler(SIGPIPE, true, true);
3666   set_signal_handler(SIGXFSZ, true, true);
3667   set_signal_handler(SIGBUS, true, true);
3668   set_signal_handler(SIGILL, true, true);
3669   set_signal_handler(SIGFPE, true, true);
3670   set_signal_handler(ASYNC_SIGNAL, true, true);
3671 
3672   if (libjsig_is_loaded) {
3673     // Tell libjsig jvm finishes setting signal handlers
3674     (*end_signal_setting)();
3675   }
3676 
3677   // We don&#39;t activate signal checker if libjsig is in place, we trust ourselves
3678   // and if UserSignalHandler is installed all bets are off.
3679   // Log that signal checking is off only if -verbose:jni is specified.
3680   if (CheckJNICalls) {
3681     if (libjsig_is_loaded) {
3682       log_debug(jni, resolve)(&quot;Info: libjsig is activated, all active signal checking is disabled&quot;);
3683       check_signals = false;
3684     }
3685     if (AllowUserSignalHandlers) {
3686       log_debug(jni, resolve)(&quot;Info: AllowUserSignalHandlers is activated, all active signal checking is disabled&quot;);
3687       check_signals = false;
3688     }
3689   }
3690 }
3691 
3692 
3693 void report_error(const char* file_name, int line_no, const char* title,
3694                   const char* format, ...);
3695 
3696 // (Static) wrappers for the liblgrp API
3697 os::Solaris::lgrp_home_func_t os::Solaris::_lgrp_home;
3698 os::Solaris::lgrp_init_func_t os::Solaris::_lgrp_init;
3699 os::Solaris::lgrp_fini_func_t os::Solaris::_lgrp_fini;
3700 os::Solaris::lgrp_root_func_t os::Solaris::_lgrp_root;
3701 os::Solaris::lgrp_children_func_t os::Solaris::_lgrp_children;
3702 os::Solaris::lgrp_resources_func_t os::Solaris::_lgrp_resources;
3703 os::Solaris::lgrp_nlgrps_func_t os::Solaris::_lgrp_nlgrps;
3704 os::Solaris::lgrp_cookie_stale_func_t os::Solaris::_lgrp_cookie_stale;
3705 os::Solaris::lgrp_cookie_t os::Solaris::_lgrp_cookie = 0;
3706 
3707 static address resolve_symbol_lazy(const char* name) {
3708   address addr = (address) dlsym(RTLD_DEFAULT, name);
3709   if (addr == NULL) {
3710     // RTLD_DEFAULT was not defined on some early versions of 2.5.1
3711     addr = (address) dlsym(RTLD_NEXT, name);
3712   }
3713   return addr;
3714 }
3715 
3716 static address resolve_symbol(const char* name) {
3717   address addr = resolve_symbol_lazy(name);
3718   if (addr == NULL) {
3719     fatal(dlerror());
3720   }
3721   return addr;
3722 }
3723 
3724 void os::Solaris::libthread_init() {
3725   address func = (address)dlsym(RTLD_DEFAULT, &quot;_thr_suspend_allmutators&quot;);
3726 
3727   lwp_priocntl_init();
3728 
3729   // RTLD_DEFAULT was not defined on some early versions of 5.5.1
3730   if (func == NULL) {
3731     func = (address) dlsym(RTLD_NEXT, &quot;_thr_suspend_allmutators&quot;);
3732     // Guarantee that this VM is running on an new enough OS (5.6 or
3733     // later) that it will have a new enough libthread.so.
3734     guarantee(func != NULL, &quot;libthread.so is too old.&quot;);
3735   }
3736 
3737   int size;
3738   void (*handler_info_func)(address *, int *);
3739   handler_info_func = CAST_TO_FN_PTR(void (*)(address *, int *), resolve_symbol(&quot;thr_sighndlrinfo&quot;));
3740   handler_info_func(&amp;handler_start, &amp;size);
3741   handler_end = handler_start + size;
3742 }
3743 
3744 
3745 int_fnP_mutex_tP os::Solaris::_mutex_lock;
3746 int_fnP_mutex_tP os::Solaris::_mutex_trylock;
3747 int_fnP_mutex_tP os::Solaris::_mutex_unlock;
3748 int_fnP_mutex_tP_i_vP os::Solaris::_mutex_init;
3749 int_fnP_mutex_tP os::Solaris::_mutex_destroy;
3750 int os::Solaris::_mutex_scope = USYNC_THREAD;
3751 
3752 int_fnP_cond_tP_mutex_tP_timestruc_tP os::Solaris::_cond_timedwait;
3753 int_fnP_cond_tP_mutex_tP os::Solaris::_cond_wait;
3754 int_fnP_cond_tP os::Solaris::_cond_signal;
3755 int_fnP_cond_tP os::Solaris::_cond_broadcast;
3756 int_fnP_cond_tP_i_vP os::Solaris::_cond_init;
3757 int_fnP_cond_tP os::Solaris::_cond_destroy;
3758 int os::Solaris::_cond_scope = USYNC_THREAD;
3759 bool os::Solaris::_synchronization_initialized;
3760 
3761 void os::Solaris::synchronization_init() {
3762   if (UseLWPSynchronization) {
3763     os::Solaris::set_mutex_lock(CAST_TO_FN_PTR(int_fnP_mutex_tP, resolve_symbol(&quot;_lwp_mutex_lock&quot;)));
3764     os::Solaris::set_mutex_trylock(CAST_TO_FN_PTR(int_fnP_mutex_tP, resolve_symbol(&quot;_lwp_mutex_trylock&quot;)));
3765     os::Solaris::set_mutex_unlock(CAST_TO_FN_PTR(int_fnP_mutex_tP, resolve_symbol(&quot;_lwp_mutex_unlock&quot;)));
3766     os::Solaris::set_mutex_init(lwp_mutex_init);
3767     os::Solaris::set_mutex_destroy(lwp_mutex_destroy);
3768     os::Solaris::set_mutex_scope(USYNC_THREAD);
3769 
3770     os::Solaris::set_cond_timedwait(CAST_TO_FN_PTR(int_fnP_cond_tP_mutex_tP_timestruc_tP, resolve_symbol(&quot;_lwp_cond_timedwait&quot;)));
3771     os::Solaris::set_cond_wait(CAST_TO_FN_PTR(int_fnP_cond_tP_mutex_tP, resolve_symbol(&quot;_lwp_cond_wait&quot;)));
3772     os::Solaris::set_cond_signal(CAST_TO_FN_PTR(int_fnP_cond_tP, resolve_symbol(&quot;_lwp_cond_signal&quot;)));
3773     os::Solaris::set_cond_broadcast(CAST_TO_FN_PTR(int_fnP_cond_tP, resolve_symbol(&quot;_lwp_cond_broadcast&quot;)));
3774     os::Solaris::set_cond_init(lwp_cond_init);
3775     os::Solaris::set_cond_destroy(lwp_cond_destroy);
3776     os::Solaris::set_cond_scope(USYNC_THREAD);
3777   } else {
3778     os::Solaris::set_mutex_scope(USYNC_THREAD);
3779     os::Solaris::set_cond_scope(USYNC_THREAD);
3780 
3781     if (UsePthreads) {
3782       os::Solaris::set_mutex_lock(CAST_TO_FN_PTR(int_fnP_mutex_tP, resolve_symbol(&quot;pthread_mutex_lock&quot;)));
3783       os::Solaris::set_mutex_trylock(CAST_TO_FN_PTR(int_fnP_mutex_tP, resolve_symbol(&quot;pthread_mutex_trylock&quot;)));
3784       os::Solaris::set_mutex_unlock(CAST_TO_FN_PTR(int_fnP_mutex_tP, resolve_symbol(&quot;pthread_mutex_unlock&quot;)));
3785       os::Solaris::set_mutex_init(pthread_mutex_default_init);
3786       os::Solaris::set_mutex_destroy(CAST_TO_FN_PTR(int_fnP_mutex_tP, resolve_symbol(&quot;pthread_mutex_destroy&quot;)));
3787 
3788       os::Solaris::set_cond_timedwait(CAST_TO_FN_PTR(int_fnP_cond_tP_mutex_tP_timestruc_tP, resolve_symbol(&quot;pthread_cond_timedwait&quot;)));
3789       os::Solaris::set_cond_wait(CAST_TO_FN_PTR(int_fnP_cond_tP_mutex_tP, resolve_symbol(&quot;pthread_cond_wait&quot;)));
3790       os::Solaris::set_cond_signal(CAST_TO_FN_PTR(int_fnP_cond_tP, resolve_symbol(&quot;pthread_cond_signal&quot;)));
3791       os::Solaris::set_cond_broadcast(CAST_TO_FN_PTR(int_fnP_cond_tP, resolve_symbol(&quot;pthread_cond_broadcast&quot;)));
3792       os::Solaris::set_cond_init(pthread_cond_default_init);
3793       os::Solaris::set_cond_destroy(CAST_TO_FN_PTR(int_fnP_cond_tP, resolve_symbol(&quot;pthread_cond_destroy&quot;)));
3794     } else {
3795       os::Solaris::set_mutex_lock(CAST_TO_FN_PTR(int_fnP_mutex_tP, resolve_symbol(&quot;mutex_lock&quot;)));
3796       os::Solaris::set_mutex_trylock(CAST_TO_FN_PTR(int_fnP_mutex_tP, resolve_symbol(&quot;mutex_trylock&quot;)));
3797       os::Solaris::set_mutex_unlock(CAST_TO_FN_PTR(int_fnP_mutex_tP, resolve_symbol(&quot;mutex_unlock&quot;)));
3798       os::Solaris::set_mutex_init(::mutex_init);
3799       os::Solaris::set_mutex_destroy(::mutex_destroy);
3800 
3801       os::Solaris::set_cond_timedwait(CAST_TO_FN_PTR(int_fnP_cond_tP_mutex_tP_timestruc_tP, resolve_symbol(&quot;cond_timedwait&quot;)));
3802       os::Solaris::set_cond_wait(CAST_TO_FN_PTR(int_fnP_cond_tP_mutex_tP, resolve_symbol(&quot;cond_wait&quot;)));
3803       os::Solaris::set_cond_signal(CAST_TO_FN_PTR(int_fnP_cond_tP, resolve_symbol(&quot;cond_signal&quot;)));
3804       os::Solaris::set_cond_broadcast(CAST_TO_FN_PTR(int_fnP_cond_tP, resolve_symbol(&quot;cond_broadcast&quot;)));
3805       os::Solaris::set_cond_init(::cond_init);
3806       os::Solaris::set_cond_destroy(::cond_destroy);
3807     }
3808   }
3809   _synchronization_initialized = true;
3810 }
3811 
3812 bool os::Solaris::liblgrp_init() {
3813   void *handle = dlopen(&quot;liblgrp.so.1&quot;, RTLD_LAZY);
3814   if (handle != NULL) {
3815     os::Solaris::set_lgrp_home(CAST_TO_FN_PTR(lgrp_home_func_t, dlsym(handle, &quot;lgrp_home&quot;)));
3816     os::Solaris::set_lgrp_init(CAST_TO_FN_PTR(lgrp_init_func_t, dlsym(handle, &quot;lgrp_init&quot;)));
3817     os::Solaris::set_lgrp_fini(CAST_TO_FN_PTR(lgrp_fini_func_t, dlsym(handle, &quot;lgrp_fini&quot;)));
3818     os::Solaris::set_lgrp_root(CAST_TO_FN_PTR(lgrp_root_func_t, dlsym(handle, &quot;lgrp_root&quot;)));
3819     os::Solaris::set_lgrp_children(CAST_TO_FN_PTR(lgrp_children_func_t, dlsym(handle, &quot;lgrp_children&quot;)));
3820     os::Solaris::set_lgrp_resources(CAST_TO_FN_PTR(lgrp_resources_func_t, dlsym(handle, &quot;lgrp_resources&quot;)));
3821     os::Solaris::set_lgrp_nlgrps(CAST_TO_FN_PTR(lgrp_nlgrps_func_t, dlsym(handle, &quot;lgrp_nlgrps&quot;)));
3822     os::Solaris::set_lgrp_cookie_stale(CAST_TO_FN_PTR(lgrp_cookie_stale_func_t,
3823                                                       dlsym(handle, &quot;lgrp_cookie_stale&quot;)));
3824 
3825     lgrp_cookie_t c = lgrp_init(LGRP_VIEW_CALLER);
3826     set_lgrp_cookie(c);
3827     return true;
3828   }
3829   return false;
3830 }
3831 
3832 // int pset_getloadavg(psetid_t pset, double loadavg[], int nelem);
3833 typedef long (*pset_getloadavg_type)(psetid_t pset, double loadavg[], int nelem);
3834 static pset_getloadavg_type pset_getloadavg_ptr = NULL;
3835 
3836 void init_pset_getloadavg_ptr(void) {
3837   pset_getloadavg_ptr =
3838     (pset_getloadavg_type)dlsym(RTLD_DEFAULT, &quot;pset_getloadavg&quot;);
3839   if (pset_getloadavg_ptr == NULL) {
3840     log_warning(os)(&quot;pset_getloadavg function not found&quot;);
3841   }
3842 }
3843 
3844 int os::Solaris::_dev_zero_fd = -1;
3845 
3846 // this is called _before_ the global arguments have been parsed
3847 void os::init(void) {
3848   _initial_pid = getpid();
3849 
3850   max_hrtime = first_hrtime = gethrtime();
3851 
3852   init_random(1234567);
3853 
3854   page_size = sysconf(_SC_PAGESIZE);
3855   if (page_size == -1) {
3856     fatal(&quot;os_solaris.cpp: os::init: sysconf failed (%s)&quot;, os::strerror(errno));
3857   }
3858   init_page_sizes((size_t) page_size);
3859 
3860   Solaris::initialize_system_info();
3861 
3862   int fd = ::open(&quot;/dev/zero&quot;, O_RDWR);
3863   if (fd &lt; 0) {
3864     fatal(&quot;os::init: cannot open /dev/zero (%s)&quot;, os::strerror(errno));
3865   } else {
3866     Solaris::set_dev_zero_fd(fd);
3867 
3868     // Close on exec, child won&#39;t inherit.
3869     fcntl(fd, F_SETFD, FD_CLOEXEC);
3870   }
3871 
3872   clock_tics_per_sec = CLK_TCK;
3873 
3874   // check if dladdr1() exists; dladdr1 can provide more information than
3875   // dladdr for os::dll_address_to_function_name. It comes with SunOS 5.9
3876   // and is available on linker patches for 5.7 and 5.8.
3877   // libdl.so must have been loaded, this call is just an entry lookup
3878   void * hdl = dlopen(&quot;libdl.so&quot;, RTLD_NOW);
3879   if (hdl) {
3880     dladdr1_func = CAST_TO_FN_PTR(dladdr1_func_type, dlsym(hdl, &quot;dladdr1&quot;));
3881   }
3882 
3883   // main_thread points to the thread that created/loaded the JVM.
3884   main_thread = thr_self();
3885 
3886   // dynamic lookup of functions that may not be available in our lowest
3887   // supported Solaris release
3888   void * handle = dlopen(&quot;libc.so.1&quot;, RTLD_LAZY);
3889   if (handle != NULL) {
3890     Solaris::_pthread_setname_np =  // from 11.3
3891         (Solaris::pthread_setname_np_func_t)dlsym(handle, &quot;pthread_setname_np&quot;);
3892   }
3893 
3894   // Shared Posix initialization
3895   os::Posix::init();
3896 }
3897 
3898 // To install functions for atexit system call
3899 extern &quot;C&quot; {
3900   static void perfMemory_exit_helper() {
3901     perfMemory_exit();
3902   }
3903 }
3904 
3905 // this is called _after_ the global arguments have been parsed
3906 jint os::init_2(void) {
3907   // try to enable extended file IO ASAP, see 6431278
3908   os::Solaris::try_enable_extended_io();
3909 
3910   // Check and sets minimum stack sizes against command line options
3911   if (Posix::set_minimum_stack_sizes() == JNI_ERR) {
3912     return JNI_ERR;
3913   }
3914 
3915   Solaris::libthread_init();
3916 
3917   if (UseNUMA) {
3918     if (!Solaris::liblgrp_init()) {
3919       UseNUMA = false;
3920     } else {
3921       size_t lgrp_limit = os::numa_get_groups_num();
3922       int *lgrp_ids = NEW_C_HEAP_ARRAY(int, lgrp_limit, mtInternal);
3923       size_t lgrp_num = os::numa_get_leaf_groups(lgrp_ids, lgrp_limit);
3924       FREE_C_HEAP_ARRAY(int, lgrp_ids);
3925       if (lgrp_num &lt; 2) {
3926         // There&#39;s only one locality group, disable NUMA unless
3927         // user explicilty forces NUMA optimizations on single-node/UMA systems
3928         UseNUMA = ForceNUMA;
3929       }
3930     }
3931   }
3932 
3933   Solaris::signal_sets_init();
3934   Solaris::init_signal_mem();
3935   Solaris::install_signal_handlers();
3936   // Initialize data for jdk.internal.misc.Signal
3937   if (!ReduceSignalUsage) {
3938     jdk_misc_signal_init();
3939   }
3940 
3941   // initialize synchronization primitives to use either thread or
3942   // lwp synchronization (controlled by UseLWPSynchronization)
3943   Solaris::synchronization_init();
3944   DEBUG_ONLY(os::set_mutex_init_done();)
3945 
3946   if (MaxFDLimit) {
3947     // set the number of file descriptors to max. print out error
3948     // if getrlimit/setrlimit fails but continue regardless.
3949     struct rlimit nbr_files;
3950     int status = getrlimit(RLIMIT_NOFILE, &amp;nbr_files);
3951     if (status != 0) {
3952       log_info(os)(&quot;os::init_2 getrlimit failed: %s&quot;, os::strerror(errno));
3953     } else {
3954       nbr_files.rlim_cur = nbr_files.rlim_max;
3955       status = setrlimit(RLIMIT_NOFILE, &amp;nbr_files);
3956       if (status != 0) {
3957         log_info(os)(&quot;os::init_2 setrlimit failed: %s&quot;, os::strerror(errno));
3958       }
3959     }
3960   }
3961 
3962   // Calculate theoretical max. size of Threads to guard gainst
3963   // artifical out-of-memory situations, where all available address-
3964   // space has been reserved by thread stacks. Default stack size is 1Mb.
3965   size_t pre_thread_stack_size = (JavaThread::stack_size_at_create()) ?
3966     JavaThread::stack_size_at_create() : (1*K*K);
3967   assert(pre_thread_stack_size != 0, &quot;Must have a stack&quot;);
3968   // Solaris has a maximum of 4Gb of user programs. Calculate the thread limit when
3969   // we should start doing Virtual Memory banging. Currently when the threads will
3970   // have used all but 200Mb of space.
3971   size_t max_address_space = ((unsigned int)4 * K * K * K) - (200 * K * K);
3972   Solaris::_os_thread_limit = max_address_space / pre_thread_stack_size;
3973 
3974   // at-exit methods are called in the reverse order of their registration.
3975   // In Solaris 7 and earlier, atexit functions are called on return from
3976   // main or as a result of a call to exit(3C). There can be only 32 of
3977   // these functions registered and atexit() does not set errno. In Solaris
3978   // 8 and later, there is no limit to the number of functions registered
3979   // and atexit() sets errno. In addition, in Solaris 8 and later, atexit
3980   // functions are called upon dlclose(3DL) in addition to return from main
3981   // and exit(3C).
3982 
3983   if (PerfAllowAtExitRegistration) {
3984     // only register atexit functions if PerfAllowAtExitRegistration is set.
3985     // atexit functions can be delayed until process exit time, which
3986     // can be problematic for embedded VM situations. Embedded VMs should
3987     // call DestroyJavaVM() to assure that VM resources are released.
3988 
3989     // note: perfMemory_exit_helper atexit function may be removed in
3990     // the future if the appropriate cleanup code can be added to the
3991     // VM_Exit VMOperation&#39;s doit method.
3992     if (atexit(perfMemory_exit_helper) != 0) {
3993       warning(&quot;os::init2 atexit(perfMemory_exit_helper) failed&quot;);
3994     }
3995   }
3996 
3997   // Init pset_loadavg function pointer
3998   init_pset_getloadavg_ptr();
3999 
4000   // Shared Posix initialization
4001   os::Posix::init_2();
4002 
4003   return JNI_OK;
4004 }
4005 
4006 // Is a (classpath) directory empty?
4007 bool os::dir_is_empty(const char* path) {
4008   DIR *dir = NULL;
4009   struct dirent *ptr;
4010 
4011   dir = opendir(path);
4012   if (dir == NULL) return true;
4013 
4014   // Scan the directory
4015   bool result = true;
4016   while (result &amp;&amp; (ptr = readdir(dir)) != NULL) {
4017     if (strcmp(ptr-&gt;d_name, &quot;.&quot;) != 0 &amp;&amp; strcmp(ptr-&gt;d_name, &quot;..&quot;) != 0) {
4018       result = false;
4019     }
4020   }
4021   closedir(dir);
4022   return result;
4023 }
4024 
4025 // This code originates from JDK&#39;s sysOpen and open64_w
4026 // from src/solaris/hpi/src/system_md.c
4027 
4028 int os::open(const char *path, int oflag, int mode) {
4029   if (strlen(path) &gt; MAX_PATH - 1) {
4030     errno = ENAMETOOLONG;
4031     return -1;
4032   }
4033   int fd;
4034 
4035   fd = ::open64(path, oflag, mode);
4036   if (fd == -1) return -1;
4037 
4038   // If the open succeeded, the file might still be a directory
4039   {
4040     struct stat64 buf64;
4041     int ret = ::fstat64(fd, &amp;buf64);
4042     int st_mode = buf64.st_mode;
4043 
4044     if (ret != -1) {
4045       if ((st_mode &amp; S_IFMT) == S_IFDIR) {
4046         errno = EISDIR;
4047         ::close(fd);
4048         return -1;
4049       }
4050     } else {
4051       ::close(fd);
4052       return -1;
4053     }
4054   }
4055 
4056   // 32-bit Solaris systems suffer from:
4057   //
4058   // - an historical default soft limit of 256 per-process file
4059   //   descriptors that is too low for many Java programs.
4060   //
4061   // - a design flaw where file descriptors created using stdio
4062   //   fopen must be less than 256, _even_ when the first limit above
4063   //   has been raised.  This can cause calls to fopen (but not calls to
4064   //   open, for example) to fail mysteriously, perhaps in 3rd party
4065   //   native code (although the JDK itself uses fopen).  One can hardly
4066   //   criticize them for using this most standard of all functions.
4067   //
4068   // We attempt to make everything work anyways by:
4069   //
4070   // - raising the soft limit on per-process file descriptors beyond
4071   //   256
4072   //
4073   // - As of Solaris 10u4, we can request that Solaris raise the 256
4074   //   stdio fopen limit by calling function enable_extended_FILE_stdio.
4075   //   This is done in init_2 and recorded in enabled_extended_FILE_stdio
4076   //
4077   // - If we are stuck on an old (pre 10u4) Solaris system, we can
4078   //   workaround the bug by remapping non-stdio file descriptors below
4079   //   256 to ones beyond 256, which is done below.
4080   //
4081   // See:
4082   // 1085341: 32-bit stdio routines should support file descriptors &gt;255
4083   // 6533291: Work around 32-bit Solaris stdio limit of 256 open files
4084   // 6431278: Netbeans crash on 32 bit Solaris: need to call
4085   //          enable_extended_FILE_stdio() in VM initialisation
4086   // Giri Mandalika&#39;s blog
4087   // http://technopark02.blogspot.com/2005_05_01_archive.html
4088   //
4089 #ifndef  _LP64
4090   if ((!enabled_extended_FILE_stdio) &amp;&amp; fd &lt; 256) {
4091     int newfd = ::fcntl(fd, F_DUPFD, 256);
4092     if (newfd != -1) {
4093       ::close(fd);
4094       fd = newfd;
4095     }
4096   }
4097 #endif // 32-bit Solaris
4098 
4099   // All file descriptors that are opened in the JVM and not
4100   // specifically destined for a subprocess should have the
4101   // close-on-exec flag set.  If we don&#39;t set it, then careless 3rd
4102   // party native code might fork and exec without closing all
4103   // appropriate file descriptors (e.g. as we do in closeDescriptors in
4104   // UNIXProcess.c), and this in turn might:
4105   //
4106   // - cause end-of-file to fail to be detected on some file
4107   //   descriptors, resulting in mysterious hangs, or
4108   //
4109   // - might cause an fopen in the subprocess to fail on a system
4110   //   suffering from bug 1085341.
4111   //
4112   // (Yes, the default setting of the close-on-exec flag is a Unix
4113   // design flaw)
4114   //
4115   // See:
4116   // 1085341: 32-bit stdio routines should support file descriptors &gt;255
4117   // 4843136: (process) pipe file descriptor from Runtime.exec not being closed
4118   // 6339493: (process) Runtime.exec does not close all file descriptors on Solaris 9
4119   //
4120 #ifdef FD_CLOEXEC
4121   {
4122     int flags = ::fcntl(fd, F_GETFD);
4123     if (flags != -1) {
4124       ::fcntl(fd, F_SETFD, flags | FD_CLOEXEC);
4125     }
4126   }
4127 #endif
4128 
4129   return fd;
4130 }
4131 
4132 // create binary file, rewriting existing file if required
4133 int os::create_binary_file(const char* path, bool rewrite_existing) {
4134   int oflags = O_WRONLY | O_CREAT;
4135   if (!rewrite_existing) {
4136     oflags |= O_EXCL;
4137   }
4138   return ::open64(path, oflags, S_IREAD | S_IWRITE);
4139 }
4140 
4141 // return current position of file pointer
4142 jlong os::current_file_offset(int fd) {
4143   return (jlong)::lseek64(fd, (off64_t)0, SEEK_CUR);
4144 }
4145 
4146 // move file pointer to the specified offset
4147 jlong os::seek_to_file_offset(int fd, jlong offset) {
4148   return (jlong)::lseek64(fd, (off64_t)offset, SEEK_SET);
4149 }
4150 
4151 jlong os::lseek(int fd, jlong offset, int whence) {
4152   return (jlong) ::lseek64(fd, offset, whence);
4153 }
4154 
4155 int os::ftruncate(int fd, jlong length) {
4156   return ::ftruncate64(fd, length);
4157 }
4158 
4159 int os::fsync(int fd)  {
4160   RESTARTABLE_RETURN_INT(::fsync(fd));
4161 }
4162 
4163 int os::available(int fd, jlong *bytes) {
4164   assert(((JavaThread*)Thread::current())-&gt;thread_state() == _thread_in_native,
4165          &quot;Assumed _thread_in_native&quot;);
4166   jlong cur, end;
4167   int mode;
4168   struct stat64 buf64;
4169 
4170   if (::fstat64(fd, &amp;buf64) &gt;= 0) {
4171     mode = buf64.st_mode;
4172     if (S_ISCHR(mode) || S_ISFIFO(mode) || S_ISSOCK(mode)) {
4173       int n,ioctl_return;
4174 
4175       RESTARTABLE(::ioctl(fd, FIONREAD, &amp;n), ioctl_return);
4176       if (ioctl_return&gt;= 0) {
4177         *bytes = n;
4178         return 1;
4179       }
4180     }
4181   }
4182   if ((cur = ::lseek64(fd, 0L, SEEK_CUR)) == -1) {
4183     return 0;
4184   } else if ((end = ::lseek64(fd, 0L, SEEK_END)) == -1) {
4185     return 0;
4186   } else if (::lseek64(fd, cur, SEEK_SET) == -1) {
4187     return 0;
4188   }
4189   *bytes = end - cur;
4190   return 1;
4191 }
4192 
4193 // Map a block of memory.
4194 char* os::pd_map_memory(int fd, const char* file_name, size_t file_offset,
4195                         char *addr, size_t bytes, bool read_only,
4196                         bool allow_exec) {
4197   int prot;
4198   int flags;
4199 
4200   if (read_only) {
4201     prot = PROT_READ;
4202     flags = MAP_SHARED;
4203   } else {
4204     prot = PROT_READ | PROT_WRITE;
4205     flags = MAP_PRIVATE;
4206   }
4207 
4208   if (allow_exec) {
4209     prot |= PROT_EXEC;
4210   }
4211 
4212   if (addr != NULL) {
4213     flags |= MAP_FIXED;
4214   }
4215 
4216   char* mapped_address = (char*)mmap(addr, (size_t)bytes, prot, flags,
4217                                      fd, file_offset);
4218   if (mapped_address == MAP_FAILED) {
4219     return NULL;
4220   }
4221   return mapped_address;
4222 }
4223 
4224 
4225 // Remap a block of memory.
4226 char* os::pd_remap_memory(int fd, const char* file_name, size_t file_offset,
4227                           char *addr, size_t bytes, bool read_only,
4228                           bool allow_exec) {
4229   // same as map_memory() on this OS
4230   return os::map_memory(fd, file_name, file_offset, addr, bytes, read_only,
4231                         allow_exec);
4232 }
4233 
4234 
4235 // Unmap a block of memory.
4236 bool os::pd_unmap_memory(char* addr, size_t bytes) {
4237   return munmap(addr, bytes) == 0;
4238 }
4239 
4240 void os::pause() {
4241   char filename[MAX_PATH];
4242   if (PauseAtStartupFile &amp;&amp; PauseAtStartupFile[0]) {
4243     jio_snprintf(filename, MAX_PATH, &quot;%s&quot;, PauseAtStartupFile);
4244   } else {
4245     jio_snprintf(filename, MAX_PATH, &quot;./vm.paused.%d&quot;, current_process_id());
4246   }
4247 
4248   int fd = ::open(filename, O_WRONLY | O_CREAT | O_TRUNC, 0666);
4249   if (fd != -1) {
4250     struct stat buf;
4251     ::close(fd);
4252     while (::stat(filename, &amp;buf) == 0) {
4253       (void)::poll(NULL, 0, 100);
4254     }
4255   } else {
4256     jio_fprintf(stderr,
4257                 &quot;Could not open pause file &#39;%s&#39;, continuing immediately.\n&quot;, filename);
4258   }
4259 }
4260 
4261 #ifndef PRODUCT
4262 #ifdef INTERPOSE_ON_SYSTEM_SYNCH_FUNCTIONS
4263 // Turn this on if you need to trace synch operations.
4264 // Set RECORD_SYNCH_LIMIT to a large-enough value,
4265 // and call record_synch_enable and record_synch_disable
4266 // around the computation of interest.
4267 
4268 void record_synch(char* name, bool returning);  // defined below
4269 
4270 class RecordSynch {
4271   char* _name;
4272  public:
4273   RecordSynch(char* name) :_name(name) { record_synch(_name, false); }
4274   ~RecordSynch()                       { record_synch(_name, true); }
4275 };
4276 
4277 #define CHECK_SYNCH_OP(ret, name, params, args, inner)          \
4278 extern &quot;C&quot; ret name params {                                    \
4279   typedef ret name##_t params;                                  \
4280   static name##_t* implem = NULL;                               \
4281   static int callcount = 0;                                     \
4282   if (implem == NULL) {                                         \
4283     implem = (name##_t*) dlsym(RTLD_NEXT, #name);               \
4284     if (implem == NULL)  fatal(dlerror());                      \
4285   }                                                             \
4286   ++callcount;                                                  \
4287   RecordSynch _rs(#name);                                       \
4288   inner;                                                        \
4289   return implem args;                                           \
4290 }
4291 // in dbx, examine callcounts this way:
4292 // for n in $(eval whereis callcount | awk &#39;{print $2}&#39;); do print $n; done
4293 
4294 #define CHECK_POINTER_OK(p) \
4295   (!Universe::is_fully_initialized() || !Universe::is_reserved_heap((oop)(p)))
4296 #define CHECK_MU \
4297   if (!CHECK_POINTER_OK(mu)) fatal(&quot;Mutex must be in C heap only.&quot;);
4298 #define CHECK_CV \
4299   if (!CHECK_POINTER_OK(cv)) fatal(&quot;Condvar must be in C heap only.&quot;);
4300 #define CHECK_P(p) \
4301   if (!CHECK_POINTER_OK(p))  fatal(false,  &quot;Pointer must be in C heap only.&quot;);
4302 
4303 #define CHECK_MUTEX(mutex_op) \
4304   CHECK_SYNCH_OP(int, mutex_op, (mutex_t *mu), (mu), CHECK_MU);
4305 
4306 CHECK_MUTEX(   mutex_lock)
4307 CHECK_MUTEX(  _mutex_lock)
4308 CHECK_MUTEX( mutex_unlock)
4309 CHECK_MUTEX(_mutex_unlock)
4310 CHECK_MUTEX( mutex_trylock)
4311 CHECK_MUTEX(_mutex_trylock)
4312 
4313 #define CHECK_COND(cond_op) \
4314   CHECK_SYNCH_OP(int, cond_op, (cond_t *cv, mutex_t *mu), (cv, mu), CHECK_MU; CHECK_CV);
4315 
4316 CHECK_COND( cond_wait);
4317 CHECK_COND(_cond_wait);
4318 CHECK_COND(_cond_wait_cancel);
4319 
4320 #define CHECK_COND2(cond_op) \
4321   CHECK_SYNCH_OP(int, cond_op, (cond_t *cv, mutex_t *mu, timestruc_t* ts), (cv, mu, ts), CHECK_MU; CHECK_CV);
4322 
4323 CHECK_COND2( cond_timedwait);
4324 CHECK_COND2(_cond_timedwait);
4325 CHECK_COND2(_cond_timedwait_cancel);
4326 
4327 // do the _lwp_* versions too
4328 #define mutex_t lwp_mutex_t
4329 #define cond_t  lwp_cond_t
4330 CHECK_MUTEX(  _lwp_mutex_lock)
4331 CHECK_MUTEX(  _lwp_mutex_unlock)
4332 CHECK_MUTEX(  _lwp_mutex_trylock)
4333 CHECK_MUTEX( __lwp_mutex_lock)
4334 CHECK_MUTEX( __lwp_mutex_unlock)
4335 CHECK_MUTEX( __lwp_mutex_trylock)
4336 CHECK_MUTEX(___lwp_mutex_lock)
4337 CHECK_MUTEX(___lwp_mutex_unlock)
4338 
4339 CHECK_COND(  _lwp_cond_wait);
4340 CHECK_COND( __lwp_cond_wait);
4341 CHECK_COND(___lwp_cond_wait);
4342 
4343 CHECK_COND2(  _lwp_cond_timedwait);
4344 CHECK_COND2( __lwp_cond_timedwait);
4345 #undef mutex_t
4346 #undef cond_t
4347 
4348 CHECK_SYNCH_OP(int, _lwp_suspend2,       (int lwp, int *n), (lwp, n), 0);
4349 CHECK_SYNCH_OP(int,__lwp_suspend2,       (int lwp, int *n), (lwp, n), 0);
4350 CHECK_SYNCH_OP(int, _lwp_kill,           (int lwp, int n),  (lwp, n), 0);
4351 CHECK_SYNCH_OP(int,__lwp_kill,           (int lwp, int n),  (lwp, n), 0);
4352 CHECK_SYNCH_OP(int, _lwp_sema_wait,      (lwp_sema_t* p),   (p),  CHECK_P(p));
4353 CHECK_SYNCH_OP(int,__lwp_sema_wait,      (lwp_sema_t* p),   (p),  CHECK_P(p));
4354 CHECK_SYNCH_OP(int, _lwp_cond_broadcast, (lwp_cond_t* cv),  (cv), CHECK_CV);
4355 CHECK_SYNCH_OP(int,__lwp_cond_broadcast, (lwp_cond_t* cv),  (cv), CHECK_CV);
4356 
4357 
4358 // recording machinery:
4359 
4360 enum { RECORD_SYNCH_LIMIT = 200 };
4361 char* record_synch_name[RECORD_SYNCH_LIMIT];
4362 void* record_synch_arg0ptr[RECORD_SYNCH_LIMIT];
4363 bool record_synch_returning[RECORD_SYNCH_LIMIT];
4364 thread_t record_synch_thread[RECORD_SYNCH_LIMIT];
4365 int record_synch_count = 0;
4366 bool record_synch_enabled = false;
4367 
4368 // in dbx, examine recorded data this way:
4369 // for n in name arg0ptr returning thread; do print record_synch_$n[0..record_synch_count-1]; done
4370 
4371 void record_synch(char* name, bool returning) {
4372   if (record_synch_enabled) {
4373     if (record_synch_count &lt; RECORD_SYNCH_LIMIT) {
4374       record_synch_name[record_synch_count] = name;
4375       record_synch_returning[record_synch_count] = returning;
4376       record_synch_thread[record_synch_count] = thr_self();
4377       record_synch_arg0ptr[record_synch_count] = &amp;name;
4378       record_synch_count++;
4379     }
4380     // put more checking code here:
4381     // ...
4382   }
4383 }
4384 
4385 void record_synch_enable() {
4386   // start collecting trace data, if not already doing so
4387   if (!record_synch_enabled)  record_synch_count = 0;
4388   record_synch_enabled = true;
4389 }
4390 
4391 void record_synch_disable() {
4392   // stop collecting trace data
4393   record_synch_enabled = false;
4394 }
4395 
4396 #endif // INTERPOSE_ON_SYSTEM_SYNCH_FUNCTIONS
4397 #endif // PRODUCT
4398 
4399 const intptr_t thr_time_off  = (intptr_t)(&amp;((prusage_t *)(NULL))-&gt;pr_utime);
4400 const intptr_t thr_time_size = (intptr_t)(&amp;((prusage_t *)(NULL))-&gt;pr_ttime) -
4401                                (intptr_t)(&amp;((prusage_t *)(NULL))-&gt;pr_utime);
4402 
4403 
4404 // JVMTI &amp; JVM monitoring and management support
4405 // The thread_cpu_time() and current_thread_cpu_time() are only
4406 // supported if is_thread_cpu_time_supported() returns true.
4407 // They are not supported on Solaris T1.
4408 
4409 // current_thread_cpu_time(bool) and thread_cpu_time(Thread*, bool)
4410 // are used by JVM M&amp;M and JVMTI to get user+sys or user CPU time
4411 // of a thread.
4412 //
4413 // current_thread_cpu_time() and thread_cpu_time(Thread *)
4414 // returns the fast estimate available on the platform.
4415 
4416 // hrtime_t gethrvtime() return value includes
4417 // user time but does not include system time
4418 jlong os::current_thread_cpu_time() {
4419   return (jlong) gethrvtime();
4420 }
4421 
4422 jlong os::thread_cpu_time(Thread *thread) {
4423   // return user level CPU time only to be consistent with
4424   // what current_thread_cpu_time returns.
4425   // thread_cpu_time_info() must be changed if this changes
4426   return os::thread_cpu_time(thread, false /* user time only */);
4427 }
4428 
4429 jlong os::current_thread_cpu_time(bool user_sys_cpu_time) {
4430   if (user_sys_cpu_time) {
4431     return os::thread_cpu_time(Thread::current(), user_sys_cpu_time);
4432   } else {
4433     return os::current_thread_cpu_time();
4434   }
4435 }
4436 
4437 jlong os::thread_cpu_time(Thread *thread, bool user_sys_cpu_time) {
4438   char proc_name[64];
4439   int count;
4440   prusage_t prusage;
4441   jlong lwp_time;
4442   int fd;
4443 
4444   sprintf(proc_name, &quot;/proc/%d/lwp/%d/lwpusage&quot;,
4445           getpid(),
4446           thread-&gt;osthread()-&gt;lwp_id());
4447   fd = ::open(proc_name, O_RDONLY);
4448   if (fd == -1) return -1;
4449 
4450   do {
4451     count = ::pread(fd,
4452                     (void *)&amp;prusage.pr_utime,
4453                     thr_time_size,
4454                     thr_time_off);
4455   } while (count &lt; 0 &amp;&amp; errno == EINTR);
4456   ::close(fd);
4457   if (count &lt; 0) return -1;
4458 
4459   if (user_sys_cpu_time) {
4460     // user + system CPU time
4461     lwp_time = (((jlong)prusage.pr_stime.tv_sec +
4462                  (jlong)prusage.pr_utime.tv_sec) * (jlong)1000000000) +
4463                  (jlong)prusage.pr_stime.tv_nsec +
4464                  (jlong)prusage.pr_utime.tv_nsec;
4465   } else {
4466     // user level CPU time only
4467     lwp_time = ((jlong)prusage.pr_utime.tv_sec * (jlong)1000000000) +
4468                 (jlong)prusage.pr_utime.tv_nsec;
4469   }
4470 
4471   return (lwp_time);
4472 }
4473 
4474 void os::current_thread_cpu_time_info(jvmtiTimerInfo *info_ptr) {
4475   info_ptr-&gt;max_value = ALL_64_BITS;      // will not wrap in less than 64 bits
4476   info_ptr-&gt;may_skip_backward = false;    // elapsed time not wall time
4477   info_ptr-&gt;may_skip_forward = false;     // elapsed time not wall time
4478   info_ptr-&gt;kind = JVMTI_TIMER_USER_CPU;  // only user time is returned
4479 }
4480 
4481 void os::thread_cpu_time_info(jvmtiTimerInfo *info_ptr) {
4482   info_ptr-&gt;max_value = ALL_64_BITS;      // will not wrap in less than 64 bits
4483   info_ptr-&gt;may_skip_backward = false;    // elapsed time not wall time
4484   info_ptr-&gt;may_skip_forward = false;     // elapsed time not wall time
4485   info_ptr-&gt;kind = JVMTI_TIMER_USER_CPU;  // only user time is returned
4486 }
4487 
4488 bool os::is_thread_cpu_time_supported() {
4489   return true;
4490 }
4491 
4492 // System loadavg support.  Returns -1 if load average cannot be obtained.
4493 // Return the load average for our processor set if the primitive exists
4494 // (Solaris 9 and later).  Otherwise just return system wide loadavg.
4495 int os::loadavg(double loadavg[], int nelem) {
4496   if (pset_getloadavg_ptr != NULL) {
4497     return (*pset_getloadavg_ptr)(PS_MYID, loadavg, nelem);
4498   } else {
4499     return ::getloadavg(loadavg, nelem);
4500   }
4501 }
4502 
4503 //---------------------------------------------------------------------------------
4504 
4505 bool os::find(address addr, outputStream* st) {
4506   Dl_info dlinfo;
4507   memset(&amp;dlinfo, 0, sizeof(dlinfo));
4508   if (dladdr(addr, &amp;dlinfo) != 0) {
4509     st-&gt;print(PTR_FORMAT &quot;: &quot;, addr);
4510     if (dlinfo.dli_sname != NULL &amp;&amp; dlinfo.dli_saddr != NULL) {
4511       st-&gt;print(&quot;%s+%#lx&quot;, dlinfo.dli_sname, addr-(intptr_t)dlinfo.dli_saddr);
4512     } else if (dlinfo.dli_fbase != NULL) {
4513       st-&gt;print(&quot;&lt;offset %#lx&gt;&quot;, addr-(intptr_t)dlinfo.dli_fbase);
4514     } else {
4515       st-&gt;print(&quot;&lt;absolute address&gt;&quot;);
4516     }
4517     if (dlinfo.dli_fname != NULL) {
4518       st-&gt;print(&quot; in %s&quot;, dlinfo.dli_fname);
4519     }
4520     if (dlinfo.dli_fbase != NULL) {
4521       st-&gt;print(&quot; at &quot; PTR_FORMAT, dlinfo.dli_fbase);
4522     }
4523     st-&gt;cr();
4524 
4525     if (Verbose) {
4526       // decode some bytes around the PC
4527       address begin = clamp_address_in_page(addr-40, addr, os::vm_page_size());
4528       address end   = clamp_address_in_page(addr+40, addr, os::vm_page_size());
4529       address       lowest = (address) dlinfo.dli_sname;
4530       if (!lowest)  lowest = (address) dlinfo.dli_fbase;
4531       if (begin &lt; lowest)  begin = lowest;
4532       Dl_info dlinfo2;
4533       if (dladdr(end, &amp;dlinfo2) != 0 &amp;&amp; dlinfo2.dli_saddr != dlinfo.dli_saddr
4534           &amp;&amp; end &gt; dlinfo2.dli_saddr &amp;&amp; dlinfo2.dli_saddr &gt; begin) {
4535         end = (address) dlinfo2.dli_saddr;
4536       }
4537       Disassembler::decode(begin, end, st);
4538     }
4539     return true;
4540   }
4541   return false;
4542 }
4543 
4544 // Following function has been added to support HotSparc&#39;s libjvm.so running
4545 // under Solaris production JDK 1.2.2 / 1.3.0.  These came from
4546 // src/solaris/hpi/native_threads in the EVM codebase.
4547 //
4548 // NOTE: This is no longer needed in the 1.3.1 and 1.4 production release
4549 // libraries and should thus be removed. We will leave it behind for a while
4550 // until we no longer want to able to run on top of 1.3.0 Solaris production
4551 // JDK. See 4341971.
4552 
4553 #define STACK_SLACK 0x800
4554 
4555 extern &quot;C&quot; {
4556   intptr_t sysThreadAvailableStackWithSlack() {
4557     stack_t st;
4558     intptr_t retval, stack_top;
4559     retval = thr_stksegment(&amp;st);
4560     assert(retval == 0, &quot;incorrect return value from thr_stksegment&quot;);
4561     assert((address)&amp;st &lt; (address)st.ss_sp, &quot;Invalid stack base returned&quot;);
4562     assert((address)&amp;st &gt; (address)st.ss_sp-st.ss_size, &quot;Invalid stack size returned&quot;);
4563     stack_top=(intptr_t)st.ss_sp-st.ss_size;
4564     return ((intptr_t)&amp;stack_top - stack_top - STACK_SLACK);
4565   }
4566 }
4567 
4568 // ObjectMonitor park-unpark infrastructure ...
4569 //
4570 // We implement Solaris and Linux PlatformEvents with the
4571 // obvious condvar-mutex-flag triple.
4572 // Another alternative that works quite well is pipes:
4573 // Each PlatformEvent consists of a pipe-pair.
4574 // The thread associated with the PlatformEvent
4575 // calls park(), which reads from the input end of the pipe.
4576 // Unpark() writes into the other end of the pipe.
4577 // The write-side of the pipe must be set NDELAY.
4578 // Unfortunately pipes consume a large # of handles.
4579 // Native solaris lwp_park() and lwp_unpark() work nicely, too.
4580 // Using pipes for the 1st few threads might be workable, however.
4581 //
4582 // park() is permitted to return spuriously.
4583 // Callers of park() should wrap the call to park() in
4584 // an appropriate loop.  A litmus test for the correct
4585 // usage of park is the following: if park() were modified
4586 // to immediately return 0 your code should still work,
4587 // albeit degenerating to a spin loop.
4588 //
4589 // In a sense, park()-unpark() just provides more polite spinning
4590 // and polling with the key difference over naive spinning being
4591 // that a parked thread needs to be explicitly unparked() in order
4592 // to wake up and to poll the underlying condition.
4593 //
4594 // Assumption:
4595 //    Only one parker can exist on an event, which is why we allocate
4596 //    them per-thread. Multiple unparkers can coexist.
4597 //
4598 // _Event transitions in park()
4599 //   -1 =&gt; -1 : illegal
4600 //    1 =&gt;  0 : pass - return immediately
4601 //    0 =&gt; -1 : block; then set _Event to 0 before returning
4602 //
4603 // _Event transitions in unpark()
4604 //    0 =&gt; 1 : just return
4605 //    1 =&gt; 1 : just return
4606 //   -1 =&gt; either 0 or 1; must signal target thread
4607 //         That is, we can safely transition _Event from -1 to either
4608 //         0 or 1.
4609 //
4610 // _Event serves as a restricted-range semaphore.
4611 //   -1 : thread is blocked, i.e. there is a waiter
4612 //    0 : neutral: thread is running or ready,
4613 //        could have been signaled after a wait started
4614 //    1 : signaled - thread is running or ready
4615 //
4616 // Another possible encoding of _Event would be with
4617 // explicit &quot;PARKED&quot; == 01b and &quot;SIGNALED&quot; == 10b bits.
4618 //
4619 // TODO-FIXME: add DTRACE probes for:
4620 // 1.   Tx parks
4621 // 2.   Ty unparks Tx
4622 // 3.   Tx resumes from park
4623 
4624 
4625 // value determined through experimentation
4626 #define ROUNDINGFIX 11
4627 
4628 // utility to compute the abstime argument to timedwait.
4629 // TODO-FIXME: switch from compute_abstime() to unpackTime().
4630 
4631 static timestruc_t* compute_abstime(timestruc_t* abstime, jlong millis) {
4632   // millis is the relative timeout time
4633   // abstime will be the absolute timeout time
4634   if (millis &lt; 0)  millis = 0;
4635   struct timeval now;
4636   int status = gettimeofday(&amp;now, NULL);
4637   assert(status == 0, &quot;gettimeofday&quot;);
4638   jlong seconds = millis / 1000;
4639   jlong max_wait_period;
4640 
4641   if (UseLWPSynchronization) {
4642     // forward port of fix for 4275818 (not sleeping long enough)
4643     // There was a bug in Solaris 6, 7 and pre-patch 5 of 8 where
4644     // _lwp_cond_timedwait() used a round_down algorithm rather
4645     // than a round_up. For millis less than our roundfactor
4646     // it rounded down to 0 which doesn&#39;t meet the spec.
4647     // For millis &gt; roundfactor we may return a bit sooner, but
4648     // since we can not accurately identify the patch level and
4649     // this has already been fixed in Solaris 9 and 8 we will
4650     // leave it alone rather than always rounding down.
4651 
4652     if (millis &gt; 0 &amp;&amp; millis &lt; ROUNDINGFIX) millis = ROUNDINGFIX;
4653     // It appears that when we go directly through Solaris _lwp_cond_timedwait()
4654     // the acceptable max time threshold is smaller than for libthread on 2.5.1 and 2.6
4655     max_wait_period = 21000000;
4656   } else {
4657     max_wait_period = 50000000;
4658   }
4659   millis %= 1000;
4660   if (seconds &gt; max_wait_period) {      // see man cond_timedwait(3T)
4661     seconds = max_wait_period;
4662   }
4663   abstime-&gt;tv_sec = now.tv_sec  + seconds;
4664   long       usec = now.tv_usec + millis * 1000;
4665   if (usec &gt;= 1000000) {
4666     abstime-&gt;tv_sec += 1;
4667     usec -= 1000000;
4668   }
4669   abstime-&gt;tv_nsec = usec * 1000;
4670   return abstime;
4671 }
4672 
4673 void os::PlatformEvent::park() {           // AKA: down()
4674   // Transitions for _Event:
4675   //   -1 =&gt; -1 : illegal
4676   //    1 =&gt;  0 : pass - return immediately
4677   //    0 =&gt; -1 : block; then set _Event to 0 before returning
4678 
4679   // Invariant: Only the thread associated with the Event/PlatformEvent
4680   // may call park().
4681   assert(_nParked == 0, &quot;invariant&quot;);
4682 
4683   int v;
4684   for (;;) {
4685     v = _Event;
4686     if (Atomic::cmpxchg(&amp;_Event, v, v-1) == v) break;
4687   }
4688   guarantee(v &gt;= 0, &quot;invariant&quot;);
4689   if (v == 0) {
4690     // Do this the hard way by blocking ...
4691     // See http://monaco.sfbay/detail.jsf?cr=5094058.
4692     int status = os::Solaris::mutex_lock(_mutex);
4693     assert_status(status == 0, status, &quot;mutex_lock&quot;);
4694     guarantee(_nParked == 0, &quot;invariant&quot;);
4695     ++_nParked;
4696     while (_Event &lt; 0) {
4697       // for some reason, under 2.7 lwp_cond_wait() may return ETIME ...
4698       // Treat this the same as if the wait was interrupted
4699       // With usr/lib/lwp going to kernel, always handle ETIME
4700       status = os::Solaris::cond_wait(_cond, _mutex);
4701       if (status == ETIME) status = EINTR;
4702       assert_status(status == 0 || status == EINTR, status, &quot;cond_wait&quot;);
4703     }
4704     --_nParked;
4705     _Event = 0;
4706     status = os::Solaris::mutex_unlock(_mutex);
4707     assert_status(status == 0, status, &quot;mutex_unlock&quot;);
4708     // Paranoia to ensure our locked and lock-free paths interact
4709     // correctly with each other.
4710     OrderAccess::fence();
4711   }
4712 }
4713 
4714 int os::PlatformEvent::park(jlong millis) {
4715   // Transitions for _Event:
4716   //   -1 =&gt; -1 : illegal
4717   //    1 =&gt;  0 : pass - return immediately
4718   //    0 =&gt; -1 : block; then set _Event to 0 before returning
4719 
4720   guarantee(_nParked == 0, &quot;invariant&quot;);
4721   int v;
4722   for (;;) {
4723     v = _Event;
4724     if (Atomic::cmpxchg(&amp;_Event, v, v-1) == v) break;
4725   }
4726   guarantee(v &gt;= 0, &quot;invariant&quot;);
4727   if (v != 0) return OS_OK;
4728 
4729   int ret = OS_TIMEOUT;
4730   timestruc_t abst;
4731   compute_abstime(&amp;abst, millis);
4732 
4733   // See http://monaco.sfbay/detail.jsf?cr=5094058.
4734   int status = os::Solaris::mutex_lock(_mutex);
4735   assert_status(status == 0, status, &quot;mutex_lock&quot;);
4736   guarantee(_nParked == 0, &quot;invariant&quot;);
4737   ++_nParked;
4738   while (_Event &lt; 0) {
4739     int status = os::Solaris::cond_timedwait(_cond, _mutex, &amp;abst);
4740     assert_status(status == 0 || status == EINTR ||
4741                   status == ETIME || status == ETIMEDOUT,
4742                   status, &quot;cond_timedwait&quot;);
4743     if (!FilterSpuriousWakeups) break;                // previous semantics
4744     if (status == ETIME || status == ETIMEDOUT) break;
4745     // We consume and ignore EINTR and spurious wakeups.
4746   }
4747   --_nParked;
4748   if (_Event &gt;= 0) ret = OS_OK;
4749   _Event = 0;
4750   status = os::Solaris::mutex_unlock(_mutex);
4751   assert_status(status == 0, status, &quot;mutex_unlock&quot;);
4752   // Paranoia to ensure our locked and lock-free paths interact
4753   // correctly with each other.
4754   OrderAccess::fence();
4755   return ret;
4756 }
4757 
4758 void os::PlatformEvent::unpark() {
4759   // Transitions for _Event:
4760   //    0 =&gt; 1 : just return
4761   //    1 =&gt; 1 : just return
4762   //   -1 =&gt; either 0 or 1; must signal target thread
4763   //         That is, we can safely transition _Event from -1 to either
4764   //         0 or 1.
4765   // See also: &quot;Semaphores in Plan 9&quot; by Mullender &amp; Cox
4766   //
4767   // Note: Forcing a transition from &quot;-1&quot; to &quot;1&quot; on an unpark() means
4768   // that it will take two back-to-back park() calls for the owning
4769   // thread to block. This has the benefit of forcing a spurious return
4770   // from the first park() call after an unpark() call which will help
4771   // shake out uses of park() and unpark() without condition variables.
4772 
4773   if (Atomic::xchg(&amp;_Event, 1) &gt;= 0) return;
4774 
4775   // If the thread associated with the event was parked, wake it.
4776   // Wait for the thread assoc with the PlatformEvent to vacate.
4777   int status = os::Solaris::mutex_lock(_mutex);
4778   assert_status(status == 0, status, &quot;mutex_lock&quot;);
4779   int AnyWaiters = _nParked;
4780   status = os::Solaris::mutex_unlock(_mutex);
4781   assert_status(status == 0, status, &quot;mutex_unlock&quot;);
4782   guarantee(AnyWaiters == 0 || AnyWaiters == 1, &quot;invariant&quot;);
4783   if (AnyWaiters != 0) {
4784     // Note that we signal() *after* dropping the lock for &quot;immortal&quot; Events.
4785     // This is safe and avoids a common class of  futile wakeups.  In rare
4786     // circumstances this can cause a thread to return prematurely from
4787     // cond_{timed}wait() but the spurious wakeup is benign and the victim
4788     // will simply re-test the condition and re-park itself.
4789     // This provides particular benefit if the underlying platform does not
4790     // provide wait morphing.
4791     status = os::Solaris::cond_signal(_cond);
4792     assert_status(status == 0, status, &quot;cond_signal&quot;);
4793   }
4794 }
4795 
4796 // JSR166
4797 // -------------------------------------------------------
4798 
4799 // The solaris and linux implementations of park/unpark are fairly
4800 // conservative for now, but can be improved. They currently use a
4801 // mutex/condvar pair, plus _counter.
4802 // Park decrements _counter if &gt; 0, else does a condvar wait.  Unpark
4803 // sets count to 1 and signals condvar.  Only one thread ever waits
4804 // on the condvar. Contention seen when trying to park implies that someone
4805 // is unparking you, so don&#39;t wait. And spurious returns are fine, so there
4806 // is no need to track notifications.
4807 
4808 #define MAX_SECS 100000000
4809 
4810 // This code is common to linux and solaris and will be moved to a
4811 // common place in dolphin.
4812 //
4813 // The passed in time value is either a relative time in nanoseconds
4814 // or an absolute time in milliseconds. Either way it has to be unpacked
4815 // into suitable seconds and nanoseconds components and stored in the
4816 // given timespec structure.
4817 // Given time is a 64-bit value and the time_t used in the timespec is only
4818 // a signed-32-bit value (except on 64-bit Linux) we have to watch for
4819 // overflow if times way in the future are given. Further on Solaris versions
4820 // prior to 10 there is a restriction (see cond_timedwait) that the specified
4821 // number of seconds, in abstime, is less than current_time  + 100,000,000.
4822 // As it will be 28 years before &quot;now + 100000000&quot; will overflow we can
4823 // ignore overflow and just impose a hard-limit on seconds using the value
4824 // of &quot;now + 100,000,000&quot;. This places a limit on the timeout of about 3.17
4825 // years from &quot;now&quot;.
4826 //
4827 static void unpackTime(timespec* absTime, bool isAbsolute, jlong time) {
4828   assert(time &gt; 0, &quot;convertTime&quot;);
4829 
4830   struct timeval now;
4831   int status = gettimeofday(&amp;now, NULL);
4832   assert(status == 0, &quot;gettimeofday&quot;);
4833 
4834   time_t max_secs = now.tv_sec + MAX_SECS;
4835 
4836   if (isAbsolute) {
4837     jlong secs = time / 1000;
4838     if (secs &gt; max_secs) {
4839       absTime-&gt;tv_sec = max_secs;
4840     } else {
4841       absTime-&gt;tv_sec = secs;
4842     }
4843     absTime-&gt;tv_nsec = (time % 1000) * NANOSECS_PER_MILLISEC;
4844   } else {
4845     jlong secs = time / NANOSECS_PER_SEC;
4846     if (secs &gt;= MAX_SECS) {
4847       absTime-&gt;tv_sec = max_secs;
4848       absTime-&gt;tv_nsec = 0;
4849     } else {
4850       absTime-&gt;tv_sec = now.tv_sec + secs;
4851       absTime-&gt;tv_nsec = (time % NANOSECS_PER_SEC) + now.tv_usec*1000;
4852       if (absTime-&gt;tv_nsec &gt;= NANOSECS_PER_SEC) {
4853         absTime-&gt;tv_nsec -= NANOSECS_PER_SEC;
4854         ++absTime-&gt;tv_sec; // note: this must be &lt;= max_secs
4855       }
4856     }
4857   }
4858   assert(absTime-&gt;tv_sec &gt;= 0, &quot;tv_sec &lt; 0&quot;);
4859   assert(absTime-&gt;tv_sec &lt;= max_secs, &quot;tv_sec &gt; max_secs&quot;);
4860   assert(absTime-&gt;tv_nsec &gt;= 0, &quot;tv_nsec &lt; 0&quot;);
4861   assert(absTime-&gt;tv_nsec &lt; NANOSECS_PER_SEC, &quot;tv_nsec &gt;= nanos_per_sec&quot;);
4862 }
4863 
4864 void Parker::park(bool isAbsolute, jlong time) {
4865   // Ideally we&#39;d do something useful while spinning, such
4866   // as calling unpackTime().
4867 
4868   // Optional fast-path check:
4869   // Return immediately if a permit is available.
4870   // We depend on Atomic::xchg() having full barrier semantics
4871   // since we are doing a lock-free update to _counter.
4872   if (Atomic::xchg(&amp;_counter, 0) &gt; 0) return;
4873 
4874   // Optional fast-exit: Check interrupt before trying to wait
4875   Thread* thread = Thread::current();
4876   assert(thread-&gt;is_Java_thread(), &quot;Must be JavaThread&quot;);
4877   JavaThread *jt = (JavaThread *)thread;
4878   if (jt-&gt;is_interrupted(false)) {
4879     return;
4880   }
4881 
4882   // First, demultiplex/decode time arguments
4883   timespec absTime;
4884   if (time &lt; 0 || (isAbsolute &amp;&amp; time == 0)) { // don&#39;t wait at all
4885     return;
4886   }
4887   if (time &gt; 0) {
4888     // Warning: this code might be exposed to the old Solaris time
4889     // round-down bugs.  Grep &quot;roundingFix&quot; for details.
4890     unpackTime(&amp;absTime, isAbsolute, time);
4891   }
4892 
4893   // Enter safepoint region
4894   // Beware of deadlocks such as 6317397.
4895   // The per-thread Parker:: _mutex is a classic leaf-lock.
4896   // In particular a thread must never block on the Threads_lock while
4897   // holding the Parker:: mutex.  If safepoints are pending both the
4898   // the ThreadBlockInVM() CTOR and DTOR may grab Threads_lock.
4899   ThreadBlockInVM tbivm(jt);
4900 
4901   // Can&#39;t access interrupt state now that we are _thread_blocked. If we&#39;ve
4902   // been interrupted since we checked above then _counter will be &gt; 0.
4903 
4904   // Don&#39;t wait if cannot get lock since interference arises from
4905   // unblocking.
4906   if (os::Solaris::mutex_trylock(_mutex) != 0) {
4907     return;
4908   }
4909 
4910   int status;
4911 
4912   if (_counter &gt; 0)  { // no wait needed
4913     _counter = 0;
4914     status = os::Solaris::mutex_unlock(_mutex);
4915     assert(status == 0, &quot;invariant&quot;);
4916     // Paranoia to ensure our locked and lock-free paths interact
4917     // correctly with each other and Java-level accesses.
4918     OrderAccess::fence();
4919     return;
4920   }
4921 
4922   OSThreadWaitState osts(thread-&gt;osthread(), false /* not Object.wait() */);
4923   jt-&gt;set_suspend_equivalent();
4924   // cleared by handle_special_suspend_equivalent_condition() or java_suspend_self()
4925 
4926   // Do this the hard way by blocking ...
4927   // See http://monaco.sfbay/detail.jsf?cr=5094058.
4928   if (time == 0) {
4929     status = os::Solaris::cond_wait(_cond, _mutex);
4930   } else {
4931     status = os::Solaris::cond_timedwait (_cond, _mutex, &amp;absTime);
4932   }
4933   // Note that an untimed cond_wait() can sometimes return ETIME on older
4934   // versions of the Solaris.
4935   assert_status(status == 0 || status == EINTR ||
4936                 status == ETIME || status == ETIMEDOUT,
4937                 status, &quot;cond_timedwait&quot;);
4938 
4939   _counter = 0;
4940   status = os::Solaris::mutex_unlock(_mutex);
4941   assert_status(status == 0, status, &quot;mutex_unlock&quot;);
4942   // Paranoia to ensure our locked and lock-free paths interact
4943   // correctly with each other and Java-level accesses.
4944   OrderAccess::fence();
4945 
4946   // If externally suspended while waiting, re-suspend
4947   if (jt-&gt;handle_special_suspend_equivalent_condition()) {
4948     jt-&gt;java_suspend_self();
4949   }
4950 }
4951 
4952 void Parker::unpark() {
4953   int status = os::Solaris::mutex_lock(_mutex);
4954   assert(status == 0, &quot;invariant&quot;);
4955   const int s = _counter;
4956   _counter = 1;
4957   status = os::Solaris::mutex_unlock(_mutex);
4958   assert(status == 0, &quot;invariant&quot;);
4959 
4960   if (s &lt; 1) {
4961     status = os::Solaris::cond_signal(_cond);
4962     assert(status == 0, &quot;invariant&quot;);
4963   }
4964 }
4965 
4966 // Platform Mutex/Monitor implementations
4967 
4968 os::PlatformMutex::PlatformMutex() {
4969   int status = os::Solaris::mutex_init(&amp;_mutex);
4970   assert_status(status == 0, status, &quot;mutex_init&quot;);
4971 }
4972 
4973 os::PlatformMutex::~PlatformMutex() {
4974   int status = os::Solaris::mutex_destroy(&amp;_mutex);
4975   assert_status(status == 0, status, &quot;mutex_destroy&quot;);
4976 }
4977 
4978 void os::PlatformMutex::lock() {
4979   int status = os::Solaris::mutex_lock(&amp;_mutex);
4980   assert_status(status == 0, status, &quot;mutex_lock&quot;);
4981 }
4982 
4983 void os::PlatformMutex::unlock() {
4984   int status = os::Solaris::mutex_unlock(&amp;_mutex);
4985   assert_status(status == 0, status, &quot;mutex_unlock&quot;);
4986 }
4987 
4988 bool os::PlatformMutex::try_lock() {
4989   int status = os::Solaris::mutex_trylock(&amp;_mutex);
4990   assert_status(status == 0 || status == EBUSY, status, &quot;mutex_trylock&quot;);
4991   return status == 0;
4992 }
4993 
4994 os::PlatformMonitor::PlatformMonitor() {
4995   int status = os::Solaris::cond_init(&amp;_cond);
4996   assert_status(status == 0, status, &quot;cond_init&quot;);
4997 }
4998 
4999 os::PlatformMonitor::~PlatformMonitor() {
5000   int status = os::Solaris::cond_destroy(&amp;_cond);
5001   assert_status(status == 0, status, &quot;cond_destroy&quot;);
5002 }
5003 
5004 // Must already be locked
5005 int os::PlatformMonitor::wait(jlong millis) {
5006   assert(millis &gt;= 0, &quot;negative timeout&quot;);
5007   if (millis &gt; 0) {
5008     timestruc_t abst;
5009     int ret = OS_TIMEOUT;
5010     compute_abstime(&amp;abst, millis);
5011     int status = os::Solaris::cond_timedwait(&amp;_cond, &amp;_mutex, &amp;abst);
5012     assert_status(status == 0 || status == EINTR ||
5013                   status == ETIME || status == ETIMEDOUT,
5014                   status, &quot;cond_timedwait&quot;);
5015     // EINTR acts as spurious wakeup - which is permitted anyway
5016     if (status == 0 || status == EINTR) {
5017       ret = OS_OK;
5018     }
5019     return ret;
5020   } else {
5021     int status = os::Solaris::cond_wait(&amp;_cond, &amp;_mutex);
5022     assert_status(status == 0 || status == EINTR,
5023                   status, &quot;cond_wait&quot;);
5024     return OS_OK;
5025   }
5026 }
5027 
5028 void os::PlatformMonitor::notify() {
5029   int status = os::Solaris::cond_signal(&amp;_cond);
5030   assert_status(status == 0, status, &quot;cond_signal&quot;);
5031 }
5032 
5033 void os::PlatformMonitor::notify_all() {
5034   int status = os::Solaris::cond_broadcast(&amp;_cond);
5035   assert_status(status == 0, status, &quot;cond_broadcast&quot;);
5036 }
5037 
5038 extern char** environ;
5039 
5040 // Run the specified command in a separate process. Return its exit value,
5041 // or -1 on failure (e.g. can&#39;t fork a new process).
5042 // Unlike system(), this function can be called from signal handler. It
5043 // doesn&#39;t block SIGINT et al.
5044 int os::fork_and_exec(char* cmd, bool use_vfork_if_available) {
5045   char * argv[4];
5046   argv[0] = (char *)&quot;sh&quot;;
5047   argv[1] = (char *)&quot;-c&quot;;
5048   argv[2] = cmd;
5049   argv[3] = NULL;
5050 
5051   // fork is async-safe, fork1 is not so can&#39;t use in signal handler
5052   pid_t pid;
5053   Thread* t = Thread::current_or_null_safe();
5054   if (t != NULL &amp;&amp; t-&gt;is_inside_signal_handler()) {
5055     pid = fork();
5056   } else {
5057     pid = fork1();
5058   }
5059 
5060   if (pid &lt; 0) {
5061     // fork failed
5062     warning(&quot;fork failed: %s&quot;, os::strerror(errno));
5063     return -1;
5064 
5065   } else if (pid == 0) {
5066     // child process
5067 
5068     // try to be consistent with system(), which uses &quot;/usr/bin/sh&quot; on Solaris
5069     execve(&quot;/usr/bin/sh&quot;, argv, environ);
5070 
5071     // execve failed
5072     _exit(-1);
5073 
5074   } else  {
5075     // copied from J2SE ..._waitForProcessExit() in UNIXProcess_md.c; we don&#39;t
5076     // care about the actual exit code, for now.
5077 
5078     int status;
5079 
5080     // Wait for the child process to exit.  This returns immediately if
5081     // the child has already exited. */
5082     while (waitpid(pid, &amp;status, 0) &lt; 0) {
5083       switch (errno) {
5084       case ECHILD: return 0;
5085       case EINTR: break;
5086       default: return -1;
5087       }
5088     }
5089 
5090     if (WIFEXITED(status)) {
5091       // The child exited normally; get its exit code.
5092       return WEXITSTATUS(status);
5093     } else if (WIFSIGNALED(status)) {
5094       // The child exited because of a signal
5095       // The best value to return is 0x80 + signal number,
5096       // because that is what all Unix shells do, and because
5097       // it allows callers to distinguish between process exit and
5098       // process death by signal.
5099       return 0x80 + WTERMSIG(status);
5100     } else {
5101       // Unknown exit code; pass it through
5102       return status;
5103     }
5104   }
5105 }
5106 
5107 size_t os::write(int fd, const void *buf, unsigned int nBytes) {
5108   size_t res;
5109   RESTARTABLE((size_t) ::write(fd, buf, (size_t) nBytes), res);
5110   return res;
5111 }
5112 
5113 int os::close(int fd) {
5114   return ::close(fd);
5115 }
5116 
5117 int os::socket_close(int fd) {
5118   return ::close(fd);
5119 }
5120 
5121 int os::recv(int fd, char* buf, size_t nBytes, uint flags) {
5122   assert(((JavaThread*)Thread::current())-&gt;thread_state() == _thread_in_native,
5123          &quot;Assumed _thread_in_native&quot;);
5124   RESTARTABLE_RETURN_INT((int)::recv(fd, buf, nBytes, flags));
5125 }
5126 
5127 int os::send(int fd, char* buf, size_t nBytes, uint flags) {
5128   assert(((JavaThread*)Thread::current())-&gt;thread_state() == _thread_in_native,
5129          &quot;Assumed _thread_in_native&quot;);
5130   RESTARTABLE_RETURN_INT((int)::send(fd, buf, nBytes, flags));
5131 }
5132 
5133 int os::raw_send(int fd, char* buf, size_t nBytes, uint flags) {
5134   RESTARTABLE_RETURN_INT((int)::send(fd, buf, nBytes, flags));
5135 }
5136 
5137 // As both poll and select can be interrupted by signals, we have to be
5138 // prepared to restart the system call after updating the timeout, unless
5139 // a poll() is done with timeout == -1, in which case we repeat with this
5140 // &quot;wait forever&quot; value.
5141 
5142 int os::connect(int fd, struct sockaddr *him, socklen_t len) {
5143   int _result;
5144   _result = ::connect(fd, him, len);
5145 
5146   // On Solaris, when a connect() call is interrupted, the connection
5147   // can be established asynchronously (see 6343810). Subsequent calls
5148   // to connect() must check the errno value which has the semantic
5149   // described below (copied from the connect() man page). Handling
5150   // of asynchronously established connections is required for both
5151   // blocking and non-blocking sockets.
5152   //     EINTR            The  connection  attempt  was   interrupted
5153   //                      before  any data arrived by the delivery of
5154   //                      a signal. The connection, however, will  be
5155   //                      established asynchronously.
5156   //
5157   //     EINPROGRESS      The socket is non-blocking, and the connec-
5158   //                      tion  cannot  be completed immediately.
5159   //
5160   //     EALREADY         The socket is non-blocking,  and a previous
5161   //                      connection  attempt  has  not yet been com-
5162   //                      pleted.
5163   //
5164   //     EISCONN          The socket is already connected.
5165   if (_result == OS_ERR &amp;&amp; errno == EINTR) {
5166     // restarting a connect() changes its errno semantics
5167     RESTARTABLE(::connect(fd, him, len), _result);
5168     // undo these changes
5169     if (_result == OS_ERR) {
5170       if (errno == EALREADY) {
5171         errno = EINPROGRESS; // fall through
5172       } else if (errno == EISCONN) {
5173         errno = 0;
5174         return OS_OK;
5175       }
5176     }
5177   }
5178   return _result;
5179 }
5180 
5181 // Get the default path to the core file
5182 // Returns the length of the string
5183 int os::get_core_path(char* buffer, size_t bufferSize) {
5184   const char* p = get_current_directory(buffer, bufferSize);
5185 
5186   if (p == NULL) {
5187     assert(p != NULL, &quot;failed to get current directory&quot;);
5188     return 0;
5189   }
5190 
5191   jio_snprintf(buffer, bufferSize, &quot;%s/core or core.%d&quot;,
5192                                               p, current_process_id());
5193 
5194   return strlen(buffer);
5195 }
5196 
5197 bool os::supports_map_sync() {
5198   return false;
5199 }
5200 
5201 #ifndef PRODUCT
5202 void TestReserveMemorySpecial_test() {
5203   // No tests available for this platform
5204 }
5205 #endif
5206 
5207 bool os::start_debugging(char *buf, int buflen) {
5208   int len = (int)strlen(buf);
5209   char *p = &amp;buf[len];
5210 
5211   jio_snprintf(p, buflen-len,
5212                &quot;\n\n&quot;
5213                &quot;Do you want to debug the problem?\n\n&quot;
5214                &quot;To debug, run &#39;dbx - %d&#39;; then switch to thread &quot; INTX_FORMAT &quot;\n&quot;
5215                &quot;Enter &#39;yes&#39; to launch dbx automatically (PATH must include dbx)\n&quot;
5216                &quot;Otherwise, press RETURN to abort...&quot;,
5217                os::current_process_id(), os::current_thread_id());
5218 
5219   bool yes = os::message_box(&quot;Unexpected Error&quot;, buf);
5220 
5221   if (yes) {
5222     // yes, user asked VM to launch debugger
5223     jio_snprintf(buf, sizeof(buf), &quot;dbx - %d&quot;, os::current_process_id());
5224 
5225     os::fork_and_exec(buf);
5226     yes = false;
5227   }
5228   return yes;
5229 }
<a name="2" id="anc2"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="2" type="hidden" />
</body>
</html>