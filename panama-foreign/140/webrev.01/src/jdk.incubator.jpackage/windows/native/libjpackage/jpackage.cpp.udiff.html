<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff src/jdk.incubator.jpackage/windows/native/libjpackage/jpackage.cpp</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
<body>
<center><a href="WindowsRegistry.cpp.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="../../../../jdk.internal.vm.compiler/share/classes/org.graalvm.compiler.hotspot/src/org/graalvm/compiler/hotspot/GraalHotSpotVMConfig.java.udiff.html" target="_top">next &gt;</a></center>    <h2>src/jdk.incubator.jpackage/windows/native/libjpackage/jpackage.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -21,84 +21,129 @@</span>
   * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
   * or visit www.oracle.com if you need additional information or have any
   * questions.
   */
  
<span class="udiff-line-removed">- #include &lt;stdio.h&gt;</span>
<span class="udiff-line-removed">- #include &lt;stdlib.h&gt;</span>
<span class="udiff-line-removed">- #include &lt;string&gt;</span>
<span class="udiff-line-removed">- #include &lt;windows.h&gt;</span>
<span class="udiff-line-removed">- </span>
  #include &quot;ResourceEditor.h&quot;
<span class="udiff-line-modified-removed">- #include &quot;WinErrorHandling.h&quot;</span>
<span class="udiff-line-modified-added">+ #include &quot;ErrorHandling.h&quot;</span>
  #include &quot;IconSwap.h&quot;
<span class="udiff-line-modified-removed">- #include &quot;VersionInfoSwap.h&quot;</span>
<span class="udiff-line-modified-removed">- #include &quot;Utils.h&quot;</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">- using namespace std;</span>
<span class="udiff-line-modified-added">+ #include &quot;VersionInfo.h&quot;</span>
<span class="udiff-line-modified-added">+ #include &quot;JniUtils.h&quot;</span>
  
  #ifdef __cplusplus
  extern &quot;C&quot; {
  #endif
  
      /*
<span class="udiff-line-modified-removed">-      * Class:     jdk_incubator_jpackage_internal_WindowsAppImageBuilder</span>
<span class="udiff-line-modified-added">+      * Class:     jdk_incubator_jpackage_internal_ExecutableRebrander</span>
<span class="udiff-line-added">+      * Method:    lockResource</span>
<span class="udiff-line-added">+      * Signature: (Ljava/lang/String;)J</span>
<span class="udiff-line-added">+      */</span>
<span class="udiff-line-added">+     JNIEXPORT jlong JNICALL</span>
<span class="udiff-line-added">+         Java_jdk_incubator_jpackage_internal_ExecutableRebrander_lockResource(</span>
<span class="udiff-line-added">+             JNIEnv *pEnv, jclass c, jstring jExecutable) {</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         JP_TRY;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         const std::wstring executable = jni::toUnicodeString(pEnv, jExecutable);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         return reinterpret_cast&lt;jlong&gt;(</span>
<span class="udiff-line-added">+                 ResourceEditor::FileLock(executable).ownHandle(false).get());</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         JP_CATCH_ALL;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         return 0;</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     /*</span>
<span class="udiff-line-added">+      * Class:     jdk_incubator_jpackage_internal_ExecutableRebrander</span>
<span class="udiff-line-added">+      * Method:    unlockResource</span>
<span class="udiff-line-added">+      * Signature: (J;)V</span>
<span class="udiff-line-added">+      */</span>
<span class="udiff-line-added">+     JNIEXPORT void JNICALL</span>
<span class="udiff-line-added">+         Java_jdk_incubator_jpackage_internal_ExecutableRebrander_unlockResource(</span>
<span class="udiff-line-added">+             JNIEnv *pEnv, jclass c, jlong jResourceLock) {</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         JP_TRY;</span>
<span class="udiff-line-added">+         ResourceEditor::FileLock(</span>
<span class="udiff-line-added">+                 reinterpret_cast&lt;HANDLE&gt;(jResourceLock)).ownHandle(true);</span>
<span class="udiff-line-added">+         JP_CATCH_ALL;</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     /*</span>
<span class="udiff-line-added">+      * Class:     jdk_incubator_jpackage_internal_ExecutableRebrander</span>
       * Method:    iconSwap
<span class="udiff-line-modified-removed">-      * Signature: (Ljava/lang/String;Ljava/lang/String;)I</span>
<span class="udiff-line-modified-added">+      * Signature: (J;Ljava/lang/String;)I</span>
       */
      JNIEXPORT jint JNICALL
<span class="udiff-line-modified-removed">-             Java_jdk_incubator_jpackage_internal_WindowsAppImageBuilder_iconSwap(</span>
<span class="udiff-line-modified-removed">-             JNIEnv *pEnv, jclass c, jstring jIconTarget, jstring jLauncher) {</span>
<span class="udiff-line-modified-removed">-         wstring iconTarget = GetStringFromJString(pEnv, jIconTarget);</span>
<span class="udiff-line-modified-removed">-         wstring launcher = GetStringFromJString(pEnv, jLauncher);</span>
<span class="udiff-line-modified-added">+             Java_jdk_incubator_jpackage_internal_ExecutableRebrander_iconSwap(</span>
<span class="udiff-line-modified-added">+             JNIEnv *pEnv, jclass c, jlong jResourceLock, jstring jIconTarget) {</span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-modified-added">+         JP_TRY;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         const ResourceEditor::FileLock lock(reinterpret_cast&lt;HANDLE&gt;(jResourceLock));</span>
  
<span class="udiff-line-modified-removed">-         if (ChangeIcon(iconTarget, launcher)) {</span>
<span class="udiff-line-modified-added">+         const std::wstring iconTarget = jni::toUnicodeString(pEnv, jIconTarget);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         if (ChangeIcon(lock.get(), iconTarget)) {</span>
              return 0;
          }
  
<span class="udiff-line-added">+         JP_CATCH_ALL;</span>
<span class="udiff-line-added">+ </span>
          return 1;
      }
  
      /*
<span class="udiff-line-modified-removed">-      * Class:     jdk_incubator_jpackage_internal_WindowsAppImageBuilder</span>
<span class="udiff-line-modified-added">+      * Class:     jdk_incubator_jpackage_internal_ExecutableRebrander</span>
       * Method:    versionSwap
<span class="udiff-line-modified-removed">-      * Signature: (Ljava/lang/String;Ljava/lang/String;)I</span>
<span class="udiff-line-modified-added">+      * Signature: (J;[Ljava/lang/String;)I</span>
       */
      JNIEXPORT jint JNICALL
<span class="udiff-line-modified-removed">-             Java_jdk_incubator_jpackage_internal_WindowsAppImageBuilder_versionSwap(</span>
<span class="udiff-line-modified-removed">-             JNIEnv *pEnv, jclass c, jstring jExecutableProperties,</span>
<span class="udiff-line-modified-removed">-             jstring jLauncher) {</span>
<span class="udiff-line-modified-added">+             Java_jdk_incubator_jpackage_internal_ExecutableRebrander_versionSwap(</span>
<span class="udiff-line-modified-added">+             JNIEnv *pEnv, jclass c, jlong jResourceLock,</span>
<span class="udiff-line-modified-added">+             jobjectArray jExecutableProperties) {</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         JP_TRY;</span>
  
<span class="udiff-line-modified-removed">-         wstring executableProperties = GetStringFromJString(pEnv,</span>
<span class="udiff-line-modified-added">+         const tstring_array props = jni::toUnicodeStringArray(pEnv,</span>
                  jExecutableProperties);
<span class="udiff-line-removed">-         wstring launcher = GetStringFromJString(pEnv, jLauncher);</span>
  
<span class="udiff-line-modified-removed">-         VersionInfoSwap vs(executableProperties, launcher);</span>
<span class="udiff-line-modified-removed">-         if (vs.PatchExecutable()) {</span>
<span class="udiff-line-modified-removed">-             return 0;</span>
<span class="udiff-line-modified-added">+         VersionInfo vi;</span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-modified-added">+         tstring_array::const_iterator it = props.begin();</span>
<span class="udiff-line-added">+         tstring_array::const_iterator end = props.end();</span>
<span class="udiff-line-added">+         for (; it != end; ++it) {</span>
<span class="udiff-line-added">+             const tstring name = *it;</span>
<span class="udiff-line-added">+             const tstring value = *++it;</span>
<span class="udiff-line-added">+             vi.setProperty(name, value);</span>
          }
  
<span class="udiff-line-added">+         const ResourceEditor::FileLock lock(reinterpret_cast&lt;HANDLE&gt;(jResourceLock));</span>
<span class="udiff-line-added">+         vi.apply(lock);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         return 0;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         JP_CATCH_ALL;</span>
<span class="udiff-line-added">+ </span>
          return 1;
      }
  
      /*
       * Class:     jdk_incubator_jpackage_internal_WinExeBundler
       * Method:    embedMSI
<span class="udiff-line-modified-removed">-      * Signature: (Ljava/lang/String;Ljava/lang/String;)I</span>
<span class="udiff-line-modified-added">+      * Signature: (J;Ljava/lang/String;)I</span>
       */
      JNIEXPORT jint JNICALL Java_jdk_incubator_jpackage_internal_WinExeBundler_embedMSI(
<span class="udiff-line-modified-removed">-             JNIEnv *pEnv, jclass c, jstring jexePath, jstring jmsiPath) {</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-         const wstring exePath = GetStringFromJString(pEnv, jexePath);</span>
<span class="udiff-line-removed">-         const wstring msiPath = GetStringFromJString(pEnv, jmsiPath);</span>
<span class="udiff-line-modified-added">+             JNIEnv *pEnv, jclass c, jlong jResourceLock, jstring jmsiPath) {</span>
  
          JP_TRY;
  
<span class="udiff-line-modified-removed">-         ResourceEditor()</span>
<span class="udiff-line-modified-removed">-             .id(L&quot;msi&quot;)</span>
<span class="udiff-line-modified-removed">-             .type(RT_RCDATA)</span>
<span class="udiff-line-modified-removed">-             .apply(ResourceEditor::FileLock(exePath), msiPath);</span>
<span class="udiff-line-modified-added">+         const std::wstring msiPath = jni::toUnicodeString(pEnv, jmsiPath);</span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-modified-added">+         const ResourceEditor::FileLock lock(reinterpret_cast&lt;HANDLE&gt;(jResourceLock));</span>
<span class="udiff-line-modified-added">+         ResourceEditor().id(L&quot;msi&quot;).type(RT_RCDATA).apply(lock, msiPath);</span>
  
          return 0;
  
          JP_CATCH_ALL;
  
</pre>
<center><a href="WindowsRegistry.cpp.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="../../../../jdk.internal.vm.compiler/share/classes/org.graalvm.compiler.hotspot/src/org/graalvm/compiler/hotspot/GraalHotSpotVMConfig.java.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>