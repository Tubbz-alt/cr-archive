<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/jdk.incubator.jpackage/windows/native/libjpackage/IconSwap.cpp</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
<body>
<center><a href="../../classes/jdk/incubator/jpackage/internal/resources/WinLauncher.template.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="IconSwap.h.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/jdk.incubator.jpackage/windows/native/libjpackage/IconSwap.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2012, 2019, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.  Oracle designates this
  8  * particular file as subject to the &quot;Classpath&quot; exception as provided
  9  * by Oracle in the LICENSE file that accompanied this code.
 10  *
 11  * This code is distributed in the hope that it will be useful, but WITHOUT
 12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 14  * version 2 for more details (a copy is included in the LICENSE file that
 15  * accompanied this code).
 16  *
 17  * You should have received a copy of the GNU General Public License version
 18  * 2 along with this work; if not, write to the Free Software Foundation,
 19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 20  *
 21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 22  * or visit www.oracle.com if you need additional information or have any
</pre>
<hr />
<pre>
 79 } GRPICONDIR, * LPGRPICONDIR;
 80 #pragma pack(pop)
 81 
 82 void PrintError() {
 83     LPVOID message = NULL;
 84     DWORD error = GetLastError();
 85 
 86     if (FormatMessage(FORMAT_MESSAGE_ALLOCATE_BUFFER
 87             | FORMAT_MESSAGE_FROM_SYSTEM
 88             | FORMAT_MESSAGE_IGNORE_INSERTS, NULL, error,
 89             MAKELANGID(LANG_NEUTRAL, SUBLANG_DEFAULT),
 90             (LPTSTR) &amp; message, 0, NULL) != 0) {
 91         printf(&quot;%S&quot;, (LPTSTR) message);
 92         LocalFree(message);
 93     }
 94 }
 95 
 96 // Note: We do not check here that iconTarget is valid icon.
 97 // Java code will already do this for us.
 98 
<span class="line-modified"> 99 bool ChangeIcon(wstring iconTarget, wstring launcher) {</span>
100     WORD language = MAKELANGID(LANG_ENGLISH, SUBLANG_DEFAULT);
101 
102     HANDLE icon = CreateFile(iconTarget.c_str(), GENERIC_READ, 0, NULL,
103             OPEN_EXISTING, FILE_ATTRIBUTE_NORMAL, NULL);
104     if (icon == INVALID_HANDLE_VALUE) {
105         PrintError();
106         return false;
107     }
108 
109     // Reading .ICO file
110     WORD idReserved, idType, idCount;
111 
112     DWORD dwBytesRead;
113     ReadFile(icon, &amp;idReserved, sizeof (WORD), &amp;dwBytesRead, NULL);
114     ReadFile(icon, &amp;idType, sizeof (WORD), &amp;dwBytesRead, NULL);
115     ReadFile(icon, &amp;idCount, sizeof (WORD), &amp;dwBytesRead, NULL);
116 
117     LPICONDIR lpid = (LPICONDIR) malloc(
118             sizeof (ICONDIR) + (sizeof (ICONDIRENTRY) * (idCount - 1)));
119     if (lpid == NULL) {
</pre>
<hr />
<pre>
137         printf(&quot;Error: Failed to allocate memory\n&quot;);
138         return false;
139     }
140 
141     lpgid-&gt;idReserved = idReserved;
142     lpgid-&gt;idType = idType;
143     lpgid-&gt;idCount = idCount;
144 
145     for (int i = 0; i &lt; lpgid-&gt;idCount; i++) {
146         lpgid-&gt;idEntries[i].bWidth = lpid-&gt;idEntries[i].bWidth;
147         lpgid-&gt;idEntries[i].bHeight = lpid-&gt;idEntries[i].bHeight;
148         lpgid-&gt;idEntries[i].bColorCount = lpid-&gt;idEntries[i].bColorCount;
149         lpgid-&gt;idEntries[i].bReserved = lpid-&gt;idEntries[i].bReserved;
150         lpgid-&gt;idEntries[i].wPlanes = lpid-&gt;idEntries[i].wPlanes;
151         lpgid-&gt;idEntries[i].wBitCount = lpid-&gt;idEntries[i].wBitCount;
152         lpgid-&gt;idEntries[i].dwBytesInRes = lpid-&gt;idEntries[i].dwBytesInRes;
153         lpgid-&gt;idEntries[i].nID = i + 1;
154     }
155 
156     // Store images in .EXE
<span class="line-removed">157     HANDLE update = BeginUpdateResource(launcher.c_str(), FALSE);</span>
<span class="line-removed">158     if (update == NULL) {</span>
<span class="line-removed">159         free(lpid);</span>
<span class="line-removed">160         free(lpgid);</span>
<span class="line-removed">161         CloseHandle(icon);</span>
<span class="line-removed">162         PrintError();</span>
<span class="line-removed">163         return false;</span>
<span class="line-removed">164     }</span>
<span class="line-removed">165 </span>
166     for (int i = 0; i &lt; lpid-&gt;idCount; i++) {
167         LPBYTE lpBuffer = (LPBYTE) malloc(lpid-&gt;idEntries[i].dwBytesInRes);
168         SetFilePointer(icon, lpid-&gt;idEntries[i].dwImageOffset,
169                 NULL, FILE_BEGIN);
170         ReadFile(icon, lpBuffer, lpid-&gt;idEntries[i].dwBytesInRes,
171                 &amp;dwBytesRead, NULL);
172         if (!UpdateResource(update, RT_ICON,
173                 MAKEINTRESOURCE(lpgid-&gt;idEntries[i].nID),
174                 language, &amp;lpBuffer[0], lpid-&gt;idEntries[i].dwBytesInRes)) {
175             free(lpBuffer);
176             free(lpid);
177             free(lpgid);
178             CloseHandle(icon);
179             PrintError();
180             return false;
181         }
182         free(lpBuffer);
183     }
184 
185     free(lpid);
186     CloseHandle(icon);
187 
188     if (!UpdateResource(update, RT_GROUP_ICON, MAKEINTRESOURCE(1),
189             language, &amp;lpgid[0], (sizeof (WORD) * 3)
190             + (sizeof (GRPICONDIRENTRY) * lpgid-&gt;idCount))) {
191         free(lpgid);
192         PrintError();
193         return false;
194     }
195 
196     free(lpgid);
197 
<span class="line-removed">198     if (EndUpdateResource(update, FALSE) == FALSE) {</span>
<span class="line-removed">199         PrintError();</span>
<span class="line-removed">200         return false;</span>
<span class="line-removed">201     }</span>
<span class="line-removed">202 </span>
203     return true;
204 }
</pre>
</td>
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2012, 2020, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.  Oracle designates this
  8  * particular file as subject to the &quot;Classpath&quot; exception as provided
  9  * by Oracle in the LICENSE file that accompanied this code.
 10  *
 11  * This code is distributed in the hope that it will be useful, but WITHOUT
 12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 14  * version 2 for more details (a copy is included in the LICENSE file that
 15  * accompanied this code).
 16  *
 17  * You should have received a copy of the GNU General Public License version
 18  * 2 along with this work; if not, write to the Free Software Foundation,
 19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 20  *
 21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 22  * or visit www.oracle.com if you need additional information or have any
</pre>
<hr />
<pre>
 79 } GRPICONDIR, * LPGRPICONDIR;
 80 #pragma pack(pop)
 81 
 82 void PrintError() {
 83     LPVOID message = NULL;
 84     DWORD error = GetLastError();
 85 
 86     if (FormatMessage(FORMAT_MESSAGE_ALLOCATE_BUFFER
 87             | FORMAT_MESSAGE_FROM_SYSTEM
 88             | FORMAT_MESSAGE_IGNORE_INSERTS, NULL, error,
 89             MAKELANGID(LANG_NEUTRAL, SUBLANG_DEFAULT),
 90             (LPTSTR) &amp; message, 0, NULL) != 0) {
 91         printf(&quot;%S&quot;, (LPTSTR) message);
 92         LocalFree(message);
 93     }
 94 }
 95 
 96 // Note: We do not check here that iconTarget is valid icon.
 97 // Java code will already do this for us.
 98 
<span class="line-modified"> 99 bool ChangeIcon(HANDLE update, const wstring&amp; iconTarget) {</span>
100     WORD language = MAKELANGID(LANG_ENGLISH, SUBLANG_DEFAULT);
101 
102     HANDLE icon = CreateFile(iconTarget.c_str(), GENERIC_READ, 0, NULL,
103             OPEN_EXISTING, FILE_ATTRIBUTE_NORMAL, NULL);
104     if (icon == INVALID_HANDLE_VALUE) {
105         PrintError();
106         return false;
107     }
108 
109     // Reading .ICO file
110     WORD idReserved, idType, idCount;
111 
112     DWORD dwBytesRead;
113     ReadFile(icon, &amp;idReserved, sizeof (WORD), &amp;dwBytesRead, NULL);
114     ReadFile(icon, &amp;idType, sizeof (WORD), &amp;dwBytesRead, NULL);
115     ReadFile(icon, &amp;idCount, sizeof (WORD), &amp;dwBytesRead, NULL);
116 
117     LPICONDIR lpid = (LPICONDIR) malloc(
118             sizeof (ICONDIR) + (sizeof (ICONDIRENTRY) * (idCount - 1)));
119     if (lpid == NULL) {
</pre>
<hr />
<pre>
137         printf(&quot;Error: Failed to allocate memory\n&quot;);
138         return false;
139     }
140 
141     lpgid-&gt;idReserved = idReserved;
142     lpgid-&gt;idType = idType;
143     lpgid-&gt;idCount = idCount;
144 
145     for (int i = 0; i &lt; lpgid-&gt;idCount; i++) {
146         lpgid-&gt;idEntries[i].bWidth = lpid-&gt;idEntries[i].bWidth;
147         lpgid-&gt;idEntries[i].bHeight = lpid-&gt;idEntries[i].bHeight;
148         lpgid-&gt;idEntries[i].bColorCount = lpid-&gt;idEntries[i].bColorCount;
149         lpgid-&gt;idEntries[i].bReserved = lpid-&gt;idEntries[i].bReserved;
150         lpgid-&gt;idEntries[i].wPlanes = lpid-&gt;idEntries[i].wPlanes;
151         lpgid-&gt;idEntries[i].wBitCount = lpid-&gt;idEntries[i].wBitCount;
152         lpgid-&gt;idEntries[i].dwBytesInRes = lpid-&gt;idEntries[i].dwBytesInRes;
153         lpgid-&gt;idEntries[i].nID = i + 1;
154     }
155 
156     // Store images in .EXE









157     for (int i = 0; i &lt; lpid-&gt;idCount; i++) {
158         LPBYTE lpBuffer = (LPBYTE) malloc(lpid-&gt;idEntries[i].dwBytesInRes);
159         SetFilePointer(icon, lpid-&gt;idEntries[i].dwImageOffset,
160                 NULL, FILE_BEGIN);
161         ReadFile(icon, lpBuffer, lpid-&gt;idEntries[i].dwBytesInRes,
162                 &amp;dwBytesRead, NULL);
163         if (!UpdateResource(update, RT_ICON,
164                 MAKEINTRESOURCE(lpgid-&gt;idEntries[i].nID),
165                 language, &amp;lpBuffer[0], lpid-&gt;idEntries[i].dwBytesInRes)) {
166             free(lpBuffer);
167             free(lpid);
168             free(lpgid);
169             CloseHandle(icon);
170             PrintError();
171             return false;
172         }
173         free(lpBuffer);
174     }
175 
176     free(lpid);
177     CloseHandle(icon);
178 
179     if (!UpdateResource(update, RT_GROUP_ICON, MAKEINTRESOURCE(1),
180             language, &amp;lpgid[0], (sizeof (WORD) * 3)
181             + (sizeof (GRPICONDIRENTRY) * lpgid-&gt;idCount))) {
182         free(lpgid);
183         PrintError();
184         return false;
185     }
186 
187     free(lpgid);
188 





189     return true;
190 }
</pre>
</td>
</tr>
</table>
<center><a href="../../classes/jdk/incubator/jpackage/internal/resources/WinLauncher.template.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="IconSwap.h.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>