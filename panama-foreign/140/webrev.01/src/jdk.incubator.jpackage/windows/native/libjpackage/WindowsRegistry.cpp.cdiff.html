<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff src/jdk.incubator.jpackage/windows/native/libjpackage/WindowsRegistry.cpp</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
<body>
<center><a href="ResourceEditor.h.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="jpackage.cpp.cdiff.html" target="_top">next &gt;</a></center>    <h2>src/jdk.incubator.jpackage/windows/native/libjpackage/WindowsRegistry.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 21,21 ***</span>
   * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
   * or visit www.oracle.com if you need additional information or have any
   * questions.
   */
  
<span class="line-modified">! #include &lt;Windows.h&gt;</span>
<span class="line-modified">! #include &lt;tchar.h&gt;</span>
<span class="line-modified">! #include &lt;strsafe.h&gt;</span>
<span class="line-removed">- #include &lt;jni.h&gt;</span>
<span class="line-removed">- </span>
<span class="line-removed">- #include &quot;Utils.h&quot;</span>
  
  #pragma comment(lib, &quot;advapi32&quot;)
  
<span class="line-modified">! // Max value name size per MSDN plus NULL</span>
<span class="line-modified">! #define VALUE_NAME_SIZE 16384</span>
  
  #ifdef __cplusplus
  extern &quot;C&quot; {
  #endif
  #undef jdk_incubator_jpackage_internal_WindowsRegistry_HKEY_LOCAL_MACHINE
<span class="line-new-header">--- 21,54 ---</span>
   * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
   * or visit www.oracle.com if you need additional information or have any
   * questions.
   */
  
<span class="line-modified">! #include &quot;JniUtils.h&quot;</span>
<span class="line-modified">! #include &quot;FileUtils.h&quot;</span>
<span class="line-modified">! #include &quot;ErrorHandling.h&quot;</span>
  
  #pragma comment(lib, &quot;advapi32&quot;)
  
<span class="line-modified">! namespace {</span>
<span class="line-modified">! </span>
<span class="line-added">+ std::wstring GetLongPath(const std::wstring&amp; path) {</span>
<span class="line-added">+     const std::wstring cleanPath = FileUtils::removeTrailingSlash(path);</span>
<span class="line-added">+     if (cleanPath.size() != path.size()) {</span>
<span class="line-added">+         return GetLongPath(cleanPath);</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
<span class="line-added">+     enum { BUFFER_SIZE = 4096 };</span>
<span class="line-added">+ </span>
<span class="line-added">+     std::wstring result;</span>
<span class="line-added">+ </span>
<span class="line-added">+     TCHAR *pBuffer = new TCHAR[BUFFER_SIZE];</span>
<span class="line-added">+     if (pBuffer != NULL) {</span>
<span class="line-added">+         DWORD dwResult = GetLongPathName(path.c_str(), pBuffer, BUFFER_SIZE);</span>
<span class="line-added">+         if (dwResult &gt; 0 &amp;&amp; dwResult &lt; BUFFER_SIZE) {</span>
<span class="line-added">+             result = std::wstring(pBuffer);</span>
<span class="line-added">+         } else {</span>
<span class="line-added">+             delete [] pBuffer;</span>
<span class="line-added">+             pBuffer = new TCHAR[dwResult];</span>
<span class="line-added">+             if (pBuffer != NULL) {</span>
<span class="line-added">+                 DWORD dwResult2 =</span>
<span class="line-added">+                         GetLongPathName(path.c_str(), pBuffer, dwResult);</span>
<span class="line-added">+                 if (dwResult2 == (dwResult - 1)) {</span>
<span class="line-added">+                     result = std::wstring(pBuffer);</span>
<span class="line-added">+                 }</span>
<span class="line-added">+             }</span>
<span class="line-added">+         }</span>
<span class="line-added">+ </span>
<span class="line-added">+         if (pBuffer != NULL) {</span>
<span class="line-added">+             delete [] pBuffer;</span>
<span class="line-added">+         }</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
<span class="line-added">+     return result;</span>
<span class="line-added">+ }</span>
<span class="line-added">+ </span>
<span class="line-added">+ } // namespace</span>
  
  #ifdef __cplusplus
  extern &quot;C&quot; {
  #endif
  #undef jdk_incubator_jpackage_internal_WindowsRegistry_HKEY_LOCAL_MACHINE
</pre>
<hr />
<pre>
<span class="line-old-header">*** 50,16 ***</span>
              Java_jdk_incubator_jpackage_internal_WindowsRegistry_readDwordValue(
              JNIEnv *pEnv, jclass c, jint key, jstring jSubKey,
              jstring jValue, jint defaultValue) {
          jint jResult = defaultValue;
  
          if (key != jdk_incubator_jpackage_internal_WindowsRegistry_HKEY_LOCAL_MACHINE) {
<span class="line-modified">!             return jResult;</span>
          }
  
<span class="line-modified">!         wstring subKey = GetStringFromJString(pEnv, jSubKey);</span>
<span class="line-modified">!         wstring value = GetStringFromJString(pEnv, jValue);</span>
  
          HKEY hSubKey = NULL;
          LSTATUS status = RegOpenKeyEx(HKEY_LOCAL_MACHINE, subKey.c_str(), 0,
                  KEY_QUERY_VALUE, &amp;hSubKey);
          if (status == ERROR_SUCCESS) {
<span class="line-new-header">--- 83,18 ---</span>
              Java_jdk_incubator_jpackage_internal_WindowsRegistry_readDwordValue(
              JNIEnv *pEnv, jclass c, jint key, jstring jSubKey,
              jstring jValue, jint defaultValue) {
          jint jResult = defaultValue;
  
<span class="line-added">+         JP_TRY;</span>
<span class="line-added">+ </span>
          if (key != jdk_incubator_jpackage_internal_WindowsRegistry_HKEY_LOCAL_MACHINE) {
<span class="line-modified">!             JP_THROW(&quot;Inavlid Windows registry key id&quot;);</span>
          }
  
<span class="line-modified">!         const std::wstring subKey = jni::toUnicodeString(pEnv, jSubKey);</span>
<span class="line-modified">!         const std::wstring value = jni::toUnicodeString(pEnv, jValue);</span>
  
          HKEY hSubKey = NULL;
          LSTATUS status = RegOpenKeyEx(HKEY_LOCAL_MACHINE, subKey.c_str(), 0,
                  KEY_QUERY_VALUE, &amp;hSubKey);
          if (status == ERROR_SUCCESS) {
</pre>
<hr />
<pre>
<span class="line-old-header">*** 72,10 ***</span>
<span class="line-new-header">--- 107,12 ---</span>
              }
  
              RegCloseKey(hSubKey);
          }
  
<span class="line-added">+         JP_CATCH_ALL;</span>
<span class="line-added">+ </span>
          return jResult;
      }
  
      /*
       * Class:     jdk_incubator_jpackage_internal_WindowsRegistry
</pre>
<hr />
<pre>
<span class="line-old-header">*** 83,22 ***</span>
       * Signature: (ILjava/lang/String;)J
       */
      JNIEXPORT jlong JNICALL
              Java_jdk_incubator_jpackage_internal_WindowsRegistry_openRegistryKey(
              JNIEnv *pEnv, jclass c, jint key, jstring jSubKey) {
          if (key != jdk_incubator_jpackage_internal_WindowsRegistry_HKEY_LOCAL_MACHINE) {
<span class="line-modified">!             return 0;</span>
          }
  
<span class="line-modified">!         wstring subKey = GetStringFromJString(pEnv, jSubKey);</span>
          HKEY hSubKey = NULL;
          LSTATUS status = RegOpenKeyEx(HKEY_LOCAL_MACHINE, subKey.c_str(), 0,
                  KEY_QUERY_VALUE, &amp;hSubKey);
          if (status == ERROR_SUCCESS) {
              return (jlong)hSubKey;
          }
  
          return 0;
      }
  
      /*
       * Class:     jdk_incubator_jpackage_internal_WindowsRegistry
<span class="line-new-header">--- 120,27 ---</span>
       * Signature: (ILjava/lang/String;)J
       */
      JNIEXPORT jlong JNICALL
              Java_jdk_incubator_jpackage_internal_WindowsRegistry_openRegistryKey(
              JNIEnv *pEnv, jclass c, jint key, jstring jSubKey) {
<span class="line-added">+ </span>
<span class="line-added">+         JP_TRY;</span>
<span class="line-added">+ </span>
          if (key != jdk_incubator_jpackage_internal_WindowsRegistry_HKEY_LOCAL_MACHINE) {
<span class="line-modified">!             JP_THROW(&quot;Inavlid Windows registry key id&quot;);</span>
          }
  
<span class="line-modified">!         const std::wstring subKey = jni::toUnicodeString(pEnv, jSubKey);</span>
          HKEY hSubKey = NULL;
          LSTATUS status = RegOpenKeyEx(HKEY_LOCAL_MACHINE, subKey.c_str(), 0,
                  KEY_QUERY_VALUE, &amp;hSubKey);
          if (status == ERROR_SUCCESS) {
              return (jlong)hSubKey;
          }
  
<span class="line-added">+         JP_CATCH_ALL;</span>
<span class="line-added">+ </span>
          return 0;
      }
  
      /*
       * Class:     jdk_incubator_jpackage_internal_WindowsRegistry
</pre>
<hr />
<pre>
<span class="line-old-header">*** 106,23 ***</span>
       * Signature: (JI)Ljava/lang/String;
       */
      JNIEXPORT jstring JNICALL
              Java_jdk_incubator_jpackage_internal_WindowsRegistry_enumRegistryValue(
              JNIEnv *pEnv, jclass c, jlong lKey, jint jIndex) {
          HKEY hKey = (HKEY)lKey;
          TCHAR valueName[VALUE_NAME_SIZE] = {0}; // Max size per MSDN plus NULL
          DWORD cchValueName = VALUE_NAME_SIZE;
          LSTATUS status = RegEnumValue(hKey, (DWORD)jIndex, valueName,
                  &amp;cchValueName, NULL, NULL, NULL, NULL);
          if (status == ERROR_SUCCESS) {
              size_t chLength = 0;
              if (StringCchLength(valueName, VALUE_NAME_SIZE, &amp;chLength)
                      == S_OK) {
<span class="line-modified">!                 return GetJStringFromString(pEnv, valueName, (jsize)chLength);</span>
              }
          }
  
          return NULL;
      }
  
      /*
       * Class:     jdk_incubator_jpackage_internal_WindowsRegistry
<span class="line-new-header">--- 148,31 ---</span>
       * Signature: (JI)Ljava/lang/String;
       */
      JNIEXPORT jstring JNICALL
              Java_jdk_incubator_jpackage_internal_WindowsRegistry_enumRegistryValue(
              JNIEnv *pEnv, jclass c, jlong lKey, jint jIndex) {
<span class="line-added">+ </span>
<span class="line-added">+         JP_TRY;</span>
<span class="line-added">+ </span>
<span class="line-added">+         // Max value name size per MSDN plus NULL</span>
<span class="line-added">+         enum { VALUE_NAME_SIZE = 16384 };</span>
<span class="line-added">+ </span>
          HKEY hKey = (HKEY)lKey;
          TCHAR valueName[VALUE_NAME_SIZE] = {0}; // Max size per MSDN plus NULL
          DWORD cchValueName = VALUE_NAME_SIZE;
          LSTATUS status = RegEnumValue(hKey, (DWORD)jIndex, valueName,
                  &amp;cchValueName, NULL, NULL, NULL, NULL);
          if (status == ERROR_SUCCESS) {
              size_t chLength = 0;
              if (StringCchLength(valueName, VALUE_NAME_SIZE, &amp;chLength)
                      == S_OK) {
<span class="line-modified">!                 return jni::toJString(pEnv, std::wstring(valueName, chLength));</span>
              }
          }
  
<span class="line-added">+         JP_CATCH_ALL;</span>
<span class="line-added">+ </span>
          return NULL;
      }
  
      /*
       * Class:     jdk_incubator_jpackage_internal_WindowsRegistry
</pre>
<hr />
<pre>
<span class="line-old-header">*** 142,28 ***</span>
       * Signature: (Ljava/lang/String;Ljava/lang/String;)Z
       */
       JNIEXPORT jboolean JNICALL
              Java_jdk_incubator_jpackage_internal_WindowsRegistry_comparePaths(
              JNIEnv *pEnv, jclass c, jstring jPath1, jstring jPath2) {
<span class="line-modified">!          wstring path1 = GetStringFromJString(pEnv, jPath1);</span>
<span class="line-modified">!          wstring path2 = GetStringFromJString(pEnv, jPath2);</span>
  
           path1 = GetLongPath(path1);
           path2 = GetLongPath(path2);
  
<span class="line-modified">!          if (path1.length() == 0 || path2.length() == 0) {</span>
<span class="line-removed">-              return JNI_FALSE;</span>
<span class="line-removed">-          }</span>
<span class="line-removed">- </span>
<span class="line-removed">-          if (path1.length() != path2.length()) {</span>
               return JNI_FALSE;
           }
  
<span class="line-modified">!          if (_tcsnicmp(path1.c_str(), path2.c_str(), path1.length()) == 0) {</span>
               return JNI_TRUE;
           }
  
           return JNI_FALSE;
       }
  
  #ifdef __cplusplus
  }
<span class="line-new-header">--- 192,29 ---</span>
       * Signature: (Ljava/lang/String;Ljava/lang/String;)Z
       */
       JNIEXPORT jboolean JNICALL
              Java_jdk_incubator_jpackage_internal_WindowsRegistry_comparePaths(
              JNIEnv *pEnv, jclass c, jstring jPath1, jstring jPath2) {
<span class="line-modified">! </span>
<span class="line-modified">!          JP_TRY;</span>
<span class="line-added">+ </span>
<span class="line-added">+          std::wstring path1 = jni::toUnicodeString(pEnv, jPath1);</span>
<span class="line-added">+          std::wstring path2 = jni::toUnicodeString(pEnv, jPath2);</span>
  
           path1 = GetLongPath(path1);
           path2 = GetLongPath(path2);
  
<span class="line-modified">!          if (path1.empty() || path2.empty()) {</span>
               return JNI_FALSE;
           }
  
<span class="line-modified">!          if (tstrings::equals(path1, path2, tstrings::IGNORE_CASE)) {</span>
               return JNI_TRUE;
           }
  
<span class="line-added">+          JP_CATCH_ALL;</span>
<span class="line-added">+ </span>
           return JNI_FALSE;
       }
  
  #ifdef __cplusplus
  }
</pre>
<center><a href="ResourceEditor.h.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="jpackage.cpp.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>