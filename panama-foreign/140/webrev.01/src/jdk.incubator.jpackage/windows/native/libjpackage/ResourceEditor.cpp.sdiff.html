<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/jdk.incubator.jpackage/windows/native/libjpackage/ResourceEditor.cpp</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
<body>
<center><a href="IconSwap.h.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="ResourceEditor.h.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/jdk.incubator.jpackage/windows/native/libjpackage/ResourceEditor.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2019, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.  Oracle designates this
  8  * particular file as subject to the &quot;Classpath&quot; exception as provided
  9  * by Oracle in the LICENSE file that accompanied this code.
 10  *
 11  * This code is distributed in the hope that it will be useful, but WITHOUT
 12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 14  * version 2 for more details (a copy is included in the LICENSE file that
 15  * accompanied this code).
 16  *
 17  * You should have received a copy of the GNU General Public License version
 18  * 2 along with this work; if not, write to the Free Software Foundation,
 19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 20  *
 21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 22  * or visit www.oracle.com if you need additional information or have any
 23  * questions.
 24  */
 25 
 26 #include &lt;algorithm&gt;
 27 #include &lt;fstream&gt;
 28 #include &quot;ResourceEditor.h&quot;
 29 #include &quot;WinErrorHandling.h&quot;
 30 #include &quot;Log.h&quot;
 31 
 32 
 33 ResourceEditor::FileLock::FileLock(const std::wstring&amp; binaryPath) {
 34     h = BeginUpdateResource(binaryPath.c_str(), FALSE);
 35     if (NULL == h) {
 36         JP_THROW(SysError(tstrings::any() &lt;&lt; &quot;BeginUpdateResource(&quot;
 37                     &lt;&lt; binaryPath &lt;&lt; &quot;) failed&quot;, BeginUpdateResource));
 38     }
 39 







 40     discard(false);
 41 }
 42 
 43 
 44 ResourceEditor::FileLock::~FileLock() {
<span class="line-modified"> 45     if (!EndUpdateResource(h, theDiscard)) {</span>
 46         JP_NO_THROW(JP_THROW(SysError(tstrings::any()
 47             &lt;&lt; &quot;EndUpdateResource(&quot; &lt;&lt; h &lt;&lt; &quot;) failed.&quot;, EndUpdateResource)));
 48     }
 49 }
 50 
 51 
 52 ResourceEditor::ResourceEditor() {
 53     language(MAKELANGID(LANG_NEUTRAL, SUBLANG_NEUTRAL)).type(unsigned(0)).id(unsigned(0));
 54 }
 55 
 56 
 57 ResourceEditor&amp; ResourceEditor::type(unsigned v) {
 58     return type(MAKEINTRESOURCE(v));
 59 }
 60 
 61 
 62 ResourceEditor&amp; ResourceEditor::type(LPCWSTR v) {
 63     if (IS_INTRESOURCE(v)) {
 64         std::wostringstream printer;
 65         printer &lt;&lt; L&quot;#&quot; &lt;&lt; reinterpret_cast&lt;size_t&gt;(v);
</pre>
<hr />
<pre>
 68     } else {
 69         theType = v;
 70         theTypePtr = theType.c_str();
 71     }
 72     return *this;
 73 }
 74 
 75 
 76 ResourceEditor&amp; ResourceEditor::id(unsigned v) {
 77     return id(MAKEINTRESOURCE(v));
 78 }
 79 
 80 
 81 ResourceEditor&amp; ResourceEditor::id(LPCWSTR v) {
 82     if (IS_INTRESOURCE(v)) {
 83         std::wostringstream printer;
 84         printer &lt;&lt; L&quot;#&quot; &lt;&lt; reinterpret_cast&lt;size_t&gt;(v);
 85         theId = printer.str();
 86     } else {
 87         theId = v;
<span class="line-removed"> 88         theIdPtr = theId.c_str();</span>
 89     }

 90     return *this;
 91 }
 92 
 93 
 94 ResourceEditor&amp; ResourceEditor::apply(const FileLock&amp; dstBinary,
 95                             std::istream&amp; srcStream, std::streamsize size) {
 96 
 97     typedef std::vector&lt;BYTE&gt; ByteArray;
 98     ByteArray buf;
 99     if (size &lt;= 0) {
100         // Read the entire stream.
101         buf = ByteArray((std::istreambuf_iterator&lt;char&gt;(srcStream)),
102                                             std::istreambuf_iterator&lt;char&gt;());
103     } else {
104         buf.resize(size_t(size));
105         srcStream.read(reinterpret_cast&lt;char*&gt;(buf.data()), size);
106     }
107 
108     auto reply = UpdateResource(dstBinary.get(), theTypePtr, theIdPtr, lang,
109                                 buf.data(), static_cast&lt;DWORD&gt;(buf.size()));
</pre>
</td>
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2019, 2020, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.  Oracle designates this
  8  * particular file as subject to the &quot;Classpath&quot; exception as provided
  9  * by Oracle in the LICENSE file that accompanied this code.
 10  *
 11  * This code is distributed in the hope that it will be useful, but WITHOUT
 12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 14  * version 2 for more details (a copy is included in the LICENSE file that
 15  * accompanied this code).
 16  *
 17  * You should have received a copy of the GNU General Public License version
 18  * 2 along with this work; if not, write to the Free Software Foundation,
 19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 20  *
 21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 22  * or visit www.oracle.com if you need additional information or have any
 23  * questions.
 24  */
 25 
 26 #include &lt;algorithm&gt;
 27 #include &lt;fstream&gt;
 28 #include &quot;ResourceEditor.h&quot;
 29 #include &quot;WinErrorHandling.h&quot;
 30 #include &quot;Log.h&quot;
 31 
 32 
 33 ResourceEditor::FileLock::FileLock(const std::wstring&amp; binaryPath) {
 34     h = BeginUpdateResource(binaryPath.c_str(), FALSE);
 35     if (NULL == h) {
 36         JP_THROW(SysError(tstrings::any() &lt;&lt; &quot;BeginUpdateResource(&quot;
 37                     &lt;&lt; binaryPath &lt;&lt; &quot;) failed&quot;, BeginUpdateResource));
 38     }
 39 
<span class="line-added"> 40     ownHandle(true);</span>
<span class="line-added"> 41     discard(false);</span>
<span class="line-added"> 42 }</span>
<span class="line-added"> 43 </span>
<span class="line-added"> 44 </span>
<span class="line-added"> 45 ResourceEditor::FileLock::FileLock(HANDLE h): h(h) {</span>
<span class="line-added"> 46     ownHandle(false);</span>
 47     discard(false);
 48 }
 49 
 50 
 51 ResourceEditor::FileLock::~FileLock() {
<span class="line-modified"> 52     if (theOwnHandle &amp;&amp; !EndUpdateResource(h, theDiscard)) {</span>
 53         JP_NO_THROW(JP_THROW(SysError(tstrings::any()
 54             &lt;&lt; &quot;EndUpdateResource(&quot; &lt;&lt; h &lt;&lt; &quot;) failed.&quot;, EndUpdateResource)));
 55     }
 56 }
 57 
 58 
 59 ResourceEditor::ResourceEditor() {
 60     language(MAKELANGID(LANG_NEUTRAL, SUBLANG_NEUTRAL)).type(unsigned(0)).id(unsigned(0));
 61 }
 62 
 63 
 64 ResourceEditor&amp; ResourceEditor::type(unsigned v) {
 65     return type(MAKEINTRESOURCE(v));
 66 }
 67 
 68 
 69 ResourceEditor&amp; ResourceEditor::type(LPCWSTR v) {
 70     if (IS_INTRESOURCE(v)) {
 71         std::wostringstream printer;
 72         printer &lt;&lt; L&quot;#&quot; &lt;&lt; reinterpret_cast&lt;size_t&gt;(v);
</pre>
<hr />
<pre>
 75     } else {
 76         theType = v;
 77         theTypePtr = theType.c_str();
 78     }
 79     return *this;
 80 }
 81 
 82 
 83 ResourceEditor&amp; ResourceEditor::id(unsigned v) {
 84     return id(MAKEINTRESOURCE(v));
 85 }
 86 
 87 
 88 ResourceEditor&amp; ResourceEditor::id(LPCWSTR v) {
 89     if (IS_INTRESOURCE(v)) {
 90         std::wostringstream printer;
 91         printer &lt;&lt; L&quot;#&quot; &lt;&lt; reinterpret_cast&lt;size_t&gt;(v);
 92         theId = printer.str();
 93     } else {
 94         theId = v;

 95     }
<span class="line-added"> 96     theIdPtr = v;</span>
 97     return *this;
 98 }
 99 
100 
101 ResourceEditor&amp; ResourceEditor::apply(const FileLock&amp; dstBinary,
102                             std::istream&amp; srcStream, std::streamsize size) {
103 
104     typedef std::vector&lt;BYTE&gt; ByteArray;
105     ByteArray buf;
106     if (size &lt;= 0) {
107         // Read the entire stream.
108         buf = ByteArray((std::istreambuf_iterator&lt;char&gt;(srcStream)),
109                                             std::istreambuf_iterator&lt;char&gt;());
110     } else {
111         buf.resize(size_t(size));
112         srcStream.read(reinterpret_cast&lt;char*&gt;(buf.data()), size);
113     }
114 
115     auto reply = UpdateResource(dstBinary.get(), theTypePtr, theIdPtr, lang,
116                                 buf.data(), static_cast&lt;DWORD&gt;(buf.size()));
</pre>
</td>
</tr>
</table>
<center><a href="IconSwap.h.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="ResourceEditor.h.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>