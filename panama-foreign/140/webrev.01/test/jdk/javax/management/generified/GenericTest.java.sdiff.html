<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff test/jdk/javax/management/generified/GenericTest.java</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
<body>
<center><a href="../../../java/util/Arrays/TimSortStackSize2.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="../query/CustomQueryTest.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>test/jdk/javax/management/generified/GenericTest.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2004, 2015, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 /*
 25  * @test
 26  * @bug 4847959 6191402
 27  * @summary Test newly-generified APIs
 28  * @author Eamonn McManus
 29  *
 30  * @run clean GenericTest
 31  * @run build GenericTest
 32  * @run main GenericTest
 33  */
 34 
 35 import java.lang.management.ManagementFactory;
 36 import java.lang.reflect.*;
 37 import java.util.*;

 38 import javax.management.*;
 39 import javax.management.openmbean.*;
 40 import javax.management.relation.*;
 41 import javax.management.timer.Timer;
 42 import javax.management.timer.TimerMBean;
 43 
 44 public class GenericTest {
 45     private static int failures;
 46 
 47     public static void main(String[] args) throws Exception {
 48         MBeanServer mbs = ManagementFactory.getPlatformMBeanServer();
 49 
 50         // Check we are really using the generified version
 51         boolean generic;
 52         Method findmbs = MBeanServerFactory.class.getMethod(&quot;findMBeanServer&quot;,
 53                                                             String.class);
 54         Type findmbstype = findmbs.getGenericReturnType();
 55         if (!(findmbstype instanceof ParameterizedType)) {
 56             System.out.println(&quot;FAILURE: API NOT GENERIC!&quot;);
 57             System.out.println(&quot;  MBeanServerFactory.findMBeanServer -&gt; &quot; +
 58                                findmbstype);
 59             failures++;
 60             generic = false;
 61         } else {
 62             System.out.println(&quot;OK: this API is generic&quot;);
 63             generic = true;
 64         }
 65 
 66         ArrayList&lt;MBeanServer&gt; mbsList1 =
 67             MBeanServerFactory.findMBeanServer(null);
 68         checked(mbsList1, MBeanServer.class);
 69         ArrayList mbsList2 = MBeanServerFactory.findMBeanServer(null);
 70         check(&quot;ArrayList&lt;MBeanServer&gt; findMBeanServer&quot;, mbsList1.size() == 1);
 71         check(&quot;ArrayList findMBeanServer&quot;, mbsList1.equals(mbsList2));
 72 
<span class="line-modified"> 73         Set&lt;ObjectName&gt; names1 =</span>
<span class="line-modified"> 74             checked(mbs.queryNames(null, null), ObjectName.class);</span>
<span class="line-modified"> 75         Set names2 = mbs.queryNames(null, null);</span>
<span class="line-modified"> 76         Set&lt;ObjectName&gt; names3 =</span>
<span class="line-modified"> 77             checked(((MBeanServerConnection) mbs).queryNames(null, null),</span>
<span class="line-modified"> 78                     ObjectName.class);</span>
<span class="line-modified"> 79         check(&quot;Set&lt;ObjectName&gt; MBeanServer.queryNames&quot;, names1.size() &gt;= 1);</span>
<span class="line-modified"> 80         check(&quot;Set MBeanServer.queryNames&quot;, names2.size() &gt;= 1);</span>
<span class="line-modified"> 81         check(&quot;Set&lt;ObjectName&gt; MBeanServerConnection.queryNames&quot;,</span>
<span class="line-modified"> 82               names3.size() &gt;= 1);</span>
<span class="line-modified"> 83         check(&quot;queryNames sets same&quot;,</span>
<span class="line-modified"> 84               names1.equals(names2) &amp;&amp; names2.equals(names3));</span>
<span class="line-modified"> 85 </span>
<span class="line-modified"> 86         Set&lt;ObjectInstance&gt; mbeans1 =</span>
<span class="line-modified"> 87             checked(mbs.queryMBeans(null, null), ObjectInstance.class);</span>
<span class="line-modified"> 88         Set mbeans2 = mbs.queryMBeans(null, null);</span>
<span class="line-modified"> 89         Set&lt;ObjectInstance&gt; mbeans3 =</span>
<span class="line-modified"> 90             checked(((MBeanServerConnection) mbs).queryMBeans(null, null),</span>
<span class="line-modified"> 91                     ObjectInstance.class);</span>
<span class="line-modified"> 92         check(&quot;Set&lt;ObjectInstsance&gt; MBeanServer.queryMBeans&quot;,</span>
<span class="line-modified"> 93               mbeans1.size() &gt;= 1);</span>
<span class="line-modified"> 94         check(&quot;Set MBeanServer.queryMBeans&quot;, mbeans2.size() &gt;= 1);</span>
<span class="line-removed"> 95         check(&quot;Set&lt;ObjectInstsance&gt; MBeanServerConnection.queryMBeans&quot;,</span>
<span class="line-removed"> 96               mbeans3.size() &gt;= 1);</span>
<span class="line-removed"> 97         check(&quot;queryMBeans sets same&quot;,</span>
<span class="line-removed"> 98               mbeans1.equals(mbeans2) &amp;&amp; mbeans2.equals(mbeans3));</span>
 99 























100 
101         AttributeChangeNotificationFilter acnf =
102             new AttributeChangeNotificationFilter();
103         acnf.enableAttribute(&quot;foo&quot;);
104         Vector&lt;String&gt; acnfs = acnf.getEnabledAttributes();
105         checked(acnfs, String.class);
106         check(&quot;Vector&lt;String&gt; AttributeChangeNotificationFilter.getEnabled&quot; +
107               &quot;Attributes&quot;, acnfs.equals(Arrays.asList(new String[] {&quot;foo&quot;})));
108 
109         if (generic) {
110             Attribute a = new Attribute(&quot;foo&quot;, &quot;bar&quot;);
111             AttributeList al1 = new AttributeList();
112             al1.add(a);
113             AttributeList al2 =
114                 new AttributeList(Arrays.asList(new Attribute[] {a}));
115             check(&quot;new AttributeList(List&lt;Attribute&gt;)&quot;, al1.equals(al2));
116             List&lt;Attribute&gt; al3 = checked(al1.asList(), Attribute.class);
117             al3.remove(a);
118             check(&quot;List&lt;Attribute&gt; AttributeList.asList()&quot;,
119                   al1.equals(al3) &amp;&amp; al1.isEmpty());
</pre>
<hr />
<pre>
465         Map&lt;K,V&gt; checked = Collections.checkedMap(unchecked, keyType, valueType);
466         checked.putAll(m);
467         return Collections.checkedMap(m, keyType, valueType);
468     }
469 
470     /* The fact that we have to call this method is a clear signal that
471      * the API says List where it means Set.
472      */
473     private static &lt;E&gt; boolean equalListContents(List&lt;E&gt; l1, List&lt;E&gt; l2) {
474         return new HashSet&lt;E&gt;(l1).equals(new HashSet&lt;E&gt;(l2));
475     }
476 
477     private static void check(String what, boolean cond) {
478         if (cond)
479             System.out.println(&quot;OK: &quot; + what);
480         else {
481             System.out.println(&quot;FAILED: &quot; + what);
482             failures++;
483         }
484     }




485 }
</pre>
</td>
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2004, 2020, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 /*
 25  * @test
 26  * @bug 4847959 6191402
 27  * @summary Test newly-generified APIs
 28  * @author Eamonn McManus
 29  *
 30  * @run clean GenericTest
 31  * @run build GenericTest
 32  * @run main GenericTest
 33  */
 34 
 35 import java.lang.management.ManagementFactory;
 36 import java.lang.reflect.*;
 37 import java.util.*;
<span class="line-added"> 38 import java.util.stream.Stream;</span>
 39 import javax.management.*;
 40 import javax.management.openmbean.*;
 41 import javax.management.relation.*;
 42 import javax.management.timer.Timer;
 43 import javax.management.timer.TimerMBean;
 44 
 45 public class GenericTest {
 46     private static int failures;
 47 
 48     public static void main(String[] args) throws Exception {
 49         MBeanServer mbs = ManagementFactory.getPlatformMBeanServer();
 50 
 51         // Check we are really using the generified version
 52         boolean generic;
 53         Method findmbs = MBeanServerFactory.class.getMethod(&quot;findMBeanServer&quot;,
 54                                                             String.class);
 55         Type findmbstype = findmbs.getGenericReturnType();
 56         if (!(findmbstype instanceof ParameterizedType)) {
 57             System.out.println(&quot;FAILURE: API NOT GENERIC!&quot;);
 58             System.out.println(&quot;  MBeanServerFactory.findMBeanServer -&gt; &quot; +
 59                                findmbstype);
 60             failures++;
 61             generic = false;
 62         } else {
 63             System.out.println(&quot;OK: this API is generic&quot;);
 64             generic = true;
 65         }
 66 
 67         ArrayList&lt;MBeanServer&gt; mbsList1 =
 68             MBeanServerFactory.findMBeanServer(null);
 69         checked(mbsList1, MBeanServer.class);
 70         ArrayList mbsList2 = MBeanServerFactory.findMBeanServer(null);
 71         check(&quot;ArrayList&lt;MBeanServer&gt; findMBeanServer&quot;, mbsList1.size() == 1);
 72         check(&quot;ArrayList findMBeanServer&quot;, mbsList1.equals(mbsList2));
 73 
<span class="line-modified"> 74         boolean isSecondAttempt = false;</span>
<span class="line-modified"> 75         Set&lt;ObjectName&gt; names1 = null;</span>
<span class="line-modified"> 76         while (true) {</span>
<span class="line-modified"> 77             names1 = checked(mbs.queryNames(null, null), ObjectName.class);</span>
<span class="line-modified"> 78             Set names2 = mbs.queryNames(null, null);</span>
<span class="line-modified"> 79             Set&lt;ObjectName&gt; names3 =</span>
<span class="line-modified"> 80                     checked(((MBeanServerConnection) mbs).queryNames(null, null),</span>
<span class="line-modified"> 81                             ObjectName.class);</span>
<span class="line-modified"> 82             // If new MBean (e.g. Graal MBean) is registered while the test is running, names1,</span>
<span class="line-modified"> 83             // names2, and names3 will have different sizes. Repeat the test in this case.</span>
<span class="line-modified"> 84             if (sameSize(names1, names2, names3) || isSecondAttempt) {</span>
<span class="line-modified"> 85                 check(&quot;Set&lt;ObjectName&gt; MBeanServer.queryNames&quot;, names1.size() &gt;= 1);</span>
<span class="line-modified"> 86                 check(&quot;Set MBeanServer.queryNames&quot;, names2.size() &gt;= 1);</span>
<span class="line-modified"> 87                 check(&quot;Set&lt;ObjectName&gt; MBeanServerConnection.queryNames&quot;,</span>
<span class="line-modified"> 88                         names3.size() &gt;= 1);</span>
<span class="line-modified"> 89                 check(&quot;queryNames sets same&quot;,</span>
<span class="line-modified"> 90                         names1.equals(names2) &amp;&amp; names2.equals(names3));</span>
<span class="line-modified"> 91                 break;</span>
<span class="line-modified"> 92             }</span>
<span class="line-modified"> 93             isSecondAttempt = true;</span>
<span class="line-modified"> 94             System.out.println(&quot;queryNames sets have different size, retrying...&quot;);</span>
<span class="line-modified"> 95         }</span>




 96 
<span class="line-added"> 97         isSecondAttempt = false;</span>
<span class="line-added"> 98         while (true) {</span>
<span class="line-added"> 99             Set&lt;ObjectInstance&gt; mbeans1 =</span>
<span class="line-added">100                     checked(mbs.queryMBeans(null, null), ObjectInstance.class);</span>
<span class="line-added">101             Set mbeans2 = mbs.queryMBeans(null, null);</span>
<span class="line-added">102             Set&lt;ObjectInstance&gt; mbeans3 =</span>
<span class="line-added">103                     checked(((MBeanServerConnection) mbs).queryMBeans(null, null),</span>
<span class="line-added">104                             ObjectInstance.class);</span>
<span class="line-added">105             // If new MBean (e.g. Graal MBean) is registered while the test is running, mbeans1,</span>
<span class="line-added">106             // mbeans2, and mbeans3 will have different sizes. Repeat the test in this case.</span>
<span class="line-added">107             if (sameSize(mbeans1, mbeans2, mbeans3) || isSecondAttempt) {</span>
<span class="line-added">108                 check(&quot;Set&lt;ObjectInstance&gt; MBeanServer.queryMBeans&quot;,</span>
<span class="line-added">109                         mbeans1.size() &gt;= 1);</span>
<span class="line-added">110                 check(&quot;Set MBeanServer.queryMBeans&quot;, mbeans2.size() &gt;= 1);</span>
<span class="line-added">111                 check(&quot;Set&lt;ObjectInstance&gt; MBeanServerConnection.queryMBeans&quot;,</span>
<span class="line-added">112                         mbeans3.size() &gt;= 1);</span>
<span class="line-added">113                 check(&quot;queryMBeans sets same&quot;,</span>
<span class="line-added">114                         mbeans1.equals(mbeans2) &amp;&amp; mbeans2.equals(mbeans3));</span>
<span class="line-added">115                 break;</span>
<span class="line-added">116             }</span>
<span class="line-added">117             isSecondAttempt = true;</span>
<span class="line-added">118             System.out.println(&quot;queryMBeans sets have different size, retrying...&quot;);</span>
<span class="line-added">119         }</span>
120 
121         AttributeChangeNotificationFilter acnf =
122             new AttributeChangeNotificationFilter();
123         acnf.enableAttribute(&quot;foo&quot;);
124         Vector&lt;String&gt; acnfs = acnf.getEnabledAttributes();
125         checked(acnfs, String.class);
126         check(&quot;Vector&lt;String&gt; AttributeChangeNotificationFilter.getEnabled&quot; +
127               &quot;Attributes&quot;, acnfs.equals(Arrays.asList(new String[] {&quot;foo&quot;})));
128 
129         if (generic) {
130             Attribute a = new Attribute(&quot;foo&quot;, &quot;bar&quot;);
131             AttributeList al1 = new AttributeList();
132             al1.add(a);
133             AttributeList al2 =
134                 new AttributeList(Arrays.asList(new Attribute[] {a}));
135             check(&quot;new AttributeList(List&lt;Attribute&gt;)&quot;, al1.equals(al2));
136             List&lt;Attribute&gt; al3 = checked(al1.asList(), Attribute.class);
137             al3.remove(a);
138             check(&quot;List&lt;Attribute&gt; AttributeList.asList()&quot;,
139                   al1.equals(al3) &amp;&amp; al1.isEmpty());
</pre>
<hr />
<pre>
485         Map&lt;K,V&gt; checked = Collections.checkedMap(unchecked, keyType, valueType);
486         checked.putAll(m);
487         return Collections.checkedMap(m, keyType, valueType);
488     }
489 
490     /* The fact that we have to call this method is a clear signal that
491      * the API says List where it means Set.
492      */
493     private static &lt;E&gt; boolean equalListContents(List&lt;E&gt; l1, List&lt;E&gt; l2) {
494         return new HashSet&lt;E&gt;(l1).equals(new HashSet&lt;E&gt;(l2));
495     }
496 
497     private static void check(String what, boolean cond) {
498         if (cond)
499             System.out.println(&quot;OK: &quot; + what);
500         else {
501             System.out.println(&quot;FAILED: &quot; + what);
502             failures++;
503         }
504     }
<span class="line-added">505 </span>
<span class="line-added">506     private static boolean sameSize(Set ... sets) {</span>
<span class="line-added">507         return Stream.of(sets).map(s -&gt; s.size()).distinct().count() == 1;</span>
<span class="line-added">508     }</span>
509 }
</pre>
</td>
</tr>
</table>
<center><a href="../../../java/util/Arrays/TimSortStackSize2.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="../query/CustomQueryTest.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>