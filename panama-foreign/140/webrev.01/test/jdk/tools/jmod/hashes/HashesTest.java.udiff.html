<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff test/jdk/tools/jmod/hashes/HashesTest.java</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
<body>
<center><a href="../../jlink/plugins/OrderResourcesPluginTest.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="../../jpackage/helpers/jdk/jpackage/test/JPackageCommand.java.udiff.html" target="_top">next &gt;</a></center>    <h2>test/jdk/tools/jmod/hashes/HashesTest.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -1,7 +1,7 @@</span>
  /**
<span class="udiff-line-modified-removed">-  * Copyright (c) 2015, 2018, Oracle and/or its affiliates. All rights reserved.</span>
<span class="udiff-line-modified-added">+  * Copyright (c) 2015, 2020, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -21,11 +21,11 @@</span>
   * questions.
   */
  
  /*
   * @test
<span class="udiff-line-modified-removed">-  * @bug 8160286</span>
<span class="udiff-line-modified-added">+  * @bug 8160286 8243666</span>
   * @summary Test the recording and checking of module hashes
   * @library /test/lib
   * @modules java.base/jdk.internal.misc
   *          java.base/jdk.internal.module
   *          jdk.compiler
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -52,10 +52,11 @@</span>
  import java.nio.file.attribute.BasicFileAttributes;
  import java.util.ArrayList;
  import java.util.Arrays;
  import java.util.Collections;
  import java.util.List;
<span class="udiff-line-added">+ import java.util.Map;</span>
  import java.util.Set;
  import java.util.spi.ToolProvider;
  import java.util.stream.Collectors;
  import java.util.stream.Stream;
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -82,10 +83,11 @@</span>
  
      private final Path mods;
      private final Path srcDir;
      private final Path lib;
      private final ModuleInfoMaker builder;
<span class="udiff-line-added">+ </span>
      HashesTest(Path dest) throws IOException {
          if (Files.exists(dest)) {
              deleteDirectory(dest);
          }
          this.mods = dest.resolve(&quot;mods&quot;);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -303,10 +305,33 @@</span>
                      mpath.toString() + File.pathSeparator + ht.lib.toString(),
                      &quot;--hash-modules&quot;, &quot;.*&quot;);
          validateImageJmodsTest(ht, mpath);
      }
  
<span class="udiff-line-added">+     @Test</span>
<span class="udiff-line-added">+     public static void testReproducibibleHash() throws Exception {</span>
<span class="udiff-line-added">+         HashesTest ht = new HashesTest(Path.of(&quot;repro&quot;));</span>
<span class="udiff-line-added">+         ht.makeModule(&quot;m4&quot;);</span>
<span class="udiff-line-added">+         ht.makeModule(&quot;m3&quot;, &quot;m4&quot;);</span>
<span class="udiff-line-added">+         ht.makeModule(&quot;m2&quot;);</span>
<span class="udiff-line-added">+         ht.makeModule(&quot;m1&quot;, &quot;m2&quot;, &quot;m3&quot;);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         // create JMOD files and run jmod hash</span>
<span class="udiff-line-added">+         List.of(&quot;m1&quot;, &quot;m2&quot;, &quot;m3&quot;, &quot;m4&quot;).forEach(ht::makeJmod);</span>
<span class="udiff-line-added">+         Map&lt;String, ModuleHashes&gt; hashes1 = ht.runJmodHash();</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         // sleep a bit to be confident that the hashes aren&#39;t dependent on timestamps</span>
<span class="udiff-line-added">+         Thread.sleep(2000);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         // (re)create JMOD files and run jmod hash</span>
<span class="udiff-line-added">+         List.of(&quot;m1&quot;, &quot;m2&quot;, &quot;m3&quot;, &quot;m4&quot;).forEach(ht::makeJmod);</span>
<span class="udiff-line-added">+         Map&lt;String, ModuleHashes&gt; hashes2 = ht.runJmodHash();</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         // hashes should be equal</span>
<span class="udiff-line-added">+         assertEquals(hashes1, hashes2);</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
      private static void validateImageJmodsTest(HashesTest ht, Path mpath)
          throws IOException
      {
          // hash is recorded in m1 and not any other packaged modules on module path
          ht.checkHashes(&quot;m1&quot;, &quot;m2&quot;);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -432,10 +457,29 @@</span>
              }
          }
          runJmod(args);
      }
  
<span class="udiff-line-added">+     /**</span>
<span class="udiff-line-added">+      * Execute jmod hash on the modules in the lib directory. Returns a map of</span>
<span class="udiff-line-added">+      * the modules, with the module name as the key, for the modules that have</span>
<span class="udiff-line-added">+      * a ModuleHashes class file attribute.</span>
<span class="udiff-line-added">+      */</span>
<span class="udiff-line-added">+     private Map&lt;String, ModuleHashes&gt; runJmodHash() {</span>
<span class="udiff-line-added">+         runJmod(List.of(&quot;hash&quot;,</span>
<span class="udiff-line-added">+                 &quot;--module-path&quot;, lib.toString(),</span>
<span class="udiff-line-added">+                 &quot;--hash-modules&quot;, &quot;.*&quot;));</span>
<span class="udiff-line-added">+         HashesTest ht = this;</span>
<span class="udiff-line-added">+         return ModulePath.of(Runtime.version(), true, lib)</span>
<span class="udiff-line-added">+                 .findAll()</span>
<span class="udiff-line-added">+                 .stream()</span>
<span class="udiff-line-added">+                 .map(ModuleReference::descriptor)</span>
<span class="udiff-line-added">+                 .map(ModuleDescriptor::name)</span>
<span class="udiff-line-added">+                 .filter(mn -&gt; ht.hashes(mn) != null)</span>
<span class="udiff-line-added">+                 .collect(Collectors.toMap(mn -&gt; mn, ht::hashes));</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
      private static void runJmod(List&lt;String&gt; args) {
          int rc = JMOD_TOOL.run(System.out, System.out, args.toArray(new String[args.size()]));
          System.out.println(&quot;jmod &quot; + args.stream().collect(Collectors.joining(&quot; &quot;)));
          if (rc != 0) {
              throw new AssertionError(&quot;jmod failed: rc = &quot; + rc);
</pre>
<center><a href="../../jlink/plugins/OrderResourcesPluginTest.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="../../jpackage/helpers/jdk/jpackage/test/JPackageCommand.java.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>