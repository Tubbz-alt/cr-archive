<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>New test/hotspot/jtreg/runtime/modules/JVMDefineModule.java</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
  <body>
    <pre>
  1 /*
  2  * Copyright (c) 2016, 2020, Oracle and/or its affiliates. All rights reserved.
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 /*
 25  * @test
 26  * @modules java.base/jdk.internal.misc
 27  * @library /test/lib ..
 28  * @build sun.hotspot.WhiteBox
 29  * @compile/module=java.base java/lang/ModuleHelper.java
 30  * @run driver ClassFileInstaller sun.hotspot.WhiteBox
 31  * @run main/othervm -Xbootclasspath/a:. -XX:+UnlockDiagnosticVMOptions -XX:+WhiteBoxAPI JVMDefineModule
 32  */
 33 
 34 import static jdk.test.lib.Asserts.*;
 35 import java.sql.Time;
 36 
 37 public class JVMDefineModule {
 38 
 39     public static void main(String args[]) throws Throwable {
 40         MyClassLoader cl = new MyClassLoader();
 41         Object m;
 42 
 43         // NULL classloader argument, expect success
 44         m = ModuleHelper.ModuleObject(&quot;mymodule&quot;, null, new String[] { &quot;mypackage&quot; });
 45         assertNotNull(m, &quot;Module should not be null&quot;);
 46         ModuleHelper.DefineModule(m, false, &quot;9.0&quot;, &quot;mymodule/here&quot;, new String[] { &quot;mypackage&quot; });
 47 
 48 /* Invalid test, won&#39;t compile.
 49         // Invalid classloader argument, expect an IAE
 50         try {
 51             m = ModuleHelper.ModuleObject(&quot;mymodule_one&quot;, new Object(), new String[] { &quot;mypackage1&quot; });
 52             ModuleHelper.DefineModule(m, false, &quot;9.0&quot;, &quot;mymodule/here&quot;, new String[] { &quot;mypackage1&quot; });
 53             throw new RuntimeException(&quot;Failed to get expected IAE for bad loader&quot;);
 54         } catch(IllegalArgumentException e) {
 55             // Expected
 56         }
 57 */
 58 
 59         // NULL package argument, should not throw an exception
 60         m = ModuleHelper.ModuleObject(&quot;mymoduleTwo&quot;, cl, new String[] { &quot;nullpkg&quot; });
 61         assertNotNull(m, &quot;Module should not be null&quot;);
 62         ModuleHelper.DefineModule(m, false, &quot;9.0&quot;, &quot;mymoduleTwo/here&quot;, null);
 63 
 64         // Null module argument, expect an NPE
 65         try {
 66             ModuleHelper.DefineModule(null, false, &quot;9.0&quot;, &quot;mymodule/here&quot;, new String[] { &quot;mypackage1&quot; });
 67             throw new RuntimeException(&quot;Failed to get expected NPE for null module&quot;);
 68         } catch(NullPointerException e) {
 69             if (!e.getMessage().contains(&quot;Null module object&quot;)) {
 70               throw new RuntimeException(&quot;Failed to get expected IAE message for null module: &quot; + e.getMessage());
 71             }
 72             // Expected
 73         }
 74 
 75         // Invalid module argument, expect an IAE
 76         try {
 77             ModuleHelper.DefineModule(new Object(), false, &quot;9.0&quot;, &quot;mymodule/here&quot;, new String[] { &quot;mypackage1&quot; });
 78             throw new RuntimeException(&quot;Failed to get expected IAE or NPE for bad module&quot;);
 79         } catch(IllegalArgumentException e) {
 80             if (!e.getMessage().contains(&quot;module is not an instance of type java.lang.Module&quot;)) {
 81               throw new RuntimeException(&quot;Failed to get expected IAE message for bad module: &quot; + e.getMessage());
 82             }
 83         }
 84 
 85         // NULL module name, expect an IAE or NPE
 86         try {
 87             m = ModuleHelper.ModuleObject(null, cl, new String[] { &quot;mypackage2&quot; });
 88             ModuleHelper.DefineModule(m, false, &quot;9.0&quot;, &quot;mymodule/here&quot;, new String[] { &quot;mypackage2&quot; });
 89             throw new RuntimeException(&quot;Failed to get expected NPE for NULL module&quot;);
 90         } catch(IllegalArgumentException e) {
 91             // Expected
 92         } catch(NullPointerException e) {
 93             // Expected
 94         }
 95 
 96         // module name is java.base, expect an IAE
 97         m = ModuleHelper.ModuleObject(&quot;java.base&quot;, cl, new String[] { &quot;mypackage3&quot; });
 98         try {
 99             ModuleHelper.DefineModule(m, false, &quot;9.0&quot;, &quot;mymodule/here&quot;, new String[] { &quot;mypackage3&quot; });
100             throw new RuntimeException(&quot;Failed to get expected IAE for java.base, not defined with boot class loader&quot;);
101         } catch(IllegalArgumentException e) {
102             if (!e.getMessage().contains(&quot;Class loader must be the boot class loader&quot;)) {
103               throw new RuntimeException(&quot;Failed to get expected IAE message for java.base: &quot; + e.getMessage());
104             }
105         }
106 
107         // Empty entry in package list, expect an IAE
108         m = ModuleHelper.ModuleObject(&quot;module.y&quot;, cl, new String[] { &quot;mypackageX&quot;, &quot;mypackageY&quot; });
109         try {
110             ModuleHelper.DefineModule(m, false, &quot;9.0&quot;, &quot;mymodule/here&quot;, new String[] { &quot;mypackageX&quot;, &quot;&quot;, &quot;mypackageY&quot; });
111             throw new RuntimeException(&quot;Failed to get IAE for empty package&quot;);
112         } catch(IllegalArgumentException e) {
113             if (!e.getMessage().contains(&quot;Invalid package name&quot;)) {
114               throw new RuntimeException(&quot;Failed to get expected IAE message empty package entry: &quot; + e.getMessage());
115             }
116         }
117 
118         // Duplicate module name, expect an ISE
119         m = ModuleHelper.ModuleObject(&quot;Module_A&quot;, cl, new String[] { &quot;mypackage6&quot; });
120         assertNotNull(m, &quot;Module should not be null&quot;);
121         ModuleHelper.DefineModule(m, false, &quot;9.0&quot;, &quot;module.name/here&quot;, new String[] { &quot;mypackage6&quot; });
122         try {
123             ModuleHelper.DefineModule(m, false, &quot;9.0&quot;, &quot;module.name/here&quot;, new String[] { &quot;mypackage6a&quot; });
124             throw new RuntimeException(&quot;Failed to get ISE for duplicate module&quot;);
125         } catch(IllegalStateException e) {
126             if (!e.getMessage().contains(&quot;Module Module_A is already defined&quot;)) {
127               throw new RuntimeException(&quot;Failed to get expected ISE message for duplicate module: &quot; + e.getMessage());
128             }
129         }
130 
131         // Package is already defined for class loader, expect an ISE
132         m = ModuleHelper.ModuleObject(&quot;dupl.pkg.module&quot;, cl, new String[] { &quot;mypackage6b&quot; });
133         try {
134             ModuleHelper.DefineModule(m, false, &quot;9.0&quot;, &quot;module.name/here&quot;, new String[] { &quot;mypackage6&quot; });
135             throw new RuntimeException(&quot;Failed to get ISE for existing package&quot;);
136         } catch(IllegalStateException e) {
137             if (!e.getMessage().contains(&quot;Package mypackage6 for module dupl.pkg.module is already in another module, Module_A, defined to the class loader&quot;)) {
138               throw new RuntimeException(&quot;Failed to get expected ISE message for duplicate package: &quot; + e.getMessage());
139             }
140         }
141 
142         // Empty module name, expect an IAE
143         try {
144             m = ModuleHelper.ModuleObject(&quot;&quot;, cl, new String[] { &quot;mypackage8&quot; });
145             ModuleHelper.DefineModule(m, false, &quot;9.0&quot;, &quot;module.name/here&quot;, new String[] { &quot;mypackage8&quot; });
146             throw new RuntimeException(&quot;Failed to get expected IAE for empty module name&quot;);
147         } catch(IllegalArgumentException e) {
148             // Expected
149         }
150 
151         // Module name with &#39;;&#39;, not allowed in java source
152         try {
153             m = ModuleHelper.ModuleObject(&quot;bad;name&quot;, cl, new String[] { &quot;mypackage9&quot; });
154             ModuleHelper.DefineModule(m, false, &quot;9.0&quot;, &quot;module.name/here&quot;, new String[] { &quot;mypackage9&quot; });
155             throw new RuntimeException(&quot;Failed to get expected IAE for bad;name&quot;);
156         } catch(IllegalArgumentException e) {
157             // Expected
158         }
159 
160         // Module name with leading dot, not allowed in java source
161         try {
162             m = ModuleHelper.ModuleObject(&quot;.leadingdot&quot;, cl, new String[] { &quot;mypackage9a&quot; });
163             ModuleHelper.DefineModule(m, false, &quot;9.0&quot;, &quot;module.name/here&quot;, new String[] { &quot;mypackage9a&quot; });
164             throw new RuntimeException(&quot;Failed to get expected IAE for .leadingdot&quot;);
165         } catch(IllegalArgumentException e) {
166             // Expected
167         }
168 
169         // Module name with trailing dot, not allowed in java source
170         try {
171             m = ModuleHelper.ModuleObject(&quot;trailingdot.&quot;, cl, new String[] { &quot;mypackage9b&quot; });
172             ModuleHelper.DefineModule(m, false, &quot;9.0&quot;, &quot;module.name/here&quot;, new String[] { &quot;mypackage9b&quot; });
173             throw new RuntimeException(&quot;Failed to get expected IAE for trailingdot.&quot;);
174         } catch(IllegalArgumentException e) {
175             // Expected
176         }
177 
178         // Module name with consecutive dots, not allowed in java source
179         try {
180             m = ModuleHelper.ModuleObject(&quot;trailingdot.&quot;, cl, new String[] { &quot;mypackage9b&quot; });
181             ModuleHelper.DefineModule(m, false, &quot;9.0&quot;, &quot;module.name/here&quot;, new String[] { &quot;mypackage9b&quot; });
182             throw new RuntimeException(&quot;Failed to get expected IAE for trailingdot.&quot;);
183         } catch(IllegalArgumentException e) {
184             // Expected
185         }
186 
187         // module name with multiple dots, should be okay
188         m = ModuleHelper.ModuleObject(&quot;more.than.one.dat&quot;, cl, new String[] { &quot;mypackage9d&quot; });
189         assertNotNull(m, &quot;Module should not be null&quot;);
190         ModuleHelper.DefineModule(m, false, &quot;9.0&quot;, &quot;module.name/here&quot;, new String[] { &quot;mypackage9d&quot; });
191 
192         // Zero length package list, should be okay
193         m = ModuleHelper.ModuleObject(&quot;zero.packages&quot;, cl, new String[] { });
194         assertNotNull(m, &quot;Module should not be null&quot;);
195         ModuleHelper.DefineModule(m, false, &quot;9.0&quot;, &quot;module.name/here&quot;, new String[] { });
196 
197         // Package name with dots, should be okay
198         m = ModuleHelper.ModuleObject(&quot;moduleFive&quot;, cl, new String[] { &quot;your.apackage&quot; });
199         assertNotNull(m, &quot;Module should not be null&quot;);
200         ModuleHelper.DefineModule(m, false, &quot;9.0&quot;, &quot;moduleFive&quot;, new String[] { &quot;your.apackage&quot; });
201 
202         // Invalid package name, expect an IAE
203         m = ModuleHelper.ModuleObject(&quot;moduleSix&quot;, cl, new String[] { &quot;foo&quot; }); // Name irrelevant
204         try {
205             ModuleHelper.DefineModule(m, false, &quot;9.0&quot;, &quot;module.name/here&quot;, new String[] { &quot;;your/apackage&quot; });
206             throw new RuntimeException(&quot;Failed to get expected IAE for ;your.apackage&quot;);
207         } catch(IllegalArgumentException e) {
208             if (!e.getMessage().contains(&quot;Invalid package name&quot;)) {
209               throw new RuntimeException(&quot;Failed to get expected IAE message for bad package name: &quot; + e.getMessage());
210             }
211         }
212 
213         // Invalid package name, expect an IAE
214         m = ModuleHelper.ModuleObject(&quot;moduleSeven&quot;, cl, new String[] { &quot;foo&quot; }); // Name irrelevant
215         try {
216             ModuleHelper.DefineModule(m, false, &quot;9.0&quot;, &quot;module.name/here&quot;, new String[] { &quot;7[743&quot; });
217             throw new RuntimeException(&quot;Failed to get expected IAE for package 7[743&quot;);
218         } catch(IllegalArgumentException e) {
219             if (!e.getMessage().contains(&quot;Invalid package name&quot;)) {
220               throw new RuntimeException(&quot;Failed to get expected IAE message for bad package name: &quot; + e.getMessage());
221             }
222         }
223 
224         // Package named &quot;java&quot; defined to a class loader other than the boot or platform class loader, expect an IAE
225         m = ModuleHelper.ModuleObject(&quot;modulejavapkgOne&quot;, cl, new String[] { &quot;java/foo&quot; });
226         try {
227             // module m is defined to an instance of MyClassLoader class loader
228             ModuleHelper.DefineModule(m, false, &quot;9.0&quot;, &quot;modulejavapkgOne&quot;, new String[] { &quot;java/foo&quot; });
229             throw new RuntimeException(&quot;Failed to get expected IAE for package java/foo&quot;);
230         } catch(IllegalArgumentException e) {
231             if (!e.getMessage().contains(&quot;prohibited package name&quot;)) {
232               throw new RuntimeException(&quot;Failed to get expected IAE message for prohibited package name: &quot; + e.getMessage());
233             }
234         }
235 
236         // Package named &quot;javabar&quot; defined to a class loader other than the boot or platform class loader, should be ok
237         m = ModuleHelper.ModuleObject(&quot;modulejavapkgTwo&quot;, cl, new String[] { &quot;javabar&quot; });
238         assertNotNull(m, &quot;Module should not be null&quot;);
239         ModuleHelper.DefineModule(m, false, &quot;9.0&quot;, &quot;modulejavapkgTwo&quot;, new String[] { &quot;javabar&quot; });
240 
241         // Package named &quot;java&quot; defined to the boot class loader, should be ok
242         //   m&#39;s type is a java.lang.Object, module is java.base
243         //   java.base module is defined to the boot loader
244         ClassLoader boot_loader = m.getClass().getClassLoader();
245         m = ModuleHelper.ModuleObject(&quot;modulejavapkgThree&quot;, boot_loader, new String[] { &quot;java/foo&quot; });
246         assertNotNull(m, &quot;Module should not be null&quot;);
247         ModuleHelper.DefineModule(m, false, &quot;9.0&quot;, &quot;modulejavapkgThree&quot;, new String[] { &quot;java/foo&quot; });
248 
249         // Package named &quot;java&quot; defined to the platform class loader, should be ok
250         //   java.sql module defined to the platform class loader.
251         java.sql.Time jst = new java.sql.Time(45 * 1000);
252         ClassLoader platform_loader = jst.getClass().getClassLoader();
253         m = ModuleHelper.ModuleObject(&quot;modulejavapkgFour&quot;, platform_loader, new String[] { &quot;java/foo&quot; });
254         assertNotNull(m, &quot;Module should not be null&quot;);
255         ModuleHelper.DefineModule(m, false, &quot;9.0&quot;, &quot;modulejavapkgFour&quot;, new String[] { &quot;java/foo&quot; });
256 
257         // module version that is null, should be okay
258         m = ModuleHelper.ModuleObject(&quot;moduleEight&quot;, cl, new String[] { &quot;a_package_8&quot; });
259         assertNotNull(m, &quot;Module should not be null&quot;);
260         ModuleHelper.DefineModule(m, false, null, &quot;moduleEight/here&quot;, new String[] { &quot;a_package_8&quot; });
261 
262         // module version that is &quot;&quot;, should be okay
263         m = ModuleHelper.ModuleObject(&quot;moduleNine&quot;, cl, new String[] { &quot;a_package_9&quot; });
264         assertNotNull(m, &quot;Module should not be null&quot;);
265         ModuleHelper.DefineModule(m, false, &quot;&quot;, &quot;moduleNine/here&quot;, new String[] { &quot;a_package_9&quot; });
266 
267         // module location that is null, should be okay
268         m = ModuleHelper.ModuleObject(&quot;moduleTen&quot;, cl, new String[] { &quot;a_package_10&quot; });
269         assertNotNull(m, &quot;Module should not be null&quot;);
270         ModuleHelper.DefineModule(m, false, &quot;9.0&quot;, null, new String[] { &quot;a_package_10&quot; });
271 
272         // module location that is &quot;&quot;, should be okay
273         m = ModuleHelper.ModuleObject(&quot;moduleEleven&quot;, cl, new String[] { &quot;a_package_11&quot; });
274         assertNotNull(m, &quot;Module should not be null&quot;);
275         ModuleHelper.DefineModule(m, false, &quot;9.0&quot;, &quot;&quot;, new String[] { &quot;a_package_11&quot; });
276 
277         // module with very long package names, should be okay
278         String[] longPackageNames = new String[] {
279          &quot;mypackage/mypackage/mypackage/mypackage1&quot;,
280          &quot;mypackage/mypackage/mypackage/mypackage/&quot; +
281          &quot;mypackage/mypackage/mypackage/mypackage/&quot; +
282          &quot;mypackage/mypackage/mypackage/mypackage/&quot; +
283          &quot;mypackage/mypackage/mypackage/mypackage/&quot; +
284          &quot;mypackage/mypackage/mypackage/mypackage/&quot; +
285          &quot;mypackage/mypackage/mypackage/mypackage/&quot; +
286          &quot;mypackage/mypackage/mypackage/mypackage/&quot; +
287          &quot;mypackage/mypackage/mypackage/mypackage2&quot;,
288          &quot;mypackage/mypackage/mypackage/mypackage/&quot; +
289          &quot;mypackage/mypackage/mypackage/mypackage/&quot; +
290          &quot;mypackage/mypackage/mypackage/mypackage/&quot; +
291          &quot;mypackage/mypackage/mypackage/mypackage/&quot; +
292          &quot;mypackage/mypackage/mypackage/mypackage/&quot; +
293          &quot;mypackage/mypackage/mypackage/mypackage/&quot; +
294          &quot;mypackage/mypackage/mypackage/mypackage/&quot; +
295          &quot;mypackage/mypackage/mypackage/mypackage/&quot; +
296          &quot;mypackage/mypackage/mypackage/mypackage/&quot; +
297          &quot;mypackage/mypackage/mypackage/mypackage/&quot; +
298          &quot;mypackage/mypackage/mypackage/mypackage/&quot; +
299          &quot;mypackage/mypackage/mypackage/mypackage3&quot;
300         };
301         m = ModuleHelper.ModuleObject(&quot;moduleTwelve&quot;, cl, longPackageNames);
302         assertNotNull(m, &quot;Module should not be null&quot;);
303         ModuleHelper.DefineModule(m, false, &quot;9.0&quot;, &quot;moduleTwelve&quot;, longPackageNames);
304         // Indirectly test that the package names doesn&#39;t get truncated when defined
305         for (int i = 0; i &lt; longPackageNames.length; i++) {
306             ModuleHelper.AddModuleExportsToAllUnnamed(m, longPackageNames[i]);
307         }
308     }
309 
310     static class MyClassLoader extends ClassLoader { }
311 }
    </pre>
  </body>
</html>