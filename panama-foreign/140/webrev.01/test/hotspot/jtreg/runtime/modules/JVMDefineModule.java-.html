<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Old test/hotspot/jtreg/runtime/modules/JVMDefineModule.java</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
  <body>
    <pre>
  1 /*
  2  * Copyright (c) 2016, 2017, Oracle and/or its affiliates. All rights reserved.
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 /*
 25  * @test
 26  * @modules java.base/jdk.internal.misc
 27  * @library /test/lib ..
 28  * @build sun.hotspot.WhiteBox
 29  * @compile/module=java.base java/lang/ModuleHelper.java
 30  * @run driver ClassFileInstaller sun.hotspot.WhiteBox
 31  *                              sun.hotspot.WhiteBox$WhiteBoxPermission
 32  * @run main/othervm -Xbootclasspath/a:. -XX:+UnlockDiagnosticVMOptions -XX:+WhiteBoxAPI JVMDefineModule
 33  */
 34 
 35 import static jdk.test.lib.Asserts.*;
 36 import java.sql.Time;
 37 
 38 public class JVMDefineModule {
 39 
 40     public static void main(String args[]) throws Throwable {
 41         MyClassLoader cl = new MyClassLoader();
 42         Object m;
 43 
 44         // NULL classloader argument, expect success
 45         m = ModuleHelper.ModuleObject(&quot;mymodule&quot;, null, new String[] { &quot;mypackage&quot; });
 46         assertNotNull(m, &quot;Module should not be null&quot;);
 47         ModuleHelper.DefineModule(m, false, &quot;9.0&quot;, &quot;mymodule/here&quot;, new String[] { &quot;mypackage&quot; });
 48 
 49 /* Invalid test, won&#39;t compile.
 50         // Invalid classloader argument, expect an IAE
 51         try {
 52             m = ModuleHelper.ModuleObject(&quot;mymodule_one&quot;, new Object(), new String[] { &quot;mypackage1&quot; });
 53             ModuleHelper.DefineModule(m, false, &quot;9.0&quot;, &quot;mymodule/here&quot;, new String[] { &quot;mypackage1&quot; });
 54             throw new RuntimeException(&quot;Failed to get expected IAE for bad loader&quot;);
 55         } catch(IllegalArgumentException e) {
 56             // Expected
 57         }
 58 */
 59 
 60         // NULL package argument, should not throw an exception
 61         m = ModuleHelper.ModuleObject(&quot;mymoduleTwo&quot;, cl, new String[] { &quot;nullpkg&quot; });
 62         assertNotNull(m, &quot;Module should not be null&quot;);
 63         ModuleHelper.DefineModule(m, false, &quot;9.0&quot;, &quot;mymoduleTwo/here&quot;, null);
 64 
 65         // Null module argument, expect an NPE
 66         try {
 67             ModuleHelper.DefineModule(null, false, &quot;9.0&quot;, &quot;mymodule/here&quot;, new String[] { &quot;mypackage1&quot; });
 68             throw new RuntimeException(&quot;Failed to get expected NPE for null module&quot;);
 69         } catch(NullPointerException e) {
 70             if (!e.getMessage().contains(&quot;Null module object&quot;)) {
 71               throw new RuntimeException(&quot;Failed to get expected IAE message for null module: &quot; + e.getMessage());
 72             }
 73             // Expected
 74         }
 75 
 76         // Invalid module argument, expect an IAE
 77         try {
 78             ModuleHelper.DefineModule(new Object(), false, &quot;9.0&quot;, &quot;mymodule/here&quot;, new String[] { &quot;mypackage1&quot; });
 79             throw new RuntimeException(&quot;Failed to get expected IAE or NPE for bad module&quot;);
 80         } catch(IllegalArgumentException e) {
 81             if (!e.getMessage().contains(&quot;module is not an instance of type java.lang.Module&quot;)) {
 82               throw new RuntimeException(&quot;Failed to get expected IAE message for bad module: &quot; + e.getMessage());
 83             }
 84         }
 85 
 86         // NULL module name, expect an IAE or NPE
 87         try {
 88             m = ModuleHelper.ModuleObject(null, cl, new String[] { &quot;mypackage2&quot; });
 89             ModuleHelper.DefineModule(m, false, &quot;9.0&quot;, &quot;mymodule/here&quot;, new String[] { &quot;mypackage2&quot; });
 90             throw new RuntimeException(&quot;Failed to get expected NPE for NULL module&quot;);
 91         } catch(IllegalArgumentException e) {
 92             // Expected
 93         } catch(NullPointerException e) {
 94             // Expected
 95         }
 96 
 97         // module name is java.base, expect an IAE
 98         m = ModuleHelper.ModuleObject(&quot;java.base&quot;, cl, new String[] { &quot;mypackage3&quot; });
 99         try {
100             ModuleHelper.DefineModule(m, false, &quot;9.0&quot;, &quot;mymodule/here&quot;, new String[] { &quot;mypackage3&quot; });
101             throw new RuntimeException(&quot;Failed to get expected IAE for java.base, not defined with boot class loader&quot;);
102         } catch(IllegalArgumentException e) {
103             if (!e.getMessage().contains(&quot;Class loader must be the boot class loader&quot;)) {
104               throw new RuntimeException(&quot;Failed to get expected IAE message for java.base: &quot; + e.getMessage());
105             }
106         }
107 
108         // Empty entry in package list, expect an IAE
109         m = ModuleHelper.ModuleObject(&quot;module.y&quot;, cl, new String[] { &quot;mypackageX&quot;, &quot;mypackageY&quot; });
110         try {
111             ModuleHelper.DefineModule(m, false, &quot;9.0&quot;, &quot;mymodule/here&quot;, new String[] { &quot;mypackageX&quot;, &quot;&quot;, &quot;mypackageY&quot; });
112             throw new RuntimeException(&quot;Failed to get IAE for empty package&quot;);
113         } catch(IllegalArgumentException e) {
114             if (!e.getMessage().contains(&quot;Invalid package name&quot;)) {
115               throw new RuntimeException(&quot;Failed to get expected IAE message empty package entry: &quot; + e.getMessage());
116             }
117         }
118 
119         // Duplicate module name, expect an ISE
120         m = ModuleHelper.ModuleObject(&quot;Module_A&quot;, cl, new String[] { &quot;mypackage6&quot; });
121         assertNotNull(m, &quot;Module should not be null&quot;);
122         ModuleHelper.DefineModule(m, false, &quot;9.0&quot;, &quot;module.name/here&quot;, new String[] { &quot;mypackage6&quot; });
123         try {
124             ModuleHelper.DefineModule(m, false, &quot;9.0&quot;, &quot;module.name/here&quot;, new String[] { &quot;mypackage6a&quot; });
125             throw new RuntimeException(&quot;Failed to get ISE for duplicate module&quot;);
126         } catch(IllegalStateException e) {
127             if (!e.getMessage().contains(&quot;Module Module_A is already defined&quot;)) {
128               throw new RuntimeException(&quot;Failed to get expected ISE message for duplicate module: &quot; + e.getMessage());
129             }
130         }
131 
132         // Package is already defined for class loader, expect an ISE
133         m = ModuleHelper.ModuleObject(&quot;dupl.pkg.module&quot;, cl, new String[] { &quot;mypackage6b&quot; });
134         try {
135             ModuleHelper.DefineModule(m, false, &quot;9.0&quot;, &quot;module.name/here&quot;, new String[] { &quot;mypackage6&quot; });
136             throw new RuntimeException(&quot;Failed to get ISE for existing package&quot;);
137         } catch(IllegalStateException e) {
138             if (!e.getMessage().contains(&quot;Package mypackage6 for module dupl.pkg.module is already in another module, Module_A, defined to the class loader&quot;)) {
139               throw new RuntimeException(&quot;Failed to get expected ISE message for duplicate package: &quot; + e.getMessage());
140             }
141         }
142 
143         // Empty module name, expect an IAE
144         try {
145             m = ModuleHelper.ModuleObject(&quot;&quot;, cl, new String[] { &quot;mypackage8&quot; });
146             ModuleHelper.DefineModule(m, false, &quot;9.0&quot;, &quot;module.name/here&quot;, new String[] { &quot;mypackage8&quot; });
147             throw new RuntimeException(&quot;Failed to get expected IAE for empty module name&quot;);
148         } catch(IllegalArgumentException e) {
149             // Expected
150         }
151 
152         // Module name with &#39;;&#39;, not allowed in java source
153         try {
154             m = ModuleHelper.ModuleObject(&quot;bad;name&quot;, cl, new String[] { &quot;mypackage9&quot; });
155             ModuleHelper.DefineModule(m, false, &quot;9.0&quot;, &quot;module.name/here&quot;, new String[] { &quot;mypackage9&quot; });
156             throw new RuntimeException(&quot;Failed to get expected IAE for bad;name&quot;);
157         } catch(IllegalArgumentException e) {
158             // Expected
159         }
160 
161         // Module name with leading dot, not allowed in java source
162         try {
163             m = ModuleHelper.ModuleObject(&quot;.leadingdot&quot;, cl, new String[] { &quot;mypackage9a&quot; });
164             ModuleHelper.DefineModule(m, false, &quot;9.0&quot;, &quot;module.name/here&quot;, new String[] { &quot;mypackage9a&quot; });
165             throw new RuntimeException(&quot;Failed to get expected IAE for .leadingdot&quot;);
166         } catch(IllegalArgumentException e) {
167             // Expected
168         }
169 
170         // Module name with trailing dot, not allowed in java source
171         try {
172             m = ModuleHelper.ModuleObject(&quot;trailingdot.&quot;, cl, new String[] { &quot;mypackage9b&quot; });
173             ModuleHelper.DefineModule(m, false, &quot;9.0&quot;, &quot;module.name/here&quot;, new String[] { &quot;mypackage9b&quot; });
174             throw new RuntimeException(&quot;Failed to get expected IAE for trailingdot.&quot;);
175         } catch(IllegalArgumentException e) {
176             // Expected
177         }
178 
179         // Module name with consecutive dots, not allowed in java source
180         try {
181             m = ModuleHelper.ModuleObject(&quot;trailingdot.&quot;, cl, new String[] { &quot;mypackage9b&quot; });
182             ModuleHelper.DefineModule(m, false, &quot;9.0&quot;, &quot;module.name/here&quot;, new String[] { &quot;mypackage9b&quot; });
183             throw new RuntimeException(&quot;Failed to get expected IAE for trailingdot.&quot;);
184         } catch(IllegalArgumentException e) {
185             // Expected
186         }
187 
188         // module name with multiple dots, should be okay
189         m = ModuleHelper.ModuleObject(&quot;more.than.one.dat&quot;, cl, new String[] { &quot;mypackage9d&quot; });
190         assertNotNull(m, &quot;Module should not be null&quot;);
191         ModuleHelper.DefineModule(m, false, &quot;9.0&quot;, &quot;module.name/here&quot;, new String[] { &quot;mypackage9d&quot; });
192 
193         // Zero length package list, should be okay
194         m = ModuleHelper.ModuleObject(&quot;zero.packages&quot;, cl, new String[] { });
195         assertNotNull(m, &quot;Module should not be null&quot;);
196         ModuleHelper.DefineModule(m, false, &quot;9.0&quot;, &quot;module.name/here&quot;, new String[] { });
197 
198         // Package name with dots, should be okay
199         m = ModuleHelper.ModuleObject(&quot;moduleFive&quot;, cl, new String[] { &quot;your.apackage&quot; });
200         assertNotNull(m, &quot;Module should not be null&quot;);
201         ModuleHelper.DefineModule(m, false, &quot;9.0&quot;, &quot;moduleFive&quot;, new String[] { &quot;your.apackage&quot; });
202 
203         // Invalid package name, expect an IAE
204         m = ModuleHelper.ModuleObject(&quot;moduleSix&quot;, cl, new String[] { &quot;foo&quot; }); // Name irrelevant
205         try {
206             ModuleHelper.DefineModule(m, false, &quot;9.0&quot;, &quot;module.name/here&quot;, new String[] { &quot;;your/apackage&quot; });
207             throw new RuntimeException(&quot;Failed to get expected IAE for ;your.apackage&quot;);
208         } catch(IllegalArgumentException e) {
209             if (!e.getMessage().contains(&quot;Invalid package name&quot;)) {
210               throw new RuntimeException(&quot;Failed to get expected IAE message for bad package name: &quot; + e.getMessage());
211             }
212         }
213 
214         // Invalid package name, expect an IAE
215         m = ModuleHelper.ModuleObject(&quot;moduleSeven&quot;, cl, new String[] { &quot;foo&quot; }); // Name irrelevant
216         try {
217             ModuleHelper.DefineModule(m, false, &quot;9.0&quot;, &quot;module.name/here&quot;, new String[] { &quot;7[743&quot; });
218             throw new RuntimeException(&quot;Failed to get expected IAE for package 7[743&quot;);
219         } catch(IllegalArgumentException e) {
220             if (!e.getMessage().contains(&quot;Invalid package name&quot;)) {
221               throw new RuntimeException(&quot;Failed to get expected IAE message for bad package name: &quot; + e.getMessage());
222             }
223         }
224 
225         // Package named &quot;java&quot; defined to a class loader other than the boot or platform class loader, expect an IAE
226         m = ModuleHelper.ModuleObject(&quot;modulejavapkgOne&quot;, cl, new String[] { &quot;java/foo&quot; });
227         try {
228             // module m is defined to an instance of MyClassLoader class loader
229             ModuleHelper.DefineModule(m, false, &quot;9.0&quot;, &quot;modulejavapkgOne&quot;, new String[] { &quot;java/foo&quot; });
230             throw new RuntimeException(&quot;Failed to get expected IAE for package java/foo&quot;);
231         } catch(IllegalArgumentException e) {
232             if (!e.getMessage().contains(&quot;prohibited package name&quot;)) {
233               throw new RuntimeException(&quot;Failed to get expected IAE message for prohibited package name: &quot; + e.getMessage());
234             }
235         }
236 
237         // Package named &quot;javabar&quot; defined to a class loader other than the boot or platform class loader, should be ok
238         m = ModuleHelper.ModuleObject(&quot;modulejavapkgTwo&quot;, cl, new String[] { &quot;javabar&quot; });
239         assertNotNull(m, &quot;Module should not be null&quot;);
240         ModuleHelper.DefineModule(m, false, &quot;9.0&quot;, &quot;modulejavapkgTwo&quot;, new String[] { &quot;javabar&quot; });
241 
242         // Package named &quot;java&quot; defined to the boot class loader, should be ok
243         //   m&#39;s type is a java.lang.Object, module is java.base
244         //   java.base module is defined to the boot loader
245         ClassLoader boot_loader = m.getClass().getClassLoader();
246         m = ModuleHelper.ModuleObject(&quot;modulejavapkgThree&quot;, boot_loader, new String[] { &quot;java/foo&quot; });
247         assertNotNull(m, &quot;Module should not be null&quot;);
248         ModuleHelper.DefineModule(m, false, &quot;9.0&quot;, &quot;modulejavapkgThree&quot;, new String[] { &quot;java/foo&quot; });
249 
250         // Package named &quot;java&quot; defined to the platform class loader, should be ok
251         //   java.sql module defined to the platform class loader.
252         java.sql.Time jst = new java.sql.Time(45 * 1000);
253         ClassLoader platform_loader = jst.getClass().getClassLoader();
254         m = ModuleHelper.ModuleObject(&quot;modulejavapkgFour&quot;, platform_loader, new String[] { &quot;java/foo&quot; });
255         assertNotNull(m, &quot;Module should not be null&quot;);
256         ModuleHelper.DefineModule(m, false, &quot;9.0&quot;, &quot;modulejavapkgFour&quot;, new String[] { &quot;java/foo&quot; });
257 
258         // module version that is null, should be okay
259         m = ModuleHelper.ModuleObject(&quot;moduleEight&quot;, cl, new String[] { &quot;a_package_8&quot; });
260         assertNotNull(m, &quot;Module should not be null&quot;);
261         ModuleHelper.DefineModule(m, false, null, &quot;moduleEight/here&quot;, new String[] { &quot;a_package_8&quot; });
262 
263         // module version that is &quot;&quot;, should be okay
264         m = ModuleHelper.ModuleObject(&quot;moduleNine&quot;, cl, new String[] { &quot;a_package_9&quot; });
265         assertNotNull(m, &quot;Module should not be null&quot;);
266         ModuleHelper.DefineModule(m, false, &quot;&quot;, &quot;moduleNine/here&quot;, new String[] { &quot;a_package_9&quot; });
267 
268         // module location that is null, should be okay
269         m = ModuleHelper.ModuleObject(&quot;moduleTen&quot;, cl, new String[] { &quot;a_package_10&quot; });
270         assertNotNull(m, &quot;Module should not be null&quot;);
271         ModuleHelper.DefineModule(m, false, &quot;9.0&quot;, null, new String[] { &quot;a_package_10&quot; });
272 
273         // module location that is &quot;&quot;, should be okay
274         m = ModuleHelper.ModuleObject(&quot;moduleEleven&quot;, cl, new String[] { &quot;a_package_11&quot; });
275         assertNotNull(m, &quot;Module should not be null&quot;);
276         ModuleHelper.DefineModule(m, false, &quot;9.0&quot;, &quot;&quot;, new String[] { &quot;a_package_11&quot; });
277 
278         // module with very long package names, should be okay
279         String[] longPackageNames = new String[] {
280          &quot;mypackage/mypackage/mypackage/mypackage1&quot;,
281          &quot;mypackage/mypackage/mypackage/mypackage/&quot; +
282          &quot;mypackage/mypackage/mypackage/mypackage/&quot; +
283          &quot;mypackage/mypackage/mypackage/mypackage/&quot; +
284          &quot;mypackage/mypackage/mypackage/mypackage/&quot; +
285          &quot;mypackage/mypackage/mypackage/mypackage/&quot; +
286          &quot;mypackage/mypackage/mypackage/mypackage/&quot; +
287          &quot;mypackage/mypackage/mypackage/mypackage/&quot; +
288          &quot;mypackage/mypackage/mypackage/mypackage2&quot;,
289          &quot;mypackage/mypackage/mypackage/mypackage/&quot; +
290          &quot;mypackage/mypackage/mypackage/mypackage/&quot; +
291          &quot;mypackage/mypackage/mypackage/mypackage/&quot; +
292          &quot;mypackage/mypackage/mypackage/mypackage/&quot; +
293          &quot;mypackage/mypackage/mypackage/mypackage/&quot; +
294          &quot;mypackage/mypackage/mypackage/mypackage/&quot; +
295          &quot;mypackage/mypackage/mypackage/mypackage/&quot; +
296          &quot;mypackage/mypackage/mypackage/mypackage/&quot; +
297          &quot;mypackage/mypackage/mypackage/mypackage/&quot; +
298          &quot;mypackage/mypackage/mypackage/mypackage/&quot; +
299          &quot;mypackage/mypackage/mypackage/mypackage/&quot; +
300          &quot;mypackage/mypackage/mypackage/mypackage3&quot;
301         };
302         m = ModuleHelper.ModuleObject(&quot;moduleTwelve&quot;, cl, longPackageNames);
303         assertNotNull(m, &quot;Module should not be null&quot;);
304         ModuleHelper.DefineModule(m, false, &quot;9.0&quot;, &quot;moduleTwelve&quot;, longPackageNames);
305         // Indirectly test that the package names doesn&#39;t get truncated when defined
306         for (int i = 0; i &lt; longPackageNames.length; i++) {
307             ModuleHelper.AddModuleExportsToAllUnnamed(m, longPackageNames[i]);
308         }
309     }
310 
311     static class MyClassLoader extends ClassLoader { }
312 }
    </pre>
  </body>
</html>