<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff test/hotspot/jtreg/gc/arguments/TestTargetSurvivorRatioFlag.java</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
<body>
<center><a href="TestSurvivorRatioFlag.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="TestUnrecognizedVMOptionsHandling.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>test/hotspot/jtreg/gc/arguments/TestTargetSurvivorRatioFlag.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
100         negativeTest(-1, options);
101         negativeTest(101, options);
102 
103         positiveTest(20, options);
104         positiveTest(30, options);
105         positiveTest(55, options);
106         positiveTest(70, options);
107     }
108 
109     /**
110      * Verify that VM will fail to start with specified TargetSurvivorRatio
111      *
112      * @param ratio value of TargetSurvivorRatio
113      * @param options additional VM options
114      */
115     public static void negativeTest(int ratio, LinkedList&lt;String&gt; options) throws Exception {
116         LinkedList&lt;String&gt; vmOptions = new LinkedList&lt;&gt;(options);
117         vmOptions.add(&quot;-XX:TargetSurvivorRatio=&quot; + ratio);
118         vmOptions.add(&quot;-version&quot;);
119 
<span class="line-modified">120         ProcessBuilder procBuilder = GCArguments.createJavaProcessBuilder(vmOptions.toArray(new String[vmOptions.size()]));</span>
121         OutputAnalyzer analyzer = new OutputAnalyzer(procBuilder.start());
122 
123         analyzer.shouldHaveExitValue(1);
124         analyzer.shouldContain(&quot;Error: Could not create the Java Virtual Machine.&quot;);
125     }
126 
127     /**
128      * Verify that actual survivor space usage ratio conforms specified TargetSurvivorRatio
129      *
130      * @param ratio value of TargetSurvivorRatio
131      * @param options additional VM options
132      */
133     public static void positiveTest(int ratio, LinkedList&lt;String&gt; options) throws Exception {
134         LinkedList&lt;String&gt; vmOptions = new LinkedList&lt;&gt;(options);
135         Collections.addAll(vmOptions,
136                 &quot;-Xbootclasspath/a:.&quot;,
137                 &quot;--add-exports=java.base/jdk.internal.misc=ALL-UNNAMED&quot;,
138                 &quot;-XX:+UnlockDiagnosticVMOptions&quot;,
139                 &quot;-XX:+WhiteBoxAPI&quot;,
140                 &quot;-XX:+UseAdaptiveSizePolicy&quot;,
141                 &quot;-Xlog:gc+age=trace&quot;,
142                 &quot;-XX:MaxTenuringThreshold=&quot; + MAX_TENURING_THRESHOLD,
143                 &quot;-XX:NewSize=&quot; + MAX_NEW_SIZE,
144                 &quot;-XX:MaxNewSize=&quot; + MAX_NEW_SIZE,
145                 &quot;-XX:InitialHeapSize=&quot; + 2 * MAX_NEW_SIZE,
146                 &quot;-XX:MaxHeapSize=&quot; + 2 * MAX_NEW_SIZE,
147                 &quot;-XX:SurvivorRatio=&quot; + SURVIVOR_RATIO,
148                 &quot;-XX:TargetSurvivorRatio=&quot; + ratio,
149                 // For reducing variance of survivor size.
150                 &quot;-XX:TargetPLABWastePct=&quot; + 1,
151                 TargetSurvivorRatioVerifier.class.getName(),
152                 Integer.toString(ratio)
153         );
154 
<span class="line-modified">155         ProcessBuilder procBuilder = GCArguments.createJavaProcessBuilder(vmOptions.toArray(new String[vmOptions.size()]));</span>
156         OutputAnalyzer analyzer = new OutputAnalyzer(procBuilder.start());
157 
158         analyzer.shouldHaveExitValue(0);
159 
160         String output = analyzer.getOutput();
161 
162         // Test avoids verification for parallel GC
163         if (!output.contains(UNSUPPORTED_GC)) {
164             // Two tests should be done - when actual ratio is lower than TargetSurvivorRatio
165             // and when it is higher. We chech that output contains results for exactly two tests.
166             List&lt;Double&gt; ratios = parseTestOutput(output);
167 
168             if (ratios.size() != 2) {
169                 System.out.println(output);
170                 throw new RuntimeException(&quot;Expected number of ratios extraced for output is 2,&quot;
171                         + &quot; but &quot; + ratios.size() + &quot; ratios were extracted&quot;);
172             }
173 
174             // At the end of the first test survivor space usage ratio should lies between
175             // TargetSurvivorRatio and TargetSurvivorRatio - 2*DELTA
</pre>
</td>
<td>
<hr />
<pre>
100         negativeTest(-1, options);
101         negativeTest(101, options);
102 
103         positiveTest(20, options);
104         positiveTest(30, options);
105         positiveTest(55, options);
106         positiveTest(70, options);
107     }
108 
109     /**
110      * Verify that VM will fail to start with specified TargetSurvivorRatio
111      *
112      * @param ratio value of TargetSurvivorRatio
113      * @param options additional VM options
114      */
115     public static void negativeTest(int ratio, LinkedList&lt;String&gt; options) throws Exception {
116         LinkedList&lt;String&gt; vmOptions = new LinkedList&lt;&gt;(options);
117         vmOptions.add(&quot;-XX:TargetSurvivorRatio=&quot; + ratio);
118         vmOptions.add(&quot;-version&quot;);
119 
<span class="line-modified">120         ProcessBuilder procBuilder = GCArguments.createJavaProcessBuilder(vmOptions);</span>
121         OutputAnalyzer analyzer = new OutputAnalyzer(procBuilder.start());
122 
123         analyzer.shouldHaveExitValue(1);
124         analyzer.shouldContain(&quot;Error: Could not create the Java Virtual Machine.&quot;);
125     }
126 
127     /**
128      * Verify that actual survivor space usage ratio conforms specified TargetSurvivorRatio
129      *
130      * @param ratio value of TargetSurvivorRatio
131      * @param options additional VM options
132      */
133     public static void positiveTest(int ratio, LinkedList&lt;String&gt; options) throws Exception {
134         LinkedList&lt;String&gt; vmOptions = new LinkedList&lt;&gt;(options);
135         Collections.addAll(vmOptions,
136                 &quot;-Xbootclasspath/a:.&quot;,
137                 &quot;--add-exports=java.base/jdk.internal.misc=ALL-UNNAMED&quot;,
138                 &quot;-XX:+UnlockDiagnosticVMOptions&quot;,
139                 &quot;-XX:+WhiteBoxAPI&quot;,
140                 &quot;-XX:+UseAdaptiveSizePolicy&quot;,
141                 &quot;-Xlog:gc+age=trace&quot;,
142                 &quot;-XX:MaxTenuringThreshold=&quot; + MAX_TENURING_THRESHOLD,
143                 &quot;-XX:NewSize=&quot; + MAX_NEW_SIZE,
144                 &quot;-XX:MaxNewSize=&quot; + MAX_NEW_SIZE,
145                 &quot;-XX:InitialHeapSize=&quot; + 2 * MAX_NEW_SIZE,
146                 &quot;-XX:MaxHeapSize=&quot; + 2 * MAX_NEW_SIZE,
147                 &quot;-XX:SurvivorRatio=&quot; + SURVIVOR_RATIO,
148                 &quot;-XX:TargetSurvivorRatio=&quot; + ratio,
149                 // For reducing variance of survivor size.
150                 &quot;-XX:TargetPLABWastePct=&quot; + 1,
151                 TargetSurvivorRatioVerifier.class.getName(),
152                 Integer.toString(ratio)
153         );
154 
<span class="line-modified">155         ProcessBuilder procBuilder = GCArguments.createJavaProcessBuilder(vmOptions);</span>
156         OutputAnalyzer analyzer = new OutputAnalyzer(procBuilder.start());
157 
158         analyzer.shouldHaveExitValue(0);
159 
160         String output = analyzer.getOutput();
161 
162         // Test avoids verification for parallel GC
163         if (!output.contains(UNSUPPORTED_GC)) {
164             // Two tests should be done - when actual ratio is lower than TargetSurvivorRatio
165             // and when it is higher. We chech that output contains results for exactly two tests.
166             List&lt;Double&gt; ratios = parseTestOutput(output);
167 
168             if (ratios.size() != 2) {
169                 System.out.println(output);
170                 throw new RuntimeException(&quot;Expected number of ratios extraced for output is 2,&quot;
171                         + &quot; but &quot; + ratios.size() + &quot; ratios were extracted&quot;);
172             }
173 
174             // At the end of the first test survivor space usage ratio should lies between
175             // TargetSurvivorRatio and TargetSurvivorRatio - 2*DELTA
</pre>
</td>
</tr>
</table>
<center><a href="TestSurvivorRatioFlag.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="TestUnrecognizedVMOptionsHandling.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>