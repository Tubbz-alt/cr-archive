<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff test/hotspot/jtreg/gc/arguments/TestMaxMinHeapFreeRatioFlags.java</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
<body>
<center><a href="TestMaxHeapSizeTools.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="TestMaxNewSize.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>test/hotspot/jtreg/gc/arguments/TestMaxMinHeapFreeRatioFlags.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 83     public static void positiveTest(int minRatio, boolean useXminf,
 84             int maxRatio, boolean useXmaxf, boolean shrinkHeapInSteps,
 85             LinkedList&lt;String&gt; options) throws Exception {
 86 
 87         LinkedList&lt;String&gt; vmOptions = new LinkedList&lt;&gt;(options);
 88         Collections.addAll(vmOptions,
 89                 (useXminf ? &quot;-Xminf&quot; + minRatio / 100.0 : &quot;-XX:MinHeapFreeRatio=&quot; + minRatio),
 90                 (useXmaxf ? &quot;-Xmaxf&quot; + maxRatio / 100.0 : &quot;-XX:MaxHeapFreeRatio=&quot; + maxRatio),
 91                 &quot;-Xmx&quot; + MAX_HEAP_SIZE,
 92                 &quot;-Xms&quot; + HEAP_SIZE,
 93                 &quot;--add-exports=java.base/jdk.internal.misc=ALL-UNNAMED&quot;,
 94                 &quot;-XX:NewSize=&quot; + NEW_SIZE,
 95                 &quot;-XX:MaxNewSize=&quot; + MAX_NEW_SIZE,
 96                 &quot;-XX:&quot; + (shrinkHeapInSteps ? &#39;+&#39; : &#39;-&#39;) + &quot;ShrinkHeapInSteps&quot;,
 97                 RatioVerifier.class.getName(),
 98                 Integer.toString(minRatio),
 99                 Integer.toString(maxRatio),
100                 Boolean.toString(shrinkHeapInSteps)
101         );
102 
<span class="line-modified">103         ProcessBuilder procBuilder = GCArguments.createJavaProcessBuilder(vmOptions.toArray(new String[vmOptions.size()]));</span>
104         OutputAnalyzer analyzer = new OutputAnalyzer(procBuilder.start());
105         analyzer.shouldHaveExitValue(0);
106     }
107 
108     /**
109      * Verify that VM will fail to start with specified ratios.
110      *
111      * @param minRatio value of MinHeapFreeRatio option
112      * @param useXminf used Xminf option instead of MinHeapFreeRatio
113      * @param maxRatio value of MaxHeapFreeRatio option
114      * @param useXmaxf used Xmaxf option instead of MaxHeapFreeRatio
115      * @param options additional options for JVM
116      */
117     public static void negativeTest(int minRatio, boolean useXminf,
118             int maxRatio, boolean useXmaxf,
119             LinkedList&lt;String&gt; options) throws Exception {
120 
121         LinkedList&lt;String&gt; vmOptions = new LinkedList&lt;&gt;(options);
122         Collections.addAll(vmOptions,
123                 (useXminf ? &quot;-Xminf&quot; + minRatio / 100.0 : &quot;-XX:MinHeapFreeRatio=&quot; + minRatio),
124                 (useXmaxf ? &quot;-Xmaxf&quot; + maxRatio / 100.0 : &quot;-XX:MaxHeapFreeRatio=&quot; + maxRatio),
125                 &quot;--add-exports=java.base/jdk.internal.misc=ALL-UNNAMED&quot;,
126                 &quot;-version&quot;
127         );
<span class="line-modified">128         ProcessBuilder procBuilder = GCArguments.createJavaProcessBuilder(vmOptions.toArray(new String[vmOptions.size()]));</span>
129         OutputAnalyzer analyzer = new OutputAnalyzer(procBuilder.start());
130         analyzer.shouldHaveExitValue(1);
131         analyzer.shouldContain(&quot;Error: Could not create the Java Virtual Machine.&quot;);
132     }
133 
134     /**
135      * RatioVerifier will be executed in the tested VM.
136      * It will check that real heap usage after collection lies between MinHeapFreeRatio and MaxHeapFreeRatio.
137      */
138     public static class RatioVerifier {
139 
140         private static final Unsafe unsafe = Unsafe.getUnsafe();
141 
142         // Size of byte array that will be allocated
143         public static final int CHUNK_SIZE = 1024;
144         // Length of byte array, that will be added to &quot;garbage&quot; list.
145         public static final int ARRAY_LENGTH = CHUNK_SIZE - Unsafe.ARRAY_BYTE_BASE_OFFSET;
146         // Amount of tries to force heap shrinking/expansion using GC
147         public static final int GC_TRIES = 10;
148 
</pre>
</td>
<td>
<hr />
<pre>
 83     public static void positiveTest(int minRatio, boolean useXminf,
 84             int maxRatio, boolean useXmaxf, boolean shrinkHeapInSteps,
 85             LinkedList&lt;String&gt; options) throws Exception {
 86 
 87         LinkedList&lt;String&gt; vmOptions = new LinkedList&lt;&gt;(options);
 88         Collections.addAll(vmOptions,
 89                 (useXminf ? &quot;-Xminf&quot; + minRatio / 100.0 : &quot;-XX:MinHeapFreeRatio=&quot; + minRatio),
 90                 (useXmaxf ? &quot;-Xmaxf&quot; + maxRatio / 100.0 : &quot;-XX:MaxHeapFreeRatio=&quot; + maxRatio),
 91                 &quot;-Xmx&quot; + MAX_HEAP_SIZE,
 92                 &quot;-Xms&quot; + HEAP_SIZE,
 93                 &quot;--add-exports=java.base/jdk.internal.misc=ALL-UNNAMED&quot;,
 94                 &quot;-XX:NewSize=&quot; + NEW_SIZE,
 95                 &quot;-XX:MaxNewSize=&quot; + MAX_NEW_SIZE,
 96                 &quot;-XX:&quot; + (shrinkHeapInSteps ? &#39;+&#39; : &#39;-&#39;) + &quot;ShrinkHeapInSteps&quot;,
 97                 RatioVerifier.class.getName(),
 98                 Integer.toString(minRatio),
 99                 Integer.toString(maxRatio),
100                 Boolean.toString(shrinkHeapInSteps)
101         );
102 
<span class="line-modified">103         ProcessBuilder procBuilder = GCArguments.createJavaProcessBuilder(vmOptions);</span>
104         OutputAnalyzer analyzer = new OutputAnalyzer(procBuilder.start());
105         analyzer.shouldHaveExitValue(0);
106     }
107 
108     /**
109      * Verify that VM will fail to start with specified ratios.
110      *
111      * @param minRatio value of MinHeapFreeRatio option
112      * @param useXminf used Xminf option instead of MinHeapFreeRatio
113      * @param maxRatio value of MaxHeapFreeRatio option
114      * @param useXmaxf used Xmaxf option instead of MaxHeapFreeRatio
115      * @param options additional options for JVM
116      */
117     public static void negativeTest(int minRatio, boolean useXminf,
118             int maxRatio, boolean useXmaxf,
119             LinkedList&lt;String&gt; options) throws Exception {
120 
121         LinkedList&lt;String&gt; vmOptions = new LinkedList&lt;&gt;(options);
122         Collections.addAll(vmOptions,
123                 (useXminf ? &quot;-Xminf&quot; + minRatio / 100.0 : &quot;-XX:MinHeapFreeRatio=&quot; + minRatio),
124                 (useXmaxf ? &quot;-Xmaxf&quot; + maxRatio / 100.0 : &quot;-XX:MaxHeapFreeRatio=&quot; + maxRatio),
125                 &quot;--add-exports=java.base/jdk.internal.misc=ALL-UNNAMED&quot;,
126                 &quot;-version&quot;
127         );
<span class="line-modified">128         ProcessBuilder procBuilder = GCArguments.createJavaProcessBuilder(vmOptions);</span>
129         OutputAnalyzer analyzer = new OutputAnalyzer(procBuilder.start());
130         analyzer.shouldHaveExitValue(1);
131         analyzer.shouldContain(&quot;Error: Could not create the Java Virtual Machine.&quot;);
132     }
133 
134     /**
135      * RatioVerifier will be executed in the tested VM.
136      * It will check that real heap usage after collection lies between MinHeapFreeRatio and MaxHeapFreeRatio.
137      */
138     public static class RatioVerifier {
139 
140         private static final Unsafe unsafe = Unsafe.getUnsafe();
141 
142         // Size of byte array that will be allocated
143         public static final int CHUNK_SIZE = 1024;
144         // Length of byte array, that will be added to &quot;garbage&quot; list.
145         public static final int ARRAY_LENGTH = CHUNK_SIZE - Unsafe.ARRAY_BYTE_BASE_OFFSET;
146         // Amount of tries to force heap shrinking/expansion using GC
147         public static final int GC_TRIES = 10;
148 
</pre>
</td>
</tr>
</table>
<center><a href="TestMaxHeapSizeTools.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="TestMaxNewSize.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>