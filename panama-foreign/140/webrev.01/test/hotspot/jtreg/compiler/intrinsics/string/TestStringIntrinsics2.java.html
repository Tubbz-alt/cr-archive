<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>New test/hotspot/jtreg/compiler/intrinsics/string/TestStringIntrinsics2.java</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
  </head>
  <body>
    <pre>
  1 /*
  2  * Copyright (c) 2016, 2020, Oracle and/or its affiliates. All rights reserved.
  3  * Copyright (c) 2016 SAP SE. All rights reserved.
  4  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  5  *
  6  * This code is free software; you can redistribute it and/or modify it
  7  * under the terms of the GNU General Public License version 2 only, as
  8  * published by the Free Software Foundation.
  9  *
 10  * This code is distributed in the hope that it will be useful, but WITHOUT
 11  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 12  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 13  * version 2 for more details (a copy is included in the LICENSE file that
 14  * accompanied this code).
 15  *
 16  * You should have received a copy of the GNU General Public License version
 17  * 2 along with this work; if not, write to the Free Software Foundation,
 18  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 19  *
 20  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 21  * or visit www.oracle.com if you need additional information or have any
 22  * questions.
 23  */
 24 
 25 /*
 26  * @test
 27  * @bug 8145336
 28  * @summary PPC64: fix string intrinsics after CompactStrings change
 29  * @modules java.base/jdk.internal.misc
 30  * @library /test/lib
 31  *
 32  * @build sun.hotspot.WhiteBox
 33  * @run driver ClassFileInstaller sun.hotspot.WhiteBox
 34  *
 35  * @run main/othervm
 36  *        -Xbootclasspath/a:.
 37  *        -Xmixed
 38  *        -XX:+UnlockDiagnosticVMOptions
 39  *        -XX:+WhiteBoxAPI
 40  *        -XX:MaxInlineSize=70
 41  *        -XX:MinInliningThreshold=0
 42  *        compiler.intrinsics.string.TestStringIntrinsics2
 43  */
 44 
 45 package compiler.intrinsics.string;
 46 
 47 import sun.hotspot.WhiteBox;
 48 
 49 import java.lang.annotation.ElementType;
 50 import java.lang.annotation.Retention;
 51 import java.lang.annotation.RetentionPolicy;
 52 import java.lang.annotation.Target;
 53 import java.util.Arrays;
 54 import java.util.function.Consumer;
 55 
 56 import static jdk.test.lib.Asserts.assertEquals;
 57 import static jdk.test.lib.Asserts.assertFalse;
 58 import static jdk.test.lib.Asserts.assertTrue;
 59 
 60 public class TestStringIntrinsics2 {
 61     // ------------------------------------------------------------------------
 62     //
 63     // We test the following cases:
 64     // - no match in string.  Do we miss the end condition? Will crash if we read
 65     //   past the string.
 66     // - no match in string, but after the string there is a match.
 67     //   Do we incorrectly report this match?  We had a case where we stepped
 68     //   a few chars past the string, this test would report that error. The
 69     //   one above would not.
 70     // - The needle is exactly at the end of the string.
 71     // - The needle spans the end of the string
 72     //
 73     // A special case are needles of length 1. For these we test:
 74     // - needle is first char
 75     // - needle is last char
 76     // - no match
 77     // - match behind string.
 78     //
 79     // We test all these for an unknown needle, and needles known to the compiler
 80     // of lengths 5, 2 and 1.
 81 
 82 
 83     private static final WhiteBox WB = WhiteBox.getWhiteBox();
 84 
 85     public enum Role {
 86         TEST_ENTRY,
 87         TEST_HELPER
 88     }
 89 
 90     @Retention(RetentionPolicy.RUNTIME)
 91     @Target(ElementType.METHOD)
 92     @interface Test {
 93         Role role();
 94         int compileAt() default 0;
 95         int warmup() default 0;
 96         String[] warmupArgs() default {};
 97     }
 98 
 99     // All this mess is needed to avoid try/catch inside the lambdas below.
100     // See: http://stackoverflow.com/questions/27644361/how-can-i-throw-checked-exceptions-from-inside-java-8-streams
101     @SuppressWarnings (&quot;unchecked&quot;)
102     private static &lt;E extends Throwable&gt; void throwAsUnchecked(Exception exception) throws E {
103         throw (E)exception;
104     }
105     @FunctionalInterface
106     public interface Consumer_WithExceptions&lt;T, E extends Exception&gt; {
107         void accept(T t) throws E;
108     }
109     public static &lt;T, E extends Exception&gt; Consumer&lt;T&gt; rethrowConsumer(Consumer_WithExceptions&lt;T, E&gt; consumer) {
110         return t -&gt; {
111             try { consumer.accept(t); }
112             catch (Exception exception) { throwAsUnchecked(exception); }
113         };
114     }
115 
116     public static void main(String[] args) throws Exception {
117 
118         // Warmup helper methods
119         Arrays.stream(TestStringIntrinsics2.class.getDeclaredMethods())
120             .filter(m -&gt; m.isAnnotationPresent(Test.class))
121             .filter(m -&gt; m.getAnnotation(Test.class).warmup() &gt; 0)
122             .forEach(rethrowConsumer(m -&gt; {
123                         Test a = m.getAnnotation(Test.class);
124                         System.out.println(&quot;Warming up &quot; + m + &quot; &quot; + a.warmup() + &quot; time(s) &quot;);
125                         for (int i=0; i &lt; a.warmup(); i++) {
126                             m.invoke(null, (Object[])a.warmupArgs());
127                         }
128                     }));
129 
130         // Compile helper methods
131         Arrays.stream(TestStringIntrinsics2.class.getDeclaredMethods())
132             .filter(m -&gt; m.isAnnotationPresent(Test.class))
133             .filter(m -&gt; m.getAnnotation(Test.class).compileAt() &gt; 0)
134             .forEach(rethrowConsumer(m -&gt; {
135                         Test a = m.getAnnotation(Test.class);
136                         if (WB.isMethodCompilable(m, a.compileAt())) {
137                             WB.enqueueMethodForCompilation(m, a.compileAt());
138                             while (WB.isMethodQueuedForCompilation(m)) Thread.sleep(10);
139                             System.out.println(m + &quot; compiled at &quot; + WB.getMethodCompilationLevel(m));
140                         } else {
141                             System.out.println(&quot;Can&#39;t compile &quot; + m + &quot; at level &quot; + a.compileAt());
142                         }
143                     }));
144 
145         // Run test methods
146         Arrays.stream(TestStringIntrinsics2.class.getDeclaredMethods())
147             .filter(m -&gt; m.isAnnotationPresent(Test.class))
148             .filter(m -&gt; m.getAnnotation(Test.class).role() == Role.TEST_ENTRY)
149             .forEach(rethrowConsumer(m -&gt; {
150                         System.out.print(&quot;Executing &quot; + m);
151                         m.invoke(null, (Object[])null);
152                         System.out.println(&quot; - OK&quot;);
153                     }));
154     }
155 
156     static String text = &quot;&lt;t&gt;&lt;t&gt;&lt;t&gt;&lt;t&gt;&lt;t&gt;&lt;t&gt;\n&quot; + &quot;&lt;hit&gt;&quot;;
157     static String text2 = &quot;&lt;t&gt;&lt;t&gt;&lt;t&gt;&lt;t&gt;&lt;t&gt;&lt;t&gt;&lt;t&gt;\n&quot; + &quot;&lt;hit&gt;&quot;;
158     static String[] ss = text.split(&quot;\n&quot;);
159     static String[] ss2 = null;
160     static String needle = &quot;&lt;miss&gt;&quot;;
161 
162     @Test(role = Role.TEST_ENTRY)
163     public static void test_indexOf_no_match() {
164         int res = indexOf_no_match_unknown_needle(ss[0], &quot;&lt;miss&gt;&quot;);
165         assertEquals(res, -1, &quot;test_indexOf_no_match_unknown_needle matched at: &quot; + res);
166         res = indexOf_no_match_imm_needle(ss[0]);
167         assertEquals(res, -1, &quot;test_indexOf_no_match_imm_needle matched at: &quot; + res);
168         res = indexOf_no_match_imm2_needle(ss[0]);
169         assertEquals(res, -1, &quot;test_indexOf_no_match_imm2_needle matched at: &quot; + res);
170 
171         if (ss2 == null) ss2 = text.split(&quot;\n&quot;);
172         res = indexOf_no_match_unknown_needle(ss2[0], &quot;&lt;miss&gt;&quot;);
173         assertEquals(res, -1, &quot;test_indexOf_no_match_unknown_needle matched at: &quot; + res);
174         res = indexOf_no_match_imm_needle(ss2[0]);
175         assertEquals(res, -1, &quot;test_indexOf_no_match_imm_needle matched at: &quot; + res);
176         res = indexOf_no_match_imm2_needle(ss2[0]);
177         assertEquals(res, -1, &quot;test_indexOf_no_match_imm2_needle matched at: &quot; + res);
178         res = indexOf_no_match_imm1_needle(ss2[0]);
179         assertEquals(res, -1, &quot;test_indexOf_no_match_imm1_needle matched at: &quot; + res);
180     }
181 
182     @Test(role = Role.TEST_HELPER, compileAt = 4, warmup = 1, warmupArgs = { &quot;&lt;t&gt;&lt;t&gt;&lt;t&gt;&quot;, &quot;&lt;miss&gt;&quot; })
183     static int indexOf_no_match_unknown_needle(String s, String needle) {
184         int index = s.indexOf(needle);
185         return index;
186     }
187 
188     @Test(role = Role.TEST_HELPER, compileAt = 4, warmup = 1, warmupArgs = { &quot;&lt;t&gt;&lt;t&gt;&lt;t&gt;&quot; })
189     static int indexOf_no_match_imm_needle(String s) {
190         int index = s.indexOf(&quot;&lt;hitt&gt;&quot;);
191         return index;
192     }
193 
194     @Test(role = Role.TEST_HELPER, compileAt = 4, warmup = 1, warmupArgs = { &quot;&lt;t&gt;&lt;t&gt;&lt;t&gt;&quot; })
195     static int indexOf_no_match_imm2_needle(String s) {
196         int index = s.indexOf(&quot;&lt;m&quot;);
197         return index;
198     }
199 
200     @Test(role = Role.TEST_HELPER, compileAt = 4, warmup = 1, warmupArgs = { &quot;&lt;t&gt;&lt;t&gt;&lt;t&gt;&quot; })
201     static int indexOf_no_match_imm1_needle(String s) {
202         int index = s.indexOf(&quot;m&quot;);
203         return index;
204     }
205 
206     @Test(role = Role.TEST_ENTRY)
207     public static void test_indexOf_reads_past_string() {
208         if (ss == null) ss = text.split(&quot;\n&quot;);
209         String res = indexOf_reads_past_string_unknown_needle(ss[0], &quot;&lt;hit&gt;&quot;);
210         assertEquals(res, null, &quot;test_indexOf_reads_past_string_unknown_needle &quot; + res);
211         res = indexOf_reads_past_string_imm_needle(ss[0]);
212         assertEquals(res, null, &quot;test_indexOf_reads_past_string_imm_needle &quot; + res);
213         res = indexOf_reads_past_string_imm2_needle(ss[0]);
214         assertEquals(res, null, &quot;test_indexOf_reads_past_string_imm2_needle &quot; + res);
215         res = indexOf_reads_past_string_imm1_needle(ss[0]);
216         assertEquals(res, null, &quot;test_indexOf_reads_past_string_imm1_needle &quot; + res);
217     }
218 
219     @Test(role = Role.TEST_HELPER, compileAt = 4, warmup = 1, warmupArgs = { &quot;&lt;t&gt;&lt;t&gt;&lt;t&gt;&quot;, &quot;&lt;hit&gt;&quot; })
220     static String indexOf_reads_past_string_unknown_needle(String s, String needle) {
221         int index = s.indexOf(needle);
222         if (index &gt; s.length()) {
223             return &quot;Found needle \&quot;&quot; + needle + &quot;\&quot; behind string of length &quot; + s.length()
224                 + &quot; at position &quot; + index + &quot;.&quot;;
225         }
226         return null;
227     }
228 
229     @Test(role = Role.TEST_HELPER, compileAt = 4, warmup = 1, warmupArgs = { &quot;&lt;t&gt;&lt;t&gt;&lt;t&gt;&quot; })
230     static String indexOf_reads_past_string_imm_needle(String s) {
231         int index = s.indexOf(&quot;&lt;hit&gt;&quot;);
232         if (index &gt; s.length()) {
233             return &quot;Found needle \&quot;&lt;hit&gt;\&quot; behind string of length &quot; + s.length() + &quot; at position &quot; + index + &quot;.&quot;;
234         }
235         return null;
236     }
237 
238     @Test(role = Role.TEST_HELPER, compileAt = 4, warmup = 1, warmupArgs = { &quot;&lt;t&gt;&lt;t&gt;&lt;t&gt;&quot; })
239     static String indexOf_reads_past_string_imm2_needle(String s) {
240         int index = s.indexOf(&quot;&lt;h&quot;);
241         if (index &gt; s.length()) {
242             return &quot;Found needle \&quot;&lt;h\&quot; behind string of length &quot; + s.length() + &quot; at position &quot; + index + &quot;.&quot;;
243         }
244         return null;
245     }
246 
247     @Test(role = Role.TEST_HELPER, compileAt = 4, warmup = 1, warmupArgs = { &quot;&lt;t&gt;&lt;t&gt;&lt;t&gt;&quot; })
248     static String indexOf_reads_past_string_imm1_needle(String s) {
249         int index = s.indexOf(&quot;h&quot;);
250         if (index &gt; s.length()) {
251             return &quot;Found needle \&quot;&lt;h\&quot; behind string of length &quot; + s.length() + &quot; at position &quot; + index + &quot;.&quot;;
252         }
253         return null;
254     }
255 
256     static String text3 =    &quot;&lt;t&gt;&lt;hi&gt;&lt;t&gt;&lt;h&gt;&lt;hit&lt;t&gt;&lt;hit&gt;&quot;;
257     static String text4 =   &quot;a&lt;t&gt;&lt;hi&gt;&lt;t&gt;&lt;h&gt;&lt;hit&lt;t&gt;&lt;hit&gt;&quot;;
258     static String text5 =  &quot;gg&lt;t&gt;&lt;hi&gt;&lt;t&gt;&lt;h&gt;&lt;hit&lt;t&gt;&lt;hit&gt;&quot;;
259     static String text6 = &quot;ccc&lt;t&gt;&lt;hi&gt;&lt;t&gt;&lt;h&gt;&lt;hit&lt;t&gt;&lt;hit&gt;&quot;;
260     static int len3 = text3.length();
261     static int len4 = text4.length();
262     static int len5 = text5.length();
263     static int len6 = text6.length();
264 
265     static String text7  =    &quot;&lt;t&gt;&lt;t&gt;&lt;t&gt;&lt;t&gt;&lt;t&lt;t&gt;&lt;h&quot;;
266     static String text8  =   &quot;a&lt;t&gt;&lt;t&gt;&lt;t&gt;&lt;t&gt;&lt;t&lt;t&gt;&lt;h&quot;;
267     static String text9  =  &quot;gg&lt;t&gt;&lt;t&gt;&lt;t&gt;&lt;t&gt;&lt;t&lt;t&gt;&lt;h&quot;;
268     static String text10 = &quot;ccc&lt;t&gt;&lt;t&gt;&lt;t&gt;&lt;t&gt;&lt;t&lt;t&gt;&lt;h&quot;;
269 
270     @Test(role = Role.TEST_ENTRY)
271     public static void test_indexOf_match_at_end_of_string() {
272         String testname = &quot;test_indexOf_match_at_end_of_string&quot;;
273         int res = 0;
274         res = indexOf_match_at_end_of_string_unknown_needle(text3, &quot;&lt;hit&gt;&quot;);
275         assertEquals(len3, res + 5, testname);
276         res = indexOf_match_at_end_of_string_unknown_needle(text4, &quot;&lt;hit&gt;&quot;);
277         assertEquals(len4, res + 5, testname);
278         res = indexOf_match_at_end_of_string_unknown_needle(text5, &quot;&lt;hit&gt;&quot;);
279         assertEquals(len5, res + 5, testname);
280         res = indexOf_match_at_end_of_string_unknown_needle(text6, &quot;&lt;hit&gt;&quot;);
281         assertEquals(len6, res + 5, testname);
282 
283         res = indexOf_match_at_end_of_string_imm_needle(text3);
284         assertEquals(len3, res + 5, testname);
285         res = indexOf_match_at_end_of_string_imm_needle(text4);
286         assertEquals(len4, res + 5, testname);
287         res = indexOf_match_at_end_of_string_imm_needle(text5);
288         assertEquals(len5, res + 5, testname);
289         res = indexOf_match_at_end_of_string_imm_needle(text6);
290         assertEquals(len6, res + 5, testname);
291 
292         res = indexOf_match_at_end_of_string_imm2_needle(text7);
293         assertEquals(text7.length(),  res + 2, testname);
294         res = indexOf_match_at_end_of_string_imm2_needle(text8);
295         assertEquals(text8.length(),  res + 2, testname);
296         res = indexOf_match_at_end_of_string_imm2_needle(text9);
297         assertEquals(text9.length(),  res + 2, testname);
298         res = indexOf_match_at_end_of_string_imm2_needle(text10);
299         assertEquals(text10.length(), res + 2, testname);
300 
301         res = indexOf_match_at_end_of_string_imm1_needle(text7);
302         assertEquals(text7.length(),  res + 1, testname);
303         res = indexOf_match_at_end_of_string_imm1_needle(text8);
304         assertEquals(text8.length(),  res + 1, testname);
305         res = indexOf_match_at_end_of_string_imm1_needle(text9);
306         assertEquals(text9.length(),  res + 1, testname);
307         res = indexOf_match_at_end_of_string_imm1_needle(text10);
308         assertEquals(text10.length(), res + 1, testname);
309     }
310 
311     @Test(role = Role.TEST_HELPER, compileAt = 4, warmup = 1, warmupArgs = { &quot;&lt;t&gt;&lt;hi&gt;&lt;t&gt;&lt;h&gt;&lt;hit&lt;t&gt;&lt;hit&gt;&quot;, &quot;&lt;hit&gt;&quot; })
312     static int indexOf_match_at_end_of_string_unknown_needle(String s, String needle) {
313         int index = s.indexOf(needle);
314         return index;
315     }
316 
317     @Test(role = Role.TEST_HELPER, compileAt = 4, warmup = 1, warmupArgs = { &quot;&lt;t&gt;&lt;hi&gt;&lt;t&gt;&lt;h&gt;&lt;hit&lt;t&gt;&lt;hit&gt;&quot; })
318     static int indexOf_match_at_end_of_string_imm_needle(String s) {
319         int index = s.indexOf(&quot;&lt;hit&gt;&quot;);
320         return index;
321     }
322 
323     @Test(role = Role.TEST_HELPER, compileAt = 4, warmup = 1, warmupArgs = { &quot;&lt;t&gt;&lt;hi&gt;&lt;t&gt;&lt;h&gt;&lt;hit&lt;t&gt;&lt;hit&gt;&quot; })
324     static int indexOf_match_at_end_of_string_imm2_needle(String s) {
325         int index = s.indexOf(&quot;&lt;h&quot;);
326         return index;
327     }
328 
329     @Test(role = Role.TEST_HELPER, compileAt = 4, warmup = 1, warmupArgs = { &quot;&lt;t&gt;&lt;hi&gt;&lt;t&gt;&lt;h&gt;&lt;hit&lt;t&gt;&lt;hit&gt;&quot; })
330     static int indexOf_match_at_end_of_string_imm1_needle(String s) {
331         int index = s.indexOf(&quot;h&quot;);
332         return index;
333     }
334 
335     static String s0_1 = text3.substring(0, len3-1);
336     static String s0_2 = text3.substring(0, len3-2);
337     static String s0_3 = text3.substring(0, len3-3);
338     static String s0_4 = text3.substring(0, len3-4);
339     static String s1_1 = text4.substring(0, len4-1);
340     static String s1_2 = text4.substring(0, len4-2);
341     static String s1_3 = text4.substring(0, len4-3);
342     static String s1_4 = text4.substring(0, len4-4);
343     static String s2_1 = text5.substring(0, len5-1);
344     static String s2_2 = text5.substring(0, len5-2);
345     static String s2_3 = text5.substring(0, len5-3);
346     static String s2_4 = text5.substring(0, len5-4);
347     static String s3_1 = text6.substring(0, len6-1);
348     static String s3_2 = text6.substring(0, len6-2);
349     static String s3_3 = text6.substring(0, len6-3);
350     static String s3_4 = text6.substring(0, len6-4);
351 
352     static String s0_1x = text7 .substring(0, text7 .length()-1);
353     static String s1_1x = text8 .substring(0, text8 .length()-1);
354     static String s2_1x = text9 .substring(0, text9 .length()-1);
355     static String s3_1x = text10.substring(0, text10.length()-1);
356 
357     @Test(role = Role.TEST_ENTRY)
358     public static void test_indexOf_match_spans_end_of_string() {
359         String res = null;
360         res = indexOf_match_spans_end_of_string_unknown_needle(s0_1, &quot;&lt;hit&gt;&quot;);
361         assertEquals(res, null, &quot;test_indexOf_match_spans_end_of_string_unknown_needle s0_1 &quot; + res);
362         res = indexOf_match_spans_end_of_string_unknown_needle(s0_2, &quot;&lt;hit&gt;&quot;);
363         assertEquals(res, null, &quot;test_indexOf_match_spans_end_of_string_unknown_needle s0_2 &quot; + res);
364         res = indexOf_match_spans_end_of_string_unknown_needle(s0_3, &quot;&lt;hit&gt;&quot;);
365         assertEquals(res, null, &quot;test_indexOf_match_spans_end_of_string_unknown_needle s0_3 &quot; + res);
366         res = indexOf_match_spans_end_of_string_unknown_needle(s0_4, &quot;&lt;hit&gt;&quot;);
367         assertEquals(res, null, &quot;test_indexOf_match_spans_end_of_string_unknown_needle s0_4 &quot; + res);
368         res = indexOf_match_spans_end_of_string_unknown_needle(s1_1, &quot;&lt;hit&gt;&quot;);
369         assertEquals(res, null, &quot;test_indexOf_match_spans_end_of_string_unknown_needle s1_1 &quot; + res);
370         res = indexOf_match_spans_end_of_string_unknown_needle(s1_2, &quot;&lt;hit&gt;&quot;);
371         assertEquals(res, null, &quot;test_indexOf_match_spans_end_of_string_unknown_needle s1_2 &quot; + res);
372         res = indexOf_match_spans_end_of_string_unknown_needle(s1_3, &quot;&lt;hit&gt;&quot;);
373         assertEquals(res, null, &quot;test_indexOf_match_spans_end_of_string_unknown_needle s1_3 &quot; + res);
374         res = indexOf_match_spans_end_of_string_unknown_needle(s1_4, &quot;&lt;hit&gt;&quot;);
375         assertEquals(res, null, &quot;test_indexOf_match_spans_end_of_string_unknown_needle s1_4 &quot; + res);
376         res = indexOf_match_spans_end_of_string_unknown_needle(s2_1, &quot;&lt;hit&gt;&quot;);
377         assertEquals(res, null, &quot;test_indexOf_match_spans_end_of_string_unknown_needle s2_1 &quot; + res);
378         res = indexOf_match_spans_end_of_string_unknown_needle(s2_2, &quot;&lt;hit&gt;&quot;);
379         assertEquals(res, null, &quot;test_indexOf_match_spans_end_of_string_unknown_needle s2_2 &quot; + res);
380         res = indexOf_match_spans_end_of_string_unknown_needle(s2_3, &quot;&lt;hit&gt;&quot;);
381         assertEquals(res, null, &quot;test_indexOf_match_spans_end_of_string_unknown_needle s2_3 &quot; + res);
382         res = indexOf_match_spans_end_of_string_unknown_needle(s2_4, &quot;&lt;hit&gt;&quot;);
383         assertEquals(res, null, &quot;test_indexOf_match_spans_end_of_string_unknown_needle s2_4 &quot; + res);
384         res = indexOf_match_spans_end_of_string_unknown_needle(s3_1, &quot;&lt;hit&gt;&quot;);
385         assertEquals(res, null, &quot;test_indexOf_match_spans_end_of_string_unknown_needle s3_1 &quot; + res);
386         res = indexOf_match_spans_end_of_string_unknown_needle(s3_2, &quot;&lt;hit&gt;&quot;);
387         assertEquals(res, null, &quot;test_indexOf_match_spans_end_of_string_unknown_needle s3_2 &quot; + res);
388         res = indexOf_match_spans_end_of_string_unknown_needle(s3_3, &quot;&lt;hit&gt;&quot;);
389         assertEquals(res, null, &quot;test_indexOf_match_spans_end_of_string_unknown_needle s3_3 &quot; + res);
390         res = indexOf_match_spans_end_of_string_unknown_needle(s3_4, &quot;&lt;hit&gt;&quot;);
391         assertEquals(res, null, &quot;test_indexOf_match_spans_end_of_string_unknown_needle s3_4 &quot; + res);
392 
393         res = indexOf_match_spans_end_of_string_imm_needle(s0_1);
394         assertEquals(res, null, &quot;test_indexOf_match_spans_end_of_string_imm_needle s0_1 &quot; + res);
395         res = indexOf_match_spans_end_of_string_imm_needle(s0_2);
396         assertEquals(res, null, &quot;test_indexOf_match_spans_end_of_string_imm_needle s0_2 &quot; + res);
397         res = indexOf_match_spans_end_of_string_imm_needle(s0_3);
398         assertEquals(res, null, &quot;test_indexOf_match_spans_end_of_string_imm_needle s0_3 &quot; + res);
399         res = indexOf_match_spans_end_of_string_imm_needle(s0_4);
400         assertEquals(res, null, &quot;test_indexOf_match_spans_end_of_string_imm_needle s0_4 &quot; + res);
401         res = indexOf_match_spans_end_of_string_imm_needle(s1_1);
402         assertEquals(res, null, &quot;test_indexOf_match_spans_end_of_string_imm_needle s1_1 &quot; + res);
403         res = indexOf_match_spans_end_of_string_imm_needle(s1_2);
404         assertEquals(res, null, &quot;test_indexOf_match_spans_end_of_string_imm_needle s1_2 &quot; + res);
405         res = indexOf_match_spans_end_of_string_imm_needle(s1_3);
406         assertEquals(res, null, &quot;test_indexOf_match_spans_end_of_string_imm_needle s1_3 &quot; + res);
407         res = indexOf_match_spans_end_of_string_imm_needle(s1_4);
408         assertEquals(res, null, &quot;test_indexOf_match_spans_end_of_string_imm_needle s1_4 &quot; + res);
409         res = indexOf_match_spans_end_of_string_imm_needle(s2_1);
410         assertEquals(res, null, &quot;test_indexOf_match_spans_end_of_string_imm_needle s2_1 &quot; + res);
411         res = indexOf_match_spans_end_of_string_imm_needle(s2_2);
412         assertEquals(res, null, &quot;test_indexOf_match_spans_end_of_string_imm_needle s2_2 &quot; + res);
413         res = indexOf_match_spans_end_of_string_imm_needle(s2_3);
414         assertEquals(res, null, &quot;test_indexOf_match_spans_end_of_string_imm_needle s2_3 &quot; + res);
415         res = indexOf_match_spans_end_of_string_imm_needle(s2_4);
416         assertEquals(res, null, &quot;test_indexOf_match_spans_end_of_string_imm_needle s2_4 &quot; + res);
417         res = indexOf_match_spans_end_of_string_imm_needle(s3_1);
418         assertEquals(res, null, &quot;test_indexOf_match_spans_end_of_string_imm_needle s3_1 &quot; + res);
419         res = indexOf_match_spans_end_of_string_imm_needle(s3_2);
420         assertEquals(res, null, &quot;test_indexOf_match_spans_end_of_string_imm_needle s3_2 &quot; + res);
421         res = indexOf_match_spans_end_of_string_imm_needle(s3_3);
422         assertEquals(res, null, &quot;test_indexOf_match_spans_end_of_string_imm_needle s3_3 &quot; + res);
423         res = indexOf_match_spans_end_of_string_imm_needle(s3_4);
424         assertEquals(res, null, &quot;test_indexOf_match_spans_end_of_string_imm_needle s3_4 &quot; + res);
425 
426         res = indexOf_match_spans_end_of_string_imm2_needle(s0_1x);
427         assertEquals(res, null, &quot;test_indexOf_match_spans_end_of_string_imm2_needle s0_1x &quot; + res);
428         res = indexOf_match_spans_end_of_string_imm2_needle(s1_1x);
429         assertEquals(res, null, &quot;test_indexOf_match_spans_end_of_string_imm2_needle s1_1x &quot; + res);
430         res = indexOf_match_spans_end_of_string_imm2_needle(s2_1x);
431         assertEquals(res, null, &quot;test_indexOf_match_spans_end_of_string_imm2_needle s2_1x &quot; + res);
432         res = indexOf_match_spans_end_of_string_imm2_needle(s3_1x);
433         assertEquals(res, null, &quot;test_indexOf_match_spans_end_of_string_imm2_needle s3_1x &quot; + res);
434     }
435 
436     @Test(role = Role.TEST_HELPER, compileAt = 4, warmup = 1, warmupArgs = { &quot;&lt;t&gt;&lt;hi&gt;&lt;t&gt;&lt;h&gt;&lt;hit&lt;t&gt;&lt;hit&quot;, &quot;&lt;hit&gt;&quot; })
437     static String indexOf_match_spans_end_of_string_unknown_needle(String s, String needle) {
438         int index = s.indexOf(needle);
439         if (index &gt; -1) {
440             return &quot;Found needle \&quot;&quot; + needle + &quot;\&quot; that is spanning the end of the string: &quot; + s + &quot;.&quot;;
441         }
442         return null;
443     }
444 
445     @Test(role = Role.TEST_HELPER, compileAt = 4, warmup = 1, warmupArgs = { &quot;&lt;t&gt;&lt;hi&gt;&lt;t&gt;&lt;h&gt;&lt;hit&lt;t&gt;&lt;hit&quot; })
446     static String indexOf_match_spans_end_of_string_imm_needle(String s) {
447         int index = s.indexOf(&quot;&lt;hit&gt;&quot;);
448         if (index &gt; -1) {
449             return &quot;Found needle \&quot;&lt;hit&gt;\&quot; that is spanning the end of the string: &quot; + s + &quot;.&quot;;
450         }
451         return null;
452     }
453 
454     @Test(role = Role.TEST_HELPER, compileAt = 4, warmup = 1, warmupArgs = { &quot;&lt;t&gt;&lt;t&gt;&lt;t&gt;&lt;t&gt;&lt;t&lt;t&gt;&lt;&quot; })
455     static String indexOf_match_spans_end_of_string_imm2_needle(String s) {
456         int index = s.indexOf(&quot;&lt;h&quot;);
457         if (index &gt; -1) {
458             return &quot;Found needle \&quot;&lt;h\&quot; that is spanning the end of the string: &quot; + s + &quot;.&quot;;
459         }
460         return null;
461     }
462 
463     static String text16 = &quot;ooooooo&quot;;
464     static String text11 = &quot;1ooooooo&quot;;
465     static String text12 = &quot;ooooooo1&quot;;
466     static String text13 = &quot;oooooooo1&quot;;
467     static String text14 = &quot;ooooooooo1&quot;;
468     static String text15 = &quot;oooooooooo1&quot;;
469     static int len12 = text12.length();
470     static int len13 = text13.length();
471     static int len14 = text14.length();
472     static int len15 = text15.length();
473 
474     static String text12_1 = text12.substring(0, len12-1);
475     static String text13_1 = text13.substring(0, len13-1);
476     static String text14_1 = text14.substring(0, len14-1);
477     static String text15_1 = text15.substring(0, len15-1);
478 
479     @Test(role = Role.TEST_ENTRY)
480     public static void test_indexOf_imm1_needle() {
481         assertEquals(     -1, indexOf_imm1_needle(text16), &quot;test_indexOf_imm1_needle no_match&quot;);
482 
483         assertEquals(      0, indexOf_imm1_needle(text11), &quot;test_indexOf_imm1_needle first_matches&quot;);
484 
485         assertEquals(len12-1, indexOf_imm1_needle(text12), &quot;test_indexOf_imm1_needle last_matches&quot;);
486         assertEquals(len13-1, indexOf_imm1_needle(text13), &quot;test_indexOf_imm1_needle last_matches&quot;);
487         assertEquals(len14-1, indexOf_imm1_needle(text14), &quot;test_indexOf_imm1_needle last_matches&quot;);
488         assertEquals(len15-1, indexOf_imm1_needle(text15), &quot;test_indexOf_imm1_needle last_matches&quot;);
489 
490         assertEquals(     -1, indexOf_imm1_needle(text12_1), &quot;test_indexOf_imm1_needle walked_past&quot;);
491         assertEquals(     -1, indexOf_imm1_needle(text13_1), &quot;test_indexOf_imm1_needle walked_past&quot;);
492         assertEquals(     -1, indexOf_imm1_needle(text14_1), &quot;test_indexOf_imm1_needle walked_past&quot;);
493         assertEquals(     -1, indexOf_imm1_needle(text15_1), &quot;test_indexOf_imm1_needle walked_past&quot;);
494     }
495 
496     @Test(role = Role.TEST_HELPER, compileAt = 4, warmup = 1, warmupArgs = { &quot;ooooooo1&quot; })
497     static int indexOf_imm1_needle(String s) {
498         return s.indexOf(&quot;1&quot;);
499     }
500 
501     static String text1UTF16 = &quot;A&quot; + &quot;\u05d0&quot; + &quot;\u05d1&quot; + &quot;B&quot;;
502 
503     @Test(role = Role.TEST_ENTRY)
504     public static void test_indexOf_immUTF16() {
505         assertEquals(      3, indexOf_imm1Latin1_needle(text1UTF16), &quot;test_indexOf_immUTF16&quot;);
506         assertEquals(      1, indexOf_imm1UTF16_needle(text1UTF16), &quot;test_indexOf_immUTF16&quot;);
507         assertEquals(      1, indexOf_immUTF16_needle(text1UTF16), &quot;test_indexOf_immUTF16&quot;);
508     }
509 
510     @Test(role = Role.TEST_HELPER, compileAt = 4, warmup = 1, warmupArgs = { &quot;A&quot; + &quot;\u05d0&quot; + &quot;\u05d1&quot; + &quot;B&quot; })
511     static int indexOf_imm1Latin1_needle(String s) {
512         return s.indexOf(&quot;B&quot;);
513     }
514 
515     @Test(role = Role.TEST_HELPER, compileAt = 4, warmup = 1, warmupArgs = { &quot;A&quot; + &quot;\u05d0&quot; + &quot;\u05d1&quot; + &quot;B&quot; })
516     static int indexOf_imm1UTF16_needle(String s) {
517         return s.indexOf(&quot;\u05d0&quot;);
518     }
519 
520     @Test(role = Role.TEST_HELPER, compileAt = 4, warmup = 1, warmupArgs = { &quot;A&quot; + &quot;\u05d0&quot; + &quot;\u05d1&quot; + &quot;B&quot; })
521     static int indexOf_immUTF16_needle(String s) {
522         return s.indexOf(&quot;\u05d0&quot; + &quot;\u05d1&quot;);
523     }
524 
525     @Test(role = Role.TEST_HELPER, compileAt = 4, warmup = 1, warmupArgs = { &quot;abc&quot;, &quot;abcd&quot; })
526     public static int asmStringCompareTo(String a, String b) {
527         return a.compareTo(b);
528     }
529 
530     @Test(role = Role.TEST_ENTRY)
531     public static void test_asmStringCompareTo() {
532         // null
533         try {
534             asmStringCompareTo(&quot;not null&quot;, null);
535             assertTrue(false,
536                        &quot;TestOther.asmStringCompareTo(\&quot;not null\&quot;, null) doesn&#39;t throw exception&quot;);
537         } catch (NullPointerException e) {
538             assertEquals(&quot;java.lang.String.compareTo&quot;,
539                          e.getStackTrace()[0].getClassName() + &quot;.&quot; +
540                          e.getStackTrace()[0].getMethodName(),
541                          &quot;TestOther.asmStringCompareTo(\&quot;not null\&quot;, null) throws exception&quot;);
542         }
543 
544         // ==0
545         {
546             // check length 0 optimization
547             assertEquals(0, asmStringCompareTo(&quot;&quot;, &quot;&quot;),
548                          &quot;TestOther.asmStringCompareTo(\&quot;\&quot;, \&quot;\&quot;)&quot;);
549 
550             // check first character optimization
551             assertEquals(0, asmStringCompareTo(&quot;A&quot;, &quot;A&quot;),
552                          &quot;TestOther.asmStringCompareTo(\&quot;A\&quot;, \&quot;A\&quot;)&quot;);
553 
554             // check real comparisons
555             assertEquals(0, asmStringCompareTo(new String(&quot;eq&quot;) + new String(&quot;ual&quot;), &quot;equal&quot;),
556                          &quot;TestOther.asmStringCompareTo(\&quot;equal\&quot;, \&quot;equal\&quot;)&quot;);
557             assertEquals(0, asmStringCompareTo(&quot;textABC&quot;, &quot;textABC&quot;),
558                          &quot;TestOther.asmStringCompareTo(\&quot;textABC\&quot;, \&quot;textABC\&quot;)&quot;);
559             assertEquals(0,
560                          asmStringCompareTo(new String(&quot;abcdefgh01234&quot;) +
561                                             new String(&quot;56abcdefgh0123456abcdefgh0123456&quot;),
562                                             &quot;abcdefgh0123456abcdefgh0123456abcdefgh0123456&quot;),
563                          &quot;TestOther.asmStringCompareTo(\&quot;abcdefgh0123456abcdefgh0123456abcdefgh0123456\&quot;, &quot; +
564                          &quot;\&quot;abcdefgh0123456abcdefgh0123456abcdefgh0123456\&quot;)&quot;);
565         }
566 
567         // &lt;0
568         {
569             // check first character optimization
570             assertEquals(-1, asmStringCompareTo(&quot;4&quot;, &quot;5&quot;),
571                          &quot;TestOther.asmStringCompareTo(\&quot;4\&quot;, \&quot;5\&quot;)&quot;);
572 
573             // check real comparisons
574             assertEquals(-1, asmStringCompareTo(&quot;diff4&quot;, &quot;diff5&quot;),
575                          &quot;TestOther.asmStringCompareTo(\&quot;diff4\&quot;, \&quot;diff5\&quot;)&quot;);
576             assertEquals(-10, asmStringCompareTo(&quot;&quot;, &quot;123456789A&quot;),
577                          &quot;TestOther.asmStringCompareTo(\&quot;\&quot;, \&quot;123456789A\&quot;)&quot;);
578             assertEquals(-10, asmStringCompareTo(&quot;ZYX&quot;, &quot;ZYX123456789A&quot;),
579                          &quot;TestOther.asmStringCompareTo(\&quot;ZYX\&quot;, \&quot;ZYX123456789A\&quot;)&quot;);
580         }
581 
582         // &gt;0
583         {
584             // check first character optimization
585             assertEquals(1, asmStringCompareTo(&quot;5&quot;, &quot;4&quot;),
586                          &quot;TestOther.asmStringCompareTo(\&quot;5\&quot;, \&quot;4\&quot;)&quot;);
587 
588             // check real comparisons
589             assertEquals(1, asmStringCompareTo(&quot;diff5&quot;, &quot;diff4&quot;),
590                          &quot;TestOther.asmStringCompareTo(\&quot;diff5\&quot;, \&quot;diff4\&quot;)&quot;);
591             assertEquals(10, asmStringCompareTo(&quot;123456789A&quot;, &quot;&quot;),
592                          &quot;TestOther.asmStringCompareTo(\&quot;123456789A\&quot;, \&quot;\&quot;)&quot;);
593             assertEquals(10, asmStringCompareTo(&quot;ZYX123456789A&quot;, &quot;ZYX&quot;),
594                          &quot;TestOther.asmStringCompareTo(\&quot;ZYX123456789A\&quot;, \&quot;ZYX\&quot;)&quot;);
595         }
596 
597         // very long strings (100k)
598         {
599             char[] ac = new char[(100 * 1024)];
600             for (int i = 0; i &lt; (100 * 1024); i += 315)
601                 ac[i] = (char) ((i % 12) + &#39;a&#39;);
602             char[] bc = new char[(100 * 1024)];
603             for (int i = 0; i &lt; (100 * 1024); i += 315)
604                 bc[i] = (char) ((i % 12) + &#39;a&#39;);
605 
606             ac[(100 * 1024) - 1] = &#39;2&#39;;
607             bc[(100 * 1024) - 1] = &#39;2&#39;;
608             String a1 = new String(ac);
609             String b1 = new String(bc);
610             assertEquals(0, asmStringCompareTo(a1, b1),
611                          &quot;TestOther.asmStringCompareTo(very_long_strings_1)&quot;);
612 
613             ac[(100 * 1024) - 1] = &#39;X&#39;;
614             bc[(100 * 1024) - 1] = &#39;Z&#39;;
615             String a2 = new String(ac);
616             String b2 = new String(bc);
617             assertEquals(-2, asmStringCompareTo(a2, b2),
618                          &quot;TestOther.asmStringCompareTo(very_long_strings_2)&quot;);
619         }
620 
621         // very very long strings (2M)
622         {
623             char[] ac = new char[(2 * 1024 * 1024)];
624             for (int i = 0; i &lt; (2 * 1024 * 1024); i += 315)
625                 ac[i] = (char) ((i % 12) + &#39;a&#39;);
626             char[] bc = new char[(2 * 1024 * 1024)];
627             for (int i = 0; i &lt; (2 * 1024 * 1024); i += 315)
628                 bc[i] = (char) ((i % 12) + &#39;a&#39;);
629 
630             ac[(2 * 1024 * 1024) - 1] = &#39;3&#39;;
631             bc[(2 * 1024 * 1024) - 1] = &#39;3&#39;;
632             String a1 = new String(ac);
633             String b1 = new String(bc);
634             assertEquals(0, asmStringCompareTo(a1, b1),
635                          &quot;TestOther.asmStringCompareTo(very_very_long_strings_1)&quot;);
636 
637             ac[(2 * 1024 * 1024) - 1] = &#39;W&#39;;
638             bc[(2 * 1024 * 1024) - 1] = &#39;Z&#39;;
639             String a2 = new String(ac);
640             String b2 = new String(bc);
641             assertEquals(-3, asmStringCompareTo(a2, b2),
642                          &quot;TestOther.asmStringCompareTo(very_very_long_strings_2)&quot;);
643         }
644 
645         // See bug 8215100
646         {
647             assertEquals(-20, asmStringCompareTo(&quot;e.\u0259.&quot;, &quot;y.e.&quot;));
648             assertEquals(20, asmStringCompareTo(&quot;y.e.&quot;, &quot;e.\u0259.&quot;));
649         }
650     }
651 
652 
653     @Test(role = Role.TEST_HELPER, compileAt = 4, warmup = 1, warmupArgs = { &quot;abc&quot;, &quot;abcd&quot; })
654     public static boolean asmStringEquals(String a, String b) {
655         return a.equals(b);
656     }
657 
658     static String a1 = &quot;abcd&quot;;
659     static String b1 = &quot;abcd&quot;;
660     static final String a2 = &quot;1234&quot;;
661     static final String b2 = &quot;1234&quot;;
662 
663     @Test(role = Role.TEST_HELPER, compileAt = 4, warmup = 1)
664     public static boolean asmStringEqualsConst() {
665         boolean ret = a1.equals(b1);
666         ret &amp;= a2.equals(b2);
667         ret &amp;= !a2.equals(b1);
668         ret &amp;= &quot;ABCD&quot;.equals(&quot;ABCD&quot;);
669         return ret;
670     }
671 
672 
673     @Test(role = Role.TEST_ENTRY)
674     public static void test_asmStringEquals() {
675         // null
676         {
677             assertFalse(asmStringEquals(&quot;not null&quot;, null),
678                         &quot;TestOther.asmStringEquals(\&quot;not null\&quot;, null)&quot;);
679         }
680 
681         // true
682         {
683             // check constant optimization
684             assertTrue(asmStringEqualsConst(),
685                        &quot;TestOther.asmStringEqualsConst(\&quot;\&quot;, \&quot;\&quot;)&quot;);
686 
687             // check length 0 optimization
688             assertTrue(asmStringEquals(&quot;&quot;, &quot;&quot;),
689                        &quot;TestOther.asmStringEquals(\&quot;\&quot;, \&quot;\&quot;)&quot;);
690 
691             // check first character optimization
692             assertTrue(asmStringEquals(&quot;A&quot;, &quot;A&quot;),
693                        &quot;TestOther.asmStringEquals(\&quot;A\&quot;, \&quot;A\&quot;)&quot;);
694 
695             // check real comparisons
696             assertTrue(asmStringEquals(new String(&quot;eq&quot;) + new String(&quot;ual&quot;), &quot;equal&quot;),
697                        &quot;TestOther.asmStringEquals(\&quot;equal\&quot;, \&quot;equal\&quot;)&quot;);
698             assertTrue(asmStringEquals(&quot;textABC&quot;, &quot;textABC&quot;),
699                        &quot;TestOther.asmStringEquals(\&quot;textABC\&quot;, \&quot;textABC\&quot;)&quot;);
700             assertTrue(asmStringEquals(new String(&quot;abcdefgh01234&quot;) +
701                                        new String(&quot;56abcdefgh0123456abcdefgh0123456&quot;),
702                                        &quot;abcdefgh0123456abcdefgh0123456abcdefgh0123456&quot;),
703                        &quot;TestOther.asmStringEquals(\&quot;abcdefgh0123456abcdefgh0123456abcdefgh0123456\&quot;, &quot; +
704                        &quot;\&quot;abcdefgh0123456abcdefgh0123456abcdefgh0123456\&quot;)&quot;);
705         }
706     }
707 
708 }
    </pre>
  </body>
</html>