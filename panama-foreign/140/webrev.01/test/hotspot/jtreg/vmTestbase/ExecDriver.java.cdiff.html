<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff test/hotspot/jtreg/vmTestbase/ExecDriver.java</title>
    <link rel="stylesheet" href="../../../../style.css" />
  </head>
<body>
<center><a href="../testlibrary_tests/whitebox/vm_flags/UintxTest.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="gc/g1/unloading/tests/unloading_anonclassloader_inMemoryCompilation_keep_class/TestDescription.java.cdiff.html" target="_top">next &gt;</a></center>    <h2>test/hotspot/jtreg/vmTestbase/ExecDriver.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 1,7 ***</span>
  /*
<span class="line-modified">!  * Copyright (c) 2017, 2019, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
<span class="line-new-header">--- 1,7 ---</span>
  /*
<span class="line-modified">!  * Copyright (c) 2017, 2020, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
</pre>
<hr />
<pre>
<span class="line-old-header">*** 19,20 ***</span>
   * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
   * or visit www.oracle.com if you need additional information or have any
   * questions.
   */
  
<span class="line-removed">- import jdk.test.lib.Platform;</span>
<span class="line-removed">- import jdk.test.lib.Utils;</span>
<span class="line-removed">- </span>
  import java.io.File;
  import java.io.IOException;
  import java.io.InputStream;
  import java.io.OutputStream;
  import java.nio.file.Path;
  import java.nio.file.Paths;
  import java.util.Arrays;
  
  /**
   * Starts a new process to execute a command.
   * &lt;p&gt;Usage: --java|--cmd|--launcher &lt;arg&gt;+
   * &lt;p&gt;If {@code --cmd} flag is specified, the arguments are treated as
<span class="line-new-header">--- 19,20 ---</span>
   * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
   * or visit www.oracle.com if you need additional information or have any
   * questions.
   */
  
  import java.io.File;
  import java.io.IOException;
  import java.io.InputStream;
  import java.io.OutputStream;
  import java.nio.file.Path;
  import java.nio.file.Paths;
<span class="line-added">+ import java.util.ArrayList;</span>
  import java.util.Arrays;
<span class="line-added">+ import java.util.Collections;</span>
<span class="line-added">+ import java.util.List;</span>
  
  /**
   * Starts a new process to execute a command.
   * &lt;p&gt;Usage: --java|--cmd|--launcher &lt;arg&gt;+
   * &lt;p&gt;If {@code --cmd} flag is specified, the arguments are treated as
</pre>
<hr />
<pre>
<span class="line-old-header">*** 46,10 ***</span>
<span class="line-new-header">--- 46,14 ---</span>
   * contains {@code jvm.so} in dynamic library path, and {@code test.class.path}
   * as CLASSPATH environment variable. Exit codes are checked as in
   * {@code --java}, i.e. 0 or 95 means pass.
   */
  public class ExecDriver {
<span class="line-added">+     // copied from jdk.test.lib.Utils.TEST_CLASS_PATH</span>
<span class="line-added">+     private static final String TEST_CLASS_PATH = System.getProperty(&quot;test.class.path&quot;, &quot;.&quot;);</span>
<span class="line-added">+     // copied from jdk.test.lib.Utils.TEST_CLASS_PATH</span>
<span class="line-added">+     private static final String TEST_JDK = System.getProperty(&quot;test.jdk&quot;);</span>
      public static void main(String[] args) throws IOException, InterruptedException {
          boolean java = false;
          boolean launcher = false;
  
          String type = args[0];
</pre>
<hr />
<pre>
<span class="line-old-header">*** 66,11 ***</span>
                      count = 3;
                      args = new String[args.length + 2];
                  }
                  args[0] = javaBin();
                  args[1] = &quot;-cp&quot;;
<span class="line-modified">!                 args[2] = Utils.TEST_CLASS_PATH;</span>
                  System.arraycopy(oldArgs, 1, args, count, oldArgs.length - 1);
                  java = true;
                  break;
              case &quot;--launcher&quot;:
                  java = true;
<span class="line-new-header">--- 70,11 ---</span>
                      count = 3;
                      args = new String[args.length + 2];
                  }
                  args[0] = javaBin();
                  args[1] = &quot;-cp&quot;;
<span class="line-modified">!                 args[2] = TEST_CLASS_PATH;</span>
                  System.arraycopy(oldArgs, 1, args, count, oldArgs.length - 1);
                  java = true;
                  break;
              case &quot;--launcher&quot;:
                  java = true;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 82,11 ***</span>
                  throw new Error(&quot;unknown type: &quot; + type);
          }
          // adding &#39;test.vm.opts&#39; and &#39;test.java.opts&#39;
          if (java) {
              String[] oldArgs = args;
<span class="line-modified">!             String[] testJavaOpts = Utils.getTestJavaOpts();</span>
              if (testJavaOpts.length &gt; 0) {
                  args = new String[args.length + testJavaOpts.length];
                  // bin/java goes before options
                  args[0] = oldArgs[0];
                  // then external java options
<span class="line-new-header">--- 86,11 ---</span>
                  throw new Error(&quot;unknown type: &quot; + type);
          }
          // adding &#39;test.vm.opts&#39; and &#39;test.java.opts&#39;
          if (java) {
              String[] oldArgs = args;
<span class="line-modified">!             String[] testJavaOpts = getTestJavaOpts();</span>
              if (testJavaOpts.length &gt; 0) {
                  args = new String[args.length + testJavaOpts.length];
                  // bin/java goes before options
                  args[0] = oldArgs[0];
                  // then external java options
</pre>
<hr />
<pre>
<span class="line-old-header">*** 99,14 ***</span>
          System.out.println(&quot;exec &quot; + command);
  
          ProcessBuilder pb = new ProcessBuilder(args);
          // adding jvm.so to library path
          if (launcher) {
<span class="line-modified">!             Path dir = Paths.get(Utils.TEST_JDK);</span>
              String value;
<span class="line-modified">!             String name = Platform.sharedLibraryPathVariableName();</span>
<span class="line-modified">!             if (Platform.isWindows()) {</span>
                  value = dir.resolve(&quot;bin&quot;)
                             .resolve(variant())
                             .toAbsolutePath()
                             .toString();
                  value += File.pathSeparator;
<span class="line-new-header">--- 103,15 ---</span>
          System.out.println(&quot;exec &quot; + command);
  
          ProcessBuilder pb = new ProcessBuilder(args);
          // adding jvm.so to library path
          if (launcher) {
<span class="line-modified">!             Path dir = Paths.get(TEST_JDK);</span>
              String value;
<span class="line-modified">!             String name = sharedLibraryPathVariableName();</span>
<span class="line-modified">!             // if (jdk.test.lib.Platform.isWindows()) {</span>
<span class="line-added">+             if (System.getProperty(&quot;os.name&quot;).toLowerCase().startsWith(&quot;win&quot;)) {</span>
                  value = dir.resolve(&quot;bin&quot;)
                             .resolve(variant())
                             .toAbsolutePath()
                             .toString();
                  value += File.pathSeparator;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 123,11 ***</span>
              System.out.println(&quot;  with &quot; + name + &quot; = &quot; +
                      pb.environment()
                        .merge(name, value, (x, y) -&gt; y + File.pathSeparator + x));
              System.out.println(&quot;  with CLASSPATH = &quot; +
                      pb.environment()
<span class="line-modified">!                       .put(&quot;CLASSPATH&quot;, Utils.TEST_CLASS_PATH));</span>
          }
          Process p = pb.start();
          // inheritIO does not work as expected for @run driver
          new Thread(() -&gt; copy(p.getInputStream(), System.out)).start();
          new Thread(() -&gt; copy(p.getErrorStream(), System.out)).start();
<span class="line-new-header">--- 128,11 ---</span>
              System.out.println(&quot;  with &quot; + name + &quot; = &quot; +
                      pb.environment()
                        .merge(name, value, (x, y) -&gt; y + File.pathSeparator + x));
              System.out.println(&quot;  with CLASSPATH = &quot; +
                      pb.environment()
<span class="line-modified">!                       .put(&quot;CLASSPATH&quot;, TEST_CLASS_PATH));</span>
          }
          Process p = pb.start();
          // inheritIO does not work as expected for @run driver
          new Thread(() -&gt; copy(p.getInputStream(), System.out)).start();
          new Thread(() -&gt; copy(p.getErrorStream(), System.out)).start();
</pre>
<hr />
<pre>
<span class="line-old-header">*** 136,23 ***</span>
          if (exitCode != 0 &amp;&amp; (!java || exitCode != 95)) {
              throw new AssertionError(command + &quot; exit code is &quot; + exitCode);
          }
      }
  
      private static String variant() {
<span class="line-modified">!         if (Platform.isServer()) {</span>
              return &quot;server&quot;;
<span class="line-modified">!         } else if (Platform.isClient()) {</span>
              return &quot;client&quot;;
<span class="line-modified">!         } else if (Platform.isMinimal()) {</span>
              return &quot;minimal&quot;;
          } else {
              throw new Error(&quot;TESTBUG: unsuppported vm variant&quot;);
          }
      }
  
<span class="line-removed">- </span>
      private static void copy(InputStream is, OutputStream os) {
          byte[] buffer = new byte[1024];
          int n;
          try (InputStream close = is) {
              while ((n = is.read(buffer)) != -1) {
<span class="line-new-header">--- 141,56 ---</span>
          if (exitCode != 0 &amp;&amp; (!java || exitCode != 95)) {
              throw new AssertionError(command + &quot; exit code is &quot; + exitCode);
          }
      }
  
<span class="line-added">+     // copied from jdk.test.lib.Platform::sharedLibraryPathVariableName</span>
<span class="line-added">+     private static String sharedLibraryPathVariableName() {</span>
<span class="line-added">+         String osName = System.getProperty(&quot;os.name&quot;).toLowerCase();</span>
<span class="line-added">+         if (osName.startsWith(&quot;win&quot;)) {</span>
<span class="line-added">+             return &quot;PATH&quot;;</span>
<span class="line-added">+         } else if (osName.startsWith(&quot;mac&quot;)) {</span>
<span class="line-added">+             return &quot;DYLD_LIBRARY_PATH&quot;;</span>
<span class="line-added">+         } else if (osName.startsWith(&quot;aix&quot;)) {</span>
<span class="line-added">+             return &quot;LIBPATH&quot;;</span>
<span class="line-added">+         } else {</span>
<span class="line-added">+             return &quot;LD_LIBRARY_PATH&quot;;</span>
<span class="line-added">+         }</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
<span class="line-added">+     // copied from jdk.test.lib.Utils::getTestJavaOpts()</span>
<span class="line-added">+     private static String[] getTestJavaOpts() {</span>
<span class="line-added">+         List&lt;String&gt; opts = new ArrayList&lt;String&gt;();</span>
<span class="line-added">+         {</span>
<span class="line-added">+             String v = System.getProperty(&quot;test.vm.opts&quot;, &quot;&quot;).trim();</span>
<span class="line-added">+             if (!v.isEmpty()) {</span>
<span class="line-added">+                 Collections.addAll(opts, v.split(&quot;\\s+&quot;));</span>
<span class="line-added">+             }</span>
<span class="line-added">+         }</span>
<span class="line-added">+         {</span>
<span class="line-added">+             String v = System.getProperty(&quot;test.java.opts&quot;, &quot;&quot;).trim();</span>
<span class="line-added">+             if (!v.isEmpty()) {</span>
<span class="line-added">+                 Collections.addAll(opts, v.split(&quot;\\s+&quot;));</span>
<span class="line-added">+             }</span>
<span class="line-added">+         }</span>
<span class="line-added">+         return opts.toArray(new String[0]);</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
<span class="line-added">+     // copied jdk.test.lib.Platform::variant</span>
      private static String variant() {
<span class="line-modified">!         String vmName = System.getProperty(&quot;java.vm.name&quot;);</span>
<span class="line-added">+         if (vmName.endsWith(&quot; Server VM&quot;)) {</span>
              return &quot;server&quot;;
<span class="line-modified">!         } else if (vmName.endsWith(&quot; Client VM&quot;)) {</span>
              return &quot;client&quot;;
<span class="line-modified">!         } else if (vmName.endsWith(&quot; Minimal VM&quot;)) {</span>
              return &quot;minimal&quot;;
          } else {
              throw new Error(&quot;TESTBUG: unsuppported vm variant&quot;);
          }
      }
  
      private static void copy(InputStream is, OutputStream os) {
          byte[] buffer = new byte[1024];
          int n;
          try (InputStream close = is) {
              while ((n = is.read(buffer)) != -1) {
</pre>
<hr />
<pre>
<span class="line-old-header">*** 163,11 ***</span>
              e.printStackTrace();
          }
      }
  
      private static String javaBin() {
<span class="line-modified">!         return Paths.get(Utils.TEST_JDK)</span>
                      .resolve(&quot;bin&quot;)
                      .resolve(&quot;java&quot;)
                      .toAbsolutePath()
                      .toString();
      }
<span class="line-new-header">--- 201,11 ---</span>
              e.printStackTrace();
          }
      }
  
      private static String javaBin() {
<span class="line-modified">!         return Paths.get(TEST_JDK)</span>
                      .resolve(&quot;bin&quot;)
                      .resolve(&quot;java&quot;)
                      .toAbsolutePath()
                      .toString();
      }
</pre>
<center><a href="../testlibrary_tests/whitebox/vm_flags/UintxTest.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="gc/g1/unloading/tests/unloading_anonclassloader_inMemoryCompilation_keep_class/TestDescription.java.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>