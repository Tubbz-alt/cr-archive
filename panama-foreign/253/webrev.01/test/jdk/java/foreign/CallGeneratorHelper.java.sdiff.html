<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff test/jdk/java/foreign/CallGeneratorHelper.java</title>
    <link rel="stylesheet" href="../../../../style.css" />
  </head>
<body>
<center><a href="../../../../src/jdk.incubator.foreign/share/classes/jdk/internal/foreign/abi/x64/windows/WinVaList.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="StdLibTest.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>test/jdk/java/foreign/CallGeneratorHelper.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
331 
332     static void cleanup(Object arg) {
333         if (arg instanceof MemoryAddress) {
334             cleanup(((MemoryAddress)arg).segment());
335         } else if (arg instanceof MemorySegment) {
336             ((MemorySegment) arg).close();
337         }
338     }
339 
340     @SuppressWarnings(&quot;unchecked&quot;)
341     static Object makeArg(MemoryLayout layout, List&lt;Consumer&lt;Object&gt;&gt; checks, boolean check) throws ReflectiveOperationException {
342         if (layout instanceof GroupLayout) {
343             MemorySegment segment = MemorySegment.allocateNative(layout);
344             initStruct(segment, (GroupLayout)layout, checks, check);
345             return segment;
346         } else if (isPointer(layout)) {
347             MemorySegment segment = MemorySegment.allocateNative(1);
348             if (check) {
349                 checks.add(o -&gt; {
350                     try {
<span class="line-modified">351                         assertEquals((MemoryAddress)o, segment.baseAddress());</span>
352                     } catch (Throwable ex) {
353                         throw new IllegalStateException(ex);
354                     }
355                 });
356             }
<span class="line-modified">357             return segment.baseAddress();</span>
358         } else if (layout instanceof ValueLayout) {
359             if (isIntegral(layout)) {
360                 if (check) {
361                     checks.add(o -&gt; assertEquals(o, 42));
362                 }
363                 return 42;
364             } else if (layout.bitSize() == 32) {
365                 if (check) {
366                     checks.add(o -&gt; assertEquals(o, 12f));
367                 }
368                 return 12f;
369             } else {
370                 if (check) {
371                     checks.add(o -&gt; assertEquals(o, 24d));
372                 }
373                 return 24d;
374             }
375         } else {
376             throw new IllegalStateException(&quot;Unexpected layout: &quot; + layout);
377         }
378     }
379 
380     static void initStruct(MemorySegment str, GroupLayout g, List&lt;Consumer&lt;Object&gt;&gt; checks, boolean check) throws ReflectiveOperationException {
381         for (MemoryLayout l : g.memberLayouts()) {
382             if (l.isPadding()) continue;
383             VarHandle accessor = g.varHandle(structFieldCarrier(l), MemoryLayout.PathElement.groupElement(l.name().get()));
384             List&lt;Consumer&lt;Object&gt;&gt; fieldsCheck = new ArrayList&lt;&gt;();
385             Object value = makeArg(l, fieldsCheck, check);
386             if (isPointer(l)) {
387                 value = ((MemoryAddress)value).toRawLongValue();
388             }
389             //set value
<span class="line-modified">390             accessor.set(str.baseAddress(), value);</span>
391             //add check
392             if (check) {
393                 assertTrue(fieldsCheck.size() == 1);
394                 checks.add(o -&gt; {
395                     MemorySegment actual = (MemorySegment)o;
396                     try {
397                         if (isPointer(l)) {
<span class="line-modified">398                             fieldsCheck.get(0).accept(MemoryAddress.ofLong((long)accessor.get(actual.baseAddress())));</span>
399                         } else {
<span class="line-modified">400                             fieldsCheck.get(0).accept(accessor.get(actual.baseAddress()));</span>
401                         }
402                     } catch (Throwable ex) {
403                         throw new IllegalStateException(ex);
404                     }
405                 });
406             }
407         }
408     }
409 
410     static Class&lt;?&gt; structFieldCarrier(MemoryLayout layout) {
411         if (isPointer(layout)) {
412             return long.class;
413         } else if (layout instanceof ValueLayout) {
414             if (isIntegral(layout)) {
415                 return int.class;
416             } else if (layout.bitSize() == 32) {
417                 return float.class;
418             } else {
419                 return double.class;
420             }
</pre>
</td>
<td>
<hr />
<pre>
331 
332     static void cleanup(Object arg) {
333         if (arg instanceof MemoryAddress) {
334             cleanup(((MemoryAddress)arg).segment());
335         } else if (arg instanceof MemorySegment) {
336             ((MemorySegment) arg).close();
337         }
338     }
339 
340     @SuppressWarnings(&quot;unchecked&quot;)
341     static Object makeArg(MemoryLayout layout, List&lt;Consumer&lt;Object&gt;&gt; checks, boolean check) throws ReflectiveOperationException {
342         if (layout instanceof GroupLayout) {
343             MemorySegment segment = MemorySegment.allocateNative(layout);
344             initStruct(segment, (GroupLayout)layout, checks, check);
345             return segment;
346         } else if (isPointer(layout)) {
347             MemorySegment segment = MemorySegment.allocateNative(1);
348             if (check) {
349                 checks.add(o -&gt; {
350                     try {
<span class="line-modified">351                         assertEquals((MemoryAddress)o, segment.address());</span>
352                     } catch (Throwable ex) {
353                         throw new IllegalStateException(ex);
354                     }
355                 });
356             }
<span class="line-modified">357             return segment.address();</span>
358         } else if (layout instanceof ValueLayout) {
359             if (isIntegral(layout)) {
360                 if (check) {
361                     checks.add(o -&gt; assertEquals(o, 42));
362                 }
363                 return 42;
364             } else if (layout.bitSize() == 32) {
365                 if (check) {
366                     checks.add(o -&gt; assertEquals(o, 12f));
367                 }
368                 return 12f;
369             } else {
370                 if (check) {
371                     checks.add(o -&gt; assertEquals(o, 24d));
372                 }
373                 return 24d;
374             }
375         } else {
376             throw new IllegalStateException(&quot;Unexpected layout: &quot; + layout);
377         }
378     }
379 
380     static void initStruct(MemorySegment str, GroupLayout g, List&lt;Consumer&lt;Object&gt;&gt; checks, boolean check) throws ReflectiveOperationException {
381         for (MemoryLayout l : g.memberLayouts()) {
382             if (l.isPadding()) continue;
383             VarHandle accessor = g.varHandle(structFieldCarrier(l), MemoryLayout.PathElement.groupElement(l.name().get()));
384             List&lt;Consumer&lt;Object&gt;&gt; fieldsCheck = new ArrayList&lt;&gt;();
385             Object value = makeArg(l, fieldsCheck, check);
386             if (isPointer(l)) {
387                 value = ((MemoryAddress)value).toRawLongValue();
388             }
389             //set value
<span class="line-modified">390             accessor.set(str.address(), value);</span>
391             //add check
392             if (check) {
393                 assertTrue(fieldsCheck.size() == 1);
394                 checks.add(o -&gt; {
395                     MemorySegment actual = (MemorySegment)o;
396                     try {
397                         if (isPointer(l)) {
<span class="line-modified">398                             fieldsCheck.get(0).accept(MemoryAddress.ofLong((long)accessor.get(actual.address())));</span>
399                         } else {
<span class="line-modified">400                             fieldsCheck.get(0).accept(accessor.get(actual.address()));</span>
401                         }
402                     } catch (Throwable ex) {
403                         throw new IllegalStateException(ex);
404                     }
405                 });
406             }
407         }
408     }
409 
410     static Class&lt;?&gt; structFieldCarrier(MemoryLayout layout) {
411         if (isPointer(layout)) {
412             return long.class;
413         } else if (layout instanceof ValueLayout) {
414             if (isIntegral(layout)) {
415                 return int.class;
416             } else if (layout.bitSize() == 32) {
417                 return float.class;
418             } else {
419                 return double.class;
420             }
</pre>
</td>
</tr>
</table>
<center><a href="../../../../src/jdk.incubator.foreign/share/classes/jdk/internal/foreign/abi/x64/windows/WinVaList.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="StdLibTest.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>