<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff test/jdk/java/foreign/CallGeneratorHelper.java</title>
    <link rel="stylesheet" href="../../../../style.css" />
  </head>
<body>
<center><a href="../../../../src/jdk.incubator.foreign/share/classes/jdk/internal/foreign/abi/x64/windows/WinVaList.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="StdLibTest.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>test/jdk/java/foreign/CallGeneratorHelper.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
312                 .mapToObj(i -&gt; &quot;p&quot; + i)
313                 .collect(Collectors.joining(&quot;,&quot;));
314         String sig = paramDecls.isEmpty() ?
315                 &quot;&quot; :
316                 paramDecls.stream().collect(Collectors.joining(&quot;, &quot;)) + &quot;, &quot;;
317         String body = String.format(ret == Ret.VOID ? &quot;{ cb(%s); }&quot; : &quot;{ return cb(%s); }&quot;, paramNames);
318         List&lt;String&gt; paramTypes = params.stream().map(p -&gt; p.type(fields)).collect(Collectors.toList());
319         String cbSig = paramTypes.isEmpty() ?
320                 &quot;void&quot; :
321                 paramTypes.stream().collect(Collectors.joining(&quot;, &quot;));
322         String cbParam = String.format(&quot;%s (*cb)(%s)&quot;,
323                 retType, cbSig);
324 
325         String res = String.format(&quot;EXPORT %s %s(%s %s) %s&quot;, retType, fName,
326                 sig, cbParam, declOnly ? &quot;;&quot; : body);
327         System.out.println(res);
328     }
329 
330     //helper methods
331 
<span class="line-removed">332     static void cleanup(Object arg) {</span>
<span class="line-removed">333         if (arg instanceof MemoryAddress) {</span>
<span class="line-removed">334             cleanup(((MemoryAddress)arg).segment());</span>
<span class="line-removed">335         } else if (arg instanceof MemorySegment) {</span>
<span class="line-removed">336             ((MemorySegment) arg).close();</span>
<span class="line-removed">337         }</span>
<span class="line-removed">338     }</span>
<span class="line-removed">339 </span>
340     @SuppressWarnings(&quot;unchecked&quot;)
<span class="line-modified">341     static Object makeArg(MemoryLayout layout, List&lt;Consumer&lt;Object&gt;&gt; checks, boolean check) throws ReflectiveOperationException {</span>
342         if (layout instanceof GroupLayout) {
343             MemorySegment segment = MemorySegment.allocateNative(layout);
<span class="line-modified">344             initStruct(segment, (GroupLayout)layout, checks, check);</span>

345             return segment;
346         } else if (isPointer(layout)) {
347             MemorySegment segment = MemorySegment.allocateNative(1);

348             if (check) {
349                 checks.add(o -&gt; {
350                     try {
351                         assertEquals((MemoryAddress)o, segment.address());
352                     } catch (Throwable ex) {
353                         throw new IllegalStateException(ex);
354                     }
355                 });
356             }
357             return segment.address();
358         } else if (layout instanceof ValueLayout) {
359             if (isIntegral(layout)) {
360                 if (check) {
361                     checks.add(o -&gt; assertEquals(o, 42));
362                 }
363                 return 42;
364             } else if (layout.bitSize() == 32) {
365                 if (check) {
366                     checks.add(o -&gt; assertEquals(o, 12f));
367                 }
368                 return 12f;
369             } else {
370                 if (check) {
371                     checks.add(o -&gt; assertEquals(o, 24d));
372                 }
373                 return 24d;
374             }
375         } else {
376             throw new IllegalStateException(&quot;Unexpected layout: &quot; + layout);
377         }
378     }
379 
<span class="line-modified">380     static void initStruct(MemorySegment str, GroupLayout g, List&lt;Consumer&lt;Object&gt;&gt; checks, boolean check) throws ReflectiveOperationException {</span>
381         for (MemoryLayout l : g.memberLayouts()) {
382             if (l.isPadding()) continue;
383             VarHandle accessor = g.varHandle(structFieldCarrier(l), MemoryLayout.PathElement.groupElement(l.name().get()));
384             List&lt;Consumer&lt;Object&gt;&gt; fieldsCheck = new ArrayList&lt;&gt;();
<span class="line-modified">385             Object value = makeArg(l, fieldsCheck, check);</span>
386             if (isPointer(l)) {
387                 value = ((MemoryAddress)value).toRawLongValue();
388             }
389             //set value
<span class="line-modified">390             accessor.set(str.address(), value);</span>
391             //add check
392             if (check) {
393                 assertTrue(fieldsCheck.size() == 1);
394                 checks.add(o -&gt; {
395                     MemorySegment actual = (MemorySegment)o;
396                     try {
397                         if (isPointer(l)) {
<span class="line-modified">398                             fieldsCheck.get(0).accept(MemoryAddress.ofLong((long)accessor.get(actual.address())));</span>
399                         } else {
<span class="line-modified">400                             fieldsCheck.get(0).accept(accessor.get(actual.address()));</span>
401                         }
402                     } catch (Throwable ex) {
403                         throw new IllegalStateException(ex);
404                     }
405                 });
406             }
407         }
408     }
409 
410     static Class&lt;?&gt; structFieldCarrier(MemoryLayout layout) {
411         if (isPointer(layout)) {
412             return long.class;
413         } else if (layout instanceof ValueLayout) {
414             if (isIntegral(layout)) {
415                 return int.class;
416             } else if (layout.bitSize() == 32) {
417                 return float.class;
418             } else {
419                 return double.class;
420             }
</pre>
</td>
<td>
<hr />
<pre>
312                 .mapToObj(i -&gt; &quot;p&quot; + i)
313                 .collect(Collectors.joining(&quot;,&quot;));
314         String sig = paramDecls.isEmpty() ?
315                 &quot;&quot; :
316                 paramDecls.stream().collect(Collectors.joining(&quot;, &quot;)) + &quot;, &quot;;
317         String body = String.format(ret == Ret.VOID ? &quot;{ cb(%s); }&quot; : &quot;{ return cb(%s); }&quot;, paramNames);
318         List&lt;String&gt; paramTypes = params.stream().map(p -&gt; p.type(fields)).collect(Collectors.toList());
319         String cbSig = paramTypes.isEmpty() ?
320                 &quot;void&quot; :
321                 paramTypes.stream().collect(Collectors.joining(&quot;, &quot;));
322         String cbParam = String.format(&quot;%s (*cb)(%s)&quot;,
323                 retType, cbSig);
324 
325         String res = String.format(&quot;EXPORT %s %s(%s %s) %s&quot;, retType, fName,
326                 sig, cbParam, declOnly ? &quot;;&quot; : body);
327         System.out.println(res);
328     }
329 
330     //helper methods
331 








332     @SuppressWarnings(&quot;unchecked&quot;)
<span class="line-modified">333     static Object makeArg(MemoryLayout layout, List&lt;Consumer&lt;Object&gt;&gt; checks, boolean check, List&lt;MemorySegment&gt; segments) throws ReflectiveOperationException {</span>
334         if (layout instanceof GroupLayout) {
335             MemorySegment segment = MemorySegment.allocateNative(layout);
<span class="line-modified">336             initStruct(segment, (GroupLayout)layout, checks, check, segments);</span>
<span class="line-added">337             segments.add(segment);</span>
338             return segment;
339         } else if (isPointer(layout)) {
340             MemorySegment segment = MemorySegment.allocateNative(1);
<span class="line-added">341             segments.add(segment);</span>
342             if (check) {
343                 checks.add(o -&gt; {
344                     try {
345                         assertEquals((MemoryAddress)o, segment.address());
346                     } catch (Throwable ex) {
347                         throw new IllegalStateException(ex);
348                     }
349                 });
350             }
351             return segment.address();
352         } else if (layout instanceof ValueLayout) {
353             if (isIntegral(layout)) {
354                 if (check) {
355                     checks.add(o -&gt; assertEquals(o, 42));
356                 }
357                 return 42;
358             } else if (layout.bitSize() == 32) {
359                 if (check) {
360                     checks.add(o -&gt; assertEquals(o, 12f));
361                 }
362                 return 12f;
363             } else {
364                 if (check) {
365                     checks.add(o -&gt; assertEquals(o, 24d));
366                 }
367                 return 24d;
368             }
369         } else {
370             throw new IllegalStateException(&quot;Unexpected layout: &quot; + layout);
371         }
372     }
373 
<span class="line-modified">374     static void initStruct(MemorySegment str, GroupLayout g, List&lt;Consumer&lt;Object&gt;&gt; checks, boolean check, List&lt;MemorySegment&gt; segments) throws ReflectiveOperationException {</span>
375         for (MemoryLayout l : g.memberLayouts()) {
376             if (l.isPadding()) continue;
377             VarHandle accessor = g.varHandle(structFieldCarrier(l), MemoryLayout.PathElement.groupElement(l.name().get()));
378             List&lt;Consumer&lt;Object&gt;&gt; fieldsCheck = new ArrayList&lt;&gt;();
<span class="line-modified">379             Object value = makeArg(l, fieldsCheck, check, segments);</span>
380             if (isPointer(l)) {
381                 value = ((MemoryAddress)value).toRawLongValue();
382             }
383             //set value
<span class="line-modified">384             accessor.set(str, value);</span>
385             //add check
386             if (check) {
387                 assertTrue(fieldsCheck.size() == 1);
388                 checks.add(o -&gt; {
389                     MemorySegment actual = (MemorySegment)o;
390                     try {
391                         if (isPointer(l)) {
<span class="line-modified">392                             fieldsCheck.get(0).accept(MemoryAddress.ofLong((long)accessor.get(actual)));</span>
393                         } else {
<span class="line-modified">394                             fieldsCheck.get(0).accept(accessor.get(actual));</span>
395                         }
396                     } catch (Throwable ex) {
397                         throw new IllegalStateException(ex);
398                     }
399                 });
400             }
401         }
402     }
403 
404     static Class&lt;?&gt; structFieldCarrier(MemoryLayout layout) {
405         if (isPointer(layout)) {
406             return long.class;
407         } else if (layout instanceof ValueLayout) {
408             if (isIntegral(layout)) {
409                 return int.class;
410             } else if (layout.bitSize() == 32) {
411                 return float.class;
412             } else {
413                 return double.class;
414             }
</pre>
</td>
</tr>
</table>
<center><a href="../../../../src/jdk.incubator.foreign/share/classes/jdk/internal/foreign/abi/x64/windows/WinVaList.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="StdLibTest.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>