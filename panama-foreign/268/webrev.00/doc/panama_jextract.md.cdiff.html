<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff doc/panama_jextract.md</title>
    <link rel="stylesheet" href="../style.css" />
  </head>
<body>
<center><a href="panama_jextract.html.cdiff.html" target="_top">&lt; prev</a> <a href="../index.html" target="_top">index</a> next &gt;</center>    <h2>doc/panama_jextract.md</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 97,11 ***</span>
  
  ### Java program that uses extracted Python interface
  
  ```java
  
<span class="line-removed">- </span>
  import static jdk.incubator.foreign.CSupport.*;
  import static jdk.incubator.foreign.MemoryAddress.NULL;
  // import jextracted python &#39;header&#39; class
  import static org.python.RuntimeHelper.*;
  import static org.python.Python_h.*;
<span class="line-new-header">--- 97,10 ---</span>
</pre>
<hr />
<pre>
<span class="line-old-header">*** 109,12 ***</span>
  public class PythonMain {
      public static void main(String[] args) {
          String script = &quot;print(sum([33, 55, 66])); print(&#39;Hello from Python!&#39;)\n&quot;;
  
          Py_Initialize();
<span class="line-modified">!         try (var s = toCString(script)) {</span>
<span class="line-removed">-             var str = s.baseAddress();</span>
              PyRun_SimpleStringFlags(str, NULL);
              Py_Finalize();
          }
      }
  }
<span class="line-new-header">--- 108,11 ---</span>
  public class PythonMain {
      public static void main(String[] args) {
          String script = &quot;print(sum([33, 55, 66])); print(&#39;Hello from Python!&#39;)\n&quot;;
  
          Py_Initialize();
<span class="line-modified">!         try (var str = toCString(script)) {</span>
              PyRun_SimpleStringFlags(str, NULL);
              Py_Finalize();
          }
      }
  }
</pre>
<hr />
<pre>
<span class="line-old-header">*** 152,14 ***</span>
  import static org.unix.readline_h.*;
  import static jdk.incubator.foreign.CSupport.*;
  
  public class Readline {
      public static void main(String[] args) {
<span class="line-modified">!         try (var s = toCString(&quot;name? &quot;)) {</span>
<span class="line-removed">-             var pstr = s.baseAddress();</span>
              // call &quot;readline&quot; API
<span class="line-modified">!             var p = readline(pstr);</span>
  
              // print char* as is
              System.out.println(p);
              // convert char* ptr from readline as Java String &amp; print it
              System.out.println(&quot;Hello, &quot; + toJavaStringRestricted(p));
<span class="line-new-header">--- 150,13 ---</span>
  import static org.unix.readline_h.*;
  import static jdk.incubator.foreign.CSupport.*;
  
  public class Readline {
      public static void main(String[] args) {
<span class="line-modified">!         try (var str = toCString(&quot;name? &quot;)) {</span>
              // call &quot;readline&quot; API
<span class="line-modified">!             var p = readline(str);</span>
  
              // print char* as is
              System.out.println(p);
              // convert char* ptr from readline as Java String &amp; print it
              System.out.println(&quot;Hello, &quot; + toJavaStringRestricted(p));
</pre>
<hr />
<pre>
<span class="line-old-header">*** 192,27 ***</span>
  
  ### Java code that uses libcurl
  
  ```java
  
<span class="line-removed">- </span>
  import static jdk.incubator.foreign.MemoryAddress.NULL;
<span class="line-modified">! import static org.unix.RuntimeHelper.*;</span>
<span class="line-modified">! import static org.unix.curl_h.*;</span>
  import static jdk.incubator.foreign.CSupport.*;
  
  public class CurlMain {
     public static void main(String[] args) {
         var urlStr = args[0];
         curl_global_init(CURL_GLOBAL_DEFAULT());
         var curl = curl_easy_init();
         if(!curl.equals(NULL)) {
<span class="line-modified">!            try (var s = toCString(urlStr)) {</span>
<span class="line-modified">!                var url = s.baseAddress();</span>
<span class="line-removed">-                curl_easy_setopt(curl, CURLOPT_URL(), url);</span>
                 int res = curl_easy_perform(curl);
                 if (res != CURLE_OK()) {
                     curl_easy_cleanup(curl);
                 }
             }
         }
         curl_global_cleanup();
<span class="line-new-header">--- 189,27 ---</span>
  
  ### Java code that uses libcurl
  
  ```java
  
  import static jdk.incubator.foreign.MemoryAddress.NULL;
<span class="line-modified">! import static org.jextract.RuntimeHelper.*;</span>
<span class="line-modified">! import static org.jextract.curl_h.*;</span>
  import static jdk.incubator.foreign.CSupport.*;
  
  public class CurlMain {
     public static void main(String[] args) {
         var urlStr = args[0];
         curl_global_init(CURL_GLOBAL_DEFAULT());
         var curl = curl_easy_init();
         if(!curl.equals(NULL)) {
<span class="line-modified">!            try (var url = toCString(urlStr)) {</span>
<span class="line-modified">!                curl_easy_setopt(curl, CURLOPT_URL(), url.address());</span>
                 int res = curl_easy_perform(curl);
                 if (res != CURLE_OK()) {
<span class="line-added">+                    String error = toJavaStringRestricted(curl_easy_strerror(res));</span>
<span class="line-added">+                    System.out.println(&quot;Curl error: &quot; + error);</span>
                     curl_easy_cleanup(curl);
                 }
             }
         }
         curl_global_cleanup();
</pre>
<hr />
<pre>
<span class="line-old-header">*** 347,10 ***</span>
<span class="line-new-header">--- 344,11 ---</span>
  
  ```java
  
  import jdk.incubator.foreign.MemoryAccess;
  import jdk.incubator.foreign.MemoryAddress;
<span class="line-added">+ import jdk.incubator.foreign.MemorySegment;</span>
  import jdk.incubator.foreign.NativeScope;
  import lapack.*;
  import static lapack.lapacke_h.*;
  import static jdk.incubator.foreign.CSupport.*;
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 377,24 ***</span>
              /* Print Entry Matrix */
              print_matrix_colmajor(&quot;Entry Matrix A&quot;, m, n, A, lda );
              /* Print Right Rand Side */
              print_matrix_colmajor(&quot;Right Hand Side b&quot;, n, nrhs, b, ldb );
              System.out.println();
<span class="line-modified">! </span>
              /* Executable statements */
              //            printf( &quot;LAPACKE_dgels (col-major, high-level) Example Program Results\n&quot; );
              /* Solve least squares problem*/
              info = LAPACKE_dgels(LAPACK_COL_MAJOR(), (byte)&#39;N&#39;, m, n, nrhs, A, lda, b, ldb);
<span class="line-modified">! </span>
              /* Print Solution */
              print_matrix_colmajor(&quot;Solution&quot;, n, nrhs, b, ldb );
              System.out.println();
              System.exit(info);
<span class="line-modified">!         }</span>
<span class="line-modified">!     }</span>
<span class="line-modified">! </span>
<span class="line-modified">!     static void print_matrix_colmajor(String msg, int m, int n, MemoryAddress mat, int ldm) {</span>
          int i, j;
          System.out.printf(&quot;\n %s\n&quot;, msg);
  
          for( i = 0; i &lt; m; i++ ) {
              for( j = 0; j &lt; n; j++ ) System.out.printf(&quot; %6.2f&quot;, MemoryAccess.getDoubleAtIndex(mat, i+j*ldm));
<span class="line-new-header">--- 375,24 ---</span>
              /* Print Entry Matrix */
              print_matrix_colmajor(&quot;Entry Matrix A&quot;, m, n, A, lda );
              /* Print Right Rand Side */
              print_matrix_colmajor(&quot;Right Hand Side b&quot;, n, nrhs, b, ldb );
              System.out.println();
<span class="line-modified">!             </span>
              /* Executable statements */
              //            printf( &quot;LAPACKE_dgels (col-major, high-level) Example Program Results\n&quot; );
              /* Solve least squares problem*/
              info = LAPACKE_dgels(LAPACK_COL_MAJOR(), (byte)&#39;N&#39;, m, n, nrhs, A, lda, b, ldb);
<span class="line-modified">!  </span>
              /* Print Solution */
              print_matrix_colmajor(&quot;Solution&quot;, n, nrhs, b, ldb );
              System.out.println();
              System.exit(info);
<span class="line-modified">!         }   </span>
<span class="line-modified">!     }   </span>
<span class="line-modified">!     </span>
<span class="line-modified">!     static void print_matrix_colmajor(String msg, int m, int n, MemorySegment mat, int ldm) {</span>
          int i, j;
          System.out.printf(&quot;\n %s\n&quot;, msg);
  
          for( i = 0; i &lt; m; i++ ) {
              for( j = 0; j &lt; n; j++ ) System.out.printf(&quot; %6.2f&quot;, MemoryAccess.getDoubleAtIndex(mat, i+j*ldm));
</pre>
<hr />
<pre>
<span class="line-old-header">*** 450,11 ***</span>
              // allocate an array
              var pids = scope.allocateArray(CSupport.C_INT, numPids);
              // list all the pids into the native array
              proc_listallpids(pids, numPids);
              // convert native array to java array
<span class="line-modified">!             int[] jpids = pids.segment().toIntArray();</span>
              // buffer for process name
              var nameBuf = scope.allocateArray(CSupport.C_CHAR, NAME_BUF_MAX);
              for (int i = 0; i &lt; jpids.length; i++) {
                  int pid = jpids[i];
                  // get the process name
<span class="line-new-header">--- 448,11 ---</span>
              // allocate an array
              var pids = scope.allocateArray(CSupport.C_INT, numPids);
              // list all the pids into the native array
              proc_listallpids(pids, numPids);
              // convert native array to java array
<span class="line-modified">!             int[] jpids = pids.toIntArray();</span>
              // buffer for process name
              var nameBuf = scope.allocateArray(CSupport.C_CHAR, NAME_BUF_MAX);
              for (int i = 0; i &lt; jpids.length; i++) {
                  int pid = jpids[i];
                  // get the process name
</pre>
<hr />
<pre>
<span class="line-old-header">*** 631,15 ***</span>
              int[] rowNum = new int[1];
              // callback to print rows from SELECT query
              var callback = sqlite3_exec$callback.allocate((a, argc, argv, columnNames) -&gt; {
                  System.out.println(&quot;Row num: &quot; + rowNum[0]++);
                  System.out.println(&quot;numColumns = &quot; + argc);
<span class="line-modified">!                 argv = asArrayRestricted(argv, C_POINTER, argc);</span>
<span class="line-modified">!                 columnNames = asArrayRestricted(columnNames, C_POINTER, argc);</span>
                  for (int i = 0; i &lt; argc; i++) {
<span class="line-modified">!                      String name = toJavaStringRestricted(MemoryAccess.getAddressAtIndex(columnNames, i));</span>
<span class="line-modified">!                      String value = toJavaStringRestricted(MemoryAccess.getAddressAtIndex(argv, i));</span>
                       System.out.printf(&quot;%s = %s\n&quot;, name, value);
                  }
                  return 0;
              }, scope);
  
<span class="line-new-header">--- 629,15 ---</span>
              int[] rowNum = new int[1];
              // callback to print rows from SELECT query
              var callback = sqlite3_exec$callback.allocate((a, argc, argv, columnNames) -&gt; {
                  System.out.println(&quot;Row num: &quot; + rowNum[0]++);
                  System.out.println(&quot;numColumns = &quot; + argc);
<span class="line-modified">!                 var argv_seg = asArrayRestricted(argv, C_POINTER, argc);</span>
<span class="line-modified">!                 var columnNames_seg = asArrayRestricted(columnNames, C_POINTER, argc);</span>
                  for (int i = 0; i &lt; argc; i++) {
<span class="line-modified">!                      String name = toJavaStringRestricted(MemoryAccess.getAddressAtIndex(columnNames_seg, i));</span>
<span class="line-modified">!                      String value = toJavaStringRestricted(MemoryAccess.getAddressAtIndex(argv_seg, i));</span>
                       System.out.printf(&quot;%s = %s\n&quot;, name, value);
                  }
                  return 0;
              }, scope);
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 669,5 ***</span>
<span class="line-new-header">--- 667,90 ---</span>
  java -Dforeign.restricted=permit \
     --add-modules jdk.incubator.foreign \
     -Djava.library.path=/usr/lib SqliteMain.java
  
  ```
<span class="line-added">+ </span>
<span class="line-added">+ ## Using OpenGL library from Java (Mac OS)</span>
<span class="line-added">+ </span>
<span class="line-added">+ ### jextract glut.h</span>
<span class="line-added">+ </span>
<span class="line-added">+ ```sh</span>
<span class="line-added">+ </span>
<span class="line-added">+ jextract -t opengl -lGL -l/System/Library/Frameworks/GLUT.framework/Versions/Current/GLUT \</span>
<span class="line-added">+   -I /Applications/Xcode.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/MacOSX.sdk/usr/include/ \</span>
<span class="line-added">+   -C-F/Applications/Xcode.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/MacOSX.sdk/System/Library/Frameworks \</span>
<span class="line-added">+   /Applications/Xcode.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/MacOSX.sdk/System/Library/Frameworks/GLUT.framework/Headers/glut.h</span>
<span class="line-added">+ </span>
<span class="line-added">+ ```</span>
<span class="line-added">+ ### Java program that uses OpenGL</span>
<span class="line-added">+ </span>
<span class="line-added">+ ```java</span>
<span class="line-added">+ </span>
<span class="line-added">+ import jdk.incubator.foreign.CSupport;</span>
<span class="line-added">+ import static jdk.incubator.foreign.CSupport.*;</span>
<span class="line-added">+ import jdk.incubator.foreign.NativeScope;</span>
<span class="line-added">+ import static opengl.glut_h.*;</span>
<span class="line-added">+ </span>
<span class="line-added">+ public class Teapot {</span>
<span class="line-added">+     private float rot = 0;</span>
<span class="line-added">+ </span>
<span class="line-added">+     Teapot(NativeScope scope) {</span>
<span class="line-added">+         // Reset Background</span>
<span class="line-added">+         glClearColor(0f, 0f, 0f, 0f);</span>
<span class="line-added">+         // Setup Lighting</span>
<span class="line-added">+         glShadeModel(GL_SMOOTH());</span>
<span class="line-added">+         var pos = scope.allocateArray(C_FLOAT, new float[] {0.0f, 15.0f, -15.0f, 0});</span>
<span class="line-added">+         glLightfv(GL_LIGHT0(), GL_POSITION(), pos);</span>
<span class="line-added">+         var spec = scope.allocateArray(C_FLOAT, new float[] {1, 1, 1, 0});</span>
<span class="line-added">+         glLightfv(GL_LIGHT0(), GL_AMBIENT(), spec);</span>
<span class="line-added">+         glLightfv(GL_LIGHT0(), GL_DIFFUSE(), spec);</span>
<span class="line-added">+         glLightfv(GL_LIGHT0(), GL_SPECULAR(), spec);</span>
<span class="line-added">+         var shini = scope.allocate(C_FLOAT, 113);</span>
<span class="line-added">+         glMaterialfv(GL_FRONT(), GL_SHININESS(), shini);</span>
<span class="line-added">+         glEnable(GL_LIGHTING());</span>
<span class="line-added">+         glEnable(GL_LIGHT0());</span>
<span class="line-added">+         glEnable(GL_DEPTH_TEST());</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
<span class="line-added">+     void display() {</span>
<span class="line-added">+         glClear(GL_COLOR_BUFFER_BIT() | GL_DEPTH_BUFFER_BIT());</span>
<span class="line-added">+         glPushMatrix();</span>
<span class="line-added">+         glRotatef(-20f, 1f, 1f, 0f);</span>
<span class="line-added">+         glRotatef(rot, 0f, 1f, 0f);</span>
<span class="line-added">+         glutSolidTeapot(0.5d);</span>
<span class="line-added">+         glPopMatrix();</span>
<span class="line-added">+         glutSwapBuffers();</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
<span class="line-added">+     void onIdle() {</span>
<span class="line-added">+         rot += 0.1;</span>
<span class="line-added">+         glutPostRedisplay();</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
<span class="line-added">+     public static void main(String[] args) {</span>
<span class="line-added">+         try (var scope = NativeScope.unboundedScope()) {</span>
<span class="line-added">+             var argc = scope.allocate(C_INT, 0);</span>
<span class="line-added">+             glutInit(argc, argc);</span>
<span class="line-added">+             glutInitDisplayMode(GLUT_DOUBLE() | GLUT_RGB() | GLUT_DEPTH());</span>
<span class="line-added">+             glutInitWindowSize(500, 500);</span>
<span class="line-added">+             glutCreateWindow(CSupport.toCString(&quot;Hello Panama!&quot;, scope));</span>
<span class="line-added">+             var teapot = new Teapot(scope);</span>
<span class="line-added">+             var displayStub = glutDisplayFunc$func.allocate(teapot::display, scope);</span>
<span class="line-added">+             var idleStub = glutIdleFunc$func.allocate(teapot::onIdle, scope);</span>
<span class="line-added">+             glutDisplayFunc(displayStub);</span>
<span class="line-added">+             glutIdleFunc(idleStub);</span>
<span class="line-added">+             glutMainLoop();</span>
<span class="line-added">+         }</span>
<span class="line-added">+     }</span>
<span class="line-added">+ }</span>
<span class="line-added">+ </span>
<span class="line-added">+ ```</span>
<span class="line-added">+ </span>
<span class="line-added">+ ### Compiling and running the OpenGL sample</span>
<span class="line-added">+ </span>
<span class="line-added">+ ```sh</span>
<span class="line-added">+ </span>
<span class="line-added">+ java -XstartOnFirstThread -Dforeign.restricted=permit --add-modules jdk.incubator.foreign \</span>
<span class="line-added">+     -Djava.library.path=.:/System/Library/Frameworks/OpenGL.framework/Versions/Current/Libraries/ Teapot.java $*</span>
<span class="line-added">+ </span>
<span class="line-added">+ ```</span>
</pre>
<center><a href="panama_jextract.html.cdiff.html" target="_top">&lt; prev</a> <a href="../index.html" target="_top">index</a> next &gt;</center>  </body>
</html>