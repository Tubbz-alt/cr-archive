<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/java.base/share/classes/jdk/internal/icu/util/CodePointTrie.java</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="CodePointMap.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="VersionInfo.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/java.base/share/classes/jdk/internal/icu/util/CodePointTrie.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  31 
  32 import jdk.internal.icu.impl.ICUBinary;
  33 
  34 import java.io.DataOutputStream;
  35 import java.io.IOException;
  36 import java.io.UncheckedIOException;
  37 import java.io.OutputStream;
  38 import java.nio.ByteBuffer;
  39 import java.nio.ByteOrder;
  40 
  41 import static jdk.internal.icu.impl.NormalizerImpl.UTF16Plus;
  42 
  43 /**
  44  * Immutable Unicode code point trie.
  45  * Fast, reasonably compact, map from Unicode code points (U+0000..U+10FFFF) to integer values.
  46  * For details see http://site.icu-project.org/design/struct/utrie
  47  *
  48  * &lt;p&gt;This class is not intended for public subclassing.
  49  *
  50  * @see MutableCodePointTrie
<span class="line-modified">  51  * @draft ICU 63</span>
<span class="line-removed">  52  * @provisional This API might change or be removed in a future release.</span>
  53  */
  54 @SuppressWarnings(&quot;deprecation&quot;)
  55 public abstract class CodePointTrie extends CodePointMap {
  56     /**
  57      * Selectors for the type of a CodePointTrie.
  58      * Different trade-offs for size vs. speed.
  59      *
  60      * &lt;p&gt;Use null for {@link #fromBinary} to accept any type;
  61      * {@link #getType} will return the actual type.
  62      *
  63      * @see MutableCodePointTrie#buildImmutable(CodePointTrie.Type, CodePointTrie.ValueWidth)
  64      * @see #fromBinary
  65      * @see #getType
<span class="line-modified">  66      * @draft ICU 63</span>
<span class="line-removed">  67      * @provisional This API might change or be removed in a future release.</span>
  68      */
  69     public enum Type {
  70         /**
  71          * Fast/simple/larger BMP data structure.
  72          * The {@link Fast} subclasses have additional functions for lookup for BMP and supplementary code points.
  73          *
  74          * @see Fast
<span class="line-modified">  75          * @draft ICU 63</span>
<span class="line-removed">  76          * @provisional This API might change or be removed in a future release.</span>
  77          */
  78         FAST,
  79         /**
  80          * Small/slower BMP data structure.
  81          *
  82          * @see Small
<span class="line-modified">  83          * @draft ICU 63</span>
<span class="line-removed">  84          * @provisional This API might change or be removed in a future release.</span>
  85          */
  86         SMALL
  87     }
  88 
  89     /**
  90      * Selectors for the number of bits in a CodePointTrie data value.
  91      *
  92      * &lt;p&gt;Use null for {@link #fromBinary} to accept any data value width;
  93      * {@link #getValueWidth} will return the actual data value width.
  94      *
<span class="line-modified">  95      * @draft ICU 63</span>
<span class="line-removed">  96      * @provisional This API might change or be removed in a future release.</span>
  97      */
  98     public enum ValueWidth {
  99         /**
 100          * The trie stores 16 bits per data value.
 101          * It returns them as unsigned values 0..0xffff=65535.
 102          *
<span class="line-modified"> 103          * @draft ICU 63</span>
<span class="line-removed"> 104          * @provisional This API might change or be removed in a future release.</span>
 105          */
 106         BITS_16,
 107         /**
 108          * The trie stores 32 bits per data value.
 109          *
<span class="line-modified"> 110          * @draft ICU 63</span>
<span class="line-removed"> 111          * @provisional This API might change or be removed in a future release.</span>
 112          */
 113         BITS_32,
 114         /**
 115          * The trie stores 8 bits per data value.
 116          * It returns them as unsigned values 0..0xff=255.
 117          *
<span class="line-modified"> 118          * @draft ICU 63</span>
<span class="line-removed"> 119          * @provisional This API might change or be removed in a future release.</span>
 120          */
 121         BITS_8
 122     }
 123 
 124     private CodePointTrie(char[] index, Data data, int highStart,
 125             int index3NullOffset, int dataNullOffset) {
 126         this.ascii = new int[ASCII_LIMIT];
 127         this.index = index;
 128         this.data = data;
 129         this.dataLength = data.getDataLength();
 130         this.highStart = highStart;
 131         this.index3NullOffset = index3NullOffset;
 132         this.dataNullOffset = dataNullOffset;
 133 
 134         for (int c = 0; c &lt; ASCII_LIMIT; ++c) {
 135             ascii[c] = data.getFromIndex(c);
 136         }
 137 
 138         int nullValueOffset = dataNullOffset;
 139         if (nullValueOffset &gt;= dataLength) {
</pre>
<hr />
<pre>
 145     /**
 146      * Creates a trie from its binary form,
 147      * stored in the ByteBuffer starting at the current position.
 148      * Advances the buffer position to just after the trie data.
 149      * Inverse of {@link #toBinary(OutputStream)}.
 150      *
 151      * &lt;p&gt;The data is copied from the buffer;
 152      * later modification of the buffer will not affect the trie.
 153      *
 154      * @param type selects the trie type; this method throws an exception
 155      *             if the type does not match the binary data;
 156      *             use null to accept any type
 157      * @param valueWidth selects the number of bits in a data value; this method throws an exception
 158      *                  if the valueWidth does not match the binary data;
 159      *                  use null to accept any data value width
 160      * @param bytes a buffer containing the binary data of a CodePointTrie
 161      * @return the trie
 162      * @see MutableCodePointTrie#MutableCodePointTrie(int, int)
 163      * @see MutableCodePointTrie#buildImmutable(CodePointTrie.Type, CodePointTrie.ValueWidth)
 164      * @see #toBinary(OutputStream)
<span class="line-modified"> 165      * @draft ICU 63</span>
<span class="line-removed"> 166      * @provisional This API might change or be removed in a future release.</span>
 167      */
 168     public static CodePointTrie fromBinary(Type type, ValueWidth valueWidth, ByteBuffer bytes) {
 169         ByteOrder outerByteOrder = bytes.order();
 170         try {
 171             // Enough data for a trie header?
 172             if (bytes.remaining() &lt; 16 /* sizeof(UCPTrieHeader) */) {
 173                 throw new InternalError(&quot;Buffer too short for a CodePointTrie header&quot;);
 174             }
 175 
 176             // struct UCPTrieHeader
 177             /** &quot;Tri3&quot; in big-endian US-ASCII (0x54726933) */
 178             int signature = bytes.getInt();
 179 
 180             // Check the signature.
 181             switch (signature) {
 182             case 0x54726933:
 183                 // The buffer is already set to the trie data byte order.
 184                 break;
 185             case 0x33697254:
 186                 // Temporarily reverse the byte order.
</pre>
<hr />
<pre>
 289                             new Small32(index, data32, highStart, index3NullOffset, dataNullOffset);
 290             }
 291             case BITS_8: {
 292                 byte[] data8 = ICUBinary.getBytes(bytes, dataLength, 0);
 293                 return type == Type.FAST ?
 294                         new Fast8(index, data8, highStart, index3NullOffset, dataNullOffset) :
 295                             new Small8(index, data8, highStart, index3NullOffset, dataNullOffset);
 296             }
 297             default:
 298                 throw new AssertionError(&quot;should be unreachable&quot;);
 299             }
 300         } finally {
 301             bytes.order(outerByteOrder);
 302         }
 303     }
 304 
 305     /**
 306      * Returns the trie type.
 307      *
 308      * @return the trie type
<span class="line-modified"> 309      * @draft ICU 63</span>
<span class="line-removed"> 310      * @provisional This API might change or be removed in a future release.</span>
 311      */
 312     public abstract Type getType();
 313     /**
 314      * Returns the number of bits in a trie data value.
 315      *
 316      * @return the number of bits in a trie data value
<span class="line-modified"> 317      * @draft ICU 63</span>
<span class="line-removed"> 318      * @provisional This API might change or be removed in a future release.</span>
 319      */
 320     public final ValueWidth getValueWidth() { return data.getValueWidth(); }
 321 
 322     /**
 323      * {@inheritDoc}
<span class="line-modified"> 324      * @draft ICU 63</span>
<span class="line-removed"> 325      * @provisional This API might change or be removed in a future release.</span>
 326      */
 327     @Override
 328     public int get(int c) {
 329         return data.getFromIndex(cpIndex(c));
 330     }
 331 
 332     /**
 333      * Returns a trie value for an ASCII code point, without range checking.
 334      *
 335      * @param c the input code point; must be U+0000..U+007F
 336      * @return The ASCII code point&#39;s trie value.
<span class="line-modified"> 337      * @draft ICU 63</span>
<span class="line-removed"> 338      * @provisional This API might change or be removed in a future release.</span>
 339      */
 340     public final int asciiGet(int c) {
 341         return ascii[c];
 342     }
 343 
 344     private static final int MAX_UNICODE = 0x10ffff;
 345 
 346     private static final int ASCII_LIMIT = 0x80;
 347 
 348     private static final int maybeFilterValue(int value, int trieNullValue, int nullValue,
 349             ValueFilter filter) {
 350         if (value == trieNullValue) {
 351             value = nullValue;
 352         } else if (filter != null) {
 353             value = filter.apply(value);
 354         }
 355         return value;
 356     }
 357 
 358     /**
 359      * {@inheritDoc}
<span class="line-modified"> 360      * @draft ICU 63</span>
<span class="line-removed"> 361      * @provisional This API might change or be removed in a future release.</span>
 362      */
 363     @Override
 364     public final boolean getRange(int start, ValueFilter filter, Range range) {
 365         if (start &lt; 0 || MAX_UNICODE &lt; start) {
 366             return false;
 367         }
 368         if (start &gt;= highStart) {
 369             int di = dataLength - HIGH_VALUE_NEG_DATA_OFFSET;
 370             int value = data.getFromIndex(di);
 371             if (filter != null) { value = filter.apply(value); }
 372             range.set(start, MAX_UNICODE, value);
 373             return true;
 374         }
 375 
 376         int nullValue = this.nullValue;
 377         if (filter != null) { nullValue = filter.apply(nullValue); }
 378         Type type = getType();
 379 
 380         int prevI3Block = -1;
 381         int prevBlock = -1;
</pre>
<hr />
<pre>
 498             } while (++i3 &lt; i3BlockLength);
 499         } while (c &lt; highStart);
 500         assert(haveValue);
 501         int di = dataLength - HIGH_VALUE_NEG_DATA_OFFSET;
 502         int highValue = data.getFromIndex(di);
 503         if (maybeFilterValue(highValue, this.nullValue, nullValue, filter) != value) {
 504             --c;
 505         } else {
 506             c = MAX_UNICODE;
 507         }
 508         range.set(start, c, value);
 509         return true;
 510     }
 511 
 512     /**
 513      * Writes a representation of the trie to the output stream.
 514      * Inverse of {@link #fromBinary}.
 515      *
 516      * @param os the output stream
 517      * @return the number of bytes written
<span class="line-modified"> 518      * @draft ICU 63</span>
<span class="line-removed"> 519      * @provisional This API might change or be removed in a future release.</span>
 520      */
 521     public final int toBinary(OutputStream os) {
 522         try {
 523             DataOutputStream dos = new DataOutputStream(os);
 524 
 525             // Write the UCPTrieHeader
 526             dos.writeInt(0x54726933);  // signature=&quot;Tri3&quot;
 527             dos.writeChar(  // options
 528                 ((dataLength &amp; 0xf0000) &gt;&gt; 4) |
 529                 ((dataNullOffset &amp; 0xf0000) &gt;&gt; 8) |
 530                 (getType().ordinal() &lt;&lt; 6) |
 531                 getValueWidth().ordinal());
 532             dos.writeChar(index.length);
 533             dos.writeChar(dataLength);
 534             dos.writeChar(index3NullOffset);
 535             dos.writeChar(dataNullOffset);
 536             dos.writeChar(highStart &gt;&gt; SHIFT_2);  // shiftedHighStart
 537             int length = 16;  // sizeof(UCPTrieHeader)
 538 
 539             for (char i : index) { dos.writeChar(i); }
</pre>
<hr />
<pre>
 764         } else {
 765             // 18-bit indexes stored in groups of 9 entries per 8 indexes.
 766             i3Block = (i3Block &amp; 0x7fff) + (i3 &amp; ~7) + (i3 &gt;&gt; 3);
 767             i3 &amp;= 7;
 768             dataBlock = (index[i3Block++] &lt;&lt; (2 + (2 * i3))) &amp; 0x30000;
 769             dataBlock |= index[i3Block + i3];
 770         }
 771         return dataBlock + (c &amp; SMALL_DATA_MASK);
 772     }
 773 
 774     /**
 775      * @internal
 776      * @deprecated This API is ICU internal only.
 777      */
 778     @Deprecated
 779     protected abstract int cpIndex(int c);
 780 
 781     /**
 782      * A CodePointTrie with {@link Type#FAST}.
 783      *
<span class="line-modified"> 784      * @draft ICU 63</span>
<span class="line-removed"> 785      * @provisional This API might change or be removed in a future release.</span>
 786      */
 787     public static abstract class Fast extends CodePointTrie {
 788         private Fast(char[] index, Data data, int highStart,
 789                 int index3NullOffset, int dataNullOffset) {
 790             super(index, data, highStart, index3NullOffset, dataNullOffset);
 791         }
 792 
 793         /**
 794          * Creates a trie from its binary form.
 795          * Same as {@link CodePointTrie#fromBinary(Type, ValueWidth, ByteBuffer)}
 796          * with {@link Type#FAST}.
 797          *
 798          * @param valueWidth selects the number of bits in a data value; this method throws an exception
 799          *                  if the valueWidth does not match the binary data;
 800          *                  use null to accept any data value width
 801          * @param bytes a buffer containing the binary data of a CodePointTrie
 802          * @return the trie
<span class="line-modified"> 803          * @draft ICU 63</span>
<span class="line-removed"> 804          * @provisional This API might change or be removed in a future release.</span>
 805          */
 806         public static Fast fromBinary(ValueWidth valueWidth, ByteBuffer bytes) {
 807             return (Fast) CodePointTrie.fromBinary(Type.FAST, valueWidth, bytes);
 808         }
 809 
 810         /**
 811          * @return {@link Type#FAST}
<span class="line-modified"> 812          * @draft ICU 63</span>
<span class="line-removed"> 813          * @provisional This API might change or be removed in a future release.</span>
 814          */
 815         @Override
 816         public final Type getType() { return Type.FAST; }
 817 
 818         /**
 819          * Returns a trie value for a BMP code point (U+0000..U+FFFF), without range checking.
 820          * Can be used to look up a value for a UTF-16 code unit if other parts of
 821          * the string processing check for surrogates.
 822          *
 823          * @param c the input code point, must be U+0000..U+FFFF
 824          * @return The BMP code point&#39;s trie value.
<span class="line-modified"> 825          * @draft ICU 63</span>
<span class="line-removed"> 826          * @provisional This API might change or be removed in a future release.</span>
 827          */
 828         public abstract int bmpGet(int c);
 829 
 830         /**
 831          * Returns a trie value for a supplementary code point (U+10000..U+10FFFF),
 832          * without range checking.
 833          *
 834          * @param c the input code point, must be U+10000..U+10FFFF
 835          * @return The supplementary code point&#39;s trie value.
<span class="line-modified"> 836          * @draft ICU 63</span>
<span class="line-removed"> 837          * @provisional This API might change or be removed in a future release.</span>
 838          */
 839         public abstract int suppGet(int c);
 840 
 841         /**
 842          * @internal
 843          * @deprecated This API is ICU internal only.
 844          */
 845         @Deprecated
 846         @Override
 847         protected final int cpIndex(int c) {
 848             if (c &gt;= 0) {
 849                 if (c &lt;= 0xffff) {
 850                     return fastIndex(c);
 851                 } else if (c &lt;= 0x10ffff) {
 852                     return smallIndex(Type.FAST, c);
 853                 }
 854             }
 855             return dataLength - ERROR_VALUE_NEG_DATA_OFFSET;
 856         }
 857 
 858         /**
 859          * {@inheritDoc}
<span class="line-modified"> 860          * @draft ICU 63</span>
<span class="line-removed"> 861          * @provisional This API might change or be removed in a future release.</span>
 862          */
 863         @Override
 864         public final StringIterator stringIterator(CharSequence s, int sIndex) {
 865             return new FastStringIterator(s, sIndex);
 866         }
 867 
 868         private final class FastStringIterator extends StringIterator {
 869             private FastStringIterator(CharSequence s, int sIndex) {
 870                 super(s, sIndex);
 871             }
 872 
 873             @Override
 874             public boolean next() {
 875                 if (sIndex &gt;= s.length()) {
 876                     return false;
 877                 }
 878                 char lead = s.charAt(sIndex++);
 879                 c = lead;
 880                 int dataIndex;
 881                 if (!Character.isSurrogate(lead)) {
</pre>
<hr />
<pre>
 908                 } else {
 909                     char lead;
 910                     if (!UTF16Plus.isSurrogateLead(trail) &amp;&amp; sIndex &gt; 0 &amp;&amp;
 911                             Character.isHighSurrogate(lead = s.charAt(sIndex - 1))) {
 912                         --sIndex;
 913                         c = Character.toCodePoint(lead, trail);
 914                         dataIndex = smallIndex(Type.FAST, c);
 915                     } else {
 916                         dataIndex = dataLength - ERROR_VALUE_NEG_DATA_OFFSET;
 917                     }
 918                 }
 919                 value = data.getFromIndex(dataIndex);
 920                 return true;
 921             }
 922         }
 923     }
 924 
 925     /**
 926      * A CodePointTrie with {@link Type#SMALL}.
 927      *
<span class="line-modified"> 928      * @draft ICU 63</span>
<span class="line-removed"> 929      * @provisional This API might change or be removed in a future release.</span>
 930      */
 931     public static abstract class Small extends CodePointTrie {
 932         private Small(char[] index, Data data, int highStart,
 933                 int index3NullOffset, int dataNullOffset) {
 934             super(index, data, highStart, index3NullOffset, dataNullOffset);
 935         }
 936 
 937         /**
 938          * Creates a trie from its binary form.
 939          * Same as {@link CodePointTrie#fromBinary(Type, ValueWidth, ByteBuffer)}
 940          * with {@link Type#SMALL}.
 941          *
 942          * @param valueWidth selects the number of bits in a data value; this method throws an exception
 943          *                  if the valueWidth does not match the binary data;
 944          *                  use null to accept any data value width
 945          * @param bytes a buffer containing the binary data of a CodePointTrie
 946          * @return the trie
<span class="line-modified"> 947          * @draft ICU 63</span>
<span class="line-removed"> 948          * @provisional This API might change or be removed in a future release.</span>
 949          */
 950         public static Small fromBinary(ValueWidth valueWidth, ByteBuffer bytes) {
 951             return (Small) CodePointTrie.fromBinary(Type.SMALL, valueWidth, bytes);
 952         }
 953 
 954         /**
 955          * @return {@link Type#SMALL}
<span class="line-modified"> 956          * @draft ICU 63</span>
<span class="line-removed"> 957          * @provisional This API might change or be removed in a future release.</span>
 958          */
 959         @Override
 960         public final Type getType() { return Type.SMALL; }
 961 
 962         /**
 963          * @internal
 964          * @deprecated This API is ICU internal only.
 965          */
 966         @Deprecated
 967         @Override
 968         protected final int cpIndex(int c) {
 969             if (c &gt;= 0) {
 970                 if (c &lt;= SMALL_MAX) {
 971                     return fastIndex(c);
 972                 } else if (c &lt;= 0x10ffff) {
 973                     return smallIndex(Type.SMALL, c);
 974                 }
 975             }
 976             return dataLength - ERROR_VALUE_NEG_DATA_OFFSET;
 977         }
 978 
 979         /**
 980          * {@inheritDoc}
<span class="line-modified"> 981          * @draft ICU 63</span>
<span class="line-removed"> 982          * @provisional This API might change or be removed in a future release.</span>
 983          */
 984         @Override
 985         public final StringIterator stringIterator(CharSequence s, int sIndex) {
 986             return new SmallStringIterator(s, sIndex);
 987         }
 988 
 989         private final class SmallStringIterator extends StringIterator {
 990             private SmallStringIterator(CharSequence s, int sIndex) {
 991                 super(s, sIndex);
 992             }
 993 
 994             @Override
 995             public boolean next() {
 996                 if (sIndex &gt;= s.length()) {
 997                     return false;
 998                 }
 999                 char lead = s.charAt(sIndex++);
1000                 c = lead;
1001                 int dataIndex;
1002                 if (!Character.isSurrogate(lead)) {
</pre>
<hr />
<pre>
1029                 } else {
1030                     char lead;
1031                     if (!UTF16Plus.isSurrogateLead(trail) &amp;&amp; sIndex &gt; 0 &amp;&amp;
1032                             Character.isHighSurrogate(lead = s.charAt(sIndex - 1))) {
1033                         --sIndex;
1034                         c = Character.toCodePoint(lead, trail);
1035                         dataIndex = smallIndex(Type.SMALL, c);
1036                     } else {
1037                         dataIndex = dataLength - ERROR_VALUE_NEG_DATA_OFFSET;
1038                     }
1039                 }
1040                 value = data.getFromIndex(dataIndex);
1041                 return true;
1042             }
1043         }
1044     }
1045 
1046     /**
1047      * A CodePointTrie with {@link Type#FAST} and {@link ValueWidth#BITS_16}.
1048      *
<span class="line-modified">1049      * @draft ICU 63</span>
<span class="line-removed">1050      * @provisional This API might change or be removed in a future release.</span>
1051      */
1052     public static final class Fast16 extends Fast {
1053         private final char[] dataArray;
1054 
1055         Fast16(char[] index, char[] data16, int highStart,
1056                 int index3NullOffset, int dataNullOffset) {
1057             super(index, new Data16(data16), highStart, index3NullOffset, dataNullOffset);
1058             this.dataArray = data16;
1059         }
1060 
1061         /**
1062          * Creates a trie from its binary form.
1063          * Same as {@link CodePointTrie#fromBinary(Type, ValueWidth, ByteBuffer)}
1064          * with {@link Type#FAST} and {@link ValueWidth#BITS_16}.
1065          *
1066          * @param bytes a buffer containing the binary data of a CodePointTrie
1067          * @return the trie
<span class="line-modified">1068          * @draft ICU 63</span>
<span class="line-removed">1069          * @provisional This API might change or be removed in a future release.</span>
1070          */
1071         public static Fast16 fromBinary(ByteBuffer bytes) {
1072             return (Fast16) CodePointTrie.fromBinary(Type.FAST, ValueWidth.BITS_16, bytes);
1073         }
1074 
1075         /**
1076          * {@inheritDoc}
<span class="line-modified">1077          * @draft ICU 63</span>
<span class="line-removed">1078          * @provisional This API might change or be removed in a future release.</span>
1079          */
1080         @Override
1081         public final int get(int c) {
1082             return dataArray[cpIndex(c)];
1083         }
1084 
1085         /**
1086          * {@inheritDoc}
<span class="line-modified">1087          * @draft ICU 63</span>
<span class="line-removed">1088          * @provisional This API might change or be removed in a future release.</span>
1089          */
1090         @Override
1091         public final int bmpGet(int c) {
1092             assert 0 &lt;= c &amp;&amp; c &lt;= 0xffff;
1093             return dataArray[fastIndex(c)];
1094         }
1095 
1096         /**
1097          * {@inheritDoc}
<span class="line-modified">1098          * @draft ICU 63</span>
<span class="line-removed">1099          * @provisional This API might change or be removed in a future release.</span>
1100          */
1101         @Override
1102         public final int suppGet(int c) {
1103             assert 0x10000 &lt;= c &amp;&amp; c &lt;= 0x10ffff;
1104             return dataArray[smallIndex(Type.FAST, c)];
1105         }
1106     }
1107 
1108     /**
1109      * A CodePointTrie with {@link Type#FAST} and {@link ValueWidth#BITS_32}.
1110      *
<span class="line-modified">1111      * @draft ICU 63</span>
<span class="line-removed">1112      * @provisional This API might change or be removed in a future release.</span>
1113      */
1114     public static final class Fast32 extends Fast {
1115         private final int[] dataArray;
1116 
1117         Fast32(char[] index, int[] data32, int highStart,
1118                 int index3NullOffset, int dataNullOffset) {
1119             super(index, new Data32(data32), highStart, index3NullOffset, dataNullOffset);
1120             this.dataArray = data32;
1121         }
1122 
1123         /**
1124          * Creates a trie from its binary form.
1125          * Same as {@link CodePointTrie#fromBinary(Type, ValueWidth, ByteBuffer)}
1126          * with {@link Type#FAST} and {@link ValueWidth#BITS_32}.
1127          *
1128          * @param bytes a buffer containing the binary data of a CodePointTrie
1129          * @return the trie
<span class="line-modified">1130          * @draft ICU 63</span>
<span class="line-removed">1131          * @provisional This API might change or be removed in a future release.</span>
1132          */
1133         public static Fast32 fromBinary(ByteBuffer bytes) {
1134             return (Fast32) CodePointTrie.fromBinary(Type.FAST, ValueWidth.BITS_32, bytes);
1135         }
1136 
1137         /**
1138          * {@inheritDoc}
<span class="line-modified">1139          * @draft ICU 63</span>
<span class="line-removed">1140          * @provisional This API might change or be removed in a future release.</span>
1141          */
1142         @Override
1143         public final int get(int c) {
1144             return dataArray[cpIndex(c)];
1145         }
1146 
1147         /**
1148          * {@inheritDoc}
<span class="line-modified">1149          * @draft ICU 63</span>
<span class="line-removed">1150          * @provisional This API might change or be removed in a future release.</span>
1151          */
1152         @Override
1153         public final int bmpGet(int c) {
1154             assert 0 &lt;= c &amp;&amp; c &lt;= 0xffff;
1155             return dataArray[fastIndex(c)];
1156         }
1157 
1158         /**
1159          * {@inheritDoc}
<span class="line-modified">1160          * @draft ICU 63</span>
<span class="line-removed">1161          * @provisional This API might change or be removed in a future release.</span>
1162          */
1163         @Override
1164         public final int suppGet(int c) {
1165             assert 0x10000 &lt;= c &amp;&amp; c &lt;= 0x10ffff;
1166             return dataArray[smallIndex(Type.FAST, c)];
1167         }
1168     }
1169 
1170     /**
1171      * A CodePointTrie with {@link Type#FAST} and {@link ValueWidth#BITS_8}.
1172      *
<span class="line-modified">1173      * @draft ICU 63</span>
<span class="line-removed">1174      * @provisional This API might change or be removed in a future release.</span>
1175      */
1176     public static final class Fast8 extends Fast {
1177         private final byte[] dataArray;
1178 
1179         Fast8(char[] index, byte[] data8, int highStart,
1180                 int index3NullOffset, int dataNullOffset) {
1181             super(index, new Data8(data8), highStart, index3NullOffset, dataNullOffset);
1182             this.dataArray = data8;
1183         }
1184 
1185         /**
1186          * Creates a trie from its binary form.
1187          * Same as {@link CodePointTrie#fromBinary(Type, ValueWidth, ByteBuffer)}
1188          * with {@link Type#FAST} and {@link ValueWidth#BITS_8}.
1189          *
1190          * @param bytes a buffer containing the binary data of a CodePointTrie
1191          * @return the trie
<span class="line-modified">1192          * @draft ICU 63</span>
<span class="line-removed">1193          * @provisional This API might change or be removed in a future release.</span>
1194          */
1195         public static Fast8 fromBinary(ByteBuffer bytes) {
1196             return (Fast8) CodePointTrie.fromBinary(Type.FAST, ValueWidth.BITS_8, bytes);
1197         }
1198 
1199         /**
1200          * {@inheritDoc}
<span class="line-modified">1201          * @draft ICU 63</span>
<span class="line-removed">1202          * @provisional This API might change or be removed in a future release.</span>
1203          */
1204         @Override
1205         public final int get(int c) {
1206             return dataArray[cpIndex(c)] &amp; 0xff;
1207         }
1208 
1209         /**
1210          * {@inheritDoc}
<span class="line-modified">1211          * @draft ICU 63</span>
<span class="line-removed">1212          * @provisional This API might change or be removed in a future release.</span>
1213          */
1214         @Override
1215         public final int bmpGet(int c) {
1216             assert 0 &lt;= c &amp;&amp; c &lt;= 0xffff;
1217             return dataArray[fastIndex(c)] &amp; 0xff;
1218         }
1219 
1220         /**
1221          * {@inheritDoc}
<span class="line-modified">1222          * @draft ICU 63</span>
<span class="line-removed">1223          * @provisional This API might change or be removed in a future release.</span>
1224          */
1225         @Override
1226         public final int suppGet(int c) {
1227             assert 0x10000 &lt;= c &amp;&amp; c &lt;= 0x10ffff;
1228             return dataArray[smallIndex(Type.FAST, c)] &amp; 0xff;
1229         }
1230     }
1231 
1232     /**
1233      * A CodePointTrie with {@link Type#SMALL} and {@link ValueWidth#BITS_16}.
1234      *
<span class="line-modified">1235      * @draft ICU 63</span>
<span class="line-removed">1236      * @provisional This API might change or be removed in a future release.</span>
1237      */
1238     public static final class Small16 extends Small {
1239         Small16(char[] index, char[] data16, int highStart,
1240                 int index3NullOffset, int dataNullOffset) {
1241             super(index, new Data16(data16), highStart, index3NullOffset, dataNullOffset);
1242         }
1243 
1244         /**
1245          * Creates a trie from its binary form.
1246          * Same as {@link CodePointTrie#fromBinary(Type, ValueWidth, ByteBuffer)}
1247          * with {@link Type#SMALL} and {@link ValueWidth#BITS_16}.
1248          *
1249          * @param bytes a buffer containing the binary data of a CodePointTrie
1250          * @return the trie
<span class="line-modified">1251          * @draft ICU 63</span>
<span class="line-removed">1252          * @provisional This API might change or be removed in a future release.</span>
1253          */
1254         public static Small16 fromBinary(ByteBuffer bytes) {
1255             return (Small16) CodePointTrie.fromBinary(Type.SMALL, ValueWidth.BITS_16, bytes);
1256         }
1257     }
1258 
1259     /**
1260      * A CodePointTrie with {@link Type#SMALL} and {@link ValueWidth#BITS_32}.
1261      *
<span class="line-modified">1262      * @draft ICU 63</span>
<span class="line-removed">1263      * @provisional This API might change or be removed in a future release.</span>
1264      */
1265     public static final class Small32 extends Small {
1266         Small32(char[] index, int[] data32, int highStart,
1267                 int index3NullOffset, int dataNullOffset) {
1268             super(index, new Data32(data32), highStart, index3NullOffset, dataNullOffset);
1269         }
1270 
1271         /**
1272          * Creates a trie from its binary form.
1273          * Same as {@link CodePointTrie#fromBinary(Type, ValueWidth, ByteBuffer)}
1274          * with {@link Type#SMALL} and {@link ValueWidth#BITS_32}.
1275          *
1276          * @param bytes a buffer containing the binary data of a CodePointTrie
1277          * @return the trie
<span class="line-modified">1278          * @draft ICU 63</span>
<span class="line-removed">1279          * @provisional This API might change or be removed in a future release.</span>
1280          */
1281         public static Small32 fromBinary(ByteBuffer bytes) {
1282             return (Small32) CodePointTrie.fromBinary(Type.SMALL, ValueWidth.BITS_32, bytes);
1283         }
1284     }
1285 
1286     /**
1287      * A CodePointTrie with {@link Type#SMALL} and {@link ValueWidth#BITS_8}.
1288      *
<span class="line-modified">1289      * @draft ICU 63</span>
<span class="line-removed">1290      * @provisional This API might change or be removed in a future release.</span>
1291      */
1292     public static final class Small8 extends Small {
1293         Small8(char[] index, byte[] data8, int highStart,
1294                 int index3NullOffset, int dataNullOffset) {
1295             super(index, new Data8(data8), highStart, index3NullOffset, dataNullOffset);
1296         }
1297 
1298         /**
1299          * Creates a trie from its binary form.
1300          * Same as {@link CodePointTrie#fromBinary(Type, ValueWidth, ByteBuffer)}
1301          * with {@link Type#SMALL} and {@link ValueWidth#BITS_8}.
1302          *
1303          * @param bytes a buffer containing the binary data of a CodePointTrie
1304          * @return the trie
<span class="line-modified">1305          * @draft ICU 63</span>
<span class="line-removed">1306          * @provisional This API might change or be removed in a future release.</span>
1307          */
1308         public static Small8 fromBinary(ByteBuffer bytes) {
1309             return (Small8) CodePointTrie.fromBinary(Type.SMALL, ValueWidth.BITS_8, bytes);
1310         }
1311     }
1312 }
</pre>
</td>
<td>
<hr />
<pre>
  31 
  32 import jdk.internal.icu.impl.ICUBinary;
  33 
  34 import java.io.DataOutputStream;
  35 import java.io.IOException;
  36 import java.io.UncheckedIOException;
  37 import java.io.OutputStream;
  38 import java.nio.ByteBuffer;
  39 import java.nio.ByteOrder;
  40 
  41 import static jdk.internal.icu.impl.NormalizerImpl.UTF16Plus;
  42 
  43 /**
  44  * Immutable Unicode code point trie.
  45  * Fast, reasonably compact, map from Unicode code points (U+0000..U+10FFFF) to integer values.
  46  * For details see http://site.icu-project.org/design/struct/utrie
  47  *
  48  * &lt;p&gt;This class is not intended for public subclassing.
  49  *
  50  * @see MutableCodePointTrie
<span class="line-modified">  51  * @stable ICU 63</span>

  52  */
  53 @SuppressWarnings(&quot;deprecation&quot;)
  54 public abstract class CodePointTrie extends CodePointMap {
  55     /**
  56      * Selectors for the type of a CodePointTrie.
  57      * Different trade-offs for size vs. speed.
  58      *
  59      * &lt;p&gt;Use null for {@link #fromBinary} to accept any type;
  60      * {@link #getType} will return the actual type.
  61      *
  62      * @see MutableCodePointTrie#buildImmutable(CodePointTrie.Type, CodePointTrie.ValueWidth)
  63      * @see #fromBinary
  64      * @see #getType
<span class="line-modified">  65      * @stable ICU 63</span>

  66      */
  67     public enum Type {
  68         /**
  69          * Fast/simple/larger BMP data structure.
  70          * The {@link Fast} subclasses have additional functions for lookup for BMP and supplementary code points.
  71          *
  72          * @see Fast
<span class="line-modified">  73          * @stable ICU 63</span>

  74          */
  75         FAST,
  76         /**
  77          * Small/slower BMP data structure.
  78          *
  79          * @see Small
<span class="line-modified">  80          * @stable ICU 63</span>

  81          */
  82         SMALL
  83     }
  84 
  85     /**
  86      * Selectors for the number of bits in a CodePointTrie data value.
  87      *
  88      * &lt;p&gt;Use null for {@link #fromBinary} to accept any data value width;
  89      * {@link #getValueWidth} will return the actual data value width.
  90      *
<span class="line-modified">  91      * @stable ICU 63</span>

  92      */
  93     public enum ValueWidth {
  94         /**
  95          * The trie stores 16 bits per data value.
  96          * It returns them as unsigned values 0..0xffff=65535.
  97          *
<span class="line-modified">  98          * @stable ICU 63</span>

  99          */
 100         BITS_16,
 101         /**
 102          * The trie stores 32 bits per data value.
 103          *
<span class="line-modified"> 104          * @stable ICU 63</span>

 105          */
 106         BITS_32,
 107         /**
 108          * The trie stores 8 bits per data value.
 109          * It returns them as unsigned values 0..0xff=255.
 110          *
<span class="line-modified"> 111          * @stable ICU 63</span>

 112          */
 113         BITS_8
 114     }
 115 
 116     private CodePointTrie(char[] index, Data data, int highStart,
 117             int index3NullOffset, int dataNullOffset) {
 118         this.ascii = new int[ASCII_LIMIT];
 119         this.index = index;
 120         this.data = data;
 121         this.dataLength = data.getDataLength();
 122         this.highStart = highStart;
 123         this.index3NullOffset = index3NullOffset;
 124         this.dataNullOffset = dataNullOffset;
 125 
 126         for (int c = 0; c &lt; ASCII_LIMIT; ++c) {
 127             ascii[c] = data.getFromIndex(c);
 128         }
 129 
 130         int nullValueOffset = dataNullOffset;
 131         if (nullValueOffset &gt;= dataLength) {
</pre>
<hr />
<pre>
 137     /**
 138      * Creates a trie from its binary form,
 139      * stored in the ByteBuffer starting at the current position.
 140      * Advances the buffer position to just after the trie data.
 141      * Inverse of {@link #toBinary(OutputStream)}.
 142      *
 143      * &lt;p&gt;The data is copied from the buffer;
 144      * later modification of the buffer will not affect the trie.
 145      *
 146      * @param type selects the trie type; this method throws an exception
 147      *             if the type does not match the binary data;
 148      *             use null to accept any type
 149      * @param valueWidth selects the number of bits in a data value; this method throws an exception
 150      *                  if the valueWidth does not match the binary data;
 151      *                  use null to accept any data value width
 152      * @param bytes a buffer containing the binary data of a CodePointTrie
 153      * @return the trie
 154      * @see MutableCodePointTrie#MutableCodePointTrie(int, int)
 155      * @see MutableCodePointTrie#buildImmutable(CodePointTrie.Type, CodePointTrie.ValueWidth)
 156      * @see #toBinary(OutputStream)
<span class="line-modified"> 157      * @stable ICU 63</span>

 158      */
 159     public static CodePointTrie fromBinary(Type type, ValueWidth valueWidth, ByteBuffer bytes) {
 160         ByteOrder outerByteOrder = bytes.order();
 161         try {
 162             // Enough data for a trie header?
 163             if (bytes.remaining() &lt; 16 /* sizeof(UCPTrieHeader) */) {
 164                 throw new InternalError(&quot;Buffer too short for a CodePointTrie header&quot;);
 165             }
 166 
 167             // struct UCPTrieHeader
 168             /** &quot;Tri3&quot; in big-endian US-ASCII (0x54726933) */
 169             int signature = bytes.getInt();
 170 
 171             // Check the signature.
 172             switch (signature) {
 173             case 0x54726933:
 174                 // The buffer is already set to the trie data byte order.
 175                 break;
 176             case 0x33697254:
 177                 // Temporarily reverse the byte order.
</pre>
<hr />
<pre>
 280                             new Small32(index, data32, highStart, index3NullOffset, dataNullOffset);
 281             }
 282             case BITS_8: {
 283                 byte[] data8 = ICUBinary.getBytes(bytes, dataLength, 0);
 284                 return type == Type.FAST ?
 285                         new Fast8(index, data8, highStart, index3NullOffset, dataNullOffset) :
 286                             new Small8(index, data8, highStart, index3NullOffset, dataNullOffset);
 287             }
 288             default:
 289                 throw new AssertionError(&quot;should be unreachable&quot;);
 290             }
 291         } finally {
 292             bytes.order(outerByteOrder);
 293         }
 294     }
 295 
 296     /**
 297      * Returns the trie type.
 298      *
 299      * @return the trie type
<span class="line-modified"> 300      * @stable ICU 63</span>

 301      */
 302     public abstract Type getType();
 303     /**
 304      * Returns the number of bits in a trie data value.
 305      *
 306      * @return the number of bits in a trie data value
<span class="line-modified"> 307      * @stable ICU 63</span>

 308      */
 309     public final ValueWidth getValueWidth() { return data.getValueWidth(); }
 310 
 311     /**
 312      * {@inheritDoc}
<span class="line-modified"> 313      * @stable ICU 63</span>

 314      */
 315     @Override
 316     public int get(int c) {
 317         return data.getFromIndex(cpIndex(c));
 318     }
 319 
 320     /**
 321      * Returns a trie value for an ASCII code point, without range checking.
 322      *
 323      * @param c the input code point; must be U+0000..U+007F
 324      * @return The ASCII code point&#39;s trie value.
<span class="line-modified"> 325      * @stable ICU 63</span>

 326      */
 327     public final int asciiGet(int c) {
 328         return ascii[c];
 329     }
 330 
 331     private static final int MAX_UNICODE = 0x10ffff;
 332 
 333     private static final int ASCII_LIMIT = 0x80;
 334 
 335     private static final int maybeFilterValue(int value, int trieNullValue, int nullValue,
 336             ValueFilter filter) {
 337         if (value == trieNullValue) {
 338             value = nullValue;
 339         } else if (filter != null) {
 340             value = filter.apply(value);
 341         }
 342         return value;
 343     }
 344 
 345     /**
 346      * {@inheritDoc}
<span class="line-modified"> 347      * @stable ICU 63</span>

 348      */
 349     @Override
 350     public final boolean getRange(int start, ValueFilter filter, Range range) {
 351         if (start &lt; 0 || MAX_UNICODE &lt; start) {
 352             return false;
 353         }
 354         if (start &gt;= highStart) {
 355             int di = dataLength - HIGH_VALUE_NEG_DATA_OFFSET;
 356             int value = data.getFromIndex(di);
 357             if (filter != null) { value = filter.apply(value); }
 358             range.set(start, MAX_UNICODE, value);
 359             return true;
 360         }
 361 
 362         int nullValue = this.nullValue;
 363         if (filter != null) { nullValue = filter.apply(nullValue); }
 364         Type type = getType();
 365 
 366         int prevI3Block = -1;
 367         int prevBlock = -1;
</pre>
<hr />
<pre>
 484             } while (++i3 &lt; i3BlockLength);
 485         } while (c &lt; highStart);
 486         assert(haveValue);
 487         int di = dataLength - HIGH_VALUE_NEG_DATA_OFFSET;
 488         int highValue = data.getFromIndex(di);
 489         if (maybeFilterValue(highValue, this.nullValue, nullValue, filter) != value) {
 490             --c;
 491         } else {
 492             c = MAX_UNICODE;
 493         }
 494         range.set(start, c, value);
 495         return true;
 496     }
 497 
 498     /**
 499      * Writes a representation of the trie to the output stream.
 500      * Inverse of {@link #fromBinary}.
 501      *
 502      * @param os the output stream
 503      * @return the number of bytes written
<span class="line-modified"> 504      * @stable ICU 63</span>

 505      */
 506     public final int toBinary(OutputStream os) {
 507         try {
 508             DataOutputStream dos = new DataOutputStream(os);
 509 
 510             // Write the UCPTrieHeader
 511             dos.writeInt(0x54726933);  // signature=&quot;Tri3&quot;
 512             dos.writeChar(  // options
 513                 ((dataLength &amp; 0xf0000) &gt;&gt; 4) |
 514                 ((dataNullOffset &amp; 0xf0000) &gt;&gt; 8) |
 515                 (getType().ordinal() &lt;&lt; 6) |
 516                 getValueWidth().ordinal());
 517             dos.writeChar(index.length);
 518             dos.writeChar(dataLength);
 519             dos.writeChar(index3NullOffset);
 520             dos.writeChar(dataNullOffset);
 521             dos.writeChar(highStart &gt;&gt; SHIFT_2);  // shiftedHighStart
 522             int length = 16;  // sizeof(UCPTrieHeader)
 523 
 524             for (char i : index) { dos.writeChar(i); }
</pre>
<hr />
<pre>
 749         } else {
 750             // 18-bit indexes stored in groups of 9 entries per 8 indexes.
 751             i3Block = (i3Block &amp; 0x7fff) + (i3 &amp; ~7) + (i3 &gt;&gt; 3);
 752             i3 &amp;= 7;
 753             dataBlock = (index[i3Block++] &lt;&lt; (2 + (2 * i3))) &amp; 0x30000;
 754             dataBlock |= index[i3Block + i3];
 755         }
 756         return dataBlock + (c &amp; SMALL_DATA_MASK);
 757     }
 758 
 759     /**
 760      * @internal
 761      * @deprecated This API is ICU internal only.
 762      */
 763     @Deprecated
 764     protected abstract int cpIndex(int c);
 765 
 766     /**
 767      * A CodePointTrie with {@link Type#FAST}.
 768      *
<span class="line-modified"> 769      * @stable ICU 63</span>

 770      */
 771     public static abstract class Fast extends CodePointTrie {
 772         private Fast(char[] index, Data data, int highStart,
 773                 int index3NullOffset, int dataNullOffset) {
 774             super(index, data, highStart, index3NullOffset, dataNullOffset);
 775         }
 776 
 777         /**
 778          * Creates a trie from its binary form.
 779          * Same as {@link CodePointTrie#fromBinary(Type, ValueWidth, ByteBuffer)}
 780          * with {@link Type#FAST}.
 781          *
 782          * @param valueWidth selects the number of bits in a data value; this method throws an exception
 783          *                  if the valueWidth does not match the binary data;
 784          *                  use null to accept any data value width
 785          * @param bytes a buffer containing the binary data of a CodePointTrie
 786          * @return the trie
<span class="line-modified"> 787          * @stable ICU 63</span>

 788          */
 789         public static Fast fromBinary(ValueWidth valueWidth, ByteBuffer bytes) {
 790             return (Fast) CodePointTrie.fromBinary(Type.FAST, valueWidth, bytes);
 791         }
 792 
 793         /**
 794          * @return {@link Type#FAST}
<span class="line-modified"> 795          * @stable ICU 63</span>

 796          */
 797         @Override
 798         public final Type getType() { return Type.FAST; }
 799 
 800         /**
 801          * Returns a trie value for a BMP code point (U+0000..U+FFFF), without range checking.
 802          * Can be used to look up a value for a UTF-16 code unit if other parts of
 803          * the string processing check for surrogates.
 804          *
 805          * @param c the input code point, must be U+0000..U+FFFF
 806          * @return The BMP code point&#39;s trie value.
<span class="line-modified"> 807          * @stable ICU 63</span>

 808          */
 809         public abstract int bmpGet(int c);
 810 
 811         /**
 812          * Returns a trie value for a supplementary code point (U+10000..U+10FFFF),
 813          * without range checking.
 814          *
 815          * @param c the input code point, must be U+10000..U+10FFFF
 816          * @return The supplementary code point&#39;s trie value.
<span class="line-modified"> 817          * @stable ICU 63</span>

 818          */
 819         public abstract int suppGet(int c);
 820 
 821         /**
 822          * @internal
 823          * @deprecated This API is ICU internal only.
 824          */
 825         @Deprecated
 826         @Override
 827         protected final int cpIndex(int c) {
 828             if (c &gt;= 0) {
 829                 if (c &lt;= 0xffff) {
 830                     return fastIndex(c);
 831                 } else if (c &lt;= 0x10ffff) {
 832                     return smallIndex(Type.FAST, c);
 833                 }
 834             }
 835             return dataLength - ERROR_VALUE_NEG_DATA_OFFSET;
 836         }
 837 
 838         /**
 839          * {@inheritDoc}
<span class="line-modified"> 840          * @stable ICU 63</span>

 841          */
 842         @Override
 843         public final StringIterator stringIterator(CharSequence s, int sIndex) {
 844             return new FastStringIterator(s, sIndex);
 845         }
 846 
 847         private final class FastStringIterator extends StringIterator {
 848             private FastStringIterator(CharSequence s, int sIndex) {
 849                 super(s, sIndex);
 850             }
 851 
 852             @Override
 853             public boolean next() {
 854                 if (sIndex &gt;= s.length()) {
 855                     return false;
 856                 }
 857                 char lead = s.charAt(sIndex++);
 858                 c = lead;
 859                 int dataIndex;
 860                 if (!Character.isSurrogate(lead)) {
</pre>
<hr />
<pre>
 887                 } else {
 888                     char lead;
 889                     if (!UTF16Plus.isSurrogateLead(trail) &amp;&amp; sIndex &gt; 0 &amp;&amp;
 890                             Character.isHighSurrogate(lead = s.charAt(sIndex - 1))) {
 891                         --sIndex;
 892                         c = Character.toCodePoint(lead, trail);
 893                         dataIndex = smallIndex(Type.FAST, c);
 894                     } else {
 895                         dataIndex = dataLength - ERROR_VALUE_NEG_DATA_OFFSET;
 896                     }
 897                 }
 898                 value = data.getFromIndex(dataIndex);
 899                 return true;
 900             }
 901         }
 902     }
 903 
 904     /**
 905      * A CodePointTrie with {@link Type#SMALL}.
 906      *
<span class="line-modified"> 907      * @stable ICU 63</span>

 908      */
 909     public static abstract class Small extends CodePointTrie {
 910         private Small(char[] index, Data data, int highStart,
 911                 int index3NullOffset, int dataNullOffset) {
 912             super(index, data, highStart, index3NullOffset, dataNullOffset);
 913         }
 914 
 915         /**
 916          * Creates a trie from its binary form.
 917          * Same as {@link CodePointTrie#fromBinary(Type, ValueWidth, ByteBuffer)}
 918          * with {@link Type#SMALL}.
 919          *
 920          * @param valueWidth selects the number of bits in a data value; this method throws an exception
 921          *                  if the valueWidth does not match the binary data;
 922          *                  use null to accept any data value width
 923          * @param bytes a buffer containing the binary data of a CodePointTrie
 924          * @return the trie
<span class="line-modified"> 925          * @stable ICU 63</span>

 926          */
 927         public static Small fromBinary(ValueWidth valueWidth, ByteBuffer bytes) {
 928             return (Small) CodePointTrie.fromBinary(Type.SMALL, valueWidth, bytes);
 929         }
 930 
 931         /**
 932          * @return {@link Type#SMALL}
<span class="line-modified"> 933          * @stable ICU 63</span>

 934          */
 935         @Override
 936         public final Type getType() { return Type.SMALL; }
 937 
 938         /**
 939          * @internal
 940          * @deprecated This API is ICU internal only.
 941          */
 942         @Deprecated
 943         @Override
 944         protected final int cpIndex(int c) {
 945             if (c &gt;= 0) {
 946                 if (c &lt;= SMALL_MAX) {
 947                     return fastIndex(c);
 948                 } else if (c &lt;= 0x10ffff) {
 949                     return smallIndex(Type.SMALL, c);
 950                 }
 951             }
 952             return dataLength - ERROR_VALUE_NEG_DATA_OFFSET;
 953         }
 954 
 955         /**
 956          * {@inheritDoc}
<span class="line-modified"> 957          * @stable ICU 63</span>

 958          */
 959         @Override
 960         public final StringIterator stringIterator(CharSequence s, int sIndex) {
 961             return new SmallStringIterator(s, sIndex);
 962         }
 963 
 964         private final class SmallStringIterator extends StringIterator {
 965             private SmallStringIterator(CharSequence s, int sIndex) {
 966                 super(s, sIndex);
 967             }
 968 
 969             @Override
 970             public boolean next() {
 971                 if (sIndex &gt;= s.length()) {
 972                     return false;
 973                 }
 974                 char lead = s.charAt(sIndex++);
 975                 c = lead;
 976                 int dataIndex;
 977                 if (!Character.isSurrogate(lead)) {
</pre>
<hr />
<pre>
1004                 } else {
1005                     char lead;
1006                     if (!UTF16Plus.isSurrogateLead(trail) &amp;&amp; sIndex &gt; 0 &amp;&amp;
1007                             Character.isHighSurrogate(lead = s.charAt(sIndex - 1))) {
1008                         --sIndex;
1009                         c = Character.toCodePoint(lead, trail);
1010                         dataIndex = smallIndex(Type.SMALL, c);
1011                     } else {
1012                         dataIndex = dataLength - ERROR_VALUE_NEG_DATA_OFFSET;
1013                     }
1014                 }
1015                 value = data.getFromIndex(dataIndex);
1016                 return true;
1017             }
1018         }
1019     }
1020 
1021     /**
1022      * A CodePointTrie with {@link Type#FAST} and {@link ValueWidth#BITS_16}.
1023      *
<span class="line-modified">1024      * @stable ICU 63</span>

1025      */
1026     public static final class Fast16 extends Fast {
1027         private final char[] dataArray;
1028 
1029         Fast16(char[] index, char[] data16, int highStart,
1030                 int index3NullOffset, int dataNullOffset) {
1031             super(index, new Data16(data16), highStart, index3NullOffset, dataNullOffset);
1032             this.dataArray = data16;
1033         }
1034 
1035         /**
1036          * Creates a trie from its binary form.
1037          * Same as {@link CodePointTrie#fromBinary(Type, ValueWidth, ByteBuffer)}
1038          * with {@link Type#FAST} and {@link ValueWidth#BITS_16}.
1039          *
1040          * @param bytes a buffer containing the binary data of a CodePointTrie
1041          * @return the trie
<span class="line-modified">1042          * @stable ICU 63</span>

1043          */
1044         public static Fast16 fromBinary(ByteBuffer bytes) {
1045             return (Fast16) CodePointTrie.fromBinary(Type.FAST, ValueWidth.BITS_16, bytes);
1046         }
1047 
1048         /**
1049          * {@inheritDoc}
<span class="line-modified">1050          * @stable ICU 63</span>

1051          */
1052         @Override
1053         public final int get(int c) {
1054             return dataArray[cpIndex(c)];
1055         }
1056 
1057         /**
1058          * {@inheritDoc}
<span class="line-modified">1059          * @stable ICU 63</span>

1060          */
1061         @Override
1062         public final int bmpGet(int c) {
1063             assert 0 &lt;= c &amp;&amp; c &lt;= 0xffff;
1064             return dataArray[fastIndex(c)];
1065         }
1066 
1067         /**
1068          * {@inheritDoc}
<span class="line-modified">1069          * @stable ICU 63</span>

1070          */
1071         @Override
1072         public final int suppGet(int c) {
1073             assert 0x10000 &lt;= c &amp;&amp; c &lt;= 0x10ffff;
1074             return dataArray[smallIndex(Type.FAST, c)];
1075         }
1076     }
1077 
1078     /**
1079      * A CodePointTrie with {@link Type#FAST} and {@link ValueWidth#BITS_32}.
1080      *
<span class="line-modified">1081      * @stable ICU 63</span>

1082      */
1083     public static final class Fast32 extends Fast {
1084         private final int[] dataArray;
1085 
1086         Fast32(char[] index, int[] data32, int highStart,
1087                 int index3NullOffset, int dataNullOffset) {
1088             super(index, new Data32(data32), highStart, index3NullOffset, dataNullOffset);
1089             this.dataArray = data32;
1090         }
1091 
1092         /**
1093          * Creates a trie from its binary form.
1094          * Same as {@link CodePointTrie#fromBinary(Type, ValueWidth, ByteBuffer)}
1095          * with {@link Type#FAST} and {@link ValueWidth#BITS_32}.
1096          *
1097          * @param bytes a buffer containing the binary data of a CodePointTrie
1098          * @return the trie
<span class="line-modified">1099          * @stable ICU 63</span>

1100          */
1101         public static Fast32 fromBinary(ByteBuffer bytes) {
1102             return (Fast32) CodePointTrie.fromBinary(Type.FAST, ValueWidth.BITS_32, bytes);
1103         }
1104 
1105         /**
1106          * {@inheritDoc}
<span class="line-modified">1107          * @stable ICU 63</span>

1108          */
1109         @Override
1110         public final int get(int c) {
1111             return dataArray[cpIndex(c)];
1112         }
1113 
1114         /**
1115          * {@inheritDoc}
<span class="line-modified">1116          * @stable ICU 63</span>

1117          */
1118         @Override
1119         public final int bmpGet(int c) {
1120             assert 0 &lt;= c &amp;&amp; c &lt;= 0xffff;
1121             return dataArray[fastIndex(c)];
1122         }
1123 
1124         /**
1125          * {@inheritDoc}
<span class="line-modified">1126          * @stable ICU 63</span>

1127          */
1128         @Override
1129         public final int suppGet(int c) {
1130             assert 0x10000 &lt;= c &amp;&amp; c &lt;= 0x10ffff;
1131             return dataArray[smallIndex(Type.FAST, c)];
1132         }
1133     }
1134 
1135     /**
1136      * A CodePointTrie with {@link Type#FAST} and {@link ValueWidth#BITS_8}.
1137      *
<span class="line-modified">1138      * @stable ICU 63</span>

1139      */
1140     public static final class Fast8 extends Fast {
1141         private final byte[] dataArray;
1142 
1143         Fast8(char[] index, byte[] data8, int highStart,
1144                 int index3NullOffset, int dataNullOffset) {
1145             super(index, new Data8(data8), highStart, index3NullOffset, dataNullOffset);
1146             this.dataArray = data8;
1147         }
1148 
1149         /**
1150          * Creates a trie from its binary form.
1151          * Same as {@link CodePointTrie#fromBinary(Type, ValueWidth, ByteBuffer)}
1152          * with {@link Type#FAST} and {@link ValueWidth#BITS_8}.
1153          *
1154          * @param bytes a buffer containing the binary data of a CodePointTrie
1155          * @return the trie
<span class="line-modified">1156          * @stable ICU 63</span>

1157          */
1158         public static Fast8 fromBinary(ByteBuffer bytes) {
1159             return (Fast8) CodePointTrie.fromBinary(Type.FAST, ValueWidth.BITS_8, bytes);
1160         }
1161 
1162         /**
1163          * {@inheritDoc}
<span class="line-modified">1164          * @stable ICU 63</span>

1165          */
1166         @Override
1167         public final int get(int c) {
1168             return dataArray[cpIndex(c)] &amp; 0xff;
1169         }
1170 
1171         /**
1172          * {@inheritDoc}
<span class="line-modified">1173          * @stable ICU 63</span>

1174          */
1175         @Override
1176         public final int bmpGet(int c) {
1177             assert 0 &lt;= c &amp;&amp; c &lt;= 0xffff;
1178             return dataArray[fastIndex(c)] &amp; 0xff;
1179         }
1180 
1181         /**
1182          * {@inheritDoc}
<span class="line-modified">1183          * @stable ICU 63</span>

1184          */
1185         @Override
1186         public final int suppGet(int c) {
1187             assert 0x10000 &lt;= c &amp;&amp; c &lt;= 0x10ffff;
1188             return dataArray[smallIndex(Type.FAST, c)] &amp; 0xff;
1189         }
1190     }
1191 
1192     /**
1193      * A CodePointTrie with {@link Type#SMALL} and {@link ValueWidth#BITS_16}.
1194      *
<span class="line-modified">1195      * @stable ICU 63</span>

1196      */
1197     public static final class Small16 extends Small {
1198         Small16(char[] index, char[] data16, int highStart,
1199                 int index3NullOffset, int dataNullOffset) {
1200             super(index, new Data16(data16), highStart, index3NullOffset, dataNullOffset);
1201         }
1202 
1203         /**
1204          * Creates a trie from its binary form.
1205          * Same as {@link CodePointTrie#fromBinary(Type, ValueWidth, ByteBuffer)}
1206          * with {@link Type#SMALL} and {@link ValueWidth#BITS_16}.
1207          *
1208          * @param bytes a buffer containing the binary data of a CodePointTrie
1209          * @return the trie
<span class="line-modified">1210          * @stable ICU 63</span>

1211          */
1212         public static Small16 fromBinary(ByteBuffer bytes) {
1213             return (Small16) CodePointTrie.fromBinary(Type.SMALL, ValueWidth.BITS_16, bytes);
1214         }
1215     }
1216 
1217     /**
1218      * A CodePointTrie with {@link Type#SMALL} and {@link ValueWidth#BITS_32}.
1219      *
<span class="line-modified">1220      * @stable ICU 63</span>

1221      */
1222     public static final class Small32 extends Small {
1223         Small32(char[] index, int[] data32, int highStart,
1224                 int index3NullOffset, int dataNullOffset) {
1225             super(index, new Data32(data32), highStart, index3NullOffset, dataNullOffset);
1226         }
1227 
1228         /**
1229          * Creates a trie from its binary form.
1230          * Same as {@link CodePointTrie#fromBinary(Type, ValueWidth, ByteBuffer)}
1231          * with {@link Type#SMALL} and {@link ValueWidth#BITS_32}.
1232          *
1233          * @param bytes a buffer containing the binary data of a CodePointTrie
1234          * @return the trie
<span class="line-modified">1235          * @stable ICU 63</span>

1236          */
1237         public static Small32 fromBinary(ByteBuffer bytes) {
1238             return (Small32) CodePointTrie.fromBinary(Type.SMALL, ValueWidth.BITS_32, bytes);
1239         }
1240     }
1241 
1242     /**
1243      * A CodePointTrie with {@link Type#SMALL} and {@link ValueWidth#BITS_8}.
1244      *
<span class="line-modified">1245      * @stable ICU 63</span>

1246      */
1247     public static final class Small8 extends Small {
1248         Small8(char[] index, byte[] data8, int highStart,
1249                 int index3NullOffset, int dataNullOffset) {
1250             super(index, new Data8(data8), highStart, index3NullOffset, dataNullOffset);
1251         }
1252 
1253         /**
1254          * Creates a trie from its binary form.
1255          * Same as {@link CodePointTrie#fromBinary(Type, ValueWidth, ByteBuffer)}
1256          * with {@link Type#SMALL} and {@link ValueWidth#BITS_8}.
1257          *
1258          * @param bytes a buffer containing the binary data of a CodePointTrie
1259          * @return the trie
<span class="line-modified">1260          * @stable ICU 63</span>

1261          */
1262         public static Small8 fromBinary(ByteBuffer bytes) {
1263             return (Small8) CodePointTrie.fromBinary(Type.SMALL, ValueWidth.BITS_8, bytes);
1264         }
1265     }
1266 }
</pre>
</td>
</tr>
</table>
<center><a href="CodePointMap.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="VersionInfo.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>