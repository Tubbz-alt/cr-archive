<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/jdk.incubator.jpackage/macosx/classes/jdk/incubator/jpackage/internal/MacDmgBundler.java</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="MacBaseInstallerBundler.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="MacPkgBundler.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/jdk.incubator.jpackage/macosx/classes/jdk/incubator/jpackage/internal/MacDmgBundler.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 14  * version 2 for more details (a copy is included in the LICENSE file that
 15  * accompanied this code).
 16  *
 17  * You should have received a copy of the GNU General Public License version
 18  * 2 along with this work; if not, write to the Free Software Foundation,
 19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 20  *
 21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 22  * or visit www.oracle.com if you need additional information or have any
 23  * questions.
 24  */
 25 
 26 package jdk.incubator.jpackage.internal;
 27 
 28 import java.io.*;
 29 import java.nio.file.Files;
 30 import java.nio.file.Path;
 31 import java.text.MessageFormat;
 32 import java.util.*;
 33 import static jdk.incubator.jpackage.internal.MacAppImageBuilder.ICON_ICNS;

 34 import static jdk.incubator.jpackage.internal.OverridableResource.createResource;
 35 
 36 import static jdk.incubator.jpackage.internal.StandardBundlerParam.*;
 37 
 38 public class MacDmgBundler extends MacBaseInstallerBundler {
 39 
 40     private static final ResourceBundle I18N = ResourceBundle.getBundle(
 41             &quot;jdk.incubator.jpackage.internal.resources.MacResources&quot;);
 42 
 43     // Background image name in resources
 44     static final String DEFAULT_BACKGROUND_IMAGE = &quot;background_dmg.tiff&quot;;
 45     // Backround image name and folder under which it will be stored in DMG
 46     static final String BACKGROUND_IMAGE_FOLDER =&quot;.background&quot;;
 47     static final String BACKGROUND_IMAGE = &quot;background.tiff&quot;;
 48     static final String DEFAULT_DMG_SETUP_SCRIPT = &quot;DMGsetup.scpt&quot;;
 49     static final String TEMPLATE_BUNDLE_ICON = &quot;java.icns&quot;;
 50 
 51     static final String DEFAULT_LICENSE_PLIST=&quot;lic_template.plist&quot;;
 52 
 53     public static final BundlerParamInfo&lt;String&gt; INSTALLER_SUFFIX =
</pre>
<hr />
<pre>
 99         // We need to use URL for DMG to find it. We cannot use volume name, since
100         // user might have open DMG with same volume name already. Url should end with
101         // &#39;/&#39; and it should be real path (no symbolic links).
102         File imageDir = IMAGES_ROOT.fetchFrom(params);
103         if (!imageDir.exists()) imageDir.mkdirs(); // Create it, since it does not exist
104         Path rootPath = Path.of(imageDir.toString()).toRealPath();
105         Path volumePath = rootPath.resolve(APP_NAME.fetchFrom(params));
106         String volumeUrl = volumePath.toUri().toString() + File.separator;
107 
108         // Provide full path to backround image, so we can find it.
109         Path bgFile = Path.of(rootPath.toString(), APP_NAME.fetchFrom(params),
110                               BACKGROUND_IMAGE_FOLDER, BACKGROUND_IMAGE);
111 
112         //prepare config for exe
113         Map&lt;String, String&gt; data = new HashMap&lt;&gt;();
114         data.put(&quot;DEPLOY_VOLUME_URL&quot;, volumeUrl);
115         data.put(&quot;DEPLOY_BG_FILE&quot;, bgFile.toString());
116         data.put(&quot;DEPLOY_VOLUME_PATH&quot;, volumePath.toString());
117         data.put(&quot;DEPLOY_APPLICATION_NAME&quot;, APP_NAME.fetchFrom(params));
118 
<span class="line-modified">119         data.put(&quot;DEPLOY_INSTALL_LOCATION&quot;, &quot;(path to applications folder)&quot;);</span>
<span class="line-modified">120         data.put(&quot;DEPLOY_INSTALL_NAME&quot;, &quot;Applications&quot;);</span>
121 
122         createResource(DEFAULT_DMG_SETUP_SCRIPT, params)
123                 .setCategory(I18N.getString(&quot;resource.dmg-setup-script&quot;))
124                 .setSubstitutionData(data)
125                 .saveToFile(dmgSetup);
126     }
127 
128     private File getConfig_VolumeScript(Map&lt;String, ? super Object&gt; params) {
129         return new File(CONFIG_ROOT.fetchFrom(params),
130                 APP_NAME.fetchFrom(params) + &quot;-dmg-setup.scpt&quot;);
131     }
132 
133     private File getConfig_VolumeBackground(
134             Map&lt;String, ? super Object&gt; params) {
135         return new File(CONFIG_ROOT.fetchFrom(params),
136                 APP_NAME.fetchFrom(params) + &quot;-background.tiff&quot;);
137     }
138 
139     private File getConfig_VolumeIcon(Map&lt;String, ? super Object&gt; params) {
140         return new File(CONFIG_ROOT.fetchFrom(params),
</pre>
<hr />
<pre>
292                 &quot;create&quot;,
293                 hdiUtilVerbosityFlag,
294                 &quot;-srcfolder&quot;, srcFolder.getAbsolutePath(),
295                 &quot;-volname&quot;, APP_NAME.fetchFrom(params),
296                 &quot;-ov&quot;, protoDMG.getAbsolutePath(),
297                 &quot;-fs&quot;, &quot;HFS+&quot;,
298                 &quot;-format&quot;, &quot;UDRW&quot;);
299         IOUtils.exec(pb);
300 
301         // mount temp image
302         pb = new ProcessBuilder(
303                 hdiutil,
304                 &quot;attach&quot;,
305                 protoDMG.getAbsolutePath(),
306                 hdiUtilVerbosityFlag,
307                 &quot;-mountroot&quot;, imagesRoot.getAbsolutePath());
308         IOUtils.exec(pb, false, null, true);
309 
310         File mountedRoot = new File(imagesRoot.getAbsolutePath(),
311                     APP_NAME.fetchFrom(params));
<span class="line-removed">312 </span>
313         try {
<span class="line-removed">314             // volume icon</span>
<span class="line-removed">315             File volumeIconFile = new File(mountedRoot, &quot;.VolumeIcon.icns&quot;);</span>
<span class="line-removed">316             IOUtils.copyFile(getConfig_VolumeIcon(params),</span>
<span class="line-removed">317                     volumeIconFile);</span>
<span class="line-removed">318 </span>
319             // background image
320             File bgdir = new File(mountedRoot, BACKGROUND_IMAGE_FOLDER);
321             bgdir.mkdirs();
322             IOUtils.copyFile(getConfig_VolumeBackground(params),
323                     new File(bgdir, BACKGROUND_IMAGE));
324 
















325             // Indicate that we want a custom icon
326             // NB: attributes of the root directory are ignored
327             // when creating the volume
328             // Therefore we have to do this after we mount image
329             String setFileUtility = findSetFileUtility();
330             if (setFileUtility != null) {
331                 //can not find utility =&gt; keep going without icon
332                 try {
333                     volumeIconFile.setWritable(true);
334                     // The &quot;creator&quot; attribute on a file is a legacy attribute
335                     // but it seems Finder excepts these bytes to be
336                     // &quot;icnC&quot; for the volume icon
337                     // (might not work on Mac 10.13 with old XCode)
338                     pb = new ProcessBuilder(
339                             setFileUtility,
340                             &quot;-c&quot;, &quot;icnC&quot;,
341                             volumeIconFile.getAbsolutePath());
342                     IOUtils.exec(pb);
343                     volumeIconFile.setReadOnly();
344 
345                     pb = new ProcessBuilder(
346                             setFileUtility,
347                             &quot;-a&quot;, &quot;C&quot;,
348                             mountedRoot.getAbsolutePath());
349                     IOUtils.exec(pb);
350                 } catch (IOException ex) {
351                     Log.error(ex.getMessage());
352                     Log.verbose(&quot;Cannot enable custom icon using SetFile utility&quot;);
353                 }
354             } else {
355                 Log.verbose(I18N.getString(&quot;message.setfile.dmg&quot;));
356             }
357 
<span class="line-removed">358             // We will not consider setting background image and creating link to</span>
<span class="line-removed">359             // /Application folder in DMG as critical error, since it can fail in</span>
<span class="line-removed">360             // headless enviroment.</span>
<span class="line-removed">361             try {</span>
<span class="line-removed">362                 pb = new ProcessBuilder(&quot;osascript&quot;,</span>
<span class="line-removed">363                         getConfig_VolumeScript(params).getAbsolutePath());</span>
<span class="line-removed">364                 IOUtils.exec(pb);</span>
<span class="line-removed">365             } catch (IOException ex) {</span>
<span class="line-removed">366                 Log.verbose(ex);</span>
<span class="line-removed">367             }</span>
368         } finally {
369             // Detach the temporary image
370             pb = new ProcessBuilder(
371                     hdiutil,
372                     &quot;detach&quot;,
373                     &quot;-force&quot;,
374                     hdiUtilVerbosityFlag,
375                     mountedRoot.getAbsolutePath());
376             IOUtils.exec(pb);
377         }
378 
379         // Compress it to a new image
380         pb = new ProcessBuilder(
381                 hdiutil,
382                 &quot;convert&quot;,
383                 protoDMG.getAbsolutePath(),
384                 hdiUtilVerbosityFlag,
385                 &quot;-format&quot;, &quot;UDZO&quot;,
386                 &quot;-o&quot;, finalDMG.getAbsolutePath());
387         IOUtils.exec(pb);
</pre>
<hr />
<pre>
475     public final static String[] required =
476             {&quot;/usr/bin/hdiutil&quot;, &quot;/usr/bin/osascript&quot;};
477     public static boolean isSupported() {
478         try {
479             for (String s : required) {
480                 File f = new File(s);
481                 if (!f.exists() || !f.canExecute()) {
482                     return false;
483                 }
484             }
485             return true;
486         } catch (Exception e) {
487             return false;
488         }
489     }
490 
491     @Override
492     public boolean isDefault() {
493         return true;
494     }
<span class="line-removed">495 </span>
496 }
</pre>
</td>
<td>
<hr />
<pre>
 14  * version 2 for more details (a copy is included in the LICENSE file that
 15  * accompanied this code).
 16  *
 17  * You should have received a copy of the GNU General Public License version
 18  * 2 along with this work; if not, write to the Free Software Foundation,
 19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 20  *
 21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 22  * or visit www.oracle.com if you need additional information or have any
 23  * questions.
 24  */
 25 
 26 package jdk.incubator.jpackage.internal;
 27 
 28 import java.io.*;
 29 import java.nio.file.Files;
 30 import java.nio.file.Path;
 31 import java.text.MessageFormat;
 32 import java.util.*;
 33 import static jdk.incubator.jpackage.internal.MacAppImageBuilder.ICON_ICNS;
<span class="line-added"> 34 import static jdk.incubator.jpackage.internal.MacAppImageBuilder.MAC_CF_BUNDLE_IDENTIFIER;</span>
 35 import static jdk.incubator.jpackage.internal.OverridableResource.createResource;
 36 
 37 import static jdk.incubator.jpackage.internal.StandardBundlerParam.*;
 38 
 39 public class MacDmgBundler extends MacBaseInstallerBundler {
 40 
 41     private static final ResourceBundle I18N = ResourceBundle.getBundle(
 42             &quot;jdk.incubator.jpackage.internal.resources.MacResources&quot;);
 43 
 44     // Background image name in resources
 45     static final String DEFAULT_BACKGROUND_IMAGE = &quot;background_dmg.tiff&quot;;
 46     // Backround image name and folder under which it will be stored in DMG
 47     static final String BACKGROUND_IMAGE_FOLDER =&quot;.background&quot;;
 48     static final String BACKGROUND_IMAGE = &quot;background.tiff&quot;;
 49     static final String DEFAULT_DMG_SETUP_SCRIPT = &quot;DMGsetup.scpt&quot;;
 50     static final String TEMPLATE_BUNDLE_ICON = &quot;java.icns&quot;;
 51 
 52     static final String DEFAULT_LICENSE_PLIST=&quot;lic_template.plist&quot;;
 53 
 54     public static final BundlerParamInfo&lt;String&gt; INSTALLER_SUFFIX =
</pre>
<hr />
<pre>
100         // We need to use URL for DMG to find it. We cannot use volume name, since
101         // user might have open DMG with same volume name already. Url should end with
102         // &#39;/&#39; and it should be real path (no symbolic links).
103         File imageDir = IMAGES_ROOT.fetchFrom(params);
104         if (!imageDir.exists()) imageDir.mkdirs(); // Create it, since it does not exist
105         Path rootPath = Path.of(imageDir.toString()).toRealPath();
106         Path volumePath = rootPath.resolve(APP_NAME.fetchFrom(params));
107         String volumeUrl = volumePath.toUri().toString() + File.separator;
108 
109         // Provide full path to backround image, so we can find it.
110         Path bgFile = Path.of(rootPath.toString(), APP_NAME.fetchFrom(params),
111                               BACKGROUND_IMAGE_FOLDER, BACKGROUND_IMAGE);
112 
113         //prepare config for exe
114         Map&lt;String, String&gt; data = new HashMap&lt;&gt;();
115         data.put(&quot;DEPLOY_VOLUME_URL&quot;, volumeUrl);
116         data.put(&quot;DEPLOY_BG_FILE&quot;, bgFile.toString());
117         data.put(&quot;DEPLOY_VOLUME_PATH&quot;, volumePath.toString());
118         data.put(&quot;DEPLOY_APPLICATION_NAME&quot;, APP_NAME.fetchFrom(params));
119 
<span class="line-modified">120         data.put(&quot;DEPLOY_INSTALL_LOCATION&quot;, MAC_INSTALL_DIR.fetchFrom(params));</span>
<span class="line-modified">121         data.put(&quot;DEPLOY_INSTALL_NAME&quot;, MAC_INSTALL_DIR.fetchFrom(params));</span>
122 
123         createResource(DEFAULT_DMG_SETUP_SCRIPT, params)
124                 .setCategory(I18N.getString(&quot;resource.dmg-setup-script&quot;))
125                 .setSubstitutionData(data)
126                 .saveToFile(dmgSetup);
127     }
128 
129     private File getConfig_VolumeScript(Map&lt;String, ? super Object&gt; params) {
130         return new File(CONFIG_ROOT.fetchFrom(params),
131                 APP_NAME.fetchFrom(params) + &quot;-dmg-setup.scpt&quot;);
132     }
133 
134     private File getConfig_VolumeBackground(
135             Map&lt;String, ? super Object&gt; params) {
136         return new File(CONFIG_ROOT.fetchFrom(params),
137                 APP_NAME.fetchFrom(params) + &quot;-background.tiff&quot;);
138     }
139 
140     private File getConfig_VolumeIcon(Map&lt;String, ? super Object&gt; params) {
141         return new File(CONFIG_ROOT.fetchFrom(params),
</pre>
<hr />
<pre>
293                 &quot;create&quot;,
294                 hdiUtilVerbosityFlag,
295                 &quot;-srcfolder&quot;, srcFolder.getAbsolutePath(),
296                 &quot;-volname&quot;, APP_NAME.fetchFrom(params),
297                 &quot;-ov&quot;, protoDMG.getAbsolutePath(),
298                 &quot;-fs&quot;, &quot;HFS+&quot;,
299                 &quot;-format&quot;, &quot;UDRW&quot;);
300         IOUtils.exec(pb);
301 
302         // mount temp image
303         pb = new ProcessBuilder(
304                 hdiutil,
305                 &quot;attach&quot;,
306                 protoDMG.getAbsolutePath(),
307                 hdiUtilVerbosityFlag,
308                 &quot;-mountroot&quot;, imagesRoot.getAbsolutePath());
309         IOUtils.exec(pb, false, null, true);
310 
311         File mountedRoot = new File(imagesRoot.getAbsolutePath(),
312                     APP_NAME.fetchFrom(params));

313         try {





314             // background image
315             File bgdir = new File(mountedRoot, BACKGROUND_IMAGE_FOLDER);
316             bgdir.mkdirs();
317             IOUtils.copyFile(getConfig_VolumeBackground(params),
318                     new File(bgdir, BACKGROUND_IMAGE));
319 
<span class="line-added">320             // We will not consider setting background image and creating link</span>
<span class="line-added">321             // to install-dir in DMG as critical error, since it can fail in</span>
<span class="line-added">322             // headless enviroment.</span>
<span class="line-added">323             try {</span>
<span class="line-added">324                 pb = new ProcessBuilder(&quot;osascript&quot;,</span>
<span class="line-added">325                         getConfig_VolumeScript(params).getAbsolutePath());</span>
<span class="line-added">326                 IOUtils.exec(pb);</span>
<span class="line-added">327             } catch (IOException ex) {</span>
<span class="line-added">328                 Log.verbose(ex);</span>
<span class="line-added">329             }</span>
<span class="line-added">330 </span>
<span class="line-added">331             // volume icon</span>
<span class="line-added">332             File volumeIconFile = new File(mountedRoot, &quot;.VolumeIcon.icns&quot;);</span>
<span class="line-added">333             IOUtils.copyFile(getConfig_VolumeIcon(params),</span>
<span class="line-added">334                     volumeIconFile);</span>
<span class="line-added">335 </span>
336             // Indicate that we want a custom icon
337             // NB: attributes of the root directory are ignored
338             // when creating the volume
339             // Therefore we have to do this after we mount image
340             String setFileUtility = findSetFileUtility();
341             if (setFileUtility != null) {
342                 //can not find utility =&gt; keep going without icon
343                 try {
344                     volumeIconFile.setWritable(true);
345                     // The &quot;creator&quot; attribute on a file is a legacy attribute
346                     // but it seems Finder excepts these bytes to be
347                     // &quot;icnC&quot; for the volume icon
348                     // (might not work on Mac 10.13 with old XCode)
349                     pb = new ProcessBuilder(
350                             setFileUtility,
351                             &quot;-c&quot;, &quot;icnC&quot;,
352                             volumeIconFile.getAbsolutePath());
353                     IOUtils.exec(pb);
354                     volumeIconFile.setReadOnly();
355 
356                     pb = new ProcessBuilder(
357                             setFileUtility,
358                             &quot;-a&quot;, &quot;C&quot;,
359                             mountedRoot.getAbsolutePath());
360                     IOUtils.exec(pb);
361                 } catch (IOException ex) {
362                     Log.error(ex.getMessage());
363                     Log.verbose(&quot;Cannot enable custom icon using SetFile utility&quot;);
364                 }
365             } else {
366                 Log.verbose(I18N.getString(&quot;message.setfile.dmg&quot;));
367             }
368 










369         } finally {
370             // Detach the temporary image
371             pb = new ProcessBuilder(
372                     hdiutil,
373                     &quot;detach&quot;,
374                     &quot;-force&quot;,
375                     hdiUtilVerbosityFlag,
376                     mountedRoot.getAbsolutePath());
377             IOUtils.exec(pb);
378         }
379 
380         // Compress it to a new image
381         pb = new ProcessBuilder(
382                 hdiutil,
383                 &quot;convert&quot;,
384                 protoDMG.getAbsolutePath(),
385                 hdiUtilVerbosityFlag,
386                 &quot;-format&quot;, &quot;UDZO&quot;,
387                 &quot;-o&quot;, finalDMG.getAbsolutePath());
388         IOUtils.exec(pb);
</pre>
<hr />
<pre>
476     public final static String[] required =
477             {&quot;/usr/bin/hdiutil&quot;, &quot;/usr/bin/osascript&quot;};
478     public static boolean isSupported() {
479         try {
480             for (String s : required) {
481                 File f = new File(s);
482                 if (!f.exists() || !f.canExecute()) {
483                     return false;
484                 }
485             }
486             return true;
487         } catch (Exception e) {
488             return false;
489         }
490     }
491 
492     @Override
493     public boolean isDefault() {
494         return true;
495     }

496 }
</pre>
</td>
</tr>
</table>
<center><a href="MacBaseInstallerBundler.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="MacPkgBundler.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>