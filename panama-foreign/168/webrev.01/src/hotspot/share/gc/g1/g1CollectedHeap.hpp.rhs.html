<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames src/hotspot/share/gc/g1/g1CollectedHeap.hpp</title>
    <link rel="stylesheet" href="../../../../../style.css" />
    <script type="text/javascript" src="../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>   1 /*
   2  * Copyright (c) 2001, 2020, Oracle and/or its affiliates. All rights reserved.
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.
   8  *
   9  * This code is distributed in the hope that it will be useful, but WITHOUT
  10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  *
  23  */
  24 
  25 #ifndef SHARE_GC_G1_G1COLLECTEDHEAP_HPP
  26 #define SHARE_GC_G1_G1COLLECTEDHEAP_HPP
  27 
  28 #include &quot;gc/g1/g1BarrierSet.hpp&quot;
  29 #include &quot;gc/g1/g1BiasedArray.hpp&quot;
  30 #include &quot;gc/g1/g1CardTable.hpp&quot;
  31 #include &quot;gc/g1/g1CollectionSet.hpp&quot;
  32 #include &quot;gc/g1/g1CollectorState.hpp&quot;
  33 #include &quot;gc/g1/g1ConcurrentMark.hpp&quot;
  34 #include &quot;gc/g1/g1EdenRegions.hpp&quot;
  35 #include &quot;gc/g1/g1EvacFailure.hpp&quot;
  36 #include &quot;gc/g1/g1EvacStats.hpp&quot;
  37 #include &quot;gc/g1/g1EvacuationInfo.hpp&quot;
  38 #include &quot;gc/g1/g1GCPhaseTimes.hpp&quot;
  39 #include &quot;gc/g1/g1HeapTransition.hpp&quot;
  40 #include &quot;gc/g1/g1HeapVerifier.hpp&quot;
  41 #include &quot;gc/g1/g1HRPrinter.hpp&quot;
  42 #include &quot;gc/g1/g1HeapRegionAttr.hpp&quot;
  43 #include &quot;gc/g1/g1MonitoringSupport.hpp&quot;
  44 #include &quot;gc/g1/g1NUMA.hpp&quot;
  45 #include &quot;gc/g1/g1RedirtyCardsQueue.hpp&quot;
  46 #include &quot;gc/g1/g1SurvivorRegions.hpp&quot;
  47 #include &quot;gc/g1/g1YCTypes.hpp&quot;
  48 #include &quot;gc/g1/heapRegionManager.hpp&quot;
  49 #include &quot;gc/g1/heapRegionSet.hpp&quot;
  50 #include &quot;gc/g1/heterogeneousHeapRegionManager.hpp&quot;
  51 #include &quot;gc/shared/barrierSet.hpp&quot;
  52 #include &quot;gc/shared/collectedHeap.hpp&quot;
  53 #include &quot;gc/shared/gcHeapSummary.hpp&quot;
  54 #include &quot;gc/shared/plab.hpp&quot;
  55 #include &quot;gc/shared/preservedMarks.hpp&quot;
  56 #include &quot;gc/shared/softRefPolicy.hpp&quot;
<a name="1" id="anc1"></a><span class="line-added">  57 #include &quot;gc/shared/taskqueue.hpp&quot;</span>
  58 #include &quot;memory/memRegion.hpp&quot;
  59 #include &quot;utilities/stack.hpp&quot;
  60 
  61 // A &quot;G1CollectedHeap&quot; is an implementation of a java heap for HotSpot.
  62 // It uses the &quot;Garbage First&quot; heap organization and algorithm, which
  63 // may combine concurrent marking with parallel, incremental compaction of
  64 // heap subsets that will yield large amounts of garbage.
  65 
  66 // Forward declarations
  67 class HeapRegion;
  68 class GenerationSpec;
  69 class G1ParScanThreadState;
  70 class G1ParScanThreadStateSet;
  71 class G1ParScanThreadState;
  72 class MemoryPool;
  73 class MemoryManager;
  74 class ObjectClosure;
  75 class SpaceClosure;
  76 class CompactibleSpaceClosure;
  77 class Space;
  78 class G1CardTableEntryClosure;
  79 class G1CollectionSet;
  80 class G1Policy;
  81 class G1HotCardCache;
  82 class G1RemSet;
  83 class G1YoungRemSetSamplingThread;
  84 class G1ConcurrentMark;
  85 class G1ConcurrentMarkThread;
  86 class G1ConcurrentRefine;
  87 class GenerationCounters;
  88 class STWGCTimer;
  89 class G1NewTracer;
  90 class EvacuationFailedInfo;
  91 class nmethod;
  92 class WorkGang;
  93 class G1Allocator;
  94 class G1ArchiveAllocator;
  95 class G1FullGCScope;
  96 class G1HeapVerifier;
  97 class G1HeapSizingPolicy;
  98 class G1HeapSummary;
  99 class G1EvacSummary;
 100 
<a name="2" id="anc2"></a><span class="line-modified"> 101 typedef OverflowTaskQueue&lt;ScannerTask, mtGC&gt;         ScannerTasksQueue;</span>
<span class="line-modified"> 102 typedef GenericTaskQueueSet&lt;ScannerTasksQueue, mtGC&gt; ScannerTasksQueueSet;</span>
 103 
 104 typedef int RegionIdx_t;   // needs to hold [ 0..max_regions() )
 105 typedef int CardIdx_t;     // needs to hold [ 0..CardsPerRegion )
 106 
 107 // The G1 STW is alive closure.
 108 // An instance is embedded into the G1CH and used as the
 109 // (optional) _is_alive_non_header closure in the STW
 110 // reference processor. It is also extensively used during
 111 // reference processing during STW evacuation pauses.
 112 class G1STWIsAliveClosure : public BoolObjectClosure {
 113   G1CollectedHeap* _g1h;
 114 public:
 115   G1STWIsAliveClosure(G1CollectedHeap* g1h) : _g1h(g1h) {}
 116   bool do_object_b(oop p);
 117 };
 118 
 119 class G1STWSubjectToDiscoveryClosure : public BoolObjectClosure {
 120   G1CollectedHeap* _g1h;
 121 public:
 122   G1STWSubjectToDiscoveryClosure(G1CollectedHeap* g1h) : _g1h(g1h) {}
 123   bool do_object_b(oop p);
 124 };
 125 
 126 class G1RegionMappingChangedListener : public G1MappingChangedListener {
 127  private:
 128   void reset_from_card_cache(uint start_idx, size_t num_regions);
 129  public:
 130   virtual void on_commit(uint start_idx, size_t num_regions, bool zero_filled);
 131 };
 132 
 133 class G1CollectedHeap : public CollectedHeap {
 134   friend class VM_CollectForMetadataAllocation;
 135   friend class VM_G1CollectForAllocation;
 136   friend class VM_G1CollectFull;
 137   friend class VM_G1TryInitiateConcMark;
 138   friend class VMStructs;
 139   friend class MutatorAllocRegion;
 140   friend class G1FullCollector;
 141   friend class G1GCAllocRegion;
 142   friend class G1HeapVerifier;
 143 
 144   // Closures used in implementation.
 145   friend class G1ParScanThreadState;
 146   friend class G1ParScanThreadStateSet;
 147   friend class G1EvacuateRegionsTask;
 148   friend class G1PLABAllocator;
 149 
 150   // Other related classes.
 151   friend class HeapRegionClaimer;
 152 
 153   // Testing classes.
 154   friend class G1CheckRegionAttrTableClosure;
 155 
 156 private:
 157   G1YoungRemSetSamplingThread* _young_gen_sampling_thread;
 158 
 159   WorkGang* _workers;
 160   G1CardTable* _card_table;
 161 
 162   SoftRefPolicy      _soft_ref_policy;
 163 
 164   static size_t _humongous_object_threshold_in_words;
 165 
 166   // These sets keep track of old, archive and humongous regions respectively.
 167   HeapRegionSet _old_set;
 168   HeapRegionSet _archive_set;
 169   HeapRegionSet _humongous_set;
 170 
 171   void eagerly_reclaim_humongous_regions();
 172   // Start a new incremental collection set for the next pause.
 173   void start_new_collection_set();
 174 
 175   // The block offset table for the G1 heap.
 176   G1BlockOffsetTable* _bot;
 177 
 178   // Tears down the region sets / lists so that they are empty and the
 179   // regions on the heap do not belong to a region set / list. The
 180   // only exception is the humongous set which we leave unaltered. If
 181   // free_list_only is true, it will only tear down the master free
 182   // list. It is called before a Full GC (free_list_only == false) or
 183   // before heap shrinking (free_list_only == true).
 184   void tear_down_region_sets(bool free_list_only);
 185 
 186   // Rebuilds the region sets / lists so that they are repopulated to
 187   // reflect the contents of the heap. The only exception is the
 188   // humongous set which was not torn down in the first place. If
 189   // free_list_only is true, it will only rebuild the master free
 190   // list. It is called after a Full GC (free_list_only == false) or
 191   // after heap shrinking (free_list_only == true).
 192   void rebuild_region_sets(bool free_list_only);
 193 
 194   // Callback for region mapping changed events.
 195   G1RegionMappingChangedListener _listener;
 196 
 197   // Handle G1 NUMA support.
 198   G1NUMA* _numa;
 199 
 200   // The sequence of all heap regions in the heap.
 201   HeapRegionManager* _hrm;
 202 
 203   // Manages all allocations with regions except humongous object allocations.
 204   G1Allocator* _allocator;
 205 
 206   // Manages all heap verification.
 207   G1HeapVerifier* _verifier;
 208 
 209   // Outside of GC pauses, the number of bytes used in all regions other
 210   // than the current allocation region(s).
 211   volatile size_t _summary_bytes_used;
 212 
 213   void increase_used(size_t bytes);
 214   void decrease_used(size_t bytes);
 215 
 216   void set_used(size_t bytes);
 217 
 218   // Number of bytes used in all regions during GC. Typically changed when
 219   // retiring a GC alloc region.
 220   size_t _bytes_used_during_gc;
 221 
 222   // Class that handles archive allocation ranges.
 223   G1ArchiveAllocator* _archive_allocator;
 224 
 225   // GC allocation statistics policy for survivors.
 226   G1EvacStats _survivor_evac_stats;
 227 
 228   // GC allocation statistics policy for tenured objects.
 229   G1EvacStats _old_evac_stats;
 230 
 231   // It specifies whether we should attempt to expand the heap after a
 232   // region allocation failure. If heap expansion fails we set this to
 233   // false so that we don&#39;t re-attempt the heap expansion (it&#39;s likely
 234   // that subsequent expansion attempts will also fail if one fails).
 235   // Currently, it is only consulted during GC and it&#39;s reset at the
 236   // start of each GC.
 237   bool _expand_heap_after_alloc_failure;
 238 
 239   // Helper for monitoring and management support.
 240   G1MonitoringSupport* _g1mm;
 241 
 242   // Records whether the region at the given index is (still) a
 243   // candidate for eager reclaim.  Only valid for humongous start
 244   // regions; other regions have unspecified values.  Humongous start
 245   // regions are initialized at start of collection pause, with
 246   // candidates removed from the set as they are found reachable from
 247   // roots or the young generation.
 248   class HumongousReclaimCandidates : public G1BiasedMappedArray&lt;bool&gt; {
 249    protected:
 250     bool default_value() const { return false; }
 251    public:
 252     void clear() { G1BiasedMappedArray&lt;bool&gt;::clear(); }
 253     void set_candidate(uint region, bool value) {
 254       set_by_index(region, value);
 255     }
 256     bool is_candidate(uint region) {
 257       return get_by_index(region);
 258     }
 259   };
 260 
 261   HumongousReclaimCandidates _humongous_reclaim_candidates;
 262   // Stores whether during humongous object registration we found candidate regions.
 263   // If not, we can skip a few steps.
 264   bool _has_humongous_reclaim_candidates;
 265 
 266   G1HRPrinter _hr_printer;
 267 
 268   // Return true if an explicit GC should start a concurrent cycle instead
 269   // of doing a STW full GC. A concurrent cycle should be started if:
 270   // (a) cause == _g1_humongous_allocation,
 271   // (b) cause == _java_lang_system_gc and +ExplicitGCInvokesConcurrent,
 272   // (c) cause == _dcmd_gc_run and +ExplicitGCInvokesConcurrent,
 273   // (d) cause == _wb_conc_mark or _wb_breakpoint,
 274   // (e) cause == _g1_periodic_collection and +G1PeriodicGCInvokesConcurrent.
 275   bool should_do_concurrent_full_gc(GCCause::Cause cause);
 276 
 277   // Attempt to start a concurrent cycle with the indicated cause.
 278   // precondition: should_do_concurrent_full_gc(cause)
 279   bool try_collect_concurrently(GCCause::Cause cause,
 280                                 uint gc_counter,
 281                                 uint old_marking_started_before);
 282 
 283   // Return true if should upgrade to full gc after an incremental one.
 284   bool should_upgrade_to_full_gc(GCCause::Cause cause);
 285 
 286   // indicates whether we are in young or mixed GC mode
 287   G1CollectorState _collector_state;
 288 
 289   // Keeps track of how many &quot;old marking cycles&quot; (i.e., Full GCs or
 290   // concurrent cycles) we have started.
 291   volatile uint _old_marking_cycles_started;
 292 
 293   // Keeps track of how many &quot;old marking cycles&quot; (i.e., Full GCs or
 294   // concurrent cycles) we have completed.
 295   volatile uint _old_marking_cycles_completed;
 296 
 297   // This is a non-product method that is helpful for testing. It is
 298   // called at the end of a GC and artificially expands the heap by
 299   // allocating a number of dead regions. This way we can induce very
 300   // frequent marking cycles and stress the cleanup / concurrent
 301   // cleanup code more (as all the regions that will be allocated by
 302   // this method will be found dead by the marking cycle).
 303   void allocate_dummy_regions() PRODUCT_RETURN;
 304 
 305   // If the HR printer is active, dump the state of the regions in the
 306   // heap after a compaction.
 307   void print_hrm_post_compaction();
 308 
 309   // Create a memory mapper for auxiliary data structures of the given size and
 310   // translation factor.
 311   static G1RegionToSpaceMapper* create_aux_memory_mapper(const char* description,
 312                                                          size_t size,
 313                                                          size_t translation_factor);
 314 
 315   void trace_heap(GCWhen::Type when, const GCTracer* tracer);
 316 
 317   // These are macros so that, if the assert fires, we get the correct
 318   // line number, file, etc.
 319 
 320 #define heap_locking_asserts_params(_extra_message_)                          \
 321   &quot;%s : Heap_lock locked: %s, at safepoint: %s, is VM thread: %s&quot;,            \
 322   (_extra_message_),                                                          \
 323   BOOL_TO_STR(Heap_lock-&gt;owned_by_self()),                                    \
 324   BOOL_TO_STR(SafepointSynchronize::is_at_safepoint()),                       \
 325   BOOL_TO_STR(Thread::current()-&gt;is_VM_thread())
 326 
 327 #define assert_heap_locked()                                                  \
 328   do {                                                                        \
 329     assert(Heap_lock-&gt;owned_by_self(),                                        \
 330            heap_locking_asserts_params(&quot;should be holding the Heap_lock&quot;));   \
 331   } while (0)
 332 
 333 #define assert_heap_locked_or_at_safepoint(_should_be_vm_thread_)             \
 334   do {                                                                        \
 335     assert(Heap_lock-&gt;owned_by_self() ||                                      \
 336            (SafepointSynchronize::is_at_safepoint() &amp;&amp;                        \
 337              ((_should_be_vm_thread_) == Thread::current()-&gt;is_VM_thread())), \
 338            heap_locking_asserts_params(&quot;should be holding the Heap_lock or &quot;  \
 339                                         &quot;should be at a safepoint&quot;));         \
 340   } while (0)
 341 
 342 #define assert_heap_locked_and_not_at_safepoint()                             \
 343   do {                                                                        \
 344     assert(Heap_lock-&gt;owned_by_self() &amp;&amp;                                      \
 345                                     !SafepointSynchronize::is_at_safepoint(), \
 346           heap_locking_asserts_params(&quot;should be holding the Heap_lock and &quot;  \
 347                                        &quot;should not be at a safepoint&quot;));      \
 348   } while (0)
 349 
 350 #define assert_heap_not_locked()                                              \
 351   do {                                                                        \
 352     assert(!Heap_lock-&gt;owned_by_self(),                                       \
 353         heap_locking_asserts_params(&quot;should not be holding the Heap_lock&quot;));  \
 354   } while (0)
 355 
 356 #define assert_heap_not_locked_and_not_at_safepoint()                         \
 357   do {                                                                        \
 358     assert(!Heap_lock-&gt;owned_by_self() &amp;&amp;                                     \
 359                                     !SafepointSynchronize::is_at_safepoint(), \
 360       heap_locking_asserts_params(&quot;should not be holding the Heap_lock and &quot;  \
 361                                    &quot;should not be at a safepoint&quot;));          \
 362   } while (0)
 363 
 364 #define assert_at_safepoint_on_vm_thread()                                    \
 365   do {                                                                        \
 366     assert_at_safepoint();                                                    \
 367     assert(Thread::current_or_null() != NULL, &quot;no current thread&quot;);           \
 368     assert(Thread::current()-&gt;is_VM_thread(), &quot;current thread is not VM thread&quot;); \
 369   } while (0)
 370 
 371 #ifdef ASSERT
 372 #define assert_used_and_recalculate_used_equal(g1h)                           \
 373   do {                                                                        \
 374     size_t cur_used_bytes = g1h-&gt;used();                                      \
 375     size_t recal_used_bytes = g1h-&gt;recalculate_used();                        \
 376     assert(cur_used_bytes == recal_used_bytes, &quot;Used(&quot; SIZE_FORMAT &quot;) is not&quot; \
 377            &quot; same as recalculated used(&quot; SIZE_FORMAT &quot;).&quot;,                    \
 378            cur_used_bytes, recal_used_bytes);                                 \
 379   } while (0)
 380 #else
 381 #define assert_used_and_recalculate_used_equal(g1h) do {} while(0)
 382 #endif
 383 
 384   const char* young_gc_name() const;
 385 
 386   // The young region list.
 387   G1EdenRegions _eden;
 388   G1SurvivorRegions _survivor;
 389 
 390   STWGCTimer* _gc_timer_stw;
 391 
 392   G1NewTracer* _gc_tracer_stw;
 393 
 394   // The current policy object for the collector.
 395   G1Policy* _policy;
 396   G1HeapSizingPolicy* _heap_sizing_policy;
 397 
 398   G1CollectionSet _collection_set;
 399 
 400   // Try to allocate a single non-humongous HeapRegion sufficient for
 401   // an allocation of the given word_size. If do_expand is true,
 402   // attempt to expand the heap if necessary to satisfy the allocation
 403   // request. &#39;type&#39; takes the type of region to be allocated. (Use constants
 404   // Old, Eden, Humongous, Survivor defined in HeapRegionType.)
 405   HeapRegion* new_region(size_t word_size,
 406                          HeapRegionType type,
 407                          bool do_expand,
 408                          uint node_index = G1NUMA::AnyNodeIndex);
 409 
 410   // Initialize a contiguous set of free regions of length num_regions
 411   // and starting at index first so that they appear as a single
 412   // humongous region.
 413   HeapWord* humongous_obj_allocate_initialize_regions(HeapRegion* first_hr,
 414                                                       uint num_regions,
 415                                                       size_t word_size);
 416 
 417   // Attempt to allocate a humongous object of the given size. Return
 418   // NULL if unsuccessful.
 419   HeapWord* humongous_obj_allocate(size_t word_size);
 420 
 421   // The following two methods, allocate_new_tlab() and
 422   // mem_allocate(), are the two main entry points from the runtime
 423   // into the G1&#39;s allocation routines. They have the following
 424   // assumptions:
 425   //
 426   // * They should both be called outside safepoints.
 427   //
 428   // * They should both be called without holding the Heap_lock.
 429   //
 430   // * All allocation requests for new TLABs should go to
 431   //   allocate_new_tlab().
 432   //
 433   // * All non-TLAB allocation requests should go to mem_allocate().
 434   //
 435   // * If either call cannot satisfy the allocation request using the
 436   //   current allocating region, they will try to get a new one. If
 437   //   this fails, they will attempt to do an evacuation pause and
 438   //   retry the allocation.
 439   //
 440   // * If all allocation attempts fail, even after trying to schedule
 441   //   an evacuation pause, allocate_new_tlab() will return NULL,
 442   //   whereas mem_allocate() will attempt a heap expansion and/or
 443   //   schedule a Full GC.
 444   //
 445   // * We do not allow humongous-sized TLABs. So, allocate_new_tlab
 446   //   should never be called with word_size being humongous. All
 447   //   humongous allocation requests should go to mem_allocate() which
 448   //   will satisfy them with a special path.
 449 
 450   virtual HeapWord* allocate_new_tlab(size_t min_size,
 451                                       size_t requested_size,
 452                                       size_t* actual_size);
 453 
 454   virtual HeapWord* mem_allocate(size_t word_size,
 455                                  bool*  gc_overhead_limit_was_exceeded);
 456 
 457   // First-level mutator allocation attempt: try to allocate out of
 458   // the mutator alloc region without taking the Heap_lock. This
 459   // should only be used for non-humongous allocations.
 460   inline HeapWord* attempt_allocation(size_t min_word_size,
 461                                       size_t desired_word_size,
 462                                       size_t* actual_word_size);
 463 
 464   // Second-level mutator allocation attempt: take the Heap_lock and
 465   // retry the allocation attempt, potentially scheduling a GC
 466   // pause. This should only be used for non-humongous allocations.
 467   HeapWord* attempt_allocation_slow(size_t word_size);
 468 
 469   // Takes the Heap_lock and attempts a humongous allocation. It can
 470   // potentially schedule a GC pause.
 471   HeapWord* attempt_allocation_humongous(size_t word_size);
 472 
 473   // Allocation attempt that should be called during safepoints (e.g.,
 474   // at the end of a successful GC). expect_null_mutator_alloc_region
 475   // specifies whether the mutator alloc region is expected to be NULL
 476   // or not.
 477   HeapWord* attempt_allocation_at_safepoint(size_t word_size,
 478                                             bool expect_null_mutator_alloc_region);
 479 
 480   // These methods are the &quot;callbacks&quot; from the G1AllocRegion class.
 481 
 482   // For mutator alloc regions.
 483   HeapRegion* new_mutator_alloc_region(size_t word_size, bool force, uint node_index);
 484   void retire_mutator_alloc_region(HeapRegion* alloc_region,
 485                                    size_t allocated_bytes);
 486 
 487   // For GC alloc regions.
 488   bool has_more_regions(G1HeapRegionAttr dest);
 489   HeapRegion* new_gc_alloc_region(size_t word_size, G1HeapRegionAttr dest, uint node_index);
 490   void retire_gc_alloc_region(HeapRegion* alloc_region,
 491                               size_t allocated_bytes, G1HeapRegionAttr dest);
 492 
 493   // - if explicit_gc is true, the GC is for a System.gc() etc,
 494   //   otherwise it&#39;s for a failed allocation.
 495   // - if clear_all_soft_refs is true, all soft references should be
 496   //   cleared during the GC.
 497   // - it returns false if it is unable to do the collection due to the
 498   //   GC locker being active, true otherwise.
 499   bool do_full_collection(bool explicit_gc,
 500                           bool clear_all_soft_refs);
 501 
 502   // Callback from VM_G1CollectFull operation, or collect_as_vm_thread.
 503   virtual void do_full_collection(bool clear_all_soft_refs);
 504 
 505   // Callback from VM_G1CollectForAllocation operation.
 506   // This function does everything necessary/possible to satisfy a
 507   // failed allocation request (including collection, expansion, etc.)
 508   HeapWord* satisfy_failed_allocation(size_t word_size,
 509                                       bool* succeeded);
 510   // Internal helpers used during full GC to split it up to
 511   // increase readability.
 512   void abort_concurrent_cycle();
 513   void verify_before_full_collection(bool explicit_gc);
 514   void prepare_heap_for_full_collection();
 515   void prepare_heap_for_mutators();
 516   void abort_refinement();
 517   void verify_after_full_collection();
 518   void print_heap_after_full_collection(G1HeapTransition* heap_transition);
 519 
 520   // Helper method for satisfy_failed_allocation()
 521   HeapWord* satisfy_failed_allocation_helper(size_t word_size,
 522                                              bool do_gc,
 523                                              bool clear_all_soft_refs,
 524                                              bool expect_null_mutator_alloc_region,
 525                                              bool* gc_succeeded);
 526 
 527   // Attempting to expand the heap sufficiently
 528   // to support an allocation of the given &quot;word_size&quot;.  If
 529   // successful, perform the allocation and return the address of the
 530   // allocated block, or else &quot;NULL&quot;.
 531   HeapWord* expand_and_allocate(size_t word_size);
 532 
 533   // Process any reference objects discovered.
 534   void process_discovered_references(G1ParScanThreadStateSet* per_thread_states);
 535 
 536   // If during an initial mark pause we may install a pending list head which is not
 537   // otherwise reachable ensure that it is marked in the bitmap for concurrent marking
 538   // to discover.
 539   void make_pending_list_reachable();
 540 
 541   // Merges the information gathered on a per-thread basis for all worker threads
 542   // during GC into global variables.
 543   void merge_per_thread_state_info(G1ParScanThreadStateSet* per_thread_states);
 544 
 545   void verify_numa_regions(const char* desc);
 546 
 547 public:
 548   G1YoungRemSetSamplingThread* sampling_thread() const { return _young_gen_sampling_thread; }
 549 
 550   WorkGang* workers() const { return _workers; }
 551 
 552   // Runs the given AbstractGangTask with the current active workers, returning the
 553   // total time taken.
 554   Tickspan run_task(AbstractGangTask* task);
 555 
 556   G1Allocator* allocator() {
 557     return _allocator;
 558   }
 559 
 560   G1HeapVerifier* verifier() {
 561     return _verifier;
 562   }
 563 
 564   G1MonitoringSupport* g1mm() {
 565     assert(_g1mm != NULL, &quot;should have been initialized&quot;);
 566     return _g1mm;
 567   }
 568 
 569   void resize_heap_if_necessary();
 570 
 571   G1NUMA* numa() const { return _numa; }
 572 
 573   // Expand the garbage-first heap by at least the given size (in bytes!).
 574   // Returns true if the heap was expanded by the requested amount;
 575   // false otherwise.
 576   // (Rounds up to a HeapRegion boundary.)
 577   bool expand(size_t expand_bytes, WorkGang* pretouch_workers = NULL, double* expand_time_ms = NULL);
 578   bool expand_single_region(uint node_index);
 579 
 580   // Returns the PLAB statistics for a given destination.
 581   inline G1EvacStats* alloc_buffer_stats(G1HeapRegionAttr dest);
 582 
 583   // Determines PLAB size for a given destination.
 584   inline size_t desired_plab_sz(G1HeapRegionAttr dest);
 585 
 586   // Do anything common to GC&#39;s.
 587   void gc_prologue(bool full);
 588   void gc_epilogue(bool full);
 589 
 590   // Does the given region fulfill remembered set based eager reclaim candidate requirements?
 591   bool is_potential_eager_reclaim_candidate(HeapRegion* r) const;
 592 
 593   // Modify the reclaim candidate set and test for presence.
 594   // These are only valid for starts_humongous regions.
 595   inline void set_humongous_reclaim_candidate(uint region, bool value);
 596   inline bool is_humongous_reclaim_candidate(uint region);
 597   inline void set_has_humongous_reclaim_candidate(bool value);
 598 
 599   // Remove from the reclaim candidate set.  Also remove from the
 600   // collection set so that later encounters avoid the slow path.
 601   inline void set_humongous_is_live(oop obj);
 602 
 603   // Register the given region to be part of the collection set.
 604   inline void register_humongous_region_with_region_attr(uint index);
 605 
 606   // We register a region with the fast &quot;in collection set&quot; test. We
 607   // simply set to true the array slot corresponding to this region.
 608   void register_young_region_with_region_attr(HeapRegion* r) {
 609     _region_attr.set_in_young(r-&gt;hrm_index());
 610   }
 611   inline void register_region_with_region_attr(HeapRegion* r);
 612   inline void register_old_region_with_region_attr(HeapRegion* r);
 613   inline void register_optional_region_with_region_attr(HeapRegion* r);
 614 
 615   void clear_region_attr(const HeapRegion* hr) {
 616     _region_attr.clear(hr);
 617   }
 618 
 619   void clear_region_attr() {
 620     _region_attr.clear();
 621   }
 622 
 623   // Verify that the G1RegionAttr remset tracking corresponds to actual remset tracking
 624   // for all regions.
 625   void verify_region_attr_remset_update() PRODUCT_RETURN;
 626 
 627   bool is_user_requested_concurrent_full_gc(GCCause::Cause cause);
 628 
 629   // This is called at the start of either a concurrent cycle or a Full
 630   // GC to update the number of old marking cycles started.
 631   void increment_old_marking_cycles_started();
 632 
 633   // This is called at the end of either a concurrent cycle or a Full
 634   // GC to update the number of old marking cycles completed. Those two
 635   // can happen in a nested fashion, i.e., we start a concurrent
 636   // cycle, a Full GC happens half-way through it which ends first,
 637   // and then the cycle notices that a Full GC happened and ends
 638   // too. The concurrent parameter is a boolean to help us do a bit
 639   // tighter consistency checking in the method. If concurrent is
 640   // false, the caller is the inner caller in the nesting (i.e., the
 641   // Full GC). If concurrent is true, the caller is the outer caller
 642   // in this nesting (i.e., the concurrent cycle). Further nesting is
 643   // not currently supported. The end of this call also notifies
 644   // the G1OldGCCount_lock in case a Java thread is waiting for a full
 645   // GC to happen (e.g., it called System.gc() with
 646   // +ExplicitGCInvokesConcurrent).
 647   void increment_old_marking_cycles_completed(bool concurrent);
 648 
 649   uint old_marking_cycles_completed() {
 650     return _old_marking_cycles_completed;
 651   }
 652 
 653   G1HRPrinter* hr_printer() { return &amp;_hr_printer; }
 654 
 655   // Allocates a new heap region instance.
 656   HeapRegion* new_heap_region(uint hrs_index, MemRegion mr);
 657 
 658   // Allocate the highest free region in the reserved heap. This will commit
 659   // regions as necessary.
 660   HeapRegion* alloc_highest_free_region();
 661 
 662   // Frees a region by resetting its metadata and adding it to the free list
 663   // passed as a parameter (this is usually a local list which will be appended
 664   // to the master free list later or NULL if free list management is handled
 665   // in another way).
 666   // Callers must ensure they are the only one calling free on the given region
 667   // at the same time.
 668   void free_region(HeapRegion* hr, FreeRegionList* free_list);
 669 
 670   // It dirties the cards that cover the block so that the post
 671   // write barrier never queues anything when updating objects on this
 672   // block. It is assumed (and in fact we assert) that the block
 673   // belongs to a young region.
 674   inline void dirty_young_block(HeapWord* start, size_t word_size);
 675 
 676   // Frees a humongous region by collapsing it into individual regions
 677   // and calling free_region() for each of them. The freed regions
 678   // will be added to the free list that&#39;s passed as a parameter (this
 679   // is usually a local list which will be appended to the master free
 680   // list later).
 681   // The method assumes that only a single thread is ever calling
 682   // this for a particular region at once.
 683   void free_humongous_region(HeapRegion* hr,
 684                              FreeRegionList* free_list);
 685 
 686   // Facility for allocating in &#39;archive&#39; regions in high heap memory and
 687   // recording the allocated ranges. These should all be called from the
 688   // VM thread at safepoints, without the heap lock held. They can be used
 689   // to create and archive a set of heap regions which can be mapped at the
 690   // same fixed addresses in a subsequent JVM invocation.
 691   void begin_archive_alloc_range(bool open = false);
 692 
 693   // Check if the requested size would be too large for an archive allocation.
 694   bool is_archive_alloc_too_large(size_t word_size);
 695 
 696   // Allocate memory of the requested size from the archive region. This will
 697   // return NULL if the size is too large or if no memory is available. It
 698   // does not trigger a garbage collection.
 699   HeapWord* archive_mem_allocate(size_t word_size);
 700 
 701   // Optionally aligns the end address and returns the allocated ranges in
 702   // an array of MemRegions in order of ascending addresses.
 703   void end_archive_alloc_range(GrowableArray&lt;MemRegion&gt;* ranges,
 704                                size_t end_alignment_in_bytes = 0);
 705 
 706   // Facility for allocating a fixed range within the heap and marking
 707   // the containing regions as &#39;archive&#39;. For use at JVM init time, when the
 708   // caller may mmap archived heap data at the specified range(s).
 709   // Verify that the MemRegions specified in the argument array are within the
 710   // reserved heap.
 711   bool check_archive_addresses(MemRegion* range, size_t count);
 712 
 713   // Commit the appropriate G1 regions containing the specified MemRegions
 714   // and mark them as &#39;archive&#39; regions. The regions in the array must be
 715   // non-overlapping and in order of ascending address.
 716   bool alloc_archive_regions(MemRegion* range, size_t count, bool open);
 717 
 718   // Insert any required filler objects in the G1 regions around the specified
 719   // ranges to make the regions parseable. This must be called after
 720   // alloc_archive_regions, and after class loading has occurred.
 721   void fill_archive_regions(MemRegion* range, size_t count);
 722 
 723   // For each of the specified MemRegions, uncommit the containing G1 regions
 724   // which had been allocated by alloc_archive_regions. This should be called
 725   // rather than fill_archive_regions at JVM init time if the archive file
 726   // mapping failed, with the same non-overlapping and sorted MemRegion array.
 727   void dealloc_archive_regions(MemRegion* range, size_t count);
 728 
 729   oop materialize_archived_object(oop obj);
 730 
 731 private:
 732 
 733   // Shrink the garbage-first heap by at most the given size (in bytes!).
 734   // (Rounds down to a HeapRegion boundary.)
 735   void shrink(size_t expand_bytes);
 736   void shrink_helper(size_t expand_bytes);
 737 
 738   #if TASKQUEUE_STATS
 739   static void print_taskqueue_stats_hdr(outputStream* const st);
 740   void print_taskqueue_stats() const;
 741   void reset_taskqueue_stats();
 742   #endif // TASKQUEUE_STATS
 743 
 744   // Schedule the VM operation that will do an evacuation pause to
 745   // satisfy an allocation request of word_size. *succeeded will
 746   // return whether the VM operation was successful (it did do an
 747   // evacuation pause) or not (another thread beat us to it or the GC
 748   // locker was active). Given that we should not be holding the
 749   // Heap_lock when we enter this method, we will pass the
 750   // gc_count_before (i.e., total_collections()) as a parameter since
 751   // it has to be read while holding the Heap_lock. Currently, both
 752   // methods that call do_collection_pause() release the Heap_lock
 753   // before the call, so it&#39;s easy to read gc_count_before just before.
 754   HeapWord* do_collection_pause(size_t         word_size,
 755                                 uint           gc_count_before,
 756                                 bool*          succeeded,
 757                                 GCCause::Cause gc_cause);
 758 
 759   void wait_for_root_region_scanning();
 760 
 761   // Perform an incremental collection at a safepoint, possibly
 762   // followed by a by-policy upgrade to a full collection.  Returns
 763   // false if unable to do the collection due to the GC locker being
 764   // active, true otherwise.
 765   // precondition: at safepoint on VM thread
 766   // precondition: !is_gc_active()
 767   bool do_collection_pause_at_safepoint(double target_pause_time_ms);
 768 
 769   // Helper for do_collection_pause_at_safepoint, containing the guts
 770   // of the incremental collection pause, executed by the vm thread.
 771   void do_collection_pause_at_safepoint_helper(double target_pause_time_ms);
 772 
 773   G1HeapVerifier::G1VerifyType young_collection_verify_type() const;
 774   void verify_before_young_collection(G1HeapVerifier::G1VerifyType type);
 775   void verify_after_young_collection(G1HeapVerifier::G1VerifyType type);
 776 
 777   void calculate_collection_set(G1EvacuationInfo&amp; evacuation_info, double target_pause_time_ms);
 778 
 779   // Actually do the work of evacuating the parts of the collection set.
 780   void evacuate_initial_collection_set(G1ParScanThreadStateSet* per_thread_states);
 781   void evacuate_optional_collection_set(G1ParScanThreadStateSet* per_thread_states);
 782 private:
 783   // Evacuate the next set of optional regions.
 784   void evacuate_next_optional_regions(G1ParScanThreadStateSet* per_thread_states);
 785 
 786 public:
 787   void pre_evacuate_collection_set(G1EvacuationInfo&amp; evacuation_info, G1ParScanThreadStateSet* pss);
 788   void post_evacuate_collection_set(G1EvacuationInfo&amp; evacuation_info,
 789                                     G1RedirtyCardsQueueSet* rdcqs,
 790                                     G1ParScanThreadStateSet* pss);
 791 
 792   void expand_heap_after_young_collection();
 793   // Update object copying statistics.
 794   void record_obj_copy_mem_stats();
 795 
 796   // The hot card cache for remembered set insertion optimization.
 797   G1HotCardCache* _hot_card_cache;
 798 
 799   // The g1 remembered set of the heap.
 800   G1RemSet* _rem_set;
 801 
 802   // After a collection pause, convert the regions in the collection set into free
 803   // regions.
 804   void free_collection_set(G1CollectionSet* collection_set, G1EvacuationInfo&amp; evacuation_info, const size_t* surviving_young_words);
 805 
 806   // Abandon the current collection set without recording policy
 807   // statistics or updating free lists.
 808   void abandon_collection_set(G1CollectionSet* collection_set);
 809 
 810   // The concurrent marker (and the thread it runs in.)
 811   G1ConcurrentMark* _cm;
 812   G1ConcurrentMarkThread* _cm_thread;
 813 
 814   // The concurrent refiner.
 815   G1ConcurrentRefine* _cr;
 816 
 817   // The parallel task queues
<a name="3" id="anc3"></a><span class="line-modified"> 818   ScannerTasksQueueSet *_task_queues;</span>
 819 
 820   // True iff a evacuation has failed in the current collection.
 821   bool _evacuation_failed;
 822 
 823   EvacuationFailedInfo* _evacuation_failed_info_array;
 824 
 825   // Failed evacuations cause some logical from-space objects to have
 826   // forwarding pointers to themselves.  Reset them.
 827   void remove_self_forwarding_pointers(G1RedirtyCardsQueueSet* rdcqs);
 828 
 829   // Restore the objects in the regions in the collection set after an
 830   // evacuation failure.
 831   void restore_after_evac_failure(G1RedirtyCardsQueueSet* rdcqs);
 832 
 833   PreservedMarksSet _preserved_marks_set;
 834 
 835   // Preserve the mark of &quot;obj&quot;, if necessary, in preparation for its mark
 836   // word being overwritten with a self-forwarding-pointer.
 837   void preserve_mark_during_evac_failure(uint worker_id, oop obj, markWord m);
 838 
 839 #ifndef PRODUCT
 840   // Support for forcing evacuation failures. Analogous to
 841   // PromotionFailureALot for the other collectors.
 842 
 843   // Records whether G1EvacuationFailureALot should be in effect
 844   // for the current GC
 845   bool _evacuation_failure_alot_for_current_gc;
 846 
 847   // Used to record the GC number for interval checking when
 848   // determining whether G1EvaucationFailureALot is in effect
 849   // for the current GC.
 850   size_t _evacuation_failure_alot_gc_number;
 851 
 852   // Count of the number of evacuations between failures.
 853   volatile size_t _evacuation_failure_alot_count;
 854 
 855   // Set whether G1EvacuationFailureALot should be in effect
 856   // for the current GC (based upon the type of GC and which
 857   // command line flags are set);
 858   inline bool evacuation_failure_alot_for_gc_type(bool for_young_gc,
 859                                                   bool during_initial_mark,
 860                                                   bool mark_or_rebuild_in_progress);
 861 
 862   inline void set_evacuation_failure_alot_for_current_gc();
 863 
 864   // Return true if it&#39;s time to cause an evacuation failure.
 865   inline bool evacuation_should_fail();
 866 
 867   // Reset the G1EvacuationFailureALot counters.  Should be called at
 868   // the end of an evacuation pause in which an evacuation failure occurred.
 869   inline void reset_evacuation_should_fail();
 870 #endif // !PRODUCT
 871 
 872   // (&quot;Weak&quot;) Reference processing support.
 873   //
 874   // G1 has 2 instances of the reference processor class. One
 875   // (_ref_processor_cm) handles reference object discovery
 876   // and subsequent processing during concurrent marking cycles.
 877   //
 878   // The other (_ref_processor_stw) handles reference object
 879   // discovery and processing during full GCs and incremental
 880   // evacuation pauses.
 881   //
 882   // During an incremental pause, reference discovery will be
 883   // temporarily disabled for _ref_processor_cm and will be
 884   // enabled for _ref_processor_stw. At the end of the evacuation
 885   // pause references discovered by _ref_processor_stw will be
 886   // processed and discovery will be disabled. The previous
 887   // setting for reference object discovery for _ref_processor_cm
 888   // will be re-instated.
 889   //
 890   // At the start of marking:
 891   //  * Discovery by the CM ref processor is verified to be inactive
 892   //    and it&#39;s discovered lists are empty.
 893   //  * Discovery by the CM ref processor is then enabled.
 894   //
 895   // At the end of marking:
 896   //  * Any references on the CM ref processor&#39;s discovered
 897   //    lists are processed (possibly MT).
 898   //
 899   // At the start of full GC we:
 900   //  * Disable discovery by the CM ref processor and
 901   //    empty CM ref processor&#39;s discovered lists
 902   //    (without processing any entries).
 903   //  * Verify that the STW ref processor is inactive and it&#39;s
 904   //    discovered lists are empty.
 905   //  * Temporarily set STW ref processor discovery as single threaded.
 906   //  * Temporarily clear the STW ref processor&#39;s _is_alive_non_header
 907   //    field.
 908   //  * Finally enable discovery by the STW ref processor.
 909   //
 910   // The STW ref processor is used to record any discovered
 911   // references during the full GC.
 912   //
 913   // At the end of a full GC we:
 914   //  * Enqueue any reference objects discovered by the STW ref processor
 915   //    that have non-live referents. This has the side-effect of
 916   //    making the STW ref processor inactive by disabling discovery.
 917   //  * Verify that the CM ref processor is still inactive
 918   //    and no references have been placed on it&#39;s discovered
 919   //    lists (also checked as a precondition during initial marking).
 920 
 921   // The (stw) reference processor...
 922   ReferenceProcessor* _ref_processor_stw;
 923 
 924   // During reference object discovery, the _is_alive_non_header
 925   // closure (if non-null) is applied to the referent object to
 926   // determine whether the referent is live. If so then the
 927   // reference object does not need to be &#39;discovered&#39; and can
 928   // be treated as a regular oop. This has the benefit of reducing
 929   // the number of &#39;discovered&#39; reference objects that need to
 930   // be processed.
 931   //
 932   // Instance of the is_alive closure for embedding into the
 933   // STW reference processor as the _is_alive_non_header field.
 934   // Supplying a value for the _is_alive_non_header field is
 935   // optional but doing so prevents unnecessary additions to
 936   // the discovered lists during reference discovery.
 937   G1STWIsAliveClosure _is_alive_closure_stw;
 938 
 939   G1STWSubjectToDiscoveryClosure _is_subject_to_discovery_stw;
 940 
 941   // The (concurrent marking) reference processor...
 942   ReferenceProcessor* _ref_processor_cm;
 943 
 944   // Instance of the concurrent mark is_alive closure for embedding
 945   // into the Concurrent Marking reference processor as the
 946   // _is_alive_non_header field. Supplying a value for the
 947   // _is_alive_non_header field is optional but doing so prevents
 948   // unnecessary additions to the discovered lists during reference
 949   // discovery.
 950   G1CMIsAliveClosure _is_alive_closure_cm;
 951 
 952   G1CMSubjectToDiscoveryClosure _is_subject_to_discovery_cm;
 953 public:
 954 
<a name="4" id="anc4"></a><span class="line-modified"> 955   ScannerTasksQueue* task_queue(uint i) const;</span>
 956 
 957   uint num_task_queues() const;
 958 
 959   // Create a G1CollectedHeap.
 960   // Must call the initialize method afterwards.
 961   // May not return if something goes wrong.
 962   G1CollectedHeap();
 963 
 964 private:
 965   jint initialize_concurrent_refinement();
 966   jint initialize_young_gen_sampling_thread();
 967 public:
 968   // Initialize the G1CollectedHeap to have the initial and
 969   // maximum sizes and remembered and barrier sets
 970   // specified by the policy object.
 971   jint initialize();
 972 
 973   virtual void stop();
 974   virtual void safepoint_synchronize_begin();
 975   virtual void safepoint_synchronize_end();
 976 
 977   // Does operations required after initialization has been done.
 978   void post_initialize();
 979 
 980   // Initialize weak reference processing.
 981   void ref_processing_init();
 982 
 983   virtual Name kind() const {
 984     return CollectedHeap::G1;
 985   }
 986 
 987   virtual const char* name() const {
 988     return &quot;G1&quot;;
 989   }
 990 
 991   const G1CollectorState* collector_state() const { return &amp;_collector_state; }
 992   G1CollectorState* collector_state() { return &amp;_collector_state; }
 993 
 994   // The current policy object for the collector.
 995   G1Policy* policy() const { return _policy; }
 996   // The remembered set.
 997   G1RemSet* rem_set() const { return _rem_set; }
 998 
 999   inline G1GCPhaseTimes* phase_times() const;
1000 
1001   HeapRegionManager* hrm() const { return _hrm; }
1002 
1003   const G1CollectionSet* collection_set() const { return &amp;_collection_set; }
1004   G1CollectionSet* collection_set() { return &amp;_collection_set; }
1005 
1006   virtual SoftRefPolicy* soft_ref_policy();
1007 
1008   virtual void initialize_serviceability();
1009   virtual MemoryUsage memory_usage();
1010   virtual GrowableArray&lt;GCMemoryManager*&gt; memory_managers();
1011   virtual GrowableArray&lt;MemoryPool*&gt; memory_pools();
1012 
1013   // Try to minimize the remembered set.
1014   void scrub_rem_set();
1015 
1016   // Apply the given closure on all cards in the Hot Card Cache, emptying it.
1017   void iterate_hcc_closure(G1CardTableEntryClosure* cl, uint worker_id);
1018 
1019   // The shared block offset table array.
1020   G1BlockOffsetTable* bot() const { return _bot; }
1021 
1022   // Reference Processing accessors
1023 
1024   // The STW reference processor....
1025   ReferenceProcessor* ref_processor_stw() const { return _ref_processor_stw; }
1026 
1027   G1NewTracer* gc_tracer_stw() const { return _gc_tracer_stw; }
1028 
1029   // The Concurrent Marking reference processor...
1030   ReferenceProcessor* ref_processor_cm() const { return _ref_processor_cm; }
1031 
1032   size_t unused_committed_regions_in_bytes() const;
1033 
1034   virtual size_t capacity() const;
1035   virtual size_t used() const;
1036   // This should be called when we&#39;re not holding the heap lock. The
1037   // result might be a bit inaccurate.
1038   size_t used_unlocked() const;
1039   size_t recalculate_used() const;
1040 
1041   // These virtual functions do the actual allocation.
1042   // Some heaps may offer a contiguous region for shared non-blocking
1043   // allocation, via inlined code (by exporting the address of the top and
1044   // end fields defining the extent of the contiguous allocation region.)
1045   // But G1CollectedHeap doesn&#39;t yet support this.
1046 
1047   virtual bool is_maximal_no_gc() const {
1048     return _hrm-&gt;available() == 0;
1049   }
1050 
1051   // Returns whether there are any regions left in the heap for allocation.
1052   bool has_regions_left_for_allocation() const {
1053     return !is_maximal_no_gc() || num_free_regions() != 0;
1054   }
1055 
1056   // The current number of regions in the heap.
1057   uint num_regions() const { return _hrm-&gt;length(); }
1058 
1059   // The max number of regions in the heap.
1060   uint max_regions() const { return _hrm-&gt;max_length(); }
1061 
1062   // Max number of regions that can be comitted.
1063   uint max_expandable_regions() const { return _hrm-&gt;max_expandable_length(); }
1064 
1065   // The number of regions that are completely free.
1066   uint num_free_regions() const { return _hrm-&gt;num_free_regions(); }
1067 
1068   // The number of regions that can be allocated into.
1069   uint num_free_or_available_regions() const { return num_free_regions() + _hrm-&gt;available(); }
1070 
1071   MemoryUsage get_auxiliary_data_memory_usage() const {
1072     return _hrm-&gt;get_auxiliary_data_memory_usage();
1073   }
1074 
1075   // The number of regions that are not completely free.
1076   uint num_used_regions() const { return num_regions() - num_free_regions(); }
1077 
1078 #ifdef ASSERT
1079   bool is_on_master_free_list(HeapRegion* hr) {
1080     return _hrm-&gt;is_free(hr);
1081   }
1082 #endif // ASSERT
1083 
1084   inline void old_set_add(HeapRegion* hr);
1085   inline void old_set_remove(HeapRegion* hr);
1086 
1087   inline void archive_set_add(HeapRegion* hr);
1088 
1089   size_t non_young_capacity_bytes() {
1090     return (old_regions_count() + _archive_set.length() + humongous_regions_count()) * HeapRegion::GrainBytes;
1091   }
1092 
1093   // Determine whether the given region is one that we are using as an
1094   // old GC alloc region.
1095   bool is_old_gc_alloc_region(HeapRegion* hr);
1096 
1097   // Perform a collection of the heap; intended for use in implementing
1098   // &quot;System.gc&quot;.  This probably implies as full a collection as the
1099   // &quot;CollectedHeap&quot; supports.
1100   virtual void collect(GCCause::Cause cause);
1101 
1102   // Perform a collection of the heap with the given cause.
1103   // Returns whether this collection actually executed.
1104   bool try_collect(GCCause::Cause cause);
1105 
1106   // True iff an evacuation has failed in the most-recent collection.
1107   bool evacuation_failed() { return _evacuation_failed; }
1108 
1109   void remove_from_old_sets(const uint old_regions_removed, const uint humongous_regions_removed);
1110   void prepend_to_freelist(FreeRegionList* list);
1111   void decrement_summary_bytes(size_t bytes);
1112 
1113   virtual bool is_in(const void* p) const;
1114 #ifdef ASSERT
1115   // Returns whether p is in one of the available areas of the heap. Slow but
1116   // extensive version.
1117   bool is_in_exact(const void* p) const;
1118 #endif
1119 
1120   // Return &quot;TRUE&quot; iff the given object address is within the collection
1121   // set. Assumes that the reference points into the heap.
1122   inline bool is_in_cset(const HeapRegion *hr);
1123   inline bool is_in_cset(oop obj);
1124   inline bool is_in_cset(HeapWord* addr);
1125 
1126   inline bool is_in_cset_or_humongous(const oop obj);
1127 
1128  private:
1129   // This array is used for a quick test on whether a reference points into
1130   // the collection set or not. Each of the array&#39;s elements denotes whether the
1131   // corresponding region is in the collection set or not.
1132   G1HeapRegionAttrBiasedMappedArray _region_attr;
1133 
1134  public:
1135 
1136   inline G1HeapRegionAttr region_attr(const void* obj) const;
1137   inline G1HeapRegionAttr region_attr(uint idx) const;
1138 
1139   // Return &quot;TRUE&quot; iff the given object address is in the reserved
1140   // region of g1.
1141   bool is_in_g1_reserved(const void* p) const {
1142     return _hrm-&gt;reserved().contains(p);
1143   }
1144 
1145   // Returns a MemRegion that corresponds to the space that has been
1146   // reserved for the heap
1147   MemRegion g1_reserved() const {
1148     return _hrm-&gt;reserved();
1149   }
1150 
1151   MemRegion reserved_region() const {
1152     return _reserved;
1153   }
1154 
1155   HeapWord* base() const {
1156     return _reserved.start();
1157   }
1158 
1159   bool is_in_reserved(const void* addr) const {
1160     return _reserved.contains(addr);
1161   }
1162 
1163   G1HotCardCache* hot_card_cache() const { return _hot_card_cache; }
1164 
1165   G1CardTable* card_table() const {
1166     return _card_table;
1167   }
1168 
1169   // Iteration functions.
1170 
1171   // Iterate over all objects, calling &quot;cl.do_object&quot; on each.
1172   virtual void object_iterate(ObjectClosure* cl);
1173 
1174   // Keep alive an object that was loaded with AS_NO_KEEPALIVE.
1175   virtual void keep_alive(oop obj);
1176 
1177   // Iterate over heap regions, in address order, terminating the
1178   // iteration early if the &quot;do_heap_region&quot; method returns &quot;true&quot;.
1179   void heap_region_iterate(HeapRegionClosure* blk) const;
1180 
1181   // Return the region with the given index. It assumes the index is valid.
1182   inline HeapRegion* region_at(uint index) const;
1183   inline HeapRegion* region_at_or_null(uint index) const;
1184 
1185   // Return the next region (by index) that is part of the same
1186   // humongous object that hr is part of.
1187   inline HeapRegion* next_region_in_humongous(HeapRegion* hr) const;
1188 
1189   // Calculate the region index of the given address. Given address must be
1190   // within the heap.
1191   inline uint addr_to_region(HeapWord* addr) const;
1192 
1193   inline HeapWord* bottom_addr_for_region(uint index) const;
1194 
1195   // Two functions to iterate over the heap regions in parallel. Threads
1196   // compete using the HeapRegionClaimer to claim the regions before
1197   // applying the closure on them.
1198   // The _from_worker_offset version uses the HeapRegionClaimer and
1199   // the worker id to calculate a start offset to prevent all workers to
1200   // start from the point.
1201   void heap_region_par_iterate_from_worker_offset(HeapRegionClosure* cl,
1202                                                   HeapRegionClaimer* hrclaimer,
1203                                                   uint worker_id) const;
1204 
1205   void heap_region_par_iterate_from_start(HeapRegionClosure* cl,
1206                                           HeapRegionClaimer* hrclaimer) const;
1207 
1208   // Iterate over all regions in the collection set in parallel.
1209   void collection_set_par_iterate_all(HeapRegionClosure* cl,
1210                                       HeapRegionClaimer* hr_claimer,
1211                                       uint worker_id);
1212 
1213   // Iterate over all regions currently in the current collection set.
1214   void collection_set_iterate_all(HeapRegionClosure* blk);
1215 
1216   // Iterate over the regions in the current increment of the collection set.
1217   // Starts the iteration so that the start regions of a given worker id over the
1218   // set active_workers are evenly spread across the set of collection set regions
1219   // to be iterated.
1220   // The variant with the HeapRegionClaimer guarantees that the closure will be
1221   // applied to a particular region exactly once.
1222   void collection_set_iterate_increment_from(HeapRegionClosure *blk, uint worker_id) {
1223     collection_set_iterate_increment_from(blk, NULL, worker_id);
1224   }
1225   void collection_set_iterate_increment_from(HeapRegionClosure *blk, HeapRegionClaimer* hr_claimer, uint worker_id);
1226 
1227   // Returns the HeapRegion that contains addr. addr must not be NULL.
1228   template &lt;class T&gt;
1229   inline HeapRegion* heap_region_containing(const T addr) const;
1230 
1231   // Returns the HeapRegion that contains addr, or NULL if that is an uncommitted
1232   // region. addr must not be NULL.
1233   template &lt;class T&gt;
1234   inline HeapRegion* heap_region_containing_or_null(const T addr) const;
1235 
1236   // A CollectedHeap is divided into a dense sequence of &quot;blocks&quot;; that is,
1237   // each address in the (reserved) heap is a member of exactly
1238   // one block.  The defining characteristic of a block is that it is
1239   // possible to find its size, and thus to progress forward to the next
1240   // block.  (Blocks may be of different sizes.)  Thus, blocks may
1241   // represent Java objects, or they might be free blocks in a
1242   // free-list-based heap (or subheap), as long as the two kinds are
1243   // distinguishable and the size of each is determinable.
1244 
1245   // Returns the address of the start of the &quot;block&quot; that contains the
1246   // address &quot;addr&quot;.  We say &quot;blocks&quot; instead of &quot;object&quot; since some heaps
1247   // may not pack objects densely; a chunk may either be an object or a
1248   // non-object.
1249   HeapWord* block_start(const void* addr) const;
1250 
1251   // Requires &quot;addr&quot; to be the start of a block, and returns &quot;TRUE&quot; iff
1252   // the block is an object.
1253   bool block_is_obj(const HeapWord* addr) const;
1254 
1255   // Section on thread-local allocation buffers (TLABs)
1256   // See CollectedHeap for semantics.
1257 
1258   bool supports_tlab_allocation() const;
1259   size_t tlab_capacity(Thread* ignored) const;
1260   size_t tlab_used(Thread* ignored) const;
1261   size_t max_tlab_size() const;
1262   size_t unsafe_max_tlab_alloc(Thread* ignored) const;
1263 
1264   inline bool is_in_young(const oop obj);
1265 
1266   // Returns &quot;true&quot; iff the given word_size is &quot;very large&quot;.
1267   static bool is_humongous(size_t word_size) {
1268     // Note this has to be strictly greater-than as the TLABs
1269     // are capped at the humongous threshold and we want to
1270     // ensure that we don&#39;t try to allocate a TLAB as
1271     // humongous and that we don&#39;t allocate a humongous
1272     // object in a TLAB.
1273     return word_size &gt; _humongous_object_threshold_in_words;
1274   }
1275 
1276   // Returns the humongous threshold for a specific region size
1277   static size_t humongous_threshold_for(size_t region_size) {
1278     return (region_size / 2);
1279   }
1280 
1281   // Returns the number of regions the humongous object of the given word size
1282   // requires.
1283   static size_t humongous_obj_size_in_regions(size_t word_size);
1284 
1285   // Print the maximum heap capacity.
1286   virtual size_t max_capacity() const;
1287 
1288   // Return the size of reserved memory. Returns different value than max_capacity() when AllocateOldGenAt is used.
1289   virtual size_t max_reserved_capacity() const;
1290 
1291   virtual jlong millis_since_last_gc();
1292 
1293 
1294   // Convenience function to be used in situations where the heap type can be
1295   // asserted to be this type.
1296   static G1CollectedHeap* heap();
1297 
1298   void set_region_short_lived_locked(HeapRegion* hr);
1299   // add appropriate methods for any other surv rate groups
1300 
1301   const G1SurvivorRegions* survivor() const { return &amp;_survivor; }
1302 
1303   uint eden_regions_count() const { return _eden.length(); }
1304   uint eden_regions_count(uint node_index) const { return _eden.regions_on_node(node_index); }
1305   uint survivor_regions_count() const { return _survivor.length(); }
1306   uint survivor_regions_count(uint node_index) const { return _survivor.regions_on_node(node_index); }
1307   size_t eden_regions_used_bytes() const { return _eden.used_bytes(); }
1308   size_t survivor_regions_used_bytes() const { return _survivor.used_bytes(); }
1309   uint young_regions_count() const { return _eden.length() + _survivor.length(); }
1310   uint old_regions_count() const { return _old_set.length(); }
1311   uint archive_regions_count() const { return _archive_set.length(); }
1312   uint humongous_regions_count() const { return _humongous_set.length(); }
1313 
1314 #ifdef ASSERT
1315   bool check_young_list_empty();
1316 #endif
1317 
1318   // *** Stuff related to concurrent marking.  It&#39;s not clear to me that so
1319   // many of these need to be public.
1320 
1321   // The functions below are helper functions that a subclass of
1322   // &quot;CollectedHeap&quot; can use in the implementation of its virtual
1323   // functions.
1324   // This performs a concurrent marking of the live objects in a
1325   // bitmap off to the side.
1326   void do_concurrent_mark();
1327 
1328   bool is_marked_next(oop obj) const;
1329 
1330   // Determine if an object is dead, given the object and also
1331   // the region to which the object belongs. An object is dead
1332   // iff a) it was not allocated since the last mark, b) it
1333   // is not marked, and c) it is not in an archive region.
1334   bool is_obj_dead(const oop obj, const HeapRegion* hr) const {
1335     return
1336       hr-&gt;is_obj_dead(obj, _cm-&gt;prev_mark_bitmap()) &amp;&amp;
1337       !hr-&gt;is_archive();
1338   }
1339 
1340   // This function returns true when an object has been
1341   // around since the previous marking and hasn&#39;t yet
1342   // been marked during this marking, and is not in an archive region.
1343   bool is_obj_ill(const oop obj, const HeapRegion* hr) const {
1344     return
1345       !hr-&gt;obj_allocated_since_next_marking(obj) &amp;&amp;
1346       !is_marked_next(obj) &amp;&amp;
1347       !hr-&gt;is_archive();
1348   }
1349 
1350   // Determine if an object is dead, given only the object itself.
1351   // This will find the region to which the object belongs and
1352   // then call the region version of the same function.
1353 
1354   // Added if it is NULL it isn&#39;t dead.
1355 
1356   inline bool is_obj_dead(const oop obj) const;
1357 
1358   inline bool is_obj_ill(const oop obj) const;
1359 
1360   inline bool is_obj_dead_full(const oop obj, const HeapRegion* hr) const;
1361   inline bool is_obj_dead_full(const oop obj) const;
1362 
1363   G1ConcurrentMark* concurrent_mark() const { return _cm; }
1364 
1365   // Refinement
1366 
1367   G1ConcurrentRefine* concurrent_refine() const { return _cr; }
1368 
1369   // Optimized nmethod scanning support routines
1370 
1371   // Register the given nmethod with the G1 heap.
1372   virtual void register_nmethod(nmethod* nm);
1373 
1374   // Unregister the given nmethod from the G1 heap.
1375   virtual void unregister_nmethod(nmethod* nm);
1376 
1377   // No nmethod flushing needed.
1378   virtual void flush_nmethod(nmethod* nm) {}
1379 
1380   // No nmethod verification implemented.
1381   virtual void verify_nmethod(nmethod* nm) {}
1382 
1383   // Free up superfluous code root memory.
1384   void purge_code_root_memory();
1385 
1386   // Rebuild the strong code root lists for each region
1387   // after a full GC.
1388   void rebuild_strong_code_roots();
1389 
1390   // Partial cleaning of VM internal data structures.
1391   void string_dedup_cleaning(BoolObjectClosure* is_alive,
1392                              OopClosure* keep_alive,
1393                              G1GCPhaseTimes* phase_times = NULL);
1394 
1395   // Performs cleaning of data structures after class unloading.
1396   void complete_cleaning(BoolObjectClosure* is_alive, bool class_unloading_occurred);
1397 
1398   // Redirty logged cards in the refinement queue.
1399   void redirty_logged_cards(G1RedirtyCardsQueueSet* rdcqs);
1400 
1401   // Verification
1402 
1403   // Deduplicate the string
1404   virtual void deduplicate_string(oop str);
1405 
1406   // Perform any cleanup actions necessary before allowing a verification.
1407   virtual void prepare_for_verify();
1408 
1409   // Perform verification.
1410 
1411   // vo == UsePrevMarking -&gt; use &quot;prev&quot; marking information,
1412   // vo == UseNextMarking -&gt; use &quot;next&quot; marking information
1413   // vo == UseFullMarking -&gt; use &quot;next&quot; marking bitmap but no TAMS
1414   //
1415   // NOTE: Only the &quot;prev&quot; marking information is guaranteed to be
1416   // consistent most of the time, so most calls to this should use
1417   // vo == UsePrevMarking.
1418   // Currently, there is only one case where this is called with
1419   // vo == UseNextMarking, which is to verify the &quot;next&quot; marking
1420   // information at the end of remark.
1421   // Currently there is only one place where this is called with
1422   // vo == UseFullMarking, which is to verify the marking during a
1423   // full GC.
1424   void verify(VerifyOption vo);
1425 
1426   // WhiteBox testing support.
1427   virtual bool supports_concurrent_gc_breakpoints() const;
1428   bool is_heterogeneous_heap() const;
1429 
1430   virtual WorkGang* get_safepoint_workers() { return _workers; }
1431 
1432   // The methods below are here for convenience and dispatch the
1433   // appropriate method depending on value of the given VerifyOption
1434   // parameter. The values for that parameter, and their meanings,
1435   // are the same as those above.
1436 
1437   bool is_obj_dead_cond(const oop obj,
1438                         const HeapRegion* hr,
1439                         const VerifyOption vo) const;
1440 
1441   bool is_obj_dead_cond(const oop obj,
1442                         const VerifyOption vo) const;
1443 
1444   G1HeapSummary create_g1_heap_summary();
1445   G1EvacSummary create_g1_evac_summary(G1EvacStats* stats);
1446 
1447   // Printing
1448 private:
1449   void print_heap_regions() const;
1450   void print_regions_on(outputStream* st) const;
1451 
1452 public:
1453   virtual void print_on(outputStream* st) const;
1454   virtual void print_extended_on(outputStream* st) const;
1455   virtual void print_on_error(outputStream* st) const;
1456 
1457   virtual void print_gc_threads_on(outputStream* st) const;
1458   virtual void gc_threads_do(ThreadClosure* tc) const;
1459 
1460   // Override
1461   void print_tracing_info() const;
1462 
1463   // The following two methods are helpful for debugging RSet issues.
1464   void print_cset_rsets() PRODUCT_RETURN;
1465   void print_all_rsets() PRODUCT_RETURN;
1466 
1467   // Used to print information about locations in the hs_err file.
1468   virtual bool print_location(outputStream* st, void* addr) const;
1469 };
1470 
1471 class G1ParEvacuateFollowersClosure : public VoidClosure {
1472 private:
1473   double _start_term;
1474   double _term_time;
1475   size_t _term_attempts;
1476 
1477   void start_term_time() { _term_attempts++; _start_term = os::elapsedTime(); }
1478   void end_term_time() { _term_time += (os::elapsedTime() - _start_term); }
1479 protected:
1480   G1CollectedHeap*              _g1h;
1481   G1ParScanThreadState*         _par_scan_state;
<a name="5" id="anc5"></a><span class="line-modified">1482   ScannerTasksQueueSet*         _queues;</span>
1483   TaskTerminator*               _terminator;
1484   G1GCPhaseTimes::GCParPhases   _phase;
1485 
1486   G1ParScanThreadState*   par_scan_state() { return _par_scan_state; }
<a name="6" id="anc6"></a><span class="line-modified">1487   ScannerTasksQueueSet*   queues()         { return _queues; }</span>
1488   TaskTerminator*         terminator()     { return _terminator; }
1489 
1490 public:
1491   G1ParEvacuateFollowersClosure(G1CollectedHeap* g1h,
1492                                 G1ParScanThreadState* par_scan_state,
<a name="7" id="anc7"></a><span class="line-modified">1493                                 ScannerTasksQueueSet* queues,</span>
1494                                 TaskTerminator* terminator,
1495                                 G1GCPhaseTimes::GCParPhases phase)
1496     : _start_term(0.0), _term_time(0.0), _term_attempts(0),
1497       _g1h(g1h), _par_scan_state(par_scan_state),
1498       _queues(queues), _terminator(terminator), _phase(phase) {}
1499 
1500   void do_void();
1501 
1502   double term_time() const { return _term_time; }
1503   size_t term_attempts() const { return _term_attempts; }
1504 
1505 private:
1506   inline bool offer_termination();
1507 };
1508 
1509 #endif // SHARE_GC_G1_G1COLLECTEDHEAP_HPP
<a name="8" id="anc8"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="8" type="hidden" />
</body>
</html>