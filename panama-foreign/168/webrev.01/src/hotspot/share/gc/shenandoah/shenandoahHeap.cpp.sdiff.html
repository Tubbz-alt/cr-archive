<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/hotspot/share/gc/shenandoah/shenandoahHeap.cpp</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
<body>
<center><a href="shenandoahControlThread.cpp.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="shenandoahMarkCompact.cpp.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/hotspot/share/gc/shenandoah/shenandoahHeap.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  29 #include &quot;gc/shared/gcArguments.hpp&quot;
  30 #include &quot;gc/shared/gcTimer.hpp&quot;
  31 #include &quot;gc/shared/gcTraceTime.inline.hpp&quot;
  32 #include &quot;gc/shared/locationPrinter.inline.hpp&quot;
  33 #include &quot;gc/shared/memAllocator.hpp&quot;
  34 #include &quot;gc/shared/oopStorageSet.hpp&quot;
  35 #include &quot;gc/shared/plab.hpp&quot;
  36 
  37 #include &quot;gc/shenandoah/shenandoahBarrierSet.hpp&quot;
  38 #include &quot;gc/shenandoah/shenandoahClosures.inline.hpp&quot;
  39 #include &quot;gc/shenandoah/shenandoahCollectionSet.hpp&quot;
  40 #include &quot;gc/shenandoah/shenandoahCollectorPolicy.hpp&quot;
  41 #include &quot;gc/shenandoah/shenandoahConcurrentMark.inline.hpp&quot;
  42 #include &quot;gc/shenandoah/shenandoahConcurrentRoots.hpp&quot;
  43 #include &quot;gc/shenandoah/shenandoahControlThread.hpp&quot;
  44 #include &quot;gc/shenandoah/shenandoahFreeSet.hpp&quot;
  45 #include &quot;gc/shenandoah/shenandoahPhaseTimings.hpp&quot;
  46 #include &quot;gc/shenandoah/shenandoahHeap.inline.hpp&quot;
  47 #include &quot;gc/shenandoah/shenandoahHeapRegion.inline.hpp&quot;
  48 #include &quot;gc/shenandoah/shenandoahHeapRegionSet.hpp&quot;
<span class="line-removed">  49 #include &quot;gc/shenandoah/shenandoahIUMode.hpp&quot;</span>
  50 #include &quot;gc/shenandoah/shenandoahMarkCompact.hpp&quot;
  51 #include &quot;gc/shenandoah/shenandoahMarkingContext.inline.hpp&quot;
  52 #include &quot;gc/shenandoah/shenandoahMemoryPool.hpp&quot;
  53 #include &quot;gc/shenandoah/shenandoahMetrics.hpp&quot;
  54 #include &quot;gc/shenandoah/shenandoahMonitoringSupport.hpp&quot;
<span class="line-removed">  55 #include &quot;gc/shenandoah/shenandoahNormalMode.hpp&quot;</span>
  56 #include &quot;gc/shenandoah/shenandoahOopClosures.inline.hpp&quot;
  57 #include &quot;gc/shenandoah/shenandoahPacer.inline.hpp&quot;
  58 #include &quot;gc/shenandoah/shenandoahPadding.hpp&quot;
  59 #include &quot;gc/shenandoah/shenandoahParallelCleaning.inline.hpp&quot;
<span class="line-removed">  60 #include &quot;gc/shenandoah/shenandoahPassiveMode.hpp&quot;</span>
  61 #include &quot;gc/shenandoah/shenandoahRootProcessor.inline.hpp&quot;
  62 #include &quot;gc/shenandoah/shenandoahStringDedup.hpp&quot;
  63 #include &quot;gc/shenandoah/shenandoahTaskqueue.hpp&quot;
  64 #include &quot;gc/shenandoah/shenandoahUtils.hpp&quot;
  65 #include &quot;gc/shenandoah/shenandoahVerifier.hpp&quot;
  66 #include &quot;gc/shenandoah/shenandoahCodeRoots.hpp&quot;
  67 #include &quot;gc/shenandoah/shenandoahVMOperations.hpp&quot;
  68 #include &quot;gc/shenandoah/shenandoahWorkGroup.hpp&quot;
  69 #include &quot;gc/shenandoah/shenandoahWorkerPolicy.hpp&quot;



  70 #if INCLUDE_JFR
  71 #include &quot;gc/shenandoah/shenandoahJfrSupport.hpp&quot;
  72 #endif
  73 
  74 #include &quot;memory/metaspace.hpp&quot;
  75 #include &quot;oops/compressedOops.inline.hpp&quot;
  76 #include &quot;runtime/atomic.hpp&quot;
  77 #include &quot;runtime/globals.hpp&quot;
  78 #include &quot;runtime/interfaceSupport.inline.hpp&quot;
  79 #include &quot;runtime/orderAccess.hpp&quot;
  80 #include &quot;runtime/safepointMechanism.hpp&quot;
  81 #include &quot;runtime/vmThread.hpp&quot;
  82 #include &quot;services/mallocTracker.hpp&quot;
  83 #include &quot;utilities/powerOfTwo.hpp&quot;
  84 
  85 ShenandoahHeap* ShenandoahHeap::_heap = NULL;
  86 
  87 #ifdef ASSERT
  88 template &lt;class T&gt;
  89 void ShenandoahAssertToSpaceClosure::do_oop_work(T* p) {
</pre>
<hr />
<pre>
 381     _pacer-&gt;setup_for_idle();
 382   } else {
 383     _pacer = NULL;
 384   }
 385 
 386   _control_thread = new ShenandoahControlThread();
 387 
 388   log_info(gc, init)(&quot;Initialize Shenandoah heap: &quot; SIZE_FORMAT &quot;%s initial, &quot; SIZE_FORMAT &quot;%s min, &quot; SIZE_FORMAT &quot;%s max&quot;,
 389                      byte_size_in_proper_unit(_initial_size),  proper_unit_for_byte_size(_initial_size),
 390                      byte_size_in_proper_unit(_minimum_size),  proper_unit_for_byte_size(_minimum_size),
 391                      byte_size_in_proper_unit(max_capacity()), proper_unit_for_byte_size(max_capacity())
 392   );
 393 
 394   log_info(gc, init)(&quot;Safepointing mechanism: thread-local poll&quot;);
 395 
 396   return JNI_OK;
 397 }
 398 
 399 void ShenandoahHeap::initialize_heuristics() {
 400   if (ShenandoahGCMode != NULL) {
<span class="line-modified"> 401     if (strcmp(ShenandoahGCMode, &quot;normal&quot;) == 0) {</span>
<span class="line-modified"> 402       _gc_mode = new ShenandoahNormalMode();</span>
 403     } else if (strcmp(ShenandoahGCMode, &quot;iu&quot;) == 0) {
 404       _gc_mode = new ShenandoahIUMode();
 405     } else if (strcmp(ShenandoahGCMode, &quot;passive&quot;) == 0) {
 406       _gc_mode = new ShenandoahPassiveMode();
 407     } else {
 408       vm_exit_during_initialization(&quot;Unknown -XX:ShenandoahGCMode option&quot;);
 409     }
 410   } else {
 411     ShouldNotReachHere();
 412   }
 413   _gc_mode-&gt;initialize_flags();
 414   if (_gc_mode-&gt;is_diagnostic() &amp;&amp; !UnlockDiagnosticVMOptions) {
 415     vm_exit_during_initialization(
 416             err_msg(&quot;GC mode \&quot;%s\&quot; is diagnostic, and must be enabled via -XX:+UnlockDiagnosticVMOptions.&quot;,
 417                     _gc_mode-&gt;name()));
 418   }
 419   if (_gc_mode-&gt;is_experimental() &amp;&amp; !UnlockExperimentalVMOptions) {
 420     vm_exit_during_initialization(
 421             err_msg(&quot;GC mode \&quot;%s\&quot; is experimental, and must be enabled via -XX:+UnlockExperimentalVMOptions.&quot;,
 422                     _gc_mode-&gt;name()));
</pre>
<hr />
<pre>
2861   op_updaterefs();
2862 }
2863 
2864 void ShenandoahHeap::entry_weak_roots() {
2865   static const char* msg = &quot;Concurrent weak roots&quot;;
2866   ShenandoahConcurrentPhase gc_phase(msg, ShenandoahPhaseTimings::conc_weak_roots);
2867   EventMark em(&quot;%s&quot;, msg);
2868 
2869   ShenandoahGCWorkerPhase worker_phase(ShenandoahPhaseTimings::conc_weak_roots);
2870 
2871   ShenandoahWorkerScope scope(workers(),
2872                               ShenandoahWorkerPolicy::calc_workers_for_conc_root_processing(),
2873                               &quot;concurrent weak root&quot;);
2874 
2875   try_inject_alloc_failure();
2876   op_weak_roots();
2877 }
2878 
2879 void ShenandoahHeap::entry_class_unloading() {
2880   static const char* msg = &quot;Concurrent class unloading&quot;;
<span class="line-modified">2881   ShenandoahConcurrentPhase gc_phase(msg, ShenandoahPhaseTimings::conc_class_unloading);</span>
2882   EventMark em(&quot;%s&quot;, msg);
2883 
2884   ShenandoahWorkerScope scope(workers(),
2885                               ShenandoahWorkerPolicy::calc_workers_for_conc_root_processing(),
2886                               &quot;concurrent class unloading&quot;);
2887 
2888   try_inject_alloc_failure();
2889   op_class_unloading();
2890 }
2891 
2892 void ShenandoahHeap::entry_strong_roots() {
2893   static const char* msg = &quot;Concurrent strong roots&quot;;
2894   ShenandoahConcurrentPhase gc_phase(msg, ShenandoahPhaseTimings::conc_strong_roots);
2895   EventMark em(&quot;%s&quot;, msg);
2896 
2897   ShenandoahGCWorkerPhase worker_phase(ShenandoahPhaseTimings::conc_strong_roots);
2898 
2899   ShenandoahWorkerScope scope(workers(),
2900                               ShenandoahWorkerPolicy::calc_workers_for_conc_root_processing(),
2901                               &quot;concurrent strong root&quot;);
</pre>
</td>
<td>
<hr />
<pre>
  29 #include &quot;gc/shared/gcArguments.hpp&quot;
  30 #include &quot;gc/shared/gcTimer.hpp&quot;
  31 #include &quot;gc/shared/gcTraceTime.inline.hpp&quot;
  32 #include &quot;gc/shared/locationPrinter.inline.hpp&quot;
  33 #include &quot;gc/shared/memAllocator.hpp&quot;
  34 #include &quot;gc/shared/oopStorageSet.hpp&quot;
  35 #include &quot;gc/shared/plab.hpp&quot;
  36 
  37 #include &quot;gc/shenandoah/shenandoahBarrierSet.hpp&quot;
  38 #include &quot;gc/shenandoah/shenandoahClosures.inline.hpp&quot;
  39 #include &quot;gc/shenandoah/shenandoahCollectionSet.hpp&quot;
  40 #include &quot;gc/shenandoah/shenandoahCollectorPolicy.hpp&quot;
  41 #include &quot;gc/shenandoah/shenandoahConcurrentMark.inline.hpp&quot;
  42 #include &quot;gc/shenandoah/shenandoahConcurrentRoots.hpp&quot;
  43 #include &quot;gc/shenandoah/shenandoahControlThread.hpp&quot;
  44 #include &quot;gc/shenandoah/shenandoahFreeSet.hpp&quot;
  45 #include &quot;gc/shenandoah/shenandoahPhaseTimings.hpp&quot;
  46 #include &quot;gc/shenandoah/shenandoahHeap.inline.hpp&quot;
  47 #include &quot;gc/shenandoah/shenandoahHeapRegion.inline.hpp&quot;
  48 #include &quot;gc/shenandoah/shenandoahHeapRegionSet.hpp&quot;

  49 #include &quot;gc/shenandoah/shenandoahMarkCompact.hpp&quot;
  50 #include &quot;gc/shenandoah/shenandoahMarkingContext.inline.hpp&quot;
  51 #include &quot;gc/shenandoah/shenandoahMemoryPool.hpp&quot;
  52 #include &quot;gc/shenandoah/shenandoahMetrics.hpp&quot;
  53 #include &quot;gc/shenandoah/shenandoahMonitoringSupport.hpp&quot;

  54 #include &quot;gc/shenandoah/shenandoahOopClosures.inline.hpp&quot;
  55 #include &quot;gc/shenandoah/shenandoahPacer.inline.hpp&quot;
  56 #include &quot;gc/shenandoah/shenandoahPadding.hpp&quot;
  57 #include &quot;gc/shenandoah/shenandoahParallelCleaning.inline.hpp&quot;

  58 #include &quot;gc/shenandoah/shenandoahRootProcessor.inline.hpp&quot;
  59 #include &quot;gc/shenandoah/shenandoahStringDedup.hpp&quot;
  60 #include &quot;gc/shenandoah/shenandoahTaskqueue.hpp&quot;
  61 #include &quot;gc/shenandoah/shenandoahUtils.hpp&quot;
  62 #include &quot;gc/shenandoah/shenandoahVerifier.hpp&quot;
  63 #include &quot;gc/shenandoah/shenandoahCodeRoots.hpp&quot;
  64 #include &quot;gc/shenandoah/shenandoahVMOperations.hpp&quot;
  65 #include &quot;gc/shenandoah/shenandoahWorkGroup.hpp&quot;
  66 #include &quot;gc/shenandoah/shenandoahWorkerPolicy.hpp&quot;
<span class="line-added">  67 #include &quot;gc/shenandoah/mode/shenandoahIUMode.hpp&quot;</span>
<span class="line-added">  68 #include &quot;gc/shenandoah/mode/shenandoahPassiveMode.hpp&quot;</span>
<span class="line-added">  69 #include &quot;gc/shenandoah/mode/shenandoahSATBMode.hpp&quot;</span>
  70 #if INCLUDE_JFR
  71 #include &quot;gc/shenandoah/shenandoahJfrSupport.hpp&quot;
  72 #endif
  73 
  74 #include &quot;memory/metaspace.hpp&quot;
  75 #include &quot;oops/compressedOops.inline.hpp&quot;
  76 #include &quot;runtime/atomic.hpp&quot;
  77 #include &quot;runtime/globals.hpp&quot;
  78 #include &quot;runtime/interfaceSupport.inline.hpp&quot;
  79 #include &quot;runtime/orderAccess.hpp&quot;
  80 #include &quot;runtime/safepointMechanism.hpp&quot;
  81 #include &quot;runtime/vmThread.hpp&quot;
  82 #include &quot;services/mallocTracker.hpp&quot;
  83 #include &quot;utilities/powerOfTwo.hpp&quot;
  84 
  85 ShenandoahHeap* ShenandoahHeap::_heap = NULL;
  86 
  87 #ifdef ASSERT
  88 template &lt;class T&gt;
  89 void ShenandoahAssertToSpaceClosure::do_oop_work(T* p) {
</pre>
<hr />
<pre>
 381     _pacer-&gt;setup_for_idle();
 382   } else {
 383     _pacer = NULL;
 384   }
 385 
 386   _control_thread = new ShenandoahControlThread();
 387 
 388   log_info(gc, init)(&quot;Initialize Shenandoah heap: &quot; SIZE_FORMAT &quot;%s initial, &quot; SIZE_FORMAT &quot;%s min, &quot; SIZE_FORMAT &quot;%s max&quot;,
 389                      byte_size_in_proper_unit(_initial_size),  proper_unit_for_byte_size(_initial_size),
 390                      byte_size_in_proper_unit(_minimum_size),  proper_unit_for_byte_size(_minimum_size),
 391                      byte_size_in_proper_unit(max_capacity()), proper_unit_for_byte_size(max_capacity())
 392   );
 393 
 394   log_info(gc, init)(&quot;Safepointing mechanism: thread-local poll&quot;);
 395 
 396   return JNI_OK;
 397 }
 398 
 399 void ShenandoahHeap::initialize_heuristics() {
 400   if (ShenandoahGCMode != NULL) {
<span class="line-modified"> 401     if (strcmp(ShenandoahGCMode, &quot;satb&quot;) == 0) {</span>
<span class="line-modified"> 402       _gc_mode = new ShenandoahSATBMode();</span>
 403     } else if (strcmp(ShenandoahGCMode, &quot;iu&quot;) == 0) {
 404       _gc_mode = new ShenandoahIUMode();
 405     } else if (strcmp(ShenandoahGCMode, &quot;passive&quot;) == 0) {
 406       _gc_mode = new ShenandoahPassiveMode();
 407     } else {
 408       vm_exit_during_initialization(&quot;Unknown -XX:ShenandoahGCMode option&quot;);
 409     }
 410   } else {
 411     ShouldNotReachHere();
 412   }
 413   _gc_mode-&gt;initialize_flags();
 414   if (_gc_mode-&gt;is_diagnostic() &amp;&amp; !UnlockDiagnosticVMOptions) {
 415     vm_exit_during_initialization(
 416             err_msg(&quot;GC mode \&quot;%s\&quot; is diagnostic, and must be enabled via -XX:+UnlockDiagnosticVMOptions.&quot;,
 417                     _gc_mode-&gt;name()));
 418   }
 419   if (_gc_mode-&gt;is_experimental() &amp;&amp; !UnlockExperimentalVMOptions) {
 420     vm_exit_during_initialization(
 421             err_msg(&quot;GC mode \&quot;%s\&quot; is experimental, and must be enabled via -XX:+UnlockExperimentalVMOptions.&quot;,
 422                     _gc_mode-&gt;name()));
</pre>
<hr />
<pre>
2861   op_updaterefs();
2862 }
2863 
2864 void ShenandoahHeap::entry_weak_roots() {
2865   static const char* msg = &quot;Concurrent weak roots&quot;;
2866   ShenandoahConcurrentPhase gc_phase(msg, ShenandoahPhaseTimings::conc_weak_roots);
2867   EventMark em(&quot;%s&quot;, msg);
2868 
2869   ShenandoahGCWorkerPhase worker_phase(ShenandoahPhaseTimings::conc_weak_roots);
2870 
2871   ShenandoahWorkerScope scope(workers(),
2872                               ShenandoahWorkerPolicy::calc_workers_for_conc_root_processing(),
2873                               &quot;concurrent weak root&quot;);
2874 
2875   try_inject_alloc_failure();
2876   op_weak_roots();
2877 }
2878 
2879 void ShenandoahHeap::entry_class_unloading() {
2880   static const char* msg = &quot;Concurrent class unloading&quot;;
<span class="line-modified">2881   ShenandoahConcurrentPhase gc_phase(msg, ShenandoahPhaseTimings::conc_class_unload);</span>
2882   EventMark em(&quot;%s&quot;, msg);
2883 
2884   ShenandoahWorkerScope scope(workers(),
2885                               ShenandoahWorkerPolicy::calc_workers_for_conc_root_processing(),
2886                               &quot;concurrent class unloading&quot;);
2887 
2888   try_inject_alloc_failure();
2889   op_class_unloading();
2890 }
2891 
2892 void ShenandoahHeap::entry_strong_roots() {
2893   static const char* msg = &quot;Concurrent strong roots&quot;;
2894   ShenandoahConcurrentPhase gc_phase(msg, ShenandoahPhaseTimings::conc_strong_roots);
2895   EventMark em(&quot;%s&quot;, msg);
2896 
2897   ShenandoahGCWorkerPhase worker_phase(ShenandoahPhaseTimings::conc_strong_roots);
2898 
2899   ShenandoahWorkerScope scope(workers(),
2900                               ShenandoahWorkerPolicy::calc_workers_for_conc_root_processing(),
2901                               &quot;concurrent strong root&quot;);
</pre>
</td>
</tr>
</table>
<center><a href="shenandoahControlThread.cpp.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="shenandoahMarkCompact.cpp.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>