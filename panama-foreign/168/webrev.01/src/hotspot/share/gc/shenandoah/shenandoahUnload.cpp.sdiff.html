<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/hotspot/share/gc/shenandoah/shenandoahUnload.cpp</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
<body>
<center><a href="shenandoahThreadLocalData.hpp.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="shenandoahUnload.hpp.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/hotspot/share/gc/shenandoah/shenandoahUnload.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  *
 23  */
 24 
 25 #include &quot;precompiled.hpp&quot;
 26 
 27 #include &quot;classfile/classLoaderDataGraph.hpp&quot;
 28 #include &quot;classfile/systemDictionary.hpp&quot;
 29 #include &quot;code/codeBehaviours.hpp&quot;
 30 #include &quot;code/codeCache.hpp&quot;
 31 #include &quot;code/dependencyContext.hpp&quot;
 32 #include &quot;gc/shared/gcBehaviours.hpp&quot;
 33 #include &quot;gc/shared/suspendibleThreadSet.hpp&quot;
 34 #include &quot;gc/shenandoah/shenandoahClosures.inline.hpp&quot;
 35 #include &quot;gc/shenandoah/shenandoahCodeRoots.hpp&quot;
 36 #include &quot;gc/shenandoah/shenandoahConcurrentRoots.hpp&quot;
 37 #include &quot;gc/shenandoah/shenandoahHeap.inline.hpp&quot;
 38 #include &quot;gc/shenandoah/shenandoahNMethod.inline.hpp&quot;
 39 #include &quot;gc/shenandoah/shenandoahLock.hpp&quot;

 40 #include &quot;gc/shenandoah/shenandoahRootProcessor.hpp&quot;
 41 #include &quot;gc/shenandoah/shenandoahUnload.hpp&quot;
 42 #include &quot;gc/shenandoah/shenandoahVerifier.hpp&quot;
 43 #include &quot;memory/iterator.hpp&quot;
 44 #include &quot;memory/resourceArea.hpp&quot;
 45 #include &quot;oops/access.inline.hpp&quot;
 46 
 47 class ShenandoahIsUnloadingOopClosure : public OopClosure {
 48 private:
 49   ShenandoahMarkingContext* const _marking_context;
 50   bool                            _is_unloading;
 51 
 52 public:
 53   ShenandoahIsUnloadingOopClosure() :
 54     _marking_context(ShenandoahHeap::heap()-&gt;complete_marking_context()),
 55     _is_unloading(false) {
 56   }
 57 
 58   virtual void do_oop(oop* p) {
 59     if (_is_unloading) {
</pre>
<hr />
<pre>
118   }
119 };
120 
121 ShenandoahUnload::ShenandoahUnload() {
122   if (ShenandoahConcurrentRoots::can_do_concurrent_class_unloading()) {
123     static ShenandoahIsUnloadingBehaviour is_unloading_behaviour;
124     IsUnloadingBehaviour::set_current(&amp;is_unloading_behaviour);
125 
126     static ShenandoahCompiledICProtectionBehaviour ic_protection_behaviour;
127     CompiledICProtectionBehaviour::set_current(&amp;ic_protection_behaviour);
128   }
129 }
130 
131 void ShenandoahUnload::prepare() {
132   assert(SafepointSynchronize::is_at_safepoint(), &quot;Should be at safepoint&quot;);
133   assert(ShenandoahConcurrentRoots::can_do_concurrent_class_unloading(), &quot;Sanity&quot;);
134   CodeCache::increment_unloading_cycle();
135   DependencyContext::cleaning_start();
136 }
137 
<span class="line-removed">138 void ShenandoahUnload::unlink() {</span>
<span class="line-removed">139   SuspendibleThreadSetJoiner sts;</span>
<span class="line-removed">140   bool unloading_occurred;</span>
<span class="line-removed">141   ShenandoahHeap* const heap = ShenandoahHeap::heap();</span>
<span class="line-removed">142   {</span>
<span class="line-removed">143     MutexLocker cldg_ml(ClassLoaderDataGraph_lock);</span>
<span class="line-removed">144     unloading_occurred = SystemDictionary::do_unloading(heap-&gt;gc_timer());</span>
<span class="line-removed">145   }</span>
<span class="line-removed">146 </span>
<span class="line-removed">147   Klass::clean_weak_klass_links(unloading_occurred);</span>
<span class="line-removed">148   ShenandoahCodeRoots::unlink(ShenandoahHeap::heap()-&gt;workers(), unloading_occurred);</span>
<span class="line-removed">149   DependencyContext::cleaning_end();</span>
<span class="line-removed">150 }</span>
<span class="line-removed">151 </span>
<span class="line-removed">152 void ShenandoahUnload::purge() {</span>
<span class="line-removed">153   {</span>
<span class="line-removed">154     SuspendibleThreadSetJoiner sts;</span>
<span class="line-removed">155     ShenandoahCodeRoots::purge(ShenandoahHeap::heap()-&gt;workers());</span>
<span class="line-removed">156   }</span>
<span class="line-removed">157 </span>
<span class="line-removed">158   ClassLoaderDataGraph::purge();</span>
<span class="line-removed">159   CodeCache::purge_exception_caches();</span>
<span class="line-removed">160 }</span>
<span class="line-removed">161 </span>
162 class ShenandoahUnloadRendezvousClosure : public HandshakeClosure {
163 public:
164   ShenandoahUnloadRendezvousClosure() : HandshakeClosure(&quot;ShenandoahUnloadRendezvous&quot;) {}
165   void do_thread(Thread* thread) {}
166 };
167 
168 void ShenandoahUnload::unload() {
<span class="line-modified">169   assert(ShenandoahConcurrentRoots::can_do_concurrent_class_unloading(), &quot;Why we here?&quot;);</span>
<span class="line-modified">170   if (!ShenandoahHeap::heap()-&gt;is_concurrent_weak_root_in_progress()) {</span>
<span class="line-modified">171     return;</span>
<span class="line-removed">172   }</span>
173 
174   // Unlink stale metadata and nmethods
<span class="line-modified">175   unlink();</span>






















176 
177   // Make sure stale metadata and nmethods are no longer observable
<span class="line-modified">178   ShenandoahUnloadRendezvousClosure cl;</span>
<span class="line-modified">179   Handshake::execute(&amp;cl);</span>



180 
181   // Purge stale metadata and nmethods that were unlinked
<span class="line-modified">182   purge();</span>


















183 }
184 
185 void ShenandoahUnload::finish() {
186   MetaspaceGC::compute_new_size();
187   MetaspaceUtils::verify_metrics();
188 }
</pre>
</td>
<td>
<hr />
<pre>
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  *
 23  */
 24 
 25 #include &quot;precompiled.hpp&quot;
 26 
 27 #include &quot;classfile/classLoaderDataGraph.hpp&quot;
 28 #include &quot;classfile/systemDictionary.hpp&quot;
 29 #include &quot;code/codeBehaviours.hpp&quot;
 30 #include &quot;code/codeCache.hpp&quot;
 31 #include &quot;code/dependencyContext.hpp&quot;
 32 #include &quot;gc/shared/gcBehaviours.hpp&quot;
 33 #include &quot;gc/shared/suspendibleThreadSet.hpp&quot;
 34 #include &quot;gc/shenandoah/shenandoahClosures.inline.hpp&quot;
 35 #include &quot;gc/shenandoah/shenandoahCodeRoots.hpp&quot;
 36 #include &quot;gc/shenandoah/shenandoahConcurrentRoots.hpp&quot;
 37 #include &quot;gc/shenandoah/shenandoahHeap.inline.hpp&quot;
 38 #include &quot;gc/shenandoah/shenandoahNMethod.inline.hpp&quot;
 39 #include &quot;gc/shenandoah/shenandoahLock.hpp&quot;
<span class="line-added"> 40 #include &quot;gc/shenandoah/shenandoahPhaseTimings.hpp&quot;</span>
 41 #include &quot;gc/shenandoah/shenandoahRootProcessor.hpp&quot;
 42 #include &quot;gc/shenandoah/shenandoahUnload.hpp&quot;
 43 #include &quot;gc/shenandoah/shenandoahVerifier.hpp&quot;
 44 #include &quot;memory/iterator.hpp&quot;
 45 #include &quot;memory/resourceArea.hpp&quot;
 46 #include &quot;oops/access.inline.hpp&quot;
 47 
 48 class ShenandoahIsUnloadingOopClosure : public OopClosure {
 49 private:
 50   ShenandoahMarkingContext* const _marking_context;
 51   bool                            _is_unloading;
 52 
 53 public:
 54   ShenandoahIsUnloadingOopClosure() :
 55     _marking_context(ShenandoahHeap::heap()-&gt;complete_marking_context()),
 56     _is_unloading(false) {
 57   }
 58 
 59   virtual void do_oop(oop* p) {
 60     if (_is_unloading) {
</pre>
<hr />
<pre>
119   }
120 };
121 
122 ShenandoahUnload::ShenandoahUnload() {
123   if (ShenandoahConcurrentRoots::can_do_concurrent_class_unloading()) {
124     static ShenandoahIsUnloadingBehaviour is_unloading_behaviour;
125     IsUnloadingBehaviour::set_current(&amp;is_unloading_behaviour);
126 
127     static ShenandoahCompiledICProtectionBehaviour ic_protection_behaviour;
128     CompiledICProtectionBehaviour::set_current(&amp;ic_protection_behaviour);
129   }
130 }
131 
132 void ShenandoahUnload::prepare() {
133   assert(SafepointSynchronize::is_at_safepoint(), &quot;Should be at safepoint&quot;);
134   assert(ShenandoahConcurrentRoots::can_do_concurrent_class_unloading(), &quot;Sanity&quot;);
135   CodeCache::increment_unloading_cycle();
136   DependencyContext::cleaning_start();
137 }
138 
























139 class ShenandoahUnloadRendezvousClosure : public HandshakeClosure {
140 public:
141   ShenandoahUnloadRendezvousClosure() : HandshakeClosure(&quot;ShenandoahUnloadRendezvous&quot;) {}
142   void do_thread(Thread* thread) {}
143 };
144 
145 void ShenandoahUnload::unload() {
<span class="line-modified">146   ShenandoahHeap* heap = ShenandoahHeap::heap();</span>
<span class="line-modified">147   assert(ShenandoahConcurrentRoots::can_do_concurrent_class_unloading(), &quot;Filtered by caller&quot;);</span>
<span class="line-modified">148   assert(heap-&gt;is_concurrent_weak_root_in_progress(), &quot;Filtered by caller&quot;);</span>

149 
150   // Unlink stale metadata and nmethods
<span class="line-modified">151   {</span>
<span class="line-added">152     ShenandoahTimingsTracker t(ShenandoahPhaseTimings::conc_class_unload_unlink);</span>
<span class="line-added">153 </span>
<span class="line-added">154     SuspendibleThreadSetJoiner sts;</span>
<span class="line-added">155     bool unloadingOccurred;</span>
<span class="line-added">156     {</span>
<span class="line-added">157       ShenandoahTimingsTracker t(ShenandoahPhaseTimings::conc_class_unload_unlink_sd);</span>
<span class="line-added">158       MutexLocker cldgMl(ClassLoaderDataGraph_lock);</span>
<span class="line-added">159       unloadingOccurred = SystemDictionary::do_unloading(heap-&gt;gc_timer());</span>
<span class="line-added">160     }</span>
<span class="line-added">161 </span>
<span class="line-added">162     {</span>
<span class="line-added">163       ShenandoahTimingsTracker t(ShenandoahPhaseTimings::conc_class_unload_unlink_weak_klass);</span>
<span class="line-added">164       Klass::clean_weak_klass_links(unloadingOccurred);</span>
<span class="line-added">165     }</span>
<span class="line-added">166 </span>
<span class="line-added">167     {</span>
<span class="line-added">168       ShenandoahTimingsTracker t(ShenandoahPhaseTimings::conc_class_unload_unlink_code_roots);</span>
<span class="line-added">169       ShenandoahCodeRoots::unlink(heap-&gt;workers(), unloadingOccurred);</span>
<span class="line-added">170     }</span>
<span class="line-added">171 </span>
<span class="line-added">172     DependencyContext::cleaning_end();</span>
<span class="line-added">173   }</span>
174 
175   // Make sure stale metadata and nmethods are no longer observable
<span class="line-modified">176   {</span>
<span class="line-modified">177     ShenandoahTimingsTracker t(ShenandoahPhaseTimings::conc_class_unload_rendezvous);</span>
<span class="line-added">178     ShenandoahUnloadRendezvousClosure cl;</span>
<span class="line-added">179     Handshake::execute(&amp;cl);</span>
<span class="line-added">180   }</span>
181 
182   // Purge stale metadata and nmethods that were unlinked
<span class="line-modified">183   {</span>
<span class="line-added">184     ShenandoahTimingsTracker t(ShenandoahPhaseTimings::conc_class_unload_purge);</span>
<span class="line-added">185 </span>
<span class="line-added">186     {</span>
<span class="line-added">187       ShenandoahTimingsTracker t(ShenandoahPhaseTimings::conc_class_unload_purge_coderoots);</span>
<span class="line-added">188       SuspendibleThreadSetJoiner sts;</span>
<span class="line-added">189       ShenandoahCodeRoots::purge(heap-&gt;workers());</span>
<span class="line-added">190     }</span>
<span class="line-added">191 </span>
<span class="line-added">192     {</span>
<span class="line-added">193       ShenandoahTimingsTracker t(ShenandoahPhaseTimings::conc_class_unload_purge_cldg);</span>
<span class="line-added">194       ClassLoaderDataGraph::purge();</span>
<span class="line-added">195     }</span>
<span class="line-added">196 </span>
<span class="line-added">197     {</span>
<span class="line-added">198       ShenandoahTimingsTracker t(ShenandoahPhaseTimings::conc_class_unload_purge_ec);</span>
<span class="line-added">199       CodeCache::purge_exception_caches();</span>
<span class="line-added">200     }</span>
<span class="line-added">201   }</span>
202 }
203 
204 void ShenandoahUnload::finish() {
205   MetaspaceGC::compute_new_size();
206   MetaspaceUtils::verify_metrics();
207 }
</pre>
</td>
</tr>
</table>
<center><a href="shenandoahThreadLocalData.hpp.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="shenandoahUnload.hpp.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>