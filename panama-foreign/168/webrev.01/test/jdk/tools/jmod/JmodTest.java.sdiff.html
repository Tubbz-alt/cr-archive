<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff test/jdk/tools/jmod/JmodTest.java</title>
    <link rel="stylesheet" href="../../../../style.css" />
  </head>
<body>
<center><a href="../../sun/tools/jstatd/TestJstatdUsage.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="../jpackage/windows/WinUpgradeUUIDTest.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>test/jdk/tools/jmod/JmodTest.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  1 /**
<span class="line-modified">  2  * Copyright (c) 2015, 2017, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 /*
 25  * @test
<span class="line-modified"> 26  * @bug 8142968 8166568 8166286 8170618 8168149</span>
 27  * @summary Basic test for jmod
 28  * @library /test/lib
 29  * @modules jdk.compiler
 30  *          jdk.jlink
 31  * @build jdk.test.lib.compiler.CompilerUtils
 32  *        jdk.test.lib.util.FileUtils
 33  *        jdk.test.lib.Platform
 34  * @run testng/othervm -Djava.io.tmpdir=. JmodTest
 35  */
 36 
 37 import java.io.*;
 38 import java.lang.module.ModuleDescriptor;
 39 import java.lang.reflect.Method;
 40 import java.nio.file.*;
 41 import java.util.*;
 42 import java.util.function.Consumer;
 43 import java.util.regex.Pattern;
 44 import java.util.spi.ToolProvider;
 45 import java.util.stream.Stream;
 46 import jdk.test.lib.compiler.CompilerUtils;
 47 import jdk.test.lib.util.FileUtils;
 48 import org.testng.annotations.BeforeTest;
 49 import org.testng.annotations.Test;
 50 
 51 import static java.io.File.pathSeparator;
 52 import static java.lang.module.ModuleDescriptor.Version;
 53 import static java.nio.charset.StandardCharsets.UTF_8;
 54 import static java.util.stream.Collectors.toSet;
 55 import static org.testng.Assert.*;
 56 
 57 public class JmodTest {
 58 
 59     static final ToolProvider JMOD_TOOL = ToolProvider.findFirst(&quot;jmod&quot;)
 60         .orElseThrow(() -&gt;
 61             new RuntimeException(&quot;jmod tool not found&quot;)
 62         );




 63 
 64     static final String TEST_SRC = System.getProperty(&quot;test.src&quot;, &quot;.&quot;);
 65     static final Path SRC_DIR = Paths.get(TEST_SRC, &quot;src&quot;);
 66     static final Path EXPLODED_DIR = Paths.get(&quot;build&quot;);
 67     static final Path MODS_DIR = Paths.get(&quot;jmods&quot;);
 68 
 69     static final String CLASSES_PREFIX = &quot;classes/&quot;;
 70     static final String CMDS_PREFIX = &quot;bin/&quot;;
 71     static final String LIBS_PREFIX = &quot;lib/&quot;;
 72     static final String CONFIGS_PREFIX = &quot;conf/&quot;;
 73 
 74     @BeforeTest
 75     public void buildExplodedModules() throws IOException {
 76         if (Files.exists(EXPLODED_DIR))
 77             FileUtils.deleteFileTreeWithRetry(EXPLODED_DIR);
 78 
 79         for (String name : new String[] { &quot;foo&quot;/*, &quot;bar&quot;, &quot;baz&quot;*/ } ) {
 80             Path dir = EXPLODED_DIR.resolve(name);
 81             assertTrue(compileModule(name, dir.resolve(&quot;classes&quot;)));
 82             copyResource(SRC_DIR.resolve(&quot;foo&quot;),
</pre>
<hr />
<pre>
419 
420         jmod(&quot;create&quot;,
421              &quot;--class-path&quot;, cp + pathSeparator + cp,
422              jmod.toString())
423              .assertSuccess()
424              .resultChecker(r -&gt;
425                  assertContains(r.output, &quot;Warning: ignoring duplicate entry&quot;)
426              );
427 
428         FileUtils.deleteFileIfExistsWithRetry(jmod);
429         jmod(&quot;create&quot;,
430              &quot;--class-path&quot;, cp,
431              &quot;--libs&quot;, lp.toString() + pathSeparator + lp.toString(),
432              jmod.toString())
433              .assertSuccess()
434              .resultChecker(r -&gt;
435                  assertContains(r.output, &quot;Warning: ignoring duplicate entry&quot;)
436              );
437     }
438 



















439     @Test
440     public void testIgnoreModuleInfoInOtherSections() throws IOException {
441         Path jmod = MODS_DIR.resolve(&quot;testIgnoreModuleInfoInOtherSections.jmod&quot;);
442         FileUtils.deleteFileIfExistsWithRetry(jmod);
443         String cp = EXPLODED_DIR.resolve(&quot;foo&quot;).resolve(&quot;classes&quot;).toString();
444 
445         jmod(&quot;create&quot;,
446             &quot;--class-path&quot;, cp,
447             &quot;--libs&quot;, cp,
448             jmod.toString())
449             .assertSuccess()
450             .resultChecker(r -&gt;
451                 assertContains(r.output, &quot;Warning: ignoring entry&quot;)
452             );
453 
454         FileUtils.deleteFileIfExistsWithRetry(jmod);
455         jmod(&quot;create&quot;,
456              &quot;--class-path&quot;, cp,
457              &quot;--cmds&quot;, cp,
458              jmod.toString())
</pre>
</td>
<td>
<hr />
<pre>
  1 /**
<span class="line-modified">  2  * Copyright (c) 2015, 2020, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 /*
 25  * @test
<span class="line-modified"> 26  * @bug 8142968 8166568 8166286 8170618 8168149 8240910</span>
 27  * @summary Basic test for jmod
 28  * @library /test/lib
 29  * @modules jdk.compiler
 30  *          jdk.jlink
 31  * @build jdk.test.lib.compiler.CompilerUtils
 32  *        jdk.test.lib.util.FileUtils
 33  *        jdk.test.lib.Platform
 34  * @run testng/othervm -Djava.io.tmpdir=. JmodTest
 35  */
 36 
 37 import java.io.*;
 38 import java.lang.module.ModuleDescriptor;
 39 import java.lang.reflect.Method;
 40 import java.nio.file.*;
 41 import java.util.*;
 42 import java.util.function.Consumer;
 43 import java.util.regex.Pattern;
 44 import java.util.spi.ToolProvider;
 45 import java.util.stream.Stream;
 46 import jdk.test.lib.compiler.CompilerUtils;
 47 import jdk.test.lib.util.FileUtils;
 48 import org.testng.annotations.BeforeTest;
 49 import org.testng.annotations.Test;
 50 
 51 import static java.io.File.pathSeparator;
 52 import static java.lang.module.ModuleDescriptor.Version;
 53 import static java.nio.charset.StandardCharsets.UTF_8;
 54 import static java.util.stream.Collectors.toSet;
 55 import static org.testng.Assert.*;
 56 
 57 public class JmodTest {
 58 
 59     static final ToolProvider JMOD_TOOL = ToolProvider.findFirst(&quot;jmod&quot;)
 60         .orElseThrow(() -&gt;
 61             new RuntimeException(&quot;jmod tool not found&quot;)
 62         );
<span class="line-added"> 63     static final ToolProvider JAR_TOOL = ToolProvider.findFirst(&quot;jar&quot;)</span>
<span class="line-added"> 64         .orElseThrow(() -&gt;</span>
<span class="line-added"> 65             new RuntimeException(&quot;jar tool not found&quot;)</span>
<span class="line-added"> 66         );</span>
 67 
 68     static final String TEST_SRC = System.getProperty(&quot;test.src&quot;, &quot;.&quot;);
 69     static final Path SRC_DIR = Paths.get(TEST_SRC, &quot;src&quot;);
 70     static final Path EXPLODED_DIR = Paths.get(&quot;build&quot;);
 71     static final Path MODS_DIR = Paths.get(&quot;jmods&quot;);
 72 
 73     static final String CLASSES_PREFIX = &quot;classes/&quot;;
 74     static final String CMDS_PREFIX = &quot;bin/&quot;;
 75     static final String LIBS_PREFIX = &quot;lib/&quot;;
 76     static final String CONFIGS_PREFIX = &quot;conf/&quot;;
 77 
 78     @BeforeTest
 79     public void buildExplodedModules() throws IOException {
 80         if (Files.exists(EXPLODED_DIR))
 81             FileUtils.deleteFileTreeWithRetry(EXPLODED_DIR);
 82 
 83         for (String name : new String[] { &quot;foo&quot;/*, &quot;bar&quot;, &quot;baz&quot;*/ } ) {
 84             Path dir = EXPLODED_DIR.resolve(name);
 85             assertTrue(compileModule(name, dir.resolve(&quot;classes&quot;)));
 86             copyResource(SRC_DIR.resolve(&quot;foo&quot;),
</pre>
<hr />
<pre>
423 
424         jmod(&quot;create&quot;,
425              &quot;--class-path&quot;, cp + pathSeparator + cp,
426              jmod.toString())
427              .assertSuccess()
428              .resultChecker(r -&gt;
429                  assertContains(r.output, &quot;Warning: ignoring duplicate entry&quot;)
430              );
431 
432         FileUtils.deleteFileIfExistsWithRetry(jmod);
433         jmod(&quot;create&quot;,
434              &quot;--class-path&quot;, cp,
435              &quot;--libs&quot;, lp.toString() + pathSeparator + lp.toString(),
436              jmod.toString())
437              .assertSuccess()
438              .resultChecker(r -&gt;
439                  assertContains(r.output, &quot;Warning: ignoring duplicate entry&quot;)
440              );
441     }
442 
<span class="line-added">443     @Test</span>
<span class="line-added">444     public void testDuplicateEntriesFromJarFile() throws IOException {</span>
<span class="line-added">445         String cp = EXPLODED_DIR.resolve(&quot;foo&quot;).resolve(&quot;classes&quot;).toString();</span>
<span class="line-added">446         Path jar = Paths.get(&quot;foo.jar&quot;);</span>
<span class="line-added">447         Path jmod = MODS_DIR.resolve(&quot;testDuplicates.jmod&quot;);</span>
<span class="line-added">448         FileUtils.deleteFileIfExistsWithRetry(jar);</span>
<span class="line-added">449         FileUtils.deleteFileIfExistsWithRetry(jmod);</span>
<span class="line-added">450         // create JAR file</span>
<span class="line-added">451         assertTrue(JAR_TOOL.run(System.out, System.err, &quot;cf&quot;, jar.toString(), &quot;-C&quot;, cp, &quot;.&quot;) == 0);</span>
<span class="line-added">452 </span>
<span class="line-added">453         jmod(&quot;create&quot;,</span>
<span class="line-added">454              &quot;--class-path&quot;, jar.toString() + pathSeparator + jar.toString(),</span>
<span class="line-added">455              jmod.toString())</span>
<span class="line-added">456              .assertSuccess()</span>
<span class="line-added">457              .resultChecker(r -&gt;</span>
<span class="line-added">458                  assertContains(r.output, &quot;Warning: ignoring duplicate entry&quot;)</span>
<span class="line-added">459              );</span>
<span class="line-added">460     }</span>
<span class="line-added">461 </span>
462     @Test
463     public void testIgnoreModuleInfoInOtherSections() throws IOException {
464         Path jmod = MODS_DIR.resolve(&quot;testIgnoreModuleInfoInOtherSections.jmod&quot;);
465         FileUtils.deleteFileIfExistsWithRetry(jmod);
466         String cp = EXPLODED_DIR.resolve(&quot;foo&quot;).resolve(&quot;classes&quot;).toString();
467 
468         jmod(&quot;create&quot;,
469             &quot;--class-path&quot;, cp,
470             &quot;--libs&quot;, cp,
471             jmod.toString())
472             .assertSuccess()
473             .resultChecker(r -&gt;
474                 assertContains(r.output, &quot;Warning: ignoring entry&quot;)
475             );
476 
477         FileUtils.deleteFileIfExistsWithRetry(jmod);
478         jmod(&quot;create&quot;,
479              &quot;--class-path&quot;, cp,
480              &quot;--cmds&quot;, cp,
481              jmod.toString())
</pre>
</td>
</tr>
</table>
<center><a href="../../sun/tools/jstatd/TestJstatdUsage.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="../jpackage/windows/WinUpgradeUUIDTest.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>