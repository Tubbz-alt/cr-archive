<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>New test/jdk/java/security/misc/Versions.java</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
  <body>
    <pre>
 1 /*
 2  * Copyright (c) 2019, 2020, Oracle and/or its affiliates. All rights reserved.
 3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 4  *
 5  * This code is free software; you can redistribute it and/or modify it
 6  * under the terms of the GNU General Public License version 2 only, as
 7  * published by the Free Software Foundation.
 8  *
 9  * This code is distributed in the hope that it will be useful, but WITHOUT
10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
12  * version 2 for more details (a copy is included in the LICENSE file that
13  * accompanied this code).
14  *
15  * You should have received a copy of the GNU General Public License version
16  * 2 along with this work; if not, write to the Free Software Foundation,
17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
18  *
19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
20  * or visit www.oracle.com if you need additional information or have any
21  * questions.
22  */
23 
24 /*
25  * @test
26  * @bug 8232357 8221801 8244674
27  * @summary Make sure version info is consistent between code and license
28  * @run testng Versions
29  */
30 
31 import org.testng.Assert;
32 import org.testng.annotations.DataProvider;
33 import org.testng.annotations.Test;
34 
35 import java.io.IOException;
36 import java.nio.file.Files;
37 import java.nio.file.Path;
38 import java.util.regex.Matcher;
39 import java.util.regex.Pattern;
40 
41 public class Versions {
42 
43     Path rootPath = Path.of(System.getProperty(&quot;test.root&quot;), &quot;../..&quot;);
44     Path legalPath = Path.of(System.getProperty(&quot;test.jdk&quot;), &quot;legal&quot;);
45 
46     @DataProvider(name = &quot;data&quot;)
47     public Object[][] createData() {
48         return new Object[][]{
49                 {&quot;src/java.xml.crypto/share/classes/org/jcp/xml/dsig/internal/dom/XMLDSigRI.java&quot;,
50                         Pattern.compile(&quot;// Apache Santuario XML Security for Java, version (?&lt;n&gt;\\S+)&quot;),
51                         &quot;src/java.xml.crypto/share/legal/santuario.md&quot;,
52                         Pattern.compile(&quot;## Apache Santuario v(?&lt;n&gt;\\S+)&quot;),
53                         &quot;java.xml.crypto/santuario.md&quot;},
54                 {&quot;make/data/publicsuffixlist/VERSION&quot;,
55                         Pattern.compile(&quot;list/(?&lt;n&gt;[0-9a-f]+)/public_suffix_list.dat&quot;),
56                         &quot;src/java.base/share/legal/public_suffix.md&quot;,
57                         Pattern.compile(&quot;list/(?&lt;n&gt;[0-9a-f]+)/public_suffix_list.dat&quot;),
58                         &quot;java.base/public_suffix.md&quot;},
59                 {&quot;src/java.smartcardio/unix/native/libj2pcsc/MUSCLE/pcsclite.h&quot;,
60                         Pattern.compile(&quot;#define PCSCLITE_VERSION_NUMBER +\&quot;(?&lt;n&gt;[0-9\\.]+)\&quot;&quot;),
61                         &quot;src/java.smartcardio/unix/legal/pcsclite.md&quot;,
62                         Pattern.compile(&quot;## PC/SC Lite v(?&lt;n&gt;[0-9\\.]+)&quot;),
63                         &quot;java.smartcardio/pcsclite.md&quot;}
64         };
65     }
66 
67     @Test(dataProvider = &quot;data&quot;)
68     public void Test(String src, Pattern sp, String legal, Pattern lp,
69                      String legalInBuild) throws IOException {
70 
71         Path pSrc = rootPath.resolve(src);
72         Path pLegal = rootPath.resolve(legal);
73 
74         Assert.assertEquals(fetch(pSrc, sp), fetch(pLegal, lp));
75 
76         Path pLegalInBuild = legalPath.resolve(legalInBuild);
77         if (!Files.exists(pLegalInBuild)) {
78             System.out.println(&quot;Not an image build, or file platform dependent&quot;);
79         } else {
80             Assert.assertEquals(Files.mismatch(pLegal, pLegalInBuild), -1);
81         }
82     }
83 
84     // Find a match in path and return the extracted named group
85     static String fetch(Path path, Pattern pattern)
86             throws IOException  {
87         return Files.lines(path)
88                 .map(pattern::matcher)
89                 .filter(Matcher::find)
90                 .findFirst()
91                 .map(m -&gt; m.group(&quot;n&quot;))
92                 .get();
93     }
94 }
    </pre>
  </body>
</html>