<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff test/jdk/jdk/jfr/tool/TestPrintJSON.java</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
<body>
<center><a href="../event/gc/objectcount/TestObjectCountEvent.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="../../../lib/testlibrary/java/lang/UCDFiles.java.cdiff.html" target="_top">next &gt;</a></center>    <h2>test/jdk/jdk/jfr/tool/TestPrintJSON.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 1,7 ***</span>
  /*
<span class="line-modified">!  * Copyright (c) 2016, 2018, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.  Oracle designates this
<span class="line-new-header">--- 1,7 ---</span>
  /*
<span class="line-modified">!  * Copyright (c) 2016, 2020, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.  Oracle designates this
</pre>
<hr />
<pre>
<span class="line-old-header">*** 29,32 ***</span>
  import java.time.OffsetDateTime;
  import java.util.Collections;
  import java.util.Iterator;
  import java.util.List;
  
<span class="line-removed">- import javax.script.ScriptEngine;</span>
<span class="line-removed">- import javax.script.ScriptEngineManager;</span>
<span class="line-removed">- </span>
  import jdk.jfr.Timespan;
  import jdk.jfr.Timestamp;
  import jdk.jfr.ValueDescriptor;
  import jdk.jfr.consumer.RecordedEvent;
  import jdk.jfr.consumer.RecordedObject;
  import jdk.jfr.consumer.RecordingFile;
<span class="line-modified">! import jdk.nashorn.api.scripting.JSObject;</span>
  import jdk.test.lib.Asserts;
  import jdk.test.lib.process.OutputAnalyzer;
  
  /**
   * @test
   * @key jfr
   * @summary Tests print --json
   * @requires vm.hasJFR
   *
   * @library /test/lib /test/jdk
<span class="line-modified">!  * @modules jdk.scripting.nashorn</span>
<span class="line-removed">-  *          jdk.jfr</span>
   *
   * @run main/othervm jdk.jfr.tool.TestPrintJSON
   */
  public class TestPrintJSON {
  
<span class="line-new-header">--- 29,28 ---</span>
  import java.time.OffsetDateTime;
  import java.util.Collections;
  import java.util.Iterator;
  import java.util.List;
  
  import jdk.jfr.Timespan;
  import jdk.jfr.Timestamp;
  import jdk.jfr.ValueDescriptor;
  import jdk.jfr.consumer.RecordedEvent;
  import jdk.jfr.consumer.RecordedObject;
  import jdk.jfr.consumer.RecordingFile;
<span class="line-modified">! import jdk.jfr.tool.JSONValue.JSONArray;</span>
  import jdk.test.lib.Asserts;
  import jdk.test.lib.process.OutputAnalyzer;
  
  /**
   * @test
   * @key jfr
   * @summary Tests print --json
   * @requires vm.hasJFR
   *
   * @library /test/lib /test/jdk
<span class="line-modified">!  * @modules jdk.jfr</span>
   *
   * @run main/othervm jdk.jfr.tool.TestPrintJSON
   */
  public class TestPrintJSON {
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 63,46 ***</span>
          Path recordingFile = ExecuteHelper.createProfilingRecording().toAbsolutePath();
  
          OutputAnalyzer output = ExecuteHelper.jfr(&quot;print&quot;, &quot;--json&quot;, &quot;--stack-depth&quot;, &quot;999&quot;, recordingFile.toString());
          String json = output.getStdout();
  
<span class="line-modified">!         // Parse JSON using Nashorn</span>
<span class="line-modified">!         String statement = &quot;var jsonObject = &quot; + json;</span>
<span class="line-modified">!         ScriptEngineManager factory = new ScriptEngineManager();</span>
<span class="line-removed">-         ScriptEngine engine = factory.getEngineByName(&quot;nashorn&quot;);</span>
<span class="line-removed">-         engine.eval(statement);</span>
<span class="line-removed">-         JSObject o = (JSObject) engine.get(&quot;jsonObject&quot;);</span>
<span class="line-removed">-         JSObject recording = (JSObject) o.getMember(&quot;recording&quot;);</span>
<span class="line-removed">-         JSObject jsonEvents = (JSObject) recording.getMember(&quot;events&quot;);</span>
<span class="line-removed">- </span>
          List&lt;RecordedEvent&gt; events = RecordingFile.readAllEvents(recordingFile);
          Collections.sort(events, (e1, e2) -&gt; e1.getEndTime().compareTo(e2.getEndTime()));
          // Verify events are equal
          Iterator&lt;RecordedEvent&gt; it = events.iterator();
<span class="line-modified">! </span>
<span class="line-removed">-         for (Object jsonEvent : jsonEvents.values()) {</span>
              RecordedEvent recordedEvent = it.next();
              String typeName = recordedEvent.getEventType().getName();
<span class="line-modified">!             Asserts.assertEquals(typeName, ((JSObject) jsonEvent).getMember(&quot;type&quot;).toString());</span>
              assertEquals(jsonEvent, recordedEvent);
          }
<span class="line-modified">!         Asserts.assertFalse(events.size() != jsonEvents.values().size(), &quot;Incorrect number of events&quot;);</span>
      }
  
      private static void assertEquals(Object jsonObject, Object jfrObject) throws Exception {
          // Check object
          if (jfrObject instanceof RecordedObject) {
<span class="line-modified">!             JSObject values = (JSObject) ((JSObject) jsonObject).getMember(&quot;values&quot;);</span>
              RecordedObject recObject = (RecordedObject) jfrObject;
<span class="line-modified">!             Asserts.assertEquals(values.values().size(), recObject.getFields().size());</span>
              for (ValueDescriptor v : recObject.getFields()) {
                  String name = v.getName();
<span class="line-modified">!                 Object jsonValue = values.getMember(name);</span>
                  Object expectedValue = recObject.getValue(name);
                  if (v.getAnnotation(Timestamp.class) != null) {
                      // Make instant of OffsetDateTime
<span class="line-modified">!                     jsonValue = OffsetDateTime.parse(&quot;&quot; + jsonValue).toInstant().toString();</span>
                      expectedValue = recObject.getInstant(name);
                  }
                  if (v.getAnnotation(Timespan.class) != null) {
                      expectedValue = recObject.getDuration(name);
                  }
<span class="line-new-header">--- 59,40 ---</span>
          Path recordingFile = ExecuteHelper.createProfilingRecording().toAbsolutePath();
  
          OutputAnalyzer output = ExecuteHelper.jfr(&quot;print&quot;, &quot;--json&quot;, &quot;--stack-depth&quot;, &quot;999&quot;, recordingFile.toString());
          String json = output.getStdout();
  
<span class="line-modified">!         JSONValue o = JSONValue.parse(json);</span>
<span class="line-modified">!         JSONValue recording = o.get(&quot;recording&quot;);</span>
<span class="line-modified">!         JSONArray jsonEvents = recording.get(&quot;events&quot;).asArray();</span>
          List&lt;RecordedEvent&gt; events = RecordingFile.readAllEvents(recordingFile);
          Collections.sort(events, (e1, e2) -&gt; e1.getEndTime().compareTo(e2.getEndTime()));
          // Verify events are equal
          Iterator&lt;RecordedEvent&gt; it = events.iterator();
<span class="line-modified">!         for (JSONValue jsonEvent : jsonEvents) {</span>
              RecordedEvent recordedEvent = it.next();
              String typeName = recordedEvent.getEventType().getName();
<span class="line-modified">!             Asserts.assertEquals(typeName,  jsonEvent.get(&quot;type&quot;).asString());</span>
              assertEquals(jsonEvent, recordedEvent);
          }
<span class="line-modified">!         Asserts.assertFalse(events.size() != jsonEvents.size(), &quot;Incorrect number of events&quot;);</span>
      }
  
      private static void assertEquals(Object jsonObject, Object jfrObject) throws Exception {
          // Check object
          if (jfrObject instanceof RecordedObject) {
<span class="line-modified">!             JSONValue values = ((JSONValue)jsonObject).get(&quot;values&quot;);</span>
              RecordedObject recObject = (RecordedObject) jfrObject;
<span class="line-modified">!             Asserts.assertEquals(values.size(), recObject.getFields().size());</span>
              for (ValueDescriptor v : recObject.getFields()) {
                  String name = v.getName();
<span class="line-modified">!                 Object jsonValue = values.get(name);</span>
                  Object expectedValue = recObject.getValue(name);
                  if (v.getAnnotation(Timestamp.class) != null) {
                      // Make instant of OffsetDateTime
<span class="line-modified">!                     String text = ((JSONValue)jsonValue).asString();</span>
<span class="line-added">+                     jsonValue = OffsetDateTime.parse(text).toInstant().toString();</span>
                      expectedValue = recObject.getInstant(name);
                  }
                  if (v.getAnnotation(Timespan.class) != null) {
                      expectedValue = recObject.getDuration(name);
                  }
</pre>
<hr />
<pre>
<span class="line-old-header">*** 111,13 ***</span>
              }
          }
          // Check array
          if (jfrObject != null &amp;&amp; jfrObject.getClass().isArray()) {
              Object[] jfrArray = (Object[]) jfrObject;
<span class="line-modified">!             JSObject jsArray = (JSObject) jsonObject;</span>
              for (int i = 0; i &lt; jfrArray.length; i++) {
<span class="line-modified">!                 assertEquals(jsArray.getSlot(i), jfrArray[i]);</span>
              }
              return;
          }
          String jsonText = String.valueOf(jsonObject);
          // Double.NaN / Double.Inifinity is not supported by JSON format,
<span class="line-new-header">--- 101,13 ---</span>
              }
          }
          // Check array
          if (jfrObject != null &amp;&amp; jfrObject.getClass().isArray()) {
              Object[] jfrArray = (Object[]) jfrObject;
<span class="line-modified">!             JSONArray jsArray = ((JSONArray)jsonObject);</span>
              for (int i = 0; i &lt; jfrArray.length; i++) {
<span class="line-modified">!                 assertEquals(jsArray.get(i), jfrArray[i]);</span>
              }
              return;
          }
          String jsonText = String.valueOf(jsonObject);
          // Double.NaN / Double.Inifinity is not supported by JSON format,
</pre>
<center><a href="../event/gc/objectcount/TestObjectCountEvent.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="../../../lib/testlibrary/java/lang/UCDFiles.java.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>