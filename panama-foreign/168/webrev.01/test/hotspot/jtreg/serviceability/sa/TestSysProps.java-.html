<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Old test/hotspot/jtreg/serviceability/sa/TestSysProps.java</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
  <body>
    <pre>
  1 /*
  2  * Copyright (c) 2020, Oracle and/or its affiliates. All rights reserved.
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 import java.io.OutputStream;
 25 import java.util.Arrays;
 26 import java.util.List;
 27 
 28 import jdk.test.lib.apps.LingeredApp;
 29 import jdk.test.lib.JDKToolLauncher;
 30 import jdk.test.lib.Platform;
 31 import jdk.test.lib.process.OutputAnalyzer;
 32 import jdk.test.lib.process.ProcessTools;
 33 import jdk.test.lib.SA.SATestUtils;
 34 
 35 /**
 36  * @test
 37  * @bug 8242165 8242162
 38  * @summary Test &quot;jhsdb jinfo --sysprops&quot;, &quot;jinfo -sysprops&quot;, and clhsdb &quot;sysprops&quot; commands
 39  * @requires vm.hasSA
 40  * @library /test/lib
 41  * @run main/othervm TestSysProps
 42  */
 43 
 44 public class TestSysProps {
 45     public static void findProp(String[] propLines, String propname, String cmdName) {
 46         boolean found = false;
 47         for (String propLine : propLines) {
 48             if (propLine.startsWith(propname)) {
 49                 found = true;
 50                 break;
 51             }
 52         }
 53         if (!found) {
 54             throw new RuntimeException(&quot;Could not find property in &quot; + cmdName + &quot; output: &quot; + propname);
 55         }
 56     }
 57 
 58     public static void countProps(String[] propLines, int expectedCount, String cmdName) {
 59         int numProps = 0;
 60         for (String propLine : propLines) {
 61             if (propLine.indexOf(&quot;=&quot;) != -1) {
 62                 numProps++;
 63             }
 64         }
 65         if (numProps != expectedCount) {
 66             throw new RuntimeException(&quot;Wrong number of &quot; + cmdName + &quot; properties: &quot; + numProps);
 67         }
 68     }
 69 
 70     public static void main (String... args) throws Exception {
 71         SATestUtils.skipIfCannotAttach(); // throws SkippedException if attach not expected to work.
 72         LingeredAppSysProps app = null;
 73 
 74         try {
 75             app = new LingeredAppSysProps();
 76             LingeredApp.startApp(app);
 77             System.out.println(&quot;Started LingeredAppSysProps with pid &quot; + app.getPid());
 78 
 79             // Get properties using the SA version of jinfo
 80 
 81             JDKToolLauncher jhsdbLauncher = JDKToolLauncher.createUsingTestJDK(&quot;jhsdb&quot;);
 82             jhsdbLauncher.addToolArg(&quot;jinfo&quot;);
 83             jhsdbLauncher.addToolArg(&quot;--sysprops&quot;);
 84             jhsdbLauncher.addToolArg(&quot;--pid&quot;);
 85             jhsdbLauncher.addToolArg(Long.toString(app.getPid()));
 86 
 87             ProcessBuilder jhsdbPb = SATestUtils.createProcessBuilder(jhsdbLauncher);
 88             System.out.println(&quot;&gt; &quot; + ProcessTools.getCommandLine(jhsdbPb));
 89             Process jhsdb = jhsdbPb.start();
 90             OutputAnalyzer jhsdbOut = new OutputAnalyzer(jhsdb);
 91 
 92             jhsdb.waitFor();
 93 
 94             System.out.println(jhsdbOut.getStdout());
 95             System.err.println(jhsdbOut.getStderr());
 96 
 97             jhsdbOut.shouldMatch(&quot;Debugger attached successfully.&quot;);
 98 
 99             // Get the properties using the Attach API version of jinfo
100 
101             JDKToolLauncher jinfoLauncher = JDKToolLauncher.createUsingTestJDK(&quot;jinfo&quot;);
102             jinfoLauncher.addToolArg(&quot;-sysprops&quot;);
103             jinfoLauncher.addToolArg(Long.toString(app.getPid()));
104 
105             List&lt;String&gt; cmdStringList = Arrays.asList(jinfoLauncher.getCommand());
106             ProcessBuilder jinfoPb = new ProcessBuilder(cmdStringList);
107             System.out.println(&quot;&gt; &quot; + ProcessTools.getCommandLine(jinfoPb));
108             Process jinfo = jinfoPb.start();
109             OutputAnalyzer jinfoOut = new OutputAnalyzer(jinfo);
110 
111             jinfo.waitFor();
112 
113             System.out.println(jinfoOut.getStdout());
114             System.err.println(jinfoOut.getStderr());
115 
116             jinfoOut.shouldMatch(&quot;Java System Properties:&quot;);
117 
118             // Get the properties using &quot;clhsdb sysprops&quot;.
119 
120             System.out.println(&quot;clhsdb sysprops output:&quot;);
121             ClhsdbLauncher test = new ClhsdbLauncher();
122             List&lt;String&gt; cmds = List.of(&quot;sysprops&quot;);
123             String output = test.run(app.getPid(), cmds, null, null);
124             OutputAnalyzer clhsdbOut = new OutputAnalyzer(output);
125             clhsdbOut.shouldMatch(&quot;java.specification.version&quot;);
126 
127             // Get the output from LingeredAppSysProps, which has printed all the
128             // system properties using java.
129 
130             app.stopApp();
131             System.out.println(&quot;LingeredAppSysProps output:&quot;);
132             System.out.println(app.getOutput().getStdout());
133             System.err.println(app.getOutput().getStderr());
134             OutputAnalyzer appOut = new OutputAnalyzer(app.getOutput().getStdout());
135             appOut.shouldMatch(&quot;-- listing properties --&quot;);
136 
137             // Now make sure the above 3 outputs all contain the same list of properties.
138             // We don&#39;t compare the property values since sometimes they get truncated
139             // in one list but not the other, and also special characters are not always
140             // handled the same.
141 
142             String[] jhsdbLines = jhsdbOut.getStdout().split(&quot;\\R&quot;);
143             String[] jinfoLines = jinfoOut.getStdout().split(&quot;\\R&quot;);
144             String[] clhsdbLines = clhsdbOut.getStdout().split(&quot;\\R&quot;);
145             String[] appLines   = app.getOutput().getStdout().split(&quot;\\R&quot;);
146             int numAppProps = 0;
147             boolean foundStartOfList = false;
148             for (String appProp : appLines) {
149                 // Skip any output that occurs before the first property
150                 if (!foundStartOfList) {
151                     if (appProp.indexOf(&quot;-- listing properties --&quot;) != -1) {
152                         foundStartOfList = true;
153                     }
154                     continue;
155                 }
156 
157                 // Find the next property in the app output
158                 int idx = appProp.indexOf(&quot;=&quot;);
159                 if (idx == -1) continue; // This line does not contain a property
160                 String propname = appProp.substring(0, idx);
161                 System.out.println(&quot;Found prop &quot; + propname);
162                 numAppProps++;
163 
164                 // Make sure we can find the property in each of the other 3 lists
165                 findProp(jhsdbLines, propname, &quot;jhsdb jinfo&quot;);
166                 findProp(jinfoLines, propname, &quot;jinfo&quot;);
167                 findProp(clhsdbLines, propname, &quot;clhsdb sysprops&quot;);
168             }
169 
170             // Make sure we found a reasonable number of properties in the app output. It should
171             // be close to 45, but the spec only mandates 29, so this is what we check for. The
172             // main reason for this check is just to make sure something didn&#39;t go drastically
173             // wrong, resulting in no properties in the app output, meaning that no comparison
174             // was actually done with the other sets of output.
175             System.out.println(numAppProps + &quot; properties found.&quot;);
176             if (numAppProps &lt; 29) {
177                 throw new RuntimeException(&quot;Did not find at least 29 properties: &quot; + numAppProps);
178             }
179 
180             // Make sure each list has the same number of properties.
181             countProps(jhsdbLines, numAppProps, &quot;jhsdb jinfo&quot;);
182             countProps(jinfoLines, numAppProps, &quot;jinfo&quot;);
183             countProps(clhsdbLines, numAppProps, &quot;clhsdb sysprops&quot;);
184 
185             System.out.println(&quot;Test Completed&quot;);
186         } finally {
187             LingeredApp.stopApp(app);
188         }
189     }
190 }
    </pre>
  </body>
</html>