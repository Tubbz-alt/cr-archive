<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff test/hotspot/jtreg/gc/metaspace/TestSizeTransitions.java</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
<body>
<center><a href="../../compiler/compilercontrol/share/scenario/Scenario.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="../shenandoah/TestObjItrWithHeapDump.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>test/hotspot/jtreg/gc/metaspace/TestSizeTransitions.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 62   public static class Run {
 63     public static void main(String... args) throws Exception {
 64       System.out.println(&quot;Run started.&quot;);
 65 
 66       // easiest way to generate a metaspace transition is to ask for a full GC
 67       System.gc();
 68 
 69       System.out.println(&quot;Run finished.&quot;);
 70     }
 71   }
 72 
 73   // matches the log tags
 74   //   e.g., [0.043s][info][gc]
 75   private static final String LOG_TAGS_REGEX = &quot;(\\[.*\\])+ &quot;;
 76 
 77   // matches a size transition
 78   //   e.g., 177K(4864K)-&gt;177K(4864K)
 79   private static final String SIZE_TRANSITION_REGEX = &quot;\\d+K\\(\\d+K\\)-&gt;\\d+K\\(\\d+K\\)&quot;;
 80 
 81   // matches -coops metaspace size transitions
<span class="line-modified"> 82   private static final String NO_COOPS_REGEX =</span>
 83     String.format(&quot;^%s.* Metaspace: %s$&quot;,
 84                   LOG_TAGS_REGEX,
 85                   SIZE_TRANSITION_REGEX);
 86 
 87   // matches +coops metaspace size transitions
<span class="line-modified"> 88   private static final String COOPS_REGEX =</span>
 89     String.format(&quot;^%s.* Metaspace: %s NonClass: %s Class: %s$&quot;,
 90                   LOG_TAGS_REGEX,
 91                   SIZE_TRANSITION_REGEX,
 92                   SIZE_TRANSITION_REGEX,
 93                   SIZE_TRANSITION_REGEX);
 94 
 95   public static void main(String... args) throws Exception {
 96     // args: &lt;use-coops&gt; &lt;gc-arg&gt;
 97     if (args.length != 2) {
 98       throw new RuntimeException(&quot;wrong number of args: &quot; + args.length);
 99     }
100 
<span class="line-modified">101     final boolean hasCoops = Platform.is64bit();</span>
<span class="line-modified">102     final boolean useCoops = Boolean.parseBoolean(args[0]);</span>
103     final String gcArg = args[1];
104 
<span class="line-modified">105     if (!hasCoops &amp;&amp; useCoops) {</span>
106        // No need to run this configuration.
107        System.out.println(&quot;Skipping test.&quot;);
108        return;
109     }
110 
111     List&lt;String&gt; jvmArgs = new ArrayList&lt;&gt;();
<span class="line-modified">112     if (hasCoops) {</span>
<span class="line-modified">113       jvmArgs.add(useCoops ? &quot;-XX:+UseCompressedOops&quot; : &quot;-XX:-UseCompressedOops&quot;);</span>
114     }
115     jvmArgs.add(gcArg);
116     jvmArgs.add(&quot;-Xmx256m&quot;);
117     jvmArgs.add(&quot;-Xlog:gc,gc+metaspace=info&quot;);
118     jvmArgs.add(TestSizeTransitions.Run.class.getName());
119 
120     System.out.println(&quot;JVM args:&quot;);
121     for (String a : jvmArgs) {
122       System.out.println(&quot;  &quot; + a);
123     }
124 
125     final ProcessBuilder pb = ProcessTools.createJavaProcessBuilder(jvmArgs);
126     final OutputAnalyzer output = new OutputAnalyzer(pb.start());
127     System.out.println(output.getStdout());
128     output.shouldHaveExitValue(0);
129 
<span class="line-modified">130     if (useCoops) {</span>
<span class="line-modified">131       output.stdoutShouldMatch(COOPS_REGEX);</span>
<span class="line-modified">132       output.stdoutShouldNotMatch(NO_COOPS_REGEX);</span>
133     } else {
<span class="line-modified">134       output.stdoutShouldMatch(NO_COOPS_REGEX);</span>
<span class="line-modified">135       output.stdoutShouldNotMatch(COOPS_REGEX);</span>
136     }
137   }
138 }
</pre>
</td>
<td>
<hr />
<pre>
 62   public static class Run {
 63     public static void main(String... args) throws Exception {
 64       System.out.println(&quot;Run started.&quot;);
 65 
 66       // easiest way to generate a metaspace transition is to ask for a full GC
 67       System.gc();
 68 
 69       System.out.println(&quot;Run finished.&quot;);
 70     }
 71   }
 72 
 73   // matches the log tags
 74   //   e.g., [0.043s][info][gc]
 75   private static final String LOG_TAGS_REGEX = &quot;(\\[.*\\])+ &quot;;
 76 
 77   // matches a size transition
 78   //   e.g., 177K(4864K)-&gt;177K(4864K)
 79   private static final String SIZE_TRANSITION_REGEX = &quot;\\d+K\\(\\d+K\\)-&gt;\\d+K\\(\\d+K\\)&quot;;
 80 
 81   // matches -coops metaspace size transitions
<span class="line-modified"> 82   private static final String NO_COMPRESSED_KLASS_POINTERS_REGEX =</span>
 83     String.format(&quot;^%s.* Metaspace: %s$&quot;,
 84                   LOG_TAGS_REGEX,
 85                   SIZE_TRANSITION_REGEX);
 86 
 87   // matches +coops metaspace size transitions
<span class="line-modified"> 88   private static final String COMPRESSED_KLASS_POINTERS_REGEX =</span>
 89     String.format(&quot;^%s.* Metaspace: %s NonClass: %s Class: %s$&quot;,
 90                   LOG_TAGS_REGEX,
 91                   SIZE_TRANSITION_REGEX,
 92                   SIZE_TRANSITION_REGEX,
 93                   SIZE_TRANSITION_REGEX);
 94 
 95   public static void main(String... args) throws Exception {
 96     // args: &lt;use-coops&gt; &lt;gc-arg&gt;
 97     if (args.length != 2) {
 98       throw new RuntimeException(&quot;wrong number of args: &quot; + args.length);
 99     }
100 
<span class="line-modified">101     final boolean hasCompressedKlassPointers = Platform.is64bit();</span>
<span class="line-modified">102     final boolean useCompressedKlassPointers = Boolean.parseBoolean(args[0]);</span>
103     final String gcArg = args[1];
104 
<span class="line-modified">105     if (!hasCompressedKlassPointers &amp;&amp; useCompressedKlassPointers) {</span>
106        // No need to run this configuration.
107        System.out.println(&quot;Skipping test.&quot;);
108        return;
109     }
110 
111     List&lt;String&gt; jvmArgs = new ArrayList&lt;&gt;();
<span class="line-modified">112     if (hasCompressedKlassPointers) {</span>
<span class="line-modified">113       jvmArgs.add(useCompressedKlassPointers ? &quot;-XX:+UseCompressedClassPointers&quot; : &quot;-XX:-UseCompressedClassPointers&quot;);</span>
114     }
115     jvmArgs.add(gcArg);
116     jvmArgs.add(&quot;-Xmx256m&quot;);
117     jvmArgs.add(&quot;-Xlog:gc,gc+metaspace=info&quot;);
118     jvmArgs.add(TestSizeTransitions.Run.class.getName());
119 
120     System.out.println(&quot;JVM args:&quot;);
121     for (String a : jvmArgs) {
122       System.out.println(&quot;  &quot; + a);
123     }
124 
125     final ProcessBuilder pb = ProcessTools.createJavaProcessBuilder(jvmArgs);
126     final OutputAnalyzer output = new OutputAnalyzer(pb.start());
127     System.out.println(output.getStdout());
128     output.shouldHaveExitValue(0);
129 
<span class="line-modified">130     if (useCompressedKlassPointers) {</span>
<span class="line-modified">131       output.stdoutShouldMatch(COMPRESSED_KLASS_POINTERS_REGEX);</span>
<span class="line-modified">132       output.stdoutShouldNotMatch(NO_COMPRESSED_KLASS_POINTERS_REGEX);</span>
133     } else {
<span class="line-modified">134       output.stdoutShouldMatch(NO_COMPRESSED_KLASS_POINTERS_REGEX);</span>
<span class="line-modified">135       output.stdoutShouldNotMatch(COMPRESSED_KLASS_POINTERS_REGEX);</span>
136     }
137   }
138 }
</pre>
</td>
</tr>
</table>
<center><a href="../../compiler/compilercontrol/share/scenario/Scenario.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="../shenandoah/TestObjItrWithHeapDump.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>