<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff make/common/JavaCompilation.gmk</title>
    <link rel="stylesheet" href="../../style.css" />
  </head>
<body>
<center><a href="../autoconf/util_windows.m4.sdiff.html" target="_top">&lt; prev</a> <a href="../../index.html" target="_top">index</a> <a href="MakeBase.gmk.sdiff.html" target="_top">next &gt;</a></center>    <h2>make/common/JavaCompilation.gmk</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
365       ifneq (,$$($1_EXCLUDE_PATTERN))
366         $1_ALL_CLEANS := $$(filter-out $$($1_EXCLUDE_PATTERN),$$($1_ALL_CLEANS))
367       endif
368       # Filter out any excluded translations
369       ifneq ($$($1_KEEP_ALL_TRANSLATIONS), true)
370         $1_ALL_CLEANS := $$(call FilterExcludedTranslations, $$($1_ALL_CLEANS), .properties)
371       endif
372       ifneq (,$$($1_ALL_CLEANS))
373         # Yep, there are files to be copied and cleaned!
374         $1_ALL_COPY_CLEAN_TARGETS:=
375             $$(foreach i,$$($1_ALL_CLEANS),$$(eval $$(call add_file_to_clean,$1,$$i)))
376         # Now we can depend on $$($1_ALL_COPY_CLEAN_TARGETS) to copy all files!
377       endif
378     endif
379 
380     # Create a sed expression to remove the source roots and to replace / with .
381     # and remove .java at the end.
382     $1_REWRITE_INTO_CLASSES:=$$(foreach i,$$($1_SRC),-e &#39;s|$$i/||g&#39;) -e &#39;s|/|.|g&#39; -e &#39;s|.java$$$$||g&#39;
383 
384     $1_COMPILE_TARGET := $$($1_BIN)$$($1_MODULE_SUBDIR)/_the.$1_batch


385     $1_API_TARGET := $$($1_BIN)$$($1_MODULE_SUBDIR)/_the.$1_pubapi
386 
387     # Put headers in a temp dir to filter out those that actually
388     # changed before copying them to the real header dir.
389     ifneq (,$$($1_HEADERS))
390       $1_HEADERS_ARG := -h $$($1_HEADERS).$1.tmp
391 
392       $$($1_HEADERS)/_the.$1_headers: $$($1_COMPILE_TARGET)
393 		$$(call MakeTargetDir)
394 		if [ -d &quot;$$($1_HEADERS).$1.tmp&quot; ]; then \
395 		  for f in `$(CD) $$($1_HEADERS).$1.tmp &amp;&amp; $(FIND) . -type f`; do \
396 		    if [ ! -f &quot;$$($1_HEADERS)/$$$$f&quot; ] \
397 		        || [ &quot;`$(DIFF) $$($1_HEADERS)/$$$$f $$($1_HEADERS).$1.tmp/$$$$f`&quot; != &quot;&quot; ]; then \
398 		      $(MKDIR) -p `$(DIRNAME) $$($1_HEADERS)/$$$$f`; \
399 		      $(CP) -f $$($1_HEADERS).$1.tmp/$$$$f $$($1_HEADERS)/$$$$f; \
400 		    fi; \
401 		  done; \
402 		fi
403 		$(RM) -r $$($1_HEADERS).$1.tmp
404 		$(TOUCH) $$@
405 
406       $1_HEADER_TARGETS := $$($1_HEADERS)/_the.$1_headers
407     endif
408 
409     $1_VARDEPS := $$($1_JAVAC_CMD) $$($1_FLAGS) $$($1_BIN) \
410         $$($1_HEADERS_ARG) $$($1_EXCLUDES) $$($1_INCLUDES) \
411         $$($1_EXCLUDE_FILES) $$($1_INCLUDE_FILES)
412     $1_VARDEPS_FILE := $$(call DependOnVariable, $1_VARDEPS, \
413         $$($1_BIN)$$($1_MODULE_SUBDIR)/_the.$1.vardeps)
414 
415     ifeq ($$($1_CREATE_API_DIGEST), true)
416       $1_API_DIGEST_FLAGS := \
417           -classpath $$(BUILDTOOLS_OUTPUTDIR)/depend \
418           -Xplugin:&quot;depend $$($1_API_TARGET)&quot; \
419           #
420 
421       $1_EXTRA_DEPS := $$(BUILDTOOLS_OUTPUTDIR)/depend/_the.COMPILE_DEPEND_batch
422     endif
423 
<span class="line-modified">424     # Pass along all sources to javac using an @file.</span>
<span class="line-modified">425     $$($1_COMPILE_TARGET): $$($1_SRCS) $$($1_DEPENDS) $$($1_VARDEPS_FILE) \</span>
<span class="line-modified">426         $$($1_EXTRA_DEPS)</span>

427 		$$(call MakeDir, $$(@D))
<span class="line-removed">428 		$$(eval $$(call ListPathsSafely,$1_SRCS, $$@.tmp))</span>
429 		$$(call LogWarn, Compiling $$(words $$($1_SRCS)) files for $1)






430 		$$(call ExecuteWithLog, $$($1_BIN)$$($1_MODULE_SUBDIR)/_the.$$($1_SAFE_NAME)_batch, \
431 		    $$($1_JAVAC_CMD) $$($1_FLAGS) \
432 		        $$($1_API_DIGEST_FLAGS) \
<span class="line-modified">433 		        -d $$($1_BIN) $$($1_HEADERS_ARG) @$$@.tmp) &amp;&amp; \</span>
<span class="line-modified">434 		$(MV) $$@.tmp $$@</span>
435 
436     # Add all targets to main variable
437     $1 := $$($1_ALL_COPY_TARGETS) $$($1_ALL_COPY_CLEAN_TARGETS) $$($1_COMPILE_TARGET) \
438         $$($1_HEADER_TARGETS)
439 
440     # Check if a jar file was specified, then setup the rules for the jar.
441     ifneq (,$$($1_JAR))
442       # If no suffixes was explicitly set for this jar file.
443       # Use class and the cleaned/copied properties file suffixes as the default
444       # for the types of files to be put into the jar.
445       ifeq (,$$($1_SUFFIXES))
446         $1_SUFFIXES:=.class $$($1_CLEAN) $$($1_COPY)
447       endif
448 
449       $$(eval $$(call SetupJarArchive, ARCHIVE_$1, \
450           DEPENDENCIES:=$$($1), \
451           SRCS:=$$($1_BIN)$$($1_MODULE_SUBDIR), \
452           SUFFIXES:=$$($1_SUFFIXES), \
453           EXCLUDE:=$$($1_EXCLUDES), \
454           INCLUDES:=$$($1_INCLUDES), \
</pre>
</td>
<td>
<hr />
<pre>
365       ifneq (,$$($1_EXCLUDE_PATTERN))
366         $1_ALL_CLEANS := $$(filter-out $$($1_EXCLUDE_PATTERN),$$($1_ALL_CLEANS))
367       endif
368       # Filter out any excluded translations
369       ifneq ($$($1_KEEP_ALL_TRANSLATIONS), true)
370         $1_ALL_CLEANS := $$(call FilterExcludedTranslations, $$($1_ALL_CLEANS), .properties)
371       endif
372       ifneq (,$$($1_ALL_CLEANS))
373         # Yep, there are files to be copied and cleaned!
374         $1_ALL_COPY_CLEAN_TARGETS:=
375             $$(foreach i,$$($1_ALL_CLEANS),$$(eval $$(call add_file_to_clean,$1,$$i)))
376         # Now we can depend on $$($1_ALL_COPY_CLEAN_TARGETS) to copy all files!
377       endif
378     endif
379 
380     # Create a sed expression to remove the source roots and to replace / with .
381     # and remove .java at the end.
382     $1_REWRITE_INTO_CLASSES:=$$(foreach i,$$($1_SRC),-e &#39;s|$$i/||g&#39;) -e &#39;s|/|.|g&#39; -e &#39;s|.java$$$$||g&#39;
383 
384     $1_COMPILE_TARGET := $$($1_BIN)$$($1_MODULE_SUBDIR)/_the.$1_batch
<span class="line-added">385     $1_FILELIST := $$($1_BIN)$$($1_MODULE_SUBDIR)/_the.$1_batch.filelist</span>
<span class="line-added">386 </span>
387     $1_API_TARGET := $$($1_BIN)$$($1_MODULE_SUBDIR)/_the.$1_pubapi
388 
389     # Put headers in a temp dir to filter out those that actually
390     # changed before copying them to the real header dir.
391     ifneq (,$$($1_HEADERS))
392       $1_HEADERS_ARG := -h $$($1_HEADERS).$1.tmp
393 
394       $$($1_HEADERS)/_the.$1_headers: $$($1_COMPILE_TARGET)
395 		$$(call MakeTargetDir)
396 		if [ -d &quot;$$($1_HEADERS).$1.tmp&quot; ]; then \
397 		  for f in `$(CD) $$($1_HEADERS).$1.tmp &amp;&amp; $(FIND) . -type f`; do \
398 		    if [ ! -f &quot;$$($1_HEADERS)/$$$$f&quot; ] \
399 		        || [ &quot;`$(DIFF) $$($1_HEADERS)/$$$$f $$($1_HEADERS).$1.tmp/$$$$f`&quot; != &quot;&quot; ]; then \
400 		      $(MKDIR) -p `$(DIRNAME) $$($1_HEADERS)/$$$$f`; \
401 		      $(CP) -f $$($1_HEADERS).$1.tmp/$$$$f $$($1_HEADERS)/$$$$f; \
402 		    fi; \
403 		  done; \
404 		fi
405 		$(RM) -r $$($1_HEADERS).$1.tmp
406 		$(TOUCH) $$@
407 
408       $1_HEADER_TARGETS := $$($1_HEADERS)/_the.$1_headers
409     endif
410 
411     $1_VARDEPS := $$($1_JAVAC_CMD) $$($1_FLAGS) $$($1_BIN) \
412         $$($1_HEADERS_ARG) $$($1_EXCLUDES) $$($1_INCLUDES) \
413         $$($1_EXCLUDE_FILES) $$($1_INCLUDE_FILES)
414     $1_VARDEPS_FILE := $$(call DependOnVariable, $1_VARDEPS, \
415         $$($1_BIN)$$($1_MODULE_SUBDIR)/_the.$1.vardeps)
416 
417     ifeq ($$($1_CREATE_API_DIGEST), true)
418       $1_API_DIGEST_FLAGS := \
419           -classpath $$(BUILDTOOLS_OUTPUTDIR)/depend \
420           -Xplugin:&quot;depend $$($1_API_TARGET)&quot; \
421           #
422 
423       $1_EXTRA_DEPS := $$(BUILDTOOLS_OUTPUTDIR)/depend/_the.COMPILE_DEPEND_batch
424     endif
425 
<span class="line-modified">426     # Create a file with all sources, to pass to javac in an @file.</span>
<span class="line-modified">427     # $$($1_VARDEPS_FILE) is used as dependency to track changes in set of</span>
<span class="line-modified">428     # list of files.</span>
<span class="line-added">429     $$($1_FILELIST): $$($1_SRCS) $$($1_VARDEPS_FILE)</span>
430 		$$(call MakeDir, $$(@D))

431 		$$(call LogWarn, Compiling $$(words $$($1_SRCS)) files for $1)
<span class="line-added">432 		$$(eval $$(call ListPathsSafely, $1_SRCS, $$($1_FILELIST)))</span>
<span class="line-added">433 </span>
<span class="line-added">434     # Do the actual compilation</span>
<span class="line-added">435     $$($1_COMPILE_TARGET): $$($1_SRCS) $$($1_FILELIST) $$($1_DEPENDS) \</span>
<span class="line-added">436         $$($1_VARDEPS_FILE) $$($1_EXTRA_DEPS)</span>
<span class="line-added">437 		$$(call MakeDir, $$(@D))</span>
438 		$$(call ExecuteWithLog, $$($1_BIN)$$($1_MODULE_SUBDIR)/_the.$$($1_SAFE_NAME)_batch, \
439 		    $$($1_JAVAC_CMD) $$($1_FLAGS) \
440 		        $$($1_API_DIGEST_FLAGS) \
<span class="line-modified">441 		        -d $$($1_BIN) $$($1_HEADERS_ARG) @$$($1_FILELIST)) &amp;&amp; \</span>
<span class="line-modified">442 		$(TOUCH) $$@</span>
443 
444     # Add all targets to main variable
445     $1 := $$($1_ALL_COPY_TARGETS) $$($1_ALL_COPY_CLEAN_TARGETS) $$($1_COMPILE_TARGET) \
446         $$($1_HEADER_TARGETS)
447 
448     # Check if a jar file was specified, then setup the rules for the jar.
449     ifneq (,$$($1_JAR))
450       # If no suffixes was explicitly set for this jar file.
451       # Use class and the cleaned/copied properties file suffixes as the default
452       # for the types of files to be put into the jar.
453       ifeq (,$$($1_SUFFIXES))
454         $1_SUFFIXES:=.class $$($1_CLEAN) $$($1_COPY)
455       endif
456 
457       $$(eval $$(call SetupJarArchive, ARCHIVE_$1, \
458           DEPENDENCIES:=$$($1), \
459           SRCS:=$$($1_BIN)$$($1_MODULE_SUBDIR), \
460           SUFFIXES:=$$($1_SUFFIXES), \
461           EXCLUDE:=$$($1_EXCLUDES), \
462           INCLUDES:=$$($1_INCLUDES), \
</pre>
</td>
</tr>
</table>
<center><a href="../autoconf/util_windows.m4.sdiff.html" target="_top">&lt; prev</a> <a href="../../index.html" target="_top">index</a> <a href="MakeBase.gmk.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>