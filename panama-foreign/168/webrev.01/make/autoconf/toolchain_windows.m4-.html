<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Old make/autoconf/toolchain_windows.m4</title>
    <link rel="stylesheet" href="../../style.css" />
  </head>
  <body>
    <pre>
  1 #
  2 # Copyright (c) 2011, 2019, Oracle and/or its affiliates. All rights reserved.
  3 # DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4 #
  5 # This code is free software; you can redistribute it and/or modify it
  6 # under the terms of the GNU General Public License version 2 only, as
  7 # published by the Free Software Foundation.  Oracle designates this
  8 # particular file as subject to the &quot;Classpath&quot; exception as provided
  9 # by Oracle in the LICENSE file that accompanied this code.
 10 #
 11 # This code is distributed in the hope that it will be useful, but WITHOUT
 12 # ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 13 # FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 14 # version 2 for more details (a copy is included in the LICENSE file that
 15 # accompanied this code).
 16 #
 17 # You should have received a copy of the GNU General Public License version
 18 # 2 along with this work; if not, write to the Free Software Foundation,
 19 # Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 20 #
 21 # Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 22 # or visit www.oracle.com if you need additional information or have any
 23 # questions.
 24 #
 25 
 26 ################################################################################
 27 # The order of these defines the priority by which we try to find them.
 28 VALID_VS_VERSIONS=&quot;2017 2019 2013 2015 2012 2010&quot;
 29 
 30 VS_DESCRIPTION_2010=&quot;Microsoft Visual Studio 2010&quot;
 31 VS_VERSION_INTERNAL_2010=100
 32 VS_MSVCR_2010=msvcr100.dll
 33 # We don&#39;t use msvcp on Visual Studio 2010
 34 #VS_MSVCP_2010=msvcp100.dll
 35 VS_ENVVAR_2010=&quot;VS100COMNTOOLS&quot;
 36 VS_VS_INSTALLDIR_2010=&quot;Microsoft Visual Studio 10.0&quot;
 37 VS_SDK_INSTALLDIR_2010=&quot;Microsoft SDKs/Windows/v7.1&quot;
 38 VS_VS_PLATFORM_NAME_2010=&quot;v100&quot;
 39 VS_SDK_PLATFORM_NAME_2010=&quot;Windows7.1SDK&quot;
 40 VS_SUPPORTED_2010=false
 41 
 42 VS_DESCRIPTION_2012=&quot;Microsoft Visual Studio 2012&quot;
 43 VS_VERSION_INTERNAL_2012=110
 44 VS_MSVCR_2012=msvcr110.dll
 45 VS_MSVCP_2012=msvcp110.dll
 46 VS_ENVVAR_2012=&quot;VS110COMNTOOLS&quot;
 47 VS_VS_INSTALLDIR_2012=&quot;Microsoft Visual Studio 11.0&quot;
 48 VS_SDK_INSTALLDIR_2012=
 49 VS_VS_PLATFORM_NAME_2012=&quot;v110&quot;
 50 VS_SDK_PLATFORM_NAME_2012=
 51 VS_SUPPORTED_2012=false
 52 
 53 VS_DESCRIPTION_2013=&quot;Microsoft Visual Studio 2013&quot;
 54 VS_VERSION_INTERNAL_2013=120
 55 VS_MSVCR_2013=msvcr120.dll
 56 VS_MSVCP_2013=msvcp120.dll
 57 VS_ENVVAR_2013=&quot;VS120COMNTOOLS&quot;
 58 VS_VS_INSTALLDIR_2013=&quot;Microsoft Visual Studio 12.0&quot;
 59 VS_SDK_INSTALLDIR_2013=
 60 VS_VS_PLATFORM_NAME_2013=&quot;v120&quot;
 61 VS_SDK_PLATFORM_NAME_2013=
 62 VS_SUPPORTED_2013=false
 63 
 64 VS_DESCRIPTION_2015=&quot;Microsoft Visual Studio 2015&quot;
 65 VS_VERSION_INTERNAL_2015=140
 66 VS_MSVCR_2015=vcruntime140.dll
 67 VS_MSVCP_2015=msvcp140.dll
 68 VS_ENVVAR_2015=&quot;VS140COMNTOOLS&quot;
 69 VS_VS_INSTALLDIR_2015=&quot;Microsoft Visual Studio 14.0&quot;
 70 VS_SDK_INSTALLDIR_2015=
 71 VS_VS_PLATFORM_NAME_2015=&quot;v140&quot;
 72 VS_SDK_PLATFORM_NAME_2015=
 73 # The vcvars of 2015 breaks if 2017 is also installed. Work around this by
 74 # explicitly specifying Windows Kit 8.1 to be used.
 75 VS_ENV_ARGS_2015=&quot;8.1&quot;
 76 VS_SUPPORTED_2015=false
 77 
 78 VS_DESCRIPTION_2017=&quot;Microsoft Visual Studio 2017&quot;
 79 VS_VERSION_INTERNAL_2017=141
 80 VS_MSVCR_2017=vcruntime140.dll
 81 VS_MSVCP_2017=msvcp140.dll
 82 VS_ENVVAR_2017=&quot;VS150COMNTOOLS&quot;
 83 VS_USE_UCRT_2017=&quot;true&quot;
 84 VS_VS_INSTALLDIR_2017=&quot;Microsoft Visual Studio/2017&quot;
 85 VS_EDITIONS_2017=&quot;BuildTools Community Professional Enterprise&quot;
 86 VS_SDK_INSTALLDIR_2017=
 87 VS_VS_PLATFORM_NAME_2017=&quot;v141&quot;
 88 VS_SDK_PLATFORM_NAME_2017=
 89 VS_SUPPORTED_2017=true
 90 VS_TOOLSET_SUPPORTED_2017=true
 91 
 92 VS_DESCRIPTION_2019=&quot;Microsoft Visual Studio 2019&quot;
 93 VS_VERSION_INTERNAL_2019=142
 94 VS_MSVCR_2019=vcruntime140.dll
 95 VS_VCRUNTIME_1_2019=vcruntime140_1.dll
 96 VS_MSVCP_2019=msvcp140.dll
 97 VS_ENVVAR_2019=&quot;VS160COMNTOOLS&quot;
 98 VS_USE_UCRT_2019=&quot;true&quot;
 99 VS_VS_INSTALLDIR_2019=&quot;Microsoft Visual Studio/2019&quot;
100 VS_EDITIONS_2019=&quot;BuildTools Community Professional Enterprise&quot;
101 VS_SDK_INSTALLDIR_2019=
102 VS_VS_PLATFORM_NAME_2019=&quot;v142&quot;
103 VS_SDK_PLATFORM_NAME_2019=
104 VS_SUPPORTED_2019=false
105 VS_TOOLSET_SUPPORTED_2019=false
106 
107 ################################################################################
108 
109 AC_DEFUN([TOOLCHAIN_CHECK_POSSIBLE_VISUAL_STUDIO_ROOT],
110 [
111   if test &quot;x$VS_ENV_CMD&quot; = x; then
112     VS_VERSION=&quot;$1&quot;
113     VS_BASE=&quot;$2&quot;
114     METHOD=&quot;$3&quot;
115 
116     UTIL_REWRITE_AS_UNIX_PATH(VS_BASE)
117     # In VS 2017 and VS 2019, the default installation is in a subdir named after the edition.
118     # Find the first one present and use that.
119     if test &quot;x$VS_EDITIONS&quot; != x; then
120       for edition in $VS_EDITIONS; do
121         if test -d &quot;$VS_BASE/$edition&quot;; then
122           VS_BASE=&quot;$VS_BASE/$edition&quot;
123           break
124         fi
125       done
126     fi
127 
128     if test -d &quot;$VS_BASE&quot;; then
129       AC_MSG_NOTICE([Found Visual Studio installation at $VS_BASE using $METHOD])
130       if test &quot;x$OPENJDK_TARGET_CPU_BITS&quot; = x32; then
131         VCVARSFILES=&quot;vc/bin/vcvars32.bat vc/auxiliary/build/vcvars32.bat&quot;
132       else
133         VCVARSFILES=&quot;vc/bin/amd64/vcvars64.bat vc/bin/x86_amd64/vcvarsx86_amd64.bat \
134             VC/Auxiliary/Build/vcvarsx86_amd64.bat VC/Auxiliary/Build/vcvars64.bat&quot;
135       fi
136 
137       for VCVARSFILE in $VCVARSFILES; do
138         if test -f &quot;$VS_BASE/$VCVARSFILE&quot;; then
139           VS_ENV_CMD=&quot;$VS_BASE/$VCVARSFILE&quot;
140           break
141         fi
142       done
143 
144       if test &quot;x$VS_ENV_CMD&quot; = x; then
145         AC_MSG_NOTICE([Warning: None of $VCVARSFILES were found, Visual Studio installation not recognized. Ignoring])
146       else
147         # PLATFORM_TOOLSET is used during the compilation of the freetype sources
148         # (see &#39;LIB_BUILD_FREETYPE&#39; in libraries.m4) and must be one of &#39;v100&#39;,
149         # &#39;v110&#39; or &#39;v120&#39; for VS 2010, 2012 or VS2013
150         eval PLATFORM_TOOLSET=&quot;\${VS_VS_PLATFORM_NAME_${VS_VERSION}}&quot;
151       fi
152     fi
153   fi
154 ])
155 
156 ################################################################################
157 
158 AC_DEFUN([TOOLCHAIN_CHECK_POSSIBLE_WIN_SDK_ROOT],
159 [
160   if test &quot;x$VS_ENV_CMD&quot; = x; then
161     VS_VERSION=&quot;$1&quot;
162     WIN_SDK_BASE=&quot;$2&quot;
163     METHOD=&quot;$3&quot;
164     UTIL_REWRITE_AS_UNIX_PATH(WIN_SDK_BASE)
165     if test -d &quot;$WIN_SDK_BASE&quot;; then
166       # There have been cases of partial or broken SDK installations. A missing
167       # lib dir is not going to work.
168       if test ! -d &quot;$WIN_SDK_BASE/lib&quot;; then
169         AC_MSG_NOTICE([Found Windows SDK installation at $WIN_SDK_BASE using $METHOD])
170         AC_MSG_NOTICE([Warning: Installation is broken, lib dir is missing. Ignoring])
171       elif test -f &quot;$WIN_SDK_BASE/Bin/SetEnv.Cmd&quot;; then
172         AC_MSG_NOTICE([Found Windows SDK installation at $WIN_SDK_BASE using $METHOD])
173         VS_ENV_CMD=&quot;$WIN_SDK_BASE/Bin/SetEnv.Cmd&quot;
174         if test &quot;x$OPENJDK_TARGET_CPU_BITS&quot; = x32; then
175           VS_ENV_ARGS=&quot;/x86&quot;
176         else
177           VS_ENV_ARGS=&quot;/x64&quot;
178         fi
179         # PLATFORM_TOOLSET is used during the compilation of the freetype sources (see
180         # &#39;LIB_BUILD_FREETYPE&#39; in libraries.m4) and must be &#39;Windows7.1SDK&#39; for Windows7.1SDK
181         # TODO: improve detection for other versions of SDK
182         eval PLATFORM_TOOLSET=&quot;\${VS_SDK_PLATFORM_NAME_${VS_VERSION}}&quot;
183       else
184         AC_MSG_NOTICE([Found Windows SDK installation at $WIN_SDK_BASE using $METHOD])
185         AC_MSG_NOTICE([Warning: Installation is broken, SetEnv.Cmd is missing. Ignoring])
186       fi
187     fi
188   fi
189 ])
190 
191 ################################################################################
192 # Finds the bat or cmd file in Visual Studio or the SDK that sets up a proper
193 # build environment and assigns it to VS_ENV_CMD
194 AC_DEFUN([TOOLCHAIN_FIND_VISUAL_STUDIO_BAT_FILE],
195 [
196   # VS2017 provides the option to install previous minor versions of the MSVC
197   # toolsets. It is not possible to directly download earlier minor versions of
198   # VS2017 and in order to build with a previous minor compiler toolset version,
199   # it is now possible to compile with earlier minor versions by passing
200   # -vcvars_ver=&lt;toolset_version&gt; argument to vcvarsall.bat.
201   AC_ARG_WITH(msvc-toolset-version, [AS_HELP_STRING([--with-msvc-toolset-version],
202       [specific MSVC toolset version to use, passed as -vcvars_ver argument to
203        pass to vcvarsall.bat (Windows only)])])
204 
205   VS_VERSION=&quot;$1&quot;
206   eval VS_COMNTOOLS_VAR=&quot;\${VS_ENVVAR_${VS_VERSION}}&quot;
207   eval VS_COMNTOOLS=&quot;\$${VS_COMNTOOLS_VAR}&quot;
208   eval VS_INSTALL_DIR=&quot;\${VS_VS_INSTALLDIR_${VS_VERSION}}&quot;
209   eval VS_EDITIONS=&quot;\${VS_EDITIONS_${VS_VERSION}}&quot;
210   eval SDK_INSTALL_DIR=&quot;\${VS_SDK_INSTALLDIR_${VS_VERSION}}&quot;
211   eval VS_ENV_ARGS=&quot;\${VS_ENV_ARGS_${VS_VERSION}}&quot;
212   eval VS_TOOLSET_SUPPORTED=&quot;\${VS_TOOLSET_SUPPORTED_${VS_VERSION}}&quot;
213 
214   VS_ENV_CMD=&quot;&quot;
215 
216   # When using --with-tools-dir, assume it points to the correct and default
217   # version of Visual Studio or that --with-toolchain-version was also set.
218   if test &quot;x$with_tools_dir&quot; != x; then
219     TOOLCHAIN_CHECK_POSSIBLE_VISUAL_STUDIO_ROOT([${VS_VERSION}],
220         [$with_tools_dir/../..], [--with-tools-dir])
221     TOOLCHAIN_CHECK_POSSIBLE_VISUAL_STUDIO_ROOT([${VS_VERSION}],
222         [$with_tools_dir/../../..], [--with-tools-dir])
223     if test &quot;x$VS_ENV_CMD&quot; = x; then
224       # Having specified an argument which is incorrect will produce an instant failure;
225       # we should not go on looking
226       AC_MSG_NOTICE([The path given by --with-tools-dir does not contain a valid])
227       AC_MSG_NOTICE([Visual Studio installation. Please point to the VC/bin or VC/bin/amd64])
228       AC_MSG_NOTICE([directory within the Visual Studio installation])
229       AC_MSG_ERROR([Cannot locate a valid Visual Studio installation])
230     fi
231   fi
232 
233   if test &quot;x$VS_COMNTOOLS&quot; != x; then
234     TOOLCHAIN_CHECK_POSSIBLE_VISUAL_STUDIO_ROOT([${VS_VERSION}],
235         [$VS_COMNTOOLS/../..], [$VS_COMNTOOLS_VAR variable])
236   fi
237   if test &quot;x$PROGRAMFILES&quot; != x; then
238     TOOLCHAIN_CHECK_POSSIBLE_VISUAL_STUDIO_ROOT([${VS_VERSION}],
239         [$PROGRAMFILES/$VS_INSTALL_DIR], [well-known name])
240   fi
241   # Work around the insanely named ProgramFiles(x86) env variable
242   PROGRAMFILES_X86=&quot;`env | $SED -n &#39;s/^ProgramFiles(x86)=//p&#39;`&quot;
243   if test &quot;x$PROGRAMFILES_X86&quot; != x; then
244     TOOLCHAIN_CHECK_POSSIBLE_VISUAL_STUDIO_ROOT([${VS_VERSION}],
245         [$PROGRAMFILES_X86/$VS_INSTALL_DIR], [well-known name])
246   fi
247   TOOLCHAIN_CHECK_POSSIBLE_VISUAL_STUDIO_ROOT([${VS_VERSION}],
248       [C:/Program Files/$VS_INSTALL_DIR], [well-known name])
249   TOOLCHAIN_CHECK_POSSIBLE_VISUAL_STUDIO_ROOT([${VS_VERSION}],
250       [C:/Program Files (x86)/$VS_INSTALL_DIR], [well-known name])
251   if test &quot;x$SDK_INSTALL_DIR&quot; != x; then
252     if test &quot;x$ProgramW6432&quot; != x; then
253       TOOLCHAIN_CHECK_POSSIBLE_WIN_SDK_ROOT([${VS_VERSION}],
254           [$ProgramW6432/$SDK_INSTALL_DIR], [well-known name])
255     fi
256     if test &quot;x$PROGRAMW6432&quot; != x; then
257       TOOLCHAIN_CHECK_POSSIBLE_WIN_SDK_ROOT([${VS_VERSION}],
258           [$PROGRAMW6432/$SDK_INSTALL_DIR], [well-known name])
259     fi
260     if test &quot;x$PROGRAMFILES&quot; != x; then
261       TOOLCHAIN_CHECK_POSSIBLE_WIN_SDK_ROOT([${VS_VERSION}],
262           [$PROGRAMFILES/$SDK_INSTALL_DIR], [well-known name])
263     fi
264     TOOLCHAIN_CHECK_POSSIBLE_WIN_SDK_ROOT([${VS_VERSION}],
265         [C:/Program Files/$SDK_INSTALL_DIR], [well-known name])
266     TOOLCHAIN_CHECK_POSSIBLE_WIN_SDK_ROOT([${VS_VERSION}],
267         [C:/Program Files (x86)/$SDK_INSTALL_DIR], [well-known name])
268   fi
269 
270   if test &quot;x$VS_TOOLSET_SUPPORTED&quot; != x; then
271     if test &quot;x$with_msvc_toolset_version&quot; != x; then
272       VS_ENV_ARGS=&quot;$VS_ENV_ARGS -vcvars_ver=$with_msvc_toolset_version&quot;
273     fi
274   fi
275 ])
276 
277 ################################################################################
278 
279 AC_DEFUN([TOOLCHAIN_FIND_VISUAL_STUDIO],
280 [
281   AC_ARG_WITH(toolchain-version, [AS_HELP_STRING([--with-toolchain-version],
282       [the version of the toolchain to look for, use &#39;--help&#39; to show possible values @&lt;:@platform dependent@:&gt;@])])
283 
284   if test &quot;x$with_toolchain_version&quot; = xlist; then
285     # List all toolchains
286     AC_MSG_NOTICE([The following toolchain versions are valid on this platform:])
287     for version in $VALID_VS_VERSIONS; do
288       eval VS_DESCRIPTION=\${VS_DESCRIPTION_$version}
289       $PRINTF &quot;  %-10s  %s\n&quot; $version &quot;$VS_DESCRIPTION&quot;
290     done
291 
292     exit 0
293   elif test &quot;x$DEVKIT_VS_VERSION&quot; != x; then
294     VS_VERSION=$DEVKIT_VS_VERSION
295     TOOLCHAIN_VERSION=$VS_VERSION
296     # If the devkit has a name, use that as description
297     VS_DESCRIPTION=&quot;$DEVKIT_NAME&quot;
298     if test &quot;x$VS_DESCRIPTION&quot; = x; then
299       eval VS_DESCRIPTION=&quot;\${VS_DESCRIPTION_${VS_VERSION}}&quot;
300     fi
301     eval VS_VERSION_INTERNAL=&quot;\${VS_VERSION_INTERNAL_${VS_VERSION}}&quot;
302     eval MSVCR_NAME=&quot;\${VS_MSVCR_${VS_VERSION}}&quot;
303     eval VCRUNTIME_1_NAME=&quot;\${VS_VCRUNTIME_1_${VS_VERSION}}&quot;
304     eval MSVCP_NAME=&quot;\${VS_MSVCP_${VS_VERSION}}&quot;
305     eval USE_UCRT=&quot;\${VS_USE_UCRT_${VS_VERSION}}&quot;
306     eval VS_SUPPORTED=&quot;\${VS_SUPPORTED_${VS_VERSION}}&quot;
307     eval PLATFORM_TOOLSET=&quot;\${VS_VS_PLATFORM_NAME_${VS_VERSION}}&quot;
308 
309     # The TOOLCHAIN_PATH from a devkit is in Unix format. In WSL we need a
310     # windows version of the complete VS_PATH as VS_PATH_WINDOWS
311     if test &quot;x$OPENJDK_BUILD_OS_ENV&quot; = &quot;xwindows.wsl&quot;; then
312       # Convert the toolchain path
313       OLDIFS=&quot;$IFS&quot;
314       IFS=&quot;:&quot;
315       VS_PATH_WINDOWS=&quot;&quot;
316       for i in $TOOLCHAIN_PATH; do
317         path=$i
318         UTIL_REWRITE_AS_WINDOWS_MIXED_PATH([path])
319         VS_PATH_WINDOWS=&quot;$VS_PATH_WINDOWS;$path&quot;
320       done
321       IFS=&quot;$OLDIFS&quot;
322       # Append the current path from Windows env
323       WINDOWS_PATH=&quot;`$CMD /c echo %PATH%`&quot;
324       VS_PATH_WINDOWS=&quot;$VS_PATH_WINDOWS;$WINDOWS_PATH&quot;
325     else
326       VS_PATH=&quot;$TOOLCHAIN_PATH:$PATH&quot;
327     fi
328 
329     # Convert DEVKIT_VS_INCLUDE into windows style VS_INCLUDE so that it
330     # can still be exported as INCLUDE for compiler invocations without
331     # SYSROOT_CFLAGS
332     OLDIFS=&quot;$IFS&quot;
333     IFS=&quot;;&quot;
334     for i in $DEVKIT_VS_INCLUDE; do
335       ipath=$i
336       UTIL_REWRITE_AS_WINDOWS_MIXED_PATH([ipath])
337       VS_INCLUDE=&quot;$VS_INCLUDE;$ipath&quot;
338     done
339     # Convert DEVKIT_VS_LIB into VS_LIB so that it can still be exported
340     # as LIB for compiler invocations without SYSROOT_LDFLAGS
341     for i in $DEVKIT_VS_LIB; do
342       libpath=$i
343       UTIL_REWRITE_AS_WINDOWS_MIXED_PATH([libpath])
344       VS_LIB=&quot;$VS_LIB;$libpath&quot;
345     done
346     IFS=&quot;$OLDIFS&quot;
347 
348     AC_MSG_NOTICE([Found devkit $VS_DESCRIPTION])
349 
350   elif test &quot;x$with_toolchain_version&quot; != x; then
351     # User override; check that it is valid
352     if test &quot;x${VALID_VS_VERSIONS/$with_toolchain_version/}&quot; = &quot;x${VALID_VS_VERSIONS}&quot;; then
353       AC_MSG_NOTICE([Visual Studio version $with_toolchain_version is not valid.])
354       AC_MSG_NOTICE([Valid Visual Studio versions: $VALID_VS_VERSIONS.])
355       AC_MSG_ERROR([Cannot continue.])
356     fi
357     VS_VERSIONS_PROBE_LIST=&quot;$with_toolchain_version&quot;
358   else
359     # No flag given, use default
360     VS_VERSIONS_PROBE_LIST=&quot;$VALID_VS_VERSIONS&quot;
361   fi
362 
363   for VS_VERSION in $VS_VERSIONS_PROBE_LIST; do
364     TOOLCHAIN_FIND_VISUAL_STUDIO_BAT_FILE([$VS_VERSION])
365     if test &quot;x$VS_ENV_CMD&quot; != x; then
366       TOOLCHAIN_VERSION=$VS_VERSION
367       eval VS_DESCRIPTION=&quot;\${VS_DESCRIPTION_${VS_VERSION}}&quot;
368       eval VS_VERSION_INTERNAL=&quot;\${VS_VERSION_INTERNAL_${VS_VERSION}}&quot;
369       eval MSVCR_NAME=&quot;\${VS_MSVCR_${VS_VERSION}}&quot;
370       eval VCRUNTIME_1_NAME=&quot;\${VS_VCRUNTIME_1_${VS_VERSION}}&quot;
371       eval MSVCP_NAME=&quot;\${VS_MSVCP_${VS_VERSION}}&quot;
372       eval USE_UCRT=&quot;\${VS_USE_UCRT_${VS_VERSION}}&quot;
373       eval VS_SUPPORTED=&quot;\${VS_SUPPORTED_${VS_VERSION}}&quot;
374       # The rest of the variables are already evaled while probing
375       AC_MSG_NOTICE([Found $VS_DESCRIPTION])
376       break
377     fi
378   done
379 
380   TOOLCHAIN_DESCRIPTION=&quot;$VS_DESCRIPTION&quot;
381   if test &quot;x$VS_SUPPORTED&quot; = &quot;xfalse&quot;; then
382     UNSUPPORTED_TOOLCHAIN_VERSION=yes
383   fi
384 ])
385 
386 ################################################################################
387 # Check if the VS env variables were setup prior to running configure.
388 # If not, then find vcvarsall.bat and run it automatically, and integrate
389 # the set env variables into the spec file.
390 AC_DEFUN([TOOLCHAIN_SETUP_VISUAL_STUDIO_ENV],
391 [
392   # Store path to cygwin link.exe to help excluding it when searching for
393   # VS linker. This must be done before changing the PATH when looking for VS.
394   AC_PATH_PROG(CYGWIN_LINK, link.exe)
395   if test &quot;x$CYGWIN_LINK&quot; != x; then
396     AC_MSG_CHECKING([if the first found link.exe is actually the Cygwin link tool])
397     &quot;$CYGWIN_LINK&quot; --version &gt; /dev/null
398     if test $? -eq 0 ; then
399       AC_MSG_RESULT([yes])
400     else
401       AC_MSG_RESULT([no])
402       # This might be the VS linker. Don&#39;t exclude it later on.
403       CYGWIN_LINK=&quot;&quot;
404     fi
405   fi
406 
407   # First-hand choice is to locate and run the vsvars bat file.
408   TOOLCHAIN_FIND_VISUAL_STUDIO
409 
410   # If we have a devkit, skip all of the below.
411   if test &quot;x$DEVKIT_VS_VERSION&quot; = x; then
412     if test &quot;x$VS_ENV_CMD&quot; != x; then
413       # We have found a Visual Studio environment on disk, let&#39;s extract variables from the vsvars bat file.
414       UTIL_FIXUP_EXECUTABLE(VS_ENV_CMD)
415 
416       # Lets extract the variables that are set by vcvarsall.bat/vsvars32.bat/vsvars64.bat
417       AC_MSG_NOTICE([Trying to extract Visual Studio environment variables])
418 
419       # We need to create a couple of temporary files.
420       VS_ENV_TMP_DIR=&quot;$CONFIGURESUPPORT_OUTPUTDIR/vs-env&quot;
421       $MKDIR -p $VS_ENV_TMP_DIR
422 
423       # Cannot use the VS10 setup script directly (since it only updates the DOS subshell environment).
424       # Instead create a shell script which will set the relevant variables when run.
425       WINPATH_VS_ENV_CMD=&quot;$VS_ENV_CMD&quot;
426       UTIL_REWRITE_AS_WINDOWS_MIXED_PATH([WINPATH_VS_ENV_CMD])
427 
428       if test &quot;x$OPENJDK_BUILD_OS_ENV&quot; = &quot;xwindows.wsl&quot;; then
429         WINPATH_BASH=&quot;bash&quot;
430       else
431         WINPATH_BASH=&quot;$BASH&quot;
432         UTIL_REWRITE_AS_WINDOWS_MIXED_PATH([WINPATH_BASH])
433       fi
434 
435       # Generate a DOS batch file which runs $VS_ENV_CMD, and then creates a shell
436       # script (executable by bash) that will setup the important variables.
437       EXTRACT_VC_ENV_BAT_FILE=&quot;$VS_ENV_TMP_DIR/extract-vs-env.bat&quot;
438       $ECHO &quot;@echo off&quot; &gt;  $EXTRACT_VC_ENV_BAT_FILE
439       # This will end up something like:
440       # call C:/progra~2/micros~2.0/vc/bin/amd64/vcvars64.bat
441       $ECHO &quot;call \&quot;$WINPATH_VS_ENV_CMD\&quot; $VS_ENV_ARGS&quot; &gt;&gt; $EXTRACT_VC_ENV_BAT_FILE
442       # In some cases, the VS_ENV_CMD will change directory, change back so
443       # the set-vs-env.sh ends up in the right place.
444       $ECHO &#39;cd %~dp0&#39; &gt;&gt; $EXTRACT_VC_ENV_BAT_FILE
445       if test &quot;x$OPENJDK_BUILD_OS_ENV&quot; = &quot;xwindows.wsl&quot;; then
446         # These will end up something like:
447         # echo VS_PATH=\&quot;$PATH\&quot; &gt; set-vs-env.sh
448         # The trailing space for everyone except PATH is no typo, but is needed due
449         # to trailing \ in the Windows paths. These will be stripped later.
450         # Trying pure CMD extract. This results in windows paths that need to
451         # be converted post extraction, but a simpler script.
452         $ECHO &#39;echo VS_PATH=&quot;%PATH%&quot; &gt; set-vs-env.sh&#39; \
453             &gt;&gt; $EXTRACT_VC_ENV_BAT_FILE
454         $ECHO &#39;echo VS_INCLUDE=&quot;%INCLUDE% &quot; &gt;&gt; set-vs-env.sh&#39; \
455             &gt;&gt; $EXTRACT_VC_ENV_BAT_FILE
456         $ECHO &#39;echo VS_LIB=&quot;%LIB% &quot; &gt;&gt; set-vs-env.sh&#39; \
457             &gt;&gt; $EXTRACT_VC_ENV_BAT_FILE
458         $ECHO &#39;echo VCINSTALLDIR=&quot;%VCINSTALLDIR% &quot; &gt;&gt; set-vs-env.sh&#39; \
459             &gt;&gt; $EXTRACT_VC_ENV_BAT_FILE
460         $ECHO &#39;echo VCToolsRedistDir=&quot;%VCToolsRedistDir% &quot; &gt;&gt; set-vs-env.sh&#39; \
461             &gt;&gt; $EXTRACT_VC_ENV_BAT_FILE
462         $ECHO &#39;echo WindowsSdkDir=&quot;%WindowsSdkDir% &quot; &gt;&gt; set-vs-env.sh&#39; \
463             &gt;&gt; $EXTRACT_VC_ENV_BAT_FILE
464         $ECHO &#39;echo WINDOWSSDKDIR=&quot;%WINDOWSSDKDIR% &quot; &gt;&gt; set-vs-env.sh&#39; \
465             &gt;&gt; $EXTRACT_VC_ENV_BAT_FILE
466       else
467         # These will end up something like:
468         # C:/CygWin/bin/bash -c &#39;echo VS_PATH=\&quot;$PATH\&quot; &gt; localdevenv.sh
469         # The trailing space for everyone except PATH is no typo, but is needed due
470         # to trailing \ in the Windows paths. These will be stripped later.
471         $ECHO &quot;$WINPATH_BASH -c &#39;echo VS_PATH=&quot;&#39;\&quot;$PATH\&quot; &gt; set-vs-env.sh&#39; \
472             &gt;&gt; $EXTRACT_VC_ENV_BAT_FILE
473         $ECHO &quot;$WINPATH_BASH -c &#39;echo VS_INCLUDE=&quot;&#39;\&quot;$INCLUDE\;$include \&quot; &gt;&gt; set-vs-env.sh&#39; \
474             &gt;&gt; $EXTRACT_VC_ENV_BAT_FILE
475         $ECHO &quot;$WINPATH_BASH -c &#39;echo VS_LIB=&quot;&#39;\&quot;$LIB\;$lib \&quot; &gt;&gt; set-vs-env.sh&#39; \
476             &gt;&gt; $EXTRACT_VC_ENV_BAT_FILE
477         $ECHO &quot;$WINPATH_BASH -c &#39;echo VCINSTALLDIR=&quot;&#39;\&quot;$VCINSTALLDIR \&quot; &gt;&gt; set-vs-env.sh&#39; \
478             &gt;&gt; $EXTRACT_VC_ENV_BAT_FILE
479         $ECHO &quot;$WINPATH_BASH -c &#39;echo VCToolsRedistDir=&quot;&#39;\&quot;$VCToolsRedistDir \&quot; &gt;&gt; set-vs-env.sh&#39; \
480             &gt;&gt; $EXTRACT_VC_ENV_BAT_FILE
481         $ECHO &quot;$WINPATH_BASH -c &#39;echo WindowsSdkDir=&quot;&#39;\&quot;$WindowsSdkDir \&quot; &gt;&gt; set-vs-env.sh&#39; \
482             &gt;&gt; $EXTRACT_VC_ENV_BAT_FILE
483         $ECHO &quot;$WINPATH_BASH -c &#39;echo WINDOWSSDKDIR=&quot;&#39;\&quot;$WINDOWSSDKDIR \&quot; &gt;&gt; set-vs-env.sh&#39; \
484             &gt;&gt; $EXTRACT_VC_ENV_BAT_FILE
485       fi
486 
487       # Now execute the newly created bat file.
488       # The | cat is to stop SetEnv.Cmd to mess with system colors on msys.
489       # Change directory so we don&#39;t need to mess with Windows paths in redirects.
490       cd $VS_ENV_TMP_DIR
491       $CMD /c extract-vs-env.bat | $CAT
492       cd $CONFIGURE_START_DIR
493 
494       if test ! -s $VS_ENV_TMP_DIR/set-vs-env.sh; then
495         AC_MSG_NOTICE([Could not succesfully extract the environment variables needed for the VS setup.])
496         AC_MSG_NOTICE([Try setting --with-tools-dir to the VC/bin directory within the VS installation])
497         AC_MSG_NOTICE([or run &quot;bash.exe -l&quot; from a VS command prompt and then run configure from there.])
498         AC_MSG_ERROR([Cannot continue])
499       fi
500 
501       # Remove windows line endings
502       $SED -i -e &#39;s|\r||g&#39; $VS_ENV_TMP_DIR/set-vs-env.sh
503 
504       # Now set all paths and other env variables. This will allow the rest of
505       # the configure script to find and run the compiler in the proper way.
506       AC_MSG_NOTICE([Setting extracted environment variables])
507       . $VS_ENV_TMP_DIR/set-vs-env.sh
508       # Now we have VS_PATH, VS_INCLUDE, VS_LIB. For further checking, we
509       # also define VCINSTALLDIR, WindowsSdkDir and WINDOWSSDKDIR.
510 
511       # In WSL, the extracted VS_PATH is Windows style. This needs to be
512       # rewritten as Unix style and the Windows style version is saved
513       # in VS_PATH_WINDOWS.
514       if test &quot;x$OPENJDK_BUILD_OS_ENV&quot; = &quot;xwindows.wsl&quot;; then
515         OLDIFS=&quot;$IFS&quot;
516         IFS=&quot;;&quot;
517         # Convert VS_PATH to unix style
518         VS_PATH_WINDOWS=&quot;$VS_PATH&quot;
519         VS_PATH=&quot;&quot;
520         for i in $VS_PATH_WINDOWS; do
521           path=$i
522           # Only process non-empty elements
523           if test &quot;x$path&quot; != x; then
524             IFS=&quot;$OLDIFS&quot;
525             # Check that directory exists before calling fixup_path
526             testpath=$path
527             UTIL_REWRITE_AS_UNIX_PATH([testpath])
528             if test -d &quot;$testpath&quot;; then
529               UTIL_FIXUP_PATH([path])
530               UTIL_APPEND_TO_PATH(VS_PATH, $path)
531             fi
532             IFS=&quot;;&quot;
533           fi
534         done
535         IFS=&quot;$OLDIFS&quot;
536       fi
537 
538     else
539       # We did not find a vsvars bat file, let&#39;s hope we are run from a VS command prompt.
540       AC_MSG_NOTICE([Cannot locate a valid Visual Studio installation, checking current environment])
541     fi
542   fi
543 
544   # At this point, we should have correct variables in the environment, or we can&#39;t continue.
545   AC_MSG_CHECKING([for Visual Studio variables])
546 
547   if test &quot;x$VCINSTALLDIR&quot; != x || test &quot;x$WindowsSDKDir&quot; != x \
548       || test &quot;x$WINDOWSSDKDIR&quot; != x || test &quot;x$DEVKIT_NAME&quot; != x; then
549     if test &quot;x$VS_INCLUDE&quot; = x || test &quot;x$VS_LIB&quot; = x; then
550       AC_MSG_RESULT([present but broken])
551       AC_MSG_ERROR([Your VC command prompt seems broken, INCLUDE and/or LIB is missing.])
552     else
553       AC_MSG_RESULT([ok])
554       # Remove any trailing &quot;\&quot; &quot;;&quot; and &quot; &quot; from the variables.
555       VS_INCLUDE=`$ECHO &quot;$VS_INCLUDE&quot; | $SED -e &#39;s/\\\\*;* *$//&#39;`
556       VS_LIB=`$ECHO &quot;$VS_LIB&quot; | $SED &#39;s/\\\\*;* *$//&#39;`
557       VCINSTALLDIR=`$ECHO &quot;$VCINSTALLDIR&quot; | $SED &#39;s/\\\\* *$//&#39;`
558       VCToolsRedistDir=`$ECHO &quot;$VCToolsRedistDir&quot; | $SED &#39;s/\\\\* *$//&#39;`
559       WindowsSdkDir=`$ECHO &quot;$WindowsSdkDir&quot; | $SED &#39;s/\\\\* *$//&#39;`
560       WINDOWSSDKDIR=`$ECHO &quot;$WINDOWSSDKDIR&quot; | $SED &#39;s/\\\\* *$//&#39;`
561       if test -z &quot;$WINDOWSSDKDIR&quot;; then
562         WINDOWSSDKDIR=&quot;$WindowsSdkDir&quot;
563       fi
564       # Remove any paths containing # (typically F#) as that messes up make. This
565       # is needed if visual studio was installed with F# support.
566       VS_PATH=`$ECHO &quot;$VS_PATH&quot; | $SED &#39;s/[[^:#]]*#[^:]*://g&#39;`
567 
568       AC_SUBST(VS_PATH)
569       AC_SUBST(VS_INCLUDE)
570       AC_SUBST(VS_LIB)
571 
572       # Convert VS_INCLUDE into SYSROOT_CFLAGS
573       OLDIFS=&quot;$IFS&quot;
574       IFS=&quot;;&quot;
575       for i in $VS_INCLUDE; do
576         ipath=$i
577         # Only process non-empty elements
578         if test &quot;x$ipath&quot; != x; then
579           IFS=&quot;$OLDIFS&quot;
580           # Check that directory exists before calling fixup_path
581           testpath=$ipath
582           UTIL_REWRITE_AS_UNIX_PATH([testpath])
583           if test -d &quot;$testpath&quot;; then
584             UTIL_FIXUP_PATH([ipath])
585             SYSROOT_CFLAGS=&quot;$SYSROOT_CFLAGS -I$ipath&quot;
586           fi
587           IFS=&quot;;&quot;
588         fi
589       done
590       # Convert VS_LIB into SYSROOT_LDFLAGS
591       for i in $VS_LIB; do
592         libpath=$i
593         # Only process non-empty elements
594         if test &quot;x$libpath&quot; != x; then
595           IFS=&quot;$OLDIFS&quot;
596           # Check that directory exists before calling fixup_path
597           testpath=$libpath
598           UTIL_REWRITE_AS_UNIX_PATH([testpath])
599           if test -d &quot;$testpath&quot;; then
600             UTIL_FIXUP_PATH([libpath])
601             SYSROOT_LDFLAGS=&quot;$SYSROOT_LDFLAGS -libpath:$libpath&quot;
602           fi
603           IFS=&quot;;&quot;
604         fi
605       done
606       IFS=&quot;$OLDIFS&quot;
607 
608       AC_SUBST(VS_PATH_WINDOWS)
609     fi
610   else
611     AC_MSG_RESULT([not found])
612 
613     if test &quot;x$VS_ENV_CMD&quot; = x; then
614       AC_MSG_NOTICE([Cannot locate a valid Visual Studio or Windows SDK installation on disk,])
615       AC_MSG_NOTICE([nor is this script run from a Visual Studio command prompt.])
616     else
617       AC_MSG_NOTICE([Running the extraction script failed.])
618     fi
619     AC_MSG_NOTICE([Try setting --with-tools-dir to the VC/bin directory within the VS installation])
620     AC_MSG_NOTICE([or run &quot;bash.exe -l&quot; from a VS command prompt and then run configure from there.])
621     AC_MSG_ERROR([Cannot continue])
622   fi
623 ])
624 
625 AC_DEFUN([TOOLCHAIN_CHECK_POSSIBLE_MSVC_DLL],
626 [
627   DLL_NAME=&quot;$1&quot;
628   POSSIBLE_MSVC_DLL=&quot;$2&quot;
629   METHOD=&quot;$3&quot;
630   if test -n &quot;$POSSIBLE_MSVC_DLL&quot; -a -e &quot;$POSSIBLE_MSVC_DLL&quot;; then
631     AC_MSG_NOTICE([Found $DLL_NAME at $POSSIBLE_MSVC_DLL using $METHOD])
632 
633     # Need to check if the found msvcr is correct architecture
634     AC_MSG_CHECKING([found $DLL_NAME architecture])
635     MSVC_DLL_FILETYPE=`$FILE -b &quot;$POSSIBLE_MSVC_DLL&quot;`
636     if test &quot;x$OPENJDK_BUILD_OS_ENV&quot; = &quot;xwindows.msys&quot;; then
637       # The MSYS &#39;file&#39; command returns &quot;PE32 executable for MS Windows (DLL) (GUI) Intel 80386 32-bit&quot;
638       # on x32 and &quot;PE32+ executable for MS Windows (DLL) (GUI) Mono/.Net assembly&quot; on x64 systems.
639       if test &quot;x$OPENJDK_TARGET_CPU_BITS&quot; = x32; then
640         CORRECT_MSVCR_ARCH=&quot;PE32 executable&quot;
641       else
642         CORRECT_MSVCR_ARCH=&quot;PE32+ executable&quot;
643       fi
644     else
645       if test &quot;x$OPENJDK_TARGET_CPU_BITS&quot; = x32; then
646         CORRECT_MSVCR_ARCH=386
647       else
648         CORRECT_MSVCR_ARCH=x86-64
649       fi
650     fi
651     if $ECHO &quot;$MSVC_DLL_FILETYPE&quot; | $GREP &quot;$CORRECT_MSVCR_ARCH&quot; 2&gt;&amp;1 &gt; /dev/null; then
652       AC_MSG_RESULT([ok])
653       MSVC_DLL=&quot;$POSSIBLE_MSVC_DLL&quot;
654       AC_MSG_CHECKING([for $DLL_NAME])
655       AC_MSG_RESULT([$MSVC_DLL])
656     else
657       AC_MSG_RESULT([incorrect, ignoring])
658       AC_MSG_NOTICE([The file type of the located $DLL_NAME is $MSVC_DLL_FILETYPE])
659     fi
660   fi
661 ])
662 
663 AC_DEFUN([TOOLCHAIN_SETUP_MSVC_DLL],
664 [
665   DLL_NAME=&quot;$1&quot;
666   MSVC_DLL=
667 
668   if test &quot;x$MSVC_DLL&quot; = x; then
669     if test &quot;x$VCINSTALLDIR&quot; != x; then
670       CYGWIN_VC_INSTALL_DIR=&quot;$VCINSTALLDIR&quot;
671       UTIL_FIXUP_PATH(CYGWIN_VC_INSTALL_DIR)
672       if test &quot;$VS_VERSION&quot; -lt 2017; then
673         # Probe: Using well-known location from Visual Studio 12.0 and older
674         if test &quot;x$OPENJDK_TARGET_CPU_BITS&quot; = x64; then
675           POSSIBLE_MSVC_DLL=&quot;$CYGWIN_VC_INSTALL_DIR/redist/x64/Microsoft.VC${VS_VERSION_INTERNAL}.CRT/$DLL_NAME&quot;
676         else
677           POSSIBLE_MSVC_DLL=&quot;$CYGWIN_VC_INSTALL_DIR/redist/x86/Microsoft.VC${VS_VERSION_INTERNAL}.CRT/$DLL_NAME&quot;
678         fi
679       else
680         CYGWIN_VC_TOOLS_REDIST_DIR=&quot;$VCToolsRedistDir&quot;
681         UTIL_FIXUP_PATH(CYGWIN_VC_TOOLS_REDIST_DIR)
682         # Probe: Using well-known location from VS 2017 and VS 2019
683         if test &quot;x$OPENJDK_TARGET_CPU_BITS&quot; = x64; then
684           POSSIBLE_MSVC_DLL=&quot;`ls $CYGWIN_VC_TOOLS_REDIST_DIR/x64/Microsoft.VC${VS_VERSION_INTERNAL}.CRT/$DLL_NAME`&quot;
685         else
686           POSSIBLE_MSVC_DLL=&quot;`ls $CYGWIN_VC_TOOLS_REDIST_DIR/x86/Microsoft.VC${VS_VERSION_INTERNAL}.CRT/$DLL_NAME`&quot;
687         fi
688       fi
689       # In case any of the above finds more than one file, loop over them.
690       for possible_msvc_dll in $POSSIBLE_MSVC_DLL; do
691         $ECHO &quot;POSSIBLE_MSVC_DLL $possible_msvc_dll&quot;
692         TOOLCHAIN_CHECK_POSSIBLE_MSVC_DLL([$DLL_NAME], [$possible_msvc_dll],
693             [well-known location in VCINSTALLDIR])
694       done
695     fi
696   fi
697 
698   if test &quot;x$MSVC_DLL&quot; = x; then
699     # Probe: Check in the Boot JDK directory.
700     POSSIBLE_MSVC_DLL=&quot;$BOOT_JDK/bin/$DLL_NAME&quot;
701     TOOLCHAIN_CHECK_POSSIBLE_MSVC_DLL([$DLL_NAME], [$POSSIBLE_MSVC_DLL],
702         [well-known location in Boot JDK])
703   fi
704 
705   if test &quot;x$MSVC_DLL&quot; = x; then
706     # Probe: Look in the Windows system32 directory
707     CYGWIN_SYSTEMROOT=&quot;$SYSTEMROOT&quot;
708     UTIL_REWRITE_AS_UNIX_PATH(CYGWIN_SYSTEMROOT)
709     POSSIBLE_MSVC_DLL=&quot;$CYGWIN_SYSTEMROOT/system32/$DLL_NAME&quot;
710     TOOLCHAIN_CHECK_POSSIBLE_MSVC_DLL([$DLL_NAME], [$POSSIBLE_MSVC_DLL],
711         [well-known location in SYSTEMROOT])
712   fi
713 
714   if test &quot;x$MSVC_DLL&quot; = x; then
715     # Probe: If Visual Studio Express is installed, there is usually one with the debugger
716     if test &quot;x$VS100COMNTOOLS&quot; != x; then
717       CYGWIN_VS_TOOLS_DIR=&quot;$VS100COMNTOOLS/..&quot;
718       UTIL_REWRITE_AS_UNIX_PATH(CYGWIN_VS_TOOLS_DIR)
719       if test &quot;x$OPENJDK_TARGET_CPU_BITS&quot; = x64; then
720         POSSIBLE_MSVC_DLL=`$FIND &quot;$CYGWIN_VS_TOOLS_DIR&quot; -name $DLL_NAME \
721         | $GREP -i /x64/ | $HEAD --lines 1`
722       else
723         POSSIBLE_MSVC_DLL=`$FIND &quot;$CYGWIN_VS_TOOLS_DIR&quot; -name $DLL_NAME \
724         | $GREP -i /x86/ | $HEAD --lines 1`
725       fi
726       TOOLCHAIN_CHECK_POSSIBLE_MSVC_DLL([$DLL_NAME], [$POSSIBLE_MSVC_DLL],
727           [search of VS100COMNTOOLS])
728     fi
729   fi
730 
731   if test &quot;x$MSVC_DLL&quot; = x; then
732     # Probe: Search wildly in the VCINSTALLDIR. We&#39;ve probably lost by now.
733     # (This was the original behaviour; kept since it might turn something up)
734     if test &quot;x$CYGWIN_VC_INSTALL_DIR&quot; != x; then
735       if test &quot;x$OPENJDK_TARGET_CPU_BITS&quot; = x64; then
736         POSSIBLE_MSVC_DLL=`$FIND &quot;$CYGWIN_VC_INSTALL_DIR&quot; -name $DLL_NAME \
737         | $GREP x64 | $HEAD --lines 1`
738       else
739         POSSIBLE_MSVC_DLL=`$FIND &quot;$CYGWIN_VC_INSTALL_DIR&quot; -name $DLL_NAME \
740         | $GREP x86 | $GREP -v ia64 | $GREP -v x64 | $HEAD --lines 1`
741         if test &quot;x$POSSIBLE_MSVC_DLL&quot; = x; then
742           # We&#39;re grasping at straws now...
743           POSSIBLE_MSVC_DLL=`$FIND &quot;$CYGWIN_VC_INSTALL_DIR&quot; -name $DLL_NAME \
744           | $HEAD --lines 1`
745         fi
746       fi
747 
748       TOOLCHAIN_CHECK_POSSIBLE_MSVC_DLL([$DLL_NAME], [$POSSIBLE_MSVC_DLL],
749           [search of VCINSTALLDIR])
750     fi
751   fi
752 
753   if test &quot;x$MSVC_DLL&quot; = x; then
754     AC_MSG_CHECKING([for $DLL_NAME])
755     AC_MSG_RESULT([no])
756     AC_MSG_ERROR([Could not find $DLL_NAME. Please specify using --with-msvcr-dll.])
757   fi
758 ])
759 
760 AC_DEFUN([TOOLCHAIN_SETUP_VS_RUNTIME_DLLS],
761 [
762   AC_ARG_WITH(msvcr-dll, [AS_HELP_STRING([--with-msvcr-dll],
763       [path to microsoft C runtime dll (msvcr*.dll) (Windows only) @&lt;:@probed@:&gt;@])])
764 
765   if test &quot;x$with_msvcr_dll&quot; != x; then
766     # If given explicitly by user, do not probe. If not present, fail directly.
767     TOOLCHAIN_CHECK_POSSIBLE_MSVC_DLL($MSVCR_NAME, [$with_msvcr_dll], [--with-msvcr-dll])
768     if test &quot;x$MSVC_DLL&quot; = x; then
769       AC_MSG_ERROR([Could not find a proper $MSVCR_NAME as specified by --with-msvcr-dll])
770     fi
771     MSVCR_DLL=&quot;$MSVC_DLL&quot;
772   elif test &quot;x$DEVKIT_MSVCR_DLL&quot; != x; then
773     TOOLCHAIN_CHECK_POSSIBLE_MSVC_DLL($MSVCR_NAME, [$DEVKIT_MSVCR_DLL], [devkit])
774     if test &quot;x$MSVC_DLL&quot; = x; then
775       AC_MSG_ERROR([Could not find a proper $MSVCR_NAME as specified by devkit])
776     fi
777     MSVCR_DLL=&quot;$MSVC_DLL&quot;
778   else
779     TOOLCHAIN_SETUP_MSVC_DLL([${MSVCR_NAME}])
780     MSVCR_DLL=&quot;$MSVC_DLL&quot;
781   fi
782   AC_SUBST(MSVCR_DLL)
783 
784   AC_ARG_WITH(msvcp-dll, [AS_HELP_STRING([--with-msvcp-dll],
785       [path to microsoft C++ runtime dll (msvcp*.dll) (Windows only) @&lt;:@probed@:&gt;@])])
786 
787   if test &quot;x$MSVCP_NAME&quot; != &quot;x&quot;; then
788     if test &quot;x$with_msvcp_dll&quot; != x; then
789       # If given explicitly by user, do not probe. If not present, fail directly.
790       TOOLCHAIN_CHECK_POSSIBLE_MSVC_DLL($MSVCP_NAME, [$with_msvcp_dll], [--with-msvcp-dll])
791       if test &quot;x$MSVC_DLL&quot; = x; then
792         AC_MSG_ERROR([Could not find a proper $MSVCP_NAME as specified by --with-msvcp-dll])
793       fi
794       MSVCP_DLL=&quot;$MSVC_DLL&quot;
795     elif test &quot;x$DEVKIT_MSVCP_DLL&quot; != x; then
796       TOOLCHAIN_CHECK_POSSIBLE_MSVC_DLL($MSVCP_NAME, [$DEVKIT_MSVCP_DLL], [devkit])
797       if test &quot;x$MSVC_DLL&quot; = x; then
798         AC_MSG_ERROR([Could not find a proper $MSVCP_NAME as specified by devkit])
799       fi
800       MSVCP_DLL=&quot;$MSVC_DLL&quot;
801     else
802       TOOLCHAIN_SETUP_MSVC_DLL([${MSVCP_NAME}])
803       MSVCP_DLL=&quot;$MSVC_DLL&quot;
804     fi
805     AC_SUBST(MSVCP_DLL)
806   fi
807 
808   AC_ARG_WITH(vcruntime-1-dll, [AS_HELP_STRING([--with-vcruntime-1-dll],
809       [path to microsoft C++ runtime dll (vcruntime*_1.dll) (Windows only) @&lt;:@probed@:&gt;@])])
810 
811   if test &quot;x$VCRUNTIME_1_NAME&quot; != &quot;x&quot;; then
812     if test &quot;x$with_vcruntime_1_dll&quot; != x; then
813       # If given explicitly by user, do not probe. If not present, fail directly.
814       TOOLCHAIN_CHECK_POSSIBLE_MSVC_DLL($VCRUNTIME_1_NAME, [$with_vcruntime_1_dll],
815           [--with-vcruntime-1-dll])
816       if test &quot;x$MSVC_DLL&quot; = x; then
817         AC_MSG_ERROR([Could not find a proper $VCRUNTIME_1_NAME as specified by --with-vcruntime-1-dll])
818       fi
819       VCRUNTIME_1_DLL=&quot;$MSVC_DLL&quot;
820     elif test &quot;x$DEVKIT_VCRUNTIME_1_DLL&quot; != x; then
821       TOOLCHAIN_CHECK_POSSIBLE_MSVC_DLL($VCRUNTIME_1_NAME, [$DEVKIT_VCRUNTIME_1_DLL], [devkit])
822       if test &quot;x$MSVC_DLL&quot; = x; then
823         AC_MSG_ERROR([Could not find a proper $VCRUNTIME_1_NAME as specified by devkit])
824       fi
825       VCRUNTIME_1_DLL=&quot;$MSVC_DLL&quot;
826     else
827       TOOLCHAIN_SETUP_MSVC_DLL([${VCRUNTIME_1_NAME}])
828       VCRUNTIME_1_DLL=&quot;$MSVC_DLL&quot;
829     fi
830     AC_SUBST(VCRUNTIME_1_DLL)
831   fi
832 
833   AC_ARG_WITH(ucrt-dll-dir, [AS_HELP_STRING([--with-ucrt-dll-dir],
834       [path to Microsoft Windows Kit UCRT DLL dir (Windows only) @&lt;:@probed@:&gt;@])])
835 
836   if test &quot;x$USE_UCRT&quot; = &quot;xtrue&quot;; then
837     AC_MSG_CHECKING([for UCRT DLL dir])
838     if test &quot;x$with_ucrt_dll_dir&quot; != x; then
839       if test -z &quot;$(ls -d &quot;$with_ucrt_dll_dir/&quot;*.dll 2&gt; /dev/null)&quot;; then
840         AC_MSG_RESULT([no])
841         AC_MSG_ERROR([Could not find any dlls in $with_ucrt_dll_dir])
842       else
843         AC_MSG_RESULT([$with_ucrt_dll_dir])
844         UCRT_DLL_DIR=&quot;$with_ucrt_dll_dir&quot;
845         UTIL_FIXUP_PATH([UCRT_DLL_DIR])
846       fi
847     elif test &quot;x$DEVKIT_UCRT_DLL_DIR&quot; != &quot;x&quot;; then
848       UCRT_DLL_DIR=&quot;$DEVKIT_UCRT_DLL_DIR&quot;
849       AC_MSG_RESULT($UCRT_DLL_DIR)
850     else
851       CYGWIN_WINDOWSSDKDIR=&quot;${WINDOWSSDKDIR}&quot;
852       UTIL_FIXUP_PATH([CYGWIN_WINDOWSSDKDIR])
853       dll_subdir=$OPENJDK_TARGET_CPU
854       if test &quot;x$dll_subdir&quot; = &quot;xx86_64&quot;; then
855         dll_subdir=&quot;x64&quot;
856       fi
857       UCRT_DLL_DIR=&quot;$CYGWIN_WINDOWSSDKDIR/Redist/ucrt/DLLs/$dll_subdir&quot;
858       if test -z &quot;$(ls -d &quot;$UCRT_DLL_DIR/&quot;*.dll 2&gt; /dev/null)&quot;; then
859         # Try with version subdir
860         UCRT_DLL_DIR=&quot;`ls -d $CYGWIN_WINDOWSSDKDIR/Redist/*/ucrt/DLLs/$dll_subdir \
861             2&gt; /dev/null | $SORT -d | $HEAD -n1`&quot;
862         if test -z &quot;$UCRT_DLL_DIR&quot; \
863             || test -z &quot;$(ls -d &quot;$UCRT_DLL_DIR/&quot;*.dll 2&gt; /dev/null)&quot;; then
864           AC_MSG_RESULT([no])
865           AC_MSG_ERROR([Could not find any dlls in $UCRT_DLL_DIR])
866         else
867           AC_MSG_RESULT($UCRT_DLL_DIR)
868         fi
869       else
870         AC_MSG_RESULT($UCRT_DLL_DIR)
871       fi
872     fi
873   else
874     UCRT_DLL_DIR=
875   fi
876   AC_SUBST(UCRT_DLL_DIR)
877 ])
    </pre>
  </body>
</html>