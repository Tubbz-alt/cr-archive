<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff test/jdk/java/jextract/TestAttributes.java</title>
    <link rel="stylesheet" href="../../../../style.css" />
  </head>
<body>
<center><a href="../../../../src/jdk.incubator.jextract/share/classes/jdk/internal/jextract/impl/TreeMaker.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> next &gt;</center>    <h2>test/jdk/java/jextract/TestAttributes.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 14  * version 2 for more details (a copy is included in the LICENSE file that
 15  * accompanied this code).
 16  *
 17  * You should have received a copy of the GNU General Public License version
 18  * 2 along with this work; if not, write to the Free Software Foundation,
 19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 20  *
 21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 22  * or visit www.oracle.com if you need additional information or have any
 23  * questions.
 24  *
 25  */
 26 
 27 /*
 28  * @test
 29  * @bug 8239808
 30  * @build JextractApiTestBase
 31  * @run testng TestAttributes
 32  */
 33 




 34 import java.util.stream.Collectors;

 35 import jdk.incubator.foreign.MemoryLayouts;
 36 import jdk.incubator.jextract.Declaration;
 37 import jdk.incubator.jextract.Type;
 38 import org.testng.annotations.Test;
 39 
 40 import static org.testng.Assert.assertEquals;

 41 
 42 public class TestAttributes extends JextractApiTestBase {
 43     private final static Type C_INT = Type.primitive(Type.Primitive.Kind.Int, MemoryLayouts.C_INT);
 44     private final static String ASMLABEL = &quot;AsmLabelAttr&quot;;
 45 
 46     private void validateAsmLabel(Declaration d, boolean isAdd) {
 47         var attrs = d.getAttribute(ASMLABEL).get();
 48         String value = isMacOSX ? &quot;_&quot; : &quot;&quot;;
 49         value += d.name();
 50         value += isAdd ? &quot;A&quot; : &quot;B&quot;;
 51         assertEquals(attrs.get(0), value);
 52     }
 53 
 54     private void validateHeader(Declaration.Scoped top, boolean isAdd) {
 55         if (isWindows) {
 56             // TODO: add Windows validation
 57             // Simply dump declaration for now
 58             System.out.println(top);
 59             return;
 60         }
</pre>
<hr />
<pre>
 83             checkFunction(func, C_INT, C_INT, C_INT);
 84             if (func.getAttribute(ASMLABEL).isPresent()) {
 85                 hasAttrs++;
 86                 validateAsmLabel(func, isAdd);
 87             }
 88         }
 89         assertEquals(hasAttrs, 2);
 90     }
 91 
 92     @Test
 93     public void testA() {
 94         Declaration.Scoped d = parse(&quot;libAsmSymbol.h&quot;, &quot;-DADD&quot;);
 95         validateHeader(d, true);
 96     }
 97 
 98     @Test
 99     public void testB() {
100         Declaration.Scoped d = parse(&quot;libAsmSymbol.h&quot;);
101         validateHeader(d, false);
102     }























































103 }
</pre>
</td>
<td>
<hr />
<pre>
 14  * version 2 for more details (a copy is included in the LICENSE file that
 15  * accompanied this code).
 16  *
 17  * You should have received a copy of the GNU General Public License version
 18  * 2 along with this work; if not, write to the Free Software Foundation,
 19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 20  *
 21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 22  * or visit www.oracle.com if you need additional information or have any
 23  * questions.
 24  *
 25  */
 26 
 27 /*
 28  * @test
 29  * @bug 8239808
 30  * @build JextractApiTestBase
 31  * @run testng TestAttributes
 32  */
 33 
<span class="line-added"> 34 import java.lang.constant.Constable;</span>
<span class="line-added"> 35 import java.time.LocalDateTime;</span>
<span class="line-added"> 36 import java.time.format.DateTimeFormatter;</span>
<span class="line-added"> 37 import java.util.List;</span>
 38 import java.util.stream.Collectors;
<span class="line-added"> 39 import java.util.stream.Stream;</span>
 40 import jdk.incubator.foreign.MemoryLayouts;
 41 import jdk.incubator.jextract.Declaration;
 42 import jdk.incubator.jextract.Type;
 43 import org.testng.annotations.Test;
 44 
 45 import static org.testng.Assert.assertEquals;
<span class="line-added"> 46 import static org.testng.Assert.assertTrue;</span>
 47 
 48 public class TestAttributes extends JextractApiTestBase {
 49     private final static Type C_INT = Type.primitive(Type.Primitive.Kind.Int, MemoryLayouts.C_INT);
 50     private final static String ASMLABEL = &quot;AsmLabelAttr&quot;;
 51 
 52     private void validateAsmLabel(Declaration d, boolean isAdd) {
 53         var attrs = d.getAttribute(ASMLABEL).get();
 54         String value = isMacOSX ? &quot;_&quot; : &quot;&quot;;
 55         value += d.name();
 56         value += isAdd ? &quot;A&quot; : &quot;B&quot;;
 57         assertEquals(attrs.get(0), value);
 58     }
 59 
 60     private void validateHeader(Declaration.Scoped top, boolean isAdd) {
 61         if (isWindows) {
 62             // TODO: add Windows validation
 63             // Simply dump declaration for now
 64             System.out.println(top);
 65             return;
 66         }
</pre>
<hr />
<pre>
 89             checkFunction(func, C_INT, C_INT, C_INT);
 90             if (func.getAttribute(ASMLABEL).isPresent()) {
 91                 hasAttrs++;
 92                 validateAsmLabel(func, isAdd);
 93             }
 94         }
 95         assertEquals(hasAttrs, 2);
 96     }
 97 
 98     @Test
 99     public void testA() {
100         Declaration.Scoped d = parse(&quot;libAsmSymbol.h&quot;, &quot;-DADD&quot;);
101         validateHeader(d, true);
102     }
103 
104     @Test
105     public void testB() {
106         Declaration.Scoped d = parse(&quot;libAsmSymbol.h&quot;);
107         validateHeader(d, false);
108     }
<span class="line-added">109 </span>
<span class="line-added">110     private static  Constable getSingleValue(Declaration d, String name) {</span>
<span class="line-added">111         List&lt;Constable&gt; values = d.getAttribute(name).get();</span>
<span class="line-added">112         assertEquals(1, values.size());</span>
<span class="line-added">113         return values.get(0);</span>
<span class="line-added">114     }</span>
<span class="line-added">115 </span>
<span class="line-added">116     @Test</span>
<span class="line-added">117     public void testAddAttribute() {</span>
<span class="line-added">118         final String ts = &quot;timestamp&quot;;</span>
<span class="line-added">119         Declaration.Scoped d = parse(&quot;libAsmSymbol.h&quot;);</span>
<span class="line-added">120         String timestamp = LocalDateTime.now().format(DateTimeFormatter.ISO_DATE_TIME);</span>
<span class="line-added">121         Declaration withAttrs = d.withAttribute(&quot;header&quot;, d.name())</span>
<span class="line-added">122                 .withAttribute(ts, timestamp);</span>
<span class="line-added">123 </span>
<span class="line-added">124         assertEquals(getSingleValue(withAttrs, &quot;header&quot;), d.name());</span>
<span class="line-added">125         assertEquals(getSingleValue(withAttrs, ts), timestamp);</span>
<span class="line-added">126 </span>
<span class="line-added">127         String timestamp2 = LocalDateTime.now().format(DateTimeFormatter.ISO_LOCAL_DATE_TIME);</span>
<span class="line-added">128         Declaration withNewAttrs = withAttrs.withAttribute(ts, timestamp2);</span>
<span class="line-added">129         assertEquals(getSingleValue(withNewAttrs, ts), timestamp2);</span>
<span class="line-added">130 </span>
<span class="line-added">131         // Make sure original Declaration is not altered</span>
<span class="line-added">132         assertEquals(getSingleValue(withAttrs, ts), timestamp);</span>
<span class="line-added">133 </span>
<span class="line-added">134         // Add more value to same attribute</span>
<span class="line-added">135         withNewAttrs = withAttrs.withAttribute(ts, Stream.concat(</span>
<span class="line-added">136                 withAttrs.getAttribute(ts).map(List::stream).orElse(Stream.empty()),</span>
<span class="line-added">137                 Stream.of(timestamp2)</span>
<span class="line-added">138             ).toArray(Constable[]::new));</span>
<span class="line-added">139         assertEquals(withNewAttrs.getAttribute(ts).get(), List.of(timestamp, timestamp2));</span>
<span class="line-added">140         assertEquals(getSingleValue(withNewAttrs,&quot;header&quot;), d.name());</span>
<span class="line-added">141 </span>
<span class="line-added">142         // Remove attribute</span>
<span class="line-added">143         withAttrs = withNewAttrs.withAttribute(ts);</span>
<span class="line-added">144         assertTrue(withAttrs.getAttribute(ts).isEmpty());</span>
<span class="line-added">145 </span>
<span class="line-added">146         // Strip attribute</span>
<span class="line-added">147         withNewAttrs = withNewAttrs.stripAttributes();</span>
<span class="line-added">148         assertTrue(withNewAttrs.attributeNames().isEmpty());</span>
<span class="line-added">149     }</span>
<span class="line-added">150 </span>
<span class="line-added">151     @Test</span>
<span class="line-added">152     public void replaceFunctionSymbol() {</span>
<span class="line-added">153         Declaration.Scoped d = parse(&quot;libAsmSymbol.h&quot;, &quot;-DADD&quot;);</span>
<span class="line-added">154         validateHeader(d, true);</span>
<span class="line-added">155 </span>
<span class="line-added">156         var members = d.members().stream()</span>
<span class="line-added">157             .map(m -&gt; m.getAttribute(ASMLABEL)</span>
<span class="line-added">158                     .map(attr -&gt; m.withAttribute(ASMLABEL, attr.get(0).toString().replace(&#39;A&#39;, &#39;B&#39;)))</span>
<span class="line-added">159                     .orElse(m))</span>
<span class="line-added">160             .toArray(Declaration[]::new);</span>
<span class="line-added">161         Declaration.Scoped patched = Declaration.toplevel(d.pos(), members);</span>
<span class="line-added">162         validateHeader(patched, false);</span>
<span class="line-added">163     }</span>
164 }
</pre>
</td>
</tr>
</table>
<center><a href="../../../../src/jdk.incubator.jextract/share/classes/jdk/internal/jextract/impl/TreeMaker.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> next &gt;</center>  </body>
</html>