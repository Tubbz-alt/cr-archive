<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/jdk.incubator.foreign/share/classes/jdk/internal/foreign/MemoryScope.java</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
  </head>
<body>
<center>&lt; prev <a href="../../../../../../../index.html" target="_top">index</a> next &gt;</center>    <h2>src/jdk.incubator.foreign/share/classes/jdk/internal/foreign/MemoryScope.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
134         private final Object ref;
135         private final Runnable cleanupAction;
136 
137         private final StampedLock lock = new StampedLock();
138 
139 
140 
141         private Root(Object ref, Runnable cleanupAction) {
142             this.ref = ref;
143             this.cleanupAction = cleanupAction;
144         }
145 
146         @Override
147         MemoryScope acquire() {
148             //try to optimistically acquire the lock
149             long stamp = lock.tryOptimisticRead();
150             try {
151                 for (; ; stamp = lock.readLock()) {
152                     if (stamp == 0L)
153                         continue;
<span class="line-modified">154                     checkAliveConfined(); // plain read is enough here (either successful optimistic read, or ful read lock)</span>
155 
156                     // increment acquires
157                     acquired.increment();
<span class="line-modified">158                     // did a call to close() occurred since we acquired the lock?</span>
159                     if (lock.validate(stamp)) {
160                         // no, just return the acquired scope
161                         return new Child();
162                     } else {
163                         // yes, just back off and retry (close might have failed, after all)
164                         acquired.decrement();
165                     }
166                 }
167             } finally {
168                 if (StampedLock.isReadLockStamp(stamp))
169                     lock.unlockRead(stamp);
170             }
171         }
172 
173         @Override
174         MemoryScope dup() { // always called in owner thread
175             return closeOrDup(false);
176         }
177 
178         @Override
</pre>
</td>
<td>
<hr />
<pre>
134         private final Object ref;
135         private final Runnable cleanupAction;
136 
137         private final StampedLock lock = new StampedLock();
138 
139 
140 
141         private Root(Object ref, Runnable cleanupAction) {
142             this.ref = ref;
143             this.cleanupAction = cleanupAction;
144         }
145 
146         @Override
147         MemoryScope acquire() {
148             //try to optimistically acquire the lock
149             long stamp = lock.tryOptimisticRead();
150             try {
151                 for (; ; stamp = lock.readLock()) {
152                     if (stamp == 0L)
153                         continue;
<span class="line-modified">154                     checkAliveConfined(); // plain read is enough here (either successful optimistic read, or full read lock)</span>
155 
156                     // increment acquires
157                     acquired.increment();
<span class="line-modified">158                     // did a call to close() occur since we acquired the lock?</span>
159                     if (lock.validate(stamp)) {
160                         // no, just return the acquired scope
161                         return new Child();
162                     } else {
163                         // yes, just back off and retry (close might have failed, after all)
164                         acquired.decrement();
165                     }
166                 }
167             } finally {
168                 if (StampedLock.isReadLockStamp(stamp))
169                     lock.unlockRead(stamp);
170             }
171         }
172 
173         @Override
174         MemoryScope dup() { // always called in owner thread
175             return closeOrDup(false);
176         }
177 
178         @Override
</pre>
</td>
</tr>
</table>
<center>&lt; prev <a href="../../../../../../../index.html" target="_top">index</a> next &gt;</center>  </body>
</html>