<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff test/jdk/java/foreign/TestAdaptVarHandles.java</title>
    <link rel="stylesheet" href="../../../../style.css" />
  </head>
<body>
<center><a href="../../../../src/jdk.incubator.foreign/share/classes/jdk/internal/foreign/Utils.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="TestAddressHandle.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>test/jdk/java/foreign/TestAdaptVarHandles.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 16  *  2 along with this work; if not, write to the Free Software Foundation,
 17  *  Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  *   Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  *  or visit www.oracle.com if you need additional information or have any
 21  *  questions.
 22  *
 23  */
 24 
 25 /*
 26  * @test
 27  * @modules jdk.incubator.foreign
 28  * @run testng/othervm -Djava.lang.invoke.VarHandle.VAR_HANDLE_GUARDS=true -Djava.lang.invoke.VarHandle.VAR_HANDLE_IDENTITY_ADAPT=false -Xverify:all TestAdaptVarHandles
 29  * @run testng/othervm -Djava.lang.invoke.VarHandle.VAR_HANDLE_GUARDS=true -Djava.lang.invoke.VarHandle.VAR_HANDLE_IDENTITY_ADAPT=true -Xverify:all TestAdaptVarHandles
 30  * @run testng/othervm -Djava.lang.invoke.VarHandle.VAR_HANDLE_GUARDS=false -Djava.lang.invoke.VarHandle.VAR_HANDLE_IDENTITY_ADAPT=false -Xverify:all TestAdaptVarHandles
 31  * @run testng/othervm -Djava.lang.invoke.VarHandle.VAR_HANDLE_GUARDS=false -Djava.lang.invoke.VarHandle.VAR_HANDLE_IDENTITY_ADAPT=true -Xverify:all TestAdaptVarHandles
 32  */
 33 
 34 import jdk.incubator.foreign.MemoryAddress;
 35 import jdk.incubator.foreign.MemoryHandles;

 36 import jdk.incubator.foreign.MemoryLayouts;
 37 import jdk.incubator.foreign.MemorySegment;
 38 import jdk.incubator.foreign.ValueLayout;
 39 import org.testng.annotations.*;
 40 import static org.testng.Assert.*;
 41 
 42 import java.lang.invoke.MethodHandle;
 43 import java.lang.invoke.MethodHandles;
 44 import java.lang.invoke.MethodType;
 45 import java.lang.invoke.VarHandle;
 46 import java.util.List;
 47 
 48 public class TestAdaptVarHandles {
 49 
 50     static MethodHandle S2I;
 51     static MethodHandle I2S;
 52     static MethodHandle CTX_I2S;
 53     static MethodHandle O2I;
 54     static MethodHandle I2O;
 55     static MethodHandle S2L;
 56     static MethodHandle S2L_EX;
 57     static MethodHandle S2I_EX;
 58     static MethodHandle I2S_EX;
 59     static MethodHandle BASE_ADDR;
 60     static MethodHandle SUM_OFFSETS;
 61     static MethodHandle VOID_FILTER;
 62 
 63     static {
 64         try {
 65             S2I = MethodHandles.lookup().findStatic(TestAdaptVarHandles.class, &quot;stringToInt&quot;, MethodType.methodType(int.class, String.class));
 66             I2S = MethodHandles.lookup().findStatic(TestAdaptVarHandles.class, &quot;intToString&quot;, MethodType.methodType(String.class, int.class));
 67             CTX_I2S = MethodHandles.lookup().findStatic(TestAdaptVarHandles.class, &quot;ctxIntToString&quot;,
 68                     MethodType.methodType(String.class, String.class, String.class, int.class));
 69             O2I = MethodHandles.explicitCastArguments(S2I, MethodType.methodType(int.class, Object.class));
 70             I2O = MethodHandles.explicitCastArguments(I2S, MethodType.methodType(Object.class, int.class));
 71             S2L = MethodHandles.lookup().findStatic(TestAdaptVarHandles.class, &quot;stringToLong&quot;, MethodType.methodType(long.class, String.class));
 72             S2L_EX = MethodHandles.lookup().findStatic(TestAdaptVarHandles.class, &quot;stringToLongException&quot;, MethodType.methodType(long.class, String.class));
<span class="line-modified"> 73             BASE_ADDR = MethodHandles.lookup().findStatic(TestAdaptVarHandles.class, &quot;baseAddress&quot;, MethodType.methodType(MemoryAddress.class, MemorySegment.class));</span>
 74             SUM_OFFSETS = MethodHandles.lookup().findStatic(TestAdaptVarHandles.class, &quot;sumOffsets&quot;, MethodType.methodType(long.class, long.class, long.class));
 75             VOID_FILTER = MethodHandles.lookup().findStatic(TestAdaptVarHandles.class, &quot;void_filter&quot;, MethodType.methodType(void.class, String.class));
 76 
 77             MethodHandle s2i_ex = MethodHandles.throwException(int.class, Throwable.class);
 78             s2i_ex = MethodHandles.insertArguments(s2i_ex, 0, new Throwable());
 79             S2I_EX = MethodHandles.dropArguments(s2i_ex, 0, String.class);
 80 
 81             MethodHandle i2s_ex = MethodHandles.throwException(String.class, Throwable.class);
 82             i2s_ex = MethodHandles.insertArguments(i2s_ex, 0, new Throwable());
 83             I2S_EX = MethodHandles.dropArguments(i2s_ex, 0, int.class);
 84         } catch (Throwable ex) {
 85             throw new ExceptionInInitializerError();
 86         }
 87     }
 88 







 89     @Test
 90     public void testFilterValue() throws Throwable {
 91         ValueLayout layout = MemoryLayouts.JAVA_INT;
 92         MemorySegment segment = MemorySegment.allocateNative(layout);
 93         VarHandle intHandle = layout.varHandle(int.class);
 94         VarHandle i2SHandle = MemoryHandles.filterValue(intHandle, S2I, I2S);
<span class="line-modified"> 95         i2SHandle.set(segment.address(), &quot;1&quot;);</span>
<span class="line-modified"> 96         String oldValue = (String)i2SHandle.getAndAdd(segment.address(), &quot;42&quot;);</span>
 97         assertEquals(oldValue, &quot;1&quot;);
<span class="line-modified"> 98         String value = (String)i2SHandle.get(segment.address());</span>
 99         assertEquals(value, &quot;43&quot;);
<span class="line-modified">100         boolean swapped = (boolean)i2SHandle.compareAndSet(segment.address(), &quot;43&quot;, &quot;12&quot;);</span>
101         assertTrue(swapped);
<span class="line-modified">102         oldValue = (String)i2SHandle.compareAndExchange(segment.address(), &quot;12&quot;, &quot;42&quot;);</span>
103         assertEquals(oldValue, &quot;12&quot;);
<span class="line-modified">104         value = (String)i2SHandle.toMethodHandle(VarHandle.AccessMode.GET).invokeExact(segment.address());</span>
105         assertEquals(value, &quot;42&quot;);
106     }
107 
108     @Test
109     public void testFilterValueComposite() throws Throwable {
110         ValueLayout layout = MemoryLayouts.JAVA_INT;
111         MemorySegment segment = MemorySegment.allocateNative(layout);
112         VarHandle intHandle = layout.varHandle(int.class);
113         MethodHandle CTX_S2I = MethodHandles.dropArguments(S2I, 0, String.class, String.class);
114         VarHandle i2SHandle = MemoryHandles.filterValue(intHandle, CTX_S2I, CTX_I2S);
115         i2SHandle = MemoryHandles.insertCoordinates(i2SHandle, 1, &quot;a&quot;, &quot;b&quot;);
<span class="line-modified">116         i2SHandle.set(segment.address(), &quot;1&quot;);</span>
<span class="line-modified">117         String oldValue = (String)i2SHandle.getAndAdd(segment.address(), &quot;42&quot;);</span>
118         assertEquals(oldValue, &quot;ab1&quot;);
<span class="line-modified">119         String value = (String)i2SHandle.get(segment.address());</span>
120         assertEquals(value, &quot;ab43&quot;);
<span class="line-modified">121         boolean swapped = (boolean)i2SHandle.compareAndSet(segment.address(), &quot;43&quot;, &quot;12&quot;);</span>
122         assertTrue(swapped);
<span class="line-modified">123         oldValue = (String)i2SHandle.compareAndExchange(segment.address(), &quot;12&quot;, &quot;42&quot;);</span>
124         assertEquals(oldValue, &quot;ab12&quot;);
<span class="line-modified">125         value = (String)i2SHandle.toMethodHandle(VarHandle.AccessMode.GET).invokeExact(segment.address());</span>
126         assertEquals(value, &quot;ab42&quot;);
127     }
128 
129     @Test
130     public void testFilterValueLoose() throws Throwable {
131         ValueLayout layout = MemoryLayouts.JAVA_INT;
132         MemorySegment segment = MemorySegment.allocateNative(layout);
133         VarHandle intHandle = layout.varHandle(int.class);
134         VarHandle i2SHandle = MemoryHandles.filterValue(intHandle, O2I, I2O);
<span class="line-modified">135         i2SHandle.set(segment.address(), &quot;1&quot;);</span>
<span class="line-modified">136         String oldValue = (String)i2SHandle.getAndAdd(segment.address(), &quot;42&quot;);</span>
137         assertEquals(oldValue, &quot;1&quot;);
<span class="line-modified">138         String value = (String)i2SHandle.get(segment.address());</span>
139         assertEquals(value, &quot;43&quot;);
<span class="line-modified">140         boolean swapped = (boolean)i2SHandle.compareAndSet(segment.address(), &quot;43&quot;, &quot;12&quot;);</span>
141         assertTrue(swapped);
<span class="line-modified">142         oldValue = (String)i2SHandle.compareAndExchange(segment.address(), &quot;12&quot;, &quot;42&quot;);</span>
143         assertEquals(oldValue, &quot;12&quot;);
<span class="line-modified">144         value = (String)(Object)i2SHandle.toMethodHandle(VarHandle.AccessMode.GET).invokeExact(segment.address());</span>
145         assertEquals(value, &quot;42&quot;);
146     }
147 
148     @Test(expectedExceptions = NullPointerException.class)
149     public void testBadFilterNullTarget() {
150         MemoryHandles.filterValue(null, S2I, I2S);
151     }
152 
153     @Test(expectedExceptions = NullPointerException.class)
154     public void testBadFilterNullUnbox() {
<span class="line-removed">155         VarHandle intHandle = MemoryLayouts.JAVA_INT.varHandle(int.class);</span>
156         MemoryHandles.filterValue(intHandle, null, I2S);
157     }
158 
159     @Test(expectedExceptions = NullPointerException.class)
160     public void testBadFilterNullBox() {
<span class="line-removed">161         VarHandle intHandle = MemoryLayouts.JAVA_INT.varHandle(int.class);</span>
162         MemoryHandles.filterValue(intHandle, S2I, null);
163     }
164 
165     @Test(expectedExceptions = IllegalArgumentException.class)
166     public void testBadFilterCarrier() {
<span class="line-removed">167         VarHandle floatHandle = MemoryLayouts.JAVA_FLOAT.varHandle(float.class);</span>
168         MemoryHandles.filterValue(floatHandle, S2I, I2S);
169     }
170 
171     @Test(expectedExceptions = IllegalArgumentException.class)
172     public void testBadFilterUnboxArity() {
173         VarHandle floatHandle = MemoryLayouts.JAVA_INT.varHandle(int.class);
174         MemoryHandles.filterValue(floatHandle, S2I.bindTo(&quot;&quot;), I2S);
175     }
176 
177     @Test(expectedExceptions = IllegalArgumentException.class)
178     public void testBadFilterBoxArity() {
179         VarHandle intHandle = MemoryLayouts.JAVA_INT.varHandle(int.class);
180         MemoryHandles.filterValue(intHandle, S2I, I2S.bindTo(42));
181     }
182 
183     @Test(expectedExceptions = IllegalArgumentException.class)
184     public void testBadFilterBoxPrefixCoordinates() {
185         VarHandle intHandle = MemoryLayouts.JAVA_INT.varHandle(int.class);
186         MemoryHandles.filterValue(intHandle,
187                 MethodHandles.dropArguments(S2I, 1, int.class),
</pre>
<hr />
<pre>
199         VarHandle intHandle = MemoryLayouts.JAVA_INT.varHandle(int.class);
200         MemoryHandles.filterValue(intHandle, S2L_EX, I2S);
201     }
202 
203     @Test(expectedExceptions = IllegalArgumentException.class)
204     public void testBadFilterBoxHandleException() {
205         VarHandle intHandle = MemoryLayouts.JAVA_INT.varHandle(int.class);
206         MemoryHandles.filterValue(intHandle, S2I, I2S_EX);
207     }
208 
209     @Test(expectedExceptions = IllegalArgumentException.class)
210     public void testBadFilterUnboxHandleException() {
211         VarHandle intHandle = MemoryLayouts.JAVA_INT.varHandle(int.class);
212         MemoryHandles.filterValue(intHandle, S2I_EX, I2S);
213     }
214 
215     @Test
216     public void testFilterCoordinates() throws Throwable {
217         ValueLayout layout = MemoryLayouts.JAVA_INT;
218         MemorySegment segment = MemorySegment.allocateNative(layout);
<span class="line-modified">219         VarHandle intHandle = MemoryHandles.withStride(layout.varHandle(int.class), 4);</span>
<span class="line-removed">220         VarHandle intHandle_longIndex = MemoryHandles.filterCoordinates(intHandle, 0, BASE_ADDR, S2L);</span>
221         intHandle_longIndex.set(segment, &quot;0&quot;, 1);
222         int oldValue = (int)intHandle_longIndex.getAndAdd(segment, &quot;0&quot;, 42);
223         assertEquals(oldValue, 1);
224         int value = (int)intHandle_longIndex.get(segment, &quot;0&quot;);
225         assertEquals(value, 43);
226         boolean swapped = (boolean)intHandle_longIndex.compareAndSet(segment, &quot;0&quot;, 43, 12);
227         assertTrue(swapped);
228         oldValue = (int)intHandle_longIndex.compareAndExchange(segment, &quot;0&quot;, 12, 42);
229         assertEquals(oldValue, 12);
230         value = (int)intHandle_longIndex.toMethodHandle(VarHandle.AccessMode.GET).invokeExact(segment, &quot;0&quot;);
231         assertEquals(value, 42);
232     }
233 
234     @Test(expectedExceptions = NullPointerException.class)
235     public void testBadFilterCoordinatesNullTarget() {
236         MemoryHandles.filterCoordinates(null, 0, S2I);
237     }
238 
239     @Test(expectedExceptions = NullPointerException.class)
240     public void testBadFilterCoordinatesNullFilters() {
<span class="line-removed">241         VarHandle intHandle = MemoryLayouts.JAVA_INT.varHandle(int.class);</span>
242         MemoryHandles.filterCoordinates(intHandle, 0, null);
243     }
244 
245     @Test(expectedExceptions = IllegalArgumentException.class)
246     public void testBadFilterCoordinatesNegativePos() {
<span class="line-removed">247         VarHandle intHandle = MemoryLayouts.JAVA_INT.varHandle(int.class);</span>
248         MemoryHandles.filterCoordinates(intHandle, -1, SUM_OFFSETS);
249     }
250 
251     @Test(expectedExceptions = IllegalArgumentException.class)
252     public void testBadFilterCoordinatesPosTooBig() {
<span class="line-removed">253         VarHandle intHandle = MemoryLayouts.JAVA_INT.varHandle(int.class);</span>
254         MemoryHandles.filterCoordinates(intHandle, 1, SUM_OFFSETS);
255     }
256 
257     @Test(expectedExceptions = IllegalArgumentException.class)
258     public void testBadFilterCoordinatesWrongFilterType() {
<span class="line-modified">259         VarHandle intHandle = MemoryHandles.withStride(MemoryLayouts.JAVA_INT.varHandle(int.class), 4);</span>
<span class="line-removed">260         MemoryHandles.filterCoordinates(intHandle, 1, S2I);</span>
261     }
262 
263     @Test(expectedExceptions = IllegalArgumentException.class)
264     public void testBadFilterCoordinatesWrongFilterException() {
<span class="line-modified">265         VarHandle intHandle = MemoryHandles.withStride(MemoryLayouts.JAVA_INT.varHandle(int.class), 4);</span>
<span class="line-removed">266         MemoryHandles.filterCoordinates(intHandle, 1, S2L_EX);</span>
267     }
268 
269     @Test(expectedExceptions = IllegalArgumentException.class)
270     public void testBadFilterCoordinatesTooManyFilters() {
<span class="line-modified">271         VarHandle intHandle = MemoryHandles.withStride(MemoryLayouts.JAVA_INT.varHandle(int.class), 4);</span>
<span class="line-removed">272         MemoryHandles.filterCoordinates(intHandle, 1, S2L, S2L);</span>
273     }
274 
275     @Test
276     public void testInsertCoordinates() throws Throwable {
277         ValueLayout layout = MemoryLayouts.JAVA_INT;
278         MemorySegment segment = MemorySegment.allocateNative(layout);
<span class="line-modified">279         VarHandle intHandle = MemoryHandles.withStride(layout.varHandle(int.class), 4);</span>
<span class="line-removed">280         VarHandle intHandle_longIndex = MemoryHandles.insertCoordinates(intHandle, 0, segment.address(), 0L);</span>
281         intHandle_longIndex.set(1);
282         int oldValue = (int)intHandle_longIndex.getAndAdd(42);
283         assertEquals(oldValue, 1);
284         int value = (int)intHandle_longIndex.get();
285         assertEquals(value, 43);
286         boolean swapped = (boolean)intHandle_longIndex.compareAndSet(43, 12);
287         assertTrue(swapped);
288         oldValue = (int)intHandle_longIndex.compareAndExchange(12, 42);
289         assertEquals(oldValue, 12);
290         value = (int)intHandle_longIndex.toMethodHandle(VarHandle.AccessMode.GET).invokeExact();
291         assertEquals(value, 42);
292     }
293 
294     @Test(expectedExceptions = NullPointerException.class)
295     public void testBadInsertCoordinatesNullTarget() {
296         MemoryHandles.insertCoordinates(null, 0, 42);
297     }
298 
299     @Test(expectedExceptions = NullPointerException.class)
300     public void testBadInsertCoordinatesNullValues() {
<span class="line-removed">301         VarHandle intHandle = MemoryLayouts.JAVA_INT.varHandle(int.class);</span>
302         MemoryHandles.insertCoordinates(intHandle, 0, null);
303     }
304 
305     @Test(expectedExceptions = IllegalArgumentException.class)
306     public void testBadInsertCoordinatesNegativePos() {
<span class="line-removed">307         VarHandle intHandle = MemoryLayouts.JAVA_INT.varHandle(int.class);</span>
308         MemoryHandles.insertCoordinates(intHandle, -1, 42);
309     }
310 
311     @Test(expectedExceptions = IllegalArgumentException.class)
312     public void testBadInsertCoordinatesPosTooBig() {
<span class="line-removed">313         VarHandle intHandle = MemoryLayouts.JAVA_INT.varHandle(int.class);</span>
314         MemoryHandles.insertCoordinates(intHandle, 1, 42);
315     }
316 
317     @Test(expectedExceptions = ClassCastException.class)
318     public void testBadInsertCoordinatesWrongCoordinateType() {
<span class="line-modified">319         VarHandle intHandle = MemoryHandles.withStride(MemoryLayouts.JAVA_INT.varHandle(int.class), 4);</span>
<span class="line-removed">320         MemoryHandles.insertCoordinates(intHandle, 1, &quot;Hello&quot;);</span>
321     }
322 
323     @Test(expectedExceptions = IllegalArgumentException.class)
324     public void testBadInsertCoordinatesTooManyValues() {
<span class="line-modified">325         VarHandle intHandle = MemoryHandles.withStride(MemoryLayouts.JAVA_INT.varHandle(int.class), 4);</span>
<span class="line-removed">326         MemoryHandles.insertCoordinates(intHandle, 1, 0L, 0L);</span>
327     }
328 
329     @Test
330     public void testPermuteCoordinates() throws Throwable {
331         ValueLayout layout = MemoryLayouts.JAVA_INT;
332         MemorySegment segment = MemorySegment.allocateNative(layout);
<span class="line-modified">333         VarHandle intHandle = MemoryHandles.withStride(layout.varHandle(int.class), 4);</span>
<span class="line-modified">334         VarHandle intHandle_swap = MemoryHandles.permuteCoordinates(intHandle,</span>
<span class="line-modified">335                 List.of(long.class, MemoryAddress.class), 1, 0);</span>
<span class="line-modified">336         intHandle_swap.set(0L, segment.address(), 1);</span>
<span class="line-removed">337         int oldValue = (int)intHandle_swap.getAndAdd(0L, segment.address(), 42);</span>
338         assertEquals(oldValue, 1);
<span class="line-modified">339         int value = (int)intHandle_swap.get(0L, segment.address());</span>
340         assertEquals(value, 43);
<span class="line-modified">341         boolean swapped = (boolean)intHandle_swap.compareAndSet(0L, segment.address(), 43, 12);</span>
342         assertTrue(swapped);
<span class="line-modified">343         oldValue = (int)intHandle_swap.compareAndExchange(0L, segment.address(), 12, 42);</span>
344         assertEquals(oldValue, 12);
<span class="line-modified">345         value = (int)intHandle_swap.toMethodHandle(VarHandle.AccessMode.GET).invokeExact(0L, segment.address());</span>
346         assertEquals(value, 42);
347     }
348 
349     @Test(expectedExceptions = NullPointerException.class)
350     public void testBadPermuteCoordinatesNullTarget() {
351         MemoryHandles.permuteCoordinates(null, List.of());
352     }
353 
354     @Test(expectedExceptions = NullPointerException.class)
355     public void testBadPermuteCoordinatesNullCoordinates() {
<span class="line-removed">356         VarHandle intHandle = MemoryLayouts.JAVA_INT.varHandle(int.class);</span>
357         MemoryHandles.permuteCoordinates(intHandle, null);
358     }
359 
360     @Test(expectedExceptions = NullPointerException.class)
361     public void testBadPermuteCoordinatesNullReorder() {
<span class="line-removed">362         VarHandle intHandle = MemoryLayouts.JAVA_INT.varHandle(int.class);</span>
363         MemoryHandles.permuteCoordinates(intHandle, List.of(int.class), null);
364     }
365 
366     @Test(expectedExceptions = IllegalArgumentException.class)
367     public void testBadPermuteCoordinatesTooManyCoordinates() {
<span class="line-removed">368         VarHandle intHandle = MemoryLayouts.JAVA_INT.varHandle(int.class);</span>
369         MemoryHandles.permuteCoordinates(intHandle, List.of(int.class, int.class), new int[2]);
370     }
371 
372     @Test(expectedExceptions = IllegalArgumentException.class)
373     public void testBadPermuteCoordinatesTooFewCoordinates() {
<span class="line-removed">374         VarHandle intHandle = MemoryLayouts.JAVA_INT.varHandle(int.class);</span>
375         MemoryHandles.permuteCoordinates(intHandle, List.of());
376     }
377 
378     @Test(expectedExceptions = IllegalArgumentException.class)
379     public void testBadPermuteCoordinatesIndexTooBig() {
<span class="line-removed">380         VarHandle intHandle = MemoryLayouts.JAVA_INT.varHandle(int.class);</span>
381         MemoryHandles.permuteCoordinates(intHandle, List.of(int.class, int.class), 3);
382     }
383 
384     @Test(expectedExceptions = IllegalArgumentException.class)
385     public void testBadPermuteCoordinatesIndexTooSmall() {
<span class="line-removed">386         VarHandle intHandle = MemoryLayouts.JAVA_INT.varHandle(int.class);</span>
387         MemoryHandles.permuteCoordinates(intHandle, List.of(int.class, int.class), -1);
388     }
389 
390     @Test
391     public void testCollectCoordinates() throws Throwable {
392         ValueLayout layout = MemoryLayouts.JAVA_INT;
393         MemorySegment segment = MemorySegment.allocateNative(layout);
<span class="line-modified">394         VarHandle intHandle = MemoryHandles.withStride(layout.varHandle(int.class), 4);</span>
<span class="line-modified">395         VarHandle intHandle_sum = MemoryHandles.collectCoordinates(intHandle, 1, SUM_OFFSETS);</span>
<span class="line-modified">396         intHandle_sum.set(segment.address(), -2L, 2L, 1);</span>
<span class="line-removed">397         int oldValue = (int)intHandle_sum.getAndAdd(segment.address(), -2L, 2L, 42);</span>
398         assertEquals(oldValue, 1);
<span class="line-modified">399         int value = (int)intHandle_sum.get(segment.address(), -2L, 2L);</span>
400         assertEquals(value, 43);
<span class="line-modified">401         boolean swapped = (boolean)intHandle_sum.compareAndSet(segment.address(), -2L, 2L, 43, 12);</span>
402         assertTrue(swapped);
<span class="line-modified">403         oldValue = (int)intHandle_sum.compareAndExchange(segment.address(), -2L, 2L, 12, 42);</span>
404         assertEquals(oldValue, 12);
<span class="line-modified">405         value = (int)intHandle_sum.toMethodHandle(VarHandle.AccessMode.GET).invokeExact(segment.address(), -2L, 2L);</span>
406         assertEquals(value, 42);
407     }
408 
409     @Test(expectedExceptions = NullPointerException.class)
410     public void testBadCollectCoordinatesNullTarget() {
411         MemoryHandles.collectCoordinates(null, 0, SUM_OFFSETS);
412     }
413 
414     @Test(expectedExceptions = NullPointerException.class)
415     public void testBadCollectCoordinatesNullFilters() {
<span class="line-removed">416         VarHandle intHandle = MemoryLayouts.JAVA_INT.varHandle(int.class);</span>
417         MemoryHandles.collectCoordinates(intHandle, 0, null);
418     }
419 
420     @Test(expectedExceptions = IllegalArgumentException.class)
421     public void testBadCollectCoordinatesNegativePos() {
<span class="line-removed">422         VarHandle intHandle = MemoryLayouts.JAVA_INT.varHandle(int.class);</span>
423         MemoryHandles.collectCoordinates(intHandle, -1, SUM_OFFSETS);
424     }
425 
426     @Test(expectedExceptions = IllegalArgumentException.class)
427     public void testBadCollectCoordinatesPosTooBig() {
<span class="line-removed">428         VarHandle intHandle = MemoryLayouts.JAVA_INT.varHandle(int.class);</span>
429         MemoryHandles.collectCoordinates(intHandle, 1, SUM_OFFSETS);
430     }
431 
432     @Test(expectedExceptions = IllegalArgumentException.class)
433     public void testBadCollectCoordinatesWrongFilterType() {
<span class="line-removed">434         VarHandle intHandle = MemoryLayouts.JAVA_INT.varHandle(int.class);</span>
435         MemoryHandles.collectCoordinates(intHandle, 0, SUM_OFFSETS);
436     }
437 
438     @Test(expectedExceptions = IllegalArgumentException.class)
439     public void testBadCollectCoordinatesWrongVoidFilterType() {
<span class="line-removed">440         VarHandle intHandle = MemoryLayouts.JAVA_INT.varHandle(int.class);</span>
441         MemoryHandles.collectCoordinates(intHandle, 0, VOID_FILTER);
442     }
443 
444     @Test(expectedExceptions = IllegalArgumentException.class)
445     public void testBadCollectCoordinatesWrongFilterException() {
<span class="line-removed">446         VarHandle intHandle = MemoryLayouts.JAVA_INT.varHandle(int.class);</span>
447         MemoryHandles.collectCoordinates(intHandle, 0, S2L_EX);
448     }
449 
450     @Test
451     public void testDropCoordinates() throws Throwable {
452         ValueLayout layout = MemoryLayouts.JAVA_INT;
453         MemorySegment segment = MemorySegment.allocateNative(layout);
<span class="line-modified">454         VarHandle intHandle = MemoryHandles.withStride(layout.varHandle(int.class), 4);</span>
<span class="line-modified">455         VarHandle intHandle_dummy = MemoryHandles.dropCoordinates(intHandle, 1, float.class, String.class);</span>
<span class="line-modified">456         intHandle_dummy.set(segment.address(), 1f, &quot;hello&quot;, 0L, 1);</span>
<span class="line-removed">457         int oldValue = (int)intHandle_dummy.getAndAdd(segment.address(), 1f, &quot;hello&quot;, 0L, 42);</span>
458         assertEquals(oldValue, 1);
<span class="line-modified">459         int value = (int)intHandle_dummy.get(segment.address(), 1f, &quot;hello&quot;, 0L);</span>
460         assertEquals(value, 43);
<span class="line-modified">461         boolean swapped = (boolean)intHandle_dummy.compareAndSet(segment.address(), 1f, &quot;hello&quot;, 0L, 43, 12);</span>
462         assertTrue(swapped);
<span class="line-modified">463         oldValue = (int)intHandle_dummy.compareAndExchange(segment.address(), 1f, &quot;hello&quot;, 0L, 12, 42);</span>
464         assertEquals(oldValue, 12);
<span class="line-modified">465         value = (int)intHandle_dummy.toMethodHandle(VarHandle.AccessMode.GET).invokeExact(segment.address(), 1f, &quot;hello&quot;, 0L);</span>
466         assertEquals(value, 42);
467     }
468 
469     @Test(expectedExceptions = IllegalArgumentException.class)
470     public void testBadDropCoordinatesNegativePos() {
<span class="line-removed">471         VarHandle intHandle = MemoryLayouts.JAVA_INT.varHandle(int.class);</span>
472         MemoryHandles.dropCoordinates(intHandle, -1);
473     }
474 
475     @Test(expectedExceptions = IllegalArgumentException.class)
476     public void testBadDropCoordinatesPosTooBig() {
<span class="line-removed">477         VarHandle intHandle = MemoryLayouts.JAVA_INT.varHandle(int.class);</span>
478         MemoryHandles.dropCoordinates(intHandle, 2);
479     }
480 
481     @Test(expectedExceptions = NullPointerException.class)
482     public void testBadDropCoordinatesNullValueTypes() {
<span class="line-removed">483         VarHandle intHandle = MemoryLayouts.JAVA_INT.varHandle(int.class);</span>
484         MemoryHandles.dropCoordinates(intHandle, 1, null);
485     }
486 
487     @Test(expectedExceptions = NullPointerException.class)
488     public void testBadDropCoordinatesNullTarget() {
489         MemoryHandles.dropCoordinates(null, 1);
490     }
491 
492     //helper methods
493 
494     static int stringToInt(String s) {
495         return Integer.valueOf(s);
496     }
497 
498     static String intToString(int i) {
499         return String.valueOf(i);
500     }
501 
502     static long stringToLong(String s) {
503         return Long.valueOf(s);
504     }
505 
506     static long stringToLongException(String s) throws Throwable {
507         return Long.valueOf(s);
508     }
509 
<span class="line-modified">510     static MemoryAddress baseAddress(MemorySegment segment) {</span>
<span class="line-modified">511         return segment.address();</span>
512     }
513 
514     static long sumOffsets(long l1, long l2) {
515         return l1 + l2;
516     }
517 
518     static void void_filter(String s) { }
519 
520     static String ctxIntToString(String a, String b, int i) {
521         return a + b + String.valueOf(i);
522     }
523 }
</pre>
</td>
<td>
<hr />
<pre>
 16  *  2 along with this work; if not, write to the Free Software Foundation,
 17  *  Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  *   Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  *  or visit www.oracle.com if you need additional information or have any
 21  *  questions.
 22  *
 23  */
 24 
 25 /*
 26  * @test
 27  * @modules jdk.incubator.foreign
 28  * @run testng/othervm -Djava.lang.invoke.VarHandle.VAR_HANDLE_GUARDS=true -Djava.lang.invoke.VarHandle.VAR_HANDLE_IDENTITY_ADAPT=false -Xverify:all TestAdaptVarHandles
 29  * @run testng/othervm -Djava.lang.invoke.VarHandle.VAR_HANDLE_GUARDS=true -Djava.lang.invoke.VarHandle.VAR_HANDLE_IDENTITY_ADAPT=true -Xverify:all TestAdaptVarHandles
 30  * @run testng/othervm -Djava.lang.invoke.VarHandle.VAR_HANDLE_GUARDS=false -Djava.lang.invoke.VarHandle.VAR_HANDLE_IDENTITY_ADAPT=false -Xverify:all TestAdaptVarHandles
 31  * @run testng/othervm -Djava.lang.invoke.VarHandle.VAR_HANDLE_GUARDS=false -Djava.lang.invoke.VarHandle.VAR_HANDLE_IDENTITY_ADAPT=true -Xverify:all TestAdaptVarHandles
 32  */
 33 
 34 import jdk.incubator.foreign.MemoryAddress;
 35 import jdk.incubator.foreign.MemoryHandles;
<span class="line-added"> 36 import jdk.incubator.foreign.MemoryLayout;</span>
 37 import jdk.incubator.foreign.MemoryLayouts;
 38 import jdk.incubator.foreign.MemorySegment;
 39 import jdk.incubator.foreign.ValueLayout;
 40 import org.testng.annotations.*;
 41 import static org.testng.Assert.*;
 42 
 43 import java.lang.invoke.MethodHandle;
 44 import java.lang.invoke.MethodHandles;
 45 import java.lang.invoke.MethodType;
 46 import java.lang.invoke.VarHandle;
 47 import java.util.List;
 48 
 49 public class TestAdaptVarHandles {
 50 
 51     static MethodHandle S2I;
 52     static MethodHandle I2S;
 53     static MethodHandle CTX_I2S;
 54     static MethodHandle O2I;
 55     static MethodHandle I2O;
 56     static MethodHandle S2L;
 57     static MethodHandle S2L_EX;
 58     static MethodHandle S2I_EX;
 59     static MethodHandle I2S_EX;
 60     static MethodHandle BASE_ADDR;
 61     static MethodHandle SUM_OFFSETS;
 62     static MethodHandle VOID_FILTER;
 63 
 64     static {
 65         try {
 66             S2I = MethodHandles.lookup().findStatic(TestAdaptVarHandles.class, &quot;stringToInt&quot;, MethodType.methodType(int.class, String.class));
 67             I2S = MethodHandles.lookup().findStatic(TestAdaptVarHandles.class, &quot;intToString&quot;, MethodType.methodType(String.class, int.class));
 68             CTX_I2S = MethodHandles.lookup().findStatic(TestAdaptVarHandles.class, &quot;ctxIntToString&quot;,
 69                     MethodType.methodType(String.class, String.class, String.class, int.class));
 70             O2I = MethodHandles.explicitCastArguments(S2I, MethodType.methodType(int.class, Object.class));
 71             I2O = MethodHandles.explicitCastArguments(I2S, MethodType.methodType(Object.class, int.class));
 72             S2L = MethodHandles.lookup().findStatic(TestAdaptVarHandles.class, &quot;stringToLong&quot;, MethodType.methodType(long.class, String.class));
 73             S2L_EX = MethodHandles.lookup().findStatic(TestAdaptVarHandles.class, &quot;stringToLongException&quot;, MethodType.methodType(long.class, String.class));
<span class="line-modified"> 74             BASE_ADDR = MethodHandles.lookup().findStatic(TestAdaptVarHandles.class, &quot;baseAddress&quot;, MethodType.methodType(MemorySegment.class, MemorySegment.class));</span>
 75             SUM_OFFSETS = MethodHandles.lookup().findStatic(TestAdaptVarHandles.class, &quot;sumOffsets&quot;, MethodType.methodType(long.class, long.class, long.class));
 76             VOID_FILTER = MethodHandles.lookup().findStatic(TestAdaptVarHandles.class, &quot;void_filter&quot;, MethodType.methodType(void.class, String.class));
 77 
 78             MethodHandle s2i_ex = MethodHandles.throwException(int.class, Throwable.class);
 79             s2i_ex = MethodHandles.insertArguments(s2i_ex, 0, new Throwable());
 80             S2I_EX = MethodHandles.dropArguments(s2i_ex, 0, String.class);
 81 
 82             MethodHandle i2s_ex = MethodHandles.throwException(String.class, Throwable.class);
 83             i2s_ex = MethodHandles.insertArguments(i2s_ex, 0, new Throwable());
 84             I2S_EX = MethodHandles.dropArguments(i2s_ex, 0, int.class);
 85         } catch (Throwable ex) {
 86             throw new ExceptionInInitializerError();
 87         }
 88     }
 89 
<span class="line-added"> 90     static final VarHandle intHandleIndexed = MemoryLayout.ofSequence(MemoryLayouts.JAVA_INT)</span>
<span class="line-added"> 91             .varHandle(int.class, MemoryLayout.PathElement.sequenceElement());</span>
<span class="line-added"> 92 </span>
<span class="line-added"> 93     static final VarHandle intHandle = MemoryLayouts.JAVA_INT.varHandle(int.class);</span>
<span class="line-added"> 94 </span>
<span class="line-added"> 95     static final VarHandle floatHandle = MemoryLayouts.JAVA_FLOAT.varHandle(float.class);</span>
<span class="line-added"> 96 </span>
 97     @Test
 98     public void testFilterValue() throws Throwable {
 99         ValueLayout layout = MemoryLayouts.JAVA_INT;
100         MemorySegment segment = MemorySegment.allocateNative(layout);
101         VarHandle intHandle = layout.varHandle(int.class);
102         VarHandle i2SHandle = MemoryHandles.filterValue(intHandle, S2I, I2S);
<span class="line-modified">103         i2SHandle.set(segment, &quot;1&quot;);</span>
<span class="line-modified">104         String oldValue = (String)i2SHandle.getAndAdd(segment, &quot;42&quot;);</span>
105         assertEquals(oldValue, &quot;1&quot;);
<span class="line-modified">106         String value = (String)i2SHandle.get(segment);</span>
107         assertEquals(value, &quot;43&quot;);
<span class="line-modified">108         boolean swapped = (boolean)i2SHandle.compareAndSet(segment, &quot;43&quot;, &quot;12&quot;);</span>
109         assertTrue(swapped);
<span class="line-modified">110         oldValue = (String)i2SHandle.compareAndExchange(segment, &quot;12&quot;, &quot;42&quot;);</span>
111         assertEquals(oldValue, &quot;12&quot;);
<span class="line-modified">112         value = (String)i2SHandle.toMethodHandle(VarHandle.AccessMode.GET).invokeExact(segment);</span>
113         assertEquals(value, &quot;42&quot;);
114     }
115 
116     @Test
117     public void testFilterValueComposite() throws Throwable {
118         ValueLayout layout = MemoryLayouts.JAVA_INT;
119         MemorySegment segment = MemorySegment.allocateNative(layout);
120         VarHandle intHandle = layout.varHandle(int.class);
121         MethodHandle CTX_S2I = MethodHandles.dropArguments(S2I, 0, String.class, String.class);
122         VarHandle i2SHandle = MemoryHandles.filterValue(intHandle, CTX_S2I, CTX_I2S);
123         i2SHandle = MemoryHandles.insertCoordinates(i2SHandle, 1, &quot;a&quot;, &quot;b&quot;);
<span class="line-modified">124         i2SHandle.set(segment, &quot;1&quot;);</span>
<span class="line-modified">125         String oldValue = (String)i2SHandle.getAndAdd(segment, &quot;42&quot;);</span>
126         assertEquals(oldValue, &quot;ab1&quot;);
<span class="line-modified">127         String value = (String)i2SHandle.get(segment);</span>
128         assertEquals(value, &quot;ab43&quot;);
<span class="line-modified">129         boolean swapped = (boolean)i2SHandle.compareAndSet(segment, &quot;43&quot;, &quot;12&quot;);</span>
130         assertTrue(swapped);
<span class="line-modified">131         oldValue = (String)i2SHandle.compareAndExchange(segment, &quot;12&quot;, &quot;42&quot;);</span>
132         assertEquals(oldValue, &quot;ab12&quot;);
<span class="line-modified">133         value = (String)i2SHandle.toMethodHandle(VarHandle.AccessMode.GET).invokeExact(segment);</span>
134         assertEquals(value, &quot;ab42&quot;);
135     }
136 
137     @Test
138     public void testFilterValueLoose() throws Throwable {
139         ValueLayout layout = MemoryLayouts.JAVA_INT;
140         MemorySegment segment = MemorySegment.allocateNative(layout);
141         VarHandle intHandle = layout.varHandle(int.class);
142         VarHandle i2SHandle = MemoryHandles.filterValue(intHandle, O2I, I2O);
<span class="line-modified">143         i2SHandle.set(segment, &quot;1&quot;);</span>
<span class="line-modified">144         String oldValue = (String)i2SHandle.getAndAdd(segment, &quot;42&quot;);</span>
145         assertEquals(oldValue, &quot;1&quot;);
<span class="line-modified">146         String value = (String)i2SHandle.get(segment);</span>
147         assertEquals(value, &quot;43&quot;);
<span class="line-modified">148         boolean swapped = (boolean)i2SHandle.compareAndSet(segment, &quot;43&quot;, &quot;12&quot;);</span>
149         assertTrue(swapped);
<span class="line-modified">150         oldValue = (String)i2SHandle.compareAndExchange(segment, &quot;12&quot;, &quot;42&quot;);</span>
151         assertEquals(oldValue, &quot;12&quot;);
<span class="line-modified">152         value = (String)(Object)i2SHandle.toMethodHandle(VarHandle.AccessMode.GET).invokeExact(segment);</span>
153         assertEquals(value, &quot;42&quot;);
154     }
155 
156     @Test(expectedExceptions = NullPointerException.class)
157     public void testBadFilterNullTarget() {
158         MemoryHandles.filterValue(null, S2I, I2S);
159     }
160 
161     @Test(expectedExceptions = NullPointerException.class)
162     public void testBadFilterNullUnbox() {

163         MemoryHandles.filterValue(intHandle, null, I2S);
164     }
165 
166     @Test(expectedExceptions = NullPointerException.class)
167     public void testBadFilterNullBox() {

168         MemoryHandles.filterValue(intHandle, S2I, null);
169     }
170 
171     @Test(expectedExceptions = IllegalArgumentException.class)
172     public void testBadFilterCarrier() {

173         MemoryHandles.filterValue(floatHandle, S2I, I2S);
174     }
175 
176     @Test(expectedExceptions = IllegalArgumentException.class)
177     public void testBadFilterUnboxArity() {
178         VarHandle floatHandle = MemoryLayouts.JAVA_INT.varHandle(int.class);
179         MemoryHandles.filterValue(floatHandle, S2I.bindTo(&quot;&quot;), I2S);
180     }
181 
182     @Test(expectedExceptions = IllegalArgumentException.class)
183     public void testBadFilterBoxArity() {
184         VarHandle intHandle = MemoryLayouts.JAVA_INT.varHandle(int.class);
185         MemoryHandles.filterValue(intHandle, S2I, I2S.bindTo(42));
186     }
187 
188     @Test(expectedExceptions = IllegalArgumentException.class)
189     public void testBadFilterBoxPrefixCoordinates() {
190         VarHandle intHandle = MemoryLayouts.JAVA_INT.varHandle(int.class);
191         MemoryHandles.filterValue(intHandle,
192                 MethodHandles.dropArguments(S2I, 1, int.class),
</pre>
<hr />
<pre>
204         VarHandle intHandle = MemoryLayouts.JAVA_INT.varHandle(int.class);
205         MemoryHandles.filterValue(intHandle, S2L_EX, I2S);
206     }
207 
208     @Test(expectedExceptions = IllegalArgumentException.class)
209     public void testBadFilterBoxHandleException() {
210         VarHandle intHandle = MemoryLayouts.JAVA_INT.varHandle(int.class);
211         MemoryHandles.filterValue(intHandle, S2I, I2S_EX);
212     }
213 
214     @Test(expectedExceptions = IllegalArgumentException.class)
215     public void testBadFilterUnboxHandleException() {
216         VarHandle intHandle = MemoryLayouts.JAVA_INT.varHandle(int.class);
217         MemoryHandles.filterValue(intHandle, S2I_EX, I2S);
218     }
219 
220     @Test
221     public void testFilterCoordinates() throws Throwable {
222         ValueLayout layout = MemoryLayouts.JAVA_INT;
223         MemorySegment segment = MemorySegment.allocateNative(layout);
<span class="line-modified">224         VarHandle intHandle_longIndex = MemoryHandles.filterCoordinates(intHandleIndexed, 0, BASE_ADDR, S2L);</span>

225         intHandle_longIndex.set(segment, &quot;0&quot;, 1);
226         int oldValue = (int)intHandle_longIndex.getAndAdd(segment, &quot;0&quot;, 42);
227         assertEquals(oldValue, 1);
228         int value = (int)intHandle_longIndex.get(segment, &quot;0&quot;);
229         assertEquals(value, 43);
230         boolean swapped = (boolean)intHandle_longIndex.compareAndSet(segment, &quot;0&quot;, 43, 12);
231         assertTrue(swapped);
232         oldValue = (int)intHandle_longIndex.compareAndExchange(segment, &quot;0&quot;, 12, 42);
233         assertEquals(oldValue, 12);
234         value = (int)intHandle_longIndex.toMethodHandle(VarHandle.AccessMode.GET).invokeExact(segment, &quot;0&quot;);
235         assertEquals(value, 42);
236     }
237 
238     @Test(expectedExceptions = NullPointerException.class)
239     public void testBadFilterCoordinatesNullTarget() {
240         MemoryHandles.filterCoordinates(null, 0, S2I);
241     }
242 
243     @Test(expectedExceptions = NullPointerException.class)
244     public void testBadFilterCoordinatesNullFilters() {

245         MemoryHandles.filterCoordinates(intHandle, 0, null);
246     }
247 
248     @Test(expectedExceptions = IllegalArgumentException.class)
249     public void testBadFilterCoordinatesNegativePos() {

250         MemoryHandles.filterCoordinates(intHandle, -1, SUM_OFFSETS);
251     }
252 
253     @Test(expectedExceptions = IllegalArgumentException.class)
254     public void testBadFilterCoordinatesPosTooBig() {

255         MemoryHandles.filterCoordinates(intHandle, 1, SUM_OFFSETS);
256     }
257 
258     @Test(expectedExceptions = IllegalArgumentException.class)
259     public void testBadFilterCoordinatesWrongFilterType() {
<span class="line-modified">260         MemoryHandles.filterCoordinates(intHandleIndexed, 1, S2I);</span>

261     }
262 
263     @Test(expectedExceptions = IllegalArgumentException.class)
264     public void testBadFilterCoordinatesWrongFilterException() {
<span class="line-modified">265         MemoryHandles.filterCoordinates(intHandleIndexed, 1, S2L_EX);</span>

266     }
267 
268     @Test(expectedExceptions = IllegalArgumentException.class)
269     public void testBadFilterCoordinatesTooManyFilters() {
<span class="line-modified">270         MemoryHandles.filterCoordinates(intHandleIndexed, 1, S2L, S2L);</span>

271     }
272 
273     @Test
274     public void testInsertCoordinates() throws Throwable {
275         ValueLayout layout = MemoryLayouts.JAVA_INT;
276         MemorySegment segment = MemorySegment.allocateNative(layout);
<span class="line-modified">277         VarHandle intHandle_longIndex = MemoryHandles.insertCoordinates(intHandleIndexed, 0, segment, 0L);</span>

278         intHandle_longIndex.set(1);
279         int oldValue = (int)intHandle_longIndex.getAndAdd(42);
280         assertEquals(oldValue, 1);
281         int value = (int)intHandle_longIndex.get();
282         assertEquals(value, 43);
283         boolean swapped = (boolean)intHandle_longIndex.compareAndSet(43, 12);
284         assertTrue(swapped);
285         oldValue = (int)intHandle_longIndex.compareAndExchange(12, 42);
286         assertEquals(oldValue, 12);
287         value = (int)intHandle_longIndex.toMethodHandle(VarHandle.AccessMode.GET).invokeExact();
288         assertEquals(value, 42);
289     }
290 
291     @Test(expectedExceptions = NullPointerException.class)
292     public void testBadInsertCoordinatesNullTarget() {
293         MemoryHandles.insertCoordinates(null, 0, 42);
294     }
295 
296     @Test(expectedExceptions = NullPointerException.class)
297     public void testBadInsertCoordinatesNullValues() {

298         MemoryHandles.insertCoordinates(intHandle, 0, null);
299     }
300 
301     @Test(expectedExceptions = IllegalArgumentException.class)
302     public void testBadInsertCoordinatesNegativePos() {

303         MemoryHandles.insertCoordinates(intHandle, -1, 42);
304     }
305 
306     @Test(expectedExceptions = IllegalArgumentException.class)
307     public void testBadInsertCoordinatesPosTooBig() {

308         MemoryHandles.insertCoordinates(intHandle, 1, 42);
309     }
310 
311     @Test(expectedExceptions = ClassCastException.class)
312     public void testBadInsertCoordinatesWrongCoordinateType() {
<span class="line-modified">313         MemoryHandles.insertCoordinates(intHandleIndexed, 1, &quot;Hello&quot;);</span>

314     }
315 
316     @Test(expectedExceptions = IllegalArgumentException.class)
317     public void testBadInsertCoordinatesTooManyValues() {
<span class="line-modified">318         MemoryHandles.insertCoordinates(intHandleIndexed, 1, 0L, 0L);</span>

319     }
320 
321     @Test
322     public void testPermuteCoordinates() throws Throwable {
323         ValueLayout layout = MemoryLayouts.JAVA_INT;
324         MemorySegment segment = MemorySegment.allocateNative(layout);
<span class="line-modified">325         VarHandle intHandle_swap = MemoryHandles.permuteCoordinates(intHandleIndexed,</span>
<span class="line-modified">326                 List.of(long.class, MemorySegment.class), 1, 0);</span>
<span class="line-modified">327         intHandle_swap.set(0L, segment, 1);</span>
<span class="line-modified">328         int oldValue = (int)intHandle_swap.getAndAdd(0L, segment, 42);</span>

329         assertEquals(oldValue, 1);
<span class="line-modified">330         int value = (int)intHandle_swap.get(0L, segment);</span>
331         assertEquals(value, 43);
<span class="line-modified">332         boolean swapped = (boolean)intHandle_swap.compareAndSet(0L, segment, 43, 12);</span>
333         assertTrue(swapped);
<span class="line-modified">334         oldValue = (int)intHandle_swap.compareAndExchange(0L, segment, 12, 42);</span>
335         assertEquals(oldValue, 12);
<span class="line-modified">336         value = (int)intHandle_swap.toMethodHandle(VarHandle.AccessMode.GET).invokeExact(0L, segment);</span>
337         assertEquals(value, 42);
338     }
339 
340     @Test(expectedExceptions = NullPointerException.class)
341     public void testBadPermuteCoordinatesNullTarget() {
342         MemoryHandles.permuteCoordinates(null, List.of());
343     }
344 
345     @Test(expectedExceptions = NullPointerException.class)
346     public void testBadPermuteCoordinatesNullCoordinates() {

347         MemoryHandles.permuteCoordinates(intHandle, null);
348     }
349 
350     @Test(expectedExceptions = NullPointerException.class)
351     public void testBadPermuteCoordinatesNullReorder() {

352         MemoryHandles.permuteCoordinates(intHandle, List.of(int.class), null);
353     }
354 
355     @Test(expectedExceptions = IllegalArgumentException.class)
356     public void testBadPermuteCoordinatesTooManyCoordinates() {

357         MemoryHandles.permuteCoordinates(intHandle, List.of(int.class, int.class), new int[2]);
358     }
359 
360     @Test(expectedExceptions = IllegalArgumentException.class)
361     public void testBadPermuteCoordinatesTooFewCoordinates() {

362         MemoryHandles.permuteCoordinates(intHandle, List.of());
363     }
364 
365     @Test(expectedExceptions = IllegalArgumentException.class)
366     public void testBadPermuteCoordinatesIndexTooBig() {

367         MemoryHandles.permuteCoordinates(intHandle, List.of(int.class, int.class), 3);
368     }
369 
370     @Test(expectedExceptions = IllegalArgumentException.class)
371     public void testBadPermuteCoordinatesIndexTooSmall() {

372         MemoryHandles.permuteCoordinates(intHandle, List.of(int.class, int.class), -1);
373     }
374 
375     @Test
376     public void testCollectCoordinates() throws Throwable {
377         ValueLayout layout = MemoryLayouts.JAVA_INT;
378         MemorySegment segment = MemorySegment.allocateNative(layout);
<span class="line-modified">379         VarHandle intHandle_sum = MemoryHandles.collectCoordinates(intHandleIndexed, 1, SUM_OFFSETS);</span>
<span class="line-modified">380         intHandle_sum.set(segment, -2L, 2L, 1);</span>
<span class="line-modified">381         int oldValue = (int)intHandle_sum.getAndAdd(segment, -2L, 2L, 42);</span>

382         assertEquals(oldValue, 1);
<span class="line-modified">383         int value = (int)intHandle_sum.get(segment, -2L, 2L);</span>
384         assertEquals(value, 43);
<span class="line-modified">385         boolean swapped = (boolean)intHandle_sum.compareAndSet(segment, -2L, 2L, 43, 12);</span>
386         assertTrue(swapped);
<span class="line-modified">387         oldValue = (int)intHandle_sum.compareAndExchange(segment, -2L, 2L, 12, 42);</span>
388         assertEquals(oldValue, 12);
<span class="line-modified">389         value = (int)intHandle_sum.toMethodHandle(VarHandle.AccessMode.GET).invokeExact(segment, -2L, 2L);</span>
390         assertEquals(value, 42);
391     }
392 
393     @Test(expectedExceptions = NullPointerException.class)
394     public void testBadCollectCoordinatesNullTarget() {
395         MemoryHandles.collectCoordinates(null, 0, SUM_OFFSETS);
396     }
397 
398     @Test(expectedExceptions = NullPointerException.class)
399     public void testBadCollectCoordinatesNullFilters() {

400         MemoryHandles.collectCoordinates(intHandle, 0, null);
401     }
402 
403     @Test(expectedExceptions = IllegalArgumentException.class)
404     public void testBadCollectCoordinatesNegativePos() {

405         MemoryHandles.collectCoordinates(intHandle, -1, SUM_OFFSETS);
406     }
407 
408     @Test(expectedExceptions = IllegalArgumentException.class)
409     public void testBadCollectCoordinatesPosTooBig() {

410         MemoryHandles.collectCoordinates(intHandle, 1, SUM_OFFSETS);
411     }
412 
413     @Test(expectedExceptions = IllegalArgumentException.class)
414     public void testBadCollectCoordinatesWrongFilterType() {

415         MemoryHandles.collectCoordinates(intHandle, 0, SUM_OFFSETS);
416     }
417 
418     @Test(expectedExceptions = IllegalArgumentException.class)
419     public void testBadCollectCoordinatesWrongVoidFilterType() {

420         MemoryHandles.collectCoordinates(intHandle, 0, VOID_FILTER);
421     }
422 
423     @Test(expectedExceptions = IllegalArgumentException.class)
424     public void testBadCollectCoordinatesWrongFilterException() {

425         MemoryHandles.collectCoordinates(intHandle, 0, S2L_EX);
426     }
427 
428     @Test
429     public void testDropCoordinates() throws Throwable {
430         ValueLayout layout = MemoryLayouts.JAVA_INT;
431         MemorySegment segment = MemorySegment.allocateNative(layout);
<span class="line-modified">432         VarHandle intHandle_dummy = MemoryHandles.dropCoordinates(intHandleIndexed, 1, float.class, String.class);</span>
<span class="line-modified">433         intHandle_dummy.set(segment, 1f, &quot;hello&quot;, 0L, 1);</span>
<span class="line-modified">434         int oldValue = (int)intHandle_dummy.getAndAdd(segment, 1f, &quot;hello&quot;, 0L, 42);</span>

435         assertEquals(oldValue, 1);
<span class="line-modified">436         int value = (int)intHandle_dummy.get(segment, 1f, &quot;hello&quot;, 0L);</span>
437         assertEquals(value, 43);
<span class="line-modified">438         boolean swapped = (boolean)intHandle_dummy.compareAndSet(segment, 1f, &quot;hello&quot;, 0L, 43, 12);</span>
439         assertTrue(swapped);
<span class="line-modified">440         oldValue = (int)intHandle_dummy.compareAndExchange(segment, 1f, &quot;hello&quot;, 0L, 12, 42);</span>
441         assertEquals(oldValue, 12);
<span class="line-modified">442         value = (int)intHandle_dummy.toMethodHandle(VarHandle.AccessMode.GET).invokeExact(segment, 1f, &quot;hello&quot;, 0L);</span>
443         assertEquals(value, 42);
444     }
445 
446     @Test(expectedExceptions = IllegalArgumentException.class)
447     public void testBadDropCoordinatesNegativePos() {

448         MemoryHandles.dropCoordinates(intHandle, -1);
449     }
450 
451     @Test(expectedExceptions = IllegalArgumentException.class)
452     public void testBadDropCoordinatesPosTooBig() {

453         MemoryHandles.dropCoordinates(intHandle, 2);
454     }
455 
456     @Test(expectedExceptions = NullPointerException.class)
457     public void testBadDropCoordinatesNullValueTypes() {

458         MemoryHandles.dropCoordinates(intHandle, 1, null);
459     }
460 
461     @Test(expectedExceptions = NullPointerException.class)
462     public void testBadDropCoordinatesNullTarget() {
463         MemoryHandles.dropCoordinates(null, 1);
464     }
465 
466     //helper methods
467 
468     static int stringToInt(String s) {
469         return Integer.valueOf(s);
470     }
471 
472     static String intToString(int i) {
473         return String.valueOf(i);
474     }
475 
476     static long stringToLong(String s) {
477         return Long.valueOf(s);
478     }
479 
480     static long stringToLongException(String s) throws Throwable {
481         return Long.valueOf(s);
482     }
483 
<span class="line-modified">484     static MemorySegment baseAddress(MemorySegment segment) {</span>
<span class="line-modified">485         return segment;</span>
486     }
487 
488     static long sumOffsets(long l1, long l2) {
489         return l1 + l2;
490     }
491 
492     static void void_filter(String s) { }
493 
494     static String ctxIntToString(String a, String b, int i) {
495         return a + b + String.valueOf(i);
496     }
497 }
</pre>
</td>
</tr>
</table>
<center><a href="../../../../src/jdk.incubator.foreign/share/classes/jdk/internal/foreign/Utils.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="TestAddressHandle.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>