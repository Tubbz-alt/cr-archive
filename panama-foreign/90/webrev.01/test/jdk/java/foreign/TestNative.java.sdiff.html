<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff test/jdk/java/foreign/TestNative.java</title>
    <link rel="stylesheet" href="../../../../style.css" />
  </head>
<body>
<center><a href="TestAddressHandle.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="TestSegments.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>test/jdk/java/foreign/TestNative.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 95     static VarHandle byteHandle = bytes.varHandle(byte.class, PathElement.sequenceElement());
 96     static VarHandle charHandle = chars.varHandle(char.class, PathElement.sequenceElement());
 97     static VarHandle shortHandle = shorts.varHandle(short.class, PathElement.sequenceElement());
 98     static VarHandle intHandle = ints.varHandle(int.class, PathElement.sequenceElement());
 99     static VarHandle floatHandle = floats.varHandle(float.class, PathElement.sequenceElement());
100     static VarHandle longHandle = doubles.varHandle(long.class, PathElement.sequenceElement());
101     static VarHandle doubleHandle = longs.varHandle(double.class, PathElement.sequenceElement());
102 
103     static void initBytes(MemoryAddress base, SequenceLayout seq, BiConsumer&lt;MemoryAddress, Long&gt; handleSetter) {
104         for (long i = 0; i &lt; seq.elementCount().getAsLong() ; i++) {
105             handleSetter.accept(base, i);
106         }
107     }
108 
109     static &lt;Z extends Buffer&gt; void checkBytes(MemoryAddress base, SequenceLayout layout,
110                                               BiFunction&lt;MemoryAddress, Long, Object&gt; handleExtractor,
111                                               Function&lt;ByteBuffer, Z&gt; bufferFactory,
112                                               BiFunction&lt;Z, Integer, Object&gt; nativeBufferExtractor,
113                                               BiFunction&lt;Long, Integer, Object&gt; nativeRawExtractor) {
114         long nelems = layout.elementCount().getAsLong();
<span class="line-modified">115         ByteBuffer bb = base.segment().asSlice(base.offset(), (int)layout.byteSize()).asByteBuffer();</span>
116         Z z = bufferFactory.apply(bb);
117         for (long i = 0 ; i &lt; nelems ; i++) {
118             Object handleValue = handleExtractor.apply(base, i);
119             Object bufferValue = nativeBufferExtractor.apply(z, (int)i);
120             Object rawValue = nativeRawExtractor.apply(base.toRawLongValue(), (int)i);
121             if (handleValue instanceof Number) {
122                 assertEquals(((Number)handleValue).longValue(), i);
123                 assertEquals(((Number)bufferValue).longValue(), i);
124                 assertEquals(((Number)rawValue).longValue(), i);
125             } else {
126                 assertEquals((long)(char)handleValue, i);
127                 assertEquals((long)(char)bufferValue, i);
128                 assertEquals((long)(char)rawValue, i);
129             }
130         }
131     }
132 
133     public static native byte getByteBuffer(ByteBuffer buf, int index);
134     public static native char getCharBuffer(CharBuffer buf, int index);
135     public static native short getShortBuffer(ShortBuffer buf, int index);
</pre>
</td>
<td>
<hr />
<pre>
 95     static VarHandle byteHandle = bytes.varHandle(byte.class, PathElement.sequenceElement());
 96     static VarHandle charHandle = chars.varHandle(char.class, PathElement.sequenceElement());
 97     static VarHandle shortHandle = shorts.varHandle(short.class, PathElement.sequenceElement());
 98     static VarHandle intHandle = ints.varHandle(int.class, PathElement.sequenceElement());
 99     static VarHandle floatHandle = floats.varHandle(float.class, PathElement.sequenceElement());
100     static VarHandle longHandle = doubles.varHandle(long.class, PathElement.sequenceElement());
101     static VarHandle doubleHandle = longs.varHandle(double.class, PathElement.sequenceElement());
102 
103     static void initBytes(MemoryAddress base, SequenceLayout seq, BiConsumer&lt;MemoryAddress, Long&gt; handleSetter) {
104         for (long i = 0; i &lt; seq.elementCount().getAsLong() ; i++) {
105             handleSetter.accept(base, i);
106         }
107     }
108 
109     static &lt;Z extends Buffer&gt; void checkBytes(MemoryAddress base, SequenceLayout layout,
110                                               BiFunction&lt;MemoryAddress, Long, Object&gt; handleExtractor,
111                                               Function&lt;ByteBuffer, Z&gt; bufferFactory,
112                                               BiFunction&lt;Z, Integer, Object&gt; nativeBufferExtractor,
113                                               BiFunction&lt;Long, Integer, Object&gt; nativeRawExtractor) {
114         long nelems = layout.elementCount().getAsLong();
<span class="line-modified">115         ByteBuffer bb = base.segment().asSlice(base.segmentOffset(), (int)layout.byteSize()).asByteBuffer();</span>
116         Z z = bufferFactory.apply(bb);
117         for (long i = 0 ; i &lt; nelems ; i++) {
118             Object handleValue = handleExtractor.apply(base, i);
119             Object bufferValue = nativeBufferExtractor.apply(z, (int)i);
120             Object rawValue = nativeRawExtractor.apply(base.toRawLongValue(), (int)i);
121             if (handleValue instanceof Number) {
122                 assertEquals(((Number)handleValue).longValue(), i);
123                 assertEquals(((Number)bufferValue).longValue(), i);
124                 assertEquals(((Number)rawValue).longValue(), i);
125             } else {
126                 assertEquals((long)(char)handleValue, i);
127                 assertEquals((long)(char)bufferValue, i);
128                 assertEquals((long)(char)rawValue, i);
129             }
130         }
131     }
132 
133     public static native byte getByteBuffer(ByteBuffer buf, int index);
134     public static native char getCharBuffer(CharBuffer buf, int index);
135     public static native short getShortBuffer(ShortBuffer buf, int index);
</pre>
</td>
</tr>
</table>
<center><a href="TestAddressHandle.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="TestSegments.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>