<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff test/jdk/java/foreign/TestByteBuffer.java</title>
    <link rel="stylesheet" href="../../../../style.css" />
  </head>
<body>
<center><a href="../../../../src/jdk.incubator.foreign/share/classes/jdk/incubator/foreign/MemoryLayouts.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="../../../micro/org/openjdk/bench/jdk/incubator/foreign/LoopOverNonConstant.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>test/jdk/java/foreign/TestByteBuffer.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 15  * accompanied this code).
 16  *
 17  * You should have received a copy of the GNU General Public License version
 18  * 2 along with this work; if not, write to the Free Software Foundation,
 19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 20  *
 21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 22  * or visit www.oracle.com if you need additional information or have any
 23  * questions.
 24  */
 25 
 26 /*
 27  * @test
 28  * @modules java.base/sun.nio.ch
 29  *          jdk.incubator.foreign/jdk.internal.foreign
 30  * @run testng TestByteBuffer
 31  */
 32 
 33 
 34 import jdk.incubator.foreign.MappedMemorySegment;

 35 import jdk.incubator.foreign.MemoryLayouts;
 36 import jdk.incubator.foreign.MemoryLayout;
 37 import jdk.incubator.foreign.MemoryAddress;
 38 import jdk.incubator.foreign.MemorySegment;
 39 import jdk.incubator.foreign.MemoryLayout.PathElement;
 40 import jdk.incubator.foreign.SequenceLayout;
 41 
 42 import java.io.File;
 43 import java.io.IOException;
 44 import java.lang.invoke.MethodHandle;
 45 import java.lang.invoke.MethodHandles;
 46 import java.lang.invoke.VarHandle;
 47 import java.lang.ref.WeakReference;
 48 import java.lang.reflect.InvocationTargetException;
 49 import java.lang.reflect.Method;
 50 import java.lang.reflect.Modifier;
 51 import java.nio.Buffer;
 52 import java.nio.ByteBuffer;
 53 import java.nio.ByteOrder;
 54 import java.nio.CharBuffer;
</pre>
<hr />
<pre>
537         assertTrue(segmentChecker.test(segment.withAccessModes(MemorySegment.READ)));
538         assertEquals(bb.capacity(), segment.byteSize());
539     }
540 
541     @Test
542     public void testRoundTripAccess() {
543         try(MemorySegment ms = MemorySegment.allocateNative(4)) {
544             MemorySegment msNoAccess = ms.withAccessModes(MemorySegment.READ); // READ is required to make BB
545             MemorySegment msRoundTrip = MemorySegment.ofByteBuffer(msNoAccess.asByteBuffer());
546             assertEquals(msNoAccess.accessModes(), msRoundTrip.accessModes());
547         }
548     }
549 
550     @Test(expectedExceptions = IllegalStateException.class)
551     public void testDeadAccessOnClosedBufferSegment() {
552         MemorySegment s1 = MemorySegment.allocateNative(MemoryLayouts.JAVA_INT);
553         MemorySegment s2 = MemorySegment.ofByteBuffer(s1.asByteBuffer());
554 
555         s1.close(); // memory freed
556 
<span class="line-modified">557         MemoryLayouts.setInt(s2.baseAddress(), 0L, 10); // Dead access!</span>
558     }
559 
560     @DataProvider(name = &quot;bufferOps&quot;)
561     public static Object[][] bufferOps() throws Throwable {
562         return new Object[][]{
563                 { (Function&lt;ByteBuffer, Buffer&gt;) bb -&gt; bb, bufferMembers(ByteBuffer.class)},
564                 { (Function&lt;ByteBuffer, Buffer&gt;) ByteBuffer::asCharBuffer, bufferMembers(CharBuffer.class)},
565                 { (Function&lt;ByteBuffer, Buffer&gt;) ByteBuffer::asShortBuffer, bufferMembers(ShortBuffer.class)},
566                 { (Function&lt;ByteBuffer, Buffer&gt;) ByteBuffer::asIntBuffer, bufferMembers(IntBuffer.class)},
567                 { (Function&lt;ByteBuffer, Buffer&gt;) ByteBuffer::asFloatBuffer, bufferMembers(FloatBuffer.class)},
568                 { (Function&lt;ByteBuffer, Buffer&gt;) ByteBuffer::asLongBuffer, bufferMembers(LongBuffer.class)},
569                 { (Function&lt;ByteBuffer, Buffer&gt;) ByteBuffer::asDoubleBuffer, bufferMembers(DoubleBuffer.class)},
570         };
571     }
572 
573     static Map&lt;Method, Object[]&gt; bufferMembers(Class&lt;?&gt; bufferClass) {
574         Map&lt;Method, Object[]&gt; members = new HashMap&lt;&gt;();
575         for (Method m : bufferClass.getMethods()) {
576             //skip statics and method declared in j.l.Object
577             if (m.getDeclaringClass().equals(Object.class) ||
</pre>
<hr />
<pre>
598 
599     static Map&lt;MethodHandle, Object[]&gt; varHandleMembers(ByteBuffer bb, VarHandle handle) {
600         Map&lt;MethodHandle, Object[]&gt; members = new HashMap&lt;&gt;();
601         for (VarHandle.AccessMode mode : VarHandle.AccessMode.values()) {
602             Class&lt;?&gt;[] params = handle.accessModeType(mode).parameterArray();
603             Object[] args = Stream.concat(Stream.of(bb), Stream.of(params).skip(1)
604                     .map(TestByteBuffer::defaultValue))
605                     .toArray();
606             try {
607                 members.put(MethodHandles.varHandleInvoker(mode, handle.accessModeType(mode)), args);
608             } catch (Throwable ex) {
609                 throw new AssertionError(ex);
610             }
611         }
612         return members;
613     }
614 
615     @DataProvider(name = &quot;resizeOps&quot;)
616     public Object[][] resizeOps() {
617         Consumer&lt;MemoryAddress&gt; byteInitializer =
<span class="line-modified">618                 (base) -&gt; initBytes(base, bytes, (addr, pos) -&gt; MemoryLayouts.setByte_BE(addr, pos, (byte)(long)pos));</span>
619         Consumer&lt;MemoryAddress&gt; charInitializer =
<span class="line-modified">620                 (base) -&gt; initBytes(base, chars, (addr, pos) -&gt; MemoryLayouts.setChar_BE(addr, pos * 2, (char)(long)pos));</span>
621         Consumer&lt;MemoryAddress&gt; shortInitializer =
<span class="line-modified">622                 (base) -&gt; initBytes(base, shorts, (addr, pos) -&gt; MemoryLayouts.setShort_BE(addr, pos * 2, (short)(long)pos));</span>
623         Consumer&lt;MemoryAddress&gt; intInitializer =
<span class="line-modified">624                 (base) -&gt; initBytes(base, ints, (addr, pos) -&gt; MemoryLayouts.setInt_BE(addr, pos * 4, (int)(long)pos));</span>
625         Consumer&lt;MemoryAddress&gt; floatInitializer =
<span class="line-modified">626                 (base) -&gt; initBytes(base, floats, (addr, pos) -&gt; MemoryLayouts.setFloat_BE(addr, pos * 4, (float)(long)pos));</span>
627         Consumer&lt;MemoryAddress&gt; longInitializer =
<span class="line-modified">628                 (base) -&gt; initBytes(base, longs, (addr, pos) -&gt; MemoryLayouts.setLong_BE(addr, pos * 8, (long)pos));</span>
629         Consumer&lt;MemoryAddress&gt; doubleInitializer =
<span class="line-modified">630                 (base) -&gt; initBytes(base, doubles, (addr, pos) -&gt; MemoryLayouts.setDouble_BE(addr, pos * 8, (double)(long)pos));</span>
631 
632         Consumer&lt;MemoryAddress&gt; byteChecker =
<span class="line-modified">633                 (base) -&gt; checkBytes(base, bytes, Function.identity(), MemoryLayouts::getByte_BE, ByteBuffer::get);</span>
634         Consumer&lt;MemoryAddress&gt; charChecker =
<span class="line-modified">635                 (base) -&gt; checkBytes(base, chars, ByteBuffer::asCharBuffer, (addr, pos) -&gt; MemoryLayouts.getChar_BE(addr, pos * 2), CharBuffer::get);</span>
636         Consumer&lt;MemoryAddress&gt; shortChecker =
<span class="line-modified">637                 (base) -&gt; checkBytes(base, shorts, ByteBuffer::asShortBuffer, (addr, pos) -&gt; MemoryLayouts.getShort_BE(addr, pos * 2), ShortBuffer::get);</span>
638         Consumer&lt;MemoryAddress&gt; intChecker =
<span class="line-modified">639                 (base) -&gt; checkBytes(base, ints, ByteBuffer::asIntBuffer, (addr, pos) -&gt; MemoryLayouts.getInt_BE(addr, pos * 4), IntBuffer::get);</span>
640         Consumer&lt;MemoryAddress&gt; floatChecker =
<span class="line-modified">641                 (base) -&gt; checkBytes(base, floats, ByteBuffer::asFloatBuffer, (addr, pos) -&gt; MemoryLayouts.getFloat_BE(addr, pos * 4), FloatBuffer::get);</span>
642         Consumer&lt;MemoryAddress&gt; longChecker =
<span class="line-modified">643                 (base) -&gt; checkBytes(base, longs, ByteBuffer::asLongBuffer, (addr, pos) -&gt; MemoryLayouts.getLong_BE(addr, pos * 8), LongBuffer::get);</span>
644         Consumer&lt;MemoryAddress&gt; doubleChecker =
<span class="line-modified">645                 (base) -&gt; checkBytes(base, doubles, ByteBuffer::asDoubleBuffer, (addr, pos) -&gt; MemoryLayouts.getDouble_BE(addr, pos * 8), DoubleBuffer::get);</span>
646 
647         return new Object[][]{
648                 {byteChecker, byteInitializer, bytes},
649                 {charChecker, charInitializer, chars},
650                 {shortChecker, shortInitializer, shorts},
651                 {intChecker, intInitializer, ints},
652                 {floatChecker, floatInitializer, floats},
653                 {longChecker, longInitializer, longs},
654                 {doubleChecker, doubleInitializer, doubles}
655         };
656     }
657 
658     static Object defaultValue(Class&lt;?&gt; c) {
659         if (c.isPrimitive()) {
660             if (c == char.class) {
661                 return (char)0;
662             } else if (c == boolean.class) {
663                 return false;
664             } else if (c == byte.class) {
665                 return (byte)0;
</pre>
</td>
<td>
<hr />
<pre>
 15  * accompanied this code).
 16  *
 17  * You should have received a copy of the GNU General Public License version
 18  * 2 along with this work; if not, write to the Free Software Foundation,
 19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 20  *
 21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 22  * or visit www.oracle.com if you need additional information or have any
 23  * questions.
 24  */
 25 
 26 /*
 27  * @test
 28  * @modules java.base/sun.nio.ch
 29  *          jdk.incubator.foreign/jdk.internal.foreign
 30  * @run testng TestByteBuffer
 31  */
 32 
 33 
 34 import jdk.incubator.foreign.MappedMemorySegment;
<span class="line-added"> 35 import jdk.incubator.foreign.MemoryAccess;</span>
 36 import jdk.incubator.foreign.MemoryLayouts;
 37 import jdk.incubator.foreign.MemoryLayout;
 38 import jdk.incubator.foreign.MemoryAddress;
 39 import jdk.incubator.foreign.MemorySegment;
 40 import jdk.incubator.foreign.MemoryLayout.PathElement;
 41 import jdk.incubator.foreign.SequenceLayout;
 42 
 43 import java.io.File;
 44 import java.io.IOException;
 45 import java.lang.invoke.MethodHandle;
 46 import java.lang.invoke.MethodHandles;
 47 import java.lang.invoke.VarHandle;
 48 import java.lang.ref.WeakReference;
 49 import java.lang.reflect.InvocationTargetException;
 50 import java.lang.reflect.Method;
 51 import java.lang.reflect.Modifier;
 52 import java.nio.Buffer;
 53 import java.nio.ByteBuffer;
 54 import java.nio.ByteOrder;
 55 import java.nio.CharBuffer;
</pre>
<hr />
<pre>
538         assertTrue(segmentChecker.test(segment.withAccessModes(MemorySegment.READ)));
539         assertEquals(bb.capacity(), segment.byteSize());
540     }
541 
542     @Test
543     public void testRoundTripAccess() {
544         try(MemorySegment ms = MemorySegment.allocateNative(4)) {
545             MemorySegment msNoAccess = ms.withAccessModes(MemorySegment.READ); // READ is required to make BB
546             MemorySegment msRoundTrip = MemorySegment.ofByteBuffer(msNoAccess.asByteBuffer());
547             assertEquals(msNoAccess.accessModes(), msRoundTrip.accessModes());
548         }
549     }
550 
551     @Test(expectedExceptions = IllegalStateException.class)
552     public void testDeadAccessOnClosedBufferSegment() {
553         MemorySegment s1 = MemorySegment.allocateNative(MemoryLayouts.JAVA_INT);
554         MemorySegment s2 = MemorySegment.ofByteBuffer(s1.asByteBuffer());
555 
556         s1.close(); // memory freed
557 
<span class="line-modified">558         MemoryAccess.setInt(s2.baseAddress(), 0L, 10); // Dead access!</span>
559     }
560 
561     @DataProvider(name = &quot;bufferOps&quot;)
562     public static Object[][] bufferOps() throws Throwable {
563         return new Object[][]{
564                 { (Function&lt;ByteBuffer, Buffer&gt;) bb -&gt; bb, bufferMembers(ByteBuffer.class)},
565                 { (Function&lt;ByteBuffer, Buffer&gt;) ByteBuffer::asCharBuffer, bufferMembers(CharBuffer.class)},
566                 { (Function&lt;ByteBuffer, Buffer&gt;) ByteBuffer::asShortBuffer, bufferMembers(ShortBuffer.class)},
567                 { (Function&lt;ByteBuffer, Buffer&gt;) ByteBuffer::asIntBuffer, bufferMembers(IntBuffer.class)},
568                 { (Function&lt;ByteBuffer, Buffer&gt;) ByteBuffer::asFloatBuffer, bufferMembers(FloatBuffer.class)},
569                 { (Function&lt;ByteBuffer, Buffer&gt;) ByteBuffer::asLongBuffer, bufferMembers(LongBuffer.class)},
570                 { (Function&lt;ByteBuffer, Buffer&gt;) ByteBuffer::asDoubleBuffer, bufferMembers(DoubleBuffer.class)},
571         };
572     }
573 
574     static Map&lt;Method, Object[]&gt; bufferMembers(Class&lt;?&gt; bufferClass) {
575         Map&lt;Method, Object[]&gt; members = new HashMap&lt;&gt;();
576         for (Method m : bufferClass.getMethods()) {
577             //skip statics and method declared in j.l.Object
578             if (m.getDeclaringClass().equals(Object.class) ||
</pre>
<hr />
<pre>
599 
600     static Map&lt;MethodHandle, Object[]&gt; varHandleMembers(ByteBuffer bb, VarHandle handle) {
601         Map&lt;MethodHandle, Object[]&gt; members = new HashMap&lt;&gt;();
602         for (VarHandle.AccessMode mode : VarHandle.AccessMode.values()) {
603             Class&lt;?&gt;[] params = handle.accessModeType(mode).parameterArray();
604             Object[] args = Stream.concat(Stream.of(bb), Stream.of(params).skip(1)
605                     .map(TestByteBuffer::defaultValue))
606                     .toArray();
607             try {
608                 members.put(MethodHandles.varHandleInvoker(mode, handle.accessModeType(mode)), args);
609             } catch (Throwable ex) {
610                 throw new AssertionError(ex);
611             }
612         }
613         return members;
614     }
615 
616     @DataProvider(name = &quot;resizeOps&quot;)
617     public Object[][] resizeOps() {
618         Consumer&lt;MemoryAddress&gt; byteInitializer =
<span class="line-modified">619                 (base) -&gt; initBytes(base, bytes, (addr, pos) -&gt; MemoryAccess.setByte_BE(addr, pos, (byte)(long)pos));</span>
620         Consumer&lt;MemoryAddress&gt; charInitializer =
<span class="line-modified">621                 (base) -&gt; initBytes(base, chars, (addr, pos) -&gt; MemoryAccess.setChar_BE(addr, pos * 2, (char)(long)pos));</span>
622         Consumer&lt;MemoryAddress&gt; shortInitializer =
<span class="line-modified">623                 (base) -&gt; initBytes(base, shorts, (addr, pos) -&gt; MemoryAccess.setShort_BE(addr, pos * 2, (short)(long)pos));</span>
624         Consumer&lt;MemoryAddress&gt; intInitializer =
<span class="line-modified">625                 (base) -&gt; initBytes(base, ints, (addr, pos) -&gt; MemoryAccess.setInt_BE(addr, pos * 4, (int)(long)pos));</span>
626         Consumer&lt;MemoryAddress&gt; floatInitializer =
<span class="line-modified">627                 (base) -&gt; initBytes(base, floats, (addr, pos) -&gt; MemoryAccess.setFloat_BE(addr, pos * 4, (float)(long)pos));</span>
628         Consumer&lt;MemoryAddress&gt; longInitializer =
<span class="line-modified">629                 (base) -&gt; initBytes(base, longs, (addr, pos) -&gt; MemoryAccess.setLong_BE(addr, pos * 8, (long)pos));</span>
630         Consumer&lt;MemoryAddress&gt; doubleInitializer =
<span class="line-modified">631                 (base) -&gt; initBytes(base, doubles, (addr, pos) -&gt; MemoryAccess.setDouble_BE(addr, pos * 8, (double)(long)pos));</span>
632 
633         Consumer&lt;MemoryAddress&gt; byteChecker =
<span class="line-modified">634                 (base) -&gt; checkBytes(base, bytes, Function.identity(), MemoryAccess::getByte_BE, ByteBuffer::get);</span>
635         Consumer&lt;MemoryAddress&gt; charChecker =
<span class="line-modified">636                 (base) -&gt; checkBytes(base, chars, ByteBuffer::asCharBuffer, (addr, pos) -&gt; MemoryAccess.getChar_BE(addr, pos * 2), CharBuffer::get);</span>
637         Consumer&lt;MemoryAddress&gt; shortChecker =
<span class="line-modified">638                 (base) -&gt; checkBytes(base, shorts, ByteBuffer::asShortBuffer, (addr, pos) -&gt; MemoryAccess.getShort_BE(addr, pos * 2), ShortBuffer::get);</span>
639         Consumer&lt;MemoryAddress&gt; intChecker =
<span class="line-modified">640                 (base) -&gt; checkBytes(base, ints, ByteBuffer::asIntBuffer, (addr, pos) -&gt; MemoryAccess.getInt_BE(addr, pos * 4), IntBuffer::get);</span>
641         Consumer&lt;MemoryAddress&gt; floatChecker =
<span class="line-modified">642                 (base) -&gt; checkBytes(base, floats, ByteBuffer::asFloatBuffer, (addr, pos) -&gt; MemoryAccess.getFloat_BE(addr, pos * 4), FloatBuffer::get);</span>
643         Consumer&lt;MemoryAddress&gt; longChecker =
<span class="line-modified">644                 (base) -&gt; checkBytes(base, longs, ByteBuffer::asLongBuffer, (addr, pos) -&gt; MemoryAccess.getLong_BE(addr, pos * 8), LongBuffer::get);</span>
645         Consumer&lt;MemoryAddress&gt; doubleChecker =
<span class="line-modified">646                 (base) -&gt; checkBytes(base, doubles, ByteBuffer::asDoubleBuffer, (addr, pos) -&gt; MemoryAccess.getDouble_BE(addr, pos * 8), DoubleBuffer::get);</span>
647 
648         return new Object[][]{
649                 {byteChecker, byteInitializer, bytes},
650                 {charChecker, charInitializer, chars},
651                 {shortChecker, shortInitializer, shorts},
652                 {intChecker, intInitializer, ints},
653                 {floatChecker, floatInitializer, floats},
654                 {longChecker, longInitializer, longs},
655                 {doubleChecker, doubleInitializer, doubles}
656         };
657     }
658 
659     static Object defaultValue(Class&lt;?&gt; c) {
660         if (c.isPrimitive()) {
661             if (c == char.class) {
662                 return (char)0;
663             } else if (c == boolean.class) {
664                 return false;
665             } else if (c == byte.class) {
666                 return (byte)0;
</pre>
</td>
</tr>
</table>
<center><a href="../../../../src/jdk.incubator.foreign/share/classes/jdk/incubator/foreign/MemoryLayouts.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="../../../micro/org/openjdk/bench/jdk/incubator/foreign/LoopOverNonConstant.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>