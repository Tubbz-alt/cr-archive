<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff test/jdk/java/foreign/TestSegments.java</title>
    <link rel="stylesheet" href="../../../../style.css" />
  </head>
<body>
<center><a href="TestNative.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="TestSharedAccess.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>test/jdk/java/foreign/TestSegments.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 75                         ((MemorySegment)o).close();
 76                     }
 77                 } catch (ReflectiveOperationException ex) {
 78                     throw new IllegalStateException(ex);
 79                 }
 80             });
 81             t.setUncaughtExceptionHandler((thread, ex) -&gt; failed.set(true));
 82             t.start();
 83             t.join();
 84             assertEquals(failed.get(), member.isConfined());
 85         }
 86     }
 87 
 88     @Test
 89     public void testNativeSegmentIsZeroed() {
 90         VarHandle byteHandle = MemoryLayout.ofSequence(MemoryLayouts.JAVA_BYTE)
 91                 .varHandle(byte.class, MemoryLayout.PathElement.sequenceElement());
 92         try (MemorySegment segment = MemorySegment.allocateNative(1000)) {
 93             for (long i = 0 ; i &lt; segment.byteSize() ; i++) {
 94                 assertEquals(0, (byte)byteHandle.get(segment.baseAddress(), i));



































 95             }
 96         }
 97     }
 98 
 99     @Test
100     public void testSlices() {
101         VarHandle byteHandle = MemoryLayout.ofSequence(MemoryLayouts.JAVA_BYTE)
102                 .varHandle(byte.class, MemoryLayout.PathElement.sequenceElement());
103         try (MemorySegment segment = MemorySegment.allocateNative(10)) {
104             //init
105             for (byte i = 0 ; i &lt; segment.byteSize() ; i++) {
106                 byteHandle.set(segment.baseAddress(), (long)i, i);
107             }
108             long start = 0;
109             MemoryAddress base = segment.baseAddress();
110             MemoryAddress last = base.addOffset(10);
111             while (!base.equals(last)) {
112                 MemorySegment slice = segment.asSlice(base.offset(), 10 - start);
113                 for (long i = start ; i &lt; 10 ; i++) {
114                     assertEquals(
</pre>
</td>
<td>
<hr />
<pre>
 75                         ((MemorySegment)o).close();
 76                     }
 77                 } catch (ReflectiveOperationException ex) {
 78                     throw new IllegalStateException(ex);
 79                 }
 80             });
 81             t.setUncaughtExceptionHandler((thread, ex) -&gt; failed.set(true));
 82             t.start();
 83             t.join();
 84             assertEquals(failed.get(), member.isConfined());
 85         }
 86     }
 87 
 88     @Test
 89     public void testNativeSegmentIsZeroed() {
 90         VarHandle byteHandle = MemoryLayout.ofSequence(MemoryLayouts.JAVA_BYTE)
 91                 .varHandle(byte.class, MemoryLayout.PathElement.sequenceElement());
 92         try (MemorySegment segment = MemorySegment.allocateNative(1000)) {
 93             for (long i = 0 ; i &lt; segment.byteSize() ; i++) {
 94                 assertEquals(0, (byte)byteHandle.get(segment.baseAddress(), i));
<span class="line-added"> 95             }</span>
<span class="line-added"> 96         }</span>
<span class="line-added"> 97     }</span>
<span class="line-added"> 98 </span>
<span class="line-added"> 99     @Test</span>
<span class="line-added">100     public void testHeapSource() {</span>
<span class="line-added">101         int[] arr = { 1, 2, 3};</span>
<span class="line-added">102         MemorySegment segment = MemorySegment.ofArray(arr);</span>
<span class="line-added">103         assertFalse(segment.source().isNative());</span>
<span class="line-added">104         assertEquals(segment.source().base(), arr);</span>
<span class="line-added">105         try {</span>
<span class="line-added">106             segment.source().address(segment.baseAddress()); //should not work - not a native segment</span>
<span class="line-added">107             fail();</span>
<span class="line-added">108         } catch (UnsupportedOperationException ex) {</span>
<span class="line-added">109             //ok</span>
<span class="line-added">110         }</span>
<span class="line-added">111     }</span>
<span class="line-added">112 </span>
<span class="line-added">113     @Test</span>
<span class="line-added">114     public void testNativeSource() {</span>
<span class="line-added">115         try (MemorySegment segment = MemorySegment.allocateNative(4);</span>
<span class="line-added">116              MemorySegment other = MemorySegment.allocateNative(4)) {</span>
<span class="line-added">117             assertTrue(segment.source().isNative());</span>
<span class="line-added">118             segment.source().address(segment.baseAddress()); //should work</span>
<span class="line-added">119             try {</span>
<span class="line-added">120                 other.source().address(segment.baseAddress()); //should not work - wrong segment</span>
<span class="line-added">121                 fail();</span>
<span class="line-added">122             } catch (IllegalArgumentException ex) {</span>
<span class="line-added">123                 //ok</span>
<span class="line-added">124             }</span>
<span class="line-added">125             try {</span>
<span class="line-added">126                 segment.source().base(); //should not work - not a heap segment</span>
<span class="line-added">127                 fail();</span>
<span class="line-added">128             } catch (UnsupportedOperationException ex) {</span>
<span class="line-added">129                 //ok</span>
130             }
131         }
132     }
133 
134     @Test
135     public void testSlices() {
136         VarHandle byteHandle = MemoryLayout.ofSequence(MemoryLayouts.JAVA_BYTE)
137                 .varHandle(byte.class, MemoryLayout.PathElement.sequenceElement());
138         try (MemorySegment segment = MemorySegment.allocateNative(10)) {
139             //init
140             for (byte i = 0 ; i &lt; segment.byteSize() ; i++) {
141                 byteHandle.set(segment.baseAddress(), (long)i, i);
142             }
143             long start = 0;
144             MemoryAddress base = segment.baseAddress();
145             MemoryAddress last = base.addOffset(10);
146             while (!base.equals(last)) {
147                 MemorySegment slice = segment.asSlice(base.offset(), 10 - start);
148                 for (long i = start ; i &lt; 10 ; i++) {
149                     assertEquals(
</pre>
</td>
</tr>
</table>
<center><a href="TestNative.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="TestSharedAccess.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>