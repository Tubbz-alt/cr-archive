<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff src/jdk.internal.vm.compiler/share/classes/org.graalvm.compiler.hotspot/src/org/graalvm/compiler/hotspot/meta/DefaultHotSpotLoweringProvider.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="../SymbolicSnippetEncoder.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../../index.html" target="_top">index</a> <a href="HotSpotGraphBuilderPlugins.java.udiff.html" target="_top">next &gt;</a></center>    <h2>src/jdk.internal.vm.compiler/share/classes/org.graalvm.compiler.hotspot/src/org/graalvm/compiler/hotspot/meta/DefaultHotSpotLoweringProvider.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -1,7 +1,7 @@</span>
  /*
<span class="udiff-line-modified-removed">-  * Copyright (c) 2011, 2019, Oracle and/or its affiliates. All rights reserved.</span>
<span class="udiff-line-modified-added">+  * Copyright (c) 2011, 2020, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -74,19 +74,19 @@</span>
  import org.graalvm.compiler.hotspot.nodes.type.MethodPointerStamp;
  import org.graalvm.compiler.hotspot.replacements.AssertionSnippets;
  import org.graalvm.compiler.hotspot.replacements.ClassGetHubNode;
  import org.graalvm.compiler.hotspot.replacements.FastNotifyNode;
  import org.graalvm.compiler.hotspot.replacements.HashCodeSnippets;
<span class="udiff-line-added">+ import org.graalvm.compiler.hotspot.replacements.HotSpotAllocationSnippets;</span>
  import org.graalvm.compiler.hotspot.replacements.HotSpotG1WriteBarrierSnippets;
  import org.graalvm.compiler.hotspot.replacements.HotSpotSerialWriteBarrierSnippets;
  import org.graalvm.compiler.hotspot.replacements.HubGetClassNode;
  import org.graalvm.compiler.hotspot.replacements.IdentityHashCodeNode;
  import org.graalvm.compiler.hotspot.replacements.InstanceOfSnippets;
  import org.graalvm.compiler.hotspot.replacements.KlassLayoutHelperNode;
  import org.graalvm.compiler.hotspot.replacements.LoadExceptionObjectSnippets;
  import org.graalvm.compiler.hotspot.replacements.MonitorSnippets;
<span class="udiff-line-removed">- import org.graalvm.compiler.hotspot.replacements.NewObjectSnippets;</span>
  import org.graalvm.compiler.hotspot.replacements.ObjectCloneSnippets;
  import org.graalvm.compiler.hotspot.replacements.ObjectSnippets;
  import org.graalvm.compiler.hotspot.replacements.StringToBytesSnippets;
  import org.graalvm.compiler.hotspot.replacements.UnsafeCopyMemoryNode;
  import org.graalvm.compiler.hotspot.replacements.UnsafeLoadSnippets;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -151,11 +151,11 @@</span>
  import org.graalvm.compiler.nodes.java.NewArrayNode;
  import org.graalvm.compiler.nodes.java.NewInstanceNode;
  import org.graalvm.compiler.nodes.java.NewMultiArrayNode;
  import org.graalvm.compiler.nodes.java.RawMonitorEnterNode;
  import org.graalvm.compiler.nodes.memory.FloatingReadNode;
<span class="udiff-line-modified-removed">- import org.graalvm.compiler.nodes.memory.HeapAccess.BarrierType;</span>
<span class="udiff-line-modified-added">+ import org.graalvm.compiler.nodes.memory.OnHeapMemoryAccess.BarrierType;</span>
  import org.graalvm.compiler.nodes.memory.ReadNode;
  import org.graalvm.compiler.nodes.memory.WriteNode;
  import org.graalvm.compiler.nodes.memory.address.AddressNode;
  import org.graalvm.compiler.nodes.spi.LoweringProvider;
  import org.graalvm.compiler.nodes.spi.LoweringTool;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -191,11 +191,11 @@</span>
      protected final HotSpotGraalRuntimeProvider runtime;
      protected final HotSpotRegistersProvider registers;
      protected final HotSpotConstantReflectionProvider constantReflection;
  
      protected InstanceOfSnippets.Templates instanceofSnippets;
<span class="udiff-line-modified-removed">-     protected NewObjectSnippets.Templates newObjectSnippets;</span>
<span class="udiff-line-modified-added">+     protected HotSpotAllocationSnippets.Templates allocationSnippets;</span>
      protected MonitorSnippets.Templates monitorSnippets;
      protected HotSpotSerialWriteBarrierSnippets.Templates serialWriteBarrierSnippets;
      protected HotSpotG1WriteBarrierSnippets.Templates g1WriteBarrierSnippets;
      protected LoadExceptionObjectSnippets.Templates exceptionObjectSnippets;
      protected UnsafeLoadSnippets.Templates unsafeLoadSnippets;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -223,11 +223,11 @@</span>
      public void initialize(OptionValues options, Iterable&lt;DebugHandlersFactory&gt; factories, HotSpotProviders providers, GraalHotSpotVMConfig config) {
          super.initialize(options, factories, runtime, providers, providers.getSnippetReflection());
  
          assert target == providers.getCodeCache().getTarget();
          instanceofSnippets = new InstanceOfSnippets.Templates(options, factories, runtime, providers, target);
<span class="udiff-line-modified-removed">-         newObjectSnippets = new NewObjectSnippets.Templates(options, factories, runtime, providers, target, config);</span>
<span class="udiff-line-modified-added">+         allocationSnippets = new HotSpotAllocationSnippets.Templates(options, factories, runtime, providers, target, config);</span>
          monitorSnippets = new MonitorSnippets.Templates(options, factories, runtime, providers, target, config.useFastLocking);
          g1WriteBarrierSnippets = new HotSpotG1WriteBarrierSnippets.Templates(options, factories, runtime, providers, target, config);
          serialWriteBarrierSnippets = new HotSpotSerialWriteBarrierSnippets.Templates(options, factories, runtime, providers, target, config);
          exceptionObjectSnippets = new LoadExceptionObjectSnippets.Templates(options, factories, providers, target);
          unsafeLoadSnippets = new UnsafeLoadSnippets.Templates(options, factories, providers, target);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -308,39 +308,39 @@</span>
                  if (graph.getGuardsStage().areDeoptsFixed()) {
                      instanceofSnippets.lower((ClassIsAssignableFromNode) n, tool);
                  }
              } else if (n instanceof NewInstanceNode) {
                  if (graph.getGuardsStage().areFrameStatesAtDeopts()) {
<span class="udiff-line-modified-removed">-                     newObjectSnippets.lower((NewInstanceNode) n, registers, tool);</span>
<span class="udiff-line-modified-added">+                     allocationSnippets.lower((NewInstanceNode) n, tool);</span>
                  }
              } else if (n instanceof DynamicNewInstanceNode) {
                  DynamicNewInstanceNode newInstanceNode = (DynamicNewInstanceNode) n;
                  if (newInstanceNode.getClassClass() == null) {
                      JavaConstant classClassMirror = constantReflection.asJavaClass(metaAccess.lookupJavaType(Class.class));
                      ConstantNode classClass = ConstantNode.forConstant(classClassMirror, tool.getMetaAccess(), graph);
                      newInstanceNode.setClassClass(classClass);
                  }
                  if (graph.getGuardsStage().areFrameStatesAtDeopts()) {
<span class="udiff-line-modified-removed">-                     newObjectSnippets.lower(newInstanceNode, registers, tool);</span>
<span class="udiff-line-modified-added">+                     allocationSnippets.lower(newInstanceNode, tool);</span>
                  }
              } else if (n instanceof NewArrayNode) {
                  if (graph.getGuardsStage().areFrameStatesAtDeopts()) {
<span class="udiff-line-modified-removed">-                     newObjectSnippets.lower((NewArrayNode) n, registers, tool);</span>
<span class="udiff-line-modified-added">+                     allocationSnippets.lower((NewArrayNode) n, tool);</span>
                  }
              } else if (n instanceof DynamicNewArrayNode) {
                  DynamicNewArrayNode dynamicNewArrayNode = (DynamicNewArrayNode) n;
                  if (dynamicNewArrayNode.getVoidClass() == null) {
                      JavaConstant voidClassMirror = constantReflection.asJavaClass(metaAccess.lookupJavaType(void.class));
                      ConstantNode voidClass = ConstantNode.forConstant(voidClassMirror, tool.getMetaAccess(), graph);
                      dynamicNewArrayNode.setVoidClass(voidClass);
                  }
                  if (graph.getGuardsStage().areFrameStatesAtDeopts()) {
<span class="udiff-line-modified-removed">-                     newObjectSnippets.lower(dynamicNewArrayNode, registers, tool);</span>
<span class="udiff-line-modified-added">+                     allocationSnippets.lower(dynamicNewArrayNode, tool);</span>
                  }
              } else if (n instanceof VerifyHeapNode) {
                  if (graph.getGuardsStage().areFrameStatesAtDeopts()) {
<span class="udiff-line-modified-removed">-                     newObjectSnippets.lower((VerifyHeapNode) n, registers, tool);</span>
<span class="udiff-line-modified-added">+                     allocationSnippets.lower((VerifyHeapNode) n, tool);</span>
                  }
              } else if (n instanceof RawMonitorEnterNode) {
                  if (graph.getGuardsStage().areFrameStatesAtDeopts()) {
                      monitorSnippets.lower((RawMonitorEnterNode) n, registers, tool);
                  }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -366,11 +366,11 @@</span>
                  g1WriteBarrierSnippets.lower((G1ArrayRangePreWriteBarrier) n, tool);
              } else if (n instanceof G1ArrayRangePostWriteBarrier) {
                  g1WriteBarrierSnippets.lower((G1ArrayRangePostWriteBarrier) n, tool);
              } else if (n instanceof NewMultiArrayNode) {
                  if (graph.getGuardsStage().areFrameStatesAtDeopts()) {
<span class="udiff-line-modified-removed">-                     newObjectSnippets.lower((NewMultiArrayNode) n, tool);</span>
<span class="udiff-line-modified-added">+                     allocationSnippets.lower((NewMultiArrayNode) n, tool);</span>
                  }
              } else if (n instanceof LoadExceptionObjectNode) {
                  exceptionObjectSnippets.lower((LoadExceptionObjectNode) n, registers, tool);
              } else if (n instanceof AssertionNode) {
                  assertionSnippets.lower((AssertionNode) n, tool);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -412,11 +412,11 @@</span>
                      resolveConstantSnippets.lower((InitializeKlassNode) n, tool);
                  }
              } else if (n instanceof ProfileNode) {
                  profileSnippets.lower((ProfileNode) n, tool);
              } else if (n instanceof KlassBeingInitializedCheckNode) {
<span class="udiff-line-modified-removed">-                 newObjectSnippets.lower((KlassBeingInitializedCheckNode) n, registers, tool);</span>
<span class="udiff-line-modified-added">+                 allocationSnippets.lower((KlassBeingInitializedCheckNode) n, tool);</span>
              } else if (n instanceof FastNotifyNode) {
                  if (graph.getGuardsStage() == GuardsStage.AFTER_FSA) {
                      objectSnippets.lower(n, tool);
                  }
              } else if (n instanceof UnsafeCopyMemoryNode) {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -779,11 +779,11 @@</span>
          AddressNode address = createOffsetAddress(graph, object, runtime.getVMConfig().hubOffset);
          return graph.add(new WriteNode(address, HUB_WRITE_LOCATION, writeValue, BarrierType.NONE, false));
      }
  
      @Override
<span class="udiff-line-modified-removed">-     protected BarrierType fieldLoadBarrierType(ResolvedJavaField f) {</span>
<span class="udiff-line-modified-added">+     public BarrierType fieldLoadBarrierType(ResolvedJavaField f) {</span>
          HotSpotResolvedJavaField loadField = (HotSpotResolvedJavaField) f;
          if (loadField.getJavaKind() == JavaKind.Object &amp;&amp; metaAccess.lookupJavaType(Reference.class).equals(loadField.getDeclaringClass()) &amp;&amp;
                          loadField.getName().equals(&quot;referent&quot;)) {
              return BarrierType.WEAK_FIELD;
          }
</pre>
<center><a href="../SymbolicSnippetEncoder.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../../index.html" target="_top">index</a> <a href="HotSpotGraphBuilderPlugins.java.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>