<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff src/jdk.internal.vm.compiler/share/classes/org.graalvm.compiler.replacements/src/org/graalvm/compiler/replacements/SnippetTemplate.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="PEGraphDecoder.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="StandardGraphBuilderPlugins.java.udiff.html" target="_top">next &gt;</a></center>    <h2>src/jdk.internal.vm.compiler/share/classes/org.graalvm.compiler.replacements/src/org/graalvm/compiler/replacements/SnippetTemplate.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -1,7 +1,7 @@</span>
  /*
<span class="udiff-line-modified-removed">-  * Copyright (c) 2012, 2019, Oracle and/or its affiliates. All rights reserved.</span>
<span class="udiff-line-modified-added">+  * Copyright (c) 2012, 2020, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -111,15 +111,17 @@</span>
  import org.graalvm.compiler.nodes.java.LoadIndexedNode;
  import org.graalvm.compiler.nodes.java.MethodCallTargetNode;
  import org.graalvm.compiler.nodes.java.StoreIndexedNode;
  import org.graalvm.compiler.nodes.memory.MemoryAccess;
  import org.graalvm.compiler.nodes.memory.MemoryAnchorNode;
<span class="udiff-line-modified-removed">- import org.graalvm.compiler.nodes.memory.MemoryCheckpoint;</span>
<span class="udiff-line-modified-added">+ import org.graalvm.compiler.nodes.memory.MemoryKill;</span>
  import org.graalvm.compiler.nodes.memory.MemoryMap;
  import org.graalvm.compiler.nodes.memory.MemoryMapNode;
  import org.graalvm.compiler.nodes.memory.MemoryNode;
  import org.graalvm.compiler.nodes.memory.MemoryPhiNode;
<span class="udiff-line-added">+ import org.graalvm.compiler.nodes.memory.MultiMemoryKill;</span>
<span class="udiff-line-added">+ import org.graalvm.compiler.nodes.memory.SingleMemoryKill;</span>
  import org.graalvm.compiler.nodes.spi.ArrayLengthProvider;
  import org.graalvm.compiler.nodes.spi.CoreProviders;
  import org.graalvm.compiler.nodes.spi.LoweringTool;
  import org.graalvm.compiler.nodes.spi.MemoryProxy;
  import org.graalvm.compiler.nodes.util.GraphUtil;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -927,11 +929,13 @@</span>
  
              new DeadCodeEliminationPhase(Required).apply(snippetCopy);
  
              assert checkAllVarargPlaceholdersAreDeleted(parameterCount, placeholders);
  
<span class="udiff-line-modified-removed">-             new FloatingReadPhase(true, true).apply(snippetCopy);</span>
<span class="udiff-line-modified-added">+             if (((StructuredGraph) replacee.graph()).isAfterFloatingReadPhase()) {</span>
<span class="udiff-line-added">+                 new FloatingReadPhase(true, true).apply(snippetCopy);</span>
<span class="udiff-line-added">+             }</span>
  
              if (!guardsStage.requiresValueProxies()) {
                  new RemoveValueProxyPhase().apply(snippetCopy);
              }
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1283,22 +1287,22 @@</span>
          }
  
          EconomicSet&lt;LocationIdentity&gt; kills = EconomicSet.create(Equivalence.DEFAULT);
          kills.addAll(memoryMap.getLocations());
  
<span class="udiff-line-modified-removed">-         if (replacee instanceof MemoryCheckpoint.Single) {</span>
<span class="udiff-line-modified-added">+         if (replacee instanceof SingleMemoryKill) {</span>
              // check if some node in snippet graph also kills the same location
<span class="udiff-line-modified-removed">-             LocationIdentity locationIdentity = ((MemoryCheckpoint.Single) replacee).getKilledLocationIdentity();</span>
<span class="udiff-line-modified-added">+             LocationIdentity locationIdentity = ((SingleMemoryKill) replacee).getKilledLocationIdentity();</span>
              if (locationIdentity.isAny()) {
                  assert !(memoryMap.getLastLocationAccess(any()) instanceof MemoryAnchorNode) : replacee + &quot; kills ANY_LOCATION, but snippet does not&quot;;
                  // if the replacee kills ANY_LOCATION, the snippet can kill arbitrary locations
                  return true;
              }
              assert kills.contains(locationIdentity) : replacee + &quot; kills &quot; + locationIdentity + &quot;, but snippet doesn&#39;t contain a kill to this location&quot;;
              kills.remove(locationIdentity);
          }
<span class="udiff-line-modified-removed">-         assert !(replacee instanceof MemoryCheckpoint.Multi) : replacee + &quot; multi not supported (yet)&quot;;</span>
<span class="udiff-line-modified-added">+         assert !(replacee instanceof MultiMemoryKill) : replacee + &quot; multi not supported (yet)&quot;;</span>
  
          // remove ANY_LOCATION if it&#39;s just a kill by the start node
          if (memoryMap.getLastLocationAccess(any()) instanceof MemoryAnchorNode) {
              kills.remove(any());
          }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1505,11 +1509,11 @@</span>
              // Replace all usages of the replacee with the value returned by the snippet
              ValueNode returnValue = null;
              if (returnNode != null &amp;&amp; !(replacee instanceof ControlSinkNode)) {
                  ReturnNode returnDuplicate = (ReturnNode) duplicates.get(returnNode);
                  returnValue = returnDuplicate.result();
<span class="udiff-line-modified-removed">-                 if (returnValue == null &amp;&amp; replacee.usages().isNotEmpty() &amp;&amp; replacee instanceof MemoryCheckpoint) {</span>
<span class="udiff-line-modified-added">+                 if (returnValue == null &amp;&amp; replacee.usages().isNotEmpty() &amp;&amp; replacee instanceof MemoryKill) {</span>
                      replacer.replace(replacee, null);
                  } else {
                      assert returnValue != null || replacee.hasNoUsages();
                      replacer.replace(replacee, returnValue);
                  }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1788,11 +1792,11 @@</span>
                  assert checkConstantArgument(metaAccess, method, signature, i - offset, args.info.getParameterName(i), args.values[i], kind);
  
              } else if (args.info.isVarargsParameter(i)) {
                  assert args.values[i] instanceof Varargs;
                  Varargs varargs = (Varargs) args.values[i];
<span class="udiff-line-modified-removed">-                 assert checkVarargs(metaAccess, method, signature, i, args.info.getParameterName(i), varargs);</span>
<span class="udiff-line-modified-added">+                 assert checkVarargs(metaAccess, method, signature, i - offset, args.info.getParameterName(i), varargs);</span>
              }
          }
          return true;
      }
  
</pre>
<center><a href="PEGraphDecoder.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="StandardGraphBuilderPlugins.java.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>