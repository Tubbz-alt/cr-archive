<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff src/hotspot/share/opto/macro.cpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
  </head>
<body>
<center><a href="loopopts.cpp.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="macro.hpp.cdiff.html" target="_top">next &gt;</a></center>    <h2>src/hotspot/share/opto/macro.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 33,10 ***</span>
<span class="line-new-header">--- 33,11 ---</span>
  #include &quot;opto/castnode.hpp&quot;
  #include &quot;opto/cfgnode.hpp&quot;
  #include &quot;opto/compile.hpp&quot;
  #include &quot;opto/convertnode.hpp&quot;
  #include &quot;opto/graphKit.hpp&quot;
<span class="line-added">+ #include &quot;opto/intrinsicnode.hpp&quot;</span>
  #include &quot;opto/locknode.hpp&quot;
  #include &quot;opto/loopnode.hpp&quot;
  #include &quot;opto/macro.hpp&quot;
  #include &quot;opto/memnode.hpp&quot;
  #include &quot;opto/narrowptrnode.hpp&quot;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 44,13 ***</span>
<span class="line-new-header">--- 45,15 ---</span>
  #include &quot;opto/opaquenode.hpp&quot;
  #include &quot;opto/phaseX.hpp&quot;
  #include &quot;opto/rootnode.hpp&quot;
  #include &quot;opto/runtime.hpp&quot;
  #include &quot;opto/subnode.hpp&quot;
<span class="line-added">+ #include &quot;opto/subtypenode.hpp&quot;</span>
  #include &quot;opto/type.hpp&quot;
  #include &quot;runtime/sharedRuntime.hpp&quot;
  #include &quot;utilities/macros.hpp&quot;
<span class="line-added">+ #include &quot;utilities/powerOfTwo.hpp&quot;</span>
  #if INCLUDE_G1GC
  #include &quot;gc/g1/g1ThreadLocalData.hpp&quot;
  #endif // INCLUDE_G1GC
  #if INCLUDE_SHENANDOAHGC
  #include &quot;gc/shenandoah/c2/shenandoahBarrierSetC2.hpp&quot;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 2530,10 ***</span>
<span class="line-new-header">--- 2533,47 ---</span>
    mem_phi-&gt;init_req(2, mem);
    transform_later(mem_phi);
    _igvn.replace_node(_memproj_fallthrough, mem_phi);
  }
  
<span class="line-added">+ void PhaseMacroExpand::expand_subtypecheck_node(SubTypeCheckNode *check) {</span>
<span class="line-added">+   assert(check-&gt;in(SubTypeCheckNode::Control) == NULL, &quot;should be pinned&quot;);</span>
<span class="line-added">+   Node* bol = check-&gt;unique_out();</span>
<span class="line-added">+   Node* obj_or_subklass = check-&gt;in(SubTypeCheckNode::ObjOrSubKlass);</span>
<span class="line-added">+   Node* superklass = check-&gt;in(SubTypeCheckNode::SuperKlass);</span>
<span class="line-added">+   assert(bol-&gt;is_Bool() &amp;&amp; bol-&gt;as_Bool()-&gt;_test._test == BoolTest::ne, &quot;unexpected bool node&quot;);</span>
<span class="line-added">+ </span>
<span class="line-added">+   for (DUIterator_Last imin, i = bol-&gt;last_outs(imin); i &gt;= imin; --i) {</span>
<span class="line-added">+     Node* iff = bol-&gt;last_out(i);</span>
<span class="line-added">+     assert(iff-&gt;is_If(), &quot;where&#39;s the if?&quot;);</span>
<span class="line-added">+ </span>
<span class="line-added">+     if (iff-&gt;in(0)-&gt;is_top()) {</span>
<span class="line-added">+       _igvn.replace_input_of(iff, 1, C-&gt;top());</span>
<span class="line-added">+       continue;</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
<span class="line-added">+     Node* iftrue = iff-&gt;as_If()-&gt;proj_out(1);</span>
<span class="line-added">+     Node* iffalse = iff-&gt;as_If()-&gt;proj_out(0);</span>
<span class="line-added">+     Node* ctrl = iff-&gt;in(0);</span>
<span class="line-added">+ </span>
<span class="line-added">+     Node* subklass = NULL;</span>
<span class="line-added">+     if (_igvn.type(obj_or_subklass)-&gt;isa_klassptr()) {</span>
<span class="line-added">+       subklass = obj_or_subklass;</span>
<span class="line-added">+     } else {</span>
<span class="line-added">+       Node* k_adr = basic_plus_adr(obj_or_subklass, oopDesc::klass_offset_in_bytes());</span>
<span class="line-added">+       subklass = _igvn.transform(LoadKlassNode::make(_igvn, NULL, C-&gt;immutable_memory(), k_adr, TypeInstPtr::KLASS));</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
<span class="line-added">+     Node* not_subtype_ctrl = Phase::gen_subtype_check(subklass, superklass, &amp;ctrl, NULL, _igvn);</span>
<span class="line-added">+ </span>
<span class="line-added">+     _igvn.replace_input_of(iff, 0, C-&gt;top());</span>
<span class="line-added">+     _igvn.replace_node(iftrue, not_subtype_ctrl);</span>
<span class="line-added">+     _igvn.replace_node(iffalse, ctrl);</span>
<span class="line-added">+   }</span>
<span class="line-added">+   _igvn.replace_node(check, C-&gt;top());</span>
<span class="line-added">+ }</span>
<span class="line-added">+ </span>
  //---------------------------eliminate_macro_nodes----------------------
  // Eliminate scalar replaced allocations and associated locks.
  void PhaseMacroExpand::eliminate_macro_nodes() {
    if (C-&gt;macro_count() == 0)
      return;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 2586,10 ***</span>
<span class="line-new-header">--- 2626,12 ---</span>
          break;
        case Node::Class_ArrayCopy:
          break;
        case Node::Class_OuterStripMinedLoop:
          break;
<span class="line-added">+       case Node::Class_SubTypeCheck:</span>
<span class="line-added">+         break;</span>
        default:
          assert(n-&gt;Opcode() == Op_LoopLimit ||
                 n-&gt;Opcode() == Op_Opaque1   ||
                 n-&gt;Opcode() == Op_Opaque2   ||
                 n-&gt;Opcode() == Op_Opaque3   ||
</pre>
<hr />
<pre>
<span class="line-old-header">*** 2692,10 ***</span>
<span class="line-new-header">--- 2734,14 ---</span>
        break;
      case Node::Class_ArrayCopy:
        expand_arraycopy_node(n-&gt;as_ArrayCopy());
        assert(C-&gt;macro_count() == (old_macro_count - 1), &quot;expansion must have deleted one node from macro list&quot;);
        break;
<span class="line-added">+     case Node::Class_SubTypeCheck:</span>
<span class="line-added">+       expand_subtypecheck_node(n-&gt;as_SubTypeCheck());</span>
<span class="line-added">+       assert(C-&gt;macro_count() == (old_macro_count - 1), &quot;expansion must have deleted one node from macro list&quot;);</span>
<span class="line-added">+       break;</span>
      }
      if (C-&gt;failing())  return true;
    }
  
    // All nodes except Allocate nodes are expanded now. There could be
</pre>
<center><a href="loopopts.cpp.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="macro.hpp.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>