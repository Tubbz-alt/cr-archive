<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>New make/scripts/compare.sh</title>
    <link rel="stylesheet" href="../../style.css" />
  </head>
  <body>
    <pre>
   1 #!/bin/bash
   2 #
   3 # Copyright (c) 2012, 2020, Oracle and/or its affiliates. All rights reserved.
   4 # DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   5 #
   6 # This code is free software; you can redistribute it and/or modify it
   7 # under the terms of the GNU General Public License version 2 only, as
   8 # published by the Free Software Foundation.
   9 #
  10 # This code is distributed in the hope that it will be useful, but WITHOUT
  11 # ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  12 # FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  13 # version 2 for more details (a copy is included in the LICENSE file that
  14 # accompanied this code).
  15 #
  16 # You should have received a copy of the GNU General Public License version
  17 # 2 along with this work; if not, write to the Free Software Foundation,
  18 # Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  19 #
  20 # Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  21 # or visit www.oracle.com if you need additional information or have any
  22 # questions.
  23 #
  24 
  25 # This script is processed by configure before it&#39;s usable. It is run from
  26 # the root of the build directory.
  27 
  28 
  29 ################################################################################
  30 
  31 # Check that we are run via the wrapper generated by configure
  32 if [ -z &quot;$TOPDIR&quot; ]; then
  33     echo &quot;Error: You must run this script using build/[conf]/compare.sh&quot;
  34     exit 1
  35 fi
  36 
  37 # Make sure all shell commands are executed with the C locale
  38 export LC_ALL=C
  39 
  40 if [ &quot;$OPENJDK_TARGET_OS&quot; = &quot;macosx&quot; ]; then
  41     FULLDUMP_CMD=&quot;$OTOOL -v -V -h -X -d&quot;
  42     LDD_CMD=&quot;$OTOOL -L&quot;
  43     DIS_CMD=&quot;$OTOOL -v -V -t&quot;
  44     STAT_PRINT_SIZE=&quot;-f %z&quot;
  45 elif [ &quot;$OPENJDK_TARGET_OS&quot; = &quot;windows&quot; ]; then
  46     FULLDUMP_CMD=&quot;$DUMPBIN -all&quot;
  47     LDD_CMD=&quot;$DUMPBIN -dependents&quot;
  48     DIS_CMD=&quot;$DUMPBIN -disasm:nobytes&quot;
  49     STAT_PRINT_SIZE=&quot;-c %s&quot;
  50 elif [ &quot;$OPENJDK_TARGET_OS&quot; = &quot;aix&quot; ]; then
  51     FULLDUMP_CMD=&quot;dump -h -r -t -n -X64&quot;
  52     LDD_CMD=&quot;$LDD&quot;
  53     DIS_CMD=&quot;$OBJDUMP -d&quot;
  54     STAT_PRINT_SIZE=&quot;-c %s&quot;
  55 else
  56     FULLDUMP_CMD=&quot;$READELF -a&quot;
  57     LDD_CMD=&quot;$LDD&quot;
  58     DIS_CMD=&quot;$OBJDUMP -d&quot;
  59     STAT_PRINT_SIZE=&quot;-c %s&quot;
  60 fi
  61 
  62 COMPARE_EXCEPTIONS_INCLUDE=&quot;$TOPDIR/make/scripts/compare_exceptions.sh.incl&quot;
  63 if [ ! -e &quot;$COMPARE_EXCEPTIONS_INCLUDE&quot; ]; then
  64     echo &quot;Error: Cannot locate the exceptions file, it should have been here: $COMPARE_EXCEPTIONS_INCLUDE&quot;
  65     exit 1
  66 fi
  67 # Include exception definitions
  68 . &quot;$COMPARE_EXCEPTIONS_INCLUDE&quot;
  69 
  70 ################################################################################
  71 #
  72 # Disassembly diff filters. These filters try to filter out ephemeral parts of the
  73 # disassembly, such as hard-coded addresses, to be able to catch &quot;actual&quot; differences.
  74 
  75 if [ &quot;$OPENJDK_TARGET_OS&quot; = &quot;solaris&quot; ]; then
  76   if [ &quot;$OPENJDK_TARGET_CPU&quot; = &quot;sparcv9&quot; ]; then
  77     DIS_DIFF_FILTER=&quot;$SED \
  78         -e &#39;s/^[0-9a-f]\{16\}/&lt;ADDR&gt;:/&#39; \
  79         -e &#39;s/^ *[0-9a-f]\{3,12\}:/  &lt;ADDR&gt;:/&#39; \
  80         -e &#39;s/:	[0-9a-f][0-9a-f]\( [0-9a-f][0-9a-f]\)\{2,10\}/:	&lt;NUMS&gt;/&#39; \
  81         -e &#39;s/\$[a-zA-Z0-9_\$]\{15\}\./&lt;SYM&gt;./&#39; \
  82         -e &#39;s/, [0-9a-fx\-]\{1,8\}/, &lt;ADDR&gt;/g&#39; \
  83         -e &#39;s/0x[0-9a-f]\{1,8\}/&lt;HEX&gt;/g&#39; \
  84         -e &#39;s/\! [0-9a-f]\{1,8\} /! &lt;ADDR&gt; /&#39; \
  85         -e &#39;s/call  [0-9a-f]\{4,7\}/call  &lt;ADDR&gt;/&#39; \
  86         -e &#39;s/%hi(0),/%hi(&lt;HEX&gt;),/&#39; \
  87         &quot;
  88   elif [ &quot;$OPENJDK_TARGET_CPU&quot; = &quot;x86_64&quot; ]; then
  89     # Random strings looking like this differ: &lt;.XAKoKoPIac2W0OA.
  90     DIS_DIFF_FILTER=&quot;$SED \
  91         -e &#39;s/&lt;\.[A-Za-z0-9]\{\15}\./&lt;.SYM./&#39; \
  92         &quot;
  93   fi
  94 elif [ &quot;$OPENJDK_TARGET_OS&quot; = &quot;windows&quot; ]; then
  95   if [ &quot;$OPENJDK_TARGET_CPU&quot; = &quot;x86&quot; ]; then
  96     DIS_DIFF_FILTER=&quot;$SED -r \
  97         -e &#39;s/^  [0-9A-F]{16}: //&#39; \
  98         -e &#39;s/^  [0-9A-F]{8}: /  &lt;ADDR&gt;: /&#39; \
  99         -e &#39;s/(offset \?\?)_C@_.*/\1&lt;SYM&gt;/&#39; \
 100         -e &#39;s/[@?][A-Za-z0-9_]{1,25}/&lt;SYM&gt;/&#39; \
 101         -e &#39;s/([-,+])[0-9A-F]{2,16}/\1&lt;HEXSTR&gt;/g&#39; \
 102         -e &#39;s/\[[0-9A-F]{4,16}h\]/[&lt;HEXSTR&gt;]/&#39; \
 103         -e &#39;s/: ([a-z]{2}[a-z ]{2})        [0-9A-F]{2,16}h?$/: \1        &lt;HEXSTR&gt;/&#39; \
 104         -e &#39;s/_20[0-9]{2}_[0-1][0-9]_[0-9]{2}/_&lt;DATE&gt;/&#39; \
 105         &quot;
 106   elif [ &quot;$OPENJDK_TARGET_CPU&quot; = &quot;x86_64&quot; ]; then
 107     DIS_DIFF_FILTER=&quot;$SED -r \
 108         -e &#39;s/^  [0-9A-F]{16}: //&#39; \
 109         -e &#39;s/\[[0-9A-F]{4,16}h\]/[&lt;HEXSTR&gt;]/&#39; \
 110         -e &#39;s/([,+])[0-9A-F]{2,16}h/\1&lt;HEXSTR&gt;/&#39; \
 111         -e &#39;s/([a-z]{2}[a-z ]{2})        [0-9A-F]{4,16}$/\1        &lt;HEXSTR&gt;/&#39; \
 112         -e &#39;s/\[\?\?_C@_.*/[&lt;SYM&gt;]/&#39; \
 113         &quot;
 114   fi
 115 elif [ &quot;$OPENJDK_TARGET_OS&quot; = &quot;macosx&quot; ]; then
 116   DIS_DIFF_FILTER=&quot;$SED \
 117       -e &#39;s/0x[0-9a-f]\{3,16\}/&lt;HEXSTR&gt;/g&#39; -e &#39;s/^[0-9a-f]\{12,20\}/&lt;ADDR&gt;/&#39; \
 118       -e &#39;s/-20[0-9][0-9]-[0-1][0-9]-[0-3][0-9]-[0-2][0-9]\{5\}/&lt;DATE&gt;/g&#39; \
 119       -e &#39;s/), built on .*/), &lt;DATE&gt;/&#39; \
 120       &quot;
 121 fi
 122 
 123 ################################################################################
 124 # Compare text files and ignore specific differences:
 125 #
 126 #  * Timestamps in Java sources generated by idl2java
 127 #  * Sorting order and cleanup style in .properties files
 128 
 129 diff_text() {
 130     OTHER_FILE=$1
 131     THIS_FILE=$2
 132 
 133     SUFFIX=&quot;${THIS_FILE##*.}&quot;
 134     NAME=&quot;${THIS_FILE##*/}&quot;
 135 
 136     TMP=1
 137 
 138     if [[ &quot;$THIS_FILE&quot; = *&quot;META-INF/MANIFEST.MF&quot; ]]; then
 139         # Filter out date string, ant version and java version differences.
 140         TMP=$($DIFF $OTHER_FILE $THIS_FILE | \
 141             $GREP &#39;^[&lt;&gt;]&#39; | \
 142             $SED -e &#39;/[&lt;&gt;] Ant-Version: Apache Ant .*/d&#39; \
 143                  -e &#39;/[&lt;&gt;] Created-By: .* (Oracle [Corpatin)]*/d&#39; \
 144                  -e &#39;/[&lt;&gt;]  [Corpatin]*)/d&#39; \
 145                  -e &#39;/[&lt;&gt;].*[0-9]\{4\}_[0-9]\{2\}_[0-9]\{2\}_[0-9]\{2\}_[0-9]\{2\}-b[0-9]\{2\}.*/d&#39;)
 146     fi
 147     if test &quot;x$SUFFIX&quot; = &quot;xjava&quot;; then
 148         TMP=$($DIFF $OTHER_FILE $THIS_FILE | \
 149             $GREP &#39;^[&lt;&gt;]&#39; | \
 150             $SED -e &#39;/[&lt;&gt;] \* from.*\.idl/d&#39; \
 151                  -e &#39;/[&lt;&gt;] .*[0-9]\{4\}_[0-9]\{2\}_[0-9]\{2\}_[0-9]\{2\}_[0-9]\{2\}-b[0-9]\{2\}.*/d&#39; \
 152                  -e &#39;/[&lt;&gt;] .*[0-9]\{4\}-[0-9]\{2\}-[0-9]\{2\}-[0-9]\{6\}.*/d&#39; \
 153                  -e &#39;/[&lt;&gt;] \*.*[0-9]\{4\} \(at \)*[0-9][0-9]*:[0-9]\{2\}:[0-9]\{2\}.*/d&#39; \
 154                  -e &#39;/\/\/ Generated from input file.*/d&#39; \
 155                  -e &#39;/\/\/ This file was generated AUTOMATICALLY from a template file.*/d&#39; \
 156                  -e &#39;/\/\/ java GenerateCharacter.*/d&#39;)
 157     fi
 158     # Ignore date strings in class files.
 159     # Anonymous lambda classes get randomly assigned counters in their names.
 160     if test &quot;x$SUFFIX&quot; = &quot;xclass&quot;; then
 161         if [ &quot;$NAME&quot; = &quot;SystemModules\$all.class&quot; ] \
 162            || [ &quot;$NAME&quot; = &quot;SystemModules\$default.class&quot; ]; then
 163             # The SystemModules\$*.classes are not comparable as they contain the
 164             # module hashes which would require a whole other level of
 165             # reproducible builds to get reproducible. There is also random
 166             # order of map initialization.
 167             TMP=&quot;&quot;
 168         elif [ &quot;$NAME&quot; = &quot;module-info.class&quot; ]; then
 169             # The module-info.class have several issues with random ordering of
 170             # elements in HashSets.
 171             MODULES_CLASS_FILTER=&quot;$SED \
 172                 -e &#39;s/,$//&#39; \
 173                 -e &#39;s/;$//&#39; \
 174                 -e &#39;s/^ *[0-9]*://&#39; \
 175                 -e &#39;s/#[0-9]* */#/&#39; \
 176                 -e &#39;s/ *\/\// \/\//&#39; \
 177                 -e &#39;s/aload *[0-9]*/aload X/&#39; \
 178                 -e &#39;s/ldc_w/ldc  /&#39; \
 179                 | $SORT \
 180                 &quot;
 181             $JAVAP -c -constants -l -p &quot;${OTHER_FILE}&quot; \
 182                 | eval &quot;$MODULES_CLASS_FILTER&quot; &gt;  ${OTHER_FILE}.javap &amp;
 183             $JAVAP -c -constants -l -p &quot;${THIS_FILE}&quot; \
 184                 | eval &quot;$MODULES_CLASS_FILTER&quot; &gt; ${THIS_FILE}.javap &amp;
 185             wait
 186             TMP=$($DIFF ${OTHER_FILE}.javap ${THIS_FILE}.javap)
 187         # To improve performance when large diffs are found, do a rough filtering of classes
 188         # elibeble for these exceptions
 189         elif $GREP -R -e &#39;[0-9]\{4\}-[0-9]\{2\}-[0-9]\{2\}-[0-9]\{6\}&#39; \
 190                 -e &#39;lambda\$[a-zA-Z0-9]*\$[0-9]&#39; ${THIS_FILE} &gt; /dev/null
 191         then
 192             $JAVAP -c -constants -l -p &quot;${OTHER_FILE}&quot; &gt;  ${OTHER_FILE}.javap &amp;
 193             $JAVAP -c -constants -l -p &quot;${THIS_FILE}&quot; &gt; ${THIS_FILE}.javap &amp;
 194             wait
 195             TMP=$($DIFF ${OTHER_FILE}.javap ${THIS_FILE}.javap | \
 196                 $GREP &#39;^[&lt;&gt;]&#39; | \
 197                 $SED -e &#39;/[&lt;&gt;].*[0-9]\{4\}-[0-9]\{2\}-[0-9]\{2\}-[0-9]\{6\}.*/d&#39; \
 198                      -e &#39;/[&lt;&gt;].*lambda\$[a-zA-Z0-9]*\$[0-9]*/d&#39;)
 199         fi
 200     fi
 201     if test &quot;x$SUFFIX&quot; = &quot;xproperties&quot;; then
 202         # Filter out date string differences.
 203         TMP=$($DIFF $OTHER_FILE $THIS_FILE | \
 204             $GREP &#39;^[&lt;&gt;]&#39; | \
 205             $SED -e &#39;/[&lt;&gt;].*[0-9]\{4\}-[0-9]\{2\}-[0-9]\{2\}-[0-9]\{6\}.*/d&#39;)
 206     fi
 207     if test &quot;x$SUFFIX&quot; = &quot;xhtml&quot;; then
 208         # Some javadoc versions do not put quotes around font size
 209         HTML_FILTER=&quot;$SED \
 210             -e &#39;s/&lt;font size=-1&gt;/&lt;font size=\&quot;-1\&quot;&gt;/g&#39;&quot;
 211         $CAT $THIS_FILE | eval &quot;$HTML_FILTER&quot; &gt; $THIS_FILE.filtered
 212         $CAT $OTHER_FILE | eval &quot;$HTML_FILTER&quot; &gt; $OTHER_FILE.filtered
 213         TMP=$($DIFF $OTHER_FILE.filtered $THIS_FILE.filtered | \
 214             $GREP &#39;^[&lt;&gt;]&#39; | \
 215             $SED -e &#39;/[&lt;&gt;] &lt;!-- Generated by javadoc .* on .* --&gt;/d&#39; \
 216                  -e &#39;/[&lt;&gt;] &lt;meta name=&quot;date&quot; content=&quot;.*&quot;&gt;/d&#39; )
 217     fi
 218     if test &quot;$NAME&quot; = &quot;BenchmarkList&quot;; then
 219         $SORT $THIS_FILE &gt; $THIS_FILE.sorted
 220         $SORT $OTHER_FILE &gt; $OTHER_FILE.sorted
 221         TMP=$($DIFF $THIS_FILE.sorted $OTHER_FILE.sorted)
 222     fi
 223     if test -n &quot;$TMP&quot;; then
 224         echo Files $OTHER_FILE and $THIS_FILE differ
 225         return 1
 226     fi
 227 
 228     return 0
 229 }
 230 
 231 ################################################################################
 232 # Compare directory structure
 233 
 234 compare_dirs() {
 235     THIS_DIR=$1
 236     OTHER_DIR=$2
 237     WORK_DIR=$3
 238 
 239     mkdir -p $WORK_DIR
 240 
 241     (cd $OTHER_DIR &amp;&amp; $FIND . -type d | $SORT &gt; $WORK_DIR/dirs_other)
 242     (cd $THIS_DIR &amp;&amp; $FIND . -type d | $SORT &gt; $WORK_DIR/dirs_this)
 243 
 244     $DIFF $WORK_DIR/dirs_other $WORK_DIR/dirs_this &gt; $WORK_DIR/dirs_diff
 245 
 246     echo -n Directory structure...
 247     if [ -s $WORK_DIR/dirs_diff ]; then
 248         echo Differences found.
 249         REGRESSIONS=true
 250         # Differences in directories found.
 251         ONLY_OTHER=$($GREP &#39;&lt;&#39; $WORK_DIR/dirs_diff)
 252         if [ &quot;$ONLY_OTHER&quot; ]; then
 253             echo Only in $OTHER
 254             $GREP &#39;&lt;&#39; $WORK_DIR/dirs_diff | $SED &#39;s|&lt; ./|    |g&#39;
 255         fi
 256         ONLY_THIS=$($GREP &#39;&gt;&#39; $WORK_DIR/dirs_diff)
 257         if [ &quot;$ONLY_THIS&quot; ]; then
 258             echo Only in $THIS
 259             $GREP &#39;&gt;&#39; $WORK_DIR/dirs_diff | $SED &#39;s|&gt; ./|    |g&#39;
 260         fi
 261     else
 262         echo Identical!
 263     fi
 264 }
 265 
 266 
 267 ################################################################################
 268 # Compare file structure
 269 
 270 compare_files() {
 271     THIS_DIR=$1
 272     OTHER_DIR=$2
 273     WORK_DIR=$3
 274 
 275     $MKDIR -p $WORK_DIR
 276 
 277     (cd $OTHER_DIR &amp;&amp; $FIND . ! -type d | $SORT &gt; $WORK_DIR/files_other)
 278     (cd $THIS_DIR &amp;&amp; $FIND . ! -type d | $SORT &gt; $WORK_DIR/files_this)
 279 
 280     $DIFF $WORK_DIR/files_other $WORK_DIR/files_this &gt; $WORK_DIR/files_diff
 281 
 282     echo -n File names...
 283     if [ -s $WORK_DIR/files_diff ]; then
 284         echo Differences found.
 285         REGRESSIONS=true
 286         # Differences in files found.
 287         ONLY_OTHER=$($GREP &#39;&lt;&#39; $WORK_DIR/files_diff)
 288         if [ &quot;$ONLY_OTHER&quot; ]; then
 289             echo Only in $OTHER
 290             $GREP &#39;&lt;&#39; $WORK_DIR/files_diff | $SED &#39;s|&lt; ./|    |g&#39;
 291         fi
 292         ONLY_THIS=$($GREP &#39;&gt;&#39; $WORK_DIR/files_diff)
 293         if [ &quot;$ONLY_THIS&quot; ]; then
 294             echo Only in $THIS
 295             $GREP &#39;&gt;&#39; $WORK_DIR/files_diff | $SED &#39;s|&gt; ./|    |g&#39;
 296         fi
 297     else
 298         echo Identical!
 299     fi
 300 }
 301 
 302 
 303 ################################################################################
 304 # Compare permissions
 305 
 306 compare_permissions() {
 307     THIS_DIR=$1
 308     OTHER_DIR=$2
 309     WORK_DIR=$3
 310 
 311     mkdir -p $WORK_DIR
 312 
 313     echo -n Permissions...
 314     found=&quot;&quot;
 315     for f in `cd $OTHER_DIR &amp;&amp; $FIND . -type f`
 316     do
 317         if [ ! -f ${OTHER_DIR}/$f ]; then continue; fi
 318         if [ ! -f ${THIS_DIR}/$f ]; then continue; fi
 319         OP=`ls -l ${OTHER_DIR}/$f | awk &#39;{printf(&quot;%.10s\n&quot;, $1);}&#39;`
 320         TP=`ls -l ${THIS_DIR}/$f | awk &#39;{printf(&quot;%.10s\n&quot;, $1);}&#39;`
 321         if [ &quot;$OP&quot; != &quot;$TP&quot; ]
 322         then
 323             if [ -z &quot;$found&quot; ]; then echo ; found=&quot;yes&quot;; fi
 324             $PRINTF &quot;\tother: ${OP} this: ${TP}\t$f\n&quot;
 325         fi
 326     done
 327     if [ -z &quot;$found&quot; ]; then
 328         echo &quot;Identical!&quot;
 329     else
 330         REGRESSIONS=true
 331     fi
 332 }
 333 
 334 ################################################################################
 335 # Compare file command output
 336 
 337 compare_file_types() {
 338     THIS_DIR=$1
 339     OTHER_DIR=$2
 340     WORK_DIR=$3
 341 
 342     $MKDIR -p $WORK_DIR
 343 
 344     FILE_TYPES_FILTER=&quot;$SED \
 345         -e &#39;s/BuildID[^,]*//&#39; \
 346         -e &#39;s/last modified: .*//&#39; \
 347         &quot;
 348 
 349     echo -n File types...
 350     found=&quot;&quot;
 351     # The file command does not know about jmod files and this sometimes results
 352     # in different types being detected more or less randomly.
 353     for f in $(cd $OTHER_DIR &amp;&amp; $FIND . ! -type d -a ! -name &quot;*.jmod&quot;)
 354     do
 355         if [ ! -f ${OTHER_DIR}/$f ]; then continue; fi
 356         if [ ! -f ${THIS_DIR}/$f ]; then continue; fi
 357         OF=$(cd ${OTHER_DIR} &amp;&amp; $FILE -h $f | eval $FILE_TYPES_FILTER)
 358         TF=$(cd ${THIS_DIR} &amp;&amp; $FILE -h $f | eval $FILE_TYPES_FILTER)
 359         if [ &quot;$OF&quot; != &quot;$TF&quot; ]
 360         then
 361             if [ &quot;`echo $OF | $GREP -c &#39;Zip archive data&#39;`&quot; -gt 0 ] \
 362                 &amp;&amp; [ &quot;`echo $TF | $GREP -c &#39;Zip archive data&#39;`&quot; -gt 0 ]
 363             then
 364                 # the way we produce zip-files make it so that directories are stored in
 365                 # old file but not in new (only files with full-path) this makes file
 366                 # report them as different
 367                 continue
 368             elif [ &quot;`echo $OF | $GREP -c &#39;MSVC program database ver 7.00&#39;`&quot; -gt 0 ] \
 369                      &amp;&amp; [ &quot;`echo $TF | $GREP -c &#39;MSVC program database ver 7.00&#39;`&quot; -gt 0 ]
 370             then
 371                 # For Windows pdb files the file command reports some kind of size data
 372                 # which may sometimes come out randomly different.
 373                 continue
 374             else
 375                 if [ -z &quot;$found&quot; ]; then echo ; found=&quot;yes&quot;; fi
 376                 $PRINTF &quot;\tother: ${OF}\n\tthis : ${TF}\n&quot;
 377             fi
 378         fi
 379     done
 380     if [ -z &quot;$found&quot; ]; then
 381         echo &quot;Identical!&quot;
 382     else
 383         REGRESSIONS=true
 384     fi
 385 }
 386 
 387 ################################################################################
 388 # Compare the rest of the files
 389 
 390 compare_general_files() {
 391     THIS_DIR=$1
 392     OTHER_DIR=$2
 393     WORK_DIR=$3
 394 
 395     GENERAL_FILES=$(cd $THIS_DIR &amp;&amp; $FIND . -type f ! -name &quot;*.so&quot; ! -name &quot;*.jar&quot; \
 396         ! -name &quot;*.zip&quot; ! -name &quot;*.debuginfo&quot; ! -name &quot;*.dylib&quot; ! -name &quot;jexec&quot; \
 397         ! -name &quot;modules&quot; ! -name &quot;ct.sym&quot; ! -name &quot;*.diz&quot; ! -name &quot;*.dll&quot; \
 398         ! -name &quot;*.cpl&quot; ! -name &quot;*.pdb&quot; ! -name &quot;*.exp&quot; ! -name &quot;*.ilk&quot; \
 399         ! -name &quot;*.lib&quot; ! -name &quot;*.war&quot; ! -name &quot;*.jmod&quot; ! -name &quot;*.exe&quot; \
 400         ! -name &quot;*.obj&quot; ! -name &quot;*.o&quot; ! -name &quot;jspawnhelper&quot; ! -name &quot;*.a&quot; \
 401         ! -name &quot;*.tar.gz&quot; ! -name &quot;classes.jsa&quot; ! -name &quot;gtestLauncher&quot; \
 402         ! -name &quot;*.map&quot; \
 403         | $GREP -v &quot;./bin/&quot;  | $SORT | $FILTER)
 404 
 405     echo Other files with binary differences...
 406     for f in $GENERAL_FILES
 407     do
 408         # Skip all files in test/*/native
 409         if [[ &quot;$f&quot; == */native/* ]]; then
 410             continue
 411         fi
 412         if [ -e $OTHER_DIR/$f ]; then
 413             SUFFIX=&quot;${f##*.}&quot;
 414             if [ &quot;$(basename $f)&quot; = &quot;release&quot; ]; then
 415                 # In release file, ignore differences in change numbers and order
 416                 # of modules in list.
 417                 OTHER_FILE=$WORK_DIR/$f.other
 418                 THIS_FILE=$WORK_DIR/$f.this
 419                 $MKDIR -p $(dirname $OTHER_FILE)
 420                 $MKDIR -p $(dirname $THIS_FILE)
 421                 RELEASE_FILTER=&quot;$SED \
 422                     -e &#39;s/\:[0-9a-f]\{12,12\}/:CHANGE/g&#39; \
 423                     -e &#39;s/[0-9]\{4\}-[0-9]\{2\}-[0-9]\{2\}-[0-9]\{6\}/&lt;DATE&gt;/g&#39; \
 424                     -e &#39;s/^#.*/#COMMENT/g&#39; \
 425                     -e &#39;s/MODULES=/MODULES=\&#39;$&#39;\n/&#39; \
 426                     -e &#39;s/,/\&#39;$&#39;\n/g&#39; \
 427                     | $SORT
 428                     &quot;
 429                 $CAT $OTHER_DIR/$f | eval &quot;$RELEASE_FILTER&quot; &gt; $OTHER_FILE
 430                 $CAT $THIS_DIR/$f  | eval &quot;$RELEASE_FILTER&quot; &gt; $THIS_FILE
 431             elif [ &quot;x$SUFFIX&quot; = &quot;xhtml&quot; ]; then
 432                 # Ignore time stamps in docs files
 433                 OTHER_FILE=$WORK_DIR/$f.other
 434                 THIS_FILE=$WORK_DIR/$f.this
 435                 $MKDIR -p $(dirname $OTHER_FILE) $(dirname $THIS_FILE)
 436                 # Older versions of compare might have left soft links with
 437                 # these names.
 438                 $RM $OTHER_FILE $THIS_FILE
 439                 #Note that | doesn&#39;t work on mac sed.
 440                 HTML_FILTER=&quot;$SED \
 441                     -e &#39;s/20[0-9]\{2\}-[0-9]\{2\}-[0-9]\{2\}-[0-9]\{6,7\}/&lt;DATE&gt;/g&#39; \
 442                     -e &#39;s/20[0-9]\{2\}-[0-9]\{2\}-[0-9]\{2\}/&lt;DATE&gt;/g&#39; \
 443                     -e &#39;s/\(-- Generated by javadoc \).*\( --\)/\1(removed)\2/&#39; \
 444                     -e &#39;s/[A-Z][a-z]*, [A-Z][a-z]* [0-9][0-9]*, [0-9]\{4\} [0-9][0-9:]* [AMP]\{2,2\} [A-Z][A-Z]*/&lt;DATE&gt;/&#39; \
 445                     -e &#39;s/from .*\.idl/\.idl/&#39; \
 446                     &quot;
 447                 $CAT $OTHER_DIR/$f | eval &quot;$HTML_FILTER&quot; &gt; $OTHER_FILE &amp;
 448                 $CAT $THIS_DIR/$f  | eval &quot;$HTML_FILTER&quot; &gt; $THIS_FILE &amp;
 449                 wait
 450             elif [ &quot;$SUFFIX&quot; = &quot;svg&quot; ]; then
 451                 # GraphViz has non-determinism when generating svg files
 452                 OTHER_FILE=$WORK_DIR/$f.other
 453                 THIS_FILE=$WORK_DIR/$f.this
 454                 $MKDIR -p $(dirname $OTHER_FILE) $(dirname $THIS_FILE)
 455                 SVG_FILTER=&quot;$SED \
 456                     -e &#39;s/edge[0-9][0-9]*/edgeX/g&#39;
 457                     &quot;
 458                 $CAT $OTHER_DIR/$f | eval &quot;$SVG_FILTER&quot; &gt; $OTHER_FILE
 459                 $CAT $THIS_DIR/$f | eval &quot;$SVG_FILTER&quot; &gt; $THIS_FILE
 460             elif [[ &quot;$f&quot; = *&quot;/lib/classlist&quot; ]] || [ &quot;$SUFFIX&quot; = &quot;jar_contents&quot; ]; then
 461                 # The classlist files may have some lines in random order
 462                 OTHER_FILE=$WORK_DIR/$f.other
 463                 THIS_FILE=$WORK_DIR/$f.this
 464                 $MKDIR -p $(dirname $OTHER_FILE) $(dirname $THIS_FILE)
 465                 $RM $OTHER_FILE $THIS_FILE
 466                 $CAT $OTHER_DIR/$f | $SORT &gt; $OTHER_FILE
 467                 $CAT $THIS_DIR/$f  | $SORT &gt; $THIS_FILE
 468             else
 469                 OTHER_FILE=$OTHER_DIR/$f
 470                 THIS_FILE=$THIS_DIR/$f
 471             fi
 472             DIFF_OUT=$($DIFF $OTHER_FILE $THIS_FILE 2&gt;&amp;1)
 473             if [ -n &quot;$DIFF_OUT&quot; ]; then
 474                 echo $f
 475                 REGRESSIONS=true
 476                 if [ &quot;$SHOW_DIFFS&quot; = &quot;true&quot; ]; then
 477                     echo &quot;$DIFF_OUT&quot;
 478                 fi
 479             fi
 480         fi
 481     done
 482 
 483 
 484 }
 485 
 486 ################################################################################
 487 # Compare zip file
 488 
 489 compare_zip_file() {
 490     THIS_DIR=$1
 491     OTHER_DIR=$2
 492     WORK_DIR=$3
 493     ZIP_FILE=$4
 494     # Optionally provide different name for other zipfile
 495     OTHER_ZIP_FILE=$5
 496 
 497     THIS_ZIP=$THIS_DIR/$ZIP_FILE
 498     if [ -n &quot;$OTHER_ZIP_FILE&quot; ]; then
 499         OTHER_ZIP=$OTHER_DIR/$OTHER_ZIP_FILE
 500     else
 501         OTHER_ZIP=$OTHER_DIR/$ZIP_FILE
 502     fi
 503 
 504     THIS_SUFFIX=&quot;${THIS_ZIP##*.}&quot;
 505     OTHER_SUFFIX=&quot;${OTHER_ZIP##*.}&quot;
 506     if [ &quot;$THIS_SUFFIX&quot; != &quot;$OTHER_SUFFIX&quot; ]; then
 507         echo &quot;The files do not have the same suffix type! ($THIS_SUFFIX != $OTHER_SUFFIX)&quot;
 508         return 2
 509     fi
 510 
 511     TYPE=&quot;$THIS_SUFFIX&quot;
 512 
 513     if $CMP $OTHER_ZIP $THIS_ZIP &gt; /dev/null
 514     then
 515         return 0
 516     fi
 517     # Not quite identical, the might still contain the same data.
 518     # Unpack the jar/zip files in temp dirs
 519 
 520     THIS_UNZIPDIR=$WORK_DIR/$ZIP_FILE.this
 521     OTHER_UNZIPDIR=$WORK_DIR/$ZIP_FILE.other
 522     $RM -rf $THIS_UNZIPDIR $OTHER_UNZIPDIR
 523     $MKDIR -p $THIS_UNZIPDIR
 524     $MKDIR -p $OTHER_UNZIPDIR
 525     if [ &quot;$TYPE&quot; = &quot;jar&quot; -o &quot;$TYPE&quot; = &quot;war&quot; -o &quot;$TYPE&quot; = &quot;zip&quot; ]
 526     then
 527         (cd $THIS_UNZIPDIR &amp;&amp; $UNARCHIVE $THIS_ZIP)
 528         (cd $OTHER_UNZIPDIR &amp;&amp; $UNARCHIVE $OTHER_ZIP)
 529     elif [ &quot;$TYPE&quot; = &quot;gz&quot; ]
 530     then
 531         (cd $THIS_UNZIPDIR &amp;&amp; $GUNZIP -c $THIS_ZIP | $TAR xf -)
 532         (cd $OTHER_UNZIPDIR &amp;&amp; $GUNZIP -c $OTHER_ZIP | $TAR xf -)
 533     elif [ &quot;$TYPE&quot; = &quot;jmod&quot; ]
 534     then
 535         (cd $THIS_UNZIPDIR &amp;&amp; $JMOD extract $THIS_ZIP)
 536         (cd $OTHER_UNZIPDIR &amp;&amp; $JMOD extract $OTHER_ZIP)
 537     else
 538         (cd $THIS_UNZIPDIR &amp;&amp; $JIMAGE extract $THIS_ZIP)
 539         (cd $OTHER_UNZIPDIR &amp;&amp; $JIMAGE extract $OTHER_ZIP)
 540     fi
 541 
 542     CONTENTS_DIFF_FILE=$WORK_DIR/$ZIP_FILE.diff
 543     # On solaris, there is no -q option.
 544     if [ &quot;$OPENJDK_TARGET_OS&quot; = &quot;solaris&quot; ]; then
 545         $DIFF -r $OTHER_UNZIPDIR $THIS_UNZIPDIR \
 546             | $GREP -v -e &quot;^&lt;&quot; -e &quot;^&gt;&quot; -e &quot;^Common subdirectories:&quot; \
 547             &gt; $CONTENTS_DIFF_FILE
 548     else
 549         $DIFF -rq $OTHER_UNZIPDIR $THIS_UNZIPDIR &gt; $CONTENTS_DIFF_FILE
 550     fi
 551 
 552     ONLY_OTHER=$($GREP &quot;^Only in $OTHER_UNZIPDIR&quot; $CONTENTS_DIFF_FILE)
 553     ONLY_THIS=$($GREP &quot;^Only in $THIS_UNZIPDIR&quot; $CONTENTS_DIFF_FILE)
 554 
 555     return_value=0
 556 
 557     if [ -n &quot;$ONLY_OTHER&quot; ]; then
 558         echo &quot;        Only OTHER $ZIP_FILE contains:&quot;
 559         echo &quot;$ONLY_OTHER&quot; | sed &quot;s|Only in $OTHER_UNZIPDIR|            |&quot;g | sed &#39;s|: |/|g&#39;
 560         return_value=1
 561     fi
 562 
 563     if [ -n &quot;$ONLY_THIS&quot; ]; then
 564         echo &quot;        Only THIS $ZIP_FILE contains:&quot;
 565         echo &quot;$ONLY_THIS&quot; | sed &quot;s|Only in $THIS_UNZIPDIR|            |&quot;g | sed &#39;s|: |/|g&#39;
 566         return_value=1
 567     fi
 568 
 569     if [ &quot;$CMP_ZIPS_CONTENTS&quot; = &quot;true&quot; ]; then
 570         if [ &quot;$OPENJDK_TARGET_OS&quot; = &quot;solaris&quot; ]; then
 571             DIFFING_FILES=$($GREP -e &#39;differ$&#39; -e &#39;^diff &#39; $CONTENTS_DIFF_FILE \
 572                 | $SED -e &#39;s/^Files //g&#39; -e &#39;s/diff -r //g&#39; | $CUT -f 1 -d &#39; &#39; \
 573                 | $SED &quot;s|$OTHER_UNZIPDIR/||g&quot;)
 574         else
 575             DIFFING_FILES=$($GREP -e &quot;differ$&quot; $CONTENTS_DIFF_FILE \
 576                 | $CUT -f 2 -d &#39; &#39; | $SED &quot;s|$OTHER_UNZIPDIR/||g&quot;)
 577         fi
 578 
 579         # Separate executable/library files from other files in zip.
 580         DIFFING_TEXT_FILES=
 581         DIFFING_EXEC_FILES=
 582         for file in $DIFFING_FILES; do
 583             SUFFIX=&quot;${file##*.}&quot;
 584             if [ &quot;$SUFFIX&quot; = &quot;exe&quot; -o &quot;$SUFFIX&quot; = &quot;dll&quot; -o &quot;$SUFFIX&quot; = &quot;so&quot; \
 585                  -o &quot;$SUFFIX&quot; = &quot;dylib&quot; ]; then
 586                 DIFFING_EXEC_FILES=&quot;$DIFFING_EXEC_FILES $file&quot;
 587             else
 588                 DIFFING_TEXT_FILES=&quot;$DIFFING_TEXT_FILES $file&quot;
 589             fi
 590         done
 591 
 592         $RM -f $WORK_DIR/$ZIP_FILE.diffs
 593         for file in $DIFFING_TEXT_FILES; do
 594             if [[ &quot;$ACCEPTED_JARZIP_CONTENTS $EXCEPTIONS&quot; != *&quot;$file&quot;* ]]; then
 595                 diff_text $OTHER_UNZIPDIR/$file $THIS_UNZIPDIR/$file &gt;&gt; $WORK_DIR/$ZIP_FILE.diffs
 596             fi
 597         done
 598 
 599         if [ -s &quot;$WORK_DIR/$ZIP_FILE.diffs&quot; ]; then
 600             return_value=1
 601             echo &quot;        Differing files in $ZIP_FILE&quot;
 602             $CAT $WORK_DIR/$ZIP_FILE.diffs | $GREP &#39;differ$&#39; | cut -f 2 -d &#39; &#39; | \
 603                 $SED &quot;s|$OTHER_UNZIPDIR|            |g&quot; &gt; $WORK_DIR/$ZIP_FILE.difflist
 604             $CAT $WORK_DIR/$ZIP_FILE.difflist
 605 
 606             if [ -n &quot;$SHOW_DIFFS&quot; ]; then
 607                 for i in $(cat $WORK_DIR/$ZIP_FILE.difflist) ; do
 608                     if [ -f &quot;${OTHER_UNZIPDIR}/$i.javap&quot; ]; then
 609                         $DIFF ${OTHER_UNZIPDIR}/$i.javap ${THIS_UNZIPDIR}/$i.javap
 610                     elif [ -f &quot;${OTHER_UNZIPDIR}/$i.cleaned&quot; ]; then
 611                         $DIFF ${OTHER_UNZIPDIR}/$i.cleaned ${THIS_UNZIPDIR}/$i
 612                     else
 613                         $DIFF ${OTHER_UNZIPDIR}/$i ${THIS_UNZIPDIR}/$i
 614                     fi
 615                 done
 616             fi
 617         fi
 618 
 619         # Use the compare_bin_file function for comparing the executable files.
 620         for file in $DIFFING_EXEC_FILES; do
 621             compare_bin_file $THIS_UNZIPDIR $OTHER_UNZIPDIR $WORK_DIR/$ZIP_FILE.bin \
 622                              $file
 623             if [ &quot;$?&quot; != &quot;0&quot; ]; then
 624                 return_value=1
 625             fi
 626         done
 627     fi
 628 
 629     return $return_value
 630 }
 631 
 632 ################################################################################
 633 # Compare jmod file
 634 
 635 compare_jmod_file() {
 636     THIS_DIR=$1
 637     OTHER_DIR=$2
 638     WORK_DIR=$3
 639     JMOD_FILE=$4
 640 
 641     THIS_JMOD=$THIS_DIR/$JMOD_FILE
 642     OTHER_JMOD=$OTHER_DIR/$JMOD_FILE
 643 
 644     if $CMP $OTHER_JMOD $THIS_JMOD &gt; /dev/null; then
 645         return 0
 646     fi
 647 
 648     THIS_JMOD_LIST=$WORK_DIR/$JMOD_FILE.list.this
 649     OTHER_JMOD_LIST=$WORK_DIR/$JMOD_FILE.list.other
 650     mkdir -p $(dirname $THIS_JMOD_LIST) $(dirname $OTHER_JMOD_LIST)
 651 
 652     $JMOD list $THIS_JMOD | sort &gt; $THIS_JMOD_LIST
 653     $JMOD list $OTHER_JMOD | sort &gt; $OTHER_JMOD_LIST
 654     JMOD_LIST_DIFF_FILE=$WORK_DIR/$JMOD_FILE.list.diff
 655     $DIFF $THIS_JMOD_LIST $OTHER_JMOD_LIST &gt; $JMOD_LIST_DIFF_FILE
 656 
 657     ONLY_THIS=$($GREP &quot;^&lt;&quot; $JMOD_LIST_DIFF_FILE)
 658     ONLY_OTHER=$($GREP &quot;^&gt;&quot; $JMOD_LIST_DIFF_FILE)
 659 
 660     if [ -n &quot;$ONLY_OTHER&quot; ]; then
 661         echo &quot;        Only OTHER $JMOD_FILE contains:&quot;
 662         echo &quot;$ONLY_OTHER&quot; | sed &quot;s|^&gt;|            |&quot;g | sed &#39;s|: |/|g&#39;
 663         return_value=1
 664     fi
 665 
 666     if [ -n &quot;$ONLY_THIS&quot; ]; then
 667         echo &quot;        Only THIS $JMOD_FILE contains:&quot;
 668         echo &quot;$ONLY_THIS&quot; | sed &quot;s|^&lt;|            |&quot;g | sed &#39;s|: |/|g&#39;
 669         return_value=1
 670     fi
 671 
 672     return $return_value
 673 }
 674 
 675 ################################################################################
 676 # Compare all zip files
 677 
 678 compare_all_zip_files() {
 679     THIS_DIR=$1
 680     OTHER_DIR=$2
 681     WORK_DIR=$3
 682 
 683     ZIPS=$(cd $THIS_DIR &amp;&amp; $FIND . -type f -name &quot;*.zip&quot; -o -name &quot;*.tar.gz&quot; \
 684         | $SORT | $FILTER )
 685 
 686     if [ -n &quot;$ZIPS&quot; ]; then
 687         echo Zip/tar.gz files...
 688 
 689         return_value=0
 690         for f in $ZIPS; do
 691             if [ -f &quot;$OTHER_DIR/$f&quot; ]; then
 692                 compare_zip_file $THIS_DIR $OTHER_DIR $WORK_DIR $f
 693                 if [ &quot;$?&quot; != &quot;0&quot; ]; then
 694                     return_value=1
 695                     REGRESSIONS=true
 696                 fi
 697             fi
 698         done
 699     fi
 700 
 701     return $return_value
 702 }
 703 
 704 ################################################################################
 705 # Compare all jmod files
 706 
 707 compare_all_jmod_files() {
 708     THIS_DIR=$1
 709     OTHER_DIR=$2
 710     WORK_DIR=$3
 711 
 712     JMODS=$(cd $THIS_DIR &amp;&amp; $FIND . -type f -name &quot;*.jmod&quot; | $SORT | $FILTER )
 713 
 714     if [ -n &quot;$JMODS&quot; ]; then
 715         echo Jmod files...
 716 
 717         return_value=0
 718         for f in $JMODS; do
 719             if [ -f &quot;$OTHER_DIR/$f&quot; ]; then
 720                 compare_jmod_file $THIS_DIR $OTHER_DIR $WORK_DIR $f
 721                 if [ &quot;$?&quot; != &quot;0&quot; ]; then
 722                     return_value=1
 723                     REGRESSIONS=true
 724                 fi
 725             fi
 726         done
 727     fi
 728 
 729     return $return_value
 730 }
 731 
 732 ################################################################################
 733 # Compare all jar files
 734 
 735 compare_all_jar_files() {
 736     THIS_DIR=$1
 737     OTHER_DIR=$2
 738     WORK_DIR=$3
 739 
 740     # TODO filter?
 741     ZIPS=$(cd $THIS_DIR &amp;&amp; $FIND . -type f -name &quot;*.jar&quot; -o -name &quot;*.war&quot; \
 742         -o -name &quot;modules&quot; | $SORT | $FILTER)
 743 
 744     if [ -n &quot;$ZIPS&quot; ]; then
 745         echo Jar files...
 746 
 747         return_value=0
 748         for f in $ZIPS; do
 749             if [ -f &quot;$OTHER_DIR/$f&quot; ]; then
 750                 compare_zip_file $THIS_DIR $OTHER_DIR $WORK_DIR $f
 751                 if [ &quot;$?&quot; != &quot;0&quot; ]; then
 752                     return_value=1
 753                     REGRESSIONS=true
 754                 fi
 755             fi
 756         done
 757     fi
 758 
 759     return $return_value
 760 }
 761 
 762 ################################################################################
 763 # Compare binary (executable/library) file
 764 
 765 compare_bin_file() {
 766     THIS_DIR=$1
 767     OTHER_DIR=$2
 768     WORK_DIR=$3
 769     BIN_FILE=$4
 770     OTHER_BIN_FILE=$5
 771 
 772     THIS_FILE=$THIS_DIR/$BIN_FILE
 773     if [ -n &quot;$OTHER_BIN_FILE&quot; ]; then
 774         OTHER_FILE=$OTHER_DIR/$OTHER_BIN_FILE
 775     else
 776         OTHER_FILE=$OTHER_DIR/$BIN_FILE
 777     fi
 778     NAME=$(basename $BIN_FILE)
 779     WORK_FILE_BASE=$WORK_DIR/$BIN_FILE
 780     FILE_WORK_DIR=$(dirname $WORK_FILE_BASE)
 781 
 782     $MKDIR -p $FILE_WORK_DIR
 783 
 784     # Make soft links to original files from work dir to facilitate debugging
 785     $LN -f -s $THIS_FILE $WORK_FILE_BASE.this
 786     $LN -f -s $OTHER_FILE $WORK_FILE_BASE.other
 787 
 788     ORIG_THIS_FILE=&quot;$THIS_FILE&quot;
 789     ORIG_OTHER_FILE=&quot;$OTHER_FILE&quot;
 790 
 791     if [ &quot;$STRIP_ALL&quot; = &quot;true&quot; ] || [[ &quot;$STRIP_BEFORE_COMPARE&quot; = *&quot;$BIN_FILE&quot;* ]]; then
 792         THIS_STRIPPED_FILE=$FILE_WORK_DIR/this/$NAME
 793         OTHER_STRIPPED_FILE=$FILE_WORK_DIR/other/$NAME
 794         $MKDIR -p $FILE_WORK_DIR/this $FILE_WORK_DIR/other
 795         $CP $THIS_FILE $THIS_STRIPPED_FILE
 796         $CP $OTHER_FILE $OTHER_STRIPPED_FILE
 797         $STRIP $THIS_STRIPPED_FILE
 798         $STRIP $OTHER_STRIPPED_FILE
 799         THIS_FILE=&quot;$THIS_STRIPPED_FILE&quot;
 800         OTHER_FILE=&quot;$OTHER_STRIPPED_FILE&quot;
 801     fi
 802 
 803     if [ &quot;$OPENJDK_TARGET_OS&quot; = &quot;windows&quot; ]; then
 804         unset _NT_SYMBOL_PATH
 805         if [ &quot;$(uname -o)&quot; = &quot;Cygwin&quot; ]; then
 806             THIS=$(cygpath -msa $THIS)
 807             OTHER=$(cygpath -msa $OTHER)
 808         fi
 809         # Build an _NT_SYMBOL_PATH that contains all known locations for
 810         # pdb files.
 811         PDB_DIRS=&quot;$(ls -d \
 812             {$OTHER,$THIS}/support/modules_{cmds,libs}/{*,*/*} \
 813             {$OTHER,$THIS}/support/native/jdk.incubator.jpackage/* \
 814             )&quot;
 815         export _NT_SYMBOL_PATH=&quot;$(echo $PDB_DIRS | tr &#39; &#39; &#39;;&#39;)&quot;
 816     fi
 817 
 818     if cmp $OTHER_FILE $THIS_FILE &gt; /dev/null; then
 819         # The files were bytewise identical.
 820         if [ -n &quot;$VERBOSE&quot; ]; then
 821             echo &quot;        :           :         :         :          :          : $BIN_FILE&quot;
 822         fi
 823         return 0
 824     fi
 825     if [ -z &quot;$SKIP_BIN_DIFF&quot; ]; then
 826         BIN_MSG=&quot; diff &quot;
 827         if [[ &quot;$ACCEPTED_BIN_DIFF&quot; != *&quot;$BIN_FILE&quot;* ]]; then
 828             DIFF_BIN=true
 829             if [[ &quot;$KNOWN_BIN_DIFF&quot; != *&quot;$BIN_FILE&quot;* ]]; then
 830                 BIN_MSG=&quot;*$BIN_MSG*&quot;
 831                 REGRESSIONS=true
 832             else
 833                 BIN_MSG=&quot; $BIN_MSG &quot;
 834             fi
 835         else
 836             BIN_MSG=&quot;($BIN_MSG)&quot;
 837             DIFF_BIN=
 838         fi
 839     else
 840         BIN_MSG=
 841         DIFF_BIN=
 842     fi
 843 
 844     if [ -n &quot;$STAT&quot; ]; then
 845         THIS_SIZE=$($STAT $STAT_PRINT_SIZE &quot;$THIS_FILE&quot;)
 846         OTHER_SIZE=$($STAT $STAT_PRINT_SIZE &quot;$OTHER_FILE&quot;)
 847     else
 848         THIS_SIZE=$(ls -l &quot;$THIS_FILE&quot; | awk &#39;{ print $5 }&#39;)
 849         OTHER_SIZE=$(ls -l &quot;$OTHER_FILE&quot; | awk &#39;{ print $5 }&#39;)
 850     fi
 851     if [ $THIS_SIZE -ne $OTHER_SIZE ]; then
 852         DIFF_SIZE_NUM=$($EXPR $THIS_SIZE - $OTHER_SIZE)
 853         DIFF_SIZE_REL=$($EXPR $THIS_SIZE \* 100 / $OTHER_SIZE)
 854         SIZE_MSG=$($PRINTF &quot;%3d%% %4d&quot; $DIFF_SIZE_REL $DIFF_SIZE_NUM)
 855         if [[ &quot;$ACCEPTED_SMALL_SIZE_DIFF&quot; = *&quot;$BIN_FILE&quot;* || &quot;$ACCEPTED_SMALL_SIZE_DIFF&quot; = &quot;true&quot; ]] \
 856             &amp;&amp; [ &quot;$DIFF_SIZE_REL&quot; -gt 98 ] \
 857             &amp;&amp; [ &quot;$DIFF_SIZE_REL&quot; -lt 102 ]; then
 858             SIZE_MSG=&quot;($SIZE_MSG)&quot;
 859             DIFF_SIZE=
 860         elif [ &quot;$OPENJDK_TARGET_OS&quot; = &quot;windows&quot; ] \
 861             &amp;&amp; [[ &quot;$ACCEPTED_SMALL_SIZE_DIFF&quot; = *&quot;$BIN_FILE&quot;* ]] \
 862             &amp;&amp; [ &quot;$DIFF_SIZE_NUM&quot; = 512 ]; then
 863             # On windows, size of binaries increase in 512 increments.
 864             SIZE_MSG=&quot;($SIZE_MSG)&quot;
 865             DIFF_SIZE=
 866         elif [ &quot;$OPENJDK_TARGET_OS&quot; = &quot;windows&quot; ] \
 867             &amp;&amp; [[ &quot;$ACCEPTED_SMALL_SIZE_DIFF&quot; = *&quot;$BIN_FILE&quot;* ]] \
 868             &amp;&amp; [ &quot;$DIFF_SIZE_NUM&quot; = -512 ]; then
 869             # On windows, size of binaries increase in 512 increments.
 870             SIZE_MSG=&quot;($SIZE_MSG)&quot;
 871             DIFF_SIZE=
 872         else
 873             if [[ &quot;$ACCEPTED_SIZE_DIFF&quot; != *&quot;$BIN_FILE&quot;* ]]; then
 874                 DIFF_SIZE=true
 875                 if [[ &quot;$KNOWN_SIZE_DIFF&quot; != *&quot;$BIN_FILE&quot;* ]]; then
 876                     SIZE_MSG=&quot;*$SIZE_MSG*&quot;
 877                     REGRESSIONS=true
 878                 else
 879                     SIZE_MSG=&quot; $SIZE_MSG &quot;
 880                 fi
 881             else
 882                 SIZE_MSG=&quot;($SIZE_MSG)&quot;
 883                 DIFF_SIZE=
 884             fi
 885         fi
 886     else
 887         SIZE_MSG=&quot;           &quot;
 888         DIFF_SIZE=
 889         if [[ &quot;$KNOWN_SIZE_DIFF $ACCEPTED_SIZE_DIFF&quot; = *&quot;$BIN_FILE&quot;* ]]; then
 890             SIZE_MSG=&quot;     !     &quot;
 891         fi
 892     fi
 893 
 894     if [ &quot;$SORT_ALL_SYMBOLS&quot; = &quot;true&quot; ] || [[ &quot;$SORT_SYMBOLS&quot; = *&quot;$BIN_FILE&quot;* ]]; then
 895         SYM_SORT_CMD=&quot;sort&quot;
 896     else
 897         SYM_SORT_CMD=&quot;cat&quot;
 898     fi
 899 
 900     if [ -n &quot;$SYMBOLS_DIFF_FILTER&quot; ] &amp;&amp; [ -z &quot;$NEED_SYMBOLS_DIFF_FILTER&quot; ] \
 901             || [[ &quot;$NEED_SYMBOLS_DIFF_FILTER&quot; = *&quot;$BIN_FILE&quot;* ]]; then
 902         this_SYMBOLS_DIFF_FILTER=&quot;$SYMBOLS_DIFF_FILTER&quot;
 903     else
 904         this_SYMBOLS_DIFF_FILTER=&quot;$CAT&quot;
 905     fi
 906 
 907     # Check symbols
 908     if [ &quot;$OPENJDK_TARGET_OS&quot; = &quot;windows&quot; ]; then
 909         # The output from dumpbin on windows differs depending on if the debug symbol
 910         # files are still around at the location the binary is pointing too. Need
 911         # to filter out that extra information.
 912         $DUMPBIN -exports $OTHER_FILE | $GREP  -E &#39;^ +[0-9A-F]+ +[0-9A-F]+ [0-9A-F]+&#39; | sed &#39;s/ = .*//g&#39; | cut -c27- | $SYM_SORT_CMD &gt; $WORK_FILE_BASE.symbols.other
 913         $DUMPBIN -exports $THIS_FILE  | $GREP  -E &#39;^ +[0-9A-F]+ +[0-9A-F]+ [0-9A-F]+&#39; | sed &#39;s/ = .*//g&#39; | cut -c27- | $SYM_SORT_CMD &gt; $WORK_FILE_BASE.symbols.this
 914     elif [ &quot;$OPENJDK_TARGET_OS&quot; = &quot;solaris&quot; ]; then
 915         # Some symbols get seemingly random 15 character prefixes. Filter them out.
 916         $NM -a $ORIG_OTHER_FILE 2&gt; /dev/null | $GREP -v $NAME | $AWK &#39;{print $2, $3, $4, $5}&#39; | $SED &#39;s/^\([a-zA-Z] [\.\$]\)[a-zA-Z0-9_\$]\{15,15\}\./\1./g&#39; | $SYM_SORT_CMD &gt; $WORK_FILE_BASE.symbols.other
 917         $NM -a $ORIG_THIS_FILE  2&gt; /dev/null | $GREP -v $NAME | $AWK &#39;{print $2, $3, $4, $5}&#39; | $SED &#39;s/^\([a-zA-Z] [\.\$]\)[a-zA-Z0-9_\$]\{15,15\}\./\1./g&#39; | $SYM_SORT_CMD &gt; $WORK_FILE_BASE.symbols.this
 918     elif [ &quot;$OPENJDK_TARGET_OS&quot; = &quot;aix&quot; ]; then
 919         $OBJDUMP -T $ORIG_OTHER_FILE 2&gt; /dev/null | $GREP -v $NAME | $AWK &#39;{print $2, $3, $4, $5}&#39; | $SYM_SORT_CMD &gt; $WORK_FILE_BASE.symbols.other
 920         $OBJDUMP -T $ORIG_THIS_FILE  2&gt; /dev/null | $GREP -v $NAME | $AWK &#39;{print $2, $3, $4, $5}&#39; | $SYM_SORT_CMD &gt; $WORK_FILE_BASE.symbols.this
 921     elif [ &quot;$OPENJDK_TARGET_OS&quot; = &quot;macosx&quot; ]; then
 922         $NM -j $ORIG_OTHER_FILE 2&gt; /dev/null | $SYM_SORT_CMD &gt; $WORK_FILE_BASE.symbols.other
 923         $NM -j $ORIG_THIS_FILE  2&gt; /dev/null | $SYM_SORT_CMD &gt; $WORK_FILE_BASE.symbols.this
 924     else
 925         $NM -a $ORIG_OTHER_FILE 2&gt; /dev/null | $GREP -v $NAME \
 926             | $AWK &#39;{print $2, $3, $4, $5}&#39; \
 927             | eval &quot;$this_SYMBOLS_DIFF_FILTER&quot; \
 928             | $SYM_SORT_CMD \
 929             &gt; $WORK_FILE_BASE.symbols.other
 930         $NM -a $ORIG_THIS_FILE  2&gt; /dev/null | $GREP -v $NAME \
 931             | $AWK &#39;{print $2, $3, $4, $5}&#39; \
 932             | eval &quot;$this_SYMBOLS_DIFF_FILTER&quot; \
 933             | $SYM_SORT_CMD \
 934             &gt; $WORK_FILE_BASE.symbols.this
 935     fi
 936 
 937     $DIFF $WORK_FILE_BASE.symbols.other $WORK_FILE_BASE.symbols.this &gt; $WORK_FILE_BASE.symbols.diff
 938     if [ -s $WORK_FILE_BASE.symbols.diff ]; then
 939         SYM_MSG=&quot; diff  &quot;
 940         if [[ &quot;$ACCEPTED_SYM_DIFF&quot; != *&quot;$BIN_FILE&quot;* ]]; then
 941             DIFF_SYM=true
 942             if [[ &quot;$KNOWN_SYM_DIFF&quot; != *&quot;$BIN_FILE&quot;* ]]; then
 943                 SYM_MSG=&quot;*$SYM_MSG*&quot;
 944                 REGRESSIONS=true
 945             else
 946                 SYM_MSG=&quot; $SYM_MSG &quot;
 947             fi
 948         else
 949             SYM_MSG=&quot;($SYM_MSG)&quot;
 950             DIFF_SYM=
 951         fi
 952     else
 953         SYM_MSG=&quot;         &quot;
 954         DIFF_SYM=
 955         if [[ &quot;$KNOWN_SYM_DIFF $ACCEPTED_SYM_DIFF&quot; = *&quot;$BIN_FILE&quot;* ]]; then
 956             SYM_MSG=&quot;    !    &quot;
 957         fi
 958     fi
 959 
 960     # Check dependencies
 961     if [ -n &quot;$LDD_CMD&quot; ]; then
 962         if [ &quot;$OPENJDK_TARGET_OS&quot; = &quot;windows&quot; ]; then
 963             LDD_FILTER=&quot;$GREP \.dll&quot;
 964         else
 965             LDD_FILTER=&quot;$CAT&quot;
 966         fi
 967         (cd $FILE_WORK_DIR &amp;&amp; $CP $OTHER_FILE . &amp;&amp; $LDD_CMD $NAME 2&gt;/dev/null \
 968                     | $LDD_FILTER | $AWK &#39;{ print $1;}&#39; | $SORT \
 969                     | $TEE $WORK_FILE_BASE.deps.other \
 970                     | $UNIQ &gt; $WORK_FILE_BASE.deps.other.uniq)
 971         (cd $FILE_WORK_DIR &amp;&amp; $CP $THIS_FILE . &amp;&amp; $LDD_CMD $NAME 2&lt;/dev/null \
 972                     | $LDD_FILTER | $AWK &#39;{ print $1;}&#39; | $SORT \
 973                     | $TEE $WORK_FILE_BASE.deps.this \
 974                     | $UNIQ &gt; $WORK_FILE_BASE.deps.this.uniq)
 975         (cd $FILE_WORK_DIR &amp;&amp; $RM -f $NAME)
 976 
 977         $DIFF $WORK_FILE_BASE.deps.other $WORK_FILE_BASE.deps.this \
 978               &gt; $WORK_FILE_BASE.deps.diff
 979         $DIFF $WORK_FILE_BASE.deps.other.uniq $WORK_FILE_BASE.deps.this.uniq \
 980               &gt; $WORK_FILE_BASE.deps.diff.uniq
 981 
 982         if [ -s $WORK_FILE_BASE.deps.diff ]; then
 983             if [ -s $WORK_FILE_BASE.deps.diff.uniq ]; then
 984                 DEP_MSG=&quot; diff  &quot;
 985             else
 986                 DEP_MSG=&quot; redun &quot;
 987             fi
 988             if [[ &quot;$ACCEPTED_DEP_DIFF&quot; != *&quot;$BIN_FILE&quot;* ]]; then
 989                 DIFF_DEP=true
 990                 if [[ &quot;$KNOWN_DEP_DIFF&quot; != *&quot;$BIN_FILE&quot;* ]]; then
 991                     DEP_MSG=&quot;*$DEP_MSG*&quot;
 992                     REGRESSIONS=true
 993                 else
 994                     DEP_MSG=&quot; $DEP_MSG &quot;
 995                 fi
 996             else
 997                 DEP_MSG=&quot;($DEP_MSG)&quot;
 998                 DIFF_DEP=
 999             fi
1000         else
1001             DEP_MSG=&quot;         &quot;
1002             DIFF_DEP=
1003             if [[ &quot;$KNOWN_DEP_DIFF $ACCEPTED_DEP_DIFF&quot; = *&quot;$BIN_FILE&quot;* ]]; then
1004                 DEP_MSG=&quot;     !      &quot;
1005             fi
1006         fi
1007     else
1008         DEP_MSG=&quot;    -    &quot;
1009     fi
1010 
1011     # Some linux compilers add a unique Build ID
1012     if [ &quot;$OPENJDK_TARGET_OS&quot; = &quot;linux&quot; ]; then
1013       BUILD_ID_FILTER=&quot;$SED -r &#39;s/(Build ID:) [0-9a-f]{40}/\1/&#39;&quot;
1014     else
1015       BUILD_ID_FILTER=&quot;$CAT&quot;
1016     fi
1017 
1018     # Compare fulldump output
1019     if [ -n &quot;$FULLDUMP_CMD&quot; ] &amp;&amp; [ -z &quot;$SKIP_FULLDUMP_DIFF&quot; ]; then
1020         if [ -z &quot;$FULLDUMP_DIFF_FILTER&quot; ]; then
1021             FULLDUMP_DIFF_FILTER=&quot;$CAT&quot;
1022         fi
1023         $FULLDUMP_CMD $OTHER_FILE | eval &quot;$BUILD_ID_FILTER&quot; | eval &quot;$FULLDUMP_DIFF_FILTER&quot; \
1024             &gt; $WORK_FILE_BASE.fulldump.other 2&gt;&amp;1 &amp;
1025         $FULLDUMP_CMD $THIS_FILE  | eval &quot;$BUILD_ID_FILTER&quot; | eval &quot;$FULLDUMP_DIFF_FILTER&quot; \
1026             &gt; $WORK_FILE_BASE.fulldump.this  2&gt;&amp;1 &amp;
1027         wait
1028 
1029         $DIFF $WORK_FILE_BASE.fulldump.other $WORK_FILE_BASE.fulldump.this \
1030             &gt; $WORK_FILE_BASE.fulldump.diff
1031 
1032         if [ -s $WORK_FILE_BASE.fulldump.diff ]; then
1033             FULLDUMP_DIFF_SIZE=$(ls -n $WORK_FILE_BASE.fulldump.diff | awk &#39;{print $5}&#39;)
1034             FULLDUMP_MSG=$($PRINTF &quot;%8d&quot; $FULLDUMP_DIFF_SIZE)
1035             if [[ &quot;$ACCEPTED_FULLDUMP_DIFF&quot; != *&quot;$BIN_FILE&quot;* ]]; then
1036                 DIFF_FULLDUMP=true
1037                 if [[ &quot;$KNOWN_FULLDUMP_DIFF&quot; != *&quot;$BIN_FILE&quot;* ]]; then
1038                     FULLDUMP_MSG=&quot;*$FULLDUMP_MSG*&quot;
1039                     REGRESSIONS=true
1040                 else
1041                     FULLDUMP_MSG=&quot; $FULLDUMP_MSG &quot;
1042                 fi
1043             else
1044                 FULLDUMP_MSG=&quot;($FULLDUMP_MSG)&quot;
1045                 DIFF_FULLDUMP=
1046             fi
1047         else
1048             FULLDUMP_MSG=&quot;          &quot;
1049             DIFF_FULLDUMP=
1050             if [[ &quot;$KNOWN_FULLDUMP_DIFF $ACCEPTED_FULLDUMP_DIFF&quot; = *&quot;$BIN_FILE&quot;* ]]; then
1051                 FULLDUMP_MSG=&quot;    !    &quot;
1052             fi
1053         fi
1054     fi
1055 
1056     # Compare disassemble output
1057     if [ -n &quot;$DIS_CMD&quot; ] &amp;&amp; [ -z &quot;$SKIP_DIS_DIFF&quot; ]; then
1058         this_DIS_DIFF_FILTER=&quot;$CAT&quot;
1059         if [ -n &quot;$DIS_DIFF_FILTER&quot; ]; then
1060             if [ -z &quot;$NEED_DIS_DIFF_FILTER&quot; ] \
1061                 || [[ &quot;$NEED_DIS_DIFF_FILTER&quot; = *&quot;$BIN_FILE&quot;* ]]; then
1062                 this_DIS_DIFF_FILTER=&quot;$DIS_DIFF_FILTER&quot;
1063             fi
1064         fi
1065         if [ &quot;$OPENJDK_TARGET_OS&quot; = &quot;windows&quot; ]; then
1066             DIS_GREP_ARG=-a
1067         else
1068             DIS_GREP_ARG=
1069         fi
1070         $DIS_CMD $OTHER_FILE | $GREP $DIS_GREP_ARG -v $NAME \
1071             | eval &quot;$this_DIS_DIFF_FILTER&quot; &gt; $WORK_FILE_BASE.dis.other 2&gt;&amp;1 &amp;
1072         $DIS_CMD $THIS_FILE  | $GREP $DIS_GREP_ARG -v $NAME \
1073             | eval &quot;$this_DIS_DIFF_FILTER&quot; &gt; $WORK_FILE_BASE.dis.this  2&gt;&amp;1 &amp;
1074         wait
1075 
1076         $DIFF $WORK_FILE_BASE.dis.other $WORK_FILE_BASE.dis.this &gt; $WORK_FILE_BASE.dis.diff
1077 
1078         if [ -s $WORK_FILE_BASE.dis.diff ]; then
1079             DIS_DIFF_SIZE=$(ls -n $WORK_FILE_BASE.dis.diff | awk &#39;{print $5}&#39;)
1080             DIS_MSG=$($PRINTF &quot;%8d&quot; $DIS_DIFF_SIZE)
1081             if [[ &quot;$ACCEPTED_DIS_DIFF&quot; != *&quot;$BIN_FILE&quot;* ]]; then
1082                 DIFF_DIS=true
1083                 if [ &quot;$MAX_KNOWN_DIS_DIFF_SIZE&quot; = &quot;&quot; ]; then
1084                     MAX_KNOWN_DIS_DIFF_SIZE=&quot;0&quot;
1085                 fi
1086                 if [[ &quot;$KNOWN_DIS_DIFF&quot; = *&quot;$BIN_FILE&quot;* ]] \
1087                     &amp;&amp; [ &quot;$DIS_DIFF_SIZE&quot; -lt &quot;$MAX_KNOWN_DIS_DIFF_SIZE&quot; ]; then
1088                     DIS_MSG=&quot; $DIS_MSG &quot;
1089                 else
1090                     DIS_MSG=&quot;*$DIS_MSG*&quot;
1091                     REGRESSIONS=true
1092                 fi
1093             else
1094                 DIS_MSG=&quot;($DIS_MSG)&quot;
1095                 DIFF_DIS=
1096             fi
1097         else
1098             DIS_MSG=&quot;          &quot;
1099             DIFF_DIS=
1100             if [[ &quot;$KNOWN_DEP_DIFF $ACCEPTED_DEP_DIFF&quot; = *&quot;$BIN_FILE&quot;* ]]; then
1101                 DIS_MSG=&quot;    !    &quot;
1102             fi
1103         fi
1104     fi
1105 
1106 
1107     if [ -n &quot;$DIFF_BIN$DIFF_SIZE$DIFF_SYM$DIFF_DEP$DIFF_FULLDUMP$DIFF_DIS&quot; ] || [ -n &quot;$VERBOSE&quot; ]; then
1108         if [ -n &quot;$BIN_MSG&quot; ]; then echo -n &quot;$BIN_MSG:&quot;; fi
1109         if [ -n &quot;$SIZE_MSG&quot; ]; then echo -n &quot;$SIZE_MSG:&quot;; fi
1110         if [ -n &quot;$SYM_MSG&quot; ]; then echo -n &quot;$SYM_MSG:&quot;; fi
1111         if [ -n &quot;$DEP_MSG&quot; ]; then echo -n &quot;$DEP_MSG:&quot;; fi
1112         if [ -n &quot;$FULLDUMP_MSG&quot; ]; then echo -n &quot;$FULLDUMP_MSG:&quot;; fi
1113         if [ -n &quot;$DIS_MSG&quot; ]; then echo -n &quot;$DIS_MSG:&quot;; fi
1114         echo &quot; $BIN_FILE&quot;
1115         if [ &quot;$SHOW_DIFFS&quot; = &quot;true&quot; ]; then
1116             if [ -s &quot;$WORK_FILE_BASE.symbols.diff&quot; ]; then
1117                 echo &quot;Symbols diff:&quot;
1118                 $CAT $WORK_FILE_BASE.symbols.diff
1119             fi
1120             if [ -s &quot;$WORK_FILE_BASE.deps.diff&quot; ]; then
1121                 echo &quot;Deps diff:&quot;
1122                 $CAT $WORK_FILE_BASE.deps.diff
1123             fi
1124             if [ -s &quot;$WORK_FILE_BASE.fulldump.diff&quot; ]; then
1125                 echo &quot;Fulldump diff:&quot;
1126                 $CAT $WORK_FILE_BASE.fulldump.diff
1127             fi
1128             if [ -s &quot;$WORK_FILE_BASE.dis.diff&quot; ]; then
1129                 echo &quot;Disassembly diff:&quot;
1130                 $CAT $WORK_FILE_BASE.dis.diff
1131             fi
1132         fi
1133         return 1
1134     fi
1135     return 0
1136 }
1137 
1138 ################################################################################
1139 # Print binary diff header
1140 
1141 print_binary_diff_header() {
1142     if [ -z &quot;$SKIP_BIN_DIFF&quot; ]; then echo -n &quot; Binary :&quot;; fi
1143     if [ -z &quot;$SKIP_SIZE_DIFF&quot; ]; then echo -n &quot;   Size    :&quot;; fi
1144     if [ -z &quot;$SKIP_SYM_DIFF&quot; ]; then echo -n &quot; Symbols :&quot;; fi
1145     if [ -z &quot;$SKIP_DEP_DIFF&quot; ]; then echo -n &quot;  Deps   :&quot;; fi
1146     if [ -z &quot;$SKIP_FULLDUMP_DIFF&quot; ]; then echo -n &quot; Fulldump :&quot;; fi
1147     if [ -z &quot;$SKIP_DIS_DIFF&quot; ]; then echo -n &quot; Disass   :&quot;; fi
1148     echo
1149 }
1150 
1151 ################################################################################
1152 # Compare all libraries
1153 
1154 compare_all_libs() {
1155     THIS_DIR=$1
1156     OTHER_DIR=$2
1157     WORK_DIR=$3
1158 
1159     LIBS=$(cd $THIS_DIR &amp;&amp; $FIND . -type f \( -name &#39;lib*.so&#39; -o -name &#39;*.dylib&#39; \
1160         -o -name &#39;*.dll&#39; -o -name &#39;*.obj&#39; -o -name &#39;*.o&#39; -o -name &#39;*.a&#39; \
1161         -o -name &#39;*.cpl&#39; \) | $SORT | $FILTER)
1162 
1163     # On macos, filter out the dSYM debug symbols files as they are also
1164     # named *.dylib.
1165     if [ &quot;$OPENJDK_TARGET_OS&quot; = &quot;macosx&quot; ]; then
1166         LIBS=$(echo &quot;$LIBS&quot; | $GREP -v &#39;\.dSYM/&#39;)
1167     fi
1168 
1169     if [ -n &quot;$LIBS&quot; ]; then
1170         echo Libraries...
1171         print_binary_diff_header
1172         for l in $LIBS; do
1173             if [ -f &quot;$OTHER_DIR/$l&quot; ]; then
1174                 compare_bin_file $THIS_DIR $OTHER_DIR $WORK_DIR $l
1175                 if [ &quot;$?&quot; != &quot;0&quot; ]; then
1176                     return_value=1
1177                 fi
1178             fi
1179         done
1180     fi
1181 
1182     return $return_value
1183 }
1184 
1185 ################################################################################
1186 # Compare all executables
1187 
1188 compare_all_execs() {
1189     THIS_DIR=$1
1190     OTHER_DIR=$2
1191     WORK_DIR=$3
1192 
1193     if [ &quot;$OPENJDK_TARGET_OS&quot; = &quot;windows&quot; ]; then
1194         EXECS=$(cd $THIS_DIR &amp;&amp; $FIND . -type f -name &#39;*.exe&#39; | $SORT | $FILTER)
1195     else
1196         EXECS=$(cd $THIS_DIR &amp;&amp; $FIND . -name db -prune -o -type f -perm -100 \! \
1197             \( -name &#39;*.so&#39; -o -name &#39;*.dylib&#39; -o -name &#39;*.dll&#39; -o -name &#39;*.cgi&#39; \
1198             -o -name &#39;*.jar&#39; -o -name &#39;*.diz&#39; -o -name &#39;jcontrol&#39; -o -name &#39;*.properties&#39; \
1199             -o -name &#39;*.data&#39; -o -name &#39;*.bfc&#39; -o -name &#39;*.src&#39; -o -name &#39;*.txt&#39; \
1200             -o -name &#39;*.cfg&#39; -o -name &#39;meta-index&#39; -o -name &#39;*.properties.ja&#39; \
1201             -o -name &#39;*.xml&#39; -o -name &#39;*.html&#39; -o -name &#39;*.png&#39; -o -name &#39;README&#39; \
1202             -o -name &#39;*.zip&#39; -o -name &#39;*.jimage&#39; -o -name &#39;*.java&#39; -o -name &#39;*.mf&#39; \
1203             -o -name &#39;*.jpg&#39; -o -name &#39;*.wsdl&#39; -o -name &#39;*.js&#39; -o -name &#39;*.sh&#39; \
1204             -o -name &#39;*.bat&#39; -o -name &#39;*LICENSE&#39; -o -name &#39;*.d&#39; -o -name &#39;*store&#39; \
1205             -o -name &#39;blacklist&#39; -o -name &#39;*certs&#39; -o -name &#39;*.ttf&#39; \
1206             -o -name &#39;*.jfc&#39; -o -name &#39;*.dat&#39;  -o -name &#39;release&#39; -o -name &#39;*.dir&#39;\
1207             -o -name &#39;*.sym&#39; -o -name &#39;*.idl&#39; -o -name &#39;*.h&#39; -o -name &#39;*.access&#39; \
1208             -o -name &#39;*.template&#39; -o -name &#39;*.policy&#39; -o -name &#39;*.security&#39; \
1209             -o -name &#39;COPYRIGHT&#39; -o -name &#39;*.1&#39; -o -name &#39;*.debuginfo&#39; \
1210             -o -name &#39;classlist&#39; \) | $SORT | $FILTER)
1211     fi
1212 
1213     if [ -n &quot;$EXECS&quot; ]; then
1214         echo Executables...
1215         print_binary_diff_header
1216         for e in $EXECS; do
1217             if [ -f &quot;$OTHER_DIR/$e&quot; ]; then
1218                 compare_bin_file $THIS_DIR $OTHER_DIR $WORK_DIR $e
1219                 if [ &quot;$?&quot; != &quot;0&quot; ]; then
1220                     return_value=1
1221                 fi
1222             fi
1223         done
1224     fi
1225 
1226     return $return_value
1227 }
1228 
1229 ################################################################################
1230 # Initiate configuration
1231 
1232 THIS=&quot;$SCRIPT_DIR&quot;
1233 echo &quot;$THIS&quot;
1234 THIS_SCRIPT=&quot;$0&quot;
1235 
1236 if [ -z &quot;$1&quot; ] || [ &quot;$1&quot; = &quot;-h&quot; ] || [ &quot;$1&quot; = &quot;-?&quot; ] || [ &quot;$1&quot; = &quot;/h&quot; ] || [ &quot;$1&quot; = &quot;/?&quot; ] || [ &quot;$1&quot; = &quot;-help&quot; ] || [ &quot;$1&quot; = &quot;--help&quot; ]; then
1237     echo &quot;bash ./compare.sh [OPTIONS] [FILTER]&quot;
1238     echo &quot;&quot;
1239     echo &quot;-all                Compare all files in all known ways&quot;
1240     echo &quot;-names              Compare the file names and directory structure&quot;
1241     echo &quot;-perms              Compare the permission bits on all files and directories&quot;
1242     echo &quot;-types              Compare the output of the file command on all files&quot;
1243     echo &quot;-general            Compare the files not convered by the specialized comparisons&quot;
1244     echo &quot;-zips               Compare the contents of all zip files and files in them&quot;
1245     echo &quot;-zips-names         Compare the file names inside all zip files&quot;
1246     echo &quot;-jars               Compare the contents of all jar files&quot;
1247     echo &quot;-jmods              Compare the listings of all jmod files&quot;
1248     echo &quot;-libs               Compare all native libraries&quot;
1249     echo &quot;-execs              Compare all executables&quot;
1250     echo &quot;-v                  Verbose output, does not hide known differences&quot;
1251     echo &quot;-vv                 More verbose output, shows diff output of all comparisons&quot;
1252     echo &quot;-o [OTHER]          Compare with build in other directory. Will default to the old build directory&quot;
1253     echo &quot;&quot;
1254     echo &quot;--sort-symbols      Sort all symbols before comparing&quot;
1255     echo &quot;--strip             Strip all binaries before comparing&quot;
1256     echo &quot;--clean             Clean all previous comparison results first&quot;
1257     echo &quot;&quot;
1258     echo &quot;[FILTER]            List filenames in the image to compare, works for jars, zips, libs and execs&quot;
1259     echo &quot;Example:&quot;
1260     echo &quot;bash ./make/scripts/compareimages.sh CodePointIM.jar&quot;
1261     echo &quot;&quot;
1262     echo &quot;-2zips &lt;file1&gt; &lt;file2&gt; Compare two zip files only&quot;
1263     echo &quot;-2bins &lt;file1&gt; &lt;file2&gt; Compare two binary files only&quot;
1264     echo &quot;-2dirs &lt;dir1&gt; &lt;dir2&gt; Compare two directories as if they were images&quot;
1265     echo &quot;&quot;
1266     exit 10
1267 fi
1268 
1269 CMP_NAMES=false
1270 CMP_PERMS=false
1271 CMP_TYPES=false
1272 CMP_GENERAL=false
1273 CMP_ZIPS=false
1274 CMP_ZIPS_CONTENTS=true
1275 CMP_JARS=false
1276 CMP_JMODS=false
1277 CMP_LIBS=false
1278 CMP_EXECS=false
1279 
1280 while [ -n &quot;$1&quot; ]; do
1281     case &quot;$1&quot; in
1282         -v)
1283             VERBOSE=true
1284             ;;
1285         -vv)
1286             VERBOSE=true
1287             SHOW_DIFFS=true
1288             ;;
1289         -o)
1290             OTHER=&quot;$2&quot;
1291             shift
1292             ;;
1293         -all)
1294             CMP_NAMES=true
1295             if [ &quot;$OPENJDK_TARGET_OS&quot; != &quot;windows&quot; ]; then
1296                 CMP_PERMS=true
1297             fi
1298             CMP_TYPES=true
1299             CMP_GENERAL=true
1300             CMP_ZIPS=true
1301             CMP_JARS=true
1302             CMP_JMODS=true
1303             CMP_LIBS=true
1304             CMP_EXECS=true
1305             ;;
1306         -names)
1307             CMP_NAMES=true
1308             ;;
1309         -perms)
1310             CMP_PERMS=true
1311             ;;
1312         -types)
1313             CMP_TYPES=true
1314             ;;
1315         -general)
1316             CMP_GENERAL=true
1317             ;;
1318         -zips)
1319             CMP_ZIPS=true
1320             CMP_ZIPS_CONTENTS=true
1321             ;;
1322         -zips-names)
1323             CMP_ZIPS=true
1324             CMP_ZIPS_CONTENTS=false
1325             ;;
1326         -jars)
1327             CMP_JARS=true
1328             ;;
1329         -jmods)
1330             CMP_JMODS=true
1331             ;;
1332         -libs)
1333             CMP_LIBS=true
1334             ;;
1335         -execs)
1336             CMP_EXECS=true
1337             ;;
1338         -2dirs)
1339             THIS=&quot;$(cd &quot;$2&quot; &gt; /dev/null &amp;&amp; pwd )&quot;
1340             OTHER=&quot;$(cd &quot;$3&quot; &gt; /dev/null &amp;&amp; pwd )&quot;
1341             THIS_BASE_DIR=&quot;$THIS&quot;
1342             OTHER_BASE_DIR=&quot;$OTHER&quot;
1343             SKIP_DEFAULT=true
1344             shift
1345             shift
1346             ;;
1347         -2zips)
1348             CMP_2_ZIPS=true
1349             THIS_FILE=$2
1350             OTHER_FILE=$3
1351             shift
1352             shift
1353             ;;
1354         -2bins)
1355             CMP_2_BINS=true
1356             THIS_FILE=$2
1357             OTHER_FILE=$3
1358             shift
1359             shift
1360             ;;
1361         --sort-symbols)
1362             SORT_ALL_SYMBOLS=true
1363             ;;
1364         --strip)
1365             STRIP_ALL=true
1366             ;;
1367         --clean)
1368             CLEAN_OUTPUT=true
1369             ;;
1370         *)
1371             CMP_NAMES=false
1372             CMP_PERMS=false
1373             CMP_TYPES=false
1374             CMP_ZIPS=true
1375             CMP_JARS=true
1376             CMP_JMODS=true
1377             CMP_LIBS=true
1378             CMP_EXECS=true
1379 
1380             if [ -z &quot;$FILTER&quot; ]; then
1381                 FILTER=&quot;$GREP&quot;
1382             fi
1383             FILTER=&quot;$FILTER -e $1&quot;
1384             ;;
1385     esac
1386     shift
1387 done
1388 
1389 if [ &quot;$STRIP_ALL&quot; = &quot;true&quot; ] &amp;&amp; [ -z &quot;$STRIP&quot; ]; then
1390   echo Warning: Not stripping even with --strip, since strip is missing on this platform
1391   STRIP_ALL=false
1392 fi
1393 
1394 COMPARE_ROOT=$OUTPUTDIR/compare-support
1395 if [ &quot;$CLEAN_OUTPUT&quot; = &quot;true&quot; ]; then
1396     echo Cleaning old output in $COMPARE_ROOT.
1397     $RM -rf $COMPARE_ROOT
1398 fi
1399 $MKDIR -p $COMPARE_ROOT
1400 if [ &quot;$OPENJDK_TARGET_OS&quot; = &quot;windows&quot; ]; then
1401     if [ &quot;$(uname -o)&quot; = &quot;Cygwin&quot; ]; then
1402         COMPARE_ROOT=$(cygpath -msa $COMPARE_ROOT)
1403     fi
1404 fi
1405 
1406 if [ &quot;$CMP_2_ZIPS&quot; = &quot;true&quot; ]; then
1407     THIS_DIR=&quot;$(dirname $THIS_FILE)&quot;
1408     THIS_DIR=&quot;$(cd &quot;$THIS_DIR&quot; &gt; /dev/null &amp;&amp; pwd )&quot;
1409     OTHER_DIR=&quot;$(dirname $OTHER_FILE)&quot;
1410     OTHER_DIR=&quot;$(cd &quot;$OTHER_DIR&quot; &gt; /dev/null &amp;&amp; pwd )&quot;
1411     THIS_FILE_NAME=&quot;$(basename $THIS_FILE)&quot;
1412     OTHER_FILE_NAME=&quot;$(basename $OTHER_FILE)&quot;
1413     echo Comparing $THIS_DIR/$THIS_FILE_NAME and $OTHER_DIR/$OTHER_FILE_NAME
1414     compare_zip_file $THIS_DIR $OTHER_DIR $COMPARE_ROOT/2zips $THIS_FILE_NAME $OTHER_FILE_NAME
1415     exit
1416 fi
1417 
1418 if [ &quot;$CMP_2_BINS&quot; = &quot;true&quot; ]; then
1419     THIS_DIR=&quot;$(dirname $THIS_FILE)&quot;
1420     THIS_DIR=&quot;$(cd &quot;$THIS_DIR&quot; &gt; /dev/null &amp;&amp; pwd )&quot;
1421     OTHER_DIR=&quot;$(dirname $OTHER_FILE)&quot;
1422     OTHER_DIR=&quot;$(cd &quot;$OTHER_DIR&quot; &gt; /dev/null &amp;&amp; pwd )&quot;
1423     THIS_FILE_NAME=&quot;$(basename $THIS_FILE)&quot;
1424     OTHER_FILE_NAME=&quot;$(basename $OTHER_FILE)&quot;
1425     echo Comparing $THIS_DIR/$THIS_FILE_NAME and $OTHER_DIR/$OTHER_FILE_NAME
1426     compare_bin_file $THIS_DIR $OTHER_DIR $COMPARE_ROOT/2bins $THIS_FILE_NAME $OTHER_FILE_NAME
1427     exit
1428 fi
1429 
1430 if [ &quot;$CMP_NAMES&quot; = &quot;false&quot; ] \
1431        &amp;&amp; [ &quot;$CMP_TYPES&quot; = &quot;false&quot; ] \
1432        &amp;&amp; [ &quot;$CMP_PERMS&quot; = &quot;false&quot; ] \
1433        &amp;&amp; [ &quot;$CMP_GENERAL&quot; = &quot;false&quot; ] \
1434        &amp;&amp; [ &quot;$CMP_ZIPS&quot; = &quot;false&quot; ] \
1435        &amp;&amp; [ &quot;$CMP_JARS&quot; = &quot;false&quot; ] \
1436        &amp;&amp; [ &quot;$CMP_JMODS&quot; = &quot;false&quot; ] \
1437        &amp;&amp; [ &quot;$CMP_LIBS&quot; = &quot;false&quot; ] \
1438        &amp;&amp; [ &quot;$CMP_EXECS&quot; = &quot;false&quot; ]; then
1439     CMP_NAMES=true
1440     CMP_PERMS=true
1441     CMP_TYPES=true
1442     CMP_GENERAL=true
1443     CMP_ZIPS=true
1444     CMP_JARS=true
1445     CMP_JMODS=true
1446     CMP_LIBS=true
1447     CMP_EXECS=true
1448 fi
1449 
1450 if [ -z &quot;$FILTER&quot; ]; then
1451     FILTER=&quot;$CAT&quot;
1452 fi
1453 
1454 if [ &quot;$SKIP_DEFAULT&quot; != &quot;true&quot; ]; then
1455     if [ -z &quot;$OTHER&quot; ]; then
1456         echo &quot;Nothing to compare to, set with -o&quot;
1457         exit 1
1458     else
1459         if [ ! -d &quot;$OTHER&quot; ]; then
1460             echo &quot;Other build directory does not exist:&quot;
1461             echo &quot;$OTHER&quot;
1462             exit 1
1463         fi
1464         OTHER=&quot;$( cd &quot;$OTHER&quot; &gt; /dev/null &amp;&amp; pwd )&quot;
1465         echo &quot;Comparing to:&quot;
1466         echo &quot;$OTHER&quot;
1467         echo
1468     fi
1469 
1470     # Find the common images to compare, prioritizing later build stages
1471     if [ -d &quot;$THIS/images/jdk&quot; ] &amp;&amp; [ -d &quot;$OTHER/images/jdk&quot; ]; then
1472         THIS_JDK=&quot;$THIS/images/jdk&quot;
1473         OTHER_JDK=&quot;$OTHER/images/jdk&quot;
1474         echo &quot;Selecting normal images for JDK compare&quot;
1475     elif [ -d &quot;$(ls -d $THIS/licensee-src/build/*/images/jdk 2&gt; /dev/null)&quot; ] \
1476         &amp;&amp; [ -d &quot;$(ls -d $OTHER/licensee-src/build/*/images/jdk 2&gt; /dev/null)&quot; ]
1477     then
1478         echo &quot;Selecting licensee images for compare&quot;
1479         # Simply override the THIS and OTHER dir with the build dir from
1480         # the nested licensee source build for the rest of the script
1481         # execution.
1482         OLD_THIS=&quot;$THIS&quot;
1483         OLD_OTHER=&quot;$OTHER&quot;
1484         THIS=&quot;$(ls -d $THIS/licensee-src/build/*)&quot;
1485         OTHER=&quot;$(ls -d $OTHER/licensee-src/build/*)&quot;
1486         THIS_JDK=&quot;$THIS/images/jdk&quot;
1487         OTHER_JDK=&quot;$OTHER/images/jdk&quot;
1488         # Rewrite the path to tools that are used from the build
1489         JIMAGE=&quot;$(echo &quot;$JIMAGE&quot; | $SED &quot;s|$OLD_THIS|$THIS|g&quot;)&quot;
1490         JMOD=&quot;$(echo &quot;$JMOD&quot; | $SED &quot;s|$OLD_THIS|$THIS|g&quot;)&quot;
1491         JAVAP=&quot;$(echo &quot;$JAVAP&quot; | $SED &quot;s|$OLD_THIS|$THIS|g&quot;)&quot;
1492     else
1493         echo &quot;No common images found.&quot;
1494         exit 1
1495     fi
1496     echo &quot;  $THIS_JDK&quot;
1497     echo &quot;  $OTHER_JDK&quot;
1498 
1499     if [ -d &quot;$THIS/images/jdk-bundle&quot; -o -d &quot;$THIS/deploy/images/jdk-bundle&quot; ] \
1500              &amp;&amp; [ -d &quot;$OTHER/images/jdk-bundle&quot; -o -d &quot;$OTHER/deploy/images/jdk-bundle&quot; ]; then
1501         if [ -d &quot;$THIS/deploy/images/jdk-bundle&quot; ]; then
1502             THIS_JDK_BUNDLE=&quot;$THIS/deploy/images/jdk-bundle&quot;
1503         else
1504             THIS_JDK_BUNDLE=&quot;$THIS/images/jdk-bundle&quot;
1505         fi
1506         if [ -d &quot;$OTHER/deploy/images/jdk-bundle&quot; ]; then
1507             OTHER_JDK_BUNDLE=&quot;$OTHER/deploy/images/jdk-bundle&quot;
1508         else
1509             OTHER_JDK_BUNDLE=&quot;$OTHER/images/jdk-bundle&quot;
1510         fi
1511         echo &quot;Also comparing jdk macosx bundles&quot;
1512         echo &quot;  $THIS_JDK_BUNDLE&quot;
1513         echo &quot;  $OTHER_JDK_BUNDLE&quot;
1514     fi
1515 
1516     THIS_SEC_DIR=&quot;$THIS/images&quot;
1517     OTHER_SEC_DIR=&quot;$OTHER/images&quot;
1518     if [ -f &quot;$THIS_SEC_DIR/sec-bin.zip&quot; ] &amp;&amp; [ -f &quot;$OTHER_SEC_DIR/sec-bin.zip&quot; ]; then
1519         OTHER_SEC_BIN=&quot;$OTHER_SEC_DIR/sec-bin.zip&quot;
1520         THIS_SEC_BIN=&quot;$THIS_SEC_DIR/sec-bin.zip&quot;
1521         if [ &quot;$OPENJDK_TARGET_OS&quot; = &quot;windows&quot; ]; then
1522             if [ &quot;$OPENJDK_TARGET_CPU&quot; = &quot;x86_64&quot; ]; then
1523                 JGSS_WINDOWS_BIN=&quot;jgss-windows-x64-bin.zip&quot;
1524             else
1525                 JGSS_WINDOWS_BIN=&quot;jgss-windows-i586-bin.zip&quot;
1526             fi
1527             OTHER_SEC_WINDOWS_BIN=&quot;$OTHER_SEC_DIR/sec-windows-bin.zip&quot;
1528             OTHER_JGSS_WINDOWS_BIN=&quot;$OTHER_SEC_DIR/$JGSS_WINDOWS_BIN&quot;
1529             THIS_SEC_WINDOWS_BIN=&quot;$THIS_SEC_DIR/sec-windows-bin.zip&quot;
1530             THIS_JGSS_WINDOWS_BIN=&quot;$THIS_SEC_DIR/$JGSS_WINDOWS_BIN&quot;
1531         fi
1532     fi
1533 
1534     if [ -d &quot;$THIS/images/docs&quot; ] &amp;&amp; [ -d &quot;$OTHER/images/docs&quot; ]; then
1535         THIS_DOCS=&quot;$THIS/images/docs&quot;
1536         OTHER_DOCS=&quot;$OTHER/images/docs&quot;
1537         echo &quot;Also comparing docs&quot;
1538     else
1539         echo &quot;WARNING! Docs haven&#39;t been built and won&#39;t be compared.&quot;
1540     fi
1541 
1542     if [ -d &quot;$THIS/images/test&quot; ] &amp;&amp; [ -d &quot;$OTHER/images/test&quot; ]; then
1543         THIS_TEST=&quot;$THIS/images/test&quot;
1544         OTHER_TEST=&quot;$OTHER/images/test&quot;
1545         echo &quot;Also comparing test image&quot;
1546     else
1547         echo &quot;WARNING! Test haven&#39;t been built and won&#39;t be compared.&quot;
1548     fi
1549 fi
1550 
1551 ################################################################################
1552 # Do the work
1553 
1554 if [ &quot;$CMP_NAMES&quot; = &quot;true&quot; ]; then
1555     if [ -n &quot;$THIS_JDK&quot; ] &amp;&amp; [ -n &quot;$OTHER_JDK&quot; ]; then
1556         echo -n &quot;JDK &quot;
1557         compare_dirs $THIS_JDK $OTHER_JDK $COMPARE_ROOT/jdk
1558         echo -n &quot;JDK &quot;
1559         compare_files $THIS_JDK $OTHER_JDK $COMPARE_ROOT/jdk
1560     fi
1561     if [ -n &quot;$THIS_JDK_BUNDLE&quot; ] &amp;&amp; [ -n &quot;$OTHER_JDK_BUNDLE&quot; ]; then
1562         echo -n &quot;JDK Bundle &quot;
1563         compare_dirs $THIS_JDK_BUNDLE $OTHER_JDK_BUNDLE $COMPARE_ROOT/jdk-bundle
1564 
1565         echo -n &quot;JDK Bundle &quot;
1566         compare_files $THIS_JDK_BUNDLE $OTHER_JDK_BUNDLE $COMPARE_ROOT/jdk-bundle
1567     fi
1568     if [ -n &quot;$THIS_DOCS&quot; ] &amp;&amp; [ -n &quot;$OTHER_DOCS&quot; ]; then
1569         echo -n &quot;Docs &quot;
1570         compare_dirs $THIS_DOCS $OTHER_DOCS $COMPARE_ROOT/docs
1571         echo -n &quot;Docs &quot;
1572         compare_files $THIS_DOCS $OTHER_DOCS $COMPARE_ROOT/docs
1573     fi
1574     if [ -n &quot;$THIS_TEST&quot; ] &amp;&amp; [ -n &quot;$OTHER_TEST&quot; ]; then
1575         echo -n &quot;Test &quot;
1576         compare_dirs $THIS_TEST $OTHER_TEST $COMPARE_ROOT/test
1577         echo -n &quot;Test &quot;
1578         compare_files $THIS_TEST $OTHER_TEST $COMPARE_ROOT/test
1579     fi
1580     if [ -n &quot;$THIS_BASE_DIR&quot; ] &amp;&amp; [ -n &quot;$OTHER_BASE_DIR&quot; ]; then
1581         compare_dirs $THIS_BASE_DIR $OTHER_BASE_DIR $COMPARE_ROOT/base_dir
1582         compare_files $THIS_BASE_DIR $OTHER_BASE_DIR $COMPARE_ROOT/base_dir
1583     fi
1584 fi
1585 
1586 if [ &quot;$CMP_LIBS&quot; = &quot;true&quot; ]; then
1587     if [ -n &quot;$THIS_JDK&quot; ] &amp;&amp; [ -n &quot;$OTHER_JDK&quot; ]; then
1588         echo -n &quot;JDK &quot;
1589         compare_all_libs $THIS_JDK $OTHER_JDK $COMPARE_ROOT/jdk
1590     fi
1591     if [ -n &quot;$THIS_TEST&quot; ] &amp;&amp; [ -n &quot;$OTHER_TEST&quot; ]; then
1592         echo -n &quot;Test &quot;
1593         STRIP_ALL_bak=&quot;$STRIP_ALL&quot;
1594         if [ &quot;$STRIP_TESTS_BEFORE_COMPARE&quot; = &quot;true&quot; ]; then
1595           STRIP_ALL=&quot;true&quot;
1596         fi
1597         compare_all_libs $THIS_TEST $OTHER_TEST $COMPARE_ROOT/test
1598         STRIP_ALL=&quot;$STRIP_ALL_bak&quot;
1599     fi
1600     if [ -n &quot;$THIS_BASE_DIR&quot; ] &amp;&amp; [ -n &quot;$OTHER_BASE_DIR&quot; ]; then
1601         compare_all_libs $THIS_BASE_DIR $OTHER_BASE_DIR $COMPARE_ROOT/base_dir
1602     fi
1603 fi
1604 
1605 if [ &quot;$CMP_EXECS&quot; = &quot;true&quot; ]; then
1606     if [ -n &quot;$THIS_JDK&quot; ] &amp;&amp; [ -n &quot;$OTHER_JDK&quot; ]; then
1607         echo -n &quot;JDK &quot;
1608         compare_all_execs $THIS_JDK $OTHER_JDK $COMPARE_ROOT/jdk
1609     fi
1610     if [ -n &quot;$THIS_TEST&quot; ] &amp;&amp; [ -n &quot;$OTHER_TEST&quot; ]; then
1611         echo -n &quot;Test &quot;
1612         STRIP_ALL_bak=&quot;$STRIP_ALL&quot;
1613         if [ &quot;$STRIP_TESTS_BEFORE_COMPARE&quot; = &quot;true&quot; ]; then
1614           STRIP_ALL=&quot;true&quot;
1615         fi
1616         compare_all_execs $THIS_TEST $OTHER_TEST $COMPARE_ROOT/test
1617         STRIP_ALL=&quot;$STRIP_ALL_bak&quot;
1618     fi
1619     if [ -n &quot;$THIS_BASE_DIR&quot; ] &amp;&amp; [ -n &quot;$OTHER_BASE_DIR&quot; ]; then
1620         compare_all_execs $THIS_BASE_DIR $OTHER_BASE_DIR $COMPARE_ROOT/base_dir
1621     fi
1622 fi
1623 
1624 if [ &quot;$CMP_GENERAL&quot; = &quot;true&quot; ]; then
1625     if [ -n &quot;$THIS_JDK&quot; ] &amp;&amp; [ -n &quot;$OTHER_JDK&quot; ]; then
1626         echo -n &quot;JDK &quot;
1627         compare_general_files $THIS_JDK $OTHER_JDK $COMPARE_ROOT/jdk
1628     fi
1629     if [ -n &quot;$THIS_JDK_BUNDLE&quot; ] &amp;&amp; [ -n &quot;$OTHER_JDK_BUNDLE&quot; ]; then
1630         echo -n &quot;JDK Bundle &quot;
1631         compare_general_files $THIS_JDK_BUNDLE $OTHER_JDK_BUNDLE $COMPARE_ROOT/jdk-bundle
1632     fi
1633     if [ -n &quot;$THIS_DOCS&quot; ] &amp;&amp; [ -n &quot;$OTHER_DOCS&quot; ]; then
1634         echo -n &quot;Docs &quot;
1635         compare_general_files $THIS_DOCS $OTHER_DOCS $COMPARE_ROOT/docs
1636     fi
1637     if [ -n &quot;$THIS_TEST&quot; ] &amp;&amp; [ -n &quot;$OTHER_TEST&quot; ]; then
1638         echo -n &quot;Test &quot;
1639         compare_general_files $THIS_TEST $OTHER_TEST $COMPARE_ROOT/test
1640     fi
1641     if [ -n &quot;$THIS_BASE_DIR&quot; ] &amp;&amp; [ -n &quot;$OTHER_BASE_DIR&quot; ]; then
1642         compare_general_files $THIS_BASE_DIR $OTHER_BASE_DIR $COMPARE_ROOT/base_dir
1643     fi
1644 fi
1645 
1646 if [ &quot;$CMP_ZIPS&quot; = &quot;true&quot; ]; then
1647     if [ -n &quot;$THIS_JDK&quot; ] &amp;&amp; [ -n &quot;$OTHER_JDK&quot; ]; then
1648         echo -n &quot;JDK &quot;
1649         compare_all_zip_files $THIS_JDK $OTHER_JDK $COMPARE_ROOT/jdk
1650     fi
1651     if [ -n &quot;$THIS_TEST&quot; ] &amp;&amp; [ -n &quot;$OTHER_TEST&quot; ]; then
1652         echo -n &quot;Test &quot;
1653         compare_all_zip_files $THIS_TEST $OTHER_TEST $COMPARE_ROOT/test
1654     fi
1655     if [ -n &quot;$THIS_SEC_BIN&quot; ] &amp;&amp; [ -n &quot;$OTHER_SEC_BIN&quot; ]; then
1656         if [ -n &quot;$(echo $THIS_SEC_BIN | $FILTER)&quot; ]; then
1657             echo &quot;sec-bin.zip...&quot;
1658             compare_zip_file $THIS_SEC_DIR $OTHER_SEC_DIR $COMPARE_ROOT/sec-bin sec-bin.zip
1659         fi
1660     fi
1661     if [ -n &quot;$THIS_SEC_WINDOWS_BIN&quot; ] &amp;&amp; [ -n &quot;$OTHER_SEC_WINDOWS_BIN&quot; ]; then
1662         if [ -n &quot;$(echo $THIS_SEC_WINDOWS_BIN | $FILTER)&quot; ]; then
1663             echo &quot;sec-windows-bin.zip...&quot;
1664             compare_zip_file $THIS_SEC_DIR $OTHER_SEC_DIR $COMPARE_ROOT/sec-bin sec-windows-bin.zip
1665         fi
1666     fi
1667     if [ -n &quot;$THIS_JGSS_WINDOWS_BIN&quot; ] &amp;&amp; [ -n &quot;$OTHER_JGSS_WINDOWS_BIN&quot; ]; then
1668         if [ -n &quot;$(echo $THIS_JGSS_WINDOWS_BIN | $FILTER)&quot; ]; then
1669             echo &quot;$JGSS_WINDOWS_BIN...&quot;
1670             compare_zip_file $THIS_SEC_DIR $OTHER_SEC_DIR $COMPARE_ROOT/sec-bin $JGSS_WINDOWS_BIN
1671         fi
1672     fi
1673     if [ -n &quot;$THIS_BASE_DIR&quot; ] &amp;&amp; [ -n &quot;$OTHER_BASE_DIR&quot; ]; then
1674         compare_all_zip_files $THIS_BASE_DIR $OTHER_BASE_DIR $COMPARE_ROOT/base_dir
1675     fi
1676 fi
1677 
1678 if [ &quot;$CMP_JARS&quot; = &quot;true&quot; ]; then
1679     if [ -n &quot;$THIS_JDK&quot; ] &amp;&amp; [ -n &quot;$OTHER_JDK&quot; ]; then
1680         echo -n &quot;JDK &quot;
1681         compare_all_jar_files $THIS_JDK $OTHER_JDK $COMPARE_ROOT/jdk
1682     fi
1683     if [ -n &quot;$THIS_TEST&quot; ] &amp;&amp; [ -n &quot;$OTHER_TEST&quot; ]; then
1684         echo -n &quot;Test &quot;
1685         compare_all_jar_files $THIS_TEST $OTHER_TEST $COMPARE_ROOT/test
1686     fi
1687     if [ -n &quot;$THIS_BASE_DIR&quot; ] &amp;&amp; [ -n &quot;$OTHER_BASE_DIR&quot; ]; then
1688         compare_all_jar_files $THIS_BASE_DIR $OTHER_BASE_DIR $COMPARE_ROOT/base_dir
1689     fi
1690 fi
1691 
1692 if [ &quot;$CMP_JMODS&quot; = &quot;true&quot; ]; then
1693     if [ -n &quot;$THIS_JDK&quot; ] &amp;&amp; [ -n &quot;$OTHER_JDK&quot; ]; then
1694         compare_all_jmod_files $THIS_JDK $OTHER_JDK $COMPARE_ROOT/jdk
1695     fi
1696     if [ -n &quot;$THIS_BASE_DIR&quot; ] &amp;&amp; [ -n &quot;$OTHER_BASE_DIR&quot; ]; then
1697         compare_all_jmod_files $THIS_BASE_DIR $OTHER_BASE_DIR $COMPARE_ROOT/base_dir
1698     fi
1699 fi
1700 
1701 if [ &quot;$CMP_PERMS&quot; = &quot;true&quot; ]; then
1702     if [ -n &quot;$THIS_JDK&quot; ] &amp;&amp; [ -n &quot;$OTHER_JDK&quot; ]; then
1703         echo -n &quot;JDK &quot;
1704         compare_permissions $THIS_JDK $OTHER_JDK $COMPARE_ROOT/jdk
1705     fi
1706     if [ -n &quot;$THIS_BASE_DIR&quot; ] &amp;&amp; [ -n &quot;$OTHER_BASE_DIR&quot; ]; then
1707         compare_permissions $THIS_BASE_DIR $OTHER_BASE_DIR $COMPARE_ROOT/base_dir
1708     fi
1709 fi
1710 
1711 if [ &quot;$CMP_TYPES&quot; = &quot;true&quot; ]; then
1712     if [ -n &quot;$THIS_JDK&quot; ] &amp;&amp; [ -n &quot;$OTHER_JDK&quot; ]; then
1713         echo -n &quot;JDK &quot;
1714         compare_file_types $THIS_JDK $OTHER_JDK $COMPARE_ROOT/jdk
1715     fi
1716     if [ -n &quot;$THIS_JDK_BUNDLE&quot; ] &amp;&amp; [ -n &quot;$OTHER_JDK_BUNDLE&quot; ]; then
1717         echo -n &quot;JDK Bundle &quot;
1718         compare_file_types $THIS_JDK_BUNDLE $OTHER_JDK_BUNDLE $COMPARE_ROOT/jdk-bundle
1719     fi
1720     if [ -n &quot;$THIS_TEST&quot; ] &amp;&amp; [ -n &quot;$OTHER_TEST&quot; ]; then
1721         echo -n &quot;Test &quot;
1722         compare_file_types $THIS_JDK $OTHER_JDK $COMPARE_ROOT/jdk
1723     fi
1724     if [ -n &quot;$THIS_BASE_DIR&quot; ] &amp;&amp; [ -n &quot;$OTHER_BASE_DIR&quot; ]; then
1725         compare_file_types $THIS_BASE_DIR $OTHER_BASE_DIR $COMPARE_ROOT/base_dir
1726     fi
1727 fi
1728 
1729 echo
1730 
1731 if [ -n &quot;$REGRESSIONS&quot; ]; then
1732     echo &quot;REGRESSIONS FOUND!&quot;
1733     echo
1734     exit 1
1735 else
1736     echo &quot;No regressions found&quot;
1737     echo
1738     exit 0
1739 fi
    </pre>
  </body>
</html>