<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>New make/autoconf/jvm-features.m4</title>
    <link rel="stylesheet" href="../../style.css" />
  </head>
  <body>
    <pre>
  1 #
  2 # Copyright (c) 2011, 2020, Oracle and/or its affiliates. All rights reserved.
  3 # DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4 #
  5 # This code is free software; you can redistribute it and/or modify it
  6 # under the terms of the GNU General Public License version 2 only, as
  7 # published by the Free Software Foundation.  Oracle designates this
  8 # particular file as subject to the &quot;Classpath&quot; exception as provided
  9 # by Oracle in the LICENSE file that accompanied this code.
 10 #
 11 # This code is distributed in the hope that it will be useful, but WITHOUT
 12 # ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 13 # FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 14 # version 2 for more details (a copy is included in the LICENSE file that
 15 # accompanied this code).
 16 #
 17 # You should have received a copy of the GNU General Public License version
 18 # 2 along with this work; if not, write to the Free Software Foundation,
 19 # Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 20 #
 21 # Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 22 # or visit www.oracle.com if you need additional information or have any
 23 # questions.
 24 #
 25 
 26 ###############################################################################
 27 # Terminology used in this file:
 28 #
 29 # Valid features      == All possible features that the JVM knows about.
 30 # Deprecated features == Previously known features (not considered valid).
 31 # Available features  == Features that are possible to use in this configuration.
 32 # Default features    == Features that are on by default in this configuration.
 33 # Enabled features    == Features requested by the user to be present.
 34 # Disabled features   == Features excluded from being used by the user.
 35 # Active features     == The exact set of features to be used for a JVM variant.
 36 #
 37 # All valid features are considered available, unless listed as unavailable.
 38 # All available features will be turned on as default, unless listed in a filter.
 39 ###############################################################################
 40 
 41 # We need these as m4 defines to be able to loop over them using m4 later on.
 42 
 43 # All valid JVM features, regardless of platform
 44 define(jvm_features_valid, m4_normalize( \
 45     ifdef([custom_jvm_features_valid], custom_jvm_features_valid) \
 46     \
 47     aot cds compiler1 compiler2 dtrace epsilongc g1gc graal jfr jni-check \
 48     jvmci jvmti link-time-opt management minimal nmt parallelgc serialgc \
 49     services shenandoahgc static-build vm-structs zero zgc \
 50 ))
 51 
 52 # Deprecated JVM features (these are ignored, but with a warning)
 53 define(jvm_features_deprecated, m4_normalize(
 54     cmsgc trace \
 55 ))
 56 
 57 
 58 ###############################################################################
 59 # Parse command line options for JVM feature selection. After this function
 60 # has run $JVM_FEATURES_ENABLED, $JVM_FEATURES_DISABLED and $JVM_FEATURES_VALID
 61 # can be used.
 62 #
 63 AC_DEFUN_ONCE([JVM_FEATURES_PARSE_OPTIONS],
 64 [
 65   # Setup shell variables from the m4 lists
 66   BASIC_SORT_LIST(JVM_FEATURES_VALID, &quot;jvm_features_valid&quot;)
 67   BASIC_SORT_LIST(JVM_FEATURES_DEPRECATED, &quot;jvm_features_deprecated&quot;)
 68 
 69   # For historical reasons, some jvm features have their own, shorter names.
 70   # Keep those as aliases for the --enable-jvm-feature-* style arguments.
 71   BASIC_ALIASED_ARG_ENABLE(aot, --enable-jvm-feature-aot)
 72   BASIC_ALIASED_ARG_ENABLE(cds, --enable-jvm-feature-cds)
 73   BASIC_ALIASED_ARG_ENABLE(dtrace, --enable-jvm-feature-dtrace)
 74 
 75   # First check for features using the
 76   # --with-jvm-features=&quot;&lt;[-]feature&gt;[,&lt;[-]feature&gt; ...]&quot; syntax.
 77   AC_ARG_WITH([jvm-features], [AS_HELP_STRING([--with-jvm-features],
 78       [JVM features to enable (foo) or disable (-foo), separated by comma. Use
 79       &#39;--help&#39; to show possible values @&lt;:@none@:&gt;@])])
 80   if test &quot;x$with_jvm_features&quot; != x; then
 81     # Replace &quot;,&quot;  with &quot; &quot;.
 82     user_jvm_feature_list=${with_jvm_features//,/ }
 83     JVM_FEATURES_ENABLED=`$ECHO $user_jvm_feature_list | \
 84         $AWK &#39;{ for (i=1; i&lt;=NF; i++) if (!match($i, /^-.*/)) printf(&quot;%s &quot;, $i) }&#39;`
 85     JVM_FEATURES_DISABLED=`$ECHO $user_jvm_feature_list | \
 86         $AWK &#39;{ for (i=1; i&lt;=NF; i++) if (match($i, /^-.*/)) printf(&quot;%s &quot;, substr($i, 2))}&#39;`
 87 
 88     # Verify that the user has provided only valid (or deprecated) features
 89     BASIC_GET_NON_MATCHING_VALUES(invalid_features, $JVM_FEATURES_ENABLED \
 90         $JVM_FEATURES_DISABLED, $JVM_FEATURES_VALID $JVM_FEATURES_DEPRECATED)
 91     if test &quot;x$invalid_features&quot; != x; then
 92       AC_MSG_NOTICE([Unknown JVM features specified: &#39;$invalid_features&#39;])
 93       AC_MSG_NOTICE([The available JVM features are: &#39;$JVM_FEATURES_VALID&#39;])
 94       AC_MSG_ERROR([Cannot continue])
 95     fi
 96 
 97     # Check if the user has provided deprecated features
 98     BASIC_GET_MATCHING_VALUES(deprecated_features, $JVM_FEATURES_ENABLED \
 99         $JVM_FEATURES_DISABLED, $JVM_FEATURES_DEPRECATED)
100     if test &quot;x$deprecated_features&quot; != x; then
101       AC_MSG_WARN([Deprecated JVM features specified (will be ignored): &#39;$deprecated_features&#39;])
102       # Filter out deprecated features
103       BASIC_GET_NON_MATCHING_VALUES(JVM_FEATURES_ENABLED, \
104           $JVM_FEATURES_ENABLED, $deprecated_features)
105       BASIC_GET_NON_MATCHING_VALUES(JVM_FEATURES_DISABLED, \
106           $JVM_FEATURES_DISABLED, $deprecated_features)
107     fi
108   fi
109 
110   # Then check for features using the &quot;--enable-jvm-feature-&lt;feature&gt;&quot; syntax.
111   # Using m4, loop over all features with the variable FEATURE.
112   m4_foreach(FEATURE, m4_split(jvm_features_valid), [
113     AC_ARG_ENABLE(jvm-feature-FEATURE, AS_HELP_STRING(
114         [--enable-jvm-feature-FEATURE], [enable jvm feature &#39;FEATURE&#39;]))
115 
116     # Create an m4 variable containing a shell variable name (like
117     # &quot;enable_jvm_feature_static_build&quot;).
118     define(FEATURE_SHELL, [enable_jvm_feature_]translit(FEATURE, -, _))
119 
120     if test &quot;x$FEATURE_SHELL&quot; = xyes; then
121       JVM_FEATURES_ENABLED=&quot;$JVM_FEATURES_ENABLED FEATURE&quot;
122     elif test &quot;x$FEATURE_SHELL&quot; = xno; then
123       JVM_FEATURES_DISABLED=&quot;$JVM_FEATURES_DISABLED FEATURE&quot;
124     elif test &quot;x$FEATURE_SHELL&quot; != x; then
125       AC_MSG_ERROR([Invalid value for --enable-jvm-feature-FEATURE: &#39;$FEATURE_SHELL&#39;])
126     fi
127 
128     undefine([FEATURE_SHELL])
129   ])
130 
131   # Likewise, check for deprecated arguments.
132   m4_foreach(FEATURE, m4_split(jvm_features_deprecated), [
133     AC_ARG_ENABLE(jvm-feature-FEATURE, AS_HELP_STRING(
134         [--enable-jvm-feature-FEATURE], [enable jvm feature &#39;FEATURE&#39;
135          (deprecated)]))
136 
137     define(FEATURE_SHELL, [enable_jvm_feature_]translit(FEATURE, -, _))
138 
139     if test &quot;x$FEATURE_SHELL&quot; != x; then
140       AC_MSG_WARN([Deprecated JVM feature, will be ignored: --enable-jvm-feature-FEATURE])
141     fi
142 
143     undefine([FEATURE_SHELL])
144   ])
145 
146   # Warn if the user has both enabled and disabled a feature
147   # If this happens, disable will override enable.
148   BASIC_GET_MATCHING_VALUES(enabled_and_disabled, $JVM_FEATURES_ENABLED, \
149       $JVM_FEATURES_DISABLED)
150   if test &quot;x$enabled_and_disabled&quot; != x; then
151     AC_MSG_WARN([Disabling of these features will override enabling: &#39;$enabled_and_disabled&#39;])
152   fi
153 
154   # Clean up lists and announce results to user
155   BASIC_SORT_LIST(JVM_FEATURES_ENABLED, $JVM_FEATURES_ENABLED)
156   AC_MSG_CHECKING([for JVM features enabled by the user])
157   if test &quot;x$JVM_FEATURES_ENABLED&quot; != x; then
158     AC_MSG_RESULT([&#39;$JVM_FEATURES_ENABLED&#39;])
159   else
160     AC_MSG_RESULT([none])
161   fi
162 
163   BASIC_SORT_LIST(JVM_FEATURES_DISABLED, $JVM_FEATURES_DISABLED)
164   AC_MSG_CHECKING([for JVM features disabled by the user])
165   if test &quot;x$JVM_FEATURES_DISABLED&quot; != x; then
166     AC_MSG_RESULT([&#39;$JVM_FEATURES_DISABLED&#39;])
167   else
168     AC_MSG_RESULT([none])
169   fi
170 
171   # Makefiles use VALID_JVM_FEATURES in check-jvm-feature to verify correctness.
172   VALID_JVM_FEATURES=&quot;$JVM_FEATURES_VALID&quot;
173   AC_SUBST(VALID_JVM_FEATURES)
174 ])
175 
176 ###############################################################################
177 # Helper function for the JVM_FEATURES_CHECK_* suite.
178 # The code in the code block should assign &#39;false&#39; to the variable AVAILABLE
179 # if the feature is not available, and this function will handle everything
180 # else that is needed.
181 #
182 # arg 1: The name of the feature to test
183 # arg 2: The code block to execute
184 #
185 AC_DEFUN([JVM_FEATURES_CHECK_AVAILABILITY],
186 [
187   # Assume that feature is available
188   AVAILABLE=true
189 
190   # Execute feature test block
191   $2
192 
193   AC_MSG_CHECKING([if JVM feature &#39;$1&#39; is available])
194   if test &quot;x$AVAILABLE&quot; = &quot;xtrue&quot;; then
195     AC_MSG_RESULT([yes])
196   else
197     AC_MSG_RESULT([no])
198     JVM_FEATURES_PLATFORM_UNAVAILABLE=&quot;$JVM_FEATURES_PLATFORM_UNAVAILABLE $1&quot;
199   fi
200 ])
201 
202 ###############################################################################
203 # Check if the feature &#39;aot&#39; is available on this platform.
204 #
205 AC_DEFUN_ONCE([JVM_FEATURES_CHECK_AOT],
206 [
207   JVM_FEATURES_CHECK_AVAILABILITY(aot, [
208     AC_MSG_CHECKING([if platform is supported by AOT])
209     # AOT is only available where JVMCI is available since it requires JVMCI.
210     if test &quot;x$OPENJDK_TARGET_CPU&quot; = &quot;xx86_64&quot; || \
211         test &quot;x$OPENJDK_TARGET_CPU&quot; = &quot;xaarch64&quot;; then
212       AC_MSG_RESULT([yes])
213     else
214       AC_MSG_RESULT([no, $OPENJDK_TARGET_CPU])
215       AVAILABLE=false
216     fi
217 
218     AC_MSG_CHECKING([if AOT source code is present])
219     if test -e &quot;${TOPDIR}/src/jdk.internal.vm.compiler&quot; &amp;&amp; \
220         test -e &quot;${TOPDIR}/src/jdk.aot&quot;; then
221       AC_MSG_RESULT([yes])
222     else
223       AC_MSG_RESULT([no, missing src/jdk.internal.vm.compiler or src/jdk.aot])
224       AVAILABLE=false
225     fi
226   ])
227 ])
228 
229 ###############################################################################
230 # Check if the feature &#39;cds&#39; is available on this platform.
231 #
232 AC_DEFUN_ONCE([JVM_FEATURES_CHECK_CDS],
233 [
234   JVM_FEATURES_CHECK_AVAILABILITY(cds, [
235     AC_MSG_CHECKING([if platform is supported by CDS])
236     if test &quot;x$OPENJDK_TARGET_OS&quot; != xaix; then
237       AC_MSG_RESULT([yes])
238     else
239       AC_MSG_RESULT([no, $OPENJDK_TARGET_OS])
240       AVAILABLE=false
241     fi
242   ])
243 ])
244 
245 ###############################################################################
246 # Check if the feature &#39;dtrace&#39; is available on this platform.
247 #
248 AC_DEFUN_ONCE([JVM_FEATURES_CHECK_DTRACE],
249 [
250   JVM_FEATURES_CHECK_AVAILABILITY(dtrace, [
251     AC_MSG_CHECKING([for dtrace tool])
252     if test &quot;x$DTRACE&quot; != &quot;x&quot; &amp;&amp; test -x &quot;$DTRACE&quot;; then
253       AC_MSG_RESULT([$DTRACE])
254     else
255       AC_MSG_RESULT([no])
256       AVAILABLE=false
257     fi
258 
259     AC_CHECK_HEADERS([sys/sdt.h], [dtrace_headers_ok=true])
260     if test &quot;x$dtrace_headers_ok&quot; != &quot;xtrue&quot;; then
261       HELP_MSG_MISSING_DEPENDENCY([dtrace])
262       AC_MSG_NOTICE([Cannot enable dtrace with missing dependencies. See above.])
263       AVAILABLE=false
264     fi
265   ])
266 ])
267 
268 ###############################################################################
269 # Check if the feature &#39;graal&#39; is available on this platform.
270 #
271 AC_DEFUN_ONCE([JVM_FEATURES_CHECK_GRAAL],
272 [
273   JVM_FEATURES_CHECK_AVAILABILITY(graal, [
274     AC_MSG_CHECKING([if platform is supported by Graal])
275     # Graal is only available where JVMCI is available since it requires JVMCI.
276     if test &quot;x$OPENJDK_TARGET_CPU&quot; = &quot;xx86_64&quot; || \
277         test &quot;x$OPENJDK_TARGET_CPU&quot; = &quot;xaarch64&quot; ; then
278       AC_MSG_RESULT([yes])
279     else
280       AC_MSG_RESULT([no, $OPENJDK_TARGET_CPU])
281       AVAILABLE=false
282     fi
283   ])
284 ])
285 
286 ###############################################################################
287 # Check if the feature &#39;jfr&#39; is available on this platform.
288 #
289 AC_DEFUN_ONCE([JVM_FEATURES_CHECK_JFR],
290 [
291   JVM_FEATURES_CHECK_AVAILABILITY(jfr, [
292     AC_MSG_CHECKING([if platform is supported by JFR])
293     if test &quot;x$OPENJDK_TARGET_OS&quot; = xaix || \
294         test &quot;x$OPENJDK_TARGET_OS-$OPENJDK_TARGET_CPU&quot; = &quot;xlinux-sparcv9&quot;; then
295       AC_MSG_RESULT([no, $OPENJDK_TARGET_OS-$OPENJDK_TARGET_CPU])
296       AVAILABLE=false
297     else
298       AC_MSG_RESULT([yes])
299     fi
300   ])
301 ])
302 
303 ###############################################################################
304 # Check if the feature &#39;jvmci&#39; is available on this platform.
305 #
306 AC_DEFUN_ONCE([JVM_FEATURES_CHECK_JVMCI],
307 [
308   JVM_FEATURES_CHECK_AVAILABILITY(jvmci, [
309     AC_MSG_CHECKING([if platform is supported by JVMCI])
310     if test &quot;x$OPENJDK_TARGET_CPU&quot; = &quot;xx86_64&quot; || \
311         test &quot;x$OPENJDK_TARGET_CPU&quot; = &quot;xaarch64&quot; ; then
312       AC_MSG_RESULT([yes])
313     else
314       AC_MSG_RESULT([no, $OPENJDK_TARGET_CPU])
315       AVAILABLE=false
316     fi
317   ])
318 ])
319 
320 ###############################################################################
321 # Check if the feature &#39;shenandoahgc&#39; is available on this platform.
322 #
323 AC_DEFUN_ONCE([JVM_FEATURES_CHECK_SHENANDOAHGC],
324 [
325   JVM_FEATURES_CHECK_AVAILABILITY(shenandoahgc, [
326     AC_MSG_CHECKING([if platform is supported by Shenandoah])
327     if test &quot;x$OPENJDK_TARGET_CPU_ARCH&quot; = &quot;xx86&quot; || \
328         test &quot;x$OPENJDK_TARGET_CPU&quot; = &quot;xaarch64&quot; ; then
329       AC_MSG_RESULT([yes])
330     else
331       AC_MSG_RESULT([no, $OPENJDK_TARGET_CPU])
332       AVAILABLE=false
333     fi
334   ])
335 ])
336 
337 ###############################################################################
338 # Check if the feature &#39;static-build&#39; is available on this platform.
339 #
340 AC_DEFUN_ONCE([JVM_FEATURES_CHECK_STATIC_BUILD],
341 [
342   JVM_FEATURES_CHECK_AVAILABILITY(static-build, [
343     AC_MSG_CHECKING([if static-build is enabled in configure])
344     if test &quot;x$STATIC_BUILD&quot; = &quot;xtrue&quot;; then
345       AC_MSG_RESULT([yes])
346     else
347       AC_MSG_RESULT([no, use --enable-static-build to enable static build.])
348       AVAILABLE=false
349     fi
350   ])
351 ])
352 
353 ###############################################################################
354 # Check if the feature &#39;zgc&#39; is available on this platform.
355 #
356 AC_DEFUN_ONCE([JVM_FEATURES_CHECK_ZGC],
357 [
358   JVM_FEATURES_CHECK_AVAILABILITY(zgc, [
359     AC_MSG_CHECKING([if platform is supported by ZGC])
360     if test &quot;x$OPENJDK_TARGET_CPU&quot; = &quot;xx86_64&quot;; then
361       if test &quot;x$OPENJDK_TARGET_OS&quot; = &quot;xlinux&quot; || \
362           test &quot;x$OPENJDK_TARGET_OS&quot; = &quot;xwindows&quot; || \
363           test &quot;x$OPENJDK_TARGET_OS&quot; = &quot;xmacosx&quot;; then
364         AC_MSG_RESULT([yes])
365       else
366         AC_MSG_RESULT([no, $OPENJDK_TARGET_OS-$OPENJDK_TARGET_CPU])
367         AVAILABLE=false
368       fi
369     elif test &quot;x$OPENJDK_TARGET_OS-$OPENJDK_TARGET_CPU&quot; = &quot;xlinux-aarch64&quot;; then
370       AC_MSG_RESULT([yes])
371     else
372       AC_MSG_RESULT([no, $OPENJDK_TARGET_OS-$OPENJDK_TARGET_CPU])
373       AVAILABLE=false
374     fi
375 
376     if test &quot;x$OPENJDK_TARGET_OS&quot; = &quot;xwindows&quot;; then
377       AC_MSG_CHECKING([if Windows APIs required for ZGC is present])
378       AC_COMPILE_IFELSE(
379         [AC_LANG_PROGRAM([[#include &lt;windows.h&gt;]],
380           [[struct MEM_EXTENDED_PARAMETER x;]])
381         ],
382         [
383           AC_MSG_RESULT([yes])
384         ],
385         [
386           AC_MSG_RESULT([no, missing required APIs])
387           AVAILABLE=false
388         ]
389       )
390     fi
391   ])
392 ])
393 
394 ###############################################################################
395 # Setup JVM_FEATURES_PLATFORM_UNAVAILABLE and JVM_FEATURES_PLATFORM_FILTER
396 # to contain those features that are unavailable, or should be off by default,
397 # for this platform, regardless of JVM variant.
398 #
399 AC_DEFUN_ONCE([JVM_FEATURES_PREPARE_PLATFORM],
400 [
401   # The checks below should add unavailable features to
402   # JVM_FEATURES_PLATFORM_UNAVAILABLE.
403 
404   JVM_FEATURES_CHECK_AOT
405   JVM_FEATURES_CHECK_CDS
406   JVM_FEATURES_CHECK_DTRACE
407   JVM_FEATURES_CHECK_GRAAL
408   JVM_FEATURES_CHECK_JFR
409   JVM_FEATURES_CHECK_JVMCI
410   JVM_FEATURES_CHECK_SHENANDOAHGC
411   JVM_FEATURES_CHECK_STATIC_BUILD
412   JVM_FEATURES_CHECK_ZGC
413 
414   # Filter out features by default for all variants on certain platforms.
415   # Make sure to just add to JVM_FEATURES_PLATFORM_FILTER, since it could
416   # have a value already from custom extensions.
417   if test &quot;x$OPENJDK_TARGET_OS&quot; = xaix; then
418     JVM_FEATURES_PLATFORM_FILTER=&quot;$JVM_FEATURES_PLATFORM_FILTER jfr&quot;
419   fi
420 
421   if test &quot;x$OPENJDK_TARGET_OS-$OPENJDK_TARGET_CPU&quot; = &quot;xlinux-sparcv9&quot;; then
422     JVM_FEATURES_PLATFORM_FILTER=&quot;$JVM_FEATURES_PLATFORM_FILTER jfr&quot;
423   fi
424 ])
425 
426 ###############################################################################
427 # Setup JVM_FEATURES_VARIANT_UNAVAILABLE and JVM_FEATURES_VARIANT_FILTER
428 # to contain those features that are unavailable, or should be off by default,
429 # for this particular JVM variant.
430 #
431 # arg 1: JVM variant
432 #
433 AC_DEFUN([JVM_FEATURES_PREPARE_VARIANT],
434 [
435   variant=$1
436 
437   # Check which features are unavailable for this JVM variant.
438   # This means that is not possible to build these features for this variant.
439   if test &quot;x$variant&quot; = &quot;xminimal&quot;; then
440     JVM_FEATURES_VARIANT_UNAVAILABLE=&quot;cds zero&quot;
441   elif test &quot;x$variant&quot; = &quot;xcore&quot;; then
442     JVM_FEATURES_VARIANT_UNAVAILABLE=&quot;cds minimal zero&quot;
443   elif test &quot;x$variant&quot; = &quot;xzero&quot;; then
444     JVM_FEATURES_VARIANT_UNAVAILABLE=&quot;aot cds compiler1 compiler2 \
445         epsilongc g1gc graal jvmci minimal shenandoahgc zgc&quot;
446   else
447     JVM_FEATURES_VARIANT_UNAVAILABLE=&quot;minimal zero&quot;
448   fi
449 
450   # Check which features should be off by default for this JVM variant.
451   if test &quot;x$variant&quot; = &quot;xclient&quot;; then
452     JVM_FEATURES_VARIANT_FILTER=&quot;aot compiler2 graal jvmci link-time-opt&quot;
453   elif test &quot;x$variant&quot; = &quot;xminimal&quot;; then
454     JVM_FEATURES_VARIANT_FILTER=&quot;aot cds compiler2 dtrace epsilongc g1gc \
455         graal jfr jni-check jvmci jvmti management nmt parallelgc services \
456         shenandoahgc vm-structs zgc&quot;
457     if test &quot;x$OPENJDK_TARGET_CPU&quot; != xarm ; then
458       # Only arm-32 should have link-time-opt enabled as default.
459       JVM_FEATURES_VARIANT_FILTER=&quot;$JVM_FEATURES_VARIANT_FILTER \
460           link-time-opt&quot;
461     fi
462   elif test &quot;x$variant&quot; = &quot;xcore&quot;; then
463     JVM_FEATURES_VARIANT_FILTER=&quot;aot compiler1 compiler2 graal jvmci \
464         link-time-opt&quot;
465   elif test &quot;x$variant&quot; = &quot;xzero&quot;; then
466     JVM_FEATURES_VARIANT_FILTER=&quot;jfr link-time-opt&quot;
467   else
468     JVM_FEATURES_VARIANT_FILTER=&quot;link-time-opt&quot;
469   fi
470 ])
471 
472 ###############################################################################
473 # Calculate the actual set of active JVM features for this JVM variant. Store
474 # the result in JVM_FEATURES_ACTIVE.
475 #
476 # arg 1: JVM variant
477 #
478 AC_DEFUN([JVM_FEATURES_CALCULATE_ACTIVE],
479 [
480   variant=$1
481 
482   # The default is set to all valid features except those unavailable or listed
483   # in a filter.
484   if test &quot;x$variant&quot; != xcustom; then
485     BASIC_GET_NON_MATCHING_VALUES(default_for_variant, $JVM_FEATURES_VALID, \
486         $JVM_FEATURES_PLATFORM_UNAVAILABLE $JVM_FEATURES_VARIANT_UNAVAILABLE \
487         $JVM_FEATURES_PLATFORM_FILTER $JVM_FEATURES_VARIANT_FILTER)
488   else
489     # Except for the &#39;custom&#39; variant, where the default is to start with an
490     # empty set.
491     default_for_variant=&quot;&quot;
492   fi
493 
494   # Verify that explicitly enabled features are available
495   BASIC_GET_MATCHING_VALUES(enabled_but_unavailable, $JVM_FEATURES_ENABLED, \
496       $JVM_FEATURES_PLATFORM_UNAVAILABLE $JVM_FEATURES_VARIANT_UNAVAILABLE)
497   if test &quot;x$enabled_but_unavailable&quot; != x; then
498     AC_MSG_NOTICE([ERROR: Unavailable JVM features explicitly enabled for &#39;$variant&#39;: &#39;$enabled_but_unavailable&#39;])
499     AC_MSG_ERROR([Cannot continue])
500   fi
501 
502   # Notify the user if their command line options has no real effect
503   BASIC_GET_MATCHING_VALUES(enabled_but_default, $JVM_FEATURES_ENABLED, \
504       $default_for_variant)
505   if test &quot;x$enabled_but_default&quot; != x; then
506     AC_MSG_NOTICE([Default JVM features explicitly enabled for &#39;$variant&#39;: &#39;$enabled_but_default&#39;])
507   fi
508   BASIC_GET_MATCHING_VALUES(disabled_but_unavailable, $JVM_FEATURES_DISABLED, \
509       $JVM_FEATURES_PLATFORM_UNAVAILABLE $JVM_FEATURES_VARIANT_UNAVAILABLE)
510   if test &quot;x$disabled_but_unavailable&quot; != x; then
511     AC_MSG_NOTICE([Unavailable JVM features explicitly disabled for &#39;$variant&#39;: &#39;$disabled_but_unavailable&#39;])
512   fi
513 
514   # JVM_FEATURES_ACTIVE is the set of all default features and all explicitly
515   # enabled features, with the explicitly disabled features filtered out.
516   BASIC_GET_NON_MATCHING_VALUES(JVM_FEATURES_ACTIVE, $default_for_variant \
517       $JVM_FEATURES_ENABLED, $JVM_FEATURES_DISABLED)
518 ])
519 
520 ###############################################################################
521 # Helper function for JVM_FEATURES_VERIFY. Check if the specified JVM
522 # feature is active. To be used in shell if constructs, like this:
523 # &#39;if JVM_FEATURES_IS_ACTIVE(jvmti); then&#39;
524 #
525 # Definition kept in one line to allow inlining in if statements.
526 # Additional [] needed to keep m4 from mangling shell constructs.
527 AC_DEFUN([JVM_FEATURES_IS_ACTIVE],
528 [ [ [[ &quot; $JVM_FEATURES_ACTIVE &quot; =~ &#39; &#39;$1&#39; &#39; ]] ] ])
529 
530 ###############################################################################
531 # Verify that the resulting set of features is consistent and legal.
532 #
533 # arg 1: JVM variant
534 #
535 AC_DEFUN([JVM_FEATURES_VERIFY],
536 [
537   variant=$1
538 
539   # Verify that dependencies are met for inter-feature relations.
540   if JVM_FEATURES_IS_ACTIVE(aot) &amp;&amp; ! JVM_FEATURES_IS_ACTIVE(graal); then
541     AC_MSG_ERROR([Specified JVM feature &#39;aot&#39; requires feature &#39;graal&#39; for variant &#39;$variant&#39;])
542   fi
543 
544   if JVM_FEATURES_IS_ACTIVE(graal) &amp;&amp; ! JVM_FEATURES_IS_ACTIVE(jvmci); then
545     AC_MSG_ERROR([Specified JVM feature &#39;graal&#39; requires feature &#39;jvmci&#39; for variant &#39;$variant&#39;])
546   fi
547 
548   if JVM_FEATURES_IS_ACTIVE(jvmci) &amp;&amp; ! (JVM_FEATURES_IS_ACTIVE(compiler1) || \
549       JVM_FEATURES_IS_ACTIVE(compiler2)); then
550     AC_MSG_ERROR([Specified JVM feature &#39;jvmci&#39; requires feature &#39;compiler2&#39; or &#39;compiler1&#39; for variant &#39;$variant&#39;])
551   fi
552 
553   if JVM_FEATURES_IS_ACTIVE(jvmti) &amp;&amp; ! JVM_FEATURES_IS_ACTIVE(services); then
554     AC_MSG_ERROR([Specified JVM feature &#39;jvmti&#39; requires feature &#39;services&#39; for variant &#39;$variant&#39;])
555   fi
556 
557   if JVM_FEATURES_IS_ACTIVE(management) &amp;&amp; ! JVM_FEATURES_IS_ACTIVE(nmt); then
558     AC_MSG_ERROR([Specified JVM feature &#39;management&#39; requires feature &#39;nmt&#39; for variant &#39;$variant&#39;])
559   fi
560 
561   # For backwards compatibility, disable a feature &quot;globally&quot; if one variant
562   # is missing the feature.
563   if ! JVM_FEATURES_IS_ACTIVE(aot); then
564     ENABLE_AOT=&quot;false&quot;
565   fi
566   if ! JVM_FEATURES_IS_ACTIVE(cds); then
567     ENABLE_CDS=&quot;false&quot;
568   fi
569   if ! JVM_FEATURES_IS_ACTIVE(graal); then
570     INCLUDE_GRAAL=&quot;false&quot;
571   fi
572   if ! JVM_FEATURES_IS_ACTIVE(jvmci); then
573     INCLUDE_JVMCI=&quot;false&quot;
574   fi
575 
576   # Verify that we have at least one gc selected (i.e., feature named &quot;*gc&quot;).
577   if ! JVM_FEATURES_IS_ACTIVE(.*gc); then
578       AC_MSG_NOTICE([At least one gc needed for variant &#39;$variant&#39;.])
579       AC_MSG_NOTICE([Specified features: &#39;$JVM_FEATURES_ACTIVE&#39;])
580       AC_MSG_ERROR([Cannot continue])
581   fi
582 ])
583 
584 ###############################################################################
585 # Set up all JVM features for each enabled JVM variant. Requires that
586 # JVM_FEATURES_PARSE_OPTIONS has been called.
587 #
588 AC_DEFUN_ONCE([JVM_FEATURES_SETUP],
589 [
590   # Set up variant-independent factors
591   JVM_FEATURES_PREPARE_PLATFORM
592 
593   # For backwards compatibility, tentatively enable these features &quot;globally&quot;,
594   # and disable them in JVM_FEATURES_VERIFY if a variant is found that are
595   # missing any of them.
596   ENABLE_AOT=&quot;true&quot;
597   ENABLE_CDS=&quot;true&quot;
598   INCLUDE_GRAAL=&quot;true&quot;
599   INCLUDE_JVMCI=&quot;true&quot;
600 
601   for variant in $JVM_VARIANTS; do
602     # Figure out if any features are unavailable, or should be filtered out
603     # by default, for this variant.
604     # Store the result in JVM_FEATURES_VARIANT_UNAVAILABLE and
605     # JVM_FEATURES_VARIANT_FILTER.
606     JVM_FEATURES_PREPARE_VARIANT($variant)
607 
608     # Calculate the resulting set of enabled features for this variant.
609     # The result is stored in JVM_FEATURES_ACTIVE.
610     JVM_FEATURES_CALCULATE_ACTIVE($variant)
611 
612     # Verify consistency for JVM_FEATURES_ACTIVE.
613     JVM_FEATURES_VERIFY($variant)
614 
615     # Keep feature list sorted and free of duplicates
616     BASIC_SORT_LIST(JVM_FEATURES_ACTIVE, $JVM_FEATURES_ACTIVE)
617     AC_MSG_CHECKING([JVM features to use for variant &#39;$variant&#39;])
618     AC_MSG_RESULT([&#39;$JVM_FEATURES_ACTIVE&#39;])
619 
620     # Save this as e.g. JVM_FEATURES_server, using indirect variable
621     # referencing.
622     features_var_name=JVM_FEATURES_$variant
623     eval $features_var_name=\&quot;$JVM_FEATURES_ACTIVE\&quot;
624   done
625 
626   # Unfortunately AC_SUBST does not work with non-literally named variables,
627   # so list all variants here.
628   AC_SUBST(JVM_FEATURES_server)
629   AC_SUBST(JVM_FEATURES_client)
630   AC_SUBST(JVM_FEATURES_minimal)
631   AC_SUBST(JVM_FEATURES_core)
632   AC_SUBST(JVM_FEATURES_zero)
633   AC_SUBST(JVM_FEATURES_custom)
634 
635   AC_SUBST(ENABLE_AOT)
636   AC_SUBST(INCLUDE_GRAAL)
637   AC_SUBST(INCLUDE_JVMCI)
638 
639 ])
    </pre>
  </body>
</html>