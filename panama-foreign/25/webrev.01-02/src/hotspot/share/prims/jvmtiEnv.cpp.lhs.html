<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames src/hotspot/share/prims/jvmtiEnv.cpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
    <script type="text/javascript" src="../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>   1 /*
   2  * Copyright (c) 2003, 2020, Oracle and/or its affiliates. All rights reserved.
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.
   8  *
   9  * This code is distributed in the hope that it will be useful, but WITHOUT
  10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  *
  23  */
  24 
  25 #include &quot;precompiled.hpp&quot;
  26 #include &quot;classfile/classLoaderExt.hpp&quot;
  27 #include &quot;classfile/javaClasses.inline.hpp&quot;
  28 #include &quot;classfile/stringTable.hpp&quot;
  29 #include &quot;classfile/modules.hpp&quot;
  30 #include &quot;classfile/systemDictionary.hpp&quot;
  31 #include &quot;classfile/vmSymbols.hpp&quot;
  32 #include &quot;interpreter/bytecodeStream.hpp&quot;
  33 #include &quot;interpreter/interpreter.hpp&quot;
<a name="1" id="anc1"></a>
  34 #include &quot;jvmtifiles/jvmtiEnv.hpp&quot;
  35 #include &quot;logging/log.hpp&quot;
  36 #include &quot;logging/logConfiguration.hpp&quot;
  37 #include &quot;memory/resourceArea.hpp&quot;
  38 #include &quot;memory/universe.hpp&quot;
  39 #include &quot;oops/instanceKlass.hpp&quot;
  40 #include &quot;oops/objArrayOop.inline.hpp&quot;
  41 #include &quot;oops/oop.inline.hpp&quot;
  42 #include &quot;prims/jniCheck.hpp&quot;
  43 #include &quot;prims/jvm_misc.hpp&quot;
  44 #include &quot;prims/jvmtiAgentThread.hpp&quot;
  45 #include &quot;prims/jvmtiClassFileReconstituter.hpp&quot;
  46 #include &quot;prims/jvmtiCodeBlobEvents.hpp&quot;
  47 #include &quot;prims/jvmtiExtensions.hpp&quot;
  48 #include &quot;prims/jvmtiGetLoadedClasses.hpp&quot;
  49 #include &quot;prims/jvmtiImpl.hpp&quot;
  50 #include &quot;prims/jvmtiManageCapabilities.hpp&quot;
  51 #include &quot;prims/jvmtiRawMonitor.hpp&quot;
  52 #include &quot;prims/jvmtiRedefineClasses.hpp&quot;
  53 #include &quot;prims/jvmtiTagMap.hpp&quot;
  54 #include &quot;prims/jvmtiThreadState.inline.hpp&quot;
  55 #include &quot;prims/jvmtiUtil.hpp&quot;
  56 #include &quot;runtime/arguments.hpp&quot;
  57 #include &quot;runtime/deoptimization.hpp&quot;
  58 #include &quot;runtime/fieldDescriptor.inline.hpp&quot;
  59 #include &quot;runtime/handles.inline.hpp&quot;
  60 #include &quot;runtime/interfaceSupport.inline.hpp&quot;
  61 #include &quot;runtime/javaCalls.hpp&quot;
  62 #include &quot;runtime/jfieldIDWorkaround.hpp&quot;
  63 #include &quot;runtime/jniHandles.inline.hpp&quot;
  64 #include &quot;runtime/objectMonitor.inline.hpp&quot;
  65 #include &quot;runtime/osThread.hpp&quot;
  66 #include &quot;runtime/reflectionUtils.hpp&quot;
  67 #include &quot;runtime/signature.hpp&quot;
  68 #include &quot;runtime/thread.inline.hpp&quot;
  69 #include &quot;runtime/threadHeapSampler.hpp&quot;
  70 #include &quot;runtime/threadSMR.hpp&quot;
  71 #include &quot;runtime/timerTrace.hpp&quot;
  72 #include &quot;runtime/vframe.inline.hpp&quot;
  73 #include &quot;runtime/vmThread.hpp&quot;
  74 #include &quot;services/threadService.hpp&quot;
  75 #include &quot;utilities/exceptions.hpp&quot;
  76 #include &quot;utilities/preserveException.hpp&quot;
  77 #include &quot;utilities/utf8.hpp&quot;
  78 
  79 
  80 #define FIXLATER 0 // REMOVE this when completed.
  81 
  82  // FIXLATER: hook into JvmtiTrace
  83 #define TraceJVMTICalls false
  84 
  85 JvmtiEnv::JvmtiEnv(jint version) : JvmtiEnvBase(version) {
  86 }
  87 
  88 JvmtiEnv::~JvmtiEnv() {
  89 }
  90 
  91 JvmtiEnv*
  92 JvmtiEnv::create_a_jvmti(jint version) {
  93   return new JvmtiEnv(version);
  94 }
  95 
  96 // VM operation class to copy jni function table at safepoint.
  97 // More than one java threads or jvmti agents may be reading/
  98 // modifying jni function tables. To reduce the risk of bad
  99 // interaction b/w these threads it is copied at safepoint.
 100 class VM_JNIFunctionTableCopier : public VM_Operation {
 101  private:
 102   const struct JNINativeInterface_ *_function_table;
 103  public:
 104   VM_JNIFunctionTableCopier(const struct JNINativeInterface_ *func_tbl) {
 105     _function_table = func_tbl;
 106   };
 107 
 108   VMOp_Type type() const { return VMOp_JNIFunctionTableCopier; }
 109   void doit() {
 110     copy_jni_function_table(_function_table);
 111   };
 112 };
 113 
 114 //
 115 // Do not change the &quot;prefix&quot; marker below, everything above it is copied
 116 // unchanged into the filled stub, everything below is controlled by the
 117 // stub filler (only method bodies are carried forward, and then only for
 118 // functionality still in the spec).
 119 //
 120 // end file prefix
 121 
 122   //
 123   // Memory Management functions
 124   //
 125 
 126 // mem_ptr - pre-checked for NULL
 127 jvmtiError
 128 JvmtiEnv::Allocate(jlong size, unsigned char** mem_ptr) {
 129   return allocate(size, mem_ptr);
 130 } /* end Allocate */
 131 
 132 
 133 // mem - NULL is a valid value, must be checked
 134 jvmtiError
 135 JvmtiEnv::Deallocate(unsigned char* mem) {
 136   return deallocate(mem);
 137 } /* end Deallocate */
 138 
 139 // Threads_lock NOT held, java_thread not protected by lock
 140 // java_thread - pre-checked
 141 // data - NULL is a valid value, must be checked
 142 jvmtiError
 143 JvmtiEnv::SetThreadLocalStorage(JavaThread* java_thread, const void* data) {
 144   JvmtiThreadState* state = java_thread-&gt;jvmti_thread_state();
 145   if (state == NULL) {
 146     if (data == NULL) {
 147       // leaving state unset same as data set to NULL
 148       return JVMTI_ERROR_NONE;
 149     }
 150     // otherwise, create the state
 151     state = JvmtiThreadState::state_for(java_thread);
 152     if (state == NULL) {
 153       return JVMTI_ERROR_THREAD_NOT_ALIVE;
 154     }
 155   }
 156   state-&gt;env_thread_state(this)-&gt;set_agent_thread_local_storage_data((void*)data);
 157   return JVMTI_ERROR_NONE;
 158 } /* end SetThreadLocalStorage */
 159 
 160 
 161 // Threads_lock NOT held
 162 // thread - NOT pre-checked
 163 // data_ptr - pre-checked for NULL
 164 jvmtiError
 165 JvmtiEnv::GetThreadLocalStorage(jthread thread, void** data_ptr) {
 166   JavaThread* current_thread = JavaThread::current();
 167   if (thread == NULL) {
 168     JvmtiThreadState* state = current_thread-&gt;jvmti_thread_state();
 169     *data_ptr = (state == NULL) ? NULL :
 170       state-&gt;env_thread_state(this)-&gt;get_agent_thread_local_storage_data();
 171   } else {
 172     // jvmti_GetThreadLocalStorage is &quot;in native&quot; and doesn&#39;t transition
 173     // the thread to _thread_in_vm. However, when the TLS for a thread
 174     // other than the current thread is required we need to transition
 175     // from native so as to resolve the jthread.
 176 
 177     ThreadInVMfromNative __tiv(current_thread);
 178     VM_ENTRY_BASE(jvmtiError, JvmtiEnv::GetThreadLocalStorage , current_thread)
 179     debug_only(VMNativeEntryWrapper __vew;)
 180 
 181     JavaThread* java_thread = NULL;
 182     ThreadsListHandle tlh(current_thread);
 183     jvmtiError err = JvmtiExport::cv_external_thread_to_JavaThread(tlh.list(), thread, &amp;java_thread, NULL);
 184     if (err != JVMTI_ERROR_NONE) {
 185       return err;
 186     }
 187 
 188     JvmtiThreadState* state = java_thread-&gt;jvmti_thread_state();
 189     *data_ptr = (state == NULL) ? NULL :
 190       state-&gt;env_thread_state(this)-&gt;get_agent_thread_local_storage_data();
 191   }
 192   return JVMTI_ERROR_NONE;
 193 } /* end GetThreadLocalStorage */
 194 
 195   //
 196   // Module functions
 197   //
 198 
 199 // module_count_ptr - pre-checked for NULL
 200 // modules_ptr - pre-checked for NULL
 201 jvmtiError
 202 JvmtiEnv::GetAllModules(jint* module_count_ptr, jobject** modules_ptr) {
 203     JvmtiModuleClosure jmc;
 204 
 205     return jmc.get_all_modules(this, module_count_ptr, modules_ptr);
 206 } /* end GetAllModules */
 207 
 208 
 209 // class_loader - NULL is a valid value, must be pre-checked
 210 // package_name - pre-checked for NULL
 211 // module_ptr - pre-checked for NULL
 212 jvmtiError
 213 JvmtiEnv::GetNamedModule(jobject class_loader, const char* package_name, jobject* module_ptr) {
 214   JavaThread* THREAD = JavaThread::current(); // pass to macros
 215   ResourceMark rm(THREAD);
 216 
 217   Handle h_loader (THREAD, JNIHandles::resolve(class_loader));
 218   // Check that loader is a subclass of java.lang.ClassLoader.
 219   if (h_loader.not_null() &amp;&amp; !java_lang_ClassLoader::is_subclass(h_loader-&gt;klass())) {
 220     return JVMTI_ERROR_ILLEGAL_ARGUMENT;
 221   }
 222   jobject module = Modules::get_named_module(h_loader, package_name, THREAD);
 223   if (HAS_PENDING_EXCEPTION) {
 224     CLEAR_PENDING_EXCEPTION;
 225     return JVMTI_ERROR_INTERNAL; // unexpected exception
 226   }
 227   *module_ptr = module;
 228   return JVMTI_ERROR_NONE;
 229 } /* end GetNamedModule */
 230 
 231 
 232 // module - pre-checked for NULL
 233 // to_module - pre-checked for NULL
 234 jvmtiError
 235 JvmtiEnv::AddModuleReads(jobject module, jobject to_module) {
 236   JavaThread* THREAD = JavaThread::current();
 237 
 238   // check module
 239   Handle h_module(THREAD, JNIHandles::resolve(module));
 240   if (!java_lang_Module::is_instance(h_module())) {
 241     return JVMTI_ERROR_INVALID_MODULE;
 242   }
 243   // check to_module
 244   Handle h_to_module(THREAD, JNIHandles::resolve(to_module));
 245   if (!java_lang_Module::is_instance(h_to_module())) {
 246     return JVMTI_ERROR_INVALID_MODULE;
 247   }
 248   return JvmtiExport::add_module_reads(h_module, h_to_module, THREAD);
 249 } /* end AddModuleReads */
 250 
 251 
 252 // module - pre-checked for NULL
 253 // pkg_name - pre-checked for NULL
 254 // to_module - pre-checked for NULL
 255 jvmtiError
 256 JvmtiEnv::AddModuleExports(jobject module, const char* pkg_name, jobject to_module) {
 257   JavaThread* THREAD = JavaThread::current();
 258   Handle h_pkg = java_lang_String::create_from_str(pkg_name, THREAD);
 259 
 260   // check module
 261   Handle h_module(THREAD, JNIHandles::resolve(module));
 262   if (!java_lang_Module::is_instance(h_module())) {
 263     return JVMTI_ERROR_INVALID_MODULE;
 264   }
 265   // check to_module
 266   Handle h_to_module(THREAD, JNIHandles::resolve(to_module));
 267   if (!java_lang_Module::is_instance(h_to_module())) {
 268     return JVMTI_ERROR_INVALID_MODULE;
 269   }
 270   return JvmtiExport::add_module_exports(h_module, h_pkg, h_to_module, THREAD);
 271 } /* end AddModuleExports */
 272 
 273 
 274 // module - pre-checked for NULL
 275 // pkg_name - pre-checked for NULL
 276 // to_module - pre-checked for NULL
 277 jvmtiError
 278 JvmtiEnv::AddModuleOpens(jobject module, const char* pkg_name, jobject to_module) {
 279   JavaThread* THREAD = JavaThread::current();
 280   Handle h_pkg = java_lang_String::create_from_str(pkg_name, THREAD);
 281 
 282   // check module
 283   Handle h_module(THREAD, JNIHandles::resolve(module));
 284   if (!java_lang_Module::is_instance(h_module())) {
 285     return JVMTI_ERROR_INVALID_MODULE;
 286   }
 287   // check to_module
 288   Handle h_to_module(THREAD, JNIHandles::resolve(to_module));
 289   if (!java_lang_Module::is_instance(h_to_module())) {
 290     return JVMTI_ERROR_INVALID_MODULE;
 291   }
 292   return JvmtiExport::add_module_opens(h_module, h_pkg, h_to_module, THREAD);
 293 } /* end AddModuleOpens */
 294 
 295 
 296 // module - pre-checked for NULL
 297 // service - pre-checked for NULL
 298 jvmtiError
 299 JvmtiEnv::AddModuleUses(jobject module, jclass service) {
 300   JavaThread* THREAD = JavaThread::current();
 301 
 302   // check module
 303   Handle h_module(THREAD, JNIHandles::resolve(module));
 304   if (!java_lang_Module::is_instance(h_module())) {
 305     return JVMTI_ERROR_INVALID_MODULE;
 306   }
 307   // check service
 308   Handle h_service(THREAD, JNIHandles::resolve_external_guard(service));
 309   if (!java_lang_Class::is_instance(h_service()) ||
 310       java_lang_Class::is_primitive(h_service())) {
 311     return JVMTI_ERROR_INVALID_CLASS;
 312   }
 313   return JvmtiExport::add_module_uses(h_module, h_service, THREAD);
 314 } /* end AddModuleUses */
 315 
 316 
 317 // module - pre-checked for NULL
 318 // service - pre-checked for NULL
 319 // impl_class - pre-checked for NULL
 320 jvmtiError
 321 JvmtiEnv::AddModuleProvides(jobject module, jclass service, jclass impl_class) {
 322   JavaThread* THREAD = JavaThread::current();
 323 
 324   // check module
 325   Handle h_module(THREAD, JNIHandles::resolve(module));
 326   if (!java_lang_Module::is_instance(h_module())) {
 327     return JVMTI_ERROR_INVALID_MODULE;
 328   }
 329   // check service
 330   Handle h_service(THREAD, JNIHandles::resolve_external_guard(service));
 331   if (!java_lang_Class::is_instance(h_service()) ||
 332       java_lang_Class::is_primitive(h_service())) {
 333     return JVMTI_ERROR_INVALID_CLASS;
 334   }
 335   // check impl_class
 336   Handle h_impl_class(THREAD, JNIHandles::resolve_external_guard(impl_class));
 337   if (!java_lang_Class::is_instance(h_impl_class()) ||
 338       java_lang_Class::is_primitive(h_impl_class())) {
 339     return JVMTI_ERROR_INVALID_CLASS;
 340   }
 341   return JvmtiExport::add_module_provides(h_module, h_service, h_impl_class, THREAD);
 342 } /* end AddModuleProvides */
 343 
 344 // module - pre-checked for NULL
 345 // is_modifiable_class_ptr - pre-checked for NULL
 346 jvmtiError
 347 JvmtiEnv::IsModifiableModule(jobject module, jboolean* is_modifiable_module_ptr) {
 348   JavaThread* THREAD = JavaThread::current();
 349 
 350   // check module
 351   Handle h_module(THREAD, JNIHandles::resolve(module));
 352   if (!java_lang_Module::is_instance(h_module())) {
 353     return JVMTI_ERROR_INVALID_MODULE;
 354   }
 355 
 356   *is_modifiable_module_ptr = JNI_TRUE;
 357   return JVMTI_ERROR_NONE;
 358 } /* end IsModifiableModule */
 359 
 360 
 361   //
 362   // Class functions
 363   //
 364 
 365 // class_count_ptr - pre-checked for NULL
 366 // classes_ptr - pre-checked for NULL
 367 jvmtiError
 368 JvmtiEnv::GetLoadedClasses(jint* class_count_ptr, jclass** classes_ptr) {
 369   return JvmtiGetLoadedClasses::getLoadedClasses(this, class_count_ptr, classes_ptr);
 370 } /* end GetLoadedClasses */
 371 
 372 
 373 // initiating_loader - NULL is a valid value, must be checked
 374 // class_count_ptr - pre-checked for NULL
 375 // classes_ptr - pre-checked for NULL
 376 jvmtiError
 377 JvmtiEnv::GetClassLoaderClasses(jobject initiating_loader, jint* class_count_ptr, jclass** classes_ptr) {
 378   return JvmtiGetLoadedClasses::getClassLoaderClasses(this, initiating_loader,
 379                                                   class_count_ptr, classes_ptr);
 380 } /* end GetClassLoaderClasses */
 381 
 382 // k_mirror - may be primitive, this must be checked
 383 // is_modifiable_class_ptr - pre-checked for NULL
 384 jvmtiError
 385 JvmtiEnv::IsModifiableClass(oop k_mirror, jboolean* is_modifiable_class_ptr) {
 386   *is_modifiable_class_ptr = VM_RedefineClasses::is_modifiable_class(k_mirror)?
 387                                                        JNI_TRUE : JNI_FALSE;
 388   return JVMTI_ERROR_NONE;
 389 } /* end IsModifiableClass */
 390 
 391 // class_count - pre-checked to be greater than or equal to 0
 392 // classes - pre-checked for NULL
 393 jvmtiError
 394 JvmtiEnv::RetransformClasses(jint class_count, const jclass* classes) {
 395 //TODO: add locking
 396 
 397   int index;
 398   JavaThread* current_thread = JavaThread::current();
 399   ResourceMark rm(current_thread);
 400 
 401   jvmtiClassDefinition* class_definitions =
 402                             NEW_RESOURCE_ARRAY(jvmtiClassDefinition, class_count);
 403   NULL_CHECK(class_definitions, JVMTI_ERROR_OUT_OF_MEMORY);
 404 
 405   for (index = 0; index &lt; class_count; index++) {
 406     HandleMark hm(current_thread);
 407 
 408     jclass jcls = classes[index];
 409     oop k_mirror = JNIHandles::resolve_external_guard(jcls);
 410     if (k_mirror == NULL) {
 411       return JVMTI_ERROR_INVALID_CLASS;
 412     }
 413     if (!k_mirror-&gt;is_a(SystemDictionary::Class_klass())) {
 414       return JVMTI_ERROR_INVALID_CLASS;
 415     }
 416 
 417     if (!VM_RedefineClasses::is_modifiable_class(k_mirror)) {
 418       return JVMTI_ERROR_UNMODIFIABLE_CLASS;
 419     }
 420 
 421     Klass* klass = java_lang_Class::as_Klass(k_mirror);
 422 
 423     jint status = klass-&gt;jvmti_class_status();
 424     if (status &amp; (JVMTI_CLASS_STATUS_ERROR)) {
 425       return JVMTI_ERROR_INVALID_CLASS;
 426     }
 427 
 428     InstanceKlass* ik = InstanceKlass::cast(klass);
 429     if (ik-&gt;get_cached_class_file_bytes() == NULL) {
 430       // Not cached, we need to reconstitute the class file from the
 431       // VM representation. We don&#39;t attach the reconstituted class
 432       // bytes to the InstanceKlass here because they have not been
 433       // validated and we&#39;re not at a safepoint.
 434       JvmtiClassFileReconstituter reconstituter(ik);
 435       if (reconstituter.get_error() != JVMTI_ERROR_NONE) {
 436         return reconstituter.get_error();
 437       }
 438 
 439       class_definitions[index].class_byte_count = (jint)reconstituter.class_file_size();
 440       class_definitions[index].class_bytes      = (unsigned char*)
 441                                                        reconstituter.class_file_bytes();
 442     } else {
 443       // it is cached, get it from the cache
 444       class_definitions[index].class_byte_count = ik-&gt;get_cached_class_file_len();
 445       class_definitions[index].class_bytes      = ik-&gt;get_cached_class_file_bytes();
 446     }
 447     class_definitions[index].klass              = jcls;
 448   }
<a name="2" id="anc2"></a>
 449   VM_RedefineClasses op(class_count, class_definitions, jvmti_class_load_kind_retransform);
 450   VMThread::execute(&amp;op);
<a name="3" id="anc3"></a><span class="line-modified"> 451   return (op.check_error());</span>






 452 } /* end RetransformClasses */
 453 
 454 
 455 // class_count - pre-checked to be greater than or equal to 0
 456 // class_definitions - pre-checked for NULL
 457 jvmtiError
 458 JvmtiEnv::RedefineClasses(jint class_count, const jvmtiClassDefinition* class_definitions) {
 459 //TODO: add locking
<a name="4" id="anc4"></a>
 460   VM_RedefineClasses op(class_count, class_definitions, jvmti_class_load_kind_redefine);
 461   VMThread::execute(&amp;op);
<a name="5" id="anc5"></a><span class="line-modified"> 462   return (op.check_error());</span>






 463 } /* end RedefineClasses */
 464 
 465 
 466   //
 467   // Object functions
 468   //
 469 
 470 // size_ptr - pre-checked for NULL
 471 jvmtiError
 472 JvmtiEnv::GetObjectSize(jobject object, jlong* size_ptr) {
 473   oop mirror = JNIHandles::resolve_external_guard(object);
 474   NULL_CHECK(mirror, JVMTI_ERROR_INVALID_OBJECT);
 475   *size_ptr = (jlong)Universe::heap()-&gt;obj_size(mirror) * wordSize;
 476   return JVMTI_ERROR_NONE;
 477 } /* end GetObjectSize */
 478 
 479   //
 480   // Method functions
 481   //
 482 
 483 // prefix - NULL is a valid value, must be checked
 484 jvmtiError
 485 JvmtiEnv::SetNativeMethodPrefix(const char* prefix) {
 486   return prefix == NULL?
 487               SetNativeMethodPrefixes(0, NULL) :
 488               SetNativeMethodPrefixes(1, (char**)&amp;prefix);
 489 } /* end SetNativeMethodPrefix */
 490 
 491 
 492 // prefix_count - pre-checked to be greater than or equal to 0
 493 // prefixes - pre-checked for NULL
 494 jvmtiError
 495 JvmtiEnv::SetNativeMethodPrefixes(jint prefix_count, char** prefixes) {
 496   // Have to grab JVMTI thread state lock to be sure that some thread
 497   // isn&#39;t accessing the prefixes at the same time we are setting them.
 498   // No locks during VM bring-up.
 499   if (Threads::number_of_threads() == 0) {
 500     return set_native_method_prefixes(prefix_count, prefixes);
 501   } else {
 502     MutexLocker mu(JvmtiThreadState_lock);
 503     return set_native_method_prefixes(prefix_count, prefixes);
 504   }
 505 } /* end SetNativeMethodPrefixes */
 506 
 507   //
 508   // Event Management functions
 509   //
 510 
 511 // callbacks - NULL is a valid value, must be checked
 512 // size_of_callbacks - pre-checked to be greater than or equal to 0
 513 jvmtiError
 514 JvmtiEnv::SetEventCallbacks(const jvmtiEventCallbacks* callbacks, jint size_of_callbacks) {
 515   JvmtiEventController::set_event_callbacks(this, callbacks, size_of_callbacks);
 516   return JVMTI_ERROR_NONE;
 517 } /* end SetEventCallbacks */
 518 
 519 
 520 // event_thread - NULL is a valid value, must be checked
 521 jvmtiError
 522 JvmtiEnv::SetEventNotificationMode(jvmtiEventMode mode, jvmtiEvent event_type, jthread event_thread,   ...) {
 523   if (event_thread == NULL) {
 524     // Can be called at Agent_OnLoad() time with event_thread == NULL
 525     // when Thread::current() does not work yet so we cannot create a
 526     // ThreadsListHandle that is common to both thread-specific and
 527     // global code paths.
 528 
 529     // event_type must be valid
 530     if (!JvmtiEventController::is_valid_event_type(event_type)) {
 531       return JVMTI_ERROR_INVALID_EVENT_TYPE;
 532     }
 533 
 534     bool enabled = (mode == JVMTI_ENABLE);
 535 
 536     // assure that needed capabilities are present
 537     if (enabled &amp;&amp; !JvmtiUtil::has_event_capability(event_type, get_capabilities())) {
 538       return JVMTI_ERROR_MUST_POSSESS_CAPABILITY;
 539     }
 540 
 541     if (event_type == JVMTI_EVENT_CLASS_FILE_LOAD_HOOK &amp;&amp; enabled) {
 542       record_class_file_load_hook_enabled();
 543     }
 544 
 545     JvmtiEventController::set_user_enabled(this, (JavaThread*) NULL, event_type, enabled);
 546   } else {
 547     // We have a specified event_thread.
 548     JavaThread* java_thread = NULL;
 549     ThreadsListHandle tlh;
 550     jvmtiError err = JvmtiExport::cv_external_thread_to_JavaThread(tlh.list(), event_thread, &amp;java_thread, NULL);
 551     if (err != JVMTI_ERROR_NONE) {
 552       return err;
 553     }
 554 
 555     // event_type must be valid
 556     if (!JvmtiEventController::is_valid_event_type(event_type)) {
 557       return JVMTI_ERROR_INVALID_EVENT_TYPE;
 558     }
 559 
 560     // global events cannot be controlled at thread level.
 561     if (JvmtiEventController::is_global_event(event_type)) {
 562       return JVMTI_ERROR_ILLEGAL_ARGUMENT;
 563     }
 564 
 565     bool enabled = (mode == JVMTI_ENABLE);
 566 
 567     // assure that needed capabilities are present
 568     if (enabled &amp;&amp; !JvmtiUtil::has_event_capability(event_type, get_capabilities())) {
 569       return JVMTI_ERROR_MUST_POSSESS_CAPABILITY;
 570     }
 571 
 572     if (event_type == JVMTI_EVENT_CLASS_FILE_LOAD_HOOK &amp;&amp; enabled) {
 573       record_class_file_load_hook_enabled();
 574     }
 575     JvmtiEventController::set_user_enabled(this, java_thread, event_type, enabled);
 576   }
 577 
 578   return JVMTI_ERROR_NONE;
 579 } /* end SetEventNotificationMode */
 580 
 581   //
 582   // Capability functions
 583   //
 584 
 585 // capabilities_ptr - pre-checked for NULL
 586 jvmtiError
 587 JvmtiEnv::GetPotentialCapabilities(jvmtiCapabilities* capabilities_ptr) {
 588   JvmtiManageCapabilities::get_potential_capabilities(get_capabilities(),
 589                                                       get_prohibited_capabilities(),
 590                                                       capabilities_ptr);
 591   return JVMTI_ERROR_NONE;
 592 } /* end GetPotentialCapabilities */
 593 
 594 
 595 // capabilities_ptr - pre-checked for NULL
 596 jvmtiError
 597 JvmtiEnv::AddCapabilities(const jvmtiCapabilities* capabilities_ptr) {
 598   return JvmtiManageCapabilities::add_capabilities(get_capabilities(),
 599                                                    get_prohibited_capabilities(),
 600                                                    capabilities_ptr,
 601                                                    get_capabilities());
 602 } /* end AddCapabilities */
 603 
 604 
 605 // capabilities_ptr - pre-checked for NULL
 606 jvmtiError
 607 JvmtiEnv::RelinquishCapabilities(const jvmtiCapabilities* capabilities_ptr) {
 608   JvmtiManageCapabilities::relinquish_capabilities(get_capabilities(), capabilities_ptr, get_capabilities());
 609   return JVMTI_ERROR_NONE;
 610 } /* end RelinquishCapabilities */
 611 
 612 
 613 // capabilities_ptr - pre-checked for NULL
 614 jvmtiError
 615 JvmtiEnv::GetCapabilities(jvmtiCapabilities* capabilities_ptr) {
 616   JvmtiManageCapabilities::copy_capabilities(get_capabilities(), capabilities_ptr);
 617   return JVMTI_ERROR_NONE;
 618 } /* end GetCapabilities */
 619 
 620   //
 621   // Class Loader Search functions
 622   //
 623 
 624 // segment - pre-checked for NULL
 625 jvmtiError
 626 JvmtiEnv::AddToBootstrapClassLoaderSearch(const char* segment) {
 627   jvmtiPhase phase = get_phase();
 628   if (phase == JVMTI_PHASE_ONLOAD) {
 629     Arguments::append_sysclasspath(segment);
 630     return JVMTI_ERROR_NONE;
 631   } else if (use_version_1_0_semantics()) {
 632     // This JvmtiEnv requested version 1.0 semantics and this function
 633     // is only allowed in the ONLOAD phase in version 1.0 so we need to
 634     // return an error here.
 635     return JVMTI_ERROR_WRONG_PHASE;
 636   } else if (phase == JVMTI_PHASE_LIVE) {
 637     // The phase is checked by the wrapper that called this function,
 638     // but this thread could be racing with the thread that is
 639     // terminating the VM so we check one more time.
 640 
 641     // create the zip entry
 642     ClassPathZipEntry* zip_entry = ClassLoader::create_class_path_zip_entry(segment, true);
 643     if (zip_entry == NULL) {
 644       return JVMTI_ERROR_ILLEGAL_ARGUMENT;
 645     }
 646 
 647     // lock the loader
 648     Thread* thread = Thread::current();
 649     HandleMark hm;
 650     Handle loader_lock = Handle(thread, SystemDictionary::system_loader_lock());
 651 
 652     ObjectLocker ol(loader_lock, thread);
 653 
 654     // add the jar file to the bootclasspath
 655     log_info(class, load)(&quot;opened: %s&quot;, zip_entry-&gt;name());
 656 #if INCLUDE_CDS
 657     ClassLoaderExt::append_boot_classpath(zip_entry);
 658 #else
 659     ClassLoader::add_to_boot_append_entries(zip_entry);
 660 #endif
 661     return JVMTI_ERROR_NONE;
 662   } else {
 663     return JVMTI_ERROR_WRONG_PHASE;
 664   }
 665 
 666 } /* end AddToBootstrapClassLoaderSearch */
 667 
 668 
 669 // segment - pre-checked for NULL
 670 jvmtiError
 671 JvmtiEnv::AddToSystemClassLoaderSearch(const char* segment) {
 672   jvmtiPhase phase = get_phase();
 673 
 674   if (phase == JVMTI_PHASE_ONLOAD) {
 675     for (SystemProperty* p = Arguments::system_properties(); p != NULL; p = p-&gt;next()) {
 676       if (strcmp(&quot;java.class.path&quot;, p-&gt;key()) == 0) {
 677         p-&gt;append_value(segment);
 678         break;
 679       }
 680     }
 681     return JVMTI_ERROR_NONE;
 682   } else if (phase == JVMTI_PHASE_LIVE) {
 683     // The phase is checked by the wrapper that called this function,
 684     // but this thread could be racing with the thread that is
 685     // terminating the VM so we check one more time.
 686     HandleMark hm;
 687 
 688     // create the zip entry (which will open the zip file and hence
 689     // check that the segment is indeed a zip file).
 690     ClassPathZipEntry* zip_entry = ClassLoader::create_class_path_zip_entry(segment, false);
 691     if (zip_entry == NULL) {
 692       return JVMTI_ERROR_ILLEGAL_ARGUMENT;
 693     }
 694     delete zip_entry;   // no longer needed
 695 
 696     // lock the loader
 697     Thread* THREAD = Thread::current();
 698     Handle loader = Handle(THREAD, SystemDictionary::java_system_loader());
 699 
 700     ObjectLocker ol(loader, THREAD);
 701 
 702     // need the path as java.lang.String
 703     Handle path = java_lang_String::create_from_platform_dependent_str(segment, THREAD);
 704     if (HAS_PENDING_EXCEPTION) {
 705       CLEAR_PENDING_EXCEPTION;
 706       return JVMTI_ERROR_INTERNAL;
 707     }
 708 
 709     // Invoke the appendToClassPathForInstrumentation method - if the method
 710     // is not found it means the loader doesn&#39;t support adding to the class path
 711     // in the live phase.
 712     {
 713       JavaValue res(T_VOID);
 714       JavaCalls::call_special(&amp;res,
 715                               loader,
 716                               loader-&gt;klass(),
 717                               vmSymbols::appendToClassPathForInstrumentation_name(),
 718                               vmSymbols::appendToClassPathForInstrumentation_signature(),
 719                               path,
 720                               THREAD);
 721       if (HAS_PENDING_EXCEPTION) {
 722         Symbol* ex_name = PENDING_EXCEPTION-&gt;klass()-&gt;name();
 723         CLEAR_PENDING_EXCEPTION;
 724 
 725         if (ex_name == vmSymbols::java_lang_NoSuchMethodError()) {
 726           return JVMTI_ERROR_CLASS_LOADER_UNSUPPORTED;
 727         } else {
 728           return JVMTI_ERROR_INTERNAL;
 729         }
 730       }
 731     }
 732 
 733     return JVMTI_ERROR_NONE;
 734   } else {
 735     return JVMTI_ERROR_WRONG_PHASE;
 736   }
 737 } /* end AddToSystemClassLoaderSearch */
 738 
 739   //
 740   // General functions
 741   //
 742 
 743 // phase_ptr - pre-checked for NULL
 744 jvmtiError
 745 JvmtiEnv::GetPhase(jvmtiPhase* phase_ptr) {
 746   *phase_ptr = phase();
 747   return JVMTI_ERROR_NONE;
 748 } /* end GetPhase */
 749 
 750 
 751 jvmtiError
 752 JvmtiEnv::DisposeEnvironment() {
 753   dispose();
 754   return JVMTI_ERROR_NONE;
 755 } /* end DisposeEnvironment */
 756 
 757 
 758 // data - NULL is a valid value, must be checked
 759 jvmtiError
 760 JvmtiEnv::SetEnvironmentLocalStorage(const void* data) {
 761   set_env_local_storage(data);
 762   return JVMTI_ERROR_NONE;
 763 } /* end SetEnvironmentLocalStorage */
 764 
 765 
 766 // data_ptr - pre-checked for NULL
 767 jvmtiError
 768 JvmtiEnv::GetEnvironmentLocalStorage(void** data_ptr) {
 769   *data_ptr = (void*)get_env_local_storage();
 770   return JVMTI_ERROR_NONE;
 771 } /* end GetEnvironmentLocalStorage */
 772 
 773 // version_ptr - pre-checked for NULL
 774 jvmtiError
 775 JvmtiEnv::GetVersionNumber(jint* version_ptr) {
 776   *version_ptr = JVMTI_VERSION;
 777   return JVMTI_ERROR_NONE;
 778 } /* end GetVersionNumber */
 779 
 780 
 781 // name_ptr - pre-checked for NULL
 782 jvmtiError
 783 JvmtiEnv::GetErrorName(jvmtiError error, char** name_ptr) {
 784   if (error &lt; JVMTI_ERROR_NONE || error &gt; JVMTI_ERROR_MAX) {
 785     return JVMTI_ERROR_ILLEGAL_ARGUMENT;
 786   }
 787   const char *name = JvmtiUtil::error_name(error);
 788   if (name == NULL) {
 789     return JVMTI_ERROR_ILLEGAL_ARGUMENT;
 790   }
 791   size_t len = strlen(name) + 1;
 792   jvmtiError err = allocate(len, (unsigned char**)name_ptr);
 793   if (err == JVMTI_ERROR_NONE) {
 794     memcpy(*name_ptr, name, len);
 795   }
 796   return err;
 797 } /* end GetErrorName */
 798 
 799 
 800 jvmtiError
 801 JvmtiEnv::SetVerboseFlag(jvmtiVerboseFlag flag, jboolean value) {
 802   LogLevelType level = value == 0 ? LogLevel::Off : LogLevel::Info;
 803   switch (flag) {
 804   case JVMTI_VERBOSE_OTHER:
 805     // ignore
 806     break;
 807   case JVMTI_VERBOSE_CLASS:
 808     LogConfiguration::configure_stdout(level, false, LOG_TAGS(class, unload));
 809     LogConfiguration::configure_stdout(level, false, LOG_TAGS(class, load));
 810     break;
 811   case JVMTI_VERBOSE_GC:
 812     LogConfiguration::configure_stdout(level, true, LOG_TAGS(gc));
 813     break;
 814   case JVMTI_VERBOSE_JNI:
 815     level = value == 0 ? LogLevel::Off : LogLevel::Debug;
 816     LogConfiguration::configure_stdout(level, true, LOG_TAGS(jni, resolve));
 817     break;
 818   default:
 819     return JVMTI_ERROR_ILLEGAL_ARGUMENT;
 820   };
 821   return JVMTI_ERROR_NONE;
 822 } /* end SetVerboseFlag */
 823 
 824 
 825 // format_ptr - pre-checked for NULL
 826 jvmtiError
 827 JvmtiEnv::GetJLocationFormat(jvmtiJlocationFormat* format_ptr) {
 828   *format_ptr = JVMTI_JLOCATION_JVMBCI;
 829   return JVMTI_ERROR_NONE;
 830 } /* end GetJLocationFormat */
 831 
 832   //
 833   // Thread functions
 834   //
 835 
 836 // Threads_lock NOT held
 837 // thread - NOT pre-checked
 838 // thread_state_ptr - pre-checked for NULL
 839 jvmtiError
 840 JvmtiEnv::GetThreadState(jthread thread, jint* thread_state_ptr) {
 841   JavaThread* current_thread = JavaThread::current();
 842   JavaThread* java_thread = NULL;
 843   oop thread_oop = NULL;
 844   ThreadsListHandle tlh(current_thread);
 845 
 846   if (thread == NULL) {
 847     java_thread = current_thread;
 848     thread_oop = java_thread-&gt;threadObj();
 849 
 850     if (thread_oop == NULL || !thread_oop-&gt;is_a(SystemDictionary::Thread_klass())) {
 851       return JVMTI_ERROR_INVALID_THREAD;
 852     }
 853   } else {
 854     jvmtiError err = JvmtiExport::cv_external_thread_to_JavaThread(tlh.list(), thread, &amp;java_thread, &amp;thread_oop);
 855     if (err != JVMTI_ERROR_NONE) {
 856       // We got an error code so we don&#39;t have a JavaThread *, but
 857       // only return an error from here if we didn&#39;t get a valid
 858       // thread_oop.
 859       if (thread_oop == NULL) {
 860         return err;
 861       }
 862       // We have a valid thread_oop so we can return some thread state.
 863     }
 864   }
 865 
 866   // get most state bits
 867   jint state = (jint)java_lang_Thread::get_thread_status(thread_oop);
 868 
 869   if (java_thread != NULL) {
 870     // We have a JavaThread* so add more state bits.
 871     JavaThreadState jts = java_thread-&gt;thread_state();
 872 
 873     if (java_thread-&gt;is_being_ext_suspended()) {
 874       state |= JVMTI_THREAD_STATE_SUSPENDED;
 875     }
 876     if (jts == _thread_in_native) {
 877       state |= JVMTI_THREAD_STATE_IN_NATIVE;
 878     }
 879     if (java_thread-&gt;is_interrupted(false)) {
 880       state |= JVMTI_THREAD_STATE_INTERRUPTED;
 881     }
 882   }
 883 
 884   *thread_state_ptr = state;
 885   return JVMTI_ERROR_NONE;
 886 } /* end GetThreadState */
 887 
 888 
 889 // thread_ptr - pre-checked for NULL
 890 jvmtiError
 891 JvmtiEnv::GetCurrentThread(jthread* thread_ptr) {
 892   JavaThread* current_thread  = JavaThread::current();
 893   *thread_ptr = (jthread)JNIHandles::make_local(current_thread, current_thread-&gt;threadObj());
 894   return JVMTI_ERROR_NONE;
 895 } /* end GetCurrentThread */
 896 
 897 
 898 // threads_count_ptr - pre-checked for NULL
 899 // threads_ptr - pre-checked for NULL
 900 jvmtiError
 901 JvmtiEnv::GetAllThreads(jint* threads_count_ptr, jthread** threads_ptr) {
 902   int nthreads        = 0;
 903   Handle *thread_objs = NULL;
 904   ResourceMark rm;
 905   HandleMark hm;
 906 
 907   // enumerate threads (including agent threads)
 908   ThreadsListEnumerator tle(Thread::current(), true);
 909   nthreads = tle.num_threads();
 910   *threads_count_ptr = nthreads;
 911 
 912   if (nthreads == 0) {
 913     *threads_ptr = NULL;
 914     return JVMTI_ERROR_NONE;
 915   }
 916 
 917   thread_objs = NEW_RESOURCE_ARRAY(Handle, nthreads);
 918   NULL_CHECK(thread_objs, JVMTI_ERROR_OUT_OF_MEMORY);
 919 
 920   for (int i = 0; i &lt; nthreads; i++) {
 921     thread_objs[i] = Handle(tle.get_threadObj(i));
 922   }
 923 
 924   jthread *jthreads  = new_jthreadArray(nthreads, thread_objs);
 925   NULL_CHECK(jthreads, JVMTI_ERROR_OUT_OF_MEMORY);
 926 
 927   *threads_ptr = jthreads;
 928   return JVMTI_ERROR_NONE;
 929 } /* end GetAllThreads */
 930 
 931 
 932 // Threads_lock NOT held, java_thread not protected by lock
 933 // java_thread - pre-checked
 934 jvmtiError
 935 JvmtiEnv::SuspendThread(JavaThread* java_thread) {
 936   // don&#39;t allow hidden thread suspend request.
 937   if (java_thread-&gt;is_hidden_from_external_view()) {
 938     return (JVMTI_ERROR_NONE);
 939   }
 940 
 941   {
 942     MutexLocker ml(java_thread-&gt;SR_lock(), Mutex::_no_safepoint_check_flag);
 943     if (java_thread-&gt;is_external_suspend()) {
 944       // don&#39;t allow nested external suspend requests.
 945       return (JVMTI_ERROR_THREAD_SUSPENDED);
 946     }
 947     if (java_thread-&gt;is_exiting()) { // thread is in the process of exiting
 948       return (JVMTI_ERROR_THREAD_NOT_ALIVE);
 949     }
 950     java_thread-&gt;set_external_suspend();
 951   }
 952 
 953   if (!JvmtiSuspendControl::suspend(java_thread)) {
 954     // the thread was in the process of exiting
 955     return (JVMTI_ERROR_THREAD_NOT_ALIVE);
 956   }
 957   return JVMTI_ERROR_NONE;
 958 } /* end SuspendThread */
 959 
 960 
 961 // request_count - pre-checked to be greater than or equal to 0
 962 // request_list - pre-checked for NULL
 963 // results - pre-checked for NULL
 964 jvmtiError
 965 JvmtiEnv::SuspendThreadList(jint request_count, const jthread* request_list, jvmtiError* results) {
 966   int needSafepoint = 0;  // &gt; 0 if we need a safepoint
 967   ThreadsListHandle tlh;
 968   for (int i = 0; i &lt; request_count; i++) {
 969     JavaThread *java_thread = NULL;
 970     jvmtiError err = JvmtiExport::cv_external_thread_to_JavaThread(tlh.list(), request_list[i], &amp;java_thread, NULL);
 971     if (err != JVMTI_ERROR_NONE) {
 972       results[i] = err;
 973       continue;
 974     }
 975     // don&#39;t allow hidden thread suspend request.
 976     if (java_thread-&gt;is_hidden_from_external_view()) {
 977       results[i] = JVMTI_ERROR_NONE;  // indicate successful suspend
 978       continue;
 979     }
 980 
 981     {
 982       MutexLocker ml(java_thread-&gt;SR_lock(), Mutex::_no_safepoint_check_flag);
 983       if (java_thread-&gt;is_external_suspend()) {
 984         // don&#39;t allow nested external suspend requests.
 985         results[i] = JVMTI_ERROR_THREAD_SUSPENDED;
 986         continue;
 987       }
 988       if (java_thread-&gt;is_exiting()) { // thread is in the process of exiting
 989         results[i] = JVMTI_ERROR_THREAD_NOT_ALIVE;
 990         continue;
 991       }
 992       java_thread-&gt;set_external_suspend();
 993     }
 994     if (java_thread-&gt;thread_state() == _thread_in_native) {
 995       // We need to try and suspend native threads here. Threads in
 996       // other states will self-suspend on their next transition.
 997       if (!JvmtiSuspendControl::suspend(java_thread)) {
 998         // The thread was in the process of exiting. Force another
 999         // safepoint to make sure that this thread transitions.
1000         needSafepoint++;
1001         results[i] = JVMTI_ERROR_THREAD_NOT_ALIVE;
1002         continue;
1003       }
1004     } else {
1005       needSafepoint++;
1006     }
1007     results[i] = JVMTI_ERROR_NONE;  // indicate successful suspend
1008   }
1009   if (needSafepoint &gt; 0) {
1010     VM_ThreadsSuspendJVMTI tsj;
1011     VMThread::execute(&amp;tsj);
1012   }
1013   // per-thread suspend results returned via results parameter
1014   return JVMTI_ERROR_NONE;
1015 } /* end SuspendThreadList */
1016 
1017 
1018 // Threads_lock NOT held, java_thread not protected by lock
1019 // java_thread - pre-checked
1020 jvmtiError
1021 JvmtiEnv::ResumeThread(JavaThread* java_thread) {
1022   // don&#39;t allow hidden thread resume request.
1023   if (java_thread-&gt;is_hidden_from_external_view()) {
1024     return JVMTI_ERROR_NONE;
1025   }
1026 
1027   if (!java_thread-&gt;is_being_ext_suspended()) {
1028     return JVMTI_ERROR_THREAD_NOT_SUSPENDED;
1029   }
1030 
1031   if (!JvmtiSuspendControl::resume(java_thread)) {
1032     return JVMTI_ERROR_INTERNAL;
1033   }
1034   return JVMTI_ERROR_NONE;
1035 } /* end ResumeThread */
1036 
1037 
1038 // request_count - pre-checked to be greater than or equal to 0
1039 // request_list - pre-checked for NULL
1040 // results - pre-checked for NULL
1041 jvmtiError
1042 JvmtiEnv::ResumeThreadList(jint request_count, const jthread* request_list, jvmtiError* results) {
1043   ThreadsListHandle tlh;
1044   for (int i = 0; i &lt; request_count; i++) {
1045     JavaThread* java_thread = NULL;
1046     jvmtiError err = JvmtiExport::cv_external_thread_to_JavaThread(tlh.list(), request_list[i], &amp;java_thread, NULL);
1047     if (err != JVMTI_ERROR_NONE) {
1048       results[i] = err;
1049       continue;
1050     }
1051     // don&#39;t allow hidden thread resume request.
1052     if (java_thread-&gt;is_hidden_from_external_view()) {
1053       results[i] = JVMTI_ERROR_NONE;  // indicate successful resume
1054       continue;
1055     }
1056     if (!java_thread-&gt;is_being_ext_suspended()) {
1057       results[i] = JVMTI_ERROR_THREAD_NOT_SUSPENDED;
1058       continue;
1059     }
1060 
1061     if (!JvmtiSuspendControl::resume(java_thread)) {
1062       results[i] = JVMTI_ERROR_INTERNAL;
1063       continue;
1064     }
1065 
1066     results[i] = JVMTI_ERROR_NONE;  // indicate successful resume
1067   }
1068   // per-thread resume results returned via results parameter
1069   return JVMTI_ERROR_NONE;
1070 } /* end ResumeThreadList */
1071 
1072 
1073 // Threads_lock NOT held, java_thread not protected by lock
1074 // java_thread - pre-checked
1075 jvmtiError
1076 JvmtiEnv::StopThread(JavaThread* java_thread, jobject exception) {
1077   oop e = JNIHandles::resolve_external_guard(exception);
1078   NULL_CHECK(e, JVMTI_ERROR_NULL_POINTER);
1079 
1080   JavaThread::send_async_exception(java_thread-&gt;threadObj(), e);
1081 
1082   return JVMTI_ERROR_NONE;
1083 
1084 } /* end StopThread */
1085 
1086 
1087 // Threads_lock NOT held
1088 // thread - NOT pre-checked
1089 jvmtiError
1090 JvmtiEnv::InterruptThread(jthread thread) {
1091   JavaThread* current_thread  = JavaThread::current();
1092   JavaThread* java_thread = NULL;
1093   ThreadsListHandle tlh(current_thread);
1094   jvmtiError err = JvmtiExport::cv_external_thread_to_JavaThread(tlh.list(), thread, &amp;java_thread, NULL);
1095   if (err != JVMTI_ERROR_NONE) {
1096     return err;
1097   }
1098   // Really this should be a Java call to Thread.interrupt to ensure the same
1099   // semantics, however historically this has not been done for some reason.
1100   // So we continue with that (which means we don&#39;t interact with any Java-level
1101   // Interruptible object) but we must set the Java-level interrupted state.
1102   java_lang_Thread::set_interrupted(JNIHandles::resolve(thread), true);
1103   java_thread-&gt;interrupt();
1104 
1105   return JVMTI_ERROR_NONE;
1106 } /* end InterruptThread */
1107 
1108 
1109 // Threads_lock NOT held
1110 // thread - NOT pre-checked
1111 // info_ptr - pre-checked for NULL
1112 jvmtiError
1113 JvmtiEnv::GetThreadInfo(jthread thread, jvmtiThreadInfo* info_ptr) {
1114   ResourceMark rm;
1115   HandleMark hm;
1116 
1117   JavaThread* current_thread = JavaThread::current();
1118   ThreadsListHandle tlh(current_thread);
1119 
1120   // if thread is NULL the current thread is used
1121   oop thread_oop = NULL;
1122   if (thread == NULL) {
1123     thread_oop = current_thread-&gt;threadObj();
1124     if (thread_oop == NULL || !thread_oop-&gt;is_a(SystemDictionary::Thread_klass())) {
1125       return JVMTI_ERROR_INVALID_THREAD;
1126     }
1127   } else {
1128     JavaThread* java_thread = NULL;
1129     jvmtiError err = JvmtiExport::cv_external_thread_to_JavaThread(tlh.list(), thread, &amp;java_thread, &amp;thread_oop);
1130     if (err != JVMTI_ERROR_NONE) {
1131       // We got an error code so we don&#39;t have a JavaThread *, but
1132       // only return an error from here if we didn&#39;t get a valid
1133       // thread_oop.
1134       if (thread_oop == NULL) {
1135         return err;
1136       }
1137       // We have a valid thread_oop so we can return some thread info.
1138     }
1139   }
1140 
1141   Handle thread_obj(current_thread, thread_oop);
1142   Handle name;
1143   ThreadPriority priority;
1144   Handle     thread_group;
1145   Handle context_class_loader;
1146   bool          is_daemon;
1147 
1148   name = Handle(current_thread, java_lang_Thread::name(thread_obj()));
1149   priority = java_lang_Thread::priority(thread_obj());
1150   thread_group = Handle(current_thread, java_lang_Thread::threadGroup(thread_obj()));
1151   is_daemon = java_lang_Thread::is_daemon(thread_obj());
1152 
1153   oop loader = java_lang_Thread::context_class_loader(thread_obj());
1154   context_class_loader = Handle(current_thread, loader);
1155 
1156   { const char *n;
1157 
1158     if (name() != NULL) {
1159       n = java_lang_String::as_utf8_string(name());
1160     } else {
1161       int utf8_length = 0;
1162       n = UNICODE::as_utf8((jchar*) NULL, utf8_length);
1163     }
1164 
1165     info_ptr-&gt;name = (char *) jvmtiMalloc(strlen(n)+1);
1166     if (info_ptr-&gt;name == NULL)
1167       return JVMTI_ERROR_OUT_OF_MEMORY;
1168 
1169     strcpy(info_ptr-&gt;name, n);
1170   }
1171   info_ptr-&gt;is_daemon = is_daemon;
1172   info_ptr-&gt;priority  = priority;
1173 
1174   info_ptr-&gt;context_class_loader = (context_class_loader.is_null()) ? NULL :
1175                                      jni_reference(context_class_loader);
1176   info_ptr-&gt;thread_group = jni_reference(thread_group);
1177 
1178   return JVMTI_ERROR_NONE;
1179 } /* end GetThreadInfo */
1180 
1181 
1182 // Threads_lock NOT held, java_thread not protected by lock
1183 // java_thread - pre-checked
1184 // owned_monitor_count_ptr - pre-checked for NULL
1185 // owned_monitors_ptr - pre-checked for NULL
1186 jvmtiError
1187 JvmtiEnv::GetOwnedMonitorInfo(JavaThread* java_thread, jint* owned_monitor_count_ptr, jobject** owned_monitors_ptr) {
1188   jvmtiError err = JVMTI_ERROR_NONE;
1189   JavaThread* calling_thread = JavaThread::current();
1190 
1191   // growable array of jvmti monitors info on the C-heap
1192   GrowableArray&lt;jvmtiMonitorStackDepthInfo*&gt; *owned_monitors_list =
1193       new (ResourceObj::C_HEAP, mtInternal) GrowableArray&lt;jvmtiMonitorStackDepthInfo*&gt;(1, true);
1194 
1195   // It is only safe to perform the direct operation on the current
1196   // thread. All other usage needs to use a vm-safepoint-op for safety.
1197   if (java_thread == calling_thread) {
1198     err = get_owned_monitors(calling_thread, java_thread, owned_monitors_list);
1199   } else {
1200     // JVMTI get monitors info at safepoint. Do not require target thread to
1201     // be suspended.
1202     VM_GetOwnedMonitorInfo op(this, calling_thread, java_thread, owned_monitors_list);
1203     VMThread::execute(&amp;op);
1204     err = op.result();
1205   }
1206   jint owned_monitor_count = owned_monitors_list-&gt;length();
1207   if (err == JVMTI_ERROR_NONE) {
1208     if ((err = allocate(owned_monitor_count * sizeof(jobject *),
1209                       (unsigned char**)owned_monitors_ptr)) == JVMTI_ERROR_NONE) {
1210       // copy into the returned array
1211       for (int i = 0; i &lt; owned_monitor_count; i++) {
1212         (*owned_monitors_ptr)[i] =
1213           ((jvmtiMonitorStackDepthInfo*)owned_monitors_list-&gt;at(i))-&gt;monitor;
1214       }
1215       *owned_monitor_count_ptr = owned_monitor_count;
1216     }
1217   }
1218   // clean up.
1219   for (int i = 0; i &lt; owned_monitor_count; i++) {
1220     deallocate((unsigned char*)owned_monitors_list-&gt;at(i));
1221   }
1222   delete owned_monitors_list;
1223 
1224   return err;
1225 } /* end GetOwnedMonitorInfo */
1226 
1227 
1228 // Threads_lock NOT held, java_thread not protected by lock
1229 // java_thread - pre-checked
1230 // monitor_info_count_ptr - pre-checked for NULL
1231 // monitor_info_ptr - pre-checked for NULL
1232 jvmtiError
1233 JvmtiEnv::GetOwnedMonitorStackDepthInfo(JavaThread* java_thread, jint* monitor_info_count_ptr, jvmtiMonitorStackDepthInfo** monitor_info_ptr) {
1234   jvmtiError err = JVMTI_ERROR_NONE;
1235   JavaThread* calling_thread  = JavaThread::current();
1236 
1237   // growable array of jvmti monitors info on the C-heap
1238   GrowableArray&lt;jvmtiMonitorStackDepthInfo*&gt; *owned_monitors_list =
1239          new (ResourceObj::C_HEAP, mtInternal) GrowableArray&lt;jvmtiMonitorStackDepthInfo*&gt;(1, true);
1240 
1241   // It is only safe to perform the direct operation on the current
1242   // thread. All other usage needs to use a vm-safepoint-op for safety.
1243   if (java_thread == calling_thread) {
1244     err = get_owned_monitors(calling_thread, java_thread, owned_monitors_list);
1245   } else {
1246     // JVMTI get owned monitors info at safepoint. Do not require target thread to
1247     // be suspended.
1248     VM_GetOwnedMonitorInfo op(this, calling_thread, java_thread, owned_monitors_list);
1249     VMThread::execute(&amp;op);
1250     err = op.result();
1251   }
1252 
1253   jint owned_monitor_count = owned_monitors_list-&gt;length();
1254   if (err == JVMTI_ERROR_NONE) {
1255     if ((err = allocate(owned_monitor_count * sizeof(jvmtiMonitorStackDepthInfo),
1256                       (unsigned char**)monitor_info_ptr)) == JVMTI_ERROR_NONE) {
1257       // copy to output array.
1258       for (int i = 0; i &lt; owned_monitor_count; i++) {
1259         (*monitor_info_ptr)[i].monitor =
1260           ((jvmtiMonitorStackDepthInfo*)owned_monitors_list-&gt;at(i))-&gt;monitor;
1261         (*monitor_info_ptr)[i].stack_depth =
1262           ((jvmtiMonitorStackDepthInfo*)owned_monitors_list-&gt;at(i))-&gt;stack_depth;
1263       }
1264     }
1265     *monitor_info_count_ptr = owned_monitor_count;
1266   }
1267 
1268   // clean up.
1269   for (int i = 0; i &lt; owned_monitor_count; i++) {
1270     deallocate((unsigned char*)owned_monitors_list-&gt;at(i));
1271   }
1272   delete owned_monitors_list;
1273 
1274   return err;
1275 } /* end GetOwnedMonitorStackDepthInfo */
1276 
1277 
1278 // Threads_lock NOT held, java_thread not protected by lock
1279 // java_thread - pre-checked
1280 // monitor_ptr - pre-checked for NULL
1281 jvmtiError
1282 JvmtiEnv::GetCurrentContendedMonitor(JavaThread* java_thread, jobject* monitor_ptr) {
1283   jvmtiError err = JVMTI_ERROR_NONE;
1284   JavaThread* calling_thread  = JavaThread::current();
1285 
1286   // It is only safe to perform the direct operation on the current
1287   // thread. All other usage needs to use a vm-safepoint-op for safety.
1288   if (java_thread == calling_thread) {
1289     err = get_current_contended_monitor(calling_thread, java_thread, monitor_ptr);
1290   } else {
1291     // get contended monitor information at safepoint.
1292     VM_GetCurrentContendedMonitor op(this, calling_thread, java_thread, monitor_ptr);
1293     VMThread::execute(&amp;op);
1294     err = op.result();
1295   }
1296   return err;
1297 } /* end GetCurrentContendedMonitor */
1298 
1299 
1300 // Threads_lock NOT held
1301 // thread - NOT pre-checked
1302 // proc - pre-checked for NULL
1303 // arg - NULL is a valid value, must be checked
1304 jvmtiError
1305 JvmtiEnv::RunAgentThread(jthread thread, jvmtiStartFunction proc, const void* arg, jint priority) {
1306   JavaThread* current_thread = JavaThread::current();
1307 
1308   JavaThread* java_thread = NULL;
1309   oop thread_oop = NULL;
1310   ThreadsListHandle tlh(current_thread);
1311   jvmtiError err = JvmtiExport::cv_external_thread_to_JavaThread(tlh.list(), thread, &amp;java_thread, &amp;thread_oop);
1312   if (err != JVMTI_ERROR_NONE) {
1313     // We got an error code so we don&#39;t have a JavaThread *, but
1314     // only return an error from here if we didn&#39;t get a valid
1315     // thread_oop.
1316     if (thread_oop == NULL) {
1317       return err;
1318     }
1319     // We have a valid thread_oop.
1320   }
1321 
1322   if (java_thread != NULL) {
1323     // &#39;thread&#39; refers to an existing JavaThread.
1324     return JVMTI_ERROR_INVALID_THREAD;
1325   }
1326 
1327   if (priority &lt; JVMTI_THREAD_MIN_PRIORITY || priority &gt; JVMTI_THREAD_MAX_PRIORITY) {
1328     return JVMTI_ERROR_INVALID_PRIORITY;
1329   }
1330 
1331   Handle thread_hndl(current_thread, thread_oop);
1332   {
1333     MutexLocker mu(current_thread, Threads_lock); // grab Threads_lock
1334 
1335     JvmtiAgentThread *new_thread = new JvmtiAgentThread(this, proc, arg);
1336 
1337     // At this point it may be possible that no osthread was created for the
1338     // JavaThread due to lack of memory.
1339     if (new_thread == NULL || new_thread-&gt;osthread() == NULL) {
1340       if (new_thread != NULL) {
1341         new_thread-&gt;smr_delete();
1342       }
1343       return JVMTI_ERROR_OUT_OF_MEMORY;
1344     }
1345 
1346     java_lang_Thread::set_thread(thread_hndl(), new_thread);
1347     java_lang_Thread::set_priority(thread_hndl(), (ThreadPriority)priority);
1348     java_lang_Thread::set_daemon(thread_hndl());
1349 
1350     new_thread-&gt;set_threadObj(thread_hndl());
1351     Threads::add(new_thread);
1352     Thread::start(new_thread);
1353   } // unlock Threads_lock
1354 
1355   return JVMTI_ERROR_NONE;
1356 } /* end RunAgentThread */
1357 
1358   //
1359   // Thread Group functions
1360   //
1361 
1362 // group_count_ptr - pre-checked for NULL
1363 // groups_ptr - pre-checked for NULL
1364 jvmtiError
1365 JvmtiEnv::GetTopThreadGroups(jint* group_count_ptr, jthreadGroup** groups_ptr) {
1366   JavaThread* current_thread = JavaThread::current();
1367 
1368   // Only one top level thread group now.
1369   *group_count_ptr = 1;
1370 
1371   // Allocate memory to store global-refs to the thread groups.
1372   // Assume this area is freed by caller.
1373   *groups_ptr = (jthreadGroup *) jvmtiMalloc((sizeof(jthreadGroup)) * (*group_count_ptr));
1374 
1375   NULL_CHECK(*groups_ptr, JVMTI_ERROR_OUT_OF_MEMORY);
1376 
1377   // Convert oop to Handle, then convert Handle to global-ref.
1378   {
1379     HandleMark hm(current_thread);
1380     Handle system_thread_group(current_thread, Universe::system_thread_group());
1381     *groups_ptr[0] = jni_reference(system_thread_group);
1382   }
1383 
1384   return JVMTI_ERROR_NONE;
1385 } /* end GetTopThreadGroups */
1386 
1387 
1388 // info_ptr - pre-checked for NULL
1389 jvmtiError
1390 JvmtiEnv::GetThreadGroupInfo(jthreadGroup group, jvmtiThreadGroupInfo* info_ptr) {
1391   ResourceMark rm;
1392   HandleMark hm;
1393 
1394   JavaThread* current_thread = JavaThread::current();
1395 
1396   Handle group_obj (current_thread, JNIHandles::resolve_external_guard(group));
1397   NULL_CHECK(group_obj(), JVMTI_ERROR_INVALID_THREAD_GROUP);
1398 
1399   const char* name;
1400   Handle parent_group;
1401   bool is_daemon;
1402   ThreadPriority max_priority;
1403 
1404   name         = java_lang_ThreadGroup::name(group_obj());
1405   parent_group = Handle(current_thread, java_lang_ThreadGroup::parent(group_obj()));
1406   is_daemon    = java_lang_ThreadGroup::is_daemon(group_obj());
1407   max_priority = java_lang_ThreadGroup::maxPriority(group_obj());
1408 
1409   info_ptr-&gt;is_daemon    = is_daemon;
1410   info_ptr-&gt;max_priority = max_priority;
1411   info_ptr-&gt;parent       = jni_reference(parent_group);
1412 
1413   if (name != NULL) {
1414     info_ptr-&gt;name = (char*)jvmtiMalloc(strlen(name)+1);
1415     NULL_CHECK(info_ptr-&gt;name, JVMTI_ERROR_OUT_OF_MEMORY);
1416     strcpy(info_ptr-&gt;name, name);
1417   } else {
1418     info_ptr-&gt;name = NULL;
1419   }
1420 
1421   return JVMTI_ERROR_NONE;
1422 } /* end GetThreadGroupInfo */
1423 
1424 
1425 // thread_count_ptr - pre-checked for NULL
1426 // threads_ptr - pre-checked for NULL
1427 // group_count_ptr - pre-checked for NULL
1428 // groups_ptr - pre-checked for NULL
1429 jvmtiError
1430 JvmtiEnv::GetThreadGroupChildren(jthreadGroup group, jint* thread_count_ptr, jthread** threads_ptr, jint* group_count_ptr, jthreadGroup** groups_ptr) {
1431   JavaThread* current_thread = JavaThread::current();
1432   oop group_obj = (oop) JNIHandles::resolve_external_guard(group);
1433   NULL_CHECK(group_obj, JVMTI_ERROR_INVALID_THREAD_GROUP);
1434 
1435   Handle *thread_objs = NULL;
1436   Handle *group_objs  = NULL;
1437   int nthreads = 0;
1438   int ngroups = 0;
1439   int hidden_threads = 0;
1440 
1441   ResourceMark rm(current_thread);
1442   HandleMark hm(current_thread);
1443 
1444   Handle group_hdl(current_thread, group_obj);
1445 
1446   { // Cannot allow thread or group counts to change.
1447     ObjectLocker ol(group_hdl, current_thread);
1448 
1449     nthreads = java_lang_ThreadGroup::nthreads(group_hdl());
1450     ngroups  = java_lang_ThreadGroup::ngroups(group_hdl());
1451 
1452     if (nthreads &gt; 0) {
1453       ThreadsListHandle tlh(current_thread);
1454       objArrayOop threads = java_lang_ThreadGroup::threads(group_hdl());
1455       assert(nthreads &lt;= threads-&gt;length(), &quot;too many threads&quot;);
1456       thread_objs = NEW_RESOURCE_ARRAY(Handle,nthreads);
1457       for (int i = 0, j = 0; i &lt; nthreads; i++) {
1458         oop thread_obj = threads-&gt;obj_at(i);
1459         assert(thread_obj != NULL, &quot;thread_obj is NULL&quot;);
1460         JavaThread *java_thread = NULL;
1461         jvmtiError err = JvmtiExport::cv_oop_to_JavaThread(tlh.list(), thread_obj, &amp;java_thread);
1462         if (err == JVMTI_ERROR_NONE) {
1463           // Have a valid JavaThread*.
1464           if (java_thread-&gt;is_hidden_from_external_view()) {
1465             // Filter out hidden java threads.
1466             hidden_threads++;
1467             continue;
1468           }
1469         } else {
1470           // We couldn&#39;t convert thread_obj into a JavaThread*.
1471           if (err == JVMTI_ERROR_INVALID_THREAD) {
1472             // The thread_obj does not refer to a java.lang.Thread object
1473             // so skip it.
1474             hidden_threads++;
1475             continue;
1476           }
1477           // We have a valid thread_obj, but no JavaThread*; the caller
1478           // can still have limited use for the thread_obj.
1479         }
1480         thread_objs[j++] = Handle(current_thread, thread_obj);
1481       }
1482       nthreads -= hidden_threads;
1483     } // ThreadsListHandle is destroyed here.
1484 
1485     if (ngroups &gt; 0) {
1486       objArrayOop groups = java_lang_ThreadGroup::groups(group_hdl());
1487       assert(ngroups &lt;= groups-&gt;length(), &quot;too many groups&quot;);
1488       group_objs = NEW_RESOURCE_ARRAY(Handle,ngroups);
1489       for (int i = 0; i &lt; ngroups; i++) {
1490         oop group_obj = groups-&gt;obj_at(i);
1491         assert(group_obj != NULL, &quot;group_obj != NULL&quot;);
1492         group_objs[i] = Handle(current_thread, group_obj);
1493       }
1494     }
1495   } // ThreadGroup unlocked here
1496 
1497   *group_count_ptr  = ngroups;
1498   *thread_count_ptr = nthreads;
1499   *threads_ptr     = new_jthreadArray(nthreads, thread_objs);
1500   *groups_ptr      = new_jthreadGroupArray(ngroups, group_objs);
1501   if ((nthreads &gt; 0) &amp;&amp; (*threads_ptr == NULL)) {
1502     return JVMTI_ERROR_OUT_OF_MEMORY;
1503   }
1504   if ((ngroups &gt; 0) &amp;&amp; (*groups_ptr == NULL)) {
1505     return JVMTI_ERROR_OUT_OF_MEMORY;
1506   }
1507 
1508   return JVMTI_ERROR_NONE;
1509 } /* end GetThreadGroupChildren */
1510 
1511 
1512   //
1513   // Stack Frame functions
1514   //
1515 
1516 // Threads_lock NOT held, java_thread not protected by lock
1517 // java_thread - pre-checked
1518 // max_frame_count - pre-checked to be greater than or equal to 0
1519 // frame_buffer - pre-checked for NULL
1520 // count_ptr - pre-checked for NULL
1521 jvmtiError
1522 JvmtiEnv::GetStackTrace(JavaThread* java_thread, jint start_depth, jint max_frame_count, jvmtiFrameInfo* frame_buffer, jint* count_ptr) {
1523   jvmtiError err = JVMTI_ERROR_NONE;
1524 
1525   // It is only safe to perform the direct operation on the current
1526   // thread. All other usage needs to use a vm-safepoint-op for safety.
1527   if (java_thread == JavaThread::current()) {
1528     err = get_stack_trace(java_thread, start_depth, max_frame_count, frame_buffer, count_ptr);
1529   } else {
1530     // JVMTI get stack trace at safepoint. Do not require target thread to
1531     // be suspended.
1532     VM_GetStackTrace op(this, java_thread, start_depth, max_frame_count, frame_buffer, count_ptr);
1533     VMThread::execute(&amp;op);
1534     err = op.result();
1535   }
1536 
1537   return err;
1538 } /* end GetStackTrace */
1539 
1540 
1541 // max_frame_count - pre-checked to be greater than or equal to 0
1542 // stack_info_ptr - pre-checked for NULL
1543 // thread_count_ptr - pre-checked for NULL
1544 jvmtiError
1545 JvmtiEnv::GetAllStackTraces(jint max_frame_count, jvmtiStackInfo** stack_info_ptr, jint* thread_count_ptr) {
1546   jvmtiError err = JVMTI_ERROR_NONE;
1547   JavaThread* calling_thread = JavaThread::current();
1548 
1549   // JVMTI get stack traces at safepoint.
1550   VM_GetAllStackTraces op(this, calling_thread, max_frame_count);
1551   VMThread::execute(&amp;op);
1552   *thread_count_ptr = op.final_thread_count();
1553   *stack_info_ptr = op.stack_info();
1554   err = op.result();
1555   return err;
1556 } /* end GetAllStackTraces */
1557 
1558 
1559 // thread_count - pre-checked to be greater than or equal to 0
1560 // thread_list - pre-checked for NULL
1561 // max_frame_count - pre-checked to be greater than or equal to 0
1562 // stack_info_ptr - pre-checked for NULL
1563 jvmtiError
1564 JvmtiEnv::GetThreadListStackTraces(jint thread_count, const jthread* thread_list, jint max_frame_count, jvmtiStackInfo** stack_info_ptr) {
1565   jvmtiError err = JVMTI_ERROR_NONE;
1566   // JVMTI get stack traces at safepoint.
1567   VM_GetThreadListStackTraces op(this, thread_count, thread_list, max_frame_count);
1568   VMThread::execute(&amp;op);
1569   err = op.result();
1570   if (err == JVMTI_ERROR_NONE) {
1571     *stack_info_ptr = op.stack_info();
1572   }
1573   return err;
1574 } /* end GetThreadListStackTraces */
1575 
1576 
1577 // Threads_lock NOT held, java_thread not protected by lock
1578 // java_thread - pre-checked
1579 // count_ptr - pre-checked for NULL
1580 jvmtiError
1581 JvmtiEnv::GetFrameCount(JavaThread* java_thread, jint* count_ptr) {
1582   jvmtiError err = JVMTI_ERROR_NONE;
1583 
1584   // retrieve or create JvmtiThreadState.
1585   JvmtiThreadState* state = JvmtiThreadState::state_for(java_thread);
1586   if (state == NULL) {
1587     return JVMTI_ERROR_THREAD_NOT_ALIVE;
1588   }
1589 
1590   // It is only safe to perform the direct operation on the current
1591   // thread. All other usage needs to use a vm-safepoint-op for safety.
1592   if (java_thread == JavaThread::current()) {
1593     err = get_frame_count(state, count_ptr);
1594   } else {
1595     // get java stack frame count at safepoint.
1596     VM_GetFrameCount op(this, state, count_ptr);
1597     VMThread::execute(&amp;op);
1598     err = op.result();
1599   }
1600   return err;
1601 } /* end GetFrameCount */
1602 
1603 
1604 // Threads_lock NOT held, java_thread not protected by lock
1605 // java_thread - pre-checked
1606 jvmtiError
1607 JvmtiEnv::PopFrame(JavaThread* java_thread) {
1608   JavaThread* current_thread  = JavaThread::current();
1609   HandleMark hm(current_thread);
1610   uint32_t debug_bits = 0;
1611 
1612   // retrieve or create the state
1613   JvmtiThreadState* state = JvmtiThreadState::state_for(java_thread);
1614   if (state == NULL) {
1615     return JVMTI_ERROR_THREAD_NOT_ALIVE;
1616   }
1617 
1618   // Check if java_thread is fully suspended
1619   if (!java_thread-&gt;is_thread_fully_suspended(true /* wait for suspend completion */, &amp;debug_bits)) {
1620     return JVMTI_ERROR_THREAD_NOT_SUSPENDED;
1621   }
1622   // Check to see if a PopFrame was already in progress
1623   if (java_thread-&gt;popframe_condition() != JavaThread::popframe_inactive) {
1624     // Probably possible for JVMTI clients to trigger this, but the
1625     // JPDA backend shouldn&#39;t allow this to happen
1626     return JVMTI_ERROR_INTERNAL;
1627   }
1628 
1629   {
1630     // Was workaround bug
1631     //    4812902: popFrame hangs if the method is waiting at a synchronize
1632     // Catch this condition and return an error to avoid hanging.
1633     // Now JVMTI spec allows an implementation to bail out with an opaque frame error.
1634     OSThread* osThread = java_thread-&gt;osthread();
1635     if (osThread-&gt;get_state() == MONITOR_WAIT) {
1636       return JVMTI_ERROR_OPAQUE_FRAME;
1637     }
1638   }
1639 
1640   {
1641     ResourceMark rm(current_thread);
1642     // Check if there are more than one Java frame in this thread, that the top two frames
1643     // are Java (not native) frames, and that there is no intervening VM frame
1644     int frame_count = 0;
1645     bool is_interpreted[2];
1646     intptr_t *frame_sp[2];
1647     // The 2-nd arg of constructor is needed to stop iterating at java entry frame.
1648     for (vframeStream vfs(java_thread, true); !vfs.at_end(); vfs.next()) {
1649       methodHandle mh(current_thread, vfs.method());
1650       if (mh-&gt;is_native()) return(JVMTI_ERROR_OPAQUE_FRAME);
1651       is_interpreted[frame_count] = vfs.is_interpreted_frame();
1652       frame_sp[frame_count] = vfs.frame_id();
1653       if (++frame_count &gt; 1) break;
1654     }
1655     if (frame_count &lt; 2)  {
1656       // We haven&#39;t found two adjacent non-native Java frames on the top.
1657       // There can be two situations here:
1658       //  1. There are no more java frames
1659       //  2. Two top java frames are separated by non-java native frames
1660       if(vframeFor(java_thread, 1) == NULL) {
1661         return JVMTI_ERROR_NO_MORE_FRAMES;
1662       } else {
1663         // Intervening non-java native or VM frames separate java frames.
1664         // Current implementation does not support this. See bug #5031735.
1665         // In theory it is possible to pop frames in such cases.
1666         return JVMTI_ERROR_OPAQUE_FRAME;
1667       }
1668     }
1669 
1670     // If any of the top 2 frames is a compiled one, need to deoptimize it
1671     for (int i = 0; i &lt; 2; i++) {
1672       if (!is_interpreted[i]) {
1673         Deoptimization::deoptimize_frame(java_thread, frame_sp[i]);
1674       }
1675     }
1676 
1677     // Update the thread state to reflect that the top frame is popped
1678     // so that cur_stack_depth is maintained properly and all frameIDs
1679     // are invalidated.
1680     // The current frame will be popped later when the suspended thread
1681     // is resumed and right before returning from VM to Java.
1682     // (see call_VM_base() in assembler_&lt;cpu&gt;.cpp).
1683 
1684     // It&#39;s fine to update the thread state here because no JVMTI events
1685     // shall be posted for this PopFrame.
1686 
1687     // It is only safe to perform the direct operation on the current
1688     // thread. All other usage needs to use a vm-safepoint-op for safety.
1689     if (java_thread == JavaThread::current()) {
1690       state-&gt;update_for_pop_top_frame();
1691     } else {
1692       VM_UpdateForPopTopFrame op(state);
1693       VMThread::execute(&amp;op);
1694       jvmtiError err = op.result();
1695       if (err != JVMTI_ERROR_NONE) {
1696         return err;
1697       }
1698     }
1699 
1700     java_thread-&gt;set_popframe_condition(JavaThread::popframe_pending_bit);
1701     // Set pending step flag for this popframe and it is cleared when next
1702     // step event is posted.
1703     state-&gt;set_pending_step_for_popframe();
1704   }
1705 
1706   return JVMTI_ERROR_NONE;
1707 } /* end PopFrame */
1708 
1709 
1710 // Threads_lock NOT held, java_thread not protected by lock
1711 // java_thread - pre-checked
1712 // java_thread - unchecked
1713 // depth - pre-checked as non-negative
1714 // method_ptr - pre-checked for NULL
1715 // location_ptr - pre-checked for NULL
1716 jvmtiError
1717 JvmtiEnv::GetFrameLocation(JavaThread* java_thread, jint depth, jmethodID* method_ptr, jlocation* location_ptr) {
1718   jvmtiError err = JVMTI_ERROR_NONE;
1719 
1720   // It is only safe to perform the direct operation on the current
1721   // thread. All other usage needs to use a vm-safepoint-op for safety.
1722   if (java_thread == JavaThread::current()) {
1723     err = get_frame_location(java_thread, depth, method_ptr, location_ptr);
1724   } else {
1725     // JVMTI get java stack frame location at safepoint.
1726     VM_GetFrameLocation op(this, java_thread, depth, method_ptr, location_ptr);
1727     VMThread::execute(&amp;op);
1728     err = op.result();
1729   }
1730   return err;
1731 } /* end GetFrameLocation */
1732 
1733 
1734 // Threads_lock NOT held, java_thread not protected by lock
1735 // java_thread - pre-checked
1736 // java_thread - unchecked
1737 // depth - pre-checked as non-negative
1738 jvmtiError
1739 JvmtiEnv::NotifyFramePop(JavaThread* java_thread, jint depth) {
1740   jvmtiError err = JVMTI_ERROR_NONE;
1741   ResourceMark rm;
1742   uint32_t debug_bits = 0;
1743 
1744   JvmtiThreadState *state = JvmtiThreadState::state_for(java_thread);
1745   if (state == NULL) {
1746     return JVMTI_ERROR_THREAD_NOT_ALIVE;
1747   }
1748 
1749   if (!java_thread-&gt;is_thread_fully_suspended(true, &amp;debug_bits)) {
1750     return JVMTI_ERROR_THREAD_NOT_SUSPENDED;
1751   }
1752 
1753   if (TraceJVMTICalls) {
1754     JvmtiSuspendControl::print();
1755   }
1756 
1757   vframe *vf = vframeFor(java_thread, depth);
1758   if (vf == NULL) {
1759     return JVMTI_ERROR_NO_MORE_FRAMES;
1760   }
1761 
1762   if (!vf-&gt;is_java_frame() || ((javaVFrame*) vf)-&gt;method()-&gt;is_native()) {
1763     return JVMTI_ERROR_OPAQUE_FRAME;
1764   }
1765 
1766   assert(vf-&gt;frame_pointer() != NULL, &quot;frame pointer mustn&#39;t be NULL&quot;);
1767 
1768   // It is only safe to perform the direct operation on the current
1769   // thread. All other usage needs to use a vm-safepoint-op for safety.
1770   if (java_thread == JavaThread::current()) {
1771     int frame_number = state-&gt;count_frames() - depth;
1772     state-&gt;env_thread_state(this)-&gt;set_frame_pop(frame_number);
1773   } else {
1774     VM_SetFramePop op(this, state, depth);
1775     VMThread::execute(&amp;op);
1776     err = op.result();
1777   }
1778   return err;
1779 } /* end NotifyFramePop */
1780 
1781 
1782   //
1783   // Force Early Return functions
1784   //
1785 
1786 // Threads_lock NOT held, java_thread not protected by lock
1787 // java_thread - pre-checked
1788 jvmtiError
1789 JvmtiEnv::ForceEarlyReturnObject(JavaThread* java_thread, jobject value) {
1790   jvalue val;
1791   val.l = value;
1792   return force_early_return(java_thread, val, atos);
1793 } /* end ForceEarlyReturnObject */
1794 
1795 
1796 // Threads_lock NOT held, java_thread not protected by lock
1797 // java_thread - pre-checked
1798 jvmtiError
1799 JvmtiEnv::ForceEarlyReturnInt(JavaThread* java_thread, jint value) {
1800   jvalue val;
1801   val.i = value;
1802   return force_early_return(java_thread, val, itos);
1803 } /* end ForceEarlyReturnInt */
1804 
1805 
1806 // Threads_lock NOT held, java_thread not protected by lock
1807 // java_thread - pre-checked
1808 jvmtiError
1809 JvmtiEnv::ForceEarlyReturnLong(JavaThread* java_thread, jlong value) {
1810   jvalue val;
1811   val.j = value;
1812   return force_early_return(java_thread, val, ltos);
1813 } /* end ForceEarlyReturnLong */
1814 
1815 
1816 // Threads_lock NOT held, java_thread not protected by lock
1817 // java_thread - pre-checked
1818 jvmtiError
1819 JvmtiEnv::ForceEarlyReturnFloat(JavaThread* java_thread, jfloat value) {
1820   jvalue val;
1821   val.f = value;
1822   return force_early_return(java_thread, val, ftos);
1823 } /* end ForceEarlyReturnFloat */
1824 
1825 
1826 // Threads_lock NOT held, java_thread not protected by lock
1827 // java_thread - pre-checked
1828 jvmtiError
1829 JvmtiEnv::ForceEarlyReturnDouble(JavaThread* java_thread, jdouble value) {
1830   jvalue val;
1831   val.d = value;
1832   return force_early_return(java_thread, val, dtos);
1833 } /* end ForceEarlyReturnDouble */
1834 
1835 
1836 // Threads_lock NOT held, java_thread not protected by lock
1837 // java_thread - pre-checked
1838 jvmtiError
1839 JvmtiEnv::ForceEarlyReturnVoid(JavaThread* java_thread) {
1840   jvalue val;
1841   val.j = 0L;
1842   return force_early_return(java_thread, val, vtos);
1843 } /* end ForceEarlyReturnVoid */
1844 
1845 
1846   //
1847   // Heap functions
1848   //
1849 
1850 // klass - NULL is a valid value, must be checked
1851 // initial_object - NULL is a valid value, must be checked
1852 // callbacks - pre-checked for NULL
1853 // user_data - NULL is a valid value, must be checked
1854 jvmtiError
1855 JvmtiEnv::FollowReferences(jint heap_filter, jclass klass, jobject initial_object, const jvmtiHeapCallbacks* callbacks, const void* user_data) {
1856   // check klass if provided
1857   Klass* k = NULL;
1858   if (klass != NULL) {
1859     oop k_mirror = JNIHandles::resolve_external_guard(klass);
1860     if (k_mirror == NULL) {
1861       return JVMTI_ERROR_INVALID_CLASS;
1862     }
1863     if (java_lang_Class::is_primitive(k_mirror)) {
1864       return JVMTI_ERROR_NONE;
1865     }
1866     k = java_lang_Class::as_Klass(k_mirror);
1867     if (klass == NULL) {
1868       return JVMTI_ERROR_INVALID_CLASS;
1869     }
1870   }
1871 
1872   if (initial_object != NULL) {
1873     oop init_obj = JNIHandles::resolve_external_guard(initial_object);
1874     if (init_obj == NULL) {
1875       return JVMTI_ERROR_INVALID_OBJECT;
1876     }
1877   }
1878 
1879   Thread *thread = Thread::current();
1880   HandleMark hm(thread);
1881 
1882   TraceTime t(&quot;FollowReferences&quot;, TRACETIME_LOG(Debug, jvmti, objecttagging));
1883   JvmtiTagMap::tag_map_for(this)-&gt;follow_references(heap_filter, k, initial_object, callbacks, user_data);
1884   return JVMTI_ERROR_NONE;
1885 } /* end FollowReferences */
1886 
1887 
1888 // klass - NULL is a valid value, must be checked
1889 // callbacks - pre-checked for NULL
1890 // user_data - NULL is a valid value, must be checked
1891 jvmtiError
1892 JvmtiEnv::IterateThroughHeap(jint heap_filter, jclass klass, const jvmtiHeapCallbacks* callbacks, const void* user_data) {
1893   // check klass if provided
1894   Klass* k = NULL;
1895   if (klass != NULL) {
1896     oop k_mirror = JNIHandles::resolve_external_guard(klass);
1897     if (k_mirror == NULL) {
1898       return JVMTI_ERROR_INVALID_CLASS;
1899     }
1900     if (java_lang_Class::is_primitive(k_mirror)) {
1901       return JVMTI_ERROR_NONE;
1902     }
1903     k = java_lang_Class::as_Klass(k_mirror);
1904     if (k == NULL) {
1905       return JVMTI_ERROR_INVALID_CLASS;
1906     }
1907   }
1908 
1909   TraceTime t(&quot;IterateThroughHeap&quot;, TRACETIME_LOG(Debug, jvmti, objecttagging));
1910   JvmtiTagMap::tag_map_for(this)-&gt;iterate_through_heap(heap_filter, k, callbacks, user_data);
1911   return JVMTI_ERROR_NONE;
1912 } /* end IterateThroughHeap */
1913 
1914 
1915 // tag_ptr - pre-checked for NULL
1916 jvmtiError
1917 JvmtiEnv::GetTag(jobject object, jlong* tag_ptr) {
1918   oop o = JNIHandles::resolve_external_guard(object);
1919   NULL_CHECK(o, JVMTI_ERROR_INVALID_OBJECT);
1920   *tag_ptr = JvmtiTagMap::tag_map_for(this)-&gt;get_tag(object);
1921   return JVMTI_ERROR_NONE;
1922 } /* end GetTag */
1923 
1924 
1925 jvmtiError
1926 JvmtiEnv::SetTag(jobject object, jlong tag) {
1927   oop o = JNIHandles::resolve_external_guard(object);
1928   NULL_CHECK(o, JVMTI_ERROR_INVALID_OBJECT);
1929   JvmtiTagMap::tag_map_for(this)-&gt;set_tag(object, tag);
1930   return JVMTI_ERROR_NONE;
1931 } /* end SetTag */
1932 
1933 
1934 // tag_count - pre-checked to be greater than or equal to 0
1935 // tags - pre-checked for NULL
1936 // count_ptr - pre-checked for NULL
1937 // object_result_ptr - NULL is a valid value, must be checked
1938 // tag_result_ptr - NULL is a valid value, must be checked
1939 jvmtiError
1940 JvmtiEnv::GetObjectsWithTags(jint tag_count, const jlong* tags, jint* count_ptr, jobject** object_result_ptr, jlong** tag_result_ptr) {
1941   TraceTime t(&quot;GetObjectsWithTags&quot;, TRACETIME_LOG(Debug, jvmti, objecttagging));
1942   return JvmtiTagMap::tag_map_for(this)-&gt;get_objects_with_tags((jlong*)tags, tag_count, count_ptr, object_result_ptr, tag_result_ptr);
1943 } /* end GetObjectsWithTags */
1944 
1945 
1946 jvmtiError
1947 JvmtiEnv::ForceGarbageCollection() {
1948   Universe::heap()-&gt;collect(GCCause::_jvmti_force_gc);
1949   return JVMTI_ERROR_NONE;
1950 } /* end ForceGarbageCollection */
1951 
1952 
1953   //
1954   // Heap (1.0) functions
1955   //
1956 
1957 // object_reference_callback - pre-checked for NULL
1958 // user_data - NULL is a valid value, must be checked
1959 jvmtiError
1960 JvmtiEnv::IterateOverObjectsReachableFromObject(jobject object, jvmtiObjectReferenceCallback object_reference_callback, const void* user_data) {
1961   oop o = JNIHandles::resolve_external_guard(object);
1962   NULL_CHECK(o, JVMTI_ERROR_INVALID_OBJECT);
1963   JvmtiTagMap::tag_map_for(this)-&gt;iterate_over_objects_reachable_from_object(object, object_reference_callback, user_data);
1964   return JVMTI_ERROR_NONE;
1965 } /* end IterateOverObjectsReachableFromObject */
1966 
1967 
1968 // heap_root_callback - NULL is a valid value, must be checked
1969 // stack_ref_callback - NULL is a valid value, must be checked
1970 // object_ref_callback - NULL is a valid value, must be checked
1971 // user_data - NULL is a valid value, must be checked
1972 jvmtiError
1973 JvmtiEnv::IterateOverReachableObjects(jvmtiHeapRootCallback heap_root_callback, jvmtiStackReferenceCallback stack_ref_callback, jvmtiObjectReferenceCallback object_ref_callback, const void* user_data) {
1974   TraceTime t(&quot;IterateOverReachableObjects&quot;, TRACETIME_LOG(Debug, jvmti, objecttagging));
1975   JvmtiTagMap::tag_map_for(this)-&gt;iterate_over_reachable_objects(heap_root_callback, stack_ref_callback, object_ref_callback, user_data);
1976   return JVMTI_ERROR_NONE;
1977 } /* end IterateOverReachableObjects */
1978 
1979 
1980 // heap_object_callback - pre-checked for NULL
1981 // user_data - NULL is a valid value, must be checked
1982 jvmtiError
1983 JvmtiEnv::IterateOverHeap(jvmtiHeapObjectFilter object_filter, jvmtiHeapObjectCallback heap_object_callback, const void* user_data) {
1984   TraceTime t(&quot;IterateOverHeap&quot;, TRACETIME_LOG(Debug, jvmti, objecttagging));
1985   Thread *thread = Thread::current();
1986   HandleMark hm(thread);
1987   JvmtiTagMap::tag_map_for(this)-&gt;iterate_over_heap(object_filter, NULL, heap_object_callback, user_data);
1988   return JVMTI_ERROR_NONE;
1989 } /* end IterateOverHeap */
1990 
1991 
1992 // k_mirror - may be primitive, this must be checked
1993 // heap_object_callback - pre-checked for NULL
1994 // user_data - NULL is a valid value, must be checked
1995 jvmtiError
1996 JvmtiEnv::IterateOverInstancesOfClass(oop k_mirror, jvmtiHeapObjectFilter object_filter, jvmtiHeapObjectCallback heap_object_callback, const void* user_data) {
1997   if (java_lang_Class::is_primitive(k_mirror)) {
1998     // DO PRIMITIVE CLASS PROCESSING
1999     return JVMTI_ERROR_NONE;
2000   }
2001   Klass* klass = java_lang_Class::as_Klass(k_mirror);
2002   if (klass == NULL) {
2003     return JVMTI_ERROR_INVALID_CLASS;
2004   }
2005   TraceTime t(&quot;IterateOverInstancesOfClass&quot;, TRACETIME_LOG(Debug, jvmti, objecttagging));
2006   JvmtiTagMap::tag_map_for(this)-&gt;iterate_over_heap(object_filter, klass, heap_object_callback, user_data);
2007   return JVMTI_ERROR_NONE;
2008 } /* end IterateOverInstancesOfClass */
2009 
2010 
2011   //
2012   // Local Variable functions
2013   //
2014 
2015 // Threads_lock NOT held, java_thread not protected by lock
2016 // java_thread - pre-checked
2017 // java_thread - unchecked
2018 // depth - pre-checked as non-negative
2019 // value_ptr - pre-checked for NULL
2020 jvmtiError
2021 JvmtiEnv::GetLocalObject(JavaThread* java_thread, jint depth, jint slot, jobject* value_ptr) {
2022   JavaThread* current_thread = JavaThread::current();
2023   // rm object is created to clean up the javaVFrame created in
2024   // doit_prologue(), but after doit() is finished with it.
2025   ResourceMark rm(current_thread);
2026 
2027   VM_GetOrSetLocal op(java_thread, current_thread, depth, slot);
2028   VMThread::execute(&amp;op);
2029   jvmtiError err = op.result();
2030   if (err != JVMTI_ERROR_NONE) {
2031     return err;
2032   } else {
2033     *value_ptr = op.value().l;
2034     return JVMTI_ERROR_NONE;
2035   }
2036 } /* end GetLocalObject */
2037 
2038 // Threads_lock NOT held, java_thread not protected by lock
2039 // java_thread - pre-checked
2040 // java_thread - unchecked
2041 // depth - pre-checked as non-negative
2042 // value - pre-checked for NULL
2043 jvmtiError
2044 JvmtiEnv::GetLocalInstance(JavaThread* java_thread, jint depth, jobject* value_ptr){
2045   JavaThread* current_thread = JavaThread::current();
2046   // rm object is created to clean up the javaVFrame created in
2047   // doit_prologue(), but after doit() is finished with it.
2048   ResourceMark rm(current_thread);
2049 
2050   VM_GetReceiver op(java_thread, current_thread, depth);
2051   VMThread::execute(&amp;op);
2052   jvmtiError err = op.result();
2053   if (err != JVMTI_ERROR_NONE) {
2054     return err;
2055   } else {
2056     *value_ptr = op.value().l;
2057     return JVMTI_ERROR_NONE;
2058   }
2059 } /* end GetLocalInstance */
2060 
2061 
2062 // Threads_lock NOT held, java_thread not protected by lock
2063 // java_thread - pre-checked
2064 // java_thread - unchecked
2065 // depth - pre-checked as non-negative
2066 // value_ptr - pre-checked for NULL
2067 jvmtiError
2068 JvmtiEnv::GetLocalInt(JavaThread* java_thread, jint depth, jint slot, jint* value_ptr) {
2069   // rm object is created to clean up the javaVFrame created in
2070   // doit_prologue(), but after doit() is finished with it.
2071   ResourceMark rm;
2072 
2073   VM_GetOrSetLocal op(java_thread, depth, slot, T_INT);
2074   VMThread::execute(&amp;op);
2075   *value_ptr = op.value().i;
2076   return op.result();
2077 } /* end GetLocalInt */
2078 
2079 
2080 // Threads_lock NOT held, java_thread not protected by lock
2081 // java_thread - pre-checked
2082 // java_thread - unchecked
2083 // depth - pre-checked as non-negative
2084 // value_ptr - pre-checked for NULL
2085 jvmtiError
2086 JvmtiEnv::GetLocalLong(JavaThread* java_thread, jint depth, jint slot, jlong* value_ptr) {
2087   // rm object is created to clean up the javaVFrame created in
2088   // doit_prologue(), but after doit() is finished with it.
2089   ResourceMark rm;
2090 
2091   VM_GetOrSetLocal op(java_thread, depth, slot, T_LONG);
2092   VMThread::execute(&amp;op);
2093   *value_ptr = op.value().j;
2094   return op.result();
2095 } /* end GetLocalLong */
2096 
2097 
2098 // Threads_lock NOT held, java_thread not protected by lock
2099 // java_thread - pre-checked
2100 // java_thread - unchecked
2101 // depth - pre-checked as non-negative
2102 // value_ptr - pre-checked for NULL
2103 jvmtiError
2104 JvmtiEnv::GetLocalFloat(JavaThread* java_thread, jint depth, jint slot, jfloat* value_ptr) {
2105   // rm object is created to clean up the javaVFrame created in
2106   // doit_prologue(), but after doit() is finished with it.
2107   ResourceMark rm;
2108 
2109   VM_GetOrSetLocal op(java_thread, depth, slot, T_FLOAT);
2110   VMThread::execute(&amp;op);
2111   *value_ptr = op.value().f;
2112   return op.result();
2113 } /* end GetLocalFloat */
2114 
2115 
2116 // Threads_lock NOT held, java_thread not protected by lock
2117 // java_thread - pre-checked
2118 // java_thread - unchecked
2119 // depth - pre-checked as non-negative
2120 // value_ptr - pre-checked for NULL
2121 jvmtiError
2122 JvmtiEnv::GetLocalDouble(JavaThread* java_thread, jint depth, jint slot, jdouble* value_ptr) {
2123   // rm object is created to clean up the javaVFrame created in
2124   // doit_prologue(), but after doit() is finished with it.
2125   ResourceMark rm;
2126 
2127   VM_GetOrSetLocal op(java_thread, depth, slot, T_DOUBLE);
2128   VMThread::execute(&amp;op);
2129   *value_ptr = op.value().d;
2130   return op.result();
2131 } /* end GetLocalDouble */
2132 
2133 
2134 // Threads_lock NOT held, java_thread not protected by lock
2135 // java_thread - pre-checked
2136 // java_thread - unchecked
2137 // depth - pre-checked as non-negative
2138 jvmtiError
2139 JvmtiEnv::SetLocalObject(JavaThread* java_thread, jint depth, jint slot, jobject value) {
2140   // rm object is created to clean up the javaVFrame created in
2141   // doit_prologue(), but after doit() is finished with it.
2142   ResourceMark rm;
2143   jvalue val;
2144   val.l = value;
2145   VM_GetOrSetLocal op(java_thread, depth, slot, T_OBJECT, val);
2146   VMThread::execute(&amp;op);
2147   return op.result();
2148 } /* end SetLocalObject */
2149 
2150 
2151 // Threads_lock NOT held, java_thread not protected by lock
2152 // java_thread - pre-checked
2153 // java_thread - unchecked
2154 // depth - pre-checked as non-negative
2155 jvmtiError
2156 JvmtiEnv::SetLocalInt(JavaThread* java_thread, jint depth, jint slot, jint value) {
2157   // rm object is created to clean up the javaVFrame created in
2158   // doit_prologue(), but after doit() is finished with it.
2159   ResourceMark rm;
2160   jvalue val;
2161   val.i = value;
2162   VM_GetOrSetLocal op(java_thread, depth, slot, T_INT, val);
2163   VMThread::execute(&amp;op);
2164   return op.result();
2165 } /* end SetLocalInt */
2166 
2167 
2168 // Threads_lock NOT held, java_thread not protected by lock
2169 // java_thread - pre-checked
2170 // java_thread - unchecked
2171 // depth - pre-checked as non-negative
2172 jvmtiError
2173 JvmtiEnv::SetLocalLong(JavaThread* java_thread, jint depth, jint slot, jlong value) {
2174   // rm object is created to clean up the javaVFrame created in
2175   // doit_prologue(), but after doit() is finished with it.
2176   ResourceMark rm;
2177   jvalue val;
2178   val.j = value;
2179   VM_GetOrSetLocal op(java_thread, depth, slot, T_LONG, val);
2180   VMThread::execute(&amp;op);
2181   return op.result();
2182 } /* end SetLocalLong */
2183 
2184 
2185 // Threads_lock NOT held, java_thread not protected by lock
2186 // java_thread - pre-checked
2187 // java_thread - unchecked
2188 // depth - pre-checked as non-negative
2189 jvmtiError
2190 JvmtiEnv::SetLocalFloat(JavaThread* java_thread, jint depth, jint slot, jfloat value) {
2191   // rm object is created to clean up the javaVFrame created in
2192   // doit_prologue(), but after doit() is finished with it.
2193   ResourceMark rm;
2194   jvalue val;
2195   val.f = value;
2196   VM_GetOrSetLocal op(java_thread, depth, slot, T_FLOAT, val);
2197   VMThread::execute(&amp;op);
2198   return op.result();
2199 } /* end SetLocalFloat */
2200 
2201 
2202 // Threads_lock NOT held, java_thread not protected by lock
2203 // java_thread - pre-checked
2204 // java_thread - unchecked
2205 // depth - pre-checked as non-negative
2206 jvmtiError
2207 JvmtiEnv::SetLocalDouble(JavaThread* java_thread, jint depth, jint slot, jdouble value) {
2208   // rm object is created to clean up the javaVFrame created in
2209   // doit_prologue(), but after doit() is finished with it.
2210   ResourceMark rm;
2211   jvalue val;
2212   val.d = value;
2213   VM_GetOrSetLocal op(java_thread, depth, slot, T_DOUBLE, val);
2214   VMThread::execute(&amp;op);
2215   return op.result();
2216 } /* end SetLocalDouble */
2217 
2218 
2219   //
2220   // Breakpoint functions
2221   //
2222 
2223 // method_oop - pre-checked for validity, but may be NULL meaning obsolete method
2224 jvmtiError
2225 JvmtiEnv::SetBreakpoint(Method* method_oop, jlocation location) {
2226   NULL_CHECK(method_oop, JVMTI_ERROR_INVALID_METHODID);
2227   if (location &lt; 0) {   // simple invalid location check first
2228     return JVMTI_ERROR_INVALID_LOCATION;
2229   }
2230   // verify that the breakpoint is not past the end of the method
2231   if (location &gt;= (jlocation) method_oop-&gt;code_size()) {
2232     return JVMTI_ERROR_INVALID_LOCATION;
2233   }
2234 
2235   ResourceMark rm;
2236   JvmtiBreakpoint bp(method_oop, location);
2237   JvmtiBreakpoints&amp; jvmti_breakpoints = JvmtiCurrentBreakpoints::get_jvmti_breakpoints();
2238   if (jvmti_breakpoints.set(bp) == JVMTI_ERROR_DUPLICATE)
2239     return JVMTI_ERROR_DUPLICATE;
2240 
2241   if (TraceJVMTICalls) {
2242     jvmti_breakpoints.print();
2243   }
2244 
2245   return JVMTI_ERROR_NONE;
2246 } /* end SetBreakpoint */
2247 
2248 
2249 // method_oop - pre-checked for validity, but may be NULL meaning obsolete method
2250 jvmtiError
2251 JvmtiEnv::ClearBreakpoint(Method* method_oop, jlocation location) {
2252   NULL_CHECK(method_oop, JVMTI_ERROR_INVALID_METHODID);
2253 
2254   if (location &lt; 0) {   // simple invalid location check first
2255     return JVMTI_ERROR_INVALID_LOCATION;
2256   }
2257 
2258   // verify that the breakpoint is not past the end of the method
2259   if (location &gt;= (jlocation) method_oop-&gt;code_size()) {
2260     return JVMTI_ERROR_INVALID_LOCATION;
2261   }
2262 
2263   JvmtiBreakpoint bp(method_oop, location);
2264 
2265   JvmtiBreakpoints&amp; jvmti_breakpoints = JvmtiCurrentBreakpoints::get_jvmti_breakpoints();
2266   if (jvmti_breakpoints.clear(bp) == JVMTI_ERROR_NOT_FOUND)
2267     return JVMTI_ERROR_NOT_FOUND;
2268 
2269   if (TraceJVMTICalls) {
2270     jvmti_breakpoints.print();
2271   }
2272 
2273   return JVMTI_ERROR_NONE;
2274 } /* end ClearBreakpoint */
2275 
2276 
2277   //
2278   // Watched Field functions
2279   //
2280 
2281 jvmtiError
2282 JvmtiEnv::SetFieldAccessWatch(fieldDescriptor* fdesc_ptr) {
2283   // make sure we haven&#39;t set this watch before
2284   if (fdesc_ptr-&gt;is_field_access_watched()) return JVMTI_ERROR_DUPLICATE;
2285   fdesc_ptr-&gt;set_is_field_access_watched(true);
2286 
2287   JvmtiEventController::change_field_watch(JVMTI_EVENT_FIELD_ACCESS, true);
2288 
2289   return JVMTI_ERROR_NONE;
2290 } /* end SetFieldAccessWatch */
2291 
2292 
2293 jvmtiError
2294 JvmtiEnv::ClearFieldAccessWatch(fieldDescriptor* fdesc_ptr) {
2295   // make sure we have a watch to clear
2296   if (!fdesc_ptr-&gt;is_field_access_watched()) return JVMTI_ERROR_NOT_FOUND;
2297   fdesc_ptr-&gt;set_is_field_access_watched(false);
2298 
2299   JvmtiEventController::change_field_watch(JVMTI_EVENT_FIELD_ACCESS, false);
2300 
2301   return JVMTI_ERROR_NONE;
2302 } /* end ClearFieldAccessWatch */
2303 
2304 
2305 jvmtiError
2306 JvmtiEnv::SetFieldModificationWatch(fieldDescriptor* fdesc_ptr) {
2307   // make sure we haven&#39;t set this watch before
2308   if (fdesc_ptr-&gt;is_field_modification_watched()) return JVMTI_ERROR_DUPLICATE;
2309   fdesc_ptr-&gt;set_is_field_modification_watched(true);
2310 
2311   JvmtiEventController::change_field_watch(JVMTI_EVENT_FIELD_MODIFICATION, true);
2312 
2313   return JVMTI_ERROR_NONE;
2314 } /* end SetFieldModificationWatch */
2315 
2316 
2317 jvmtiError
2318 JvmtiEnv::ClearFieldModificationWatch(fieldDescriptor* fdesc_ptr) {
2319    // make sure we have a watch to clear
2320   if (!fdesc_ptr-&gt;is_field_modification_watched()) return JVMTI_ERROR_NOT_FOUND;
2321   fdesc_ptr-&gt;set_is_field_modification_watched(false);
2322 
2323   JvmtiEventController::change_field_watch(JVMTI_EVENT_FIELD_MODIFICATION, false);
2324 
2325   return JVMTI_ERROR_NONE;
2326 } /* end ClearFieldModificationWatch */
2327 
2328   //
2329   // Class functions
2330   //
2331 
2332 
2333 // k_mirror - may be primitive, this must be checked
2334 // signature_ptr - NULL is a valid value, must be checked
2335 // generic_ptr - NULL is a valid value, must be checked
2336 jvmtiError
2337 JvmtiEnv::GetClassSignature(oop k_mirror, char** signature_ptr, char** generic_ptr) {
2338   ResourceMark rm;
2339   bool isPrimitive = java_lang_Class::is_primitive(k_mirror);
2340   Klass* k = NULL;
2341   if (!isPrimitive) {
2342     k = java_lang_Class::as_Klass(k_mirror);
2343     NULL_CHECK(k, JVMTI_ERROR_INVALID_CLASS);
2344   }
2345   if (signature_ptr != NULL) {
2346     char* result = NULL;
2347     if (isPrimitive) {
2348       char tchar = type2char(java_lang_Class::primitive_type(k_mirror));
2349       result = (char*) jvmtiMalloc(2);
2350       result[0] = tchar;
2351       result[1] = &#39;\0&#39;;
2352     } else {
2353       const char* class_sig = k-&gt;signature_name();
2354       result = (char *) jvmtiMalloc(strlen(class_sig)+1);
2355       strcpy(result, class_sig);
2356     }
2357     *signature_ptr = result;
2358   }
2359   if (generic_ptr != NULL) {
2360     *generic_ptr = NULL;
2361     if (!isPrimitive &amp;&amp; k-&gt;is_instance_klass()) {
2362       Symbol* soo = InstanceKlass::cast(k)-&gt;generic_signature();
2363       if (soo != NULL) {
2364         const char *gen_sig = soo-&gt;as_C_string();
2365         if (gen_sig != NULL) {
2366           char* gen_result;
2367           jvmtiError err = allocate(strlen(gen_sig) + 1,
2368                                     (unsigned char **)&amp;gen_result);
2369           if (err != JVMTI_ERROR_NONE) {
2370             return err;
2371           }
2372           strcpy(gen_result, gen_sig);
2373           *generic_ptr = gen_result;
2374         }
2375       }
2376     }
2377   }
2378   return JVMTI_ERROR_NONE;
2379 } /* end GetClassSignature */
2380 
2381 
2382 // k_mirror - may be primitive, this must be checked
2383 // status_ptr - pre-checked for NULL
2384 jvmtiError
2385 JvmtiEnv::GetClassStatus(oop k_mirror, jint* status_ptr) {
2386   jint result = 0;
2387   if (java_lang_Class::is_primitive(k_mirror)) {
2388     result |= JVMTI_CLASS_STATUS_PRIMITIVE;
2389   } else {
2390     Klass* k = java_lang_Class::as_Klass(k_mirror);
2391     NULL_CHECK(k, JVMTI_ERROR_INVALID_CLASS);
2392     result = k-&gt;jvmti_class_status();
2393   }
2394   *status_ptr = result;
2395 
2396   return JVMTI_ERROR_NONE;
2397 } /* end GetClassStatus */
2398 
2399 
2400 // k_mirror - may be primitive, this must be checked
2401 // source_name_ptr - pre-checked for NULL
2402 jvmtiError
2403 JvmtiEnv::GetSourceFileName(oop k_mirror, char** source_name_ptr) {
2404   if (java_lang_Class::is_primitive(k_mirror)) {
2405      return JVMTI_ERROR_ABSENT_INFORMATION;
2406   }
2407   Klass* k_klass = java_lang_Class::as_Klass(k_mirror);
2408   NULL_CHECK(k_klass, JVMTI_ERROR_INVALID_CLASS);
2409 
2410   if (!k_klass-&gt;is_instance_klass()) {
2411     return JVMTI_ERROR_ABSENT_INFORMATION;
2412   }
2413 
2414   Symbol* sfnOop = InstanceKlass::cast(k_klass)-&gt;source_file_name();
2415   NULL_CHECK(sfnOop, JVMTI_ERROR_ABSENT_INFORMATION);
2416   {
2417     JavaThread* current_thread  = JavaThread::current();
2418     ResourceMark rm(current_thread);
2419     const char* sfncp = (const char*) sfnOop-&gt;as_C_string();
2420     *source_name_ptr = (char *) jvmtiMalloc(strlen(sfncp)+1);
2421     strcpy(*source_name_ptr, sfncp);
2422   }
2423 
2424   return JVMTI_ERROR_NONE;
2425 } /* end GetSourceFileName */
2426 
2427 
2428 // k_mirror - may be primitive, this must be checked
2429 // modifiers_ptr - pre-checked for NULL
2430 jvmtiError
2431 JvmtiEnv::GetClassModifiers(oop k_mirror, jint* modifiers_ptr) {
2432   JavaThread* current_thread  = JavaThread::current();
2433   jint result = 0;
2434   if (!java_lang_Class::is_primitive(k_mirror)) {
2435     Klass* k = java_lang_Class::as_Klass(k_mirror);
2436     NULL_CHECK(k, JVMTI_ERROR_INVALID_CLASS);
2437     result = k-&gt;compute_modifier_flags(current_thread);
2438     JavaThread* THREAD = current_thread; // pass to macros
2439     if (HAS_PENDING_EXCEPTION) {
2440       CLEAR_PENDING_EXCEPTION;
2441       return JVMTI_ERROR_INTERNAL;
2442     };
2443 
2444     // Reset the deleted  ACC_SUPER bit ( deleted in compute_modifier_flags()).
2445     if(k-&gt;is_super()) {
2446       result |= JVM_ACC_SUPER;
2447     }
2448   } else {
2449     result = (JVM_ACC_ABSTRACT | JVM_ACC_FINAL | JVM_ACC_PUBLIC);
2450   }
2451   *modifiers_ptr = result;
2452 
2453   return JVMTI_ERROR_NONE;
2454 } /* end GetClassModifiers */
2455 
2456 
2457 // k_mirror - may be primitive, this must be checked
2458 // method_count_ptr - pre-checked for NULL
2459 // methods_ptr - pre-checked for NULL
2460 jvmtiError
2461 JvmtiEnv::GetClassMethods(oop k_mirror, jint* method_count_ptr, jmethodID** methods_ptr) {
2462   JavaThread* current_thread  = JavaThread::current();
2463   HandleMark hm(current_thread);
2464 
2465   if (java_lang_Class::is_primitive(k_mirror)) {
2466     *method_count_ptr = 0;
2467     *methods_ptr = (jmethodID*) jvmtiMalloc(0 * sizeof(jmethodID));
2468     return JVMTI_ERROR_NONE;
2469   }
2470   Klass* k = java_lang_Class::as_Klass(k_mirror);
2471   NULL_CHECK(k, JVMTI_ERROR_INVALID_CLASS);
2472 
2473   // Return CLASS_NOT_PREPARED error as per JVMTI spec.
2474   if (!(k-&gt;jvmti_class_status() &amp; (JVMTI_CLASS_STATUS_PREPARED|JVMTI_CLASS_STATUS_ARRAY) )) {
2475     return JVMTI_ERROR_CLASS_NOT_PREPARED;
2476   }
2477 
2478   if (!k-&gt;is_instance_klass()) {
2479     *method_count_ptr = 0;
2480     *methods_ptr = (jmethodID*) jvmtiMalloc(0 * sizeof(jmethodID));
2481     return JVMTI_ERROR_NONE;
2482   }
2483   InstanceKlass* ik = InstanceKlass::cast(k);
2484   // Allocate the result and fill it in
2485   int result_length = ik-&gt;methods()-&gt;length();
2486   jmethodID* result_list = (jmethodID*)jvmtiMalloc(result_length * sizeof(jmethodID));
2487   int index;
2488   bool jmethodids_found = true;
2489 
2490   if (JvmtiExport::can_maintain_original_method_order()) {
2491     // Use the original method ordering indices stored in the class, so we can emit
2492     // jmethodIDs in the order they appeared in the class file
2493     for (index = 0; index &lt; result_length; index++) {
2494       Method* m = ik-&gt;methods()-&gt;at(index);
2495       int original_index = ik-&gt;method_ordering()-&gt;at(index);
2496       assert(original_index &gt;= 0 &amp;&amp; original_index &lt; result_length, &quot;invalid original method index&quot;);
2497       jmethodID id;
2498       if (jmethodids_found) {
2499         id = m-&gt;find_jmethod_id_or_null();
2500         if (id == NULL) {
2501           // If we find an uninitialized value, make sure there is
2502           // enough space for all the uninitialized values we might
2503           // find.
2504           ik-&gt;ensure_space_for_methodids(index);
2505           jmethodids_found = false;
2506           id = m-&gt;jmethod_id();
2507         }
2508       } else {
2509         id = m-&gt;jmethod_id();
2510       }
2511       result_list[original_index] = id;
2512     }
2513   } else {
2514     // otherwise just copy in any order
2515     for (index = 0; index &lt; result_length; index++) {
2516       Method* m = ik-&gt;methods()-&gt;at(index);
2517       jmethodID id;
2518       if (jmethodids_found) {
2519         id = m-&gt;find_jmethod_id_or_null();
2520         if (id == NULL) {
2521           // If we find an uninitialized value, make sure there is
2522           // enough space for all the uninitialized values we might
2523           // find.
2524           ik-&gt;ensure_space_for_methodids(index);
2525           jmethodids_found = false;
2526           id = m-&gt;jmethod_id();
2527         }
2528       } else {
2529         id = m-&gt;jmethod_id();
2530       }
2531       result_list[index] = id;
2532     }
2533   }
2534   // Fill in return value.
2535   *method_count_ptr = result_length;
2536   *methods_ptr = result_list;
2537 
2538   return JVMTI_ERROR_NONE;
2539 } /* end GetClassMethods */
2540 
2541 
2542 // k_mirror - may be primitive, this must be checked
2543 // field_count_ptr - pre-checked for NULL
2544 // fields_ptr - pre-checked for NULL
2545 jvmtiError
2546 JvmtiEnv::GetClassFields(oop k_mirror, jint* field_count_ptr, jfieldID** fields_ptr) {
2547   if (java_lang_Class::is_primitive(k_mirror)) {
2548     *field_count_ptr = 0;
2549     *fields_ptr = (jfieldID*) jvmtiMalloc(0 * sizeof(jfieldID));
2550     return JVMTI_ERROR_NONE;
2551   }
2552   JavaThread* current_thread = JavaThread::current();
2553   HandleMark hm(current_thread);
2554   Klass* k = java_lang_Class::as_Klass(k_mirror);
2555   NULL_CHECK(k, JVMTI_ERROR_INVALID_CLASS);
2556 
2557   // Return CLASS_NOT_PREPARED error as per JVMTI spec.
2558   if (!(k-&gt;jvmti_class_status() &amp; (JVMTI_CLASS_STATUS_PREPARED|JVMTI_CLASS_STATUS_ARRAY) )) {
2559     return JVMTI_ERROR_CLASS_NOT_PREPARED;
2560   }
2561 
2562   if (!k-&gt;is_instance_klass()) {
2563     *field_count_ptr = 0;
2564     *fields_ptr = (jfieldID*) jvmtiMalloc(0 * sizeof(jfieldID));
2565     return JVMTI_ERROR_NONE;
2566   }
2567 
2568 
2569   InstanceKlass* ik = InstanceKlass::cast(k);
2570 
2571   int result_count = 0;
2572   // First, count the fields.
2573   FilteredFieldStream flds(ik, true, true);
2574   result_count = flds.field_count();
2575 
2576   // Allocate the result and fill it in
2577   jfieldID* result_list = (jfieldID*) jvmtiMalloc(result_count * sizeof(jfieldID));
2578   // The JVMTI spec requires fields in the order they occur in the class file,
2579   // this is the reverse order of what FieldStream hands out.
2580   int id_index = (result_count - 1);
2581 
2582   for (FilteredFieldStream src_st(ik, true, true); !src_st.eos(); src_st.next()) {
2583     result_list[id_index--] = jfieldIDWorkaround::to_jfieldID(
2584                                             ik, src_st.offset(),
2585                                             src_st.access_flags().is_static());
2586   }
2587   assert(id_index == -1, &quot;just checking&quot;);
2588   // Fill in the results
2589   *field_count_ptr = result_count;
2590   *fields_ptr = result_list;
2591 
2592   return JVMTI_ERROR_NONE;
2593 } /* end GetClassFields */
2594 
2595 
2596 // k_mirror - may be primitive, this must be checked
2597 // interface_count_ptr - pre-checked for NULL
2598 // interfaces_ptr - pre-checked for NULL
2599 jvmtiError
2600 JvmtiEnv::GetImplementedInterfaces(oop k_mirror, jint* interface_count_ptr, jclass** interfaces_ptr) {
2601   {
2602     if (java_lang_Class::is_primitive(k_mirror)) {
2603       *interface_count_ptr = 0;
2604       *interfaces_ptr = (jclass*) jvmtiMalloc(0 * sizeof(jclass));
2605       return JVMTI_ERROR_NONE;
2606     }
2607     JavaThread* current_thread = JavaThread::current();
2608     HandleMark hm(current_thread);
2609     Klass* k = java_lang_Class::as_Klass(k_mirror);
2610     NULL_CHECK(k, JVMTI_ERROR_INVALID_CLASS);
2611 
2612     // Return CLASS_NOT_PREPARED error as per JVMTI spec.
2613     if (!(k-&gt;jvmti_class_status() &amp; (JVMTI_CLASS_STATUS_PREPARED|JVMTI_CLASS_STATUS_ARRAY) ))
2614       return JVMTI_ERROR_CLASS_NOT_PREPARED;
2615 
2616     if (!k-&gt;is_instance_klass()) {
2617       *interface_count_ptr = 0;
2618       *interfaces_ptr = (jclass*) jvmtiMalloc(0 * sizeof(jclass));
2619       return JVMTI_ERROR_NONE;
2620     }
2621 
2622     Array&lt;InstanceKlass*&gt;* interface_list = InstanceKlass::cast(k)-&gt;local_interfaces();
2623     const int result_length = (interface_list == NULL ? 0 : interface_list-&gt;length());
2624     jclass* result_list = (jclass*) jvmtiMalloc(result_length * sizeof(jclass));
2625     for (int i_index = 0; i_index &lt; result_length; i_index += 1) {
2626       InstanceKlass* klass_at = interface_list-&gt;at(i_index);
2627       assert(klass_at-&gt;is_klass(), &quot;interfaces must be Klass*s&quot;);
2628       assert(klass_at-&gt;is_interface(), &quot;interfaces must be interfaces&quot;);
2629       oop mirror_at = klass_at-&gt;java_mirror();
2630       Handle handle_at = Handle(current_thread, mirror_at);
2631       result_list[i_index] = (jclass) jni_reference(handle_at);
2632     }
2633     *interface_count_ptr = result_length;
2634     *interfaces_ptr = result_list;
2635   }
2636 
2637   return JVMTI_ERROR_NONE;
2638 } /* end GetImplementedInterfaces */
2639 
2640 
2641 // k_mirror - may be primitive, this must be checked
2642 // minor_version_ptr - pre-checked for NULL
2643 // major_version_ptr - pre-checked for NULL
2644 jvmtiError
2645 JvmtiEnv::GetClassVersionNumbers(oop k_mirror, jint* minor_version_ptr, jint* major_version_ptr) {
2646   if (java_lang_Class::is_primitive(k_mirror)) {
2647     return JVMTI_ERROR_ABSENT_INFORMATION;
2648   }
2649   Klass* klass = java_lang_Class::as_Klass(k_mirror);
2650 
2651   jint status = klass-&gt;jvmti_class_status();
2652   if (status &amp; (JVMTI_CLASS_STATUS_ERROR)) {
2653     return JVMTI_ERROR_INVALID_CLASS;
2654   }
2655   if (status &amp; (JVMTI_CLASS_STATUS_ARRAY)) {
2656     return JVMTI_ERROR_ABSENT_INFORMATION;
2657   }
2658 
2659   InstanceKlass* ik = InstanceKlass::cast(klass);
2660   *minor_version_ptr = ik-&gt;minor_version();
2661   *major_version_ptr = ik-&gt;major_version();
2662 
2663   return JVMTI_ERROR_NONE;
2664 } /* end GetClassVersionNumbers */
2665 
2666 
2667 // k_mirror - may be primitive, this must be checked
2668 // constant_pool_count_ptr - pre-checked for NULL
2669 // constant_pool_byte_count_ptr - pre-checked for NULL
2670 // constant_pool_bytes_ptr - pre-checked for NULL
2671 jvmtiError
2672 JvmtiEnv::GetConstantPool(oop k_mirror, jint* constant_pool_count_ptr, jint* constant_pool_byte_count_ptr, unsigned char** constant_pool_bytes_ptr) {
2673   if (java_lang_Class::is_primitive(k_mirror)) {
2674     return JVMTI_ERROR_ABSENT_INFORMATION;
2675   }
2676 
2677   Klass* klass = java_lang_Class::as_Klass(k_mirror);
2678   Thread *thread = Thread::current();
2679   ResourceMark rm(thread);
2680 
2681   jint status = klass-&gt;jvmti_class_status();
2682   if (status &amp; (JVMTI_CLASS_STATUS_ERROR)) {
2683     return JVMTI_ERROR_INVALID_CLASS;
2684   }
2685   if (status &amp; (JVMTI_CLASS_STATUS_ARRAY)) {
2686     return JVMTI_ERROR_ABSENT_INFORMATION;
2687   }
2688 
2689   InstanceKlass* ik = InstanceKlass::cast(klass);
2690   JvmtiConstantPoolReconstituter reconstituter(ik);
2691   if (reconstituter.get_error() != JVMTI_ERROR_NONE) {
2692     return reconstituter.get_error();
2693   }
2694 
2695   unsigned char *cpool_bytes;
2696   int cpool_size = reconstituter.cpool_size();
2697   if (reconstituter.get_error() != JVMTI_ERROR_NONE) {
2698     return reconstituter.get_error();
2699   }
2700   jvmtiError res = allocate(cpool_size, &amp;cpool_bytes);
2701   if (res != JVMTI_ERROR_NONE) {
2702     return res;
2703   }
2704   reconstituter.copy_cpool_bytes(cpool_bytes);
2705   if (reconstituter.get_error() != JVMTI_ERROR_NONE) {
2706     return reconstituter.get_error();
2707   }
2708 
2709   constantPoolHandle  constants(thread, ik-&gt;constants());
2710   *constant_pool_count_ptr      = constants-&gt;length();
2711   *constant_pool_byte_count_ptr = cpool_size;
2712   *constant_pool_bytes_ptr      = cpool_bytes;
2713 
2714   return JVMTI_ERROR_NONE;
2715 } /* end GetConstantPool */
2716 
2717 
2718 // k_mirror - may be primitive, this must be checked
2719 // is_interface_ptr - pre-checked for NULL
2720 jvmtiError
2721 JvmtiEnv::IsInterface(oop k_mirror, jboolean* is_interface_ptr) {
2722   {
2723     bool result = false;
2724     if (!java_lang_Class::is_primitive(k_mirror)) {
2725       Klass* k = java_lang_Class::as_Klass(k_mirror);
2726       if (k != NULL &amp;&amp; k-&gt;is_interface()) {
2727         result = true;
2728       }
2729     }
2730     *is_interface_ptr = result;
2731   }
2732 
2733   return JVMTI_ERROR_NONE;
2734 } /* end IsInterface */
2735 
2736 
2737 // k_mirror - may be primitive, this must be checked
2738 // is_array_class_ptr - pre-checked for NULL
2739 jvmtiError
2740 JvmtiEnv::IsArrayClass(oop k_mirror, jboolean* is_array_class_ptr) {
2741   {
2742     bool result = false;
2743     if (!java_lang_Class::is_primitive(k_mirror)) {
2744       Klass* k = java_lang_Class::as_Klass(k_mirror);
2745       if (k != NULL &amp;&amp; k-&gt;is_array_klass()) {
2746         result = true;
2747       }
2748     }
2749     *is_array_class_ptr = result;
2750   }
2751 
2752   return JVMTI_ERROR_NONE;
2753 } /* end IsArrayClass */
2754 
2755 
2756 // k_mirror - may be primitive, this must be checked
2757 // classloader_ptr - pre-checked for NULL
2758 jvmtiError
2759 JvmtiEnv::GetClassLoader(oop k_mirror, jobject* classloader_ptr) {
2760   {
2761     if (java_lang_Class::is_primitive(k_mirror)) {
2762       *classloader_ptr = (jclass) jni_reference(Handle());
2763       return JVMTI_ERROR_NONE;
2764     }
2765     JavaThread* current_thread = JavaThread::current();
2766     HandleMark hm(current_thread);
2767     Klass* k = java_lang_Class::as_Klass(k_mirror);
2768     NULL_CHECK(k, JVMTI_ERROR_INVALID_CLASS);
2769 
2770     oop result_oop = k-&gt;class_loader();
2771     if (result_oop == NULL) {
2772       *classloader_ptr = (jclass) jni_reference(Handle());
2773       return JVMTI_ERROR_NONE;
2774     }
2775     Handle result_handle = Handle(current_thread, result_oop);
2776     jclass result_jnihandle = (jclass) jni_reference(result_handle);
2777     *classloader_ptr = result_jnihandle;
2778   }
2779   return JVMTI_ERROR_NONE;
2780 } /* end GetClassLoader */
2781 
2782 
2783 // k_mirror - may be primitive, this must be checked
2784 // source_debug_extension_ptr - pre-checked for NULL
2785 jvmtiError
2786 JvmtiEnv::GetSourceDebugExtension(oop k_mirror, char** source_debug_extension_ptr) {
2787   {
2788     if (java_lang_Class::is_primitive(k_mirror)) {
2789       return JVMTI_ERROR_ABSENT_INFORMATION;
2790     }
2791     Klass* k = java_lang_Class::as_Klass(k_mirror);
2792     NULL_CHECK(k, JVMTI_ERROR_INVALID_CLASS);
2793     if (!k-&gt;is_instance_klass()) {
2794       return JVMTI_ERROR_ABSENT_INFORMATION;
2795     }
2796     const char* sde = InstanceKlass::cast(k)-&gt;source_debug_extension();
2797     NULL_CHECK(sde, JVMTI_ERROR_ABSENT_INFORMATION);
2798 
2799     {
2800       *source_debug_extension_ptr = (char *) jvmtiMalloc(strlen(sde)+1);
2801       strcpy(*source_debug_extension_ptr, sde);
2802     }
2803   }
2804 
2805   return JVMTI_ERROR_NONE;
2806 } /* end GetSourceDebugExtension */
2807 
2808   //
2809   // Object functions
2810   //
2811 
2812 // hash_code_ptr - pre-checked for NULL
2813 jvmtiError
2814 JvmtiEnv::GetObjectHashCode(jobject object, jint* hash_code_ptr) {
2815   oop mirror = JNIHandles::resolve_external_guard(object);
2816   NULL_CHECK(mirror, JVMTI_ERROR_INVALID_OBJECT);
2817   NULL_CHECK(hash_code_ptr, JVMTI_ERROR_NULL_POINTER);
2818 
2819   {
2820     jint result = (jint) mirror-&gt;identity_hash();
2821     *hash_code_ptr = result;
2822   }
2823   return JVMTI_ERROR_NONE;
2824 } /* end GetObjectHashCode */
2825 
2826 
2827 // info_ptr - pre-checked for NULL
2828 jvmtiError
2829 JvmtiEnv::GetObjectMonitorUsage(jobject object, jvmtiMonitorUsage* info_ptr) {
2830   JavaThread* calling_thread = JavaThread::current();
2831   jvmtiError err = get_object_monitor_usage(calling_thread, object, info_ptr);
2832   if (err == JVMTI_ERROR_THREAD_NOT_SUSPENDED) {
2833     // Some of the critical threads were not suspended. go to a safepoint and try again
2834     VM_GetObjectMonitorUsage op(this, calling_thread, object, info_ptr);
2835     VMThread::execute(&amp;op);
2836     err = op.result();
2837   }
2838   return err;
2839 } /* end GetObjectMonitorUsage */
2840 
2841 
2842   //
2843   // Field functions
2844   //
2845 
2846 // name_ptr - NULL is a valid value, must be checked
2847 // signature_ptr - NULL is a valid value, must be checked
2848 // generic_ptr - NULL is a valid value, must be checked
2849 jvmtiError
2850 JvmtiEnv::GetFieldName(fieldDescriptor* fdesc_ptr, char** name_ptr, char** signature_ptr, char** generic_ptr) {
2851   JavaThread* current_thread  = JavaThread::current();
2852   ResourceMark rm(current_thread);
2853   if (name_ptr == NULL) {
2854     // just don&#39;t return the name
2855   } else {
2856     const char* fieldName = fdesc_ptr-&gt;name()-&gt;as_C_string();
2857     *name_ptr =  (char*) jvmtiMalloc(strlen(fieldName) + 1);
2858     if (*name_ptr == NULL)
2859       return JVMTI_ERROR_OUT_OF_MEMORY;
2860     strcpy(*name_ptr, fieldName);
2861   }
2862   if (signature_ptr== NULL) {
2863     // just don&#39;t return the signature
2864   } else {
2865     const char* fieldSignature = fdesc_ptr-&gt;signature()-&gt;as_C_string();
2866     *signature_ptr = (char*) jvmtiMalloc(strlen(fieldSignature) + 1);
2867     if (*signature_ptr == NULL)
2868       return JVMTI_ERROR_OUT_OF_MEMORY;
2869     strcpy(*signature_ptr, fieldSignature);
2870   }
2871   if (generic_ptr != NULL) {
2872     *generic_ptr = NULL;
2873     Symbol* soop = fdesc_ptr-&gt;generic_signature();
2874     if (soop != NULL) {
2875       const char* gen_sig = soop-&gt;as_C_string();
2876       if (gen_sig != NULL) {
2877         jvmtiError err = allocate(strlen(gen_sig) + 1, (unsigned char **)generic_ptr);
2878         if (err != JVMTI_ERROR_NONE) {
2879           return err;
2880         }
2881         strcpy(*generic_ptr, gen_sig);
2882       }
2883     }
2884   }
2885   return JVMTI_ERROR_NONE;
2886 } /* end GetFieldName */
2887 
2888 
2889 // declaring_class_ptr - pre-checked for NULL
2890 jvmtiError
2891 JvmtiEnv::GetFieldDeclaringClass(fieldDescriptor* fdesc_ptr, jclass* declaring_class_ptr) {
2892 
2893   *declaring_class_ptr = get_jni_class_non_null(fdesc_ptr-&gt;field_holder());
2894   return JVMTI_ERROR_NONE;
2895 } /* end GetFieldDeclaringClass */
2896 
2897 
2898 // modifiers_ptr - pre-checked for NULL
2899 jvmtiError
2900 JvmtiEnv::GetFieldModifiers(fieldDescriptor* fdesc_ptr, jint* modifiers_ptr) {
2901 
2902   AccessFlags resultFlags = fdesc_ptr-&gt;access_flags();
2903   jint result = resultFlags.as_int();
2904   *modifiers_ptr = result;
2905 
2906   return JVMTI_ERROR_NONE;
2907 } /* end GetFieldModifiers */
2908 
2909 
2910 // is_synthetic_ptr - pre-checked for NULL
2911 jvmtiError
2912 JvmtiEnv::IsFieldSynthetic(fieldDescriptor* fdesc_ptr, jboolean* is_synthetic_ptr) {
2913   *is_synthetic_ptr = fdesc_ptr-&gt;is_synthetic();
2914   return JVMTI_ERROR_NONE;
2915 } /* end IsFieldSynthetic */
2916 
2917 
2918   //
2919   // Method functions
2920   //
2921 
2922 // method_oop - pre-checked for validity, but may be NULL meaning obsolete method
2923 // name_ptr - NULL is a valid value, must be checked
2924 // signature_ptr - NULL is a valid value, must be checked
2925 // generic_ptr - NULL is a valid value, must be checked
2926 jvmtiError
2927 JvmtiEnv::GetMethodName(Method* method_oop, char** name_ptr, char** signature_ptr, char** generic_ptr) {
2928   NULL_CHECK(method_oop, JVMTI_ERROR_INVALID_METHODID);
2929   JavaThread* current_thread  = JavaThread::current();
2930 
2931   ResourceMark rm(current_thread); // get the utf8 name and signature
2932   if (name_ptr == NULL) {
2933     // just don&#39;t return the name
2934   } else {
2935     const char* utf8_name = (const char *) method_oop-&gt;name()-&gt;as_utf8();
2936     *name_ptr = (char *) jvmtiMalloc(strlen(utf8_name)+1);
2937     strcpy(*name_ptr, utf8_name);
2938   }
2939   if (signature_ptr == NULL) {
2940     // just don&#39;t return the signature
2941   } else {
2942     const char* utf8_signature = (const char *) method_oop-&gt;signature()-&gt;as_utf8();
2943     *signature_ptr = (char *) jvmtiMalloc(strlen(utf8_signature) + 1);
2944     strcpy(*signature_ptr, utf8_signature);
2945   }
2946 
2947   if (generic_ptr != NULL) {
2948     *generic_ptr = NULL;
2949     Symbol* soop = method_oop-&gt;generic_signature();
2950     if (soop != NULL) {
2951       const char* gen_sig = soop-&gt;as_C_string();
2952       if (gen_sig != NULL) {
2953         jvmtiError err = allocate(strlen(gen_sig) + 1, (unsigned char **)generic_ptr);
2954         if (err != JVMTI_ERROR_NONE) {
2955           return err;
2956         }
2957         strcpy(*generic_ptr, gen_sig);
2958       }
2959     }
2960   }
2961   return JVMTI_ERROR_NONE;
2962 } /* end GetMethodName */
2963 
2964 
2965 // method_oop - pre-checked for validity, but may be NULL meaning obsolete method
2966 // declaring_class_ptr - pre-checked for NULL
2967 jvmtiError
2968 JvmtiEnv::GetMethodDeclaringClass(Method* method_oop, jclass* declaring_class_ptr) {
2969   NULL_CHECK(method_oop, JVMTI_ERROR_INVALID_METHODID);
2970   (*declaring_class_ptr) = get_jni_class_non_null(method_oop-&gt;method_holder());
2971   return JVMTI_ERROR_NONE;
2972 } /* end GetMethodDeclaringClass */
2973 
2974 
2975 // method_oop - pre-checked for validity, but may be NULL meaning obsolete method
2976 // modifiers_ptr - pre-checked for NULL
2977 jvmtiError
2978 JvmtiEnv::GetMethodModifiers(Method* method_oop, jint* modifiers_ptr) {
2979   NULL_CHECK(method_oop, JVMTI_ERROR_INVALID_METHODID);
2980   (*modifiers_ptr) = method_oop-&gt;access_flags().as_int() &amp; JVM_RECOGNIZED_METHOD_MODIFIERS;
2981   return JVMTI_ERROR_NONE;
2982 } /* end GetMethodModifiers */
2983 
2984 
2985 // method_oop - pre-checked for validity, but may be NULL meaning obsolete method
2986 // max_ptr - pre-checked for NULL
2987 jvmtiError
2988 JvmtiEnv::GetMaxLocals(Method* method_oop, jint* max_ptr) {
2989   NULL_CHECK(method_oop, JVMTI_ERROR_INVALID_METHODID);
2990   // get max stack
2991   (*max_ptr) = method_oop-&gt;max_locals();
2992   return JVMTI_ERROR_NONE;
2993 } /* end GetMaxLocals */
2994 
2995 
2996 // method_oop - pre-checked for validity, but may be NULL meaning obsolete method
2997 // size_ptr - pre-checked for NULL
2998 jvmtiError
2999 JvmtiEnv::GetArgumentsSize(Method* method_oop, jint* size_ptr) {
3000   NULL_CHECK(method_oop, JVMTI_ERROR_INVALID_METHODID);
3001   // get size of arguments
3002 
3003   (*size_ptr) = method_oop-&gt;size_of_parameters();
3004   return JVMTI_ERROR_NONE;
3005 } /* end GetArgumentsSize */
3006 
3007 
3008 // method_oop - pre-checked for validity, but may be NULL meaning obsolete method
3009 // entry_count_ptr - pre-checked for NULL
3010 // table_ptr - pre-checked for NULL
3011 jvmtiError
3012 JvmtiEnv::GetLineNumberTable(Method* method_oop, jint* entry_count_ptr, jvmtiLineNumberEntry** table_ptr) {
3013   NULL_CHECK(method_oop, JVMTI_ERROR_INVALID_METHODID);
3014   if (!method_oop-&gt;has_linenumber_table()) {
3015     return (JVMTI_ERROR_ABSENT_INFORMATION);
3016   }
3017 
3018   // The line number table is compressed so we don&#39;t know how big it is until decompressed.
3019   // Decompression is really fast so we just do it twice.
3020 
3021   // Compute size of table
3022   jint num_entries = 0;
3023   CompressedLineNumberReadStream stream(method_oop-&gt;compressed_linenumber_table());
3024   while (stream.read_pair()) {
3025     num_entries++;
3026   }
3027   jvmtiLineNumberEntry *jvmti_table =
3028             (jvmtiLineNumberEntry *)jvmtiMalloc(num_entries * (sizeof(jvmtiLineNumberEntry)));
3029 
3030   // Fill jvmti table
3031   if (num_entries &gt; 0) {
3032     int index = 0;
3033     CompressedLineNumberReadStream stream(method_oop-&gt;compressed_linenumber_table());
3034     while (stream.read_pair()) {
3035       jvmti_table[index].start_location = (jlocation) stream.bci();
3036       jvmti_table[index].line_number = (jint) stream.line();
3037       index++;
3038     }
3039     assert(index == num_entries, &quot;sanity check&quot;);
3040   }
3041 
3042   // Set up results
3043   (*entry_count_ptr) = num_entries;
3044   (*table_ptr) = jvmti_table;
3045 
3046   return JVMTI_ERROR_NONE;
3047 } /* end GetLineNumberTable */
3048 
3049 
3050 // method_oop - pre-checked for validity, but may be NULL meaning obsolete method
3051 // start_location_ptr - pre-checked for NULL
3052 // end_location_ptr - pre-checked for NULL
3053 jvmtiError
3054 JvmtiEnv::GetMethodLocation(Method* method_oop, jlocation* start_location_ptr, jlocation* end_location_ptr) {
3055 
3056   NULL_CHECK(method_oop, JVMTI_ERROR_INVALID_METHODID);
3057   // get start and end location
3058   (*end_location_ptr) = (jlocation) (method_oop-&gt;code_size() - 1);
3059   if (method_oop-&gt;code_size() == 0) {
3060     // there is no code so there is no start location
3061     (*start_location_ptr) = (jlocation)(-1);
3062   } else {
3063     (*start_location_ptr) = (jlocation)(0);
3064   }
3065 
3066   return JVMTI_ERROR_NONE;
3067 } /* end GetMethodLocation */
3068 
3069 
3070 // method_oop - pre-checked for validity, but may be NULL meaning obsolete method
3071 // entry_count_ptr - pre-checked for NULL
3072 // table_ptr - pre-checked for NULL
3073 jvmtiError
3074 JvmtiEnv::GetLocalVariableTable(Method* method_oop, jint* entry_count_ptr, jvmtiLocalVariableEntry** table_ptr) {
3075 
3076   NULL_CHECK(method_oop, JVMTI_ERROR_INVALID_METHODID);
3077   JavaThread* current_thread  = JavaThread::current();
3078 
3079   // does the klass have any local variable information?
3080   InstanceKlass* ik = method_oop-&gt;method_holder();
3081   if (!ik-&gt;access_flags().has_localvariable_table()) {
3082     return (JVMTI_ERROR_ABSENT_INFORMATION);
3083   }
3084 
3085   ConstantPool* constants = method_oop-&gt;constants();
3086   NULL_CHECK(constants, JVMTI_ERROR_ABSENT_INFORMATION);
3087 
3088   // in the vm localvariable table representation, 6 consecutive elements in the table
3089   // represent a 6-tuple of shorts
3090   // [start_pc, length, name_index, descriptor_index, signature_index, index]
3091   jint num_entries = method_oop-&gt;localvariable_table_length();
3092   jvmtiLocalVariableEntry *jvmti_table = (jvmtiLocalVariableEntry *)
3093                 jvmtiMalloc(num_entries * (sizeof(jvmtiLocalVariableEntry)));
3094 
3095   if (num_entries &gt; 0) {
3096     LocalVariableTableElement* table = method_oop-&gt;localvariable_table_start();
3097     for (int i = 0; i &lt; num_entries; i++) {
3098       // get the 5 tuple information from the vm table
3099       jlocation start_location = (jlocation) table[i].start_bci;
3100       jint length = (jint) table[i].length;
3101       int name_index = (int) table[i].name_cp_index;
3102       int signature_index = (int) table[i].descriptor_cp_index;
3103       int generic_signature_index = (int) table[i].signature_cp_index;
3104       jint slot = (jint) table[i].slot;
3105 
3106       // get utf8 name and signature
3107       char *name_buf = NULL;
3108       char *sig_buf = NULL;
3109       char *gen_sig_buf = NULL;
3110       {
3111         ResourceMark rm(current_thread);
3112 
3113         const char *utf8_name = (const char *) constants-&gt;symbol_at(name_index)-&gt;as_utf8();
3114         name_buf = (char *) jvmtiMalloc(strlen(utf8_name)+1);
3115         strcpy(name_buf, utf8_name);
3116 
3117         const char *utf8_signature = (const char *) constants-&gt;symbol_at(signature_index)-&gt;as_utf8();
3118         sig_buf = (char *) jvmtiMalloc(strlen(utf8_signature)+1);
3119         strcpy(sig_buf, utf8_signature);
3120 
3121         if (generic_signature_index &gt; 0) {
3122           const char *utf8_gen_sign = (const char *)
3123                                        constants-&gt;symbol_at(generic_signature_index)-&gt;as_utf8();
3124           gen_sig_buf = (char *) jvmtiMalloc(strlen(utf8_gen_sign)+1);
3125           strcpy(gen_sig_buf, utf8_gen_sign);
3126         }
3127       }
3128 
3129       // fill in the jvmti local variable table
3130       jvmti_table[i].start_location = start_location;
3131       jvmti_table[i].length = length;
3132       jvmti_table[i].name = name_buf;
3133       jvmti_table[i].signature = sig_buf;
3134       jvmti_table[i].generic_signature = gen_sig_buf;
3135       jvmti_table[i].slot = slot;
3136     }
3137   }
3138 
3139   // set results
3140   (*entry_count_ptr) = num_entries;
3141   (*table_ptr) = jvmti_table;
3142 
3143   return JVMTI_ERROR_NONE;
3144 } /* end GetLocalVariableTable */
3145 
3146 
3147 // method_oop - pre-checked for validity, but may be NULL meaning obsolete method
3148 // bytecode_count_ptr - pre-checked for NULL
3149 // bytecodes_ptr - pre-checked for NULL
3150 jvmtiError
3151 JvmtiEnv::GetBytecodes(Method* method_oop, jint* bytecode_count_ptr, unsigned char** bytecodes_ptr) {
3152   NULL_CHECK(method_oop, JVMTI_ERROR_INVALID_METHODID);
3153 
3154   HandleMark hm;
3155   methodHandle method(Thread::current(), method_oop);
3156   jint size = (jint)method-&gt;code_size();
3157   jvmtiError err = allocate(size, bytecodes_ptr);
3158   if (err != JVMTI_ERROR_NONE) {
3159     return err;
3160   }
3161 
3162   (*bytecode_count_ptr) = size;
3163   // get byte codes
3164   JvmtiClassFileReconstituter::copy_bytecodes(method, *bytecodes_ptr);
3165 
3166   return JVMTI_ERROR_NONE;
3167 } /* end GetBytecodes */
3168 
3169 
3170 // method_oop - pre-checked for validity, but may be NULL meaning obsolete method
3171 // is_native_ptr - pre-checked for NULL
3172 jvmtiError
3173 JvmtiEnv::IsMethodNative(Method* method_oop, jboolean* is_native_ptr) {
3174   NULL_CHECK(method_oop, JVMTI_ERROR_INVALID_METHODID);
3175   (*is_native_ptr) = method_oop-&gt;is_native();
3176   return JVMTI_ERROR_NONE;
3177 } /* end IsMethodNative */
3178 
3179 
3180 // method_oop - pre-checked for validity, but may be NULL meaning obsolete method
3181 // is_synthetic_ptr - pre-checked for NULL
3182 jvmtiError
3183 JvmtiEnv::IsMethodSynthetic(Method* method_oop, jboolean* is_synthetic_ptr) {
3184   NULL_CHECK(method_oop, JVMTI_ERROR_INVALID_METHODID);
3185   (*is_synthetic_ptr) = method_oop-&gt;is_synthetic();
3186   return JVMTI_ERROR_NONE;
3187 } /* end IsMethodSynthetic */
3188 
3189 
3190 // method_oop - pre-checked for validity, but may be NULL meaning obsolete method
3191 // is_obsolete_ptr - pre-checked for NULL
3192 jvmtiError
3193 JvmtiEnv::IsMethodObsolete(Method* method_oop, jboolean* is_obsolete_ptr) {
3194   if (use_version_1_0_semantics() &amp;&amp;
3195       get_capabilities()-&gt;can_redefine_classes == 0) {
3196     // This JvmtiEnv requested version 1.0 semantics and this function
3197     // requires the can_redefine_classes capability in version 1.0 so
3198     // we need to return an error here.
3199     return JVMTI_ERROR_MUST_POSSESS_CAPABILITY;
3200   }
3201 
3202   if (method_oop == NULL || method_oop-&gt;is_obsolete()) {
3203     *is_obsolete_ptr = true;
3204   } else {
3205     *is_obsolete_ptr = false;
3206   }
3207   return JVMTI_ERROR_NONE;
3208 } /* end IsMethodObsolete */
3209 
3210   //
3211   // Raw Monitor functions
3212   //
3213 
3214 // name - pre-checked for NULL
3215 // monitor_ptr - pre-checked for NULL
3216 jvmtiError
3217 JvmtiEnv::CreateRawMonitor(const char* name, jrawMonitorID* monitor_ptr) {
3218   JvmtiRawMonitor* rmonitor = new JvmtiRawMonitor(name);
3219   NULL_CHECK(rmonitor, JVMTI_ERROR_OUT_OF_MEMORY);
3220 
3221   *monitor_ptr = (jrawMonitorID)rmonitor;
3222 
3223   return JVMTI_ERROR_NONE;
3224 } /* end CreateRawMonitor */
3225 
3226 
3227 // rmonitor - pre-checked for validity
3228 jvmtiError
3229 JvmtiEnv::DestroyRawMonitor(JvmtiRawMonitor * rmonitor) {
3230   if (Threads::number_of_threads() == 0) {
3231     // Remove this monitor from pending raw monitors list
3232     // if it has entered in onload or start phase.
3233     JvmtiPendingMonitors::destroy(rmonitor);
3234   } else {
3235     Thread* thread  = Thread::current();
3236     if (rmonitor-&gt;owner() == thread) {
3237       // The caller owns this monitor which we are about to destroy.
3238       // We exit the underlying synchronization object so that the
3239       // &quot;delete monitor&quot; call below can work without an assertion
3240       // failure on systems that don&#39;t like destroying synchronization
3241       // objects that are locked.
3242       int r;
3243       int recursion = rmonitor-&gt;recursions();
3244       for (int i = 0; i &lt;= recursion; i++) {
3245         r = rmonitor-&gt;raw_exit(thread);
3246         assert(r == JvmtiRawMonitor::M_OK, &quot;raw_exit should have worked&quot;);
3247         if (r != JvmtiRawMonitor::M_OK) {  // robustness
3248           return JVMTI_ERROR_INTERNAL;
3249         }
3250       }
3251     }
3252     if (rmonitor-&gt;owner() != NULL) {
3253       // The caller is trying to destroy a monitor that is locked by
3254       // someone else. While this is not forbidden by the JVMTI
3255       // spec, it will cause an assertion failure on systems that don&#39;t
3256       // like destroying synchronization objects that are locked.
3257       // We indicate a problem with the error return (and leak the
3258       // monitor&#39;s memory).
3259       return JVMTI_ERROR_NOT_MONITOR_OWNER;
3260     }
3261   }
3262 
3263   delete rmonitor;
3264 
3265   return JVMTI_ERROR_NONE;
3266 } /* end DestroyRawMonitor */
3267 
3268 
3269 // rmonitor - pre-checked for validity
3270 jvmtiError
3271 JvmtiEnv::RawMonitorEnter(JvmtiRawMonitor * rmonitor) {
3272   if (Threads::number_of_threads() == 0) {
3273     // No JavaThreads exist so JvmtiRawMonitor enter cannot be
3274     // used, add this raw monitor to the pending list.
3275     // The pending monitors will be actually entered when
3276     // the VM is setup.
3277     // See transition_pending_raw_monitors in create_vm()
3278     // in thread.cpp.
3279     JvmtiPendingMonitors::enter(rmonitor);
3280   } else {
3281     Thread* thread = Thread::current();
3282     if (thread-&gt;is_Java_thread()) {
3283       JavaThread* current_thread = (JavaThread*)thread;
3284 
3285       /* Transition to thread_blocked without entering vm state          */
3286       /* This is really evil. Normally you can&#39;t undo _thread_blocked    */
3287       /* transitions like this because it would cause us to miss a       */
3288       /* safepoint but since the thread was already in _thread_in_native */
3289       /* the thread is not leaving a safepoint safe state and it will    */
3290       /* block when it tries to return from native. We can&#39;t safepoint   */
3291       /* block in here because we could deadlock the vmthread. Blech.    */
3292 
3293       JavaThreadState state = current_thread-&gt;thread_state();
3294       assert(state == _thread_in_native, &quot;Must be _thread_in_native&quot;);
3295       // frame should already be walkable since we are in native
3296       assert(!current_thread-&gt;has_last_Java_frame() ||
3297              current_thread-&gt;frame_anchor()-&gt;walkable(), &quot;Must be walkable&quot;);
3298       current_thread-&gt;set_thread_state(_thread_blocked);
3299 
3300       rmonitor-&gt;raw_enter(current_thread);
3301       // restore state, still at a safepoint safe state
3302       current_thread-&gt;set_thread_state(state);
3303     } else {
3304       rmonitor-&gt;raw_enter(thread);
3305     }
3306   }
3307   return JVMTI_ERROR_NONE;
3308 } /* end RawMonitorEnter */
3309 
3310 
3311 // rmonitor - pre-checked for validity
3312 jvmtiError
3313 JvmtiEnv::RawMonitorExit(JvmtiRawMonitor * rmonitor) {
3314   jvmtiError err = JVMTI_ERROR_NONE;
3315 
3316   if (Threads::number_of_threads() == 0) {
3317     // No JavaThreads exist so just remove this monitor from the pending list.
3318     // Bool value from exit is false if rmonitor is not in the list.
3319     if (!JvmtiPendingMonitors::exit(rmonitor)) {
3320       err = JVMTI_ERROR_NOT_MONITOR_OWNER;
3321     }
3322   } else {
3323     Thread* thread = Thread::current();
3324     int r = rmonitor-&gt;raw_exit(thread);
3325     if (r == JvmtiRawMonitor::M_ILLEGAL_MONITOR_STATE) {
3326       err = JVMTI_ERROR_NOT_MONITOR_OWNER;
3327     }
3328   }
3329   return err;
3330 } /* end RawMonitorExit */
3331 
3332 
3333 // rmonitor - pre-checked for validity
3334 jvmtiError
3335 JvmtiEnv::RawMonitorWait(JvmtiRawMonitor * rmonitor, jlong millis) {
3336   Thread* thread = Thread::current();
3337   int r = rmonitor-&gt;raw_wait(millis, thread);
3338 
3339   switch (r) {
3340   case JvmtiRawMonitor::M_INTERRUPTED:
3341     return JVMTI_ERROR_INTERRUPT;
3342   case JvmtiRawMonitor::M_ILLEGAL_MONITOR_STATE:
3343     return JVMTI_ERROR_NOT_MONITOR_OWNER;
3344   default:
3345     return JVMTI_ERROR_NONE;
3346   }
3347 } /* end RawMonitorWait */
3348 
3349 
3350 // rmonitor - pre-checked for validity
3351 jvmtiError
3352 JvmtiEnv::RawMonitorNotify(JvmtiRawMonitor * rmonitor) {
3353   Thread* thread = Thread::current();
3354   int r = rmonitor-&gt;raw_notify(thread);
3355 
3356   if (r == JvmtiRawMonitor::M_ILLEGAL_MONITOR_STATE) {
3357     return JVMTI_ERROR_NOT_MONITOR_OWNER;
3358   }
3359   return JVMTI_ERROR_NONE;
3360 } /* end RawMonitorNotify */
3361 
3362 
3363 // rmonitor - pre-checked for validity
3364 jvmtiError
3365 JvmtiEnv::RawMonitorNotifyAll(JvmtiRawMonitor * rmonitor) {
3366   Thread* thread = Thread::current();
3367   int r = rmonitor-&gt;raw_notifyAll(thread);
3368 
3369   if (r == JvmtiRawMonitor::M_ILLEGAL_MONITOR_STATE) {
3370     return JVMTI_ERROR_NOT_MONITOR_OWNER;
3371   }
3372   return JVMTI_ERROR_NONE;
3373 } /* end RawMonitorNotifyAll */
3374 
3375 
3376   //
3377   // JNI Function Interception functions
3378   //
3379 
3380 
3381 // function_table - pre-checked for NULL
3382 jvmtiError
3383 JvmtiEnv::SetJNIFunctionTable(const jniNativeInterface* function_table) {
3384   // Copy jni function table at safepoint.
3385   VM_JNIFunctionTableCopier copier(function_table);
3386   VMThread::execute(&amp;copier);
3387 
3388   return JVMTI_ERROR_NONE;
3389 } /* end SetJNIFunctionTable */
3390 
3391 
3392 // function_table - pre-checked for NULL
3393 jvmtiError
3394 JvmtiEnv::GetJNIFunctionTable(jniNativeInterface** function_table) {
3395   *function_table=(jniNativeInterface*)jvmtiMalloc(sizeof(jniNativeInterface));
3396   if (*function_table == NULL)
3397     return JVMTI_ERROR_OUT_OF_MEMORY;
3398   memcpy(*function_table,(JavaThread::current())-&gt;get_jni_functions(),sizeof(jniNativeInterface));
3399   return JVMTI_ERROR_NONE;
3400 } /* end GetJNIFunctionTable */
3401 
3402 
3403   //
3404   // Event Management functions
3405   //
3406 
3407 jvmtiError
3408 JvmtiEnv::GenerateEvents(jvmtiEvent event_type) {
3409   // can only generate two event types
3410   if (event_type != JVMTI_EVENT_COMPILED_METHOD_LOAD &amp;&amp;
3411       event_type != JVMTI_EVENT_DYNAMIC_CODE_GENERATED) {
3412     return JVMTI_ERROR_ILLEGAL_ARGUMENT;
3413   }
3414 
3415   // for compiled_method_load events we must check that the environment
3416   // has the can_generate_compiled_method_load_events capability.
3417   if (event_type == JVMTI_EVENT_COMPILED_METHOD_LOAD) {
3418     if (get_capabilities()-&gt;can_generate_compiled_method_load_events == 0) {
3419       return JVMTI_ERROR_MUST_POSSESS_CAPABILITY;
3420     }
3421     return JvmtiCodeBlobEvents::generate_compiled_method_load_events(this);
3422   } else {
3423     return JvmtiCodeBlobEvents::generate_dynamic_code_events(this);
3424   }
3425 
3426 } /* end GenerateEvents */
3427 
3428 
3429   //
3430   // Extension Mechanism functions
3431   //
3432 
3433 // extension_count_ptr - pre-checked for NULL
3434 // extensions - pre-checked for NULL
3435 jvmtiError
3436 JvmtiEnv::GetExtensionFunctions(jint* extension_count_ptr, jvmtiExtensionFunctionInfo** extensions) {
3437   return JvmtiExtensions::get_functions(this, extension_count_ptr, extensions);
3438 } /* end GetExtensionFunctions */
3439 
3440 
3441 // extension_count_ptr - pre-checked for NULL
3442 // extensions - pre-checked for NULL
3443 jvmtiError
3444 JvmtiEnv::GetExtensionEvents(jint* extension_count_ptr, jvmtiExtensionEventInfo** extensions) {
3445   return JvmtiExtensions::get_events(this, extension_count_ptr, extensions);
3446 } /* end GetExtensionEvents */
3447 
3448 
3449 // callback - NULL is a valid value, must be checked
3450 jvmtiError
3451 JvmtiEnv::SetExtensionEventCallback(jint extension_event_index, jvmtiExtensionEvent callback) {
3452   return JvmtiExtensions::set_event_callback(this, extension_event_index, callback);
3453 } /* end SetExtensionEventCallback */
3454 
3455   //
3456   // Timers functions
3457   //
3458 
3459 // info_ptr - pre-checked for NULL
3460 jvmtiError
3461 JvmtiEnv::GetCurrentThreadCpuTimerInfo(jvmtiTimerInfo* info_ptr) {
3462   os::current_thread_cpu_time_info(info_ptr);
3463   return JVMTI_ERROR_NONE;
3464 } /* end GetCurrentThreadCpuTimerInfo */
3465 
3466 
3467 // nanos_ptr - pre-checked for NULL
3468 jvmtiError
3469 JvmtiEnv::GetCurrentThreadCpuTime(jlong* nanos_ptr) {
3470   *nanos_ptr = os::current_thread_cpu_time();
3471   return JVMTI_ERROR_NONE;
3472 } /* end GetCurrentThreadCpuTime */
3473 
3474 
3475 // info_ptr - pre-checked for NULL
3476 jvmtiError
3477 JvmtiEnv::GetThreadCpuTimerInfo(jvmtiTimerInfo* info_ptr) {
3478   os::thread_cpu_time_info(info_ptr);
3479   return JVMTI_ERROR_NONE;
3480 } /* end GetThreadCpuTimerInfo */
3481 
3482 
3483 // Threads_lock NOT held, java_thread not protected by lock
3484 // java_thread - pre-checked
3485 // nanos_ptr - pre-checked for NULL
3486 jvmtiError
3487 JvmtiEnv::GetThreadCpuTime(JavaThread* java_thread, jlong* nanos_ptr) {
3488   *nanos_ptr = os::thread_cpu_time(java_thread);
3489   return JVMTI_ERROR_NONE;
3490 } /* end GetThreadCpuTime */
3491 
3492 
3493 // info_ptr - pre-checked for NULL
3494 jvmtiError
3495 JvmtiEnv::GetTimerInfo(jvmtiTimerInfo* info_ptr) {
3496   os::javaTimeNanos_info(info_ptr);
3497   return JVMTI_ERROR_NONE;
3498 } /* end GetTimerInfo */
3499 
3500 
3501 // nanos_ptr - pre-checked for NULL
3502 jvmtiError
3503 JvmtiEnv::GetTime(jlong* nanos_ptr) {
3504   *nanos_ptr = os::javaTimeNanos();
3505   return JVMTI_ERROR_NONE;
3506 } /* end GetTime */
3507 
3508 
3509 // processor_count_ptr - pre-checked for NULL
3510 jvmtiError
3511 JvmtiEnv::GetAvailableProcessors(jint* processor_count_ptr) {
3512   *processor_count_ptr = os::active_processor_count();
3513   return JVMTI_ERROR_NONE;
3514 } /* end GetAvailableProcessors */
3515 
3516 jvmtiError
3517 JvmtiEnv::SetHeapSamplingInterval(jint sampling_interval) {
3518   if (sampling_interval &lt; 0) {
3519     return JVMTI_ERROR_ILLEGAL_ARGUMENT;
3520   }
3521   ThreadHeapSampler::set_sampling_interval(sampling_interval);
3522   return JVMTI_ERROR_NONE;
3523 } /* end SetHeapSamplingInterval */
3524 
3525   //
3526   // System Properties functions
3527   //
3528 
3529 // count_ptr - pre-checked for NULL
3530 // property_ptr - pre-checked for NULL
3531 jvmtiError
3532 JvmtiEnv::GetSystemProperties(jint* count_ptr, char*** property_ptr) {
3533   jvmtiError err = JVMTI_ERROR_NONE;
3534 
3535   // Get the number of readable properties.
3536   *count_ptr = Arguments::PropertyList_readable_count(Arguments::system_properties());
3537 
3538   // Allocate memory to hold the exact number of readable properties.
3539   err = allocate(*count_ptr * sizeof(char *), (unsigned char **)property_ptr);
3540   if (err != JVMTI_ERROR_NONE) {
3541     return err;
3542   }
3543   int readable_count = 0;
3544   // Loop through the system properties until all the readable properties are found.
3545   for (SystemProperty* p = Arguments::system_properties(); p != NULL &amp;&amp; readable_count &lt; *count_ptr; p = p-&gt;next()) {
3546     if (p-&gt;is_readable()) {
3547       const char *key = p-&gt;key();
3548       char **tmp_value = *property_ptr+readable_count;
3549       readable_count++;
3550       err = allocate((strlen(key)+1) * sizeof(char), (unsigned char**)tmp_value);
3551       if (err == JVMTI_ERROR_NONE) {
3552         strcpy(*tmp_value, key);
3553       } else {
3554         // clean up previously allocated memory.
3555         for (int j = 0; j &lt; readable_count; j++) {
3556           Deallocate((unsigned char*)*property_ptr+j);
3557         }
3558         Deallocate((unsigned char*)property_ptr);
3559         break;
3560       }
3561     }
3562   }
3563   assert(err != JVMTI_ERROR_NONE || readable_count == *count_ptr, &quot;Bad readable property count&quot;);
3564   return err;
3565 } /* end GetSystemProperties */
3566 
3567 
3568 // property - pre-checked for NULL
3569 // value_ptr - pre-checked for NULL
3570 jvmtiError
3571 JvmtiEnv::GetSystemProperty(const char* property, char** value_ptr) {
3572   jvmtiError err = JVMTI_ERROR_NONE;
3573   const char *value;
3574 
3575   // Return JVMTI_ERROR_NOT_AVAILABLE if property is not readable or doesn&#39;t exist.
3576   value = Arguments::PropertyList_get_readable_value(Arguments::system_properties(), property);
3577   if (value == NULL) {
3578     err =  JVMTI_ERROR_NOT_AVAILABLE;
3579   } else {
3580     err = allocate((strlen(value)+1) * sizeof(char), (unsigned char **)value_ptr);
3581     if (err == JVMTI_ERROR_NONE) {
3582       strcpy(*value_ptr, value);
3583     }
3584   }
3585   return err;
3586 } /* end GetSystemProperty */
3587 
3588 
3589 // property - pre-checked for NULL
3590 // value - NULL is a valid value, must be checked
3591 jvmtiError
3592 JvmtiEnv::SetSystemProperty(const char* property, const char* value_ptr) {
3593   jvmtiError err =JVMTI_ERROR_NOT_AVAILABLE;
3594 
3595   for (SystemProperty* p = Arguments::system_properties(); p != NULL; p = p-&gt;next()) {
3596     if (strcmp(property, p-&gt;key()) == 0) {
3597       if (p-&gt;set_writeable_value(value_ptr)) {
3598         err =  JVMTI_ERROR_NONE;
3599       }
3600     }
3601   }
3602   return err;
3603 } /* end SetSystemProperty */
<a name="6" id="anc6"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="6" type="hidden" />
</body>
</html>