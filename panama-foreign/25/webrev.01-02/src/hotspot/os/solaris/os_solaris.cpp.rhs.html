<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames src/hotspot/os/solaris/os_solaris.cpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
    <script type="text/javascript" src="../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>   1 /*
<a name="1" id="anc1"></a><span class="line-modified">   2  * Copyright (c) 1997, 2020, Oracle and/or its affiliates. All rights reserved.</span>
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.
   8  *
   9  * This code is distributed in the hope that it will be useful, but WITHOUT
  10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  *
  23  */
  24 
  25 // no precompiled headers
  26 #include &quot;jvm.h&quot;
  27 #include &quot;classfile/classLoader.hpp&quot;
  28 #include &quot;classfile/systemDictionary.hpp&quot;
  29 #include &quot;classfile/vmSymbols.hpp&quot;
  30 #include &quot;code/icBuffer.hpp&quot;
  31 #include &quot;code/vtableStubs.hpp&quot;
  32 #include &quot;compiler/compileBroker.hpp&quot;
  33 #include &quot;compiler/disassembler.hpp&quot;
  34 #include &quot;interpreter/interpreter.hpp&quot;
  35 #include &quot;logging/log.hpp&quot;
  36 #include &quot;logging/logStream.hpp&quot;
  37 #include &quot;memory/allocation.inline.hpp&quot;
  38 #include &quot;memory/filemap.hpp&quot;
  39 #include &quot;memory/universe.hpp&quot;
  40 #include &quot;oops/oop.inline.hpp&quot;
  41 #include &quot;os_share_solaris.hpp&quot;
  42 #include &quot;os_solaris.inline.hpp&quot;
  43 #include &quot;prims/jniFastGetField.hpp&quot;
  44 #include &quot;prims/jvm_misc.hpp&quot;
  45 #include &quot;runtime/arguments.hpp&quot;
  46 #include &quot;runtime/atomic.hpp&quot;
  47 #include &quot;runtime/extendedPC.hpp&quot;
  48 #include &quot;runtime/globals.hpp&quot;
  49 #include &quot;runtime/interfaceSupport.inline.hpp&quot;
  50 #include &quot;runtime/java.hpp&quot;
  51 #include &quot;runtime/javaCalls.hpp&quot;
  52 #include &quot;runtime/mutexLocker.hpp&quot;
  53 #include &quot;runtime/objectMonitor.hpp&quot;
  54 #include &quot;runtime/orderAccess.hpp&quot;
  55 #include &quot;runtime/osThread.hpp&quot;
  56 #include &quot;runtime/perfMemory.hpp&quot;
  57 #include &quot;runtime/sharedRuntime.hpp&quot;
  58 #include &quot;runtime/statSampler.hpp&quot;
  59 #include &quot;runtime/stubRoutines.hpp&quot;
  60 #include &quot;runtime/thread.inline.hpp&quot;
  61 #include &quot;runtime/threadCritical.hpp&quot;
  62 #include &quot;runtime/timer.hpp&quot;
  63 #include &quot;runtime/vm_version.hpp&quot;
  64 #include &quot;semaphore_posix.hpp&quot;
  65 #include &quot;services/attachListener.hpp&quot;
  66 #include &quot;services/memTracker.hpp&quot;
  67 #include &quot;services/runtimeService.hpp&quot;
  68 #include &quot;utilities/align.hpp&quot;
  69 #include &quot;utilities/decoder.hpp&quot;
  70 #include &quot;utilities/defaultStream.hpp&quot;
  71 #include &quot;utilities/events.hpp&quot;
  72 #include &quot;utilities/growableArray.hpp&quot;
  73 #include &quot;utilities/macros.hpp&quot;
  74 #include &quot;utilities/vmError.hpp&quot;
  75 
  76 // put OS-includes here
  77 # include &lt;dlfcn.h&gt;
  78 # include &lt;errno.h&gt;
  79 # include &lt;exception&gt;
  80 # include &lt;link.h&gt;
  81 # include &lt;poll.h&gt;
  82 # include &lt;pthread.h&gt;
  83 # include &lt;setjmp.h&gt;
  84 # include &lt;signal.h&gt;
  85 # include &lt;stdio.h&gt;
  86 # include &lt;alloca.h&gt;
  87 # include &lt;sys/filio.h&gt;
  88 # include &lt;sys/ipc.h&gt;
  89 # include &lt;sys/lwp.h&gt;
  90 # include &lt;sys/machelf.h&gt;     // for elf Sym structure used by dladdr1
  91 # include &lt;sys/mman.h&gt;
  92 # include &lt;sys/processor.h&gt;
  93 # include &lt;sys/procset.h&gt;
  94 # include &lt;sys/pset.h&gt;
  95 # include &lt;sys/resource.h&gt;
  96 # include &lt;sys/shm.h&gt;
  97 # include &lt;sys/socket.h&gt;
  98 # include &lt;sys/stat.h&gt;
  99 # include &lt;sys/systeminfo.h&gt;
 100 # include &lt;sys/time.h&gt;
 101 # include &lt;sys/times.h&gt;
 102 # include &lt;sys/types.h&gt;
 103 # include &lt;sys/wait.h&gt;
 104 # include &lt;sys/utsname.h&gt;
 105 # include &lt;thread.h&gt;
 106 # include &lt;unistd.h&gt;
 107 # include &lt;sys/priocntl.h&gt;
 108 # include &lt;sys/rtpriocntl.h&gt;
 109 # include &lt;sys/tspriocntl.h&gt;
 110 # include &lt;sys/iapriocntl.h&gt;
 111 # include &lt;sys/fxpriocntl.h&gt;
 112 # include &lt;sys/loadavg.h&gt;
 113 # include &lt;string.h&gt;
 114 # include &lt;stdio.h&gt;
 115 
 116 # define _STRUCTURED_PROC 1  //  this gets us the new structured proc interfaces of 5.6 &amp; later
 117 # include &lt;sys/procfs.h&gt;     //  see comment in &lt;sys/procfs.h&gt;
 118 
 119 #define MAX_PATH (2 * K)
 120 
 121 // for timer info max values which include all bits
 122 #define ALL_64_BITS CONST64(0xFFFFFFFFFFFFFFFF)
 123 
 124 
 125 // Here are some liblgrp types from sys/lgrp_user.h to be able to
 126 // compile on older systems without this header file.
 127 
 128 #ifndef MADV_ACCESS_LWP
 129   #define  MADV_ACCESS_LWP   7       /* next LWP to access heavily */
 130 #endif
 131 #ifndef MADV_ACCESS_MANY
 132   #define  MADV_ACCESS_MANY  8       /* many processes to access heavily */
 133 #endif
 134 
 135 #ifndef LGRP_RSRC_CPU
 136   #define LGRP_RSRC_CPU      0       /* CPU resources */
 137 #endif
 138 #ifndef LGRP_RSRC_MEM
 139   #define LGRP_RSRC_MEM      1       /* memory resources */
 140 #endif
 141 
 142 // Values for ThreadPriorityPolicy == 1
 143 int prio_policy1[CriticalPriority+1] = {
 144   -99999,  0, 16,  32,  48,  64,
 145           80, 96, 112, 124, 127, 127 };
 146 
 147 // System parameters used internally
 148 static clock_t clock_tics_per_sec = 100;
 149 
 150 // Track if we have called enable_extended_FILE_stdio (on Solaris 10u4+)
 151 static bool enabled_extended_FILE_stdio = false;
 152 
 153 // For diagnostics to print a message once. see run_periodic_checks
 154 static bool check_addr0_done = false;
 155 static sigset_t check_signal_done;
 156 static bool check_signals = true;
 157 
 158 address os::Solaris::handler_start;  // start pc of thr_sighndlrinfo
 159 address os::Solaris::handler_end;    // end pc of thr_sighndlrinfo
 160 
 161 address os::Solaris::_main_stack_base = NULL;  // 4352906 workaround
 162 
 163 os::Solaris::pthread_setname_np_func_t os::Solaris::_pthread_setname_np = NULL;
 164 
 165 // &quot;default&quot; initializers for missing libc APIs
 166 extern &quot;C&quot; {
 167   static int lwp_mutex_init(mutex_t *mx, int scope, void *arg) { memset(mx, 0, sizeof(mutex_t)); return 0; }
 168   static int lwp_mutex_destroy(mutex_t *mx)                 { return 0; }
 169 
 170   static int lwp_cond_init(cond_t *cv, int scope, void *arg){ memset(cv, 0, sizeof(cond_t)); return 0; }
 171   static int lwp_cond_destroy(cond_t *cv)                   { return 0; }
 172 }
 173 
 174 // &quot;default&quot; initializers for pthread-based synchronization
 175 extern &quot;C&quot; {
 176   static int pthread_mutex_default_init(mutex_t *mx, int scope, void *arg) { memset(mx, 0, sizeof(mutex_t)); return 0; }
 177   static int pthread_cond_default_init(cond_t *cv, int scope, void *arg){ memset(cv, 0, sizeof(cond_t)); return 0; }
 178 }
 179 
 180 static void unpackTime(timespec* absTime, bool isAbsolute, jlong time);
 181 
 182 static inline size_t adjust_stack_size(address base, size_t size) {
 183   if ((ssize_t)size &lt; 0) {
 184     // 4759953: Compensate for ridiculous stack size.
 185     size = max_intx;
 186   }
 187   if (size &gt; (size_t)base) {
 188     // 4812466: Make sure size doesn&#39;t allow the stack to wrap the address space.
 189     size = (size_t)base;
 190   }
 191   return size;
 192 }
 193 
 194 static inline stack_t get_stack_info() {
 195   stack_t st;
 196   int retval = thr_stksegment(&amp;st);
 197   st.ss_size = adjust_stack_size((address)st.ss_sp, st.ss_size);
 198   assert(retval == 0, &quot;incorrect return value from thr_stksegment&quot;);
 199   assert((address)&amp;st &lt; (address)st.ss_sp, &quot;Invalid stack base returned&quot;);
 200   assert((address)&amp;st &gt; (address)st.ss_sp-st.ss_size, &quot;Invalid stack size returned&quot;);
 201   return st;
 202 }
 203 
 204 static void _handle_uncaught_cxx_exception() {
 205   VMError::report_and_die(&quot;An uncaught C++ exception&quot;);
 206 }
 207 
 208 bool os::is_primordial_thread(void) {
 209   int r = thr_main();
 210   guarantee(r == 0 || r == 1, &quot;CR6501650 or CR6493689&quot;);
 211   return r == 1;
 212 }
 213 
 214 address os::current_stack_base() {
 215   bool _is_primordial_thread = is_primordial_thread();
 216 
 217   // Workaround 4352906, avoid calls to thr_stksegment by
 218   // thr_main after the first one (it looks like we trash
 219   // some data, causing the value for ss_sp to be incorrect).
 220   if (!_is_primordial_thread || os::Solaris::_main_stack_base == NULL) {
 221     stack_t st = get_stack_info();
 222     if (_is_primordial_thread) {
 223       // cache initial value of stack base
 224       os::Solaris::_main_stack_base = (address)st.ss_sp;
 225     }
 226     return (address)st.ss_sp;
 227   } else {
 228     guarantee(os::Solaris::_main_stack_base != NULL, &quot;Attempt to use null cached stack base&quot;);
 229     return os::Solaris::_main_stack_base;
 230   }
 231 }
 232 
 233 size_t os::current_stack_size() {
 234   size_t size;
 235 
 236   if (!is_primordial_thread()) {
 237     size = get_stack_info().ss_size;
 238   } else {
 239     struct rlimit limits;
 240     getrlimit(RLIMIT_STACK, &amp;limits);
 241     size = adjust_stack_size(os::Solaris::_main_stack_base, (size_t)limits.rlim_cur);
 242   }
 243   // base may not be page aligned
 244   address base = current_stack_base();
 245   address bottom = align_up(base - size, os::vm_page_size());;
 246   return (size_t)(base - bottom);
 247 }
 248 
 249 struct tm* os::localtime_pd(const time_t* clock, struct tm*  res) {
 250   return localtime_r(clock, res);
 251 }
 252 
 253 void os::Solaris::try_enable_extended_io() {
 254   typedef int (*enable_extended_FILE_stdio_t)(int, int);
 255 
 256   if (!UseExtendedFileIO) {
 257     return;
 258   }
 259 
 260   enable_extended_FILE_stdio_t enabler =
 261     (enable_extended_FILE_stdio_t) dlsym(RTLD_DEFAULT,
 262                                          &quot;enable_extended_FILE_stdio&quot;);
 263   if (enabler) {
 264     enabler(-1, -1);
 265   }
 266 }
 267 
 268 jint os::Solaris::_os_thread_limit = 0;
 269 volatile jint os::Solaris::_os_thread_count = 0;
 270 
 271 julong os::available_memory() {
 272   return Solaris::available_memory();
 273 }
 274 
 275 julong os::Solaris::available_memory() {
 276   return (julong)sysconf(_SC_AVPHYS_PAGES) * os::vm_page_size();
 277 }
 278 
 279 julong os::Solaris::_physical_memory = 0;
 280 
 281 julong os::physical_memory() {
 282   return Solaris::physical_memory();
 283 }
 284 
 285 static hrtime_t first_hrtime = 0;
 286 static const hrtime_t hrtime_hz = 1000*1000*1000;
 287 static volatile hrtime_t max_hrtime = 0;
 288 
 289 
 290 void os::Solaris::initialize_system_info() {
 291   set_processor_count(sysconf(_SC_NPROCESSORS_CONF));
 292   _physical_memory = (julong)sysconf(_SC_PHYS_PAGES) *
 293                                      (julong)sysconf(_SC_PAGESIZE);
 294 }
 295 
 296 uint os::processor_id() {
 297   const processorid_t id = ::getcpuid();
 298   assert(id &gt;= 0 &amp;&amp; id &lt; _processor_count, &quot;Invalid processor id&quot;);
 299   return (uint)id;
 300 }
 301 
 302 int os::active_processor_count() {
 303   // User has overridden the number of active processors
 304   if (ActiveProcessorCount &gt; 0) {
 305     log_trace(os)(&quot;active_processor_count: &quot;
 306                   &quot;active processor count set by user : %d&quot;,
 307                   ActiveProcessorCount);
 308     return ActiveProcessorCount;
 309   }
 310 
 311   int online_cpus = sysconf(_SC_NPROCESSORS_ONLN);
 312   pid_t pid = getpid();
 313   psetid_t pset = PS_NONE;
 314   // Are we running in a processor set or is there any processor set around?
 315   if (pset_bind(PS_QUERY, P_PID, pid, &amp;pset) == 0) {
 316     uint_t pset_cpus;
 317     // Query the number of cpus available to us.
 318     if (pset_info(pset, NULL, &amp;pset_cpus, NULL) == 0) {
 319       assert(pset_cpus &gt; 0 &amp;&amp; pset_cpus &lt;= online_cpus, &quot;sanity check&quot;);
 320       return pset_cpus;
 321     }
 322   }
 323   // Otherwise return number of online cpus
 324   return online_cpus;
 325 }
 326 
 327 void os::set_native_thread_name(const char *name) {
 328   if (Solaris::_pthread_setname_np != NULL) {
 329     // Only the first 31 bytes of &#39;name&#39; are processed by pthread_setname_np
 330     // but we explicitly copy into a size-limited buffer to avoid any
 331     // possible overflow.
 332     char buf[32];
 333     snprintf(buf, sizeof(buf), &quot;%s&quot;, name);
 334     buf[sizeof(buf) - 1] = &#39;\0&#39;;
 335     Solaris::_pthread_setname_np(pthread_self(), buf);
 336   }
 337 }
 338 
 339 bool os::bind_to_processor(uint processor_id) {
 340   // We assume that a processorid_t can be stored in a uint.
 341   assert(sizeof(uint) == sizeof(processorid_t),
 342          &quot;can&#39;t convert uint to processorid_t&quot;);
 343   int bind_result =
 344     processor_bind(P_LWPID,                       // bind LWP.
 345                    P_MYID,                        // bind current LWP.
 346                    (processorid_t) processor_id,  // id.
 347                    NULL);                         // don&#39;t return old binding.
 348   return (bind_result == 0);
 349 }
 350 
 351 // Return true if user is running as root.
 352 
 353 bool os::have_special_privileges() {
 354   static bool init = false;
 355   static bool privileges = false;
 356   if (!init) {
 357     privileges = (getuid() != geteuid()) || (getgid() != getegid());
 358     init = true;
 359   }
 360   return privileges;
 361 }
 362 
 363 
 364 void os::init_system_properties_values() {
 365   // The next steps are taken in the product version:
 366   //
 367   // Obtain the JAVA_HOME value from the location of libjvm.so.
 368   // This library should be located at:
 369   // &lt;JAVA_HOME&gt;/jre/lib/&lt;arch&gt;/{client|server}/libjvm.so.
 370   //
 371   // If &quot;/jre/lib/&quot; appears at the right place in the path, then we
 372   // assume libjvm.so is installed in a JDK and we use this path.
 373   //
 374   // Otherwise exit with message: &quot;Could not create the Java virtual machine.&quot;
 375   //
 376   // The following extra steps are taken in the debugging version:
 377   //
 378   // If &quot;/jre/lib/&quot; does NOT appear at the right place in the path
 379   // instead of exit check for $JAVA_HOME environment variable.
 380   //
 381   // If it is defined and we are able to locate $JAVA_HOME/jre/lib/&lt;arch&gt;,
 382   // then we append a fake suffix &quot;hotspot/libjvm.so&quot; to this path so
 383   // it looks like libjvm.so is installed there
 384   // &lt;JAVA_HOME&gt;/jre/lib/&lt;arch&gt;/hotspot/libjvm.so.
 385   //
 386   // Otherwise exit.
 387   //
 388   // Important note: if the location of libjvm.so changes this
 389   // code needs to be changed accordingly.
 390 
 391 // Base path of extensions installed on the system.
 392 #define SYS_EXT_DIR     &quot;/usr/jdk/packages&quot;
 393 #define EXTENSIONS_DIR  &quot;/lib/ext&quot;
 394 
 395   // Buffer that fits several sprintfs.
 396   // Note that the space for the colon and the trailing null are provided
 397   // by the nulls included by the sizeof operator.
 398   const size_t bufsize =
 399     MAX3((size_t)MAXPATHLEN,  // For dll_dir &amp; friends.
 400          sizeof(SYS_EXT_DIR) + sizeof(&quot;/lib/&quot;), // invariant ld_library_path
 401          (size_t)MAXPATHLEN + sizeof(EXTENSIONS_DIR) + sizeof(SYS_EXT_DIR) + sizeof(EXTENSIONS_DIR)); // extensions dir
 402   char *buf = NEW_C_HEAP_ARRAY(char, bufsize, mtInternal);
 403 
 404   // sysclasspath, java_home, dll_dir
 405   {
 406     char *pslash;
 407     os::jvm_path(buf, bufsize);
 408 
 409     // Found the full path to libjvm.so.
 410     // Now cut the path to &lt;java_home&gt;/jre if we can.
 411     *(strrchr(buf, &#39;/&#39;)) = &#39;\0&#39;; // Get rid of /libjvm.so.
 412     pslash = strrchr(buf, &#39;/&#39;);
 413     if (pslash != NULL) {
 414       *pslash = &#39;\0&#39;;            // Get rid of /{client|server|hotspot}.
 415     }
 416     Arguments::set_dll_dir(buf);
 417 
 418     if (pslash != NULL) {
 419       pslash = strrchr(buf, &#39;/&#39;);
 420       if (pslash != NULL) {
 421         *pslash = &#39;\0&#39;;        // Get rid of /lib.
 422       }
 423     }
 424     Arguments::set_java_home(buf);
 425     if (!set_boot_path(&#39;/&#39;, &#39;:&#39;)) {
 426       vm_exit_during_initialization(&quot;Failed setting boot class path.&quot;, NULL);
 427     }
 428   }
 429 
 430   // Where to look for native libraries.
 431   {
 432     // Use dlinfo() to determine the correct java.library.path.
 433     //
 434     // If we&#39;re launched by the Java launcher, and the user
 435     // does not set java.library.path explicitly on the commandline,
 436     // the Java launcher sets LD_LIBRARY_PATH for us and unsets
 437     // LD_LIBRARY_PATH_32 and LD_LIBRARY_PATH_64.  In this case
 438     // dlinfo returns LD_LIBRARY_PATH + crle settings (including
 439     // /usr/lib), which is exactly what we want.
 440     //
 441     // If the user does set java.library.path, it completely
 442     // overwrites this setting, and always has.
 443     //
 444     // If we&#39;re not launched by the Java launcher, we may
 445     // get here with any/all of the LD_LIBRARY_PATH[_32|64]
 446     // settings.  Again, dlinfo does exactly what we want.
 447 
 448     Dl_serinfo     info_sz, *info = &amp;info_sz;
 449     Dl_serpath     *path;
 450     char           *library_path;
 451     char           *common_path = buf;
 452 
 453     // Determine search path count and required buffer size.
 454     if (dlinfo(RTLD_SELF, RTLD_DI_SERINFOSIZE, (void *)info) == -1) {
 455       FREE_C_HEAP_ARRAY(char, buf);
 456       vm_exit_during_initialization(&quot;dlinfo SERINFOSIZE request&quot;, dlerror());
 457     }
 458 
 459     // Allocate new buffer and initialize.
 460     info = (Dl_serinfo*)NEW_C_HEAP_ARRAY(char, info_sz.dls_size, mtInternal);
 461     info-&gt;dls_size = info_sz.dls_size;
 462     info-&gt;dls_cnt = info_sz.dls_cnt;
 463 
 464     // Obtain search path information.
 465     if (dlinfo(RTLD_SELF, RTLD_DI_SERINFO, (void *)info) == -1) {
 466       FREE_C_HEAP_ARRAY(char, buf);
 467       FREE_C_HEAP_ARRAY(char, info);
 468       vm_exit_during_initialization(&quot;dlinfo SERINFO request&quot;, dlerror());
 469     }
 470 
 471     path = &amp;info-&gt;dls_serpath[0];
 472 
 473     // Note: Due to a legacy implementation, most of the library path
 474     // is set in the launcher. This was to accomodate linking restrictions
 475     // on legacy Solaris implementations (which are no longer supported).
 476     // Eventually, all the library path setting will be done here.
 477     //
 478     // However, to prevent the proliferation of improperly built native
 479     // libraries, the new path component /usr/jdk/packages is added here.
 480 
 481     // Construct the invariant part of ld_library_path.
 482     sprintf(common_path, SYS_EXT_DIR &quot;/lib&quot;);
 483 
 484     // Struct size is more than sufficient for the path components obtained
 485     // through the dlinfo() call, so only add additional space for the path
 486     // components explicitly added here.
 487     size_t library_path_size = info-&gt;dls_size + strlen(common_path);
 488     library_path = NEW_C_HEAP_ARRAY(char, library_path_size, mtInternal);
 489     library_path[0] = &#39;\0&#39;;
 490 
 491     // Construct the desired Java library path from the linker&#39;s library
 492     // search path.
 493     //
 494     // For compatibility, it is optimal that we insert the additional path
 495     // components specific to the Java VM after those components specified
 496     // in LD_LIBRARY_PATH (if any) but before those added by the ld.so
 497     // infrastructure.
 498     if (info-&gt;dls_cnt == 0) { // Not sure this can happen, but allow for it.
 499       strcpy(library_path, common_path);
 500     } else {
 501       int inserted = 0;
 502       int i;
 503       for (i = 0; i &lt; info-&gt;dls_cnt; i++, path++) {
 504         uint_t flags = path-&gt;dls_flags &amp; LA_SER_MASK;
 505         if (((flags &amp; LA_SER_LIBPATH) == 0) &amp;&amp; !inserted) {
 506           strcat(library_path, common_path);
 507           strcat(library_path, os::path_separator());
 508           inserted = 1;
 509         }
 510         strcat(library_path, path-&gt;dls_name);
 511         strcat(library_path, os::path_separator());
 512       }
 513       // Eliminate trailing path separator.
 514       library_path[strlen(library_path)-1] = &#39;\0&#39;;
 515     }
 516 
 517     // happens before argument parsing - can&#39;t use a trace flag
 518     // tty-&gt;print_raw(&quot;init_system_properties_values: native lib path: &quot;);
 519     // tty-&gt;print_raw_cr(library_path);
 520 
 521     // Callee copies into its own buffer.
 522     Arguments::set_library_path(library_path);
 523 
 524     FREE_C_HEAP_ARRAY(char, library_path);
 525     FREE_C_HEAP_ARRAY(char, info);
 526   }
 527 
 528   // Extensions directories.
 529   sprintf(buf, &quot;%s&quot; EXTENSIONS_DIR &quot;:&quot; SYS_EXT_DIR EXTENSIONS_DIR, Arguments::get_java_home());
 530   Arguments::set_ext_dirs(buf);
 531 
 532   FREE_C_HEAP_ARRAY(char, buf);
 533 
 534 #undef SYS_EXT_DIR
 535 #undef EXTENSIONS_DIR
 536 }
 537 
 538 void os::breakpoint() {
 539   BREAKPOINT;
 540 }
 541 
 542 bool os::Solaris::valid_stack_address(Thread* thread, address sp) {
 543   address  stackStart  = (address)thread-&gt;stack_base();
 544   address  stackEnd    = (address)(stackStart - (address)thread-&gt;stack_size());
 545   if (sp &lt; stackStart &amp;&amp; sp &gt;= stackEnd) return true;
 546   return false;
 547 }
 548 
 549 extern &quot;C&quot; void breakpoint() {
 550   // use debugger to set breakpoint here
 551 }
 552 
 553 static thread_t main_thread;
 554 
 555 // Thread start routine for all newly created threads
 556 extern &quot;C&quot; void* thread_native_entry(void* thread_addr) {
 557 
 558   Thread* thread = (Thread*)thread_addr;
 559 
 560   thread-&gt;record_stack_base_and_size();
 561 
 562   // Try to randomize the cache line index of hot stack frames.
 563   // This helps when threads of the same stack traces evict each other&#39;s
 564   // cache lines. The threads can be either from the same JVM instance, or
 565   // from different JVM instances. The benefit is especially true for
 566   // processors with hyperthreading technology.
 567   static int counter = 0;
 568   int pid = os::current_process_id();
 569   alloca(((pid ^ counter++) &amp; 7) * 128);
 570 
 571   int prio;
 572 
 573   thread-&gt;initialize_thread_current();
 574 
 575   OSThread* osthr = thread-&gt;osthread();
 576 
 577   osthr-&gt;set_lwp_id(_lwp_self());  // Store lwp in case we are bound
 578 
 579   log_info(os, thread)(&quot;Thread is alive (tid: &quot; UINTX_FORMAT &quot;).&quot;,
 580     os::current_thread_id());
 581 
 582   if (UseNUMA) {
 583     int lgrp_id = os::numa_get_group_id();
 584     if (lgrp_id != -1) {
 585       thread-&gt;set_lgrp_id(lgrp_id);
 586     }
 587   }
 588 
 589   // Our priority was set when we were created, and stored in the
 590   // osthread, but couldn&#39;t be passed through to our LWP until now.
 591   // So read back the priority and set it again.
 592 
 593   if (osthr-&gt;thread_id() != -1) {
 594     if (UseThreadPriorities) {
 595       int prio = osthr-&gt;native_priority();
 596       if (ThreadPriorityVerbose) {
 597         tty-&gt;print_cr(&quot;Starting Thread &quot; INTPTR_FORMAT &quot;, LWP is &quot;
 598                       INTPTR_FORMAT &quot;, setting priority: %d\n&quot;,
 599                       osthr-&gt;thread_id(), osthr-&gt;lwp_id(), prio);
 600       }
 601       os::set_native_priority(thread, prio);
 602     }
 603   } else if (ThreadPriorityVerbose) {
 604     warning(&quot;Can&#39;t set priority in _start routine, thread id hasn&#39;t been set\n&quot;);
 605   }
 606 
 607   assert(osthr-&gt;get_state() == RUNNABLE, &quot;invalid os thread state&quot;);
 608 
 609   // initialize signal mask for this thread
 610   os::Solaris::hotspot_sigmask(thread);
 611 
 612   os::Solaris::init_thread_fpu_state();
 613   std::set_terminate(_handle_uncaught_cxx_exception);
 614 
 615   thread-&gt;call_run();
 616 
 617   // Note: at this point the thread object may already have deleted itself.
 618   // Do not dereference it from here on out.
 619 
 620   // One less thread is executing
 621   // When the VMThread gets here, the main thread may have already exited
 622   // which frees the CodeHeap containing the Atomic::dec code
 623   if (thread != VMThread::vm_thread() &amp;&amp; VMThread::vm_thread() != NULL) {
 624     Atomic::dec(&amp;os::Solaris::_os_thread_count);
 625   }
 626 
 627   log_info(os, thread)(&quot;Thread finished (tid: &quot; UINTX_FORMAT &quot;).&quot;, os::current_thread_id());
 628 
 629   if (UseDetachedThreads) {
 630     thr_exit(NULL);
 631     ShouldNotReachHere();
 632   }
 633   return NULL;
 634 }
 635 
 636 static OSThread* create_os_thread(Thread* thread, thread_t thread_id) {
 637   // Allocate the OSThread object
 638   OSThread* osthread = new OSThread(NULL, NULL);
 639   if (osthread == NULL) return NULL;
 640 
 641   // Store info on the Solaris thread into the OSThread
 642   osthread-&gt;set_thread_id(thread_id);
 643   osthread-&gt;set_lwp_id(_lwp_self());
 644 
 645   if (UseNUMA) {
 646     int lgrp_id = os::numa_get_group_id();
 647     if (lgrp_id != -1) {
 648       thread-&gt;set_lgrp_id(lgrp_id);
 649     }
 650   }
 651 
 652   if (ThreadPriorityVerbose) {
 653     tty-&gt;print_cr(&quot;In create_os_thread, Thread &quot; INTPTR_FORMAT &quot;, LWP is &quot; INTPTR_FORMAT &quot;\n&quot;,
 654                   osthread-&gt;thread_id(), osthread-&gt;lwp_id());
 655   }
 656 
 657   // Initial thread state is INITIALIZED, not SUSPENDED
 658   osthread-&gt;set_state(INITIALIZED);
 659 
 660   return osthread;
 661 }
 662 
 663 void os::Solaris::hotspot_sigmask(Thread* thread) {
 664   //Save caller&#39;s signal mask
 665   sigset_t sigmask;
 666   pthread_sigmask(SIG_SETMASK, NULL, &amp;sigmask);
 667   OSThread *osthread = thread-&gt;osthread();
 668   osthread-&gt;set_caller_sigmask(sigmask);
 669 
 670   pthread_sigmask(SIG_UNBLOCK, os::Solaris::unblocked_signals(), NULL);
 671   if (!ReduceSignalUsage) {
 672     if (thread-&gt;is_VM_thread()) {
 673       // Only the VM thread handles BREAK_SIGNAL ...
 674       pthread_sigmask(SIG_UNBLOCK, vm_signals(), NULL);
 675     } else {
 676       // ... all other threads block BREAK_SIGNAL
 677       assert(!sigismember(vm_signals(), SIGINT), &quot;SIGINT should not be blocked&quot;);
 678       pthread_sigmask(SIG_BLOCK, vm_signals(), NULL);
 679     }
 680   }
 681 }
 682 
 683 bool os::create_attached_thread(JavaThread* thread) {
 684 #ifdef ASSERT
 685   thread-&gt;verify_not_published();
 686 #endif
 687   OSThread* osthread = create_os_thread(thread, thr_self());
 688   if (osthread == NULL) {
 689     return false;
 690   }
 691 
 692   // Initial thread state is RUNNABLE
 693   osthread-&gt;set_state(RUNNABLE);
 694   thread-&gt;set_osthread(osthread);
 695 
 696   // initialize signal mask for this thread
 697   // and save the caller&#39;s signal mask
 698   os::Solaris::hotspot_sigmask(thread);
 699 
 700   log_info(os, thread)(&quot;Thread attached (tid: &quot; UINTX_FORMAT &quot;).&quot;,
 701     os::current_thread_id());
 702 
 703   return true;
 704 }
 705 
 706 bool os::create_main_thread(JavaThread* thread) {
 707 #ifdef ASSERT
 708   thread-&gt;verify_not_published();
 709 #endif
 710   if (_starting_thread == NULL) {
 711     _starting_thread = create_os_thread(thread, main_thread);
 712     if (_starting_thread == NULL) {
 713       return false;
 714     }
 715   }
 716 
 717   // The primodial thread is runnable from the start
 718   _starting_thread-&gt;set_state(RUNNABLE);
 719 
 720   thread-&gt;set_osthread(_starting_thread);
 721 
 722   // initialize signal mask for this thread
 723   // and save the caller&#39;s signal mask
 724   os::Solaris::hotspot_sigmask(thread);
 725 
 726   return true;
 727 }
 728 
 729 // Helper function to trace thread attributes, similar to os::Posix::describe_pthread_attr()
 730 static char* describe_thr_create_attributes(char* buf, size_t buflen,
 731                                             size_t stacksize, long flags) {
 732   stringStream ss(buf, buflen);
 733   ss.print(&quot;stacksize: &quot; SIZE_FORMAT &quot;k, &quot;, stacksize / 1024);
 734   ss.print(&quot;flags: &quot;);
 735   #define PRINT_FLAG(f) if (flags &amp; f) ss.print( #f &quot; &quot;);
 736   #define ALL(X) \
 737     X(THR_SUSPENDED) \
 738     X(THR_DETACHED) \
 739     X(THR_BOUND) \
 740     X(THR_NEW_LWP) \
 741     X(THR_DAEMON)
 742   ALL(PRINT_FLAG)
 743   #undef ALL
 744   #undef PRINT_FLAG
 745   return buf;
 746 }
 747 
 748 // return default stack size for thr_type
 749 size_t os::Posix::default_stack_size(os::ThreadType thr_type) {
 750   // default stack size when not specified by caller is 1M (2M for LP64)
 751   size_t s = (BytesPerWord &gt;&gt; 2) * K * K;
 752   return s;
 753 }
 754 
 755 bool os::create_thread(Thread* thread, ThreadType thr_type,
 756                        size_t req_stack_size) {
 757   // Allocate the OSThread object
 758   OSThread* osthread = new OSThread(NULL, NULL);
 759   if (osthread == NULL) {
 760     return false;
 761   }
 762 
 763   if (ThreadPriorityVerbose) {
 764     char *thrtyp;
 765     switch (thr_type) {
 766     case vm_thread:
 767       thrtyp = (char *)&quot;vm&quot;;
 768       break;
 769     case cgc_thread:
 770       thrtyp = (char *)&quot;cgc&quot;;
 771       break;
 772     case pgc_thread:
 773       thrtyp = (char *)&quot;pgc&quot;;
 774       break;
 775     case java_thread:
 776       thrtyp = (char *)&quot;java&quot;;
 777       break;
 778     case compiler_thread:
 779       thrtyp = (char *)&quot;compiler&quot;;
 780       break;
 781     case watcher_thread:
 782       thrtyp = (char *)&quot;watcher&quot;;
 783       break;
 784     default:
 785       thrtyp = (char *)&quot;unknown&quot;;
 786       break;
 787     }
 788     tty-&gt;print_cr(&quot;In create_thread, creating a %s thread\n&quot;, thrtyp);
 789   }
 790 
 791   // calculate stack size if it&#39;s not specified by caller
 792   size_t stack_size = os::Posix::get_initial_stack_size(thr_type, req_stack_size);
 793 
 794   // Initial state is ALLOCATED but not INITIALIZED
 795   osthread-&gt;set_state(ALLOCATED);
 796 
 797   if (os::Solaris::_os_thread_count &gt; os::Solaris::_os_thread_limit) {
 798     // We got lots of threads. Check if we still have some address space left.
 799     // Need to be at least 5Mb of unreserved address space. We do check by
 800     // trying to reserve some.
 801     const size_t VirtualMemoryBangSize = 20*K*K;
 802     char* mem = os::reserve_memory(VirtualMemoryBangSize);
 803     if (mem == NULL) {
 804       delete osthread;
 805       return false;
 806     } else {
 807       // Release the memory again
 808       os::release_memory(mem, VirtualMemoryBangSize);
 809     }
 810   }
 811 
 812   // Setup osthread because the child thread may need it.
 813   thread-&gt;set_osthread(osthread);
 814 
 815   // Create the Solaris thread
 816   thread_t tid = 0;
 817   long     flags = (UseDetachedThreads ? THR_DETACHED : 0) | THR_SUSPENDED;
 818   int      status;
 819 
 820   // Mark that we don&#39;t have an lwp or thread id yet.
 821   // In case we attempt to set the priority before the thread starts.
 822   osthread-&gt;set_lwp_id(-1);
 823   osthread-&gt;set_thread_id(-1);
 824 
 825   status = thr_create(NULL, stack_size, thread_native_entry, thread, flags, &amp;tid);
 826 
 827   char buf[64];
 828   if (status == 0) {
 829     log_info(os, thread)(&quot;Thread started (tid: &quot; UINTX_FORMAT &quot;, attributes: %s). &quot;,
 830       (uintx) tid, describe_thr_create_attributes(buf, sizeof(buf), stack_size, flags));
 831   } else {
 832     log_warning(os, thread)(&quot;Failed to start thread - thr_create failed (%s) for attributes: %s.&quot;,
 833       os::errno_name(status), describe_thr_create_attributes(buf, sizeof(buf), stack_size, flags));
 834     // Log some OS information which might explain why creating the thread failed.
 835     log_info(os, thread)(&quot;Number of threads approx. running in the VM: %d&quot;, Threads::number_of_threads());
 836     LogStream st(Log(os, thread)::info());
 837     os::Posix::print_rlimit_info(&amp;st);
 838     os::print_memory_info(&amp;st);
 839   }
 840 
 841   if (status != 0) {
 842     thread-&gt;set_osthread(NULL);
 843     // Need to clean up stuff we&#39;ve allocated so far
 844     delete osthread;
 845     return false;
 846   }
 847 
 848   Atomic::inc(&amp;os::Solaris::_os_thread_count);
 849 
 850   // Store info on the Solaris thread into the OSThread
 851   osthread-&gt;set_thread_id(tid);
 852 
 853   // Remember that we created this thread so we can set priority on it
 854   osthread-&gt;set_vm_created();
 855 
 856   // Most thread types will set an explicit priority before starting the thread,
 857   // but for those that don&#39;t we need a valid value to read back in thread_native_entry.
 858   osthread-&gt;set_native_priority(NormPriority);
 859 
 860   // Initial thread state is INITIALIZED, not SUSPENDED
 861   osthread-&gt;set_state(INITIALIZED);
 862 
 863   // The thread is returned suspended (in state INITIALIZED), and is started higher up in the call chain
 864   return true;
 865 }
 866 
 867 debug_only(static bool signal_sets_initialized = false);
 868 static sigset_t unblocked_sigs, vm_sigs;
 869 
 870 void os::Solaris::signal_sets_init() {
 871   // Should also have an assertion stating we are still single-threaded.
 872   assert(!signal_sets_initialized, &quot;Already initialized&quot;);
 873   // Fill in signals that are necessarily unblocked for all threads in
 874   // the VM. Currently, we unblock the following signals:
 875   // SHUTDOWN{1,2,3}_SIGNAL: for shutdown hooks support (unless over-ridden
 876   //                         by -Xrs (=ReduceSignalUsage));
 877   // BREAK_SIGNAL which is unblocked only by the VM thread and blocked by all
 878   // other threads. The &quot;ReduceSignalUsage&quot; boolean tells us not to alter
 879   // the dispositions or masks wrt these signals.
 880   // Programs embedding the VM that want to use the above signals for their
 881   // own purposes must, at this time, use the &quot;-Xrs&quot; option to prevent
 882   // interference with shutdown hooks and BREAK_SIGNAL thread dumping.
 883   // (See bug 4345157, and other related bugs).
 884   // In reality, though, unblocking these signals is really a nop, since
 885   // these signals are not blocked by default.
 886   sigemptyset(&amp;unblocked_sigs);
 887   sigaddset(&amp;unblocked_sigs, SIGILL);
 888   sigaddset(&amp;unblocked_sigs, SIGSEGV);
 889   sigaddset(&amp;unblocked_sigs, SIGBUS);
 890   sigaddset(&amp;unblocked_sigs, SIGFPE);
 891   sigaddset(&amp;unblocked_sigs, ASYNC_SIGNAL);
 892 
 893   if (!ReduceSignalUsage) {
 894     if (!os::Posix::is_sig_ignored(SHUTDOWN1_SIGNAL)) {
 895       sigaddset(&amp;unblocked_sigs, SHUTDOWN1_SIGNAL);
 896     }
 897     if (!os::Posix::is_sig_ignored(SHUTDOWN2_SIGNAL)) {
 898       sigaddset(&amp;unblocked_sigs, SHUTDOWN2_SIGNAL);
 899     }
 900     if (!os::Posix::is_sig_ignored(SHUTDOWN3_SIGNAL)) {
 901       sigaddset(&amp;unblocked_sigs, SHUTDOWN3_SIGNAL);
 902     }
 903   }
 904   // Fill in signals that are blocked by all but the VM thread.
 905   sigemptyset(&amp;vm_sigs);
 906   if (!ReduceSignalUsage) {
 907     sigaddset(&amp;vm_sigs, BREAK_SIGNAL);
 908   }
 909   debug_only(signal_sets_initialized = true);
 910 
 911   // For diagnostics only used in run_periodic_checks
 912   sigemptyset(&amp;check_signal_done);
 913 }
 914 
 915 // These are signals that are unblocked while a thread is running Java.
 916 // (For some reason, they get blocked by default.)
 917 sigset_t* os::Solaris::unblocked_signals() {
 918   assert(signal_sets_initialized, &quot;Not initialized&quot;);
 919   return &amp;unblocked_sigs;
 920 }
 921 
 922 // These are the signals that are blocked while a (non-VM) thread is
 923 // running Java. Only the VM thread handles these signals.
 924 sigset_t* os::Solaris::vm_signals() {
 925   assert(signal_sets_initialized, &quot;Not initialized&quot;);
 926   return &amp;vm_sigs;
 927 }
 928 
 929 // CR 7190089: on Solaris, primordial thread&#39;s stack needs adjusting.
 930 // Without the adjustment, stack size is incorrect if stack is set to unlimited (ulimit -s unlimited).
 931 void os::Solaris::correct_stack_boundaries_for_primordial_thread(Thread* thr) {
 932   assert(is_primordial_thread(), &quot;Call only for primordial thread&quot;);
 933 
 934   JavaThread* jt = (JavaThread *)thr;
 935   assert(jt != NULL, &quot;Sanity check&quot;);
 936   size_t stack_size;
 937   address base = jt-&gt;stack_base();
 938   if (Arguments::created_by_java_launcher()) {
 939     // Use 2MB to allow for Solaris 7 64 bit mode.
 940     stack_size = JavaThread::stack_size_at_create() == 0
 941       ? 2048*K : JavaThread::stack_size_at_create();
 942 
 943     // There are rare cases when we may have already used more than
 944     // the basic stack size allotment before this method is invoked.
 945     // Attempt to allow for a normally sized java_stack.
 946     size_t current_stack_offset = (size_t)(base - (address)&amp;stack_size);
 947     stack_size += ReservedSpace::page_align_size_down(current_stack_offset);
 948   } else {
 949     // 6269555: If we were not created by a Java launcher, i.e. if we are
 950     // running embedded in a native application, treat the primordial thread
 951     // as much like a native attached thread as possible.  This means using
 952     // the current stack size from thr_stksegment(), unless it is too large
 953     // to reliably setup guard pages.  A reasonable max size is 8MB.
 954     size_t current_size = os::current_stack_size();
 955     // This should never happen, but just in case....
 956     if (current_size == 0) current_size = 2 * K * K;
 957     stack_size = current_size &gt; (8 * K * K) ? (8 * K * K) : current_size;
 958   }
 959   address bottom = align_up(base - stack_size, os::vm_page_size());;
 960   stack_size = (size_t)(base - bottom);
 961 
 962   assert(stack_size &gt; 0, &quot;Stack size calculation problem&quot;);
 963 
 964   if (stack_size &gt; jt-&gt;stack_size()) {
 965 #ifndef PRODUCT
 966     struct rlimit limits;
 967     getrlimit(RLIMIT_STACK, &amp;limits);
 968     size_t size = adjust_stack_size(base, (size_t)limits.rlim_cur);
 969     assert(size &gt;= jt-&gt;stack_size(), &quot;Stack size problem in main thread&quot;);
 970 #endif
 971     tty-&gt;print_cr(&quot;Stack size of %d Kb exceeds current limit of %d Kb.\n&quot;
 972                   &quot;(Stack sizes are rounded up to a multiple of the system page size.)\n&quot;
 973                   &quot;See limit(1) to increase the stack size limit.&quot;,
 974                   stack_size / K, jt-&gt;stack_size() / K);
 975     vm_exit(1);
 976   }
 977   assert(jt-&gt;stack_size() &gt;= stack_size,
 978          &quot;Attempt to map more stack than was allocated&quot;);
 979   jt-&gt;set_stack_size(stack_size);
 980 
 981 }
 982 
 983 
 984 
 985 // Free Solaris resources related to the OSThread
 986 void os::free_thread(OSThread* osthread) {
 987   assert(osthread != NULL, &quot;os::free_thread but osthread not set&quot;);
 988 
 989   // We are told to free resources of the argument thread,
 990   // but we can only really operate on the current thread.
 991   assert(Thread::current()-&gt;osthread() == osthread,
 992          &quot;os::free_thread but not current thread&quot;);
 993 
 994   // Restore caller&#39;s signal mask
 995   sigset_t sigmask = osthread-&gt;caller_sigmask();
 996   pthread_sigmask(SIG_SETMASK, &amp;sigmask, NULL);
 997 
 998   delete osthread;
 999 }
1000 
1001 void os::pd_start_thread(Thread* thread) {
1002   int status = thr_continue(thread-&gt;osthread()-&gt;thread_id());
1003   assert_status(status == 0, status, &quot;thr_continue failed&quot;);
1004 }
1005 
1006 
1007 intx os::current_thread_id() {
1008   return (intx)thr_self();
1009 }
1010 
1011 static pid_t _initial_pid = 0;
1012 
1013 int os::current_process_id() {
1014   return (int)(_initial_pid ? _initial_pid : getpid());
1015 }
1016 
1017 // gethrtime() should be monotonic according to the documentation,
1018 // but some virtualized platforms are known to break this guarantee.
1019 // getTimeNanos() must be guaranteed not to move backwards, so we
1020 // are forced to add a check here.
1021 inline hrtime_t getTimeNanos() {
1022   const hrtime_t now = gethrtime();
1023   const hrtime_t prev = max_hrtime;
1024   if (now &lt;= prev) {
1025     return prev;   // same or retrograde time;
1026   }
1027   const hrtime_t obsv = Atomic::cmpxchg(&amp;max_hrtime, prev, now);
1028   assert(obsv &gt;= prev, &quot;invariant&quot;);   // Monotonicity
1029   // If the CAS succeeded then we&#39;re done and return &quot;now&quot;.
1030   // If the CAS failed and the observed value &quot;obsv&quot; is &gt;= now then
1031   // we should return &quot;obsv&quot;.  If the CAS failed and now &gt; obsv &gt; prv then
1032   // some other thread raced this thread and installed a new value, in which case
1033   // we could either (a) retry the entire operation, (b) retry trying to install now
1034   // or (c) just return obsv.  We use (c).   No loop is required although in some cases
1035   // we might discard a higher &quot;now&quot; value in deference to a slightly lower but freshly
1036   // installed obsv value.   That&#39;s entirely benign -- it admits no new orderings compared
1037   // to (a) or (b) -- and greatly reduces coherence traffic.
1038   // We might also condition (c) on the magnitude of the delta between obsv and now.
1039   // Avoiding excessive CAS operations to hot RW locations is critical.
1040   // See https://blogs.oracle.com/dave/entry/cas_and_cache_trivia_invalidate
1041   return (prev == obsv) ? now : obsv;
1042 }
1043 
1044 // Time since start-up in seconds to a fine granularity.
1045 // Used by VMSelfDestructTimer and the MemProfiler.
1046 double os::elapsedTime() {
1047   return (double)(getTimeNanos() - first_hrtime) / (double)hrtime_hz;
1048 }
1049 
1050 jlong os::elapsed_counter() {
1051   return (jlong)(getTimeNanos() - first_hrtime);
1052 }
1053 
1054 jlong os::elapsed_frequency() {
1055   return hrtime_hz;
1056 }
1057 
1058 // Return the real, user, and system times in seconds from an
1059 // arbitrary fixed point in the past.
1060 bool os::getTimesSecs(double* process_real_time,
1061                       double* process_user_time,
1062                       double* process_system_time) {
1063   struct tms ticks;
1064   clock_t real_ticks = times(&amp;ticks);
1065 
1066   if (real_ticks == (clock_t) (-1)) {
1067     return false;
1068   } else {
1069     double ticks_per_second = (double) clock_tics_per_sec;
1070     *process_user_time = ((double) ticks.tms_utime) / ticks_per_second;
1071     *process_system_time = ((double) ticks.tms_stime) / ticks_per_second;
1072     // For consistency return the real time from getTimeNanos()
1073     // converted to seconds.
1074     *process_real_time = ((double) getTimeNanos()) / ((double) NANOUNITS);
1075 
1076     return true;
1077   }
1078 }
1079 
1080 bool os::supports_vtime() { return true; }
1081 
1082 double os::elapsedVTime() {
1083   return (double)gethrvtime() / (double)hrtime_hz;
1084 }
1085 
1086 // Must return millis since Jan 1 1970 for JVM_CurrentTimeMillis
1087 jlong os::javaTimeMillis() {
1088   timeval t;
1089   if (gettimeofday(&amp;t, NULL) == -1) {
1090     fatal(&quot;os::javaTimeMillis: gettimeofday (%s)&quot;, os::strerror(errno));
1091   }
1092   return jlong(t.tv_sec) * 1000  +  jlong(t.tv_usec) / 1000;
1093 }
1094 
1095 // Must return seconds+nanos since Jan 1 1970. This must use the same
1096 // time source as javaTimeMillis and can&#39;t use get_nsec_fromepoch as
1097 // we need better than 1ms accuracy
1098 void os::javaTimeSystemUTC(jlong &amp;seconds, jlong &amp;nanos) {
1099   timeval t;
1100   if (gettimeofday(&amp;t, NULL) == -1) {
1101     fatal(&quot;os::javaTimeSystemUTC: gettimeofday (%s)&quot;, os::strerror(errno));
1102   }
1103   seconds = jlong(t.tv_sec);
1104   nanos = jlong(t.tv_usec) * 1000;
1105 }
1106 
1107 
1108 jlong os::javaTimeNanos() {
1109   return (jlong)getTimeNanos();
1110 }
1111 
1112 void os::javaTimeNanos_info(jvmtiTimerInfo *info_ptr) {
1113   info_ptr-&gt;max_value = ALL_64_BITS;      // gethrtime() uses all 64 bits
1114   info_ptr-&gt;may_skip_backward = false;    // not subject to resetting or drifting
1115   info_ptr-&gt;may_skip_forward = false;     // not subject to resetting or drifting
1116   info_ptr-&gt;kind = JVMTI_TIMER_ELAPSED;   // elapsed not CPU time
1117 }
1118 
1119 char * os::local_time_string(char *buf, size_t buflen) {
1120   struct tm t;
1121   time_t long_time;
1122   time(&amp;long_time);
1123   localtime_r(&amp;long_time, &amp;t);
1124   jio_snprintf(buf, buflen, &quot;%d-%02d-%02d %02d:%02d:%02d&quot;,
1125                t.tm_year + 1900, t.tm_mon + 1, t.tm_mday,
1126                t.tm_hour, t.tm_min, t.tm_sec);
1127   return buf;
1128 }
1129 
1130 // Note: os::shutdown() might be called very early during initialization, or
1131 // called from signal handler. Before adding something to os::shutdown(), make
1132 // sure it is async-safe and can handle partially initialized VM.
1133 void os::shutdown() {
1134 
1135   // allow PerfMemory to attempt cleanup of any persistent resources
1136   perfMemory_exit();
1137 
1138   // needs to remove object in file system
1139   AttachListener::abort();
1140 
1141   // flush buffered output, finish log files
1142   ostream_abort();
1143 
1144   // Check for abort hook
1145   abort_hook_t abort_hook = Arguments::abort_hook();
1146   if (abort_hook != NULL) {
1147     abort_hook();
1148   }
1149 }
1150 
1151 // Note: os::abort() might be called very early during initialization, or
1152 // called from signal handler. Before adding something to os::abort(), make
1153 // sure it is async-safe and can handle partially initialized VM.
1154 void os::abort(bool dump_core, void* siginfo, const void* context) {
1155   os::shutdown();
1156   if (dump_core) {
1157 #ifndef PRODUCT
1158     fdStream out(defaultStream::output_fd());
1159     out.print_raw(&quot;Current thread is &quot;);
1160     char buf[16];
1161     jio_snprintf(buf, sizeof(buf), UINTX_FORMAT, os::current_thread_id());
1162     out.print_raw_cr(buf);
1163     out.print_raw_cr(&quot;Dumping core ...&quot;);
1164 #endif
1165     ::abort(); // dump core (for debugging)
1166   }
1167 
1168   ::exit(1);
1169 }
1170 
1171 // Die immediately, no exit hook, no abort hook, no cleanup.
1172 // Dump a core file, if possible, for debugging.
1173 void os::die() {
1174   if (TestUnresponsiveErrorHandler &amp;&amp; !CreateCoredumpOnCrash) {
1175     // For TimeoutInErrorHandlingTest.java, we just kill the VM
1176     // and don&#39;t take the time to generate a core file.
1177     os::signal_raise(SIGKILL);
1178   } else {
1179     ::abort();
1180   }
1181 }
1182 
1183 // DLL functions
1184 
1185 const char* os::dll_file_extension() { return &quot;.so&quot;; }
1186 
1187 // This must be hard coded because it&#39;s the system&#39;s temporary
1188 // directory not the java application&#39;s temp directory, ala java.io.tmpdir.
1189 const char* os::get_temp_directory() { return &quot;/tmp&quot;; }
1190 
1191 // check if addr is inside libjvm.so
1192 bool os::address_is_in_vm(address addr) {
1193   static address libjvm_base_addr;
1194   Dl_info dlinfo;
1195 
1196   if (libjvm_base_addr == NULL) {
1197     if (dladdr(CAST_FROM_FN_PTR(void *, os::address_is_in_vm), &amp;dlinfo) != 0) {
1198       libjvm_base_addr = (address)dlinfo.dli_fbase;
1199     }
1200     assert(libjvm_base_addr !=NULL, &quot;Cannot obtain base address for libjvm&quot;);
1201   }
1202 
1203   if (dladdr((void *)addr, &amp;dlinfo) != 0) {
1204     if (libjvm_base_addr == (address)dlinfo.dli_fbase) return true;
1205   }
1206 
1207   return false;
1208 }
1209 
1210 typedef int (*dladdr1_func_type)(void *, Dl_info *, void **, int);
1211 static dladdr1_func_type dladdr1_func = NULL;
1212 
1213 bool os::dll_address_to_function_name(address addr, char *buf,
1214                                       int buflen, int * offset,
1215                                       bool demangle) {
1216   // buf is not optional, but offset is optional
1217   assert(buf != NULL, &quot;sanity check&quot;);
1218 
1219   Dl_info dlinfo;
1220 
1221   // dladdr1_func was initialized in os::init()
1222   if (dladdr1_func != NULL) {
1223     // yes, we have dladdr1
1224 
1225     // Support for dladdr1 is checked at runtime; it may be
1226     // available even if the vm is built on a machine that does
1227     // not have dladdr1 support.  Make sure there is a value for
1228     // RTLD_DL_SYMENT.
1229 #ifndef RTLD_DL_SYMENT
1230   #define RTLD_DL_SYMENT 1
1231 #endif
1232 #ifdef _LP64
1233     Elf64_Sym * info;
1234 #else
1235     Elf32_Sym * info;
1236 #endif
1237     if (dladdr1_func((void *)addr, &amp;dlinfo, (void **)&amp;info,
1238                      RTLD_DL_SYMENT) != 0) {
1239       // see if we have a matching symbol that covers our address
1240       if (dlinfo.dli_saddr != NULL &amp;&amp;
1241           (char *)dlinfo.dli_saddr + info-&gt;st_size &gt; (char *)addr) {
1242         if (dlinfo.dli_sname != NULL) {
1243           if (!(demangle &amp;&amp; Decoder::demangle(dlinfo.dli_sname, buf, buflen))) {
1244             jio_snprintf(buf, buflen, &quot;%s&quot;, dlinfo.dli_sname);
1245           }
1246           if (offset != NULL) *offset = addr - (address)dlinfo.dli_saddr;
1247           return true;
1248         }
1249       }
1250       // no matching symbol so try for just file info
1251       if (dlinfo.dli_fname != NULL &amp;&amp; dlinfo.dli_fbase != NULL) {
1252         if (Decoder::decode((address)(addr - (address)dlinfo.dli_fbase),
1253                             buf, buflen, offset, dlinfo.dli_fname, demangle)) {
1254           return true;
1255         }
1256       }
1257     }
1258     buf[0] = &#39;\0&#39;;
1259     if (offset != NULL) *offset  = -1;
1260     return false;
1261   }
1262 
1263   // no, only dladdr is available
1264   if (dladdr((void *)addr, &amp;dlinfo) != 0) {
1265     // see if we have a matching symbol
1266     if (dlinfo.dli_saddr != NULL &amp;&amp; dlinfo.dli_sname != NULL) {
1267       if (!(demangle &amp;&amp; Decoder::demangle(dlinfo.dli_sname, buf, buflen))) {
1268         jio_snprintf(buf, buflen, dlinfo.dli_sname);
1269       }
1270       if (offset != NULL) *offset = addr - (address)dlinfo.dli_saddr;
1271       return true;
1272     }
1273     // no matching symbol so try for just file info
1274     if (dlinfo.dli_fname != NULL &amp;&amp; dlinfo.dli_fbase != NULL) {
1275       if (Decoder::decode((address)(addr - (address)dlinfo.dli_fbase),
1276                           buf, buflen, offset, dlinfo.dli_fname, demangle)) {
1277         return true;
1278       }
1279     }
1280   }
1281   buf[0] = &#39;\0&#39;;
1282   if (offset != NULL) *offset  = -1;
1283   return false;
1284 }
1285 
1286 bool os::dll_address_to_library_name(address addr, char* buf,
1287                                      int buflen, int* offset) {
1288   // buf is not optional, but offset is optional
1289   assert(buf != NULL, &quot;sanity check&quot;);
1290 
1291   Dl_info dlinfo;
1292 
1293   if (dladdr((void*)addr, &amp;dlinfo) != 0) {
1294     if (dlinfo.dli_fname != NULL) {
1295       jio_snprintf(buf, buflen, &quot;%s&quot;, dlinfo.dli_fname);
1296     }
1297     if (dlinfo.dli_fbase != NULL &amp;&amp; offset != NULL) {
1298       *offset = addr - (address)dlinfo.dli_fbase;
1299     }
1300     return true;
1301   }
1302 
1303   buf[0] = &#39;\0&#39;;
1304   if (offset) *offset = -1;
1305   return false;
1306 }
1307 
1308 int os::get_loaded_modules_info(os::LoadedModulesCallbackFunc callback, void *param) {
1309   Dl_info dli;
1310   // Sanity check?
1311   if (dladdr(CAST_FROM_FN_PTR(void *, os::get_loaded_modules_info), &amp;dli) == 0 ||
1312       dli.dli_fname == NULL) {
1313     return 1;
1314   }
1315 
1316   void * handle = dlopen(dli.dli_fname, RTLD_LAZY);
1317   if (handle == NULL) {
1318     return 1;
1319   }
1320 
1321   Link_map *map;
1322   dlinfo(handle, RTLD_DI_LINKMAP, &amp;map);
1323   if (map == NULL) {
1324     dlclose(handle);
1325     return 1;
1326   }
1327 
1328   while (map-&gt;l_prev != NULL) {
1329     map = map-&gt;l_prev;
1330   }
1331 
1332   while (map != NULL) {
1333     // Iterate through all map entries and call callback with fields of interest
1334     if(callback(map-&gt;l_name, (address)map-&gt;l_addr, (address)0, param)) {
1335       dlclose(handle);
1336       return 1;
1337     }
1338     map = map-&gt;l_next;
1339   }
1340 
1341   dlclose(handle);
1342   return 0;
1343 }
1344 
1345 int _print_dll_info_cb(const char * name, address base_address, address top_address, void * param) {
1346   outputStream * out = (outputStream *) param;
1347   out-&gt;print_cr(PTR_FORMAT &quot; \t%s&quot;, base_address, name);
1348   return 0;
1349 }
1350 
1351 void os::print_dll_info(outputStream * st) {
1352   st-&gt;print_cr(&quot;Dynamic libraries:&quot;); st-&gt;flush();
1353   if (get_loaded_modules_info(_print_dll_info_cb, (void *)st)) {
1354     st-&gt;print_cr(&quot;Error: Cannot print dynamic libraries.&quot;);
1355   }
1356 }
1357 
1358 static void change_endianness(Elf32_Half&amp; val) {
1359   unsigned char *ptr = (unsigned char *)&amp;val;
1360   unsigned char swp = ptr[0];
1361   ptr[0] = ptr[1];
1362   ptr[1] = swp;
1363 }
1364 
1365 // Loads .dll/.so and
1366 // in case of error it checks if .dll/.so was built for the
1367 // same architecture as Hotspot is running on
1368 
1369 void * os::dll_load(const char *filename, char *ebuf, int ebuflen) {
1370   log_info(os)(&quot;attempting shared library load of %s&quot;, filename);
1371 
1372   void * result= ::dlopen(filename, RTLD_LAZY);
1373   if (result != NULL) {
1374     // Successful loading
1375     Events::log(NULL, &quot;Loaded shared library %s&quot;, filename);
1376     log_info(os)(&quot;shared library load of %s was successful&quot;, filename);
1377     return result;
1378   }
1379 
1380   Elf32_Ehdr elf_head;
1381   const char* error_report = ::dlerror();
1382   if (error_report == NULL) {
1383     error_report = &quot;dlerror returned no error description&quot;;
1384   }
1385   if (ebuf != NULL &amp;&amp; ebuflen &gt; 0) {
1386     ::strncpy(ebuf, error_report, ebuflen-1);
1387     ebuf[ebuflen-1]=&#39;\0&#39;;
1388   }
1389 
1390   Events::log(NULL, &quot;Loading shared library %s failed, %s&quot;, filename, error_report);
1391   log_info(os)(&quot;shared library load of %s failed, %s&quot;, filename, error_report);
1392 
1393   int diag_msg_max_length=ebuflen-strlen(ebuf);
1394   char* diag_msg_buf=ebuf+strlen(ebuf);
1395 
1396   if (diag_msg_max_length==0) {
1397     // No more space in ebuf for additional diagnostics message
1398     return NULL;
1399   }
1400 
1401 
1402   int file_descriptor= ::open(filename, O_RDONLY | O_NONBLOCK);
1403 
1404   if (file_descriptor &lt; 0) {
1405     // Can&#39;t open library, report dlerror() message
1406     return NULL;
1407   }
1408 
1409   bool failed_to_read_elf_head=
1410     (sizeof(elf_head)!=
1411      (::read(file_descriptor, &amp;elf_head,sizeof(elf_head))));
1412 
1413   ::close(file_descriptor);
1414   if (failed_to_read_elf_head) {
1415     // file i/o error - report dlerror() msg
1416     return NULL;
1417   }
1418 
1419   if (elf_head.e_ident[EI_DATA] != LITTLE_ENDIAN_ONLY(ELFDATA2LSB) BIG_ENDIAN_ONLY(ELFDATA2MSB)) {
1420     // handle invalid/out of range endianness values
1421     if (elf_head.e_ident[EI_DATA] == 0 || elf_head.e_ident[EI_DATA] &gt; 2) {
1422       return NULL;
1423     }
1424     change_endianness(elf_head.e_machine);
1425   }
1426 
1427   typedef struct {
1428     Elf32_Half    code;         // Actual value as defined in elf.h
1429     Elf32_Half    compat_class; // Compatibility of archs at VM&#39;s sense
1430     unsigned char elf_class;    // 32 or 64 bit
1431     unsigned char endianess;    // MSB or LSB
1432     char*         name;         // String representation
1433   } arch_t;
1434 
1435 #ifndef EM_AARCH64
1436   #define EM_AARCH64    183               /* ARM AARCH64 */
1437 #endif
1438 
1439   static const arch_t arch_array[]={
1440     {EM_386,         EM_386,     ELFCLASS32, ELFDATA2LSB, (char*)&quot;IA 32&quot;},
1441     {EM_486,         EM_386,     ELFCLASS32, ELFDATA2LSB, (char*)&quot;IA 32&quot;},
1442     {EM_IA_64,       EM_IA_64,   ELFCLASS64, ELFDATA2LSB, (char*)&quot;IA 64&quot;},
1443     {EM_X86_64,      EM_X86_64,  ELFCLASS64, ELFDATA2LSB, (char*)&quot;AMD 64&quot;},
1444     {EM_SPARC,       EM_SPARC,   ELFCLASS32, ELFDATA2MSB, (char*)&quot;Sparc 32&quot;},
1445     {EM_SPARC32PLUS, EM_SPARC,   ELFCLASS32, ELFDATA2MSB, (char*)&quot;Sparc 32&quot;},
1446     {EM_SPARCV9,     EM_SPARCV9, ELFCLASS64, ELFDATA2MSB, (char*)&quot;Sparc v9 64&quot;},
1447     {EM_PPC,         EM_PPC,     ELFCLASS32, ELFDATA2MSB, (char*)&quot;Power PC 32&quot;},
1448     {EM_PPC64,       EM_PPC64,   ELFCLASS64, ELFDATA2MSB, (char*)&quot;Power PC 64&quot;},
1449     {EM_ARM,         EM_ARM,     ELFCLASS32, ELFDATA2LSB, (char*)&quot;ARM&quot;},
1450     // we only support 64 bit z architecture
1451     {EM_S390,        EM_S390,    ELFCLASS64, ELFDATA2MSB, (char*)&quot;IBM System/390&quot;},
1452     {EM_AARCH64,     EM_AARCH64, ELFCLASS64, ELFDATA2LSB, (char*)&quot;AARCH64&quot;}
1453   };
1454 
1455 #if  (defined IA32)
1456   static  Elf32_Half running_arch_code=EM_386;
1457 #elif   (defined AMD64)
1458   static  Elf32_Half running_arch_code=EM_X86_64;
1459 #elif  (defined IA64)
1460   static  Elf32_Half running_arch_code=EM_IA_64;
1461 #elif  (defined __sparc) &amp;&amp; (defined _LP64)
1462   static  Elf32_Half running_arch_code=EM_SPARCV9;
1463 #elif  (defined __sparc) &amp;&amp; (!defined _LP64)
1464   static  Elf32_Half running_arch_code=EM_SPARC;
1465 #elif  (defined __powerpc64__)
1466   static  Elf32_Half running_arch_code=EM_PPC64;
1467 #elif  (defined __powerpc__)
1468   static  Elf32_Half running_arch_code=EM_PPC;
1469 #elif (defined ARM)
1470   static  Elf32_Half running_arch_code=EM_ARM;
1471 #else
1472   #error Method os::dll_load requires that one of following is defined:\
1473        IA32, AMD64, IA64, __sparc, __powerpc__, ARM, ARM
1474 #endif
1475 
1476   // Identify compatibility class for VM&#39;s architecture and library&#39;s architecture
1477   // Obtain string descriptions for architectures
1478 
1479   arch_t lib_arch={elf_head.e_machine,0,elf_head.e_ident[EI_CLASS], elf_head.e_ident[EI_DATA], NULL};
1480   int running_arch_index=-1;
1481 
1482   for (unsigned int i=0; i &lt; ARRAY_SIZE(arch_array); i++) {
1483     if (running_arch_code == arch_array[i].code) {
1484       running_arch_index    = i;
1485     }
1486     if (lib_arch.code == arch_array[i].code) {
1487       lib_arch.compat_class = arch_array[i].compat_class;
1488       lib_arch.name         = arch_array[i].name;
1489     }
1490   }
1491 
1492   assert(running_arch_index != -1,
1493          &quot;Didn&#39;t find running architecture code (running_arch_code) in arch_array&quot;);
1494   if (running_arch_index == -1) {
1495     // Even though running architecture detection failed
1496     // we may still continue with reporting dlerror() message
1497     return NULL;
1498   }
1499 
1500   if (lib_arch.compat_class != arch_array[running_arch_index].compat_class) {
1501     if (lib_arch.name != NULL) {
1502       ::snprintf(diag_msg_buf, diag_msg_max_length-1,
1503                  &quot; (Possible cause: can&#39;t load %s .so on a %s platform)&quot;,
1504                  lib_arch.name, arch_array[running_arch_index].name);
1505     } else {
1506       ::snprintf(diag_msg_buf, diag_msg_max_length-1,
1507                  &quot; (Possible cause: can&#39;t load this .so (machine code=0x%x) on a %s platform)&quot;,
1508                  lib_arch.code, arch_array[running_arch_index].name);
1509     }
1510     return NULL;
1511   }
1512 
1513   if (lib_arch.endianess != arch_array[running_arch_index].endianess) {
1514     ::snprintf(diag_msg_buf, diag_msg_max_length-1,&quot; (Possible cause: endianness mismatch)&quot;);
1515     return NULL;
1516   }
1517 
1518   // ELF file class/capacity : 0 - invalid, 1 - 32bit, 2 - 64bit
1519   if (lib_arch.elf_class &gt; 2 || lib_arch.elf_class &lt; 1) {
1520     ::snprintf(diag_msg_buf, diag_msg_max_length-1, &quot; (Possible cause: invalid ELF file class)&quot;);
1521     return NULL;
1522   }
1523 
1524   if (lib_arch.elf_class != arch_array[running_arch_index].elf_class) {
1525     ::snprintf(diag_msg_buf, diag_msg_max_length-1,
1526                &quot; (Possible cause: architecture word width mismatch, can&#39;t load %d-bit .so on a %d-bit platform)&quot;,
1527                (int) lib_arch.elf_class * 32, arch_array[running_arch_index].elf_class * 32);
1528     return NULL;
1529   }
1530 
1531   return NULL;
1532 }
1533 
1534 void* os::dll_lookup(void* handle, const char* name) {
1535   return dlsym(handle, name);
1536 }
1537 
1538 void* os::get_default_process_handle() {
1539   return (void*)::dlopen(NULL, RTLD_LAZY);
1540 }
1541 
1542 static inline time_t get_mtime(const char* filename) {
1543   struct stat st;
1544   int ret = os::stat(filename, &amp;st);
1545   assert(ret == 0, &quot;failed to stat() file &#39;%s&#39;: %s&quot;, filename, os::strerror(errno));
1546   return st.st_mtime;
1547 }
1548 
1549 int os::compare_file_modified_times(const char* file1, const char* file2) {
1550   time_t t1 = get_mtime(file1);
1551   time_t t2 = get_mtime(file2);
1552   return t1 - t2;
1553 }
1554 
1555 static bool _print_ascii_file(const char* filename, outputStream* st) {
1556   int fd = ::open(filename, O_RDONLY);
1557   if (fd == -1) {
1558     return false;
1559   }
1560 
1561   char buf[32];
1562   int bytes;
1563   while ((bytes = ::read(fd, buf, sizeof(buf))) &gt; 0) {
1564     st-&gt;print_raw(buf, bytes);
1565   }
1566 
1567   ::close(fd);
1568 
1569   return true;
1570 }
1571 
1572 void os::print_os_info_brief(outputStream* st) {
1573   os::Solaris::print_distro_info(st);
1574 
1575   os::Posix::print_uname_info(st);
1576 
1577   os::Solaris::print_libversion_info(st);
1578 }
1579 
1580 void os::print_os_info(outputStream* st) {
1581   st-&gt;print(&quot;OS:&quot;);
1582 
1583   os::Solaris::print_distro_info(st);
1584 
1585   os::Posix::print_uname_info(st);
1586 
1587   os::Posix::print_uptime_info(st);
1588 
1589   os::Solaris::print_libversion_info(st);
1590 
1591   os::Posix::print_rlimit_info(st);
1592 
1593   os::Posix::print_load_average(st);
1594 }
1595 
1596 void os::Solaris::print_distro_info(outputStream* st) {
1597   if (!_print_ascii_file(&quot;/etc/release&quot;, st)) {
1598     st-&gt;print(&quot;Solaris&quot;);
1599   }
1600   st-&gt;cr();
1601 }
1602 
1603 void os::get_summary_os_info(char* buf, size_t buflen) {
1604   strncpy(buf, &quot;Solaris&quot;, buflen);  // default to plain solaris
1605   FILE* fp = fopen(&quot;/etc/release&quot;, &quot;r&quot;);
1606   if (fp != NULL) {
1607     char tmp[256];
1608     // Only get the first line and chop out everything but the os name.
1609     if (fgets(tmp, sizeof(tmp), fp)) {
1610       char* ptr = tmp;
1611       // skip past whitespace characters
1612       while (*ptr != &#39;\0&#39; &amp;&amp; (*ptr == &#39; &#39; || *ptr == &#39;\t&#39; || *ptr == &#39;\n&#39;)) ptr++;
1613       if (*ptr != &#39;\0&#39;) {
1614         char* nl = strchr(ptr, &#39;\n&#39;);
1615         if (nl != NULL) *nl = &#39;\0&#39;;
1616         strncpy(buf, ptr, buflen);
1617       }
1618     }
1619     fclose(fp);
1620   }
1621 }
1622 
1623 void os::Solaris::print_libversion_info(outputStream* st) {
1624   st-&gt;print(&quot;  (T2 libthread)&quot;);
1625   st-&gt;cr();
1626 }
1627 
1628 static bool check_addr0(outputStream* st) {
1629   jboolean status = false;
1630   const int read_chunk = 200;
1631   int ret = 0;
1632   int nmap = 0;
1633   int fd = ::open(&quot;/proc/self/map&quot;,O_RDONLY);
1634   if (fd &gt;= 0) {
1635     prmap_t *p = NULL;
1636     char *mbuff = (char *) calloc(read_chunk, sizeof(prmap_t));
1637     if (NULL == mbuff) {
1638       ::close(fd);
1639       return status;
1640     }
1641     while ((ret = ::read(fd, mbuff, read_chunk*sizeof(prmap_t))) &gt; 0) {
1642       //check if read() has not read partial data
1643       if( 0 != ret % sizeof(prmap_t)){
1644         break;
1645       }
1646       nmap = ret / sizeof(prmap_t);
1647       p = (prmap_t *)mbuff;
1648       for(int i = 0; i &lt; nmap; i++){
1649         if (p-&gt;pr_vaddr == 0x0) {
1650           st-&gt;print(&quot;Warning: Address: &quot; PTR_FORMAT &quot;, Size: &quot; SIZE_FORMAT &quot;K, &quot;,p-&gt;pr_vaddr, p-&gt;pr_size/1024);
1651           st-&gt;print(&quot;Mapped file: %s, &quot;, p-&gt;pr_mapname[0] == &#39;\0&#39; ? &quot;None&quot; : p-&gt;pr_mapname);
1652           st-&gt;print(&quot;Access: &quot;);
1653           st-&gt;print(&quot;%s&quot;,(p-&gt;pr_mflags &amp; MA_READ)  ? &quot;r&quot; : &quot;-&quot;);
1654           st-&gt;print(&quot;%s&quot;,(p-&gt;pr_mflags &amp; MA_WRITE) ? &quot;w&quot; : &quot;-&quot;);
1655           st-&gt;print(&quot;%s&quot;,(p-&gt;pr_mflags &amp; MA_EXEC)  ? &quot;x&quot; : &quot;-&quot;);
1656           st-&gt;cr();
1657           status = true;
1658         }
1659         p++;
1660       }
1661     }
1662     free(mbuff);
1663     ::close(fd);
1664   }
1665   return status;
1666 }
1667 
1668 void os::get_summary_cpu_info(char* buf, size_t buflen) {
1669   // Get MHz with system call. We don&#39;t seem to already have this.
1670   processor_info_t stats;
1671   processorid_t id = getcpuid();
1672   int clock = 0;
1673   if (processor_info(id, &amp;stats) != -1) {
1674     clock = stats.pi_clock;  // pi_processor_type isn&#39;t more informative than below
1675   }
1676 #ifdef AMD64
1677   snprintf(buf, buflen, &quot;x86 64 bit %d MHz&quot;, clock);
1678 #else
1679   // must be sparc
1680   snprintf(buf, buflen, &quot;Sparcv9 64 bit %d MHz&quot;, clock);
1681 #endif
1682 }
1683 
1684 void os::pd_print_cpu_info(outputStream* st, char* buf, size_t buflen) {
1685   // Nothing to do for now.
1686 }
1687 
1688 void os::print_memory_info(outputStream* st) {
1689   st-&gt;print(&quot;Memory:&quot;);
1690   st-&gt;print(&quot; %dk page&quot;, os::vm_page_size()&gt;&gt;10);
1691   st-&gt;print(&quot;, physical &quot; UINT64_FORMAT &quot;k&quot;, os::physical_memory()&gt;&gt;10);
1692   st-&gt;print(&quot;(&quot; UINT64_FORMAT &quot;k free)&quot;, os::available_memory() &gt;&gt; 10);
1693   st-&gt;cr();
1694   (void) check_addr0(st);
1695 }
1696 
1697 // Moved from whole group, because we need them here for diagnostic
1698 // prints.
1699 static int Maxsignum = 0;
1700 static int *ourSigFlags = NULL;
1701 
1702 int os::Solaris::get_our_sigflags(int sig) {
1703   assert(ourSigFlags!=NULL, &quot;signal data structure not initialized&quot;);
1704   assert(sig &gt; 0 &amp;&amp; sig &lt; Maxsignum, &quot;vm signal out of expected range&quot;);
1705   return ourSigFlags[sig];
1706 }
1707 
1708 void os::Solaris::set_our_sigflags(int sig, int flags) {
1709   assert(ourSigFlags!=NULL, &quot;signal data structure not initialized&quot;);
1710   assert(sig &gt; 0 &amp;&amp; sig &lt; Maxsignum, &quot;vm signal out of expected range&quot;);
1711   ourSigFlags[sig] = flags;
1712 }
1713 
1714 
1715 static const char* get_signal_handler_name(address handler,
1716                                            char* buf, int buflen) {
1717   int offset;
1718   bool found = os::dll_address_to_library_name(handler, buf, buflen, &amp;offset);
1719   if (found) {
1720     // skip directory names
1721     const char *p1, *p2;
1722     p1 = buf;
1723     size_t len = strlen(os::file_separator());
1724     while ((p2 = strstr(p1, os::file_separator())) != NULL) p1 = p2 + len;
1725     jio_snprintf(buf, buflen, &quot;%s+0x%x&quot;, p1, offset);
1726   } else {
1727     jio_snprintf(buf, buflen, PTR_FORMAT, handler);
1728   }
1729   return buf;
1730 }
1731 
1732 static void print_signal_handler(outputStream* st, int sig,
1733                                  char* buf, size_t buflen) {
1734   struct sigaction sa;
1735 
1736   sigaction(sig, NULL, &amp;sa);
1737 
1738   st-&gt;print(&quot;%s: &quot;, os::exception_name(sig, buf, buflen));
1739 
1740   address handler = (sa.sa_flags &amp; SA_SIGINFO)
1741                   ? CAST_FROM_FN_PTR(address, sa.sa_sigaction)
1742                   : CAST_FROM_FN_PTR(address, sa.sa_handler);
1743 
1744   if (handler == CAST_FROM_FN_PTR(address, SIG_DFL)) {
1745     st-&gt;print(&quot;SIG_DFL&quot;);
1746   } else if (handler == CAST_FROM_FN_PTR(address, SIG_IGN)) {
1747     st-&gt;print(&quot;SIG_IGN&quot;);
1748   } else {
1749     st-&gt;print(&quot;[%s]&quot;, get_signal_handler_name(handler, buf, buflen));
1750   }
1751 
1752   st-&gt;print(&quot;, sa_mask[0]=&quot;);
1753   os::Posix::print_signal_set_short(st, &amp;sa.sa_mask);
1754 
1755   address rh = VMError::get_resetted_sighandler(sig);
1756   // May be, handler was resetted by VMError?
1757   if (rh != NULL) {
1758     handler = rh;
1759     sa.sa_flags = VMError::get_resetted_sigflags(sig);
1760   }
1761 
1762   st-&gt;print(&quot;, sa_flags=&quot;);
1763   os::Posix::print_sa_flags(st, sa.sa_flags);
1764 
1765   // Check: is it our handler?
1766   if (handler == CAST_FROM_FN_PTR(address, signalHandler)) {
1767     // It is our signal handler
1768     // check for flags
1769     if (sa.sa_flags != os::Solaris::get_our_sigflags(sig)) {
1770       st-&gt;print(
1771                 &quot;, flags was changed from &quot; PTR32_FORMAT &quot;, consider using jsig library&quot;,
1772                 os::Solaris::get_our_sigflags(sig));
1773     }
1774   }
1775   st-&gt;cr();
1776 }
1777 
1778 void os::print_signal_handlers(outputStream* st, char* buf, size_t buflen) {
1779   st-&gt;print_cr(&quot;Signal Handlers:&quot;);
1780   print_signal_handler(st, SIGSEGV, buf, buflen);
1781   print_signal_handler(st, SIGBUS , buf, buflen);
1782   print_signal_handler(st, SIGFPE , buf, buflen);
1783   print_signal_handler(st, SIGPIPE, buf, buflen);
1784   print_signal_handler(st, SIGXFSZ, buf, buflen);
1785   print_signal_handler(st, SIGILL , buf, buflen);
1786   print_signal_handler(st, ASYNC_SIGNAL, buf, buflen);
1787   print_signal_handler(st, BREAK_SIGNAL, buf, buflen);
1788   print_signal_handler(st, SHUTDOWN1_SIGNAL , buf, buflen);
1789   print_signal_handler(st, SHUTDOWN2_SIGNAL , buf, buflen);
1790   print_signal_handler(st, SHUTDOWN3_SIGNAL, buf, buflen);
1791 }
1792 
1793 static char saved_jvm_path[MAXPATHLEN] = { 0 };
1794 
1795 // Find the full path to the current module, libjvm.so
1796 void os::jvm_path(char *buf, jint buflen) {
1797   // Error checking.
1798   if (buflen &lt; MAXPATHLEN) {
1799     assert(false, &quot;must use a large-enough buffer&quot;);
1800     buf[0] = &#39;\0&#39;;
1801     return;
1802   }
1803   // Lazy resolve the path to current module.
1804   if (saved_jvm_path[0] != 0) {
1805     strcpy(buf, saved_jvm_path);
1806     return;
1807   }
1808 
1809   Dl_info dlinfo;
1810   int ret = dladdr(CAST_FROM_FN_PTR(void *, os::jvm_path), &amp;dlinfo);
1811   assert(ret != 0, &quot;cannot locate libjvm&quot;);
1812   if (ret != 0 &amp;&amp; dlinfo.dli_fname != NULL) {
1813     if (os::Posix::realpath((char *)dlinfo.dli_fname, buf, buflen) == NULL) {
1814       return;
1815     }
1816   } else {
1817     buf[0] = &#39;\0&#39;;
1818     return;
1819   }
1820 
1821   if (Arguments::sun_java_launcher_is_altjvm()) {
1822     // Support for the java launcher&#39;s &#39;-XXaltjvm=&lt;path&gt;&#39; option. Typical
1823     // value for buf is &quot;&lt;JAVA_HOME&gt;/jre/lib/&lt;arch&gt;/&lt;vmtype&gt;/libjvm.so&quot;.
1824     // If &quot;/jre/lib/&quot; appears at the right place in the string, then
1825     // assume we are installed in a JDK and we&#39;re done.  Otherwise, check
1826     // for a JAVA_HOME environment variable and fix up the path so it
1827     // looks like libjvm.so is installed there (append a fake suffix
1828     // hotspot/libjvm.so).
1829     const char *p = buf + strlen(buf) - 1;
1830     for (int count = 0; p &gt; buf &amp;&amp; count &lt; 5; ++count) {
1831       for (--p; p &gt; buf &amp;&amp; *p != &#39;/&#39;; --p)
1832         /* empty */ ;
1833     }
1834 
1835     if (strncmp(p, &quot;/jre/lib/&quot;, 9) != 0) {
1836       // Look for JAVA_HOME in the environment.
1837       char* java_home_var = ::getenv(&quot;JAVA_HOME&quot;);
1838       if (java_home_var != NULL &amp;&amp; java_home_var[0] != 0) {
1839         char* jrelib_p;
1840         int   len;
1841 
1842         // Check the current module name &quot;libjvm.so&quot;.
1843         p = strrchr(buf, &#39;/&#39;);
1844         assert(strstr(p, &quot;/libjvm&quot;) == p, &quot;invalid library name&quot;);
1845 
1846         if (os::Posix::realpath(java_home_var, buf, buflen) == NULL) {
1847           return;
1848         }
1849         // determine if this is a legacy image or modules image
1850         // modules image doesn&#39;t have &quot;jre&quot; subdirectory
1851         len = strlen(buf);
1852         assert(len &lt; buflen, &quot;Ran out of buffer space&quot;);
1853         jrelib_p = buf + len;
1854         snprintf(jrelib_p, buflen-len, &quot;/jre/lib&quot;);
1855         if (0 != access(buf, F_OK)) {
1856           snprintf(jrelib_p, buflen-len, &quot;/lib&quot;);
1857         }
1858 
1859         if (0 == access(buf, F_OK)) {
1860           // Use current module name &quot;libjvm.so&quot;
1861           len = strlen(buf);
1862           snprintf(buf + len, buflen-len, &quot;/hotspot/libjvm.so&quot;);
1863         } else {
1864           // Go back to path of .so
1865           if (os::Posix::realpath((char *)dlinfo.dli_fname, buf, buflen) == NULL) {
1866             return;
1867           }
1868         }
1869       }
1870     }
1871   }
1872 
1873   strncpy(saved_jvm_path, buf, MAXPATHLEN);
1874   saved_jvm_path[MAXPATHLEN - 1] = &#39;\0&#39;;
1875 }
1876 
1877 
1878 void os::print_jni_name_prefix_on(outputStream* st, int args_size) {
1879   // no prefix required, not even &quot;_&quot;
1880 }
1881 
1882 
1883 void os::print_jni_name_suffix_on(outputStream* st, int args_size) {
1884   // no suffix required
1885 }
1886 
1887 // sun.misc.Signal
1888 
1889 extern &quot;C&quot; {
1890   static void UserHandler(int sig, void *siginfo, void *context) {
1891     // Ctrl-C is pressed during error reporting, likely because the error
1892     // handler fails to abort. Let VM die immediately.
1893     if (sig == SIGINT &amp;&amp; VMError::is_error_reported()) {
1894       os::die();
1895     }
1896 
1897     os::signal_notify(sig);
1898     // We do not need to reinstate the signal handler each time...
1899   }
1900 }
1901 
1902 void* os::user_handler() {
1903   return CAST_FROM_FN_PTR(void*, UserHandler);
1904 }
1905 
1906 extern &quot;C&quot; {
1907   typedef void (*sa_handler_t)(int);
1908   typedef void (*sa_sigaction_t)(int, siginfo_t *, void *);
1909 }
1910 
1911 void* os::signal(int signal_number, void* handler) {
1912   struct sigaction sigAct, oldSigAct;
1913   sigfillset(&amp;(sigAct.sa_mask));
1914   sigAct.sa_flags = SA_RESTART &amp; ~SA_RESETHAND;
1915   sigAct.sa_flags |= SA_SIGINFO;
1916   sigAct.sa_handler = CAST_TO_FN_PTR(sa_handler_t, handler);
1917 
1918   if (sigaction(signal_number, &amp;sigAct, &amp;oldSigAct)) {
1919     // -1 means registration failed
1920     return (void *)-1;
1921   }
1922 
1923   return CAST_FROM_FN_PTR(void*, oldSigAct.sa_handler);
1924 }
1925 
1926 void os::signal_raise(int signal_number) {
1927   raise(signal_number);
1928 }
1929 
1930 // The following code is moved from os.cpp for making this
1931 // code platform specific, which it is by its very nature.
1932 
1933 // a counter for each possible signal value
1934 static int Sigexit = 0;
1935 static jint *pending_signals = NULL;
1936 static int *preinstalled_sigs = NULL;
1937 static struct sigaction *chainedsigactions = NULL;
1938 static Semaphore* sig_sem = NULL;
1939 
1940 int os::sigexitnum_pd() {
1941   assert(Sigexit &gt; 0, &quot;signal memory not yet initialized&quot;);
1942   return Sigexit;
1943 }
1944 
1945 void os::Solaris::init_signal_mem() {
1946   // Initialize signal structures
1947   Maxsignum = SIGRTMAX;
1948   Sigexit = Maxsignum+1;
1949   assert(Maxsignum &gt;0, &quot;Unable to obtain max signal number&quot;);
1950 
1951   // Initialize signal structures
1952   // pending_signals has one int per signal
1953   // The additional signal is for SIGEXIT - exit signal to signal_thread
1954   pending_signals = (jint *)os::malloc(sizeof(jint) * (Sigexit+1), mtInternal);
1955   memset(pending_signals, 0, (sizeof(jint) * (Sigexit+1)));
1956 
1957   if (UseSignalChaining) {
1958     chainedsigactions = (struct sigaction *)malloc(sizeof(struct sigaction)
1959                                                    * (Maxsignum + 1), mtInternal);
1960     memset(chainedsigactions, 0, (sizeof(struct sigaction) * (Maxsignum + 1)));
1961     preinstalled_sigs = (int *)os::malloc(sizeof(int) * (Maxsignum + 1), mtInternal);
1962     memset(preinstalled_sigs, 0, (sizeof(int) * (Maxsignum + 1)));
1963   }
1964   ourSigFlags = (int*)malloc(sizeof(int) * (Maxsignum + 1), mtInternal);
1965   memset(ourSigFlags, 0, sizeof(int) * (Maxsignum + 1));
1966 }
1967 
1968 static void jdk_misc_signal_init() {
1969   // Initialize signal semaphore
1970   sig_sem = new Semaphore();
1971 }
1972 
1973 void os::signal_notify(int sig) {
1974   if (sig_sem != NULL) {
1975     Atomic::inc(&amp;pending_signals[sig]);
1976     sig_sem-&gt;signal();
1977   } else {
1978     // Signal thread is not created with ReduceSignalUsage and jdk_misc_signal_init
1979     // initialization isn&#39;t called.
1980     assert(ReduceSignalUsage, &quot;signal semaphore should be created&quot;);
1981   }
1982 }
1983 
1984 static int check_pending_signals() {
1985   int ret;
1986   while (true) {
1987     for (int i = 0; i &lt; Sigexit + 1; i++) {
1988       jint n = pending_signals[i];
1989       if (n &gt; 0 &amp;&amp; n == Atomic::cmpxchg(&amp;pending_signals[i], n, n - 1)) {
1990         return i;
1991       }
1992     }
1993     JavaThread *thread = JavaThread::current();
1994     ThreadBlockInVM tbivm(thread);
1995 
1996     bool threadIsSuspended;
1997     do {
1998       thread-&gt;set_suspend_equivalent();
1999       sig_sem-&gt;wait();
2000 
2001       // were we externally suspended while we were waiting?
2002       threadIsSuspended = thread-&gt;handle_special_suspend_equivalent_condition();
2003       if (threadIsSuspended) {
2004         // The semaphore has been incremented, but while we were waiting
2005         // another thread suspended us. We don&#39;t want to continue running
2006         // while suspended because that would surprise the thread that
2007         // suspended us.
2008         sig_sem-&gt;signal();
2009 
2010         thread-&gt;java_suspend_self();
2011       }
2012     } while (threadIsSuspended);
2013   }
2014 }
2015 
2016 int os::signal_wait() {
2017   return check_pending_signals();
2018 }
2019 
2020 ////////////////////////////////////////////////////////////////////////////////
2021 // Virtual Memory
2022 
2023 static int page_size = -1;
2024 
2025 int os::vm_page_size() {
2026   assert(page_size != -1, &quot;must call os::init&quot;);
2027   return page_size;
2028 }
2029 
2030 // Solaris allocates memory by pages.
2031 int os::vm_allocation_granularity() {
2032   assert(page_size != -1, &quot;must call os::init&quot;);
2033   return page_size;
2034 }
2035 
2036 static bool recoverable_mmap_error(int err) {
2037   // See if the error is one we can let the caller handle. This
2038   // list of errno values comes from the Solaris mmap(2) man page.
2039   switch (err) {
2040   case EBADF:
2041   case EINVAL:
2042   case ENOTSUP:
2043     // let the caller deal with these errors
2044     return true;
2045 
2046   default:
2047     // Any remaining errors on this OS can cause our reserved mapping
2048     // to be lost. That can cause confusion where different data
2049     // structures think they have the same memory mapped. The worst
2050     // scenario is if both the VM and a library think they have the
2051     // same memory mapped.
2052     return false;
2053   }
2054 }
2055 
2056 static void warn_fail_commit_memory(char* addr, size_t bytes, bool exec,
2057                                     int err) {
2058   warning(&quot;INFO: os::commit_memory(&quot; PTR_FORMAT &quot;, &quot; SIZE_FORMAT
2059           &quot;, %d) failed; error=&#39;%s&#39; (errno=%d)&quot;, addr, bytes, exec,
2060           os::strerror(err), err);
2061 }
2062 
2063 static void warn_fail_commit_memory(char* addr, size_t bytes,
2064                                     size_t alignment_hint, bool exec,
2065                                     int err) {
2066   warning(&quot;INFO: os::commit_memory(&quot; PTR_FORMAT &quot;, &quot; SIZE_FORMAT
2067           &quot;, &quot; SIZE_FORMAT &quot;, %d) failed; error=&#39;%s&#39; (errno=%d)&quot;, addr, bytes,
2068           alignment_hint, exec, os::strerror(err), err);
2069 }
2070 
2071 int os::Solaris::commit_memory_impl(char* addr, size_t bytes, bool exec) {
2072   int prot = exec ? PROT_READ|PROT_WRITE|PROT_EXEC : PROT_READ|PROT_WRITE;
2073   size_t size = bytes;
2074   char *res = Solaris::mmap_chunk(addr, size, MAP_PRIVATE|MAP_FIXED, prot);
2075   if (res != NULL) {
2076     if (UseNUMAInterleaving) {
2077         numa_make_global(addr, bytes);
2078     }
2079     return 0;
2080   }
2081 
2082   int err = errno;  // save errno from mmap() call in mmap_chunk()
2083 
2084   if (!recoverable_mmap_error(err)) {
2085     warn_fail_commit_memory(addr, bytes, exec, err);
2086     vm_exit_out_of_memory(bytes, OOM_MMAP_ERROR, &quot;committing reserved memory.&quot;);
2087   }
2088 
2089   return err;
2090 }
2091 
2092 bool os::pd_commit_memory(char* addr, size_t bytes, bool exec) {
2093   return Solaris::commit_memory_impl(addr, bytes, exec) == 0;
2094 }
2095 
2096 void os::pd_commit_memory_or_exit(char* addr, size_t bytes, bool exec,
2097                                   const char* mesg) {
2098   assert(mesg != NULL, &quot;mesg must be specified&quot;);
2099   int err = os::Solaris::commit_memory_impl(addr, bytes, exec);
2100   if (err != 0) {
2101     // the caller wants all commit errors to exit with the specified mesg:
2102     warn_fail_commit_memory(addr, bytes, exec, err);
2103     vm_exit_out_of_memory(bytes, OOM_MMAP_ERROR, &quot;%s&quot;, mesg);
2104   }
2105 }
2106 
2107 size_t os::Solaris::page_size_for_alignment(size_t alignment) {
2108   assert(is_aligned(alignment, (size_t) vm_page_size()),
2109          SIZE_FORMAT &quot; is not aligned to &quot; SIZE_FORMAT,
2110          alignment, (size_t) vm_page_size());
2111 
2112   for (int i = 0; _page_sizes[i] != 0; i++) {
2113     if (is_aligned(alignment, _page_sizes[i])) {
2114       return _page_sizes[i];
2115     }
2116   }
2117 
2118   return (size_t) vm_page_size();
2119 }
2120 
2121 int os::Solaris::commit_memory_impl(char* addr, size_t bytes,
2122                                     size_t alignment_hint, bool exec) {
2123   int err = Solaris::commit_memory_impl(addr, bytes, exec);
2124   if (err == 0 &amp;&amp; UseLargePages &amp;&amp; alignment_hint &gt; 0) {
2125     assert(is_aligned(bytes, alignment_hint),
2126            SIZE_FORMAT &quot; is not aligned to &quot; SIZE_FORMAT, bytes, alignment_hint);
2127 
2128     // The syscall memcntl requires an exact page size (see man memcntl for details).
2129     size_t page_size = page_size_for_alignment(alignment_hint);
2130     if (page_size &gt; (size_t) vm_page_size()) {
2131       (void)Solaris::setup_large_pages(addr, bytes, page_size);
2132     }
2133   }
2134   return err;
2135 }
2136 
2137 bool os::pd_commit_memory(char* addr, size_t bytes, size_t alignment_hint,
2138                           bool exec) {
2139   return Solaris::commit_memory_impl(addr, bytes, alignment_hint, exec) == 0;
2140 }
2141 
2142 void os::pd_commit_memory_or_exit(char* addr, size_t bytes,
2143                                   size_t alignment_hint, bool exec,
2144                                   const char* mesg) {
2145   assert(mesg != NULL, &quot;mesg must be specified&quot;);
2146   int err = os::Solaris::commit_memory_impl(addr, bytes, alignment_hint, exec);
2147   if (err != 0) {
2148     // the caller wants all commit errors to exit with the specified mesg:
2149     warn_fail_commit_memory(addr, bytes, alignment_hint, exec, err);
2150     vm_exit_out_of_memory(bytes, OOM_MMAP_ERROR, &quot;%s&quot;, mesg);
2151   }
2152 }
2153 
2154 // Uncommit the pages in a specified region.
2155 void os::pd_free_memory(char* addr, size_t bytes, size_t alignment_hint) {
2156   if (madvise(addr, bytes, MADV_FREE) &lt; 0) {
2157     debug_only(warning(&quot;MADV_FREE failed.&quot;));
2158     return;
2159   }
2160 }
2161 
2162 bool os::pd_create_stack_guard_pages(char* addr, size_t size) {
2163   return os::commit_memory(addr, size, !ExecMem);
2164 }
2165 
2166 bool os::remove_stack_guard_pages(char* addr, size_t size) {
2167   return os::uncommit_memory(addr, size);
2168 }
2169 
2170 // Change the page size in a given range.
2171 void os::pd_realign_memory(char *addr, size_t bytes, size_t alignment_hint) {
2172   assert((intptr_t)addr % alignment_hint == 0, &quot;Address should be aligned.&quot;);
2173   assert((intptr_t)(addr + bytes) % alignment_hint == 0, &quot;End should be aligned.&quot;);
2174   if (UseLargePages) {
2175     size_t page_size = Solaris::page_size_for_alignment(alignment_hint);
2176     if (page_size &gt; (size_t) vm_page_size()) {
2177       Solaris::setup_large_pages(addr, bytes, page_size);
2178     }
2179   }
2180 }
2181 
2182 // Tell the OS to make the range local to the first-touching LWP
2183 void os::numa_make_local(char *addr, size_t bytes, int lgrp_hint) {
2184   assert((intptr_t)addr % os::vm_page_size() == 0, &quot;Address should be page-aligned.&quot;);
2185   if (madvise(addr, bytes, MADV_ACCESS_LWP) &lt; 0) {
2186     debug_only(warning(&quot;MADV_ACCESS_LWP failed.&quot;));
2187   }
2188 }
2189 
2190 // Tell the OS that this range would be accessed from different LWPs.
2191 void os::numa_make_global(char *addr, size_t bytes) {
2192   assert((intptr_t)addr % os::vm_page_size() == 0, &quot;Address should be page-aligned.&quot;);
2193   if (madvise(addr, bytes, MADV_ACCESS_MANY) &lt; 0) {
2194     debug_only(warning(&quot;MADV_ACCESS_MANY failed.&quot;));
2195   }
2196 }
2197 
2198 // Get the number of the locality groups.
2199 size_t os::numa_get_groups_num() {
2200   size_t n = Solaris::lgrp_nlgrps(Solaris::lgrp_cookie());
2201   return n != -1 ? n : 1;
2202 }
2203 
2204 // Get a list of leaf locality groups. A leaf lgroup is group that
2205 // doesn&#39;t have any children. Typical leaf group is a CPU or a CPU/memory
2206 // board. An LWP is assigned to one of these groups upon creation.
2207 size_t os::numa_get_leaf_groups(int *ids, size_t size) {
2208   if ((ids[0] = Solaris::lgrp_root(Solaris::lgrp_cookie())) == -1) {
2209     ids[0] = 0;
2210     return 1;
2211   }
2212   int result_size = 0, top = 1, bottom = 0, cur = 0;
2213   for (int k = 0; k &lt; size; k++) {
2214     int r = Solaris::lgrp_children(Solaris::lgrp_cookie(), ids[cur],
2215                                    (Solaris::lgrp_id_t*)&amp;ids[top], size - top);
2216     if (r == -1) {
2217       ids[0] = 0;
2218       return 1;
2219     }
2220     if (!r) {
2221       // That&#39;s a leaf node.
2222       assert(bottom &lt;= cur, &quot;Sanity check&quot;);
2223       // Check if the node has memory
2224       if (Solaris::lgrp_resources(Solaris::lgrp_cookie(), ids[cur],
2225                                   NULL, 0, LGRP_RSRC_MEM) &gt; 0) {
2226         ids[bottom++] = ids[cur];
2227       }
2228     }
2229     top += r;
2230     cur++;
2231   }
2232   if (bottom == 0) {
2233     // Handle a situation, when the OS reports no memory available.
2234     // Assume UMA architecture.
2235     ids[0] = 0;
2236     return 1;
2237   }
2238   return bottom;
2239 }
2240 
2241 // Detect the topology change. Typically happens during CPU plugging-unplugging.
2242 bool os::numa_topology_changed() {
2243   int is_stale = Solaris::lgrp_cookie_stale(Solaris::lgrp_cookie());
2244   if (is_stale != -1 &amp;&amp; is_stale) {
2245     Solaris::lgrp_fini(Solaris::lgrp_cookie());
2246     Solaris::lgrp_cookie_t c = Solaris::lgrp_init(Solaris::LGRP_VIEW_CALLER);
2247     assert(c != 0, &quot;Failure to initialize LGRP API&quot;);
2248     Solaris::set_lgrp_cookie(c);
2249     return true;
2250   }
2251   return false;
2252 }
2253 
2254 // Get the group id of the current LWP.
2255 int os::numa_get_group_id() {
2256   int lgrp_id = Solaris::lgrp_home(P_LWPID, P_MYID);
2257   if (lgrp_id == -1) {
2258     return 0;
2259   }
2260   const int size = os::numa_get_groups_num();
2261   int *ids = (int*)alloca(size * sizeof(int));
2262 
2263   // Get the ids of all lgroups with memory; r is the count.
2264   int r = Solaris::lgrp_resources(Solaris::lgrp_cookie(), lgrp_id,
2265                                   (Solaris::lgrp_id_t*)ids, size, LGRP_RSRC_MEM);
2266   if (r &lt;= 0) {
2267     return 0;
2268   }
2269   return ids[os::random() % r];
2270 }
2271 
2272 int os::numa_get_group_id_for_address(const void* address) {
2273   return 0;
2274 }
2275 
2276 // Request information about the page.
2277 bool os::get_page_info(char *start, page_info* info) {
2278   const uint_t info_types[] = { MEMINFO_VLGRP, MEMINFO_VPAGESIZE };
2279   uint64_t addr = (uintptr_t)start;
2280   uint64_t outdata[2];
2281   uint_t validity = 0;
2282 
2283   if (meminfo(&amp;addr, 1, info_types, 2, outdata, &amp;validity) &lt; 0) {
2284     return false;
2285   }
2286 
2287   info-&gt;size = 0;
2288   info-&gt;lgrp_id = -1;
2289 
2290   if ((validity &amp; 1) != 0) {
2291     if ((validity &amp; 2) != 0) {
2292       info-&gt;lgrp_id = outdata[0];
2293     }
2294     if ((validity &amp; 4) != 0) {
2295       info-&gt;size = outdata[1];
2296     }
2297     return true;
2298   }
2299   return false;
2300 }
2301 
2302 // Scan the pages from start to end until a page different than
2303 // the one described in the info parameter is encountered.
2304 char *os::scan_pages(char *start, char* end, page_info* page_expected,
2305                      page_info* page_found) {
2306   const uint_t info_types[] = { MEMINFO_VLGRP, MEMINFO_VPAGESIZE };
2307   const size_t types = sizeof(info_types) / sizeof(info_types[0]);
2308   uint64_t addrs[MAX_MEMINFO_CNT], outdata[types * MAX_MEMINFO_CNT + 1];
2309   uint_t validity[MAX_MEMINFO_CNT];
2310 
2311   size_t page_size = MAX2((size_t)os::vm_page_size(), page_expected-&gt;size);
2312   uint64_t p = (uint64_t)start;
2313   while (p &lt; (uint64_t)end) {
2314     addrs[0] = p;
2315     size_t addrs_count = 1;
2316     while (addrs_count &lt; MAX_MEMINFO_CNT &amp;&amp; addrs[addrs_count - 1] + page_size &lt; (uint64_t)end) {
2317       addrs[addrs_count] = addrs[addrs_count - 1] + page_size;
2318       addrs_count++;
2319     }
2320 
2321     if (meminfo(addrs, addrs_count, info_types, types, outdata, validity) &lt; 0) {
2322       return NULL;
2323     }
2324 
2325     size_t i = 0;
2326     for (; i &lt; addrs_count; i++) {
2327       if ((validity[i] &amp; 1) != 0) {
2328         if ((validity[i] &amp; 4) != 0) {
2329           if (outdata[types * i + 1] != page_expected-&gt;size) {
2330             break;
2331           }
2332         } else if (page_expected-&gt;size != 0) {
2333           break;
2334         }
2335 
2336         if ((validity[i] &amp; 2) != 0 &amp;&amp; page_expected-&gt;lgrp_id &gt; 0) {
2337           if (outdata[types * i] != page_expected-&gt;lgrp_id) {
2338             break;
2339           }
2340         }
2341       } else {
2342         return NULL;
2343       }
2344     }
2345 
2346     if (i &lt; addrs_count) {
2347       if ((validity[i] &amp; 2) != 0) {
2348         page_found-&gt;lgrp_id = outdata[types * i];
2349       } else {
2350         page_found-&gt;lgrp_id = -1;
2351       }
2352       if ((validity[i] &amp; 4) != 0) {
2353         page_found-&gt;size = outdata[types * i + 1];
2354       } else {
2355         page_found-&gt;size = 0;
2356       }
2357       return (char*)addrs[i];
2358     }
2359 
2360     p = addrs[addrs_count - 1] + page_size;
2361   }
2362   return end;
2363 }
2364 
2365 bool os::pd_uncommit_memory(char* addr, size_t bytes) {
2366   size_t size = bytes;
2367   // Map uncommitted pages PROT_NONE so we fail early if we touch an
2368   // uncommitted page. Otherwise, the read/write might succeed if we
2369   // have enough swap space to back the physical page.
2370   return
2371     NULL != Solaris::mmap_chunk(addr, size,
2372                                 MAP_PRIVATE|MAP_FIXED|MAP_NORESERVE,
2373                                 PROT_NONE);
2374 }
2375 
2376 char* os::Solaris::mmap_chunk(char *addr, size_t size, int flags, int prot) {
2377   char *b = (char *)mmap(addr, size, prot, flags, os::Solaris::_dev_zero_fd, 0);
2378 
2379   if (b == MAP_FAILED) {
2380     return NULL;
2381   }
2382   return b;
2383 }
2384 
2385 char* os::Solaris::anon_mmap(char* requested_addr, size_t bytes,
2386                              size_t alignment_hint, bool fixed) {
2387   char* addr = requested_addr;
2388   int flags = MAP_PRIVATE | MAP_NORESERVE;
2389 
2390   assert(!(fixed &amp;&amp; (alignment_hint &gt; 0)),
2391          &quot;alignment hint meaningless with fixed mmap&quot;);
2392 
2393   if (fixed) {
2394     flags |= MAP_FIXED;
2395   } else if (alignment_hint &gt; (size_t) vm_page_size()) {
2396     flags |= MAP_ALIGN;
2397     addr = (char*) alignment_hint;
2398   }
2399 
2400   // Map uncommitted pages PROT_NONE so we fail early if we touch an
2401   // uncommitted page. Otherwise, the read/write might succeed if we
2402   // have enough swap space to back the physical page.
2403   return mmap_chunk(addr, bytes, flags, PROT_NONE);
2404 }
2405 
2406 char* os::pd_reserve_memory(size_t bytes, char* requested_addr,
2407                             size_t alignment_hint) {
2408   char* addr = Solaris::anon_mmap(requested_addr, bytes, alignment_hint,
2409                                   (requested_addr != NULL));
2410 
2411   guarantee(requested_addr == NULL || requested_addr == addr,
2412             &quot;OS failed to return requested mmap address.&quot;);
2413   return addr;
2414 }
2415 
2416 char* os::pd_attempt_reserve_memory_at(size_t bytes, char* requested_addr, int file_desc) {
2417   assert(file_desc &gt;= 0, &quot;file_desc is not valid&quot;);
2418   char* result = pd_attempt_reserve_memory_at(bytes, requested_addr);
2419   if (result != NULL) {
2420     if (replace_existing_mapping_with_file_mapping(result, bytes, file_desc) == NULL) {
2421       vm_exit_during_initialization(err_msg(&quot;Error in mapping Java heap at the given filesystem directory&quot;));
2422     }
2423   }
2424   return result;
2425 }
2426 
2427 // Reserve memory at an arbitrary address, only if that area is
2428 // available (and not reserved for something else).
2429 
2430 char* os::pd_attempt_reserve_memory_at(size_t bytes, char* requested_addr) {
2431   // Assert only that the size is a multiple of the page size, since
2432   // that&#39;s all that mmap requires, and since that&#39;s all we really know
2433   // about at this low abstraction level.  If we need higher alignment,
2434   // we can either pass an alignment to this method or verify alignment
2435   // in one of the methods further up the call chain.  See bug 5044738.
2436   assert(bytes % os::vm_page_size() == 0, &quot;reserving unexpected size block&quot;);
2437 
2438   // Since snv_84, Solaris attempts to honor the address hint - see 5003415.
2439   char* addr = Solaris::anon_mmap(requested_addr, bytes, 0, false);
2440 
2441   volatile int err = errno;
2442   if (addr == requested_addr) {
2443     return addr;
2444   }
2445 
2446   if (addr != NULL) {
2447     pd_unmap_memory(addr, bytes);
2448   }
2449 
2450   return NULL;
2451 }
2452 
2453 bool os::pd_release_memory(char* addr, size_t bytes) {
2454   size_t size = bytes;
2455   return munmap(addr, size) == 0;
2456 }
2457 
2458 static bool solaris_mprotect(char* addr, size_t bytes, int prot) {
2459   assert(addr == (char*)align_down((uintptr_t)addr, os::vm_page_size()),
2460          &quot;addr must be page aligned&quot;);
2461   Events::log(NULL, &quot;Protecting memory [&quot; INTPTR_FORMAT &quot;,&quot; INTPTR_FORMAT &quot;] with protection modes %x&quot;, p2i(addr), p2i(addr+bytes), prot);
2462   int retVal = mprotect(addr, bytes, prot);
2463   return retVal == 0;
2464 }
2465 
2466 // Protect memory (Used to pass readonly pages through
2467 // JNI GetArray&lt;type&gt;Elements with empty arrays.)
2468 // Also, used for serialization page and for compressed oops null pointer
2469 // checking.
2470 bool os::protect_memory(char* addr, size_t bytes, ProtType prot,
2471                         bool is_committed) {
2472   unsigned int p = 0;
2473   switch (prot) {
2474   case MEM_PROT_NONE: p = PROT_NONE; break;
2475   case MEM_PROT_READ: p = PROT_READ; break;
2476   case MEM_PROT_RW:   p = PROT_READ|PROT_WRITE; break;
2477   case MEM_PROT_RWX:  p = PROT_READ|PROT_WRITE|PROT_EXEC; break;
2478   default:
2479     ShouldNotReachHere();
2480   }
2481   // is_committed is unused.
2482   return solaris_mprotect(addr, bytes, p);
2483 }
2484 
2485 // guard_memory and unguard_memory only happens within stack guard pages.
2486 // Since ISM pertains only to the heap, guard and unguard memory should not
2487 /// happen with an ISM region.
2488 bool os::guard_memory(char* addr, size_t bytes) {
2489   return solaris_mprotect(addr, bytes, PROT_NONE);
2490 }
2491 
2492 bool os::unguard_memory(char* addr, size_t bytes) {
2493   return solaris_mprotect(addr, bytes, PROT_READ|PROT_WRITE);
2494 }
2495 
2496 // Large page support
2497 static size_t _large_page_size = 0;
2498 
2499 // Insertion sort for small arrays (descending order).
2500 static void insertion_sort_descending(size_t* array, int len) {
2501   for (int i = 0; i &lt; len; i++) {
2502     size_t val = array[i];
2503     for (size_t key = i; key &gt; 0 &amp;&amp; array[key - 1] &lt; val; --key) {
2504       size_t tmp = array[key];
2505       array[key] = array[key - 1];
2506       array[key - 1] = tmp;
2507     }
2508   }
2509 }
2510 
2511 bool os::Solaris::mpss_sanity_check(bool warn, size_t* page_size) {
2512   const unsigned int usable_count = VM_Version::page_size_count();
2513   if (usable_count == 1) {
2514     return false;
2515   }
2516 
2517   // Find the right getpagesizes interface.  When solaris 11 is the minimum
2518   // build platform, getpagesizes() (without the &#39;2&#39;) can be called directly.
2519   typedef int (*gps_t)(size_t[], int);
2520   gps_t gps_func = CAST_TO_FN_PTR(gps_t, dlsym(RTLD_DEFAULT, &quot;getpagesizes2&quot;));
2521   if (gps_func == NULL) {
2522     gps_func = CAST_TO_FN_PTR(gps_t, dlsym(RTLD_DEFAULT, &quot;getpagesizes&quot;));
2523     if (gps_func == NULL) {
2524       if (warn) {
2525         warning(&quot;MPSS is not supported by the operating system.&quot;);
2526       }
2527       return false;
2528     }
2529   }
2530 
2531   // Fill the array of page sizes.
2532   int n = (*gps_func)(_page_sizes, page_sizes_max);
2533   assert(n &gt; 0, &quot;Solaris bug?&quot;);
2534 
2535   if (n == page_sizes_max) {
2536     // Add a sentinel value (necessary only if the array was completely filled
2537     // since it is static (zeroed at initialization)).
2538     _page_sizes[--n] = 0;
2539     DEBUG_ONLY(warning(&quot;increase the size of the os::_page_sizes array.&quot;);)
2540   }
2541   assert(_page_sizes[n] == 0, &quot;missing sentinel&quot;);
2542   trace_page_sizes(&quot;available page sizes&quot;, _page_sizes, n);
2543 
2544   if (n == 1) return false;     // Only one page size available.
2545 
2546   // Skip sizes larger than 4M (or LargePageSizeInBytes if it was set) and
2547   // select up to usable_count elements.  First sort the array, find the first
2548   // acceptable value, then copy the usable sizes to the top of the array and
2549   // trim the rest.  Make sure to include the default page size :-).
2550   //
2551   // A better policy could get rid of the 4M limit by taking the sizes of the
2552   // important VM memory regions (java heap and possibly the code cache) into
2553   // account.
2554   insertion_sort_descending(_page_sizes, n);
2555   const size_t size_limit =
2556     FLAG_IS_DEFAULT(LargePageSizeInBytes) ? 4 * M : LargePageSizeInBytes;
2557   int beg;
2558   for (beg = 0; beg &lt; n &amp;&amp; _page_sizes[beg] &gt; size_limit; ++beg) /* empty */;
2559   const int end = MIN2((int)usable_count, n) - 1;
2560   for (int cur = 0; cur &lt; end; ++cur, ++beg) {
2561     _page_sizes[cur] = _page_sizes[beg];
2562   }
2563   _page_sizes[end] = vm_page_size();
2564   _page_sizes[end + 1] = 0;
2565 
2566   if (_page_sizes[end] &gt; _page_sizes[end - 1]) {
2567     // Default page size is not the smallest; sort again.
2568     insertion_sort_descending(_page_sizes, end + 1);
2569   }
2570   *page_size = _page_sizes[0];
2571 
2572   trace_page_sizes(&quot;usable page sizes&quot;, _page_sizes, end + 1);
2573   return true;
2574 }
2575 
2576 void os::large_page_init() {
2577   if (UseLargePages) {
2578     // print a warning if any large page related flag is specified on command line
2579     bool warn_on_failure = !FLAG_IS_DEFAULT(UseLargePages)        ||
2580                            !FLAG_IS_DEFAULT(LargePageSizeInBytes);
2581 
2582     UseLargePages = Solaris::mpss_sanity_check(warn_on_failure, &amp;_large_page_size);
2583   }
2584 }
2585 
2586 bool os::Solaris::is_valid_page_size(size_t bytes) {
2587   for (int i = 0; _page_sizes[i] != 0; i++) {
2588     if (_page_sizes[i] == bytes) {
2589       return true;
2590     }
2591   }
2592   return false;
2593 }
2594 
2595 bool os::Solaris::setup_large_pages(caddr_t start, size_t bytes, size_t align) {
2596   assert(is_valid_page_size(align), SIZE_FORMAT &quot; is not a valid page size&quot;, align);
2597   assert(is_aligned((void*) start, align),
2598          PTR_FORMAT &quot; is not aligned to &quot; SIZE_FORMAT, p2i((void*) start), align);
2599   assert(is_aligned(bytes, align),
2600          SIZE_FORMAT &quot; is not aligned to &quot; SIZE_FORMAT, bytes, align);
2601 
2602   // Signal to OS that we want large pages for addresses
2603   // from addr, addr + bytes
2604   struct memcntl_mha mpss_struct;
2605   mpss_struct.mha_cmd = MHA_MAPSIZE_VA;
2606   mpss_struct.mha_pagesize = align;
2607   mpss_struct.mha_flags = 0;
2608   // Upon successful completion, memcntl() returns 0
2609   if (memcntl(start, bytes, MC_HAT_ADVISE, (caddr_t) &amp;mpss_struct, 0, 0)) {
2610     debug_only(warning(&quot;Attempt to use MPSS failed.&quot;));
2611     return false;
2612   }
2613   return true;
2614 }
2615 
2616 char* os::reserve_memory_special(size_t size, size_t alignment, char* addr, bool exec) {
2617   fatal(&quot;os::reserve_memory_special should not be called on Solaris.&quot;);
2618   return NULL;
2619 }
2620 
2621 bool os::release_memory_special(char* base, size_t bytes) {
2622   fatal(&quot;os::release_memory_special should not be called on Solaris.&quot;);
2623   return false;
2624 }
2625 
2626 size_t os::large_page_size() {
2627   return _large_page_size;
2628 }
2629 
2630 // MPSS allows application to commit large page memory on demand; with ISM
2631 // the entire memory region must be allocated as shared memory.
2632 bool os::can_commit_large_page_memory() {
2633   return true;
2634 }
2635 
2636 bool os::can_execute_large_page_memory() {
2637   return true;
2638 }
2639 
2640 // Sleep forever; naked call to OS-specific sleep; use with CAUTION
2641 void os::infinite_sleep() {
2642   while (true) {    // sleep forever ...
2643     ::sleep(100);   // ... 100 seconds at a time
2644   }
2645 }
2646 
2647 // Used to convert frequent JVM_Yield() to nops
2648 bool os::dont_yield() {
2649   if (DontYieldALot) {
2650     static hrtime_t last_time = 0;
2651     hrtime_t diff = getTimeNanos() - last_time;
2652 
2653     if (diff &lt; DontYieldALotInterval * 1000000) {
2654       return true;
2655     }
2656 
2657     last_time += diff;
2658 
2659     return false;
2660   } else {
2661     return false;
2662   }
2663 }
2664 
2665 // Note that yield semantics are defined by the scheduling class to which
2666 // the thread currently belongs.  Typically, yield will _not yield to
2667 // other equal or higher priority threads that reside on the dispatch queues
2668 // of other CPUs.
2669 
2670 void os::naked_yield() {
2671   thr_yield();
2672 }
2673 
2674 // Interface for setting lwp priorities.  We are using T2 libthread,
2675 // which forces the use of bound threads, so all of our threads will
2676 // be assigned to real lwp&#39;s.  Using the thr_setprio function is
2677 // meaningless in this mode so we must adjust the real lwp&#39;s priority.
2678 // The routines below implement the getting and setting of lwp priorities.
2679 //
2680 // Note: There are three priority scales used on Solaris.  Java priotities
2681 //       which range from 1 to 10, libthread &quot;thr_setprio&quot; scale which range
2682 //       from 0 to 127, and the current scheduling class of the process we
2683 //       are running in.  This is typically from -60 to +60.
2684 //       The setting of the lwp priorities in done after a call to thr_setprio
2685 //       so Java priorities are mapped to libthread priorities and we map from
2686 //       the latter to lwp priorities.  We don&#39;t keep priorities stored in
2687 //       Java priorities since some of our worker threads want to set priorities
2688 //       higher than all Java threads.
2689 //
2690 // For related information:
2691 // (1)  man -s 2 priocntl
2692 // (2)  man -s 4 priocntl
2693 // (3)  man dispadmin
2694 // =    librt.so
2695 // =    libthread/common/rtsched.c - thrp_setlwpprio().
2696 // =    ps -cL &lt;pid&gt; ... to validate priority.
2697 // =    sched_get_priority_min and _max
2698 //              pthread_create
2699 //              sched_setparam
2700 //              pthread_setschedparam
2701 //
2702 // Assumptions:
2703 // +    We assume that all threads in the process belong to the same
2704 //              scheduling class.   IE. an homogenous process.
2705 // +    Must be root or in IA group to change change &quot;interactive&quot; attribute.
2706 //              Priocntl() will fail silently.  The only indication of failure is when
2707 //              we read-back the value and notice that it hasn&#39;t changed.
2708 // +    Interactive threads enter the runq at the head, non-interactive at the tail.
2709 // +    For RT, change timeslice as well.  Invariant:
2710 //              constant &quot;priority integral&quot;
2711 //              Konst == TimeSlice * (60-Priority)
2712 //              Given a priority, compute appropriate timeslice.
2713 // +    Higher numerical values have higher priority.
2714 
2715 // sched class attributes
2716 typedef struct {
2717   int   schedPolicy;              // classID
2718   int   maxPrio;
2719   int   minPrio;
2720 } SchedInfo;
2721 
2722 
2723 static SchedInfo tsLimits, iaLimits, rtLimits, fxLimits;
2724 
2725 #ifdef ASSERT
2726 static int  ReadBackValidate = 1;
2727 #endif
2728 static int  myClass     = 0;
2729 static int  myMin       = 0;
2730 static int  myMax       = 0;
2731 static int  myCur       = 0;
2732 static bool priocntl_enable = false;
2733 
2734 static const int criticalPrio = FXCriticalPriority;
2735 static int java_MaxPriority_to_os_priority = 0; // Saved mapping
2736 
2737 
2738 // lwp_priocntl_init
2739 //
2740 // Try to determine the priority scale for our process.
2741 //
2742 // Return errno or 0 if OK.
2743 //
2744 static int lwp_priocntl_init() {
2745   int rslt;
2746   pcinfo_t ClassInfo;
2747   pcparms_t ParmInfo;
2748   int i;
2749 
2750   if (!UseThreadPriorities) return 0;
2751 
2752   // If ThreadPriorityPolicy is 1, switch tables
2753   if (ThreadPriorityPolicy == 1) {
2754     for (i = 0; i &lt; CriticalPriority+1; i++)
2755       os::java_to_os_priority[i] = prio_policy1[i];
2756   }
2757   if (UseCriticalJavaThreadPriority) {
2758     // MaxPriority always maps to the FX scheduling class and criticalPrio.
2759     // See set_native_priority() and set_lwp_class_and_priority().
2760     // Save original MaxPriority mapping in case attempt to
2761     // use critical priority fails.
2762     java_MaxPriority_to_os_priority = os::java_to_os_priority[MaxPriority];
2763     // Set negative to distinguish from other priorities
2764     os::java_to_os_priority[MaxPriority] = -criticalPrio;
2765   }
2766 
2767   // Get IDs for a set of well-known scheduling classes.
2768   // TODO-FIXME: GETCLINFO returns the current # of classes in the
2769   // the system.  We should have a loop that iterates over the
2770   // classID values, which are known to be &quot;small&quot; integers.
2771 
2772   strcpy(ClassInfo.pc_clname, &quot;TS&quot;);
2773   ClassInfo.pc_cid = -1;
2774   rslt = priocntl(P_ALL, 0, PC_GETCID, (caddr_t)&amp;ClassInfo);
2775   if (rslt &lt; 0) return errno;
2776   assert(ClassInfo.pc_cid != -1, &quot;cid for TS class is -1&quot;);
2777   tsLimits.schedPolicy = ClassInfo.pc_cid;
2778   tsLimits.maxPrio = ((tsinfo_t*)ClassInfo.pc_clinfo)-&gt;ts_maxupri;
2779   tsLimits.minPrio = -tsLimits.maxPrio;
2780 
2781   strcpy(ClassInfo.pc_clname, &quot;IA&quot;);
2782   ClassInfo.pc_cid = -1;
2783   rslt = priocntl(P_ALL, 0, PC_GETCID, (caddr_t)&amp;ClassInfo);
2784   if (rslt &lt; 0) return errno;
2785   assert(ClassInfo.pc_cid != -1, &quot;cid for IA class is -1&quot;);
2786   iaLimits.schedPolicy = ClassInfo.pc_cid;
2787   iaLimits.maxPrio = ((iainfo_t*)ClassInfo.pc_clinfo)-&gt;ia_maxupri;
2788   iaLimits.minPrio = -iaLimits.maxPrio;
2789 
2790   strcpy(ClassInfo.pc_clname, &quot;RT&quot;);
2791   ClassInfo.pc_cid = -1;
2792   rslt = priocntl(P_ALL, 0, PC_GETCID, (caddr_t)&amp;ClassInfo);
2793   if (rslt &lt; 0) return errno;
2794   assert(ClassInfo.pc_cid != -1, &quot;cid for RT class is -1&quot;);
2795   rtLimits.schedPolicy = ClassInfo.pc_cid;
2796   rtLimits.maxPrio = ((rtinfo_t*)ClassInfo.pc_clinfo)-&gt;rt_maxpri;
2797   rtLimits.minPrio = 0;
2798 
2799   strcpy(ClassInfo.pc_clname, &quot;FX&quot;);
2800   ClassInfo.pc_cid = -1;
2801   rslt = priocntl(P_ALL, 0, PC_GETCID, (caddr_t)&amp;ClassInfo);
2802   if (rslt &lt; 0) return errno;
2803   assert(ClassInfo.pc_cid != -1, &quot;cid for FX class is -1&quot;);
2804   fxLimits.schedPolicy = ClassInfo.pc_cid;
2805   fxLimits.maxPrio = ((fxinfo_t*)ClassInfo.pc_clinfo)-&gt;fx_maxupri;
2806   fxLimits.minPrio = 0;
2807 
2808   // Query our &quot;current&quot; scheduling class.
2809   // This will normally be IA, TS or, rarely, FX or RT.
2810   memset(&amp;ParmInfo, 0, sizeof(ParmInfo));
2811   ParmInfo.pc_cid = PC_CLNULL;
2812   rslt = priocntl(P_PID, P_MYID, PC_GETPARMS, (caddr_t)&amp;ParmInfo);
2813   if (rslt &lt; 0) return errno;
2814   myClass = ParmInfo.pc_cid;
2815 
2816   // We now know our scheduling classId, get specific information
2817   // about the class.
2818   ClassInfo.pc_cid = myClass;
2819   ClassInfo.pc_clname[0] = 0;
2820   rslt = priocntl((idtype)0, 0, PC_GETCLINFO, (caddr_t)&amp;ClassInfo);
2821   if (rslt &lt; 0) return errno;
2822 
2823   if (ThreadPriorityVerbose) {
2824     tty-&gt;print_cr(&quot;lwp_priocntl_init: Class=%d(%s)...&quot;, myClass, ClassInfo.pc_clname);
2825   }
2826 
2827   memset(&amp;ParmInfo, 0, sizeof(pcparms_t));
2828   ParmInfo.pc_cid = PC_CLNULL;
2829   rslt = priocntl(P_PID, P_MYID, PC_GETPARMS, (caddr_t)&amp;ParmInfo);
2830   if (rslt &lt; 0) return errno;
2831 
2832   if (ParmInfo.pc_cid == rtLimits.schedPolicy) {
2833     myMin = rtLimits.minPrio;
2834     myMax = rtLimits.maxPrio;
2835   } else if (ParmInfo.pc_cid == iaLimits.schedPolicy) {
2836     iaparms_t *iaInfo  = (iaparms_t*)ParmInfo.pc_clparms;
2837     myMin = iaLimits.minPrio;
2838     myMax = iaLimits.maxPrio;
2839     myMax = MIN2(myMax, (int)iaInfo-&gt;ia_uprilim);       // clamp - restrict
2840   } else if (ParmInfo.pc_cid == tsLimits.schedPolicy) {
2841     tsparms_t *tsInfo  = (tsparms_t*)ParmInfo.pc_clparms;
2842     myMin = tsLimits.minPrio;
2843     myMax = tsLimits.maxPrio;
2844     myMax = MIN2(myMax, (int)tsInfo-&gt;ts_uprilim);       // clamp - restrict
2845   } else if (ParmInfo.pc_cid == fxLimits.schedPolicy) {
2846     fxparms_t *fxInfo = (fxparms_t*)ParmInfo.pc_clparms;
2847     myMin = fxLimits.minPrio;
2848     myMax = fxLimits.maxPrio;
2849     myMax = MIN2(myMax, (int)fxInfo-&gt;fx_uprilim);       // clamp - restrict
2850   } else {
2851     // No clue - punt
2852     if (ThreadPriorityVerbose) {
2853       tty-&gt;print_cr(&quot;Unknown scheduling class: %s ... \n&quot;,
2854                     ClassInfo.pc_clname);
2855     }
2856     return EINVAL;      // no clue, punt
2857   }
2858 
2859   if (ThreadPriorityVerbose) {
2860     tty-&gt;print_cr(&quot;Thread priority Range: [%d..%d]\n&quot;, myMin, myMax);
2861   }
2862 
2863   priocntl_enable = true;  // Enable changing priorities
2864   return 0;
2865 }
2866 
2867 #define IAPRI(x)        ((iaparms_t *)((x).pc_clparms))
2868 #define RTPRI(x)        ((rtparms_t *)((x).pc_clparms))
2869 #define TSPRI(x)        ((tsparms_t *)((x).pc_clparms))
2870 #define FXPRI(x)        ((fxparms_t *)((x).pc_clparms))
2871 
2872 
2873 // scale_to_lwp_priority
2874 //
2875 // Convert from the libthread &quot;thr_setprio&quot; scale to our current
2876 // lwp scheduling class scale.
2877 //
2878 static int scale_to_lwp_priority(int rMin, int rMax, int x) {
2879   int v;
2880 
2881   if (x == 127) return rMax;            // avoid round-down
2882   v = (((x*(rMax-rMin)))/128)+rMin;
2883   return v;
2884 }
2885 
2886 
2887 // set_lwp_class_and_priority
2888 int set_lwp_class_and_priority(int ThreadID, int lwpid,
2889                                int newPrio, int new_class, bool scale) {
2890   int rslt;
2891   int Actual, Expected, prv;
2892   pcparms_t ParmInfo;                   // for GET-SET
2893 #ifdef ASSERT
2894   pcparms_t ReadBack;                   // for readback
2895 #endif
2896 
2897   // Set priority via PC_GETPARMS, update, PC_SETPARMS
2898   // Query current values.
2899   // TODO: accelerate this by eliminating the PC_GETPARMS call.
2900   // Cache &quot;pcparms_t&quot; in global ParmCache.
2901   // TODO: elide set-to-same-value
2902 
2903   // If something went wrong on init, don&#39;t change priorities.
2904   if (!priocntl_enable) {
2905     if (ThreadPriorityVerbose) {
2906       tty-&gt;print_cr(&quot;Trying to set priority but init failed, ignoring&quot;);
2907     }
2908     return EINVAL;
2909   }
2910 
2911   // If lwp hasn&#39;t started yet, just return
2912   // the _start routine will call us again.
2913   if (lwpid &lt;= 0) {
2914     if (ThreadPriorityVerbose) {
2915       tty-&gt;print_cr(&quot;deferring the set_lwp_class_and_priority of thread &quot;
2916                     INTPTR_FORMAT &quot; to %d, lwpid not set&quot;,
2917                     ThreadID, newPrio);
2918     }
2919     return 0;
2920   }
2921 
2922   if (ThreadPriorityVerbose) {
2923     tty-&gt;print_cr (&quot;set_lwp_class_and_priority(&quot;
2924                    INTPTR_FORMAT &quot;@&quot; INTPTR_FORMAT &quot; %d) &quot;,
2925                    ThreadID, lwpid, newPrio);
2926   }
2927 
2928   memset(&amp;ParmInfo, 0, sizeof(pcparms_t));
2929   ParmInfo.pc_cid = PC_CLNULL;
2930   rslt = priocntl(P_LWPID, lwpid, PC_GETPARMS, (caddr_t)&amp;ParmInfo);
2931   if (rslt &lt; 0) return errno;
2932 
2933   int cur_class = ParmInfo.pc_cid;
2934   ParmInfo.pc_cid = (id_t)new_class;
2935 
2936   if (new_class == rtLimits.schedPolicy) {
2937     rtparms_t *rtInfo  = (rtparms_t*)ParmInfo.pc_clparms;
2938     rtInfo-&gt;rt_pri     = scale ? scale_to_lwp_priority(rtLimits.minPrio,
2939                                                        rtLimits.maxPrio, newPrio)
2940                                : newPrio;
2941     rtInfo-&gt;rt_tqsecs  = RT_NOCHANGE;
2942     rtInfo-&gt;rt_tqnsecs = RT_NOCHANGE;
2943     if (ThreadPriorityVerbose) {
2944       tty-&gt;print_cr(&quot;RT: %d-&gt;%d\n&quot;, newPrio, rtInfo-&gt;rt_pri);
2945     }
2946   } else if (new_class == iaLimits.schedPolicy) {
2947     iaparms_t* iaInfo  = (iaparms_t*)ParmInfo.pc_clparms;
2948     int maxClamped     = MIN2(iaLimits.maxPrio,
2949                               cur_class == new_class
2950                               ? (int)iaInfo-&gt;ia_uprilim : iaLimits.maxPrio);
2951     iaInfo-&gt;ia_upri    = scale ? scale_to_lwp_priority(iaLimits.minPrio,
2952                                                        maxClamped, newPrio)
2953                                : newPrio;
2954     iaInfo-&gt;ia_uprilim = cur_class == new_class
2955                            ? IA_NOCHANGE : (pri_t)iaLimits.maxPrio;
2956     iaInfo-&gt;ia_mode    = IA_NOCHANGE;
2957     if (ThreadPriorityVerbose) {
2958       tty-&gt;print_cr(&quot;IA: [%d...%d] %d-&gt;%d\n&quot;,
2959                     iaLimits.minPrio, maxClamped, newPrio, iaInfo-&gt;ia_upri);
2960     }
2961   } else if (new_class == tsLimits.schedPolicy) {
2962     tsparms_t* tsInfo  = (tsparms_t*)ParmInfo.pc_clparms;
2963     int maxClamped     = MIN2(tsLimits.maxPrio,
2964                               cur_class == new_class
2965                               ? (int)tsInfo-&gt;ts_uprilim : tsLimits.maxPrio);
2966     tsInfo-&gt;ts_upri    = scale ? scale_to_lwp_priority(tsLimits.minPrio,
2967                                                        maxClamped, newPrio)
2968                                : newPrio;
2969     tsInfo-&gt;ts_uprilim = cur_class == new_class
2970                            ? TS_NOCHANGE : (pri_t)tsLimits.maxPrio;
2971     if (ThreadPriorityVerbose) {
2972       tty-&gt;print_cr(&quot;TS: [%d...%d] %d-&gt;%d\n&quot;,
2973                     tsLimits.minPrio, maxClamped, newPrio, tsInfo-&gt;ts_upri);
2974     }
2975   } else if (new_class == fxLimits.schedPolicy) {
2976     fxparms_t* fxInfo  = (fxparms_t*)ParmInfo.pc_clparms;
2977     int maxClamped     = MIN2(fxLimits.maxPrio,
2978                               cur_class == new_class
2979                               ? (int)fxInfo-&gt;fx_uprilim : fxLimits.maxPrio);
2980     fxInfo-&gt;fx_upri    = scale ? scale_to_lwp_priority(fxLimits.minPrio,
2981                                                        maxClamped, newPrio)
2982                                : newPrio;
2983     fxInfo-&gt;fx_uprilim = cur_class == new_class
2984                            ? FX_NOCHANGE : (pri_t)fxLimits.maxPrio;
2985     fxInfo-&gt;fx_tqsecs  = FX_NOCHANGE;
2986     fxInfo-&gt;fx_tqnsecs = FX_NOCHANGE;
2987     if (ThreadPriorityVerbose) {
2988       tty-&gt;print_cr(&quot;FX: [%d...%d] %d-&gt;%d\n&quot;,
2989                     fxLimits.minPrio, maxClamped, newPrio, fxInfo-&gt;fx_upri);
2990     }
2991   } else {
2992     if (ThreadPriorityVerbose) {
2993       tty-&gt;print_cr(&quot;Unknown new scheduling class %d\n&quot;, new_class);
2994     }
2995     return EINVAL;    // no clue, punt
2996   }
2997 
2998   rslt = priocntl(P_LWPID, lwpid, PC_SETPARMS, (caddr_t)&amp;ParmInfo);
2999   if (ThreadPriorityVerbose &amp;&amp; rslt) {
3000     tty-&gt;print_cr (&quot;PC_SETPARMS -&gt;%d %d\n&quot;, rslt, errno);
3001   }
3002   if (rslt &lt; 0) return errno;
3003 
3004 #ifdef ASSERT
3005   // Sanity check: read back what we just attempted to set.
3006   // In theory it could have changed in the interim ...
3007   //
3008   // The priocntl system call is tricky.
3009   // Sometimes it&#39;ll validate the priority value argument and
3010   // return EINVAL if unhappy.  At other times it fails silently.
3011   // Readbacks are prudent.
3012 
3013   if (!ReadBackValidate) return 0;
3014 
3015   memset(&amp;ReadBack, 0, sizeof(pcparms_t));
3016   ReadBack.pc_cid = PC_CLNULL;
3017   rslt = priocntl(P_LWPID, lwpid, PC_GETPARMS, (caddr_t)&amp;ReadBack);
3018   assert(rslt &gt;= 0, &quot;priocntl failed&quot;);
3019   Actual = Expected = 0xBAD;
3020   assert(ParmInfo.pc_cid == ReadBack.pc_cid, &quot;cid&#39;s don&#39;t match&quot;);
3021   if (ParmInfo.pc_cid == rtLimits.schedPolicy) {
3022     Actual   = RTPRI(ReadBack)-&gt;rt_pri;
3023     Expected = RTPRI(ParmInfo)-&gt;rt_pri;
3024   } else if (ParmInfo.pc_cid == iaLimits.schedPolicy) {
3025     Actual   = IAPRI(ReadBack)-&gt;ia_upri;
3026     Expected = IAPRI(ParmInfo)-&gt;ia_upri;
3027   } else if (ParmInfo.pc_cid == tsLimits.schedPolicy) {
3028     Actual   = TSPRI(ReadBack)-&gt;ts_upri;
3029     Expected = TSPRI(ParmInfo)-&gt;ts_upri;
3030   } else if (ParmInfo.pc_cid == fxLimits.schedPolicy) {
3031     Actual   = FXPRI(ReadBack)-&gt;fx_upri;
3032     Expected = FXPRI(ParmInfo)-&gt;fx_upri;
3033   } else {
3034     if (ThreadPriorityVerbose) {
3035       tty-&gt;print_cr(&quot;set_lwp_class_and_priority: unexpected class in readback: %d\n&quot;,
3036                     ParmInfo.pc_cid);
3037     }
3038   }
3039 
3040   if (Actual != Expected) {
3041     if (ThreadPriorityVerbose) {
3042       tty-&gt;print_cr (&quot;set_lwp_class_and_priority(%d %d) Class=%d: actual=%d vs expected=%d\n&quot;,
3043                      lwpid, newPrio, ReadBack.pc_cid, Actual, Expected);
3044     }
3045   }
3046 #endif
3047 
3048   return 0;
3049 }
3050 
3051 // Solaris only gives access to 128 real priorities at a time,
3052 // so we expand Java&#39;s ten to fill this range.  This would be better
3053 // if we dynamically adjusted relative priorities.
3054 //
3055 // The ThreadPriorityPolicy option allows us to select 2 different
3056 // priority scales.
3057 //
3058 // ThreadPriorityPolicy=0
3059 // Since the Solaris&#39; default priority is MaximumPriority, we do not
3060 // set a priority lower than Max unless a priority lower than
3061 // NormPriority is requested.
3062 //
3063 // ThreadPriorityPolicy=1
3064 // This mode causes the priority table to get filled with
3065 // linear values.  NormPriority get&#39;s mapped to 50% of the
3066 // Maximum priority an so on.  This will cause VM threads
3067 // to get unfair treatment against other Solaris processes
3068 // which do not explicitly alter their thread priorities.
3069 
3070 int os::java_to_os_priority[CriticalPriority + 1] = {
3071   -99999,         // 0 Entry should never be used
3072 
3073   0,              // 1 MinPriority
3074   32,             // 2
3075   64,             // 3
3076 
3077   96,             // 4
3078   127,            // 5 NormPriority
3079   127,            // 6
3080 
3081   127,            // 7
3082   127,            // 8
3083   127,            // 9 NearMaxPriority
3084 
3085   127,            // 10 MaxPriority
3086 
3087   -criticalPrio   // 11 CriticalPriority
3088 };
3089 
3090 OSReturn os::set_native_priority(Thread* thread, int newpri) {
3091   OSThread* osthread = thread-&gt;osthread();
3092 
3093   // Save requested priority in case the thread hasn&#39;t been started
3094   osthread-&gt;set_native_priority(newpri);
3095 
3096   // Check for critical priority request
3097   bool fxcritical = false;
3098   if (newpri == -criticalPrio) {
3099     fxcritical = true;
3100     newpri = criticalPrio;
3101   }
3102 
3103   assert(newpri &gt;= MinimumPriority &amp;&amp; newpri &lt;= MaximumPriority, &quot;bad priority mapping&quot;);
3104   if (!UseThreadPriorities) return OS_OK;
3105 
3106   int status = 0;
3107 
3108   if (!fxcritical) {
3109     // Use thr_setprio only if we have a priority that thr_setprio understands
3110     status = thr_setprio(thread-&gt;osthread()-&gt;thread_id(), newpri);
3111   }
3112 
3113   int lwp_status =
3114           set_lwp_class_and_priority(osthread-&gt;thread_id(),
3115                                      osthread-&gt;lwp_id(),
3116                                      newpri,
3117                                      fxcritical ? fxLimits.schedPolicy : myClass,
3118                                      !fxcritical);
3119   if (lwp_status != 0 &amp;&amp; fxcritical) {
3120     // Try again, this time without changing the scheduling class
3121     newpri = java_MaxPriority_to_os_priority;
3122     lwp_status = set_lwp_class_and_priority(osthread-&gt;thread_id(),
3123                                             osthread-&gt;lwp_id(),
3124                                             newpri, myClass, false);
3125   }
3126   status |= lwp_status;
3127   return (status == 0) ? OS_OK : OS_ERR;
3128 }
3129 
3130 
3131 OSReturn os::get_native_priority(const Thread* const thread,
3132                                  int *priority_ptr) {
3133   int p;
3134   if (!UseThreadPriorities) {
3135     *priority_ptr = NormalPriority;
3136     return OS_OK;
3137   }
3138   int status = thr_getprio(thread-&gt;osthread()-&gt;thread_id(), &amp;p);
3139   if (status != 0) {
3140     return OS_ERR;
3141   }
3142   *priority_ptr = p;
3143   return OS_OK;
3144 }
3145 
3146 ////////////////////////////////////////////////////////////////////////////////
3147 // suspend/resume support
3148 
3149 //  The low-level signal-based suspend/resume support is a remnant from the
3150 //  old VM-suspension that used to be for java-suspension, safepoints etc,
3151 //  within hotspot. Currently used by JFR&#39;s OSThreadSampler
3152 //
3153 //  The remaining code is greatly simplified from the more general suspension
3154 //  code that used to be used.
3155 //
3156 //  The protocol is quite simple:
3157 //  - suspend:
3158 //      - sends a signal to the target thread
3159 //      - polls the suspend state of the osthread using a yield loop
3160 //      - target thread signal handler (SR_handler) sets suspend state
3161 //        and blocks in sigsuspend until continued
3162 //  - resume:
3163 //      - sets target osthread state to continue
3164 //      - sends signal to end the sigsuspend loop in the SR_handler
3165 //
3166 //  Note that the SR_lock plays no role in this suspend/resume protocol,
3167 //  but is checked for NULL in SR_handler as a thread termination indicator.
3168 //  The SR_lock is, however, used by JavaThread::java_suspend()/java_resume() APIs.
3169 //
3170 //  Note that resume_clear_context() and suspend_save_context() are needed
3171 //  by SR_handler(), so that fetch_frame_from_ucontext() works,
3172 //  which in part is used by:
3173 //    - Forte Analyzer: AsyncGetCallTrace()
3174 //    - StackBanging: get_frame_at_stack_banging_point()
3175 //    - JFR: get_topframe()--&gt;....--&gt;get_valid_uc_in_signal_handler()
3176 
3177 static void resume_clear_context(OSThread *osthread) {
3178   osthread-&gt;set_ucontext(NULL);
3179 }
3180 
3181 static void suspend_save_context(OSThread *osthread, ucontext_t* context) {
3182   osthread-&gt;set_ucontext(context);
3183 }
3184 
3185 static PosixSemaphore sr_semaphore;
3186 
3187 void os::Solaris::SR_handler(Thread* thread, ucontext_t* context) {
3188   // Save and restore errno to avoid confusing native code with EINTR
3189   // after sigsuspend.
3190   int old_errno = errno;
3191 
3192   OSThread* osthread = thread-&gt;osthread();
3193   assert(thread-&gt;is_VM_thread() || thread-&gt;is_Java_thread(), &quot;Must be VMThread or JavaThread&quot;);
3194 
3195   os::SuspendResume::State current = osthread-&gt;sr.state();
3196   if (current == os::SuspendResume::SR_SUSPEND_REQUEST) {
3197     suspend_save_context(osthread, context);
3198 
3199     // attempt to switch the state, we assume we had a SUSPEND_REQUEST
3200     os::SuspendResume::State state = osthread-&gt;sr.suspended();
3201     if (state == os::SuspendResume::SR_SUSPENDED) {
3202       sigset_t suspend_set;  // signals for sigsuspend()
3203 
3204       // get current set of blocked signals and unblock resume signal
3205       pthread_sigmask(SIG_BLOCK, NULL, &amp;suspend_set);
3206       sigdelset(&amp;suspend_set, ASYNC_SIGNAL);
3207 
3208       sr_semaphore.signal();
3209       // wait here until we are resumed
3210       while (1) {
3211         sigsuspend(&amp;suspend_set);
3212 
3213         os::SuspendResume::State result = osthread-&gt;sr.running();
3214         if (result == os::SuspendResume::SR_RUNNING) {
3215           sr_semaphore.signal();
3216           break;
3217         }
3218       }
3219 
3220     } else if (state == os::SuspendResume::SR_RUNNING) {
3221       // request was cancelled, continue
3222     } else {
3223       ShouldNotReachHere();
3224     }
3225 
3226     resume_clear_context(osthread);
3227   } else if (current == os::SuspendResume::SR_RUNNING) {
3228     // request was cancelled, continue
3229   } else if (current == os::SuspendResume::SR_WAKEUP_REQUEST) {
3230     // ignore
3231   } else {
3232     // ignore
3233   }
3234 
3235   errno = old_errno;
3236 }
3237 
3238 void os::print_statistics() {
3239 }
3240 
3241 bool os::message_box(const char* title, const char* message) {
3242   int i;
3243   fdStream err(defaultStream::error_fd());
3244   for (i = 0; i &lt; 78; i++) err.print_raw(&quot;=&quot;);
3245   err.cr();
3246   err.print_raw_cr(title);
3247   for (i = 0; i &lt; 78; i++) err.print_raw(&quot;-&quot;);
3248   err.cr();
3249   err.print_raw_cr(message);
3250   for (i = 0; i &lt; 78; i++) err.print_raw(&quot;=&quot;);
3251   err.cr();
3252 
3253   char buf[16];
3254   // Prevent process from exiting upon &quot;read error&quot; without consuming all CPU
3255   while (::read(0, buf, sizeof(buf)) &lt;= 0) { ::sleep(100); }
3256 
3257   return buf[0] == &#39;y&#39; || buf[0] == &#39;Y&#39;;
3258 }
3259 
3260 static int sr_notify(OSThread* osthread) {
3261   int status = thr_kill(osthread-&gt;thread_id(), ASYNC_SIGNAL);
3262   assert_status(status == 0, status, &quot;thr_kill&quot;);
3263   return status;
3264 }
3265 
3266 // &quot;Randomly&quot; selected value for how long we want to spin
3267 // before bailing out on suspending a thread, also how often
3268 // we send a signal to a thread we want to resume
3269 static const int RANDOMLY_LARGE_INTEGER = 1000000;
3270 static const int RANDOMLY_LARGE_INTEGER2 = 100;
3271 
3272 static bool do_suspend(OSThread* osthread) {
3273   assert(osthread-&gt;sr.is_running(), &quot;thread should be running&quot;);
3274   assert(!sr_semaphore.trywait(), &quot;semaphore has invalid state&quot;);
3275 
3276   // mark as suspended and send signal
3277   if (osthread-&gt;sr.request_suspend() != os::SuspendResume::SR_SUSPEND_REQUEST) {
3278     // failed to switch, state wasn&#39;t running?
3279     ShouldNotReachHere();
3280     return false;
3281   }
3282 
3283   if (sr_notify(osthread) != 0) {
3284     ShouldNotReachHere();
3285   }
3286 
3287   // managed to send the signal and switch to SUSPEND_REQUEST, now wait for SUSPENDED
3288   while (true) {
3289     if (sr_semaphore.timedwait(2000)) {
3290       break;
3291     } else {
3292       // timeout
3293       os::SuspendResume::State cancelled = osthread-&gt;sr.cancel_suspend();
3294       if (cancelled == os::SuspendResume::SR_RUNNING) {
3295         return false;
3296       } else if (cancelled == os::SuspendResume::SR_SUSPENDED) {
3297         // make sure that we consume the signal on the semaphore as well
3298         sr_semaphore.wait();
3299         break;
3300       } else {
3301         ShouldNotReachHere();
3302         return false;
3303       }
3304     }
3305   }
3306 
3307   guarantee(osthread-&gt;sr.is_suspended(), &quot;Must be suspended&quot;);
3308   return true;
3309 }
3310 
3311 static void do_resume(OSThread* osthread) {
3312   assert(osthread-&gt;sr.is_suspended(), &quot;thread should be suspended&quot;);
3313   assert(!sr_semaphore.trywait(), &quot;invalid semaphore state&quot;);
3314 
3315   if (osthread-&gt;sr.request_wakeup() != os::SuspendResume::SR_WAKEUP_REQUEST) {
3316     // failed to switch to WAKEUP_REQUEST
3317     ShouldNotReachHere();
3318     return;
3319   }
3320 
3321   while (true) {
3322     if (sr_notify(osthread) == 0) {
3323       if (sr_semaphore.timedwait(2)) {
3324         if (osthread-&gt;sr.is_running()) {
3325           return;
3326         }
3327       }
3328     } else {
3329       ShouldNotReachHere();
3330     }
3331   }
3332 
3333   guarantee(osthread-&gt;sr.is_running(), &quot;Must be running!&quot;);
3334 }
3335 
3336 void os::SuspendedThreadTask::internal_do_task() {
3337   if (do_suspend(_thread-&gt;osthread())) {
3338     SuspendedThreadTaskContext context(_thread, _thread-&gt;osthread()-&gt;ucontext());
3339     do_task(context);
3340     do_resume(_thread-&gt;osthread());
3341   }
3342 }
3343 
3344 // This does not do anything on Solaris. This is basically a hook for being
3345 // able to use structured exception handling (thread-local exception filters) on, e.g., Win32.
3346 void os::os_exception_wrapper(java_call_t f, JavaValue* value,
3347                               const methodHandle&amp; method, JavaCallArguments* args,
3348                               Thread* thread) {
3349   f(value, method, args, thread);
3350 }
3351 
3352 // This routine may be used by user applications as a &quot;hook&quot; to catch signals.
3353 // The user-defined signal handler must pass unrecognized signals to this
3354 // routine, and if it returns true (non-zero), then the signal handler must
3355 // return immediately.  If the flag &quot;abort_if_unrecognized&quot; is true, then this
3356 // routine will never retun false (zero), but instead will execute a VM panic
3357 // routine kill the process.
3358 //
3359 // If this routine returns false, it is OK to call it again.  This allows
3360 // the user-defined signal handler to perform checks either before or after
3361 // the VM performs its own checks.  Naturally, the user code would be making
3362 // a serious error if it tried to handle an exception (such as a null check
3363 // or breakpoint) that the VM was generating for its own correct operation.
3364 //
3365 // This routine may recognize any of the following kinds of signals:
3366 // SIGBUS, SIGSEGV, SIGILL, SIGFPE, BREAK_SIGNAL, SIGPIPE, SIGXFSZ,
3367 // ASYNC_SIGNAL.
3368 // It should be consulted by handlers for any of those signals.
3369 //
3370 // The caller of this routine must pass in the three arguments supplied
3371 // to the function referred to in the &quot;sa_sigaction&quot; (not the &quot;sa_handler&quot;)
3372 // field of the structure passed to sigaction().  This routine assumes that
3373 // the sa_flags field passed to sigaction() includes SA_SIGINFO and SA_RESTART.
3374 //
3375 // Note that the VM will print warnings if it detects conflicting signal
3376 // handlers, unless invoked with the option &quot;-XX:+AllowUserSignalHandlers&quot;.
3377 //
3378 extern &quot;C&quot; JNIEXPORT int JVM_handle_solaris_signal(int signo,
3379                                                    siginfo_t* siginfo,
3380                                                    void* ucontext,
3381                                                    int abort_if_unrecognized);
3382 
3383 
3384 void signalHandler(int sig, siginfo_t* info, void* ucVoid) {
3385   int orig_errno = errno;  // Preserve errno value over signal handler.
3386   JVM_handle_solaris_signal(sig, info, ucVoid, true);
3387   errno = orig_errno;
3388 }
3389 
3390 // This boolean allows users to forward their own non-matching signals
3391 // to JVM_handle_solaris_signal, harmlessly.
3392 bool os::Solaris::signal_handlers_are_installed = false;
3393 
3394 // For signal-chaining
3395 bool os::Solaris::libjsig_is_loaded = false;
3396 typedef struct sigaction *(*get_signal_t)(int);
3397 get_signal_t os::Solaris::get_signal_action = NULL;
3398 
3399 struct sigaction* os::Solaris::get_chained_signal_action(int sig) {
3400   struct sigaction *actp = NULL;
3401 
3402   if ((libjsig_is_loaded)  &amp;&amp; (sig &lt;= Maxsignum)) {
3403     // Retrieve the old signal handler from libjsig
3404     actp = (*get_signal_action)(sig);
3405   }
3406   if (actp == NULL) {
3407     // Retrieve the preinstalled signal handler from jvm
3408     actp = get_preinstalled_handler(sig);
3409   }
3410 
3411   return actp;
3412 }
3413 
3414 static bool call_chained_handler(struct sigaction *actp, int sig,
3415                                  siginfo_t *siginfo, void *context) {
3416   // Call the old signal handler
3417   if (actp-&gt;sa_handler == SIG_DFL) {
3418     // It&#39;s more reasonable to let jvm treat it as an unexpected exception
3419     // instead of taking the default action.
3420     return false;
3421   } else if (actp-&gt;sa_handler != SIG_IGN) {
3422     if ((actp-&gt;sa_flags &amp; SA_NODEFER) == 0) {
3423       // automaticlly block the signal
3424       sigaddset(&amp;(actp-&gt;sa_mask), sig);
3425     }
3426 
3427     sa_handler_t hand;
3428     sa_sigaction_t sa;
3429     bool siginfo_flag_set = (actp-&gt;sa_flags &amp; SA_SIGINFO) != 0;
3430     // retrieve the chained handler
3431     if (siginfo_flag_set) {
3432       sa = actp-&gt;sa_sigaction;
3433     } else {
3434       hand = actp-&gt;sa_handler;
3435     }
3436 
3437     if ((actp-&gt;sa_flags &amp; SA_RESETHAND) != 0) {
3438       actp-&gt;sa_handler = SIG_DFL;
3439     }
3440 
3441     // try to honor the signal mask
3442     sigset_t oset;
3443     pthread_sigmask(SIG_SETMASK, &amp;(actp-&gt;sa_mask), &amp;oset);
3444 
3445     // call into the chained handler
3446     if (siginfo_flag_set) {
3447       (*sa)(sig, siginfo, context);
3448     } else {
3449       (*hand)(sig);
3450     }
3451 
3452     // restore the signal mask
3453     pthread_sigmask(SIG_SETMASK, &amp;oset, 0);
3454   }
3455   // Tell jvm&#39;s signal handler the signal is taken care of.
3456   return true;
3457 }
3458 
3459 bool os::Solaris::chained_handler(int sig, siginfo_t* siginfo, void* context) {
3460   bool chained = false;
3461   // signal-chaining
3462   if (UseSignalChaining) {
3463     struct sigaction *actp = get_chained_signal_action(sig);
3464     if (actp != NULL) {
3465       chained = call_chained_handler(actp, sig, siginfo, context);
3466     }
3467   }
3468   return chained;
3469 }
3470 
3471 struct sigaction* os::Solaris::get_preinstalled_handler(int sig) {
3472   assert((chainedsigactions != (struct sigaction *)NULL) &amp;&amp;
3473          (preinstalled_sigs != (int *)NULL), &quot;signals not yet initialized&quot;);
3474   if (preinstalled_sigs[sig] != 0) {
3475     return &amp;chainedsigactions[sig];
3476   }
3477   return NULL;
3478 }
3479 
3480 void os::Solaris::save_preinstalled_handler(int sig,
3481                                             struct sigaction&amp; oldAct) {
3482   assert(sig &gt; 0 &amp;&amp; sig &lt;= Maxsignum, &quot;vm signal out of expected range&quot;);
3483   assert((chainedsigactions != (struct sigaction *)NULL) &amp;&amp;
3484          (preinstalled_sigs != (int *)NULL), &quot;signals not yet initialized&quot;);
3485   chainedsigactions[sig] = oldAct;
3486   preinstalled_sigs[sig] = 1;
3487 }
3488 
3489 void os::Solaris::set_signal_handler(int sig, bool set_installed,
3490                                      bool oktochain) {
3491   // Check for overwrite.
3492   struct sigaction oldAct;
3493   sigaction(sig, (struct sigaction*)NULL, &amp;oldAct);
3494   void* oldhand =
3495       oldAct.sa_sigaction ? CAST_FROM_FN_PTR(void*,  oldAct.sa_sigaction)
3496                           : CAST_FROM_FN_PTR(void*,  oldAct.sa_handler);
3497   if (oldhand != CAST_FROM_FN_PTR(void*, SIG_DFL) &amp;&amp;
3498       oldhand != CAST_FROM_FN_PTR(void*, SIG_IGN) &amp;&amp;
3499       oldhand != CAST_FROM_FN_PTR(void*, signalHandler)) {
3500     if (AllowUserSignalHandlers || !set_installed) {
3501       // Do not overwrite; user takes responsibility to forward to us.
3502       return;
3503     } else if (UseSignalChaining) {
3504       if (oktochain) {
3505         // save the old handler in jvm
3506         save_preinstalled_handler(sig, oldAct);
3507       } else {
3508         vm_exit_during_initialization(&quot;Signal chaining not allowed for VM interrupt signal.&quot;);
3509       }
3510       // libjsig also interposes the sigaction() call below and saves the
3511       // old sigaction on it own.
3512     } else {
3513       fatal(&quot;Encountered unexpected pre-existing sigaction handler &quot;
3514             &quot;%#lx for signal %d.&quot;, (long)oldhand, sig);
3515     }
3516   }
3517 
3518   struct sigaction sigAct;
3519   sigfillset(&amp;(sigAct.sa_mask));
3520   sigAct.sa_handler = SIG_DFL;
3521 
3522   sigAct.sa_sigaction = signalHandler;
3523   // Handle SIGSEGV on alternate signal stack if
3524   // not using stack banging
3525   if (!UseStackBanging &amp;&amp; sig == SIGSEGV) {
3526     sigAct.sa_flags = SA_SIGINFO | SA_RESTART | SA_ONSTACK;
3527   } else {
3528     sigAct.sa_flags = SA_SIGINFO | SA_RESTART;
3529   }
3530   os::Solaris::set_our_sigflags(sig, sigAct.sa_flags);
3531 
3532   sigaction(sig, &amp;sigAct, &amp;oldAct);
3533 
3534   void* oldhand2 = oldAct.sa_sigaction ? CAST_FROM_FN_PTR(void*, oldAct.sa_sigaction)
3535                                        : CAST_FROM_FN_PTR(void*, oldAct.sa_handler);
3536   assert(oldhand2 == oldhand, &quot;no concurrent signal handler installation&quot;);
3537 }
3538 
3539 
3540 #define DO_SIGNAL_CHECK(sig)                      \
3541   do {                                            \
3542     if (!sigismember(&amp;check_signal_done, sig)) {  \
3543       os::Solaris::check_signal_handler(sig);     \
3544     }                                             \
3545   } while (0)
3546 
3547 // This method is a periodic task to check for misbehaving JNI applications
3548 // under CheckJNI, we can add any periodic checks here
3549 
3550 void os::run_periodic_checks() {
3551   // A big source of grief is hijacking virt. addr 0x0 on Solaris,
3552   // thereby preventing a NULL checks.
3553   if (!check_addr0_done) check_addr0_done = check_addr0(tty);
3554 
3555   if (check_signals == false) return;
3556 
3557   // SEGV and BUS if overridden could potentially prevent
3558   // generation of hs*.log in the event of a crash, debugging
3559   // such a case can be very challenging, so we absolutely
3560   // check for the following for a good measure:
3561   DO_SIGNAL_CHECK(SIGSEGV);
3562   DO_SIGNAL_CHECK(SIGILL);
3563   DO_SIGNAL_CHECK(SIGFPE);
3564   DO_SIGNAL_CHECK(SIGBUS);
3565   DO_SIGNAL_CHECK(SIGPIPE);
3566   DO_SIGNAL_CHECK(SIGXFSZ);
3567   DO_SIGNAL_CHECK(ASYNC_SIGNAL);
3568 
3569   // ReduceSignalUsage allows the user to override these handlers
3570   // see comments at the very top and jvm_solaris.h
3571   if (!ReduceSignalUsage) {
3572     DO_SIGNAL_CHECK(SHUTDOWN1_SIGNAL);
3573     DO_SIGNAL_CHECK(SHUTDOWN2_SIGNAL);
3574     DO_SIGNAL_CHECK(SHUTDOWN3_SIGNAL);
3575     DO_SIGNAL_CHECK(BREAK_SIGNAL);
3576   }
3577 }
3578 
3579 typedef int (*os_sigaction_t)(int, const struct sigaction *, struct sigaction *);
3580 
3581 static os_sigaction_t os_sigaction = NULL;
3582 
3583 void os::Solaris::check_signal_handler(int sig) {
3584   char buf[O_BUFLEN];
3585   address jvmHandler = NULL;
3586 
3587   struct sigaction act;
3588   if (os_sigaction == NULL) {
3589     // only trust the default sigaction, in case it has been interposed
3590     os_sigaction = (os_sigaction_t)dlsym(RTLD_DEFAULT, &quot;sigaction&quot;);
3591     if (os_sigaction == NULL) return;
3592   }
3593 
3594   os_sigaction(sig, (struct sigaction*)NULL, &amp;act);
3595 
3596   address thisHandler = (act.sa_flags &amp; SA_SIGINFO)
3597     ? CAST_FROM_FN_PTR(address, act.sa_sigaction)
3598     : CAST_FROM_FN_PTR(address, act.sa_handler);
3599 
3600 
3601   switch (sig) {
3602   case SIGSEGV:
3603   case SIGBUS:
3604   case SIGFPE:
3605   case SIGPIPE:
3606   case SIGXFSZ:
3607   case SIGILL:
3608   case ASYNC_SIGNAL:
3609     jvmHandler = CAST_FROM_FN_PTR(address, signalHandler);
3610     break;
3611 
3612   case SHUTDOWN1_SIGNAL:
3613   case SHUTDOWN2_SIGNAL:
3614   case SHUTDOWN3_SIGNAL:
3615   case BREAK_SIGNAL:
3616     jvmHandler = (address)user_handler();
3617     break;
3618 
3619   default:
3620       return;
3621   }
3622 
3623   if (thisHandler != jvmHandler) {
3624     tty-&gt;print(&quot;Warning: %s handler &quot;, exception_name(sig, buf, O_BUFLEN));
3625     tty-&gt;print(&quot;expected:%s&quot;, get_signal_handler_name(jvmHandler, buf, O_BUFLEN));
3626     tty-&gt;print_cr(&quot;  found:%s&quot;, get_signal_handler_name(thisHandler, buf, O_BUFLEN));
3627     // No need to check this sig any longer
3628     sigaddset(&amp;check_signal_done, sig);
3629     // Running under non-interactive shell, SHUTDOWN2_SIGNAL will be reassigned SIG_IGN
3630     if (sig == SHUTDOWN2_SIGNAL &amp;&amp; !isatty(fileno(stdin))) {
3631       tty-&gt;print_cr(&quot;Running in non-interactive shell, %s handler is replaced by shell&quot;,
3632                     exception_name(sig, buf, O_BUFLEN));
3633     }
3634   } else if(os::Solaris::get_our_sigflags(sig) != 0 &amp;&amp; act.sa_flags != os::Solaris::get_our_sigflags(sig)) {
3635     tty-&gt;print(&quot;Warning: %s handler flags &quot;, exception_name(sig, buf, O_BUFLEN));
3636     tty-&gt;print(&quot;expected:&quot;);
3637     os::Posix::print_sa_flags(tty, os::Solaris::get_our_sigflags(sig));
3638     tty-&gt;cr();
3639     tty-&gt;print(&quot;  found:&quot;);
3640     os::Posix::print_sa_flags(tty, act.sa_flags);
3641     tty-&gt;cr();
3642     // No need to check this sig any longer
3643     sigaddset(&amp;check_signal_done, sig);
3644   }
3645 
3646   // Print all the signal handler state
3647   if (sigismember(&amp;check_signal_done, sig)) {
3648     print_signal_handlers(tty, buf, O_BUFLEN);
3649   }
3650 
3651 }
3652 
3653 void os::Solaris::install_signal_handlers() {
3654   signal_handlers_are_installed = true;
3655 
3656   // signal-chaining
3657   typedef void (*signal_setting_t)();
3658   signal_setting_t begin_signal_setting = NULL;
3659   signal_setting_t end_signal_setting = NULL;
3660   begin_signal_setting = CAST_TO_FN_PTR(signal_setting_t,
3661                                         dlsym(RTLD_DEFAULT, &quot;JVM_begin_signal_setting&quot;));
3662   if (begin_signal_setting != NULL) {
3663     end_signal_setting = CAST_TO_FN_PTR(signal_setting_t,
3664                                         dlsym(RTLD_DEFAULT, &quot;JVM_end_signal_setting&quot;));
3665     get_signal_action = CAST_TO_FN_PTR(get_signal_t,
3666                                        dlsym(RTLD_DEFAULT, &quot;JVM_get_signal_action&quot;));
3667     libjsig_is_loaded = true;
3668     assert(UseSignalChaining, &quot;should enable signal-chaining&quot;);
3669   }
3670   if (libjsig_is_loaded) {
3671     // Tell libjsig jvm is setting signal handlers
3672     (*begin_signal_setting)();
3673   }
3674 
3675   set_signal_handler(SIGSEGV, true, true);
3676   set_signal_handler(SIGPIPE, true, true);
3677   set_signal_handler(SIGXFSZ, true, true);
3678   set_signal_handler(SIGBUS, true, true);
3679   set_signal_handler(SIGILL, true, true);
3680   set_signal_handler(SIGFPE, true, true);
3681   set_signal_handler(ASYNC_SIGNAL, true, true);
3682 
3683   if (libjsig_is_loaded) {
3684     // Tell libjsig jvm finishes setting signal handlers
3685     (*end_signal_setting)();
3686   }
3687 
3688   // We don&#39;t activate signal checker if libjsig is in place, we trust ourselves
3689   // and if UserSignalHandler is installed all bets are off.
3690   // Log that signal checking is off only if -verbose:jni is specified.
3691   if (CheckJNICalls) {
3692     if (libjsig_is_loaded) {
3693       log_debug(jni, resolve)(&quot;Info: libjsig is activated, all active signal checking is disabled&quot;);
3694       check_signals = false;
3695     }
3696     if (AllowUserSignalHandlers) {
3697       log_debug(jni, resolve)(&quot;Info: AllowUserSignalHandlers is activated, all active signal checking is disabled&quot;);
3698       check_signals = false;
3699     }
3700   }
3701 }
3702 
3703 
3704 void report_error(const char* file_name, int line_no, const char* title,
3705                   const char* format, ...);
3706 
3707 // (Static) wrappers for the liblgrp API
3708 os::Solaris::lgrp_home_func_t os::Solaris::_lgrp_home;
3709 os::Solaris::lgrp_init_func_t os::Solaris::_lgrp_init;
3710 os::Solaris::lgrp_fini_func_t os::Solaris::_lgrp_fini;
3711 os::Solaris::lgrp_root_func_t os::Solaris::_lgrp_root;
3712 os::Solaris::lgrp_children_func_t os::Solaris::_lgrp_children;
3713 os::Solaris::lgrp_resources_func_t os::Solaris::_lgrp_resources;
3714 os::Solaris::lgrp_nlgrps_func_t os::Solaris::_lgrp_nlgrps;
3715 os::Solaris::lgrp_cookie_stale_func_t os::Solaris::_lgrp_cookie_stale;
3716 os::Solaris::lgrp_cookie_t os::Solaris::_lgrp_cookie = 0;
3717 
3718 static address resolve_symbol_lazy(const char* name) {
3719   address addr = (address) dlsym(RTLD_DEFAULT, name);
3720   if (addr == NULL) {
3721     // RTLD_DEFAULT was not defined on some early versions of 2.5.1
3722     addr = (address) dlsym(RTLD_NEXT, name);
3723   }
3724   return addr;
3725 }
3726 
3727 static address resolve_symbol(const char* name) {
3728   address addr = resolve_symbol_lazy(name);
3729   if (addr == NULL) {
3730     fatal(dlerror());
3731   }
3732   return addr;
3733 }
3734 
3735 void os::Solaris::libthread_init() {
3736   address func = (address)dlsym(RTLD_DEFAULT, &quot;_thr_suspend_allmutators&quot;);
3737 
3738   lwp_priocntl_init();
3739 
3740   // RTLD_DEFAULT was not defined on some early versions of 5.5.1
3741   if (func == NULL) {
3742     func = (address) dlsym(RTLD_NEXT, &quot;_thr_suspend_allmutators&quot;);
3743     // Guarantee that this VM is running on an new enough OS (5.6 or
3744     // later) that it will have a new enough libthread.so.
3745     guarantee(func != NULL, &quot;libthread.so is too old.&quot;);
3746   }
3747 
3748   int size;
3749   void (*handler_info_func)(address *, int *);
3750   handler_info_func = CAST_TO_FN_PTR(void (*)(address *, int *), resolve_symbol(&quot;thr_sighndlrinfo&quot;));
3751   handler_info_func(&amp;handler_start, &amp;size);
3752   handler_end = handler_start + size;
3753 }
3754 
3755 
3756 int_fnP_mutex_tP os::Solaris::_mutex_lock;
3757 int_fnP_mutex_tP os::Solaris::_mutex_trylock;
3758 int_fnP_mutex_tP os::Solaris::_mutex_unlock;
3759 int_fnP_mutex_tP_i_vP os::Solaris::_mutex_init;
3760 int_fnP_mutex_tP os::Solaris::_mutex_destroy;
3761 int os::Solaris::_mutex_scope = USYNC_THREAD;
3762 
3763 int_fnP_cond_tP_mutex_tP_timestruc_tP os::Solaris::_cond_timedwait;
3764 int_fnP_cond_tP_mutex_tP os::Solaris::_cond_wait;
3765 int_fnP_cond_tP os::Solaris::_cond_signal;
3766 int_fnP_cond_tP os::Solaris::_cond_broadcast;
3767 int_fnP_cond_tP_i_vP os::Solaris::_cond_init;
3768 int_fnP_cond_tP os::Solaris::_cond_destroy;
3769 int os::Solaris::_cond_scope = USYNC_THREAD;
3770 bool os::Solaris::_synchronization_initialized;
3771 
3772 void os::Solaris::synchronization_init() {
3773   if (UseLWPSynchronization) {
3774     os::Solaris::set_mutex_lock(CAST_TO_FN_PTR(int_fnP_mutex_tP, resolve_symbol(&quot;_lwp_mutex_lock&quot;)));
3775     os::Solaris::set_mutex_trylock(CAST_TO_FN_PTR(int_fnP_mutex_tP, resolve_symbol(&quot;_lwp_mutex_trylock&quot;)));
3776     os::Solaris::set_mutex_unlock(CAST_TO_FN_PTR(int_fnP_mutex_tP, resolve_symbol(&quot;_lwp_mutex_unlock&quot;)));
3777     os::Solaris::set_mutex_init(lwp_mutex_init);
3778     os::Solaris::set_mutex_destroy(lwp_mutex_destroy);
3779     os::Solaris::set_mutex_scope(USYNC_THREAD);
3780 
3781     os::Solaris::set_cond_timedwait(CAST_TO_FN_PTR(int_fnP_cond_tP_mutex_tP_timestruc_tP, resolve_symbol(&quot;_lwp_cond_timedwait&quot;)));
3782     os::Solaris::set_cond_wait(CAST_TO_FN_PTR(int_fnP_cond_tP_mutex_tP, resolve_symbol(&quot;_lwp_cond_wait&quot;)));
3783     os::Solaris::set_cond_signal(CAST_TO_FN_PTR(int_fnP_cond_tP, resolve_symbol(&quot;_lwp_cond_signal&quot;)));
3784     os::Solaris::set_cond_broadcast(CAST_TO_FN_PTR(int_fnP_cond_tP, resolve_symbol(&quot;_lwp_cond_broadcast&quot;)));
3785     os::Solaris::set_cond_init(lwp_cond_init);
3786     os::Solaris::set_cond_destroy(lwp_cond_destroy);
3787     os::Solaris::set_cond_scope(USYNC_THREAD);
3788   } else {
3789     os::Solaris::set_mutex_scope(USYNC_THREAD);
3790     os::Solaris::set_cond_scope(USYNC_THREAD);
3791 
3792     if (UsePthreads) {
3793       os::Solaris::set_mutex_lock(CAST_TO_FN_PTR(int_fnP_mutex_tP, resolve_symbol(&quot;pthread_mutex_lock&quot;)));
3794       os::Solaris::set_mutex_trylock(CAST_TO_FN_PTR(int_fnP_mutex_tP, resolve_symbol(&quot;pthread_mutex_trylock&quot;)));
3795       os::Solaris::set_mutex_unlock(CAST_TO_FN_PTR(int_fnP_mutex_tP, resolve_symbol(&quot;pthread_mutex_unlock&quot;)));
3796       os::Solaris::set_mutex_init(pthread_mutex_default_init);
3797       os::Solaris::set_mutex_destroy(CAST_TO_FN_PTR(int_fnP_mutex_tP, resolve_symbol(&quot;pthread_mutex_destroy&quot;)));
3798 
3799       os::Solaris::set_cond_timedwait(CAST_TO_FN_PTR(int_fnP_cond_tP_mutex_tP_timestruc_tP, resolve_symbol(&quot;pthread_cond_timedwait&quot;)));
3800       os::Solaris::set_cond_wait(CAST_TO_FN_PTR(int_fnP_cond_tP_mutex_tP, resolve_symbol(&quot;pthread_cond_wait&quot;)));
3801       os::Solaris::set_cond_signal(CAST_TO_FN_PTR(int_fnP_cond_tP, resolve_symbol(&quot;pthread_cond_signal&quot;)));
3802       os::Solaris::set_cond_broadcast(CAST_TO_FN_PTR(int_fnP_cond_tP, resolve_symbol(&quot;pthread_cond_broadcast&quot;)));
3803       os::Solaris::set_cond_init(pthread_cond_default_init);
3804       os::Solaris::set_cond_destroy(CAST_TO_FN_PTR(int_fnP_cond_tP, resolve_symbol(&quot;pthread_cond_destroy&quot;)));
3805     } else {
3806       os::Solaris::set_mutex_lock(CAST_TO_FN_PTR(int_fnP_mutex_tP, resolve_symbol(&quot;mutex_lock&quot;)));
3807       os::Solaris::set_mutex_trylock(CAST_TO_FN_PTR(int_fnP_mutex_tP, resolve_symbol(&quot;mutex_trylock&quot;)));
3808       os::Solaris::set_mutex_unlock(CAST_TO_FN_PTR(int_fnP_mutex_tP, resolve_symbol(&quot;mutex_unlock&quot;)));
3809       os::Solaris::set_mutex_init(::mutex_init);
3810       os::Solaris::set_mutex_destroy(::mutex_destroy);
3811 
3812       os::Solaris::set_cond_timedwait(CAST_TO_FN_PTR(int_fnP_cond_tP_mutex_tP_timestruc_tP, resolve_symbol(&quot;cond_timedwait&quot;)));
3813       os::Solaris::set_cond_wait(CAST_TO_FN_PTR(int_fnP_cond_tP_mutex_tP, resolve_symbol(&quot;cond_wait&quot;)));
3814       os::Solaris::set_cond_signal(CAST_TO_FN_PTR(int_fnP_cond_tP, resolve_symbol(&quot;cond_signal&quot;)));
3815       os::Solaris::set_cond_broadcast(CAST_TO_FN_PTR(int_fnP_cond_tP, resolve_symbol(&quot;cond_broadcast&quot;)));
3816       os::Solaris::set_cond_init(::cond_init);
3817       os::Solaris::set_cond_destroy(::cond_destroy);
3818     }
3819   }
3820   _synchronization_initialized = true;
3821 }
3822 
3823 bool os::Solaris::liblgrp_init() {
3824   void *handle = dlopen(&quot;liblgrp.so.1&quot;, RTLD_LAZY);
3825   if (handle != NULL) {
3826     os::Solaris::set_lgrp_home(CAST_TO_FN_PTR(lgrp_home_func_t, dlsym(handle, &quot;lgrp_home&quot;)));
3827     os::Solaris::set_lgrp_init(CAST_TO_FN_PTR(lgrp_init_func_t, dlsym(handle, &quot;lgrp_init&quot;)));
3828     os::Solaris::set_lgrp_fini(CAST_TO_FN_PTR(lgrp_fini_func_t, dlsym(handle, &quot;lgrp_fini&quot;)));
3829     os::Solaris::set_lgrp_root(CAST_TO_FN_PTR(lgrp_root_func_t, dlsym(handle, &quot;lgrp_root&quot;)));
3830     os::Solaris::set_lgrp_children(CAST_TO_FN_PTR(lgrp_children_func_t, dlsym(handle, &quot;lgrp_children&quot;)));
3831     os::Solaris::set_lgrp_resources(CAST_TO_FN_PTR(lgrp_resources_func_t, dlsym(handle, &quot;lgrp_resources&quot;)));
3832     os::Solaris::set_lgrp_nlgrps(CAST_TO_FN_PTR(lgrp_nlgrps_func_t, dlsym(handle, &quot;lgrp_nlgrps&quot;)));
3833     os::Solaris::set_lgrp_cookie_stale(CAST_TO_FN_PTR(lgrp_cookie_stale_func_t,
3834                                                       dlsym(handle, &quot;lgrp_cookie_stale&quot;)));
3835 
3836     lgrp_cookie_t c = lgrp_init(LGRP_VIEW_CALLER);
3837     set_lgrp_cookie(c);
3838     return true;
3839   }
3840   return false;
3841 }
3842 
3843 // int pset_getloadavg(psetid_t pset, double loadavg[], int nelem);
3844 typedef long (*pset_getloadavg_type)(psetid_t pset, double loadavg[], int nelem);
3845 static pset_getloadavg_type pset_getloadavg_ptr = NULL;
3846 
3847 void init_pset_getloadavg_ptr(void) {
3848   pset_getloadavg_ptr =
3849     (pset_getloadavg_type)dlsym(RTLD_DEFAULT, &quot;pset_getloadavg&quot;);
3850   if (pset_getloadavg_ptr == NULL) {
3851     log_warning(os)(&quot;pset_getloadavg function not found&quot;);
3852   }
3853 }
3854 
3855 int os::Solaris::_dev_zero_fd = -1;
3856 
3857 // this is called _before_ the global arguments have been parsed
3858 void os::init(void) {
3859   _initial_pid = getpid();
3860 
3861   max_hrtime = first_hrtime = gethrtime();
3862 
3863   init_random(1234567);
3864 
3865   page_size = sysconf(_SC_PAGESIZE);
3866   if (page_size == -1) {
3867     fatal(&quot;os_solaris.cpp: os::init: sysconf failed (%s)&quot;, os::strerror(errno));
3868   }
3869   init_page_sizes((size_t) page_size);
3870 
3871   Solaris::initialize_system_info();
3872 
3873   int fd = ::open(&quot;/dev/zero&quot;, O_RDWR);
3874   if (fd &lt; 0) {
3875     fatal(&quot;os::init: cannot open /dev/zero (%s)&quot;, os::strerror(errno));
3876   } else {
3877     Solaris::set_dev_zero_fd(fd);
3878 
3879     // Close on exec, child won&#39;t inherit.
3880     fcntl(fd, F_SETFD, FD_CLOEXEC);
3881   }
3882 
3883   clock_tics_per_sec = CLK_TCK;
3884 
3885   // check if dladdr1() exists; dladdr1 can provide more information than
3886   // dladdr for os::dll_address_to_function_name. It comes with SunOS 5.9
3887   // and is available on linker patches for 5.7 and 5.8.
3888   // libdl.so must have been loaded, this call is just an entry lookup
3889   void * hdl = dlopen(&quot;libdl.so&quot;, RTLD_NOW);
3890   if (hdl) {
3891     dladdr1_func = CAST_TO_FN_PTR(dladdr1_func_type, dlsym(hdl, &quot;dladdr1&quot;));
3892   }
3893 
3894   // main_thread points to the thread that created/loaded the JVM.
3895   main_thread = thr_self();
3896 
3897   // dynamic lookup of functions that may not be available in our lowest
3898   // supported Solaris release
3899   void * handle = dlopen(&quot;libc.so.1&quot;, RTLD_LAZY);
3900   if (handle != NULL) {
3901     Solaris::_pthread_setname_np =  // from 11.3
3902         (Solaris::pthread_setname_np_func_t)dlsym(handle, &quot;pthread_setname_np&quot;);
3903   }
3904 
3905   // Shared Posix initialization
3906   os::Posix::init();
3907 }
3908 
3909 // To install functions for atexit system call
3910 extern &quot;C&quot; {
3911   static void perfMemory_exit_helper() {
3912     perfMemory_exit();
3913   }
3914 }
3915 
3916 // this is called _after_ the global arguments have been parsed
3917 jint os::init_2(void) {
3918   // try to enable extended file IO ASAP, see 6431278
3919   os::Solaris::try_enable_extended_io();
3920 
3921   // Check and sets minimum stack sizes against command line options
3922   if (Posix::set_minimum_stack_sizes() == JNI_ERR) {
3923     return JNI_ERR;
3924   }
3925 
3926   Solaris::libthread_init();
3927 
3928   if (UseNUMA) {
3929     if (!Solaris::liblgrp_init()) {
3930       UseNUMA = false;
3931     } else {
3932       size_t lgrp_limit = os::numa_get_groups_num();
3933       int *lgrp_ids = NEW_C_HEAP_ARRAY(int, lgrp_limit, mtInternal);
3934       size_t lgrp_num = os::numa_get_leaf_groups(lgrp_ids, lgrp_limit);
3935       FREE_C_HEAP_ARRAY(int, lgrp_ids);
3936       if (lgrp_num &lt; 2) {
<a name="2" id="anc2"></a><span class="line-modified">3937         // There&#39;s only one locality group, disable NUMA unless</span>
<span class="line-modified">3938         // user explicilty forces NUMA optimizations on single-node/UMA systems</span>
<span class="line-added">3939         UseNUMA = ForceNUMA;</span>
3940       }
3941     }
<a name="3" id="anc3"></a>


3942   }
3943 
3944   Solaris::signal_sets_init();
3945   Solaris::init_signal_mem();
3946   Solaris::install_signal_handlers();
3947   // Initialize data for jdk.internal.misc.Signal
3948   if (!ReduceSignalUsage) {
3949     jdk_misc_signal_init();
3950   }
3951 
3952   // initialize synchronization primitives to use either thread or
3953   // lwp synchronization (controlled by UseLWPSynchronization)
3954   Solaris::synchronization_init();
3955   DEBUG_ONLY(os::set_mutex_init_done();)
3956 
3957   if (MaxFDLimit) {
3958     // set the number of file descriptors to max. print out error
3959     // if getrlimit/setrlimit fails but continue regardless.
3960     struct rlimit nbr_files;
3961     int status = getrlimit(RLIMIT_NOFILE, &amp;nbr_files);
3962     if (status != 0) {
3963       log_info(os)(&quot;os::init_2 getrlimit failed: %s&quot;, os::strerror(errno));
3964     } else {
3965       nbr_files.rlim_cur = nbr_files.rlim_max;
3966       status = setrlimit(RLIMIT_NOFILE, &amp;nbr_files);
3967       if (status != 0) {
3968         log_info(os)(&quot;os::init_2 setrlimit failed: %s&quot;, os::strerror(errno));
3969       }
3970     }
3971   }
3972 
3973   // Calculate theoretical max. size of Threads to guard gainst
3974   // artifical out-of-memory situations, where all available address-
3975   // space has been reserved by thread stacks. Default stack size is 1Mb.
3976   size_t pre_thread_stack_size = (JavaThread::stack_size_at_create()) ?
3977     JavaThread::stack_size_at_create() : (1*K*K);
3978   assert(pre_thread_stack_size != 0, &quot;Must have a stack&quot;);
3979   // Solaris has a maximum of 4Gb of user programs. Calculate the thread limit when
3980   // we should start doing Virtual Memory banging. Currently when the threads will
3981   // have used all but 200Mb of space.
3982   size_t max_address_space = ((unsigned int)4 * K * K * K) - (200 * K * K);
3983   Solaris::_os_thread_limit = max_address_space / pre_thread_stack_size;
3984 
3985   // at-exit methods are called in the reverse order of their registration.
3986   // In Solaris 7 and earlier, atexit functions are called on return from
3987   // main or as a result of a call to exit(3C). There can be only 32 of
3988   // these functions registered and atexit() does not set errno. In Solaris
3989   // 8 and later, there is no limit to the number of functions registered
3990   // and atexit() sets errno. In addition, in Solaris 8 and later, atexit
3991   // functions are called upon dlclose(3DL) in addition to return from main
3992   // and exit(3C).
3993 
3994   if (PerfAllowAtExitRegistration) {
3995     // only register atexit functions if PerfAllowAtExitRegistration is set.
3996     // atexit functions can be delayed until process exit time, which
3997     // can be problematic for embedded VM situations. Embedded VMs should
3998     // call DestroyJavaVM() to assure that VM resources are released.
3999 
4000     // note: perfMemory_exit_helper atexit function may be removed in
4001     // the future if the appropriate cleanup code can be added to the
4002     // VM_Exit VMOperation&#39;s doit method.
4003     if (atexit(perfMemory_exit_helper) != 0) {
4004       warning(&quot;os::init2 atexit(perfMemory_exit_helper) failed&quot;);
4005     }
4006   }
4007 
4008   // Init pset_loadavg function pointer
4009   init_pset_getloadavg_ptr();
4010 
4011   // Shared Posix initialization
4012   os::Posix::init_2();
4013 
4014   return JNI_OK;
4015 }
4016 
4017 // Mark the polling page as unreadable
4018 void os::make_polling_page_unreadable(void) {
4019   Events::log(NULL, &quot;Protecting polling page &quot; INTPTR_FORMAT &quot; with PROT_NONE&quot;, p2i(_polling_page));
4020   if (mprotect((char *)_polling_page, page_size, PROT_NONE) != 0) {
4021     fatal(&quot;Could not disable polling page&quot;);
4022   }
4023 }
4024 
4025 // Mark the polling page as readable
4026 void os::make_polling_page_readable(void) {
4027   Events::log(NULL, &quot;Protecting polling page &quot; INTPTR_FORMAT &quot; with PROT_READ&quot;, p2i(_polling_page));
4028   if (mprotect((char *)_polling_page, page_size, PROT_READ) != 0) {
4029     fatal(&quot;Could not enable polling page&quot;);
4030   }
4031 }
4032 
4033 // Is a (classpath) directory empty?
4034 bool os::dir_is_empty(const char* path) {
4035   DIR *dir = NULL;
4036   struct dirent *ptr;
4037 
4038   dir = opendir(path);
4039   if (dir == NULL) return true;
4040 
4041   // Scan the directory
4042   bool result = true;
4043   while (result &amp;&amp; (ptr = readdir(dir)) != NULL) {
4044     if (strcmp(ptr-&gt;d_name, &quot;.&quot;) != 0 &amp;&amp; strcmp(ptr-&gt;d_name, &quot;..&quot;) != 0) {
4045       result = false;
4046     }
4047   }
4048   closedir(dir);
4049   return result;
4050 }
4051 
4052 // This code originates from JDK&#39;s sysOpen and open64_w
4053 // from src/solaris/hpi/src/system_md.c
4054 
4055 int os::open(const char *path, int oflag, int mode) {
4056   if (strlen(path) &gt; MAX_PATH - 1) {
4057     errno = ENAMETOOLONG;
4058     return -1;
4059   }
4060   int fd;
4061 
4062   fd = ::open64(path, oflag, mode);
4063   if (fd == -1) return -1;
4064 
4065   // If the open succeeded, the file might still be a directory
4066   {
4067     struct stat64 buf64;
4068     int ret = ::fstat64(fd, &amp;buf64);
4069     int st_mode = buf64.st_mode;
4070 
4071     if (ret != -1) {
4072       if ((st_mode &amp; S_IFMT) == S_IFDIR) {
4073         errno = EISDIR;
4074         ::close(fd);
4075         return -1;
4076       }
4077     } else {
4078       ::close(fd);
4079       return -1;
4080     }
4081   }
4082 
4083   // 32-bit Solaris systems suffer from:
4084   //
4085   // - an historical default soft limit of 256 per-process file
4086   //   descriptors that is too low for many Java programs.
4087   //
4088   // - a design flaw where file descriptors created using stdio
4089   //   fopen must be less than 256, _even_ when the first limit above
4090   //   has been raised.  This can cause calls to fopen (but not calls to
4091   //   open, for example) to fail mysteriously, perhaps in 3rd party
4092   //   native code (although the JDK itself uses fopen).  One can hardly
4093   //   criticize them for using this most standard of all functions.
4094   //
4095   // We attempt to make everything work anyways by:
4096   //
4097   // - raising the soft limit on per-process file descriptors beyond
4098   //   256
4099   //
4100   // - As of Solaris 10u4, we can request that Solaris raise the 256
4101   //   stdio fopen limit by calling function enable_extended_FILE_stdio.
4102   //   This is done in init_2 and recorded in enabled_extended_FILE_stdio
4103   //
4104   // - If we are stuck on an old (pre 10u4) Solaris system, we can
4105   //   workaround the bug by remapping non-stdio file descriptors below
4106   //   256 to ones beyond 256, which is done below.
4107   //
4108   // See:
4109   // 1085341: 32-bit stdio routines should support file descriptors &gt;255
4110   // 6533291: Work around 32-bit Solaris stdio limit of 256 open files
4111   // 6431278: Netbeans crash on 32 bit Solaris: need to call
4112   //          enable_extended_FILE_stdio() in VM initialisation
4113   // Giri Mandalika&#39;s blog
4114   // http://technopark02.blogspot.com/2005_05_01_archive.html
4115   //
4116 #ifndef  _LP64
4117   if ((!enabled_extended_FILE_stdio) &amp;&amp; fd &lt; 256) {
4118     int newfd = ::fcntl(fd, F_DUPFD, 256);
4119     if (newfd != -1) {
4120       ::close(fd);
4121       fd = newfd;
4122     }
4123   }
4124 #endif // 32-bit Solaris
4125 
4126   // All file descriptors that are opened in the JVM and not
4127   // specifically destined for a subprocess should have the
4128   // close-on-exec flag set.  If we don&#39;t set it, then careless 3rd
4129   // party native code might fork and exec without closing all
4130   // appropriate file descriptors (e.g. as we do in closeDescriptors in
4131   // UNIXProcess.c), and this in turn might:
4132   //
4133   // - cause end-of-file to fail to be detected on some file
4134   //   descriptors, resulting in mysterious hangs, or
4135   //
4136   // - might cause an fopen in the subprocess to fail on a system
4137   //   suffering from bug 1085341.
4138   //
4139   // (Yes, the default setting of the close-on-exec flag is a Unix
4140   // design flaw)
4141   //
4142   // See:
4143   // 1085341: 32-bit stdio routines should support file descriptors &gt;255
4144   // 4843136: (process) pipe file descriptor from Runtime.exec not being closed
4145   // 6339493: (process) Runtime.exec does not close all file descriptors on Solaris 9
4146   //
4147 #ifdef FD_CLOEXEC
4148   {
4149     int flags = ::fcntl(fd, F_GETFD);
4150     if (flags != -1) {
4151       ::fcntl(fd, F_SETFD, flags | FD_CLOEXEC);
4152     }
4153   }
4154 #endif
4155 
4156   return fd;
4157 }
4158 
4159 // create binary file, rewriting existing file if required
4160 int os::create_binary_file(const char* path, bool rewrite_existing) {
4161   int oflags = O_WRONLY | O_CREAT;
4162   if (!rewrite_existing) {
4163     oflags |= O_EXCL;
4164   }
4165   return ::open64(path, oflags, S_IREAD | S_IWRITE);
4166 }
4167 
4168 // return current position of file pointer
4169 jlong os::current_file_offset(int fd) {
4170   return (jlong)::lseek64(fd, (off64_t)0, SEEK_CUR);
4171 }
4172 
4173 // move file pointer to the specified offset
4174 jlong os::seek_to_file_offset(int fd, jlong offset) {
4175   return (jlong)::lseek64(fd, (off64_t)offset, SEEK_SET);
4176 }
4177 
4178 jlong os::lseek(int fd, jlong offset, int whence) {
4179   return (jlong) ::lseek64(fd, offset, whence);
4180 }
4181 
4182 int os::ftruncate(int fd, jlong length) {
4183   return ::ftruncate64(fd, length);
4184 }
4185 
4186 int os::fsync(int fd)  {
4187   RESTARTABLE_RETURN_INT(::fsync(fd));
4188 }
4189 
4190 int os::available(int fd, jlong *bytes) {
4191   assert(((JavaThread*)Thread::current())-&gt;thread_state() == _thread_in_native,
4192          &quot;Assumed _thread_in_native&quot;);
4193   jlong cur, end;
4194   int mode;
4195   struct stat64 buf64;
4196 
4197   if (::fstat64(fd, &amp;buf64) &gt;= 0) {
4198     mode = buf64.st_mode;
4199     if (S_ISCHR(mode) || S_ISFIFO(mode) || S_ISSOCK(mode)) {
4200       int n,ioctl_return;
4201 
4202       RESTARTABLE(::ioctl(fd, FIONREAD, &amp;n), ioctl_return);
4203       if (ioctl_return&gt;= 0) {
4204         *bytes = n;
4205         return 1;
4206       }
4207     }
4208   }
4209   if ((cur = ::lseek64(fd, 0L, SEEK_CUR)) == -1) {
4210     return 0;
4211   } else if ((end = ::lseek64(fd, 0L, SEEK_END)) == -1) {
4212     return 0;
4213   } else if (::lseek64(fd, cur, SEEK_SET) == -1) {
4214     return 0;
4215   }
4216   *bytes = end - cur;
4217   return 1;
4218 }
4219 
4220 // Map a block of memory.
4221 char* os::pd_map_memory(int fd, const char* file_name, size_t file_offset,
4222                         char *addr, size_t bytes, bool read_only,
4223                         bool allow_exec) {
4224   int prot;
4225   int flags;
4226 
4227   if (read_only) {
4228     prot = PROT_READ;
4229     flags = MAP_SHARED;
4230   } else {
4231     prot = PROT_READ | PROT_WRITE;
4232     flags = MAP_PRIVATE;
4233   }
4234 
4235   if (allow_exec) {
4236     prot |= PROT_EXEC;
4237   }
4238 
4239   if (addr != NULL) {
4240     flags |= MAP_FIXED;
4241   }
4242 
4243   char* mapped_address = (char*)mmap(addr, (size_t)bytes, prot, flags,
4244                                      fd, file_offset);
4245   if (mapped_address == MAP_FAILED) {
4246     return NULL;
4247   }
4248   return mapped_address;
4249 }
4250 
4251 
4252 // Remap a block of memory.
4253 char* os::pd_remap_memory(int fd, const char* file_name, size_t file_offset,
4254                           char *addr, size_t bytes, bool read_only,
4255                           bool allow_exec) {
4256   // same as map_memory() on this OS
4257   return os::map_memory(fd, file_name, file_offset, addr, bytes, read_only,
4258                         allow_exec);
4259 }
4260 
4261 
4262 // Unmap a block of memory.
4263 bool os::pd_unmap_memory(char* addr, size_t bytes) {
4264   return munmap(addr, bytes) == 0;
4265 }
4266 
4267 void os::pause() {
4268   char filename[MAX_PATH];
4269   if (PauseAtStartupFile &amp;&amp; PauseAtStartupFile[0]) {
4270     jio_snprintf(filename, MAX_PATH, &quot;%s&quot;, PauseAtStartupFile);
4271   } else {
4272     jio_snprintf(filename, MAX_PATH, &quot;./vm.paused.%d&quot;, current_process_id());
4273   }
4274 
4275   int fd = ::open(filename, O_WRONLY | O_CREAT | O_TRUNC, 0666);
4276   if (fd != -1) {
4277     struct stat buf;
4278     ::close(fd);
4279     while (::stat(filename, &amp;buf) == 0) {
4280       (void)::poll(NULL, 0, 100);
4281     }
4282   } else {
4283     jio_fprintf(stderr,
4284                 &quot;Could not open pause file &#39;%s&#39;, continuing immediately.\n&quot;, filename);
4285   }
4286 }
4287 
4288 #ifndef PRODUCT
4289 #ifdef INTERPOSE_ON_SYSTEM_SYNCH_FUNCTIONS
4290 // Turn this on if you need to trace synch operations.
4291 // Set RECORD_SYNCH_LIMIT to a large-enough value,
4292 // and call record_synch_enable and record_synch_disable
4293 // around the computation of interest.
4294 
4295 void record_synch(char* name, bool returning);  // defined below
4296 
4297 class RecordSynch {
4298   char* _name;
4299  public:
4300   RecordSynch(char* name) :_name(name) { record_synch(_name, false); }
4301   ~RecordSynch()                       { record_synch(_name, true); }
4302 };
4303 
4304 #define CHECK_SYNCH_OP(ret, name, params, args, inner)          \
4305 extern &quot;C&quot; ret name params {                                    \
4306   typedef ret name##_t params;                                  \
4307   static name##_t* implem = NULL;                               \
4308   static int callcount = 0;                                     \
4309   if (implem == NULL) {                                         \
4310     implem = (name##_t*) dlsym(RTLD_NEXT, #name);               \
4311     if (implem == NULL)  fatal(dlerror());                      \
4312   }                                                             \
4313   ++callcount;                                                  \
4314   RecordSynch _rs(#name);                                       \
4315   inner;                                                        \
4316   return implem args;                                           \
4317 }
4318 // in dbx, examine callcounts this way:
4319 // for n in $(eval whereis callcount | awk &#39;{print $2}&#39;); do print $n; done
4320 
4321 #define CHECK_POINTER_OK(p) \
4322   (!Universe::is_fully_initialized() || !Universe::is_reserved_heap((oop)(p)))
4323 #define CHECK_MU \
4324   if (!CHECK_POINTER_OK(mu)) fatal(&quot;Mutex must be in C heap only.&quot;);
4325 #define CHECK_CV \
4326   if (!CHECK_POINTER_OK(cv)) fatal(&quot;Condvar must be in C heap only.&quot;);
4327 #define CHECK_P(p) \
4328   if (!CHECK_POINTER_OK(p))  fatal(false,  &quot;Pointer must be in C heap only.&quot;);
4329 
4330 #define CHECK_MUTEX(mutex_op) \
4331   CHECK_SYNCH_OP(int, mutex_op, (mutex_t *mu), (mu), CHECK_MU);
4332 
4333 CHECK_MUTEX(   mutex_lock)
4334 CHECK_MUTEX(  _mutex_lock)
4335 CHECK_MUTEX( mutex_unlock)
4336 CHECK_MUTEX(_mutex_unlock)
4337 CHECK_MUTEX( mutex_trylock)
4338 CHECK_MUTEX(_mutex_trylock)
4339 
4340 #define CHECK_COND(cond_op) \
4341   CHECK_SYNCH_OP(int, cond_op, (cond_t *cv, mutex_t *mu), (cv, mu), CHECK_MU; CHECK_CV);
4342 
4343 CHECK_COND( cond_wait);
4344 CHECK_COND(_cond_wait);
4345 CHECK_COND(_cond_wait_cancel);
4346 
4347 #define CHECK_COND2(cond_op) \
4348   CHECK_SYNCH_OP(int, cond_op, (cond_t *cv, mutex_t *mu, timestruc_t* ts), (cv, mu, ts), CHECK_MU; CHECK_CV);
4349 
4350 CHECK_COND2( cond_timedwait);
4351 CHECK_COND2(_cond_timedwait);
4352 CHECK_COND2(_cond_timedwait_cancel);
4353 
4354 // do the _lwp_* versions too
4355 #define mutex_t lwp_mutex_t
4356 #define cond_t  lwp_cond_t
4357 CHECK_MUTEX(  _lwp_mutex_lock)
4358 CHECK_MUTEX(  _lwp_mutex_unlock)
4359 CHECK_MUTEX(  _lwp_mutex_trylock)
4360 CHECK_MUTEX( __lwp_mutex_lock)
4361 CHECK_MUTEX( __lwp_mutex_unlock)
4362 CHECK_MUTEX( __lwp_mutex_trylock)
4363 CHECK_MUTEX(___lwp_mutex_lock)
4364 CHECK_MUTEX(___lwp_mutex_unlock)
4365 
4366 CHECK_COND(  _lwp_cond_wait);
4367 CHECK_COND( __lwp_cond_wait);
4368 CHECK_COND(___lwp_cond_wait);
4369 
4370 CHECK_COND2(  _lwp_cond_timedwait);
4371 CHECK_COND2( __lwp_cond_timedwait);
4372 #undef mutex_t
4373 #undef cond_t
4374 
4375 CHECK_SYNCH_OP(int, _lwp_suspend2,       (int lwp, int *n), (lwp, n), 0);
4376 CHECK_SYNCH_OP(int,__lwp_suspend2,       (int lwp, int *n), (lwp, n), 0);
4377 CHECK_SYNCH_OP(int, _lwp_kill,           (int lwp, int n),  (lwp, n), 0);
4378 CHECK_SYNCH_OP(int,__lwp_kill,           (int lwp, int n),  (lwp, n), 0);
4379 CHECK_SYNCH_OP(int, _lwp_sema_wait,      (lwp_sema_t* p),   (p),  CHECK_P(p));
4380 CHECK_SYNCH_OP(int,__lwp_sema_wait,      (lwp_sema_t* p),   (p),  CHECK_P(p));
4381 CHECK_SYNCH_OP(int, _lwp_cond_broadcast, (lwp_cond_t* cv),  (cv), CHECK_CV);
4382 CHECK_SYNCH_OP(int,__lwp_cond_broadcast, (lwp_cond_t* cv),  (cv), CHECK_CV);
4383 
4384 
4385 // recording machinery:
4386 
4387 enum { RECORD_SYNCH_LIMIT = 200 };
4388 char* record_synch_name[RECORD_SYNCH_LIMIT];
4389 void* record_synch_arg0ptr[RECORD_SYNCH_LIMIT];
4390 bool record_synch_returning[RECORD_SYNCH_LIMIT];
4391 thread_t record_synch_thread[RECORD_SYNCH_LIMIT];
4392 int record_synch_count = 0;
4393 bool record_synch_enabled = false;
4394 
4395 // in dbx, examine recorded data this way:
4396 // for n in name arg0ptr returning thread; do print record_synch_$n[0..record_synch_count-1]; done
4397 
4398 void record_synch(char* name, bool returning) {
4399   if (record_synch_enabled) {
4400     if (record_synch_count &lt; RECORD_SYNCH_LIMIT) {
4401       record_synch_name[record_synch_count] = name;
4402       record_synch_returning[record_synch_count] = returning;
4403       record_synch_thread[record_synch_count] = thr_self();
4404       record_synch_arg0ptr[record_synch_count] = &amp;name;
4405       record_synch_count++;
4406     }
4407     // put more checking code here:
4408     // ...
4409   }
4410 }
4411 
4412 void record_synch_enable() {
4413   // start collecting trace data, if not already doing so
4414   if (!record_synch_enabled)  record_synch_count = 0;
4415   record_synch_enabled = true;
4416 }
4417 
4418 void record_synch_disable() {
4419   // stop collecting trace data
4420   record_synch_enabled = false;
4421 }
4422 
4423 #endif // INTERPOSE_ON_SYSTEM_SYNCH_FUNCTIONS
4424 #endif // PRODUCT
4425 
4426 const intptr_t thr_time_off  = (intptr_t)(&amp;((prusage_t *)(NULL))-&gt;pr_utime);
4427 const intptr_t thr_time_size = (intptr_t)(&amp;((prusage_t *)(NULL))-&gt;pr_ttime) -
4428                                (intptr_t)(&amp;((prusage_t *)(NULL))-&gt;pr_utime);
4429 
4430 
4431 // JVMTI &amp; JVM monitoring and management support
4432 // The thread_cpu_time() and current_thread_cpu_time() are only
4433 // supported if is_thread_cpu_time_supported() returns true.
4434 // They are not supported on Solaris T1.
4435 
4436 // current_thread_cpu_time(bool) and thread_cpu_time(Thread*, bool)
4437 // are used by JVM M&amp;M and JVMTI to get user+sys or user CPU time
4438 // of a thread.
4439 //
4440 // current_thread_cpu_time() and thread_cpu_time(Thread *)
4441 // returns the fast estimate available on the platform.
4442 
4443 // hrtime_t gethrvtime() return value includes
4444 // user time but does not include system time
4445 jlong os::current_thread_cpu_time() {
4446   return (jlong) gethrvtime();
4447 }
4448 
4449 jlong os::thread_cpu_time(Thread *thread) {
4450   // return user level CPU time only to be consistent with
4451   // what current_thread_cpu_time returns.
4452   // thread_cpu_time_info() must be changed if this changes
4453   return os::thread_cpu_time(thread, false /* user time only */);
4454 }
4455 
4456 jlong os::current_thread_cpu_time(bool user_sys_cpu_time) {
4457   if (user_sys_cpu_time) {
4458     return os::thread_cpu_time(Thread::current(), user_sys_cpu_time);
4459   } else {
4460     return os::current_thread_cpu_time();
4461   }
4462 }
4463 
4464 jlong os::thread_cpu_time(Thread *thread, bool user_sys_cpu_time) {
4465   char proc_name[64];
4466   int count;
4467   prusage_t prusage;
4468   jlong lwp_time;
4469   int fd;
4470 
4471   sprintf(proc_name, &quot;/proc/%d/lwp/%d/lwpusage&quot;,
4472           getpid(),
4473           thread-&gt;osthread()-&gt;lwp_id());
4474   fd = ::open(proc_name, O_RDONLY);
4475   if (fd == -1) return -1;
4476 
4477   do {
4478     count = ::pread(fd,
4479                     (void *)&amp;prusage.pr_utime,
4480                     thr_time_size,
4481                     thr_time_off);
4482   } while (count &lt; 0 &amp;&amp; errno == EINTR);
4483   ::close(fd);
4484   if (count &lt; 0) return -1;
4485 
4486   if (user_sys_cpu_time) {
4487     // user + system CPU time
4488     lwp_time = (((jlong)prusage.pr_stime.tv_sec +
4489                  (jlong)prusage.pr_utime.tv_sec) * (jlong)1000000000) +
4490                  (jlong)prusage.pr_stime.tv_nsec +
4491                  (jlong)prusage.pr_utime.tv_nsec;
4492   } else {
4493     // user level CPU time only
4494     lwp_time = ((jlong)prusage.pr_utime.tv_sec * (jlong)1000000000) +
4495                 (jlong)prusage.pr_utime.tv_nsec;
4496   }
4497 
4498   return (lwp_time);
4499 }
4500 
4501 void os::current_thread_cpu_time_info(jvmtiTimerInfo *info_ptr) {
4502   info_ptr-&gt;max_value = ALL_64_BITS;      // will not wrap in less than 64 bits
4503   info_ptr-&gt;may_skip_backward = false;    // elapsed time not wall time
4504   info_ptr-&gt;may_skip_forward = false;     // elapsed time not wall time
4505   info_ptr-&gt;kind = JVMTI_TIMER_USER_CPU;  // only user time is returned
4506 }
4507 
4508 void os::thread_cpu_time_info(jvmtiTimerInfo *info_ptr) {
4509   info_ptr-&gt;max_value = ALL_64_BITS;      // will not wrap in less than 64 bits
4510   info_ptr-&gt;may_skip_backward = false;    // elapsed time not wall time
4511   info_ptr-&gt;may_skip_forward = false;     // elapsed time not wall time
4512   info_ptr-&gt;kind = JVMTI_TIMER_USER_CPU;  // only user time is returned
4513 }
4514 
4515 bool os::is_thread_cpu_time_supported() {
4516   return true;
4517 }
4518 
4519 // System loadavg support.  Returns -1 if load average cannot be obtained.
4520 // Return the load average for our processor set if the primitive exists
4521 // (Solaris 9 and later).  Otherwise just return system wide loadavg.
4522 int os::loadavg(double loadavg[], int nelem) {
4523   if (pset_getloadavg_ptr != NULL) {
4524     return (*pset_getloadavg_ptr)(PS_MYID, loadavg, nelem);
4525   } else {
4526     return ::getloadavg(loadavg, nelem);
4527   }
4528 }
4529 
4530 //---------------------------------------------------------------------------------
4531 
4532 bool os::find(address addr, outputStream* st) {
4533   Dl_info dlinfo;
4534   memset(&amp;dlinfo, 0, sizeof(dlinfo));
4535   if (dladdr(addr, &amp;dlinfo) != 0) {
4536     st-&gt;print(PTR_FORMAT &quot;: &quot;, addr);
4537     if (dlinfo.dli_sname != NULL &amp;&amp; dlinfo.dli_saddr != NULL) {
4538       st-&gt;print(&quot;%s+%#lx&quot;, dlinfo.dli_sname, addr-(intptr_t)dlinfo.dli_saddr);
4539     } else if (dlinfo.dli_fbase != NULL) {
4540       st-&gt;print(&quot;&lt;offset %#lx&gt;&quot;, addr-(intptr_t)dlinfo.dli_fbase);
4541     } else {
4542       st-&gt;print(&quot;&lt;absolute address&gt;&quot;);
4543     }
4544     if (dlinfo.dli_fname != NULL) {
4545       st-&gt;print(&quot; in %s&quot;, dlinfo.dli_fname);
4546     }
4547     if (dlinfo.dli_fbase != NULL) {
4548       st-&gt;print(&quot; at &quot; PTR_FORMAT, dlinfo.dli_fbase);
4549     }
4550     st-&gt;cr();
4551 
4552     if (Verbose) {
4553       // decode some bytes around the PC
4554       address begin = clamp_address_in_page(addr-40, addr, os::vm_page_size());
4555       address end   = clamp_address_in_page(addr+40, addr, os::vm_page_size());
4556       address       lowest = (address) dlinfo.dli_sname;
4557       if (!lowest)  lowest = (address) dlinfo.dli_fbase;
4558       if (begin &lt; lowest)  begin = lowest;
4559       Dl_info dlinfo2;
4560       if (dladdr(end, &amp;dlinfo2) != 0 &amp;&amp; dlinfo2.dli_saddr != dlinfo.dli_saddr
4561           &amp;&amp; end &gt; dlinfo2.dli_saddr &amp;&amp; dlinfo2.dli_saddr &gt; begin) {
4562         end = (address) dlinfo2.dli_saddr;
4563       }
4564       Disassembler::decode(begin, end, st);
4565     }
4566     return true;
4567   }
4568   return false;
4569 }
4570 
4571 // Following function has been added to support HotSparc&#39;s libjvm.so running
4572 // under Solaris production JDK 1.2.2 / 1.3.0.  These came from
4573 // src/solaris/hpi/native_threads in the EVM codebase.
4574 //
4575 // NOTE: This is no longer needed in the 1.3.1 and 1.4 production release
4576 // libraries and should thus be removed. We will leave it behind for a while
4577 // until we no longer want to able to run on top of 1.3.0 Solaris production
4578 // JDK. See 4341971.
4579 
4580 #define STACK_SLACK 0x800
4581 
4582 extern &quot;C&quot; {
4583   intptr_t sysThreadAvailableStackWithSlack() {
4584     stack_t st;
4585     intptr_t retval, stack_top;
4586     retval = thr_stksegment(&amp;st);
4587     assert(retval == 0, &quot;incorrect return value from thr_stksegment&quot;);
4588     assert((address)&amp;st &lt; (address)st.ss_sp, &quot;Invalid stack base returned&quot;);
4589     assert((address)&amp;st &gt; (address)st.ss_sp-st.ss_size, &quot;Invalid stack size returned&quot;);
4590     stack_top=(intptr_t)st.ss_sp-st.ss_size;
4591     return ((intptr_t)&amp;stack_top - stack_top - STACK_SLACK);
4592   }
4593 }
4594 
4595 // ObjectMonitor park-unpark infrastructure ...
4596 //
4597 // We implement Solaris and Linux PlatformEvents with the
4598 // obvious condvar-mutex-flag triple.
4599 // Another alternative that works quite well is pipes:
4600 // Each PlatformEvent consists of a pipe-pair.
4601 // The thread associated with the PlatformEvent
4602 // calls park(), which reads from the input end of the pipe.
4603 // Unpark() writes into the other end of the pipe.
4604 // The write-side of the pipe must be set NDELAY.
4605 // Unfortunately pipes consume a large # of handles.
4606 // Native solaris lwp_park() and lwp_unpark() work nicely, too.
4607 // Using pipes for the 1st few threads might be workable, however.
4608 //
4609 // park() is permitted to return spuriously.
4610 // Callers of park() should wrap the call to park() in
4611 // an appropriate loop.  A litmus test for the correct
4612 // usage of park is the following: if park() were modified
4613 // to immediately return 0 your code should still work,
4614 // albeit degenerating to a spin loop.
4615 //
4616 // In a sense, park()-unpark() just provides more polite spinning
4617 // and polling with the key difference over naive spinning being
4618 // that a parked thread needs to be explicitly unparked() in order
4619 // to wake up and to poll the underlying condition.
4620 //
4621 // Assumption:
4622 //    Only one parker can exist on an event, which is why we allocate
4623 //    them per-thread. Multiple unparkers can coexist.
4624 //
4625 // _Event transitions in park()
4626 //   -1 =&gt; -1 : illegal
4627 //    1 =&gt;  0 : pass - return immediately
4628 //    0 =&gt; -1 : block; then set _Event to 0 before returning
4629 //
4630 // _Event transitions in unpark()
4631 //    0 =&gt; 1 : just return
4632 //    1 =&gt; 1 : just return
4633 //   -1 =&gt; either 0 or 1; must signal target thread
4634 //         That is, we can safely transition _Event from -1 to either
4635 //         0 or 1.
4636 //
4637 // _Event serves as a restricted-range semaphore.
4638 //   -1 : thread is blocked, i.e. there is a waiter
4639 //    0 : neutral: thread is running or ready,
4640 //        could have been signaled after a wait started
4641 //    1 : signaled - thread is running or ready
4642 //
4643 // Another possible encoding of _Event would be with
4644 // explicit &quot;PARKED&quot; == 01b and &quot;SIGNALED&quot; == 10b bits.
4645 //
4646 // TODO-FIXME: add DTRACE probes for:
4647 // 1.   Tx parks
4648 // 2.   Ty unparks Tx
4649 // 3.   Tx resumes from park
4650 
4651 
4652 // value determined through experimentation
4653 #define ROUNDINGFIX 11
4654 
4655 // utility to compute the abstime argument to timedwait.
4656 // TODO-FIXME: switch from compute_abstime() to unpackTime().
4657 
4658 static timestruc_t* compute_abstime(timestruc_t* abstime, jlong millis) {
4659   // millis is the relative timeout time
4660   // abstime will be the absolute timeout time
4661   if (millis &lt; 0)  millis = 0;
4662   struct timeval now;
4663   int status = gettimeofday(&amp;now, NULL);
4664   assert(status == 0, &quot;gettimeofday&quot;);
4665   jlong seconds = millis / 1000;
4666   jlong max_wait_period;
4667 
4668   if (UseLWPSynchronization) {
4669     // forward port of fix for 4275818 (not sleeping long enough)
4670     // There was a bug in Solaris 6, 7 and pre-patch 5 of 8 where
4671     // _lwp_cond_timedwait() used a round_down algorithm rather
4672     // than a round_up. For millis less than our roundfactor
4673     // it rounded down to 0 which doesn&#39;t meet the spec.
4674     // For millis &gt; roundfactor we may return a bit sooner, but
4675     // since we can not accurately identify the patch level and
4676     // this has already been fixed in Solaris 9 and 8 we will
4677     // leave it alone rather than always rounding down.
4678 
4679     if (millis &gt; 0 &amp;&amp; millis &lt; ROUNDINGFIX) millis = ROUNDINGFIX;
4680     // It appears that when we go directly through Solaris _lwp_cond_timedwait()
4681     // the acceptable max time threshold is smaller than for libthread on 2.5.1 and 2.6
4682     max_wait_period = 21000000;
4683   } else {
4684     max_wait_period = 50000000;
4685   }
4686   millis %= 1000;
4687   if (seconds &gt; max_wait_period) {      // see man cond_timedwait(3T)
4688     seconds = max_wait_period;
4689   }
4690   abstime-&gt;tv_sec = now.tv_sec  + seconds;
4691   long       usec = now.tv_usec + millis * 1000;
4692   if (usec &gt;= 1000000) {
4693     abstime-&gt;tv_sec += 1;
4694     usec -= 1000000;
4695   }
4696   abstime-&gt;tv_nsec = usec * 1000;
4697   return abstime;
4698 }
4699 
4700 void os::PlatformEvent::park() {           // AKA: down()
4701   // Transitions for _Event:
4702   //   -1 =&gt; -1 : illegal
4703   //    1 =&gt;  0 : pass - return immediately
4704   //    0 =&gt; -1 : block; then set _Event to 0 before returning
4705 
4706   // Invariant: Only the thread associated with the Event/PlatformEvent
4707   // may call park().
4708   assert(_nParked == 0, &quot;invariant&quot;);
4709 
4710   int v;
4711   for (;;) {
4712     v = _Event;
4713     if (Atomic::cmpxchg(&amp;_Event, v, v-1) == v) break;
4714   }
4715   guarantee(v &gt;= 0, &quot;invariant&quot;);
4716   if (v == 0) {
4717     // Do this the hard way by blocking ...
4718     // See http://monaco.sfbay/detail.jsf?cr=5094058.
4719     int status = os::Solaris::mutex_lock(_mutex);
4720     assert_status(status == 0, status, &quot;mutex_lock&quot;);
4721     guarantee(_nParked == 0, &quot;invariant&quot;);
4722     ++_nParked;
4723     while (_Event &lt; 0) {
4724       // for some reason, under 2.7 lwp_cond_wait() may return ETIME ...
4725       // Treat this the same as if the wait was interrupted
4726       // With usr/lib/lwp going to kernel, always handle ETIME
4727       status = os::Solaris::cond_wait(_cond, _mutex);
4728       if (status == ETIME) status = EINTR;
4729       assert_status(status == 0 || status == EINTR, status, &quot;cond_wait&quot;);
4730     }
4731     --_nParked;
4732     _Event = 0;
4733     status = os::Solaris::mutex_unlock(_mutex);
4734     assert_status(status == 0, status, &quot;mutex_unlock&quot;);
4735     // Paranoia to ensure our locked and lock-free paths interact
4736     // correctly with each other.
4737     OrderAccess::fence();
4738   }
4739 }
4740 
4741 int os::PlatformEvent::park(jlong millis) {
4742   // Transitions for _Event:
4743   //   -1 =&gt; -1 : illegal
4744   //    1 =&gt;  0 : pass - return immediately
4745   //    0 =&gt; -1 : block; then set _Event to 0 before returning
4746 
4747   guarantee(_nParked == 0, &quot;invariant&quot;);
4748   int v;
4749   for (;;) {
4750     v = _Event;
4751     if (Atomic::cmpxchg(&amp;_Event, v, v-1) == v) break;
4752   }
4753   guarantee(v &gt;= 0, &quot;invariant&quot;);
4754   if (v != 0) return OS_OK;
4755 
4756   int ret = OS_TIMEOUT;
4757   timestruc_t abst;
4758   compute_abstime(&amp;abst, millis);
4759 
4760   // See http://monaco.sfbay/detail.jsf?cr=5094058.
4761   int status = os::Solaris::mutex_lock(_mutex);
4762   assert_status(status == 0, status, &quot;mutex_lock&quot;);
4763   guarantee(_nParked == 0, &quot;invariant&quot;);
4764   ++_nParked;
4765   while (_Event &lt; 0) {
4766     int status = os::Solaris::cond_timedwait(_cond, _mutex, &amp;abst);
4767     assert_status(status == 0 || status == EINTR ||
4768                   status == ETIME || status == ETIMEDOUT,
4769                   status, &quot;cond_timedwait&quot;);
4770     if (!FilterSpuriousWakeups) break;                // previous semantics
4771     if (status == ETIME || status == ETIMEDOUT) break;
4772     // We consume and ignore EINTR and spurious wakeups.
4773   }
4774   --_nParked;
4775   if (_Event &gt;= 0) ret = OS_OK;
4776   _Event = 0;
4777   status = os::Solaris::mutex_unlock(_mutex);
4778   assert_status(status == 0, status, &quot;mutex_unlock&quot;);
4779   // Paranoia to ensure our locked and lock-free paths interact
4780   // correctly with each other.
4781   OrderAccess::fence();
4782   return ret;
4783 }
4784 
4785 void os::PlatformEvent::unpark() {
4786   // Transitions for _Event:
4787   //    0 =&gt; 1 : just return
4788   //    1 =&gt; 1 : just return
4789   //   -1 =&gt; either 0 or 1; must signal target thread
4790   //         That is, we can safely transition _Event from -1 to either
4791   //         0 or 1.
4792   // See also: &quot;Semaphores in Plan 9&quot; by Mullender &amp; Cox
4793   //
4794   // Note: Forcing a transition from &quot;-1&quot; to &quot;1&quot; on an unpark() means
4795   // that it will take two back-to-back park() calls for the owning
4796   // thread to block. This has the benefit of forcing a spurious return
4797   // from the first park() call after an unpark() call which will help
4798   // shake out uses of park() and unpark() without condition variables.
4799 
4800   if (Atomic::xchg(&amp;_Event, 1) &gt;= 0) return;
4801 
4802   // If the thread associated with the event was parked, wake it.
4803   // Wait for the thread assoc with the PlatformEvent to vacate.
4804   int status = os::Solaris::mutex_lock(_mutex);
4805   assert_status(status == 0, status, &quot;mutex_lock&quot;);
4806   int AnyWaiters = _nParked;
4807   status = os::Solaris::mutex_unlock(_mutex);
4808   assert_status(status == 0, status, &quot;mutex_unlock&quot;);
4809   guarantee(AnyWaiters == 0 || AnyWaiters == 1, &quot;invariant&quot;);
4810   if (AnyWaiters != 0) {
4811     // Note that we signal() *after* dropping the lock for &quot;immortal&quot; Events.
4812     // This is safe and avoids a common class of  futile wakeups.  In rare
4813     // circumstances this can cause a thread to return prematurely from
4814     // cond_{timed}wait() but the spurious wakeup is benign and the victim
4815     // will simply re-test the condition and re-park itself.
4816     // This provides particular benefit if the underlying platform does not
4817     // provide wait morphing.
4818     status = os::Solaris::cond_signal(_cond);
4819     assert_status(status == 0, status, &quot;cond_signal&quot;);
4820   }
4821 }
4822 
4823 // JSR166
4824 // -------------------------------------------------------
4825 
4826 // The solaris and linux implementations of park/unpark are fairly
4827 // conservative for now, but can be improved. They currently use a
4828 // mutex/condvar pair, plus _counter.
4829 // Park decrements _counter if &gt; 0, else does a condvar wait.  Unpark
4830 // sets count to 1 and signals condvar.  Only one thread ever waits
4831 // on the condvar. Contention seen when trying to park implies that someone
4832 // is unparking you, so don&#39;t wait. And spurious returns are fine, so there
4833 // is no need to track notifications.
4834 
4835 #define MAX_SECS 100000000
4836 
4837 // This code is common to linux and solaris and will be moved to a
4838 // common place in dolphin.
4839 //
4840 // The passed in time value is either a relative time in nanoseconds
4841 // or an absolute time in milliseconds. Either way it has to be unpacked
4842 // into suitable seconds and nanoseconds components and stored in the
4843 // given timespec structure.
4844 // Given time is a 64-bit value and the time_t used in the timespec is only
4845 // a signed-32-bit value (except on 64-bit Linux) we have to watch for
4846 // overflow if times way in the future are given. Further on Solaris versions
4847 // prior to 10 there is a restriction (see cond_timedwait) that the specified
4848 // number of seconds, in abstime, is less than current_time  + 100,000,000.
4849 // As it will be 28 years before &quot;now + 100000000&quot; will overflow we can
4850 // ignore overflow and just impose a hard-limit on seconds using the value
4851 // of &quot;now + 100,000,000&quot;. This places a limit on the timeout of about 3.17
4852 // years from &quot;now&quot;.
4853 //
4854 static void unpackTime(timespec* absTime, bool isAbsolute, jlong time) {
4855   assert(time &gt; 0, &quot;convertTime&quot;);
4856 
4857   struct timeval now;
4858   int status = gettimeofday(&amp;now, NULL);
4859   assert(status == 0, &quot;gettimeofday&quot;);
4860 
4861   time_t max_secs = now.tv_sec + MAX_SECS;
4862 
4863   if (isAbsolute) {
4864     jlong secs = time / 1000;
4865     if (secs &gt; max_secs) {
4866       absTime-&gt;tv_sec = max_secs;
4867     } else {
4868       absTime-&gt;tv_sec = secs;
4869     }
4870     absTime-&gt;tv_nsec = (time % 1000) * NANOSECS_PER_MILLISEC;
4871   } else {
4872     jlong secs = time / NANOSECS_PER_SEC;
4873     if (secs &gt;= MAX_SECS) {
4874       absTime-&gt;tv_sec = max_secs;
4875       absTime-&gt;tv_nsec = 0;
4876     } else {
4877       absTime-&gt;tv_sec = now.tv_sec + secs;
4878       absTime-&gt;tv_nsec = (time % NANOSECS_PER_SEC) + now.tv_usec*1000;
4879       if (absTime-&gt;tv_nsec &gt;= NANOSECS_PER_SEC) {
4880         absTime-&gt;tv_nsec -= NANOSECS_PER_SEC;
4881         ++absTime-&gt;tv_sec; // note: this must be &lt;= max_secs
4882       }
4883     }
4884   }
4885   assert(absTime-&gt;tv_sec &gt;= 0, &quot;tv_sec &lt; 0&quot;);
4886   assert(absTime-&gt;tv_sec &lt;= max_secs, &quot;tv_sec &gt; max_secs&quot;);
4887   assert(absTime-&gt;tv_nsec &gt;= 0, &quot;tv_nsec &lt; 0&quot;);
4888   assert(absTime-&gt;tv_nsec &lt; NANOSECS_PER_SEC, &quot;tv_nsec &gt;= nanos_per_sec&quot;);
4889 }
4890 
4891 void Parker::park(bool isAbsolute, jlong time) {
4892   // Ideally we&#39;d do something useful while spinning, such
4893   // as calling unpackTime().
4894 
4895   // Optional fast-path check:
4896   // Return immediately if a permit is available.
4897   // We depend on Atomic::xchg() having full barrier semantics
4898   // since we are doing a lock-free update to _counter.
4899   if (Atomic::xchg(&amp;_counter, 0) &gt; 0) return;
4900 
4901   // Optional fast-exit: Check interrupt before trying to wait
4902   Thread* thread = Thread::current();
4903   assert(thread-&gt;is_Java_thread(), &quot;Must be JavaThread&quot;);
4904   JavaThread *jt = (JavaThread *)thread;
4905   if (jt-&gt;is_interrupted(false)) {
4906     return;
4907   }
4908 
4909   // First, demultiplex/decode time arguments
4910   timespec absTime;
4911   if (time &lt; 0 || (isAbsolute &amp;&amp; time == 0)) { // don&#39;t wait at all
4912     return;
4913   }
4914   if (time &gt; 0) {
4915     // Warning: this code might be exposed to the old Solaris time
4916     // round-down bugs.  Grep &quot;roundingFix&quot; for details.
4917     unpackTime(&amp;absTime, isAbsolute, time);
4918   }
4919 
4920   // Enter safepoint region
4921   // Beware of deadlocks such as 6317397.
4922   // The per-thread Parker:: _mutex is a classic leaf-lock.
4923   // In particular a thread must never block on the Threads_lock while
4924   // holding the Parker:: mutex.  If safepoints are pending both the
4925   // the ThreadBlockInVM() CTOR and DTOR may grab Threads_lock.
4926   ThreadBlockInVM tbivm(jt);
4927 
4928   // Can&#39;t access interrupt state now that we are _thread_blocked. If we&#39;ve
4929   // been interrupted since we checked above then _counter will be &gt; 0.
4930 
4931   // Don&#39;t wait if cannot get lock since interference arises from
4932   // unblocking.
4933   if (os::Solaris::mutex_trylock(_mutex) != 0) {
4934     return;
4935   }
4936 
4937   int status;
4938 
4939   if (_counter &gt; 0)  { // no wait needed
4940     _counter = 0;
4941     status = os::Solaris::mutex_unlock(_mutex);
4942     assert(status == 0, &quot;invariant&quot;);
4943     // Paranoia to ensure our locked and lock-free paths interact
4944     // correctly with each other and Java-level accesses.
4945     OrderAccess::fence();
4946     return;
4947   }
4948 
4949   OSThreadWaitState osts(thread-&gt;osthread(), false /* not Object.wait() */);
4950   jt-&gt;set_suspend_equivalent();
4951   // cleared by handle_special_suspend_equivalent_condition() or java_suspend_self()
4952 
4953   // Do this the hard way by blocking ...
4954   // See http://monaco.sfbay/detail.jsf?cr=5094058.
4955   if (time == 0) {
4956     status = os::Solaris::cond_wait(_cond, _mutex);
4957   } else {
4958     status = os::Solaris::cond_timedwait (_cond, _mutex, &amp;absTime);
4959   }
4960   // Note that an untimed cond_wait() can sometimes return ETIME on older
4961   // versions of the Solaris.
4962   assert_status(status == 0 || status == EINTR ||
4963                 status == ETIME || status == ETIMEDOUT,
4964                 status, &quot;cond_timedwait&quot;);
4965 
4966   _counter = 0;
4967   status = os::Solaris::mutex_unlock(_mutex);
4968   assert_status(status == 0, status, &quot;mutex_unlock&quot;);
4969   // Paranoia to ensure our locked and lock-free paths interact
4970   // correctly with each other and Java-level accesses.
4971   OrderAccess::fence();
4972 
4973   // If externally suspended while waiting, re-suspend
4974   if (jt-&gt;handle_special_suspend_equivalent_condition()) {
4975     jt-&gt;java_suspend_self();
4976   }
4977 }
4978 
4979 void Parker::unpark() {
4980   int status = os::Solaris::mutex_lock(_mutex);
4981   assert(status == 0, &quot;invariant&quot;);
4982   const int s = _counter;
4983   _counter = 1;
4984   status = os::Solaris::mutex_unlock(_mutex);
4985   assert(status == 0, &quot;invariant&quot;);
4986 
4987   if (s &lt; 1) {
4988     status = os::Solaris::cond_signal(_cond);
4989     assert(status == 0, &quot;invariant&quot;);
4990   }
4991 }
4992 
4993 // Platform Mutex/Monitor implementations
4994 
4995 os::PlatformMutex::PlatformMutex() {
4996   int status = os::Solaris::mutex_init(&amp;_mutex);
4997   assert_status(status == 0, status, &quot;mutex_init&quot;);
4998 }
4999 
5000 os::PlatformMutex::~PlatformMutex() {
5001   int status = os::Solaris::mutex_destroy(&amp;_mutex);
5002   assert_status(status == 0, status, &quot;mutex_destroy&quot;);
5003 }
5004 
5005 void os::PlatformMutex::lock() {
5006   int status = os::Solaris::mutex_lock(&amp;_mutex);
5007   assert_status(status == 0, status, &quot;mutex_lock&quot;);
5008 }
5009 
5010 void os::PlatformMutex::unlock() {
5011   int status = os::Solaris::mutex_unlock(&amp;_mutex);
5012   assert_status(status == 0, status, &quot;mutex_unlock&quot;);
5013 }
5014 
5015 bool os::PlatformMutex::try_lock() {
5016   int status = os::Solaris::mutex_trylock(&amp;_mutex);
5017   assert_status(status == 0 || status == EBUSY, status, &quot;mutex_trylock&quot;);
5018   return status == 0;
5019 }
5020 
5021 os::PlatformMonitor::PlatformMonitor() {
5022   int status = os::Solaris::cond_init(&amp;_cond);
5023   assert_status(status == 0, status, &quot;cond_init&quot;);
5024 }
5025 
5026 os::PlatformMonitor::~PlatformMonitor() {
5027   int status = os::Solaris::cond_destroy(&amp;_cond);
5028   assert_status(status == 0, status, &quot;cond_destroy&quot;);
5029 }
5030 
5031 // Must already be locked
5032 int os::PlatformMonitor::wait(jlong millis) {
5033   assert(millis &gt;= 0, &quot;negative timeout&quot;);
5034   if (millis &gt; 0) {
5035     timestruc_t abst;
5036     int ret = OS_TIMEOUT;
5037     compute_abstime(&amp;abst, millis);
5038     int status = os::Solaris::cond_timedwait(&amp;_cond, &amp;_mutex, &amp;abst);
5039     assert_status(status == 0 || status == EINTR ||
5040                   status == ETIME || status == ETIMEDOUT,
5041                   status, &quot;cond_timedwait&quot;);
5042     // EINTR acts as spurious wakeup - which is permitted anyway
5043     if (status == 0 || status == EINTR) {
5044       ret = OS_OK;
5045     }
5046     return ret;
5047   } else {
5048     int status = os::Solaris::cond_wait(&amp;_cond, &amp;_mutex);
5049     assert_status(status == 0 || status == EINTR,
5050                   status, &quot;cond_wait&quot;);
5051     return OS_OK;
5052   }
5053 }
5054 
5055 void os::PlatformMonitor::notify() {
5056   int status = os::Solaris::cond_signal(&amp;_cond);
5057   assert_status(status == 0, status, &quot;cond_signal&quot;);
5058 }
5059 
5060 void os::PlatformMonitor::notify_all() {
5061   int status = os::Solaris::cond_broadcast(&amp;_cond);
5062   assert_status(status == 0, status, &quot;cond_broadcast&quot;);
5063 }
5064 
5065 extern char** environ;
5066 
5067 // Run the specified command in a separate process. Return its exit value,
5068 // or -1 on failure (e.g. can&#39;t fork a new process).
5069 // Unlike system(), this function can be called from signal handler. It
5070 // doesn&#39;t block SIGINT et al.
5071 int os::fork_and_exec(char* cmd, bool use_vfork_if_available) {
5072   char * argv[4];
5073   argv[0] = (char *)&quot;sh&quot;;
5074   argv[1] = (char *)&quot;-c&quot;;
5075   argv[2] = cmd;
5076   argv[3] = NULL;
5077 
5078   // fork is async-safe, fork1 is not so can&#39;t use in signal handler
5079   pid_t pid;
5080   Thread* t = Thread::current_or_null_safe();
5081   if (t != NULL &amp;&amp; t-&gt;is_inside_signal_handler()) {
5082     pid = fork();
5083   } else {
5084     pid = fork1();
5085   }
5086 
5087   if (pid &lt; 0) {
5088     // fork failed
5089     warning(&quot;fork failed: %s&quot;, os::strerror(errno));
5090     return -1;
5091 
5092   } else if (pid == 0) {
5093     // child process
5094 
5095     // try to be consistent with system(), which uses &quot;/usr/bin/sh&quot; on Solaris
5096     execve(&quot;/usr/bin/sh&quot;, argv, environ);
5097 
5098     // execve failed
5099     _exit(-1);
5100 
5101   } else  {
5102     // copied from J2SE ..._waitForProcessExit() in UNIXProcess_md.c; we don&#39;t
5103     // care about the actual exit code, for now.
5104 
5105     int status;
5106 
5107     // Wait for the child process to exit.  This returns immediately if
5108     // the child has already exited. */
5109     while (waitpid(pid, &amp;status, 0) &lt; 0) {
5110       switch (errno) {
5111       case ECHILD: return 0;
5112       case EINTR: break;
5113       default: return -1;
5114       }
5115     }
5116 
5117     if (WIFEXITED(status)) {
5118       // The child exited normally; get its exit code.
5119       return WEXITSTATUS(status);
5120     } else if (WIFSIGNALED(status)) {
5121       // The child exited because of a signal
5122       // The best value to return is 0x80 + signal number,
5123       // because that is what all Unix shells do, and because
5124       // it allows callers to distinguish between process exit and
5125       // process death by signal.
5126       return 0x80 + WTERMSIG(status);
5127     } else {
5128       // Unknown exit code; pass it through
5129       return status;
5130     }
5131   }
5132 }
5133 
5134 size_t os::write(int fd, const void *buf, unsigned int nBytes) {
5135   size_t res;
5136   RESTARTABLE((size_t) ::write(fd, buf, (size_t) nBytes), res);
5137   return res;
5138 }
5139 
5140 int os::close(int fd) {
5141   return ::close(fd);
5142 }
5143 
5144 int os::socket_close(int fd) {
5145   return ::close(fd);
5146 }
5147 
5148 int os::recv(int fd, char* buf, size_t nBytes, uint flags) {
5149   assert(((JavaThread*)Thread::current())-&gt;thread_state() == _thread_in_native,
5150          &quot;Assumed _thread_in_native&quot;);
5151   RESTARTABLE_RETURN_INT((int)::recv(fd, buf, nBytes, flags));
5152 }
5153 
5154 int os::send(int fd, char* buf, size_t nBytes, uint flags) {
5155   assert(((JavaThread*)Thread::current())-&gt;thread_state() == _thread_in_native,
5156          &quot;Assumed _thread_in_native&quot;);
5157   RESTARTABLE_RETURN_INT((int)::send(fd, buf, nBytes, flags));
5158 }
5159 
5160 int os::raw_send(int fd, char* buf, size_t nBytes, uint flags) {
5161   RESTARTABLE_RETURN_INT((int)::send(fd, buf, nBytes, flags));
5162 }
5163 
5164 // As both poll and select can be interrupted by signals, we have to be
5165 // prepared to restart the system call after updating the timeout, unless
5166 // a poll() is done with timeout == -1, in which case we repeat with this
5167 // &quot;wait forever&quot; value.
5168 
5169 int os::connect(int fd, struct sockaddr *him, socklen_t len) {
5170   int _result;
5171   _result = ::connect(fd, him, len);
5172 
5173   // On Solaris, when a connect() call is interrupted, the connection
5174   // can be established asynchronously (see 6343810). Subsequent calls
5175   // to connect() must check the errno value which has the semantic
5176   // described below (copied from the connect() man page). Handling
5177   // of asynchronously established connections is required for both
5178   // blocking and non-blocking sockets.
5179   //     EINTR            The  connection  attempt  was   interrupted
5180   //                      before  any data arrived by the delivery of
5181   //                      a signal. The connection, however, will  be
5182   //                      established asynchronously.
5183   //
5184   //     EINPROGRESS      The socket is non-blocking, and the connec-
5185   //                      tion  cannot  be completed immediately.
5186   //
5187   //     EALREADY         The socket is non-blocking,  and a previous
5188   //                      connection  attempt  has  not yet been com-
5189   //                      pleted.
5190   //
5191   //     EISCONN          The socket is already connected.
5192   if (_result == OS_ERR &amp;&amp; errno == EINTR) {
5193     // restarting a connect() changes its errno semantics
5194     RESTARTABLE(::connect(fd, him, len), _result);
5195     // undo these changes
5196     if (_result == OS_ERR) {
5197       if (errno == EALREADY) {
5198         errno = EINPROGRESS; // fall through
5199       } else if (errno == EISCONN) {
5200         errno = 0;
5201         return OS_OK;
5202       }
5203     }
5204   }
5205   return _result;
5206 }
5207 
5208 // Get the default path to the core file
5209 // Returns the length of the string
5210 int os::get_core_path(char* buffer, size_t bufferSize) {
5211   const char* p = get_current_directory(buffer, bufferSize);
5212 
5213   if (p == NULL) {
5214     assert(p != NULL, &quot;failed to get current directory&quot;);
5215     return 0;
5216   }
5217 
5218   jio_snprintf(buffer, bufferSize, &quot;%s/core or core.%d&quot;,
5219                                               p, current_process_id());
5220 
5221   return strlen(buffer);
5222 }
5223 
5224 bool os::supports_map_sync() {
5225   return false;
5226 }
5227 
5228 #ifndef PRODUCT
5229 void TestReserveMemorySpecial_test() {
5230   // No tests available for this platform
5231 }
5232 #endif
5233 
5234 bool os::start_debugging(char *buf, int buflen) {
5235   int len = (int)strlen(buf);
5236   char *p = &amp;buf[len];
5237 
5238   jio_snprintf(p, buflen-len,
5239                &quot;\n\n&quot;
5240                &quot;Do you want to debug the problem?\n\n&quot;
5241                &quot;To debug, run &#39;dbx - %d&#39;; then switch to thread &quot; INTX_FORMAT &quot;\n&quot;
5242                &quot;Enter &#39;yes&#39; to launch dbx automatically (PATH must include dbx)\n&quot;
5243                &quot;Otherwise, press RETURN to abort...&quot;,
5244                os::current_process_id(), os::current_thread_id());
5245 
5246   bool yes = os::message_box(&quot;Unexpected Error&quot;, buf);
5247 
5248   if (yes) {
5249     // yes, user asked VM to launch debugger
5250     jio_snprintf(buf, sizeof(buf), &quot;dbx - %d&quot;, os::current_process_id());
5251 
5252     os::fork_and_exec(buf);
5253     yes = false;
5254   }
5255   return yes;
5256 }
<a name="4" id="anc4"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="4" type="hidden" />
</body>
</html>