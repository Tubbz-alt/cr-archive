<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>New src/jdk.internal.vm.compiler/share/classes/org.graalvm.compiler.lir.amd64/src/org/graalvm/compiler/lir/amd64/AMD64MathSinOp.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../../style.css" />
  </head>
  <body>
    <pre>
  1 /*
  2  * Copyright (c) 2018, 2020, Oracle and/or its affiliates. All rights reserved.
  3  * Copyright (c) 2016, Intel Corporation. All rights reserved.
  4  * Intel Math Library (LIBM) Source Code
  5  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  6  *
  7  * This code is free software; you can redistribute it and/or modify it
  8  * under the terms of the GNU General Public License version 2 only, as
  9  * published by the Free Software Foundation.
 10  *
 11  * This code is distributed in the hope that it will be useful, but WITHOUT
 12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 14  * version 2 for more details (a copy is included in the LICENSE file that
 15  * accompanied this code).
 16  *
 17  * You should have received a copy of the GNU General Public License version
 18  * 2 along with this work; if not, write to the Free Software Foundation,
 19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 20  *
 21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 22  * or visit www.oracle.com if you need additional information or have any
 23  * questions.
 24  */
 25 
 26 
 27 package org.graalvm.compiler.lir.amd64;
 28 
 29 import static jdk.vm.ci.amd64.AMD64.r10;
 30 import static jdk.vm.ci.amd64.AMD64.r11;
 31 import static jdk.vm.ci.amd64.AMD64.r8;
 32 import static jdk.vm.ci.amd64.AMD64.r9;
 33 import static jdk.vm.ci.amd64.AMD64.rax;
 34 import static jdk.vm.ci.amd64.AMD64.rbx;
 35 import static jdk.vm.ci.amd64.AMD64.rcx;
 36 import static jdk.vm.ci.amd64.AMD64.rdi;
 37 import static jdk.vm.ci.amd64.AMD64.rdx;
 38 import static jdk.vm.ci.amd64.AMD64.rsi;
 39 import static jdk.vm.ci.amd64.AMD64.rsp;
 40 import static jdk.vm.ci.amd64.AMD64.xmm0;
 41 import static jdk.vm.ci.amd64.AMD64.xmm1;
 42 import static jdk.vm.ci.amd64.AMD64.xmm2;
 43 import static jdk.vm.ci.amd64.AMD64.xmm3;
 44 import static jdk.vm.ci.amd64.AMD64.xmm4;
 45 import static jdk.vm.ci.amd64.AMD64.xmm5;
 46 import static jdk.vm.ci.amd64.AMD64.xmm6;
 47 import static jdk.vm.ci.amd64.AMD64.xmm7;
 48 import static org.graalvm.compiler.lir.amd64.AMD64HotSpotHelper.pointerConstant;
 49 import static org.graalvm.compiler.lir.amd64.AMD64HotSpotHelper.recordExternalAddress;
 50 
 51 import org.graalvm.compiler.asm.Label;
 52 import org.graalvm.compiler.asm.amd64.AMD64Address;
 53 import org.graalvm.compiler.asm.amd64.AMD64Assembler.ConditionFlag;
 54 import org.graalvm.compiler.asm.amd64.AMD64MacroAssembler;
 55 import org.graalvm.compiler.lir.LIRInstructionClass;
 56 import org.graalvm.compiler.lir.asm.ArrayDataPointerConstant;
 57 import org.graalvm.compiler.lir.asm.CompilationResultBuilder;
 58 
 59 import jdk.vm.ci.amd64.AMD64;
 60 
 61 /**
 62  * &lt;pre&gt;
 63  *                     ALGORITHM DESCRIPTION - SIN()
 64  *                     ---------------------
 65  *
 66  *     1. RANGE REDUCTION
 67  *
 68  *     We perform an initial range reduction from X to r with
 69  *
 70  *          X =~= N * pi/32 + r
 71  *
 72  *     so that |r| &lt;= pi/64 + epsilon. We restrict inputs to those
 73  *     where |N| &lt;= 932560. Beyond this, the range reduction is
 74  *     insufficiently accurate. For extremely small inputs,
 75  *     denormalization can occur internally, impacting performance.
 76  *     This means that the main path is actually only taken for
 77  *     2^-252 &lt;= |X| &lt; 90112.
 78  *
 79  *     To avoid branches, we perform the range reduction to full
 80  *     accuracy each time.
 81  *
 82  *          X - N * (P_1 + P_2 + P_3)
 83  *
 84  *     where P_1 and P_2 are 32-bit numbers (so multiplication by N
 85  *     is exact) and P_3 is a 53-bit number. Together, these
 86  *     approximate pi well enough for all cases in the restricted
 87  *     range.
 88  *
 89  *     The main reduction sequence is:
 90  *
 91  *             y = 32/pi * x
 92  *             N = integer(y)
 93  *     (computed by adding and subtracting off SHIFTER)
 94  *
 95  *             m_1 = N * P_1
 96  *             m_2 = N * P_2
 97  *             r_1 = x - m_1
 98  *             r = r_1 - m_2
 99  *     (this r can be used for most of the calculation)
100  *
101  *             c_1 = r_1 - r
102  *             m_3 = N * P_3
103  *             c_2 = c_1 - m_2
104  *             c = c_2 - m_3
105  *
106  *     2. MAIN ALGORITHM
107  *
108  *     The algorithm uses a table lookup based on B = M * pi / 32
109  *     where M = N mod 64. The stored values are:
110  *       sigma             closest power of 2 to cos(B)
111  *       C_hl              53-bit cos(B) - sigma
112  *       S_hi + S_lo       2 * 53-bit sin(B)
113  *
114  *     The computation is organized as follows:
115  *
116  *          sin(B + r + c) = [sin(B) + sigma * r] +
117  *                           r * (cos(B) - sigma) +
118  *                           sin(B) * [cos(r + c) - 1] +
119  *                           cos(B) * [sin(r + c) - r]
120  *
121  *     which is approximately:
122  *
123  *          [S_hi + sigma * r] +
124  *          C_hl * r +
125  *          S_lo + S_hi * [(cos(r) - 1) - r * c] +
126  *          (C_hl + sigma) * [(sin(r) - r) + c]
127  *
128  *     and this is what is actually computed. We separate this sum
129  *     into four parts:
130  *
131  *          hi + med + pols + corr
132  *
133  *     where
134  *
135  *          hi       = S_hi + sigma r
136  *          med      = C_hl * r
137  *          pols     = S_hi * (cos(r) - 1) + (C_hl + sigma) * (sin(r) - r)
138  *          corr     = S_lo + c * ((C_hl + sigma) - S_hi * r)
139  *
140  *     3. POLYNOMIAL
141  *
142  *     The polynomial S_hi * (cos(r) - 1) + (C_hl + sigma) *
143  *     (sin(r) - r) can be rearranged freely, since it is quite
144  *     small, so we exploit parallelism to the fullest.
145  *
146  *          psc4       =   SC_4 * r_1
147  *          msc4       =   psc4 * r
148  *          r2         =   r * r
149  *          msc2       =   SC_2 * r2
150  *          r4         =   r2 * r2
151  *          psc3       =   SC_3 + msc4
152  *          psc1       =   SC_1 + msc2
153  *          msc3       =   r4 * psc3
154  *          sincospols =   psc1 + msc3
155  *          pols       =   sincospols *
156  *                         &lt;S_hi * r^2 | (C_hl + sigma) * r^3&gt;
157  *
158  *     4. CORRECTION TERM
159  *
160  *     This is where the &quot;c&quot; component of the range reduction is
161  *     taken into account; recall that just &quot;r&quot; is used for most of
162  *     the calculation.
163  *
164  *          -c   = m_3 - c_2
165  *          -d   = S_hi * r - (C_hl + sigma)
166  *          corr = -c * -d + S_lo
167  *
168  *     5. COMPENSATED SUMMATIONS
169  *
170  *     The two successive compensated summations add up the high
171  *     and medium parts, leaving just the low parts to add up at
172  *     the end.
173  *
174  *          rs        =  sigma * r
175  *          res_int   =  S_hi + rs
176  *          k_0       =  S_hi - res_int
177  *          k_2       =  k_0 + rs
178  *          med       =  C_hl * r
179  *          res_hi    =  res_int + med
180  *          k_1       =  res_int - res_hi
181  *          k_3       =  k_1 + med
182  *
183  *     6. FINAL SUMMATION
184  *
185  *     We now add up all the small parts:
186  *
187  *          res_lo = pols(hi) + pols(lo) + corr + k_1 + k_3
188  *
189  *     Now the overall result is just:
190  *
191  *          res_hi + res_lo
192  *
193  *     7. SMALL ARGUMENTS
194  *
195  *     If |x| &lt; SNN (SNN meaning the smallest normal number), we
196  *     simply perform 0.1111111 cdots 1111 * x. For SNN &lt;= |x|, we
197  *     do 2^-55 * (2^55 * x - x).
198  *
199  * Special cases:
200  *  sin(NaN) = quiet NaN, and raise invalid exception
201  *  sin(INF) = NaN and raise invalid exception
202  *  sin(+/-0) = +/-0
203  * &lt;/pre&gt;
204  */
205 public final class AMD64MathSinOp extends AMD64MathIntrinsicUnaryOp {
206 
207     public static final LIRInstructionClass&lt;AMD64MathSinOp&gt; TYPE = LIRInstructionClass.create(AMD64MathSinOp.class);
208 
209     public AMD64MathSinOp() {
210         super(TYPE, /* GPR */ rax, rcx, rdx, rbx, rsi, rdi, r8, r9, r10, r11,
211                         /* XMM */ xmm1, xmm2, xmm3, xmm4, xmm5, xmm6, xmm7);
212     }
213 
214     private ArrayDataPointerConstant onehalf = pointerConstant(16, new int[]{
215             // @formatter:off
216             0x00000000, 0x3fe00000, 0x00000000, 0x3fe00000
217             // @formatter:on
218     });
219 
220     private ArrayDataPointerConstant p2 = pointerConstant(16, new int[]{
221             // @formatter:off
222             0x1a600000, 0x3d90b461, 0x1a600000, 0x3d90b461
223             // @formatter:on
224     });
225 
226     private ArrayDataPointerConstant sc4 = pointerConstant(16, new int[]{
227             // @formatter:off
228             0xa556c734, 0x3ec71de3, 0x1a01a01a, 0x3efa01a0
229             // @formatter:on
230     });
231 
232     private ArrayDataPointerConstant ctable = pointerConstant(16, new int[]{
233             // @formatter:off
234             0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
235             0x00000000, 0x00000000, 0x3ff00000, 0x176d6d31, 0xbf73b92e,
236             0xbc29b42c, 0x3fb917a6, 0xe0000000, 0xbc3e2718, 0x00000000,
237             0x3ff00000, 0x011469fb, 0xbf93ad06, 0x3c69a60b, 0x3fc8f8b8,
238             0xc0000000, 0xbc626d19, 0x00000000, 0x3ff00000, 0x939d225a,
239             0xbfa60bea, 0x2ed59f06, 0x3fd29406, 0xa0000000, 0xbc75d28d,
240             0x00000000, 0x3ff00000, 0x866b95cf, 0xbfb37ca1, 0xa6aea963,
241             0x3fd87de2, 0xe0000000, 0xbc672ced, 0x00000000, 0x3ff00000,
242             0x73fa1279, 0xbfbe3a68, 0x3806f63b, 0x3fde2b5d, 0x20000000,
243             0x3c5e0d89, 0x00000000, 0x3ff00000, 0x5bc57974, 0xbfc59267,
244             0x39ae68c8, 0x3fe1c73b, 0x20000000, 0x3c8b25dd, 0x00000000,
245             0x3ff00000, 0x53aba2fd, 0xbfcd0dfe, 0x25091dd6, 0x3fe44cf3,
246             0x20000000, 0x3c68076a, 0x00000000, 0x3ff00000, 0x99fcef32,
247             0x3fca8279, 0x667f3bcd, 0x3fe6a09e, 0x20000000, 0xbc8bdd34,
248             0x00000000, 0x3fe00000, 0x94247758, 0x3fc133cc, 0x6b151741,
249             0x3fe8bc80, 0x20000000, 0xbc82c5e1, 0x00000000, 0x3fe00000,
250             0x9ae68c87, 0x3fac73b3, 0x290ea1a3, 0x3fea9b66, 0xe0000000,
251             0x3c39f630, 0x00000000, 0x3fe00000, 0x7f909c4e, 0xbf9d4a2c,
252             0xf180bdb1, 0x3fec38b2, 0x80000000, 0xbc76e0b1, 0x00000000,
253             0x3fe00000, 0x65455a75, 0xbfbe0875, 0xcf328d46, 0x3fed906b,
254             0x20000000, 0x3c7457e6, 0x00000000, 0x3fe00000, 0x76acf82d,
255             0x3fa4a031, 0x56c62dda, 0x3fee9f41, 0xe0000000, 0x3c8760b1,
256             0x00000000, 0x3fd00000, 0x0e5967d5, 0xbfac1d1f, 0xcff75cb0,
257             0x3fef6297, 0x20000000, 0x3c756217, 0x00000000, 0x3fd00000,
258             0x0f592f50, 0xbf9ba165, 0xa3d12526, 0x3fefd88d, 0x40000000,
259             0xbc887df6, 0x00000000, 0x3fc00000, 0x00000000, 0x00000000,
260             0x00000000, 0x3ff00000, 0x00000000, 0x00000000, 0x00000000,
261             0x00000000, 0x0f592f50, 0x3f9ba165, 0xa3d12526, 0x3fefd88d,
262             0x40000000, 0xbc887df6, 0x00000000, 0xbfc00000, 0x0e5967d5,
263             0x3fac1d1f, 0xcff75cb0, 0x3fef6297, 0x20000000, 0x3c756217,
264             0x00000000, 0xbfd00000, 0x76acf82d, 0xbfa4a031, 0x56c62dda,
265             0x3fee9f41, 0xe0000000, 0x3c8760b1, 0x00000000, 0xbfd00000,
266             0x65455a75, 0x3fbe0875, 0xcf328d46, 0x3fed906b, 0x20000000,
267             0x3c7457e6, 0x00000000, 0xbfe00000, 0x7f909c4e, 0x3f9d4a2c,
268             0xf180bdb1, 0x3fec38b2, 0x80000000, 0xbc76e0b1, 0x00000000,
269             0xbfe00000, 0x9ae68c87, 0xbfac73b3, 0x290ea1a3, 0x3fea9b66,
270             0xe0000000, 0x3c39f630, 0x00000000, 0xbfe00000, 0x94247758,
271             0xbfc133cc, 0x6b151741, 0x3fe8bc80, 0x20000000, 0xbc82c5e1,
272             0x00000000, 0xbfe00000, 0x99fcef32, 0xbfca8279, 0x667f3bcd,
273             0x3fe6a09e, 0x20000000, 0xbc8bdd34, 0x00000000, 0xbfe00000,
274             0x53aba2fd, 0x3fcd0dfe, 0x25091dd6, 0x3fe44cf3, 0x20000000,
275             0x3c68076a, 0x00000000, 0xbff00000, 0x5bc57974, 0x3fc59267,
276             0x39ae68c8, 0x3fe1c73b, 0x20000000, 0x3c8b25dd, 0x00000000,
277             0xbff00000, 0x73fa1279, 0x3fbe3a68, 0x3806f63b, 0x3fde2b5d,
278             0x20000000, 0x3c5e0d89, 0x00000000, 0xbff00000, 0x866b95cf,
279             0x3fb37ca1, 0xa6aea963, 0x3fd87de2, 0xe0000000, 0xbc672ced,
280             0x00000000, 0xbff00000, 0x939d225a, 0x3fa60bea, 0x2ed59f06,
281             0x3fd29406, 0xa0000000, 0xbc75d28d, 0x00000000, 0xbff00000,
282             0x011469fb, 0x3f93ad06, 0x3c69a60b, 0x3fc8f8b8, 0xc0000000,
283             0xbc626d19, 0x00000000, 0xbff00000, 0x176d6d31, 0x3f73b92e,
284             0xbc29b42c, 0x3fb917a6, 0xe0000000, 0xbc3e2718, 0x00000000,
285             0xbff00000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
286             0x00000000, 0x00000000, 0x00000000, 0xbff00000, 0x176d6d31,
287             0x3f73b92e, 0xbc29b42c, 0xbfb917a6, 0xe0000000, 0x3c3e2718,
288             0x00000000, 0xbff00000, 0x011469fb, 0x3f93ad06, 0x3c69a60b,
289             0xbfc8f8b8, 0xc0000000, 0x3c626d19, 0x00000000, 0xbff00000,
290             0x939d225a, 0x3fa60bea, 0x2ed59f06, 0xbfd29406, 0xa0000000,
291             0x3c75d28d, 0x00000000, 0xbff00000, 0x866b95cf, 0x3fb37ca1,
292             0xa6aea963, 0xbfd87de2, 0xe0000000, 0x3c672ced, 0x00000000,
293             0xbff00000, 0x73fa1279, 0x3fbe3a68, 0x3806f63b, 0xbfde2b5d,
294             0x20000000, 0xbc5e0d89, 0x00000000, 0xbff00000, 0x5bc57974,
295             0x3fc59267, 0x39ae68c8, 0xbfe1c73b, 0x20000000, 0xbc8b25dd,
296             0x00000000, 0xbff00000, 0x53aba2fd, 0x3fcd0dfe, 0x25091dd6,
297             0xbfe44cf3, 0x20000000, 0xbc68076a, 0x00000000, 0xbff00000,
298             0x99fcef32, 0xbfca8279, 0x667f3bcd, 0xbfe6a09e, 0x20000000,
299             0x3c8bdd34, 0x00000000, 0xbfe00000, 0x94247758, 0xbfc133cc,
300             0x6b151741, 0xbfe8bc80, 0x20000000, 0x3c82c5e1, 0x00000000,
301             0xbfe00000, 0x9ae68c87, 0xbfac73b3, 0x290ea1a3, 0xbfea9b66,
302             0xe0000000, 0xbc39f630, 0x00000000, 0xbfe00000, 0x7f909c4e,
303             0x3f9d4a2c, 0xf180bdb1, 0xbfec38b2, 0x80000000, 0x3c76e0b1,
304             0x00000000, 0xbfe00000, 0x65455a75, 0x3fbe0875, 0xcf328d46,
305             0xbfed906b, 0x20000000, 0xbc7457e6, 0x00000000, 0xbfe00000,
306             0x76acf82d, 0xbfa4a031, 0x56c62dda, 0xbfee9f41, 0xe0000000,
307             0xbc8760b1, 0x00000000, 0xbfd00000, 0x0e5967d5, 0x3fac1d1f,
308             0xcff75cb0, 0xbfef6297, 0x20000000, 0xbc756217, 0x00000000,
309             0xbfd00000, 0x0f592f50, 0x3f9ba165, 0xa3d12526, 0xbfefd88d,
310             0x40000000, 0x3c887df6, 0x00000000, 0xbfc00000, 0x00000000,
311             0x00000000, 0x00000000, 0xbff00000, 0x00000000, 0x00000000,
312             0x00000000, 0x00000000, 0x0f592f50, 0xbf9ba165, 0xa3d12526,
313             0xbfefd88d, 0x40000000, 0x3c887df6, 0x00000000, 0x3fc00000,
314             0x0e5967d5, 0xbfac1d1f, 0xcff75cb0, 0xbfef6297, 0x20000000,
315             0xbc756217, 0x00000000, 0x3fd00000, 0x76acf82d, 0x3fa4a031,
316             0x56c62dda, 0xbfee9f41, 0xe0000000, 0xbc8760b1, 0x00000000,
317             0x3fd00000, 0x65455a75, 0xbfbe0875, 0xcf328d46, 0xbfed906b,
318             0x20000000, 0xbc7457e6, 0x00000000, 0x3fe00000, 0x7f909c4e,
319             0xbf9d4a2c, 0xf180bdb1, 0xbfec38b2, 0x80000000, 0x3c76e0b1,
320             0x00000000, 0x3fe00000, 0x9ae68c87, 0x3fac73b3, 0x290ea1a3,
321             0xbfea9b66, 0xe0000000, 0xbc39f630, 0x00000000, 0x3fe00000,
322             0x94247758, 0x3fc133cc, 0x6b151741, 0xbfe8bc80, 0x20000000,
323             0x3c82c5e1, 0x00000000, 0x3fe00000, 0x99fcef32, 0x3fca8279,
324             0x667f3bcd, 0xbfe6a09e, 0x20000000, 0x3c8bdd34, 0x00000000,
325             0x3fe00000, 0x53aba2fd, 0xbfcd0dfe, 0x25091dd6, 0xbfe44cf3,
326             0x20000000, 0xbc68076a, 0x00000000, 0x3ff00000, 0x5bc57974,
327             0xbfc59267, 0x39ae68c8, 0xbfe1c73b, 0x20000000, 0xbc8b25dd,
328             0x00000000, 0x3ff00000, 0x73fa1279, 0xbfbe3a68, 0x3806f63b,
329             0xbfde2b5d, 0x20000000, 0xbc5e0d89, 0x00000000, 0x3ff00000,
330             0x866b95cf, 0xbfb37ca1, 0xa6aea963, 0xbfd87de2, 0xe0000000,
331             0x3c672ced, 0x00000000, 0x3ff00000, 0x939d225a, 0xbfa60bea,
332             0x2ed59f06, 0xbfd29406, 0xa0000000, 0x3c75d28d, 0x00000000,
333             0x3ff00000, 0x011469fb, 0xbf93ad06, 0x3c69a60b, 0xbfc8f8b8,
334             0xc0000000, 0x3c626d19, 0x00000000, 0x3ff00000, 0x176d6d31,
335             0xbf73b92e, 0xbc29b42c, 0xbfb917a6, 0xe0000000, 0x3c3e2718,
336             0x00000000, 0x3ff00000
337             // @formatter:on
338     });
339 
340     private ArrayDataPointerConstant sc2 = pointerConstant(16, new int[]{
341             // @formatter:off
342             0x11111111, 0x3f811111, 0x55555555, 0x3fa55555
343             // @formatter:on
344     });
345 
346     private ArrayDataPointerConstant sc3 = pointerConstant(16, new int[]{
347             // @formatter:off
348             0x1a01a01a, 0xbf2a01a0, 0x16c16c17, 0xbf56c16c
349             // @formatter:on
350     });
351 
352     private ArrayDataPointerConstant sc1 = pointerConstant(16, new int[]{
353             // @formatter:off
354             0x55555555, 0xbfc55555, 0x00000000, 0xbfe00000
355             // @formatter:on
356     });
357 
358     private ArrayDataPointerConstant piInvTable = pointerConstant(16, new int[]{
359             // @formatter:off
360             0x00000000, 0x00000000, 0xa2f9836e, 0x4e441529, 0xfc2757d1,
361             0xf534ddc0, 0xdb629599, 0x3c439041, 0xfe5163ab, 0xdebbc561,
362             0xb7246e3a, 0x424dd2e0, 0x06492eea, 0x09d1921c, 0xfe1deb1c,
363             0xb129a73e, 0xe88235f5, 0x2ebb4484, 0xe99c7026, 0xb45f7e41,
364             0x3991d639, 0x835339f4, 0x9c845f8b, 0xbdf9283b, 0x1ff897ff,
365             0xde05980f, 0xef2f118b, 0x5a0a6d1f, 0x6d367ecf, 0x27cb09b7,
366             0x4f463f66, 0x9e5fea2d, 0x7527bac7, 0xebe5f17b, 0x3d0739f7,
367             0x8a5292ea, 0x6bfb5fb1, 0x1f8d5d08, 0x56033046, 0xfc7b6bab,
368             0xf0cfbc21
369             // @formatter:on
370     });
371 
372     private ArrayDataPointerConstant pi4 = pointerConstant(8, new int[]{
373             // @formatter:off
374             0x40000000, 0x3fe921fb,
375     });
376     private ArrayDataPointerConstant pi48 = pointerConstant(8, new int[]{
377             0x18469899, 0x3e64442d
378             // @formatter:on
379     });
380 
381     private ArrayDataPointerConstant pi32Inv = pointerConstant(8, new int[]{
382             // @formatter:off
383             0x6dc9c883, 0x40245f30
384             // @formatter:on
385     });
386 
387     private ArrayDataPointerConstant shifter = pointerConstant(8, new int[]{
388             // @formatter:off
389             0x00000000, 0x43380000
390             // @formatter:on
391     });
392 
393     private ArrayDataPointerConstant signMask = pointerConstant(8, new int[]{
394             // @formatter:off
395             0x00000000, 0x80000000
396             // @formatter:on
397     });
398 
399     private ArrayDataPointerConstant p3 = pointerConstant(8, new int[]{
400             // @formatter:off
401             0x2e037073, 0x3b63198a
402             // @formatter:on
403     });
404 
405     private ArrayDataPointerConstant allOnes = pointerConstant(8, new int[]{
406             // @formatter:off
407             0xffffffff, 0x3fefffff
408             // @formatter:on
409     });
410 
411     private ArrayDataPointerConstant twoPow55 = pointerConstant(8, new int[]{
412             // @formatter:off
413             0x00000000, 0x43600000
414             // @formatter:on
415     });
416 
417     private ArrayDataPointerConstant twoPowM55 = pointerConstant(8, new int[]{
418             // @formatter:off
419             0x00000000, 0x3c800000
420             // @formatter:on
421     });
422 
423     private ArrayDataPointerConstant p1 = pointerConstant(8, new int[]{
424             // @formatter:off
425             0x54400000, 0x3fb921fb
426             // @formatter:on
427     });
428 
429     private ArrayDataPointerConstant negZero = pointerConstant(8, new int[]{
430             // @formatter:off
431             0x00000000, 0x80000000
432             // @formatter:on
433     });
434 
435     @Override
436     public void emitCode(CompilationResultBuilder crb, AMD64MacroAssembler masm) {
437         Label block0 = new Label();
438         Label block1 = new Label();
439         Label block2 = new Label();
440         Label block3 = new Label();
441         Label block4 = new Label();
442         Label block5 = new Label();
443         Label block6 = new Label();
444         Label block7 = new Label();
445         Label block8 = new Label();
446         Label block9 = new Label();
447         Label block10 = new Label();
448         Label block11 = new Label();
449         Label block12 = new Label();
450         Label block13 = new Label();
451         Label block14 = new Label();
452 
453         masm.push(AMD64.rbx);
454         masm.subq(rsp, 16);
455         masm.movsd(new AMD64Address(rsp, 8), xmm0);
456         masm.movl(rax, new AMD64Address(rsp, 12));
457         masm.movq(xmm1, recordExternalAddress(crb, pi32Inv));          // 0x6dc9c883, 0x40245f30
458         masm.movq(xmm2, recordExternalAddress(crb, shifter));          // 0x00000000, 0x43380000
459         masm.andl(rax, 2147418112);
460         masm.subl(rax, 808452096);
461         masm.cmplAndJcc(rax, 281346048, ConditionFlag.Above, block0, false);
462         masm.mulsd(xmm1, xmm0);
463         masm.movdqu(xmm5, recordExternalAddress(crb, onehalf));        // 0x00000000, 0x3fe00000,
464                                                                        // 0x00000000, 0x3fe00000
465         masm.movq(xmm4, recordExternalAddress(crb, signMask));         // 0x00000000, 0x80000000
466         masm.pand(xmm4, xmm0);
467         masm.por(xmm5, xmm4);
468         masm.addpd(xmm1, xmm5);
469         masm.cvttsd2sil(rdx, xmm1);
470         masm.cvtsi2sdl(xmm1, rdx);
471         masm.movdqu(xmm6, recordExternalAddress(crb, p2));             // 0x1a600000, 0x3d90b461,
472                                                                        // 0x1a600000, 0x3d90b461
473         masm.movq(r8, 0x3fb921fb54400000L);
474         masm.movdq(xmm3, r8);
475         masm.movdqu(xmm5, recordExternalAddress(crb, sc4));            // 0xa556c734, 0x3ec71de3,
476                                                                        // 0x1a01a01a, 0x3efa01a0
477         masm.pshufd(xmm4, xmm0, 68);
478         masm.mulsd(xmm3, xmm1);
479         if (masm.supports(AMD64.CPUFeature.SSE3)) {
480             masm.movddup(xmm1, xmm1);
481         } else {
482             masm.movlhps(xmm1, xmm1);
483         }
484         masm.andl(rdx, 63);
485         masm.shll(rdx, 5);
486         masm.leaq(AMD64.rax, recordExternalAddress(crb, ctable));
487         masm.addq(AMD64.rax, AMD64.rdx);
488         masm.mulpd(xmm6, xmm1);
489         masm.mulsd(xmm1, recordExternalAddress(crb, p3));              // 0x2e037073, 0x3b63198a
490         masm.subsd(xmm4, xmm3);
491         masm.movq(xmm7, new AMD64Address(AMD64.rax, 8));
492         masm.subsd(xmm0, xmm3);
493         if (masm.supports(AMD64.CPUFeature.SSE3)) {
494             masm.movddup(xmm3, xmm4);
495         } else {
496             masm.movdqu(xmm3, xmm4);
497             masm.movlhps(xmm3, xmm3);
498         }
499         masm.subsd(xmm4, xmm6);
500         masm.pshufd(xmm0, xmm0, 68);
501         masm.movdqu(xmm2, new AMD64Address(AMD64.rax, 0));
502         masm.mulpd(xmm5, xmm0);
503         masm.subpd(xmm0, xmm6);
504         masm.mulsd(xmm7, xmm4);
505         masm.subsd(xmm3, xmm4);
506         masm.mulpd(xmm5, xmm0);
507         masm.mulpd(xmm0, xmm0);
508         masm.subsd(xmm3, xmm6);
509         masm.movdqu(xmm6, recordExternalAddress(crb, sc2));            // 0x11111111, 0x3f811111,
510                                                                        // 0x55555555, 0x3fa55555
511         masm.subsd(xmm1, xmm3);
512         masm.movq(xmm3, new AMD64Address(AMD64.rax, 24));
513         masm.addsd(xmm2, xmm3);
514         masm.subsd(xmm7, xmm2);
515         masm.mulsd(xmm2, xmm4);
516         masm.mulpd(xmm6, xmm0);
517         masm.mulsd(xmm3, xmm4);
518         masm.mulpd(xmm2, xmm0);
519         masm.mulpd(xmm0, xmm0);
520         masm.addpd(xmm5, recordExternalAddress(crb, sc3));             // 0x1a01a01a, 0xbf2a01a0,
521                                                                        // 0x16c16c17, 0xbf56c16c
522         masm.mulsd(xmm4, new AMD64Address(AMD64.rax, 0));
523         masm.addpd(xmm6, recordExternalAddress(crb, sc1));             // 0x55555555, 0xbfc55555,
524                                                                        // 0x00000000, 0xbfe00000
525         masm.mulpd(xmm5, xmm0);
526         masm.movdqu(xmm0, xmm3);
527         masm.addsd(xmm3, new AMD64Address(AMD64.rax, 8));
528         masm.mulpd(xmm1, xmm7);
529         masm.movdqu(xmm7, xmm4);
530         masm.addsd(xmm4, xmm3);
531         masm.addpd(xmm6, xmm5);
532         masm.movq(xmm5, new AMD64Address(AMD64.rax, 8));
533         masm.subsd(xmm5, xmm3);
534         masm.subsd(xmm3, xmm4);
535         masm.addsd(xmm1, new AMD64Address(AMD64.rax, 16));
536         masm.mulpd(xmm6, xmm2);
537         masm.addsd(xmm5, xmm0);
538         masm.addsd(xmm3, xmm7);
539         masm.addsd(xmm1, xmm5);
540         masm.addsd(xmm1, xmm3);
541         masm.addsd(xmm1, xmm6);
542         masm.unpckhpd(xmm6, xmm6);
543         masm.movdqu(xmm0, xmm4);
544         masm.addsd(xmm1, xmm6);
545         masm.addsd(xmm0, xmm1);
546         masm.jmp(block14);
547 
548         masm.bind(block0);
549         masm.jcc(ConditionFlag.Greater, block1);
550         masm.shrl(rax, 20);
551         masm.cmplAndJcc(rax, 3325, ConditionFlag.NotEqual, block2, false);
552         masm.mulsd(xmm0, recordExternalAddress(crb, allOnes));         // 0xffffffff, 0x3fefffff
553         masm.jmp(block14);
554 
555         masm.bind(block2);
556         masm.movq(xmm3, recordExternalAddress(crb, twoPow55));         // 0x00000000, 0x43600000
557         masm.mulsd(xmm3, xmm0);
558         masm.subsd(xmm3, xmm0);
559         masm.mulsd(xmm3, recordExternalAddress(crb, twoPowM55));       // 0x00000000, 0x3c800000
560         masm.jmp(block14);
561 
562         masm.bind(block1);
563         masm.pextrw(rax, xmm0, 3);
564         masm.andl(rax, 32752);
565         masm.cmplAndJcc(rax, 32752, ConditionFlag.Equal, block3, false);
566         masm.pextrw(rcx, xmm0, 3);
567         masm.andl(rcx, 32752);
568         masm.subl(rcx, 16224);
569         masm.shrl(rcx, 7);
570         masm.andl(rcx, 65532);
571         masm.leaq(r11, recordExternalAddress(crb, piInvTable));
572         masm.addq(AMD64.rcx, r11);
573         masm.movdq(AMD64.rax, xmm0);
574         masm.movl(r10, new AMD64Address(AMD64.rcx, 20));
575         masm.movl(r8, new AMD64Address(AMD64.rcx, 24));
576         masm.movl(rdx, rax);
577         masm.shrq(AMD64.rax, 21);
578         masm.orl(rax, Integer.MIN_VALUE);
579         masm.shrl(rax, 11);
580         masm.movl(r9, r10);
581         masm.imulq(r10, AMD64.rdx);
582         masm.imulq(r9, AMD64.rax);
583         masm.imulq(r8, AMD64.rax);
584         masm.movl(rsi, new AMD64Address(AMD64.rcx, 16));
585         masm.movl(rdi, new AMD64Address(AMD64.rcx, 12));
586         masm.movl(r11, r10);
587         masm.shrq(r10, 32);
588         masm.addq(r9, r10);
589         masm.addq(r11, r8);
590         masm.movl(r8, r11);
591         masm.shrq(r11, 32);
592         masm.addq(r9, r11);
593         masm.movl(r10, rsi);
594         masm.imulq(rsi, AMD64.rdx);
595         masm.imulq(r10, AMD64.rax);
596         masm.movl(r11, rdi);
597         masm.imulq(rdi, AMD64.rdx);
598         masm.movl(rbx, rsi);
599         masm.shrq(rsi, 32);
600         masm.addq(r9, AMD64.rbx);
601         masm.movl(rbx, r9);
602         masm.shrq(r9, 32);
603         masm.addq(r10, rsi);
604         masm.addq(r10, r9);
605         masm.shlq(AMD64.rbx, 32);
606         masm.orq(r8, AMD64.rbx);
607         masm.imulq(r11, AMD64.rax);
608         masm.movl(r9, new AMD64Address(AMD64.rcx, 8));
609         masm.movl(rsi, new AMD64Address(AMD64.rcx, 4));
610         masm.movl(rbx, rdi);
611         masm.shrq(rdi, 32);
612         masm.addq(r10, AMD64.rbx);
613         masm.movl(rbx, r10);
614         masm.shrq(r10, 32);
615         masm.addq(r11, rdi);
616         masm.addq(r11, r10);
617         masm.movq(rdi, r9);
618         masm.imulq(r9, AMD64.rdx);
619         masm.imulq(rdi, AMD64.rax);
620         masm.movl(r10, r9);
621         masm.shrq(r9, 32);
622         masm.addq(r11, r10);
623         masm.movl(r10, r11);
624         masm.shrq(r11, 32);
625         masm.addq(rdi, r9);
626         masm.addq(rdi, r11);
627         masm.movq(r9, rsi);
628         masm.imulq(rsi, AMD64.rdx);
629         masm.imulq(r9, AMD64.rax);
630         masm.shlq(r10, 32);
631         masm.orq(r10, AMD64.rbx);
632         masm.movl(rax, new AMD64Address(AMD64.rcx, 0));
633         masm.movl(r11, rsi);
634         masm.shrq(rsi, 32);
635         masm.addq(rdi, r11);
636         masm.movl(r11, rdi);
637         masm.shrq(rdi, 32);
638         masm.addq(r9, rsi);
639         masm.addq(r9, rdi);
640         masm.imulq(AMD64.rdx, AMD64.rax);
641         masm.pextrw(rbx, xmm0, 3);
642         masm.leaq(rdi, recordExternalAddress(crb, piInvTable));
643         masm.subq(AMD64.rcx, rdi);
644         masm.addl(rcx, rcx);
645         masm.addl(rcx, rcx);
646         masm.addl(rcx, rcx);
647         masm.addl(rcx, 19);
648         masm.movl(rsi, 32768);
649         masm.andl(rsi, rbx);
650         masm.shrl(rbx, 4);
651         masm.andl(rbx, 2047);
652         masm.subl(rbx, 1023);
653         masm.subl(rcx, rbx);
654         masm.addq(r9, AMD64.rdx);
655         masm.movl(rdx, rcx);
656         masm.addl(rdx, 32);
657         masm.cmplAndJcc(rcx, 1, ConditionFlag.Less, block4, false);
658         masm.negl(rcx);
659         masm.addl(rcx, 29);
660         masm.shll(r9);
661         masm.movl(rdi, r9);
662         masm.andl(r9, 536870911);
663         masm.testlAndJcc(r9, 268435456, ConditionFlag.NotEqual, block5, false);
664         masm.shrl(r9);
665         masm.movl(rbx, 0);
666         masm.shlq(r9, 32);
667         masm.orq(r9, r11);
668 
669         masm.bind(block6);
670 
671         masm.bind(block7);
672 
673         masm.cmpqAndJcc(r9, 0, ConditionFlag.Equal, block8, false);
674 
675         masm.bind(block9);
676         masm.bsrq(r11, r9);
677         masm.movl(rcx, 29);
678         masm.sublAndJcc(rcx, r11, ConditionFlag.LessEqual, block10, false);
679         masm.shlq(r9);
680         masm.movq(AMD64.rax, r10);
681         masm.shlq(r10);
682         masm.addl(rdx, rcx);
683         masm.negl(rcx);
684         masm.addl(rcx, 64);
685         masm.shrq(AMD64.rax);
686         masm.shrq(r8);
687         masm.orq(r9, AMD64.rax);
688         masm.orq(r10, r8);
689 
690         masm.bind(block11);
691         masm.cvtsi2sdq(xmm0, r9);
692         masm.shrq(r10, 1);
693         masm.cvtsi2sdq(xmm3, r10);
694         masm.xorpd(xmm4, xmm4);
695         masm.shll(rdx, 4);
696         masm.negl(rdx);
697         masm.addl(rdx, 16368);
698         masm.orl(rdx, rsi);
699         masm.xorl(rdx, rbx);
700         masm.pinsrw(xmm4, rdx, 3);
701         masm.movq(xmm2, recordExternalAddress(crb, pi4));              // 0x40000000, 0x3fe921fb,
702                                                                        // 0x18469899, 0x3e64442d
703         masm.movq(xmm6, recordExternalAddress(crb, pi48));             // 0x3fe921fb, 0x18469899,
704                                                                        // 0x3e64442d
705         masm.xorpd(xmm5, xmm5);
706         masm.subl(rdx, 1008);
707         masm.pinsrw(xmm5, rdx, 3);
708         masm.mulsd(xmm0, xmm4);
709         masm.shll(rsi, 16);
710         masm.sarl(rsi, 31);
711         masm.mulsd(xmm3, xmm5);
712         masm.movdqu(xmm1, xmm0);
713         masm.mulsd(xmm0, xmm2);
714         masm.shrl(rdi, 29);
715         masm.addsd(xmm1, xmm3);
716         masm.mulsd(xmm3, xmm2);
717         masm.addl(rdi, rsi);
718         masm.xorl(rdi, rsi);
719         masm.mulsd(xmm6, xmm1);
720         masm.movl(rax, rdi);
721         masm.addsd(xmm6, xmm3);
722         masm.movdqu(xmm2, xmm0);
723         masm.addsd(xmm0, xmm6);
724         masm.subsd(xmm2, xmm0);
725         masm.addsd(xmm6, xmm2);
726 
727         masm.bind(block12);
728         masm.movq(xmm1, recordExternalAddress(crb, pi32Inv));          // 0x6dc9c883, 0x40245f30
729         masm.mulsd(xmm1, xmm0);
730         masm.movq(xmm5, recordExternalAddress(crb, onehalf));          // 0x00000000, 0x3fe00000,
731                                                                        // 0x00000000, 0x3fe00000
732         masm.movq(xmm4, recordExternalAddress(crb, signMask));         // 0x00000000, 0x80000000
733         masm.pand(xmm4, xmm0);
734         masm.por(xmm5, xmm4);
735         masm.addpd(xmm1, xmm5);
736         masm.cvttsd2sil(rdx, xmm1);
737         masm.cvtsi2sdl(xmm1, rdx);
738         masm.movq(xmm3, recordExternalAddress(crb, p1));               // 0x54400000, 0x3fb921fb
739         masm.movdqu(xmm2, recordExternalAddress(crb, p2));             // 0x1a600000, 0x3d90b461,
740                                                                        // 0x1a600000, 0x3d90b461
741         masm.mulsd(xmm3, xmm1);
742         masm.unpcklpd(xmm1, xmm1);
743         masm.shll(rax, 3);
744         masm.addl(rdx, 1865216);
745         masm.movdqu(xmm4, xmm0);
746         masm.addl(rdx, rax);
747         masm.andl(rdx, 63);
748         masm.movdqu(xmm5, recordExternalAddress(crb, sc4));            // 0x54400000, 0x3fb921fb
749         masm.leaq(AMD64.rax, recordExternalAddress(crb, ctable));
750         masm.shll(rdx, 5);
751         masm.addq(AMD64.rax, AMD64.rdx);
752         masm.mulpd(xmm2, xmm1);
753         masm.subsd(xmm0, xmm3);
754         masm.mulsd(xmm1, recordExternalAddress(crb, p3));              // 0x2e037073, 0x3b63198a
755         masm.subsd(xmm4, xmm3);
756         masm.movq(xmm7, new AMD64Address(AMD64.rax, 8));
757         masm.unpcklpd(xmm0, xmm0);
758         masm.movdqu(xmm3, xmm4);
759         masm.subsd(xmm4, xmm2);
760         masm.mulpd(xmm5, xmm0);
761         masm.subpd(xmm0, xmm2);
762         masm.mulsd(xmm7, xmm4);
763         masm.subsd(xmm3, xmm4);
764         masm.mulpd(xmm5, xmm0);
765         masm.mulpd(xmm0, xmm0);
766         masm.subsd(xmm3, xmm2);
767         masm.movdqu(xmm2, new AMD64Address(AMD64.rax, 0));
768         masm.subsd(xmm1, xmm3);
769         masm.movq(xmm3, new AMD64Address(AMD64.rax, 24));
770         masm.addsd(xmm2, xmm3);
771         masm.subsd(xmm7, xmm2);
772         masm.subsd(xmm1, xmm6);
773         masm.movdqu(xmm6, recordExternalAddress(crb, sc2));            // 0x11111111, 0x3f811111,
774                                                                        // 0x55555555, 0x3fa55555
775         masm.mulsd(xmm2, xmm4);
776         masm.mulpd(xmm6, xmm0);
777         masm.mulsd(xmm3, xmm4);
778         masm.mulpd(xmm2, xmm0);
779         masm.mulpd(xmm0, xmm0);
780         masm.addpd(xmm5, recordExternalAddress(crb, sc3));             // 0x1a01a01a, 0xbf2a01a0,
781                                                                        // 0x16c16c17, 0xbf56c16c
782         masm.mulsd(xmm4, new AMD64Address(AMD64.rax, 0));
783         masm.addpd(xmm6, recordExternalAddress(crb, sc1));             // 0x55555555, 0xbfc55555,
784                                                                        // 0x00000000, 0xbfe00000
785         masm.mulpd(xmm5, xmm0);
786         masm.movdqu(xmm0, xmm3);
787         masm.addsd(xmm3, new AMD64Address(AMD64.rax, 8));
788         masm.mulpd(xmm1, xmm7);
789         masm.movdqu(xmm7, xmm4);
790         masm.addsd(xmm4, xmm3);
791         masm.addpd(xmm6, xmm5);
792         masm.movq(xmm5, new AMD64Address(AMD64.rax, 8));
793         masm.subsd(xmm5, xmm3);
794         masm.subsd(xmm3, xmm4);
795         masm.addsd(xmm1, new AMD64Address(AMD64.rax, 16));
796         masm.mulpd(xmm6, xmm2);
797         masm.addsd(xmm5, xmm0);
798         masm.addsd(xmm3, xmm7);
799         masm.addsd(xmm1, xmm5);
800         masm.addsd(xmm1, xmm3);
801         masm.addsd(xmm1, xmm6);
802         masm.unpckhpd(xmm6, xmm6);
803         masm.movdqu(xmm0, xmm4);
804         masm.addsd(xmm1, xmm6);
805         masm.addsd(xmm0, xmm1);
806         masm.jmp(block14);
807 
808         masm.bind(block8);
809         masm.addl(rdx, 64);
810         masm.movq(r9, r10);
811         masm.movq(r10, r8);
812         masm.movl(r8, 0);
813         masm.cmpqAndJcc(r9, 0, ConditionFlag.NotEqual, block9, false);
814         masm.addl(rdx, 64);
815         masm.movq(r9, r10);
816         masm.movq(r10, r8);
817         masm.cmpqAndJcc(r9, 0, ConditionFlag.NotEqual, block9, false);
818         masm.xorpd(xmm0, xmm0);
819         masm.xorpd(xmm6, xmm6);
820         masm.jmp(block12);
821 
822         masm.bind(block10);
823         masm.jcc(ConditionFlag.Equal, block11);
824         masm.negl(rcx);
825         masm.shrq(r10);
826         masm.movq(AMD64.rax, r9);
827         masm.shrq(r9);
828         masm.subl(rdx, rcx);
829         masm.negl(rcx);
830         masm.addl(rcx, 64);
831         masm.shlq(AMD64.rax);
832         masm.orq(r10, AMD64.rax);
833         masm.jmp(block11);
834 
835         masm.bind(block4);
836         masm.negl(rcx);
837         masm.shlq(r9, 32);
838         masm.orq(r9, r11);
839         masm.shlq(r9);
840         masm.movq(rdi, r9);
841         masm.testlAndJcc(r9, Integer.MIN_VALUE, ConditionFlag.NotEqual, block13, false);
842         masm.shrl(r9);
843         masm.movl(rbx, 0);
844         masm.shrq(rdi, 3);
845         masm.jmp(block7);
846 
847         masm.bind(block5);
848         masm.shrl(r9);
849         masm.movl(rbx, 536870912);
850         masm.shrl(rbx);
851         masm.shlq(r9, 32);
852         masm.orq(r9, r11);
853         masm.shlq(AMD64.rbx, 32);
854         masm.addl(rdi, 536870912);
855         masm.movl(AMD64.rcx, 0);
856         masm.movl(r11, 0);
857         masm.subq(AMD64.rcx, r8);
858         masm.sbbq(r11, r10);
859         masm.sbbq(AMD64.rbx, r9);
860         masm.movq(r8, AMD64.rcx);
861         masm.movq(r10, r11);
862         masm.movq(r9, AMD64.rbx);
863         masm.movl(rbx, 32768);
864         masm.jmp(block6);
865 
866         masm.bind(block13);
867         masm.shrl(r9);
868         masm.movq(AMD64.rbx, 0x100000000L);
869         masm.shrq(AMD64.rbx);
870         masm.movl(AMD64.rcx, 0);
871         masm.movl(r11, 0);
872         masm.subq(AMD64.rcx, r8);
873         masm.sbbq(r11, r10);
874         masm.sbbq(AMD64.rbx, r9);
875         masm.movq(r8, AMD64.rcx);
876         masm.movq(r10, r11);
877         masm.movq(r9, AMD64.rbx);
878         masm.movl(rbx, 32768);
879         masm.shrq(rdi, 3);
880         masm.addl(rdi, 536870912);
881         masm.jmp(block7);
882 
883         masm.bind(block3);
884         masm.movq(xmm0, new AMD64Address(rsp, 8));
885         masm.mulsd(xmm0, recordExternalAddress(crb, negZero));         // 0x00000000, 0x80000000
886         masm.movq(new AMD64Address(rsp, 0), xmm0);
887 
888         masm.bind(block14);
889         masm.addq(rsp, 16);
890         masm.pop(AMD64.rbx);
891     }
892 }
    </pre>
  </body>
</html>