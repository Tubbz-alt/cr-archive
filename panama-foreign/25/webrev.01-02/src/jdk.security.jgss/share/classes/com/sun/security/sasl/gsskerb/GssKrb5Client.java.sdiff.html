<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/jdk.security.jgss/share/classes/com/sun/security/sasl/gsskerb/GssKrb5Client.java</title>
    <link rel="stylesheet" href="../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="../../../../../../../../jdk.management/unix/classes/com/sun/management/internal/OperatingSystemImpl.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="../../../../../../../../jdk.unsupported/share/classes/sun/misc/Unsafe.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/jdk.security.jgss/share/classes/com/sun/security/sasl/gsskerb/GssKrb5Client.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2000, 2019, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.  Oracle designates this
  8  * particular file as subject to the &quot;Classpath&quot; exception as provided
  9  * by Oracle in the LICENSE file that accompanied this code.
 10  *
 11  * This code is distributed in the hope that it will be useful, but WITHOUT
 12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 14  * version 2 for more details (a copy is included in the LICENSE file that
 15  * accompanied this code).
 16  *
 17  * You should have received a copy of the GNU General Public License version
 18  * 2 along with this work; if not, write to the Free Software Foundation,
 19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 20  *
 21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 22  * or visit www.oracle.com if you need additional information or have any
 23  * questions.
 24  */
 25 
 26 package com.sun.security.sasl.gsskerb;
 27 
<span class="line-removed"> 28 import java.io.IOException;</span>
 29 import java.util.Map;
 30 import java.util.logging.Level;
 31 import javax.security.sasl.*;
 32 
 33 import static java.nio.charset.StandardCharsets.UTF_8;
 34 
 35 // JAAS
 36 import javax.security.auth.callback.CallbackHandler;
 37 
 38 // JGSS
 39 import org.ietf.jgss.*;
 40 
 41 /**
 42   * Implements the GSSAPI SASL client mechanism for Kerberos V5.
 43   * (&lt;A HREF=&quot;http://www.ietf.org/rfc/rfc2222.txt&quot;&gt;RFC 2222&lt;/A&gt;,
 44   * &lt;a HREF=&quot;http://www.ietf.org/internet-drafts/draft-ietf-cat-sasl-gssapi-04.txt&quot;&gt;draft-ietf-cat-sasl-gssapi-04.txt&lt;/a&gt;).
 45   * It uses the Java Bindings for GSSAPI
 46   * (&lt;A HREF=&quot;http://www.ietf.org/rfc/rfc2853.txt&quot;&gt;RFC 2853&lt;/A&gt;)
 47   * for getting GSSAPI/Kerberos V5 support.
 48   *
</pre>
<hr />
<pre>
 68   * - quality of protection; list of auth, auth-int, auth-conf; default is &quot;auth&quot;
 69   * javax.security.sasl.maxbuf
 70   * - max receive buffer size; default is 65536
 71   * javax.security.sasl.sendmaxbuffer
 72   * - max send buffer size; default is 65536; (min with server max recv size)
 73   *
 74   * javax.security.sasl.server.authentication
 75   * - &quot;true&quot; means require mutual authentication; default is &quot;false&quot;
 76   *
 77   * javax.security.sasl.credentials
 78   * - an {@link org.ietf.jgss.GSSCredential} used for delegated authentication.
 79   *
 80   * @author Rosanna Lee
 81   */
 82 
 83 final class GssKrb5Client extends GssKrb5Base implements SaslClient {
 84     // ---------------- Constants -----------------
 85     private static final String MY_CLASS_NAME = GssKrb5Client.class.getName();
 86 
 87     private boolean finalHandshake = false;
<span class="line-removed"> 88     private boolean mutual = false;       // default false</span>
 89     private byte[] authzID;
 90 
 91     /**
 92      * Creates a SASL mechanism with client credentials that it needs
 93      * to participate in GSS-API/Kerberos v5 authentication exchange
 94      * with the server.
 95      */
 96     GssKrb5Client(String authzID, String protocol, String serverName,
 97         Map&lt;String, ?&gt; props, CallbackHandler cbh) throws SaslException {
 98 
 99         super(props, MY_CLASS_NAME);
100 
101         String service = protocol + &quot;@&quot; + serverName;
102         logger.log(Level.FINE, &quot;KRB5CLNT01:Requesting service name: {0}&quot;,
103             service);
104 
105         try {
106             GSSManager mgr = GSSManager.getInstance();
107 
108             // Create the name for the requested service entity for Krb5 mech
</pre>
<hr />
<pre>
115                 Object prop = props.get(Sasl.CREDENTIALS);
116                 if (prop != null &amp;&amp; prop instanceof GSSCredential) {
117                     credentials = (GSSCredential) prop;
118                     logger.log(Level.FINE,
119                         &quot;KRB5CLNT01:Using the credentials supplied in &quot; +
120                         &quot;javax.security.sasl.credentials&quot;);
121                 }
122             }
123 
124             // Create a context using credentials for Krb5 mech
125             secCtx = mgr.createContext(acceptorName,
126                 KRB5_OID,   /* mechanism */
127                 credentials, /* credentials */
128                 GSSContext.INDEFINITE_LIFETIME);
129 
130             // Request credential delegation when credentials have been supplied
131             if (credentials != null) {
132                 secCtx.requestCredDeleg(true);
133             }
134 
<span class="line-modified">135             // Parse properties  to set desired context options</span>










136             if (props != null) {
137                 // Mutual authentication
138                 String prop = (String)props.get(Sasl.SERVER_AUTH);
139                 if (prop != null) {
140                     mutual = &quot;true&quot;.equalsIgnoreCase(prop);
141                 }
142             }
143             secCtx.requestMutualAuth(mutual);
144 
145             // Always specify potential need for integrity and confidentiality
146             // Decision will be made during final handshake
147             secCtx.requestConf(true);
148             secCtx.requestInteg(true);
149 
150         } catch (GSSException e) {
151             throw new SaslException(&quot;Failure to initialize security context&quot;, e);
152         }
153 
154         if (authzID != null &amp;&amp; authzID.length() &gt; 0) {
155             this.authzID = authzID.getBytes(UTF_8);
</pre>
</td>
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2000, 2020, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.  Oracle designates this
  8  * particular file as subject to the &quot;Classpath&quot; exception as provided
  9  * by Oracle in the LICENSE file that accompanied this code.
 10  *
 11  * This code is distributed in the hope that it will be useful, but WITHOUT
 12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 14  * version 2 for more details (a copy is included in the LICENSE file that
 15  * accompanied this code).
 16  *
 17  * You should have received a copy of the GNU General Public License version
 18  * 2 along with this work; if not, write to the Free Software Foundation,
 19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 20  *
 21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 22  * or visit www.oracle.com if you need additional information or have any
 23  * questions.
 24  */
 25 
 26 package com.sun.security.sasl.gsskerb;
 27 

 28 import java.util.Map;
 29 import java.util.logging.Level;
 30 import javax.security.sasl.*;
 31 
 32 import static java.nio.charset.StandardCharsets.UTF_8;
 33 
 34 // JAAS
 35 import javax.security.auth.callback.CallbackHandler;
 36 
 37 // JGSS
 38 import org.ietf.jgss.*;
 39 
 40 /**
 41   * Implements the GSSAPI SASL client mechanism for Kerberos V5.
 42   * (&lt;A HREF=&quot;http://www.ietf.org/rfc/rfc2222.txt&quot;&gt;RFC 2222&lt;/A&gt;,
 43   * &lt;a HREF=&quot;http://www.ietf.org/internet-drafts/draft-ietf-cat-sasl-gssapi-04.txt&quot;&gt;draft-ietf-cat-sasl-gssapi-04.txt&lt;/a&gt;).
 44   * It uses the Java Bindings for GSSAPI
 45   * (&lt;A HREF=&quot;http://www.ietf.org/rfc/rfc2853.txt&quot;&gt;RFC 2853&lt;/A&gt;)
 46   * for getting GSSAPI/Kerberos V5 support.
 47   *
</pre>
<hr />
<pre>
 67   * - quality of protection; list of auth, auth-int, auth-conf; default is &quot;auth&quot;
 68   * javax.security.sasl.maxbuf
 69   * - max receive buffer size; default is 65536
 70   * javax.security.sasl.sendmaxbuffer
 71   * - max send buffer size; default is 65536; (min with server max recv size)
 72   *
 73   * javax.security.sasl.server.authentication
 74   * - &quot;true&quot; means require mutual authentication; default is &quot;false&quot;
 75   *
 76   * javax.security.sasl.credentials
 77   * - an {@link org.ietf.jgss.GSSCredential} used for delegated authentication.
 78   *
 79   * @author Rosanna Lee
 80   */
 81 
 82 final class GssKrb5Client extends GssKrb5Base implements SaslClient {
 83     // ---------------- Constants -----------------
 84     private static final String MY_CLASS_NAME = GssKrb5Client.class.getName();
 85 
 86     private boolean finalHandshake = false;

 87     private byte[] authzID;
 88 
 89     /**
 90      * Creates a SASL mechanism with client credentials that it needs
 91      * to participate in GSS-API/Kerberos v5 authentication exchange
 92      * with the server.
 93      */
 94     GssKrb5Client(String authzID, String protocol, String serverName,
 95         Map&lt;String, ?&gt; props, CallbackHandler cbh) throws SaslException {
 96 
 97         super(props, MY_CLASS_NAME);
 98 
 99         String service = protocol + &quot;@&quot; + serverName;
100         logger.log(Level.FINE, &quot;KRB5CLNT01:Requesting service name: {0}&quot;,
101             service);
102 
103         try {
104             GSSManager mgr = GSSManager.getInstance();
105 
106             // Create the name for the requested service entity for Krb5 mech
</pre>
<hr />
<pre>
113                 Object prop = props.get(Sasl.CREDENTIALS);
114                 if (prop != null &amp;&amp; prop instanceof GSSCredential) {
115                     credentials = (GSSCredential) prop;
116                     logger.log(Level.FINE,
117                         &quot;KRB5CLNT01:Using the credentials supplied in &quot; +
118                         &quot;javax.security.sasl.credentials&quot;);
119                 }
120             }
121 
122             // Create a context using credentials for Krb5 mech
123             secCtx = mgr.createContext(acceptorName,
124                 KRB5_OID,   /* mechanism */
125                 credentials, /* credentials */
126                 GSSContext.INDEFINITE_LIFETIME);
127 
128             // Request credential delegation when credentials have been supplied
129             if (credentials != null) {
130                 secCtx.requestCredDeleg(true);
131             }
132 
<span class="line-modified">133             // mutual is by default true if there is a security layer</span>
<span class="line-added">134             boolean mutual;</span>
<span class="line-added">135             if ((allQop &amp; INTEGRITY_ONLY_PROTECTION) != 0</span>
<span class="line-added">136                     || (allQop &amp; PRIVACY_PROTECTION) != 0) {</span>
<span class="line-added">137                 mutual = true;</span>
<span class="line-added">138                 secCtx.requestSequenceDet(true);</span>
<span class="line-added">139             } else {</span>
<span class="line-added">140                 mutual = false;</span>
<span class="line-added">141             }</span>
<span class="line-added">142 </span>
<span class="line-added">143             // User can override default mutual flag</span>
144             if (props != null) {
145                 // Mutual authentication
146                 String prop = (String)props.get(Sasl.SERVER_AUTH);
147                 if (prop != null) {
148                     mutual = &quot;true&quot;.equalsIgnoreCase(prop);
149                 }
150             }
151             secCtx.requestMutualAuth(mutual);
152 
153             // Always specify potential need for integrity and confidentiality
154             // Decision will be made during final handshake
155             secCtx.requestConf(true);
156             secCtx.requestInteg(true);
157 
158         } catch (GSSException e) {
159             throw new SaslException(&quot;Failure to initialize security context&quot;, e);
160         }
161 
162         if (authzID != null &amp;&amp; authzID.length() &gt; 0) {
163             this.authzID = authzID.getBytes(UTF_8);
</pre>
</td>
</tr>
</table>
<center><a href="../../../../../../../../jdk.management/unix/classes/com/sun/management/internal/OperatingSystemImpl.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="../../../../../../../../jdk.unsupported/share/classes/sun/misc/Unsafe.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>