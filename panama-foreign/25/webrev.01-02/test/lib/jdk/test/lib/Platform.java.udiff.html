<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff test/lib/jdk/test/lib/Platform.java</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
<body>
<center><a href="../../../../langtools/tools/javac/diags/examples/RedundantTypesWithWildcardProc/processors/AnnoProc.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="artifacts/DefaultArtifactManager.java.udiff.html" target="_top">next &gt;</a></center>    <h2>test/lib/jdk/test/lib/Platform.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -22,14 +22,16 @@</span>
   */
  
  package jdk.test.lib;
  
  import java.io.File;
<span class="udiff-line-added">+ import java.io.FileNotFoundException;</span>
  import java.io.IOException;
  import java.io.RandomAccessFile;
  import java.nio.file.Path;
  import java.nio.file.Paths;
<span class="udiff-line-added">+ import java.util.concurrent.TimeUnit;</span>
  import java.util.regex.Pattern;
  import java.security.AccessController;
  import java.security.PrivilegedAction;
  import java.security.PrivilegedActionException;
  import java.security.PrivilegedExceptionAction;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -229,21 +231,74 @@</span>
          }
          // Other platforms expected to work:
          return true;
      }
  
<span class="udiff-line-added">+     /**</span>
<span class="udiff-line-added">+      * Return true if the test JDK is signed, otherwise false. Only valid on OSX.</span>
<span class="udiff-line-added">+      */</span>
<span class="udiff-line-added">+     public static boolean isSignedOSX() throws IOException {</span>
<span class="udiff-line-added">+         // We only care about signed binaries for 10.14 and later (actually 10.14.5, but</span>
<span class="udiff-line-added">+         // for simplicity we&#39;ll also include earlier 10.14 versions).</span>
<span class="udiff-line-added">+         if (getOsVersionMajor() == 10 &amp;&amp; getOsVersionMinor() &lt; 14) {</span>
<span class="udiff-line-added">+             return false; // assume not signed</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         // Find the path to the java binary.</span>
<span class="udiff-line-added">+         String jdkPath = System.getProperty(&quot;java.home&quot;);</span>
<span class="udiff-line-added">+         Path javaPath = Paths.get(jdkPath + &quot;/bin/java&quot;);</span>
<span class="udiff-line-added">+         String javaFileName = javaPath.toAbsolutePath().toString();</span>
<span class="udiff-line-added">+         if (!javaPath.toFile().exists()) {</span>
<span class="udiff-line-added">+             throw new FileNotFoundException(&quot;Could not find file &quot; + javaFileName);</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         // Run codesign on the java binary.</span>
<span class="udiff-line-added">+         ProcessBuilder pb = new ProcessBuilder(&quot;codesign&quot;, &quot;-d&quot;, &quot;-v&quot;, javaFileName);</span>
<span class="udiff-line-added">+         pb.redirectError(ProcessBuilder.Redirect.DISCARD);</span>
<span class="udiff-line-added">+         pb.redirectOutput(ProcessBuilder.Redirect.DISCARD);</span>
<span class="udiff-line-added">+         Process codesignProcess = pb.start();</span>
<span class="udiff-line-added">+         try {</span>
<span class="udiff-line-added">+             if (codesignProcess.waitFor(10, TimeUnit.SECONDS) == false) {</span>
<span class="udiff-line-added">+                 System.err.println(&quot;Timed out waiting for the codesign process to complete. Assuming not signed.&quot;);</span>
<span class="udiff-line-added">+                 codesignProcess.destroyForcibly();</span>
<span class="udiff-line-added">+                 return false; // assume not signed</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+         } catch (InterruptedException e) {</span>
<span class="udiff-line-added">+             throw new RuntimeException(e);</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         // Check codesign result to see if java binary is signed. Here are the</span>
<span class="udiff-line-added">+         // exit code meanings:</span>
<span class="udiff-line-added">+         //    0: signed</span>
<span class="udiff-line-added">+         //    1: not signed</span>
<span class="udiff-line-added">+         //    2: invalid arguments</span>
<span class="udiff-line-added">+         //    3: only has meaning with the -R argument.</span>
<span class="udiff-line-added">+         // So we should always get 0 or 1 as an exit value.</span>
<span class="udiff-line-added">+         if (codesignProcess.exitValue() == 0) {</span>
<span class="udiff-line-added">+             System.out.println(&quot;Target JDK is signed. Some tests may be skipped.&quot;);</span>
<span class="udiff-line-added">+             return true; // signed</span>
<span class="udiff-line-added">+         } else if (codesignProcess.exitValue() == 1) {</span>
<span class="udiff-line-added">+             System.out.println(&quot;Target JDK is not signed.&quot;);</span>
<span class="udiff-line-added">+             return false; // not signed</span>
<span class="udiff-line-added">+         } else {</span>
<span class="udiff-line-added">+             System.err.println(&quot;Executing codesign failed. Assuming unsigned: &quot; +</span>
<span class="udiff-line-added">+                                codesignProcess.exitValue());</span>
<span class="udiff-line-added">+             return false; // not signed</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
      /**
       * Return a boolean for whether we expect to be able to attach
       * the SA to our own processes on this system.  This requires
       * that SA is ported/available on this platform.
       */
      public static boolean shouldSAAttach() throws IOException {
          if (!hasSA()) return false;
          if (isLinux()) {
              return canPtraceAttachLinux();
          } else if (isOSX()) {
<span class="udiff-line-modified-removed">-             return canAttachOSX();</span>
<span class="udiff-line-modified-added">+             return canAttachOSX() &amp;&amp; !isSignedOSX();</span>
          } else {
              // Other platforms expected to work:
              return true;
          }
      }
</pre>
<center><a href="../../../../langtools/tools/javac/diags/examples/RedundantTypesWithWildcardProc/processors/AnnoProc.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="artifacts/DefaultArtifactManager.java.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>