<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff src/jdk.incubator.jextract/share/classes/jdk/internal/jextract/impl/Parser.java</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="../../../incubator/jextract/Position.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="PrettyPrinter.java.udiff.html" target="_top">next &gt;</a></center>    <h2>src/jdk.incubator.jextract/share/classes/jdk/internal/jextract/impl/Parser.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -23,10 +23,15 @@</span>
   *  questions.
   *
   */
  package jdk.internal.jextract.impl;
  
<span class="udiff-line-added">+ import java.nio.file.Path;</span>
<span class="udiff-line-added">+ import java.util.ArrayList;</span>
<span class="udiff-line-added">+ import java.util.Collection;</span>
<span class="udiff-line-added">+ import java.util.List;</span>
<span class="udiff-line-added">+ import java.util.Optional;</span>
  import jdk.incubator.jextract.Declaration;
  import jdk.incubator.jextract.JextractTask;
  import jdk.incubator.jextract.Position;
  import jdk.internal.clang.Cursor;
  import jdk.internal.clang.CursorKind;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -35,22 +40,18 @@</span>
  import jdk.internal.clang.LibClang;
  import jdk.internal.clang.SourceLocation;
  import jdk.internal.clang.SourceRange;
  import jdk.internal.clang.TranslationUnit;
  
<span class="udiff-line-removed">- import java.nio.file.Path;</span>
<span class="udiff-line-removed">- import java.util.ArrayList;</span>
<span class="udiff-line-removed">- import java.util.Collection;</span>
<span class="udiff-line-removed">- import java.util.List;</span>
<span class="udiff-line-removed">- import java.util.Optional;</span>
<span class="udiff-line-removed">- </span>
  class Parser {
      private final TreeMaker treeMaker;
      private final JextractTask.ConstantParser constantParser;
<span class="udiff-line-added">+     private final PositionTracker tracker;</span>
  
      public Parser(JextractTask.ConstantParser constantParser) {
<span class="udiff-line-modified-removed">-         this.treeMaker = new TreeMaker();</span>
<span class="udiff-line-modified-added">+         this.tracker = new PositionTracker();</span>
<span class="udiff-line-added">+         this.treeMaker = new TreeMaker(tracker);</span>
          this.constantParser = constantParser;
      }
  
      public Declaration.Scoped parse(Path path, Collection&lt;String&gt; args) {
          final Index index = LibClang.createIndex(false);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -66,23 +67,24 @@</span>
          JextractTask.ConstantParser constantParser = this.constantParser != null ?
                  this.constantParser : new DefaultConstantParser(new MacroParserImpl(tu, args));
  
          List&lt;Declaration&gt; decls = new ArrayList&lt;&gt;();
          Cursor tuCursor = tu.getCursor();
<span class="udiff-line-added">+         tracker.start(path);</span>
          tuCursor.children().
              forEach(c -&gt; {
<span class="udiff-line-added">+                 tracker.track(c);</span>
                  SourceLocation loc = c.getSourceLocation();
                  if (loc == null) {
                      return;
                  }
  
                  SourceLocation.Location src = loc.getFileLocation();
                  if (src == null) {
                      return;
                  }
  
<span class="udiff-line-removed">- </span>
                  if (c.isDeclaration()) {
                      if (c.kind() == CursorKind.UnexposedDecl ||
                          c.kind() == CursorKind.Namespace) {
                          c.children().map(treeMaker::createTree)
                                  .filter(t -&gt; t != null)
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -121,14 +123,14 @@</span>
              this.macroParser = macroParser;
          }
  
          @Override
          public Optional&lt;Declaration.Constant&gt; parseConstant(Position pos, String name, String[] tokens) {
<span class="udiff-line-modified-removed">-             if (!(pos instanceof TreeMaker.CursorPosition)) {</span>
<span class="udiff-line-modified-added">+             if (!(pos instanceof CursorPosition)) {</span>
                  return Optional.empty();
              } else {
<span class="udiff-line-modified-removed">-                 Cursor cursor = ((TreeMaker.CursorPosition)pos).cursor();</span>
<span class="udiff-line-modified-added">+                 Cursor cursor = ((CursorPosition)pos).cursor();</span>
                  if (cursor.isMacroFunctionLike()) {
                      return Optional.empty();
                  } else {
                      return Optional.ofNullable(treeMaker.createMacro(cursor, macroParser.eval(name, tokens)));
                  }
</pre>
<center><a href="../../../incubator/jextract/Position.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="PrettyPrinter.java.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>