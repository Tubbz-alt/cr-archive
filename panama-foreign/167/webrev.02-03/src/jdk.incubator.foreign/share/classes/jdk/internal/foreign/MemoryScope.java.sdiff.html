<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/jdk.incubator.foreign/share/classes/jdk/internal/foreign/MemoryScope.java</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
  </head>
<body>
<center>&lt; prev <a href="../../../../../../../index.html" target="_top">index</a> next &gt;</center>    <h2>src/jdk.incubator.foreign/share/classes/jdk/internal/foreign/MemoryScope.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
248             Objects.requireNonNull(newOwner, &quot;newOwner&quot;);
249             // pre-allocate duped scope so we don&#39;t get OOME later and be left with this scope closed
250             var duped = new Root(newOwner, ref, cleanupAction);
251             justClose();
252             return duped;
253         }
254 
255         @Override
256         void close() {
257             justClose();
258             if (cleanupAction != null) {
259                 cleanupAction.run();
260             }
261         }
262 
263         @ForceInline
264         private void justClose() {
265             // enter critical section - no acquires are possible past this point
266             long stamp = lock.writeLock();
267             try {
<span class="line-modified">268                 checkAliveConfined(this); // plain read is enough here (full write lock)</span>
269                 // check for absence of active acquired children
270                 if (acquired.sum() &gt; 0) {
271                     throw new IllegalStateException(&quot;Cannot close this scope as it has active acquired children&quot;);
272                 }
273                 // now that we made sure there&#39;s no active acquired children, we can mark scope as closed
274                 CLOSED.set(this, true); // plain write is enough here (full write lock)
275             } finally {
276                 // leave critical section
277                 lock.unlockWrite(stamp);
278             }
279         }
280 
281         private final class Child extends MemoryScope {
282 
283             private Child(Thread owner) {
284                 super(owner);
285             }
286 
287             @Override
288             MemoryScope acquire() {
</pre>
</td>
<td>
<hr />
<pre>
248             Objects.requireNonNull(newOwner, &quot;newOwner&quot;);
249             // pre-allocate duped scope so we don&#39;t get OOME later and be left with this scope closed
250             var duped = new Root(newOwner, ref, cleanupAction);
251             justClose();
252             return duped;
253         }
254 
255         @Override
256         void close() {
257             justClose();
258             if (cleanupAction != null) {
259                 cleanupAction.run();
260             }
261         }
262 
263         @ForceInline
264         private void justClose() {
265             // enter critical section - no acquires are possible past this point
266             long stamp = lock.writeLock();
267             try {
<span class="line-modified">268                 checkValidState(); // plain read is enough here (full write lock)</span>
269                 // check for absence of active acquired children
270                 if (acquired.sum() &gt; 0) {
271                     throw new IllegalStateException(&quot;Cannot close this scope as it has active acquired children&quot;);
272                 }
273                 // now that we made sure there&#39;s no active acquired children, we can mark scope as closed
274                 CLOSED.set(this, true); // plain write is enough here (full write lock)
275             } finally {
276                 // leave critical section
277                 lock.unlockWrite(stamp);
278             }
279         }
280 
281         private final class Child extends MemoryScope {
282 
283             private Child(Thread owner) {
284                 super(owner);
285             }
286 
287             @Override
288             MemoryScope acquire() {
</pre>
</td>
</tr>
</table>
<center>&lt; prev <a href="../../../../../../../index.html" target="_top">index</a> next &gt;</center>  </body>
</html>