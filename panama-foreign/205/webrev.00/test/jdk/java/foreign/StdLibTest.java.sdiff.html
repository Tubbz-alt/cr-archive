<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff test/jdk/java/foreign/StdLibTest.java</title>
    <link rel="stylesheet" href="../../../../style.css" />
  </head>
<body>
<center>&lt; prev <a href="../../../../index.html" target="_top">index</a> next &gt;</center>    <h2>test/jdk/java/foreign/StdLibTest.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 29  *          java.base/sun.security.action
 30  * @build NativeTestHelper StdLibTest
 31  * @run testng/othervm -Dforeign.restricted=permit StdLibTest
 32  */
 33 
 34 import java.lang.invoke.MethodHandle;
 35 import java.lang.invoke.MethodHandles;
 36 import java.lang.invoke.MethodType;
 37 import java.lang.invoke.VarHandle;
 38 import java.nio.ByteOrder;
 39 import java.time.Instant;
 40 import java.time.LocalDateTime;
 41 import java.time.ZoneOffset;
 42 import java.time.ZonedDateTime;
 43 import java.util.ArrayList;
 44 import java.util.Arrays;
 45 import java.util.Collections;
 46 import java.util.LinkedHashSet;
 47 import java.util.List;
 48 import java.util.Set;

 49 import java.util.stream.Collectors;
 50 import java.util.stream.IntStream;
 51 import java.util.stream.LongStream;
 52 import java.util.stream.Stream;
 53 
 54 import jdk.incubator.foreign.CSupport;
 55 import jdk.incubator.foreign.ForeignLinker;
 56 import jdk.incubator.foreign.FunctionDescriptor;
 57 import jdk.incubator.foreign.LibraryLookup;
 58 import jdk.incubator.foreign.MemoryAddress;
 59 import jdk.incubator.foreign.MemoryHandles;
 60 import jdk.incubator.foreign.MemoryLayout;
 61 import jdk.incubator.foreign.MemorySegment;
 62 import jdk.incubator.foreign.SequenceLayout;
 63 import org.testng.annotations.*;
 64 
 65 import static jdk.incubator.foreign.CSupport.*;
 66 import static org.testng.Assert.*;
 67 
 68 @Test
</pre>
<hr />
<pre>
142             val = newVal;
143         }
144         fail(&quot;All values are the same! &quot; + val);
145     }
146 
147     @Test(dataProvider = &quot;printfArgs&quot;)
148     void test_printf(List&lt;PrintfArg&gt; args) throws Throwable {
149         String formatArgs = args.stream()
150                 .map(a -&gt; a.format)
151                 .collect(Collectors.joining(&quot;,&quot;));
152 
153         String formatString = &quot;hello(&quot; + formatArgs + &quot;)\n&quot;;
154 
155         String expected = String.format(formatString, args.stream()
156                 .map(a -&gt; a.javaValue).toArray());
157 
158         int found = stdLibHelper.printf(formatString, args);
159         assertEquals(found, expected.length());
160     }
161 















162     static class StdLibHelper {
163 
164         final static MethodHandle strcat;
165         final static MethodHandle strcmp;
166         final static MethodHandle puts;
167         final static MethodHandle strlen;
168         final static MethodHandle gmtime;
169         final static MethodHandle qsort;
170         final static MethodHandle qsortCompar;
171         final static FunctionDescriptor qsortComparFunction;
172         final static MethodHandle rand;

173         final static MemoryAddress printfAddr;
174         final static FunctionDescriptor printfBase;
175 
176         static {
177             try {
178                 LibraryLookup lookup = LibraryLookup.ofDefault();
179 
180                 strcat = abi.downcallHandle(lookup.lookup(&quot;strcat&quot;),
181                         MethodType.methodType(MemoryAddress.class, MemoryAddress.class, MemoryAddress.class),
182                         FunctionDescriptor.of(C_POINTER, C_POINTER, C_POINTER));
183 
184                 strcmp = abi.downcallHandle(lookup.lookup(&quot;strcmp&quot;),
185                         MethodType.methodType(int.class, MemoryAddress.class, MemoryAddress.class),
186                         FunctionDescriptor.of(C_INT, C_POINTER, C_POINTER));
187 
188                 puts = abi.downcallHandle(lookup.lookup(&quot;puts&quot;),
189                         MethodType.methodType(int.class, MemoryAddress.class),
190                         FunctionDescriptor.of(C_INT, C_POINTER));
191 
192                 strlen = abi.downcallHandle(lookup.lookup(&quot;strlen&quot;),
</pre>
<hr />
<pre>
194                         FunctionDescriptor.of(C_INT, C_POINTER));
195 
196                 gmtime = abi.downcallHandle(lookup.lookup(&quot;gmtime&quot;),
197                         MethodType.methodType(MemoryAddress.class, MemoryAddress.class),
198                         FunctionDescriptor.of(C_POINTER, C_POINTER));
199 
200                 qsortComparFunction = FunctionDescriptor.of(C_INT, C_POINTER, C_POINTER);
201 
202                 qsort = abi.downcallHandle(lookup.lookup(&quot;qsort&quot;),
203                         MethodType.methodType(void.class, MemoryAddress.class, long.class, long.class, MemoryAddress.class),
204                         FunctionDescriptor.ofVoid(C_POINTER, C_LONGLONG, C_LONGLONG, C_POINTER));
205 
206                 //qsort upcall handle
207                 qsortCompar = MethodHandles.lookup().findStatic(StdLibTest.StdLibHelper.class, &quot;qsortCompare&quot;,
208                         MethodType.methodType(int.class, MemorySegment.class, MemoryAddress.class, MemoryAddress.class));
209 
210                 rand = abi.downcallHandle(lookup.lookup(&quot;rand&quot;),
211                         MethodType.methodType(int.class),
212                         FunctionDescriptor.of(C_INT));
213 




214                 printfAddr = lookup.lookup(&quot;printf&quot;);
215 
216                 printfBase = FunctionDescriptor.of(C_INT, C_POINTER);
217             } catch (Throwable ex) {
218                 throw new IllegalStateException(ex);
219             }
220         }
221 
222         String strcat(String s1, String s2) throws Throwable {
223             try (MemorySegment buf = MemorySegment.allocateNative(s1.length() + s2.length() + 1) ;
224                  MemorySegment other = toCString(s2)) {
225                 char[] chars = s1.toCharArray();
226                 for (long i = 0 ; i &lt; chars.length ; i++) {
227                     byteArrHandle.set(buf.baseAddress(), i, (byte)chars[(int)i]);
228                 }
229                 byteArrHandle.set(buf.baseAddress(), (long)chars.length, (byte)&#39;\0&#39;);
230                 return toJavaStringRestricted(((MemoryAddress)strcat.invokeExact(buf.baseAddress(), other.baseAddress())));
231             }
232         }
233 
</pre>
<hr />
<pre>
318                         .mapToInt(i -&gt; (int)intArrHandle.get(nativeArr.baseAddress(), i))
319                         .toArray();
320             }
321         }
322 
323         static int qsortCompare(MemorySegment base, MemoryAddress addr1, MemoryAddress addr2) {
324             return (int)intHandle.get(addr1.rebase(base)) - (int)intHandle.get(addr2.rebase(base));
325         }
326 
327         int rand() throws Throwable {
328             return (int)rand.invokeExact();
329         }
330 
331         int printf(String format, List&lt;PrintfArg&gt; args) throws Throwable {
332             try (MemorySegment formatStr = toCString(format)) {
333                 return (int)specializedPrintf(args).invokeExact(formatStr.baseAddress(),
334                         args.stream().map(a -&gt; a.nativeValue).toArray());
335             }
336         }
337 







338         private MethodHandle specializedPrintf(List&lt;PrintfArg&gt; args) {
339             //method type
340             MethodType mt = MethodType.methodType(int.class, MemoryAddress.class);
341             FunctionDescriptor fd = printfBase;
342             for (PrintfArg arg : args) {
343                 mt = mt.appendParameterTypes(arg.carrier);
344                 fd = fd.appendArgumentLayouts(arg.layout);
345             }
346             MethodHandle mh = abi.downcallHandle(printfAddr, mt, fd);
347             return mh.asSpreader(1, Object[].class, args.size());
348         }
349     }
350 
351     /*** data providers ***/
352 
353     @DataProvider
354     public static Object[][] ints() {
355         return perms(0, new Integer[] { 0, 1, 2, 3, 4 }).stream()
356                 .map(l -&gt; new Object[] { l })
357                 .toArray(Object[][]::new);
</pre>
<hr />
<pre>
385         for (int i = 0 ; i &lt; instants.length ; i++) {
386             Instant instant = start.plusSeconds((long)(Math.random() * (end.getEpochSecond() - start.getEpochSecond())));
387             instants[i] = new Object[] { instant };
388         }
389         return instants;
390     }
391 
392     @DataProvider
393     public static Object[][] printfArgs() {
394         ArrayList&lt;List&lt;PrintfArg&gt;&gt; res = new ArrayList&lt;&gt;();
395         List&lt;List&lt;PrintfArg&gt;&gt; perms = new ArrayList&lt;&gt;(perms(0, PrintfArg.values()));
396         for (int i = 0 ; i &lt; 100 ; i++) {
397             Collections.shuffle(perms);
398             res.addAll(perms);
399         }
400         return res.stream()
401                 .map(l -&gt; new Object[] { l })
402                 .toArray(Object[][]::new);
403     }
404 
<span class="line-modified">405     enum PrintfArg {</span>
<span class="line-modified">406         INTEGRAL(int.class, asVarArg(C_INT), &quot;%d&quot;, 42, 42),</span>
<span class="line-modified">407         STRING(MemoryAddress.class, asVarArg(C_POINTER), &quot;%s&quot;, toCString(&quot;str&quot;).baseAddress(), &quot;str&quot;),</span>
<span class="line-modified">408         CHAR(byte.class, asVarArg(C_CHAR), &quot;%c&quot;, (byte) &#39;h&#39;, &#39;h&#39;),</span>
<span class="line-modified">409         DOUBLE(double.class, asVarArg(C_DOUBLE), &quot;%.4f&quot;, 1.2345d, 1.2345d);</span>

410 
411         final Class&lt;?&gt; carrier;
412         final MemoryLayout layout;
413         final String format;
414         final Object nativeValue;
415         final Object javaValue;


416 
<span class="line-modified">417         PrintfArg(Class&lt;?&gt; carrier, MemoryLayout layout, String format, Object nativeValue, Object javaValue) {</span>
418             this.carrier = carrier;
419             this.layout = layout;
420             this.format = format;
421             this.nativeValue = nativeValue;
422             this.javaValue = javaValue;











423         }
424     }
425 
426     static &lt;Z&gt; Set&lt;List&lt;Z&gt;&gt; perms(int count, Z[] arr) {
427         if (count == arr.length) {
428             return Set.of(List.of());
429         } else {
430             return Arrays.stream(arr)
431                     .flatMap(num -&gt; {
432                         Set&lt;List&lt;Z&gt;&gt; perms = perms(count + 1, arr);
433                         return Stream.concat(
434                                 //take n
435                                 perms.stream().map(l -&gt; {
436                                     List&lt;Z&gt; li = new ArrayList&lt;&gt;(l);
437                                     li.add(num);
438                                     return li;
439                                 }),
440                                 //drop n
441                                 perms.stream());
442                     }).collect(Collectors.toCollection(LinkedHashSet::new));
</pre>
</td>
<td>
<hr />
<pre>
 29  *          java.base/sun.security.action
 30  * @build NativeTestHelper StdLibTest
 31  * @run testng/othervm -Dforeign.restricted=permit StdLibTest
 32  */
 33 
 34 import java.lang.invoke.MethodHandle;
 35 import java.lang.invoke.MethodHandles;
 36 import java.lang.invoke.MethodType;
 37 import java.lang.invoke.VarHandle;
 38 import java.nio.ByteOrder;
 39 import java.time.Instant;
 40 import java.time.LocalDateTime;
 41 import java.time.ZoneOffset;
 42 import java.time.ZonedDateTime;
 43 import java.util.ArrayList;
 44 import java.util.Arrays;
 45 import java.util.Collections;
 46 import java.util.LinkedHashSet;
 47 import java.util.List;
 48 import java.util.Set;
<span class="line-added"> 49 import java.util.function.Consumer;</span>
 50 import java.util.stream.Collectors;
 51 import java.util.stream.IntStream;
 52 import java.util.stream.LongStream;
 53 import java.util.stream.Stream;
 54 
 55 import jdk.incubator.foreign.CSupport;
 56 import jdk.incubator.foreign.ForeignLinker;
 57 import jdk.incubator.foreign.FunctionDescriptor;
 58 import jdk.incubator.foreign.LibraryLookup;
 59 import jdk.incubator.foreign.MemoryAddress;
 60 import jdk.incubator.foreign.MemoryHandles;
 61 import jdk.incubator.foreign.MemoryLayout;
 62 import jdk.incubator.foreign.MemorySegment;
 63 import jdk.incubator.foreign.SequenceLayout;
 64 import org.testng.annotations.*;
 65 
 66 import static jdk.incubator.foreign.CSupport.*;
 67 import static org.testng.Assert.*;
 68 
 69 @Test
</pre>
<hr />
<pre>
143             val = newVal;
144         }
145         fail(&quot;All values are the same! &quot; + val);
146     }
147 
148     @Test(dataProvider = &quot;printfArgs&quot;)
149     void test_printf(List&lt;PrintfArg&gt; args) throws Throwable {
150         String formatArgs = args.stream()
151                 .map(a -&gt; a.format)
152                 .collect(Collectors.joining(&quot;,&quot;));
153 
154         String formatString = &quot;hello(&quot; + formatArgs + &quot;)\n&quot;;
155 
156         String expected = String.format(formatString, args.stream()
157                 .map(a -&gt; a.javaValue).toArray());
158 
159         int found = stdLibHelper.printf(formatString, args);
160         assertEquals(found, expected.length());
161     }
162 
<span class="line-added">163     @Test(dataProvider = &quot;printfArgs&quot;)</span>
<span class="line-added">164     void test_vprintf(List&lt;PrintfArg&gt; args) throws Throwable {</span>
<span class="line-added">165         String formatArgs = args.stream()</span>
<span class="line-added">166                 .map(a -&gt; a.format)</span>
<span class="line-added">167                 .collect(Collectors.joining(&quot;,&quot;));</span>
<span class="line-added">168 </span>
<span class="line-added">169         String formatString = &quot;hello(&quot; + formatArgs + &quot;)\n&quot;;</span>
<span class="line-added">170 </span>
<span class="line-added">171         String expected = String.format(formatString, args.stream()</span>
<span class="line-added">172                 .map(a -&gt; a.javaValue).toArray());</span>
<span class="line-added">173 </span>
<span class="line-added">174         int found = stdLibHelper.vprintf(formatString, args);</span>
<span class="line-added">175         assertEquals(found, expected.length());</span>
<span class="line-added">176     }</span>
<span class="line-added">177 </span>
178     static class StdLibHelper {
179 
180         final static MethodHandle strcat;
181         final static MethodHandle strcmp;
182         final static MethodHandle puts;
183         final static MethodHandle strlen;
184         final static MethodHandle gmtime;
185         final static MethodHandle qsort;
186         final static MethodHandle qsortCompar;
187         final static FunctionDescriptor qsortComparFunction;
188         final static MethodHandle rand;
<span class="line-added">189         final static MethodHandle vprintf;</span>
190         final static MemoryAddress printfAddr;
191         final static FunctionDescriptor printfBase;
192 
193         static {
194             try {
195                 LibraryLookup lookup = LibraryLookup.ofDefault();
196 
197                 strcat = abi.downcallHandle(lookup.lookup(&quot;strcat&quot;),
198                         MethodType.methodType(MemoryAddress.class, MemoryAddress.class, MemoryAddress.class),
199                         FunctionDescriptor.of(C_POINTER, C_POINTER, C_POINTER));
200 
201                 strcmp = abi.downcallHandle(lookup.lookup(&quot;strcmp&quot;),
202                         MethodType.methodType(int.class, MemoryAddress.class, MemoryAddress.class),
203                         FunctionDescriptor.of(C_INT, C_POINTER, C_POINTER));
204 
205                 puts = abi.downcallHandle(lookup.lookup(&quot;puts&quot;),
206                         MethodType.methodType(int.class, MemoryAddress.class),
207                         FunctionDescriptor.of(C_INT, C_POINTER));
208 
209                 strlen = abi.downcallHandle(lookup.lookup(&quot;strlen&quot;),
</pre>
<hr />
<pre>
211                         FunctionDescriptor.of(C_INT, C_POINTER));
212 
213                 gmtime = abi.downcallHandle(lookup.lookup(&quot;gmtime&quot;),
214                         MethodType.methodType(MemoryAddress.class, MemoryAddress.class),
215                         FunctionDescriptor.of(C_POINTER, C_POINTER));
216 
217                 qsortComparFunction = FunctionDescriptor.of(C_INT, C_POINTER, C_POINTER);
218 
219                 qsort = abi.downcallHandle(lookup.lookup(&quot;qsort&quot;),
220                         MethodType.methodType(void.class, MemoryAddress.class, long.class, long.class, MemoryAddress.class),
221                         FunctionDescriptor.ofVoid(C_POINTER, C_LONGLONG, C_LONGLONG, C_POINTER));
222 
223                 //qsort upcall handle
224                 qsortCompar = MethodHandles.lookup().findStatic(StdLibTest.StdLibHelper.class, &quot;qsortCompare&quot;,
225                         MethodType.methodType(int.class, MemorySegment.class, MemoryAddress.class, MemoryAddress.class));
226 
227                 rand = abi.downcallHandle(lookup.lookup(&quot;rand&quot;),
228                         MethodType.methodType(int.class),
229                         FunctionDescriptor.of(C_INT));
230 
<span class="line-added">231                 vprintf = abi.downcallHandle(lookup.lookup(&quot;vprintf&quot;),</span>
<span class="line-added">232                         MethodType.methodType(int.class, MemoryAddress.class, VaList.class),</span>
<span class="line-added">233                         FunctionDescriptor.of(C_INT, C_POINTER, C_VA_LIST));</span>
<span class="line-added">234 </span>
235                 printfAddr = lookup.lookup(&quot;printf&quot;);
236 
237                 printfBase = FunctionDescriptor.of(C_INT, C_POINTER);
238             } catch (Throwable ex) {
239                 throw new IllegalStateException(ex);
240             }
241         }
242 
243         String strcat(String s1, String s2) throws Throwable {
244             try (MemorySegment buf = MemorySegment.allocateNative(s1.length() + s2.length() + 1) ;
245                  MemorySegment other = toCString(s2)) {
246                 char[] chars = s1.toCharArray();
247                 for (long i = 0 ; i &lt; chars.length ; i++) {
248                     byteArrHandle.set(buf.baseAddress(), i, (byte)chars[(int)i]);
249                 }
250                 byteArrHandle.set(buf.baseAddress(), (long)chars.length, (byte)&#39;\0&#39;);
251                 return toJavaStringRestricted(((MemoryAddress)strcat.invokeExact(buf.baseAddress(), other.baseAddress())));
252             }
253         }
254 
</pre>
<hr />
<pre>
339                         .mapToInt(i -&gt; (int)intArrHandle.get(nativeArr.baseAddress(), i))
340                         .toArray();
341             }
342         }
343 
344         static int qsortCompare(MemorySegment base, MemoryAddress addr1, MemoryAddress addr2) {
345             return (int)intHandle.get(addr1.rebase(base)) - (int)intHandle.get(addr2.rebase(base));
346         }
347 
348         int rand() throws Throwable {
349             return (int)rand.invokeExact();
350         }
351 
352         int printf(String format, List&lt;PrintfArg&gt; args) throws Throwable {
353             try (MemorySegment formatStr = toCString(format)) {
354                 return (int)specializedPrintf(args).invokeExact(formatStr.baseAddress(),
355                         args.stream().map(a -&gt; a.nativeValue).toArray());
356             }
357         }
358 
<span class="line-added">359         int vprintf(String format, List&lt;PrintfArg&gt; args) throws Throwable {</span>
<span class="line-added">360             try (MemorySegment formatStr = toCString(format)) {</span>
<span class="line-added">361                 return (int)vprintf.invokeExact(formatStr.baseAddress(),</span>
<span class="line-added">362                         newVaList(b -&gt; args.forEach(a -&gt; a.accept(b))));</span>
<span class="line-added">363             }</span>
<span class="line-added">364         }</span>
<span class="line-added">365 </span>
366         private MethodHandle specializedPrintf(List&lt;PrintfArg&gt; args) {
367             //method type
368             MethodType mt = MethodType.methodType(int.class, MemoryAddress.class);
369             FunctionDescriptor fd = printfBase;
370             for (PrintfArg arg : args) {
371                 mt = mt.appendParameterTypes(arg.carrier);
372                 fd = fd.appendArgumentLayouts(arg.layout);
373             }
374             MethodHandle mh = abi.downcallHandle(printfAddr, mt, fd);
375             return mh.asSpreader(1, Object[].class, args.size());
376         }
377     }
378 
379     /*** data providers ***/
380 
381     @DataProvider
382     public static Object[][] ints() {
383         return perms(0, new Integer[] { 0, 1, 2, 3, 4 }).stream()
384                 .map(l -&gt; new Object[] { l })
385                 .toArray(Object[][]::new);
</pre>
<hr />
<pre>
413         for (int i = 0 ; i &lt; instants.length ; i++) {
414             Instant instant = start.plusSeconds((long)(Math.random() * (end.getEpochSecond() - start.getEpochSecond())));
415             instants[i] = new Object[] { instant };
416         }
417         return instants;
418     }
419 
420     @DataProvider
421     public static Object[][] printfArgs() {
422         ArrayList&lt;List&lt;PrintfArg&gt;&gt; res = new ArrayList&lt;&gt;();
423         List&lt;List&lt;PrintfArg&gt;&gt; perms = new ArrayList&lt;&gt;(perms(0, PrintfArg.values()));
424         for (int i = 0 ; i &lt; 100 ; i++) {
425             Collections.shuffle(perms);
426             res.addAll(perms);
427         }
428         return res.stream()
429                 .map(l -&gt; new Object[] { l })
430                 .toArray(Object[][]::new);
431     }
432 
<span class="line-modified">433     enum PrintfArg implements Consumer&lt;VaList.Builder&gt; {</span>
<span class="line-modified">434 </span>
<span class="line-modified">435         INTEGRAL(int.class, asVarArg(C_INT), &quot;%d&quot;, 42, 42, VaList.Builder::vargFromInt),</span>
<span class="line-modified">436         STRING(MemoryAddress.class, asVarArg(C_POINTER), &quot;%s&quot;, toCString(&quot;str&quot;).baseAddress(), &quot;str&quot;, VaList.Builder::vargFromAddress),</span>
<span class="line-modified">437         CHAR(byte.class, asVarArg(C_CHAR), &quot;%c&quot;, (byte) &#39;h&#39;, &#39;h&#39;, (builder, layout, value) -&gt; builder.vargFromInt(C_INT, (int)value)),</span>
<span class="line-added">438         DOUBLE(double.class, asVarArg(C_DOUBLE), &quot;%.4f&quot;, 1.2345d, 1.2345d, VaList.Builder::vargFromDouble);</span>
439 
440         final Class&lt;?&gt; carrier;
441         final MemoryLayout layout;
442         final String format;
443         final Object nativeValue;
444         final Object javaValue;
<span class="line-added">445         @SuppressWarnings(&quot;rawtypes&quot;)</span>
<span class="line-added">446         final VaListBuilderCall builderCall;</span>
447 
<span class="line-modified">448         &lt;Z&gt; PrintfArg(Class&lt;?&gt; carrier, MemoryLayout layout, String format, Z nativeValue, Object javaValue, VaListBuilderCall&lt;Z&gt; builderCall) {</span>
449             this.carrier = carrier;
450             this.layout = layout;
451             this.format = format;
452             this.nativeValue = nativeValue;
453             this.javaValue = javaValue;
<span class="line-added">454             this.builderCall = builderCall;</span>
<span class="line-added">455         }</span>
<span class="line-added">456 </span>
<span class="line-added">457         @Override</span>
<span class="line-added">458         @SuppressWarnings(&quot;unchecked&quot;)</span>
<span class="line-added">459         public void accept(VaList.Builder builder) {</span>
<span class="line-added">460             builderCall.build(builder, layout, nativeValue);</span>
<span class="line-added">461         }</span>
<span class="line-added">462 </span>
<span class="line-added">463         interface VaListBuilderCall&lt;V&gt; {</span>
<span class="line-added">464             void build(VaList.Builder builder, MemoryLayout layout, V value);</span>
465         }
466     }
467 
468     static &lt;Z&gt; Set&lt;List&lt;Z&gt;&gt; perms(int count, Z[] arr) {
469         if (count == arr.length) {
470             return Set.of(List.of());
471         } else {
472             return Arrays.stream(arr)
473                     .flatMap(num -&gt; {
474                         Set&lt;List&lt;Z&gt;&gt; perms = perms(count + 1, arr);
475                         return Stream.concat(
476                                 //take n
477                                 perms.stream().map(l -&gt; {
478                                     List&lt;Z&gt; li = new ArrayList&lt;&gt;(l);
479                                     li.add(num);
480                                     return li;
481                                 }),
482                                 //drop n
483                                 perms.stream());
484                     }).collect(Collectors.toCollection(LinkedHashSet::new));
</pre>
</td>
</tr>
</table>
<center>&lt; prev <a href="../../../../index.html" target="_top">index</a> next &gt;</center>  </body>
</html>