<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames src/hotspot/share/compiler/compileBroker.cpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
    <script type="text/javascript" src="../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>   1 /*
   2  * Copyright (c) 1999, 2020, Oracle and/or its affiliates. All rights reserved.
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.
   8  *
   9  * This code is distributed in the hope that it will be useful, but WITHOUT
  10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  *
  23  */
  24 
  25 #include &quot;precompiled.hpp&quot;
  26 #include &quot;jvm.h&quot;
  27 #include &quot;classfile/symbolTable.hpp&quot;
  28 #include &quot;classfile/systemDictionary.hpp&quot;
  29 #include &quot;classfile/vmSymbols.hpp&quot;
  30 #include &quot;code/codeCache.hpp&quot;
  31 #include &quot;code/codeHeapState.hpp&quot;
  32 #include &quot;code/dependencyContext.hpp&quot;
  33 #include &quot;compiler/compilationPolicy.hpp&quot;
  34 #include &quot;compiler/compileBroker.hpp&quot;
  35 #include &quot;compiler/compileLog.hpp&quot;
  36 #include &quot;compiler/compilerOracle.hpp&quot;
  37 #include &quot;compiler/directivesParser.hpp&quot;
  38 #include &quot;interpreter/linkResolver.hpp&quot;
  39 #include &quot;jfr/jfrEvents.hpp&quot;
  40 #include &quot;logging/log.hpp&quot;
  41 #include &quot;logging/logStream.hpp&quot;
  42 #include &quot;memory/allocation.inline.hpp&quot;
  43 #include &quot;memory/resourceArea.hpp&quot;
  44 #include &quot;memory/universe.hpp&quot;
  45 #include &quot;oops/methodData.hpp&quot;
  46 #include &quot;oops/method.inline.hpp&quot;
  47 #include &quot;oops/oop.inline.hpp&quot;
  48 #include &quot;prims/nativeLookup.hpp&quot;
  49 #include &quot;prims/whitebox.hpp&quot;
  50 #include &quot;runtime/arguments.hpp&quot;
  51 #include &quot;runtime/atomic.hpp&quot;
  52 #include &quot;runtime/handles.inline.hpp&quot;
  53 #include &quot;runtime/init.hpp&quot;
  54 #include &quot;runtime/interfaceSupport.inline.hpp&quot;
  55 #include &quot;runtime/javaCalls.hpp&quot;
  56 #include &quot;runtime/jniHandles.inline.hpp&quot;
  57 #include &quot;runtime/os.hpp&quot;
  58 #include &quot;runtime/safepointVerifiers.hpp&quot;
  59 #include &quot;runtime/sharedRuntime.hpp&quot;
  60 #include &quot;runtime/sweeper.hpp&quot;
  61 #include &quot;runtime/timerTrace.hpp&quot;
  62 #include &quot;runtime/vframe.inline.hpp&quot;
  63 #include &quot;utilities/debug.hpp&quot;
  64 #include &quot;utilities/dtrace.hpp&quot;
  65 #include &quot;utilities/events.hpp&quot;
  66 #include &quot;utilities/formatBuffer.hpp&quot;
  67 #include &quot;utilities/macros.hpp&quot;
  68 #ifdef COMPILER1
  69 #include &quot;c1/c1_Compiler.hpp&quot;
  70 #endif
  71 #if INCLUDE_JVMCI
  72 #include &quot;jvmci/jvmciEnv.hpp&quot;
  73 #include &quot;jvmci/jvmciRuntime.hpp&quot;
  74 #endif
  75 #ifdef COMPILER2
  76 #include &quot;opto/c2compiler.hpp&quot;
  77 #endif
  78 
  79 #ifdef DTRACE_ENABLED
  80 
  81 // Only bother with this argument setup if dtrace is available
  82 
  83 #define DTRACE_METHOD_COMPILE_BEGIN_PROBE(method, comp_name)             \
  84   {                                                                      \
  85     Symbol* klass_name = (method)-&gt;klass_name();                         \
  86     Symbol* name = (method)-&gt;name();                                     \
  87     Symbol* signature = (method)-&gt;signature();                           \
  88     HOTSPOT_METHOD_COMPILE_BEGIN(                                        \
  89       (char *) comp_name, strlen(comp_name),                             \
  90       (char *) klass_name-&gt;bytes(), klass_name-&gt;utf8_length(),           \
  91       (char *) name-&gt;bytes(), name-&gt;utf8_length(),                       \
  92       (char *) signature-&gt;bytes(), signature-&gt;utf8_length());            \
  93   }
  94 
  95 #define DTRACE_METHOD_COMPILE_END_PROBE(method, comp_name, success)      \
  96   {                                                                      \
  97     Symbol* klass_name = (method)-&gt;klass_name();                         \
  98     Symbol* name = (method)-&gt;name();                                     \
  99     Symbol* signature = (method)-&gt;signature();                           \
 100     HOTSPOT_METHOD_COMPILE_END(                                          \
 101       (char *) comp_name, strlen(comp_name),                             \
 102       (char *) klass_name-&gt;bytes(), klass_name-&gt;utf8_length(),           \
 103       (char *) name-&gt;bytes(), name-&gt;utf8_length(),                       \
 104       (char *) signature-&gt;bytes(), signature-&gt;utf8_length(), (success)); \
 105   }
 106 
 107 #else //  ndef DTRACE_ENABLED
 108 
 109 #define DTRACE_METHOD_COMPILE_BEGIN_PROBE(method, comp_name)
 110 #define DTRACE_METHOD_COMPILE_END_PROBE(method, comp_name, success)
 111 
 112 #endif // ndef DTRACE_ENABLED
 113 
 114 bool CompileBroker::_initialized = false;
 115 volatile bool CompileBroker::_should_block = false;
 116 volatile int  CompileBroker::_print_compilation_warning = 0;
 117 volatile jint CompileBroker::_should_compile_new_jobs = run_compilation;
 118 
 119 // The installed compiler(s)
 120 AbstractCompiler* CompileBroker::_compilers[2];
 121 
 122 // The maximum numbers of compiler threads to be determined during startup.
 123 int CompileBroker::_c1_count = 0;
 124 int CompileBroker::_c2_count = 0;
 125 
 126 // An array of compiler names as Java String objects
 127 jobject* CompileBroker::_compiler1_objects = NULL;
 128 jobject* CompileBroker::_compiler2_objects = NULL;
 129 
 130 CompileLog** CompileBroker::_compiler1_logs = NULL;
 131 CompileLog** CompileBroker::_compiler2_logs = NULL;
 132 
 133 // These counters are used to assign an unique ID to each compilation.
 134 volatile jint CompileBroker::_compilation_id     = 0;
 135 volatile jint CompileBroker::_osr_compilation_id = 0;
 136 
 137 // Performance counters
 138 PerfCounter* CompileBroker::_perf_total_compilation = NULL;
 139 PerfCounter* CompileBroker::_perf_osr_compilation = NULL;
 140 PerfCounter* CompileBroker::_perf_standard_compilation = NULL;
 141 
 142 PerfCounter* CompileBroker::_perf_total_bailout_count = NULL;
 143 PerfCounter* CompileBroker::_perf_total_invalidated_count = NULL;
 144 PerfCounter* CompileBroker::_perf_total_compile_count = NULL;
 145 PerfCounter* CompileBroker::_perf_total_osr_compile_count = NULL;
 146 PerfCounter* CompileBroker::_perf_total_standard_compile_count = NULL;
 147 
 148 PerfCounter* CompileBroker::_perf_sum_osr_bytes_compiled = NULL;
 149 PerfCounter* CompileBroker::_perf_sum_standard_bytes_compiled = NULL;
 150 PerfCounter* CompileBroker::_perf_sum_nmethod_size = NULL;
 151 PerfCounter* CompileBroker::_perf_sum_nmethod_code_size = NULL;
 152 
 153 PerfStringVariable* CompileBroker::_perf_last_method = NULL;
 154 PerfStringVariable* CompileBroker::_perf_last_failed_method = NULL;
 155 PerfStringVariable* CompileBroker::_perf_last_invalidated_method = NULL;
 156 PerfVariable*       CompileBroker::_perf_last_compile_type = NULL;
 157 PerfVariable*       CompileBroker::_perf_last_compile_size = NULL;
 158 PerfVariable*       CompileBroker::_perf_last_failed_type = NULL;
 159 PerfVariable*       CompileBroker::_perf_last_invalidated_type = NULL;
 160 
 161 // Timers and counters for generating statistics
 162 elapsedTimer CompileBroker::_t_total_compilation;
 163 elapsedTimer CompileBroker::_t_osr_compilation;
 164 elapsedTimer CompileBroker::_t_standard_compilation;
 165 elapsedTimer CompileBroker::_t_invalidated_compilation;
 166 elapsedTimer CompileBroker::_t_bailedout_compilation;
 167 
 168 int CompileBroker::_total_bailout_count            = 0;
 169 int CompileBroker::_total_invalidated_count        = 0;
 170 int CompileBroker::_total_compile_count            = 0;
 171 int CompileBroker::_total_osr_compile_count        = 0;
 172 int CompileBroker::_total_standard_compile_count   = 0;
 173 int CompileBroker::_total_compiler_stopped_count   = 0;
 174 int CompileBroker::_total_compiler_restarted_count = 0;
 175 
 176 int CompileBroker::_sum_osr_bytes_compiled         = 0;
 177 int CompileBroker::_sum_standard_bytes_compiled    = 0;
 178 int CompileBroker::_sum_nmethod_size               = 0;
 179 int CompileBroker::_sum_nmethod_code_size          = 0;
 180 
 181 long CompileBroker::_peak_compilation_time         = 0;
 182 
 183 CompileQueue* CompileBroker::_c2_compile_queue     = NULL;
 184 CompileQueue* CompileBroker::_c1_compile_queue     = NULL;
 185 
 186 
 187 
 188 class CompilationLog : public StringEventLog {
 189  public:
 190   CompilationLog() : StringEventLog(&quot;Compilation events&quot;, &quot;jit&quot;) {
 191   }
 192 
 193   void log_compile(JavaThread* thread, CompileTask* task) {
 194     StringLogMessage lm;
 195     stringStream sstr(lm.buffer(), lm.size());
 196     // msg.time_stamp().update_to(tty-&gt;time_stamp().ticks());
 197     task-&gt;print(&amp;sstr, NULL, true, false);
 198     log(thread, &quot;%s&quot;, (const char*)lm);
 199   }
 200 
 201   void log_nmethod(JavaThread* thread, nmethod* nm) {
 202     log(thread, &quot;nmethod %d%s &quot; INTPTR_FORMAT &quot; code [&quot; INTPTR_FORMAT &quot;, &quot; INTPTR_FORMAT &quot;]&quot;,
 203         nm-&gt;compile_id(), nm-&gt;is_osr_method() ? &quot;%&quot; : &quot;&quot;,
 204         p2i(nm), p2i(nm-&gt;code_begin()), p2i(nm-&gt;code_end()));
 205   }
 206 
 207   void log_failure(JavaThread* thread, CompileTask* task, const char* reason, const char* retry_message) {
 208     StringLogMessage lm;
 209     lm.print(&quot;%4d   COMPILE SKIPPED: %s&quot;, task-&gt;compile_id(), reason);
 210     if (retry_message != NULL) {
 211       lm.append(&quot; (%s)&quot;, retry_message);
 212     }
 213     lm.print(&quot;\n&quot;);
 214     log(thread, &quot;%s&quot;, (const char*)lm);
 215   }
 216 
 217   void log_metaspace_failure(const char* reason) {
 218     ResourceMark rm;
 219     StringLogMessage lm;
 220     lm.print(&quot;%4d   COMPILE PROFILING SKIPPED: %s&quot;, -1, reason);
 221     lm.print(&quot;\n&quot;);
 222     log(JavaThread::current(), &quot;%s&quot;, (const char*)lm);
 223   }
 224 };
 225 
 226 static CompilationLog* _compilation_log = NULL;
 227 
 228 bool compileBroker_init() {
 229   if (LogEvents) {
 230     _compilation_log = new CompilationLog();
 231   }
 232 
 233   // init directives stack, adding default directive
 234   DirectivesStack::init();
 235 
 236   if (DirectivesParser::has_file()) {
 237     return DirectivesParser::parse_from_flag();
 238   } else if (CompilerDirectivesPrint) {
 239     // Print default directive even when no other was added
 240     DirectivesStack::print(tty);
 241   }
 242 
 243   return true;
 244 }
 245 
 246 CompileTaskWrapper::CompileTaskWrapper(CompileTask* task) {
 247   CompilerThread* thread = CompilerThread::current();
 248   thread-&gt;set_task(task);
 249 #if INCLUDE_JVMCI
 250   if (task-&gt;is_blocking() &amp;&amp; CompileBroker::compiler(task-&gt;comp_level())-&gt;is_jvmci()) {
 251     task-&gt;set_jvmci_compiler_thread(thread);
 252   }
 253 #endif
 254   CompileLog*     log  = thread-&gt;log();
 255   if (log != NULL &amp;&amp; !task-&gt;is_unloaded())  task-&gt;log_task_start(log);
 256 }
 257 
 258 CompileTaskWrapper::~CompileTaskWrapper() {
 259   CompilerThread* thread = CompilerThread::current();
 260   CompileTask* task = thread-&gt;task();
 261   CompileLog*  log  = thread-&gt;log();
 262   if (log != NULL &amp;&amp; !task-&gt;is_unloaded())  task-&gt;log_task_done(log);
 263   thread-&gt;set_task(NULL);
 264   task-&gt;set_code_handle(NULL);
 265   thread-&gt;set_env(NULL);
 266   if (task-&gt;is_blocking()) {
 267     bool free_task = false;
 268     {
 269       MutexLocker notifier(thread, task-&gt;lock());
 270       task-&gt;mark_complete();
 271 #if INCLUDE_JVMCI
 272       if (CompileBroker::compiler(task-&gt;comp_level())-&gt;is_jvmci()) {
 273         if (!task-&gt;has_waiter()) {
 274           // The waiting thread timed out and thus did not free the task.
 275           free_task = true;
 276         }
 277         task-&gt;set_jvmci_compiler_thread(NULL);
 278       }
 279 #endif
 280       if (!free_task) {
 281         // Notify the waiting thread that the compilation has completed
 282         // so that it can free the task.
 283         task-&gt;lock()-&gt;notify_all();
 284       }
 285     }
 286     if (free_task) {
 287       // The task can only be freed once the task lock is released.
 288       CompileTask::free(task);
 289     }
 290   } else {
 291     task-&gt;mark_complete();
 292 
 293     // By convention, the compiling thread is responsible for
 294     // recycling a non-blocking CompileTask.
 295     CompileTask::free(task);
 296   }
 297 }
 298 
 299 /**
 300  * Check if a CompilerThread can be removed and update count if requested.
 301  */
 302 bool CompileBroker::can_remove(CompilerThread *ct, bool do_it) {
 303   assert(UseDynamicNumberOfCompilerThreads, &quot;or shouldn&#39;t be here&quot;);
 304   if (!ReduceNumberOfCompilerThreads) return false;
 305 
 306   AbstractCompiler *compiler = ct-&gt;compiler();
 307   int compiler_count = compiler-&gt;num_compiler_threads();
 308   bool c1 = compiler-&gt;is_c1();
 309 
 310   // Keep at least 1 compiler thread of each type.
 311   if (compiler_count &lt; 2) return false;
 312 
 313   // Keep thread alive for at least some time.
 314   if (ct-&gt;idle_time_millis() &lt; (c1 ? 500 : 100)) return false;
 315 
 316 #if INCLUDE_JVMCI
 317   if (compiler-&gt;is_jvmci()) {
 318     // Handles for JVMCI thread objects may get released concurrently.
 319     if (do_it) {
 320       assert(CompileThread_lock-&gt;owner() == ct, &quot;must be holding lock&quot;);
 321     } else {
 322       // Skip check if it&#39;s the last thread and let caller check again.
 323       return true;
 324     }
 325   }
 326 #endif
 327 
 328   // We only allow the last compiler thread of each type to get removed.
 329   jobject last_compiler = c1 ? compiler1_object(compiler_count - 1)
 330                              : compiler2_object(compiler_count - 1);
 331   if (ct-&gt;threadObj() == JNIHandles::resolve_non_null(last_compiler)) {
 332     if (do_it) {
 333       assert_locked_or_safepoint(CompileThread_lock); // Update must be consistent.
 334       compiler-&gt;set_num_compiler_threads(compiler_count - 1);
 335 #if INCLUDE_JVMCI
 336       if (compiler-&gt;is_jvmci()) {
 337         // Old j.l.Thread object can die when no longer referenced elsewhere.
 338         JNIHandles::destroy_global(compiler2_object(compiler_count - 1));
 339         _compiler2_objects[compiler_count - 1] = NULL;
 340       }
 341 #endif
 342     }
 343     return true;
 344   }
 345   return false;
 346 }
 347 
 348 /**
 349  * Add a CompileTask to a CompileQueue.
 350  */
 351 void CompileQueue::add(CompileTask* task) {
 352   assert(MethodCompileQueue_lock-&gt;owned_by_self(), &quot;must own lock&quot;);
 353 
 354   task-&gt;set_next(NULL);
 355   task-&gt;set_prev(NULL);
 356 
 357   if (_last == NULL) {
 358     // The compile queue is empty.
 359     assert(_first == NULL, &quot;queue is empty&quot;);
 360     _first = task;
 361     _last = task;
 362   } else {
 363     // Append the task to the queue.
 364     assert(_last-&gt;next() == NULL, &quot;not last&quot;);
 365     _last-&gt;set_next(task);
 366     task-&gt;set_prev(_last);
 367     _last = task;
 368   }
 369   ++_size;
 370 
 371   // Mark the method as being in the compile queue.
 372   task-&gt;method()-&gt;set_queued_for_compilation();
 373 
 374   if (CIPrintCompileQueue) {
 375     print_tty();
 376   }
 377 
 378   if (LogCompilation &amp;&amp; xtty != NULL) {
 379     task-&gt;log_task_queued();
 380   }
 381 
 382   // Notify CompilerThreads that a task is available.
 383   MethodCompileQueue_lock-&gt;notify_all();
 384 }
 385 
 386 /**
 387  * Empties compilation queue by putting all compilation tasks onto
 388  * a freelist. Furthermore, the method wakes up all threads that are
 389  * waiting on a compilation task to finish. This can happen if background
 390  * compilation is disabled.
 391  */
 392 void CompileQueue::free_all() {
 393   MutexLocker mu(MethodCompileQueue_lock);
 394   CompileTask* next = _first;
 395 
 396   // Iterate over all tasks in the compile queue
 397   while (next != NULL) {
 398     CompileTask* current = next;
 399     next = current-&gt;next();
 400     {
 401       // Wake up thread that blocks on the compile task.
 402       MutexLocker ct_lock(current-&gt;lock());
 403       current-&gt;lock()-&gt;notify();
 404     }
 405     // Put the task back on the freelist.
 406     CompileTask::free(current);
 407   }
 408   _first = NULL;
 409 
 410   // Wake up all threads that block on the queue.
 411   MethodCompileQueue_lock-&gt;notify_all();
 412 }
 413 
 414 /**
 415  * Get the next CompileTask from a CompileQueue
 416  */
 417 CompileTask* CompileQueue::get() {
 418   // save methods from RedefineClasses across safepoint
 419   // across MethodCompileQueue_lock below.
 420   methodHandle save_method;
 421   methodHandle save_hot_method;
 422 
 423   MonitorLocker locker(MethodCompileQueue_lock);
 424   // If _first is NULL we have no more compile jobs. There are two reasons for
 425   // having no compile jobs: First, we compiled everything we wanted. Second,
 426   // we ran out of code cache so compilation has been disabled. In the latter
 427   // case we perform code cache sweeps to free memory such that we can re-enable
 428   // compilation.
 429   while (_first == NULL) {
 430     // Exit loop if compilation is disabled forever
 431     if (CompileBroker::is_compilation_disabled_forever()) {
 432       return NULL;
 433     }
 434 
 435     // If there are no compilation tasks and we can compile new jobs
 436     // (i.e., there is enough free space in the code cache) there is
 437     // no need to invoke the sweeper. As a result, the hotness of methods
 438     // remains unchanged. This behavior is desired, since we want to keep
 439     // the stable state, i.e., we do not want to evict methods from the
 440     // code cache if it is unnecessary.
 441     // We need a timed wait here, since compiler threads can exit if compilation
 442     // is disabled forever. We use 5 seconds wait time; the exiting of compiler threads
 443     // is not critical and we do not want idle compiler threads to wake up too often.
 444     locker.wait(5*1000);
 445 
 446     if (UseDynamicNumberOfCompilerThreads &amp;&amp; _first == NULL) {
 447       // Still nothing to compile. Give caller a chance to stop this thread.
 448       if (CompileBroker::can_remove(CompilerThread::current(), false)) return NULL;
 449     }
 450   }
 451 
 452   if (CompileBroker::is_compilation_disabled_forever()) {
 453     return NULL;
 454   }
 455 
 456   CompileTask* task;
 457   {
 458     NoSafepointVerifier nsv;
 459     task = CompilationPolicy::policy()-&gt;select_task(this);
 460     if (task != NULL) {
 461       task = task-&gt;select_for_compilation();
 462     }
 463   }
 464 
 465   if (task != NULL) {
 466     // Save method pointers across unlock safepoint.  The task is removed from
 467     // the compilation queue, which is walked during RedefineClasses.
 468     Thread* thread = Thread::current();
 469     save_method = methodHandle(thread, task-&gt;method());
 470     save_hot_method = methodHandle(thread, task-&gt;hot_method());
 471 
 472     remove(task);
 473   }
 474   purge_stale_tasks(); // may temporarily release MCQ lock
 475   return task;
 476 }
 477 
 478 // Clean &amp; deallocate stale compile tasks.
 479 // Temporarily releases MethodCompileQueue lock.
 480 void CompileQueue::purge_stale_tasks() {
 481   assert(MethodCompileQueue_lock-&gt;owned_by_self(), &quot;must own lock&quot;);
 482   if (_first_stale != NULL) {
 483     // Stale tasks are purged when MCQ lock is released,
 484     // but _first_stale updates are protected by MCQ lock.
 485     // Once task processing starts and MCQ lock is released,
 486     // other compiler threads can reuse _first_stale.
 487     CompileTask* head = _first_stale;
 488     _first_stale = NULL;
 489     {
 490       MutexUnlocker ul(MethodCompileQueue_lock);
 491       for (CompileTask* task = head; task != NULL; ) {
 492         CompileTask* next_task = task-&gt;next();
 493         CompileTaskWrapper ctw(task); // Frees the task
 494         task-&gt;set_failure_reason(&quot;stale task&quot;);
 495         task = next_task;
 496       }
 497     }
 498   }
 499 }
 500 
 501 void CompileQueue::remove(CompileTask* task) {
 502   assert(MethodCompileQueue_lock-&gt;owned_by_self(), &quot;must own lock&quot;);
 503   if (task-&gt;prev() != NULL) {
 504     task-&gt;prev()-&gt;set_next(task-&gt;next());
 505   } else {
 506     // max is the first element
 507     assert(task == _first, &quot;Sanity&quot;);
 508     _first = task-&gt;next();
 509   }
 510 
 511   if (task-&gt;next() != NULL) {
 512     task-&gt;next()-&gt;set_prev(task-&gt;prev());
 513   } else {
 514     // max is the last element
 515     assert(task == _last, &quot;Sanity&quot;);
 516     _last = task-&gt;prev();
 517   }
 518   --_size;
 519 }
 520 
 521 void CompileQueue::remove_and_mark_stale(CompileTask* task) {
 522   assert(MethodCompileQueue_lock-&gt;owned_by_self(), &quot;must own lock&quot;);
 523   remove(task);
 524 
 525   // Enqueue the task for reclamation (should be done outside MCQ lock)
 526   task-&gt;set_next(_first_stale);
 527   task-&gt;set_prev(NULL);
 528   _first_stale = task;
 529 }
 530 
 531 // methods in the compile queue need to be marked as used on the stack
 532 // so that they don&#39;t get reclaimed by Redefine Classes
 533 void CompileQueue::mark_on_stack() {
 534   CompileTask* task = _first;
 535   while (task != NULL) {
 536     task-&gt;mark_on_stack();
 537     task = task-&gt;next();
 538   }
 539 }
 540 
 541 
 542 CompileQueue* CompileBroker::compile_queue(int comp_level) {
 543   if (is_c2_compile(comp_level)) return _c2_compile_queue;
 544   if (is_c1_compile(comp_level)) return _c1_compile_queue;
 545   return NULL;
 546 }
 547 
 548 void CompileBroker::print_compile_queues(outputStream* st) {
 549   st-&gt;print_cr(&quot;Current compiles: &quot;);
 550 
 551   char buf[2000];
 552   int buflen = sizeof(buf);
 553   Threads::print_threads_compiling(st, buf, buflen, /* short_form = */ true);
 554 
 555   st-&gt;cr();
 556   if (_c1_compile_queue != NULL) {
 557     _c1_compile_queue-&gt;print(st);
 558   }
 559   if (_c2_compile_queue != NULL) {
 560     _c2_compile_queue-&gt;print(st);
 561   }
 562 }
 563 
 564 void CompileQueue::print(outputStream* st) {
 565   assert_locked_or_safepoint(MethodCompileQueue_lock);
 566   st-&gt;print_cr(&quot;%s:&quot;, name());
 567   CompileTask* task = _first;
 568   if (task == NULL) {
 569     st-&gt;print_cr(&quot;Empty&quot;);
 570   } else {
 571     while (task != NULL) {
 572       task-&gt;print(st, NULL, true, true);
 573       task = task-&gt;next();
 574     }
 575   }
 576   st-&gt;cr();
 577 }
 578 
 579 void CompileQueue::print_tty() {
 580   ResourceMark rm;
 581   stringStream ss;
 582   // Dump the compile queue into a buffer before locking the tty
 583   print(&amp;ss);
 584   {
 585     ttyLocker ttyl;
 586     tty-&gt;print(&quot;%s&quot;, ss.as_string());
 587   }
 588 }
 589 
 590 CompilerCounters::CompilerCounters() {
 591   _current_method[0] = &#39;\0&#39;;
 592   _compile_type = CompileBroker::no_compile;
 593 }
 594 
 595 // ------------------------------------------------------------------
 596 // CompileBroker::compilation_init
 597 //
 598 // Initialize the Compilation object
 599 void CompileBroker::compilation_init_phase1(Thread* THREAD) {
 600   // No need to initialize compilation system if we do not use it.
 601   if (!UseCompiler) {
 602     return;
 603   }
 604   // Set the interface to the current compiler(s).
 605   _c1_count = CompilationPolicy::policy()-&gt;compiler_count(CompLevel_simple);
 606   _c2_count = CompilationPolicy::policy()-&gt;compiler_count(CompLevel_full_optimization);
 607 
 608 #if INCLUDE_JVMCI
 609   if (EnableJVMCI) {
 610     // This is creating a JVMCICompiler singleton.
 611     JVMCICompiler* jvmci = new JVMCICompiler();
 612 
 613     if (UseJVMCICompiler) {
 614       _compilers[1] = jvmci;
 615       if (FLAG_IS_DEFAULT(JVMCIThreads)) {
 616         if (BootstrapJVMCI) {
 617           // JVMCI will bootstrap so give it more threads
 618           _c2_count = MIN2(32, os::active_processor_count());
 619         }
 620       } else {
 621         _c2_count = JVMCIThreads;
 622       }
 623       if (FLAG_IS_DEFAULT(JVMCIHostThreads)) {
 624       } else {
 625         _c1_count = JVMCIHostThreads;
 626       }
 627     }
 628   }
 629 #endif // INCLUDE_JVMCI
 630 
 631 #ifdef COMPILER1
 632   if (_c1_count &gt; 0) {
 633     _compilers[0] = new Compiler();
 634   }
 635 #endif // COMPILER1
 636 
 637 #ifdef COMPILER2
 638   if (true JVMCI_ONLY( &amp;&amp; !UseJVMCICompiler)) {
 639     if (_c2_count &gt; 0) {
 640       _compilers[1] = new C2Compiler();
 641     }
 642   }
 643 #endif // COMPILER2
 644 
 645   // Start the compiler thread(s) and the sweeper thread
 646   init_compiler_sweeper_threads();
 647   // totalTime performance counter is always created as it is required
 648   // by the implementation of java.lang.management.CompilationMBean.
 649   {
 650     // Ensure OOM leads to vm_exit_during_initialization.
 651     EXCEPTION_MARK;
 652     _perf_total_compilation =
 653                  PerfDataManager::create_counter(JAVA_CI, &quot;totalTime&quot;,
 654                                                  PerfData::U_Ticks, CHECK);
 655   }
 656 
 657   if (UsePerfData) {
 658 
 659     EXCEPTION_MARK;
 660 
 661     // create the jvmstat performance counters
 662     _perf_osr_compilation =
 663                  PerfDataManager::create_counter(SUN_CI, &quot;osrTime&quot;,
 664                                                  PerfData::U_Ticks, CHECK);
 665 
 666     _perf_standard_compilation =
 667                  PerfDataManager::create_counter(SUN_CI, &quot;standardTime&quot;,
 668                                                  PerfData::U_Ticks, CHECK);
 669 
 670     _perf_total_bailout_count =
 671                  PerfDataManager::create_counter(SUN_CI, &quot;totalBailouts&quot;,
 672                                                  PerfData::U_Events, CHECK);
 673 
 674     _perf_total_invalidated_count =
 675                  PerfDataManager::create_counter(SUN_CI, &quot;totalInvalidates&quot;,
 676                                                  PerfData::U_Events, CHECK);
 677 
 678     _perf_total_compile_count =
 679                  PerfDataManager::create_counter(SUN_CI, &quot;totalCompiles&quot;,
 680                                                  PerfData::U_Events, CHECK);
 681     _perf_total_osr_compile_count =
 682                  PerfDataManager::create_counter(SUN_CI, &quot;osrCompiles&quot;,
 683                                                  PerfData::U_Events, CHECK);
 684 
 685     _perf_total_standard_compile_count =
 686                  PerfDataManager::create_counter(SUN_CI, &quot;standardCompiles&quot;,
 687                                                  PerfData::U_Events, CHECK);
 688 
 689     _perf_sum_osr_bytes_compiled =
 690                  PerfDataManager::create_counter(SUN_CI, &quot;osrBytes&quot;,
 691                                                  PerfData::U_Bytes, CHECK);
 692 
 693     _perf_sum_standard_bytes_compiled =
 694                  PerfDataManager::create_counter(SUN_CI, &quot;standardBytes&quot;,
 695                                                  PerfData::U_Bytes, CHECK);
 696 
 697     _perf_sum_nmethod_size =
 698                  PerfDataManager::create_counter(SUN_CI, &quot;nmethodSize&quot;,
 699                                                  PerfData::U_Bytes, CHECK);
 700 
 701     _perf_sum_nmethod_code_size =
 702                  PerfDataManager::create_counter(SUN_CI, &quot;nmethodCodeSize&quot;,
 703                                                  PerfData::U_Bytes, CHECK);
 704 
 705     _perf_last_method =
 706                  PerfDataManager::create_string_variable(SUN_CI, &quot;lastMethod&quot;,
 707                                        CompilerCounters::cmname_buffer_length,
 708                                        &quot;&quot;, CHECK);
 709 
 710     _perf_last_failed_method =
 711             PerfDataManager::create_string_variable(SUN_CI, &quot;lastFailedMethod&quot;,
 712                                        CompilerCounters::cmname_buffer_length,
 713                                        &quot;&quot;, CHECK);
 714 
 715     _perf_last_invalidated_method =
 716         PerfDataManager::create_string_variable(SUN_CI, &quot;lastInvalidatedMethod&quot;,
 717                                      CompilerCounters::cmname_buffer_length,
 718                                      &quot;&quot;, CHECK);
 719 
 720     _perf_last_compile_type =
 721              PerfDataManager::create_variable(SUN_CI, &quot;lastType&quot;,
 722                                               PerfData::U_None,
 723                                               (jlong)CompileBroker::no_compile,
 724                                               CHECK);
 725 
 726     _perf_last_compile_size =
 727              PerfDataManager::create_variable(SUN_CI, &quot;lastSize&quot;,
 728                                               PerfData::U_Bytes,
 729                                               (jlong)CompileBroker::no_compile,
 730                                               CHECK);
 731 
 732 
 733     _perf_last_failed_type =
 734              PerfDataManager::create_variable(SUN_CI, &quot;lastFailedType&quot;,
 735                                               PerfData::U_None,
 736                                               (jlong)CompileBroker::no_compile,
 737                                               CHECK);
 738 
 739     _perf_last_invalidated_type =
 740          PerfDataManager::create_variable(SUN_CI, &quot;lastInvalidatedType&quot;,
 741                                           PerfData::U_None,
 742                                           (jlong)CompileBroker::no_compile,
 743                                           CHECK);
 744   }
 745 }
 746 
 747 // Completes compiler initialization. Compilation requests submitted
 748 // prior to this will be silently ignored.
 749 void CompileBroker::compilation_init_phase2() {
 750   _initialized = true;
 751 }
 752 
 753 Handle CompileBroker::create_thread_oop(const char* name, TRAPS) {
 754   Handle string = java_lang_String::create_from_str(name, CHECK_NH);
 755   Handle thread_group(THREAD, Universe::system_thread_group());
 756   return JavaCalls::construct_new_instance(
 757                        SystemDictionary::Thread_klass(),
 758                        vmSymbols::threadgroup_string_void_signature(),
 759                        thread_group,
 760                        string,
 761                        CHECK_NH);
 762 }
 763 
 764 
 765 JavaThread* CompileBroker::make_thread(jobject thread_handle, CompileQueue* queue, AbstractCompiler* comp, Thread* THREAD) {
 766   JavaThread* new_thread = NULL;
 767   {
 768     MutexLocker mu(THREAD, Threads_lock);
 769     if (comp != NULL) {
 770       if (!InjectCompilerCreationFailure || comp-&gt;num_compiler_threads() == 0) {
 771         CompilerCounters* counters = new CompilerCounters();
 772         new_thread = new CompilerThread(queue, counters);
 773       }
 774     } else {
 775       new_thread = new CodeCacheSweeperThread();
 776     }
 777     // At this point the new CompilerThread data-races with this startup
 778     // thread (which I believe is the primoridal thread and NOT the VM
 779     // thread).  This means Java bytecodes being executed at startup can
 780     // queue compile jobs which will run at whatever default priority the
 781     // newly created CompilerThread runs at.
 782 
 783 
 784     // At this point it may be possible that no osthread was created for the
 785     // JavaThread due to lack of memory. We would have to throw an exception
 786     // in that case. However, since this must work and we do not allow
 787     // exceptions anyway, check and abort if this fails. But first release the
 788     // lock.
 789 
 790     if (new_thread != NULL &amp;&amp; new_thread-&gt;osthread() != NULL) {
 791 
 792       java_lang_Thread::set_thread(JNIHandles::resolve_non_null(thread_handle), new_thread);
 793 
 794       // Note that this only sets the JavaThread _priority field, which by
 795       // definition is limited to Java priorities and not OS priorities.
 796       // The os-priority is set in the CompilerThread startup code itself
 797 
 798       java_lang_Thread::set_priority(JNIHandles::resolve_non_null(thread_handle), NearMaxPriority);
 799 
 800       // Note that we cannot call os::set_priority because it expects Java
 801       // priorities and we are *explicitly* using OS priorities so that it&#39;s
 802       // possible to set the compiler thread priority higher than any Java
 803       // thread.
 804 
 805       int native_prio = CompilerThreadPriority;
 806       if (native_prio == -1) {
 807         if (UseCriticalCompilerThreadPriority) {
 808           native_prio = os::java_to_os_priority[CriticalPriority];
 809         } else {
 810           native_prio = os::java_to_os_priority[NearMaxPriority];
 811         }
 812       }
 813       os::set_native_priority(new_thread, native_prio);
 814 
 815       java_lang_Thread::set_daemon(JNIHandles::resolve_non_null(thread_handle));
 816 
 817       new_thread-&gt;set_threadObj(JNIHandles::resolve_non_null(thread_handle));
 818       if (comp != NULL) {
 819         new_thread-&gt;as_CompilerThread()-&gt;set_compiler(comp);
 820       }
 821       Threads::add(new_thread);
 822       Thread::start(new_thread);
 823     }
 824   }
 825 
 826   // First release lock before aborting VM.
 827   if (new_thread == NULL || new_thread-&gt;osthread() == NULL) {
 828     if (UseDynamicNumberOfCompilerThreads &amp;&amp; comp != NULL &amp;&amp; comp-&gt;num_compiler_threads() &gt; 0) {
 829       if (new_thread != NULL) {
 830         new_thread-&gt;smr_delete();
 831       }
 832       return NULL;
 833     }
 834     vm_exit_during_initialization(&quot;java.lang.OutOfMemoryError&quot;,
 835                                   os::native_thread_creation_failed_msg());
 836   }
 837 
 838   // Let go of Threads_lock before yielding
 839   os::naked_yield(); // make sure that the compiler thread is started early (especially helpful on SOLARIS)
 840 
 841   return new_thread;
 842 }
 843 
 844 
 845 void CompileBroker::init_compiler_sweeper_threads() {
 846   // Ensure any exceptions lead to vm_exit_during_initialization.
 847   EXCEPTION_MARK;
 848 #if !defined(ZERO)
 849   assert(_c2_count &gt; 0 || _c1_count &gt; 0, &quot;No compilers?&quot;);
 850 #endif // !ZERO
 851   // Initialize the compilation queue
 852   if (_c2_count &gt; 0) {
 853     const char* name = JVMCI_ONLY(UseJVMCICompiler ? &quot;JVMCI compile queue&quot; :) &quot;C2 compile queue&quot;;
 854     _c2_compile_queue  = new CompileQueue(name);
 855     _compiler2_objects = NEW_C_HEAP_ARRAY(jobject, _c2_count, mtCompiler);
 856     _compiler2_logs = NEW_C_HEAP_ARRAY(CompileLog*, _c2_count, mtCompiler);
 857   }
 858   if (_c1_count &gt; 0) {
 859     _c1_compile_queue  = new CompileQueue(&quot;C1 compile queue&quot;);
 860     _compiler1_objects = NEW_C_HEAP_ARRAY(jobject, _c1_count, mtCompiler);
 861     _compiler1_logs = NEW_C_HEAP_ARRAY(CompileLog*, _c1_count, mtCompiler);
 862   }
 863 
 864   char name_buffer[256];
 865 
 866   for (int i = 0; i &lt; _c2_count; i++) {
 867     jobject thread_handle = NULL;
 868     // Create all j.l.Thread objects for C1 and C2 threads here, but only one
 869     // for JVMCI compiler which can create further ones on demand.
 870     JVMCI_ONLY(if (!UseJVMCICompiler || !UseDynamicNumberOfCompilerThreads || i == 0) {)
 871     // Create a name for our thread.
 872     sprintf(name_buffer, &quot;%s CompilerThread%d&quot;, _compilers[1]-&gt;name(), i);
 873     Handle thread_oop = create_thread_oop(name_buffer, CHECK);
 874     thread_handle = JNIHandles::make_global(thread_oop);
 875     JVMCI_ONLY(})
 876     _compiler2_objects[i] = thread_handle;
 877     _compiler2_logs[i] = NULL;
 878 
 879     if (!UseDynamicNumberOfCompilerThreads || i == 0) {
 880       JavaThread *ct = make_thread(thread_handle, _c2_compile_queue, _compilers[1], THREAD);
 881       assert(ct != NULL, &quot;should have been handled for initial thread&quot;);
 882       _compilers[1]-&gt;set_num_compiler_threads(i + 1);
 883       if (TraceCompilerThreads) {
 884         ResourceMark rm;
 885         MutexLocker mu(Threads_lock);
 886         tty-&gt;print_cr(&quot;Added initial compiler thread %s&quot;, ct-&gt;get_thread_name());
 887       }
 888     }
 889   }
 890 
 891   for (int i = 0; i &lt; _c1_count; i++) {
 892     // Create a name for our thread.
 893     sprintf(name_buffer, &quot;C1 CompilerThread%d&quot;, i);
 894     Handle thread_oop = create_thread_oop(name_buffer, CHECK);
 895     jobject thread_handle = JNIHandles::make_global(thread_oop);
 896     _compiler1_objects[i] = thread_handle;
 897     _compiler1_logs[i] = NULL;
 898 
 899     if (!UseDynamicNumberOfCompilerThreads || i == 0) {
 900       JavaThread *ct = make_thread(thread_handle, _c1_compile_queue, _compilers[0], THREAD);
 901       assert(ct != NULL, &quot;should have been handled for initial thread&quot;);
 902       _compilers[0]-&gt;set_num_compiler_threads(i + 1);
 903       if (TraceCompilerThreads) {
 904         ResourceMark rm;
 905         MutexLocker mu(Threads_lock);
 906         tty-&gt;print_cr(&quot;Added initial compiler thread %s&quot;, ct-&gt;get_thread_name());
 907       }
 908     }
 909   }
 910 
 911   if (UsePerfData) {
 912     PerfDataManager::create_constant(SUN_CI, &quot;threads&quot;, PerfData::U_Bytes, _c1_count + _c2_count, CHECK);
 913   }
 914 
 915   if (MethodFlushing) {
 916     // Initialize the sweeper thread
 917     Handle thread_oop = create_thread_oop(&quot;Sweeper thread&quot;, CHECK);
 918     jobject thread_handle = JNIHandles::make_local(THREAD, thread_oop());
 919     make_thread(thread_handle, NULL, NULL, THREAD);
 920   }
 921 }
 922 
 923 void CompileBroker::possibly_add_compiler_threads(Thread* THREAD) {
 924 
 925   julong available_memory = os::available_memory();
 926   // If SegmentedCodeCache is off, both values refer to the single heap (with type CodeBlobType::All).
 927   size_t available_cc_np  = CodeCache::unallocated_capacity(CodeBlobType::MethodNonProfiled),
 928          available_cc_p   = CodeCache::unallocated_capacity(CodeBlobType::MethodProfiled);
 929 
 930   // Only do attempt to start additional threads if the lock is free.
 931   if (!CompileThread_lock-&gt;try_lock()) return;
 932 
 933   if (_c2_compile_queue != NULL) {
 934     int old_c2_count = _compilers[1]-&gt;num_compiler_threads();
 935     int new_c2_count = MIN4(_c2_count,
 936         _c2_compile_queue-&gt;size() / 2,
 937         (int)(available_memory / (200*M)),
 938         (int)(available_cc_np / (128*K)));
 939 
 940     for (int i = old_c2_count; i &lt; new_c2_count; i++) {
 941 #if INCLUDE_JVMCI
 942       if (UseJVMCICompiler) {
 943         // Native compiler threads as used in C1/C2 can reuse the j.l.Thread
 944         // objects as their existence is completely hidden from the rest of
 945         // the VM (and those compiler threads can&#39;t call Java code to do the
 946         // creation anyway). For JVMCI we have to create new j.l.Thread objects
 947         // as they are visible and we can see unexpected thread lifecycle
 948         // transitions if we bind them to new JavaThreads.
 949         if (!THREAD-&gt;can_call_java()) break;
 950         char name_buffer[256];
 951         sprintf(name_buffer, &quot;%s CompilerThread%d&quot;, _compilers[1]-&gt;name(), i);
 952         Handle thread_oop;
 953         {
 954           // We have to give up the lock temporarily for the Java calls.
 955           MutexUnlocker mu(CompileThread_lock);
 956           thread_oop = create_thread_oop(name_buffer, THREAD);
 957         }
 958         if (HAS_PENDING_EXCEPTION) {
 959           if (TraceCompilerThreads) {
 960             ResourceMark rm;
 961             tty-&gt;print_cr(&quot;JVMCI compiler thread creation failed:&quot;);
 962             PENDING_EXCEPTION-&gt;print();
 963           }
 964           CLEAR_PENDING_EXCEPTION;
 965           break;
 966         }
 967         // Check if another thread has beaten us during the Java calls.
 968         if (_compilers[1]-&gt;num_compiler_threads() != i) break;
 969         jobject thread_handle = JNIHandles::make_global(thread_oop);
 970         assert(compiler2_object(i) == NULL, &quot;Old one must be released!&quot;);
 971         _compiler2_objects[i] = thread_handle;
 972       }
 973 #endif
 974       JavaThread *ct = make_thread(compiler2_object(i), _c2_compile_queue, _compilers[1], THREAD);
 975       if (ct == NULL) break;
 976       _compilers[1]-&gt;set_num_compiler_threads(i + 1);
 977       if (TraceCompilerThreads) {
 978         ResourceMark rm;
 979         MutexLocker mu(Threads_lock);
 980         tty-&gt;print_cr(&quot;Added compiler thread %s (available memory: %dMB, available non-profiled code cache: %dMB)&quot;,
 981                       ct-&gt;get_thread_name(), (int)(available_memory/M), (int)(available_cc_np/M));
 982       }
 983     }
 984   }
 985 
 986   if (_c1_compile_queue != NULL) {
 987     int old_c1_count = _compilers[0]-&gt;num_compiler_threads();
 988     int new_c1_count = MIN4(_c1_count,
 989         _c1_compile_queue-&gt;size() / 4,
 990         (int)(available_memory / (100*M)),
 991         (int)(available_cc_p / (128*K)));
 992 
 993     for (int i = old_c1_count; i &lt; new_c1_count; i++) {
 994       JavaThread *ct = make_thread(compiler1_object(i), _c1_compile_queue, _compilers[0], THREAD);
 995       if (ct == NULL) break;
 996       _compilers[0]-&gt;set_num_compiler_threads(i + 1);
 997       if (TraceCompilerThreads) {
 998         ResourceMark rm;
 999         MutexLocker mu(Threads_lock);
1000         tty-&gt;print_cr(&quot;Added compiler thread %s (available memory: %dMB, available profiled code cache: %dMB)&quot;,
1001                       ct-&gt;get_thread_name(), (int)(available_memory/M), (int)(available_cc_p/M));
1002       }
1003     }
1004   }
1005 
1006   CompileThread_lock-&gt;unlock();
1007 }
1008 
1009 
1010 /**
1011  * Set the methods on the stack as on_stack so that redefine classes doesn&#39;t
1012  * reclaim them. This method is executed at a safepoint.
1013  */
1014 void CompileBroker::mark_on_stack() {
1015   assert(SafepointSynchronize::is_at_safepoint(), &quot;sanity check&quot;);
1016   // Since we are at a safepoint, we do not need a lock to access
1017   // the compile queues.
1018   if (_c2_compile_queue != NULL) {
1019     _c2_compile_queue-&gt;mark_on_stack();
1020   }
1021   if (_c1_compile_queue != NULL) {
1022     _c1_compile_queue-&gt;mark_on_stack();
1023   }
1024 }
1025 
1026 // ------------------------------------------------------------------
1027 // CompileBroker::compile_method
1028 //
1029 // Request compilation of a method.
1030 void CompileBroker::compile_method_base(const methodHandle&amp; method,
1031                                         int osr_bci,
1032                                         int comp_level,
1033                                         const methodHandle&amp; hot_method,
1034                                         int hot_count,
1035                                         CompileTask::CompileReason compile_reason,
1036                                         bool blocking,
1037                                         Thread* thread) {
1038   guarantee(!method-&gt;is_abstract(), &quot;cannot compile abstract methods&quot;);
1039   assert(method-&gt;method_holder()-&gt;is_instance_klass(),
1040          &quot;sanity check&quot;);
1041   assert(!method-&gt;method_holder()-&gt;is_not_initialized(),
1042          &quot;method holder must be initialized&quot;);
1043   assert(!method-&gt;is_method_handle_intrinsic(), &quot;do not enqueue these guys&quot;);
1044 
1045   if (CIPrintRequests) {
1046     tty-&gt;print(&quot;request: &quot;);
1047     method-&gt;print_short_name(tty);
1048     if (osr_bci != InvocationEntryBci) {
1049       tty-&gt;print(&quot; osr_bci: %d&quot;, osr_bci);
1050     }
1051     tty-&gt;print(&quot; level: %d comment: %s count: %d&quot;, comp_level, CompileTask::reason_name(compile_reason), hot_count);
1052     if (!hot_method.is_null()) {
1053       tty-&gt;print(&quot; hot: &quot;);
1054       if (hot_method() != method()) {
1055           hot_method-&gt;print_short_name(tty);
1056       } else {
1057         tty-&gt;print(&quot;yes&quot;);
1058       }
1059     }
1060     tty-&gt;cr();
1061   }
1062 
1063   // A request has been made for compilation.  Before we do any
1064   // real work, check to see if the method has been compiled
1065   // in the meantime with a definitive result.
1066   if (compilation_is_complete(method, osr_bci, comp_level)) {
1067     return;
1068   }
1069 
1070 #ifndef PRODUCT
1071   if (osr_bci != -1 &amp;&amp; !FLAG_IS_DEFAULT(OSROnlyBCI)) {
1072     if ((OSROnlyBCI &gt; 0) ? (OSROnlyBCI != osr_bci) : (-OSROnlyBCI == osr_bci)) {
1073       // Positive OSROnlyBCI means only compile that bci.  Negative means don&#39;t compile that BCI.
1074       return;
1075     }
1076   }
1077 #endif
1078 
1079   // If this method is already in the compile queue, then
1080   // we do not block the current thread.
1081   if (compilation_is_in_queue(method)) {
1082     // We may want to decay our counter a bit here to prevent
1083     // multiple denied requests for compilation.  This is an
1084     // open compilation policy issue. Note: The other possibility,
1085     // in the case that this is a blocking compile request, is to have
1086     // all subsequent blocking requesters wait for completion of
1087     // ongoing compiles. Note that in this case we&#39;ll need a protocol
1088     // for freeing the associated compile tasks. [Or we could have
1089     // a single static monitor on which all these waiters sleep.]
1090     return;
1091   }
1092 
1093   if (TieredCompilation) {
1094     // Tiered policy requires MethodCounters to exist before adding a method to
1095     // the queue. Create if we don&#39;t have them yet.
1096     method-&gt;get_method_counters(thread);
1097   }
1098 
1099   // Outputs from the following MutexLocker block:
1100   CompileTask* task     = NULL;
1101   CompileQueue* queue  = compile_queue(comp_level);
1102 
1103   // Acquire our lock.
1104   {
1105     MutexLocker locker(thread, MethodCompileQueue_lock);
1106 
1107     // Make sure the method has not slipped into the queues since
1108     // last we checked; note that those checks were &quot;fast bail-outs&quot;.
1109     // Here we need to be more careful, see 14012000 below.
1110     if (compilation_is_in_queue(method)) {
1111       return;
1112     }
1113 
1114     // We need to check again to see if the compilation has
1115     // completed.  A previous compilation may have registered
1116     // some result.
1117     if (compilation_is_complete(method, osr_bci, comp_level)) {
1118       return;
1119     }
1120 
1121     // We now know that this compilation is not pending, complete,
1122     // or prohibited.  Assign a compile_id to this compilation
1123     // and check to see if it is in our [Start..Stop) range.
1124     int compile_id = assign_compile_id(method, osr_bci);
1125     if (compile_id == 0) {
1126       // The compilation falls outside the allowed range.
1127       return;
1128     }
1129 
1130 #if INCLUDE_JVMCI
1131     if (UseJVMCICompiler &amp;&amp; blocking) {
1132       // Don&#39;t allow blocking compiles for requests triggered by JVMCI.
1133       if (thread-&gt;is_Compiler_thread()) {
1134         blocking = false;
1135       }
1136 
1137       if (!UseJVMCINativeLibrary) {
1138         // Don&#39;t allow blocking compiles if inside a class initializer or while performing class loading
1139         vframeStream vfst((JavaThread*) thread);
1140         for (; !vfst.at_end(); vfst.next()) {
1141           if (vfst.method()-&gt;is_static_initializer() ||
1142               (vfst.method()-&gt;method_holder()-&gt;is_subclass_of(SystemDictionary::ClassLoader_klass()) &amp;&amp;
1143                   vfst.method()-&gt;name() == vmSymbols::loadClass_name())) {
1144             blocking = false;
1145             break;
1146           }
1147         }
1148       }
1149 
1150       // Don&#39;t allow blocking compilation requests to JVMCI
1151       // if JVMCI itself is not yet initialized
1152       if (!JVMCI::is_compiler_initialized() &amp;&amp; compiler(comp_level)-&gt;is_jvmci()) {
1153         blocking = false;
1154       }
1155 
1156       // Don&#39;t allow blocking compilation requests if we are in JVMCIRuntime::shutdown
1157       // to avoid deadlock between compiler thread(s) and threads run at shutdown
1158       // such as the DestroyJavaVM thread.
1159       if (JVMCI::shutdown_called()) {
1160         blocking = false;
1161       }
1162     }
1163 #endif // INCLUDE_JVMCI
1164 
1165     // We will enter the compilation in the queue.
1166     // 14012000: Note that this sets the queued_for_compile bits in
1167     // the target method. We can now reason that a method cannot be
1168     // queued for compilation more than once, as follows:
1169     // Before a thread queues a task for compilation, it first acquires
1170     // the compile queue lock, then checks if the method&#39;s queued bits
1171     // are set or it has already been compiled. Thus there can not be two
1172     // instances of a compilation task for the same method on the
1173     // compilation queue. Consider now the case where the compilation
1174     // thread has already removed a task for that method from the queue
1175     // and is in the midst of compiling it. In this case, the
1176     // queued_for_compile bits must be set in the method (and these
1177     // will be visible to the current thread, since the bits were set
1178     // under protection of the compile queue lock, which we hold now.
1179     // When the compilation completes, the compiler thread first sets
1180     // the compilation result and then clears the queued_for_compile
1181     // bits. Neither of these actions are protected by a barrier (or done
1182     // under the protection of a lock), so the only guarantee we have
1183     // (on machines with TSO (Total Store Order)) is that these values
1184     // will update in that order. As a result, the only combinations of
1185     // these bits that the current thread will see are, in temporal order:
1186     // &lt;RESULT, QUEUE&gt; :
1187     //     &lt;0, 1&gt; : in compile queue, but not yet compiled
1188     //     &lt;1, 1&gt; : compiled but queue bit not cleared
1189     //     &lt;1, 0&gt; : compiled and queue bit cleared
1190     // Because we first check the queue bits then check the result bits,
1191     // we are assured that we cannot introduce a duplicate task.
1192     // Note that if we did the tests in the reverse order (i.e. check
1193     // result then check queued bit), we could get the result bit before
1194     // the compilation completed, and the queue bit after the compilation
1195     // completed, and end up introducing a &quot;duplicate&quot; (redundant) task.
1196     // In that case, the compiler thread should first check if a method
1197     // has already been compiled before trying to compile it.
1198     // NOTE: in the event that there are multiple compiler threads and
1199     // there is de-optimization/recompilation, things will get hairy,
1200     // and in that case it&#39;s best to protect both the testing (here) of
1201     // these bits, and their updating (here and elsewhere) under a
1202     // common lock.
1203     task = create_compile_task(queue,
1204                                compile_id, method,
1205                                osr_bci, comp_level,
1206                                hot_method, hot_count, compile_reason,
1207                                blocking);
1208   }
1209 
1210   if (blocking) {
1211     wait_for_completion(task);
1212   }
1213 }
1214 
1215 nmethod* CompileBroker::compile_method(const methodHandle&amp; method, int osr_bci,
1216                                        int comp_level,
1217                                        const methodHandle&amp; hot_method, int hot_count,
1218                                        CompileTask::CompileReason compile_reason,
1219                                        Thread* THREAD) {
1220   // Do nothing if compilebroker is not initalized or compiles are submitted on level none
1221   if (!_initialized || comp_level == CompLevel_none) {
1222     return NULL;
1223   }
1224 
1225   AbstractCompiler *comp = CompileBroker::compiler(comp_level);
1226   assert(comp != NULL, &quot;Ensure we have a compiler&quot;);
1227 
1228   DirectiveSet* directive = DirectivesStack::getMatchingDirective(method, comp);
1229   nmethod* nm = CompileBroker::compile_method(method, osr_bci, comp_level, hot_method, hot_count, compile_reason, directive, THREAD);
1230   DirectivesStack::release(directive);
1231   return nm;
1232 }
1233 
1234 nmethod* CompileBroker::compile_method(const methodHandle&amp; method, int osr_bci,
1235                                          int comp_level,
1236                                          const methodHandle&amp; hot_method, int hot_count,
1237                                          CompileTask::CompileReason compile_reason,
1238                                          DirectiveSet* directive,
1239                                          Thread* THREAD) {
1240 
1241   // make sure arguments make sense
1242   assert(method-&gt;method_holder()-&gt;is_instance_klass(), &quot;not an instance method&quot;);
1243   assert(osr_bci == InvocationEntryBci || (0 &lt;= osr_bci &amp;&amp; osr_bci &lt; method-&gt;code_size()), &quot;bci out of range&quot;);
1244   assert(!method-&gt;is_abstract() &amp;&amp; (osr_bci == InvocationEntryBci || !method-&gt;is_native()), &quot;cannot compile abstract/native methods&quot;);
1245   assert(!method-&gt;method_holder()-&gt;is_not_initialized(), &quot;method holder must be initialized&quot;);
1246   assert(!TieredCompilation || comp_level &lt;= TieredStopAtLevel, &quot;Invalid compilation level&quot;);
1247   // allow any levels for WhiteBox
1248   assert(WhiteBoxAPI || TieredCompilation || comp_level == CompLevel_highest_tier, &quot;only CompLevel_highest_tier must be used in non-tiered&quot;);
1249   // return quickly if possible
1250 
1251   // lock, make sure that the compilation
1252   // isn&#39;t prohibited in a straightforward way.
1253   AbstractCompiler* comp = CompileBroker::compiler(comp_level);
1254   if (comp == NULL || !comp-&gt;can_compile_method(method) ||
1255       compilation_is_prohibited(method, osr_bci, comp_level, directive-&gt;ExcludeOption)) {
1256     return NULL;
1257   }
1258 
1259 #if INCLUDE_JVMCI
1260   if (comp-&gt;is_jvmci() &amp;&amp; !JVMCI::can_initialize_JVMCI()) {
1261     return NULL;
1262   }
1263 #endif
1264 
1265   if (osr_bci == InvocationEntryBci) {
1266     // standard compilation
1267     CompiledMethod* method_code = method-&gt;code();
1268     if (method_code != NULL &amp;&amp; method_code-&gt;is_nmethod()) {
1269       if (compilation_is_complete(method, osr_bci, comp_level)) {
1270         return (nmethod*) method_code;
1271       }
1272     }
1273     if (method-&gt;is_not_compilable(comp_level)) {
1274       return NULL;
1275     }
1276   } else {
1277     // osr compilation
1278 #ifndef TIERED
1279     // seems like an assert of dubious value
1280     assert(comp_level == CompLevel_highest_tier,
1281            &quot;all OSR compiles are assumed to be at a single compilation level&quot;);
1282 #endif // TIERED
1283     // We accept a higher level osr method
1284     nmethod* nm = method-&gt;lookup_osr_nmethod_for(osr_bci, comp_level, false);
1285     if (nm != NULL) return nm;
1286     if (method-&gt;is_not_osr_compilable(comp_level)) return NULL;
1287   }
1288 
1289   assert(!HAS_PENDING_EXCEPTION, &quot;No exception should be present&quot;);
1290   // some prerequisites that are compiler specific
1291   if (comp-&gt;is_c2()) {
1292     method-&gt;constants()-&gt;resolve_string_constants(CHECK_AND_CLEAR_NULL);
1293     // Resolve all classes seen in the signature of the method
1294     // we are compiling.
1295     Method::load_signature_classes(method, CHECK_AND_CLEAR_NULL);
1296   }
1297 
1298   // If the method is native, do the lookup in the thread requesting
1299   // the compilation. Native lookups can load code, which is not
1300   // permitted during compilation.
1301   //
1302   // Note: A native method implies non-osr compilation which is
1303   //       checked with an assertion at the entry of this method.
1304   if (method-&gt;is_native() &amp;&amp; !method-&gt;is_method_handle_intrinsic()) {
1305     bool in_base_library;
1306     address adr = NativeLookup::lookup(method, in_base_library, THREAD);
1307     if (HAS_PENDING_EXCEPTION) {
1308       // In case of an exception looking up the method, we just forget
1309       // about it. The interpreter will kick-in and throw the exception.
1310       method-&gt;set_not_compilable(&quot;NativeLookup::lookup failed&quot;); // implies is_not_osr_compilable()
1311       CLEAR_PENDING_EXCEPTION;
1312       return NULL;
1313     }
1314     assert(method-&gt;has_native_function(), &quot;must have native code by now&quot;);
1315   }
1316 
1317   // RedefineClasses() has replaced this method; just return
1318   if (method-&gt;is_old()) {
1319     return NULL;
1320   }
1321 
1322   // JVMTI -- post_compile_event requires jmethod_id() that may require
1323   // a lock the compiling thread can not acquire. Prefetch it here.
1324   if (JvmtiExport::should_post_compiled_method_load()) {
1325     method-&gt;jmethod_id();
1326   }
1327 
1328   // do the compilation
1329   if (method-&gt;is_native()) {
1330     if (!PreferInterpreterNativeStubs || method-&gt;is_method_handle_intrinsic()) {
<a name="1" id="anc1"></a><span class="line-added">1331 #if defined(X86) &amp;&amp; !defined(ZERO)</span>
1332       // The following native methods:
1333       //
1334       // java.lang.Float.intBitsToFloat
1335       // java.lang.Float.floatToRawIntBits
1336       // java.lang.Double.longBitsToDouble
1337       // java.lang.Double.doubleToRawLongBits
1338       //
1339       // are called through the interpreter even if interpreter native stubs
1340       // are not preferred (i.e., calling through adapter handlers is preferred).
1341       // The reason is that on x86_32 signaling NaNs (sNaNs) are not preserved
1342       // if the version of the methods from the native libraries is called.
1343       // As the interpreter and the C2-intrinsified version of the methods preserves
1344       // sNaNs, that would result in an inconsistent way of handling of sNaNs.
1345       if ((UseSSE &gt;= 1 &amp;&amp;
1346           (method-&gt;intrinsic_id() == vmIntrinsics::_intBitsToFloat ||
1347            method-&gt;intrinsic_id() == vmIntrinsics::_floatToRawIntBits)) ||
1348           (UseSSE &gt;= 2 &amp;&amp;
1349            (method-&gt;intrinsic_id() == vmIntrinsics::_longBitsToDouble ||
1350             method-&gt;intrinsic_id() == vmIntrinsics::_doubleToRawLongBits))) {
1351         return NULL;
1352       }
<a name="2" id="anc2"></a><span class="line-added">1353 #endif // X86 &amp;&amp; !ZERO</span>
1354 
1355       // To properly handle the appendix argument for out-of-line calls we are using a small trampoline that
1356       // pops off the appendix argument and jumps to the target (see gen_special_dispatch in SharedRuntime).
1357       //
1358       // Since normal compiled-to-compiled calls are not able to handle such a thing we MUST generate an adapter
1359       // in this case.  If we can&#39;t generate one and use it we can not execute the out-of-line method handle calls.
1360       AdapterHandlerLibrary::create_native_wrapper(method);
1361     } else {
1362       return NULL;
1363     }
1364   } else {
1365     // If the compiler is shut off due to code cache getting full
1366     // fail out now so blocking compiles dont hang the java thread
1367     if (!should_compile_new_jobs()) {
1368       CompilationPolicy::policy()-&gt;delay_compilation(method());
1369       return NULL;
1370     }
1371     bool is_blocking = !directive-&gt;BackgroundCompilationOption || ReplayCompiles;
1372     compile_method_base(method, osr_bci, comp_level, hot_method, hot_count, compile_reason, is_blocking, THREAD);
1373   }
1374 
1375   // return requested nmethod
1376   // We accept a higher level osr method
1377   if (osr_bci == InvocationEntryBci) {
1378     CompiledMethod* code = method-&gt;code();
1379     if (code == NULL) {
1380       return (nmethod*) code;
1381     } else {
1382       return code-&gt;as_nmethod_or_null();
1383     }
1384   }
1385   return method-&gt;lookup_osr_nmethod_for(osr_bci, comp_level, false);
1386 }
1387 
1388 
1389 // ------------------------------------------------------------------
1390 // CompileBroker::compilation_is_complete
1391 //
1392 // See if compilation of this method is already complete.
1393 bool CompileBroker::compilation_is_complete(const methodHandle&amp; method,
1394                                             int                 osr_bci,
1395                                             int                 comp_level) {
1396   bool is_osr = (osr_bci != standard_entry_bci);
1397   if (is_osr) {
1398     if (method-&gt;is_not_osr_compilable(comp_level)) {
1399       return true;
1400     } else {
1401       nmethod* result = method-&gt;lookup_osr_nmethod_for(osr_bci, comp_level, true);
1402       return (result != NULL);
1403     }
1404   } else {
1405     if (method-&gt;is_not_compilable(comp_level)) {
1406       return true;
1407     } else {
1408       CompiledMethod* result = method-&gt;code();
1409       if (result == NULL) return false;
1410       return comp_level == result-&gt;comp_level();
1411     }
1412   }
1413 }
1414 
1415 
1416 /**
1417  * See if this compilation is already requested.
1418  *
1419  * Implementation note: there is only a single &quot;is in queue&quot; bit
1420  * for each method.  This means that the check below is overly
1421  * conservative in the sense that an osr compilation in the queue
1422  * will block a normal compilation from entering the queue (and vice
1423  * versa).  This can be remedied by a full queue search to disambiguate
1424  * cases.  If it is deemed profitable, this may be done.
1425  */
1426 bool CompileBroker::compilation_is_in_queue(const methodHandle&amp; method) {
1427   return method-&gt;queued_for_compilation();
1428 }
1429 
1430 // ------------------------------------------------------------------
1431 // CompileBroker::compilation_is_prohibited
1432 //
1433 // See if this compilation is not allowed.
1434 bool CompileBroker::compilation_is_prohibited(const methodHandle&amp; method, int osr_bci, int comp_level, bool excluded) {
1435   bool is_native = method-&gt;is_native();
1436   // Some compilers may not support the compilation of natives.
1437   AbstractCompiler *comp = compiler(comp_level);
1438   if (is_native &amp;&amp;
1439       (!CICompileNatives || comp == NULL || !comp-&gt;supports_native())) {
1440     method-&gt;set_not_compilable_quietly(&quot;native methods not supported&quot;, comp_level);
1441     return true;
1442   }
1443 
1444   bool is_osr = (osr_bci != standard_entry_bci);
1445   // Some compilers may not support on stack replacement.
1446   if (is_osr &amp;&amp;
1447       (!CICompileOSR || comp == NULL || !comp-&gt;supports_osr())) {
1448     method-&gt;set_not_osr_compilable(&quot;OSR not supported&quot;, comp_level);
1449     return true;
1450   }
1451 
1452   // The method may be explicitly excluded by the user.
1453   double scale;
1454   if (excluded || (CompilerOracle::has_option_value(method, &quot;CompileThresholdScaling&quot;, scale) &amp;&amp; scale == 0)) {
1455     bool quietly = CompilerOracle::should_exclude_quietly();
1456     if (PrintCompilation &amp;&amp; !quietly) {
1457       // This does not happen quietly...
1458       ResourceMark rm;
1459       tty-&gt;print(&quot;### Excluding %s:%s&quot;,
1460                  method-&gt;is_native() ? &quot;generation of native wrapper&quot; : &quot;compile&quot;,
1461                  (method-&gt;is_static() ? &quot; static&quot; : &quot;&quot;));
1462       method-&gt;print_short_name(tty);
1463       tty-&gt;cr();
1464     }
1465     method-&gt;set_not_compilable(&quot;excluded by CompileCommand&quot;, comp_level, !quietly);
1466   }
1467 
1468   return false;
1469 }
1470 
1471 /**
1472  * Generate serialized IDs for compilation requests. If certain debugging flags are used
1473  * and the ID is not within the specified range, the method is not compiled and 0 is returned.
1474  * The function also allows to generate separate compilation IDs for OSR compilations.
1475  */
1476 int CompileBroker::assign_compile_id(const methodHandle&amp; method, int osr_bci) {
1477 #ifdef ASSERT
1478   bool is_osr = (osr_bci != standard_entry_bci);
1479   int id;
1480   if (method-&gt;is_native()) {
1481     assert(!is_osr, &quot;can&#39;t be osr&quot;);
1482     // Adapters, native wrappers and method handle intrinsics
1483     // should be generated always.
1484     return Atomic::add(&amp;_compilation_id, 1);
1485   } else if (CICountOSR &amp;&amp; is_osr) {
1486     id = Atomic::add(&amp;_osr_compilation_id, 1);
1487     if (CIStartOSR &lt;= id &amp;&amp; id &lt; CIStopOSR) {
1488       return id;
1489     }
1490   } else {
1491     id = Atomic::add(&amp;_compilation_id, 1);
1492     if (CIStart &lt;= id &amp;&amp; id &lt; CIStop) {
1493       return id;
1494     }
1495   }
1496 
1497   // Method was not in the appropriate compilation range.
1498   method-&gt;set_not_compilable_quietly(&quot;Not in requested compile id range&quot;);
1499   return 0;
1500 #else
1501   // CICountOSR is a develop flag and set to &#39;false&#39; by default. In a product built,
1502   // only _compilation_id is incremented.
1503   return Atomic::add(&amp;_compilation_id, 1);
1504 #endif
1505 }
1506 
1507 // ------------------------------------------------------------------
1508 // CompileBroker::assign_compile_id_unlocked
1509 //
1510 // Public wrapper for assign_compile_id that acquires the needed locks
1511 uint CompileBroker::assign_compile_id_unlocked(Thread* thread, const methodHandle&amp; method, int osr_bci) {
1512   MutexLocker locker(thread, MethodCompileQueue_lock);
1513   return assign_compile_id(method, osr_bci);
1514 }
1515 
1516 // ------------------------------------------------------------------
1517 // CompileBroker::create_compile_task
1518 //
1519 // Create a CompileTask object representing the current request for
1520 // compilation.  Add this task to the queue.
1521 CompileTask* CompileBroker::create_compile_task(CompileQueue*       queue,
1522                                                 int                 compile_id,
1523                                                 const methodHandle&amp; method,
1524                                                 int                 osr_bci,
1525                                                 int                 comp_level,
1526                                                 const methodHandle&amp; hot_method,
1527                                                 int                 hot_count,
1528                                                 CompileTask::CompileReason compile_reason,
1529                                                 bool                blocking) {
1530   CompileTask* new_task = CompileTask::allocate();
1531   new_task-&gt;initialize(compile_id, method, osr_bci, comp_level,
1532                        hot_method, hot_count, compile_reason,
1533                        blocking);
1534   queue-&gt;add(new_task);
1535   return new_task;
1536 }
1537 
1538 #if INCLUDE_JVMCI
1539 // The number of milliseconds to wait before checking if
1540 // JVMCI compilation has made progress.
1541 static const long JVMCI_COMPILATION_PROGRESS_WAIT_TIMESLICE = 1000;
1542 
1543 // The number of JVMCI compilation progress checks that must fail
1544 // before unblocking a thread waiting for a blocking compilation.
1545 static const int JVMCI_COMPILATION_PROGRESS_WAIT_ATTEMPTS = 10;
1546 
1547 /**
1548  * Waits for a JVMCI compiler to complete a given task. This thread
1549  * waits until either the task completes or it sees no JVMCI compilation
1550  * progress for N consecutive milliseconds where N is
1551  * JVMCI_COMPILATION_PROGRESS_WAIT_TIMESLICE *
1552  * JVMCI_COMPILATION_PROGRESS_WAIT_ATTEMPTS.
1553  *
1554  * @return true if this thread needs to free/recycle the task
1555  */
1556 bool CompileBroker::wait_for_jvmci_completion(JVMCICompiler* jvmci, CompileTask* task, JavaThread* thread) {
1557   MonitorLocker ml(thread, task-&gt;lock());
1558   int progress_wait_attempts = 0;
1559   int methods_compiled = jvmci-&gt;methods_compiled();
1560   while (!task-&gt;is_complete() &amp;&amp; !is_compilation_disabled_forever() &amp;&amp;
1561          ml.wait(JVMCI_COMPILATION_PROGRESS_WAIT_TIMESLICE)) {
1562     CompilerThread* jvmci_compiler_thread = task-&gt;jvmci_compiler_thread();
1563 
1564     bool progress;
1565     if (jvmci_compiler_thread != NULL) {
1566       // If the JVMCI compiler thread is not blocked or suspended, we deem it to be making progress.
1567       progress = jvmci_compiler_thread-&gt;thread_state() != _thread_blocked &amp;&amp;
1568         !jvmci_compiler_thread-&gt;is_external_suspend();
1569     } else {
1570       // Still waiting on JVMCI compiler queue. This thread may be holding a lock
1571       // that all JVMCI compiler threads are blocked on. We use the counter for
1572       // successful JVMCI compilations to determine whether JVMCI compilation
1573       // is still making progress through the JVMCI compiler queue.
1574       progress = jvmci-&gt;methods_compiled() != methods_compiled;
1575     }
1576 
1577     if (!progress) {
1578       if (++progress_wait_attempts == JVMCI_COMPILATION_PROGRESS_WAIT_ATTEMPTS) {
1579         if (PrintCompilation) {
1580           task-&gt;print(tty, &quot;wait for blocking compilation timed out&quot;);
1581         }
1582         break;
1583       }
1584     } else {
1585       progress_wait_attempts = 0;
1586       if (jvmci_compiler_thread == NULL) {
1587         methods_compiled = jvmci-&gt;methods_compiled();
1588       }
1589     }
1590   }
1591   task-&gt;clear_waiter();
1592   return task-&gt;is_complete();
1593 }
1594 #endif
1595 
1596 /**
1597  *  Wait for the compilation task to complete.
1598  */
1599 void CompileBroker::wait_for_completion(CompileTask* task) {
1600   if (CIPrintCompileQueue) {
1601     ttyLocker ttyl;
1602     tty-&gt;print_cr(&quot;BLOCKING FOR COMPILE&quot;);
1603   }
1604 
1605   assert(task-&gt;is_blocking(), &quot;can only wait on blocking task&quot;);
1606 
1607   JavaThread* thread = JavaThread::current();
1608 
1609   methodHandle method(thread, task-&gt;method());
1610   bool free_task;
1611 #if INCLUDE_JVMCI
1612   AbstractCompiler* comp = compiler(task-&gt;comp_level());
1613   if (comp-&gt;is_jvmci()) {
1614     free_task = wait_for_jvmci_completion((JVMCICompiler*) comp, task, thread);
1615   } else
1616 #endif
1617   {
1618     MonitorLocker ml(thread, task-&gt;lock());
1619     free_task = true;
1620     while (!task-&gt;is_complete() &amp;&amp; !is_compilation_disabled_forever()) {
1621       ml.wait();
1622     }
1623   }
1624 
1625   if (free_task) {
1626     if (is_compilation_disabled_forever()) {
1627       CompileTask::free(task);
1628       return;
1629     }
1630 
1631     // It is harmless to check this status without the lock, because
1632     // completion is a stable property (until the task object is recycled).
1633     assert(task-&gt;is_complete(), &quot;Compilation should have completed&quot;);
1634     assert(task-&gt;code_handle() == NULL, &quot;must be reset&quot;);
1635 
1636     // By convention, the waiter is responsible for recycling a
1637     // blocking CompileTask. Since there is only one waiter ever
1638     // waiting on a CompileTask, we know that no one else will
1639     // be using this CompileTask; we can free it.
1640     CompileTask::free(task);
1641   }
1642 }
1643 
1644 /**
1645  * Initialize compiler thread(s) + compiler object(s). The postcondition
1646  * of this function is that the compiler runtimes are initialized and that
1647  * compiler threads can start compiling.
1648  */
1649 bool CompileBroker::init_compiler_runtime() {
1650   CompilerThread* thread = CompilerThread::current();
1651   AbstractCompiler* comp = thread-&gt;compiler();
1652   // Final sanity check - the compiler object must exist
1653   guarantee(comp != NULL, &quot;Compiler object must exist&quot;);
1654 
1655   {
1656     // Must switch to native to allocate ci_env
1657     ThreadToNativeFromVM ttn(thread);
1658     ciEnv ci_env((CompileTask*)NULL);
1659     // Cache Jvmti state
1660     ci_env.cache_jvmti_state();
1661     // Cache DTrace flags
1662     ci_env.cache_dtrace_flags();
1663 
1664     // Switch back to VM state to do compiler initialization
1665     ThreadInVMfromNative tv(thread);
1666     ResetNoHandleMark rnhm;
1667 
1668     // Perform per-thread and global initializations
1669     comp-&gt;initialize();
1670   }
1671 
1672   if (comp-&gt;is_failed()) {
1673     disable_compilation_forever();
1674     // If compiler initialization failed, no compiler thread that is specific to a
1675     // particular compiler runtime will ever start to compile methods.
1676     shutdown_compiler_runtime(comp, thread);
1677     return false;
1678   }
1679 
1680   // C1 specific check
1681   if (comp-&gt;is_c1() &amp;&amp; (thread-&gt;get_buffer_blob() == NULL)) {
1682     warning(&quot;Initialization of %s thread failed (no space to run compilers)&quot;, thread-&gt;name());
1683     return false;
1684   }
1685 
1686   return true;
1687 }
1688 
1689 /**
1690  * If C1 and/or C2 initialization failed, we shut down all compilation.
1691  * We do this to keep things simple. This can be changed if it ever turns
1692  * out to be a problem.
1693  */
1694 void CompileBroker::shutdown_compiler_runtime(AbstractCompiler* comp, CompilerThread* thread) {
1695   // Free buffer blob, if allocated
1696   if (thread-&gt;get_buffer_blob() != NULL) {
1697     MutexLocker mu(CodeCache_lock, Mutex::_no_safepoint_check_flag);
1698     CodeCache::free(thread-&gt;get_buffer_blob());
1699   }
1700 
1701   if (comp-&gt;should_perform_shutdown()) {
1702     // There are two reasons for shutting down the compiler
1703     // 1) compiler runtime initialization failed
1704     // 2) The code cache is full and the following flag is set: -XX:-UseCodeCacheFlushing
1705     warning(&quot;%s initialization failed. Shutting down all compilers&quot;, comp-&gt;name());
1706 
1707     // Only one thread per compiler runtime object enters here
1708     // Set state to shut down
1709     comp-&gt;set_shut_down();
1710 
1711     // Delete all queued compilation tasks to make compiler threads exit faster.
1712     if (_c1_compile_queue != NULL) {
1713       _c1_compile_queue-&gt;free_all();
1714     }
1715 
1716     if (_c2_compile_queue != NULL) {
1717       _c2_compile_queue-&gt;free_all();
1718     }
1719 
1720     // Set flags so that we continue execution with using interpreter only.
1721     UseCompiler    = false;
1722     UseInterpreter = true;
1723 
1724     // We could delete compiler runtimes also. However, there are references to
1725     // the compiler runtime(s) (e.g.,  nmethod::is_compiled_by_c1()) which then
1726     // fail. This can be done later if necessary.
1727   }
1728 }
1729 
1730 /**
1731  * Helper function to create new or reuse old CompileLog.
1732  */
1733 CompileLog* CompileBroker::get_log(CompilerThread* ct) {
1734   if (!LogCompilation) return NULL;
1735 
1736   AbstractCompiler *compiler = ct-&gt;compiler();
1737   bool c1 = compiler-&gt;is_c1();
1738   jobject* compiler_objects = c1 ? _compiler1_objects : _compiler2_objects;
1739   assert(compiler_objects != NULL, &quot;must be initialized at this point&quot;);
1740   CompileLog** logs = c1 ? _compiler1_logs : _compiler2_logs;
1741   assert(logs != NULL, &quot;must be initialized at this point&quot;);
1742   int count = c1 ? _c1_count : _c2_count;
1743 
1744   // Find Compiler number by its threadObj.
1745   oop compiler_obj = ct-&gt;threadObj();
1746   int compiler_number = 0;
1747   bool found = false;
1748   for (; compiler_number &lt; count; compiler_number++) {
1749     if (JNIHandles::resolve_non_null(compiler_objects[compiler_number]) == compiler_obj) {
1750       found = true;
1751       break;
1752     }
1753   }
1754   assert(found, &quot;Compiler must exist at this point&quot;);
1755 
1756   // Determine pointer for this thread&#39;s log.
1757   CompileLog** log_ptr = &amp;logs[compiler_number];
1758 
1759   // Return old one if it exists.
1760   CompileLog* log = *log_ptr;
1761   if (log != NULL) {
1762     ct-&gt;init_log(log);
1763     return log;
1764   }
1765 
1766   // Create a new one and remember it.
1767   init_compiler_thread_log();
1768   log = ct-&gt;log();
1769   *log_ptr = log;
1770   return log;
1771 }
1772 
1773 // ------------------------------------------------------------------
1774 // CompileBroker::compiler_thread_loop
1775 //
1776 // The main loop run by a CompilerThread.
1777 void CompileBroker::compiler_thread_loop() {
1778   CompilerThread* thread = CompilerThread::current();
1779   CompileQueue* queue = thread-&gt;queue();
1780   // For the thread that initializes the ciObjectFactory
1781   // this resource mark holds all the shared objects
1782   ResourceMark rm;
1783 
1784   // First thread to get here will initialize the compiler interface
1785 
1786   {
1787     ASSERT_IN_VM;
1788     MutexLocker only_one (thread, CompileThread_lock);
1789     if (!ciObjectFactory::is_initialized()) {
1790       ciObjectFactory::initialize();
1791     }
1792   }
1793 
1794   // Open a log.
1795   CompileLog* log = get_log(thread);
1796   if (log != NULL) {
1797     log-&gt;begin_elem(&quot;start_compile_thread name=&#39;%s&#39; thread=&#39;&quot; UINTX_FORMAT &quot;&#39; process=&#39;%d&#39;&quot;,
1798                     thread-&gt;name(),
1799                     os::current_thread_id(),
1800                     os::current_process_id());
1801     log-&gt;stamp();
1802     log-&gt;end_elem();
1803   }
1804 
1805   // If compiler thread/runtime initialization fails, exit the compiler thread
1806   if (!init_compiler_runtime()) {
1807     return;
1808   }
1809 
1810   thread-&gt;start_idle_timer();
1811 
1812   // Poll for new compilation tasks as long as the JVM runs. Compilation
1813   // should only be disabled if something went wrong while initializing the
1814   // compiler runtimes. This, in turn, should not happen. The only known case
1815   // when compiler runtime initialization fails is if there is not enough free
1816   // space in the code cache to generate the necessary stubs, etc.
1817   while (!is_compilation_disabled_forever()) {
1818     // We need this HandleMark to avoid leaking VM handles.
1819     HandleMark hm(thread);
1820 
1821     CompileTask* task = queue-&gt;get();
1822     if (task == NULL) {
1823       if (UseDynamicNumberOfCompilerThreads) {
1824         // Access compiler_count under lock to enforce consistency.
1825         MutexLocker only_one(CompileThread_lock);
1826         if (can_remove(thread, true)) {
1827           if (TraceCompilerThreads) {
1828             tty-&gt;print_cr(&quot;Removing compiler thread %s after &quot; JLONG_FORMAT &quot; ms idle time&quot;,
1829                           thread-&gt;name(), thread-&gt;idle_time_millis());
1830           }
1831           // Free buffer blob, if allocated
1832           if (thread-&gt;get_buffer_blob() != NULL) {
1833             MutexLocker mu(CodeCache_lock, Mutex::_no_safepoint_check_flag);
1834             CodeCache::free(thread-&gt;get_buffer_blob());
1835           }
1836           return; // Stop this thread.
1837         }
1838       }
1839     } else {
1840       // Assign the task to the current thread.  Mark this compilation
1841       // thread as active for the profiler.
1842       // CompileTaskWrapper also keeps the Method* from being deallocated if redefinition
1843       // occurs after fetching the compile task off the queue.
1844       CompileTaskWrapper ctw(task);
1845       nmethodLocker result_handle;  // (handle for the nmethod produced by this task)
1846       task-&gt;set_code_handle(&amp;result_handle);
1847       methodHandle method(thread, task-&gt;method());
1848 
1849       // Never compile a method if breakpoints are present in it
1850       if (method()-&gt;number_of_breakpoints() == 0) {
1851         // Compile the method.
1852         if ((UseCompiler || AlwaysCompileLoopMethods) &amp;&amp; CompileBroker::should_compile_new_jobs()) {
1853           invoke_compiler_on_method(task);
1854           thread-&gt;start_idle_timer();
1855         } else {
1856           // After compilation is disabled, remove remaining methods from queue
1857           method-&gt;clear_queued_for_compilation();
1858           task-&gt;set_failure_reason(&quot;compilation is disabled&quot;);
1859         }
1860       }
1861 
1862       if (UseDynamicNumberOfCompilerThreads) {
1863         possibly_add_compiler_threads(thread);
1864         assert(!thread-&gt;has_pending_exception(), &quot;should have been handled&quot;);
1865       }
1866     }
1867   }
1868 
1869   // Shut down compiler runtime
1870   shutdown_compiler_runtime(thread-&gt;compiler(), thread);
1871 }
1872 
1873 // ------------------------------------------------------------------
1874 // CompileBroker::init_compiler_thread_log
1875 //
1876 // Set up state required by +LogCompilation.
1877 void CompileBroker::init_compiler_thread_log() {
1878     CompilerThread* thread = CompilerThread::current();
1879     char  file_name[4*K];
1880     FILE* fp = NULL;
1881     intx thread_id = os::current_thread_id();
1882     for (int try_temp_dir = 1; try_temp_dir &gt;= 0; try_temp_dir--) {
1883       const char* dir = (try_temp_dir ? os::get_temp_directory() : NULL);
1884       if (dir == NULL) {
1885         jio_snprintf(file_name, sizeof(file_name), &quot;hs_c&quot; UINTX_FORMAT &quot;_pid%u.log&quot;,
1886                      thread_id, os::current_process_id());
1887       } else {
1888         jio_snprintf(file_name, sizeof(file_name),
1889                      &quot;%s%shs_c&quot; UINTX_FORMAT &quot;_pid%u.log&quot;, dir,
1890                      os::file_separator(), thread_id, os::current_process_id());
1891       }
1892 
1893       fp = fopen(file_name, &quot;wt&quot;);
1894       if (fp != NULL) {
1895         if (LogCompilation &amp;&amp; Verbose) {
1896           tty-&gt;print_cr(&quot;Opening compilation log %s&quot;, file_name);
1897         }
1898         CompileLog* log = new(ResourceObj::C_HEAP, mtCompiler) CompileLog(file_name, fp, thread_id);
1899         if (log == NULL) {
1900           fclose(fp);
1901           return;
1902         }
1903         thread-&gt;init_log(log);
1904 
1905         if (xtty != NULL) {
1906           ttyLocker ttyl;
1907           // Record any per thread log files
1908           xtty-&gt;elem(&quot;thread_logfile thread=&#39;&quot; INTX_FORMAT &quot;&#39; filename=&#39;%s&#39;&quot;, thread_id, file_name);
1909         }
1910         return;
1911       }
1912     }
1913     warning(&quot;Cannot open log file: %s&quot;, file_name);
1914 }
1915 
1916 void CompileBroker::log_metaspace_failure() {
1917   const char* message = &quot;some methods may not be compiled because metaspace &quot;
1918                         &quot;is out of memory&quot;;
1919   if (_compilation_log != NULL) {
1920     _compilation_log-&gt;log_metaspace_failure(message);
1921   }
1922   if (PrintCompilation) {
1923     tty-&gt;print_cr(&quot;COMPILE PROFILING SKIPPED: %s&quot;, message);
1924   }
1925 }
1926 
1927 
1928 // ------------------------------------------------------------------
1929 // CompileBroker::set_should_block
1930 //
1931 // Set _should_block.
1932 // Call this from the VM, with Threads_lock held and a safepoint requested.
1933 void CompileBroker::set_should_block() {
1934   assert(Threads_lock-&gt;owner() == Thread::current(), &quot;must have threads lock&quot;);
1935   assert(SafepointSynchronize::is_at_safepoint(), &quot;must be at a safepoint already&quot;);
1936 #ifndef PRODUCT
1937   if (PrintCompilation &amp;&amp; (Verbose || WizardMode))
1938     tty-&gt;print_cr(&quot;notifying compiler thread pool to block&quot;);
1939 #endif
1940   _should_block = true;
1941 }
1942 
1943 // ------------------------------------------------------------------
1944 // CompileBroker::maybe_block
1945 //
1946 // Call this from the compiler at convenient points, to poll for _should_block.
1947 void CompileBroker::maybe_block() {
1948   if (_should_block) {
1949 #ifndef PRODUCT
1950     if (PrintCompilation &amp;&amp; (Verbose || WizardMode))
1951       tty-&gt;print_cr(&quot;compiler thread &quot; INTPTR_FORMAT &quot; poll detects block request&quot;, p2i(Thread::current()));
1952 #endif
1953     ThreadInVMfromNative tivfn(JavaThread::current());
1954   }
1955 }
1956 
1957 // wrapper for CodeCache::print_summary()
1958 static void codecache_print(bool detailed)
1959 {
1960   ResourceMark rm;
1961   stringStream s;
1962   // Dump code cache  into a buffer before locking the tty,
1963   {
1964     MutexLocker mu(CodeCache_lock, Mutex::_no_safepoint_check_flag);
1965     CodeCache::print_summary(&amp;s, detailed);
1966   }
1967   ttyLocker ttyl;
1968   tty-&gt;print(&quot;%s&quot;, s.as_string());
1969 }
1970 
1971 // wrapper for CodeCache::print_summary() using outputStream
1972 static void codecache_print(outputStream* out, bool detailed) {
1973   ResourceMark rm;
1974   stringStream s;
1975 
1976   // Dump code cache into a buffer
1977   {
1978     MutexLocker mu(CodeCache_lock, Mutex::_no_safepoint_check_flag);
1979     CodeCache::print_summary(&amp;s, detailed);
1980   }
1981 
1982   char* remaining_log = s.as_string();
1983   while (*remaining_log != &#39;\0&#39;) {
1984     char* eol = strchr(remaining_log, &#39;\n&#39;);
1985     if (eol == NULL) {
1986       out-&gt;print_cr(&quot;%s&quot;, remaining_log);
1987       remaining_log = remaining_log + strlen(remaining_log);
1988     } else {
1989       *eol = &#39;\0&#39;;
1990       out-&gt;print_cr(&quot;%s&quot;, remaining_log);
1991       remaining_log = eol + 1;
1992     }
1993   }
1994 }
1995 
1996 void CompileBroker::post_compile(CompilerThread* thread, CompileTask* task, bool success, ciEnv* ci_env,
1997                                  int compilable, const char* failure_reason) {
1998   if (success) {
1999     task-&gt;mark_success();
2000     if (ci_env != NULL) {
2001       task-&gt;set_num_inlined_bytecodes(ci_env-&gt;num_inlined_bytecodes());
2002     }
2003     if (_compilation_log != NULL) {
2004       nmethod* code = task-&gt;code();
2005       if (code != NULL) {
2006         _compilation_log-&gt;log_nmethod(thread, code);
2007       }
2008     }
2009   } else if (AbortVMOnCompilationFailure) {
2010     if (compilable == ciEnv::MethodCompilable_not_at_tier) {
2011       fatal(&quot;Not compilable at tier %d: %s&quot;, task-&gt;comp_level(), failure_reason);
2012     }
2013     if (compilable == ciEnv::MethodCompilable_never) {
2014       fatal(&quot;Never compilable: %s&quot;, failure_reason);
2015     }
2016   }
2017   // simulate crash during compilation
2018   assert(task-&gt;compile_id() != CICrashAt, &quot;just as planned&quot;);
2019 }
2020 
2021 static void post_compilation_event(EventCompilation* event, CompileTask* task) {
2022   assert(event != NULL, &quot;invariant&quot;);
2023   assert(event-&gt;should_commit(), &quot;invariant&quot;);
2024   assert(task != NULL, &quot;invariant&quot;);
2025   event-&gt;set_compileId(task-&gt;compile_id());
2026   event-&gt;set_compiler(task-&gt;compiler()-&gt;type());
2027   event-&gt;set_method(task-&gt;method());
2028   event-&gt;set_compileLevel(task-&gt;comp_level());
2029   event-&gt;set_succeded(task-&gt;is_success());
2030   event-&gt;set_isOsr(task-&gt;osr_bci() != CompileBroker::standard_entry_bci);
2031   event-&gt;set_codeSize((task-&gt;code() == NULL) ? 0 : task-&gt;code()-&gt;total_size());
2032   event-&gt;set_inlinedBytes(task-&gt;num_inlined_bytecodes());
2033   event-&gt;commit();
2034 }
2035 
2036 int DirectivesStack::_depth = 0;
2037 CompilerDirectives* DirectivesStack::_top = NULL;
2038 CompilerDirectives* DirectivesStack::_bottom = NULL;
2039 
2040 // ------------------------------------------------------------------
2041 // CompileBroker::invoke_compiler_on_method
2042 //
2043 // Compile a method.
2044 //
2045 void CompileBroker::invoke_compiler_on_method(CompileTask* task) {
2046   task-&gt;print_ul();
2047   if (PrintCompilation) {
2048     ResourceMark rm;
2049     task-&gt;print_tty();
2050   }
2051   elapsedTimer time;
2052 
2053   CompilerThread* thread = CompilerThread::current();
2054   ResourceMark rm(thread);
2055 
2056   if (LogEvents) {
2057     _compilation_log-&gt;log_compile(thread, task);
2058   }
2059 
2060   // Common flags.
2061   uint compile_id = task-&gt;compile_id();
2062   int osr_bci = task-&gt;osr_bci();
2063   bool is_osr = (osr_bci != standard_entry_bci);
2064   bool should_log = (thread-&gt;log() != NULL);
2065   bool should_break = false;
2066   const int task_level = task-&gt;comp_level();
2067   AbstractCompiler* comp = task-&gt;compiler();
2068 
2069   DirectiveSet* directive;
2070   {
2071     // create the handle inside it&#39;s own block so it can&#39;t
2072     // accidentally be referenced once the thread transitions to
2073     // native.  The NoHandleMark before the transition should catch
2074     // any cases where this occurs in the future.
2075     methodHandle method(thread, task-&gt;method());
2076     assert(!method-&gt;is_native(), &quot;no longer compile natives&quot;);
2077 
2078     // Look up matching directives
2079     directive = DirectivesStack::getMatchingDirective(method, comp);
2080 
2081     // Update compile information when using perfdata.
2082     if (UsePerfData) {
2083       update_compile_perf_data(thread, method, is_osr);
2084     }
2085 
2086     DTRACE_METHOD_COMPILE_BEGIN_PROBE(method, compiler_name(task_level));
2087   }
2088 
2089   should_break = directive-&gt;BreakAtExecuteOption || task-&gt;check_break_at_flags();
2090   if (should_log &amp;&amp; !directive-&gt;LogOption) {
2091     should_log = false;
2092   }
2093 
2094   // Allocate a new set of JNI handles.
2095   push_jni_handle_block();
2096   Method* target_handle = task-&gt;method();
2097   int compilable = ciEnv::MethodCompilable;
2098   const char* failure_reason = NULL;
2099   bool failure_reason_on_C_heap = false;
2100   const char* retry_message = NULL;
2101 
2102 #if INCLUDE_JVMCI
2103   if (UseJVMCICompiler &amp;&amp; comp != NULL &amp;&amp; comp-&gt;is_jvmci()) {
2104     JVMCICompiler* jvmci = (JVMCICompiler*) comp;
2105 
2106     TraceTime t1(&quot;compilation&quot;, &amp;time);
2107     EventCompilation event;
2108 
2109     // Skip redefined methods
2110     if (target_handle-&gt;is_old()) {
2111       failure_reason = &quot;redefined method&quot;;
2112       retry_message = &quot;not retryable&quot;;
2113       compilable = ciEnv::MethodCompilable_never;
2114     } else {
2115       JVMCICompileState compile_state(task);
2116       JVMCIEnv env(thread, &amp;compile_state, __FILE__, __LINE__);
2117       methodHandle method(thread, target_handle);
2118       env.runtime()-&gt;compile_method(&amp;env, jvmci, method, osr_bci);
2119 
2120       failure_reason = compile_state.failure_reason();
2121       failure_reason_on_C_heap = compile_state.failure_reason_on_C_heap();
2122       if (!compile_state.retryable()) {
2123         retry_message = &quot;not retryable&quot;;
2124         compilable = ciEnv::MethodCompilable_not_at_tier;
2125       }
2126       if (task-&gt;code() == NULL) {
2127         assert(failure_reason != NULL, &quot;must specify failure_reason&quot;);
2128       }
2129     }
2130     post_compile(thread, task, task-&gt;code() != NULL, NULL, compilable, failure_reason);
2131     if (event.should_commit()) {
2132       post_compilation_event(&amp;event, task);
2133     }
2134 
2135   } else
2136 #endif // INCLUDE_JVMCI
2137   {
2138     NoHandleMark  nhm;
2139     ThreadToNativeFromVM ttn(thread);
2140 
2141     ciEnv ci_env(task);
2142     if (should_break) {
2143       ci_env.set_break_at_compile(true);
2144     }
2145     if (should_log) {
2146       ci_env.set_log(thread-&gt;log());
2147     }
2148     assert(thread-&gt;env() == &amp;ci_env, &quot;set by ci_env&quot;);
2149     // The thread-env() field is cleared in ~CompileTaskWrapper.
2150 
2151     // Cache Jvmti state
2152     ci_env.cache_jvmti_state();
2153 
2154     // Cache DTrace flags
2155     ci_env.cache_dtrace_flags();
2156 
2157     ciMethod* target = ci_env.get_method_from_handle(target_handle);
2158 
2159     TraceTime t1(&quot;compilation&quot;, &amp;time);
2160     EventCompilation event;
2161 
2162     if (comp == NULL) {
2163       ci_env.record_method_not_compilable(&quot;no compiler&quot;, !TieredCompilation);
2164     } else {
2165       if (WhiteBoxAPI &amp;&amp; WhiteBox::compilation_locked) {
2166         MonitorLocker locker(Compilation_lock, Mutex::_no_safepoint_check_flag);
2167         while (WhiteBox::compilation_locked) {
2168           locker.wait();
2169         }
2170       }
2171       comp-&gt;compile_method(&amp;ci_env, target, osr_bci, directive);
2172     }
2173 
2174     if (!ci_env.failing() &amp;&amp; task-&gt;code() == NULL) {
2175       //assert(false, &quot;compiler should always document failure&quot;);
2176       // The compiler elected, without comment, not to register a result.
2177       // Do not attempt further compilations of this method.
2178       ci_env.record_method_not_compilable(&quot;compile failed&quot;, !TieredCompilation);
2179     }
2180 
2181     // Copy this bit to the enclosing block:
2182     compilable = ci_env.compilable();
2183 
2184     if (ci_env.failing()) {
2185       failure_reason = ci_env.failure_reason();
2186       retry_message = ci_env.retry_message();
2187       ci_env.report_failure(failure_reason);
2188     }
2189 
2190     post_compile(thread, task, !ci_env.failing(), &amp;ci_env, compilable, failure_reason);
2191     if (event.should_commit()) {
2192       post_compilation_event(&amp;event, task);
2193     }
2194   }
2195   // Remove the JNI handle block after the ciEnv destructor has run in
2196   // the previous block.
2197   pop_jni_handle_block();
2198 
2199   if (failure_reason != NULL) {
2200     task-&gt;set_failure_reason(failure_reason, failure_reason_on_C_heap);
2201     if (_compilation_log != NULL) {
2202       _compilation_log-&gt;log_failure(thread, task, failure_reason, retry_message);
2203     }
2204     if (PrintCompilation) {
2205       FormatBufferResource msg = retry_message != NULL ?
2206         FormatBufferResource(&quot;COMPILE SKIPPED: %s (%s)&quot;, failure_reason, retry_message) :
2207         FormatBufferResource(&quot;COMPILE SKIPPED: %s&quot;,      failure_reason);
2208       task-&gt;print(tty, msg);
2209     }
2210   }
2211 
2212   methodHandle method(thread, task-&gt;method());
2213 
2214   DTRACE_METHOD_COMPILE_END_PROBE(method, compiler_name(task_level), task-&gt;is_success());
2215 
2216   collect_statistics(thread, time, task);
2217 
2218   nmethod* nm = task-&gt;code();
2219   if (nm != NULL) {
2220     nm-&gt;maybe_print_nmethod(directive);
2221   }
2222   DirectivesStack::release(directive);
2223 
2224   if (PrintCompilation &amp;&amp; PrintCompilation2) {
2225     tty-&gt;print(&quot;%7d &quot;, (int) tty-&gt;time_stamp().milliseconds());  // print timestamp
2226     tty-&gt;print(&quot;%4d &quot;, compile_id);    // print compilation number
2227     tty-&gt;print(&quot;%s &quot;, (is_osr ? &quot;%&quot; : &quot; &quot;));
2228     if (task-&gt;code() != NULL) {
2229       tty-&gt;print(&quot;size: %d(%d) &quot;, task-&gt;code()-&gt;total_size(), task-&gt;code()-&gt;insts_size());
2230     }
2231     tty-&gt;print_cr(&quot;time: %d inlined: %d bytes&quot;, (int)time.milliseconds(), task-&gt;num_inlined_bytecodes());
2232   }
2233 
2234   Log(compilation, codecache) log;
2235   if (log.is_debug()) {
2236     LogStream ls(log.debug());
2237     codecache_print(&amp;ls, /* detailed= */ false);
2238   }
2239   if (PrintCodeCacheOnCompilation) {
2240     codecache_print(/* detailed= */ false);
2241   }
2242   // Disable compilation, if required.
2243   switch (compilable) {
2244   case ciEnv::MethodCompilable_never:
2245     if (is_osr)
2246       method-&gt;set_not_osr_compilable_quietly(&quot;MethodCompilable_never&quot;);
2247     else
2248       method-&gt;set_not_compilable_quietly(&quot;MethodCompilable_never&quot;);
2249     break;
2250   case ciEnv::MethodCompilable_not_at_tier:
2251     if (is_osr)
2252       method-&gt;set_not_osr_compilable_quietly(&quot;MethodCompilable_not_at_tier&quot;, task_level);
2253     else
2254       method-&gt;set_not_compilable_quietly(&quot;MethodCompilable_not_at_tier&quot;, task_level);
2255     break;
2256   }
2257 
2258   // Note that the queued_for_compilation bits are cleared without
2259   // protection of a mutex. [They were set by the requester thread,
2260   // when adding the task to the compile queue -- at which time the
2261   // compile queue lock was held. Subsequently, we acquired the compile
2262   // queue lock to get this task off the compile queue; thus (to belabour
2263   // the point somewhat) our clearing of the bits must be occurring
2264   // only after the setting of the bits. See also 14012000 above.
2265   method-&gt;clear_queued_for_compilation();
2266 }
2267 
2268 /**
2269  * The CodeCache is full. Print warning and disable compilation.
2270  * Schedule code cache cleaning so compilation can continue later.
2271  * This function needs to be called only from CodeCache::allocate(),
2272  * since we currently handle a full code cache uniformly.
2273  */
2274 void CompileBroker::handle_full_code_cache(int code_blob_type) {
2275   UseInterpreter = true;
2276   if (UseCompiler || AlwaysCompileLoopMethods ) {
2277     if (xtty != NULL) {
2278       ResourceMark rm;
2279       stringStream s;
2280       // Dump code cache state into a buffer before locking the tty,
2281       // because log_state() will use locks causing lock conflicts.
2282       CodeCache::log_state(&amp;s);
2283       // Lock to prevent tearing
2284       ttyLocker ttyl;
2285       xtty-&gt;begin_elem(&quot;code_cache_full&quot;);
2286       xtty-&gt;print(&quot;%s&quot;, s.as_string());
2287       xtty-&gt;stamp();
2288       xtty-&gt;end_elem();
2289     }
2290 
2291 #ifndef PRODUCT
2292     if (ExitOnFullCodeCache) {
2293       codecache_print(/* detailed= */ true);
2294       before_exit(JavaThread::current());
2295       exit_globals(); // will delete tty
2296       vm_direct_exit(1);
2297     }
2298 #endif
2299     if (UseCodeCacheFlushing) {
2300       // Since code cache is full, immediately stop new compiles
2301       if (CompileBroker::set_should_compile_new_jobs(CompileBroker::stop_compilation)) {
2302         NMethodSweeper::log_sweep(&quot;disable_compiler&quot;);
2303       }
2304     } else {
2305       disable_compilation_forever();
2306     }
2307 
2308     CodeCache::report_codemem_full(code_blob_type, should_print_compiler_warning());
2309   }
2310 }
2311 
2312 // ------------------------------------------------------------------
2313 // CompileBroker::update_compile_perf_data
2314 //
2315 // Record this compilation for debugging purposes.
2316 void CompileBroker::update_compile_perf_data(CompilerThread* thread, const methodHandle&amp; method, bool is_osr) {
2317   ResourceMark rm;
2318   char* method_name = method-&gt;name()-&gt;as_C_string();
2319   char current_method[CompilerCounters::cmname_buffer_length];
2320   size_t maxLen = CompilerCounters::cmname_buffer_length;
2321 
2322   const char* class_name = method-&gt;method_holder()-&gt;name()-&gt;as_C_string();
2323 
2324   size_t s1len = strlen(class_name);
2325   size_t s2len = strlen(method_name);
2326 
2327   // check if we need to truncate the string
2328   if (s1len + s2len + 2 &gt; maxLen) {
2329 
2330     // the strategy is to lop off the leading characters of the
2331     // class name and the trailing characters of the method name.
2332 
2333     if (s2len + 2 &gt; maxLen) {
2334       // lop of the entire class name string, let snprintf handle
2335       // truncation of the method name.
2336       class_name += s1len; // null string
2337     }
2338     else {
2339       // lop off the extra characters from the front of the class name
2340       class_name += ((s1len + s2len + 2) - maxLen);
2341     }
2342   }
2343 
2344   jio_snprintf(current_method, maxLen, &quot;%s %s&quot;, class_name, method_name);
2345 
2346   int last_compile_type = normal_compile;
2347   if (CICountOSR &amp;&amp; is_osr) {
2348     last_compile_type = osr_compile;
2349   }
2350 
2351   CompilerCounters* counters = thread-&gt;counters();
2352   counters-&gt;set_current_method(current_method);
2353   counters-&gt;set_compile_type((jlong) last_compile_type);
2354 }
2355 
2356 // ------------------------------------------------------------------
2357 // CompileBroker::push_jni_handle_block
2358 //
2359 // Push on a new block of JNI handles.
2360 void CompileBroker::push_jni_handle_block() {
2361   JavaThread* thread = JavaThread::current();
2362 
2363   // Allocate a new block for JNI handles.
2364   // Inlined code from jni_PushLocalFrame()
2365   JNIHandleBlock* java_handles = thread-&gt;active_handles();
2366   JNIHandleBlock* compile_handles = JNIHandleBlock::allocate_block(thread);
2367   assert(compile_handles != NULL &amp;&amp; java_handles != NULL, &quot;should not be NULL&quot;);
2368   compile_handles-&gt;set_pop_frame_link(java_handles);  // make sure java handles get gc&#39;d.
2369   thread-&gt;set_active_handles(compile_handles);
2370 }
2371 
2372 
2373 // ------------------------------------------------------------------
2374 // CompileBroker::pop_jni_handle_block
2375 //
2376 // Pop off the current block of JNI handles.
2377 void CompileBroker::pop_jni_handle_block() {
2378   JavaThread* thread = JavaThread::current();
2379 
2380   // Release our JNI handle block
2381   JNIHandleBlock* compile_handles = thread-&gt;active_handles();
2382   JNIHandleBlock* java_handles = compile_handles-&gt;pop_frame_link();
2383   thread-&gt;set_active_handles(java_handles);
2384   compile_handles-&gt;set_pop_frame_link(NULL);
2385   JNIHandleBlock::release_block(compile_handles, thread); // may block
2386 }
2387 
2388 // ------------------------------------------------------------------
2389 // CompileBroker::collect_statistics
2390 //
2391 // Collect statistics about the compilation.
2392 
2393 void CompileBroker::collect_statistics(CompilerThread* thread, elapsedTimer time, CompileTask* task) {
2394   bool success = task-&gt;is_success();
2395   methodHandle method (thread, task-&gt;method());
2396   uint compile_id = task-&gt;compile_id();
2397   bool is_osr = (task-&gt;osr_bci() != standard_entry_bci);
2398   nmethod* code = task-&gt;code();
2399   CompilerCounters* counters = thread-&gt;counters();
2400 
2401   assert(code == NULL || code-&gt;is_locked_by_vm(), &quot;will survive the MutexLocker&quot;);
2402   MutexLocker locker(CompileStatistics_lock);
2403 
2404   // _perf variables are production performance counters which are
2405   // updated regardless of the setting of the CITime and CITimeEach flags
2406   //
2407 
2408   // account all time, including bailouts and failures in this counter;
2409   // C1 and C2 counters are counting both successful and unsuccessful compiles
2410   _t_total_compilation.add(time);
2411 
2412   if (!success) {
2413     _total_bailout_count++;
2414     if (UsePerfData) {
2415       _perf_last_failed_method-&gt;set_value(counters-&gt;current_method());
2416       _perf_last_failed_type-&gt;set_value(counters-&gt;compile_type());
2417       _perf_total_bailout_count-&gt;inc();
2418     }
2419     _t_bailedout_compilation.add(time);
2420   } else if (code == NULL) {
2421     if (UsePerfData) {
2422       _perf_last_invalidated_method-&gt;set_value(counters-&gt;current_method());
2423       _perf_last_invalidated_type-&gt;set_value(counters-&gt;compile_type());
2424       _perf_total_invalidated_count-&gt;inc();
2425     }
2426     _total_invalidated_count++;
2427     _t_invalidated_compilation.add(time);
2428   } else {
2429     // Compilation succeeded
2430 
2431     // update compilation ticks - used by the implementation of
2432     // java.lang.management.CompilationMBean
2433     _perf_total_compilation-&gt;inc(time.ticks());
2434     _peak_compilation_time = time.milliseconds() &gt; _peak_compilation_time ? time.milliseconds() : _peak_compilation_time;
2435 
2436     if (CITime) {
2437       int bytes_compiled = method-&gt;code_size() + task-&gt;num_inlined_bytecodes();
2438       if (is_osr) {
2439         _t_osr_compilation.add(time);
2440         _sum_osr_bytes_compiled += bytes_compiled;
2441       } else {
2442         _t_standard_compilation.add(time);
2443         _sum_standard_bytes_compiled += method-&gt;code_size() + task-&gt;num_inlined_bytecodes();
2444       }
2445 
2446 #if INCLUDE_JVMCI
2447       AbstractCompiler* comp = compiler(task-&gt;comp_level());
2448       if (comp) {
2449         CompilerStatistics* stats = comp-&gt;stats();
2450         if (stats) {
2451           if (is_osr) {
2452             stats-&gt;_osr.update(time, bytes_compiled);
2453           } else {
2454             stats-&gt;_standard.update(time, bytes_compiled);
2455           }
2456           stats-&gt;_nmethods_size += code-&gt;total_size();
2457           stats-&gt;_nmethods_code_size += code-&gt;insts_size();
2458         } else { // if (!stats)
2459           assert(false, &quot;Compiler statistics object must exist&quot;);
2460         }
2461       } else { // if (!comp)
2462         assert(false, &quot;Compiler object must exist&quot;);
2463       }
2464 #endif // INCLUDE_JVMCI
2465     }
2466 
2467     if (UsePerfData) {
2468       // save the name of the last method compiled
2469       _perf_last_method-&gt;set_value(counters-&gt;current_method());
2470       _perf_last_compile_type-&gt;set_value(counters-&gt;compile_type());
2471       _perf_last_compile_size-&gt;set_value(method-&gt;code_size() +
2472                                          task-&gt;num_inlined_bytecodes());
2473       if (is_osr) {
2474         _perf_osr_compilation-&gt;inc(time.ticks());
2475         _perf_sum_osr_bytes_compiled-&gt;inc(method-&gt;code_size() + task-&gt;num_inlined_bytecodes());
2476       } else {
2477         _perf_standard_compilation-&gt;inc(time.ticks());
2478         _perf_sum_standard_bytes_compiled-&gt;inc(method-&gt;code_size() + task-&gt;num_inlined_bytecodes());
2479       }
2480     }
2481 
2482     if (CITimeEach) {
2483       float bytes_per_sec = 1.0 * (method-&gt;code_size() + task-&gt;num_inlined_bytecodes()) / time.seconds();
2484       tty-&gt;print_cr(&quot;%3d   seconds: %f bytes/sec : %f (bytes %d + %d inlined)&quot;,
2485                     compile_id, time.seconds(), bytes_per_sec, method-&gt;code_size(), task-&gt;num_inlined_bytecodes());
2486     }
2487 
2488     // Collect counts of successful compilations
2489     _sum_nmethod_size      += code-&gt;total_size();
2490     _sum_nmethod_code_size += code-&gt;insts_size();
2491     _total_compile_count++;
2492 
2493     if (UsePerfData) {
2494       _perf_sum_nmethod_size-&gt;inc(     code-&gt;total_size());
2495       _perf_sum_nmethod_code_size-&gt;inc(code-&gt;insts_size());
2496       _perf_total_compile_count-&gt;inc();
2497     }
2498 
2499     if (is_osr) {
2500       if (UsePerfData) _perf_total_osr_compile_count-&gt;inc();
2501       _total_osr_compile_count++;
2502     } else {
2503       if (UsePerfData) _perf_total_standard_compile_count-&gt;inc();
2504       _total_standard_compile_count++;
2505     }
2506   }
2507   // set the current method for the thread to null
2508   if (UsePerfData) counters-&gt;set_current_method(&quot;&quot;);
2509 }
2510 
2511 const char* CompileBroker::compiler_name(int comp_level) {
2512   AbstractCompiler *comp = CompileBroker::compiler(comp_level);
2513   if (comp == NULL) {
2514     return &quot;no compiler&quot;;
2515   } else {
2516     return (comp-&gt;name());
2517   }
2518 }
2519 
2520 #if INCLUDE_JVMCI
2521 void CompileBroker::print_times(AbstractCompiler* comp) {
2522   CompilerStatistics* stats = comp-&gt;stats();
2523   if (stats) {
2524     tty-&gt;print_cr(&quot;  %s {speed: %d bytes/s; standard: %6.3f s, %d bytes, %d methods; osr: %6.3f s, %d bytes, %d methods; nmethods_size: %d bytes; nmethods_code_size: %d bytes}&quot;,
2525                 comp-&gt;name(), stats-&gt;bytes_per_second(),
2526                 stats-&gt;_standard._time.seconds(), stats-&gt;_standard._bytes, stats-&gt;_standard._count,
2527                 stats-&gt;_osr._time.seconds(), stats-&gt;_osr._bytes, stats-&gt;_osr._count,
2528                 stats-&gt;_nmethods_size, stats-&gt;_nmethods_code_size);
2529   } else { // if (!stats)
2530     assert(false, &quot;Compiler statistics object must exist&quot;);
2531   }
2532   comp-&gt;print_timers();
2533 }
2534 #endif // INCLUDE_JVMCI
2535 
2536 void CompileBroker::print_times(bool per_compiler, bool aggregate) {
2537 #if INCLUDE_JVMCI
2538   elapsedTimer standard_compilation;
2539   elapsedTimer total_compilation;
2540   elapsedTimer osr_compilation;
2541 
2542   int standard_bytes_compiled = 0;
2543   int osr_bytes_compiled = 0;
2544 
2545   int standard_compile_count = 0;
2546   int osr_compile_count = 0;
2547   int total_compile_count = 0;
2548 
2549   int nmethods_size = 0;
2550   int nmethods_code_size = 0;
2551   bool printedHeader = false;
2552 
2553   for (unsigned int i = 0; i &lt; sizeof(_compilers) / sizeof(AbstractCompiler*); i++) {
2554     AbstractCompiler* comp = _compilers[i];
2555     if (comp != NULL) {
2556       if (per_compiler &amp;&amp; aggregate &amp;&amp; !printedHeader) {
2557         printedHeader = true;
2558         tty-&gt;cr();
2559         tty-&gt;print_cr(&quot;Individual compiler times (for compiled methods only)&quot;);
2560         tty-&gt;print_cr(&quot;------------------------------------------------&quot;);
2561         tty-&gt;cr();
2562       }
2563       CompilerStatistics* stats = comp-&gt;stats();
2564 
2565       if (stats) {
2566         standard_compilation.add(stats-&gt;_standard._time);
2567         osr_compilation.add(stats-&gt;_osr._time);
2568 
2569         standard_bytes_compiled += stats-&gt;_standard._bytes;
2570         osr_bytes_compiled += stats-&gt;_osr._bytes;
2571 
2572         standard_compile_count += stats-&gt;_standard._count;
2573         osr_compile_count += stats-&gt;_osr._count;
2574 
2575         nmethods_size += stats-&gt;_nmethods_size;
2576         nmethods_code_size += stats-&gt;_nmethods_code_size;
2577       } else { // if (!stats)
2578         assert(false, &quot;Compiler statistics object must exist&quot;);
2579       }
2580 
2581       if (per_compiler) {
2582         print_times(comp);
2583       }
2584     }
2585   }
2586   total_compile_count = osr_compile_count + standard_compile_count;
2587   total_compilation.add(osr_compilation);
2588   total_compilation.add(standard_compilation);
2589 
2590   // In hosted mode, print the JVMCI compiler specific counters manually.
2591   if (!UseJVMCICompiler) {
2592     JVMCICompiler::print_compilation_timers();
2593   }
2594 #else // INCLUDE_JVMCI
2595   elapsedTimer standard_compilation = CompileBroker::_t_standard_compilation;
2596   elapsedTimer osr_compilation = CompileBroker::_t_osr_compilation;
2597   elapsedTimer total_compilation = CompileBroker::_t_total_compilation;
2598 
2599   int standard_bytes_compiled = CompileBroker::_sum_standard_bytes_compiled;
2600   int osr_bytes_compiled = CompileBroker::_sum_osr_bytes_compiled;
2601 
2602   int standard_compile_count = CompileBroker::_total_standard_compile_count;
2603   int osr_compile_count = CompileBroker::_total_osr_compile_count;
2604   int total_compile_count = CompileBroker::_total_compile_count;
2605 
2606   int nmethods_size = CompileBroker::_sum_nmethod_code_size;
2607   int nmethods_code_size = CompileBroker::_sum_nmethod_size;
2608 #endif // INCLUDE_JVMCI
2609 
2610   if (!aggregate) {
2611     return;
2612   }
2613   tty-&gt;cr();
2614   tty-&gt;print_cr(&quot;Accumulated compiler times&quot;);
2615   tty-&gt;print_cr(&quot;----------------------------------------------------------&quot;);
2616                //0000000000111111111122222222223333333333444444444455555555556666666666
2617                //0123456789012345678901234567890123456789012345678901234567890123456789
2618   tty-&gt;print_cr(&quot;  Total compilation time   : %7.3f s&quot;, total_compilation.seconds());
2619   tty-&gt;print_cr(&quot;    Standard compilation   : %7.3f s, Average : %2.3f s&quot;,
2620                 standard_compilation.seconds(),
2621                 standard_compilation.seconds() / standard_compile_count);
2622   tty-&gt;print_cr(&quot;    Bailed out compilation : %7.3f s, Average : %2.3f s&quot;,
2623                 CompileBroker::_t_bailedout_compilation.seconds(),
2624                 CompileBroker::_t_bailedout_compilation.seconds() / CompileBroker::_total_bailout_count);
2625   tty-&gt;print_cr(&quot;    On stack replacement   : %7.3f s, Average : %2.3f s&quot;,
2626                 osr_compilation.seconds(),
2627                 osr_compilation.seconds() / osr_compile_count);
2628   tty-&gt;print_cr(&quot;    Invalidated            : %7.3f s, Average : %2.3f s&quot;,
2629                 CompileBroker::_t_invalidated_compilation.seconds(),
2630                 CompileBroker::_t_invalidated_compilation.seconds() / CompileBroker::_total_invalidated_count);
2631 
2632   AbstractCompiler *comp = compiler(CompLevel_simple);
2633   if (comp != NULL) {
2634     tty-&gt;cr();
2635     comp-&gt;print_timers();
2636   }
2637   comp = compiler(CompLevel_full_optimization);
2638   if (comp != NULL) {
2639     tty-&gt;cr();
2640     comp-&gt;print_timers();
2641   }
2642   tty-&gt;cr();
2643   tty-&gt;print_cr(&quot;  Total compiled methods    : %8d methods&quot;, total_compile_count);
2644   tty-&gt;print_cr(&quot;    Standard compilation    : %8d methods&quot;, standard_compile_count);
2645   tty-&gt;print_cr(&quot;    On stack replacement    : %8d methods&quot;, osr_compile_count);
2646   int tcb = osr_bytes_compiled + standard_bytes_compiled;
2647   tty-&gt;print_cr(&quot;  Total compiled bytecodes  : %8d bytes&quot;, tcb);
2648   tty-&gt;print_cr(&quot;    Standard compilation    : %8d bytes&quot;, standard_bytes_compiled);
2649   tty-&gt;print_cr(&quot;    On stack replacement    : %8d bytes&quot;, osr_bytes_compiled);
2650   double tcs = total_compilation.seconds();
2651   int bps = tcs == 0.0 ? 0 : (int)(tcb / tcs);
2652   tty-&gt;print_cr(&quot;  Average compilation speed : %8d bytes/s&quot;, bps);
2653   tty-&gt;cr();
2654   tty-&gt;print_cr(&quot;  nmethod code size         : %8d bytes&quot;, nmethods_code_size);
2655   tty-&gt;print_cr(&quot;  nmethod total size        : %8d bytes&quot;, nmethods_size);
2656 }
2657 
2658 // Print general/accumulated JIT information.
2659 void CompileBroker::print_info(outputStream *out) {
2660   if (out == NULL) out = tty;
2661   out-&gt;cr();
2662   out-&gt;print_cr(&quot;======================&quot;);
2663   out-&gt;print_cr(&quot;   General JIT info   &quot;);
2664   out-&gt;print_cr(&quot;======================&quot;);
2665   out-&gt;cr();
2666   out-&gt;print_cr(&quot;            JIT is : %7s&quot;,     should_compile_new_jobs() ? &quot;on&quot; : &quot;off&quot;);
2667   out-&gt;print_cr(&quot;  Compiler threads : %7d&quot;,     (int)CICompilerCount);
2668   out-&gt;cr();
2669   out-&gt;print_cr(&quot;CodeCache overview&quot;);
2670   out-&gt;print_cr(&quot;--------------------------------------------------------&quot;);
2671   out-&gt;cr();
2672   out-&gt;print_cr(&quot;         Reserved size : &quot; SIZE_FORMAT_W(7) &quot; KB&quot;, CodeCache::max_capacity() / K);
2673   out-&gt;print_cr(&quot;        Committed size : &quot; SIZE_FORMAT_W(7) &quot; KB&quot;, CodeCache::capacity() / K);
2674   out-&gt;print_cr(&quot;  Unallocated capacity : &quot; SIZE_FORMAT_W(7) &quot; KB&quot;, CodeCache::unallocated_capacity() / K);
2675   out-&gt;cr();
2676 
2677   out-&gt;cr();
2678   out-&gt;print_cr(&quot;CodeCache cleaning overview&quot;);
2679   out-&gt;print_cr(&quot;--------------------------------------------------------&quot;);
2680   out-&gt;cr();
2681   NMethodSweeper::print(out);
2682   out-&gt;print_cr(&quot;--------------------------------------------------------&quot;);
2683   out-&gt;cr();
2684 }
2685 
2686 // Note: tty_lock must not be held upon entry to this function.
2687 //       Print functions called from herein do &quot;micro-locking&quot; on tty_lock.
2688 //       That&#39;s a tradeoff which keeps together important blocks of output.
2689 //       At the same time, continuous tty_lock hold time is kept in check,
2690 //       preventing concurrently printing threads from stalling a long time.
2691 void CompileBroker::print_heapinfo(outputStream* out, const char* function, size_t granularity) {
2692   TimeStamp ts_total;
2693   TimeStamp ts_global;
2694   TimeStamp ts;
2695 
2696   bool allFun = !strcmp(function, &quot;all&quot;);
2697   bool aggregate = !strcmp(function, &quot;aggregate&quot;) || !strcmp(function, &quot;analyze&quot;) || allFun;
2698   bool usedSpace = !strcmp(function, &quot;UsedSpace&quot;) || allFun;
2699   bool freeSpace = !strcmp(function, &quot;FreeSpace&quot;) || allFun;
2700   bool methodCount = !strcmp(function, &quot;MethodCount&quot;) || allFun;
2701   bool methodSpace = !strcmp(function, &quot;MethodSpace&quot;) || allFun;
2702   bool methodAge = !strcmp(function, &quot;MethodAge&quot;) || allFun;
2703   bool methodNames = !strcmp(function, &quot;MethodNames&quot;) || allFun;
2704   bool discard = !strcmp(function, &quot;discard&quot;) || allFun;
2705 
2706   if (out == NULL) {
2707     out = tty;
2708   }
2709 
2710   if (!(aggregate || usedSpace || freeSpace || methodCount || methodSpace || methodAge || methodNames || discard)) {
2711     out-&gt;print_cr(&quot;\n__ CodeHeapStateAnalytics: Function %s is not supported&quot;, function);
2712     out-&gt;cr();
2713     return;
2714   }
2715 
2716   ts_total.update(); // record starting point
2717 
2718   if (aggregate) {
2719     print_info(out);
2720   }
2721 
2722   // We hold the CodeHeapStateAnalytics_lock all the time, from here until we leave this function.
2723   // That prevents another thread from destroying our view on the CodeHeap.
2724   // When we request individual parts of the analysis via the jcmd interface, it is possible
2725   // that in between another thread (another jcmd user or the vm running into CodeCache OOM)
2726   // updated the aggregated data. That&#39;s a tolerable tradeoff because we can&#39;t hold a lock
2727   // across user interaction.
2728   // Acquire this lock before acquiring the CodeCache_lock.
2729   // CodeHeapStateAnalytics_lock could be held by a concurrent thread for a long time,
2730   // leading to an unnecessarily long hold time of the CodeCache_lock.
2731   ts.update(); // record starting point
2732   MutexLocker mu1(CodeHeapStateAnalytics_lock, Mutex::_no_safepoint_check_flag);
2733   out-&gt;print_cr(&quot;\n__ CodeHeapStateAnalytics lock wait took %10.3f seconds _________\n&quot;, ts.seconds());
2734 
2735   // If we serve an &quot;allFun&quot; call, it is beneficial to hold the CodeCache_lock
2736   // for the entire duration of aggregation and printing. That makes sure
2737   // we see a consistent picture and do not run into issues caused by
2738   // the CodeHeap being altered concurrently.
2739   Mutex* global_lock   = allFun ? CodeCache_lock : NULL;
2740   Mutex* function_lock = allFun ? NULL : CodeCache_lock;
2741   ts_global.update(); // record starting point
2742   MutexLocker mu2(global_lock, Mutex::_no_safepoint_check_flag);
2743   if (global_lock != NULL) {
2744     out-&gt;print_cr(&quot;\n__ CodeCache (global) lock wait took %10.3f seconds _________\n&quot;, ts_global.seconds());
2745     ts_global.update(); // record starting point
2746   }
2747 
2748   if (aggregate) {
2749     ts.update(); // record starting point
2750     MutexLocker mu3(function_lock, Mutex::_no_safepoint_check_flag);
2751     if (function_lock != NULL) {
2752       out-&gt;print_cr(&quot;\n__ CodeCache (function) lock wait took %10.3f seconds _________\n&quot;, ts.seconds());
2753     }
2754 
2755     ts.update(); // record starting point
2756     CodeCache::aggregate(out, granularity);
2757     if (function_lock != NULL) {
2758       out-&gt;print_cr(&quot;\n__ CodeCache (function) lock hold took %10.3f seconds _________\n&quot;, ts.seconds());
2759     }
2760   }
2761 
2762   if (usedSpace) CodeCache::print_usedSpace(out);
2763   if (freeSpace) CodeCache::print_freeSpace(out);
2764   if (methodCount) CodeCache::print_count(out);
2765   if (methodSpace) CodeCache::print_space(out);
2766   if (methodAge) CodeCache::print_age(out);
2767   if (methodNames) {
2768     // print_names() has shown to be sensitive to concurrent CodeHeap modifications.
2769     // Therefore, request  the CodeCache_lock before calling...
2770     MutexLocker mu3(function_lock, Mutex::_no_safepoint_check_flag);
2771     CodeCache::print_names(out);
2772   }
2773   if (discard) CodeCache::discard(out);
2774 
2775   if (global_lock != NULL) {
2776     out-&gt;print_cr(&quot;\n__ CodeCache (global) lock hold took %10.3f seconds _________\n&quot;, ts_global.seconds());
2777   }
2778   out-&gt;print_cr(&quot;\n__ CodeHeapStateAnalytics total duration %10.3f seconds _________\n&quot;, ts_total.seconds());
2779 }
<a name="3" id="anc3"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="3" type="hidden" />
</body>
</html>