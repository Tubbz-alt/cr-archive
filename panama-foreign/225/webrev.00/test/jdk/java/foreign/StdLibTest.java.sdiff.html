<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff test/jdk/java/foreign/StdLibTest.java</title>
    <link rel="stylesheet" href="../../../../style.css" />
  </head>
<body>
<center><a href="../../../../src/jdk.incubator.foreign/share/classes/jdk/internal/foreign/abi/SharedUtils.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> next &gt;</center>    <h2>test/jdk/java/foreign/StdLibTest.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 /*
 25  * @test
 26   * @modules jdk.incubator.foreign/jdk.incubator.foreign.unsafe
 27  *          jdk.incubator.foreign/jdk.internal.foreign
 28  *          jdk.incubator.foreign/jdk.internal.foreign.abi
 29  *          java.base/sun.security.action
 30  * @build NativeTestHelper StdLibTest
 31  * @run testng/othervm -Dforeign.restricted=permit StdLibTest
 32  */
 33 
 34 import java.lang.invoke.MethodHandle;
 35 import java.lang.invoke.MethodHandles;
 36 import java.lang.invoke.MethodType;
<span class="line-removed"> 37 import java.lang.invoke.VarHandle;</span>
<span class="line-removed"> 38 import java.nio.ByteOrder;</span>
 39 import java.time.Instant;
 40 import java.time.LocalDateTime;
 41 import java.time.ZoneOffset;
 42 import java.time.ZonedDateTime;
 43 import java.util.ArrayList;
 44 import java.util.Arrays;
 45 import java.util.Collections;
 46 import java.util.LinkedHashSet;
 47 import java.util.List;
 48 import java.util.Set;
 49 import java.util.function.Consumer;
 50 import java.util.stream.Collectors;
<span class="line-removed"> 51 import java.util.stream.IntStream;</span>
<span class="line-removed"> 52 import java.util.stream.LongStream;</span>
 53 import java.util.stream.Stream;
 54 
 55 import jdk.incubator.foreign.CSupport;
 56 import jdk.incubator.foreign.ForeignLinker;
 57 import jdk.incubator.foreign.FunctionDescriptor;
 58 import jdk.incubator.foreign.LibraryLookup;
 59 import jdk.incubator.foreign.MemoryAddress;
<span class="line-removed"> 60 import jdk.incubator.foreign.MemoryHandles;</span>
 61 import jdk.incubator.foreign.MemoryLayout;
 62 import jdk.incubator.foreign.MemorySegment;

 63 import jdk.incubator.foreign.SequenceLayout;



 64 import org.testng.annotations.*;
 65 
 66 import static jdk.incubator.foreign.CSupport.*;
 67 import static org.testng.Assert.*;
 68 
 69 @Test
 70 public class StdLibTest extends NativeTestHelper {
 71 
 72     final static ForeignLinker abi = CSupport.getSystemLinker();
 73 
<span class="line-removed"> 74     final static VarHandle byteHandle = MemoryHandles.varHandle(byte.class, ByteOrder.nativeOrder());</span>
<span class="line-removed"> 75     final static VarHandle intHandle = MemoryHandles.varHandle(int.class, ByteOrder.nativeOrder());</span>
<span class="line-removed"> 76     final static VarHandle longHandle = MemoryHandles.varHandle(long.class, ByteOrder.nativeOrder());</span>
<span class="line-removed"> 77     final static VarHandle byteArrHandle = arrayHandle(C_CHAR, byte.class);</span>
<span class="line-removed"> 78     final static VarHandle intArrHandle = arrayHandle(C_INT, int.class);</span>
<span class="line-removed"> 79 </span>
<span class="line-removed"> 80     static VarHandle arrayHandle(MemoryLayout elemLayout, Class&lt;?&gt; elemCarrier) {</span>
<span class="line-removed"> 81         return MemoryLayout.ofSequence(1, elemLayout)</span>
<span class="line-removed"> 82                 .varHandle(elemCarrier, MemoryLayout.PathElement.sequenceElement());</span>
<span class="line-removed"> 83     }</span>
<span class="line-removed"> 84 </span>
 85     private StdLibHelper stdLibHelper = new StdLibHelper();
 86 
 87     @Test(dataProvider = &quot;stringPairs&quot;)
 88     void test_strcat(String s1, String s2) throws Throwable {
 89         assertEquals(stdLibHelper.strcat(s1, s2), s1 + s2);
 90     }
 91 
 92     @Test(dataProvider = &quot;stringPairs&quot;)
 93     void test_strcmp(String s1, String s2) throws Throwable {
 94         assertEquals(Math.signum(stdLibHelper.strcmp(s1, s2)), Math.signum(s1.compareTo(s2)));
 95     }
 96 
 97     @Test(dataProvider = &quot;strings&quot;)
 98     void test_puts(String s) throws Throwable {
 99         assertTrue(stdLibHelper.puts(s) &gt;= 0);
100     }
101 
102     @Test(dataProvider = &quot;strings&quot;)
103     void test_strlen(String s) throws Throwable {
104         assertEquals(stdLibHelper.strlen(s), s.length());
</pre>
<hr />
<pre>
228                         MethodType.methodType(int.class),
229                         FunctionDescriptor.of(C_INT));
230 
231                 vprintf = abi.downcallHandle(lookup.lookup(&quot;vprintf&quot;),
232                         MethodType.methodType(int.class, MemoryAddress.class, VaList.class),
233                         FunctionDescriptor.of(C_INT, C_POINTER, C_VA_LIST));
234 
235                 printfAddr = lookup.lookup(&quot;printf&quot;);
236 
237                 printfBase = FunctionDescriptor.of(C_INT, C_POINTER);
238             } catch (Throwable ex) {
239                 throw new IllegalStateException(ex);
240             }
241         }
242 
243         String strcat(String s1, String s2) throws Throwable {
244             try (MemorySegment buf = MemorySegment.allocateNative(s1.length() + s2.length() + 1) ;
245                  MemorySegment other = toCString(s2)) {
246                 char[] chars = s1.toCharArray();
247                 for (long i = 0 ; i &lt; chars.length ; i++) {
<span class="line-modified">248                     byteArrHandle.set(buf.baseAddress(), i, (byte)chars[(int)i]);</span>
249                 }
<span class="line-modified">250                 byteArrHandle.set(buf.baseAddress(), (long)chars.length, (byte)&#39;\0&#39;);</span>
251                 return toJavaStringRestricted(((MemoryAddress)strcat.invokeExact(buf.baseAddress(), other.baseAddress())));
252             }
253         }
254 
255         int strcmp(String s1, String s2) throws Throwable {
256             try (MemorySegment ns1 = toCString(s1) ;
257                  MemorySegment ns2 = toCString(s2)) {
258                 return (int)strcmp.invokeExact(ns1.baseAddress(), ns2.baseAddress());
259             }
260         }
261 
262         int puts(String msg) throws Throwable {
263             try (MemorySegment s = toCString(msg)) {
264                 return (int)puts.invokeExact(s.baseAddress());
265             }
266         }
267 
268         int strlen(String msg) throws Throwable {
269             try (MemorySegment s = toCString(msg)) {
270                 return (int)strlen.invokeExact(s.baseAddress());
271             }
272         }
273 
274         Tm gmtime(long arg) throws Throwable {
275             try (MemorySegment time = MemorySegment.allocateNative(8)) {
<span class="line-modified">276                 longHandle.set(time.baseAddress(), arg);</span>
277                 return new Tm((MemoryAddress)gmtime.invokeExact(time.baseAddress()));
278             }
279         }
280 
281         static class Tm {
282 
283             //Tm pointer should never be freed directly, as it points to shared memory
284             private final MemoryAddress base;
285 
286             static final long SIZE = 56;
287 
288             Tm(MemoryAddress base) {
289                 this.base = MemorySegment.ofNativeRestricted(base, SIZE, Thread.currentThread(),
290                         null, null).baseAddress();
291             }
292 
293             int sec() {
<span class="line-modified">294                 return (int)intHandle.get(base);</span>
295             }
296             int min() {
<span class="line-modified">297                 return (int)intHandle.get(base.addOffset(4));</span>
298             }
299             int hour() {
<span class="line-modified">300                 return (int)intHandle.get(base.addOffset(8));</span>
301             }
302             int mday() {
<span class="line-modified">303                 return (int)intHandle.get(base.addOffset(12));</span>
304             }
305             int mon() {
<span class="line-modified">306                 return (int)intHandle.get(base.addOffset(16));</span>
307             }
308             int year() {
<span class="line-modified">309                 return (int)intHandle.get(base.addOffset(20));</span>
310             }
311             int wday() {
<span class="line-modified">312                 return (int)intHandle.get(base.addOffset(24));</span>
313             }
314             int yday() {
<span class="line-modified">315                 return (int)intHandle.get(base.addOffset(28));</span>
316             }
317             boolean isdst() {
<span class="line-modified">318                 byte b = (byte)byteHandle.get(base.addOffset(32));</span>
319                 return b != 0;
320             }
321         }
322 
323         int[] qsort(int[] arr) throws Throwable {
324             //init native array
<span class="line-modified">325             SequenceLayout seq = MemoryLayout.ofSequence(arr.length, C_INT);</span>
<span class="line-removed">326 </span>
<span class="line-removed">327             try (MemorySegment nativeArr = MemorySegment.allocateNative(seq)) {</span>
328 
<span class="line-modified">329                 IntStream.range(0, arr.length)</span>
<span class="line-removed">330                         .forEach(i -&gt; intArrHandle.set(nativeArr.baseAddress(), i, arr[i]));</span>
331 
332                 //call qsort
<span class="line-modified">333                 try (MemorySegment qsortUpcallStub = abi.upcallStub(qsortCompar.bindTo(nativeArr), qsortComparFunction)) {</span>
<span class="line-modified">334                     qsort.invokeExact(nativeArr.baseAddress(), seq.elementCount().getAsLong(), C_INT.byteSize(), qsortUpcallStub.baseAddress());</span>
<span class="line-modified">335                 }</span>

336 
337                 //convert back to Java array
<span class="line-modified">338                 return LongStream.range(0, arr.length)</span>
<span class="line-removed">339                         .mapToInt(i -&gt; (int)intArrHandle.get(nativeArr.baseAddress(), i))</span>
<span class="line-removed">340                         .toArray();</span>
341             }
342         }
343 
344         static int qsortCompare(MemorySegment base, MemoryAddress addr1, MemoryAddress addr2) {
<span class="line-modified">345             return (int)intHandle.get(addr1.rebase(base)) - (int)intHandle.get(addr2.rebase(base));</span>

346         }
347 
348         int rand() throws Throwable {
349             return (int)rand.invokeExact();
350         }
351 
352         int printf(String format, List&lt;PrintfArg&gt; args) throws Throwable {
353             try (MemorySegment formatStr = toCString(format)) {
354                 return (int)specializedPrintf(args).invokeExact(formatStr.baseAddress(),
355                         args.stream().map(a -&gt; a.nativeValue).toArray());
356             }
357         }
358 
359         int vprintf(String format, List&lt;PrintfArg&gt; args) throws Throwable {
360             try (MemorySegment formatStr = toCString(format)) {
361                 VaList vaList = VaList.make(b -&gt; args.forEach(a -&gt; a.accept(b)));
362                 int result = (int)vprintf.invokeExact(formatStr.baseAddress(), vaList);
363                 try {
364                     vaList.close();
365                 }
</pre>
</td>
<td>
<hr />
<pre>
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 /*
 25  * @test
 26   * @modules jdk.incubator.foreign/jdk.incubator.foreign.unsafe
 27  *          jdk.incubator.foreign/jdk.internal.foreign
 28  *          jdk.incubator.foreign/jdk.internal.foreign.abi
 29  *          java.base/sun.security.action
 30  * @build NativeTestHelper StdLibTest
 31  * @run testng/othervm -Dforeign.restricted=permit StdLibTest
 32  */
 33 
 34 import java.lang.invoke.MethodHandle;
 35 import java.lang.invoke.MethodHandles;
 36 import java.lang.invoke.MethodType;


 37 import java.time.Instant;
 38 import java.time.LocalDateTime;
 39 import java.time.ZoneOffset;
 40 import java.time.ZonedDateTime;
 41 import java.util.ArrayList;
 42 import java.util.Arrays;
 43 import java.util.Collections;
 44 import java.util.LinkedHashSet;
 45 import java.util.List;
 46 import java.util.Set;
 47 import java.util.function.Consumer;
 48 import java.util.stream.Collectors;


 49 import java.util.stream.Stream;
 50 
 51 import jdk.incubator.foreign.CSupport;
 52 import jdk.incubator.foreign.ForeignLinker;
 53 import jdk.incubator.foreign.FunctionDescriptor;
 54 import jdk.incubator.foreign.LibraryLookup;
 55 import jdk.incubator.foreign.MemoryAddress;

 56 import jdk.incubator.foreign.MemoryLayout;
 57 import jdk.incubator.foreign.MemorySegment;
<span class="line-added"> 58 import jdk.incubator.foreign.NativeScope;</span>
 59 import jdk.incubator.foreign.SequenceLayout;
<span class="line-added"> 60 </span>
<span class="line-added"> 61 import static jdk.incubator.foreign.MemoryAccess.*;</span>
<span class="line-added"> 62 </span>
 63 import org.testng.annotations.*;
 64 
 65 import static jdk.incubator.foreign.CSupport.*;
 66 import static org.testng.Assert.*;
 67 
 68 @Test
 69 public class StdLibTest extends NativeTestHelper {
 70 
 71     final static ForeignLinker abi = CSupport.getSystemLinker();
 72 











 73     private StdLibHelper stdLibHelper = new StdLibHelper();
 74 
 75     @Test(dataProvider = &quot;stringPairs&quot;)
 76     void test_strcat(String s1, String s2) throws Throwable {
 77         assertEquals(stdLibHelper.strcat(s1, s2), s1 + s2);
 78     }
 79 
 80     @Test(dataProvider = &quot;stringPairs&quot;)
 81     void test_strcmp(String s1, String s2) throws Throwable {
 82         assertEquals(Math.signum(stdLibHelper.strcmp(s1, s2)), Math.signum(s1.compareTo(s2)));
 83     }
 84 
 85     @Test(dataProvider = &quot;strings&quot;)
 86     void test_puts(String s) throws Throwable {
 87         assertTrue(stdLibHelper.puts(s) &gt;= 0);
 88     }
 89 
 90     @Test(dataProvider = &quot;strings&quot;)
 91     void test_strlen(String s) throws Throwable {
 92         assertEquals(stdLibHelper.strlen(s), s.length());
</pre>
<hr />
<pre>
216                         MethodType.methodType(int.class),
217                         FunctionDescriptor.of(C_INT));
218 
219                 vprintf = abi.downcallHandle(lookup.lookup(&quot;vprintf&quot;),
220                         MethodType.methodType(int.class, MemoryAddress.class, VaList.class),
221                         FunctionDescriptor.of(C_INT, C_POINTER, C_VA_LIST));
222 
223                 printfAddr = lookup.lookup(&quot;printf&quot;);
224 
225                 printfBase = FunctionDescriptor.of(C_INT, C_POINTER);
226             } catch (Throwable ex) {
227                 throw new IllegalStateException(ex);
228             }
229         }
230 
231         String strcat(String s1, String s2) throws Throwable {
232             try (MemorySegment buf = MemorySegment.allocateNative(s1.length() + s2.length() + 1) ;
233                  MemorySegment other = toCString(s2)) {
234                 char[] chars = s1.toCharArray();
235                 for (long i = 0 ; i &lt; chars.length ; i++) {
<span class="line-modified">236                     setByte(buf.baseAddress(), i, (byte)chars[(int)i]);</span>
237                 }
<span class="line-modified">238                 setByte(buf.baseAddress(), chars.length, (byte)&#39;\0&#39;);</span>
239                 return toJavaStringRestricted(((MemoryAddress)strcat.invokeExact(buf.baseAddress(), other.baseAddress())));
240             }
241         }
242 
243         int strcmp(String s1, String s2) throws Throwable {
244             try (MemorySegment ns1 = toCString(s1) ;
245                  MemorySegment ns2 = toCString(s2)) {
246                 return (int)strcmp.invokeExact(ns1.baseAddress(), ns2.baseAddress());
247             }
248         }
249 
250         int puts(String msg) throws Throwable {
251             try (MemorySegment s = toCString(msg)) {
252                 return (int)puts.invokeExact(s.baseAddress());
253             }
254         }
255 
256         int strlen(String msg) throws Throwable {
257             try (MemorySegment s = toCString(msg)) {
258                 return (int)strlen.invokeExact(s.baseAddress());
259             }
260         }
261 
262         Tm gmtime(long arg) throws Throwable {
263             try (MemorySegment time = MemorySegment.allocateNative(8)) {
<span class="line-modified">264                 setLong(time.baseAddress(), 0, arg);</span>
265                 return new Tm((MemoryAddress)gmtime.invokeExact(time.baseAddress()));
266             }
267         }
268 
269         static class Tm {
270 
271             //Tm pointer should never be freed directly, as it points to shared memory
272             private final MemoryAddress base;
273 
274             static final long SIZE = 56;
275 
276             Tm(MemoryAddress base) {
277                 this.base = MemorySegment.ofNativeRestricted(base, SIZE, Thread.currentThread(),
278                         null, null).baseAddress();
279             }
280 
281             int sec() {
<span class="line-modified">282                 return getInt(base, 0);</span>
283             }
284             int min() {
<span class="line-modified">285                 return getInt(base, 4);</span>
286             }
287             int hour() {
<span class="line-modified">288                 return getInt(base, 8);</span>
289             }
290             int mday() {
<span class="line-modified">291                 return getInt(base, 12);</span>
292             }
293             int mon() {
<span class="line-modified">294                 return getInt(base, 16);</span>
295             }
296             int year() {
<span class="line-modified">297                 return getInt(base, 20);</span>
298             }
299             int wday() {
<span class="line-modified">300                 return getInt(base, 24);</span>
301             }
302             int yday() {
<span class="line-modified">303                 return getInt(base, 28);</span>
304             }
305             boolean isdst() {
<span class="line-modified">306                 byte b = getByte(base, 32);</span>
307                 return b != 0;
308             }
309         }
310 
311         int[] qsort(int[] arr) throws Throwable {
312             //init native array
<span class="line-modified">313             try (NativeScope scope = NativeScope.unboundedScope()) {</span>


314 
<span class="line-modified">315                 MemorySegment nativeArr = scope.allocateArray(C_INT, arr).segment();</span>

316 
317                 //call qsort
<span class="line-modified">318                 MemorySegment qsortUpcallStub = abi.upcallStub(qsortCompar.bindTo(nativeArr), qsortComparFunction);</span>
<span class="line-modified">319                 scope.register(qsortUpcallStub);</span>
<span class="line-modified">320 </span>
<span class="line-added">321                 qsort.invokeExact(nativeArr.baseAddress(), (long)arr.length, C_INT.byteSize(), qsortUpcallStub.baseAddress());</span>
322 
323                 //convert back to Java array
<span class="line-modified">324                 return nativeArr.toIntArray();</span>


325             }
326         }
327 
328         static int qsortCompare(MemorySegment base, MemoryAddress addr1, MemoryAddress addr2) {
<span class="line-modified">329             return getInt(base.baseAddress(), addr1.rebase(base).segmentOffset()) -</span>
<span class="line-added">330                    getInt(base.baseAddress(), addr2.rebase(base).segmentOffset());</span>
331         }
332 
333         int rand() throws Throwable {
334             return (int)rand.invokeExact();
335         }
336 
337         int printf(String format, List&lt;PrintfArg&gt; args) throws Throwable {
338             try (MemorySegment formatStr = toCString(format)) {
339                 return (int)specializedPrintf(args).invokeExact(formatStr.baseAddress(),
340                         args.stream().map(a -&gt; a.nativeValue).toArray());
341             }
342         }
343 
344         int vprintf(String format, List&lt;PrintfArg&gt; args) throws Throwable {
345             try (MemorySegment formatStr = toCString(format)) {
346                 VaList vaList = VaList.make(b -&gt; args.forEach(a -&gt; a.accept(b)));
347                 int result = (int)vprintf.invokeExact(formatStr.baseAddress(), vaList);
348                 try {
349                     vaList.close();
350                 }
</pre>
</td>
</tr>
</table>
<center><a href="../../../../src/jdk.incubator.foreign/share/classes/jdk/internal/foreign/abi/SharedUtils.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> next &gt;</center>  </body>
</html>