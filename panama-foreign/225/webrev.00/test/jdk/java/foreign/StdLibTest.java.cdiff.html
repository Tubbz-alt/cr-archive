<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff test/jdk/java/foreign/StdLibTest.java</title>
    <link rel="stylesheet" href="../../../../style.css" />
  </head>
<body>
<center><a href="../../../../src/jdk.incubator.foreign/share/classes/jdk/internal/foreign/abi/SharedUtils.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> next &gt;</center>    <h2>test/jdk/java/foreign/StdLibTest.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 32,12 ***</span>
   */
  
  import java.lang.invoke.MethodHandle;
  import java.lang.invoke.MethodHandles;
  import java.lang.invoke.MethodType;
<span class="line-removed">- import java.lang.invoke.VarHandle;</span>
<span class="line-removed">- import java.nio.ByteOrder;</span>
  import java.time.Instant;
  import java.time.LocalDateTime;
  import java.time.ZoneOffset;
  import java.time.ZonedDateTime;
  import java.util.ArrayList;
<span class="line-new-header">--- 32,10 ---</span>
</pre>
<hr />
<pre>
<span class="line-old-header">*** 46,44 ***</span>
  import java.util.LinkedHashSet;
  import java.util.List;
  import java.util.Set;
  import java.util.function.Consumer;
  import java.util.stream.Collectors;
<span class="line-removed">- import java.util.stream.IntStream;</span>
<span class="line-removed">- import java.util.stream.LongStream;</span>
  import java.util.stream.Stream;
  
  import jdk.incubator.foreign.CSupport;
  import jdk.incubator.foreign.ForeignLinker;
  import jdk.incubator.foreign.FunctionDescriptor;
  import jdk.incubator.foreign.LibraryLookup;
  import jdk.incubator.foreign.MemoryAddress;
<span class="line-removed">- import jdk.incubator.foreign.MemoryHandles;</span>
  import jdk.incubator.foreign.MemoryLayout;
  import jdk.incubator.foreign.MemorySegment;
  import jdk.incubator.foreign.SequenceLayout;
  import org.testng.annotations.*;
  
  import static jdk.incubator.foreign.CSupport.*;
  import static org.testng.Assert.*;
  
  @Test
  public class StdLibTest extends NativeTestHelper {
  
      final static ForeignLinker abi = CSupport.getSystemLinker();
  
<span class="line-removed">-     final static VarHandle byteHandle = MemoryHandles.varHandle(byte.class, ByteOrder.nativeOrder());</span>
<span class="line-removed">-     final static VarHandle intHandle = MemoryHandles.varHandle(int.class, ByteOrder.nativeOrder());</span>
<span class="line-removed">-     final static VarHandle longHandle = MemoryHandles.varHandle(long.class, ByteOrder.nativeOrder());</span>
<span class="line-removed">-     final static VarHandle byteArrHandle = arrayHandle(C_CHAR, byte.class);</span>
<span class="line-removed">-     final static VarHandle intArrHandle = arrayHandle(C_INT, int.class);</span>
<span class="line-removed">- </span>
<span class="line-removed">-     static VarHandle arrayHandle(MemoryLayout elemLayout, Class&lt;?&gt; elemCarrier) {</span>
<span class="line-removed">-         return MemoryLayout.ofSequence(1, elemLayout)</span>
<span class="line-removed">-                 .varHandle(elemCarrier, MemoryLayout.PathElement.sequenceElement());</span>
<span class="line-removed">-     }</span>
<span class="line-removed">- </span>
      private StdLibHelper stdLibHelper = new StdLibHelper();
  
      @Test(dataProvider = &quot;stringPairs&quot;)
      void test_strcat(String s1, String s2) throws Throwable {
          assertEquals(stdLibHelper.strcat(s1, s2), s1 + s2);
<span class="line-new-header">--- 44,34 ---</span>
  import java.util.LinkedHashSet;
  import java.util.List;
  import java.util.Set;
  import java.util.function.Consumer;
  import java.util.stream.Collectors;
  import java.util.stream.Stream;
  
  import jdk.incubator.foreign.CSupport;
  import jdk.incubator.foreign.ForeignLinker;
  import jdk.incubator.foreign.FunctionDescriptor;
  import jdk.incubator.foreign.LibraryLookup;
  import jdk.incubator.foreign.MemoryAddress;
  import jdk.incubator.foreign.MemoryLayout;
  import jdk.incubator.foreign.MemorySegment;
<span class="line-added">+ import jdk.incubator.foreign.NativeScope;</span>
  import jdk.incubator.foreign.SequenceLayout;
<span class="line-added">+ </span>
<span class="line-added">+ import static jdk.incubator.foreign.MemoryAccess.*;</span>
<span class="line-added">+ </span>
  import org.testng.annotations.*;
  
  import static jdk.incubator.foreign.CSupport.*;
  import static org.testng.Assert.*;
  
  @Test
  public class StdLibTest extends NativeTestHelper {
  
      final static ForeignLinker abi = CSupport.getSystemLinker();
  
      private StdLibHelper stdLibHelper = new StdLibHelper();
  
      @Test(dataProvider = &quot;stringPairs&quot;)
      void test_strcat(String s1, String s2) throws Throwable {
          assertEquals(stdLibHelper.strcat(s1, s2), s1 + s2);
</pre>
<hr />
<pre>
<span class="line-old-header">*** 243,13 ***</span>
          String strcat(String s1, String s2) throws Throwable {
              try (MemorySegment buf = MemorySegment.allocateNative(s1.length() + s2.length() + 1) ;
                   MemorySegment other = toCString(s2)) {
                  char[] chars = s1.toCharArray();
                  for (long i = 0 ; i &lt; chars.length ; i++) {
<span class="line-modified">!                     byteArrHandle.set(buf.baseAddress(), i, (byte)chars[(int)i]);</span>
                  }
<span class="line-modified">!                 byteArrHandle.set(buf.baseAddress(), (long)chars.length, (byte)&#39;\0&#39;);</span>
                  return toJavaStringRestricted(((MemoryAddress)strcat.invokeExact(buf.baseAddress(), other.baseAddress())));
              }
          }
  
          int strcmp(String s1, String s2) throws Throwable {
<span class="line-new-header">--- 231,13 ---</span>
          String strcat(String s1, String s2) throws Throwable {
              try (MemorySegment buf = MemorySegment.allocateNative(s1.length() + s2.length() + 1) ;
                   MemorySegment other = toCString(s2)) {
                  char[] chars = s1.toCharArray();
                  for (long i = 0 ; i &lt; chars.length ; i++) {
<span class="line-modified">!                     setByte(buf.baseAddress(), i, (byte)chars[(int)i]);</span>
                  }
<span class="line-modified">!                 setByte(buf.baseAddress(), chars.length, (byte)&#39;\0&#39;);</span>
                  return toJavaStringRestricted(((MemoryAddress)strcat.invokeExact(buf.baseAddress(), other.baseAddress())));
              }
          }
  
          int strcmp(String s1, String s2) throws Throwable {
</pre>
<hr />
<pre>
<span class="line-old-header">*** 271,11 ***</span>
              }
          }
  
          Tm gmtime(long arg) throws Throwable {
              try (MemorySegment time = MemorySegment.allocateNative(8)) {
<span class="line-modified">!                 longHandle.set(time.baseAddress(), arg);</span>
                  return new Tm((MemoryAddress)gmtime.invokeExact(time.baseAddress()));
              }
          }
  
          static class Tm {
<span class="line-new-header">--- 259,11 ---</span>
              }
          }
  
          Tm gmtime(long arg) throws Throwable {
              try (MemorySegment time = MemorySegment.allocateNative(8)) {
<span class="line-modified">!                 setLong(time.baseAddress(), 0, arg);</span>
                  return new Tm((MemoryAddress)gmtime.invokeExact(time.baseAddress()));
              }
          }
  
          static class Tm {
</pre>
<hr />
<pre>
<span class="line-old-header">*** 289,62 ***</span>
                  this.base = MemorySegment.ofNativeRestricted(base, SIZE, Thread.currentThread(),
                          null, null).baseAddress();
              }
  
              int sec() {
<span class="line-modified">!                 return (int)intHandle.get(base);</span>
              }
              int min() {
<span class="line-modified">!                 return (int)intHandle.get(base.addOffset(4));</span>
              }
              int hour() {
<span class="line-modified">!                 return (int)intHandle.get(base.addOffset(8));</span>
              }
              int mday() {
<span class="line-modified">!                 return (int)intHandle.get(base.addOffset(12));</span>
              }
              int mon() {
<span class="line-modified">!                 return (int)intHandle.get(base.addOffset(16));</span>
              }
              int year() {
<span class="line-modified">!                 return (int)intHandle.get(base.addOffset(20));</span>
              }
              int wday() {
<span class="line-modified">!                 return (int)intHandle.get(base.addOffset(24));</span>
              }
              int yday() {
<span class="line-modified">!                 return (int)intHandle.get(base.addOffset(28));</span>
              }
              boolean isdst() {
<span class="line-modified">!                 byte b = (byte)byteHandle.get(base.addOffset(32));</span>
                  return b != 0;
              }
          }
  
          int[] qsort(int[] arr) throws Throwable {
              //init native array
<span class="line-modified">!             SequenceLayout seq = MemoryLayout.ofSequence(arr.length, C_INT);</span>
<span class="line-removed">- </span>
<span class="line-removed">-             try (MemorySegment nativeArr = MemorySegment.allocateNative(seq)) {</span>
  
<span class="line-modified">!                 IntStream.range(0, arr.length)</span>
<span class="line-removed">-                         .forEach(i -&gt; intArrHandle.set(nativeArr.baseAddress(), i, arr[i]));</span>
  
                  //call qsort
<span class="line-modified">!                 try (MemorySegment qsortUpcallStub = abi.upcallStub(qsortCompar.bindTo(nativeArr), qsortComparFunction)) {</span>
<span class="line-modified">!                     qsort.invokeExact(nativeArr.baseAddress(), seq.elementCount().getAsLong(), C_INT.byteSize(), qsortUpcallStub.baseAddress());</span>
<span class="line-modified">!                 }</span>
  
                  //convert back to Java array
<span class="line-modified">!                 return LongStream.range(0, arr.length)</span>
<span class="line-removed">-                         .mapToInt(i -&gt; (int)intArrHandle.get(nativeArr.baseAddress(), i))</span>
<span class="line-removed">-                         .toArray();</span>
              }
          }
  
          static int qsortCompare(MemorySegment base, MemoryAddress addr1, MemoryAddress addr2) {
<span class="line-modified">!             return (int)intHandle.get(addr1.rebase(base)) - (int)intHandle.get(addr2.rebase(base));</span>
          }
  
          int rand() throws Throwable {
              return (int)rand.invokeExact();
          }
<span class="line-new-header">--- 277,59 ---</span>
                  this.base = MemorySegment.ofNativeRestricted(base, SIZE, Thread.currentThread(),
                          null, null).baseAddress();
              }
  
              int sec() {
<span class="line-modified">!                 return getInt(base, 0);</span>
              }
              int min() {
<span class="line-modified">!                 return getInt(base, 4);</span>
              }
              int hour() {
<span class="line-modified">!                 return getInt(base, 8);</span>
              }
              int mday() {
<span class="line-modified">!                 return getInt(base, 12);</span>
              }
              int mon() {
<span class="line-modified">!                 return getInt(base, 16);</span>
              }
              int year() {
<span class="line-modified">!                 return getInt(base, 20);</span>
              }
              int wday() {
<span class="line-modified">!                 return getInt(base, 24);</span>
              }
              int yday() {
<span class="line-modified">!                 return getInt(base, 28);</span>
              }
              boolean isdst() {
<span class="line-modified">!                 byte b = getByte(base, 32);</span>
                  return b != 0;
              }
          }
  
          int[] qsort(int[] arr) throws Throwable {
              //init native array
<span class="line-modified">!             try (NativeScope scope = NativeScope.unboundedScope()) {</span>
  
<span class="line-modified">!                 MemorySegment nativeArr = scope.allocateArray(C_INT, arr).segment();</span>
  
                  //call qsort
<span class="line-modified">!                 MemorySegment qsortUpcallStub = abi.upcallStub(qsortCompar.bindTo(nativeArr), qsortComparFunction);</span>
<span class="line-modified">!                 scope.register(qsortUpcallStub);</span>
<span class="line-modified">! </span>
<span class="line-added">+                 qsort.invokeExact(nativeArr.baseAddress(), (long)arr.length, C_INT.byteSize(), qsortUpcallStub.baseAddress());</span>
  
                  //convert back to Java array
<span class="line-modified">!                 return nativeArr.toIntArray();</span>
              }
          }
  
          static int qsortCompare(MemorySegment base, MemoryAddress addr1, MemoryAddress addr2) {
<span class="line-modified">!             return getInt(base.baseAddress(), addr1.rebase(base).segmentOffset()) -</span>
<span class="line-added">+                    getInt(base.baseAddress(), addr2.rebase(base).segmentOffset());</span>
          }
  
          int rand() throws Throwable {
              return (int)rand.invokeExact();
          }
</pre>
<center><a href="../../../../src/jdk.incubator.foreign/share/classes/jdk/internal/foreign/abi/SharedUtils.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> next &gt;</center>  </body>
</html>