<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>New test/jdk/java/net/httpclient/PathSubscriber/BodyHandlerOfFileDownloadTest.java</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
  </head>
  <body>
    <pre>
  1 /*
  2  * Copyright (c) 2020, Oracle and/or its affiliates. All rights reserved.
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 /*
 25  * @test
 26  * @bug 8237470
 27  * @summary Confirm HttpResponse.BodySubscribers#ofFileDownload(Path)
 28  *          works only with the default file system
 29  * @modules java.base/sun.net.www.http
 30  *          java.net.http/jdk.internal.net.http.common
 31  *          java.net.http/jdk.internal.net.http.frame
 32  *          java.net.http/jdk.internal.net.http.hpack
 33  *          jdk.httpserver
 34  * @library /test/lib ../http2/server
 35  * @compile ../HttpServerAdapters.java
 36  * @build jdk.test.lib.net.SimpleSSLContext
 37  * @run testng/othervm BodyHandlerOfFileDownloadTest
 38  * @run testng/othervm/java.security.policy=ofFileDownload.policy BodyHandlerOfFileDownloadTest
 39  */
 40 
 41 import com.sun.net.httpserver.HttpServer;
 42 import com.sun.net.httpserver.HttpsConfigurator;
 43 import com.sun.net.httpserver.HttpsServer;
 44 import jdk.test.lib.net.SimpleSSLContext;
 45 import jdk.test.lib.util.FileUtils;
 46 import org.testng.annotations.AfterTest;
 47 import org.testng.annotations.BeforeTest;
 48 import org.testng.annotations.DataProvider;
 49 import org.testng.annotations.Test;
 50 
 51 import javax.net.ssl.SSLContext;
 52 import java.io.IOException;
 53 import java.io.InputStream;
 54 import java.io.OutputStream;
 55 import java.net.InetAddress;
 56 import java.net.InetSocketAddress;
 57 import java.net.URI;
 58 import java.net.http.HttpClient;
 59 import java.net.http.HttpRequest;
 60 import java.net.http.HttpRequest.BodyPublishers;
 61 import java.net.http.HttpResponse.BodyHandlers;
 62 import java.nio.charset.StandardCharsets;
 63 import java.nio.file.FileSystem;
 64 import java.nio.file.FileSystems;
 65 import java.nio.file.Files;
 66 import java.nio.file.Path;
 67 import java.util.Map;
 68 
 69 import static java.lang.System.out;
 70 import static java.net.http.HttpClient.Builder.NO_PROXY;
 71 import static java.nio.file.StandardOpenOption.CREATE;
 72 import static java.nio.file.StandardOpenOption.TRUNCATE_EXISTING;
 73 import static java.nio.file.StandardOpenOption.WRITE;
 74 import static org.testng.Assert.assertEquals;
 75 import static org.testng.Assert.assertTrue;
 76 
 77 public class BodyHandlerOfFileDownloadTest implements HttpServerAdapters {
 78     static final String MSG = &quot;msg&quot;;
 79     static final String contentDispositionValue = &quot;attachment; filename=example.html&quot;;
 80 
 81     SSLContext sslContext;
 82     HttpServerAdapters.HttpTestServer httpTestServer;    // HTTP/1.1      [ 4 servers ]
 83     HttpServerAdapters.HttpTestServer httpsTestServer;   // HTTPS/1.1
 84     HttpServerAdapters.HttpTestServer http2TestServer;   // HTTP/2 ( h2c )
 85     HttpServerAdapters.HttpTestServer https2TestServer;  // HTTP/2 ( h2  )
 86     String httpURI;
 87     String httpsURI;
 88     String http2URI;
 89     String https2URI;
 90 
 91     FileSystem zipFs;
 92     Path defaultFsPath;
 93     Path zipFsPath;
 94 
 95     // Default file system
 96 
 97     static Path defaultFsDir() throws Exception {
 98         var dir = Path.of(&quot;defaultDir&quot;);
 99         if (Files.notExists(dir)) {
100             Files.createDirectory(dir);
101         }
102         return dir;
103     }
104 
105     @DataProvider(name = &quot;defaultFsData&quot;)
106     public Object[][] defaultFsData() {
107         return new Object[][]{
108                 {  httpURI,    defaultFsPath,  MSG,  true   },
109                 {  httpsURI,   defaultFsPath,  MSG,  true   },
110                 {  http2URI,   defaultFsPath,  MSG,  true   },
111                 {  https2URI,  defaultFsPath,  MSG,  true   },
112                 {  httpURI,    defaultFsPath,  MSG,  false  },
113                 {  httpsURI,   defaultFsPath,  MSG,  false  },
114                 {  http2URI,   defaultFsPath,  MSG,  false  },
115                 {  https2URI,  defaultFsPath,  MSG,  false  },
116         };
117     }
118 
119     @Test(dataProvider = &quot;defaultFsData&quot;)
120     public void testDefaultFs(String uriString,
121                               Path path,
122                               String expectedMsg,
123                               boolean sameClient) throws Exception {
124         out.printf(&quot;\n\n--- testDefaultFs(%s, %s, \&quot;%s\&quot;, %b): starting\n&quot;,
125                 uriString, path, expectedMsg, sameClient);
126         receive(uriString, path, expectedMsg, sameClient);
127     }
128 
129     private static final int ITERATION_COUNT = 3;
130 
131     private void receive(String uriString,
132                       Path path,
133                       String expectedMsg,
134                       boolean sameClient) throws Exception {
135         HttpClient client = null;
136 
137         for (int i = 0; i &lt; ITERATION_COUNT; i++) {
138             if (!sameClient || client == null) {
139                 client = HttpClient.newBuilder()
140                         .proxy(NO_PROXY)
141                         .sslContext(sslContext)
142                         .build();
143             }
144             var req = HttpRequest.newBuilder(URI.create(uriString))
145                 .POST(BodyPublishers.noBody())
146                 .build();
147             var resp = client.send(req, BodyHandlers.ofFileDownload(path, CREATE, TRUNCATE_EXISTING, WRITE));
148             String msg = Files.readString(resp.body());
149             out.printf(&quot;Resp code: %s\n&quot;, resp.statusCode());
150             out.println(&quot;Resp body Path: &quot; + resp.body());
151             out.printf(&quot;Resp body written to file: %s\n&quot;, msg);
152             assertEquals(resp.statusCode(), 200);
153             assertEquals(msg, expectedMsg);
154             assertTrue(resp.headers().firstValue(&quot;Content-Disposition&quot;).isPresent());
155             assertEquals(resp.headers().firstValue(&quot;Content-Disposition&quot;).get(), contentDispositionValue);
156         }
157     }
158 
159     // Zip file system
160 
161     static FileSystem newZipFs() throws Exception {
162         Path zipFile = Path.of(&quot;file.zip&quot;);
163         return FileSystems.newFileSystem(zipFile, Map.of(&quot;create&quot;, &quot;true&quot;));
164     }
165 
166     static Path zipFsDir(FileSystem fs) throws Exception {
167         var dir = fs.getPath(&quot;zipDir&quot;);
168         if (Files.notExists(dir)) {
169             Files.createDirectory(dir);
170         }
171         return dir;
172     }
173 
174     @Test(expectedExceptions = IllegalArgumentException.class)
175     public void testZipFs() {
176         out.printf(&quot;\n\n--- testZipFs(): starting\n&quot;);
177         BodyHandlers.ofFileDownload(zipFsPath, CREATE, TRUNCATE_EXISTING, WRITE);
178     }
179 
180 
181     @BeforeTest
182     public void setup() throws Exception {
183         sslContext = new SimpleSSLContext().get();
184         if (sslContext == null)
185             throw new AssertionError(&quot;Unexpected null sslContext&quot;);
186 
187         defaultFsPath = defaultFsDir();
188         zipFs = newZipFs();
189         zipFsPath = zipFsDir(zipFs);
190 
191         InetSocketAddress sa =
192                 new InetSocketAddress(InetAddress.getLoopbackAddress(), 0);
193 
194         httpTestServer = HttpServerAdapters.HttpTestServer.of(HttpServer.create(sa, 0));
195         httpTestServer.addHandler(new HttpEchoHandler(), &quot;/http1/echo&quot;);
196         httpURI = &quot;http://&quot; + httpTestServer.serverAuthority() + &quot;/http1/echo&quot;;
197 
198         HttpsServer httpsServer = HttpsServer.create(sa, 0);
199         httpsServer.setHttpsConfigurator(new HttpsConfigurator(sslContext));
200         httpsTestServer = HttpServerAdapters.HttpTestServer.of(httpsServer);
201         httpsTestServer.addHandler(new HttpEchoHandler(), &quot;/https1/echo&quot;);
202         httpsURI = &quot;https://&quot; + httpsTestServer.serverAuthority() + &quot;/https1/echo&quot;;
203 
204         http2TestServer = HttpServerAdapters.HttpTestServer.of(
205                 new Http2TestServer(&quot;localhost&quot;, false, 0));
206         http2TestServer.addHandler(new HttpEchoHandler(), &quot;/http2/echo&quot;);
207         http2URI = &quot;http://&quot; + http2TestServer.serverAuthority() + &quot;/http2/echo&quot;;
208 
209         https2TestServer = HttpServerAdapters.HttpTestServer.of(
210                 new Http2TestServer(&quot;localhost&quot;, true, sslContext));
211         https2TestServer.addHandler(new HttpEchoHandler(), &quot;/https2/echo&quot;);
212         https2URI = &quot;https://&quot; + https2TestServer.serverAuthority() + &quot;/https2/echo&quot;;
213 
214         httpTestServer.start();
215         httpsTestServer.start();
216         http2TestServer.start();
217         https2TestServer.start();
218     }
219 
220     @AfterTest
221     public void teardown() throws Exception {
222         if (Files.exists(zipFsPath))
223             FileUtils.deleteFileTreeWithRetry(zipFsPath);
224         if (Files.exists(defaultFsPath))
225             FileUtils.deleteFileTreeWithRetry(defaultFsPath);
226 
227         httpTestServer.stop();
228         httpsTestServer.stop();
229         http2TestServer.stop();
230         https2TestServer.stop();
231         zipFs.close();
232     }
233 
234     static class HttpEchoHandler implements HttpServerAdapters.HttpTestHandler {
235         @Override
236         public void handle(HttpServerAdapters.HttpTestExchange t) throws IOException {
237             try (InputStream is = t.getRequestBody();
238                 OutputStream os = t.getResponseBody()) {
239                 is.readAllBytes();
240                 t.getResponseHeaders().addHeader(&quot;Content-Disposition&quot;,
241                                 &quot;attachment; filename=example.html&quot;);
242                 t.sendResponseHeaders(200, MSG.getBytes().length);
243                 os.write(MSG.getBytes(StandardCharsets.UTF_8));
244             }
245         }
246     }
247 }
    </pre>
  </body>
</html>