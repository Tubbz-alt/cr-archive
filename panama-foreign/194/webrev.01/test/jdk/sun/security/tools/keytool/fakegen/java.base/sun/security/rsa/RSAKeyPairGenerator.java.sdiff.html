<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff test/jdk/sun/security/tools/keytool/fakegen/java.base/sun/security/rsa/RSAKeyPairGenerator.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="../../../../../../../krb5/auto/KDC.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../../index.html" target="_top">index</a> <a href="../../../../../../../../../tools/jpackage/helpers/jdk/jpackage/test/Executor.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>test/jdk/sun/security/tools/keytool/fakegen/java.base/sun/security/rsa/RSAKeyPairGenerator.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2019, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 package sun.security.rsa;
 25 
 26 import java.math.BigInteger;
 27 
 28 import java.security.*;
 29 import java.security.spec.AlgorithmParameterSpec;
 30 import java.security.spec.RSAKeyGenParameterSpec;
 31 
<span class="line-modified"> 32 import sun.security.x509.AlgorithmId;</span>
<span class="line-removed"> 33 import static sun.security.rsa.RSAUtil.KeyType;</span>
 34 
 35 /**
 36  * A fake RSA keypair generation.
 37  */
 38 public abstract class RSAKeyPairGenerator extends KeyPairGeneratorSpi {
 39 
 40     // public exponent to use
 41     private BigInteger publicExponent;
 42 
 43     // size of the key to generate, &gt;= RSAKeyFactory.MIN_MODLEN
 44     private int keySize;
 45 
 46     private final KeyType type;
<span class="line-modified"> 47     private AlgorithmId rsaId;</span>
 48 
 49     RSAKeyPairGenerator(KeyType type, int defKeySize) {
 50         this.type = type;
 51         // initialize to default in case the app does not call initialize()
 52         initialize(defKeySize, null);
 53     }
 54 
 55     // initialize the generator. See JCA doc
 56     public void initialize(int keySize, SecureRandom random) {
 57         try {
 58             initialize(new RSAKeyGenParameterSpec(keySize,
 59                     RSAKeyGenParameterSpec.F4), random);
 60         } catch (InvalidAlgorithmParameterException iape) {
 61             throw new InvalidParameterException(iape.getMessage());
 62         }
 63     }
 64 
 65     // second initialize method. See JCA doc.
 66     public void initialize(AlgorithmParameterSpec params, SecureRandom random)
 67             throws InvalidAlgorithmParameterException {
</pre>
<hr />
<pre>
 81             if (tmpPublicExponent.compareTo(RSAKeyGenParameterSpec.F0) &lt; 0) {
 82                 throw new InvalidAlgorithmParameterException
 83                         (&quot;Public exponent must be 3 or larger&quot;);
 84             }
 85             if (tmpPublicExponent.bitLength() &gt; tmpKeySize) {
 86                 throw new InvalidAlgorithmParameterException
 87                         (&quot;Public exponent must be smaller than key size&quot;);
 88             }
 89         }
 90 
 91         // do not allow unreasonably large key sizes, probably user error
 92         try {
 93             RSAKeyFactory.checkKeyLengths(tmpKeySize, tmpPublicExponent,
 94                 512, 64 * 1024);
 95         } catch (InvalidKeyException e) {
 96             throw new InvalidAlgorithmParameterException(
 97                 &quot;Invalid key sizes&quot;, e);
 98         }
 99 
100         try {
<span class="line-modified">101             this.rsaId = RSAUtil.createAlgorithmId(type, tmpParams);</span>
102         } catch (ProviderException e) {
103             throw new InvalidAlgorithmParameterException(
104                 &quot;Invalid key parameters&quot;, e);
105         }
106 
107         this.keySize = tmpKeySize;
108         this.publicExponent = tmpPublicExponent;
109     }
110 
111     // generate the keypair. See JCA doc
112     public KeyPair generateKeyPair() {
113 
114         // accommodate odd key sizes in case anybody wants to use them
115         BigInteger e = publicExponent;
116         if (!e.equals(RSAKeyGenParameterSpec.F4)) {
117             throw new AssertionError(&quot;Only support F4 now&quot;);
118         }
119         BigInteger p, q, n;
120 
121         // Pre-calculated p and q for e == RSAKeyGenParameterSpec.F4
</pre>
<hr />
<pre>
419         BigInteger q1 = q.subtract(BigInteger.ONE);
420         BigInteger phi = p1.multiply(q1);
421         // generate new p and q until they work. typically
422         // the first try will succeed when using F4
423         if (e.gcd(phi).equals(BigInteger.ONE) == false) {
424             throw new AssertionError(&quot;Should not happen&quot;);
425         }
426 
427         // private exponent d is the inverse of e mod phi
428         BigInteger d = e.modInverse(phi);
429 
430         // 1st prime exponent pe = d mod (p - 1)
431         BigInteger pe = d.mod(p1);
432         // 2nd prime exponent qe = d mod (q - 1)
433         BigInteger qe = d.mod(q1);
434 
435         // crt coefficient coeff is the inverse of q mod p
436         BigInteger coeff = q.modInverse(p);
437 
438         try {
<span class="line-modified">439             PublicKey publicKey = new RSAPublicKeyImpl(rsaId, n, e);</span>
440             PrivateKey privateKey = new RSAPrivateCrtKeyImpl(
<span class="line-modified">441                     rsaId, n, e, d, p, q, pe, qe, coeff);</span>
442             return new KeyPair(publicKey, privateKey);
443         } catch (InvalidKeyException exc) {
444             // invalid key exception only thrown for keys &lt; 512 bit,
445             // will not happen here
446             throw new RuntimeException(exc);
447         }
448     }
449 }
</pre>
</td>
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2019, 2020, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 package sun.security.rsa;
 25 
 26 import java.math.BigInteger;
 27 
 28 import java.security.*;
 29 import java.security.spec.AlgorithmParameterSpec;
 30 import java.security.spec.RSAKeyGenParameterSpec;
 31 
<span class="line-modified"> 32 import sun.security.rsa.RSAUtil.KeyType;</span>

 33 
 34 /**
 35  * A fake RSA keypair generation.
 36  */
 37 public abstract class RSAKeyPairGenerator extends KeyPairGeneratorSpi {
 38 
 39     // public exponent to use
 40     private BigInteger publicExponent;
 41 
 42     // size of the key to generate, &gt;= RSAKeyFactory.MIN_MODLEN
 43     private int keySize;
 44 
 45     private final KeyType type;
<span class="line-modified"> 46     private AlgorithmParameterSpec keyParams;</span>
 47 
 48     RSAKeyPairGenerator(KeyType type, int defKeySize) {
 49         this.type = type;
 50         // initialize to default in case the app does not call initialize()
 51         initialize(defKeySize, null);
 52     }
 53 
 54     // initialize the generator. See JCA doc
 55     public void initialize(int keySize, SecureRandom random) {
 56         try {
 57             initialize(new RSAKeyGenParameterSpec(keySize,
 58                     RSAKeyGenParameterSpec.F4), random);
 59         } catch (InvalidAlgorithmParameterException iape) {
 60             throw new InvalidParameterException(iape.getMessage());
 61         }
 62     }
 63 
 64     // second initialize method. See JCA doc.
 65     public void initialize(AlgorithmParameterSpec params, SecureRandom random)
 66             throws InvalidAlgorithmParameterException {
</pre>
<hr />
<pre>
 80             if (tmpPublicExponent.compareTo(RSAKeyGenParameterSpec.F0) &lt; 0) {
 81                 throw new InvalidAlgorithmParameterException
 82                         (&quot;Public exponent must be 3 or larger&quot;);
 83             }
 84             if (tmpPublicExponent.bitLength() &gt; tmpKeySize) {
 85                 throw new InvalidAlgorithmParameterException
 86                         (&quot;Public exponent must be smaller than key size&quot;);
 87             }
 88         }
 89 
 90         // do not allow unreasonably large key sizes, probably user error
 91         try {
 92             RSAKeyFactory.checkKeyLengths(tmpKeySize, tmpPublicExponent,
 93                 512, 64 * 1024);
 94         } catch (InvalidKeyException e) {
 95             throw new InvalidAlgorithmParameterException(
 96                 &quot;Invalid key sizes&quot;, e);
 97         }
 98 
 99         try {
<span class="line-modified">100             this.keyParams = RSAUtil.checkParamsAgainstType(type, tmpParams);</span>
101         } catch (ProviderException e) {
102             throw new InvalidAlgorithmParameterException(
103                 &quot;Invalid key parameters&quot;, e);
104         }
105 
106         this.keySize = tmpKeySize;
107         this.publicExponent = tmpPublicExponent;
108     }
109 
110     // generate the keypair. See JCA doc
111     public KeyPair generateKeyPair() {
112 
113         // accommodate odd key sizes in case anybody wants to use them
114         BigInteger e = publicExponent;
115         if (!e.equals(RSAKeyGenParameterSpec.F4)) {
116             throw new AssertionError(&quot;Only support F4 now&quot;);
117         }
118         BigInteger p, q, n;
119 
120         // Pre-calculated p and q for e == RSAKeyGenParameterSpec.F4
</pre>
<hr />
<pre>
418         BigInteger q1 = q.subtract(BigInteger.ONE);
419         BigInteger phi = p1.multiply(q1);
420         // generate new p and q until they work. typically
421         // the first try will succeed when using F4
422         if (e.gcd(phi).equals(BigInteger.ONE) == false) {
423             throw new AssertionError(&quot;Should not happen&quot;);
424         }
425 
426         // private exponent d is the inverse of e mod phi
427         BigInteger d = e.modInverse(phi);
428 
429         // 1st prime exponent pe = d mod (p - 1)
430         BigInteger pe = d.mod(p1);
431         // 2nd prime exponent qe = d mod (q - 1)
432         BigInteger qe = d.mod(q1);
433 
434         // crt coefficient coeff is the inverse of q mod p
435         BigInteger coeff = q.modInverse(p);
436 
437         try {
<span class="line-modified">438             PublicKey publicKey = new RSAPublicKeyImpl(type, keyParams, n, e);</span>
439             PrivateKey privateKey = new RSAPrivateCrtKeyImpl(
<span class="line-modified">440                     type, keyParams, n, e, d, p, q, pe, qe, coeff);</span>
441             return new KeyPair(publicKey, privateKey);
442         } catch (InvalidKeyException exc) {
443             // invalid key exception only thrown for keys &lt; 512 bit,
444             // will not happen here
445             throw new RuntimeException(exc);
446         }
447     }
448 }
</pre>
</td>
</tr>
</table>
<center><a href="../../../../../../../krb5/auto/KDC.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../../index.html" target="_top">index</a> <a href="../../../../../../../../../tools/jpackage/helpers/jdk/jpackage/test/Executor.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>