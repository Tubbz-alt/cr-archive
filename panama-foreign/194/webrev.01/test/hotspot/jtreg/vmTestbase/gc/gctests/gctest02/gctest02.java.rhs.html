<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames test/hotspot/jtreg/vmTestbase/gc/gctests/gctest02/gctest02.java</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
<a name="1" id="anc1"></a><span class="line-modified">  2  * Copyright (c) 2002, 2020, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 //gctest02.java
 24 
 25 
 26 /*
 27  * @test
<a name="2" id="anc2"></a><span class="line-modified"> 28  * @key gc randomness</span>
 29  *
 30  * @summary converted from VM Testbase gc/gctests/gctest02.
 31  * VM Testbase keywords: [gc]
 32  *
 33  * @library /vmTestbase
 34  *          /test/lib
 35  * @run driver jdk.test.lib.FileInstaller . .
 36  * @run main/othervm gc.gctests.gctest02.gctest02 100
 37  */
 38 
 39 package gc.gctests.gctest02;
 40 
 41 import nsk.share.TestFailure;
 42 import nsk.share.TestBug;
<a name="3" id="anc3"></a><span class="line-added"> 43 import nsk.share.test.LocalRandom;</span>
<span class="line-added"> 44 </span>
 45 /*  stress testing
 46  create 16 memory evil threads requesting to allocate
 47  the object of sizes from 8 to ( 2 ^ 19).
 48  The live time of objects is random (0 ~ 1000).
 49  Here we let the threads that reference the objects
 50  to simulate the object life time.
 51 */
 52 
<a name="4" id="anc4"></a>

 53 class PopulationException extends Exception {
 54     //this exception is used to signal that we&#39;ve
 55     //reached the end of the test
 56 }
 57 
<a name="5" id="anc5"></a>













 58 class ThreadCount {
 59     static int count= 0;
 60     static synchronized void inc() { count++; }
 61     static synchronized void dec() { count --; }
 62     static synchronized int get() { return count; }
 63 }
 64 
 65 class Person {
 66         String name;
 67         int     ssid;
 68         int     age;
 69         int     buf[];
 70         int     bufsz;
 71         static int populationCount = 0;
 72         static int populationLimit = 0;
 73 
 74         Person(String n, int ssid, int age, int bufsz)
 75         throws PopulationException {
 76                 name = n;
 77                 this.ssid = ssid;
 78                 this.age = age;
 79                 if ( bufsz &gt; 0 ) {
 80                         this.bufsz = bufsz;
 81                         this.buf = new int[bufsz];
 82                 }
 83                 incPopulation();
 84                 if (getPopulation() &gt; getPopulationLimit()) {
 85                         throw new PopulationException();
 86                 }
 87         }
 88         public static synchronized int getPopulationLimit() {
 89                 return populationLimit;
 90         }
 91         public static synchronized void setPopulationLimit(int newLimit) {
 92                 populationLimit = newLimit;
 93         }
 94         public static synchronized int getPopulation() {
 95                 return populationCount;
 96         }
 97         public static synchronized void incPopulation() {
 98                 populationCount ++;
 99         }
100 
101 }
102 
103 // hr (humane resource) dept is using objects.
104 // Put the hr thread to sleep to keep the reference to objects
105 class hr extends Thread {
106         Person pp;
107         int lifetime;
108 
109         hr(Person p, int l) {
110                 pp = p;
111                 lifetime = l;
112         }
113 
114         public void run() {
115                 // just sleep to emulate the life time of object referenced by p
116                 try { sleep(lifetime); }
117                 catch (InterruptedException e) {}
118         }
119 }
120 
121 class Memevil extends Thread {
122         int sum;
123         int bufsz = 64;
124         boolean debug = false;
125 
126         Memevil(int bufsz) {
127                 sum = 0;
128                 this.bufsz = bufsz;
129         }
130         /*      Person object is live short, it will be garbage after
131          *      control returns
132          */
133         private boolean doit() {
134                 try {
135                         Person p = new Person(&quot;Duke&quot;, 100, 100, bufsz);
136                         hr useit = new hr(p, (int)(100*LocalRandom.random()));
137                         useit.start();
138                         return true;
139                 }
140                 catch (PopulationException e) {
141                         return false;
142                 }
143                 catch (OutOfMemoryError e ) {
144                         System.err.println(getName() + &quot;: Out of Memory&quot;);
145                         return false;
146                 }
147         }
148         public void run() {
149                 while ( doit() ) {
150                         if ( LocalRandom.random() &gt; 0.6668) {
151                                 try {
152                                         sleep(10);   // to be nice
153                                 }
154                                 catch (InterruptedException e) {
155                                 }
156                         }
157                         Thread.yield();
158                 }
159                 //we&#39;ve reached the population limit, so we&#39;re exiting the thread
160                 ThreadCount.dec();
161         }
162 }
163 
164 class Escaper extends Thread {
165         public void run() {
166                 while ( ThreadCount.get() &gt; 0 ) {
167                         int buf[] = new int[32];
168                         {
169                                                 Thread.yield();
170                         }
171                 }
172         }
173 }
174 
175 public class gctest02 {
176         public static void main(String args[] ) {
177                 int bufsz = 8;
178                 int peopleLimit = 1000;
<a name="6" id="anc6"></a>
179                 Memevil me=null;
180                 if (args.length &gt; 0)
181                 {
182                         try
183                         {
184                                 peopleLimit = new Integer(args[0]).intValue();
185                         }
186                         catch (NumberFormatException e)
187                         {
188                                 throw new TestBug(
189                                         &quot;Bad input to gctest02. Expected integer, got: -&gt;&quot;
190                                         + args[0] + &quot;&lt;-&quot;, e);
191                         }
192                 }
193 
<a name="7" id="anc7"></a>












194                 Person.setPopulationLimit(peopleLimit);
<a name="8" id="anc8"></a>
195                 for (int ii=0; ii&lt;40; ii++) {
196                         bufsz = 8;
<a name="9" id="anc9"></a>
197                         Person.populationCount = 0;
198                         Escaper you = new Escaper();
199                         you.setName(&quot;Escaper&quot;);
200                         ThreadCount.inc();
201                         you.start();
202                         me = new Memevil(bufsz);
203                         me.setName(&quot;Memevil&quot; + bufsz);
204                         bufsz = 2*bufsz;
205                         me.start();
206                         Thread.yield();
207                         for (int i=1; i&lt;11; i++) {
208                                 ThreadCount.inc();
209                                 me = new Memevil(bufsz);
210                                 me.setName(&quot;Memevil&quot; + bufsz);
211                                 bufsz = 2*bufsz;
212                                 me.start();
213                                 Thread.yield();
214                         }
215                         try {
216                                 you.join();
217                         }
218                         catch (InterruptedException e) {
219                                 throw new TestFailure(&quot;InterruptedException in gctest2.main()&quot;);
220                         }
221                         for (int i=1; i&lt;11; i++) {
222                                 try { me.join(); }
223                                 catch (InterruptedException e) {
224                                         throw new TestFailure(&quot;InterruptedException in gctest2.main()&quot;);
225                                 }
226                         }
227                 }
228                 System.out.println(&quot;Test passed.&quot;);
229         }
230 }
<a name="10" id="anc10"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="10" type="hidden" />
</body>
</html>