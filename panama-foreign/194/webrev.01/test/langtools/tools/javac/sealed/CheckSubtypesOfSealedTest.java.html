<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>New test/langtools/tools/javac/sealed/CheckSubtypesOfSealedTest.java</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
  <body>
    <pre>
  1 /*
  2  * Copyright (c) 2018, 2020, Oracle and/or its affiliates. All rights reserved.
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 /*
 25  * @test
 26  * @summary check subtypes of sealed classes
 27  * @library /tools/lib /tools/javac/lib /tools/javac/classfiles/attributes/lib
 28  * @modules jdk.jdeps/com.sun.tools.classfile
 29  *          jdk.compiler/com.sun.tools.javac.code
 30  *          jdk.compiler/com.sun.tools.javac.api
 31  *          jdk.compiler/com.sun.tools.javac.main
 32  *          jdk.compiler/com.sun.tools.javac.util
 33  * @build toolbox.ToolBox toolbox.JavacTask InMemoryFileManager TestBase
 34  * @run main CheckSubtypesOfSealedTest
 35  */
 36 
 37 import java.util.List;
 38 import com.sun.tools.classfile.*;
 39 import com.sun.tools.classfile.ConstantPool.CONSTANT_Utf8_info;
 40 import com.sun.tools.javac.code.Flags;
 41 import com.sun.tools.javac.util.Assert;
 42 
 43 public class CheckSubtypesOfSealedTest extends TestBase {
 44 
 45     static final String testSource =
 46             &quot;public class SealedClasses {\n&quot; +
 47             &quot;    sealed abstract class SAC {}\n&quot; +
 48             &quot;    sealed abstract class SAC2 extends SAC {}\n&quot; +
 49             &quot;    final class SAC3 extends SAC {}\n&quot; +
 50             &quot;    final class SAC4 extends SAC2 {}\n&quot; +
 51             &quot;    sealed interface SI {}\n&quot; +
 52             &quot;    sealed interface SSI extends SI {}\n&quot; +
 53             &quot;    final class SAC5 implements SI, SSI {}\n&quot; +
 54             &quot;    non-sealed abstract class SAC6 extends SAC {}\n&quot; +
 55             &quot;    non-sealed class SAC7 extends SAC {}\n&quot; +
 56             &quot;}&quot;;
 57 
 58     public static void main(String[] args) throws Exception {
 59         new CheckSubtypesOfSealedTest().run();
 60     }
 61 
 62     void run() throws Exception {
 63         InMemoryFileManager fileManager = compile(List.of(&quot;--enable-preview&quot;, &quot;-source&quot;,
 64                 Integer.toString(Runtime.version().feature())), testSource);
 65         checkClassFile(readClassFile(fileManager.getClasses().get(&quot;SealedClasses$SAC2&quot;)), CheckFor.SEALED);
 66         checkClassFile(readClassFile(fileManager.getClasses().get(&quot;SealedClasses$SAC3&quot;)), CheckFor.FINAL);
 67         checkClassFile(readClassFile(fileManager.getClasses().get(&quot;SealedClasses$SAC4&quot;)), CheckFor.FINAL);
 68         checkClassFile(readClassFile(fileManager.getClasses().get(&quot;SealedClasses$SSI&quot;)), CheckFor.SEALED);
 69         checkClassFile(readClassFile(fileManager.getClasses().get(&quot;SealedClasses$SAC5&quot;)), CheckFor.FINAL);
 70         checkClassFile(readClassFile(fileManager.getClasses().get(&quot;SealedClasses$SAC6&quot;)), CheckFor.NOT_SEALED);
 71         checkClassFile(readClassFile(fileManager.getClasses().get(&quot;SealedClasses$SAC7&quot;)), CheckFor.NOT_SEALED);
 72     }
 73 
 74     enum CheckFor {
 75         SEALED {
 76             void check(ClassFile classFile) throws Exception {
 77                 boolean found = false;
 78                 for (Attribute attr: classFile.attributes) {
 79                     if (attr.getName(classFile.constant_pool).equals(&quot;PermittedSubclasses&quot;)) {
 80                         PermittedSubclasses_attribute permittedSubclasses = (PermittedSubclasses_attribute)attr;
 81                         found = true;
 82                         if (permittedSubclasses.subtypes == null || permittedSubclasses.subtypes.length == 0) {
 83                             throw new AssertionError(classFile.getName() + &quot; should be sealed&quot;);
 84                         }
 85                     }
 86                 }
 87                 if (!found) {
 88                     throw new AssertionError(classFile.getName() + &quot; should be sealed&quot;);
 89                 }
 90             }
 91         },
 92         FINAL {
 93             void check(ClassFile classFile) throws Exception {
 94                 if ((classFile.access_flags.flags &amp; Flags.FINAL) == 0) {
 95                     throw new AssertionError(classFile.getName() + &quot; should be final&quot;);
 96                 }
 97             }
 98         },
 99         NOT_SEALED {
100             void check(ClassFile classFile) throws Exception {
101                 for (Attribute attr: classFile.attributes) {
102                     if (attr.getName(classFile.constant_pool).equals(&quot;PermittedSubclasses&quot;)) {
103                         throw new AssertionError(classFile.getName() + &quot; should not be sealed&quot;);
104                     }
105                 }
106                 if ((classFile.access_flags.flags &amp; Flags.FINAL) != 0) {
107                     throw new AssertionError(classFile.getName() + &quot; should not be final&quot;);
108                 }
109             }
110         };
111 
112         abstract void check(ClassFile classFile) throws Exception;
113     }
114 
115     void checkClassFile(final ClassFile classFile, CheckFor... checkFor) throws Exception {
116         for (CheckFor whatToCheckFor : checkFor) {
117             whatToCheckFor.check(classFile);
118         }
119     }
120 }
    </pre>
  </body>
</html>