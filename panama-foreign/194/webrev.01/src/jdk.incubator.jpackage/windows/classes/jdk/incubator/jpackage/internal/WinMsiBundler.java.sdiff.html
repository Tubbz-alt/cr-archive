<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/jdk.incubator.jpackage/windows/classes/jdk/incubator/jpackage/internal/WinMsiBundler.java</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="ExecutableRebrander.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="resources/WinResources.properties.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/jdk.incubator.jpackage/windows/classes/jdk/incubator/jpackage/internal/WinMsiBundler.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
231             }
232 
233             try {
234                 getUpgradeCode(params);
235             } catch (IllegalArgumentException ex) {
236                 throw new ConfigException(ex);
237             }
238 
239             for (var toolInfo: wixToolset.values()) {
240                 Log.verbose(MessageFormat.format(I18N.getString(
241                         &quot;message.tool-version&quot;), toolInfo.path.getFileName(),
242                         toolInfo.version));
243             }
244 
245             wixSourcesBuilder.setWixVersion(wixToolset.get(WixTool.Light).version);
246 
247             wixSourcesBuilder.logWixFeatures();
248 
249             /********* validate bundle parameters *************/
250 
<span class="line-modified">251             String version = PRODUCT_VERSION.fetchFrom(params);</span>
<span class="line-modified">252             if (!isVersionStringValid(version)) {</span>
<span class="line-modified">253                 throw new ConfigException(</span>
<span class="line-modified">254                         MessageFormat.format(I18N.getString(</span>
<span class="line-modified">255                                 &quot;error.version-string-wrong-format&quot;), version),</span>
<span class="line-modified">256                         MessageFormat.format(I18N.getString(</span>
<span class="line-removed">257                                 &quot;error.version-string-wrong-format.advice&quot;),</span>
<span class="line-removed">258                                 PRODUCT_VERSION.getID()));</span>
259             }
260 
261             FileAssociation.verify(FileAssociation.fetchFrom(params));
262 
263             return true;
264         } catch (RuntimeException re) {
265             if (re.getCause() instanceof ConfigException) {
266                 throw (ConfigException) re.getCause();
267             } else {
268                 throw new ConfigException(re);
269             }
270         }
271     }
272 
<span class="line-removed">273     // https://msdn.microsoft.com/en-us/library/aa370859%28v=VS.85%29.aspx</span>
<span class="line-removed">274     // The format of the string is as follows:</span>
<span class="line-removed">275     //     major.minor.build</span>
<span class="line-removed">276     // The first field is the major version and has a maximum value of 255.</span>
<span class="line-removed">277     // The second field is the minor version and has a maximum value of 255.</span>
<span class="line-removed">278     // The third field is called the build version or the update version and</span>
<span class="line-removed">279     // has a maximum value of 65,535.</span>
<span class="line-removed">280     static boolean isVersionStringValid(String v) {</span>
<span class="line-removed">281         if (v == null) {</span>
<span class="line-removed">282             return true;</span>
<span class="line-removed">283         }</span>
<span class="line-removed">284 </span>
<span class="line-removed">285         String p[] = v.split(&quot;\\.&quot;);</span>
<span class="line-removed">286         if (p.length &gt; 3) {</span>
<span class="line-removed">287             Log.verbose(I18N.getString(</span>
<span class="line-removed">288                     &quot;message.version-string-too-many-components&quot;));</span>
<span class="line-removed">289             return false;</span>
<span class="line-removed">290         }</span>
<span class="line-removed">291 </span>
<span class="line-removed">292         try {</span>
<span class="line-removed">293             int val = Integer.parseInt(p[0]);</span>
<span class="line-removed">294             if (val &lt; 0 || val &gt; 255) {</span>
<span class="line-removed">295                 Log.verbose(I18N.getString(</span>
<span class="line-removed">296                         &quot;error.version-string-major-out-of-range&quot;));</span>
<span class="line-removed">297                 return false;</span>
<span class="line-removed">298             }</span>
<span class="line-removed">299             if (p.length &gt; 1) {</span>
<span class="line-removed">300                 val = Integer.parseInt(p[1]);</span>
<span class="line-removed">301                 if (val &lt; 0 || val &gt; 255) {</span>
<span class="line-removed">302                     Log.verbose(I18N.getString(</span>
<span class="line-removed">303                             &quot;error.version-string-minor-out-of-range&quot;));</span>
<span class="line-removed">304                     return false;</span>
<span class="line-removed">305                 }</span>
<span class="line-removed">306             }</span>
<span class="line-removed">307             if (p.length &gt; 2) {</span>
<span class="line-removed">308                 val = Integer.parseInt(p[2]);</span>
<span class="line-removed">309                 if (val &lt; 0 || val &gt; 65535) {</span>
<span class="line-removed">310                     Log.verbose(I18N.getString(</span>
<span class="line-removed">311                             &quot;error.version-string-build-out-of-range&quot;));</span>
<span class="line-removed">312                     return false;</span>
<span class="line-removed">313                 }</span>
<span class="line-removed">314             }</span>
<span class="line-removed">315         } catch (NumberFormatException ne) {</span>
<span class="line-removed">316             Log.verbose(I18N.getString(&quot;error.version-string-part-not-number&quot;));</span>
<span class="line-removed">317             Log.verbose(ne);</span>
<span class="line-removed">318             return false;</span>
<span class="line-removed">319         }</span>
<span class="line-removed">320 </span>
<span class="line-removed">321         return true;</span>
<span class="line-removed">322     }</span>
<span class="line-removed">323 </span>
324     private void prepareProto(Map&lt;String, ? super Object&gt; params)
325                 throws PackagerException, IOException {
326         File appImage = StandardBundlerParam.getPredefinedAppImage(params);
327         File appDir = null;
328 
329         // we either have an application image or need to build one
330         if (appImage != null) {
331             appDir = new File(MSI_IMAGE_DIR.fetchFrom(params),
332                     APP_NAME.fetchFrom(params));
333             // copy everything from appImage dir into appDir/name
334             IOUtils.copyRecursive(appImage.toPath(), appDir.toPath());
335         } else {
336             appDir = APP_BUNDLER.fetchFrom(params).doBundle(params,
337                     MSI_IMAGE_DIR.fetchFrom(params), true);
338         }
339 
340         // Configure installer icon
341         if (StandardBundlerParam.isRuntimeInstaller(params)) {
342             // Use icon from java launcher.
343             // Assume java.exe exists in Java Runtime being packed.
</pre>
</td>
<td>
<hr />
<pre>
231             }
232 
233             try {
234                 getUpgradeCode(params);
235             } catch (IllegalArgumentException ex) {
236                 throw new ConfigException(ex);
237             }
238 
239             for (var toolInfo: wixToolset.values()) {
240                 Log.verbose(MessageFormat.format(I18N.getString(
241                         &quot;message.tool-version&quot;), toolInfo.path.getFileName(),
242                         toolInfo.version));
243             }
244 
245             wixSourcesBuilder.setWixVersion(wixToolset.get(WixTool.Light).version);
246 
247             wixSourcesBuilder.logWixFeatures();
248 
249             /********* validate bundle parameters *************/
250 
<span class="line-modified">251             try {</span>
<span class="line-modified">252                 String version = PRODUCT_VERSION.fetchFrom(params);</span>
<span class="line-modified">253                 MsiVersion.of(version);</span>
<span class="line-modified">254             } catch (IllegalArgumentException ex) {</span>
<span class="line-modified">255                 throw new ConfigException(ex.getMessage(), I18N.getString(</span>
<span class="line-modified">256                         &quot;error.version-string-wrong-format.advice&quot;), ex);</span>


257             }
258 
259             FileAssociation.verify(FileAssociation.fetchFrom(params));
260 
261             return true;
262         } catch (RuntimeException re) {
263             if (re.getCause() instanceof ConfigException) {
264                 throw (ConfigException) re.getCause();
265             } else {
266                 throw new ConfigException(re);
267             }
268         }
269     }
270 



















































271     private void prepareProto(Map&lt;String, ? super Object&gt; params)
272                 throws PackagerException, IOException {
273         File appImage = StandardBundlerParam.getPredefinedAppImage(params);
274         File appDir = null;
275 
276         // we either have an application image or need to build one
277         if (appImage != null) {
278             appDir = new File(MSI_IMAGE_DIR.fetchFrom(params),
279                     APP_NAME.fetchFrom(params));
280             // copy everything from appImage dir into appDir/name
281             IOUtils.copyRecursive(appImage.toPath(), appDir.toPath());
282         } else {
283             appDir = APP_BUNDLER.fetchFrom(params).doBundle(params,
284                     MSI_IMAGE_DIR.fetchFrom(params), true);
285         }
286 
287         // Configure installer icon
288         if (StandardBundlerParam.isRuntimeInstaller(params)) {
289             // Use icon from java launcher.
290             // Assume java.exe exists in Java Runtime being packed.
</pre>
</td>
</tr>
</table>
<center><a href="ExecutableRebrander.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="resources/WinResources.properties.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>