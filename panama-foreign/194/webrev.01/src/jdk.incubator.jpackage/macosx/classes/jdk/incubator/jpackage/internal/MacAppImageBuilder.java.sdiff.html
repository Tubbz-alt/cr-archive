<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/jdk.incubator.jpackage/macosx/classes/jdk/incubator/jpackage/internal/MacAppImageBuilder.java</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="MacAppBundler.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="resources/MacResources.properties.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/jdk.incubator.jpackage/macosx/classes/jdk/incubator/jpackage/internal/MacAppImageBuilder.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 93 
 94     public static final BundlerParamInfo&lt;String&gt; MAC_CF_BUNDLE_NAME =
 95             new StandardBundlerParam&lt;&gt;(
 96                     Arguments.CLIOptions.MAC_BUNDLE_NAME.getId(),
 97                     String.class,
 98                     params -&gt; null,
 99                     (s, p) -&gt; s);
100 
101     public static final BundlerParamInfo&lt;String&gt; MAC_CF_BUNDLE_IDENTIFIER =
102             new StandardBundlerParam&lt;&gt;(
103                     Arguments.CLIOptions.MAC_BUNDLE_IDENTIFIER.getId(),
104                     String.class,
105                     params -&gt; {
106                         // Get identifier from app image if user provided
107                         // app image and did not provide the identifier via CLI.
108                         String identifier = extractBundleIdentifier(params);
109                         if (identifier != null) {
110                             return identifier;
111                         }
112 
<span class="line-modified">113                         identifier = IDENTIFIER.fetchFrom(params);</span>
<span class="line-removed">114                         if (identifier != null) {</span>
<span class="line-removed">115                             return identifier;</span>
<span class="line-removed">116                         }</span>
<span class="line-removed">117                         // the IDENTIFIER (above) will default to derive from</span>
<span class="line-removed">118                         // the main-class, in case there is no main-class</span>
<span class="line-removed">119                         // (such as runtime installer) revert to the name.</span>
<span class="line-removed">120                         // any of these could be invalid, so check later.</span>
<span class="line-removed">121                         return APP_NAME.fetchFrom(params);</span>
<span class="line-removed">122                     },</span>
<span class="line-removed">123                     (s, p) -&gt; s);</span>
<span class="line-removed">124 </span>
<span class="line-removed">125     public static final BundlerParamInfo&lt;String&gt; MAC_CF_BUNDLE_VERSION =</span>
<span class="line-removed">126             new StandardBundlerParam&lt;&gt;(</span>
<span class="line-removed">127                     &quot;mac.CFBundleVersion&quot;,</span>
<span class="line-removed">128                     String.class,</span>
<span class="line-removed">129                     p -&gt; {</span>
<span class="line-removed">130                         String s = VERSION.fetchFrom(p);</span>
<span class="line-removed">131                         if (validCFBundleVersion(s)) {</span>
<span class="line-removed">132                             return s;</span>
<span class="line-removed">133                         } else {</span>
<span class="line-removed">134                             return &quot;100&quot;;</span>
<span class="line-removed">135                         }</span>
136                     },
137                     (s, p) -&gt; s);
138 
139     public static final BundlerParamInfo&lt;File&gt; ICON_ICNS =
140             new StandardBundlerParam&lt;&gt;(
141             &quot;icon.icns&quot;,
142             File.class,
143             params -&gt; {
144                 File f = ICON.fetchFrom(params);
145                 if (f != null &amp;&amp; !f.getName().toLowerCase().endsWith(&quot;.icns&quot;)) {
146                     Log.error(MessageFormat.format(
147                             I18N.getString(&quot;message.icon-not-icns&quot;), f));
148                     return null;
149                 }
150                 return f;
151             },
152             (s, p) -&gt; new File(s));
153 
154     public static final StandardBundlerParam&lt;Boolean&gt; SIGN_BUNDLE  =
155             new StandardBundlerParam&lt;&gt;(
</pre>
<hr />
<pre>
171         this.root = imageOutDir.resolve(APP_NAME.fetchFrom(params) + &quot;.app&quot;);
172         this.contentsDir = root.resolve(&quot;Contents&quot;);
173         this.appDir = contentsDir.resolve(&quot;app&quot;);
174         this.javaModsDir = appDir.resolve(&quot;mods&quot;);
175         this.resourcesDir = contentsDir.resolve(&quot;Resources&quot;);
176         this.macOSDir = contentsDir.resolve(&quot;MacOS&quot;);
177         this.runtimeDir = contentsDir.resolve(&quot;runtime&quot;);
178         this.runtimeRoot = runtimeDir.resolve(&quot;Contents/Home&quot;);
179         this.mdir = runtimeRoot.resolve(&quot;lib&quot;);
180         Files.createDirectories(appDir);
181         Files.createDirectories(resourcesDir);
182         Files.createDirectories(macOSDir);
183         Files.createDirectories(runtimeDir);
184     }
185 
186     private void writeEntry(InputStream in, Path dstFile) throws IOException {
187         Files.createDirectories(dstFile.getParent());
188         Files.copy(in, dstFile);
189     }
190 
<span class="line-removed">191     public static boolean validCFBundleVersion(String v) {</span>
<span class="line-removed">192         // CFBundleVersion (String - iOS, OS X) specifies the build version</span>
<span class="line-removed">193         // number of the bundle, which identifies an iteration (released or</span>
<span class="line-removed">194         // unreleased) of the bundle. The build version number should be a</span>
<span class="line-removed">195         // string comprised of three non-negative, period-separated integers</span>
<span class="line-removed">196         // with the first integer being greater than zero. The string should</span>
<span class="line-removed">197         // only contain numeric (0-9) and period (.) characters. Leading zeros</span>
<span class="line-removed">198         // are truncated from each integer and will be ignored (that is,</span>
<span class="line-removed">199         // 1.02.3 is equivalent to 1.2.3). This key is not localizable.</span>
<span class="line-removed">200 </span>
<span class="line-removed">201         if (v == null) {</span>
<span class="line-removed">202             return false;</span>
<span class="line-removed">203         }</span>
<span class="line-removed">204 </span>
<span class="line-removed">205         String p[] = v.split(&quot;\\.&quot;);</span>
<span class="line-removed">206         if (p.length &gt; 3 || p.length &lt; 1) {</span>
<span class="line-removed">207             Log.verbose(I18N.getString(</span>
<span class="line-removed">208                     &quot;message.version-string-too-many-components&quot;));</span>
<span class="line-removed">209             return false;</span>
<span class="line-removed">210         }</span>
<span class="line-removed">211 </span>
<span class="line-removed">212         try {</span>
<span class="line-removed">213             BigInteger n = new BigInteger(p[0]);</span>
<span class="line-removed">214             if (BigInteger.ONE.compareTo(n) &gt; 0) {</span>
<span class="line-removed">215                 Log.verbose(I18N.getString(</span>
<span class="line-removed">216                         &quot;message.version-string-first-number-not-zero&quot;));</span>
<span class="line-removed">217                 return false;</span>
<span class="line-removed">218             }</span>
<span class="line-removed">219             if (p.length &gt; 1) {</span>
<span class="line-removed">220                 n = new BigInteger(p[1]);</span>
<span class="line-removed">221                 if (BigInteger.ZERO.compareTo(n) &gt; 0) {</span>
<span class="line-removed">222                     Log.verbose(I18N.getString(</span>
<span class="line-removed">223                             &quot;message.version-string-no-negative-numbers&quot;));</span>
<span class="line-removed">224                     return false;</span>
<span class="line-removed">225                 }</span>
<span class="line-removed">226             }</span>
<span class="line-removed">227             if (p.length &gt; 2) {</span>
<span class="line-removed">228                 n = new BigInteger(p[2]);</span>
<span class="line-removed">229                 if (BigInteger.ZERO.compareTo(n) &gt; 0) {</span>
<span class="line-removed">230                     Log.verbose(I18N.getString(</span>
<span class="line-removed">231                             &quot;message.version-string-no-negative-numbers&quot;));</span>
<span class="line-removed">232                     return false;</span>
<span class="line-removed">233                 }</span>
<span class="line-removed">234             }</span>
<span class="line-removed">235         } catch (NumberFormatException ne) {</span>
<span class="line-removed">236             Log.verbose(I18N.getString(&quot;message.version-string-numbers-only&quot;));</span>
<span class="line-removed">237             Log.verbose(ne);</span>
<span class="line-removed">238             return false;</span>
<span class="line-removed">239         }</span>
<span class="line-removed">240 </span>
<span class="line-removed">241         return true;</span>
<span class="line-removed">242     }</span>
<span class="line-removed">243 </span>
244     @Override
245     public Path getAppDir() {
246         return appDir;
247     }
248 
249     @Override
250     public Path getAppModsDir() {
251         return javaModsDir;
252     }
253 
254     @Override
255     public void prepareApplicationFiles(Map&lt;String, ? super Object&gt; params)
256             throws IOException {
257         Map&lt;String, ? super Object&gt; originalParams = new HashMap&lt;&gt;(params);
258         // Generate PkgInfo
259         File pkgInfoFile = new File(contentsDir.toFile(), &quot;PkgInfo&quot;);
260         pkgInfoFile.createNewFile();
261         writePkgInfo(pkgInfoFile);
262 
263         Path executable = macOSDir.resolve(getLauncherName(params));
</pre>
<hr />
<pre>
452         createResource(TEMPLATE_RUNTIME_INFO_PLIST, params)
453                 .setPublicName(&quot;Runtime-Info.plist&quot;)
454                 .setCategory(I18N.getString(&quot;resource.runtime-info-plist&quot;))
455                 .setSubstitutionData(data)
456                 .saveToFile(file);
457     }
458 
459     private void writeInfoPlist(File file, Map&lt;String, ? super Object&gt; params)
460             throws IOException {
461         Log.verbose(MessageFormat.format(I18N.getString(
462                 &quot;message.preparing-info-plist&quot;), file.getAbsolutePath()));
463 
464         //prepare config for exe
465         //Note: do not need CFBundleDisplayName if we don&#39;t support localization
466         Map&lt;String, String&gt; data = new HashMap&lt;&gt;();
467         data.put(&quot;DEPLOY_ICON_FILE&quot;, APP_NAME.fetchFrom(params) + &quot;.icns&quot;);
468         data.put(&quot;DEPLOY_BUNDLE_IDENTIFIER&quot;,
469                 MAC_CF_BUNDLE_IDENTIFIER.fetchFrom(params));
470         data.put(&quot;DEPLOY_BUNDLE_NAME&quot;,
471                 getBundleName(params));
<span class="line-modified">472         data.put(&quot;DEPLOY_BUNDLE_COPYRIGHT&quot;,</span>
<span class="line-removed">473                 COPYRIGHT.fetchFrom(params) != null ?</span>
<span class="line-removed">474                 COPYRIGHT.fetchFrom(params) : &quot;Unknown&quot;);</span>
475         data.put(&quot;DEPLOY_LAUNCHER_NAME&quot;, getLauncherName(params));
<span class="line-modified">476         data.put(&quot;DEPLOY_BUNDLE_SHORT_VERSION&quot;,</span>
<span class="line-modified">477                 VERSION.fetchFrom(params) != null ?</span>
<span class="line-removed">478                 VERSION.fetchFrom(params) : &quot;1.0.0&quot;);</span>
<span class="line-removed">479         data.put(&quot;DEPLOY_BUNDLE_CFBUNDLE_VERSION&quot;,</span>
<span class="line-removed">480                 MAC_CF_BUNDLE_VERSION.fetchFrom(params) != null ?</span>
<span class="line-removed">481                 MAC_CF_BUNDLE_VERSION.fetchFrom(params) : &quot;100&quot;);</span>
482 
483         boolean hasMainJar = MAIN_JAR.fetchFrom(params) != null;
484         boolean hasMainModule =
485                 StandardBundlerParam.MODULE.fetchFrom(params) != null;
486 
487         if (hasMainJar) {
488             data.put(&quot;DEPLOY_MAIN_JAR_NAME&quot;, MAIN_JAR.fetchFrom(params).
489                     getIncludedFiles().iterator().next());
490         }
491         else if (hasMainModule) {
492             data.put(&quot;DEPLOY_MODULE_NAME&quot;,
493                     StandardBundlerParam.MODULE.fetchFrom(params));
494         }
495 
496         StringBuilder sb = new StringBuilder();
497         List&lt;String&gt; jvmOptions = JAVA_OPTIONS.fetchFrom(params);
498 
499         String newline = &quot;&quot;; //So we don&#39;t add extra line after last append
500         for (String o : jvmOptions) {
501             sb.append(newline).append(
</pre>
</td>
<td>
<hr />
<pre>
 93 
 94     public static final BundlerParamInfo&lt;String&gt; MAC_CF_BUNDLE_NAME =
 95             new StandardBundlerParam&lt;&gt;(
 96                     Arguments.CLIOptions.MAC_BUNDLE_NAME.getId(),
 97                     String.class,
 98                     params -&gt; null,
 99                     (s, p) -&gt; s);
100 
101     public static final BundlerParamInfo&lt;String&gt; MAC_CF_BUNDLE_IDENTIFIER =
102             new StandardBundlerParam&lt;&gt;(
103                     Arguments.CLIOptions.MAC_BUNDLE_IDENTIFIER.getId(),
104                     String.class,
105                     params -&gt; {
106                         // Get identifier from app image if user provided
107                         // app image and did not provide the identifier via CLI.
108                         String identifier = extractBundleIdentifier(params);
109                         if (identifier != null) {
110                             return identifier;
111                         }
112 
<span class="line-modified">113                         return MacAppBundler.getIdentifier(params);</span>






















114                     },
115                     (s, p) -&gt; s);
116 
117     public static final BundlerParamInfo&lt;File&gt; ICON_ICNS =
118             new StandardBundlerParam&lt;&gt;(
119             &quot;icon.icns&quot;,
120             File.class,
121             params -&gt; {
122                 File f = ICON.fetchFrom(params);
123                 if (f != null &amp;&amp; !f.getName().toLowerCase().endsWith(&quot;.icns&quot;)) {
124                     Log.error(MessageFormat.format(
125                             I18N.getString(&quot;message.icon-not-icns&quot;), f));
126                     return null;
127                 }
128                 return f;
129             },
130             (s, p) -&gt; new File(s));
131 
132     public static final StandardBundlerParam&lt;Boolean&gt; SIGN_BUNDLE  =
133             new StandardBundlerParam&lt;&gt;(
</pre>
<hr />
<pre>
149         this.root = imageOutDir.resolve(APP_NAME.fetchFrom(params) + &quot;.app&quot;);
150         this.contentsDir = root.resolve(&quot;Contents&quot;);
151         this.appDir = contentsDir.resolve(&quot;app&quot;);
152         this.javaModsDir = appDir.resolve(&quot;mods&quot;);
153         this.resourcesDir = contentsDir.resolve(&quot;Resources&quot;);
154         this.macOSDir = contentsDir.resolve(&quot;MacOS&quot;);
155         this.runtimeDir = contentsDir.resolve(&quot;runtime&quot;);
156         this.runtimeRoot = runtimeDir.resolve(&quot;Contents/Home&quot;);
157         this.mdir = runtimeRoot.resolve(&quot;lib&quot;);
158         Files.createDirectories(appDir);
159         Files.createDirectories(resourcesDir);
160         Files.createDirectories(macOSDir);
161         Files.createDirectories(runtimeDir);
162     }
163 
164     private void writeEntry(InputStream in, Path dstFile) throws IOException {
165         Files.createDirectories(dstFile.getParent());
166         Files.copy(in, dstFile);
167     }
168 





















































169     @Override
170     public Path getAppDir() {
171         return appDir;
172     }
173 
174     @Override
175     public Path getAppModsDir() {
176         return javaModsDir;
177     }
178 
179     @Override
180     public void prepareApplicationFiles(Map&lt;String, ? super Object&gt; params)
181             throws IOException {
182         Map&lt;String, ? super Object&gt; originalParams = new HashMap&lt;&gt;(params);
183         // Generate PkgInfo
184         File pkgInfoFile = new File(contentsDir.toFile(), &quot;PkgInfo&quot;);
185         pkgInfoFile.createNewFile();
186         writePkgInfo(pkgInfoFile);
187 
188         Path executable = macOSDir.resolve(getLauncherName(params));
</pre>
<hr />
<pre>
377         createResource(TEMPLATE_RUNTIME_INFO_PLIST, params)
378                 .setPublicName(&quot;Runtime-Info.plist&quot;)
379                 .setCategory(I18N.getString(&quot;resource.runtime-info-plist&quot;))
380                 .setSubstitutionData(data)
381                 .saveToFile(file);
382     }
383 
384     private void writeInfoPlist(File file, Map&lt;String, ? super Object&gt; params)
385             throws IOException {
386         Log.verbose(MessageFormat.format(I18N.getString(
387                 &quot;message.preparing-info-plist&quot;), file.getAbsolutePath()));
388 
389         //prepare config for exe
390         //Note: do not need CFBundleDisplayName if we don&#39;t support localization
391         Map&lt;String, String&gt; data = new HashMap&lt;&gt;();
392         data.put(&quot;DEPLOY_ICON_FILE&quot;, APP_NAME.fetchFrom(params) + &quot;.icns&quot;);
393         data.put(&quot;DEPLOY_BUNDLE_IDENTIFIER&quot;,
394                 MAC_CF_BUNDLE_IDENTIFIER.fetchFrom(params));
395         data.put(&quot;DEPLOY_BUNDLE_NAME&quot;,
396                 getBundleName(params));
<span class="line-modified">397         data.put(&quot;DEPLOY_BUNDLE_COPYRIGHT&quot;, COPYRIGHT.fetchFrom(params));</span>


398         data.put(&quot;DEPLOY_LAUNCHER_NAME&quot;, getLauncherName(params));
<span class="line-modified">399         data.put(&quot;DEPLOY_BUNDLE_SHORT_VERSION&quot;, VERSION.fetchFrom(params));</span>
<span class="line-modified">400         data.put(&quot;DEPLOY_BUNDLE_CFBUNDLE_VERSION&quot;, VERSION.fetchFrom(params));</span>




401 
402         boolean hasMainJar = MAIN_JAR.fetchFrom(params) != null;
403         boolean hasMainModule =
404                 StandardBundlerParam.MODULE.fetchFrom(params) != null;
405 
406         if (hasMainJar) {
407             data.put(&quot;DEPLOY_MAIN_JAR_NAME&quot;, MAIN_JAR.fetchFrom(params).
408                     getIncludedFiles().iterator().next());
409         }
410         else if (hasMainModule) {
411             data.put(&quot;DEPLOY_MODULE_NAME&quot;,
412                     StandardBundlerParam.MODULE.fetchFrom(params));
413         }
414 
415         StringBuilder sb = new StringBuilder();
416         List&lt;String&gt; jvmOptions = JAVA_OPTIONS.fetchFrom(params);
417 
418         String newline = &quot;&quot;; //So we don&#39;t add extra line after last append
419         for (String o : jvmOptions) {
420             sb.append(newline).append(
</pre>
</td>
</tr>
</table>
<center><a href="MacAppBundler.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="resources/MacResources.properties.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>