<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff src/java.base/share/classes/sun/security/rsa/RSAUtil.java</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
  </head>
<body>
<center><a href="RSAPublicKeyImpl.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="../ssl/Finished.java.cdiff.html" target="_top">next &gt;</a></center>    <h2>src/java.base/share/classes/sun/security/rsa/RSAUtil.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 1,7 ***</span>
  /*
<span class="line-modified">!  * Copyright (c) 2018, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.  Oracle designates this
<span class="line-new-header">--- 1,7 ---</span>
  /*
<span class="line-modified">!  * Copyright (c) 2018, 2020, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.  Oracle designates this
</pre>
<hr />
<pre>
<span class="line-old-header">*** 38,125 ***</span>
   * @since   11
   */
  public class RSAUtil {
  
      public enum KeyType {
<span class="line-modified">!         RSA (&quot;RSA&quot;),</span>
<span class="line-modified">!         PSS (&quot;RSASSA-PSS&quot;)</span>
          ;
  
<span class="line-modified">!         private final String algo;</span>
  
<span class="line-modified">!         KeyType(String keyAlgo) {</span>
<span class="line-modified">!             this.algo = keyAlgo;</span>
          }
<span class="line-modified">!         public String keyAlgo() {</span>
<span class="line-modified">!             return algo;</span>
<span class="line-modified">!         }</span>
<span class="line-modified">!         public static KeyType lookup(String name)</span>
<span class="line-modified">!                 throws InvalidKeyException, ProviderException {</span>
<span class="line-modified">!             if (name == null) {</span>
<span class="line-modified">!                 throw new InvalidKeyException(&quot;Null key algorithm&quot;);</span>
<span class="line-modified">!             }</span>
<span class="line-modified">!             for (KeyType kt : KeyType.values()) {</span>
<span class="line-modified">!                 if (kt.keyAlgo().equalsIgnoreCase(name)) {</span>
<span class="line-modified">!                     return kt;</span>
<span class="line-modified">!                 }</span>
              }
<span class="line-removed">-             // no match</span>
<span class="line-removed">-             throw new ProviderException(&quot;Unsupported algorithm &quot; + name);</span>
          }
      }
  
<span class="line-modified">!     public static void checkParamsAgainstType(KeyType type,</span>
              AlgorithmParameterSpec paramSpec) throws ProviderException {
<span class="line-modified">!         switch (type) {</span>
<span class="line-modified">!             case RSA:</span>
<span class="line-modified">!                 if (paramSpec != null) {</span>
<span class="line-modified">!                     throw new ProviderException(&quot;null params expected for &quot; +</span>
<span class="line-modified">!                         type.keyAlgo());</span>
<span class="line-modified">!                 }</span>
<span class="line-modified">!                 break;</span>
<span class="line-modified">!             case PSS:</span>
<span class="line-modified">!                 if ((paramSpec != null) &amp;&amp;</span>
<span class="line-modified">!                     !(paramSpec instanceof PSSParameterSpec)) {</span>
<span class="line-modified">!                     throw new ProviderException</span>
<span class="line-modified">!                         (&quot;PSSParmeterSpec expected for &quot; + type.keyAlgo());</span>
<span class="line-modified">!                 }</span>
<span class="line-modified">!                 break;</span>
<span class="line-modified">!             default:</span>
<span class="line-modified">!                 throw new ProviderException</span>
<span class="line-modified">!                     (&quot;Unsupported RSA algorithm &quot; + type);</span>
          }
      }
  
      public static AlgorithmId createAlgorithmId(KeyType type,
              AlgorithmParameterSpec paramSpec) throws ProviderException {
  
          checkParamsAgainstType(type, paramSpec);
  
<span class="line-modified">!         ObjectIdentifier oid = null;</span>
<span class="line-modified">!         AlgorithmParameters params = null;</span>
<span class="line-modified">!         try {</span>
<span class="line-removed">-             switch (type) {</span>
<span class="line-removed">-                 case RSA:</span>
<span class="line-removed">-                     oid = AlgorithmId.RSAEncryption_oid;</span>
<span class="line-removed">-                     break;</span>
<span class="line-removed">-                 case PSS:</span>
<span class="line-removed">-                     if (paramSpec != null) {</span>
<span class="line-removed">-                         params = AlgorithmParameters.getInstance(type.keyAlgo());</span>
<span class="line-removed">-                         params.init(paramSpec);</span>
<span class="line-removed">-                     }</span>
<span class="line-removed">-                     oid = AlgorithmId.RSASSA_PSS_oid;</span>
<span class="line-removed">-                     break;</span>
<span class="line-removed">-                 default:</span>
<span class="line-removed">-                     throw new ProviderException</span>
<span class="line-removed">-                         (&quot;Unsupported RSA algorithm &quot;  + type);</span>
<span class="line-removed">-             }</span>
<span class="line-removed">-             AlgorithmId result;</span>
<span class="line-removed">-             if (params == null) {</span>
<span class="line-removed">-                 result = new AlgorithmId(oid);</span>
<span class="line-removed">-             } else {</span>
<span class="line-removed">-                 result = new AlgorithmId(oid, params);</span>
<span class="line-removed">-             }</span>
<span class="line-removed">-             return result;</span>
<span class="line-removed">-         } catch (NoSuchAlgorithmException | InvalidParameterSpecException e) {</span>
<span class="line-removed">-             // should not happen</span>
<span class="line-removed">-             throw new ProviderException(e);</span>
<span class="line-removed">-         }</span>
      }
  
<span class="line-modified">!     public static AlgorithmParameterSpec getParamSpec(AlgorithmId algid)</span>
<span class="line-modified">!             throws ProviderException {</span>
<span class="line-modified">!         if (algid == null) {</span>
<span class="line-modified">!             throw new ProviderException(&quot;AlgorithmId should not be null&quot;);</span>
          }
<span class="line-removed">-         return getParamSpec(algid.getParameters());</span>
      }
  
<span class="line-modified">!     public static AlgorithmParameterSpec getParamSpec(AlgorithmParameters params)</span>
              throws ProviderException {
<span class="line-removed">-         if (params == null) return null;</span>
  
          try {
<span class="line-modified">!             String algName = params.getAlgorithm();</span>
<span class="line-removed">-             KeyType type = KeyType.lookup(algName);</span>
<span class="line-removed">-             Class&lt;? extends AlgorithmParameterSpec&gt; specCls;</span>
<span class="line-removed">-             switch (type) {</span>
<span class="line-removed">-                 case RSA:</span>
<span class="line-removed">-                     throw new ProviderException(&quot;No params accepted for &quot; +</span>
<span class="line-removed">-                         type.keyAlgo());</span>
<span class="line-removed">-                 case PSS:</span>
<span class="line-removed">-                     specCls = PSSParameterSpec.class;</span>
<span class="line-removed">-                     break;</span>
<span class="line-removed">-                 default:</span>
<span class="line-removed">-                     throw new ProviderException(&quot;Unsupported RSA algorithm: &quot; + algName);</span>
<span class="line-removed">-             }</span>
<span class="line-removed">-             return params.getParameterSpec(specCls);</span>
          } catch (ProviderException pe) {
<span class="line-modified">!             // pass it up</span>
<span class="line-modified">!             throw pe;</span>
<span class="line-modified">!         } catch (Exception e) {</span>
<span class="line-modified">!             throw new ProviderException(e);</span>
          }
      }
  }
<span class="line-new-header">--- 38,128 ---</span>
   * @since   11
   */
  public class RSAUtil {
  
      public enum KeyType {
<span class="line-modified">!         RSA (&quot;RSA&quot;, AlgorithmId.RSAEncryption_oid, null),</span>
<span class="line-modified">!         PSS (&quot;RSASSA-PSS&quot;, AlgorithmId.RSASSA_PSS_oid, PSSParameterSpec.class)</span>
          ;
  
<span class="line-modified">!         final String keyAlgo;</span>
<span class="line-added">+         final ObjectIdentifier oid;</span>
<span class="line-added">+         final Class&lt;? extends AlgorithmParameterSpec&gt; paramSpecCls;</span>
  
<span class="line-modified">!         KeyType(String keyAlgo, ObjectIdentifier oid,</span>
<span class="line-modified">!                 Class&lt;? extends AlgorithmParameterSpec&gt; paramSpecCls) {</span>
<span class="line-added">+             this.keyAlgo = keyAlgo;</span>
<span class="line-added">+             this.oid = oid;</span>
<span class="line-added">+             this.paramSpecCls = paramSpecCls;</span>
          }
<span class="line-modified">! </span>
<span class="line-modified">!         public static KeyType lookup(String name) throws ProviderException {</span>
<span class="line-modified">! </span>
<span class="line-modified">!             requireNonNull(name, &quot;Key algorithm should not be null&quot;);</span>
<span class="line-modified">! </span>
<span class="line-modified">!             // match loosely in order to work with 3rd party providers which</span>
<span class="line-modified">!             // may not follow the standard names</span>
<span class="line-modified">!             if (name.indexOf(&quot;PSS&quot;) != -1) {</span>
<span class="line-modified">!                 return PSS;</span>
<span class="line-modified">!             } else if (name.indexOf(&quot;RSA&quot;) != -1) {</span>
<span class="line-modified">!                 return RSA;</span>
<span class="line-modified">!             } else { // no match</span>
<span class="line-added">+                 throw new ProviderException(&quot;Unsupported algorithm &quot; + name);</span>
              }
          }
      }
  
<span class="line-modified">!     private static void requireNonNull(Object obj, String msg) {</span>
<span class="line-added">+         if (obj == null) throw new ProviderException(msg);</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
<span class="line-added">+     public static AlgorithmParameterSpec checkParamsAgainstType(KeyType type,</span>
              AlgorithmParameterSpec paramSpec) throws ProviderException {
<span class="line-modified">! </span>
<span class="line-modified">!         // currently no check for null parameter spec</span>
<span class="line-modified">!         // assumption is parameter spec is optional and can be null</span>
<span class="line-modified">!         if (paramSpec == null) return null;</span>
<span class="line-modified">! </span>
<span class="line-modified">!         Class&lt;? extends AlgorithmParameterSpec&gt; expCls = type.paramSpecCls;</span>
<span class="line-modified">!         if (expCls == null) {</span>
<span class="line-modified">!             throw new ProviderException(&quot;null params expected for &quot; +</span>
<span class="line-modified">!                     type.keyAlgo);</span>
<span class="line-modified">!         } else if (!expCls.isInstance(paramSpec)) {</span>
<span class="line-modified">!             throw new ProviderException</span>
<span class="line-modified">!                     (expCls + &quot; expected for &quot; + type.keyAlgo);</span>
<span class="line-modified">!         }</span>
<span class="line-modified">!         return paramSpec;</span>
<span class="line-modified">!     }</span>
<span class="line-modified">! </span>
<span class="line-modified">!     public static AlgorithmParameters getParams(KeyType type,</span>
<span class="line-added">+             AlgorithmParameterSpec spec) throws ProviderException {</span>
<span class="line-added">+ </span>
<span class="line-added">+         if (spec == null) return null;</span>
<span class="line-added">+ </span>
<span class="line-added">+         try {</span>
<span class="line-added">+             AlgorithmParameters params =</span>
<span class="line-added">+                     AlgorithmParameters.getInstance(type.keyAlgo);</span>
<span class="line-added">+             params.init(spec);</span>
<span class="line-added">+             return params;</span>
<span class="line-added">+         } catch (NoSuchAlgorithmException | InvalidParameterSpecException ex) {</span>
<span class="line-added">+             throw new ProviderException(ex);</span>
          }
      }
  
      public static AlgorithmId createAlgorithmId(KeyType type,
              AlgorithmParameterSpec paramSpec) throws ProviderException {
  
          checkParamsAgainstType(type, paramSpec);
  
<span class="line-modified">!         ObjectIdentifier oid = type.oid;</span>
<span class="line-modified">!         AlgorithmParameters params = getParams(type, paramSpec);</span>
<span class="line-modified">!         return new AlgorithmId(oid, params);</span>
      }
  
<span class="line-modified">!     public static AlgorithmParameterSpec getParamSpec(</span>
<span class="line-modified">!             AlgorithmParameters params) throws ProviderException {</span>
<span class="line-modified">! </span>
<span class="line-modified">!         if (params == null) return null;</span>
<span class="line-added">+ </span>
<span class="line-added">+         String algName = params.getAlgorithm();</span>
<span class="line-added">+ </span>
<span class="line-added">+         KeyType type = KeyType.lookup(algName);</span>
<span class="line-added">+         Class&lt;? extends AlgorithmParameterSpec&gt; specCls = type.paramSpecCls;</span>
<span class="line-added">+         if (specCls == null) {</span>
<span class="line-added">+             throw new ProviderException(&quot;No params accepted for &quot; +</span>
<span class="line-added">+                     type.keyAlgo);</span>
<span class="line-added">+         }</span>
<span class="line-added">+         try {</span>
<span class="line-added">+             return params.getParameterSpec(specCls);</span>
<span class="line-added">+         } catch (InvalidParameterSpecException ex) {</span>
<span class="line-added">+             throw new ProviderException(ex);</span>
          }
      }
  
<span class="line-modified">!     public static Object[] getTypeAndParamSpec(AlgorithmId algid)</span>
              throws ProviderException {
  
<span class="line-added">+         requireNonNull(algid, &quot;AlgorithmId should not be null&quot;);</span>
<span class="line-added">+ </span>
<span class="line-added">+         Object[] result = new Object[2];</span>
<span class="line-added">+ </span>
<span class="line-added">+         String algName = algid.getName();</span>
          try {
<span class="line-modified">!             result[0] = KeyType.lookup(algName);</span>
          } catch (ProviderException pe) {
<span class="line-modified">!             // accommodate RSA keys encoded with various RSA signature oids</span>
<span class="line-modified">!             // for backward compatibility</span>
<span class="line-modified">!             if (algName.indexOf(&quot;RSA&quot;) != -1) {</span>
<span class="line-modified">!                 result[0] = KeyType.RSA;</span>
<span class="line-added">+             } else {</span>
<span class="line-added">+                 // pass it up</span>
<span class="line-added">+                 throw pe;</span>
<span class="line-added">+             }</span>
          }
<span class="line-added">+ </span>
<span class="line-added">+         result[1] = getParamSpec(algid.getParameters());</span>
<span class="line-added">+         return result;</span>
      }
  }
</pre>
<center><a href="RSAPublicKeyImpl.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="../ssl/Finished.java.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>