<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff src/java.base/share/classes/sun/security/rsa/RSAUtil.java</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
  </head>
<body>
<center><a href="RSAPublicKeyImpl.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="../ssl/Finished.java.udiff.html" target="_top">next &gt;</a></center>    <h2>src/java.base/share/classes/sun/security/rsa/RSAUtil.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -1,7 +1,7 @@</span>
  /*
<span class="udiff-line-modified-removed">-  * Copyright (c) 2018, Oracle and/or its affiliates. All rights reserved.</span>
<span class="udiff-line-modified-added">+  * Copyright (c) 2018, 2020, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.  Oracle designates this
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -38,125 +38,128 @@</span>
   * @since   11
   */
  public class RSAUtil {
  
      public enum KeyType {
<span class="udiff-line-modified-removed">-         RSA (&quot;RSA&quot;),</span>
<span class="udiff-line-modified-removed">-         PSS (&quot;RSASSA-PSS&quot;)</span>
<span class="udiff-line-modified-added">+         RSA (&quot;RSA&quot;, AlgorithmId.RSAEncryption_oid, null),</span>
<span class="udiff-line-modified-added">+         PSS (&quot;RSASSA-PSS&quot;, AlgorithmId.RSASSA_PSS_oid, PSSParameterSpec.class)</span>
          ;
  
<span class="udiff-line-modified-removed">-         private final String algo;</span>
<span class="udiff-line-modified-added">+         final String keyAlgo;</span>
<span class="udiff-line-added">+         final ObjectIdentifier oid;</span>
<span class="udiff-line-added">+         final Class&lt;? extends AlgorithmParameterSpec&gt; paramSpecCls;</span>
  
<span class="udiff-line-modified-removed">-         KeyType(String keyAlgo) {</span>
<span class="udiff-line-modified-removed">-             this.algo = keyAlgo;</span>
<span class="udiff-line-modified-added">+         KeyType(String keyAlgo, ObjectIdentifier oid,</span>
<span class="udiff-line-modified-added">+                 Class&lt;? extends AlgorithmParameterSpec&gt; paramSpecCls) {</span>
<span class="udiff-line-added">+             this.keyAlgo = keyAlgo;</span>
<span class="udiff-line-added">+             this.oid = oid;</span>
<span class="udiff-line-added">+             this.paramSpecCls = paramSpecCls;</span>
          }
<span class="udiff-line-modified-removed">-         public String keyAlgo() {</span>
<span class="udiff-line-modified-removed">-             return algo;</span>
<span class="udiff-line-modified-removed">-         }</span>
<span class="udiff-line-modified-removed">-         public static KeyType lookup(String name)</span>
<span class="udiff-line-modified-removed">-                 throws InvalidKeyException, ProviderException {</span>
<span class="udiff-line-modified-removed">-             if (name == null) {</span>
<span class="udiff-line-modified-removed">-                 throw new InvalidKeyException(&quot;Null key algorithm&quot;);</span>
<span class="udiff-line-modified-removed">-             }</span>
<span class="udiff-line-modified-removed">-             for (KeyType kt : KeyType.values()) {</span>
<span class="udiff-line-modified-removed">-                 if (kt.keyAlgo().equalsIgnoreCase(name)) {</span>
<span class="udiff-line-modified-removed">-                     return kt;</span>
<span class="udiff-line-modified-removed">-                 }</span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-modified-added">+         public static KeyType lookup(String name) throws ProviderException {</span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-modified-added">+             requireNonNull(name, &quot;Key algorithm should not be null&quot;);</span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-modified-added">+             // match loosely in order to work with 3rd party providers which</span>
<span class="udiff-line-modified-added">+             // may not follow the standard names</span>
<span class="udiff-line-modified-added">+             if (name.indexOf(&quot;PSS&quot;) != -1) {</span>
<span class="udiff-line-modified-added">+                 return PSS;</span>
<span class="udiff-line-modified-added">+             } else if (name.indexOf(&quot;RSA&quot;) != -1) {</span>
<span class="udiff-line-modified-added">+                 return RSA;</span>
<span class="udiff-line-modified-added">+             } else { // no match</span>
<span class="udiff-line-added">+                 throw new ProviderException(&quot;Unsupported algorithm &quot; + name);</span>
              }
<span class="udiff-line-removed">-             // no match</span>
<span class="udiff-line-removed">-             throw new ProviderException(&quot;Unsupported algorithm &quot; + name);</span>
          }
      }
  
<span class="udiff-line-modified-removed">-     public static void checkParamsAgainstType(KeyType type,</span>
<span class="udiff-line-modified-added">+     private static void requireNonNull(Object obj, String msg) {</span>
<span class="udiff-line-added">+         if (obj == null) throw new ProviderException(msg);</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     public static AlgorithmParameterSpec checkParamsAgainstType(KeyType type,</span>
              AlgorithmParameterSpec paramSpec) throws ProviderException {
<span class="udiff-line-modified-removed">-         switch (type) {</span>
<span class="udiff-line-modified-removed">-             case RSA:</span>
<span class="udiff-line-modified-removed">-                 if (paramSpec != null) {</span>
<span class="udiff-line-modified-removed">-                     throw new ProviderException(&quot;null params expected for &quot; +</span>
<span class="udiff-line-modified-removed">-                         type.keyAlgo());</span>
<span class="udiff-line-modified-removed">-                 }</span>
<span class="udiff-line-modified-removed">-                 break;</span>
<span class="udiff-line-modified-removed">-             case PSS:</span>
<span class="udiff-line-modified-removed">-                 if ((paramSpec != null) &amp;&amp;</span>
<span class="udiff-line-modified-removed">-                     !(paramSpec instanceof PSSParameterSpec)) {</span>
<span class="udiff-line-modified-removed">-                     throw new ProviderException</span>
<span class="udiff-line-modified-removed">-                         (&quot;PSSParmeterSpec expected for &quot; + type.keyAlgo());</span>
<span class="udiff-line-modified-removed">-                 }</span>
<span class="udiff-line-modified-removed">-                 break;</span>
<span class="udiff-line-modified-removed">-             default:</span>
<span class="udiff-line-modified-removed">-                 throw new ProviderException</span>
<span class="udiff-line-modified-removed">-                     (&quot;Unsupported RSA algorithm &quot; + type);</span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-modified-added">+         // currently no check for null parameter spec</span>
<span class="udiff-line-modified-added">+         // assumption is parameter spec is optional and can be null</span>
<span class="udiff-line-modified-added">+         if (paramSpec == null) return null;</span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-modified-added">+         Class&lt;? extends AlgorithmParameterSpec&gt; expCls = type.paramSpecCls;</span>
<span class="udiff-line-modified-added">+         if (expCls == null) {</span>
<span class="udiff-line-modified-added">+             throw new ProviderException(&quot;null params expected for &quot; +</span>
<span class="udiff-line-modified-added">+                     type.keyAlgo);</span>
<span class="udiff-line-modified-added">+         } else if (!expCls.isInstance(paramSpec)) {</span>
<span class="udiff-line-modified-added">+             throw new ProviderException</span>
<span class="udiff-line-modified-added">+                     (expCls + &quot; expected for &quot; + type.keyAlgo);</span>
<span class="udiff-line-modified-added">+         }</span>
<span class="udiff-line-modified-added">+         return paramSpec;</span>
<span class="udiff-line-modified-added">+     }</span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-modified-added">+     public static AlgorithmParameters getParams(KeyType type,</span>
<span class="udiff-line-added">+             AlgorithmParameterSpec spec) throws ProviderException {</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         if (spec == null) return null;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         try {</span>
<span class="udiff-line-added">+             AlgorithmParameters params =</span>
<span class="udiff-line-added">+                     AlgorithmParameters.getInstance(type.keyAlgo);</span>
<span class="udiff-line-added">+             params.init(spec);</span>
<span class="udiff-line-added">+             return params;</span>
<span class="udiff-line-added">+         } catch (NoSuchAlgorithmException | InvalidParameterSpecException ex) {</span>
<span class="udiff-line-added">+             throw new ProviderException(ex);</span>
          }
      }
  
      public static AlgorithmId createAlgorithmId(KeyType type,
              AlgorithmParameterSpec paramSpec) throws ProviderException {
  
          checkParamsAgainstType(type, paramSpec);
  
<span class="udiff-line-modified-removed">-         ObjectIdentifier oid = null;</span>
<span class="udiff-line-modified-removed">-         AlgorithmParameters params = null;</span>
<span class="udiff-line-modified-removed">-         try {</span>
<span class="udiff-line-removed">-             switch (type) {</span>
<span class="udiff-line-removed">-                 case RSA:</span>
<span class="udiff-line-removed">-                     oid = AlgorithmId.RSAEncryption_oid;</span>
<span class="udiff-line-removed">-                     break;</span>
<span class="udiff-line-removed">-                 case PSS:</span>
<span class="udiff-line-removed">-                     if (paramSpec != null) {</span>
<span class="udiff-line-removed">-                         params = AlgorithmParameters.getInstance(type.keyAlgo());</span>
<span class="udiff-line-removed">-                         params.init(paramSpec);</span>
<span class="udiff-line-removed">-                     }</span>
<span class="udiff-line-removed">-                     oid = AlgorithmId.RSASSA_PSS_oid;</span>
<span class="udiff-line-removed">-                     break;</span>
<span class="udiff-line-removed">-                 default:</span>
<span class="udiff-line-removed">-                     throw new ProviderException</span>
<span class="udiff-line-removed">-                         (&quot;Unsupported RSA algorithm &quot;  + type);</span>
<span class="udiff-line-removed">-             }</span>
<span class="udiff-line-removed">-             AlgorithmId result;</span>
<span class="udiff-line-removed">-             if (params == null) {</span>
<span class="udiff-line-removed">-                 result = new AlgorithmId(oid);</span>
<span class="udiff-line-removed">-             } else {</span>
<span class="udiff-line-removed">-                 result = new AlgorithmId(oid, params);</span>
<span class="udiff-line-removed">-             }</span>
<span class="udiff-line-removed">-             return result;</span>
<span class="udiff-line-removed">-         } catch (NoSuchAlgorithmException | InvalidParameterSpecException e) {</span>
<span class="udiff-line-removed">-             // should not happen</span>
<span class="udiff-line-removed">-             throw new ProviderException(e);</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-modified-added">+         ObjectIdentifier oid = type.oid;</span>
<span class="udiff-line-modified-added">+         AlgorithmParameters params = getParams(type, paramSpec);</span>
<span class="udiff-line-modified-added">+         return new AlgorithmId(oid, params);</span>
      }
  
<span class="udiff-line-modified-removed">-     public static AlgorithmParameterSpec getParamSpec(AlgorithmId algid)</span>
<span class="udiff-line-modified-removed">-             throws ProviderException {</span>
<span class="udiff-line-modified-removed">-         if (algid == null) {</span>
<span class="udiff-line-modified-removed">-             throw new ProviderException(&quot;AlgorithmId should not be null&quot;);</span>
<span class="udiff-line-modified-added">+     public static AlgorithmParameterSpec getParamSpec(</span>
<span class="udiff-line-modified-added">+             AlgorithmParameters params) throws ProviderException {</span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-modified-added">+         if (params == null) return null;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         String algName = params.getAlgorithm();</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         KeyType type = KeyType.lookup(algName);</span>
<span class="udiff-line-added">+         Class&lt;? extends AlgorithmParameterSpec&gt; specCls = type.paramSpecCls;</span>
<span class="udiff-line-added">+         if (specCls == null) {</span>
<span class="udiff-line-added">+             throw new ProviderException(&quot;No params accepted for &quot; +</span>
<span class="udiff-line-added">+                     type.keyAlgo);</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+         try {</span>
<span class="udiff-line-added">+             return params.getParameterSpec(specCls);</span>
<span class="udiff-line-added">+         } catch (InvalidParameterSpecException ex) {</span>
<span class="udiff-line-added">+             throw new ProviderException(ex);</span>
          }
<span class="udiff-line-removed">-         return getParamSpec(algid.getParameters());</span>
      }
  
<span class="udiff-line-modified-removed">-     public static AlgorithmParameterSpec getParamSpec(AlgorithmParameters params)</span>
<span class="udiff-line-modified-added">+     public static Object[] getTypeAndParamSpec(AlgorithmId algid)</span>
              throws ProviderException {
<span class="udiff-line-removed">-         if (params == null) return null;</span>
  
<span class="udiff-line-added">+         requireNonNull(algid, &quot;AlgorithmId should not be null&quot;);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         Object[] result = new Object[2];</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         String algName = algid.getName();</span>
          try {
<span class="udiff-line-modified-removed">-             String algName = params.getAlgorithm();</span>
<span class="udiff-line-removed">-             KeyType type = KeyType.lookup(algName);</span>
<span class="udiff-line-removed">-             Class&lt;? extends AlgorithmParameterSpec&gt; specCls;</span>
<span class="udiff-line-removed">-             switch (type) {</span>
<span class="udiff-line-removed">-                 case RSA:</span>
<span class="udiff-line-removed">-                     throw new ProviderException(&quot;No params accepted for &quot; +</span>
<span class="udiff-line-removed">-                         type.keyAlgo());</span>
<span class="udiff-line-removed">-                 case PSS:</span>
<span class="udiff-line-removed">-                     specCls = PSSParameterSpec.class;</span>
<span class="udiff-line-removed">-                     break;</span>
<span class="udiff-line-removed">-                 default:</span>
<span class="udiff-line-removed">-                     throw new ProviderException(&quot;Unsupported RSA algorithm: &quot; + algName);</span>
<span class="udiff-line-removed">-             }</span>
<span class="udiff-line-removed">-             return params.getParameterSpec(specCls);</span>
<span class="udiff-line-modified-added">+             result[0] = KeyType.lookup(algName);</span>
          } catch (ProviderException pe) {
<span class="udiff-line-modified-removed">-             // pass it up</span>
<span class="udiff-line-modified-removed">-             throw pe;</span>
<span class="udiff-line-modified-removed">-         } catch (Exception e) {</span>
<span class="udiff-line-modified-removed">-             throw new ProviderException(e);</span>
<span class="udiff-line-modified-added">+             // accommodate RSA keys encoded with various RSA signature oids</span>
<span class="udiff-line-modified-added">+             // for backward compatibility</span>
<span class="udiff-line-modified-added">+             if (algName.indexOf(&quot;RSA&quot;) != -1) {</span>
<span class="udiff-line-modified-added">+                 result[0] = KeyType.RSA;</span>
<span class="udiff-line-added">+             } else {</span>
<span class="udiff-line-added">+                 // pass it up</span>
<span class="udiff-line-added">+                 throw pe;</span>
<span class="udiff-line-added">+             }</span>
          }
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         result[1] = getParamSpec(algid.getParameters());</span>
<span class="udiff-line-added">+         return result;</span>
      }
  }
</pre>
<center><a href="RSAPublicKeyImpl.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="../ssl/Finished.java.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>