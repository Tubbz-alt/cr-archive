<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/java.base/share/classes/sun/security/rsa/RSAKeyPairGenerator.java</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
  </head>
<body>
<center><a href="RSAKeyFactory.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="RSAPrivateCrtKeyImpl.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/java.base/share/classes/sun/security/rsa/RSAKeyPairGenerator.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 15  * accompanied this code).
 16  *
 17  * You should have received a copy of the GNU General Public License version
 18  * 2 along with this work; if not, write to the Free Software Foundation,
 19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 20  *
 21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 22  * or visit www.oracle.com if you need additional information or have any
 23  * questions.
 24  */
 25 
 26 package sun.security.rsa;
 27 
 28 import java.math.BigInteger;
 29 
 30 import java.security.*;
 31 import java.security.spec.AlgorithmParameterSpec;
 32 import java.security.spec.RSAKeyGenParameterSpec;
 33 
 34 import sun.security.jca.JCAUtil;


 35 import static sun.security.util.SecurityProviderConstants.DEF_RSA_KEY_SIZE;
 36 import static sun.security.util.SecurityProviderConstants.DEF_RSASSA_PSS_KEY_SIZE;
<span class="line-removed"> 37 import sun.security.x509.AlgorithmId;</span>
<span class="line-removed"> 38 import static sun.security.rsa.RSAUtil.KeyType;</span>
 39 
 40 /**
 41  * RSA keypair generation. Standard algorithm, minimum key length 512 bit.
 42  * We generate two random primes until we find two where phi is relative
 43  * prime to the public exponent. Default exponent is 65537. It has only bit 0
 44  * and bit 4 set, which makes it particularly efficient.
 45  *
 46  * @since   1.5
 47  * @author  Andreas Sterbenz
 48  */
 49 public abstract class RSAKeyPairGenerator extends KeyPairGeneratorSpi {
 50 
 51     // public exponent to use
 52     private BigInteger publicExponent;
 53 
 54     // size of the key to generate, &gt;= RSAKeyFactory.MIN_MODLEN
 55     private int keySize;
 56 
 57     private final KeyType type;
<span class="line-modified"> 58     private AlgorithmId rsaId;</span>
 59 
 60     // PRNG to use
 61     private SecureRandom random;
 62 
 63     RSAKeyPairGenerator(KeyType type, int defKeySize) {
 64         this.type = type;
 65         // initialize to default in case the app does not call initialize()
 66         initialize(defKeySize, null);
 67     }
 68 
 69     // initialize the generator. See JCA doc
 70     public void initialize(int keySize, SecureRandom random) {
 71         try {
 72             initialize(new RSAKeyGenParameterSpec(keySize,
 73                     RSAKeyGenParameterSpec.F4), random);
 74         } catch (InvalidAlgorithmParameterException iape) {
 75             throw new InvalidParameterException(iape.getMessage());
 76         }
 77     }
 78 
</pre>
<hr />
<pre>
 99             if (!tmpPublicExponent.testBit(0)) {
100                 throw new InvalidAlgorithmParameterException
101                         (&quot;Public exponent must be an odd number&quot;);
102             }
103             if (tmpPublicExponent.bitLength() &gt; tmpKeySize) {
104                 throw new InvalidAlgorithmParameterException
105                         (&quot;Public exponent must be smaller than key size&quot;);
106             }
107         }
108 
109         // do not allow unreasonably large key sizes, probably user error
110         try {
111             RSAKeyFactory.checkKeyLengths(tmpKeySize, tmpPublicExponent,
112                 512, 64 * 1024);
113         } catch (InvalidKeyException e) {
114             throw new InvalidAlgorithmParameterException(
115                 &quot;Invalid key sizes&quot;, e);
116         }
117 
118         try {
<span class="line-modified">119             this.rsaId = RSAUtil.createAlgorithmId(type, tmpParams);</span>
120         } catch (ProviderException e) {
121             throw new InvalidAlgorithmParameterException(
122                 &quot;Invalid key parameters&quot;, e);
123         }
124 
125         this.keySize = tmpKeySize;
126         this.publicExponent = tmpPublicExponent;
127         this.random = random;
128     }
129 
130     // generate the keypair. See JCA doc
131     public KeyPair generateKeyPair() {
132         // accommodate odd key sizes in case anybody wants to use them
133         int lp = (keySize + 1) &gt;&gt; 1;
134         int lq = keySize - lp;
135         if (random == null) {
136             random = JCAUtil.getSecureRandom();
137         }
138         BigInteger e = publicExponent;
139         while (true) {
</pre>
<hr />
<pre>
160             BigInteger q1 = q.subtract(BigInteger.ONE);
161             BigInteger phi = p1.multiply(q1);
162             // generate new p and q until they work. typically
163             // the first try will succeed when using F4
164             if (e.gcd(phi).equals(BigInteger.ONE) == false) {
165                 continue;
166             }
167 
168             // private exponent d is the inverse of e mod phi
169             BigInteger d = e.modInverse(phi);
170 
171             // 1st prime exponent pe = d mod (p - 1)
172             BigInteger pe = d.mod(p1);
173             // 2nd prime exponent qe = d mod (q - 1)
174             BigInteger qe = d.mod(q1);
175 
176             // crt coefficient coeff is the inverse of q mod p
177             BigInteger coeff = q.modInverse(p);
178 
179             try {
<span class="line-modified">180                 PublicKey publicKey = new RSAPublicKeyImpl(rsaId, n, e);</span>
<span class="line-modified">181                 PrivateKey privateKey = new RSAPrivateCrtKeyImpl(</span>
<span class="line-modified">182                     rsaId, n, e, d, p, q, pe, qe, coeff);</span>

183                 return new KeyPair(publicKey, privateKey);
184             } catch (InvalidKeyException exc) {
185                 // invalid key exception only thrown for keys &lt; 512 bit,
186                 // will not happen here
187                 throw new RuntimeException(exc);
188             }
189         }
190     }
191 
192     public static final class Legacy extends RSAKeyPairGenerator {
193         public Legacy() {
194             super(KeyType.RSA, DEF_RSA_KEY_SIZE);
195         }
196     }
197 
198     public static final class PSS extends RSAKeyPairGenerator {
199         public PSS() {
200             super(KeyType.PSS, DEF_RSASSA_PSS_KEY_SIZE);
201         }
202     }
</pre>
</td>
<td>
<hr />
<pre>
 15  * accompanied this code).
 16  *
 17  * You should have received a copy of the GNU General Public License version
 18  * 2 along with this work; if not, write to the Free Software Foundation,
 19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 20  *
 21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 22  * or visit www.oracle.com if you need additional information or have any
 23  * questions.
 24  */
 25 
 26 package sun.security.rsa;
 27 
 28 import java.math.BigInteger;
 29 
 30 import java.security.*;
 31 import java.security.spec.AlgorithmParameterSpec;
 32 import java.security.spec.RSAKeyGenParameterSpec;
 33 
 34 import sun.security.jca.JCAUtil;
<span class="line-added"> 35 import sun.security.rsa.RSAUtil.KeyType;</span>
<span class="line-added"> 36 </span>
 37 import static sun.security.util.SecurityProviderConstants.DEF_RSA_KEY_SIZE;
 38 import static sun.security.util.SecurityProviderConstants.DEF_RSASSA_PSS_KEY_SIZE;


 39 
 40 /**
 41  * RSA keypair generation. Standard algorithm, minimum key length 512 bit.
 42  * We generate two random primes until we find two where phi is relative
 43  * prime to the public exponent. Default exponent is 65537. It has only bit 0
 44  * and bit 4 set, which makes it particularly efficient.
 45  *
 46  * @since   1.5
 47  * @author  Andreas Sterbenz
 48  */
 49 public abstract class RSAKeyPairGenerator extends KeyPairGeneratorSpi {
 50 
 51     // public exponent to use
 52     private BigInteger publicExponent;
 53 
 54     // size of the key to generate, &gt;= RSAKeyFactory.MIN_MODLEN
 55     private int keySize;
 56 
 57     private final KeyType type;
<span class="line-modified"> 58     private AlgorithmParameterSpec keyParams;</span>
 59 
 60     // PRNG to use
 61     private SecureRandom random;
 62 
 63     RSAKeyPairGenerator(KeyType type, int defKeySize) {
 64         this.type = type;
 65         // initialize to default in case the app does not call initialize()
 66         initialize(defKeySize, null);
 67     }
 68 
 69     // initialize the generator. See JCA doc
 70     public void initialize(int keySize, SecureRandom random) {
 71         try {
 72             initialize(new RSAKeyGenParameterSpec(keySize,
 73                     RSAKeyGenParameterSpec.F4), random);
 74         } catch (InvalidAlgorithmParameterException iape) {
 75             throw new InvalidParameterException(iape.getMessage());
 76         }
 77     }
 78 
</pre>
<hr />
<pre>
 99             if (!tmpPublicExponent.testBit(0)) {
100                 throw new InvalidAlgorithmParameterException
101                         (&quot;Public exponent must be an odd number&quot;);
102             }
103             if (tmpPublicExponent.bitLength() &gt; tmpKeySize) {
104                 throw new InvalidAlgorithmParameterException
105                         (&quot;Public exponent must be smaller than key size&quot;);
106             }
107         }
108 
109         // do not allow unreasonably large key sizes, probably user error
110         try {
111             RSAKeyFactory.checkKeyLengths(tmpKeySize, tmpPublicExponent,
112                 512, 64 * 1024);
113         } catch (InvalidKeyException e) {
114             throw new InvalidAlgorithmParameterException(
115                 &quot;Invalid key sizes&quot;, e);
116         }
117 
118         try {
<span class="line-modified">119             this.keyParams = RSAUtil.checkParamsAgainstType(type, tmpParams);</span>
120         } catch (ProviderException e) {
121             throw new InvalidAlgorithmParameterException(
122                 &quot;Invalid key parameters&quot;, e);
123         }
124 
125         this.keySize = tmpKeySize;
126         this.publicExponent = tmpPublicExponent;
127         this.random = random;
128     }
129 
130     // generate the keypair. See JCA doc
131     public KeyPair generateKeyPair() {
132         // accommodate odd key sizes in case anybody wants to use them
133         int lp = (keySize + 1) &gt;&gt; 1;
134         int lq = keySize - lp;
135         if (random == null) {
136             random = JCAUtil.getSecureRandom();
137         }
138         BigInteger e = publicExponent;
139         while (true) {
</pre>
<hr />
<pre>
160             BigInteger q1 = q.subtract(BigInteger.ONE);
161             BigInteger phi = p1.multiply(q1);
162             // generate new p and q until they work. typically
163             // the first try will succeed when using F4
164             if (e.gcd(phi).equals(BigInteger.ONE) == false) {
165                 continue;
166             }
167 
168             // private exponent d is the inverse of e mod phi
169             BigInteger d = e.modInverse(phi);
170 
171             // 1st prime exponent pe = d mod (p - 1)
172             BigInteger pe = d.mod(p1);
173             // 2nd prime exponent qe = d mod (q - 1)
174             BigInteger qe = d.mod(q1);
175 
176             // crt coefficient coeff is the inverse of q mod p
177             BigInteger coeff = q.modInverse(p);
178 
179             try {
<span class="line-modified">180                 PublicKey publicKey = new RSAPublicKeyImpl(type, keyParams,</span>
<span class="line-modified">181                         n, e);</span>
<span class="line-modified">182                 PrivateKey privateKey = new RSAPrivateCrtKeyImpl(type,</span>
<span class="line-added">183                         keyParams, n, e, d, p, q, pe, qe, coeff);</span>
184                 return new KeyPair(publicKey, privateKey);
185             } catch (InvalidKeyException exc) {
186                 // invalid key exception only thrown for keys &lt; 512 bit,
187                 // will not happen here
188                 throw new RuntimeException(exc);
189             }
190         }
191     }
192 
193     public static final class Legacy extends RSAKeyPairGenerator {
194         public Legacy() {
195             super(KeyType.RSA, DEF_RSA_KEY_SIZE);
196         }
197     }
198 
199     public static final class PSS extends RSAKeyPairGenerator {
200         public PSS() {
201             super(KeyType.PSS, DEF_RSASSA_PSS_KEY_SIZE);
202         }
203     }
</pre>
</td>
</tr>
</table>
<center><a href="RSAKeyFactory.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="RSAPrivateCrtKeyImpl.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>