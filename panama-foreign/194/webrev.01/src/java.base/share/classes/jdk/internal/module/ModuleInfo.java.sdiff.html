<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/java.base/share/classes/jdk/internal/module/ModuleInfo.java</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
  </head>
<body>
<center><a href="../misc/VM.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="../org/objectweb/asm/ClassReader.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/java.base/share/classes/jdk/internal/module/ModuleInfo.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  32 import java.io.InputStream;
  33 import java.io.UncheckedIOException;
  34 import java.lang.module.InvalidModuleDescriptorException;
  35 import java.lang.module.ModuleDescriptor;
  36 import java.lang.module.ModuleDescriptor.Builder;
  37 import java.lang.module.ModuleDescriptor.Requires;
  38 import java.lang.module.ModuleDescriptor.Exports;
  39 import java.lang.module.ModuleDescriptor.Opens;
  40 import java.nio.ByteBuffer;
  41 import java.nio.BufferUnderflowException;
  42 import java.util.ArrayList;
  43 import java.util.HashMap;
  44 import java.util.HashSet;
  45 import java.util.List;
  46 import java.util.Map;
  47 import java.util.Set;
  48 import java.util.function.Supplier;
  49 
  50 import jdk.internal.access.JavaLangModuleAccess;
  51 import jdk.internal.access.SharedSecrets;

  52 
  53 import static jdk.internal.module.ClassFileConstants.*;
  54 
  55 
  56 /**
  57  * Read module information from a {@code module-info} class file.
  58  *
  59  * @implNote The rationale for the hand-coded reader is startup performance
  60  * and fine control over the throwing of InvalidModuleDescriptorException.
  61  */
  62 
  63 public final class ModuleInfo {
  64 
<span class="line-removed">  65     private final int JAVA_MIN_SUPPORTED_VERSION = 53;</span>
<span class="line-removed">  66     private final int JAVA_MAX_SUPPORTED_VERSION = 59;</span>
<span class="line-removed">  67 </span>
  68     private static final JavaLangModuleAccess JLMA
  69         = SharedSecrets.getJavaLangModuleAccess();
  70 
  71     // supplies the set of packages when ModulePackages attribute not present
  72     private final Supplier&lt;Set&lt;String&gt;&gt; packageFinder;
  73 
  74     // indicates if the ModuleHashes attribute should be parsed
  75     private final boolean parseHashes;
  76 
  77     private ModuleInfo(Supplier&lt;Set&lt;String&gt;&gt; pf, boolean ph) {
  78         packageFinder = pf;
  79         parseHashes = ph;
  80     }
  81 
  82     private ModuleInfo(Supplier&lt;Set&lt;String&gt;&gt; pf) {
  83         this(pf, true);
  84     }
  85 
  86     /**
  87      * A holder class for the ModuleDescriptor that is created by reading the
</pre>
<hr />
<pre>
 173         }
 174     }
 175 
 176     /**
 177      * Reads the input as a module-info class file.
 178      *
 179      * @throws IOException
 180      * @throws InvalidModuleDescriptorException
 181      * @throws IllegalArgumentException if thrown by the ModuleDescriptor.Builder
 182      *         because an identifier is not a legal Java identifier, duplicate
 183      *         exports, and many other reasons
 184      */
 185     private Attributes doRead(DataInput in) throws IOException {
 186 
 187         int magic = in.readInt();
 188         if (magic != 0xCAFEBABE)
 189             throw invalidModuleDescriptor(&quot;Bad magic number&quot;);
 190 
 191         int minor_version = in.readUnsignedShort();
 192         int major_version = in.readUnsignedShort();
<span class="line-modified"> 193         if (major_version &lt; JAVA_MIN_SUPPORTED_VERSION ||</span>
<span class="line-removed"> 194                 major_version &gt; JAVA_MAX_SUPPORTED_VERSION) {</span>
 195             throw invalidModuleDescriptor(&quot;Unsupported major.minor version &quot;
 196                                           + major_version + &quot;.&quot; + minor_version);
 197         }
 198 
 199         ConstantPool cpool = new ConstantPool(in);
 200 
 201         int access_flags = in.readUnsignedShort();
 202         if (access_flags != ACC_MODULE)
 203             throw invalidModuleDescriptor(&quot;access_flags should be ACC_MODULE&quot;);
 204 
 205         int this_class = in.readUnsignedShort();
 206         String mn = cpool.getClassName(this_class);
 207         if (!&quot;module-info&quot;.equals(mn))
 208             throw invalidModuleDescriptor(&quot;this_class should be module-info&quot;);
 209 
 210         int super_class = in.readUnsignedShort();
 211         if (super_class &gt; 0)
 212             throw invalidModuleDescriptor(&quot;bad #super_class&quot;);
 213 
 214         int interfaces_count = in.readUnsignedShort();
</pre>
</td>
<td>
<hr />
<pre>
  32 import java.io.InputStream;
  33 import java.io.UncheckedIOException;
  34 import java.lang.module.InvalidModuleDescriptorException;
  35 import java.lang.module.ModuleDescriptor;
  36 import java.lang.module.ModuleDescriptor.Builder;
  37 import java.lang.module.ModuleDescriptor.Requires;
  38 import java.lang.module.ModuleDescriptor.Exports;
  39 import java.lang.module.ModuleDescriptor.Opens;
  40 import java.nio.ByteBuffer;
  41 import java.nio.BufferUnderflowException;
  42 import java.util.ArrayList;
  43 import java.util.HashMap;
  44 import java.util.HashSet;
  45 import java.util.List;
  46 import java.util.Map;
  47 import java.util.Set;
  48 import java.util.function.Supplier;
  49 
  50 import jdk.internal.access.JavaLangModuleAccess;
  51 import jdk.internal.access.SharedSecrets;
<span class="line-added">  52 import jdk.internal.misc.VM;</span>
  53 
  54 import static jdk.internal.module.ClassFileConstants.*;
  55 
  56 
  57 /**
  58  * Read module information from a {@code module-info} class file.
  59  *
  60  * @implNote The rationale for the hand-coded reader is startup performance
  61  * and fine control over the throwing of InvalidModuleDescriptorException.
  62  */
  63 
  64 public final class ModuleInfo {
  65 



  66     private static final JavaLangModuleAccess JLMA
  67         = SharedSecrets.getJavaLangModuleAccess();
  68 
  69     // supplies the set of packages when ModulePackages attribute not present
  70     private final Supplier&lt;Set&lt;String&gt;&gt; packageFinder;
  71 
  72     // indicates if the ModuleHashes attribute should be parsed
  73     private final boolean parseHashes;
  74 
  75     private ModuleInfo(Supplier&lt;Set&lt;String&gt;&gt; pf, boolean ph) {
  76         packageFinder = pf;
  77         parseHashes = ph;
  78     }
  79 
  80     private ModuleInfo(Supplier&lt;Set&lt;String&gt;&gt; pf) {
  81         this(pf, true);
  82     }
  83 
  84     /**
  85      * A holder class for the ModuleDescriptor that is created by reading the
</pre>
<hr />
<pre>
 171         }
 172     }
 173 
 174     /**
 175      * Reads the input as a module-info class file.
 176      *
 177      * @throws IOException
 178      * @throws InvalidModuleDescriptorException
 179      * @throws IllegalArgumentException if thrown by the ModuleDescriptor.Builder
 180      *         because an identifier is not a legal Java identifier, duplicate
 181      *         exports, and many other reasons
 182      */
 183     private Attributes doRead(DataInput in) throws IOException {
 184 
 185         int magic = in.readInt();
 186         if (magic != 0xCAFEBABE)
 187             throw invalidModuleDescriptor(&quot;Bad magic number&quot;);
 188 
 189         int minor_version = in.readUnsignedShort();
 190         int major_version = in.readUnsignedShort();
<span class="line-modified"> 191         if (!VM.isSupportedModuleDescriptorVersion(major_version, minor_version)) {</span>

 192             throw invalidModuleDescriptor(&quot;Unsupported major.minor version &quot;
 193                                           + major_version + &quot;.&quot; + minor_version);
 194         }
 195 
 196         ConstantPool cpool = new ConstantPool(in);
 197 
 198         int access_flags = in.readUnsignedShort();
 199         if (access_flags != ACC_MODULE)
 200             throw invalidModuleDescriptor(&quot;access_flags should be ACC_MODULE&quot;);
 201 
 202         int this_class = in.readUnsignedShort();
 203         String mn = cpool.getClassName(this_class);
 204         if (!&quot;module-info&quot;.equals(mn))
 205             throw invalidModuleDescriptor(&quot;this_class should be module-info&quot;);
 206 
 207         int super_class = in.readUnsignedShort();
 208         if (super_class &gt; 0)
 209             throw invalidModuleDescriptor(&quot;bad #super_class&quot;);
 210 
 211         int interfaces_count = in.readUnsignedShort();
</pre>
</td>
</tr>
</table>
<center><a href="../misc/VM.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="../org/objectweb/asm/ClassReader.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>