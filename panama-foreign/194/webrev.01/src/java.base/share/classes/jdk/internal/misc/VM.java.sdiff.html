<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/java.base/share/classes/jdk/internal/misc/VM.java</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
  </head>
<body>
<center><a href="../PreviewFeature.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="../module/ModuleInfo.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/java.base/share/classes/jdk/internal/misc/VM.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 10  *
 11  * This code is distributed in the hope that it will be useful, but WITHOUT
 12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 14  * version 2 for more details (a copy is included in the LICENSE file that
 15  * accompanied this code).
 16  *
 17  * You should have received a copy of the GNU General Public License version
 18  * 2 along with this work; if not, write to the Free Software Foundation,
 19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 20  *
 21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 22  * or visit www.oracle.com if you need additional information or have any
 23  * questions.
 24  */
 25 
 26 package jdk.internal.misc;
 27 
 28 import static java.lang.Thread.State.*;
 29 

 30 import java.util.ArrayList;
 31 import java.util.Collections;
 32 import java.util.List;
 33 import java.util.Map;
<span class="line-removed"> 34 import java.util.Properties;</span>
 35 
 36 import jdk.internal.access.SharedSecrets;
 37 
 38 import sun.nio.ch.FileChannelImpl;
 39 
 40 public class VM {
 41 
 42     // the init level when the VM is fully initialized
 43     private static final int JAVA_LANG_SYSTEM_INITED     = 1;
 44     private static final int MODULE_SYSTEM_INITED        = 2;
 45     private static final int SYSTEM_LOADER_INITIALIZING  = 3;
 46     private static final int SYSTEM_BOOTED               = 4;
 47     private static final int SYSTEM_SHUTDOWN             = 5;
 48 
<span class="line-removed"> 49 </span>
 50     // 0, 1, 2, ...
 51     private static volatile int initLevel;
 52     private static final Object lock = new Object();
 53 
 54     /**
 55      * Sets the init level.
 56      *
 57      * @see java.lang.System#initPhase1
 58      * @see java.lang.System#initPhase2
 59      * @see java.lang.System#initPhase3
 60      */
 61     public static void initLevel(int value) {
 62         synchronized (lock) {
 63             if (value &lt;= initLevel || value &gt; SYSTEM_SHUTDOWN)
 64                 throw new InternalError(&quot;Bad level: &quot; + value);
 65             initLevel = value;
 66             lock.notifyAll();
 67         }
 68     }
 69 
</pre>
<hr />
<pre>
131 
132     // Returns the maximum amount of allocatable direct buffer memory.
133     // The directMemory variable is initialized during system initialization
134     // in the saveAndRemoveProperties method.
135     //
136     public static long maxDirectMemory() {
137         return directMemory;
138     }
139 
140     // User-controllable flag that determines if direct buffers should be page
141     // aligned. The &quot;-XX:+PageAlignDirectMemory&quot; option can be used to force
142     // buffers, allocated by ByteBuffer.allocateDirect, to be page aligned.
143     private static boolean pageAlignDirectMemory;
144 
145     // Returns {@code true} if the direct buffers should be page aligned. This
146     // variable is initialized by saveAndRemoveProperties.
147     public static boolean isDirectMemoryPageAligned() {
148         return pageAlignDirectMemory;
149     }
150 







































151     /**
152      * Returns true if the given class loader is the bootstrap class loader
153      * or the platform class loader.
154      */
155     public static boolean isSystemDomainLoader(ClassLoader loader) {
156         return loader == null || loader == ClassLoader.getPlatformClassLoader();
157     }
158 
159     /**
160      * Returns the system property of the specified key saved at
161      * system initialization time.  This method should only be used
162      * for the system properties that are not changed during runtime.
163      *
164      * Note that the saved system properties do not include
165      * the ones set by java.lang.VersionProps.init().
166      */
167     public static String getSavedProperty(String key) {
168         if (savedProps == null)
169             throw new IllegalStateException(&quot;Not yet initialized&quot;);
170 
</pre>
<hr />
<pre>
205         // Set the maximum amount of direct memory.  This value is controlled
206         // by the vm option -XX:MaxDirectMemorySize=&lt;size&gt;.
207         // The maximum amount of allocatable direct buffer memory (in bytes)
208         // from the system property sun.nio.MaxDirectMemorySize set by the VM.
209         // If not set or set to -1, the max memory will be used
210         // The system property will be removed.
211         String s = props.get(&quot;sun.nio.MaxDirectMemorySize&quot;);
212         if (s == null || s.isEmpty() || s.equals(&quot;-1&quot;)) {
213             // -XX:MaxDirectMemorySize not given, take default
214             directMemory = Runtime.getRuntime().maxMemory();
215         } else {
216             long l = Long.parseLong(s);
217             if (l &gt; -1)
218                 directMemory = l;
219         }
220 
221         // Check if direct buffers should be page aligned
222         s = props.get(&quot;sun.nio.PageAlignDirectMemory&quot;);
223         if (&quot;true&quot;.equals(s))
224             pageAlignDirectMemory = true;









225     }
226 
227     // Initialize any miscellaneous operating system settings that need to be
228     // set for the class libraries.
229     //
230     public static void initializeOSEnvironment() {
231         if (initLevel() == 0) {
232             OSEnvironment.initialize();
233         }
234     }
235 
236     /* Current count of objects pending for finalization */
237     private static volatile int finalRefCount;
238 
239     /* Peak count of objects pending for finalization */
240     private static volatile int peakFinalRefCount;
241 
242     /*
243      * Gets the number of objects pending for finalization.
244      *
</pre>
</td>
<td>
<hr />
<pre>
 10  *
 11  * This code is distributed in the hope that it will be useful, but WITHOUT
 12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 14  * version 2 for more details (a copy is included in the LICENSE file that
 15  * accompanied this code).
 16  *
 17  * You should have received a copy of the GNU General Public License version
 18  * 2 along with this work; if not, write to the Free Software Foundation,
 19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 20  *
 21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 22  * or visit www.oracle.com if you need additional information or have any
 23  * questions.
 24  */
 25 
 26 package jdk.internal.misc;
 27 
 28 import static java.lang.Thread.State.*;
 29 
<span class="line-added"> 30 import java.text.NumberFormat;</span>
 31 import java.util.ArrayList;
 32 import java.util.Collections;
 33 import java.util.List;
 34 import java.util.Map;

 35 
 36 import jdk.internal.access.SharedSecrets;
 37 
 38 import sun.nio.ch.FileChannelImpl;
 39 
 40 public class VM {
 41 
 42     // the init level when the VM is fully initialized
 43     private static final int JAVA_LANG_SYSTEM_INITED     = 1;
 44     private static final int MODULE_SYSTEM_INITED        = 2;
 45     private static final int SYSTEM_LOADER_INITIALIZING  = 3;
 46     private static final int SYSTEM_BOOTED               = 4;
 47     private static final int SYSTEM_SHUTDOWN             = 5;
 48 

 49     // 0, 1, 2, ...
 50     private static volatile int initLevel;
 51     private static final Object lock = new Object();
 52 
 53     /**
 54      * Sets the init level.
 55      *
 56      * @see java.lang.System#initPhase1
 57      * @see java.lang.System#initPhase2
 58      * @see java.lang.System#initPhase3
 59      */
 60     public static void initLevel(int value) {
 61         synchronized (lock) {
 62             if (value &lt;= initLevel || value &gt; SYSTEM_SHUTDOWN)
 63                 throw new InternalError(&quot;Bad level: &quot; + value);
 64             initLevel = value;
 65             lock.notifyAll();
 66         }
 67     }
 68 
</pre>
<hr />
<pre>
130 
131     // Returns the maximum amount of allocatable direct buffer memory.
132     // The directMemory variable is initialized during system initialization
133     // in the saveAndRemoveProperties method.
134     //
135     public static long maxDirectMemory() {
136         return directMemory;
137     }
138 
139     // User-controllable flag that determines if direct buffers should be page
140     // aligned. The &quot;-XX:+PageAlignDirectMemory&quot; option can be used to force
141     // buffers, allocated by ByteBuffer.allocateDirect, to be page aligned.
142     private static boolean pageAlignDirectMemory;
143 
144     // Returns {@code true} if the direct buffers should be page aligned. This
145     // variable is initialized by saveAndRemoveProperties.
146     public static boolean isDirectMemoryPageAligned() {
147         return pageAlignDirectMemory;
148     }
149 
<span class="line-added">150     private static int classFileMajorVersion;</span>
<span class="line-added">151     private static int classFileMinorVersion;</span>
<span class="line-added">152     private static final int PREVIEW_MINOR_VERSION = 65535;</span>
<span class="line-added">153 </span>
<span class="line-added">154     /**</span>
<span class="line-added">155      * Tests if the given version is a supported {@code class}</span>
<span class="line-added">156      * file version.</span>
<span class="line-added">157      *</span>
<span class="line-added">158      * A {@code class} file depends on the preview features of Java SE {@code N}</span>
<span class="line-added">159      * if the major version is {@code N} and the minor version is 65535.</span>
<span class="line-added">160      * This method returns {@code true} if the given version is a supported</span>
<span class="line-added">161      * {@code class} file version regardless of whether the preview features</span>
<span class="line-added">162      * are enabled or not.</span>
<span class="line-added">163      *</span>
<span class="line-added">164      * @jvms 4.1 Table 4.1-A. class file format major versions</span>
<span class="line-added">165      */</span>
<span class="line-added">166     public static boolean isSupportedClassFileVersion(int major, int minor) {</span>
<span class="line-added">167         if (major &lt; 45 || major &gt; classFileMajorVersion) return false;</span>
<span class="line-added">168         // for major version is between 45 and 55 inclusive, the minor version may be any value</span>
<span class="line-added">169         if (major &lt; 56) return true;</span>
<span class="line-added">170         // otherwise, the minor version must be 0 or 65535</span>
<span class="line-added">171         return minor == 0 || minor == PREVIEW_MINOR_VERSION;</span>
<span class="line-added">172     }</span>
<span class="line-added">173 </span>
<span class="line-added">174     /**</span>
<span class="line-added">175      * Tests if the given version is a supported {@code class}</span>
<span class="line-added">176      * file version for module descriptor.</span>
<span class="line-added">177      *</span>
<span class="line-added">178      * major.minor version &gt;= 53.0</span>
<span class="line-added">179      */</span>
<span class="line-added">180     public static boolean isSupportedModuleDescriptorVersion(int major, int minor) {</span>
<span class="line-added">181         if (major &lt; 53 || major &gt; classFileMajorVersion) return false;</span>
<span class="line-added">182         // for major version is between 45 and 55 inclusive, the minor version may be any value</span>
<span class="line-added">183         if (major &lt; 56) return true;</span>
<span class="line-added">184         // otherwise, the minor version must be 0 or 65535</span>
<span class="line-added">185         // preview features do not apply to module-info.class but JVMS allows it</span>
<span class="line-added">186         return minor == 0 || minor == PREVIEW_MINOR_VERSION;</span>
<span class="line-added">187     }</span>
<span class="line-added">188 </span>
189     /**
190      * Returns true if the given class loader is the bootstrap class loader
191      * or the platform class loader.
192      */
193     public static boolean isSystemDomainLoader(ClassLoader loader) {
194         return loader == null || loader == ClassLoader.getPlatformClassLoader();
195     }
196 
197     /**
198      * Returns the system property of the specified key saved at
199      * system initialization time.  This method should only be used
200      * for the system properties that are not changed during runtime.
201      *
202      * Note that the saved system properties do not include
203      * the ones set by java.lang.VersionProps.init().
204      */
205     public static String getSavedProperty(String key) {
206         if (savedProps == null)
207             throw new IllegalStateException(&quot;Not yet initialized&quot;);
208 
</pre>
<hr />
<pre>
243         // Set the maximum amount of direct memory.  This value is controlled
244         // by the vm option -XX:MaxDirectMemorySize=&lt;size&gt;.
245         // The maximum amount of allocatable direct buffer memory (in bytes)
246         // from the system property sun.nio.MaxDirectMemorySize set by the VM.
247         // If not set or set to -1, the max memory will be used
248         // The system property will be removed.
249         String s = props.get(&quot;sun.nio.MaxDirectMemorySize&quot;);
250         if (s == null || s.isEmpty() || s.equals(&quot;-1&quot;)) {
251             // -XX:MaxDirectMemorySize not given, take default
252             directMemory = Runtime.getRuntime().maxMemory();
253         } else {
254             long l = Long.parseLong(s);
255             if (l &gt; -1)
256                 directMemory = l;
257         }
258 
259         // Check if direct buffers should be page aligned
260         s = props.get(&quot;sun.nio.PageAlignDirectMemory&quot;);
261         if (&quot;true&quot;.equals(s))
262             pageAlignDirectMemory = true;
<span class="line-added">263 </span>
<span class="line-added">264         s = props.get(&quot;java.class.version&quot;);</span>
<span class="line-added">265         int index = s.indexOf(&#39;.&#39;);</span>
<span class="line-added">266         try {</span>
<span class="line-added">267             classFileMajorVersion = Integer.valueOf(s.substring(0, index));</span>
<span class="line-added">268             classFileMinorVersion = Integer.valueOf(s.substring(index+1, s.length()));</span>
<span class="line-added">269         } catch (NumberFormatException e) {</span>
<span class="line-added">270             throw new InternalError(e);</span>
<span class="line-added">271         }</span>
272     }
273 
274     // Initialize any miscellaneous operating system settings that need to be
275     // set for the class libraries.
276     //
277     public static void initializeOSEnvironment() {
278         if (initLevel() == 0) {
279             OSEnvironment.initialize();
280         }
281     }
282 
283     /* Current count of objects pending for finalization */
284     private static volatile int finalRefCount;
285 
286     /* Peak count of objects pending for finalization */
287     private static volatile int peakFinalRefCount;
288 
289     /*
290      * Gets the number of objects pending for finalization.
291      *
</pre>
</td>
</tr>
</table>
<center><a href="../PreviewFeature.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="../module/ModuleInfo.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>