<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff src/jdk.jfr/share/classes/jdk/jfr/internal/MetadataHandler.java</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
  </head>
<body>
<center><a href="JVM.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="MetadataReader.java.cdiff.html" target="_top">next &gt;</a></center>    <h2>src/jdk.jfr/share/classes/jdk/jfr/internal/MetadataHandler.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 28,10 ***</span>
<span class="line-new-header">--- 28,11 ---</span>
  import java.io.BufferedInputStream;
  import java.io.IOException;
  import java.io.InputStream;
  import java.lang.annotation.Annotation;
  import java.util.ArrayList;
<span class="line-added">+ import java.util.Collection;</span>
  import java.util.Collections;
  import java.util.HashMap;
  import java.util.LinkedHashMap;
  import java.util.List;
  import java.util.Map;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 57,10 ***</span>
<span class="line-new-header">--- 58,13 ---</span>
  import jdk.jfr.TransitionTo;
  import jdk.jfr.Unsigned;
  
  final class MetadataHandler extends DefaultHandler implements EntityResolver {
  
<span class="line-added">+     // Metadata and Checkpoint event</span>
<span class="line-added">+     private final long RESERVED_EVENT_COUNT = 2;</span>
<span class="line-added">+ </span>
      static class TypeElement {
          List&lt;FieldElement&gt; fields = new ArrayList&lt;&gt;();
          String name;
          String label;
          String description;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 70,10 ***</span>
<span class="line-new-header">--- 74,11 ---</span>
          boolean thread;
          boolean startTime;
          boolean stackTrace;
          boolean cutoff;
          boolean isEvent;
<span class="line-added">+         boolean isRelation;</span>
          boolean experimental;
          boolean valueType;
      }
  
      static class FieldElement {
</pre>
<hr />
<pre>
<span class="line-old-header">*** 97,17 ***</span>
          String contentType;
          boolean unsigned;
      }
  
      final Map&lt;String, TypeElement&gt; types = new LinkedHashMap&lt;&gt;(200);
<span class="line-modified">!     final Map&lt;String, XmlType&gt; xmlTypes = new HashMap&lt;&gt;(20);</span>
<span class="line-modified">!     final Map&lt;String, List&lt;AnnotationElement&gt;&gt; xmlContentTypes = new HashMap&lt;&gt;(20);</span>
<span class="line-removed">-     final List&lt;String&gt; relations = new ArrayList&lt;&gt;();</span>
<span class="line-removed">-     long eventTypeId = 255;</span>
<span class="line-removed">-     long structTypeId = 33;</span>
      FieldElement currentField;
      TypeElement currentType;
  
      @Override
      public void startElement(String uri, String localName, String qName, Attributes attributes) throws SAXException {
          switch (qName) {
          case &quot;XmlType&quot;:
<span class="line-new-header">--- 102,15 ---</span>
          String contentType;
          boolean unsigned;
      }
  
      final Map&lt;String, TypeElement&gt; types = new LinkedHashMap&lt;&gt;(200);
<span class="line-modified">!     final Map&lt;String, XmlType&gt; xmlTypes = new LinkedHashMap&lt;&gt;(20);</span>
<span class="line-modified">!     final Map&lt;String, List&lt;AnnotationElement&gt;&gt; xmlContentTypes = new LinkedHashMap&lt;&gt;(20);</span>
      FieldElement currentField;
      TypeElement currentType;
<span class="line-added">+     long eventCount;</span>
  
      @Override
      public void startElement(String uri, String localName, String qName, Attributes attributes) throws SAXException {
          switch (qName) {
          case &quot;XmlType&quot;:
</pre>
<hr />
<pre>
<span class="line-old-header">*** 116,10 ***</span>
<span class="line-new-header">--- 119,11 ---</span>
              xmlType.javaType = attributes.getValue(&quot;javaType&quot;);
              xmlType.contentType = attributes.getValue(&quot;contentType&quot;);
              xmlType.unsigned = Boolean.valueOf(attributes.getValue(&quot;unsigned&quot;));
              xmlTypes.put(xmlType.name, xmlType);
              break;
<span class="line-added">+         case &quot;Relation&quot;:</span>
          case &quot;Type&quot;:
          case &quot;Event&quot;:
              currentType = new TypeElement();
              currentType.name = attributes.getValue(&quot;name&quot;);
              currentType.label = attributes.getValue(&quot;label&quot;);
</pre>
<hr />
<pre>
<span class="line-old-header">*** 130,10 ***</span>
<span class="line-new-header">--- 134,11 ---</span>
              currentType.startTime = getBoolean(attributes, &quot;startTime&quot;, true);
              currentType.period = attributes.getValue(&quot;period&quot;);
              currentType.cutoff = getBoolean(attributes, &quot;cutoff&quot;, false);
              currentType.experimental = getBoolean(attributes, &quot;experimental&quot;, false);
              currentType.isEvent = qName.equals(&quot;Event&quot;);
<span class="line-added">+             currentType.isRelation = qName.equals(&quot;Relation&quot;);</span>
              break;
          case &quot;Field&quot;:
              currentField = new FieldElement();
              currentField.struct = getBoolean(attributes, &quot;struct&quot;, false);
              currentField.array = getBoolean(attributes, &quot;array&quot;, false);
</pre>
<hr />
<pre>
<span class="line-old-header">*** 149,14 ***</span>
          case &quot;XmlContentType&quot;:
              String name = attributes.getValue(&quot;name&quot;);
              String annotation = attributes.getValue(&quot;annotation&quot;);
              xmlContentTypes.put(name, createAnnotationElements(annotation));
              break;
<span class="line-removed">-         case &quot;Relation&quot;:</span>
<span class="line-removed">-             String n = attributes.getValue(&quot;name&quot;);</span>
<span class="line-removed">-             relations.add(n);</span>
<span class="line-removed">-             break;</span>
          }
      }
  
      private List&lt;AnnotationElement&gt; createAnnotationElements(String annotation) throws InternalError {
          String[] annotations = annotation.split(&quot;,&quot;);
<span class="line-new-header">--- 154,10 ---</span>
</pre>
<hr />
<pre>
<span class="line-old-header">*** 200,11 ***</span>
<span class="line-new-header">--- 201,15 ---</span>
      @Override
      public void endElement(String uri, String localName, String qName) {
          switch (qName) {
          case &quot;Type&quot;:
          case &quot;Event&quot;:
<span class="line-added">+         case &quot;Relation&quot;:</span>
              types.put(currentType.name, currentType);
<span class="line-added">+             if (currentType.isEvent) {</span>
<span class="line-added">+                 eventCount++;</span>
<span class="line-added">+             }</span>
              currentType = null;
              break;
          case &quot;Field&quot;:
              currentType.fields.add(currentField);
              currentField = null;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 219,11 ***</span>
              Logger.log(LogTag.JFR_SYSTEM, LogLevel.DEBUG, () -&gt; &quot;Parsing metadata.xml&quot;);
              try {
                  parser.parse(is, t);
                  return t.buildTypes();
              } catch (Exception e) {
<span class="line-removed">-                 e.printStackTrace();</span>
                  throw new IOException(e);
              }
          }
      }
  
<span class="line-new-header">--- 224,10 ---</span>
</pre>
<hr />
<pre>
<span class="line-old-header">*** 235,16 ***</span>
          return trimTypes(typeMap);
      }
  
      private Map&lt;String, AnnotationElement&gt; buildRelationMap(Map&lt;String, Type&gt; typeMap) {
          Map&lt;String, AnnotationElement&gt; relationMap = new HashMap&lt;&gt;();
<span class="line-modified">!         for (String relation : relations) {</span>
<span class="line-modified">!             Type relationType = new Type(Type.TYPES_PREFIX + relation, Type.SUPER_TYPE_ANNOTATION, eventTypeId++);</span>
<span class="line-modified">!             relationType.setAnnotations(Collections.singletonList(new AnnotationElement(Relational.class)));</span>
<span class="line-modified">!             AnnotationElement ae = PrivateAccess.getInstance().newAnnotation(relationType, Collections.emptyList(), true);</span>
<span class="line-modified">!             relationMap.put(relation, ae);</span>
<span class="line-modified">!             typeMap.put(relationType.getName(), relationType);</span>
          }
          return relationMap;
      }
  
      private List&lt;Type&gt; trimTypes(Map&lt;String, Type&gt; lookup) {
<span class="line-new-header">--- 239,16 ---</span>
          return trimTypes(typeMap);
      }
  
      private Map&lt;String, AnnotationElement&gt; buildRelationMap(Map&lt;String, Type&gt; typeMap) {
          Map&lt;String, AnnotationElement&gt; relationMap = new HashMap&lt;&gt;();
<span class="line-modified">!         for (TypeElement t : types.values()) {</span>
<span class="line-modified">!             if (t.isRelation) {</span>
<span class="line-modified">!                 Type relationType = typeMap.get(t.name);</span>
<span class="line-modified">!                 AnnotationElement ae = PrivateAccess.getInstance().newAnnotation(relationType, Collections.emptyList(), true);</span>
<span class="line-modified">!                 relationMap.put(t.name, ae);</span>
<span class="line-modified">!             }</span>
          }
          return relationMap;
      }
  
      private List&lt;Type&gt; trimTypes(Map&lt;String, Type&gt; lookup) {
</pre>
<hr />
<pre>
<span class="line-old-header">*** 274,11 ***</span>
                  }
                  if (f.contentType != null) {
                      aes.addAll(Objects.requireNonNull(xmlContentTypes.get(f.contentType)));
                  }
                  if (f.relation != null) {
<span class="line-modified">!                     aes.add(Objects.requireNonNull(relationMap.get(f.relation)));</span>
                  }
                  if (f.label != null) {
                      aes.add(new AnnotationElement(Label.class, f.label));
                  }
                  if (f.experimental) {
<span class="line-new-header">--- 278,13 ---</span>
                  }
                  if (f.contentType != null) {
                      aes.addAll(Objects.requireNonNull(xmlContentTypes.get(f.contentType)));
                  }
                  if (f.relation != null) {
<span class="line-modified">!                     String relationTypeName = Type.TYPES_PREFIX + f.relation;</span>
<span class="line-added">+                     AnnotationElement t = relationMap.get(relationTypeName);</span>
<span class="line-added">+                     aes.add(Objects.requireNonNull(t));</span>
                  }
                  if (f.label != null) {
                      aes.add(new AnnotationElement(Label.class, f.label));
                  }
                  if (f.experimental) {
</pre>
<hr />
<pre>
<span class="line-old-header">*** 299,14 ***</span>
          }
      }
  
      private Map&lt;String, Type&gt; buildTypeMap() {
          Map&lt;String, Type&gt; typeMap = new HashMap&lt;&gt;();
<span class="line-modified">!         for (Type type : Type.getKnownTypes()) {</span>
<span class="line-modified">!             typeMap.put(type.getName(), type);</span>
          }
<span class="line-modified">! </span>
          for (TypeElement t : types.values()) {
              List&lt;AnnotationElement&gt; aes = new ArrayList&lt;&gt;();
              if (t.category != null) {
                  aes.add(new AnnotationElement(Category.class, buildCategoryArray(t.category)));
              }
<span class="line-new-header">--- 305,17 ---</span>
          }
      }
  
      private Map&lt;String, Type&gt; buildTypeMap() {
          Map&lt;String, Type&gt; typeMap = new HashMap&lt;&gt;();
<span class="line-modified">!         Map&lt;String, Type&gt; knownTypeMap = new HashMap&lt;&gt;();</span>
<span class="line-modified">!         for (Type kt :Type.getKnownTypes()) {</span>
<span class="line-added">+             typeMap.put(kt.getName(), kt);</span>
<span class="line-added">+             knownTypeMap.put(kt.getName(), kt);</span>
          }
<span class="line-modified">!         long eventTypeId = RESERVED_EVENT_COUNT;</span>
<span class="line-added">+         long typeId = RESERVED_EVENT_COUNT + eventCount + knownTypeMap.size();</span>
          for (TypeElement t : types.values()) {
              List&lt;AnnotationElement&gt; aes = new ArrayList&lt;&gt;();
              if (t.category != null) {
                  aes.add(new AnnotationElement(Category.class, buildCategoryArray(t.category)));
              }
</pre>
<hr />
<pre>
<span class="line-old-header">*** 337,39 ***</span>
              Type type;
              if (t.isEvent) {
                  aes.add(new AnnotationElement(Enabled.class, false));
                  type = new PlatformEventType(t.name,  eventTypeId++, false, true);
              } else {
<span class="line-modified">!                 // Struct types had their own XML-element in the past. To have id assigned in the</span>
<span class="line-modified">!                 // same order as generated .hpp file do some tweaks here.</span>
<span class="line-modified">!                 boolean valueType = t.name.endsWith(&quot;StackFrame&quot;) || t.valueType;</span>
<span class="line-modified">!                 type = new Type(t.name, null, valueType ?  eventTypeId++ : nextTypeId(t.name), false);</span>
              }
              type.setAnnotations(aes);
              typeMap.put(t.name, type);
          }
          return typeMap;
      }
  
<span class="line-removed">-     private long nextTypeId(String name) {</span>
<span class="line-removed">-         if (Type.THREAD.getName().equals(name)) {</span>
<span class="line-removed">-             return Type.THREAD.getId();</span>
<span class="line-removed">-         }</span>
<span class="line-removed">-         if (Type.STRING.getName().equals(name)) {</span>
<span class="line-removed">-             return Type.STRING.getId();</span>
<span class="line-removed">-         }</span>
<span class="line-removed">-         if (Type.CLASS.getName().equals(name)) {</span>
<span class="line-removed">-             return Type.CLASS.getId();</span>
<span class="line-removed">-         }</span>
<span class="line-removed">-         for (Type type : Type.getKnownTypes()) {</span>
<span class="line-removed">-             if (type.getName().equals(name)) {</span>
<span class="line-removed">-                 return type.getId();</span>
<span class="line-removed">-             }</span>
<span class="line-removed">-         }</span>
<span class="line-removed">-         return structTypeId++;</span>
<span class="line-removed">-     }</span>
<span class="line-removed">- </span>
      private String[] buildCategoryArray(String category) {
          List&lt;String&gt; categories = new ArrayList&lt;&gt;();
          StringBuilder sb = new StringBuilder();
          for (char c : category.toCharArray()) {
              if (c == &#39;,&#39;) {
<span class="line-new-header">--- 346,27 ---</span>
              Type type;
              if (t.isEvent) {
                  aes.add(new AnnotationElement(Enabled.class, false));
                  type = new PlatformEventType(t.name,  eventTypeId++, false, true);
              } else {
<span class="line-modified">!                 if (knownTypeMap.containsKey(t.name)) {</span>
<span class="line-modified">!                     type = knownTypeMap.get(t.name);</span>
<span class="line-modified">!                 } else {</span>
<span class="line-modified">!                     if (t.isRelation) {</span>
<span class="line-added">+                         type = new Type(t.name, Type.SUPER_TYPE_ANNOTATION, typeId++);</span>
<span class="line-added">+                         aes.add(new AnnotationElement(Relational.class));</span>
<span class="line-added">+                     } else {</span>
<span class="line-added">+                         type = new Type(t.name, null, typeId++);</span>
<span class="line-added">+                     }</span>
<span class="line-added">+                 }</span>
              }
              type.setAnnotations(aes);
              typeMap.put(t.name, type);
          }
          return typeMap;
      }
  
      private String[] buildCategoryArray(String category) {
          List&lt;String&gt; categories = new ArrayList&lt;&gt;();
          StringBuilder sb = new StringBuilder();
          for (char c : category.toCharArray()) {
              if (c == &#39;,&#39;) {
</pre>
<center><a href="JVM.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="MetadataReader.java.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>