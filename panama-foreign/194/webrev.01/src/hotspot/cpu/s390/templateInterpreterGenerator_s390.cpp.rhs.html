<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames src/hotspot/cpu/s390/templateInterpreterGenerator_s390.cpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
    <script type="text/javascript" src="../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>   1 /*
<a name="1" id="anc1"></a><span class="line-modified">   2  * Copyright (c) 2016, 2020, Oracle and/or its affiliates. All rights reserved.</span>
   3  * Copyright (c) 2016, 2019, SAP SE. All rights reserved.
   4  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   5  *
   6  * This code is free software; you can redistribute it and/or modify it
   7  * under the terms of the GNU General Public License version 2 only, as
   8  * published by the Free Software Foundation.
   9  *
  10  * This code is distributed in the hope that it will be useful, but WITHOUT
  11  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  12  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  13  * version 2 for more details (a copy is included in the LICENSE file that
  14  * accompanied this code).
  15  *
  16  * You should have received a copy of the GNU General Public License version
  17  * 2 along with this work; if not, write to the Free Software Foundation,
  18  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  19  *
  20  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  21  * or visit www.oracle.com if you need additional information or have any
  22  * questions.
  23  *
  24  */
  25 
  26 #include &quot;precompiled.hpp&quot;
  27 #include &quot;asm/macroAssembler.inline.hpp&quot;
  28 #include &quot;gc/shared/barrierSetAssembler.hpp&quot;
  29 #include &quot;interpreter/abstractInterpreter.hpp&quot;
  30 #include &quot;interpreter/bytecodeHistogram.hpp&quot;
  31 #include &quot;interpreter/interpreter.hpp&quot;
  32 #include &quot;interpreter/interpreterRuntime.hpp&quot;
  33 #include &quot;interpreter/interp_masm.hpp&quot;
  34 #include &quot;interpreter/templateInterpreterGenerator.hpp&quot;
  35 #include &quot;interpreter/templateTable.hpp&quot;
  36 #include &quot;oops/arrayOop.hpp&quot;
  37 #include &quot;oops/oop.inline.hpp&quot;
  38 #include &quot;prims/jvmtiExport.hpp&quot;
  39 #include &quot;prims/jvmtiThreadState.hpp&quot;
  40 #include &quot;runtime/arguments.hpp&quot;
  41 #include &quot;runtime/deoptimization.hpp&quot;
  42 #include &quot;runtime/frame.inline.hpp&quot;
  43 #include &quot;runtime/sharedRuntime.hpp&quot;
  44 #include &quot;runtime/stubRoutines.hpp&quot;
  45 #include &quot;runtime/synchronizer.hpp&quot;
  46 #include &quot;runtime/timer.hpp&quot;
  47 #include &quot;runtime/vframeArray.hpp&quot;
  48 #include &quot;utilities/debug.hpp&quot;
  49 
  50 
  51 // Size of interpreter code.  Increase if too small.  Interpreter will
  52 // fail with a guarantee (&quot;not enough space for interpreter generation&quot;);
  53 // if too small.
  54 // Run with +PrintInterpreter to get the VM to print out the size.
  55 // Max size with JVMTI
  56 int TemplateInterpreter::InterpreterCodeSize = 320*K;
  57 
  58 #undef  __
  59 #ifdef PRODUCT
  60   #define __ _masm-&gt;
  61 #else
  62   #define __ _masm-&gt;
  63 //  #define __ (Verbose ? (_masm-&gt;block_comment(FILE_AND_LINE),_masm):_masm)-&gt;
  64 #endif
  65 
  66 #define BLOCK_COMMENT(str) __ block_comment(str)
  67 #define BIND(label)        __ bind(label); BLOCK_COMMENT(#label &quot;:&quot;)
  68 
  69 #define oop_tmp_offset     _z_ijava_state_neg(oop_tmp)
  70 
  71 //-----------------------------------------------------------------------------
  72 
  73 address TemplateInterpreterGenerator::generate_slow_signature_handler() {
  74   //
  75   // New slow_signature handler that respects the z/Architecture
  76   // C calling conventions.
  77   //
  78   // We get called by the native entry code with our output register
  79   // area == 8. First we call InterpreterRuntime::get_result_handler
  80   // to copy the pointer to the signature string temporarily to the
  81   // first C-argument and to return the result_handler in
  82   // Z_RET. Since native_entry will copy the jni-pointer to the
  83   // first C-argument slot later on, it&#39;s OK to occupy this slot
  84   // temporarily. Then we copy the argument list on the java
  85   // expression stack into native varargs format on the native stack
  86   // and load arguments into argument registers. Integer arguments in
  87   // the varargs vector will be sign-extended to 8 bytes.
  88   //
  89   // On entry:
  90   //   Z_ARG1  - intptr_t*       Address of java argument list in memory.
  91   //   Z_state - cppInterpreter* Address of interpreter state for
  92   //                               this method
  93   //   Z_method
  94   //
  95   // On exit (just before return instruction):
  96   //   Z_RET contains the address of the result_handler.
  97   //   Z_ARG2 is not updated for static methods and contains &quot;this&quot; otherwise.
  98   //   Z_ARG3-Z_ARG5 contain the first 3 arguments of types other than float and double.
  99   //   Z_FARG1-Z_FARG4 contain the first 4 arguments of type float or double.
 100 
 101   const int LogSizeOfCase = 3;
 102 
 103   const int max_fp_register_arguments   = Argument::n_float_register_parameters;
 104   const int max_int_register_arguments  = Argument::n_register_parameters - 2;  // First 2 are reserved.
 105 
 106   const Register arg_java       = Z_tmp_2;
 107   const Register arg_c          = Z_tmp_3;
 108   const Register signature      = Z_R1_scratch; // Is a string.
 109   const Register fpcnt          = Z_R0_scratch;
 110   const Register argcnt         = Z_tmp_4;
 111   const Register intSlot        = Z_tmp_1;
 112   const Register sig_end        = Z_tmp_1; // Assumed end of signature (only used in do_object).
 113   const Register target_sp      = Z_tmp_1;
 114   const FloatRegister floatSlot = Z_F1;
 115 
 116   const int d_signature         = _z_abi(gpr6); // Only spill space, register contents not affected.
 117   const int d_fpcnt             = _z_abi(gpr7); // Only spill space, register contents not affected.
 118 
 119   unsigned int entry_offset = __ offset();
 120 
 121   BLOCK_COMMENT(&quot;slow_signature_handler {&quot;);
 122 
 123   // We use target_sp for storing arguments in the C frame.
 124   __ save_return_pc();
 125   __ push_frame_abi160(4*BytesPerWord);                 // Reserve space to save the tmp_[1..4] registers.
 126   __ z_stmg(Z_R10, Z_R13, frame::z_abi_160_size, Z_SP); // Save registers only after frame is pushed.
 127 
 128   __ z_lgr(arg_java, Z_ARG1);
 129 
 130   Register   method = Z_ARG2; // Directly load into correct argument register.
 131 
 132   __ get_method(method);
 133   __ call_VM_leaf(CAST_FROM_FN_PTR(address, InterpreterRuntime::get_signature), Z_thread, method);
 134 
 135   // Move signature to callee saved register.
 136   // Don&#39;t directly write to stack. Frame is used by VM call.
 137   __ z_lgr(Z_tmp_1, Z_RET);
 138 
 139   // Reload method. Register may have been altered by VM call.
 140   __ get_method(method);
 141 
 142   // Get address of result handler.
 143   __ call_VM_leaf(CAST_FROM_FN_PTR(address, InterpreterRuntime::get_result_handler), Z_thread, method);
 144 
 145   // Save signature address to stack.
 146   __ z_stg(Z_tmp_1, d_signature, Z_SP);
 147 
 148   // Don&#39;t overwrite return value (Z_RET, Z_ARG1) in rest of the method !
 149 
 150   {
 151     Label   isStatic;
 152 
 153     // Test if static.
 154     // We can test the bit directly.
 155     // Path is Z_method-&gt;_access_flags._flags.
 156     // We only support flag bits in the least significant byte (assert !).
 157     // Therefore add 3 to address that byte within &quot;_flags&quot;.
 158     // Reload method. VM call above may have destroyed register contents
 159     __ get_method(method);
 160     __ testbit(method2_(method, access_flags), JVM_ACC_STATIC_BIT);
 161     method = noreg;  // end of life
 162     __ z_btrue(isStatic);
 163 
 164     // For non-static functions, pass &quot;this&quot; in Z_ARG2 and copy it to 2nd C-arg slot.
 165     // Need to box the Java object here, so we use arg_java
 166     // (address of current Java stack slot) as argument and
 167     // don&#39;t dereference it as in case of ints, floats, etc..
 168     __ z_lgr(Z_ARG2, arg_java);
 169     __ add2reg(arg_java, -BytesPerWord);
 170     __ bind(isStatic);
 171   }
 172 
 173   // argcnt == 0 corresponds to 3rd C argument.
 174   //   arg #1 (result handler) and
 175   //   arg #2 (this, for non-statics), unused else
 176   // are reserved and pre-filled above.
 177   // arg_java points to the corresponding Java argument here. It
 178   // has been decremented by one argument (this) in case of non-static.
 179   __ clear_reg(argcnt, true, false);  // Don&#39;t set CC.
 180   __ z_lg(target_sp, 0, Z_SP);
 181   __ add2reg(arg_c, _z_abi(remaining_cargs), target_sp);
 182   // No floating-point args parsed so far.
 183   __ clear_mem(Address(Z_SP, d_fpcnt), 8);
 184 
 185   NearLabel   move_intSlot_to_ARG, move_floatSlot_to_FARG;
 186   NearLabel   loop_start, loop_start_restore, loop_end;
 187   NearLabel   do_int, do_long, do_float, do_double;
 188   NearLabel   do_dontreachhere, do_object, do_array, do_boxed;
 189 
 190 #ifdef ASSERT
 191   // Signature needs to point to &#39;(&#39; (== 0x28) at entry.
 192   __ z_lg(signature, d_signature, Z_SP);
 193   __ z_cli(0, signature, (int) &#39;(&#39;);
 194   __ z_brne(do_dontreachhere);
 195 #endif
 196 
 197   __ bind(loop_start_restore);
 198   __ z_lg(signature, d_signature, Z_SP);  // Restore signature ptr, destroyed by move_XX_to_ARG.
 199 
 200   BIND(loop_start);
 201   // Advance to next argument type token from the signature.
 202   __ add2reg(signature, 1);
 203 
 204   // Use CLI, works well on all CPU versions.
 205     __ z_cli(0, signature, (int) &#39;)&#39;);
 206     __ z_bre(loop_end);                // end of signature
 207     __ z_cli(0, signature, (int) &#39;L&#39;);
 208     __ z_bre(do_object);               // object     #9
 209     __ z_cli(0, signature, (int) &#39;F&#39;);
 210     __ z_bre(do_float);                // float      #7
 211     __ z_cli(0, signature, (int) &#39;J&#39;);
 212     __ z_bre(do_long);                 // long       #6
 213     __ z_cli(0, signature, (int) &#39;B&#39;);
 214     __ z_bre(do_int);                  // byte       #1
 215     __ z_cli(0, signature, (int) &#39;Z&#39;);
 216     __ z_bre(do_int);                  // boolean    #2
 217     __ z_cli(0, signature, (int) &#39;C&#39;);
 218     __ z_bre(do_int);                  // char       #3
 219     __ z_cli(0, signature, (int) &#39;S&#39;);
 220     __ z_bre(do_int);                  // short      #4
 221     __ z_cli(0, signature, (int) &#39;I&#39;);
 222     __ z_bre(do_int);                  // int        #5
 223     __ z_cli(0, signature, (int) &#39;D&#39;);
 224     __ z_bre(do_double);               // double     #8
 225     __ z_cli(0, signature, (int) &#39;[&#39;);
 226     __ z_bre(do_array);                // array      #10
 227 
 228   __ bind(do_dontreachhere);
 229 
 230   __ unimplemented(&quot;ShouldNotReachHere in slow_signature_handler&quot;, 120);
 231 
 232   // Array argument
 233   BIND(do_array);
 234 
 235   {
 236     Label   start_skip, end_skip;
 237 
 238     __ bind(start_skip);
 239 
 240     // Advance to next type tag from signature.
 241     __ add2reg(signature, 1);
 242 
 243     // Use CLI, works well on all CPU versions.
 244     __ z_cli(0, signature, (int) &#39;[&#39;);
 245     __ z_bre(start_skip);               // Skip further brackets.
 246 
 247     __ z_cli(0, signature, (int) &#39;9&#39;);
 248     __ z_brh(end_skip);                 // no optional size
 249 
 250     __ z_cli(0, signature, (int) &#39;0&#39;);
 251     __ z_brnl(start_skip);              // Skip optional size.
 252 
 253     __ bind(end_skip);
 254 
 255     __ z_cli(0, signature, (int) &#39;L&#39;);
 256     __ z_brne(do_boxed);                // If not array of objects: go directly to do_boxed.
 257   }
 258 
 259   //  OOP argument
 260   BIND(do_object);
 261   // Pass by an object&#39;s type name.
 262   {
 263     Label   L;
 264 
 265     __ add2reg(sig_end, 4095, signature);     // Assume object type name is shorter than 4k.
 266     __ load_const_optimized(Z_R0, (int) &#39;;&#39;); // Type name terminator (must be in Z_R0!).
 267     __ MacroAssembler::search_string(sig_end, signature);
 268     __ z_brl(L);
 269     __ z_illtrap();  // No semicolon found: internal error or object name too long.
 270     __ bind(L);
 271     __ z_lgr(signature, sig_end);
 272     // fallthru to do_boxed
 273   }
 274 
 275   // Need to box the Java object here, so we use arg_java
 276   // (address of current Java stack slot) as argument and
 277   // don&#39;t dereference it as in case of ints, floats, etc..
 278 
 279   // UNBOX argument
 280   // Load reference and check for NULL.
 281   Label  do_int_Entry4Boxed;
 282   __ bind(do_boxed);
 283   {
 284     __ load_and_test_long(intSlot, Address(arg_java));
 285     __ z_bre(do_int_Entry4Boxed);
 286     __ z_lgr(intSlot, arg_java);
 287     __ z_bru(do_int_Entry4Boxed);
 288   }
 289 
 290   // INT argument
 291 
 292   // (also for byte, boolean, char, short)
 293   // Use lgf for load (sign-extend) and stg for store.
 294   BIND(do_int);
 295   __ z_lgf(intSlot, 0, arg_java);
 296 
 297   __ bind(do_int_Entry4Boxed);
 298   __ add2reg(arg_java, -BytesPerWord);
 299   // If argument fits into argument register, go and handle it, otherwise continue.
 300   __ compare32_and_branch(argcnt, max_int_register_arguments,
 301                           Assembler::bcondLow, move_intSlot_to_ARG);
 302   __ z_stg(intSlot, 0, arg_c);
 303   __ add2reg(arg_c, BytesPerWord);
 304   __ z_bru(loop_start);
 305 
 306   // LONG argument
 307 
 308   BIND(do_long);
 309   __ add2reg(arg_java, -2*BytesPerWord);  // Decrement first to have positive displacement for lg.
 310   __ z_lg(intSlot, BytesPerWord, arg_java);
 311   // If argument fits into argument register, go and handle it, otherwise continue.
 312   __ compare32_and_branch(argcnt, max_int_register_arguments,
 313                           Assembler::bcondLow, move_intSlot_to_ARG);
 314   __ z_stg(intSlot, 0, arg_c);
 315   __ add2reg(arg_c, BytesPerWord);
 316   __ z_bru(loop_start);
 317 
 318   // FLOAT argumen
 319 
 320   BIND(do_float);
 321   __ z_le(floatSlot, 0, arg_java);
 322   __ add2reg(arg_java, -BytesPerWord);
 323   assert(max_fp_register_arguments &lt;= 255, &quot;always true&quot;);  // safety net
 324   __ z_cli(d_fpcnt+7, Z_SP, max_fp_register_arguments);
 325   __ z_brl(move_floatSlot_to_FARG);
 326   __ z_ste(floatSlot, 4, arg_c);
 327   __ add2reg(arg_c, BytesPerWord);
 328   __ z_bru(loop_start);
 329 
 330   // DOUBLE argument
 331 
 332   BIND(do_double);
 333   __ add2reg(arg_java, -2*BytesPerWord);  // Decrement first to have positive displacement for lg.
 334   __ z_ld(floatSlot, BytesPerWord, arg_java);
 335   assert(max_fp_register_arguments &lt;= 255, &quot;always true&quot;);  // safety net
 336   __ z_cli(d_fpcnt+7, Z_SP, max_fp_register_arguments);
 337   __ z_brl(move_floatSlot_to_FARG);
 338   __ z_std(floatSlot, 0, arg_c);
 339   __ add2reg(arg_c, BytesPerWord);
 340   __ z_bru(loop_start);
 341 
 342   // Method exit, all arguments proocessed.
 343   __ bind(loop_end);
 344   __ z_lmg(Z_R10, Z_R13, frame::z_abi_160_size, Z_SP); // restore registers before frame is popped.
 345   __ pop_frame();
 346   __ restore_return_pc();
 347   __ z_br(Z_R14);
 348 
 349   // Copy int arguments.
 350 
 351   Label  iarg_caselist;   // Distance between each case has to be a power of 2
 352                           // (= 1 &lt;&lt; LogSizeOfCase).
 353   __ align(16);
 354   BIND(iarg_caselist);
 355   __ z_lgr(Z_ARG3, intSlot);    // 4 bytes
 356   __ z_bru(loop_start_restore); // 4 bytes
 357 
 358   __ z_lgr(Z_ARG4, intSlot);
 359   __ z_bru(loop_start_restore);
 360 
 361   __ z_lgr(Z_ARG5, intSlot);
 362   __ z_bru(loop_start_restore);
 363 
 364   __ align(16);
 365   __ bind(move_intSlot_to_ARG);
 366   __ z_stg(signature, d_signature, Z_SP);       // Spill since signature == Z_R1_scratch.
 367   __ z_larl(Z_R1_scratch, iarg_caselist);
 368   __ z_sllg(Z_R0_scratch, argcnt, LogSizeOfCase);
 369   __ add2reg(argcnt, 1);
 370   __ z_agr(Z_R1_scratch, Z_R0_scratch);
 371   __ z_bcr(Assembler::bcondAlways, Z_R1_scratch);
 372 
 373   // Copy float arguments.
 374 
 375   Label  farg_caselist;   // Distance between each case has to be a power of 2
 376                           // (= 1 &lt;&lt; logSizeOfCase, padded with nop.
 377   __ align(16);
 378   BIND(farg_caselist);
 379   __ z_ldr(Z_FARG1, floatSlot); // 2 bytes
 380   __ z_bru(loop_start_restore); // 4 bytes
 381   __ z_nop();                   // 2 bytes
 382 
 383   __ z_ldr(Z_FARG2, floatSlot);
 384   __ z_bru(loop_start_restore);
 385   __ z_nop();
 386 
 387   __ z_ldr(Z_FARG3, floatSlot);
 388   __ z_bru(loop_start_restore);
 389   __ z_nop();
 390 
 391   __ z_ldr(Z_FARG4, floatSlot);
 392   __ z_bru(loop_start_restore);
 393   __ z_nop();
 394 
 395   __ align(16);
 396   __ bind(move_floatSlot_to_FARG);
 397   __ z_stg(signature, d_signature, Z_SP);        // Spill since signature == Z_R1_scratch.
 398   __ z_lg(Z_R0_scratch, d_fpcnt, Z_SP);          // Need old value for indexing.
 399   __ add2mem_64(Address(Z_SP, d_fpcnt), 1, Z_R1_scratch); // Increment index.
 400   __ z_larl(Z_R1_scratch, farg_caselist);
 401   __ z_sllg(Z_R0_scratch, Z_R0_scratch, LogSizeOfCase);
 402   __ z_agr(Z_R1_scratch, Z_R0_scratch);
 403   __ z_bcr(Assembler::bcondAlways, Z_R1_scratch);
 404 
 405   BLOCK_COMMENT(&quot;} slow_signature_handler&quot;);
 406 
 407   return __ addr_at(entry_offset);
 408 }
 409 
 410 address TemplateInterpreterGenerator::generate_result_handler_for (BasicType type) {
 411   address entry = __ pc();
 412 
 413   assert(Z_tos == Z_RET, &quot;Result handler: must move result!&quot;);
 414   assert(Z_ftos == Z_FRET, &quot;Result handler: must move float result!&quot;);
 415 
 416   switch (type) {
 417     case T_BOOLEAN:
 418       __ c2bool(Z_tos);
 419       break;
 420     case T_CHAR:
 421       __ and_imm(Z_tos, 0xffff);
 422       break;
 423     case T_BYTE:
 424       __ z_lbr(Z_tos, Z_tos);
 425       break;
 426     case T_SHORT:
 427       __ z_lhr(Z_tos, Z_tos);
 428       break;
 429     case T_INT:
 430     case T_LONG:
 431     case T_VOID:
 432     case T_FLOAT:
 433     case T_DOUBLE:
 434       break;
 435     case T_OBJECT:
 436       // Retrieve result from frame...
 437       __ mem2reg_opt(Z_tos, Address(Z_fp, oop_tmp_offset));
 438       // and verify it.
 439       __ verify_oop(Z_tos);
 440       break;
 441     default:
 442       ShouldNotReachHere();
 443   }
 444   __ z_br(Z_R14);      // Return from result handler.
 445   return entry;
 446 }
 447 
 448 // Abstract method entry.
 449 // Attempt to execute abstract method. Throw exception.
 450 address TemplateInterpreterGenerator::generate_abstract_entry(void) {
 451   unsigned int entry_offset = __ offset();
 452 
 453   // Caller could be the call_stub or a compiled method (x86 version is wrong!).
 454 
 455   BLOCK_COMMENT(&quot;abstract_entry {&quot;);
 456 
 457   // Implement call of InterpreterRuntime::throw_AbstractMethodError.
 458   __ set_top_ijava_frame_at_SP_as_last_Java_frame(Z_SP, Z_R1);
 459   __ save_return_pc();       // Save Z_R14.
 460   __ push_frame_abi160(0);   // Without new frame the RT call could overwrite the saved Z_R14.
 461 
 462   __ call_VM_leaf(CAST_FROM_FN_PTR(address, InterpreterRuntime::throw_AbstractMethodErrorWithMethod),
 463                   Z_thread, Z_method);
 464 
 465   __ pop_frame();
 466   __ restore_return_pc();    // Restore Z_R14.
 467   __ reset_last_Java_frame();
 468 
 469   // Restore caller sp for c2i case.
 470   __ resize_frame_absolute(Z_R10, Z_R0, true); // Cut the stack back to where the caller started.
 471 
 472   // branch to SharedRuntime::generate_forward_exception() which handles all possible callers,
 473   // i.e. call stub, compiled method, interpreted method.
 474   __ load_absolute_address(Z_tmp_1, StubRoutines::forward_exception_entry());
 475   __ z_br(Z_tmp_1);
 476 
 477   BLOCK_COMMENT(&quot;} abstract_entry&quot;);
 478 
 479   return __ addr_at(entry_offset);
 480 }
 481 
 482 address TemplateInterpreterGenerator::generate_Reference_get_entry(void) {
 483   // Inputs:
 484   //  Z_ARG1 - receiver
 485   //
 486   // What we do:
 487   //  - Load the referent field address.
 488   //  - Load the value in the referent field.
 489   //  - Pass that value to the pre-barrier.
 490   //
 491   // In the case of G1 this will record the value of the
 492   // referent in an SATB buffer if marking is active.
 493   // This will cause concurrent marking to mark the referent
 494   // field as live.
 495 
 496   Register  scratch1 = Z_tmp_2;
 497   Register  scratch2 = Z_tmp_3;
 498   Register  pre_val  = Z_RET;   // return value
 499   // Z_esp is callers operand stack pointer, i.e. it points to the parameters.
 500   Register  Rargp    = Z_esp;
 501 
 502   Label     slow_path;
 503   address   entry = __ pc();
 504 
<a name="2" id="anc2"></a><span class="line-modified"> 505   const int referent_offset = java_lang_ref_Reference::referent_offset();</span>

 506 
 507   BLOCK_COMMENT(&quot;Reference_get {&quot;);
 508 
 509   //  If the receiver is null then it is OK to jump to the slow path.
 510   __ load_and_test_long(pre_val, Address(Rargp, Interpreter::stackElementSize)); // Get receiver.
 511   __ z_bre(slow_path);
 512 
 513   //  Load the value of the referent field.
 514   __ load_heap_oop(pre_val, Address(pre_val, referent_offset), scratch1, scratch2, ON_WEAK_OOP_REF);
 515 
 516   // Restore caller sp for c2i case.
 517   __ resize_frame_absolute(Z_R10, Z_R0, true); // Cut the stack back to where the caller started.
 518   __ z_br(Z_R14);
 519 
 520   // Branch to previously generated regular method entry.
 521   __ bind(slow_path);
 522 
 523   address meth_entry = Interpreter::entry_for_kind(Interpreter::zerolocals);
 524   __ jump_to_entry(meth_entry, Z_R1);
 525 
 526   BLOCK_COMMENT(&quot;} Reference_get&quot;);
 527 
 528   return entry;
 529 }
 530 
 531 address TemplateInterpreterGenerator::generate_StackOverflowError_handler() {
 532   address entry = __ pc();
 533 
 534   DEBUG_ONLY(__ verify_esp(Z_esp, Z_ARG5));
 535 
 536   // Restore bcp under the assumption that the current frame is still
 537   // interpreted.
 538   __ restore_bcp();
 539 
 540   // Expression stack must be empty before entering the VM if an
 541   // exception happened.
 542   __ empty_expression_stack();
 543   // Throw exception.
 544   __ call_VM(noreg,
 545              CAST_FROM_FN_PTR(address, InterpreterRuntime::throw_StackOverflowError));
 546   return entry;
 547 }
 548 
 549 //
 550 // Args:
 551 //   Z_ARG2: oop of array
 552 //   Z_ARG3: aberrant index
 553 //
 554 address TemplateInterpreterGenerator::generate_ArrayIndexOutOfBounds_handler() {
 555   address entry = __ pc();
 556   address excp = CAST_FROM_FN_PTR(address, InterpreterRuntime::throw_ArrayIndexOutOfBoundsException);
 557 
 558   // Expression stack must be empty before entering the VM if an
 559   // exception happened.
 560   __ empty_expression_stack();
 561 
 562   // Setup parameters.
 563   // Pass register with array to create more detailed exceptions.
 564   __ call_VM(noreg, excp, Z_ARG2, Z_ARG3);
 565   return entry;
 566 }
 567 
 568 address TemplateInterpreterGenerator::generate_ClassCastException_handler() {
 569   address entry = __ pc();
 570 
 571   // Object is at TOS.
 572   __ pop_ptr(Z_ARG2);
 573 
 574   // Expression stack must be empty before entering the VM if an
 575   // exception happened.
 576   __ empty_expression_stack();
 577 
 578   __ call_VM(Z_ARG1,
 579              CAST_FROM_FN_PTR(address, InterpreterRuntime::throw_ClassCastException),
 580              Z_ARG2);
 581 
 582   DEBUG_ONLY(__ should_not_reach_here();)
 583 
 584   return entry;
 585 }
 586 
 587 address TemplateInterpreterGenerator::generate_exception_handler_common(const char* name, const char* message, bool pass_oop) {
 588   assert(!pass_oop || message == NULL, &quot;either oop or message but not both&quot;);
 589   address entry = __ pc();
 590 
 591   BLOCK_COMMENT(&quot;exception_handler_common {&quot;);
 592 
 593   // Expression stack must be empty before entering the VM if an
 594   // exception happened.
 595   __ empty_expression_stack();
 596   if (name != NULL) {
 597     __ load_absolute_address(Z_ARG2, (address)name);
 598   } else {
 599     __ clear_reg(Z_ARG2, true, false);
 600   }
 601 
 602   if (pass_oop) {
 603     __ call_VM(Z_tos,
 604                CAST_FROM_FN_PTR(address, InterpreterRuntime::create_klass_exception),
 605                Z_ARG2, Z_tos /*object (see TT::aastore())*/);
 606   } else {
 607     if (message != NULL) {
 608       __ load_absolute_address(Z_ARG3, (address)message);
 609     } else {
 610       __ clear_reg(Z_ARG3, true, false);
 611     }
 612     __ call_VM(Z_tos,
 613                CAST_FROM_FN_PTR(address, InterpreterRuntime::create_exception),
 614                Z_ARG2, Z_ARG3);
 615   }
 616   // Throw exception.
 617   __ load_absolute_address(Z_R1_scratch, Interpreter::throw_exception_entry());
 618   __ z_br(Z_R1_scratch);
 619 
 620   BLOCK_COMMENT(&quot;} exception_handler_common&quot;);
 621 
 622   return entry;
 623 }
 624 
 625 address TemplateInterpreterGenerator::generate_return_entry_for (TosState state, int step, size_t index_size) {
 626   address entry = __ pc();
 627 
 628   BLOCK_COMMENT(&quot;return_entry {&quot;);
 629 
 630   // Pop i2c extension or revert top-2-parent-resize done by interpreted callees.
 631   Register sp_before_i2c_extension = Z_bcp;
 632   __ z_lg(Z_fp, _z_abi(callers_sp), Z_SP); // Restore frame pointer.
 633   __ z_lg(sp_before_i2c_extension, Address(Z_fp, _z_ijava_state_neg(top_frame_sp)));
 634   __ resize_frame_absolute(sp_before_i2c_extension, Z_locals/*tmp*/, true/*load_fp*/);
 635 
 636   // TODO(ZASM): necessary??
 637   //  // and NULL it as marker that esp is now tos until next java call
 638   //  __ movptr(Address(rbp, frame::interpreter_frame_last_sp_offset * wordSize), (int32_t)NULL_WORD);
 639 
 640   __ restore_bcp();
 641   __ restore_locals();
 642   __ restore_esp();
 643 
 644   if (state == atos) {
 645     __ profile_return_type(Z_tmp_1, Z_tos, Z_tmp_2);
 646   }
 647 
 648   Register cache  = Z_tmp_1;
 649   Register size   = Z_tmp_1;
 650   Register offset = Z_tmp_2;
 651   const int flags_offset = in_bytes(ConstantPoolCache::base_offset() +
 652                                     ConstantPoolCacheEntry::flags_offset());
 653   __ get_cache_and_index_at_bcp(cache, offset, 1, index_size);
 654 
 655   // #args is in rightmost byte of the _flags field.
 656   __ z_llgc(size, Address(cache, offset, flags_offset+(sizeof(size_t)-1)));
 657   __ z_sllg(size, size, Interpreter::logStackElementSize); // Each argument size in bytes.
 658   __ z_agr(Z_esp, size);                                   // Pop arguments.
 659 
 660   __ check_and_handle_popframe(Z_thread);
 661   __ check_and_handle_earlyret(Z_thread);
 662 
 663   __ dispatch_next(state, step);
 664 
 665   BLOCK_COMMENT(&quot;} return_entry&quot;);
 666 
 667   return entry;
 668 }
 669 
 670 address TemplateInterpreterGenerator::generate_deopt_entry_for(TosState state,
 671                                                                int step,
 672                                                                address continuation) {
 673   address entry = __ pc();
 674 
 675   BLOCK_COMMENT(&quot;deopt_entry {&quot;);
 676 
 677   // TODO(ZASM): necessary? NULL last_sp until next java call
 678   // __ movptr(Address(rbp, frame::interpreter_frame_last_sp_offset * wordSize), (int32_t)NULL_WORD);
 679   __ z_lg(Z_fp, _z_abi(callers_sp), Z_SP); // Restore frame pointer.
 680   __ restore_bcp();
 681   __ restore_locals();
 682   __ restore_esp();
 683 
 684   // Handle exceptions.
 685   {
 686     Label L;
 687     __ load_and_test_long(Z_R0/*pending_exception*/, thread_(pending_exception));
 688     __ z_bre(L);
 689     __ call_VM(noreg,
 690                CAST_FROM_FN_PTR(address,
 691                                 InterpreterRuntime::throw_pending_exception));
 692     __ should_not_reach_here();
 693     __ bind(L);
 694   }
 695   if (continuation == NULL) {
 696     __ dispatch_next(state, step);
 697   } else {
 698     __ jump_to_entry(continuation, Z_R1_scratch);
 699   }
 700 
 701   BLOCK_COMMENT(&quot;} deopt_entry&quot;);
 702 
 703   return entry;
 704 }
 705 
 706 address TemplateInterpreterGenerator::generate_safept_entry_for (TosState state,
 707                                                                 address runtime_entry) {
 708   address entry = __ pc();
 709   __ push(state);
 710   __ call_VM(noreg, runtime_entry);
 711   __ dispatch_via(vtos, Interpreter::_normal_table.table_for (vtos));
 712   return entry;
 713 }
 714 
 715 //
 716 // Helpers for commoning out cases in the various type of method entries.
 717 //
 718 
 719 // Increment invocation count &amp; check for overflow.
 720 //
 721 // Note: checking for negative value instead of overflow
 722 // so we have a &#39;sticky&#39; overflow test.
 723 //
 724 // Z_ARG2: method (see generate_fixed_frame())
 725 //
 726 void TemplateInterpreterGenerator::generate_counter_incr(Label* overflow, Label* profile_method, Label* profile_method_continue) {
 727   Label done;
 728   Register method = Z_ARG2; // Generate_fixed_frame() copies Z_method into Z_ARG2.
 729   Register m_counters = Z_ARG4;
 730 
 731   BLOCK_COMMENT(&quot;counter_incr {&quot;);
 732 
 733   // Note: In tiered we increment either counters in method or in MDO depending
 734   // if we are profiling or not.
 735   if (TieredCompilation) {
 736     int increment = InvocationCounter::count_increment;
 737     if (ProfileInterpreter) {
 738       NearLabel no_mdo;
 739       Register mdo = m_counters;
 740       // Are we profiling?
 741       __ load_and_test_long(mdo, method2_(method, method_data));
 742       __ branch_optimized(Assembler::bcondZero, no_mdo);
 743       // Increment counter in the MDO.
 744       const Address mdo_invocation_counter(mdo, MethodData::invocation_counter_offset() +
 745                                            InvocationCounter::counter_offset());
 746       const Address mask(mdo, MethodData::invoke_mask_offset());
 747       __ increment_mask_and_jump(mdo_invocation_counter, increment, mask,
 748                                  Z_R1_scratch, false, Assembler::bcondZero,
 749                                  overflow);
 750       __ z_bru(done);
 751       __ bind(no_mdo);
 752     }
 753 
 754     // Increment counter in MethodCounters.
 755     const Address invocation_counter(m_counters,
 756                                      MethodCounters::invocation_counter_offset() +
 757                                      InvocationCounter::counter_offset());
 758     // Get address of MethodCounters object.
 759     __ get_method_counters(method, m_counters, done);
 760     const Address mask(m_counters, MethodCounters::invoke_mask_offset());
 761     __ increment_mask_and_jump(invocation_counter,
 762                                increment, mask,
 763                                Z_R1_scratch, false, Assembler::bcondZero,
 764                                overflow);
 765   } else {
 766     Register counter_sum = Z_ARG3; // The result of this piece of code.
 767     Register tmp         = Z_R1_scratch;
 768 #ifdef ASSERT
 769     {
 770       NearLabel ok;
 771       __ get_method(tmp);
 772       __ compare64_and_branch(method, tmp, Assembler::bcondEqual, ok);
 773       __ z_illtrap(0x66);
 774       __ bind(ok);
 775     }
 776 #endif
 777 
 778     // Get address of MethodCounters object.
 779     __ get_method_counters(method, m_counters, done);
 780     // Update standard invocation counters.
 781     __ increment_invocation_counter(m_counters, counter_sum);
 782     if (ProfileInterpreter) {
 783       __ add2mem_32(Address(m_counters, MethodCounters::interpreter_invocation_counter_offset()), 1, tmp);
 784       if (profile_method != NULL) {
 785         const Address profile_limit(m_counters, MethodCounters::interpreter_profile_limit_offset());
 786         __ z_cl(counter_sum, profile_limit);
 787         __ branch_optimized(Assembler::bcondLow, *profile_method_continue);
 788         // If no method data exists, go to profile_method.
 789         __ test_method_data_pointer(tmp, *profile_method);
 790       }
 791     }
 792 
 793     const Address invocation_limit(m_counters, MethodCounters::interpreter_invocation_limit_offset());
 794     __ z_cl(counter_sum, invocation_limit);
 795     __ branch_optimized(Assembler::bcondNotLow, *overflow);
 796   }
 797 
 798   __ bind(done);
 799 
 800   BLOCK_COMMENT(&quot;} counter_incr&quot;);
 801 }
 802 
 803 void TemplateInterpreterGenerator::generate_counter_overflow(Label&amp; do_continue) {
 804   // InterpreterRuntime::frequency_counter_overflow takes two
 805   // arguments, the first (thread) is passed by call_VM, the second
 806   // indicates if the counter overflow occurs at a backwards branch
 807   // (NULL bcp). We pass zero for it. The call returns the address
 808   // of the verified entry point for the method or NULL if the
 809   // compilation did not complete (either went background or bailed
 810   // out).
 811   __ clear_reg(Z_ARG2);
 812   __ call_VM(noreg,
 813              CAST_FROM_FN_PTR(address, InterpreterRuntime::frequency_counter_overflow),
 814              Z_ARG2);
 815   __ z_bru(do_continue);
 816 }
 817 
 818 void TemplateInterpreterGenerator::generate_stack_overflow_check(Register frame_size, Register tmp1) {
 819   Register tmp2 = Z_R1_scratch;
 820   const int page_size = os::vm_page_size();
 821   NearLabel after_frame_check;
 822 
 823   BLOCK_COMMENT(&quot;stack_overflow_check {&quot;);
 824 
 825   assert_different_registers(frame_size, tmp1);
 826 
 827   // Stack banging is sufficient overflow check if frame_size &lt; page_size.
 828   if (Immediate::is_uimm(page_size, 15)) {
 829     __ z_chi(frame_size, page_size);
 830     __ z_brl(after_frame_check);
 831   } else {
 832     __ load_const_optimized(tmp1, page_size);
 833     __ compareU32_and_branch(frame_size, tmp1, Assembler::bcondLow, after_frame_check);
 834   }
 835 
 836   // Get the stack base, and in debug, verify it is non-zero.
 837   __ z_lg(tmp1, thread_(stack_base));
 838 #ifdef ASSERT
 839   address reentry = NULL;
 840   NearLabel base_not_zero;
 841   __ compareU64_and_branch(tmp1, (intptr_t)0L, Assembler::bcondNotEqual, base_not_zero);
 842   reentry = __ stop_chain_static(reentry, &quot;stack base is zero in generate_stack_overflow_check&quot;);
 843   __ bind(base_not_zero);
 844 #endif
 845 
 846   // Get the stack size, and in debug, verify it is non-zero.
 847   assert(sizeof(size_t) == sizeof(intptr_t), &quot;wrong load size&quot;);
 848   __ z_lg(tmp2, thread_(stack_size));
 849 #ifdef ASSERT
 850   NearLabel size_not_zero;
 851   __ compareU64_and_branch(tmp2, (intptr_t)0L, Assembler::bcondNotEqual, size_not_zero);
 852   reentry = __ stop_chain_static(reentry, &quot;stack size is zero in generate_stack_overflow_check&quot;);
 853   __ bind(size_not_zero);
 854 #endif
 855 
 856   // Compute the beginning of the protected zone minus the requested frame size.
 857   __ z_sgr(tmp1, tmp2);
 858   __ add2reg(tmp1, JavaThread::stack_guard_zone_size());
 859 
 860   // Add in the size of the frame (which is the same as subtracting it from the
 861   // SP, which would take another register.
 862   __ z_agr(tmp1, frame_size);
 863 
 864   // The frame is greater than one page in size, so check against
 865   // the bottom of the stack.
 866   __ compareU64_and_branch(Z_SP, tmp1, Assembler::bcondHigh, after_frame_check);
 867 
 868   // The stack will overflow, throw an exception.
 869 
 870   // Restore SP to sender&#39;s sp. This is necessary if the sender&#39;s frame is an
 871   // extended compiled frame (see gen_c2i_adapter()) and safer anyway in case of
 872   // JSR292 adaptations.
 873   __ resize_frame_absolute(Z_R10, tmp1, true/*load_fp*/);
 874 
 875   // Note also that the restored frame is not necessarily interpreted.
 876   // Use the shared runtime version of the StackOverflowError.
 877   assert(StubRoutines::throw_StackOverflowError_entry() != NULL, &quot;stub not yet generated&quot;);
 878   AddressLiteral stub(StubRoutines::throw_StackOverflowError_entry());
 879   __ load_absolute_address(tmp1, StubRoutines::throw_StackOverflowError_entry());
 880   __ z_br(tmp1);
 881 
 882   // If you get to here, then there is enough stack space.
 883   __ bind(after_frame_check);
 884 
 885   BLOCK_COMMENT(&quot;} stack_overflow_check&quot;);
 886 }
 887 
 888 // Allocate monitor and lock method (asm interpreter).
 889 //
 890 // Args:
 891 //   Z_locals: locals
 892 
 893 void TemplateInterpreterGenerator::lock_method(void) {
 894 
 895   BLOCK_COMMENT(&quot;lock_method {&quot;);
 896 
 897   // Synchronize method.
 898   const Register method = Z_tmp_2;
 899   __ get_method(method);
 900 
 901 #ifdef ASSERT
 902   address reentry = NULL;
 903   {
 904     Label L;
 905     __ testbit(method2_(method, access_flags), JVM_ACC_SYNCHRONIZED_BIT);
 906     __ z_btrue(L);
 907     reentry = __ stop_chain_static(reentry, &quot;method doesn&#39;t need synchronization&quot;);
 908     __ bind(L);
 909   }
 910 #endif // ASSERT
 911 
 912   // Get synchronization object.
 913   const Register object = Z_tmp_2;
 914 
 915   {
 916     Label     done;
 917     Label     static_method;
 918 
 919     __ testbit(method2_(method, access_flags), JVM_ACC_STATIC_BIT);
 920     __ z_btrue(static_method);
 921 
 922     // non-static method: Load receiver obj from stack.
 923     __ mem2reg_opt(object, Address(Z_locals, Interpreter::local_offset_in_bytes(0)));
 924     __ z_bru(done);
 925 
 926     __ bind(static_method);
 927 
 928     // Lock the java mirror.
 929     // Load mirror from interpreter frame.
 930     __ z_lg(object, _z_ijava_state_neg(mirror), Z_fp);
 931 
 932 #ifdef ASSERT
 933     {
 934       NearLabel L;
 935       __ compare64_and_branch(object, (intptr_t) 0, Assembler::bcondNotEqual, L);
 936       reentry = __ stop_chain_static(reentry, &quot;synchronization object is NULL&quot;);
 937       __ bind(L);
 938     }
 939 #endif // ASSERT
 940 
 941     __ bind(done);
 942   }
 943 
 944   __ add_monitor_to_stack(true, Z_ARG3, Z_ARG4, Z_ARG5); // Allocate monitor elem.
 945   // Store object and lock it.
 946   __ get_monitors(Z_tmp_1);
 947   __ reg2mem_opt(object, Address(Z_tmp_1, BasicObjectLock::obj_offset_in_bytes()));
 948   __ lock_object(Z_tmp_1, object);
 949 
 950   BLOCK_COMMENT(&quot;} lock_method&quot;);
 951 }
 952 
 953 // Generate a fixed interpreter frame. This is identical setup for
 954 // interpreted methods and for native methods hence the shared code.
 955 //
 956 // Registers alive
 957 //   Z_thread   - JavaThread*
 958 //   Z_SP       - old stack pointer
 959 //   Z_method   - callee&#39;s method
 960 //   Z_esp      - parameter list (slot &#39;above&#39; last param)
 961 //   Z_R14      - return pc, to be stored in caller&#39;s frame
 962 //   Z_R10      - sender sp, note: Z_tmp_1 is Z_R10!
 963 //
 964 // Registers updated
 965 //   Z_SP       - new stack pointer
 966 //   Z_esp      - callee&#39;s operand stack pointer
 967 //                points to the slot above the value on top
 968 //   Z_locals   - used to access locals: locals[i] := *(Z_locals - i*BytesPerWord)
 969 //   Z_bcp      - the bytecode pointer
 970 //   Z_fp       - the frame pointer, thereby killing Z_method
 971 //   Z_ARG2     - copy of Z_method
 972 //
 973 void TemplateInterpreterGenerator::generate_fixed_frame(bool native_call) {
 974 
 975   //  stack layout
 976   //
 977   //   F1 [TOP_IJAVA_FRAME_ABI]              &lt;-- Z_SP, Z_R10 (see note below)
 978   //      [F1&#39;s operand stack (unused)]
 979   //      [F1&#39;s outgoing Java arguments]     &lt;-- Z_esp
 980   //      [F1&#39;s operand stack (non args)]
 981   //      [monitors]      (optional)
 982   //      [IJAVA_STATE]
 983   //
 984   //   F2 [PARENT_IJAVA_FRAME_ABI]
 985   //      ...
 986   //
 987   //  0x000
 988   //
 989   // Note: Z_R10, the sender sp, will be below Z_SP if F1 was extended by a c2i adapter.
 990 
 991   //=============================================================================
 992   // Allocate space for locals other than the parameters, the
 993   // interpreter state, monitors, and the expression stack.
 994 
 995   const Register local_count  = Z_ARG5;
 996   const Register fp           = Z_tmp_2;
 997   const Register const_method = Z_ARG1;
 998 
 999   BLOCK_COMMENT(&quot;generate_fixed_frame {&quot;);
1000   {
1001   // local registers
1002   const Register top_frame_size  = Z_ARG2;
1003   const Register sp_after_resize = Z_ARG3;
1004   const Register max_stack       = Z_ARG4;
1005 
1006   __ z_lg(const_method, Address(Z_method, Method::const_offset()));
1007   __ z_llgh(max_stack, Address(const_method, ConstMethod::size_of_parameters_offset()));
1008   __ z_sllg(Z_locals /*parameter_count bytes*/, max_stack /*parameter_count*/, LogBytesPerWord);
1009 
1010   if (native_call) {
1011     // If we&#39;re calling a native method, we replace max_stack (which is
1012     // zero) with space for the worst-case signature handler varargs
1013     // vector, which is:
1014     //   max_stack = max(Argument::n_register_parameters, parameter_count+2);
1015     //
1016     // We add two slots to the parameter_count, one for the jni
1017     // environment and one for a possible native mirror. We allocate
1018     // space for at least the number of ABI registers, even though
1019     // InterpreterRuntime::slow_signature_handler won&#39;t write more than
1020     // parameter_count+2 words when it creates the varargs vector at the
1021     // top of the stack. The generated slow signature handler will just
1022     // load trash into registers beyond the necessary number. We&#39;re
1023     // still going to cut the stack back by the ABI register parameter
1024     // count so as to get SP+16 pointing at the ABI outgoing parameter
1025     // area, so we need to allocate at least that much even though we&#39;re
1026     // going to throw it away.
1027     //
1028     __ add2reg(max_stack, 2);
1029 
1030     NearLabel passing_args_on_stack;
1031 
1032     // max_stack in bytes
1033     __ z_sllg(max_stack, max_stack, LogBytesPerWord);
1034 
1035     int argument_registers_in_bytes = Argument::n_register_parameters &lt;&lt; LogBytesPerWord;
1036     __ compare64_and_branch(max_stack, argument_registers_in_bytes, Assembler::bcondNotLow, passing_args_on_stack);
1037 
1038     __ load_const_optimized(max_stack, argument_registers_in_bytes);
1039 
1040     __ bind(passing_args_on_stack);
1041   } else {
1042     // !native_call
1043     // local_count = method-&gt;constMethod-&gt;max_locals();
1044     __ z_llgh(local_count, Address(const_method, ConstMethod::size_of_locals_offset()));
1045 
1046     // Calculate number of non-parameter locals (in slots):
1047     __ z_sgr(local_count, max_stack);
1048 
1049     // max_stack = method-&gt;max_stack();
1050     __ z_llgh(max_stack, Address(const_method, ConstMethod::max_stack_offset()));
1051     // max_stack in bytes
1052     __ z_sllg(max_stack, max_stack, LogBytesPerWord);
1053   }
1054 
1055   // Resize (i.e. normally shrink) the top frame F1 ...
1056   //   F1      [TOP_IJAVA_FRAME_ABI]          &lt;-- Z_SP, Z_R10
1057   //           F1&#39;s operand stack (free)
1058   //           ...
1059   //           F1&#39;s operand stack (free)      &lt;-- Z_esp
1060   //           F1&#39;s outgoing Java arg m
1061   //           ...
1062   //           F1&#39;s outgoing Java arg 0
1063   //           ...
1064   //
1065   //  ... into a parent frame (Z_R10 holds F1&#39;s SP before any modification, see also above)
1066   //
1067   //           +......................+
1068   //           :                      :        &lt;-- Z_R10, saved below as F0&#39;s z_ijava_state.sender_sp
1069   //           :                      :
1070   //   F1      [PARENT_IJAVA_FRAME_ABI]        &lt;-- Z_SP       \
1071   //           F0&#39;s non arg local                             | = delta
1072   //           ...                                            |
1073   //           F0&#39;s non arg local              &lt;-- Z_esp      /
1074   //           F1&#39;s outgoing Java arg m
1075   //           ...
1076   //           F1&#39;s outgoing Java arg 0
1077   //           ...
1078   //
1079   // then push the new top frame F0.
1080   //
1081   //   F0      [TOP_IJAVA_FRAME_ABI]    = frame::z_top_ijava_frame_abi_size \
1082   //           [operand stack]          = max_stack                          | = top_frame_size
1083   //           [IJAVA_STATE]            = frame::z_ijava_state_size         /
1084 
1085   // sp_after_resize = Z_esp - delta
1086   //
1087   // delta = PARENT_IJAVA_FRAME_ABI + (locals_count - params_count)
1088 
1089   __ add2reg(sp_after_resize, (Interpreter::stackElementSize) - (frame::z_parent_ijava_frame_abi_size), Z_esp);
1090   if (!native_call) {
1091     __ z_sllg(Z_R0_scratch, local_count, LogBytesPerWord); // Params have already been subtracted from local_count.
1092     __ z_slgr(sp_after_resize, Z_R0_scratch);
1093   }
1094 
1095   // top_frame_size = TOP_IJAVA_FRAME_ABI + max_stack + size of interpreter state
1096   __ add2reg(top_frame_size,
1097              frame::z_top_ijava_frame_abi_size +
1098              frame::z_ijava_state_size,
1099              max_stack);
1100 
1101   if (!native_call) {
1102     // Stack overflow check.
1103     // Native calls don&#39;t need the stack size check since they have no
1104     // expression stack and the arguments are already on the stack and
1105     // we only add a handful of words to the stack.
1106     Register frame_size = max_stack; // Reuse the register for max_stack.
1107     __ z_lgr(frame_size, Z_SP);
1108     __ z_sgr(frame_size, sp_after_resize);
1109     __ z_agr(frame_size, top_frame_size);
1110     generate_stack_overflow_check(frame_size, fp/*tmp1*/);
1111   }
1112 
1113   DEBUG_ONLY(__ z_cg(Z_R14, _z_abi16(return_pc), Z_SP));
1114   __ asm_assert_eq(&quot;killed Z_R14&quot;, 0);
1115   __ resize_frame_absolute(sp_after_resize, fp, true);
1116   __ save_return_pc(Z_R14);
1117 
1118   // ... and push the new frame F0.
1119   __ push_frame(top_frame_size, fp, true /*copy_sp*/, false);
1120   }
1121 
1122   //=============================================================================
1123   // Initialize the new frame F0: initialize interpreter state.
1124 
1125   {
1126   // locals
1127   const Register local_addr = Z_ARG4;
1128 
1129   BLOCK_COMMENT(&quot;generate_fixed_frame: initialize interpreter state {&quot;);
1130 
1131 #ifdef ASSERT
1132   // Set the magic number (using local_addr as tmp register).
1133   __ load_const_optimized(local_addr, frame::z_istate_magic_number);
1134   __ z_stg(local_addr, _z_ijava_state_neg(magic), fp);
1135 #endif
1136 
1137   // Save sender SP from F1 (i.e. before it was potentially modified by an
1138   // adapter) into F0&#39;s interpreter state. We use it as well to revert
1139   // resizing the frame above.
1140   __ z_stg(Z_R10, _z_ijava_state_neg(sender_sp), fp);
1141 
1142   // Load cp cache and save it at the end of this block.
1143   __ z_lg(Z_R1_scratch, Address(const_method, ConstMethod::constants_offset()));
1144   __ z_lg(Z_R1_scratch, Address(Z_R1_scratch, ConstantPool::cache_offset_in_bytes()));
1145 
1146   // z_ijava_state-&gt;method = method;
1147   __ z_stg(Z_method, _z_ijava_state_neg(method), fp);
1148 
1149   // Point locals at the first argument. Method&#39;s locals are the
1150   // parameters on top of caller&#39;s expression stack.
1151   // Tos points past last Java argument.
1152 
1153   __ z_agr(Z_locals, Z_esp);
1154   // z_ijava_state-&gt;locals - i*BytesPerWord points to i-th Java local (i starts at 0)
1155   // z_ijava_state-&gt;locals = Z_esp + parameter_count bytes
1156   __ z_stg(Z_locals, _z_ijava_state_neg(locals), fp);
1157 
1158   // z_ijava_state-&gt;oop_temp = NULL;
1159   __ store_const(Address(fp, oop_tmp_offset), 0);
1160 
1161   // Initialize z_ijava_state-&gt;mdx.
1162   Register Rmdp = Z_bcp;
1163   // native_call: assert that mdo == NULL
1164   const bool check_for_mdo = !native_call DEBUG_ONLY(|| native_call);
1165   if (ProfileInterpreter &amp;&amp; check_for_mdo) {
1166     Label get_continue;
1167 
1168     __ load_and_test_long(Rmdp, method_(method_data));
1169     __ z_brz(get_continue);
1170     DEBUG_ONLY(if (native_call) __ stop(&quot;native methods don&#39;t have a mdo&quot;));
1171     __ add2reg(Rmdp, in_bytes(MethodData::data_offset()));
1172     __ bind(get_continue);
1173   }
1174   __ z_stg(Rmdp, _z_ijava_state_neg(mdx), fp);
1175 
1176   // Initialize z_ijava_state-&gt;bcp and Z_bcp.
1177   if (native_call) {
1178     __ clear_reg(Z_bcp); // Must initialize. Will get written into frame where GC reads it.
1179   } else {
1180     __ add2reg(Z_bcp, in_bytes(ConstMethod::codes_offset()), const_method);
1181   }
1182   __ z_stg(Z_bcp, _z_ijava_state_neg(bcp), fp);
1183 
1184   // no monitors and empty operand stack
1185   // =&gt; z_ijava_state-&gt;monitors points to the top slot in IJAVA_STATE.
1186   // =&gt; Z_ijava_state-&gt;esp points one slot above into the operand stack.
1187   // z_ijava_state-&gt;monitors = fp - frame::z_ijava_state_size - Interpreter::stackElementSize;
1188   // z_ijava_state-&gt;esp = Z_esp = z_ijava_state-&gt;monitors;
1189   __ add2reg(Z_esp, -frame::z_ijava_state_size, fp);
1190   __ z_stg(Z_esp, _z_ijava_state_neg(monitors), fp);
1191   __ add2reg(Z_esp, -Interpreter::stackElementSize);
1192   __ z_stg(Z_esp, _z_ijava_state_neg(esp), fp);
1193 
1194   // z_ijava_state-&gt;cpoolCache = Z_R1_scratch (see load above);
1195   __ z_stg(Z_R1_scratch, _z_ijava_state_neg(cpoolCache), fp);
1196 
1197   // Get mirror and store it in the frame as GC root for this Method*.
1198   __ load_mirror_from_const_method(Z_R1_scratch, const_method);
1199   __ z_stg(Z_R1_scratch, _z_ijava_state_neg(mirror), fp);
1200 
1201   BLOCK_COMMENT(&quot;} generate_fixed_frame: initialize interpreter state&quot;);
1202 
1203   //=============================================================================
1204   if (!native_call) {
1205     // Local_count is already num_locals_slots - num_param_slots.
1206     // Start of locals: local_addr = Z_locals - locals size + 1 slot
1207     __ z_llgh(Z_R0_scratch, Address(const_method, ConstMethod::size_of_locals_offset()));
1208     __ add2reg(local_addr, BytesPerWord, Z_locals);
1209     __ z_sllg(Z_R0_scratch, Z_R0_scratch, LogBytesPerWord);
1210     __ z_sgr(local_addr, Z_R0_scratch);
1211 
1212     __ Clear_Array(local_count, local_addr, Z_ARG2);
1213   }
1214 
1215   }
1216   // Finally set the frame pointer, destroying Z_method.
1217   assert(Z_fp == Z_method, &quot;maybe set Z_fp earlier if other register than Z_method&quot;);
1218   // Oprofile analysis suggests to keep a copy in a register to be used by
1219   // generate_counter_incr().
1220   __ z_lgr(Z_ARG2, Z_method);
1221   __ z_lgr(Z_fp, fp);
1222 
1223   BLOCK_COMMENT(&quot;} generate_fixed_frame&quot;);
1224 }
1225 
1226 // Various method entries
1227 
1228 // Math function, frame manager must set up an interpreter state, etc.
1229 address TemplateInterpreterGenerator::generate_math_entry(AbstractInterpreter::MethodKind kind) {
1230 
1231   // Decide what to do: Use same platform specific instructions and runtime calls as compilers.
1232   bool use_instruction = false;
1233   address runtime_entry = NULL;
1234   int num_args = 1;
1235   bool double_precision = true;
1236 
1237   // s390 specific:
1238   switch (kind) {
1239     case Interpreter::java_lang_math_sqrt:
1240     case Interpreter::java_lang_math_abs:  use_instruction = true; break;
1241     case Interpreter::java_lang_math_fmaF:
1242     case Interpreter::java_lang_math_fmaD: use_instruction = UseFMA; break;
1243     default: break; // Fall back to runtime call.
1244   }
1245 
1246   switch (kind) {
1247     case Interpreter::java_lang_math_sin  : runtime_entry = CAST_FROM_FN_PTR(address, SharedRuntime::dsin);   break;
1248     case Interpreter::java_lang_math_cos  : runtime_entry = CAST_FROM_FN_PTR(address, SharedRuntime::dcos);   break;
1249     case Interpreter::java_lang_math_tan  : runtime_entry = CAST_FROM_FN_PTR(address, SharedRuntime::dtan);   break;
1250     case Interpreter::java_lang_math_abs  : /* run interpreted */ break;
1251     case Interpreter::java_lang_math_sqrt : /* runtime_entry = CAST_FROM_FN_PTR(address, SharedRuntime::dsqrt); not available */ break;
1252     case Interpreter::java_lang_math_log  : runtime_entry = CAST_FROM_FN_PTR(address, SharedRuntime::dlog);   break;
1253     case Interpreter::java_lang_math_log10: runtime_entry = CAST_FROM_FN_PTR(address, SharedRuntime::dlog10); break;
1254     case Interpreter::java_lang_math_pow  : runtime_entry = CAST_FROM_FN_PTR(address, SharedRuntime::dpow); num_args = 2; break;
1255     case Interpreter::java_lang_math_exp  : runtime_entry = CAST_FROM_FN_PTR(address, SharedRuntime::dexp);   break;
1256     case Interpreter::java_lang_math_fmaF : /* run interpreted */ num_args = 3; double_precision = false; break;
1257     case Interpreter::java_lang_math_fmaD : /* run interpreted */ num_args = 3; break;
1258     default: ShouldNotReachHere();
1259   }
1260 
1261   // Use normal entry if neither instruction nor runtime call is used.
1262   if (!use_instruction &amp;&amp; runtime_entry == NULL) return NULL;
1263 
1264   address entry = __ pc();
1265 
1266   if (use_instruction) {
1267     switch (kind) {
1268       case Interpreter::java_lang_math_sqrt:
1269         // Can use memory operand directly.
1270         __ z_sqdb(Z_FRET, Interpreter::stackElementSize, Z_esp);
1271         break;
1272       case Interpreter::java_lang_math_abs:
1273         // Load operand from stack.
1274         __ mem2freg_opt(Z_FRET, Address(Z_esp, Interpreter::stackElementSize));
1275         __ z_lpdbr(Z_FRET);
1276         break;
1277       case Interpreter::java_lang_math_fmaF:
1278         __ mem2freg_opt(Z_FRET,  Address(Z_esp,     Interpreter::stackElementSize)); // result reg = arg3
1279         __ mem2freg_opt(Z_FARG2, Address(Z_esp, 3 * Interpreter::stackElementSize)); // arg1
1280         __ z_maeb(Z_FRET, Z_FARG2, Address(Z_esp, 2 * Interpreter::stackElementSize));
1281         break;
1282       case Interpreter::java_lang_math_fmaD:
1283         __ mem2freg_opt(Z_FRET,  Address(Z_esp,     Interpreter::stackElementSize)); // result reg = arg3
1284         __ mem2freg_opt(Z_FARG2, Address(Z_esp, 5 * Interpreter::stackElementSize)); // arg1
1285         __ z_madb(Z_FRET, Z_FARG2, Address(Z_esp, 3 * Interpreter::stackElementSize));
1286         break;
1287       default: ShouldNotReachHere();
1288     }
1289   } else {
1290     // Load arguments
1291     assert(num_args &lt;= 4, &quot;passed in registers&quot;);
1292     if (double_precision) {
1293       int offset = (2 * num_args - 1) * Interpreter::stackElementSize;
1294       for (int i = 0; i &lt; num_args; ++i) {
1295         __ mem2freg_opt(as_FloatRegister(Z_FARG1-&gt;encoding() + 2 * i), Address(Z_esp, offset));
1296         offset -= 2 * Interpreter::stackElementSize;
1297       }
1298     } else {
1299       int offset = num_args * Interpreter::stackElementSize;
1300       for (int i = 0; i &lt; num_args; ++i) {
1301         __ mem2freg_opt(as_FloatRegister(Z_FARG1-&gt;encoding() + 2 * i), Address(Z_esp, offset));
1302         offset -= Interpreter::stackElementSize;
1303       }
1304     }
1305     // Call runtime
1306     __ save_return_pc();       // Save Z_R14.
1307     __ push_frame_abi160(0);   // Without new frame the RT call could overwrite the saved Z_R14.
1308 
1309     __ call_VM_leaf(runtime_entry);
1310 
1311     __ pop_frame();
1312     __ restore_return_pc();    // Restore Z_R14.
1313   }
1314 
1315   // Pop c2i arguments (if any) off when we return.
1316   __ resize_frame_absolute(Z_R10, Z_R0, true); // Cut the stack back to where the caller started.
1317 
1318   __ z_br(Z_R14);
1319 
1320   return entry;
1321 }
1322 
1323 // Interpreter stub for calling a native method. (asm interpreter).
1324 // This sets up a somewhat different looking stack for calling the
1325 // native method than the typical interpreter frame setup.
1326 address TemplateInterpreterGenerator::generate_native_entry(bool synchronized) {
1327   // Determine code generation flags.
1328   bool inc_counter = UseCompiler || CountCompiledCalls || LogTouchedMethods;
1329 
1330   // Interpreter entry for ordinary Java methods.
1331   //
1332   // Registers alive
1333   //   Z_SP          - stack pointer
1334   //   Z_thread      - JavaThread*
1335   //   Z_method      - callee&#39;s method (method to be invoked)
1336   //   Z_esp         - operand (or expression) stack pointer of caller. one slot above last arg.
1337   //   Z_R10         - sender sp (before modifications, e.g. by c2i adapter
1338   //                   and as well by generate_fixed_frame below)
1339   //   Z_R14         - return address to caller (call_stub or c2i_adapter)
1340   //
1341   // Registers updated
1342   //   Z_SP          - stack pointer
1343   //   Z_fp          - callee&#39;s framepointer
1344   //   Z_esp         - callee&#39;s operand stack pointer
1345   //                   points to the slot above the value on top
1346   //   Z_locals      - used to access locals: locals[i] := *(Z_locals - i*BytesPerWord)
1347   //   Z_tos         - integer result, if any
1348   //   z_ftos        - floating point result, if any
1349   //
1350   // Stack layout at this point:
1351   //
1352   //   F1      [TOP_IJAVA_FRAME_ABI]         &lt;-- Z_SP, Z_R10 (Z_R10 will be below Z_SP if
1353   //                                                          frame was extended by c2i adapter)
1354   //           [outgoing Java arguments]     &lt;-- Z_esp
1355   //           ...
1356   //   PARENT  [PARENT_IJAVA_FRAME_ABI]
1357   //           ...
1358   //
1359 
1360   address entry_point = __ pc();
1361 
1362   // Make sure registers are different!
1363   assert_different_registers(Z_thread, Z_method, Z_esp);
1364 
1365   BLOCK_COMMENT(&quot;native_entry {&quot;);
1366 
1367   // Make sure method is native and not abstract.
1368 #ifdef ASSERT
1369   address reentry = NULL;
1370   { Label L;
1371     __ testbit(method_(access_flags), JVM_ACC_NATIVE_BIT);
1372     __ z_btrue(L);
1373     reentry = __ stop_chain_static(reentry, &quot;tried to execute non-native method as native&quot;);
1374     __ bind(L);
1375   }
1376   { Label L;
1377     __ testbit(method_(access_flags), JVM_ACC_ABSTRACT_BIT);
1378     __ z_bfalse(L);
1379     reentry = __ stop_chain_static(reentry, &quot;tried to execute abstract method as non-abstract&quot;);
1380     __ bind(L);
1381   }
1382 #endif // ASSERT
1383 
1384 #ifdef ASSERT
1385   // Save the return PC into the callers frame for assertion in generate_fixed_frame.
1386   __ save_return_pc(Z_R14);
1387 #endif
1388 
1389   // Generate the code to allocate the interpreter stack frame.
1390   generate_fixed_frame(true);
1391 
1392   const Address do_not_unlock_if_synchronized(Z_thread, JavaThread::do_not_unlock_if_synchronized_offset());
1393   // Since at this point in the method invocation the exception handler
1394   // would try to exit the monitor of synchronized methods which hasn&#39;t
1395   // been entered yet, we set the thread local variable
1396   // _do_not_unlock_if_synchronized to true. If any exception was thrown by
1397   // runtime, exception handling i.e. unlock_if_synchronized_method will
1398   // check this thread local flag.
1399   __ z_mvi(do_not_unlock_if_synchronized, true);
1400 
1401   // Increment invocation count and check for overflow.
1402   NearLabel invocation_counter_overflow;
1403   if (inc_counter) {
1404     generate_counter_incr(&amp;invocation_counter_overflow, NULL, NULL);
1405   }
1406 
1407   Label continue_after_compile;
1408   __ bind(continue_after_compile);
1409 
1410   bang_stack_shadow_pages(true);
1411 
1412   // Reset the _do_not_unlock_if_synchronized flag.
1413   __ z_mvi(do_not_unlock_if_synchronized, false);
1414 
1415   // Check for synchronized methods.
1416   // This mst happen AFTER invocation_counter check and stack overflow check,
1417   // so method is not locked if overflows.
1418   if (synchronized) {
1419     lock_method();
1420   } else {
1421     // No synchronization necessary.
1422 #ifdef ASSERT
1423     { Label L;
1424       __ get_method(Z_R1_scratch);
1425       __ testbit(method2_(Z_R1_scratch, access_flags), JVM_ACC_SYNCHRONIZED_BIT);
1426       __ z_bfalse(L);
1427       reentry = __ stop_chain_static(reentry, &quot;method needs synchronization&quot;);
1428       __ bind(L);
1429     }
1430 #endif // ASSERT
1431   }
1432 
1433   // start execution
1434 
1435   // jvmti support
1436   __ notify_method_entry();
1437 
1438   //=============================================================================
1439   // Get and call the signature handler.
1440   const Register Rmethod                 = Z_tmp_2;
1441   const Register signature_handler_entry = Z_tmp_1;
1442   const Register Rresult_handler         = Z_tmp_3;
1443   Label call_signature_handler;
1444 
1445   assert_different_registers(Z_fp, Rmethod, signature_handler_entry, Rresult_handler);
1446   assert(Rresult_handler-&gt;is_nonvolatile(), &quot;Rresult_handler must be in a non-volatile register&quot;);
1447 
1448   // Reload method.
1449   __ get_method(Rmethod);
1450 
1451   // Check for signature handler.
1452   __ load_and_test_long(signature_handler_entry, method2_(Rmethod, signature_handler));
1453   __ z_brne(call_signature_handler);
1454 
1455   // Method has never been called. Either generate a specialized
1456   // handler or point to the slow one.
1457   __ call_VM(noreg, CAST_FROM_FN_PTR(address, InterpreterRuntime::prepare_native_call),
1458              Rmethod);
1459 
1460   // Reload method.
1461   __ get_method(Rmethod);
1462 
1463   // Reload signature handler, it must have been created/assigned in the meantime.
1464   __ z_lg(signature_handler_entry, method2_(Rmethod, signature_handler));
1465 
1466   __ bind(call_signature_handler);
1467 
1468   // We have a TOP_IJAVA_FRAME here, which belongs to us.
1469   __ set_top_ijava_frame_at_SP_as_last_Java_frame(Z_SP, Z_R1/*tmp*/);
1470 
1471   // Call signature handler and pass locals address in Z_ARG1.
1472   __ z_lgr(Z_ARG1, Z_locals);
1473   __ call_stub(signature_handler_entry);
1474   // Save result handler returned by signature handler.
1475   __ z_lgr(Rresult_handler, Z_RET);
1476 
1477   // Reload method (the slow signature handler may block for GC).
1478   __ get_method(Rmethod);
1479 
1480   // Pass mirror handle if static call.
1481   {
1482     Label method_is_not_static;
1483     __ testbit(method2_(Rmethod, access_flags), JVM_ACC_STATIC_BIT);
1484     __ z_bfalse(method_is_not_static);
1485     // Load mirror from interpreter frame.
1486     __ z_lg(Z_R1, _z_ijava_state_neg(mirror), Z_fp);
1487     // z_ijava_state.oop_temp = pool_holder-&gt;klass_part()-&gt;java_mirror();
1488     __ z_stg(Z_R1, oop_tmp_offset, Z_fp);
1489     // Pass handle to mirror as 2nd argument to JNI method.
1490     __ add2reg(Z_ARG2, oop_tmp_offset, Z_fp);
1491     __ bind(method_is_not_static);
1492   }
1493 
1494   // Pass JNIEnv address as first parameter.
1495   __ add2reg(Z_ARG1, in_bytes(JavaThread::jni_environment_offset()), Z_thread);
1496 
1497   // Note: last java frame has been set above already. The pc from there
1498   // is precise enough.
1499 
1500   // Get native function entry point before we change the thread state.
1501   __ z_lg(Z_R1/*native_method_entry*/, method2_(Rmethod, native_function));
1502 
1503   //=============================================================================
1504   // Transition from _thread_in_Java to _thread_in_native. As soon as
1505   // we make this change the safepoint code needs to be certain that
1506   // the last Java frame we established is good. The pc in that frame
1507   // just need to be near here not an actual return address.
1508 #ifdef ASSERT
1509   {
1510     NearLabel L;
1511     __ mem2reg_opt(Z_R14, Address(Z_thread, JavaThread::thread_state_offset()), false /*32 bits*/);
1512     __ compareU32_and_branch(Z_R14, _thread_in_Java, Assembler::bcondEqual, L);
1513     reentry = __ stop_chain_static(reentry, &quot;Wrong thread state in native stub&quot;);
1514     __ bind(L);
1515   }
1516 #endif
1517 
1518   // Memory ordering: Z does not reorder store/load with subsequent load. That&#39;s strong enough.
1519   __ set_thread_state(_thread_in_native);
1520 
1521   //=============================================================================
1522   // Call the native method. Argument registers must not have been
1523   // overwritten since &quot;__ call_stub(signature_handler);&quot; (except for
1524   // ARG1 and ARG2 for static methods).
1525 
1526   __ call_c(Z_R1/*native_method_entry*/);
1527 
1528   // NOTE: frame::interpreter_frame_result() depends on these stores.
1529   __ z_stg(Z_RET, _z_ijava_state_neg(lresult), Z_fp);
1530   __ freg2mem_opt(Z_FRET, Address(Z_fp, _z_ijava_state_neg(fresult)));
1531   const Register Rlresult = signature_handler_entry;
1532   assert(Rlresult-&gt;is_nonvolatile(), &quot;Rlresult must be in a non-volatile register&quot;);
1533   __ z_lgr(Rlresult, Z_RET);
1534 
1535   // Z_method may no longer be valid, because of GC.
1536 
1537   // Block, if necessary, before resuming in _thread_in_Java state.
1538   // In order for GC to work, don&#39;t clear the last_Java_sp until after
1539   // blocking.
1540 
1541   //=============================================================================
1542   // Switch thread to &quot;native transition&quot; state before reading the
1543   // synchronization state. This additional state is necessary
1544   // because reading and testing the synchronization state is not
1545   // atomic w.r.t. GC, as this scenario demonstrates: Java thread A,
1546   // in _thread_in_native state, loads _not_synchronized and is
1547   // preempted. VM thread changes sync state to synchronizing and
1548   // suspends threads for GC. Thread A is resumed to finish this
1549   // native method, but doesn&#39;t block here since it didn&#39;t see any
1550   // synchronization is progress, and escapes.
1551 
1552   __ set_thread_state(_thread_in_native_trans);
1553   __ z_fence();
1554 
1555   // Now before we return to java we must look for a current safepoint
1556   // (a new safepoint can not start since we entered native_trans).
1557   // We must check here because a current safepoint could be modifying
1558   // the callers registers right this moment.
1559 
1560   // Check for safepoint operation in progress and/or pending suspend requests.
1561   {
1562     Label Continue, do_safepoint;
1563     __ safepoint_poll(do_safepoint, Z_R1);
1564     // Check for suspend.
1565     __ load_and_test_int(Z_R0/*suspend_flags*/, thread_(suspend_flags));
1566     __ z_bre(Continue); // 0 -&gt; no flag set -&gt; not suspended
1567     __ bind(do_safepoint);
1568     __ z_lgr(Z_ARG1, Z_thread);
1569     __ call_c(CAST_FROM_FN_PTR(address, JavaThread::check_special_condition_for_native_trans));
1570     __ bind(Continue);
1571   }
1572 
1573   //=============================================================================
1574   // Back in Interpreter Frame.
1575 
1576   // We are in thread_in_native_trans here and back in the normal
1577   // interpreter frame. We don&#39;t have to do anything special about
1578   // safepoints and we can switch to Java mode anytime we are ready.
1579 
1580   // Note: frame::interpreter_frame_result has a dependency on how the
1581   // method result is saved across the call to post_method_exit. For
1582   // native methods it assumes that the non-FPU/non-void result is
1583   // saved in z_ijava_state.lresult and a FPU result in z_ijava_state.fresult. If
1584   // this changes then the interpreter_frame_result implementation
1585   // will need to be updated too.
1586 
1587   //=============================================================================
1588   // Back in Java.
1589 
1590   // Memory ordering: Z does not reorder store/load with subsequent
1591   // load. That&#39;s strong enough.
1592   __ set_thread_state(_thread_in_Java);
1593 
1594   __ reset_last_Java_frame();
1595 
1596   // We reset the JNI handle block only after unboxing the result; see below.
1597 
1598   // The method register is junk from after the thread_in_native transition
1599   // until here. Also can&#39;t call_VM until the bcp has been
1600   // restored. Need bcp for throwing exception below so get it now.
1601   __ get_method(Rmethod);
1602 
1603   // Restore Z_bcp to have legal interpreter frame,
1604   // i.e., bci == 0 &lt;=&gt; Z_bcp == code_base().
1605   __ z_lg(Z_bcp, Address(Rmethod, Method::const_offset())); // get constMethod
1606   __ add2reg(Z_bcp, in_bytes(ConstMethod::codes_offset())); // get codebase
1607 
1608   if (CheckJNICalls) {
1609     // clear_pending_jni_exception_check
1610     __ clear_mem(Address(Z_thread, JavaThread::pending_jni_exception_check_fn_offset()), sizeof(oop));
1611   }
1612 
1613   // Check if the native method returns an oop, and if so, move it
1614   // from the jni handle to z_ijava_state.oop_temp. This is
1615   // necessary, because we reset the jni handle block below.
1616   // NOTE: frame::interpreter_frame_result() depends on this, too.
1617   { NearLabel no_oop_result;
1618   __ load_absolute_address(Z_R1, AbstractInterpreter::result_handler(T_OBJECT));
1619   __ compareU64_and_branch(Z_R1, Rresult_handler, Assembler::bcondNotEqual, no_oop_result);
1620   __ resolve_jobject(Rlresult, /* tmp1 */ Rmethod, /* tmp2 */ Z_R1);
1621   __ z_stg(Rlresult, oop_tmp_offset, Z_fp);
1622   __ bind(no_oop_result);
1623   }
1624 
1625   // Reset handle block.
1626   __ z_lg(Z_R1/*active_handles*/, thread_(active_handles));
1627   __ clear_mem(Address(Z_R1, JNIHandleBlock::top_offset_in_bytes()), 4);
1628 
1629   // Handle exceptions (exception handling will handle unlocking!).
1630   {
1631     Label L;
1632     __ load_and_test_long(Z_R0/*pending_exception*/, thread_(pending_exception));
1633     __ z_bre(L);
1634     __ MacroAssembler::call_VM(noreg,
1635                                CAST_FROM_FN_PTR(address,
1636                                InterpreterRuntime::throw_pending_exception));
1637     __ should_not_reach_here();
1638     __ bind(L);
1639   }
1640 
1641   if (synchronized) {
1642     Register Rfirst_monitor = Z_ARG2;
1643     __ add2reg(Rfirst_monitor, -(frame::z_ijava_state_size + (int)sizeof(BasicObjectLock)), Z_fp);
1644 #ifdef ASSERT
1645     NearLabel ok;
1646     __ z_lg(Z_R1, _z_ijava_state_neg(monitors), Z_fp);
1647     __ compareU64_and_branch(Rfirst_monitor, Z_R1, Assembler::bcondEqual, ok);
1648     reentry = __ stop_chain_static(reentry, &quot;native_entry:unlock: inconsistent z_ijava_state.monitors&quot;);
1649     __ bind(ok);
1650 #endif
1651     __ unlock_object(Rfirst_monitor);
1652   }
1653 
1654   // JVMTI support. Result has already been saved above to the frame.
1655   __ notify_method_exit(true/*native_method*/, ilgl, InterpreterMacroAssembler::NotifyJVMTI);
1656 
1657   // Move native method result back into proper registers and return.
1658   __ mem2freg_opt(Z_FRET, Address(Z_fp, _z_ijava_state_neg(fresult)));
1659   __ mem2reg_opt(Z_RET, Address(Z_fp, _z_ijava_state_neg(lresult)));
1660   __ call_stub(Rresult_handler);
1661 
1662   // Pop the native method&#39;s interpreter frame.
1663   __ pop_interpreter_frame(Z_R14 /*return_pc*/, Z_ARG2/*tmp1*/, Z_ARG3/*tmp2*/);
1664 
1665   // Return to caller.
1666   __ z_br(Z_R14);
1667 
1668   if (inc_counter) {
1669     // Handle overflow of counter and compile method.
1670     __ bind(invocation_counter_overflow);
1671     generate_counter_overflow(continue_after_compile);
1672   }
1673 
1674   BLOCK_COMMENT(&quot;} native_entry&quot;);
1675 
1676   return entry_point;
1677 }
1678 
1679 //
1680 // Generic interpreted method entry to template interpreter.
1681 //
1682 address TemplateInterpreterGenerator::generate_normal_entry(bool synchronized) {
1683   address entry_point = __ pc();
1684 
1685   bool inc_counter = UseCompiler || CountCompiledCalls || LogTouchedMethods;
1686 
1687   // Interpreter entry for ordinary Java methods.
1688   //
1689   // Registers alive
1690   //   Z_SP       - stack pointer
1691   //   Z_thread   - JavaThread*
1692   //   Z_method   - callee&#39;s method (method to be invoked)
1693   //   Z_esp      - operand (or expression) stack pointer of caller. one slot above last arg.
1694   //   Z_R10      - sender sp (before modifications, e.g. by c2i adapter
1695   //                           and as well by generate_fixed_frame below)
1696   //   Z_R14      - return address to caller (call_stub or c2i_adapter)
1697   //
1698   // Registers updated
1699   //   Z_SP       - stack pointer
1700   //   Z_fp       - callee&#39;s framepointer
1701   //   Z_esp      - callee&#39;s operand stack pointer
1702   //                points to the slot above the value on top
1703   //   Z_locals   - used to access locals: locals[i] := *(Z_locals - i*BytesPerWord)
1704   //   Z_tos      - integer result, if any
1705   //   z_ftos     - floating point result, if any
1706   //
1707   //
1708   // stack layout at this point:
1709   //
1710   //   F1      [TOP_IJAVA_FRAME_ABI]         &lt;-- Z_SP, Z_R10 (Z_R10 will be below Z_SP if
1711   //                                                          frame was extended by c2i adapter)
1712   //           [outgoing Java arguments]     &lt;-- Z_esp
1713   //           ...
1714   //   PARENT  [PARENT_IJAVA_FRAME_ABI]
1715   //           ...
1716   //
1717   // stack layout before dispatching the first bytecode:
1718   //
1719   //   F0      [TOP_IJAVA_FRAME_ABI]         &lt;-- Z_SP
1720   //           [operand stack]               &lt;-- Z_esp
1721   //           monitor (optional, can grow)
1722   //           [IJAVA_STATE]
1723   //   F1      [PARENT_IJAVA_FRAME_ABI]      &lt;-- Z_fp (== *Z_SP)
1724   //           [F0&#39;s locals]                 &lt;-- Z_locals
1725   //           [F1&#39;s operand stack]
1726   //           [F1&#39;s monitors] (optional)
1727   //           [IJAVA_STATE]
1728 
1729   // Make sure registers are different!
1730   assert_different_registers(Z_thread, Z_method, Z_esp);
1731 
1732   BLOCK_COMMENT(&quot;normal_entry {&quot;);
1733 
1734   // Make sure method is not native and not abstract.
1735   // Rethink these assertions - they can be simplified and shared.
1736 #ifdef ASSERT
1737   address reentry = NULL;
1738   { Label L;
1739     __ testbit(method_(access_flags), JVM_ACC_NATIVE_BIT);
1740     __ z_bfalse(L);
1741     reentry = __ stop_chain_static(reentry, &quot;tried to execute native method as non-native&quot;);
1742     __ bind(L);
1743   }
1744   { Label L;
1745     __ testbit(method_(access_flags), JVM_ACC_ABSTRACT_BIT);
1746     __ z_bfalse(L);
1747     reentry = __ stop_chain_static(reentry, &quot;tried to execute abstract method as non-abstract&quot;);
1748     __ bind(L);
1749   }
1750 #endif // ASSERT
1751 
1752 #ifdef ASSERT
1753   // Save the return PC into the callers frame for assertion in generate_fixed_frame.
1754   __ save_return_pc(Z_R14);
1755 #endif
1756 
1757   // Generate the code to allocate the interpreter stack frame.
1758   generate_fixed_frame(false);
1759 
1760   const Address do_not_unlock_if_synchronized(Z_thread, JavaThread::do_not_unlock_if_synchronized_offset());
1761   // Since at this point in the method invocation the exception handler
1762   // would try to exit the monitor of synchronized methods which hasn&#39;t
1763   // been entered yet, we set the thread local variable
1764   // _do_not_unlock_if_synchronized to true. If any exception was thrown by
1765   // runtime, exception handling i.e. unlock_if_synchronized_method will
1766   // check this thread local flag.
1767   __ z_mvi(do_not_unlock_if_synchronized, true);
1768 
1769   __ profile_parameters_type(Z_tmp_2, Z_ARG3, Z_ARG4);
1770 
1771   // Increment invocation counter and check for overflow.
1772   //
1773   // Note: checking for negative value instead of overflow so we have a &#39;sticky&#39;
1774   // overflow test (may be of importance as soon as we have true MT/MP).
1775   NearLabel invocation_counter_overflow;
1776   NearLabel profile_method;
1777   NearLabel profile_method_continue;
1778   NearLabel Lcontinue;
1779   if (inc_counter) {
1780     generate_counter_incr(&amp;invocation_counter_overflow, &amp;profile_method, &amp;profile_method_continue);
1781     if (ProfileInterpreter) {
1782       __ bind(profile_method_continue);
1783     }
1784   }
1785   __ bind(Lcontinue);
1786 
1787   bang_stack_shadow_pages(false);
1788 
1789   // Reset the _do_not_unlock_if_synchronized flag.
1790   __ z_mvi(do_not_unlock_if_synchronized, false);
1791 
1792   // Check for synchronized methods.
1793   // Must happen AFTER invocation_counter check and stack overflow check,
1794   // so method is not locked if overflows.
1795   if (synchronized) {
1796     // Allocate monitor and lock method.
1797     lock_method();
1798   } else {
1799 #ifdef ASSERT
1800     { Label L;
1801       __ get_method(Z_R1_scratch);
1802       __ testbit(method2_(Z_R1_scratch, access_flags), JVM_ACC_SYNCHRONIZED_BIT);
1803       __ z_bfalse(L);
1804       reentry = __ stop_chain_static(reentry, &quot;method needs synchronization&quot;);
1805       __ bind(L);
1806     }
1807 #endif // ASSERT
1808   }
1809 
1810   // start execution
1811 
1812 #ifdef ASSERT
1813   __ verify_esp(Z_esp, Z_R1_scratch);
1814 
1815   __ verify_thread();
1816 #endif
1817 
1818   // jvmti support
1819   __ notify_method_entry();
1820 
1821   // Start executing instructions.
1822   __ dispatch_next(vtos);
1823   // Dispatch_next does not return.
1824   DEBUG_ONLY(__ should_not_reach_here());
1825 
1826   // Invocation counter overflow.
1827   if (inc_counter) {
1828     if (ProfileInterpreter) {
1829       // We have decided to profile this method in the interpreter.
1830       __ bind(profile_method);
1831 
1832       __ call_VM(noreg, CAST_FROM_FN_PTR(address, InterpreterRuntime::profile_method));
1833       __ set_method_data_pointer_for_bcp();
1834       __ z_bru(profile_method_continue);
1835     }
1836 
1837     // Handle invocation counter overflow.
1838     __ bind(invocation_counter_overflow);
1839     generate_counter_overflow(Lcontinue);
1840   }
1841 
1842   BLOCK_COMMENT(&quot;} normal_entry&quot;);
1843 
1844   return entry_point;
1845 }
1846 
1847 
1848 /**
1849  * Method entry for static native methods:
1850  *   int java.util.zip.CRC32.update(int crc, int b)
1851  */
1852 address TemplateInterpreterGenerator::generate_CRC32_update_entry() {
1853 
1854   if (UseCRC32Intrinsics) {
1855     uint64_t entry_off = __ offset();
1856     Label    slow_path;
1857 
1858     // If we need a safepoint check, generate full interpreter entry.
1859     __ safepoint_poll(slow_path, Z_R1);
1860 
1861     BLOCK_COMMENT(&quot;CRC32_update {&quot;);
1862 
1863     // We don&#39;t generate local frame and don&#39;t align stack because
1864     // we not even call stub code (we generate the code inline)
1865     // and there is no safepoint on this path.
1866 
1867     // Load java parameters.
1868     // Z_esp is callers operand stack pointer, i.e. it points to the parameters.
1869     const Register argP    = Z_esp;
1870     const Register crc     = Z_ARG1;  // crc value
1871     const Register data    = Z_ARG2;  // address of java byte value (kernel_crc32 needs address)
1872     const Register dataLen = Z_ARG3;  // source data len (1 byte). Not used because calling the single-byte emitter.
1873     const Register table   = Z_ARG4;  // address of crc32 table
1874 
1875     // Arguments are reversed on java expression stack.
1876     __ z_la(data, 3+1*wordSize, argP);  // byte value (stack address).
1877                                         // Being passed as an int, the single byte is at offset +3.
1878     __ z_llgf(crc, 2 * wordSize, argP); // Current crc state, zero extend to 64 bit to have a clean register.
1879 
1880     StubRoutines::zarch::generate_load_crc_table_addr(_masm, table);
1881     __ kernel_crc32_singleByte(crc, data, dataLen, table, Z_R1, true);
1882 
1883     // Restore caller sp for c2i case.
1884     __ resize_frame_absolute(Z_R10, Z_R0, true); // Cut the stack back to where the caller started.
1885 
1886     __ z_br(Z_R14);
1887 
1888     BLOCK_COMMENT(&quot;} CRC32_update&quot;);
1889 
1890     // Use a previously generated vanilla native entry as the slow path.
1891     BIND(slow_path);
1892     __ jump_to_entry(Interpreter::entry_for_kind(Interpreter::native), Z_R1);
1893     return __ addr_at(entry_off);
1894   }
1895 
1896   return NULL;
1897 }
1898 
1899 
1900 /**
1901  * Method entry for static native methods:
1902  *   int java.util.zip.CRC32.updateBytes(     int crc, byte[] b,  int off, int len)
1903  *   int java.util.zip.CRC32.updateByteBuffer(int crc, long* buf, int off, int len)
1904  */
1905 address TemplateInterpreterGenerator::generate_CRC32_updateBytes_entry(AbstractInterpreter::MethodKind kind) {
1906 
1907   if (UseCRC32Intrinsics) {
1908     uint64_t entry_off = __ offset();
1909     Label    slow_path;
1910 
1911     // If we need a safepoint check, generate full interpreter entry.
1912     __ safepoint_poll(slow_path, Z_R1);
1913 
1914     // We don&#39;t generate local frame and don&#39;t align stack because
1915     // we call stub code and there is no safepoint on this path.
1916 
1917     // Load parameters.
1918     // Z_esp is callers operand stack pointer, i.e. it points to the parameters.
1919     const Register argP    = Z_esp;
1920     const Register crc     = Z_ARG1;  // crc value
1921     const Register data    = Z_ARG2;  // address of java byte array
1922     const Register dataLen = Z_ARG3;  // source data len
1923     const Register table   = Z_ARG4;  // address of crc32 table
1924     const Register t0      = Z_R10;   // work reg for kernel* emitters
1925     const Register t1      = Z_R11;   // work reg for kernel* emitters
1926     const Register t2      = Z_R12;   // work reg for kernel* emitters
1927     const Register t3      = Z_R13;   // work reg for kernel* emitters
1928 
1929     // Arguments are reversed on java expression stack.
1930     // Calculate address of start element.
1931     if (kind == Interpreter::java_util_zip_CRC32_updateByteBuffer) { // Used for &quot;updateByteBuffer direct&quot;.
1932       // crc     @ (SP + 5W) (32bit)
1933       // buf     @ (SP + 3W) (64bit ptr to long array)
1934       // off     @ (SP + 2W) (32bit)
1935       // dataLen @ (SP + 1W) (32bit)
1936       // data = buf + off
1937       BLOCK_COMMENT(&quot;CRC32_updateByteBuffer {&quot;);
1938       __ z_llgf(crc,    5*wordSize, argP);  // current crc state
1939       __ z_lg(data,     3*wordSize, argP);  // start of byte buffer
1940       __ z_agf(data,    2*wordSize, argP);  // Add byte buffer offset.
1941       __ z_lgf(dataLen, 1*wordSize, argP);  // #bytes to process
1942     } else {                                                         // Used for &quot;updateBytes update&quot;.
1943       // crc     @ (SP + 4W) (32bit)
1944       // buf     @ (SP + 3W) (64bit ptr to byte array)
1945       // off     @ (SP + 2W) (32bit)
1946       // dataLen @ (SP + 1W) (32bit)
1947       // data = buf + off + base_offset
1948       BLOCK_COMMENT(&quot;CRC32_updateBytes {&quot;);
1949       __ z_llgf(crc,    4*wordSize, argP);  // current crc state
1950       __ z_lg(data,     3*wordSize, argP);  // start of byte buffer
1951       __ z_agf(data,    2*wordSize, argP);  // Add byte buffer offset.
1952       __ z_lgf(dataLen, 1*wordSize, argP);  // #bytes to process
1953       __ z_aghi(data, arrayOopDesc::base_offset_in_bytes(T_BYTE));
1954     }
1955 
1956     StubRoutines::zarch::generate_load_crc_table_addr(_masm, table);
1957 
1958     __ resize_frame(-(6*8), Z_R0, true); // Resize frame to provide add&#39;l space to spill 5 registers.
1959     __ z_stmg(t0, t3, 1*8, Z_SP);        // Spill regs 10..13 to make them available as work registers.
1960     __ kernel_crc32_1word(crc, data, dataLen, table, t0, t1, t2, t3, true);
1961     __ z_lmg(t0, t3, 1*8, Z_SP);         // Spill regs 10..13 back from stack.
1962 
1963     // Restore caller sp for c2i case.
1964     __ resize_frame_absolute(Z_R10, Z_R0, true); // Cut the stack back to where the caller started.
1965 
1966     __ z_br(Z_R14);
1967 
1968     BLOCK_COMMENT(&quot;} CRC32_update{Bytes|ByteBuffer}&quot;);
1969 
1970     // Use a previously generated vanilla native entry as the slow path.
1971     BIND(slow_path);
1972     __ jump_to_entry(Interpreter::entry_for_kind(Interpreter::native), Z_R1);
1973     return __ addr_at(entry_off);
1974   }
1975 
1976   return NULL;
1977 }
1978 
1979 
1980 /**
1981  * Method entry for intrinsic-candidate (non-native) methods:
1982  *   int java.util.zip.CRC32C.updateBytes(           int crc, byte[] b,  int off, int end)
1983  *   int java.util.zip.CRC32C.updateDirectByteBuffer(int crc, long* buf, int off, int end)
1984  * Unlike CRC32, CRC32C does not have any methods marked as native
1985  * CRC32C also uses an &quot;end&quot; variable instead of the length variable CRC32 uses
1986  */
1987 address TemplateInterpreterGenerator::generate_CRC32C_updateBytes_entry(AbstractInterpreter::MethodKind kind) {
1988 
1989   if (UseCRC32CIntrinsics) {
1990     uint64_t entry_off = __ offset();
1991 
1992     // We don&#39;t generate local frame and don&#39;t align stack because
1993     // we call stub code and there is no safepoint on this path.
1994 
1995     // Load parameters.
1996     // Z_esp is callers operand stack pointer, i.e. it points to the parameters.
1997     const Register argP    = Z_esp;
1998     const Register crc     = Z_ARG1;  // crc value
1999     const Register data    = Z_ARG2;  // address of java byte array
2000     const Register dataLen = Z_ARG3;  // source data len
2001     const Register table   = Z_ARG4;  // address of crc32 table
2002     const Register t0      = Z_R10;   // work reg for kernel* emitters
2003     const Register t1      = Z_R11;   // work reg for kernel* emitters
2004     const Register t2      = Z_R12;   // work reg for kernel* emitters
2005     const Register t3      = Z_R13;   // work reg for kernel* emitters
2006 
2007     // Arguments are reversed on java expression stack.
2008     // Calculate address of start element.
2009     if (kind == Interpreter::java_util_zip_CRC32C_updateDirectByteBuffer) { // Used for &quot;updateByteBuffer direct&quot;.
2010       // crc     @ (SP + 5W) (32bit)
2011       // buf     @ (SP + 3W) (64bit ptr to long array)
2012       // off     @ (SP + 2W) (32bit)
2013       // dataLen @ (SP + 1W) (32bit)
2014       // data = buf + off
2015       BLOCK_COMMENT(&quot;CRC32C_updateDirectByteBuffer {&quot;);
2016       __ z_llgf(crc,    5*wordSize, argP);  // current crc state
2017       __ z_lg(data,     3*wordSize, argP);  // start of byte buffer
2018       __ z_agf(data,    2*wordSize, argP);  // Add byte buffer offset.
2019       __ z_lgf(dataLen, 1*wordSize, argP);  // #bytes to process, calculated as
2020       __ z_sgf(dataLen, Address(argP, 2*wordSize));  // (end_index - offset)
2021     } else {                                                                // Used for &quot;updateBytes update&quot;.
2022       // crc     @ (SP + 4W) (32bit)
2023       // buf     @ (SP + 3W) (64bit ptr to byte array)
2024       // off     @ (SP + 2W) (32bit)
2025       // dataLen @ (SP + 1W) (32bit)
2026       // data = buf + off + base_offset
2027       BLOCK_COMMENT(&quot;CRC32C_updateBytes {&quot;);
2028       __ z_llgf(crc,    4*wordSize, argP);  // current crc state
2029       __ z_lg(data,     3*wordSize, argP);  // start of byte buffer
2030       __ z_agf(data,    2*wordSize, argP);  // Add byte buffer offset.
2031       __ z_lgf(dataLen, 1*wordSize, argP);  // #bytes to process, calculated as
2032       __ z_sgf(dataLen, Address(argP, 2*wordSize));  // (end_index - offset)
2033       __ z_aghi(data, arrayOopDesc::base_offset_in_bytes(T_BYTE));
2034     }
2035 
2036     StubRoutines::zarch::generate_load_crc32c_table_addr(_masm, table);
2037 
2038     __ resize_frame(-(6*8), Z_R0, true); // Resize frame to provide add&#39;l space to spill 5 registers.
2039     __ z_stmg(t0, t3, 1*8, Z_SP);        // Spill regs 10..13 to make them available as work registers.
2040     __ kernel_crc32_1word(crc, data, dataLen, table, t0, t1, t2, t3, false);
2041     __ z_lmg(t0, t3, 1*8, Z_SP);         // Spill regs 10..13 back from stack.
2042 
2043     // Restore caller sp for c2i case.
2044     __ resize_frame_absolute(Z_R10, Z_R0, true); // Cut the stack back to where the caller started.
2045 
2046     __ z_br(Z_R14);
2047 
2048     BLOCK_COMMENT(&quot;} CRC32C_update{Bytes|DirectByteBuffer}&quot;);
2049     return __ addr_at(entry_off);
2050   }
2051 
2052   return NULL;
2053 }
2054 
2055 void TemplateInterpreterGenerator::bang_stack_shadow_pages(bool native_call) {
2056   // Quick &amp; dirty stack overflow checking: bang the stack &amp; handle trap.
2057   // Note that we do the banging after the frame is setup, since the exception
2058   // handling code expects to find a valid interpreter frame on the stack.
2059   // Doing the banging earlier fails if the caller frame is not an interpreter
2060   // frame.
2061   // (Also, the exception throwing code expects to unlock any synchronized
2062   // method receiver, so do the banging after locking the receiver.)
2063 
2064   // Bang each page in the shadow zone. We can&#39;t assume it&#39;s been done for
2065   // an interpreter frame with greater than a page of locals, so each page
2066   // needs to be checked. Only true for non-native. For native, we only bang the last page.
2067   if (UseStackBanging) {
2068     const int page_size      = os::vm_page_size();
2069     const int n_shadow_pages = (int)(JavaThread::stack_shadow_zone_size()/page_size);
2070     const int start_page_num = native_call ? n_shadow_pages : 1;
2071     for (int pages = start_page_num; pages &lt;= n_shadow_pages; pages++) {
2072       __ bang_stack_with_offset(pages*page_size);
2073     }
2074   }
2075 }
2076 
2077 //-----------------------------------------------------------------------------
2078 // Exceptions
2079 
2080 void TemplateInterpreterGenerator::generate_throw_exception() {
2081 
2082   BLOCK_COMMENT(&quot;throw_exception {&quot;);
2083 
2084   // Entry point in previous activation (i.e., if the caller was interpreted).
2085   Interpreter::_rethrow_exception_entry = __ pc();
2086   __ z_lg(Z_fp, _z_abi(callers_sp), Z_SP); // Frame accessors use Z_fp.
2087   // Z_ARG1 (==Z_tos): exception
2088   // Z_ARG2          : Return address/pc that threw exception.
2089   __ restore_bcp();    // R13 points to call/send.
2090   __ restore_locals();
2091 
2092   // Fallthrough, no need to restore Z_esp.
2093 
2094   // Entry point for exceptions thrown within interpreter code.
2095   Interpreter::_throw_exception_entry = __ pc();
2096   // Expression stack is undefined here.
2097   // Z_ARG1 (==Z_tos): exception
2098   // Z_bcp: exception bcp
2099   __ verify_oop(Z_ARG1);
2100   __ z_lgr(Z_ARG2, Z_ARG1);
2101 
2102   // Expression stack must be empty before entering the VM in case of
2103   // an exception.
2104   __ empty_expression_stack();
2105   // Find exception handler address and preserve exception oop.
2106   const Register Rpreserved_exc_oop = Z_tmp_1;
2107   __ call_VM(Rpreserved_exc_oop,
2108              CAST_FROM_FN_PTR(address, InterpreterRuntime::exception_handler_for_exception),
2109              Z_ARG2);
2110   // Z_RET: exception handler entry point
2111   // Z_bcp: bcp for exception handler
2112   __ push_ptr(Rpreserved_exc_oop); // Push exception which is now the only value on the stack.
2113   __ z_br(Z_RET); // Jump to exception handler (may be _remove_activation_entry!).
2114 
2115   // If the exception is not handled in the current frame the frame is
2116   // removed and the exception is rethrown (i.e. exception
2117   // continuation is _rethrow_exception).
2118   //
2119   // Note: At this point the bci is still the bci for the instruction
2120   // which caused the exception and the expression stack is
2121   // empty. Thus, for any VM calls at this point, GC will find a legal
2122   // oop map (with empty expression stack).
2123 
2124   //
2125   // JVMTI PopFrame support
2126   //
2127 
2128   Interpreter::_remove_activation_preserving_args_entry = __ pc();
2129   __ z_lg(Z_fp, _z_parent_ijava_frame_abi(callers_sp), Z_SP);
2130   __ empty_expression_stack();
2131   // Set the popframe_processing bit in pending_popframe_condition
2132   // indicating that we are currently handling popframe, so that
2133   // call_VMs that may happen later do not trigger new popframe
2134   // handling cycles.
2135   __ load_sized_value(Z_tmp_1, Address(Z_thread, JavaThread::popframe_condition_offset()), 4, false /*signed*/);
2136   __ z_oill(Z_tmp_1, JavaThread::popframe_processing_bit);
2137   __ z_sty(Z_tmp_1, thread_(popframe_condition));
2138 
2139   {
2140     // Check to see whether we are returning to a deoptimized frame.
2141     // (The PopFrame call ensures that the caller of the popped frame is
2142     // either interpreted or compiled and deoptimizes it if compiled.)
2143     // In this case, we can&#39;t call dispatch_next() after the frame is
2144     // popped, but instead must save the incoming arguments and restore
2145     // them after deoptimization has occurred.
2146     //
2147     // Note that we don&#39;t compare the return PC against the
2148     // deoptimization blob&#39;s unpack entry because of the presence of
2149     // adapter frames in C2.
2150     NearLabel caller_not_deoptimized;
2151     __ z_lg(Z_ARG1, _z_parent_ijava_frame_abi(return_pc), Z_fp);
2152     __ call_VM_leaf(CAST_FROM_FN_PTR(address, InterpreterRuntime::interpreter_contains), Z_ARG1);
2153     __ compareU64_and_branch(Z_RET, (intptr_t)0, Assembler::bcondNotEqual, caller_not_deoptimized);
2154 
2155     // Compute size of arguments for saving when returning to
2156     // deoptimized caller.
2157     __ get_method(Z_ARG2);
2158     __ z_lg(Z_ARG2, Address(Z_ARG2, Method::const_offset()));
2159     __ z_llgh(Z_ARG2, Address(Z_ARG2, ConstMethod::size_of_parameters_offset()));
2160     __ z_sllg(Z_ARG2, Z_ARG2, Interpreter::logStackElementSize); // slots 2 bytes
2161     __ restore_locals();
2162     // Compute address of args to be saved.
2163     __ z_lgr(Z_ARG3, Z_locals);
2164     __ z_slgr(Z_ARG3, Z_ARG2);
2165     __ add2reg(Z_ARG3, wordSize);
2166     // Save these arguments.
2167     __ call_VM_leaf(CAST_FROM_FN_PTR(address, Deoptimization::popframe_preserve_args),
2168                     Z_thread, Z_ARG2, Z_ARG3);
2169 
2170     __ remove_activation(vtos, Z_R14,
2171                          /* throw_monitor_exception */ false,
2172                          /* install_monitor_exception */ false,
2173                          /* notify_jvmdi */ false);
2174 
2175     // Inform deoptimization that it is responsible for restoring
2176     // these arguments.
2177     __ store_const(thread_(popframe_condition),
2178                    JavaThread::popframe_force_deopt_reexecution_bit,
2179                    Z_tmp_1, false);
2180 
2181     // Continue in deoptimization handler.
2182     __ z_br(Z_R14);
2183 
2184     __ bind(caller_not_deoptimized);
2185   }
2186 
2187   // Clear the popframe condition flag.
2188   __ clear_mem(thread_(popframe_condition), sizeof(int));
2189 
2190   __ remove_activation(vtos,
2191                        noreg,  // Retaddr is not used.
2192                        false,  // throw_monitor_exception
2193                        false,  // install_monitor_exception
2194                        false); // notify_jvmdi
2195   __ z_lg(Z_fp, _z_abi(callers_sp), Z_SP); // Restore frame pointer.
2196   __ restore_bcp();
2197   __ restore_locals();
2198   __ restore_esp();
2199   // The method data pointer was incremented already during
2200   // call profiling. We have to restore the mdp for the current bcp.
2201   if (ProfileInterpreter) {
2202     __ set_method_data_pointer_for_bcp();
2203   }
2204 #if INCLUDE_JVMTI
2205   {
2206     Label L_done;
2207 
2208     __ z_cli(0, Z_bcp, Bytecodes::_invokestatic);
2209     __ z_brc(Assembler::bcondNotEqual, L_done);
2210 
2211     // The member name argument must be restored if _invokestatic is
2212     // re-executed after a PopFrame call.  Detect such a case in the
2213     // InterpreterRuntime function and return the member name
2214     // argument, or NULL.
2215     __ z_lg(Z_ARG2, Address(Z_locals));
2216     __ get_method(Z_ARG3);
2217     __ call_VM(Z_tmp_1,
2218                CAST_FROM_FN_PTR(address, InterpreterRuntime::member_name_arg_or_null),
2219                Z_ARG2, Z_ARG3, Z_bcp);
2220 
2221     __ z_ltgr(Z_tmp_1, Z_tmp_1);
2222     __ z_brc(Assembler::bcondEqual, L_done);
2223 
2224     __ z_stg(Z_tmp_1, Address(Z_esp, wordSize));
2225     __ bind(L_done);
2226   }
2227 #endif // INCLUDE_JVMTI
2228   __ dispatch_next(vtos);
2229   // End of PopFrame support.
2230   Interpreter::_remove_activation_entry = __ pc();
2231 
2232   // In between activations - previous activation type unknown yet
2233   // compute continuation point - the continuation point expects the
2234   // following registers set up:
2235   //
2236   // Z_ARG1 (==Z_tos): exception
2237   // Z_ARG2          : return address/pc that threw exception
2238 
2239   Register return_pc = Z_tmp_1;
2240   Register handler   = Z_tmp_2;
2241    assert(return_pc-&gt;is_nonvolatile(), &quot;use non-volatile reg. to preserve exception pc&quot;);
2242    assert(handler-&gt;is_nonvolatile(),   &quot;use non-volatile reg. to handler pc&quot;);
2243   __ asm_assert_ijava_state_magic(return_pc/*tmp*/); // The top frame should be an interpreter frame.
2244   __ z_lg(return_pc, _z_parent_ijava_frame_abi(return_pc), Z_fp);
2245 
2246   // Moved removing the activation after VM call, because the new top
2247   // frame does not necessarily have the z_abi_160 required for a VM
2248   // call (e.g. if it is compiled).
2249 
2250   __ super_call_VM_leaf(CAST_FROM_FN_PTR(address,
2251                                          SharedRuntime::exception_handler_for_return_address),
2252                         Z_thread, return_pc);
2253   __ z_lgr(handler, Z_RET); // Save exception handler.
2254 
2255   // Preserve exception over this code sequence.
2256   __ pop_ptr(Z_ARG1);
2257   __ set_vm_result(Z_ARG1);
2258   // Remove the activation (without doing throws on illegalMonitorExceptions).
2259   __ remove_activation(vtos, noreg/*ret.pc already loaded*/, false/*throw exc*/, true/*install exc*/, false/*notify jvmti*/);
2260   __ z_lg(Z_fp, _z_abi(callers_sp), Z_SP); // Restore frame pointer.
2261 
2262   __ get_vm_result(Z_ARG1);     // Restore exception.
2263   __ verify_oop(Z_ARG1);
2264   __ z_lgr(Z_ARG2, return_pc);  // Restore return address.
2265 
2266 #ifdef ASSERT
2267   // The return_pc in the new top frame is dead... at least that&#39;s my
2268   // current understanding. To assert this I overwrite it.
2269   // Note: for compiled frames the handler is the deopt blob
2270   // which writes Z_ARG2 into the return_pc slot.
2271   __ load_const_optimized(return_pc, 0xb00b1);
2272   __ z_stg(return_pc, _z_parent_ijava_frame_abi(return_pc), Z_SP);
2273 #endif
2274 
2275   // Z_ARG1 (==Z_tos): exception
2276   // Z_ARG2          : return address/pc that threw exception
2277 
2278   // Note that an &quot;issuing PC&quot; is actually the next PC after the call.
2279   __ z_br(handler);         // Jump to exception handler of caller.
2280 
2281   BLOCK_COMMENT(&quot;} throw_exception&quot;);
2282 }
2283 
2284 //
2285 // JVMTI ForceEarlyReturn support
2286 //
2287 address TemplateInterpreterGenerator::generate_earlyret_entry_for (TosState state) {
2288   address entry = __ pc();
2289 
2290   BLOCK_COMMENT(&quot;earlyret_entry {&quot;);
2291 
2292   __ z_lg(Z_fp, _z_parent_ijava_frame_abi(callers_sp), Z_SP);
2293   __ restore_bcp();
2294   __ restore_locals();
2295   __ restore_esp();
2296   __ empty_expression_stack();
2297   __ load_earlyret_value(state);
2298 
2299   Register RjvmtiState = Z_tmp_1;
2300   __ z_lg(RjvmtiState, thread_(jvmti_thread_state));
2301   __ store_const(Address(RjvmtiState, JvmtiThreadState::earlyret_state_offset()),
2302                  JvmtiThreadState::earlyret_inactive, 4, 4, Z_R0_scratch);
2303 
2304   if (state == itos) {
2305     // Narrow result if state is itos but result type is smaller.
2306     // Need to narrow in the return bytecode rather than in generate_return_entry
2307     // since compiled code callers expect the result to already be narrowed.
2308     __ narrow(Z_tos, Z_tmp_1); /* fall through */
2309   }
2310   __ remove_activation(state,
2311                        Z_tmp_1, // retaddr
2312                        false,   // throw_monitor_exception
2313                        false,   // install_monitor_exception
2314                        true);   // notify_jvmdi
2315   __ z_br(Z_tmp_1);
2316 
2317   BLOCK_COMMENT(&quot;} earlyret_entry&quot;);
2318 
2319   return entry;
2320 }
2321 
2322 //-----------------------------------------------------------------------------
2323 // Helper for vtos entry point generation.
2324 
2325 void TemplateInterpreterGenerator::set_vtos_entry_points(Template* t,
2326                                                          address&amp; bep,
2327                                                          address&amp; cep,
2328                                                          address&amp; sep,
2329                                                          address&amp; aep,
2330                                                          address&amp; iep,
2331                                                          address&amp; lep,
2332                                                          address&amp; fep,
2333                                                          address&amp; dep,
2334                                                          address&amp; vep) {
2335   assert(t-&gt;is_valid() &amp;&amp; t-&gt;tos_in() == vtos, &quot;illegal template&quot;);
2336   Label L;
2337   aep = __ pc(); __ push_ptr(); __ z_bru(L);
2338   fep = __ pc(); __ push_f();   __ z_bru(L);
2339   dep = __ pc(); __ push_d();   __ z_bru(L);
2340   lep = __ pc(); __ push_l();   __ z_bru(L);
2341   bep = cep = sep =
2342   iep = __ pc(); __ push_i();
2343   vep = __ pc();
2344   __ bind(L);
2345   generate_and_dispatch(t);
2346 }
2347 
2348 //-----------------------------------------------------------------------------
2349 
2350 #ifndef PRODUCT
2351 address TemplateInterpreterGenerator::generate_trace_code(TosState state) {
2352   address entry = __ pc();
2353   NearLabel counter_below_trace_threshold;
2354 
2355   if (TraceBytecodesAt &gt; 0) {
2356     // Skip runtime call, if the trace threshold is not yet reached.
2357     __ load_absolute_address(Z_tmp_1, (address)&amp;BytecodeCounter::_counter_value);
2358     __ load_absolute_address(Z_tmp_2, (address)&amp;TraceBytecodesAt);
2359     __ load_sized_value(Z_tmp_1, Address(Z_tmp_1), 4, false /*signed*/);
2360     __ load_sized_value(Z_tmp_2, Address(Z_tmp_2), 8, false /*signed*/);
2361     __ compareU64_and_branch(Z_tmp_1, Z_tmp_2, Assembler::bcondLow, counter_below_trace_threshold);
2362   }
2363 
2364   int offset2 = state == ltos || state == dtos ? 2 : 1;
2365 
2366   __ push(state);
2367   // Preserved return pointer is in Z_R14.
2368   // InterpreterRuntime::trace_bytecode() preserved and returns the value passed as second argument.
2369   __ z_lgr(Z_ARG2, Z_R14);
2370   __ z_lg(Z_ARG3, Address(Z_esp, Interpreter::expr_offset_in_bytes(0)));
2371   if (WizardMode) {
2372     __ z_lgr(Z_ARG4, Z_esp); // Trace Z_esp in WizardMode.
2373   } else {
2374     __ z_lg(Z_ARG4, Address(Z_esp, Interpreter::expr_offset_in_bytes(offset2)));
2375   }
2376   __ call_VM(noreg, CAST_FROM_FN_PTR(address, InterpreterRuntime::trace_bytecode), Z_ARG2, Z_ARG3, Z_ARG4);
2377   __ z_lgr(Z_R14, Z_RET); // Estore return address (see above).
2378   __ pop(state);
2379 
2380   __ bind(counter_below_trace_threshold);
2381   __ z_br(Z_R14); // return
2382 
2383   return entry;
2384 }
2385 
2386 // Make feasible for old CPUs.
2387 void TemplateInterpreterGenerator::count_bytecode() {
2388   __ load_absolute_address(Z_R1_scratch, (address) &amp;BytecodeCounter::_counter_value);
2389   __ add2mem_32(Address(Z_R1_scratch), 1, Z_R0_scratch);
2390 }
2391 
2392 void TemplateInterpreterGenerator::histogram_bytecode(Template * t) {
2393   __ load_absolute_address(Z_R1_scratch, (address)&amp;BytecodeHistogram::_counters[ t-&gt;bytecode() ]);
2394   __ add2mem_32(Address(Z_R1_scratch), 1, Z_tmp_1);
2395 }
2396 
2397 void TemplateInterpreterGenerator::histogram_bytecode_pair(Template * t) {
2398   Address  index_addr(Z_tmp_1, (intptr_t) 0);
2399   Register index = Z_tmp_2;
2400 
2401   // Load previous index.
2402   __ load_absolute_address(Z_tmp_1, (address) &amp;BytecodePairHistogram::_index);
2403   __ mem2reg_opt(index, index_addr, false);
2404 
2405   // Mask with current bytecode and store as new previous index.
2406   __ z_srl(index, BytecodePairHistogram::log2_number_of_codes);
2407   __ load_const_optimized(Z_R0_scratch,
2408                           (int)t-&gt;bytecode() &lt;&lt; BytecodePairHistogram::log2_number_of_codes);
2409   __ z_or(index, Z_R0_scratch);
2410   __ reg2mem_opt(index, index_addr, false);
2411 
2412   // Load counter array&#39;s address.
2413   __ z_lgfr(index, index);   // Sign extend for addressing.
2414   __ z_sllg(index, index, LogBytesPerInt);  // index2bytes
2415   __ load_absolute_address(Z_R1_scratch,
2416                            (address) &amp;BytecodePairHistogram::_counters);
2417   // Add index and increment counter.
2418   __ z_agr(Z_R1_scratch, index);
2419   __ add2mem_32(Address(Z_R1_scratch), 1, Z_tmp_1);
2420 }
2421 
2422 void TemplateInterpreterGenerator::trace_bytecode(Template* t) {
2423   // Call a little run-time stub to avoid blow-up for each bytecode.
2424   // The run-time runtime saves the right registers, depending on
2425   // the tosca in-state for the given template.
2426   address entry = Interpreter::trace_code(t-&gt;tos_in());
2427   guarantee(entry != NULL, &quot;entry must have been generated&quot;);
2428   __ call_stub(entry);
2429 }
2430 
2431 void TemplateInterpreterGenerator::stop_interpreter_at() {
2432   NearLabel L;
2433 
2434   __ load_absolute_address(Z_tmp_1, (address)&amp;BytecodeCounter::_counter_value);
2435   __ load_absolute_address(Z_tmp_2, (address)&amp;StopInterpreterAt);
2436   __ load_sized_value(Z_tmp_1, Address(Z_tmp_1), 4, false /*signed*/);
2437   __ load_sized_value(Z_tmp_2, Address(Z_tmp_2), 8, false /*signed*/);
2438   __ compareU64_and_branch(Z_tmp_1, Z_tmp_2, Assembler::bcondLow, L);
2439   assert(Z_tmp_1-&gt;is_nonvolatile(), &quot;must be nonvolatile to preserve Z_tos&quot;);
2440   assert(Z_F8-&gt;is_nonvolatile(), &quot;must be nonvolatile to preserve Z_ftos&quot;);
2441   __ z_lgr(Z_tmp_1, Z_tos);      // Save tos.
2442   __ z_lgr(Z_tmp_2, Z_bytecode); // Save Z_bytecode.
2443   __ z_ldr(Z_F8, Z_ftos);        // Save ftos.
2444   // Use -XX:StopInterpreterAt=&lt;num&gt; to set the limit
2445   // and break at breakpoint().
2446   __ call_VM(noreg, CAST_FROM_FN_PTR(address, breakpoint), false);
2447   __ z_lgr(Z_tos, Z_tmp_1);      // Restore tos.
2448   __ z_lgr(Z_bytecode, Z_tmp_2); // Save Z_bytecode.
2449   __ z_ldr(Z_ftos, Z_F8);        // Restore ftos.
2450   __ bind(L);
2451 }
2452 
2453 #endif // !PRODUCT
<a name="3" id="anc3"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="3" type="hidden" />
</body>
</html>