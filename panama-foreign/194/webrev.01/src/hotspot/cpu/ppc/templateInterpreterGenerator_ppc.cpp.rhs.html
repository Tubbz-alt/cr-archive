<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames src/hotspot/cpu/ppc/templateInterpreterGenerator_ppc.cpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
    <script type="text/javascript" src="../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>   1 /*
<a name="1" id="anc1"></a><span class="line-modified">   2  * Copyright (c) 2014, 2020, Oracle and/or its affiliates. All rights reserved.</span>
   3  * Copyright (c) 2015, 2019, SAP SE. All rights reserved.
   4  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   5  *
   6  * This code is free software; you can redistribute it and/or modify it
   7  * under the terms of the GNU General Public License version 2 only, as
   8  * published by the Free Software Foundation.
   9  *
  10  * This code is distributed in the hope that it will be useful, but WITHOUT
  11  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  12  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  13  * version 2 for more details (a copy is included in the LICENSE file that
  14  * accompanied this code).
  15  *
  16  * You should have received a copy of the GNU General Public License version
  17  * 2 along with this work; if not, write to the Free Software Foundation,
  18  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  19  *
  20  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  21  * or visit www.oracle.com if you need additional information or have any
  22  * questions.
  23  *
  24  */
  25 
  26 #include &quot;precompiled.hpp&quot;
  27 #include &quot;asm/macroAssembler.inline.hpp&quot;
  28 #include &quot;gc/shared/barrierSetAssembler.hpp&quot;
  29 #include &quot;interpreter/bytecodeHistogram.hpp&quot;
  30 #include &quot;interpreter/interpreter.hpp&quot;
  31 #include &quot;interpreter/interpreterRuntime.hpp&quot;
  32 #include &quot;interpreter/interp_masm.hpp&quot;
  33 #include &quot;interpreter/templateInterpreterGenerator.hpp&quot;
  34 #include &quot;interpreter/templateTable.hpp&quot;
  35 #include &quot;oops/arrayOop.hpp&quot;
  36 #include &quot;oops/methodData.hpp&quot;
  37 #include &quot;oops/method.hpp&quot;
  38 #include &quot;oops/oop.inline.hpp&quot;
  39 #include &quot;prims/jvmtiExport.hpp&quot;
  40 #include &quot;prims/jvmtiThreadState.hpp&quot;
  41 #include &quot;runtime/arguments.hpp&quot;
  42 #include &quot;runtime/deoptimization.hpp&quot;
  43 #include &quot;runtime/frame.inline.hpp&quot;
  44 #include &quot;runtime/sharedRuntime.hpp&quot;
  45 #include &quot;runtime/stubRoutines.hpp&quot;
  46 #include &quot;runtime/synchronizer.hpp&quot;
  47 #include &quot;runtime/timer.hpp&quot;
  48 #include &quot;runtime/vframeArray.hpp&quot;
  49 #include &quot;utilities/debug.hpp&quot;
  50 #include &quot;utilities/macros.hpp&quot;
  51 
  52 #undef __
  53 #define __ _masm-&gt;
  54 
  55 // Size of interpreter code.  Increase if too small.  Interpreter will
  56 // fail with a guarantee (&quot;not enough space for interpreter generation&quot;);
  57 // if too small.
  58 // Run with +PrintInterpreter to get the VM to print out the size.
  59 // Max size with JVMTI
  60 int TemplateInterpreter::InterpreterCodeSize = 256*K;
  61 
  62 #ifdef PRODUCT
  63 #define BLOCK_COMMENT(str) /* nothing */
  64 #else
  65 #define BLOCK_COMMENT(str) __ block_comment(str)
  66 #endif
  67 
  68 #define BIND(label)        __ bind(label); BLOCK_COMMENT(#label &quot;:&quot;)
  69 
  70 //-----------------------------------------------------------------------------
  71 
  72 address TemplateInterpreterGenerator::generate_slow_signature_handler() {
  73   // Slow_signature handler that respects the PPC C calling conventions.
  74   //
  75   // We get called by the native entry code with our output register
  76   // area == 8. First we call InterpreterRuntime::get_result_handler
  77   // to copy the pointer to the signature string temporarily to the
  78   // first C-argument and to return the result_handler in
  79   // R3_RET. Since native_entry will copy the jni-pointer to the
  80   // first C-argument slot later on, it is OK to occupy this slot
  81   // temporarilly. Then we copy the argument list on the java
  82   // expression stack into native varargs format on the native stack
  83   // and load arguments into argument registers. Integer arguments in
  84   // the varargs vector will be sign-extended to 8 bytes.
  85   //
  86   // On entry:
  87   //   R3_ARG1        - intptr_t*     Address of java argument list in memory.
  88   //   R15_prev_state - BytecodeInterpreter* Address of interpreter state for
  89   //     this method
  90   //   R19_method
  91   //
  92   // On exit (just before return instruction):
  93   //   R3_RET            - contains the address of the result_handler.
  94   //   R4_ARG2           - is not updated for static methods and contains &quot;this&quot; otherwise.
  95   //   R5_ARG3-R10_ARG8: - When the (i-2)th Java argument is not of type float or double,
  96   //                       ARGi contains this argument. Otherwise, ARGi is not updated.
  97   //   F1_ARG1-F13_ARG13 - contain the first 13 arguments of type float or double.
  98 
  99   const int LogSizeOfTwoInstructions = 3;
 100 
 101   // FIXME: use Argument:: GL: Argument names different numbers!
 102   const int max_fp_register_arguments  = 13;
 103   const int max_int_register_arguments = 6;  // first 2 are reserved
 104 
 105   const Register arg_java       = R21_tmp1;
 106   const Register arg_c          = R22_tmp2;
 107   const Register signature      = R23_tmp3;  // is string
 108   const Register sig_byte       = R24_tmp4;
 109   const Register fpcnt          = R25_tmp5;
 110   const Register argcnt         = R26_tmp6;
 111   const Register intSlot        = R27_tmp7;
 112   const Register target_sp      = R28_tmp8;
 113   const FloatRegister floatSlot = F0;
 114 
 115   address entry = __ function_entry();
 116 
 117   __ save_LR_CR(R0);
 118   __ save_nonvolatile_gprs(R1_SP, _spill_nonvolatiles_neg(r14));
 119   // We use target_sp for storing arguments in the C frame.
 120   __ mr(target_sp, R1_SP);
 121   __ push_frame_reg_args_nonvolatiles(0, R11_scratch1);
 122 
 123   __ mr(arg_java, R3_ARG1);
 124 
 125   __ call_VM_leaf(CAST_FROM_FN_PTR(address, InterpreterRuntime::get_signature), R16_thread, R19_method);
 126 
 127   // Signature is in R3_RET. Signature is callee saved.
 128   __ mr(signature, R3_RET);
 129 
 130   // Get the result handler.
 131   __ call_VM_leaf(CAST_FROM_FN_PTR(address, InterpreterRuntime::get_result_handler), R16_thread, R19_method);
 132 
 133   {
 134     Label L;
 135     // test if static
 136     // _access_flags._flags must be at offset 0.
 137     // TODO PPC port: requires change in shared code.
 138     //assert(in_bytes(AccessFlags::flags_offset()) == 0,
 139     //       &quot;MethodDesc._access_flags == MethodDesc._access_flags._flags&quot;);
 140     // _access_flags must be a 32 bit value.
 141     assert(sizeof(AccessFlags) == 4, &quot;wrong size&quot;);
 142     __ lwa(R11_scratch1/*access_flags*/, method_(access_flags));
 143     // testbit with condition register.
 144     __ testbitdi(CCR0, R0, R11_scratch1/*access_flags*/, JVM_ACC_STATIC_BIT);
 145     __ btrue(CCR0, L);
 146     // For non-static functions, pass &quot;this&quot; in R4_ARG2 and copy it
 147     // to 2nd C-arg slot.
 148     // We need to box the Java object here, so we use arg_java
 149     // (address of current Java stack slot) as argument and don&#39;t
 150     // dereference it as in case of ints, floats, etc.
 151     __ mr(R4_ARG2, arg_java);
 152     __ addi(arg_java, arg_java, -BytesPerWord);
 153     __ std(R4_ARG2, _abi(carg_2), target_sp);
 154     __ bind(L);
 155   }
 156 
 157   // Will be incremented directly after loop_start. argcnt=0
 158   // corresponds to 3rd C argument.
 159   __ li(argcnt, -1);
 160   // arg_c points to 3rd C argument
 161   __ addi(arg_c, target_sp, _abi(carg_3));
 162   // no floating-point args parsed so far
 163   __ li(fpcnt, 0);
 164 
 165   Label move_intSlot_to_ARG, move_floatSlot_to_FARG;
 166   Label loop_start, loop_end;
 167   Label do_int, do_long, do_float, do_double, do_dontreachhere, do_object, do_array, do_boxed;
 168 
 169   // signature points to &#39;(&#39; at entry
 170 #ifdef ASSERT
 171   __ lbz(sig_byte, 0, signature);
 172   __ cmplwi(CCR0, sig_byte, &#39;(&#39;);
 173   __ bne(CCR0, do_dontreachhere);
 174 #endif
 175 
 176   __ bind(loop_start);
 177 
 178   __ addi(argcnt, argcnt, 1);
 179   __ lbzu(sig_byte, 1, signature);
 180 
 181   __ cmplwi(CCR0, sig_byte, &#39;)&#39;); // end of signature
 182   __ beq(CCR0, loop_end);
 183 
 184   __ cmplwi(CCR0, sig_byte, &#39;B&#39;); // byte
 185   __ beq(CCR0, do_int);
 186 
 187   __ cmplwi(CCR0, sig_byte, &#39;C&#39;); // char
 188   __ beq(CCR0, do_int);
 189 
 190   __ cmplwi(CCR0, sig_byte, &#39;D&#39;); // double
 191   __ beq(CCR0, do_double);
 192 
 193   __ cmplwi(CCR0, sig_byte, &#39;F&#39;); // float
 194   __ beq(CCR0, do_float);
 195 
 196   __ cmplwi(CCR0, sig_byte, &#39;I&#39;); // int
 197   __ beq(CCR0, do_int);
 198 
 199   __ cmplwi(CCR0, sig_byte, &#39;J&#39;); // long
 200   __ beq(CCR0, do_long);
 201 
 202   __ cmplwi(CCR0, sig_byte, &#39;S&#39;); // short
 203   __ beq(CCR0, do_int);
 204 
 205   __ cmplwi(CCR0, sig_byte, &#39;Z&#39;); // boolean
 206   __ beq(CCR0, do_int);
 207 
 208   __ cmplwi(CCR0, sig_byte, &#39;L&#39;); // object
 209   __ beq(CCR0, do_object);
 210 
 211   __ cmplwi(CCR0, sig_byte, &#39;[&#39;); // array
 212   __ beq(CCR0, do_array);
 213 
 214   //  __ cmplwi(CCR0, sig_byte, &#39;V&#39;); // void cannot appear since we do not parse the return type
 215   //  __ beq(CCR0, do_void);
 216 
 217   __ bind(do_dontreachhere);
 218 
 219   __ unimplemented(&quot;ShouldNotReachHere in slow_signature_handler&quot;);
 220 
 221   __ bind(do_array);
 222 
 223   {
 224     Label start_skip, end_skip;
 225 
 226     __ bind(start_skip);
 227     __ lbzu(sig_byte, 1, signature);
 228     __ cmplwi(CCR0, sig_byte, &#39;[&#39;);
 229     __ beq(CCR0, start_skip); // skip further brackets
 230     __ cmplwi(CCR0, sig_byte, &#39;9&#39;);
 231     __ bgt(CCR0, end_skip);   // no optional size
 232     __ cmplwi(CCR0, sig_byte, &#39;0&#39;);
 233     __ bge(CCR0, start_skip); // skip optional size
 234     __ bind(end_skip);
 235 
 236     __ cmplwi(CCR0, sig_byte, &#39;L&#39;);
 237     __ beq(CCR0, do_object);  // for arrays of objects, the name of the object must be skipped
 238     __ b(do_boxed);          // otherwise, go directly to do_boxed
 239   }
 240 
 241   __ bind(do_object);
 242   {
 243     Label L;
 244     __ bind(L);
 245     __ lbzu(sig_byte, 1, signature);
 246     __ cmplwi(CCR0, sig_byte, &#39;;&#39;);
 247     __ bne(CCR0, L);
 248    }
 249   // Need to box the Java object here, so we use arg_java (address of
 250   // current Java stack slot) as argument and don&#39;t dereference it as
 251   // in case of ints, floats, etc.
 252   Label do_null;
 253   __ bind(do_boxed);
 254   __ ld(R0,0, arg_java);
 255   __ cmpdi(CCR0, R0, 0);
 256   __ li(intSlot,0);
 257   __ beq(CCR0, do_null);
 258   __ mr(intSlot, arg_java);
 259   __ bind(do_null);
 260   __ std(intSlot, 0, arg_c);
 261   __ addi(arg_java, arg_java, -BytesPerWord);
 262   __ addi(arg_c, arg_c, BytesPerWord);
 263   __ cmplwi(CCR0, argcnt, max_int_register_arguments);
 264   __ blt(CCR0, move_intSlot_to_ARG);
 265   __ b(loop_start);
 266 
 267   __ bind(do_int);
 268   __ lwa(intSlot, 0, arg_java);
 269   __ std(intSlot, 0, arg_c);
 270   __ addi(arg_java, arg_java, -BytesPerWord);
 271   __ addi(arg_c, arg_c, BytesPerWord);
 272   __ cmplwi(CCR0, argcnt, max_int_register_arguments);
 273   __ blt(CCR0, move_intSlot_to_ARG);
 274   __ b(loop_start);
 275 
 276   __ bind(do_long);
 277   __ ld(intSlot, -BytesPerWord, arg_java);
 278   __ std(intSlot, 0, arg_c);
 279   __ addi(arg_java, arg_java, - 2 * BytesPerWord);
 280   __ addi(arg_c, arg_c, BytesPerWord);
 281   __ cmplwi(CCR0, argcnt, max_int_register_arguments);
 282   __ blt(CCR0, move_intSlot_to_ARG);
 283   __ b(loop_start);
 284 
 285   __ bind(do_float);
 286   __ lfs(floatSlot, 0, arg_java);
 287 #if defined(LINUX)
 288   // Linux uses ELF ABI. Both original ELF and ELFv2 ABIs have float
 289   // in the least significant word of an argument slot.
 290 #if defined(VM_LITTLE_ENDIAN)
 291   __ stfs(floatSlot, 0, arg_c);
 292 #else
 293   __ stfs(floatSlot, 4, arg_c);
 294 #endif
 295 #elif defined(AIX)
 296   // Although AIX runs on big endian CPU, float is in most significant
 297   // word of an argument slot.
 298   __ stfs(floatSlot, 0, arg_c);
 299 #else
 300 #error &quot;unknown OS&quot;
 301 #endif
 302   __ addi(arg_java, arg_java, -BytesPerWord);
 303   __ addi(arg_c, arg_c, BytesPerWord);
 304   __ cmplwi(CCR0, fpcnt, max_fp_register_arguments);
 305   __ blt(CCR0, move_floatSlot_to_FARG);
 306   __ b(loop_start);
 307 
 308   __ bind(do_double);
 309   __ lfd(floatSlot, - BytesPerWord, arg_java);
 310   __ stfd(floatSlot, 0, arg_c);
 311   __ addi(arg_java, arg_java, - 2 * BytesPerWord);
 312   __ addi(arg_c, arg_c, BytesPerWord);
 313   __ cmplwi(CCR0, fpcnt, max_fp_register_arguments);
 314   __ blt(CCR0, move_floatSlot_to_FARG);
 315   __ b(loop_start);
 316 
 317   __ bind(loop_end);
 318 
 319   __ pop_frame();
 320   __ restore_nonvolatile_gprs(R1_SP, _spill_nonvolatiles_neg(r14));
 321   __ restore_LR_CR(R0);
 322 
 323   __ blr();
 324 
 325   Label move_int_arg, move_float_arg;
 326   __ bind(move_int_arg); // each case must consist of 2 instructions (otherwise adapt LogSizeOfTwoInstructions)
 327   __ mr(R5_ARG3, intSlot);  __ b(loop_start);
 328   __ mr(R6_ARG4, intSlot);  __ b(loop_start);
 329   __ mr(R7_ARG5, intSlot);  __ b(loop_start);
 330   __ mr(R8_ARG6, intSlot);  __ b(loop_start);
 331   __ mr(R9_ARG7, intSlot);  __ b(loop_start);
 332   __ mr(R10_ARG8, intSlot); __ b(loop_start);
 333 
 334   __ bind(move_float_arg); // each case must consist of 2 instructions (otherwise adapt LogSizeOfTwoInstructions)
 335   __ fmr(F1_ARG1, floatSlot);   __ b(loop_start);
 336   __ fmr(F2_ARG2, floatSlot);   __ b(loop_start);
 337   __ fmr(F3_ARG3, floatSlot);   __ b(loop_start);
 338   __ fmr(F4_ARG4, floatSlot);   __ b(loop_start);
 339   __ fmr(F5_ARG5, floatSlot);   __ b(loop_start);
 340   __ fmr(F6_ARG6, floatSlot);   __ b(loop_start);
 341   __ fmr(F7_ARG7, floatSlot);   __ b(loop_start);
 342   __ fmr(F8_ARG8, floatSlot);   __ b(loop_start);
 343   __ fmr(F9_ARG9, floatSlot);   __ b(loop_start);
 344   __ fmr(F10_ARG10, floatSlot); __ b(loop_start);
 345   __ fmr(F11_ARG11, floatSlot); __ b(loop_start);
 346   __ fmr(F12_ARG12, floatSlot); __ b(loop_start);
 347   __ fmr(F13_ARG13, floatSlot); __ b(loop_start);
 348 
 349   __ bind(move_intSlot_to_ARG);
 350   __ sldi(R0, argcnt, LogSizeOfTwoInstructions);
 351   __ load_const(R11_scratch1, move_int_arg); // Label must be bound here.
 352   __ add(R11_scratch1, R0, R11_scratch1);
 353   __ mtctr(R11_scratch1/*branch_target*/);
 354   __ bctr();
 355   __ bind(move_floatSlot_to_FARG);
 356   __ sldi(R0, fpcnt, LogSizeOfTwoInstructions);
 357   __ addi(fpcnt, fpcnt, 1);
 358   __ load_const(R11_scratch1, move_float_arg); // Label must be bound here.
 359   __ add(R11_scratch1, R0, R11_scratch1);
 360   __ mtctr(R11_scratch1/*branch_target*/);
 361   __ bctr();
 362 
 363   return entry;
 364 }
 365 
 366 address TemplateInterpreterGenerator::generate_result_handler_for(BasicType type) {
 367   //
 368   // Registers alive
 369   //   R3_RET
 370   //   LR
 371   //
 372   // Registers updated
 373   //   R3_RET
 374   //
 375 
 376   Label done;
 377   address entry = __ pc();
 378 
 379   switch (type) {
 380   case T_BOOLEAN:
 381     // convert !=0 to 1
 382     __ neg(R0, R3_RET);
 383     __ orr(R0, R3_RET, R0);
 384     __ srwi(R3_RET, R0, 31);
 385     break;
 386   case T_BYTE:
 387      // sign extend 8 bits
 388      __ extsb(R3_RET, R3_RET);
 389      break;
 390   case T_CHAR:
 391      // zero extend 16 bits
 392      __ clrldi(R3_RET, R3_RET, 48);
 393      break;
 394   case T_SHORT:
 395      // sign extend 16 bits
 396      __ extsh(R3_RET, R3_RET);
 397      break;
 398   case T_INT:
 399      // sign extend 32 bits
 400      __ extsw(R3_RET, R3_RET);
 401      break;
 402   case T_LONG:
 403      break;
 404   case T_OBJECT:
 405     // JNIHandles::resolve result.
 406     __ resolve_jobject(R3_RET, R11_scratch1, R31, /* needs_frame */ true); // kills R31
 407     break;
 408   case T_FLOAT:
 409      break;
 410   case T_DOUBLE:
 411      break;
 412   case T_VOID:
 413      break;
 414   default: ShouldNotReachHere();
 415   }
 416 
 417   BIND(done);
 418   __ blr();
 419 
 420   return entry;
 421 }
 422 
 423 // Abstract method entry.
 424 //
 425 address TemplateInterpreterGenerator::generate_abstract_entry(void) {
 426   address entry = __ pc();
 427 
 428   //
 429   // Registers alive
 430   //   R16_thread     - JavaThread*
 431   //   R19_method     - callee&#39;s method (method to be invoked)
 432   //   R1_SP          - SP prepared such that caller&#39;s outgoing args are near top
 433   //   LR             - return address to caller
 434   //
 435   // Stack layout at this point:
 436   //
 437   //   0       [TOP_IJAVA_FRAME_ABI]         &lt;-- R1_SP
 438   //           alignment (optional)
 439   //           [outgoing Java arguments]
 440   //           ...
 441   //   PARENT  [PARENT_IJAVA_FRAME_ABI]
 442   //            ...
 443   //
 444 
 445   // Can&#39;t use call_VM here because we have not set up a new
 446   // interpreter state. Make the call to the vm and make it look like
 447   // our caller set up the JavaFrameAnchor.
 448   __ set_top_ijava_frame_at_SP_as_last_Java_frame(R1_SP, R12_scratch2/*tmp*/);
 449 
 450   // Push a new C frame and save LR.
 451   __ save_LR_CR(R0);
 452   __ push_frame_reg_args(0, R11_scratch1);
 453 
 454   // This is not a leaf but we have a JavaFrameAnchor now and we will
 455   // check (create) exceptions afterward so this is ok.
 456   __ call_VM_leaf(CAST_FROM_FN_PTR(address, InterpreterRuntime::throw_AbstractMethodErrorWithMethod),
 457                   R16_thread, R19_method);
 458 
 459   // Pop the C frame and restore LR.
 460   __ pop_frame();
 461   __ restore_LR_CR(R0);
 462 
 463   // Reset JavaFrameAnchor from call_VM_leaf above.
 464   __ reset_last_Java_frame();
 465 
 466   // We don&#39;t know our caller, so jump to the general forward exception stub,
 467   // which will also pop our full frame off. Satisfy the interface of
 468   // SharedRuntime::generate_forward_exception()
 469   __ load_const_optimized(R11_scratch1, StubRoutines::forward_exception_entry(), R0);
 470   __ mtctr(R11_scratch1);
 471   __ bctr();
 472 
 473   return entry;
 474 }
 475 
 476 // Interpreter intrinsic for WeakReference.get().
 477 // 1. Don&#39;t push a full blown frame and go on dispatching, but fetch the value
 478 //    into R8 and return quickly
 479 // 2. If G1 is active we *must* execute this intrinsic for corrrectness:
 480 //    It contains a GC barrier which puts the reference into the satb buffer
 481 //    to indicate that someone holds a strong reference to the object the
 482 //    weak ref points to!
 483 address TemplateInterpreterGenerator::generate_Reference_get_entry(void) {
 484   // Code: _aload_0, _getfield, _areturn
 485   // parameter size = 1
 486   //
 487   // The code that gets generated by this routine is split into 2 parts:
 488   //    1. the &quot;intrinsified&quot; code for G1 (or any SATB based GC),
 489   //    2. the slow path - which is an expansion of the regular method entry.
 490   //
 491   // Notes:
 492   // * In the G1 code we do not check whether we need to block for
 493   //   a safepoint. If G1 is enabled then we must execute the specialized
 494   //   code for Reference.get (except when the Reference object is null)
 495   //   so that we can log the value in the referent field with an SATB
 496   //   update buffer.
 497   //   If the code for the getfield template is modified so that the
 498   //   G1 pre-barrier code is executed when the current method is
 499   //   Reference.get() then going through the normal method entry
 500   //   will be fine.
 501   // * The G1 code can, however, check the receiver object (the instance
 502   //   of java.lang.Reference) and jump to the slow path if null. If the
 503   //   Reference object is null then we obviously cannot fetch the referent
 504   //   and so we don&#39;t need to call the G1 pre-barrier. Thus we can use the
 505   //   regular method entry code to generate the NPE.
 506   //
 507 
 508   address entry = __ pc();
 509 
<a name="2" id="anc2"></a><span class="line-modified"> 510   const int referent_offset = java_lang_ref_Reference::referent_offset();</span>

 511 
 512   Label slow_path;
 513 
 514   // Debugging not possible, so can&#39;t use __ skip_if_jvmti_mode(slow_path, GR31_SCRATCH);
 515 
 516   // In the G1 code we don&#39;t check if we need to reach a safepoint. We
 517   // continue and the thread will safepoint at the next bytecode dispatch.
 518 
 519   // If the receiver is null then it is OK to jump to the slow path.
 520   __ ld(R3_RET, Interpreter::stackElementSize, R15_esp); // get receiver
 521 
 522   // Check if receiver == NULL and go the slow path.
 523   __ cmpdi(CCR0, R3_RET, 0);
 524   __ beq(CCR0, slow_path);
 525 
 526   __ load_heap_oop(R3_RET, referent_offset, R3_RET,
 527                    /* non-volatile temp */ R31, R11_scratch1, true, ON_WEAK_OOP_REF);
 528 
 529   // Generate the G1 pre-barrier code to log the value of
 530   // the referent field in an SATB buffer. Note with
 531   // these parameters the pre-barrier does not generate
 532   // the load of the previous value.
 533 
 534   // Restore caller sp for c2i case (from compiled) and for resized sender frame (from interpreted).
 535   __ resize_frame_absolute(R21_sender_SP, R11_scratch1, R0);
 536 
 537   __ blr();
 538 
 539   __ bind(slow_path);
 540   __ jump_to_entry(Interpreter::entry_for_kind(Interpreter::zerolocals), R11_scratch1);
 541   return entry;
 542 }
 543 
 544 address TemplateInterpreterGenerator::generate_StackOverflowError_handler() {
 545   address entry = __ pc();
 546 
 547   // Expression stack must be empty before entering the VM if an
 548   // exception happened.
 549   __ empty_expression_stack();
 550   // Throw exception.
 551   __ call_VM(noreg,
 552              CAST_FROM_FN_PTR(address,
 553                               InterpreterRuntime::throw_StackOverflowError));
 554   return entry;
 555 }
 556 
 557 address TemplateInterpreterGenerator::generate_ArrayIndexOutOfBounds_handler() {
 558   address entry = __ pc();
 559   __ empty_expression_stack();
 560   // R4_ARG2 already contains the array.
 561   // Index is in R17_tos.
 562   __ mr(R5_ARG3, R17_tos);
 563   __ call_VM(noreg, CAST_FROM_FN_PTR(address, InterpreterRuntime::throw_ArrayIndexOutOfBoundsException), R4_ARG2, R5_ARG3);
 564   return entry;
 565 }
 566 
 567 address TemplateInterpreterGenerator::generate_ClassCastException_handler() {
 568   address entry = __ pc();
 569   // Expression stack must be empty before entering the VM if an
 570   // exception happened.
 571   __ empty_expression_stack();
 572 
 573   // Load exception object.
 574   // Thread will be loaded to R3_ARG1.
 575   __ call_VM(noreg, CAST_FROM_FN_PTR(address, InterpreterRuntime::throw_ClassCastException), R17_tos);
 576 #ifdef ASSERT
 577   // Above call must not return here since exception pending.
 578   __ should_not_reach_here();
 579 #endif
 580   return entry;
 581 }
 582 
 583 address TemplateInterpreterGenerator::generate_exception_handler_common(const char* name, const char* message, bool pass_oop) {
 584   address entry = __ pc();
 585   //__ untested(&quot;generate_exception_handler_common&quot;);
 586   Register Rexception = R17_tos;
 587 
 588   // Expression stack must be empty before entering the VM if an exception happened.
 589   __ empty_expression_stack();
 590 
 591   __ load_const_optimized(R4_ARG2, (address) name, R11_scratch1);
 592   if (pass_oop) {
 593     __ mr(R5_ARG3, Rexception);
 594     __ call_VM(Rexception, CAST_FROM_FN_PTR(address, InterpreterRuntime::create_klass_exception));
 595   } else {
 596     __ load_const_optimized(R5_ARG3, (address) message, R11_scratch1);
 597     __ call_VM(Rexception, CAST_FROM_FN_PTR(address, InterpreterRuntime::create_exception));
 598   }
 599 
 600   // Throw exception.
 601   __ mr(R3_ARG1, Rexception);
 602   __ load_const_optimized(R11_scratch1, Interpreter::throw_exception_entry(), R12_scratch2);
 603   __ mtctr(R11_scratch1);
 604   __ bctr();
 605 
 606   return entry;
 607 }
 608 
 609 // This entry is returned to when a call returns to the interpreter.
 610 // When we arrive here, we expect that the callee stack frame is already popped.
 611 address TemplateInterpreterGenerator::generate_return_entry_for(TosState state, int step, size_t index_size) {
 612   address entry = __ pc();
 613 
 614   // Move the value out of the return register back to the TOS cache of current frame.
 615   switch (state) {
 616     case ltos:
 617     case btos:
 618     case ztos:
 619     case ctos:
 620     case stos:
 621     case atos:
 622     case itos: __ mr(R17_tos, R3_RET); break;   // RET -&gt; TOS cache
 623     case ftos:
 624     case dtos: __ fmr(F15_ftos, F1_RET); break; // TOS cache -&gt; GR_FRET
 625     case vtos: break;                           // Nothing to do, this was a void return.
 626     default  : ShouldNotReachHere();
 627   }
 628 
 629   __ restore_interpreter_state(R11_scratch1); // Sets R11_scratch1 = fp.
 630   __ ld(R12_scratch2, _ijava_state_neg(top_frame_sp), R11_scratch1);
 631   __ resize_frame_absolute(R12_scratch2, R11_scratch1, R0);
 632 
 633   // Compiled code destroys templateTableBase, reload.
 634   __ load_const_optimized(R25_templateTableBase, (address)Interpreter::dispatch_table((TosState)0), R12_scratch2);
 635 
 636   if (state == atos) {
 637     __ profile_return_type(R3_RET, R11_scratch1, R12_scratch2);
 638   }
 639 
 640   const Register cache = R11_scratch1;
 641   const Register size  = R12_scratch2;
 642   __ get_cache_and_index_at_bcp(cache, 1, index_size);
 643 
 644   // Get least significant byte of 64 bit value:
 645 #if defined(VM_LITTLE_ENDIAN)
 646   __ lbz(size, in_bytes(ConstantPoolCache::base_offset() + ConstantPoolCacheEntry::flags_offset()), cache);
 647 #else
 648   __ lbz(size, in_bytes(ConstantPoolCache::base_offset() + ConstantPoolCacheEntry::flags_offset()) + 7, cache);
 649 #endif
 650   __ sldi(size, size, Interpreter::logStackElementSize);
 651   __ add(R15_esp, R15_esp, size);
 652 
 653  __ check_and_handle_popframe(R11_scratch1);
 654  __ check_and_handle_earlyret(R11_scratch1);
 655 
 656   __ dispatch_next(state, step);
 657   return entry;
 658 }
 659 
 660 address TemplateInterpreterGenerator::generate_deopt_entry_for(TosState state, int step, address continuation) {
 661   address entry = __ pc();
 662   // If state != vtos, we&#39;re returning from a native method, which put it&#39;s result
 663   // into the result register. So move the value out of the return register back
 664   // to the TOS cache of current frame.
 665 
 666   switch (state) {
 667     case ltos:
 668     case btos:
 669     case ztos:
 670     case ctos:
 671     case stos:
 672     case atos:
 673     case itos: __ mr(R17_tos, R3_RET); break;   // GR_RET -&gt; TOS cache
 674     case ftos:
 675     case dtos: __ fmr(F15_ftos, F1_RET); break; // TOS cache -&gt; GR_FRET
 676     case vtos: break;                           // Nothing to do, this was a void return.
 677     default  : ShouldNotReachHere();
 678   }
 679 
 680   // Load LcpoolCache @@@ should be already set!
 681   __ get_constant_pool_cache(R27_constPoolCache);
 682 
 683   // Handle a pending exception, fall through if none.
 684   __ check_and_forward_exception(R11_scratch1, R12_scratch2);
 685 
 686   // Start executing bytecodes.
 687   if (continuation == NULL) {
 688     __ dispatch_next(state, step);
 689   } else {
 690     __ jump_to_entry(continuation, R11_scratch1);
 691   }
 692 
 693   return entry;
 694 }
 695 
 696 address TemplateInterpreterGenerator::generate_safept_entry_for(TosState state, address runtime_entry) {
 697   address entry = __ pc();
 698 
 699   __ push(state);
 700   __ call_VM(noreg, runtime_entry);
 701   __ dispatch_via(vtos, Interpreter::_normal_table.table_for(vtos));
 702 
 703   return entry;
 704 }
 705 
 706 // Helpers for commoning out cases in the various type of method entries.
 707 
 708 // Increment invocation count &amp; check for overflow.
 709 //
 710 // Note: checking for negative value instead of overflow
 711 //       so we have a &#39;sticky&#39; overflow test.
 712 //
 713 void TemplateInterpreterGenerator::generate_counter_incr(Label* overflow, Label* profile_method, Label* profile_method_continue) {
 714   // Note: In tiered we increment either counters in method or in MDO depending if we&#39;re profiling or not.
 715   Register Rscratch1   = R11_scratch1;
 716   Register Rscratch2   = R12_scratch2;
 717   Register R3_counters = R3_ARG1;
 718   Label done;
 719 
 720   if (TieredCompilation) {
 721     const int increment = InvocationCounter::count_increment;
 722     Label no_mdo;
 723     if (ProfileInterpreter) {
 724       const Register Rmdo = R3_counters;
 725       // If no method data exists, go to profile_continue.
 726       __ ld(Rmdo, in_bytes(Method::method_data_offset()), R19_method);
 727       __ cmpdi(CCR0, Rmdo, 0);
 728       __ beq(CCR0, no_mdo);
 729 
 730       // Increment invocation counter in the MDO.
 731       const int mdo_ic_offs = in_bytes(MethodData::invocation_counter_offset()) + in_bytes(InvocationCounter::counter_offset());
 732       __ lwz(Rscratch2, mdo_ic_offs, Rmdo);
 733       __ lwz(Rscratch1, in_bytes(MethodData::invoke_mask_offset()), Rmdo);
 734       __ addi(Rscratch2, Rscratch2, increment);
 735       __ stw(Rscratch2, mdo_ic_offs, Rmdo);
 736       __ and_(Rscratch1, Rscratch2, Rscratch1);
 737       __ bne(CCR0, done);
 738       __ b(*overflow);
 739     }
 740 
 741     // Increment counter in MethodCounters*.
 742     const int mo_ic_offs = in_bytes(MethodCounters::invocation_counter_offset()) + in_bytes(InvocationCounter::counter_offset());
 743     __ bind(no_mdo);
 744     __ get_method_counters(R19_method, R3_counters, done);
 745     __ lwz(Rscratch2, mo_ic_offs, R3_counters);
 746     __ lwz(Rscratch1, in_bytes(MethodCounters::invoke_mask_offset()), R3_counters);
 747     __ addi(Rscratch2, Rscratch2, increment);
 748     __ stw(Rscratch2, mo_ic_offs, R3_counters);
 749     __ and_(Rscratch1, Rscratch2, Rscratch1);
 750     __ beq(CCR0, *overflow);
 751 
 752     __ bind(done);
 753 
 754   } else {
 755 
 756     // Update standard invocation counters.
 757     Register Rsum_ivc_bec = R4_ARG2;
 758     __ get_method_counters(R19_method, R3_counters, done);
 759     __ increment_invocation_counter(R3_counters, Rsum_ivc_bec, R12_scratch2);
 760     // Increment interpreter invocation counter.
 761     if (ProfileInterpreter) {  // %%% Merge this into methodDataOop.
 762       __ lwz(R12_scratch2, in_bytes(MethodCounters::interpreter_invocation_counter_offset()), R3_counters);
 763       __ addi(R12_scratch2, R12_scratch2, 1);
 764       __ stw(R12_scratch2, in_bytes(MethodCounters::interpreter_invocation_counter_offset()), R3_counters);
 765     }
 766     // Check if we must create a method data obj.
 767     if (ProfileInterpreter &amp;&amp; profile_method != NULL) {
 768       const Register profile_limit = Rscratch1;
 769       __ lwz(profile_limit, in_bytes(MethodCounters::interpreter_profile_limit_offset()), R3_counters);
 770       // Test to see if we should create a method data oop.
 771       __ cmpw(CCR0, Rsum_ivc_bec, profile_limit);
 772       __ blt(CCR0, *profile_method_continue);
 773       // If no method data exists, go to profile_method.
 774       __ test_method_data_pointer(*profile_method);
 775     }
 776     // Finally check for counter overflow.
 777     if (overflow) {
 778       const Register invocation_limit = Rscratch1;
 779       __ lwz(invocation_limit, in_bytes(MethodCounters::interpreter_invocation_limit_offset()), R3_counters);
 780       __ cmpw(CCR0, Rsum_ivc_bec, invocation_limit);
 781       __ bge(CCR0, *overflow);
 782     }
 783 
 784     __ bind(done);
 785   }
 786 }
 787 
 788 // Generate code to initiate compilation on invocation counter overflow.
 789 void TemplateInterpreterGenerator::generate_counter_overflow(Label&amp; continue_entry) {
 790   // Generate code to initiate compilation on the counter overflow.
 791 
 792   // InterpreterRuntime::frequency_counter_overflow takes one arguments,
 793   // which indicates if the counter overflow occurs at a backwards branch (NULL bcp)
 794   // We pass zero in.
 795   // The call returns the address of the verified entry point for the method or NULL
 796   // if the compilation did not complete (either went background or bailed out).
 797   //
 798   // Unlike the C++ interpreter above: Check exceptions!
 799   // Assumption: Caller must set the flag &quot;do_not_unlock_if_sychronized&quot; if the monitor of a sync&#39;ed
 800   // method has not yet been created. Thus, no unlocking of a non-existing monitor can occur.
 801 
 802   __ li(R4_ARG2, 0);
 803   __ call_VM(noreg, CAST_FROM_FN_PTR(address, InterpreterRuntime::frequency_counter_overflow), R4_ARG2, true);
 804 
 805   // Returns verified_entry_point or NULL.
 806   // We ignore it in any case.
 807   __ b(continue_entry);
 808 }
 809 
 810 // See if we&#39;ve got enough room on the stack for locals plus overhead below
 811 // JavaThread::stack_overflow_limit(). If not, throw a StackOverflowError
 812 // without going through the signal handler, i.e., reserved and yellow zones
 813 // will not be made usable. The shadow zone must suffice to handle the
 814 // overflow.
 815 //
 816 // Kills Rmem_frame_size, Rscratch1.
 817 void TemplateInterpreterGenerator::generate_stack_overflow_check(Register Rmem_frame_size, Register Rscratch1) {
 818   Label done;
 819   assert_different_registers(Rmem_frame_size, Rscratch1);
 820 
 821   BLOCK_COMMENT(&quot;stack_overflow_check_with_compare {&quot;);
 822   __ sub(Rmem_frame_size, R1_SP, Rmem_frame_size);
 823   __ ld(Rscratch1, thread_(stack_overflow_limit));
 824   __ cmpld(CCR0/*is_stack_overflow*/, Rmem_frame_size, Rscratch1);
 825   __ bgt(CCR0/*is_stack_overflow*/, done);
 826 
 827   // The stack overflows. Load target address of the runtime stub and call it.
 828   assert(StubRoutines::throw_StackOverflowError_entry() != NULL, &quot;generated in wrong order&quot;);
 829   __ load_const_optimized(Rscratch1, (StubRoutines::throw_StackOverflowError_entry()), R0);
 830   __ mtctr(Rscratch1);
 831   // Restore caller_sp (c2i adapter may exist, but no shrinking of interpreted caller frame).
 832 #ifdef ASSERT
 833   Label frame_not_shrunk;
 834   __ cmpld(CCR0, R1_SP, R21_sender_SP);
 835   __ ble(CCR0, frame_not_shrunk);
 836   __ stop(&quot;frame shrunk&quot;);
 837   __ bind(frame_not_shrunk);
 838   __ ld(Rscratch1, 0, R1_SP);
 839   __ ld(R0, 0, R21_sender_SP);
 840   __ cmpd(CCR0, R0, Rscratch1);
 841   __ asm_assert_eq(&quot;backlink&quot;);
 842 #endif // ASSERT
 843   __ mr(R1_SP, R21_sender_SP);
 844   __ bctr();
 845 
 846   __ align(32, 12);
 847   __ bind(done);
 848   BLOCK_COMMENT(&quot;} stack_overflow_check_with_compare&quot;);
 849 }
 850 
 851 // Lock the current method, interpreter register window must be set up!
 852 void TemplateInterpreterGenerator::lock_method(Register Rflags, Register Rscratch1, Register Rscratch2, bool flags_preloaded) {
 853   const Register Robj_to_lock = Rscratch2;
 854 
 855   {
 856     if (!flags_preloaded) {
 857       __ lwz(Rflags, method_(access_flags));
 858     }
 859 
 860 #ifdef ASSERT
 861     // Check if methods needs synchronization.
 862     {
 863       Label Lok;
 864       __ testbitdi(CCR0, R0, Rflags, JVM_ACC_SYNCHRONIZED_BIT);
 865       __ btrue(CCR0,Lok);
 866       __ stop(&quot;method doesn&#39;t need synchronization&quot;);
 867       __ bind(Lok);
 868     }
 869 #endif // ASSERT
 870   }
 871 
 872   // Get synchronization object to Rscratch2.
 873   {
 874     Label Lstatic;
 875     Label Ldone;
 876 
 877     __ testbitdi(CCR0, R0, Rflags, JVM_ACC_STATIC_BIT);
 878     __ btrue(CCR0, Lstatic);
 879 
 880     // Non-static case: load receiver obj from stack and we&#39;re done.
 881     __ ld(Robj_to_lock, R18_locals);
 882     __ b(Ldone);
 883 
 884     __ bind(Lstatic); // Static case: Lock the java mirror
 885     // Load mirror from interpreter frame.
 886     __ ld(Robj_to_lock, _abi(callers_sp), R1_SP);
 887     __ ld(Robj_to_lock, _ijava_state_neg(mirror), Robj_to_lock);
 888 
 889     __ bind(Ldone);
 890     __ verify_oop(Robj_to_lock);
 891   }
 892 
 893   // Got the oop to lock =&gt; execute!
 894   __ add_monitor_to_stack(true, Rscratch1, R0);
 895 
 896   __ std(Robj_to_lock, BasicObjectLock::obj_offset_in_bytes(), R26_monitor);
 897   __ lock_object(R26_monitor, Robj_to_lock);
 898 }
 899 
 900 // Generate a fixed interpreter frame for pure interpreter
 901 // and I2N native transition frames.
 902 //
 903 // Before (stack grows downwards):
 904 //
 905 //         |  ...         |
 906 //         |------------- |
 907 //         |  java arg0   |
 908 //         |  ...         |
 909 //         |  java argn   |
 910 //         |              |   &lt;-   R15_esp
 911 //         |              |
 912 //         |--------------|
 913 //         | abi_112      |
 914 //         |              |   &lt;-   R1_SP
 915 //         |==============|
 916 //
 917 //
 918 // After:
 919 //
 920 //         |  ...         |
 921 //         |  java arg0   |&lt;-   R18_locals
 922 //         |  ...         |
 923 //         |  java argn   |
 924 //         |--------------|
 925 //         |              |
 926 //         |  java locals |
 927 //         |              |
 928 //         |--------------|
 929 //         |  abi_48      |
 930 //         |==============|
 931 //         |              |
 932 //         |   istate     |
 933 //         |              |
 934 //         |--------------|
 935 //         |   monitor    |&lt;-   R26_monitor
 936 //         |--------------|
 937 //         |              |&lt;-   R15_esp
 938 //         | expression   |
 939 //         | stack        |
 940 //         |              |
 941 //         |--------------|
 942 //         |              |
 943 //         | abi_112      |&lt;-   R1_SP
 944 //         |==============|
 945 //
 946 // The top most frame needs an abi space of 112 bytes. This space is needed,
 947 // since we call to c. The c function may spill their arguments to the caller
 948 // frame. When we call to java, we don&#39;t need these spill slots. In order to save
 949 // space on the stack, we resize the caller. However, java locals reside in
 950 // the caller frame and the frame has to be increased. The frame_size for the
 951 // current frame was calculated based on max_stack as size for the expression
 952 // stack. At the call, just a part of the expression stack might be used.
 953 // We don&#39;t want to waste this space and cut the frame back accordingly.
 954 // The resulting amount for resizing is calculated as follows:
 955 // resize =   (number_of_locals - number_of_arguments) * slot_size
 956 //          + (R1_SP - R15_esp) + 48
 957 //
 958 // The size for the callee frame is calculated:
 959 // framesize = 112 + max_stack + monitor + state_size
 960 //
 961 // maxstack:   Max number of slots on the expression stack, loaded from the method.
 962 // monitor:    We statically reserve room for one monitor object.
 963 // state_size: We save the current state of the interpreter to this area.
 964 //
 965 void TemplateInterpreterGenerator::generate_fixed_frame(bool native_call, Register Rsize_of_parameters, Register Rsize_of_locals) {
 966   Register parent_frame_resize = R6_ARG4, // Frame will grow by this number of bytes.
 967            top_frame_size      = R7_ARG5,
 968            Rconst_method       = R8_ARG6;
 969 
 970   assert_different_registers(Rsize_of_parameters, Rsize_of_locals, parent_frame_resize, top_frame_size);
 971 
 972   __ ld(Rconst_method, method_(const));
 973   __ lhz(Rsize_of_parameters /* number of params */,
 974          in_bytes(ConstMethod::size_of_parameters_offset()), Rconst_method);
 975   if (native_call) {
 976     // If we&#39;re calling a native method, we reserve space for the worst-case signature
 977     // handler varargs vector, which is max(Argument::n_register_parameters, parameter_count+2).
 978     // We add two slots to the parameter_count, one for the jni
 979     // environment and one for a possible native mirror.
 980     Label skip_native_calculate_max_stack;
 981     __ addi(top_frame_size, Rsize_of_parameters, 2);
 982     __ cmpwi(CCR0, top_frame_size, Argument::n_register_parameters);
 983     __ bge(CCR0, skip_native_calculate_max_stack);
 984     __ li(top_frame_size, Argument::n_register_parameters);
 985     __ bind(skip_native_calculate_max_stack);
 986     __ sldi(Rsize_of_parameters, Rsize_of_parameters, Interpreter::logStackElementSize);
 987     __ sldi(top_frame_size, top_frame_size, Interpreter::logStackElementSize);
 988     __ sub(parent_frame_resize, R1_SP, R15_esp); // &lt;0, off by Interpreter::stackElementSize!
 989     assert(Rsize_of_locals == noreg, &quot;Rsize_of_locals not initialized&quot;); // Only relevant value is Rsize_of_parameters.
 990   } else {
 991     __ lhz(Rsize_of_locals /* number of params */, in_bytes(ConstMethod::size_of_locals_offset()), Rconst_method);
 992     __ sldi(Rsize_of_parameters, Rsize_of_parameters, Interpreter::logStackElementSize);
 993     __ sldi(Rsize_of_locals, Rsize_of_locals, Interpreter::logStackElementSize);
 994     __ lhz(top_frame_size, in_bytes(ConstMethod::max_stack_offset()), Rconst_method);
 995     __ sub(R11_scratch1, Rsize_of_locals, Rsize_of_parameters); // &gt;=0
 996     __ sub(parent_frame_resize, R1_SP, R15_esp); // &lt;0, off by Interpreter::stackElementSize!
 997     __ sldi(top_frame_size, top_frame_size, Interpreter::logStackElementSize);
 998     __ add(parent_frame_resize, parent_frame_resize, R11_scratch1);
 999   }
1000 
1001   // Compute top frame size.
1002   __ addi(top_frame_size, top_frame_size, frame::abi_reg_args_size + frame::ijava_state_size);
1003 
1004   // Cut back area between esp and max_stack.
1005   __ addi(parent_frame_resize, parent_frame_resize, frame::abi_minframe_size - Interpreter::stackElementSize);
1006 
1007   __ round_to(top_frame_size, frame::alignment_in_bytes);
1008   __ round_to(parent_frame_resize, frame::alignment_in_bytes);
1009   // parent_frame_resize = (locals-parameters) - (ESP-SP-ABI48) Rounded to frame alignment size.
1010   // Enlarge by locals-parameters (not in case of native_call), shrink by ESP-SP-ABI48.
1011 
1012   if (!native_call) {
1013     // Stack overflow check.
1014     // Native calls don&#39;t need the stack size check since they have no
1015     // expression stack and the arguments are already on the stack and
1016     // we only add a handful of words to the stack.
1017     __ add(R11_scratch1, parent_frame_resize, top_frame_size);
1018     generate_stack_overflow_check(R11_scratch1, R12_scratch2);
1019   }
1020 
1021   // Set up interpreter state registers.
1022 
1023   __ add(R18_locals, R15_esp, Rsize_of_parameters);
1024   __ ld(R27_constPoolCache, in_bytes(ConstMethod::constants_offset()), Rconst_method);
1025   __ ld(R27_constPoolCache, ConstantPool::cache_offset_in_bytes(), R27_constPoolCache);
1026 
1027   // Set method data pointer.
1028   if (ProfileInterpreter) {
1029     Label zero_continue;
1030     __ ld(R28_mdx, method_(method_data));
1031     __ cmpdi(CCR0, R28_mdx, 0);
1032     __ beq(CCR0, zero_continue);
1033     __ addi(R28_mdx, R28_mdx, in_bytes(MethodData::data_offset()));
1034     __ bind(zero_continue);
1035   }
1036 
1037   if (native_call) {
1038     __ li(R14_bcp, 0); // Must initialize.
1039   } else {
1040     __ add(R14_bcp, in_bytes(ConstMethod::codes_offset()), Rconst_method);
1041   }
1042 
1043   // Resize parent frame.
1044   __ mflr(R12_scratch2);
1045   __ neg(parent_frame_resize, parent_frame_resize);
1046   __ resize_frame(parent_frame_resize, R11_scratch1);
1047   __ std(R12_scratch2, _abi(lr), R1_SP);
1048 
1049   // Get mirror and store it in the frame as GC root for this Method*.
1050   __ load_mirror_from_const_method(R12_scratch2, Rconst_method);
1051 
1052   __ addi(R26_monitor, R1_SP, -frame::ijava_state_size);
1053   __ addi(R15_esp, R26_monitor, -Interpreter::stackElementSize);
1054 
1055   // Store values.
1056   __ std(R19_method, _ijava_state_neg(method), R1_SP);
1057   __ std(R12_scratch2, _ijava_state_neg(mirror), R1_SP);
1058   __ std(R18_locals, _ijava_state_neg(locals), R1_SP);
1059   __ std(R27_constPoolCache, _ijava_state_neg(cpoolCache), R1_SP);
1060 
1061   // Note: esp, bcp, monitor, mdx live in registers. Hence, the correct version can only
1062   // be found in the frame after save_interpreter_state is done. This is always true
1063   // for non-top frames. But when a signal occurs, dumping the top frame can go wrong,
1064   // because e.g. frame::interpreter_frame_bcp() will not access the correct value
1065   // (Enhanced Stack Trace).
1066   // The signal handler does not save the interpreter state into the frame.
1067 
1068   // We have to initialize some of these frame slots for native calls (accessed by GC).
1069   // Also initialize them for non-native calls for better tool support (even though
1070   // you may not get the most recent version as described above).
1071   __ li(R0, 0);
1072   __ std(R26_monitor, _ijava_state_neg(monitors), R1_SP);
1073   __ std(R14_bcp, _ijava_state_neg(bcp), R1_SP);
1074   if (ProfileInterpreter) { __ std(R28_mdx, _ijava_state_neg(mdx), R1_SP); }
1075   __ std(R15_esp, _ijava_state_neg(esp), R1_SP);
1076   __ std(R0, _ijava_state_neg(oop_tmp), R1_SP); // only used for native_call
1077 
1078   // Store sender&#39;s SP and this frame&#39;s top SP.
1079   __ subf(R12_scratch2, top_frame_size, R1_SP);
1080   __ std(R21_sender_SP, _ijava_state_neg(sender_sp), R1_SP);
1081   __ std(R12_scratch2, _ijava_state_neg(top_frame_sp), R1_SP);
1082 
1083   // Push top frame.
1084   __ push_frame(top_frame_size, R11_scratch1);
1085 }
1086 
1087 // End of helpers
1088 
1089 address TemplateInterpreterGenerator::generate_math_entry(AbstractInterpreter::MethodKind kind) {
1090 
1091   // Decide what to do: Use same platform specific instructions and runtime calls as compilers.
1092   bool use_instruction = false;
1093   address runtime_entry = NULL;
1094   int num_args = 1;
1095   bool double_precision = true;
1096 
1097   // PPC64 specific:
1098   switch (kind) {
1099     case Interpreter::java_lang_math_sqrt: use_instruction = VM_Version::has_fsqrt(); break;
1100     case Interpreter::java_lang_math_abs:  use_instruction = true; break;
1101     case Interpreter::java_lang_math_fmaF:
1102     case Interpreter::java_lang_math_fmaD: use_instruction = UseFMA; break;
1103     default: break; // Fall back to runtime call.
1104   }
1105 
1106   switch (kind) {
1107     case Interpreter::java_lang_math_sin  : runtime_entry = CAST_FROM_FN_PTR(address, SharedRuntime::dsin);   break;
1108     case Interpreter::java_lang_math_cos  : runtime_entry = CAST_FROM_FN_PTR(address, SharedRuntime::dcos);   break;
1109     case Interpreter::java_lang_math_tan  : runtime_entry = CAST_FROM_FN_PTR(address, SharedRuntime::dtan);   break;
1110     case Interpreter::java_lang_math_abs  : /* run interpreted */ break;
1111     case Interpreter::java_lang_math_sqrt : runtime_entry = CAST_FROM_FN_PTR(address, SharedRuntime::dsqrt);  break;
1112     case Interpreter::java_lang_math_log  : runtime_entry = CAST_FROM_FN_PTR(address, SharedRuntime::dlog);   break;
1113     case Interpreter::java_lang_math_log10: runtime_entry = CAST_FROM_FN_PTR(address, SharedRuntime::dlog10); break;
1114     case Interpreter::java_lang_math_pow  : runtime_entry = CAST_FROM_FN_PTR(address, SharedRuntime::dpow); num_args = 2; break;
1115     case Interpreter::java_lang_math_exp  : runtime_entry = CAST_FROM_FN_PTR(address, SharedRuntime::dexp);   break;
1116     case Interpreter::java_lang_math_fmaF : /* run interpreted */ num_args = 3; double_precision = false; break;
1117     case Interpreter::java_lang_math_fmaD : /* run interpreted */ num_args = 3; break;
1118     default: ShouldNotReachHere();
1119   }
1120 
1121   // Use normal entry if neither instruction nor runtime call is used.
1122   if (!use_instruction &amp;&amp; runtime_entry == NULL) return NULL;
1123 
1124   address entry = __ pc();
1125 
1126   // Load arguments
1127   assert(num_args &lt;= 13, &quot;passed in registers&quot;);
1128   if (double_precision) {
1129     int offset = (2 * num_args - 1) * Interpreter::stackElementSize;
1130     for (int i = 0; i &lt; num_args; ++i) {
1131       __ lfd(as_FloatRegister(F1_ARG1-&gt;encoding() + i), offset, R15_esp);
1132       offset -= 2 * Interpreter::stackElementSize;
1133     }
1134   } else {
1135     int offset = num_args * Interpreter::stackElementSize;
1136     for (int i = 0; i &lt; num_args; ++i) {
1137       __ lfs(as_FloatRegister(F1_ARG1-&gt;encoding() + i), offset, R15_esp);
1138       offset -= Interpreter::stackElementSize;
1139     }
1140   }
1141 
1142   if (use_instruction) {
1143     switch (kind) {
1144       case Interpreter::java_lang_math_sqrt: __ fsqrt(F1_RET, F1);          break;
1145       case Interpreter::java_lang_math_abs:  __ fabs(F1_RET, F1);           break;
1146       case Interpreter::java_lang_math_fmaF: __ fmadds(F1_RET, F1, F2, F3); break;
1147       case Interpreter::java_lang_math_fmaD: __ fmadd(F1_RET, F1, F2, F3);  break;
1148       default: ShouldNotReachHere();
1149     }
1150   } else {
1151     // Comment: Can use tail call if the unextended frame is always C ABI compliant:
1152     //__ load_const_optimized(R12_scratch2, runtime_entry, R0);
1153     //__ call_c_and_return_to_caller(R12_scratch2);
1154 
1155     // Push a new C frame and save LR.
1156     __ save_LR_CR(R0);
1157     __ push_frame_reg_args(0, R11_scratch1);
1158 
1159     __ call_VM_leaf(runtime_entry);
1160 
1161     // Pop the C frame and restore LR.
1162     __ pop_frame();
1163     __ restore_LR_CR(R0);
1164   }
1165 
1166   // Restore caller sp for c2i case (from compiled) and for resized sender frame (from interpreted).
1167   __ resize_frame_absolute(R21_sender_SP, R11_scratch1, R0);
1168   __ blr();
1169 
1170   __ flush();
1171 
1172   return entry;
1173 }
1174 
1175 void TemplateInterpreterGenerator::bang_stack_shadow_pages(bool native_call) {
1176   // Quick &amp; dirty stack overflow checking: bang the stack &amp; handle trap.
1177   // Note that we do the banging after the frame is setup, since the exception
1178   // handling code expects to find a valid interpreter frame on the stack.
1179   // Doing the banging earlier fails if the caller frame is not an interpreter
1180   // frame.
1181   // (Also, the exception throwing code expects to unlock any synchronized
1182   // method receiever, so do the banging after locking the receiver.)
1183 
1184   // Bang each page in the shadow zone. We can&#39;t assume it&#39;s been done for
1185   // an interpreter frame with greater than a page of locals, so each page
1186   // needs to be checked.  Only true for non-native.
1187   if (UseStackBanging) {
1188     const int page_size = os::vm_page_size();
1189     const int n_shadow_pages = ((int)JavaThread::stack_shadow_zone_size()) / page_size;
1190     const int start_page = native_call ? n_shadow_pages : 1;
1191     BLOCK_COMMENT(&quot;bang_stack_shadow_pages:&quot;);
1192     for (int pages = start_page; pages &lt;= n_shadow_pages; pages++) {
1193       __ bang_stack_with_offset(pages*page_size);
1194     }
1195   }
1196 }
1197 
1198 // Interpreter stub for calling a native method. (asm interpreter)
1199 // This sets up a somewhat different looking stack for calling the
1200 // native method than the typical interpreter frame setup.
1201 //
1202 // On entry:
1203 //   R19_method    - method
1204 //   R16_thread    - JavaThread*
1205 //   R15_esp       - intptr_t* sender tos
1206 //
1207 //   abstract stack (grows up)
1208 //     [  IJava (caller of JNI callee)  ]  &lt;-- ASP
1209 //        ...
1210 address TemplateInterpreterGenerator::generate_native_entry(bool synchronized) {
1211 
1212   address entry = __ pc();
1213 
1214   const bool inc_counter = UseCompiler || CountCompiledCalls || LogTouchedMethods;
1215 
1216   // -----------------------------------------------------------------------------
1217   // Allocate a new frame that represents the native callee (i2n frame).
1218   // This is not a full-blown interpreter frame, but in particular, the
1219   // following registers are valid after this:
1220   // - R19_method
1221   // - R18_local (points to start of arguments to native function)
1222   //
1223   //   abstract stack (grows up)
1224   //     [  IJava (caller of JNI callee)  ]  &lt;-- ASP
1225   //        ...
1226 
1227   const Register signature_handler_fd = R11_scratch1;
1228   const Register pending_exception    = R0;
1229   const Register result_handler_addr  = R31;
1230   const Register native_method_fd     = R11_scratch1;
1231   const Register access_flags         = R22_tmp2;
1232   const Register active_handles       = R11_scratch1; // R26_monitor saved to state.
1233   const Register sync_state           = R12_scratch2;
1234   const Register sync_state_addr      = sync_state;   // Address is dead after use.
1235   const Register suspend_flags        = R11_scratch1;
1236 
1237   //=============================================================================
1238   // Allocate new frame and initialize interpreter state.
1239 
1240   Label exception_return;
1241   Label exception_return_sync_check;
1242   Label stack_overflow_return;
1243 
1244   // Generate new interpreter state and jump to stack_overflow_return in case of
1245   // a stack overflow.
1246   //generate_compute_interpreter_state(stack_overflow_return);
1247 
1248   Register size_of_parameters = R22_tmp2;
1249 
1250   generate_fixed_frame(true, size_of_parameters, noreg /* unused */);
1251 
1252   //=============================================================================
1253   // Increment invocation counter. On overflow, entry to JNI method
1254   // will be compiled.
1255   Label invocation_counter_overflow, continue_after_compile;
1256   if (inc_counter) {
1257     if (synchronized) {
1258       // Since at this point in the method invocation the exception handler
1259       // would try to exit the monitor of synchronized methods which hasn&#39;t
1260       // been entered yet, we set the thread local variable
1261       // _do_not_unlock_if_synchronized to true. If any exception was thrown by
1262       // runtime, exception handling i.e. unlock_if_synchronized_method will
1263       // check this thread local flag.
1264       // This flag has two effects, one is to force an unwind in the topmost
1265       // interpreter frame and not perform an unlock while doing so.
1266       __ li(R0, 1);
1267       __ stb(R0, in_bytes(JavaThread::do_not_unlock_if_synchronized_offset()), R16_thread);
1268     }
1269     generate_counter_incr(&amp;invocation_counter_overflow, NULL, NULL);
1270 
1271     BIND(continue_after_compile);
1272   }
1273 
1274   bang_stack_shadow_pages(true);
1275 
1276   if (inc_counter) {
1277     // Reset the _do_not_unlock_if_synchronized flag.
1278     if (synchronized) {
1279       __ li(R0, 0);
1280       __ stb(R0, in_bytes(JavaThread::do_not_unlock_if_synchronized_offset()), R16_thread);
1281     }
1282   }
1283 
1284   // access_flags = method-&gt;access_flags();
1285   // Load access flags.
1286   assert(access_flags-&gt;is_nonvolatile(),
1287          &quot;access_flags must be in a non-volatile register&quot;);
1288   // Type check.
1289   assert(4 == sizeof(AccessFlags), &quot;unexpected field size&quot;);
1290   __ lwz(access_flags, method_(access_flags));
1291 
1292   // We don&#39;t want to reload R19_method and access_flags after calls
1293   // to some helper functions.
1294   assert(R19_method-&gt;is_nonvolatile(),
1295          &quot;R19_method must be a non-volatile register&quot;);
1296 
1297   // Check for synchronized methods. Must happen AFTER invocation counter
1298   // check, so method is not locked if counter overflows.
1299 
1300   if (synchronized) {
1301     lock_method(access_flags, R11_scratch1, R12_scratch2, true);
1302 
1303     // Update monitor in state.
1304     __ ld(R11_scratch1, 0, R1_SP);
1305     __ std(R26_monitor, _ijava_state_neg(monitors), R11_scratch1);
1306   }
1307 
1308   // jvmti/jvmpi support
1309   __ notify_method_entry();
1310 
1311   //=============================================================================
1312   // Get and call the signature handler.
1313 
1314   __ ld(signature_handler_fd, method_(signature_handler));
1315   Label call_signature_handler;
1316 
1317   __ cmpdi(CCR0, signature_handler_fd, 0);
1318   __ bne(CCR0, call_signature_handler);
1319 
1320   // Method has never been called. Either generate a specialized
1321   // handler or point to the slow one.
1322   //
1323   // Pass parameter &#39;false&#39; to avoid exception check in call_VM.
1324   __ call_VM(noreg, CAST_FROM_FN_PTR(address, InterpreterRuntime::prepare_native_call), R19_method, false);
1325 
1326   // Check for an exception while looking up the target method. If we
1327   // incurred one, bail.
1328   __ ld(pending_exception, thread_(pending_exception));
1329   __ cmpdi(CCR0, pending_exception, 0);
1330   __ bne(CCR0, exception_return_sync_check); // Has pending exception.
1331 
1332   // Reload signature handler, it may have been created/assigned in the meanwhile.
1333   __ ld(signature_handler_fd, method_(signature_handler));
1334   __ twi_0(signature_handler_fd); // Order wrt. load of klass mirror and entry point (isync is below).
1335 
1336   BIND(call_signature_handler);
1337 
1338   // Before we call the signature handler we push a new frame to
1339   // protect the interpreter frame volatile registers when we return
1340   // from jni but before we can get back to Java.
1341 
1342   // First set the frame anchor while the SP/FP registers are
1343   // convenient and the slow signature handler can use this same frame
1344   // anchor.
1345 
1346   // We have a TOP_IJAVA_FRAME here, which belongs to us.
1347   __ set_top_ijava_frame_at_SP_as_last_Java_frame(R1_SP, R12_scratch2/*tmp*/);
1348 
1349   // Now the interpreter frame (and its call chain) have been
1350   // invalidated and flushed. We are now protected against eager
1351   // being enabled in native code. Even if it goes eager the
1352   // registers will be reloaded as clean and we will invalidate after
1353   // the call so no spurious flush should be possible.
1354 
1355   // Call signature handler and pass locals address.
1356   //
1357   // Our signature handlers copy required arguments to the C stack
1358   // (outgoing C args), R3_ARG1 to R10_ARG8, and FARG1 to FARG13.
1359   __ mr(R3_ARG1, R18_locals);
1360 #if !defined(ABI_ELFv2)
1361   __ ld(signature_handler_fd, 0, signature_handler_fd);
1362 #endif
1363 
1364   __ call_stub(signature_handler_fd);
1365 
1366   // Remove the register parameter varargs slots we allocated in
1367   // compute_interpreter_state. SP+16 ends up pointing to the ABI
1368   // outgoing argument area.
1369   //
1370   // Not needed on PPC64.
1371   //__ add(SP, SP, Argument::n_register_parameters*BytesPerWord);
1372 
1373   assert(result_handler_addr-&gt;is_nonvolatile(), &quot;result_handler_addr must be in a non-volatile register&quot;);
1374   // Save across call to native method.
1375   __ mr(result_handler_addr, R3_RET);
1376 
1377   __ isync(); // Acquire signature handler before trying to fetch the native entry point and klass mirror.
1378 
1379   // Set up fixed parameters and call the native method.
1380   // If the method is static, get mirror into R4_ARG2.
1381   {
1382     Label method_is_not_static;
1383     // Access_flags is non-volatile and still, no need to restore it.
1384 
1385     // Restore access flags.
1386     __ testbitdi(CCR0, R0, access_flags, JVM_ACC_STATIC_BIT);
1387     __ bfalse(CCR0, method_is_not_static);
1388 
1389     __ ld(R11_scratch1, _abi(callers_sp), R1_SP);
1390     // Load mirror from interpreter frame.
1391     __ ld(R12_scratch2, _ijava_state_neg(mirror), R11_scratch1);
1392     // R4_ARG2 = &amp;state-&gt;_oop_temp;
1393     __ addi(R4_ARG2, R11_scratch1, _ijava_state_neg(oop_tmp));
1394     __ std(R12_scratch2/*mirror*/, _ijava_state_neg(oop_tmp), R11_scratch1);
1395     BIND(method_is_not_static);
1396   }
1397 
1398   // At this point, arguments have been copied off the stack into
1399   // their JNI positions. Oops are boxed in-place on the stack, with
1400   // handles copied to arguments. The result handler address is in a
1401   // register.
1402 
1403   // Pass JNIEnv address as first parameter.
1404   __ addir(R3_ARG1, thread_(jni_environment));
1405 
1406   // Load the native_method entry before we change the thread state.
1407   __ ld(native_method_fd, method_(native_function));
1408 
1409   //=============================================================================
1410   // Transition from _thread_in_Java to _thread_in_native. As soon as
1411   // we make this change the safepoint code needs to be certain that
1412   // the last Java frame we established is good. The pc in that frame
1413   // just needs to be near here not an actual return address.
1414 
1415   // We use release_store_fence to update values like the thread state, where
1416   // we don&#39;t want the current thread to continue until all our prior memory
1417   // accesses (including the new thread state) are visible to other threads.
1418   __ li(R0, _thread_in_native);
1419   __ release();
1420 
1421   // TODO PPC port assert(4 == JavaThread::sz_thread_state(), &quot;unexpected field size&quot;);
1422   __ stw(R0, thread_(thread_state));
1423 
1424   //=============================================================================
1425   // Call the native method. Argument registers must not have been
1426   // overwritten since &quot;__ call_stub(signature_handler);&quot; (except for
1427   // ARG1 and ARG2 for static methods).
1428   __ call_c(native_method_fd);
1429 
1430   __ li(R0, 0);
1431   __ ld(R11_scratch1, 0, R1_SP);
1432   __ std(R3_RET, _ijava_state_neg(lresult), R11_scratch1);
1433   __ stfd(F1_RET, _ijava_state_neg(fresult), R11_scratch1);
1434   __ std(R0/*mirror*/, _ijava_state_neg(oop_tmp), R11_scratch1); // reset
1435 
1436   // Note: C++ interpreter needs the following here:
1437   // The frame_manager_lr field, which we use for setting the last
1438   // java frame, gets overwritten by the signature handler. Restore
1439   // it now.
1440   //__ get_PC_trash_LR(R11_scratch1);
1441   //__ std(R11_scratch1, _top_ijava_frame_abi(frame_manager_lr), R1_SP);
1442 
1443   // Because of GC R19_method may no longer be valid.
1444 
1445   // Block, if necessary, before resuming in _thread_in_Java state.
1446   // In order for GC to work, don&#39;t clear the last_Java_sp until after
1447   // blocking.
1448 
1449   //=============================================================================
1450   // Switch thread to &quot;native transition&quot; state before reading the
1451   // synchronization state. This additional state is necessary
1452   // because reading and testing the synchronization state is not
1453   // atomic w.r.t. GC, as this scenario demonstrates: Java thread A,
1454   // in _thread_in_native state, loads _not_synchronized and is
1455   // preempted. VM thread changes sync state to synchronizing and
1456   // suspends threads for GC. Thread A is resumed to finish this
1457   // native method, but doesn&#39;t block here since it didn&#39;t see any
1458   // synchronization in progress, and escapes.
1459 
1460   // We use release_store_fence to update values like the thread state, where
1461   // we don&#39;t want the current thread to continue until all our prior memory
1462   // accesses (including the new thread state) are visible to other threads.
1463   __ li(R0/*thread_state*/, _thread_in_native_trans);
1464   __ release();
1465   __ stw(R0/*thread_state*/, thread_(thread_state));
1466   __ fence();
1467 
1468   // Now before we return to java we must look for a current safepoint
1469   // (a new safepoint can not start since we entered native_trans).
1470   // We must check here because a current safepoint could be modifying
1471   // the callers registers right this moment.
1472 
1473   // Acquire isn&#39;t strictly necessary here because of the fence, but
1474   // sync_state is declared to be volatile, so we do it anyway
1475   // (cmp-br-isync on one path, release (same as acquire on PPC64) on the other path).
1476 
1477   Label do_safepoint, sync_check_done;
1478   // No synchronization in progress nor yet synchronized.
1479   __ safepoint_poll(do_safepoint, sync_state);
1480 
1481   // Not suspended.
1482   // TODO PPC port assert(4 == Thread::sz_suspend_flags(), &quot;unexpected field size&quot;);
1483   __ lwz(suspend_flags, thread_(suspend_flags));
1484   __ cmpwi(CCR1, suspend_flags, 0);
1485   __ beq(CCR1, sync_check_done);
1486 
1487   __ bind(do_safepoint);
1488   __ isync();
1489   // Block. We do the call directly and leave the current
1490   // last_Java_frame setup undisturbed. We must save any possible
1491   // native result across the call. No oop is present.
1492 
1493   __ mr(R3_ARG1, R16_thread);
1494 #if defined(ABI_ELFv2)
1495   __ call_c(CAST_FROM_FN_PTR(address, JavaThread::check_special_condition_for_native_trans),
1496             relocInfo::none);
1497 #else
1498   __ call_c(CAST_FROM_FN_PTR(FunctionDescriptor*, JavaThread::check_special_condition_for_native_trans),
1499             relocInfo::none);
1500 #endif
1501 
1502   __ bind(sync_check_done);
1503 
1504   //=============================================================================
1505   // &lt;&lt;&lt;&lt;&lt;&lt; Back in Interpreter Frame &gt;&gt;&gt;&gt;&gt;
1506 
1507   // We are in thread_in_native_trans here and back in the normal
1508   // interpreter frame. We don&#39;t have to do anything special about
1509   // safepoints and we can switch to Java mode anytime we are ready.
1510 
1511   // Note: frame::interpreter_frame_result has a dependency on how the
1512   // method result is saved across the call to post_method_exit. For
1513   // native methods it assumes that the non-FPU/non-void result is
1514   // saved in _native_lresult and a FPU result in _native_fresult. If
1515   // this changes then the interpreter_frame_result implementation
1516   // will need to be updated too.
1517 
1518   // On PPC64, we have stored the result directly after the native call.
1519 
1520   //=============================================================================
1521   // Back in Java
1522 
1523   // We use release_store_fence to update values like the thread state, where
1524   // we don&#39;t want the current thread to continue until all our prior memory
1525   // accesses (including the new thread state) are visible to other threads.
1526   __ li(R0/*thread_state*/, _thread_in_Java);
1527   __ lwsync(); // Acquire safepoint and suspend state, release thread state.
1528   __ stw(R0/*thread_state*/, thread_(thread_state));
1529 
1530   if (CheckJNICalls) {
1531     // clear_pending_jni_exception_check
1532     __ load_const_optimized(R0, 0L);
1533     __ st_ptr(R0, JavaThread::pending_jni_exception_check_fn_offset(), R16_thread);
1534   }
1535 
1536   __ reset_last_Java_frame();
1537 
1538   // Jvmdi/jvmpi support. Whether we&#39;ve got an exception pending or
1539   // not, and whether unlocking throws an exception or not, we notify
1540   // on native method exit. If we do have an exception, we&#39;ll end up
1541   // in the caller&#39;s context to handle it, so if we don&#39;t do the
1542   // notify here, we&#39;ll drop it on the floor.
1543   __ notify_method_exit(true/*native method*/,
1544                         ilgl /*illegal state (not used for native methods)*/,
1545                         InterpreterMacroAssembler::NotifyJVMTI,
1546                         false /*check_exceptions*/);
1547 
1548   //=============================================================================
1549   // Handle exceptions
1550 
1551   if (synchronized) {
1552     // Don&#39;t check for exceptions since we&#39;re still in the i2n frame. Do that
1553     // manually afterwards.
1554     __ unlock_object(R26_monitor, false); // Can also unlock methods.
1555   }
1556 
1557   // Reset active handles after returning from native.
1558   // thread-&gt;active_handles()-&gt;clear();
1559   __ ld(active_handles, thread_(active_handles));
1560   // TODO PPC port assert(4 == JNIHandleBlock::top_size_in_bytes(), &quot;unexpected field size&quot;);
1561   __ li(R0, 0);
1562   __ stw(R0, JNIHandleBlock::top_offset_in_bytes(), active_handles);
1563 
1564   Label exception_return_sync_check_already_unlocked;
1565   __ ld(R0/*pending_exception*/, thread_(pending_exception));
1566   __ cmpdi(CCR0, R0/*pending_exception*/, 0);
1567   __ bne(CCR0, exception_return_sync_check_already_unlocked);
1568 
1569   //-----------------------------------------------------------------------------
1570   // No exception pending.
1571 
1572   // Move native method result back into proper registers and return.
1573   // Invoke result handler (may unbox/promote).
1574   __ ld(R11_scratch1, 0, R1_SP);
1575   __ ld(R3_RET, _ijava_state_neg(lresult), R11_scratch1);
1576   __ lfd(F1_RET, _ijava_state_neg(fresult), R11_scratch1);
1577   __ call_stub(result_handler_addr);
1578 
1579   __ merge_frames(/*top_frame_sp*/ R21_sender_SP, /*return_pc*/ R0, R11_scratch1, R12_scratch2);
1580 
1581   // Must use the return pc which was loaded from the caller&#39;s frame
1582   // as the VM uses return-pc-patching for deoptimization.
1583   __ mtlr(R0);
1584   __ blr();
1585 
1586   //-----------------------------------------------------------------------------
1587   // An exception is pending. We call into the runtime only if the
1588   // caller was not interpreted. If it was interpreted the
1589   // interpreter will do the correct thing. If it isn&#39;t interpreted
1590   // (call stub/compiled code) we will change our return and continue.
1591 
1592   BIND(exception_return_sync_check);
1593 
1594   if (synchronized) {
1595     // Don&#39;t check for exceptions since we&#39;re still in the i2n frame. Do that
1596     // manually afterwards.
1597     __ unlock_object(R26_monitor, false); // Can also unlock methods.
1598   }
1599   BIND(exception_return_sync_check_already_unlocked);
1600 
1601   const Register return_pc = R31;
1602 
1603   __ ld(return_pc, 0, R1_SP);
1604   __ ld(return_pc, _abi(lr), return_pc);
1605 
1606   // Get the address of the exception handler.
1607   __ call_VM_leaf(CAST_FROM_FN_PTR(address, SharedRuntime::exception_handler_for_return_address),
1608                   R16_thread,
1609                   return_pc /* return pc */);
1610   __ merge_frames(/*top_frame_sp*/ R21_sender_SP, noreg, R11_scratch1, R12_scratch2);
1611 
1612   // Load the PC of the the exception handler into LR.
1613   __ mtlr(R3_RET);
1614 
1615   // Load exception into R3_ARG1 and clear pending exception in thread.
1616   __ ld(R3_ARG1/*exception*/, thread_(pending_exception));
1617   __ li(R4_ARG2, 0);
1618   __ std(R4_ARG2, thread_(pending_exception));
1619 
1620   // Load the original return pc into R4_ARG2.
1621   __ mr(R4_ARG2/*issuing_pc*/, return_pc);
1622 
1623   // Return to exception handler.
1624   __ blr();
1625 
1626   //=============================================================================
1627   // Counter overflow.
1628 
1629   if (inc_counter) {
1630     // Handle invocation counter overflow.
1631     __ bind(invocation_counter_overflow);
1632 
1633     generate_counter_overflow(continue_after_compile);
1634   }
1635 
1636   return entry;
1637 }
1638 
1639 // Generic interpreted method entry to (asm) interpreter.
1640 //
1641 address TemplateInterpreterGenerator::generate_normal_entry(bool synchronized) {
1642   bool inc_counter = UseCompiler || CountCompiledCalls || LogTouchedMethods;
1643   address entry = __ pc();
1644   // Generate the code to allocate the interpreter stack frame.
1645   Register Rsize_of_parameters = R4_ARG2, // Written by generate_fixed_frame.
1646            Rsize_of_locals     = R5_ARG3; // Written by generate_fixed_frame.
1647 
1648   // Does also a stack check to assure this frame fits on the stack.
1649   generate_fixed_frame(false, Rsize_of_parameters, Rsize_of_locals);
1650 
1651   // --------------------------------------------------------------------------
1652   // Zero out non-parameter locals.
1653   // Note: *Always* zero out non-parameter locals as Sparc does. It&#39;s not
1654   // worth to ask the flag, just do it.
1655   Register Rslot_addr = R6_ARG4,
1656            Rnum       = R7_ARG5;
1657   Label Lno_locals, Lzero_loop;
1658 
1659   // Set up the zeroing loop.
1660   __ subf(Rnum, Rsize_of_parameters, Rsize_of_locals);
1661   __ subf(Rslot_addr, Rsize_of_parameters, R18_locals);
1662   __ srdi_(Rnum, Rnum, Interpreter::logStackElementSize);
1663   __ beq(CCR0, Lno_locals);
1664   __ li(R0, 0);
1665   __ mtctr(Rnum);
1666 
1667   // The zero locals loop.
1668   __ bind(Lzero_loop);
1669   __ std(R0, 0, Rslot_addr);
1670   __ addi(Rslot_addr, Rslot_addr, -Interpreter::stackElementSize);
1671   __ bdnz(Lzero_loop);
1672 
1673   __ bind(Lno_locals);
1674 
1675   // --------------------------------------------------------------------------
1676   // Counter increment and overflow check.
1677   Label invocation_counter_overflow,
1678         profile_method,
1679         profile_method_continue;
1680   if (inc_counter || ProfileInterpreter) {
1681 
1682     Register Rdo_not_unlock_if_synchronized_addr = R11_scratch1;
1683     if (synchronized) {
1684       // Since at this point in the method invocation the exception handler
1685       // would try to exit the monitor of synchronized methods which hasn&#39;t
1686       // been entered yet, we set the thread local variable
1687       // _do_not_unlock_if_synchronized to true. If any exception was thrown by
1688       // runtime, exception handling i.e. unlock_if_synchronized_method will
1689       // check this thread local flag.
1690       // This flag has two effects, one is to force an unwind in the topmost
1691       // interpreter frame and not perform an unlock while doing so.
1692       __ li(R0, 1);
1693       __ stb(R0, in_bytes(JavaThread::do_not_unlock_if_synchronized_offset()), R16_thread);
1694     }
1695 
1696     // Argument and return type profiling.
1697     __ profile_parameters_type(R3_ARG1, R4_ARG2, R5_ARG3, R6_ARG4);
1698 
1699     // Increment invocation counter and check for overflow.
1700     if (inc_counter) {
1701       generate_counter_incr(&amp;invocation_counter_overflow, &amp;profile_method, &amp;profile_method_continue);
1702     }
1703 
1704     __ bind(profile_method_continue);
1705   }
1706 
1707   bang_stack_shadow_pages(false);
1708 
1709   if (inc_counter || ProfileInterpreter) {
1710     // Reset the _do_not_unlock_if_synchronized flag.
1711     if (synchronized) {
1712       __ li(R0, 0);
1713       __ stb(R0, in_bytes(JavaThread::do_not_unlock_if_synchronized_offset()), R16_thread);
1714     }
1715   }
1716 
1717   // --------------------------------------------------------------------------
1718   // Locking of synchronized methods. Must happen AFTER invocation_counter
1719   // check and stack overflow check, so method is not locked if overflows.
1720   if (synchronized) {
1721     lock_method(R3_ARG1, R4_ARG2, R5_ARG3);
1722   }
1723 #ifdef ASSERT
1724   else {
1725     Label Lok;
1726     __ lwz(R0, in_bytes(Method::access_flags_offset()), R19_method);
1727     __ andi_(R0, R0, JVM_ACC_SYNCHRONIZED);
1728     __ asm_assert_eq(&quot;method needs synchronization&quot;);
1729     __ bind(Lok);
1730   }
1731 #endif // ASSERT
1732 
1733   __ verify_thread();
1734 
1735   // --------------------------------------------------------------------------
1736   // JVMTI support
1737   __ notify_method_entry();
1738 
1739   // --------------------------------------------------------------------------
1740   // Start executing instructions.
1741   __ dispatch_next(vtos);
1742 
1743   // --------------------------------------------------------------------------
1744   // Out of line counter overflow and MDO creation code.
1745   if (ProfileInterpreter) {
1746     // We have decided to profile this method in the interpreter.
1747     __ bind(profile_method);
1748     __ call_VM(noreg, CAST_FROM_FN_PTR(address, InterpreterRuntime::profile_method));
1749     __ set_method_data_pointer_for_bcp();
1750     __ b(profile_method_continue);
1751   }
1752 
1753   if (inc_counter) {
1754     // Handle invocation counter overflow.
1755     __ bind(invocation_counter_overflow);
1756     generate_counter_overflow(profile_method_continue);
1757   }
1758   return entry;
1759 }
1760 
1761 // CRC32 Intrinsics.
1762 //
1763 // Contract on scratch and work registers.
1764 // =======================================
1765 //
1766 // On ppc, the register set {R2..R12} is available in the interpreter as scratch/work registers.
1767 // You should, however, keep in mind that {R3_ARG1..R10_ARG8} is the C-ABI argument register set.
1768 // You can&#39;t rely on these registers across calls.
1769 //
1770 // The generators for CRC32_update and for CRC32_updateBytes use the
1771 // scratch/work register set internally, passing the work registers
1772 // as arguments to the MacroAssembler emitters as required.
1773 //
1774 // R3_ARG1..R6_ARG4 are preset to hold the incoming java arguments.
1775 // Their contents is not constant but may change according to the requirements
1776 // of the emitted code.
1777 //
1778 // All other registers from the scratch/work register set are used &quot;internally&quot;
1779 // and contain garbage (i.e. unpredictable values) once blr() is reached.
1780 // Basically, only R3_RET contains a defined value which is the function result.
1781 //
1782 /**
1783  * Method entry for static native methods:
1784  *   int java.util.zip.CRC32.update(int crc, int b)
1785  */
1786 address TemplateInterpreterGenerator::generate_CRC32_update_entry() {
1787   if (UseCRC32Intrinsics) {
1788     address start = __ pc();  // Remember stub start address (is rtn value).
1789     Label slow_path;
1790 
1791     // Safepoint check
1792     const Register sync_state = R11_scratch1;
1793     __ safepoint_poll(slow_path, sync_state);
1794 
1795     // We don&#39;t generate local frame and don&#39;t align stack because
1796     // we not even call stub code (we generate the code inline)
1797     // and there is no safepoint on this path.
1798 
1799     // Load java parameters.
1800     // R15_esp is callers operand stack pointer, i.e. it points to the parameters.
1801     const Register argP    = R15_esp;
1802     const Register crc     = R3_ARG1;  // crc value
1803     const Register data    = R4_ARG2;
1804     const Register table   = R5_ARG3;  // address of crc32 table
1805 
1806     BLOCK_COMMENT(&quot;CRC32_update {&quot;);
1807 
1808     // Arguments are reversed on java expression stack
1809 #ifdef VM_LITTLE_ENDIAN
1810     int data_offs = 0+1*wordSize;      // (stack) address of byte value. Emitter expects address, not value.
1811                                        // Being passed as an int, the single byte is at offset +0.
1812 #else
1813     int data_offs = 3+1*wordSize;      // (stack) address of byte value. Emitter expects address, not value.
1814                                        // Being passed from java as an int, the single byte is at offset +3.
1815 #endif
1816     __ lwz(crc, 2*wordSize, argP);     // Current crc state, zero extend to 64 bit to have a clean register.
1817     __ lbz(data, data_offs, argP);     // Byte from buffer, zero-extended.
1818     __ load_const_optimized(table, StubRoutines::crc_table_addr(), R0);
1819     __ kernel_crc32_singleByteReg(crc, data, table, true);
1820 
1821     // Restore caller sp for c2i case (from compiled) and for resized sender frame (from interpreted).
1822     __ resize_frame_absolute(R21_sender_SP, R11_scratch1, R0);
1823     __ blr();
1824 
1825     // Generate a vanilla native entry as the slow path.
1826     BLOCK_COMMENT(&quot;} CRC32_update&quot;);
1827     BIND(slow_path);
1828     __ jump_to_entry(Interpreter::entry_for_kind(Interpreter::native), R11_scratch1);
1829     return start;
1830   }
1831 
1832   return NULL;
1833 }
1834 
1835 /**
1836  * Method entry for static native methods:
1837  *   int java.util.zip.CRC32.updateBytes(     int crc, byte[] b,  int off, int len)
1838  *   int java.util.zip.CRC32.updateByteBuffer(int crc, long* buf, int off, int len)
1839  */
1840 address TemplateInterpreterGenerator::generate_CRC32_updateBytes_entry(AbstractInterpreter::MethodKind kind) {
1841   if (UseCRC32Intrinsics) {
1842     address start = __ pc();  // Remember stub start address (is rtn value).
1843     Label slow_path;
1844 
1845     // Safepoint check
1846     const Register sync_state = R11_scratch1;
1847     __ safepoint_poll(slow_path, sync_state);
1848 
1849     // We don&#39;t generate local frame and don&#39;t align stack because
1850     // we not even call stub code (we generate the code inline)
1851     // and there is no safepoint on this path.
1852 
1853     // Load parameters.
1854     // Z_esp is callers operand stack pointer, i.e. it points to the parameters.
1855     const Register argP    = R15_esp;
1856     const Register crc     = R3_ARG1;  // crc value
1857     const Register data    = R4_ARG2;  // address of java byte array
1858     const Register dataLen = R5_ARG3;  // source data len
1859     const Register tmp     = R11_scratch1;
1860 
1861     // Arguments are reversed on java expression stack.
1862     // Calculate address of start element.
1863     if (kind == Interpreter::java_util_zip_CRC32_updateByteBuffer) { // Used for &quot;updateByteBuffer direct&quot;.
1864       BLOCK_COMMENT(&quot;CRC32_updateByteBuffer {&quot;);
1865       // crc     @ (SP + 5W) (32bit)
1866       // buf     @ (SP + 3W) (64bit ptr to long array)
1867       // off     @ (SP + 2W) (32bit)
1868       // dataLen @ (SP + 1W) (32bit)
1869       // data = buf + off
1870       __ ld(  data,    3*wordSize, argP);  // start of byte buffer
1871       __ lwa( tmp,     2*wordSize, argP);  // byte buffer offset
1872       __ lwa( dataLen, 1*wordSize, argP);  // #bytes to process
1873       __ lwz( crc,     5*wordSize, argP);  // current crc state
1874       __ add( data, data, tmp);            // Add byte buffer offset.
1875     } else {                                                         // Used for &quot;updateBytes update&quot;.
1876       BLOCK_COMMENT(&quot;CRC32_updateBytes {&quot;);
1877       // crc     @ (SP + 4W) (32bit)
1878       // buf     @ (SP + 3W) (64bit ptr to byte array)
1879       // off     @ (SP + 2W) (32bit)
1880       // dataLen @ (SP + 1W) (32bit)
1881       // data = buf + off + base_offset
1882       __ ld(  data,    3*wordSize, argP);  // start of byte buffer
1883       __ lwa( tmp,     2*wordSize, argP);  // byte buffer offset
1884       __ lwa( dataLen, 1*wordSize, argP);  // #bytes to process
1885       __ add( data, data, tmp);            // add byte buffer offset
1886       __ lwz( crc,     4*wordSize, argP);  // current crc state
1887       __ addi(data, data, arrayOopDesc::base_offset_in_bytes(T_BYTE));
1888     }
1889 
1890     __ crc32(crc, data, dataLen, R2, R6, R7, R8, R9, R10, R11, R12, false);
1891 
1892     // Restore caller sp for c2i case (from compiled) and for resized sender frame (from interpreted).
1893     __ resize_frame_absolute(R21_sender_SP, R11_scratch1, R0);
1894     __ blr();
1895 
1896     // Generate a vanilla native entry as the slow path.
1897     BLOCK_COMMENT(&quot;} CRC32_updateBytes(Buffer)&quot;);
1898     BIND(slow_path);
1899     __ jump_to_entry(Interpreter::entry_for_kind(Interpreter::native), R11_scratch1);
1900     return start;
1901   }
1902 
1903   return NULL;
1904 }
1905 
1906 
1907 /**
1908  * Method entry for intrinsic-candidate (non-native) methods:
1909  *   int java.util.zip.CRC32C.updateBytes(           int crc, byte[] b,  int off, int end)
1910  *   int java.util.zip.CRC32C.updateDirectByteBuffer(int crc, long* buf, int off, int end)
1911  * Unlike CRC32, CRC32C does not have any methods marked as native
1912  * CRC32C also uses an &quot;end&quot; variable instead of the length variable CRC32 uses
1913  **/
1914 address TemplateInterpreterGenerator::generate_CRC32C_updateBytes_entry(AbstractInterpreter::MethodKind kind) {
1915   if (UseCRC32CIntrinsics) {
1916     address start = __ pc();  // Remember stub start address (is rtn value).
1917 
1918     // We don&#39;t generate local frame and don&#39;t align stack because
1919     // we not even call stub code (we generate the code inline)
1920     // and there is no safepoint on this path.
1921 
1922     // Load parameters.
1923     // Z_esp is callers operand stack pointer, i.e. it points to the parameters.
1924     const Register argP    = R15_esp;
1925     const Register crc     = R3_ARG1;  // crc value
1926     const Register data    = R4_ARG2;  // address of java byte array
1927     const Register dataLen = R5_ARG3;  // source data len
1928     const Register tmp     = R11_scratch1;
1929 
1930     // Arguments are reversed on java expression stack.
1931     // Calculate address of start element.
1932     if (kind == Interpreter::java_util_zip_CRC32C_updateDirectByteBuffer) { // Used for &quot;updateDirectByteBuffer&quot;.
1933       BLOCK_COMMENT(&quot;CRC32C_updateDirectByteBuffer {&quot;);
1934       // crc     @ (SP + 5W) (32bit)
1935       // buf     @ (SP + 3W) (64bit ptr to long array)
1936       // off     @ (SP + 2W) (32bit)
1937       // dataLen @ (SP + 1W) (32bit)
1938       // data = buf + off
1939       __ ld(  data,    3*wordSize, argP);  // start of byte buffer
1940       __ lwa( tmp,     2*wordSize, argP);  // byte buffer offset
1941       __ lwa( dataLen, 1*wordSize, argP);  // #bytes to process
1942       __ lwz( crc,     5*wordSize, argP);  // current crc state
1943       __ add( data, data, tmp);            // Add byte buffer offset.
1944       __ sub( dataLen, dataLen, tmp);      // (end_index - offset)
1945     } else {                                                         // Used for &quot;updateBytes update&quot;.
1946       BLOCK_COMMENT(&quot;CRC32C_updateBytes {&quot;);
1947       // crc     @ (SP + 4W) (32bit)
1948       // buf     @ (SP + 3W) (64bit ptr to byte array)
1949       // off     @ (SP + 2W) (32bit)
1950       // dataLen @ (SP + 1W) (32bit)
1951       // data = buf + off + base_offset
1952       __ ld(  data,    3*wordSize, argP);  // start of byte buffer
1953       __ lwa( tmp,     2*wordSize, argP);  // byte buffer offset
1954       __ lwa( dataLen, 1*wordSize, argP);  // #bytes to process
1955       __ add( data, data, tmp);            // add byte buffer offset
1956       __ sub( dataLen, dataLen, tmp);      // (end_index - offset)
1957       __ lwz( crc,     4*wordSize, argP);  // current crc state
1958       __ addi(data, data, arrayOopDesc::base_offset_in_bytes(T_BYTE));
1959     }
1960 
1961     __ crc32(crc, data, dataLen, R2, R6, R7, R8, R9, R10, R11, R12, true);
1962 
1963     // Restore caller sp for c2i case (from compiled) and for resized sender frame (from interpreted).
1964     __ resize_frame_absolute(R21_sender_SP, R11_scratch1, R0);
1965     __ blr();
1966 
1967     BLOCK_COMMENT(&quot;} CRC32C_update{Bytes|DirectByteBuffer}&quot;);
1968     return start;
1969   }
1970 
1971   return NULL;
1972 }
1973 
1974 // =============================================================================
1975 // Exceptions
1976 
1977 void TemplateInterpreterGenerator::generate_throw_exception() {
1978   Register Rexception    = R17_tos,
1979            Rcontinuation = R3_RET;
1980 
1981   // --------------------------------------------------------------------------
1982   // Entry point if an method returns with a pending exception (rethrow).
1983   Interpreter::_rethrow_exception_entry = __ pc();
1984   {
1985     __ restore_interpreter_state(R11_scratch1); // Sets R11_scratch1 = fp.
1986     __ ld(R12_scratch2, _ijava_state_neg(top_frame_sp), R11_scratch1);
1987     __ resize_frame_absolute(R12_scratch2, R11_scratch1, R0);
1988 
1989     // Compiled code destroys templateTableBase, reload.
1990     __ load_const_optimized(R25_templateTableBase, (address)Interpreter::dispatch_table((TosState)0), R11_scratch1);
1991   }
1992 
1993   // Entry point if a interpreted method throws an exception (throw).
1994   Interpreter::_throw_exception_entry = __ pc();
1995   {
1996     __ mr(Rexception, R3_RET);
1997 
1998     __ verify_thread();
1999     __ verify_oop(Rexception);
2000 
2001     // Expression stack must be empty before entering the VM in case of an exception.
2002     __ empty_expression_stack();
2003     // Find exception handler address and preserve exception oop.
2004     // Call C routine to find handler and jump to it.
2005     __ call_VM(Rexception, CAST_FROM_FN_PTR(address, InterpreterRuntime::exception_handler_for_exception), Rexception);
2006     __ mtctr(Rcontinuation);
2007     // Push exception for exception handler bytecodes.
2008     __ push_ptr(Rexception);
2009 
2010     // Jump to exception handler (may be remove activation entry!).
2011     __ bctr();
2012   }
2013 
2014   // If the exception is not handled in the current frame the frame is
2015   // removed and the exception is rethrown (i.e. exception
2016   // continuation is _rethrow_exception).
2017   //
2018   // Note: At this point the bci is still the bxi for the instruction
2019   // which caused the exception and the expression stack is
2020   // empty. Thus, for any VM calls at this point, GC will find a legal
2021   // oop map (with empty expression stack).
2022 
2023   // In current activation
2024   // tos: exception
2025   // bcp: exception bcp
2026 
2027   // --------------------------------------------------------------------------
2028   // JVMTI PopFrame support
2029 
2030   Interpreter::_remove_activation_preserving_args_entry = __ pc();
2031   {
2032     // Set the popframe_processing bit in popframe_condition indicating that we are
2033     // currently handling popframe, so that call_VMs that may happen later do not
2034     // trigger new popframe handling cycles.
2035     __ lwz(R11_scratch1, in_bytes(JavaThread::popframe_condition_offset()), R16_thread);
2036     __ ori(R11_scratch1, R11_scratch1, JavaThread::popframe_processing_bit);
2037     __ stw(R11_scratch1, in_bytes(JavaThread::popframe_condition_offset()), R16_thread);
2038 
2039     // Empty the expression stack, as in normal exception handling.
2040     __ empty_expression_stack();
2041     __ unlock_if_synchronized_method(vtos, /* throw_monitor_exception */ false, /* install_monitor_exception */ false);
2042 
2043     // Check to see whether we are returning to a deoptimized frame.
2044     // (The PopFrame call ensures that the caller of the popped frame is
2045     // either interpreted or compiled and deoptimizes it if compiled.)
2046     // Note that we don&#39;t compare the return PC against the
2047     // deoptimization blob&#39;s unpack entry because of the presence of
2048     // adapter frames in C2.
2049     Label Lcaller_not_deoptimized;
2050     Register return_pc = R3_ARG1;
2051     __ ld(return_pc, 0, R1_SP);
2052     __ ld(return_pc, _abi(lr), return_pc);
2053     __ call_VM_leaf(CAST_FROM_FN_PTR(address, InterpreterRuntime::interpreter_contains), return_pc);
2054     __ cmpdi(CCR0, R3_RET, 0);
2055     __ bne(CCR0, Lcaller_not_deoptimized);
2056 
2057     // The deoptimized case.
2058     // In this case, we can&#39;t call dispatch_next() after the frame is
2059     // popped, but instead must save the incoming arguments and restore
2060     // them after deoptimization has occurred.
2061     __ ld(R4_ARG2, in_bytes(Method::const_offset()), R19_method);
2062     __ lhz(R4_ARG2 /* number of params */, in_bytes(ConstMethod::size_of_parameters_offset()), R4_ARG2);
2063     __ slwi(R4_ARG2, R4_ARG2, Interpreter::logStackElementSize);
2064     __ addi(R5_ARG3, R18_locals, Interpreter::stackElementSize);
2065     __ subf(R5_ARG3, R4_ARG2, R5_ARG3);
2066     // Save these arguments.
2067     __ call_VM_leaf(CAST_FROM_FN_PTR(address, Deoptimization::popframe_preserve_args), R16_thread, R4_ARG2, R5_ARG3);
2068 
2069     // Inform deoptimization that it is responsible for restoring these arguments.
2070     __ load_const_optimized(R11_scratch1, JavaThread::popframe_force_deopt_reexecution_bit);
2071     __ stw(R11_scratch1, in_bytes(JavaThread::popframe_condition_offset()), R16_thread);
2072 
2073     // Return from the current method into the deoptimization blob. Will eventually
2074     // end up in the deopt interpeter entry, deoptimization prepared everything that
2075     // we will reexecute the call that called us.
2076     __ merge_frames(/*top_frame_sp*/ R21_sender_SP, /*reload return_pc*/ return_pc, R11_scratch1, R12_scratch2);
2077     __ mtlr(return_pc);
2078     __ blr();
2079 
2080     // The non-deoptimized case.
2081     __ bind(Lcaller_not_deoptimized);
2082 
2083     // Clear the popframe condition flag.
2084     __ li(R0, 0);
2085     __ stw(R0, in_bytes(JavaThread::popframe_condition_offset()), R16_thread);
2086 
2087     // Get out of the current method and re-execute the call that called us.
2088     __ merge_frames(/*top_frame_sp*/ R21_sender_SP, /*return_pc*/ noreg, R11_scratch1, R12_scratch2);
2089     __ restore_interpreter_state(R11_scratch1);
2090     __ ld(R12_scratch2, _ijava_state_neg(top_frame_sp), R11_scratch1);
2091     __ resize_frame_absolute(R12_scratch2, R11_scratch1, R0);
2092     if (ProfileInterpreter) {
2093       __ set_method_data_pointer_for_bcp();
2094       __ ld(R11_scratch1, 0, R1_SP);
2095       __ std(R28_mdx, _ijava_state_neg(mdx), R11_scratch1);
2096     }
2097 #if INCLUDE_JVMTI
2098     Label L_done;
2099 
2100     __ lbz(R11_scratch1, 0, R14_bcp);
2101     __ cmpwi(CCR0, R11_scratch1, Bytecodes::_invokestatic);
2102     __ bne(CCR0, L_done);
2103 
2104     // The member name argument must be restored if _invokestatic is re-executed after a PopFrame call.
2105     // Detect such a case in the InterpreterRuntime function and return the member name argument, or NULL.
2106     __ ld(R4_ARG2, 0, R18_locals);
2107     __ call_VM(R4_ARG2, CAST_FROM_FN_PTR(address, InterpreterRuntime::member_name_arg_or_null), R4_ARG2, R19_method, R14_bcp);
2108     __ restore_interpreter_state(R11_scratch1, /*bcp_and_mdx_only*/ true);
2109     __ cmpdi(CCR0, R4_ARG2, 0);
2110     __ beq(CCR0, L_done);
2111     __ std(R4_ARG2, wordSize, R15_esp);
2112     __ bind(L_done);
2113 #endif // INCLUDE_JVMTI
2114     __ dispatch_next(vtos);
2115   }
2116   // end of JVMTI PopFrame support
2117 
2118   // --------------------------------------------------------------------------
2119   // Remove activation exception entry.
2120   // This is jumped to if an interpreted method can&#39;t handle an exception itself
2121   // (we come from the throw/rethrow exception entry above). We&#39;re going to call
2122   // into the VM to find the exception handler in the caller, pop the current
2123   // frame and return the handler we calculated.
2124   Interpreter::_remove_activation_entry = __ pc();
2125   {
2126     __ pop_ptr(Rexception);
2127     __ verify_thread();
2128     __ verify_oop(Rexception);
2129     __ std(Rexception, in_bytes(JavaThread::vm_result_offset()), R16_thread);
2130 
2131     __ unlock_if_synchronized_method(vtos, /* throw_monitor_exception */ false, true);
2132     __ notify_method_exit(false, vtos, InterpreterMacroAssembler::SkipNotifyJVMTI, false);
2133 
2134     __ get_vm_result(Rexception);
2135 
2136     // We are done with this activation frame; find out where to go next.
2137     // The continuation point will be an exception handler, which expects
2138     // the following registers set up:
2139     //
2140     // RET:  exception oop
2141     // ARG2: Issuing PC (see generate_exception_blob()), only used if the caller is compiled.
2142 
2143     Register return_pc = R31; // Needs to survive the runtime call.
2144     __ ld(return_pc, 0, R1_SP);
2145     __ ld(return_pc, _abi(lr), return_pc);
2146     __ call_VM_leaf(CAST_FROM_FN_PTR(address, SharedRuntime::exception_handler_for_return_address), R16_thread, return_pc);
2147 
2148     // Remove the current activation.
2149     __ merge_frames(/*top_frame_sp*/ R21_sender_SP, /*return_pc*/ noreg, R11_scratch1, R12_scratch2);
2150 
2151     __ mr(R4_ARG2, return_pc);
2152     __ mtlr(R3_RET);
2153     __ mr(R3_RET, Rexception);
2154     __ blr();
2155   }
2156 }
2157 
2158 // JVMTI ForceEarlyReturn support.
2159 // Returns &quot;in the middle&quot; of a method with a &quot;fake&quot; return value.
2160 address TemplateInterpreterGenerator::generate_earlyret_entry_for(TosState state) {
2161 
2162   Register Rscratch1 = R11_scratch1,
2163            Rscratch2 = R12_scratch2;
2164 
2165   address entry = __ pc();
2166   __ empty_expression_stack();
2167 
2168   __ load_earlyret_value(state, Rscratch1);
2169 
2170   __ ld(Rscratch1, in_bytes(JavaThread::jvmti_thread_state_offset()), R16_thread);
2171   // Clear the earlyret state.
2172   __ li(R0, 0);
2173   __ stw(R0, in_bytes(JvmtiThreadState::earlyret_state_offset()), Rscratch1);
2174 
2175   __ remove_activation(state, false, false);
2176   // Copied from TemplateTable::_return.
2177   // Restoration of lr done by remove_activation.
2178   switch (state) {
2179     // Narrow result if state is itos but result type is smaller.
2180     case btos:
2181     case ztos:
2182     case ctos:
2183     case stos:
2184     case itos: __ narrow(R17_tos); /* fall through */
2185     case ltos:
2186     case atos: __ mr(R3_RET, R17_tos); break;
2187     case ftos:
2188     case dtos: __ fmr(F1_RET, F15_ftos); break;
2189     case vtos: // This might be a constructor. Final fields (and volatile fields on PPC64) need
2190                // to get visible before the reference to the object gets stored anywhere.
2191                __ membar(Assembler::StoreStore); break;
2192     default  : ShouldNotReachHere();
2193   }
2194   __ blr();
2195 
2196   return entry;
2197 } // end of ForceEarlyReturn support
2198 
2199 //-----------------------------------------------------------------------------
2200 // Helper for vtos entry point generation
2201 
2202 void TemplateInterpreterGenerator::set_vtos_entry_points(Template* t,
2203                                                          address&amp; bep,
2204                                                          address&amp; cep,
2205                                                          address&amp; sep,
2206                                                          address&amp; aep,
2207                                                          address&amp; iep,
2208                                                          address&amp; lep,
2209                                                          address&amp; fep,
2210                                                          address&amp; dep,
2211                                                          address&amp; vep) {
2212   assert(t-&gt;is_valid() &amp;&amp; t-&gt;tos_in() == vtos, &quot;illegal template&quot;);
2213   Label L;
2214 
2215   aep = __ pc();  __ push_ptr();  __ b(L);
2216   fep = __ pc();  __ push_f();    __ b(L);
2217   dep = __ pc();  __ push_d();    __ b(L);
2218   lep = __ pc();  __ push_l();    __ b(L);
2219   __ align(32, 12, 24); // align L
2220   bep = cep = sep =
2221   iep = __ pc();  __ push_i();
2222   vep = __ pc();
2223   __ bind(L);
2224   generate_and_dispatch(t);
2225 }
2226 
2227 //-----------------------------------------------------------------------------
2228 
2229 // Non-product code
2230 #ifndef PRODUCT
2231 address TemplateInterpreterGenerator::generate_trace_code(TosState state) {
2232   //__ flush_bundle();
2233   address entry = __ pc();
2234 
2235   const char *bname = NULL;
2236   uint tsize = 0;
2237   switch(state) {
2238   case ftos:
2239     bname = &quot;trace_code_ftos {&quot;;
2240     tsize = 2;
2241     break;
2242   case btos:
2243     bname = &quot;trace_code_btos {&quot;;
2244     tsize = 2;
2245     break;
2246   case ztos:
2247     bname = &quot;trace_code_ztos {&quot;;
2248     tsize = 2;
2249     break;
2250   case ctos:
2251     bname = &quot;trace_code_ctos {&quot;;
2252     tsize = 2;
2253     break;
2254   case stos:
2255     bname = &quot;trace_code_stos {&quot;;
2256     tsize = 2;
2257     break;
2258   case itos:
2259     bname = &quot;trace_code_itos {&quot;;
2260     tsize = 2;
2261     break;
2262   case ltos:
2263     bname = &quot;trace_code_ltos {&quot;;
2264     tsize = 3;
2265     break;
2266   case atos:
2267     bname = &quot;trace_code_atos {&quot;;
2268     tsize = 2;
2269     break;
2270   case vtos:
2271     // Note: In case of vtos, the topmost of stack value could be a int or doubl
2272     // In case of a double (2 slots) we won&#39;t see the 2nd stack value.
2273     // Maybe we simply should print the topmost 3 stack slots to cope with the problem.
2274     bname = &quot;trace_code_vtos {&quot;;
2275     tsize = 2;
2276 
2277     break;
2278   case dtos:
2279     bname = &quot;trace_code_dtos {&quot;;
2280     tsize = 3;
2281     break;
2282   default:
2283     ShouldNotReachHere();
2284   }
2285   BLOCK_COMMENT(bname);
2286 
2287   // Support short-cut for TraceBytecodesAt.
2288   // Don&#39;t call into the VM if we don&#39;t want to trace to speed up things.
2289   Label Lskip_vm_call;
2290   if (TraceBytecodesAt &gt; 0 &amp;&amp; TraceBytecodesAt &lt; max_intx) {
2291     int offs1 = __ load_const_optimized(R11_scratch1, (address) &amp;TraceBytecodesAt, R0, true);
2292     int offs2 = __ load_const_optimized(R12_scratch2, (address) &amp;BytecodeCounter::_counter_value, R0, true);
2293     __ ld(R11_scratch1, offs1, R11_scratch1);
2294     __ lwa(R12_scratch2, offs2, R12_scratch2);
2295     __ cmpd(CCR0, R12_scratch2, R11_scratch1);
2296     __ blt(CCR0, Lskip_vm_call);
2297   }
2298 
2299   __ push(state);
2300   // Load 2 topmost expression stack values.
2301   __ ld(R6_ARG4, tsize*Interpreter::stackElementSize, R15_esp);
2302   __ ld(R5_ARG3, Interpreter::stackElementSize, R15_esp);
2303   __ mflr(R31);
2304   __ call_VM(noreg, CAST_FROM_FN_PTR(address, InterpreterRuntime::trace_bytecode), /* unused */ R4_ARG2, R5_ARG3, R6_ARG4, false);
2305   __ mtlr(R31);
2306   __ pop(state);
2307 
2308   if (TraceBytecodesAt &gt; 0 &amp;&amp; TraceBytecodesAt &lt; max_intx) {
2309     __ bind(Lskip_vm_call);
2310   }
2311   __ blr();
2312   BLOCK_COMMENT(&quot;} trace_code&quot;);
2313   return entry;
2314 }
2315 
2316 void TemplateInterpreterGenerator::count_bytecode() {
2317   int offs = __ load_const_optimized(R11_scratch1, (address) &amp;BytecodeCounter::_counter_value, R12_scratch2, true);
2318   __ lwz(R12_scratch2, offs, R11_scratch1);
2319   __ addi(R12_scratch2, R12_scratch2, 1);
2320   __ stw(R12_scratch2, offs, R11_scratch1);
2321 }
2322 
2323 void TemplateInterpreterGenerator::histogram_bytecode(Template* t) {
2324   int offs = __ load_const_optimized(R11_scratch1, (address) &amp;BytecodeHistogram::_counters[t-&gt;bytecode()], R12_scratch2, true);
2325   __ lwz(R12_scratch2, offs, R11_scratch1);
2326   __ addi(R12_scratch2, R12_scratch2, 1);
2327   __ stw(R12_scratch2, offs, R11_scratch1);
2328 }
2329 
2330 void TemplateInterpreterGenerator::histogram_bytecode_pair(Template* t) {
2331   const Register addr = R11_scratch1,
2332                  tmp  = R12_scratch2;
2333   // Get index, shift out old bytecode, bring in new bytecode, and store it.
2334   // _index = (_index &gt;&gt; log2_number_of_codes) |
2335   //          (bytecode &lt;&lt; log2_number_of_codes);
2336   int offs1 = __ load_const_optimized(addr, (address)&amp;BytecodePairHistogram::_index, tmp, true);
2337   __ lwz(tmp, offs1, addr);
2338   __ srwi(tmp, tmp, BytecodePairHistogram::log2_number_of_codes);
2339   __ ori(tmp, tmp, ((int) t-&gt;bytecode()) &lt;&lt; BytecodePairHistogram::log2_number_of_codes);
2340   __ stw(tmp, offs1, addr);
2341 
2342   // Bump bucket contents.
2343   // _counters[_index] ++;
2344   int offs2 = __ load_const_optimized(addr, (address)&amp;BytecodePairHistogram::_counters, R0, true);
2345   __ sldi(tmp, tmp, LogBytesPerInt);
2346   __ add(addr, tmp, addr);
2347   __ lwz(tmp, offs2, addr);
2348   __ addi(tmp, tmp, 1);
2349   __ stw(tmp, offs2, addr);
2350 }
2351 
2352 void TemplateInterpreterGenerator::trace_bytecode(Template* t) {
2353   // Call a little run-time stub to avoid blow-up for each bytecode.
2354   // The run-time runtime saves the right registers, depending on
2355   // the tosca in-state for the given template.
2356 
2357   assert(Interpreter::trace_code(t-&gt;tos_in()) != NULL,
2358          &quot;entry must have been generated&quot;);
2359 
2360   // Note: we destroy LR here.
2361   __ bl(Interpreter::trace_code(t-&gt;tos_in()));
2362 }
2363 
2364 void TemplateInterpreterGenerator::stop_interpreter_at() {
2365   Label L;
2366   int offs1 = __ load_const_optimized(R11_scratch1, (address) &amp;StopInterpreterAt, R0, true);
2367   int offs2 = __ load_const_optimized(R12_scratch2, (address) &amp;BytecodeCounter::_counter_value, R0, true);
2368   __ ld(R11_scratch1, offs1, R11_scratch1);
2369   __ lwa(R12_scratch2, offs2, R12_scratch2);
2370   __ cmpd(CCR0, R12_scratch2, R11_scratch1);
2371   __ bne(CCR0, L);
2372   __ illtrap();
2373   __ bind(L);
2374 }
2375 
2376 #endif // !PRODUCT
<a name="3" id="anc3"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="3" type="hidden" />
</body>
</html>