<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames src/hotspot/cpu/ppc/templateInterpreterGenerator_ppc.cpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
    <script type="text/javascript" src="../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>   1 /*
<a name="1" id="anc1"></a><span class="line-modified">   2  * Copyright (c) 2014, 2019, Oracle and/or its affiliates. All rights reserved.</span>
   3  * Copyright (c) 2015, 2019, SAP SE. All rights reserved.
   4  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   5  *
   6  * This code is free software; you can redistribute it and/or modify it
   7  * under the terms of the GNU General Public License version 2 only, as
   8  * published by the Free Software Foundation.
   9  *
  10  * This code is distributed in the hope that it will be useful, but WITHOUT
  11  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  12  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  13  * version 2 for more details (a copy is included in the LICENSE file that
  14  * accompanied this code).
  15  *
  16  * You should have received a copy of the GNU General Public License version
  17  * 2 along with this work; if not, write to the Free Software Foundation,
  18  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  19  *
  20  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  21  * or visit www.oracle.com if you need additional information or have any
  22  * questions.
  23  *
  24  */
  25 
  26 #include &quot;precompiled.hpp&quot;
  27 #include &quot;asm/macroAssembler.inline.hpp&quot;
  28 #include &quot;gc/shared/barrierSetAssembler.hpp&quot;
  29 #include &quot;interpreter/bytecodeHistogram.hpp&quot;
  30 #include &quot;interpreter/interpreter.hpp&quot;
  31 #include &quot;interpreter/interpreterRuntime.hpp&quot;
  32 #include &quot;interpreter/interp_masm.hpp&quot;
  33 #include &quot;interpreter/templateInterpreterGenerator.hpp&quot;
  34 #include &quot;interpreter/templateTable.hpp&quot;
  35 #include &quot;oops/arrayOop.hpp&quot;
  36 #include &quot;oops/methodData.hpp&quot;
  37 #include &quot;oops/method.hpp&quot;
  38 #include &quot;oops/oop.inline.hpp&quot;
  39 #include &quot;prims/jvmtiExport.hpp&quot;
  40 #include &quot;prims/jvmtiThreadState.hpp&quot;
  41 #include &quot;runtime/arguments.hpp&quot;
  42 #include &quot;runtime/deoptimization.hpp&quot;
  43 #include &quot;runtime/frame.inline.hpp&quot;
  44 #include &quot;runtime/sharedRuntime.hpp&quot;
  45 #include &quot;runtime/stubRoutines.hpp&quot;
  46 #include &quot;runtime/synchronizer.hpp&quot;
  47 #include &quot;runtime/timer.hpp&quot;
  48 #include &quot;runtime/vframeArray.hpp&quot;
  49 #include &quot;utilities/debug.hpp&quot;
  50 #include &quot;utilities/macros.hpp&quot;
  51 
  52 #undef __
  53 #define __ _masm-&gt;
  54 
  55 // Size of interpreter code.  Increase if too small.  Interpreter will
  56 // fail with a guarantee (&quot;not enough space for interpreter generation&quot;);
  57 // if too small.
  58 // Run with +PrintInterpreter to get the VM to print out the size.
  59 // Max size with JVMTI
  60 int TemplateInterpreter::InterpreterCodeSize = 256*K;
  61 
  62 #ifdef PRODUCT
  63 #define BLOCK_COMMENT(str) /* nothing */
  64 #else
  65 #define BLOCK_COMMENT(str) __ block_comment(str)
  66 #endif
  67 
  68 #define BIND(label)        __ bind(label); BLOCK_COMMENT(#label &quot;:&quot;)
  69 
  70 //-----------------------------------------------------------------------------
  71 
  72 address TemplateInterpreterGenerator::generate_slow_signature_handler() {
  73   // Slow_signature handler that respects the PPC C calling conventions.
  74   //
  75   // We get called by the native entry code with our output register
  76   // area == 8. First we call InterpreterRuntime::get_result_handler
  77   // to copy the pointer to the signature string temporarily to the
  78   // first C-argument and to return the result_handler in
  79   // R3_RET. Since native_entry will copy the jni-pointer to the
  80   // first C-argument slot later on, it is OK to occupy this slot
  81   // temporarilly. Then we copy the argument list on the java
  82   // expression stack into native varargs format on the native stack
  83   // and load arguments into argument registers. Integer arguments in
  84   // the varargs vector will be sign-extended to 8 bytes.
  85   //
  86   // On entry:
  87   //   R3_ARG1        - intptr_t*     Address of java argument list in memory.
  88   //   R15_prev_state - BytecodeInterpreter* Address of interpreter state for
  89   //     this method
  90   //   R19_method
  91   //
  92   // On exit (just before return instruction):
  93   //   R3_RET            - contains the address of the result_handler.
  94   //   R4_ARG2           - is not updated for static methods and contains &quot;this&quot; otherwise.
  95   //   R5_ARG3-R10_ARG8: - When the (i-2)th Java argument is not of type float or double,
  96   //                       ARGi contains this argument. Otherwise, ARGi is not updated.
  97   //   F1_ARG1-F13_ARG13 - contain the first 13 arguments of type float or double.
  98 
  99   const int LogSizeOfTwoInstructions = 3;
 100 
 101   // FIXME: use Argument:: GL: Argument names different numbers!
 102   const int max_fp_register_arguments  = 13;
 103   const int max_int_register_arguments = 6;  // first 2 are reserved
 104 
 105   const Register arg_java       = R21_tmp1;
 106   const Register arg_c          = R22_tmp2;
 107   const Register signature      = R23_tmp3;  // is string
 108   const Register sig_byte       = R24_tmp4;
 109   const Register fpcnt          = R25_tmp5;
 110   const Register argcnt         = R26_tmp6;
 111   const Register intSlot        = R27_tmp7;
 112   const Register target_sp      = R28_tmp8;
 113   const FloatRegister floatSlot = F0;
 114 
 115   address entry = __ function_entry();
 116 
 117   __ save_LR_CR(R0);
 118   __ save_nonvolatile_gprs(R1_SP, _spill_nonvolatiles_neg(r14));
 119   // We use target_sp for storing arguments in the C frame.
 120   __ mr(target_sp, R1_SP);
 121   __ push_frame_reg_args_nonvolatiles(0, R11_scratch1);
 122 
 123   __ mr(arg_java, R3_ARG1);
 124 
 125   __ call_VM_leaf(CAST_FROM_FN_PTR(address, InterpreterRuntime::get_signature), R16_thread, R19_method);
 126 
 127   // Signature is in R3_RET. Signature is callee saved.
 128   __ mr(signature, R3_RET);
 129 
 130   // Get the result handler.
 131   __ call_VM_leaf(CAST_FROM_FN_PTR(address, InterpreterRuntime::get_result_handler), R16_thread, R19_method);
 132 
 133   {
 134     Label L;
 135     // test if static
 136     // _access_flags._flags must be at offset 0.
 137     // TODO PPC port: requires change in shared code.
 138     //assert(in_bytes(AccessFlags::flags_offset()) == 0,
 139     //       &quot;MethodDesc._access_flags == MethodDesc._access_flags._flags&quot;);
 140     // _access_flags must be a 32 bit value.
 141     assert(sizeof(AccessFlags) == 4, &quot;wrong size&quot;);
 142     __ lwa(R11_scratch1/*access_flags*/, method_(access_flags));
 143     // testbit with condition register.
 144     __ testbitdi(CCR0, R0, R11_scratch1/*access_flags*/, JVM_ACC_STATIC_BIT);
 145     __ btrue(CCR0, L);
 146     // For non-static functions, pass &quot;this&quot; in R4_ARG2 and copy it
 147     // to 2nd C-arg slot.
 148     // We need to box the Java object here, so we use arg_java
 149     // (address of current Java stack slot) as argument and don&#39;t
 150     // dereference it as in case of ints, floats, etc.
 151     __ mr(R4_ARG2, arg_java);
 152     __ addi(arg_java, arg_java, -BytesPerWord);
 153     __ std(R4_ARG2, _abi(carg_2), target_sp);
 154     __ bind(L);
 155   }
 156 
 157   // Will be incremented directly after loop_start. argcnt=0
 158   // corresponds to 3rd C argument.
 159   __ li(argcnt, -1);
 160   // arg_c points to 3rd C argument
 161   __ addi(arg_c, target_sp, _abi(carg_3));
 162   // no floating-point args parsed so far
 163   __ li(fpcnt, 0);
 164 
 165   Label move_intSlot_to_ARG, move_floatSlot_to_FARG;
 166   Label loop_start, loop_end;
 167   Label do_int, do_long, do_float, do_double, do_dontreachhere, do_object, do_array, do_boxed;
 168 
 169   // signature points to &#39;(&#39; at entry
 170 #ifdef ASSERT
 171   __ lbz(sig_byte, 0, signature);
 172   __ cmplwi(CCR0, sig_byte, &#39;(&#39;);
 173   __ bne(CCR0, do_dontreachhere);
 174 #endif
 175 
 176   __ bind(loop_start);
 177 
 178   __ addi(argcnt, argcnt, 1);
 179   __ lbzu(sig_byte, 1, signature);
 180 
 181   __ cmplwi(CCR0, sig_byte, &#39;)&#39;); // end of signature
 182   __ beq(CCR0, loop_end);
 183 
 184   __ cmplwi(CCR0, sig_byte, &#39;B&#39;); // byte
 185   __ beq(CCR0, do_int);
 186 
 187   __ cmplwi(CCR0, sig_byte, &#39;C&#39;); // char
 188   __ beq(CCR0, do_int);
 189 
 190   __ cmplwi(CCR0, sig_byte, &#39;D&#39;); // double
 191   __ beq(CCR0, do_double);
 192 
 193   __ cmplwi(CCR0, sig_byte, &#39;F&#39;); // float
 194   __ beq(CCR0, do_float);
 195 
 196   __ cmplwi(CCR0, sig_byte, &#39;I&#39;); // int
 197   __ beq(CCR0, do_int);
 198 
 199   __ cmplwi(CCR0, sig_byte, &#39;J&#39;); // long
 200   __ beq(CCR0, do_long);
 201 
 202   __ cmplwi(CCR0, sig_byte, &#39;S&#39;); // short
 203   __ beq(CCR0, do_int);
 204 
 205   __ cmplwi(CCR0, sig_byte, &#39;Z&#39;); // boolean
 206   __ beq(CCR0, do_int);
 207 
 208   __ cmplwi(CCR0, sig_byte, &#39;L&#39;); // object
 209   __ beq(CCR0, do_object);
 210 
 211   __ cmplwi(CCR0, sig_byte, &#39;[&#39;); // array
 212   __ beq(CCR0, do_array);
 213 
 214   //  __ cmplwi(CCR0, sig_byte, &#39;V&#39;); // void cannot appear since we do not parse the return type
 215   //  __ beq(CCR0, do_void);
 216 
 217   __ bind(do_dontreachhere);
 218 
 219   __ unimplemented(&quot;ShouldNotReachHere in slow_signature_handler&quot;);
 220 
 221   __ bind(do_array);
 222 
 223   {
 224     Label start_skip, end_skip;
 225 
 226     __ bind(start_skip);
 227     __ lbzu(sig_byte, 1, signature);
 228     __ cmplwi(CCR0, sig_byte, &#39;[&#39;);
 229     __ beq(CCR0, start_skip); // skip further brackets
 230     __ cmplwi(CCR0, sig_byte, &#39;9&#39;);
 231     __ bgt(CCR0, end_skip);   // no optional size
 232     __ cmplwi(CCR0, sig_byte, &#39;0&#39;);
 233     __ bge(CCR0, start_skip); // skip optional size
 234     __ bind(end_skip);
 235 
 236     __ cmplwi(CCR0, sig_byte, &#39;L&#39;);
 237     __ beq(CCR0, do_object);  // for arrays of objects, the name of the object must be skipped
 238     __ b(do_boxed);          // otherwise, go directly to do_boxed
 239   }
 240 
 241   __ bind(do_object);
 242   {
 243     Label L;
 244     __ bind(L);
 245     __ lbzu(sig_byte, 1, signature);
 246     __ cmplwi(CCR0, sig_byte, &#39;;&#39;);
 247     __ bne(CCR0, L);
 248    }
 249   // Need to box the Java object here, so we use arg_java (address of
 250   // current Java stack slot) as argument and don&#39;t dereference it as
 251   // in case of ints, floats, etc.
 252   Label do_null;
 253   __ bind(do_boxed);
 254   __ ld(R0,0, arg_java);
 255   __ cmpdi(CCR0, R0, 0);
 256   __ li(intSlot,0);
 257   __ beq(CCR0, do_null);
 258   __ mr(intSlot, arg_java);
 259   __ bind(do_null);
 260   __ std(intSlot, 0, arg_c);
 261   __ addi(arg_java, arg_java, -BytesPerWord);
 262   __ addi(arg_c, arg_c, BytesPerWord);
 263   __ cmplwi(CCR0, argcnt, max_int_register_arguments);
 264   __ blt(CCR0, move_intSlot_to_ARG);
 265   __ b(loop_start);
 266 
 267   __ bind(do_int);
 268   __ lwa(intSlot, 0, arg_java);
 269   __ std(intSlot, 0, arg_c);
 270   __ addi(arg_java, arg_java, -BytesPerWord);
 271   __ addi(arg_c, arg_c, BytesPerWord);
 272   __ cmplwi(CCR0, argcnt, max_int_register_arguments);
 273   __ blt(CCR0, move_intSlot_to_ARG);
 274   __ b(loop_start);
 275 
 276   __ bind(do_long);
 277   __ ld(intSlot, -BytesPerWord, arg_java);
 278   __ std(intSlot, 0, arg_c);
 279   __ addi(arg_java, arg_java, - 2 * BytesPerWord);
 280   __ addi(arg_c, arg_c, BytesPerWord);
 281   __ cmplwi(CCR0, argcnt, max_int_register_arguments);
 282   __ blt(CCR0, move_intSlot_to_ARG);
 283   __ b(loop_start);
 284 
 285   __ bind(do_float);
 286   __ lfs(floatSlot, 0, arg_java);
 287 #if defined(LINUX)
 288   // Linux uses ELF ABI. Both original ELF and ELFv2 ABIs have float
 289   // in the least significant word of an argument slot.
 290 #if defined(VM_LITTLE_ENDIAN)
 291   __ stfs(floatSlot, 0, arg_c);
 292 #else
 293   __ stfs(floatSlot, 4, arg_c);
 294 #endif
 295 #elif defined(AIX)
 296   // Although AIX runs on big endian CPU, float is in most significant
 297   // word of an argument slot.
 298   __ stfs(floatSlot, 0, arg_c);
 299 #else
 300 #error &quot;unknown OS&quot;
 301 #endif
 302   __ addi(arg_java, arg_java, -BytesPerWord);
 303   __ addi(arg_c, arg_c, BytesPerWord);
 304   __ cmplwi(CCR0, fpcnt, max_fp_register_arguments);
 305   __ blt(CCR0, move_floatSlot_to_FARG);
 306   __ b(loop_start);
 307 
 308   __ bind(do_double);
 309   __ lfd(floatSlot, - BytesPerWord, arg_java);
 310   __ stfd(floatSlot, 0, arg_c);
 311   __ addi(arg_java, arg_java, - 2 * BytesPerWord);
 312   __ addi(arg_c, arg_c, BytesPerWord);
 313   __ cmplwi(CCR0, fpcnt, max_fp_register_arguments);
 314   __ blt(CCR0, move_floatSlot_to_FARG);
 315   __ b(loop_start);
 316 
 317   __ bind(loop_end);
 318 
 319   __ pop_frame();
 320   __ restore_nonvolatile_gprs(R1_SP, _spill_nonvolatiles_neg(r14));
 321   __ restore_LR_CR(R0);
 322 
 323   __ blr();
 324 
 325   Label move_int_arg, move_float_arg;
 326   __ bind(move_int_arg); // each case must consist of 2 instructions (otherwise adapt LogSizeOfTwoInstructions)
 327   __ mr(R5_ARG3, intSlot);  __ b(loop_start);
 328   __ mr(R6_ARG4, intSlot);  __ b(loop_start);
 329   __ mr(R7_ARG5, intSlot);  __ b(loop_start);
 330   __ mr(R8_ARG6, intSlot);  __ b(loop_start);
 331   __ mr(R9_ARG7, intSlot);  __ b(loop_start);
 332   __ mr(R10_ARG8, intSlot); __ b(loop_start);
 333 
 334   __ bind(move_float_arg); // each case must consist of 2 instructions (otherwise adapt LogSizeOfTwoInstructions)
 335   __ fmr(F1_ARG1, floatSlot);   __ b(loop_start);
 336   __ fmr(F2_ARG2, floatSlot);   __ b(loop_start);
 337   __ fmr(F3_ARG3, floatSlot);   __ b(loop_start);
 338   __ fmr(F4_ARG4, floatSlot);   __ b(loop_start);
 339   __ fmr(F5_ARG5, floatSlot);   __ b(loop_start);
 340   __ fmr(F6_ARG6, floatSlot);   __ b(loop_start);
 341   __ fmr(F7_ARG7, floatSlot);   __ b(loop_start);
 342   __ fmr(F8_ARG8, floatSlot);   __ b(loop_start);
 343   __ fmr(F9_ARG9, floatSlot);   __ b(loop_start);
 344   __ fmr(F10_ARG10, floatSlot); __ b(loop_start);
 345   __ fmr(F11_ARG11, floatSlot); __ b(loop_start);
 346   __ fmr(F12_ARG12, floatSlot); __ b(loop_start);
 347   __ fmr(F13_ARG13, floatSlot); __ b(loop_start);
 348 
 349   __ bind(move_intSlot_to_ARG);
 350   __ sldi(R0, argcnt, LogSizeOfTwoInstructions);
 351   __ load_const(R11_scratch1, move_int_arg); // Label must be bound here.
 352   __ add(R11_scratch1, R0, R11_scratch1);
 353   __ mtctr(R11_scratch1/*branch_target*/);
 354   __ bctr();
 355   __ bind(move_floatSlot_to_FARG);
 356   __ sldi(R0, fpcnt, LogSizeOfTwoInstructions);
 357   __ addi(fpcnt, fpcnt, 1);
 358   __ load_const(R11_scratch1, move_float_arg); // Label must be bound here.
 359   __ add(R11_scratch1, R0, R11_scratch1);
 360   __ mtctr(R11_scratch1/*branch_target*/);
 361   __ bctr();
 362 
 363   return entry;
 364 }
 365 
 366 address TemplateInterpreterGenerator::generate_result_handler_for(BasicType type) {
 367   //
 368   // Registers alive
 369   //   R3_RET
 370   //   LR
 371   //
 372   // Registers updated
 373   //   R3_RET
 374   //
 375 
 376   Label done;
 377   address entry = __ pc();
 378 
 379   switch (type) {
 380   case T_BOOLEAN:
 381     // convert !=0 to 1
 382     __ neg(R0, R3_RET);
 383     __ orr(R0, R3_RET, R0);
 384     __ srwi(R3_RET, R0, 31);
 385     break;
 386   case T_BYTE:
 387      // sign extend 8 bits
 388      __ extsb(R3_RET, R3_RET);
 389      break;
 390   case T_CHAR:
 391      // zero extend 16 bits
 392      __ clrldi(R3_RET, R3_RET, 48);
 393      break;
 394   case T_SHORT:
 395      // sign extend 16 bits
 396      __ extsh(R3_RET, R3_RET);
 397      break;
 398   case T_INT:
 399      // sign extend 32 bits
 400      __ extsw(R3_RET, R3_RET);
 401      break;
 402   case T_LONG:
 403      break;
 404   case T_OBJECT:
 405     // JNIHandles::resolve result.
 406     __ resolve_jobject(R3_RET, R11_scratch1, R31, /* needs_frame */ true); // kills R31
 407     break;
 408   case T_FLOAT:
 409      break;
 410   case T_DOUBLE:
 411      break;
 412   case T_VOID:
 413      break;
 414   default: ShouldNotReachHere();
 415   }
 416 
 417   BIND(done);
 418   __ blr();
 419 
 420   return entry;
 421 }
 422 
 423 // Abstract method entry.
 424 //
 425 address TemplateInterpreterGenerator::generate_abstract_entry(void) {
 426   address entry = __ pc();
 427 
 428   //
 429   // Registers alive
 430   //   R16_thread     - JavaThread*
 431   //   R19_method     - callee&#39;s method (method to be invoked)
 432   //   R1_SP          - SP prepared such that caller&#39;s outgoing args are near top
 433   //   LR             - return address to caller
 434   //
 435   // Stack layout at this point:
 436   //
 437   //   0       [TOP_IJAVA_FRAME_ABI]         &lt;-- R1_SP
 438   //           alignment (optional)
 439   //           [outgoing Java arguments]
 440   //           ...
 441   //   PARENT  [PARENT_IJAVA_FRAME_ABI]
 442   //            ...
 443   //
 444 
 445   // Can&#39;t use call_VM here because we have not set up a new
 446   // interpreter state. Make the call to the vm and make it look like
 447   // our caller set up the JavaFrameAnchor.
 448   __ set_top_ijava_frame_at_SP_as_last_Java_frame(R1_SP, R12_scratch2/*tmp*/);
 449 
 450   // Push a new C frame and save LR.
 451   __ save_LR_CR(R0);
 452   __ push_frame_reg_args(0, R11_scratch1);
 453 
 454   // This is not a leaf but we have a JavaFrameAnchor now and we will
 455   // check (create) exceptions afterward so this is ok.
 456   __ call_VM_leaf(CAST_FROM_FN_PTR(address, InterpreterRuntime::throw_AbstractMethodErrorWithMethod),
 457                   R16_thread, R19_method);
 458 
 459   // Pop the C frame and restore LR.
 460   __ pop_frame();
 461   __ restore_LR_CR(R0);
 462 
 463   // Reset JavaFrameAnchor from call_VM_leaf above.
 464   __ reset_last_Java_frame();
 465 
 466   // We don&#39;t know our caller, so jump to the general forward exception stub,
 467   // which will also pop our full frame off. Satisfy the interface of
 468   // SharedRuntime::generate_forward_exception()
 469   __ load_const_optimized(R11_scratch1, StubRoutines::forward_exception_entry(), R0);
 470   __ mtctr(R11_scratch1);
 471   __ bctr();
 472 
 473   return entry;
 474 }
 475 
 476 // Interpreter intrinsic for WeakReference.get().
 477 // 1. Don&#39;t push a full blown frame and go on dispatching, but fetch the value
 478 //    into R8 and return quickly
 479 // 2. If G1 is active we *must* execute this intrinsic for corrrectness:
 480 //    It contains a GC barrier which puts the reference into the satb buffer
 481 //    to indicate that someone holds a strong reference to the object the
 482 //    weak ref points to!
 483 address TemplateInterpreterGenerator::generate_Reference_get_entry(void) {
 484   // Code: _aload_0, _getfield, _areturn
 485   // parameter size = 1
 486   //
 487   // The code that gets generated by this routine is split into 2 parts:
 488   //    1. the &quot;intrinsified&quot; code for G1 (or any SATB based GC),
 489   //    2. the slow path - which is an expansion of the regular method entry.
 490   //
 491   // Notes:
 492   // * In the G1 code we do not check whether we need to block for
 493   //   a safepoint. If G1 is enabled then we must execute the specialized
 494   //   code for Reference.get (except when the Reference object is null)
 495   //   so that we can log the value in the referent field with an SATB
 496   //   update buffer.
 497   //   If the code for the getfield template is modified so that the
 498   //   G1 pre-barrier code is executed when the current method is
 499   //   Reference.get() then going through the normal method entry
 500   //   will be fine.
 501   // * The G1 code can, however, check the receiver object (the instance
 502   //   of java.lang.Reference) and jump to the slow path if null. If the
 503   //   Reference object is null then we obviously cannot fetch the referent
 504   //   and so we don&#39;t need to call the G1 pre-barrier. Thus we can use the
 505   //   regular method entry code to generate the NPE.
 506   //
 507 
 508   address entry = __ pc();
 509 
<a name="2" id="anc2"></a><span class="line-modified"> 510   const int referent_offset = java_lang_ref_Reference::referent_offset;</span>
<span class="line-removed"> 511   guarantee(referent_offset &gt; 0, &quot;referent offset not initialized&quot;);</span>
 512 
 513   Label slow_path;
 514 
 515   // Debugging not possible, so can&#39;t use __ skip_if_jvmti_mode(slow_path, GR31_SCRATCH);
 516 
 517   // In the G1 code we don&#39;t check if we need to reach a safepoint. We
 518   // continue and the thread will safepoint at the next bytecode dispatch.
 519 
 520   // If the receiver is null then it is OK to jump to the slow path.
 521   __ ld(R3_RET, Interpreter::stackElementSize, R15_esp); // get receiver
 522 
 523   // Check if receiver == NULL and go the slow path.
 524   __ cmpdi(CCR0, R3_RET, 0);
 525   __ beq(CCR0, slow_path);
 526 
 527   __ load_heap_oop(R3_RET, referent_offset, R3_RET,
 528                    /* non-volatile temp */ R31, R11_scratch1, true, ON_WEAK_OOP_REF);
 529 
 530   // Generate the G1 pre-barrier code to log the value of
 531   // the referent field in an SATB buffer. Note with
 532   // these parameters the pre-barrier does not generate
 533   // the load of the previous value.
 534 
 535   // Restore caller sp for c2i case (from compiled) and for resized sender frame (from interpreted).
 536   __ resize_frame_absolute(R21_sender_SP, R11_scratch1, R0);
 537 
 538   __ blr();
 539 
 540   __ bind(slow_path);
 541   __ jump_to_entry(Interpreter::entry_for_kind(Interpreter::zerolocals), R11_scratch1);
 542   return entry;
 543 }
 544 
 545 address TemplateInterpreterGenerator::generate_StackOverflowError_handler() {
 546   address entry = __ pc();
 547 
 548   // Expression stack must be empty before entering the VM if an
 549   // exception happened.
 550   __ empty_expression_stack();
 551   // Throw exception.
 552   __ call_VM(noreg,
 553              CAST_FROM_FN_PTR(address,
 554                               InterpreterRuntime::throw_StackOverflowError));
 555   return entry;
 556 }
 557 
 558 address TemplateInterpreterGenerator::generate_ArrayIndexOutOfBounds_handler() {
 559   address entry = __ pc();
 560   __ empty_expression_stack();
 561   // R4_ARG2 already contains the array.
 562   // Index is in R17_tos.
 563   __ mr(R5_ARG3, R17_tos);
 564   __ call_VM(noreg, CAST_FROM_FN_PTR(address, InterpreterRuntime::throw_ArrayIndexOutOfBoundsException), R4_ARG2, R5_ARG3);
 565   return entry;
 566 }
 567 
 568 address TemplateInterpreterGenerator::generate_ClassCastException_handler() {
 569   address entry = __ pc();
 570   // Expression stack must be empty before entering the VM if an
 571   // exception happened.
 572   __ empty_expression_stack();
 573 
 574   // Load exception object.
 575   // Thread will be loaded to R3_ARG1.
 576   __ call_VM(noreg, CAST_FROM_FN_PTR(address, InterpreterRuntime::throw_ClassCastException), R17_tos);
 577 #ifdef ASSERT
 578   // Above call must not return here since exception pending.
 579   __ should_not_reach_here();
 580 #endif
 581   return entry;
 582 }
 583 
 584 address TemplateInterpreterGenerator::generate_exception_handler_common(const char* name, const char* message, bool pass_oop) {
 585   address entry = __ pc();
 586   //__ untested(&quot;generate_exception_handler_common&quot;);
 587   Register Rexception = R17_tos;
 588 
 589   // Expression stack must be empty before entering the VM if an exception happened.
 590   __ empty_expression_stack();
 591 
 592   __ load_const_optimized(R4_ARG2, (address) name, R11_scratch1);
 593   if (pass_oop) {
 594     __ mr(R5_ARG3, Rexception);
 595     __ call_VM(Rexception, CAST_FROM_FN_PTR(address, InterpreterRuntime::create_klass_exception));
 596   } else {
 597     __ load_const_optimized(R5_ARG3, (address) message, R11_scratch1);
 598     __ call_VM(Rexception, CAST_FROM_FN_PTR(address, InterpreterRuntime::create_exception));
 599   }
 600 
 601   // Throw exception.
 602   __ mr(R3_ARG1, Rexception);
 603   __ load_const_optimized(R11_scratch1, Interpreter::throw_exception_entry(), R12_scratch2);
 604   __ mtctr(R11_scratch1);
 605   __ bctr();
 606 
 607   return entry;
 608 }
 609 
 610 // This entry is returned to when a call returns to the interpreter.
 611 // When we arrive here, we expect that the callee stack frame is already popped.
 612 address TemplateInterpreterGenerator::generate_return_entry_for(TosState state, int step, size_t index_size) {
 613   address entry = __ pc();
 614 
 615   // Move the value out of the return register back to the TOS cache of current frame.
 616   switch (state) {
 617     case ltos:
 618     case btos:
 619     case ztos:
 620     case ctos:
 621     case stos:
 622     case atos:
 623     case itos: __ mr(R17_tos, R3_RET); break;   // RET -&gt; TOS cache
 624     case ftos:
 625     case dtos: __ fmr(F15_ftos, F1_RET); break; // TOS cache -&gt; GR_FRET
 626     case vtos: break;                           // Nothing to do, this was a void return.
 627     default  : ShouldNotReachHere();
 628   }
 629 
 630   __ restore_interpreter_state(R11_scratch1); // Sets R11_scratch1 = fp.
 631   __ ld(R12_scratch2, _ijava_state_neg(top_frame_sp), R11_scratch1);
 632   __ resize_frame_absolute(R12_scratch2, R11_scratch1, R0);
 633 
 634   // Compiled code destroys templateTableBase, reload.
 635   __ load_const_optimized(R25_templateTableBase, (address)Interpreter::dispatch_table((TosState)0), R12_scratch2);
 636 
 637   if (state == atos) {
 638     __ profile_return_type(R3_RET, R11_scratch1, R12_scratch2);
 639   }
 640 
 641   const Register cache = R11_scratch1;
 642   const Register size  = R12_scratch2;
 643   __ get_cache_and_index_at_bcp(cache, 1, index_size);
 644 
 645   // Get least significant byte of 64 bit value:
 646 #if defined(VM_LITTLE_ENDIAN)
 647   __ lbz(size, in_bytes(ConstantPoolCache::base_offset() + ConstantPoolCacheEntry::flags_offset()), cache);
 648 #else
 649   __ lbz(size, in_bytes(ConstantPoolCache::base_offset() + ConstantPoolCacheEntry::flags_offset()) + 7, cache);
 650 #endif
 651   __ sldi(size, size, Interpreter::logStackElementSize);
 652   __ add(R15_esp, R15_esp, size);
 653 
 654  __ check_and_handle_popframe(R11_scratch1);
 655  __ check_and_handle_earlyret(R11_scratch1);
 656 
 657   __ dispatch_next(state, step);
 658   return entry;
 659 }
 660 
 661 address TemplateInterpreterGenerator::generate_deopt_entry_for(TosState state, int step, address continuation) {
 662   address entry = __ pc();
 663   // If state != vtos, we&#39;re returning from a native method, which put it&#39;s result
 664   // into the result register. So move the value out of the return register back
 665   // to the TOS cache of current frame.
 666 
 667   switch (state) {
 668     case ltos:
 669     case btos:
 670     case ztos:
 671     case ctos:
 672     case stos:
 673     case atos:
 674     case itos: __ mr(R17_tos, R3_RET); break;   // GR_RET -&gt; TOS cache
 675     case ftos:
 676     case dtos: __ fmr(F15_ftos, F1_RET); break; // TOS cache -&gt; GR_FRET
 677     case vtos: break;                           // Nothing to do, this was a void return.
 678     default  : ShouldNotReachHere();
 679   }
 680 
 681   // Load LcpoolCache @@@ should be already set!
 682   __ get_constant_pool_cache(R27_constPoolCache);
 683 
 684   // Handle a pending exception, fall through if none.
 685   __ check_and_forward_exception(R11_scratch1, R12_scratch2);
 686 
 687   // Start executing bytecodes.
 688   if (continuation == NULL) {
 689     __ dispatch_next(state, step);
 690   } else {
 691     __ jump_to_entry(continuation, R11_scratch1);
 692   }
 693 
 694   return entry;
 695 }
 696 
 697 address TemplateInterpreterGenerator::generate_safept_entry_for(TosState state, address runtime_entry) {
 698   address entry = __ pc();
 699 
 700   __ push(state);
 701   __ call_VM(noreg, runtime_entry);
 702   __ dispatch_via(vtos, Interpreter::_normal_table.table_for(vtos));
 703 
 704   return entry;
 705 }
 706 
 707 // Helpers for commoning out cases in the various type of method entries.
 708 
 709 // Increment invocation count &amp; check for overflow.
 710 //
 711 // Note: checking for negative value instead of overflow
 712 //       so we have a &#39;sticky&#39; overflow test.
 713 //
 714 void TemplateInterpreterGenerator::generate_counter_incr(Label* overflow, Label* profile_method, Label* profile_method_continue) {
 715   // Note: In tiered we increment either counters in method or in MDO depending if we&#39;re profiling or not.
 716   Register Rscratch1   = R11_scratch1;
 717   Register Rscratch2   = R12_scratch2;
 718   Register R3_counters = R3_ARG1;
 719   Label done;
 720 
 721   if (TieredCompilation) {
 722     const int increment = InvocationCounter::count_increment;
 723     Label no_mdo;
 724     if (ProfileInterpreter) {
 725       const Register Rmdo = R3_counters;
 726       // If no method data exists, go to profile_continue.
 727       __ ld(Rmdo, in_bytes(Method::method_data_offset()), R19_method);
 728       __ cmpdi(CCR0, Rmdo, 0);
 729       __ beq(CCR0, no_mdo);
 730 
 731       // Increment invocation counter in the MDO.
 732       const int mdo_ic_offs = in_bytes(MethodData::invocation_counter_offset()) + in_bytes(InvocationCounter::counter_offset());
 733       __ lwz(Rscratch2, mdo_ic_offs, Rmdo);
 734       __ lwz(Rscratch1, in_bytes(MethodData::invoke_mask_offset()), Rmdo);
 735       __ addi(Rscratch2, Rscratch2, increment);
 736       __ stw(Rscratch2, mdo_ic_offs, Rmdo);
 737       __ and_(Rscratch1, Rscratch2, Rscratch1);
 738       __ bne(CCR0, done);
 739       __ b(*overflow);
 740     }
 741 
 742     // Increment counter in MethodCounters*.
 743     const int mo_ic_offs = in_bytes(MethodCounters::invocation_counter_offset()) + in_bytes(InvocationCounter::counter_offset());
 744     __ bind(no_mdo);
 745     __ get_method_counters(R19_method, R3_counters, done);
 746     __ lwz(Rscratch2, mo_ic_offs, R3_counters);
 747     __ lwz(Rscratch1, in_bytes(MethodCounters::invoke_mask_offset()), R3_counters);
 748     __ addi(Rscratch2, Rscratch2, increment);
 749     __ stw(Rscratch2, mo_ic_offs, R3_counters);
 750     __ and_(Rscratch1, Rscratch2, Rscratch1);
 751     __ beq(CCR0, *overflow);
 752 
 753     __ bind(done);
 754 
 755   } else {
 756 
 757     // Update standard invocation counters.
 758     Register Rsum_ivc_bec = R4_ARG2;
 759     __ get_method_counters(R19_method, R3_counters, done);
 760     __ increment_invocation_counter(R3_counters, Rsum_ivc_bec, R12_scratch2);
 761     // Increment interpreter invocation counter.
 762     if (ProfileInterpreter) {  // %%% Merge this into methodDataOop.
 763       __ lwz(R12_scratch2, in_bytes(MethodCounters::interpreter_invocation_counter_offset()), R3_counters);
 764       __ addi(R12_scratch2, R12_scratch2, 1);
 765       __ stw(R12_scratch2, in_bytes(MethodCounters::interpreter_invocation_counter_offset()), R3_counters);
 766     }
 767     // Check if we must create a method data obj.
 768     if (ProfileInterpreter &amp;&amp; profile_method != NULL) {
 769       const Register profile_limit = Rscratch1;
 770       __ lwz(profile_limit, in_bytes(MethodCounters::interpreter_profile_limit_offset()), R3_counters);
 771       // Test to see if we should create a method data oop.
 772       __ cmpw(CCR0, Rsum_ivc_bec, profile_limit);
 773       __ blt(CCR0, *profile_method_continue);
 774       // If no method data exists, go to profile_method.
 775       __ test_method_data_pointer(*profile_method);
 776     }
 777     // Finally check for counter overflow.
 778     if (overflow) {
 779       const Register invocation_limit = Rscratch1;
 780       __ lwz(invocation_limit, in_bytes(MethodCounters::interpreter_invocation_limit_offset()), R3_counters);
 781       __ cmpw(CCR0, Rsum_ivc_bec, invocation_limit);
 782       __ bge(CCR0, *overflow);
 783     }
 784 
 785     __ bind(done);
 786   }
 787 }
 788 
 789 // Generate code to initiate compilation on invocation counter overflow.
 790 void TemplateInterpreterGenerator::generate_counter_overflow(Label&amp; continue_entry) {
 791   // Generate code to initiate compilation on the counter overflow.
 792 
 793   // InterpreterRuntime::frequency_counter_overflow takes one arguments,
 794   // which indicates if the counter overflow occurs at a backwards branch (NULL bcp)
 795   // We pass zero in.
 796   // The call returns the address of the verified entry point for the method or NULL
 797   // if the compilation did not complete (either went background or bailed out).
 798   //
 799   // Unlike the C++ interpreter above: Check exceptions!
 800   // Assumption: Caller must set the flag &quot;do_not_unlock_if_sychronized&quot; if the monitor of a sync&#39;ed
 801   // method has not yet been created. Thus, no unlocking of a non-existing monitor can occur.
 802 
 803   __ li(R4_ARG2, 0);
 804   __ call_VM(noreg, CAST_FROM_FN_PTR(address, InterpreterRuntime::frequency_counter_overflow), R4_ARG2, true);
 805 
 806   // Returns verified_entry_point or NULL.
 807   // We ignore it in any case.
 808   __ b(continue_entry);
 809 }
 810 
 811 // See if we&#39;ve got enough room on the stack for locals plus overhead below
 812 // JavaThread::stack_overflow_limit(). If not, throw a StackOverflowError
 813 // without going through the signal handler, i.e., reserved and yellow zones
 814 // will not be made usable. The shadow zone must suffice to handle the
 815 // overflow.
 816 //
 817 // Kills Rmem_frame_size, Rscratch1.
 818 void TemplateInterpreterGenerator::generate_stack_overflow_check(Register Rmem_frame_size, Register Rscratch1) {
 819   Label done;
 820   assert_different_registers(Rmem_frame_size, Rscratch1);
 821 
 822   BLOCK_COMMENT(&quot;stack_overflow_check_with_compare {&quot;);
 823   __ sub(Rmem_frame_size, R1_SP, Rmem_frame_size);
 824   __ ld(Rscratch1, thread_(stack_overflow_limit));
 825   __ cmpld(CCR0/*is_stack_overflow*/, Rmem_frame_size, Rscratch1);
 826   __ bgt(CCR0/*is_stack_overflow*/, done);
 827 
 828   // The stack overflows. Load target address of the runtime stub and call it.
 829   assert(StubRoutines::throw_StackOverflowError_entry() != NULL, &quot;generated in wrong order&quot;);
 830   __ load_const_optimized(Rscratch1, (StubRoutines::throw_StackOverflowError_entry()), R0);
 831   __ mtctr(Rscratch1);
 832   // Restore caller_sp (c2i adapter may exist, but no shrinking of interpreted caller frame).
 833 #ifdef ASSERT
 834   Label frame_not_shrunk;
 835   __ cmpld(CCR0, R1_SP, R21_sender_SP);
 836   __ ble(CCR0, frame_not_shrunk);
 837   __ stop(&quot;frame shrunk&quot;);
 838   __ bind(frame_not_shrunk);
 839   __ ld(Rscratch1, 0, R1_SP);
 840   __ ld(R0, 0, R21_sender_SP);
 841   __ cmpd(CCR0, R0, Rscratch1);
 842   __ asm_assert_eq(&quot;backlink&quot;);
 843 #endif // ASSERT
 844   __ mr(R1_SP, R21_sender_SP);
 845   __ bctr();
 846 
 847   __ align(32, 12);
 848   __ bind(done);
 849   BLOCK_COMMENT(&quot;} stack_overflow_check_with_compare&quot;);
 850 }
 851 
 852 // Lock the current method, interpreter register window must be set up!
 853 void TemplateInterpreterGenerator::lock_method(Register Rflags, Register Rscratch1, Register Rscratch2, bool flags_preloaded) {
 854   const Register Robj_to_lock = Rscratch2;
 855 
 856   {
 857     if (!flags_preloaded) {
 858       __ lwz(Rflags, method_(access_flags));
 859     }
 860 
 861 #ifdef ASSERT
 862     // Check if methods needs synchronization.
 863     {
 864       Label Lok;
 865       __ testbitdi(CCR0, R0, Rflags, JVM_ACC_SYNCHRONIZED_BIT);
 866       __ btrue(CCR0,Lok);
 867       __ stop(&quot;method doesn&#39;t need synchronization&quot;);
 868       __ bind(Lok);
 869     }
 870 #endif // ASSERT
 871   }
 872 
 873   // Get synchronization object to Rscratch2.
 874   {
 875     Label Lstatic;
 876     Label Ldone;
 877 
 878     __ testbitdi(CCR0, R0, Rflags, JVM_ACC_STATIC_BIT);
 879     __ btrue(CCR0, Lstatic);
 880 
 881     // Non-static case: load receiver obj from stack and we&#39;re done.
 882     __ ld(Robj_to_lock, R18_locals);
 883     __ b(Ldone);
 884 
 885     __ bind(Lstatic); // Static case: Lock the java mirror
 886     // Load mirror from interpreter frame.
 887     __ ld(Robj_to_lock, _abi(callers_sp), R1_SP);
 888     __ ld(Robj_to_lock, _ijava_state_neg(mirror), Robj_to_lock);
 889 
 890     __ bind(Ldone);
 891     __ verify_oop(Robj_to_lock);
 892   }
 893 
 894   // Got the oop to lock =&gt; execute!
 895   __ add_monitor_to_stack(true, Rscratch1, R0);
 896 
 897   __ std(Robj_to_lock, BasicObjectLock::obj_offset_in_bytes(), R26_monitor);
 898   __ lock_object(R26_monitor, Robj_to_lock);
 899 }
 900 
 901 // Generate a fixed interpreter frame for pure interpreter
 902 // and I2N native transition frames.
 903 //
 904 // Before (stack grows downwards):
 905 //
 906 //         |  ...         |
 907 //         |------------- |
 908 //         |  java arg0   |
 909 //         |  ...         |
 910 //         |  java argn   |
 911 //         |              |   &lt;-   R15_esp
 912 //         |              |
 913 //         |--------------|
 914 //         | abi_112      |
 915 //         |              |   &lt;-   R1_SP
 916 //         |==============|
 917 //
 918 //
 919 // After:
 920 //
 921 //         |  ...         |
 922 //         |  java arg0   |&lt;-   R18_locals
 923 //         |  ...         |
 924 //         |  java argn   |
 925 //         |--------------|
 926 //         |              |
 927 //         |  java locals |
 928 //         |              |
 929 //         |--------------|
 930 //         |  abi_48      |
 931 //         |==============|
 932 //         |              |
 933 //         |   istate     |
 934 //         |              |
 935 //         |--------------|
 936 //         |   monitor    |&lt;-   R26_monitor
 937 //         |--------------|
 938 //         |              |&lt;-   R15_esp
 939 //         | expression   |
 940 //         | stack        |
 941 //         |              |
 942 //         |--------------|
 943 //         |              |
 944 //         | abi_112      |&lt;-   R1_SP
 945 //         |==============|
 946 //
 947 // The top most frame needs an abi space of 112 bytes. This space is needed,
 948 // since we call to c. The c function may spill their arguments to the caller
 949 // frame. When we call to java, we don&#39;t need these spill slots. In order to save
 950 // space on the stack, we resize the caller. However, java locals reside in
 951 // the caller frame and the frame has to be increased. The frame_size for the
 952 // current frame was calculated based on max_stack as size for the expression
 953 // stack. At the call, just a part of the expression stack might be used.
 954 // We don&#39;t want to waste this space and cut the frame back accordingly.
 955 // The resulting amount for resizing is calculated as follows:
 956 // resize =   (number_of_locals - number_of_arguments) * slot_size
 957 //          + (R1_SP - R15_esp) + 48
 958 //
 959 // The size for the callee frame is calculated:
 960 // framesize = 112 + max_stack + monitor + state_size
 961 //
 962 // maxstack:   Max number of slots on the expression stack, loaded from the method.
 963 // monitor:    We statically reserve room for one monitor object.
 964 // state_size: We save the current state of the interpreter to this area.
 965 //
 966 void TemplateInterpreterGenerator::generate_fixed_frame(bool native_call, Register Rsize_of_parameters, Register Rsize_of_locals) {
 967   Register parent_frame_resize = R6_ARG4, // Frame will grow by this number of bytes.
 968            top_frame_size      = R7_ARG5,
 969            Rconst_method       = R8_ARG6;
 970 
 971   assert_different_registers(Rsize_of_parameters, Rsize_of_locals, parent_frame_resize, top_frame_size);
 972 
 973   __ ld(Rconst_method, method_(const));
 974   __ lhz(Rsize_of_parameters /* number of params */,
 975          in_bytes(ConstMethod::size_of_parameters_offset()), Rconst_method);
 976   if (native_call) {
 977     // If we&#39;re calling a native method, we reserve space for the worst-case signature
 978     // handler varargs vector, which is max(Argument::n_register_parameters, parameter_count+2).
 979     // We add two slots to the parameter_count, one for the jni
 980     // environment and one for a possible native mirror.
 981     Label skip_native_calculate_max_stack;
 982     __ addi(top_frame_size, Rsize_of_parameters, 2);
 983     __ cmpwi(CCR0, top_frame_size, Argument::n_register_parameters);
 984     __ bge(CCR0, skip_native_calculate_max_stack);
 985     __ li(top_frame_size, Argument::n_register_parameters);
 986     __ bind(skip_native_calculate_max_stack);
 987     __ sldi(Rsize_of_parameters, Rsize_of_parameters, Interpreter::logStackElementSize);
 988     __ sldi(top_frame_size, top_frame_size, Interpreter::logStackElementSize);
 989     __ sub(parent_frame_resize, R1_SP, R15_esp); // &lt;0, off by Interpreter::stackElementSize!
 990     assert(Rsize_of_locals == noreg, &quot;Rsize_of_locals not initialized&quot;); // Only relevant value is Rsize_of_parameters.
 991   } else {
 992     __ lhz(Rsize_of_locals /* number of params */, in_bytes(ConstMethod::size_of_locals_offset()), Rconst_method);
 993     __ sldi(Rsize_of_parameters, Rsize_of_parameters, Interpreter::logStackElementSize);
 994     __ sldi(Rsize_of_locals, Rsize_of_locals, Interpreter::logStackElementSize);
 995     __ lhz(top_frame_size, in_bytes(ConstMethod::max_stack_offset()), Rconst_method);
 996     __ sub(R11_scratch1, Rsize_of_locals, Rsize_of_parameters); // &gt;=0
 997     __ sub(parent_frame_resize, R1_SP, R15_esp); // &lt;0, off by Interpreter::stackElementSize!
 998     __ sldi(top_frame_size, top_frame_size, Interpreter::logStackElementSize);
 999     __ add(parent_frame_resize, parent_frame_resize, R11_scratch1);
1000   }
1001 
1002   // Compute top frame size.
1003   __ addi(top_frame_size, top_frame_size, frame::abi_reg_args_size + frame::ijava_state_size);
1004 
1005   // Cut back area between esp and max_stack.
1006   __ addi(parent_frame_resize, parent_frame_resize, frame::abi_minframe_size - Interpreter::stackElementSize);
1007 
1008   __ round_to(top_frame_size, frame::alignment_in_bytes);
1009   __ round_to(parent_frame_resize, frame::alignment_in_bytes);
1010   // parent_frame_resize = (locals-parameters) - (ESP-SP-ABI48) Rounded to frame alignment size.
1011   // Enlarge by locals-parameters (not in case of native_call), shrink by ESP-SP-ABI48.
1012 
1013   if (!native_call) {
1014     // Stack overflow check.
1015     // Native calls don&#39;t need the stack size check since they have no
1016     // expression stack and the arguments are already on the stack and
1017     // we only add a handful of words to the stack.
1018     __ add(R11_scratch1, parent_frame_resize, top_frame_size);
1019     generate_stack_overflow_check(R11_scratch1, R12_scratch2);
1020   }
1021 
1022   // Set up interpreter state registers.
1023 
1024   __ add(R18_locals, R15_esp, Rsize_of_parameters);
1025   __ ld(R27_constPoolCache, in_bytes(ConstMethod::constants_offset()), Rconst_method);
1026   __ ld(R27_constPoolCache, ConstantPool::cache_offset_in_bytes(), R27_constPoolCache);
1027 
1028   // Set method data pointer.
1029   if (ProfileInterpreter) {
1030     Label zero_continue;
1031     __ ld(R28_mdx, method_(method_data));
1032     __ cmpdi(CCR0, R28_mdx, 0);
1033     __ beq(CCR0, zero_continue);
1034     __ addi(R28_mdx, R28_mdx, in_bytes(MethodData::data_offset()));
1035     __ bind(zero_continue);
1036   }
1037 
1038   if (native_call) {
1039     __ li(R14_bcp, 0); // Must initialize.
1040   } else {
1041     __ add(R14_bcp, in_bytes(ConstMethod::codes_offset()), Rconst_method);
1042   }
1043 
1044   // Resize parent frame.
1045   __ mflr(R12_scratch2);
1046   __ neg(parent_frame_resize, parent_frame_resize);
1047   __ resize_frame(parent_frame_resize, R11_scratch1);
1048   __ std(R12_scratch2, _abi(lr), R1_SP);
1049 
1050   // Get mirror and store it in the frame as GC root for this Method*.
1051   __ load_mirror_from_const_method(R12_scratch2, Rconst_method);
1052 
1053   __ addi(R26_monitor, R1_SP, -frame::ijava_state_size);
1054   __ addi(R15_esp, R26_monitor, -Interpreter::stackElementSize);
1055 
1056   // Store values.
1057   __ std(R19_method, _ijava_state_neg(method), R1_SP);
1058   __ std(R12_scratch2, _ijava_state_neg(mirror), R1_SP);
1059   __ std(R18_locals, _ijava_state_neg(locals), R1_SP);
1060   __ std(R27_constPoolCache, _ijava_state_neg(cpoolCache), R1_SP);
1061 
1062   // Note: esp, bcp, monitor, mdx live in registers. Hence, the correct version can only
1063   // be found in the frame after save_interpreter_state is done. This is always true
1064   // for non-top frames. But when a signal occurs, dumping the top frame can go wrong,
1065   // because e.g. frame::interpreter_frame_bcp() will not access the correct value
1066   // (Enhanced Stack Trace).
1067   // The signal handler does not save the interpreter state into the frame.
1068 
1069   // We have to initialize some of these frame slots for native calls (accessed by GC).
1070   // Also initialize them for non-native calls for better tool support (even though
1071   // you may not get the most recent version as described above).
1072   __ li(R0, 0);
1073   __ std(R26_monitor, _ijava_state_neg(monitors), R1_SP);
1074   __ std(R14_bcp, _ijava_state_neg(bcp), R1_SP);
1075   if (ProfileInterpreter) { __ std(R28_mdx, _ijava_state_neg(mdx), R1_SP); }
1076   __ std(R15_esp, _ijava_state_neg(esp), R1_SP);
1077   __ std(R0, _ijava_state_neg(oop_tmp), R1_SP); // only used for native_call
1078 
1079   // Store sender&#39;s SP and this frame&#39;s top SP.
1080   __ subf(R12_scratch2, top_frame_size, R1_SP);
1081   __ std(R21_sender_SP, _ijava_state_neg(sender_sp), R1_SP);
1082   __ std(R12_scratch2, _ijava_state_neg(top_frame_sp), R1_SP);
1083 
1084   // Push top frame.
1085   __ push_frame(top_frame_size, R11_scratch1);
1086 }
1087 
1088 // End of helpers
1089 
1090 address TemplateInterpreterGenerator::generate_math_entry(AbstractInterpreter::MethodKind kind) {
1091 
1092   // Decide what to do: Use same platform specific instructions and runtime calls as compilers.
1093   bool use_instruction = false;
1094   address runtime_entry = NULL;
1095   int num_args = 1;
1096   bool double_precision = true;
1097 
1098   // PPC64 specific:
1099   switch (kind) {
1100     case Interpreter::java_lang_math_sqrt: use_instruction = VM_Version::has_fsqrt(); break;
1101     case Interpreter::java_lang_math_abs:  use_instruction = true; break;
1102     case Interpreter::java_lang_math_fmaF:
1103     case Interpreter::java_lang_math_fmaD: use_instruction = UseFMA; break;
1104     default: break; // Fall back to runtime call.
1105   }
1106 
1107   switch (kind) {
1108     case Interpreter::java_lang_math_sin  : runtime_entry = CAST_FROM_FN_PTR(address, SharedRuntime::dsin);   break;
1109     case Interpreter::java_lang_math_cos  : runtime_entry = CAST_FROM_FN_PTR(address, SharedRuntime::dcos);   break;
1110     case Interpreter::java_lang_math_tan  : runtime_entry = CAST_FROM_FN_PTR(address, SharedRuntime::dtan);   break;
1111     case Interpreter::java_lang_math_abs  : /* run interpreted */ break;
1112     case Interpreter::java_lang_math_sqrt : runtime_entry = CAST_FROM_FN_PTR(address, SharedRuntime::dsqrt);  break;
1113     case Interpreter::java_lang_math_log  : runtime_entry = CAST_FROM_FN_PTR(address, SharedRuntime::dlog);   break;
1114     case Interpreter::java_lang_math_log10: runtime_entry = CAST_FROM_FN_PTR(address, SharedRuntime::dlog10); break;
1115     case Interpreter::java_lang_math_pow  : runtime_entry = CAST_FROM_FN_PTR(address, SharedRuntime::dpow); num_args = 2; break;
1116     case Interpreter::java_lang_math_exp  : runtime_entry = CAST_FROM_FN_PTR(address, SharedRuntime::dexp);   break;
1117     case Interpreter::java_lang_math_fmaF : /* run interpreted */ num_args = 3; double_precision = false; break;
1118     case Interpreter::java_lang_math_fmaD : /* run interpreted */ num_args = 3; break;
1119     default: ShouldNotReachHere();
1120   }
1121 
1122   // Use normal entry if neither instruction nor runtime call is used.
1123   if (!use_instruction &amp;&amp; runtime_entry == NULL) return NULL;
1124 
1125   address entry = __ pc();
1126 
1127   // Load arguments
1128   assert(num_args &lt;= 13, &quot;passed in registers&quot;);
1129   if (double_precision) {
1130     int offset = (2 * num_args - 1) * Interpreter::stackElementSize;
1131     for (int i = 0; i &lt; num_args; ++i) {
1132       __ lfd(as_FloatRegister(F1_ARG1-&gt;encoding() + i), offset, R15_esp);
1133       offset -= 2 * Interpreter::stackElementSize;
1134     }
1135   } else {
1136     int offset = num_args * Interpreter::stackElementSize;
1137     for (int i = 0; i &lt; num_args; ++i) {
1138       __ lfs(as_FloatRegister(F1_ARG1-&gt;encoding() + i), offset, R15_esp);
1139       offset -= Interpreter::stackElementSize;
1140     }
1141   }
1142 
1143   if (use_instruction) {
1144     switch (kind) {
1145       case Interpreter::java_lang_math_sqrt: __ fsqrt(F1_RET, F1);          break;
1146       case Interpreter::java_lang_math_abs:  __ fabs(F1_RET, F1);           break;
1147       case Interpreter::java_lang_math_fmaF: __ fmadds(F1_RET, F1, F2, F3); break;
1148       case Interpreter::java_lang_math_fmaD: __ fmadd(F1_RET, F1, F2, F3);  break;
1149       default: ShouldNotReachHere();
1150     }
1151   } else {
1152     // Comment: Can use tail call if the unextended frame is always C ABI compliant:
1153     //__ load_const_optimized(R12_scratch2, runtime_entry, R0);
1154     //__ call_c_and_return_to_caller(R12_scratch2);
1155 
1156     // Push a new C frame and save LR.
1157     __ save_LR_CR(R0);
1158     __ push_frame_reg_args(0, R11_scratch1);
1159 
1160     __ call_VM_leaf(runtime_entry);
1161 
1162     // Pop the C frame and restore LR.
1163     __ pop_frame();
1164     __ restore_LR_CR(R0);
1165   }
1166 
1167   // Restore caller sp for c2i case (from compiled) and for resized sender frame (from interpreted).
1168   __ resize_frame_absolute(R21_sender_SP, R11_scratch1, R0);
1169   __ blr();
1170 
1171   __ flush();
1172 
1173   return entry;
1174 }
1175 
1176 void TemplateInterpreterGenerator::bang_stack_shadow_pages(bool native_call) {
1177   // Quick &amp; dirty stack overflow checking: bang the stack &amp; handle trap.
1178   // Note that we do the banging after the frame is setup, since the exception
1179   // handling code expects to find a valid interpreter frame on the stack.
1180   // Doing the banging earlier fails if the caller frame is not an interpreter
1181   // frame.
1182   // (Also, the exception throwing code expects to unlock any synchronized
1183   // method receiever, so do the banging after locking the receiver.)
1184 
1185   // Bang each page in the shadow zone. We can&#39;t assume it&#39;s been done for
1186   // an interpreter frame with greater than a page of locals, so each page
1187   // needs to be checked.  Only true for non-native.
1188   if (UseStackBanging) {
1189     const int page_size = os::vm_page_size();
1190     const int n_shadow_pages = ((int)JavaThread::stack_shadow_zone_size()) / page_size;
1191     const int start_page = native_call ? n_shadow_pages : 1;
1192     BLOCK_COMMENT(&quot;bang_stack_shadow_pages:&quot;);
1193     for (int pages = start_page; pages &lt;= n_shadow_pages; pages++) {
1194       __ bang_stack_with_offset(pages*page_size);
1195     }
1196   }
1197 }
1198 
1199 // Interpreter stub for calling a native method. (asm interpreter)
1200 // This sets up a somewhat different looking stack for calling the
1201 // native method than the typical interpreter frame setup.
1202 //
1203 // On entry:
1204 //   R19_method    - method
1205 //   R16_thread    - JavaThread*
1206 //   R15_esp       - intptr_t* sender tos
1207 //
1208 //   abstract stack (grows up)
1209 //     [  IJava (caller of JNI callee)  ]  &lt;-- ASP
1210 //        ...
1211 address TemplateInterpreterGenerator::generate_native_entry(bool synchronized) {
1212 
1213   address entry = __ pc();
1214 
1215   const bool inc_counter = UseCompiler || CountCompiledCalls || LogTouchedMethods;
1216 
1217   // -----------------------------------------------------------------------------
1218   // Allocate a new frame that represents the native callee (i2n frame).
1219   // This is not a full-blown interpreter frame, but in particular, the
1220   // following registers are valid after this:
1221   // - R19_method
1222   // - R18_local (points to start of arguments to native function)
1223   //
1224   //   abstract stack (grows up)
1225   //     [  IJava (caller of JNI callee)  ]  &lt;-- ASP
1226   //        ...
1227 
1228   const Register signature_handler_fd = R11_scratch1;
1229   const Register pending_exception    = R0;
1230   const Register result_handler_addr  = R31;
1231   const Register native_method_fd     = R11_scratch1;
1232   const Register access_flags         = R22_tmp2;
1233   const Register active_handles       = R11_scratch1; // R26_monitor saved to state.
1234   const Register sync_state           = R12_scratch2;
1235   const Register sync_state_addr      = sync_state;   // Address is dead after use.
1236   const Register suspend_flags        = R11_scratch1;
1237 
1238   //=============================================================================
1239   // Allocate new frame and initialize interpreter state.
1240 
1241   Label exception_return;
1242   Label exception_return_sync_check;
1243   Label stack_overflow_return;
1244 
1245   // Generate new interpreter state and jump to stack_overflow_return in case of
1246   // a stack overflow.
1247   //generate_compute_interpreter_state(stack_overflow_return);
1248 
1249   Register size_of_parameters = R22_tmp2;
1250 
1251   generate_fixed_frame(true, size_of_parameters, noreg /* unused */);
1252 
1253   //=============================================================================
1254   // Increment invocation counter. On overflow, entry to JNI method
1255   // will be compiled.
1256   Label invocation_counter_overflow, continue_after_compile;
1257   if (inc_counter) {
1258     if (synchronized) {
1259       // Since at this point in the method invocation the exception handler
1260       // would try to exit the monitor of synchronized methods which hasn&#39;t
1261       // been entered yet, we set the thread local variable
1262       // _do_not_unlock_if_synchronized to true. If any exception was thrown by
1263       // runtime, exception handling i.e. unlock_if_synchronized_method will
1264       // check this thread local flag.
1265       // This flag has two effects, one is to force an unwind in the topmost
1266       // interpreter frame and not perform an unlock while doing so.
1267       __ li(R0, 1);
1268       __ stb(R0, in_bytes(JavaThread::do_not_unlock_if_synchronized_offset()), R16_thread);
1269     }
1270     generate_counter_incr(&amp;invocation_counter_overflow, NULL, NULL);
1271 
1272     BIND(continue_after_compile);
1273   }
1274 
1275   bang_stack_shadow_pages(true);
1276 
1277   if (inc_counter) {
1278     // Reset the _do_not_unlock_if_synchronized flag.
1279     if (synchronized) {
1280       __ li(R0, 0);
1281       __ stb(R0, in_bytes(JavaThread::do_not_unlock_if_synchronized_offset()), R16_thread);
1282     }
1283   }
1284 
1285   // access_flags = method-&gt;access_flags();
1286   // Load access flags.
1287   assert(access_flags-&gt;is_nonvolatile(),
1288          &quot;access_flags must be in a non-volatile register&quot;);
1289   // Type check.
1290   assert(4 == sizeof(AccessFlags), &quot;unexpected field size&quot;);
1291   __ lwz(access_flags, method_(access_flags));
1292 
1293   // We don&#39;t want to reload R19_method and access_flags after calls
1294   // to some helper functions.
1295   assert(R19_method-&gt;is_nonvolatile(),
1296          &quot;R19_method must be a non-volatile register&quot;);
1297 
1298   // Check for synchronized methods. Must happen AFTER invocation counter
1299   // check, so method is not locked if counter overflows.
1300 
1301   if (synchronized) {
1302     lock_method(access_flags, R11_scratch1, R12_scratch2, true);
1303 
1304     // Update monitor in state.
1305     __ ld(R11_scratch1, 0, R1_SP);
1306     __ std(R26_monitor, _ijava_state_neg(monitors), R11_scratch1);
1307   }
1308 
1309   // jvmti/jvmpi support
1310   __ notify_method_entry();
1311 
1312   //=============================================================================
1313   // Get and call the signature handler.
1314 
1315   __ ld(signature_handler_fd, method_(signature_handler));
1316   Label call_signature_handler;
1317 
1318   __ cmpdi(CCR0, signature_handler_fd, 0);
1319   __ bne(CCR0, call_signature_handler);
1320 
1321   // Method has never been called. Either generate a specialized
1322   // handler or point to the slow one.
1323   //
1324   // Pass parameter &#39;false&#39; to avoid exception check in call_VM.
1325   __ call_VM(noreg, CAST_FROM_FN_PTR(address, InterpreterRuntime::prepare_native_call), R19_method, false);
1326 
1327   // Check for an exception while looking up the target method. If we
1328   // incurred one, bail.
1329   __ ld(pending_exception, thread_(pending_exception));
1330   __ cmpdi(CCR0, pending_exception, 0);
1331   __ bne(CCR0, exception_return_sync_check); // Has pending exception.
1332 
1333   // Reload signature handler, it may have been created/assigned in the meanwhile.
1334   __ ld(signature_handler_fd, method_(signature_handler));
1335   __ twi_0(signature_handler_fd); // Order wrt. load of klass mirror and entry point (isync is below).
1336 
1337   BIND(call_signature_handler);
1338 
1339   // Before we call the signature handler we push a new frame to
1340   // protect the interpreter frame volatile registers when we return
1341   // from jni but before we can get back to Java.
1342 
1343   // First set the frame anchor while the SP/FP registers are
1344   // convenient and the slow signature handler can use this same frame
1345   // anchor.
1346 
1347   // We have a TOP_IJAVA_FRAME here, which belongs to us.
1348   __ set_top_ijava_frame_at_SP_as_last_Java_frame(R1_SP, R12_scratch2/*tmp*/);
1349 
1350   // Now the interpreter frame (and its call chain) have been
1351   // invalidated and flushed. We are now protected against eager
1352   // being enabled in native code. Even if it goes eager the
1353   // registers will be reloaded as clean and we will invalidate after
1354   // the call so no spurious flush should be possible.
1355 
1356   // Call signature handler and pass locals address.
1357   //
1358   // Our signature handlers copy required arguments to the C stack
1359   // (outgoing C args), R3_ARG1 to R10_ARG8, and FARG1 to FARG13.
1360   __ mr(R3_ARG1, R18_locals);
1361 #if !defined(ABI_ELFv2)
1362   __ ld(signature_handler_fd, 0, signature_handler_fd);
1363 #endif
1364 
1365   __ call_stub(signature_handler_fd);
1366 
1367   // Remove the register parameter varargs slots we allocated in
1368   // compute_interpreter_state. SP+16 ends up pointing to the ABI
1369   // outgoing argument area.
1370   //
1371   // Not needed on PPC64.
1372   //__ add(SP, SP, Argument::n_register_parameters*BytesPerWord);
1373 
1374   assert(result_handler_addr-&gt;is_nonvolatile(), &quot;result_handler_addr must be in a non-volatile register&quot;);
1375   // Save across call to native method.
1376   __ mr(result_handler_addr, R3_RET);
1377 
1378   __ isync(); // Acquire signature handler before trying to fetch the native entry point and klass mirror.
1379 
1380   // Set up fixed parameters and call the native method.
1381   // If the method is static, get mirror into R4_ARG2.
1382   {
1383     Label method_is_not_static;
1384     // Access_flags is non-volatile and still, no need to restore it.
1385 
1386     // Restore access flags.
1387     __ testbitdi(CCR0, R0, access_flags, JVM_ACC_STATIC_BIT);
1388     __ bfalse(CCR0, method_is_not_static);
1389 
1390     __ ld(R11_scratch1, _abi(callers_sp), R1_SP);
1391     // Load mirror from interpreter frame.
1392     __ ld(R12_scratch2, _ijava_state_neg(mirror), R11_scratch1);
1393     // R4_ARG2 = &amp;state-&gt;_oop_temp;
1394     __ addi(R4_ARG2, R11_scratch1, _ijava_state_neg(oop_tmp));
1395     __ std(R12_scratch2/*mirror*/, _ijava_state_neg(oop_tmp), R11_scratch1);
1396     BIND(method_is_not_static);
1397   }
1398 
1399   // At this point, arguments have been copied off the stack into
1400   // their JNI positions. Oops are boxed in-place on the stack, with
1401   // handles copied to arguments. The result handler address is in a
1402   // register.
1403 
1404   // Pass JNIEnv address as first parameter.
1405   __ addir(R3_ARG1, thread_(jni_environment));
1406 
1407   // Load the native_method entry before we change the thread state.
1408   __ ld(native_method_fd, method_(native_function));
1409 
1410   //=============================================================================
1411   // Transition from _thread_in_Java to _thread_in_native. As soon as
1412   // we make this change the safepoint code needs to be certain that
1413   // the last Java frame we established is good. The pc in that frame
1414   // just needs to be near here not an actual return address.
1415 
1416   // We use release_store_fence to update values like the thread state, where
1417   // we don&#39;t want the current thread to continue until all our prior memory
1418   // accesses (including the new thread state) are visible to other threads.
1419   __ li(R0, _thread_in_native);
1420   __ release();
1421 
1422   // TODO PPC port assert(4 == JavaThread::sz_thread_state(), &quot;unexpected field size&quot;);
1423   __ stw(R0, thread_(thread_state));
1424 
1425   //=============================================================================
1426   // Call the native method. Argument registers must not have been
1427   // overwritten since &quot;__ call_stub(signature_handler);&quot; (except for
1428   // ARG1 and ARG2 for static methods).
1429   __ call_c(native_method_fd);
1430 
1431   __ li(R0, 0);
1432   __ ld(R11_scratch1, 0, R1_SP);
1433   __ std(R3_RET, _ijava_state_neg(lresult), R11_scratch1);
1434   __ stfd(F1_RET, _ijava_state_neg(fresult), R11_scratch1);
1435   __ std(R0/*mirror*/, _ijava_state_neg(oop_tmp), R11_scratch1); // reset
1436 
1437   // Note: C++ interpreter needs the following here:
1438   // The frame_manager_lr field, which we use for setting the last
1439   // java frame, gets overwritten by the signature handler. Restore
1440   // it now.
1441   //__ get_PC_trash_LR(R11_scratch1);
1442   //__ std(R11_scratch1, _top_ijava_frame_abi(frame_manager_lr), R1_SP);
1443 
1444   // Because of GC R19_method may no longer be valid.
1445 
1446   // Block, if necessary, before resuming in _thread_in_Java state.
1447   // In order for GC to work, don&#39;t clear the last_Java_sp until after
1448   // blocking.
1449 
1450   //=============================================================================
1451   // Switch thread to &quot;native transition&quot; state before reading the
1452   // synchronization state. This additional state is necessary
1453   // because reading and testing the synchronization state is not
1454   // atomic w.r.t. GC, as this scenario demonstrates: Java thread A,
1455   // in _thread_in_native state, loads _not_synchronized and is
1456   // preempted. VM thread changes sync state to synchronizing and
1457   // suspends threads for GC. Thread A is resumed to finish this
1458   // native method, but doesn&#39;t block here since it didn&#39;t see any
1459   // synchronization in progress, and escapes.
1460 
1461   // We use release_store_fence to update values like the thread state, where
1462   // we don&#39;t want the current thread to continue until all our prior memory
1463   // accesses (including the new thread state) are visible to other threads.
1464   __ li(R0/*thread_state*/, _thread_in_native_trans);
1465   __ release();
1466   __ stw(R0/*thread_state*/, thread_(thread_state));
1467   __ fence();
1468 
1469   // Now before we return to java we must look for a current safepoint
1470   // (a new safepoint can not start since we entered native_trans).
1471   // We must check here because a current safepoint could be modifying
1472   // the callers registers right this moment.
1473 
1474   // Acquire isn&#39;t strictly necessary here because of the fence, but
1475   // sync_state is declared to be volatile, so we do it anyway
1476   // (cmp-br-isync on one path, release (same as acquire on PPC64) on the other path).
1477 
1478   Label do_safepoint, sync_check_done;
1479   // No synchronization in progress nor yet synchronized.
1480   __ safepoint_poll(do_safepoint, sync_state);
1481 
1482   // Not suspended.
1483   // TODO PPC port assert(4 == Thread::sz_suspend_flags(), &quot;unexpected field size&quot;);
1484   __ lwz(suspend_flags, thread_(suspend_flags));
1485   __ cmpwi(CCR1, suspend_flags, 0);
1486   __ beq(CCR1, sync_check_done);
1487 
1488   __ bind(do_safepoint);
1489   __ isync();
1490   // Block. We do the call directly and leave the current
1491   // last_Java_frame setup undisturbed. We must save any possible
1492   // native result across the call. No oop is present.
1493 
1494   __ mr(R3_ARG1, R16_thread);
1495 #if defined(ABI_ELFv2)
1496   __ call_c(CAST_FROM_FN_PTR(address, JavaThread::check_special_condition_for_native_trans),
1497             relocInfo::none);
1498 #else
1499   __ call_c(CAST_FROM_FN_PTR(FunctionDescriptor*, JavaThread::check_special_condition_for_native_trans),
1500             relocInfo::none);
1501 #endif
1502 
1503   __ bind(sync_check_done);
1504 
1505   //=============================================================================
1506   // &lt;&lt;&lt;&lt;&lt;&lt; Back in Interpreter Frame &gt;&gt;&gt;&gt;&gt;
1507 
1508   // We are in thread_in_native_trans here and back in the normal
1509   // interpreter frame. We don&#39;t have to do anything special about
1510   // safepoints and we can switch to Java mode anytime we are ready.
1511 
1512   // Note: frame::interpreter_frame_result has a dependency on how the
1513   // method result is saved across the call to post_method_exit. For
1514   // native methods it assumes that the non-FPU/non-void result is
1515   // saved in _native_lresult and a FPU result in _native_fresult. If
1516   // this changes then the interpreter_frame_result implementation
1517   // will need to be updated too.
1518 
1519   // On PPC64, we have stored the result directly after the native call.
1520 
1521   //=============================================================================
1522   // Back in Java
1523 
1524   // We use release_store_fence to update values like the thread state, where
1525   // we don&#39;t want the current thread to continue until all our prior memory
1526   // accesses (including the new thread state) are visible to other threads.
1527   __ li(R0/*thread_state*/, _thread_in_Java);
1528   __ lwsync(); // Acquire safepoint and suspend state, release thread state.
1529   __ stw(R0/*thread_state*/, thread_(thread_state));
1530 
1531   if (CheckJNICalls) {
1532     // clear_pending_jni_exception_check
1533     __ load_const_optimized(R0, 0L);
1534     __ st_ptr(R0, JavaThread::pending_jni_exception_check_fn_offset(), R16_thread);
1535   }
1536 
1537   __ reset_last_Java_frame();
1538 
1539   // Jvmdi/jvmpi support. Whether we&#39;ve got an exception pending or
1540   // not, and whether unlocking throws an exception or not, we notify
1541   // on native method exit. If we do have an exception, we&#39;ll end up
1542   // in the caller&#39;s context to handle it, so if we don&#39;t do the
1543   // notify here, we&#39;ll drop it on the floor.
1544   __ notify_method_exit(true/*native method*/,
1545                         ilgl /*illegal state (not used for native methods)*/,
1546                         InterpreterMacroAssembler::NotifyJVMTI,
1547                         false /*check_exceptions*/);
1548 
1549   //=============================================================================
1550   // Handle exceptions
1551 
1552   if (synchronized) {
1553     // Don&#39;t check for exceptions since we&#39;re still in the i2n frame. Do that
1554     // manually afterwards.
1555     __ unlock_object(R26_monitor, false); // Can also unlock methods.
1556   }
1557 
1558   // Reset active handles after returning from native.
1559   // thread-&gt;active_handles()-&gt;clear();
1560   __ ld(active_handles, thread_(active_handles));
1561   // TODO PPC port assert(4 == JNIHandleBlock::top_size_in_bytes(), &quot;unexpected field size&quot;);
1562   __ li(R0, 0);
1563   __ stw(R0, JNIHandleBlock::top_offset_in_bytes(), active_handles);
1564 
1565   Label exception_return_sync_check_already_unlocked;
1566   __ ld(R0/*pending_exception*/, thread_(pending_exception));
1567   __ cmpdi(CCR0, R0/*pending_exception*/, 0);
1568   __ bne(CCR0, exception_return_sync_check_already_unlocked);
1569 
1570   //-----------------------------------------------------------------------------
1571   // No exception pending.
1572 
1573   // Move native method result back into proper registers and return.
1574   // Invoke result handler (may unbox/promote).
1575   __ ld(R11_scratch1, 0, R1_SP);
1576   __ ld(R3_RET, _ijava_state_neg(lresult), R11_scratch1);
1577   __ lfd(F1_RET, _ijava_state_neg(fresult), R11_scratch1);
1578   __ call_stub(result_handler_addr);
1579 
1580   __ merge_frames(/*top_frame_sp*/ R21_sender_SP, /*return_pc*/ R0, R11_scratch1, R12_scratch2);
1581 
1582   // Must use the return pc which was loaded from the caller&#39;s frame
1583   // as the VM uses return-pc-patching for deoptimization.
1584   __ mtlr(R0);
1585   __ blr();
1586 
1587   //-----------------------------------------------------------------------------
1588   // An exception is pending. We call into the runtime only if the
1589   // caller was not interpreted. If it was interpreted the
1590   // interpreter will do the correct thing. If it isn&#39;t interpreted
1591   // (call stub/compiled code) we will change our return and continue.
1592 
1593   BIND(exception_return_sync_check);
1594 
1595   if (synchronized) {
1596     // Don&#39;t check for exceptions since we&#39;re still in the i2n frame. Do that
1597     // manually afterwards.
1598     __ unlock_object(R26_monitor, false); // Can also unlock methods.
1599   }
1600   BIND(exception_return_sync_check_already_unlocked);
1601 
1602   const Register return_pc = R31;
1603 
1604   __ ld(return_pc, 0, R1_SP);
1605   __ ld(return_pc, _abi(lr), return_pc);
1606 
1607   // Get the address of the exception handler.
1608   __ call_VM_leaf(CAST_FROM_FN_PTR(address, SharedRuntime::exception_handler_for_return_address),
1609                   R16_thread,
1610                   return_pc /* return pc */);
1611   __ merge_frames(/*top_frame_sp*/ R21_sender_SP, noreg, R11_scratch1, R12_scratch2);
1612 
1613   // Load the PC of the the exception handler into LR.
1614   __ mtlr(R3_RET);
1615 
1616   // Load exception into R3_ARG1 and clear pending exception in thread.
1617   __ ld(R3_ARG1/*exception*/, thread_(pending_exception));
1618   __ li(R4_ARG2, 0);
1619   __ std(R4_ARG2, thread_(pending_exception));
1620 
1621   // Load the original return pc into R4_ARG2.
1622   __ mr(R4_ARG2/*issuing_pc*/, return_pc);
1623 
1624   // Return to exception handler.
1625   __ blr();
1626 
1627   //=============================================================================
1628   // Counter overflow.
1629 
1630   if (inc_counter) {
1631     // Handle invocation counter overflow.
1632     __ bind(invocation_counter_overflow);
1633 
1634     generate_counter_overflow(continue_after_compile);
1635   }
1636 
1637   return entry;
1638 }
1639 
1640 // Generic interpreted method entry to (asm) interpreter.
1641 //
1642 address TemplateInterpreterGenerator::generate_normal_entry(bool synchronized) {
1643   bool inc_counter = UseCompiler || CountCompiledCalls || LogTouchedMethods;
1644   address entry = __ pc();
1645   // Generate the code to allocate the interpreter stack frame.
1646   Register Rsize_of_parameters = R4_ARG2, // Written by generate_fixed_frame.
1647            Rsize_of_locals     = R5_ARG3; // Written by generate_fixed_frame.
1648 
1649   // Does also a stack check to assure this frame fits on the stack.
1650   generate_fixed_frame(false, Rsize_of_parameters, Rsize_of_locals);
1651 
1652   // --------------------------------------------------------------------------
1653   // Zero out non-parameter locals.
1654   // Note: *Always* zero out non-parameter locals as Sparc does. It&#39;s not
1655   // worth to ask the flag, just do it.
1656   Register Rslot_addr = R6_ARG4,
1657            Rnum       = R7_ARG5;
1658   Label Lno_locals, Lzero_loop;
1659 
1660   // Set up the zeroing loop.
1661   __ subf(Rnum, Rsize_of_parameters, Rsize_of_locals);
1662   __ subf(Rslot_addr, Rsize_of_parameters, R18_locals);
1663   __ srdi_(Rnum, Rnum, Interpreter::logStackElementSize);
1664   __ beq(CCR0, Lno_locals);
1665   __ li(R0, 0);
1666   __ mtctr(Rnum);
1667 
1668   // The zero locals loop.
1669   __ bind(Lzero_loop);
1670   __ std(R0, 0, Rslot_addr);
1671   __ addi(Rslot_addr, Rslot_addr, -Interpreter::stackElementSize);
1672   __ bdnz(Lzero_loop);
1673 
1674   __ bind(Lno_locals);
1675 
1676   // --------------------------------------------------------------------------
1677   // Counter increment and overflow check.
1678   Label invocation_counter_overflow,
1679         profile_method,
1680         profile_method_continue;
1681   if (inc_counter || ProfileInterpreter) {
1682 
1683     Register Rdo_not_unlock_if_synchronized_addr = R11_scratch1;
1684     if (synchronized) {
1685       // Since at this point in the method invocation the exception handler
1686       // would try to exit the monitor of synchronized methods which hasn&#39;t
1687       // been entered yet, we set the thread local variable
1688       // _do_not_unlock_if_synchronized to true. If any exception was thrown by
1689       // runtime, exception handling i.e. unlock_if_synchronized_method will
1690       // check this thread local flag.
1691       // This flag has two effects, one is to force an unwind in the topmost
1692       // interpreter frame and not perform an unlock while doing so.
1693       __ li(R0, 1);
1694       __ stb(R0, in_bytes(JavaThread::do_not_unlock_if_synchronized_offset()), R16_thread);
1695     }
1696 
1697     // Argument and return type profiling.
1698     __ profile_parameters_type(R3_ARG1, R4_ARG2, R5_ARG3, R6_ARG4);
1699 
1700     // Increment invocation counter and check for overflow.
1701     if (inc_counter) {
1702       generate_counter_incr(&amp;invocation_counter_overflow, &amp;profile_method, &amp;profile_method_continue);
1703     }
1704 
1705     __ bind(profile_method_continue);
1706   }
1707 
1708   bang_stack_shadow_pages(false);
1709 
1710   if (inc_counter || ProfileInterpreter) {
1711     // Reset the _do_not_unlock_if_synchronized flag.
1712     if (synchronized) {
1713       __ li(R0, 0);
1714       __ stb(R0, in_bytes(JavaThread::do_not_unlock_if_synchronized_offset()), R16_thread);
1715     }
1716   }
1717 
1718   // --------------------------------------------------------------------------
1719   // Locking of synchronized methods. Must happen AFTER invocation_counter
1720   // check and stack overflow check, so method is not locked if overflows.
1721   if (synchronized) {
1722     lock_method(R3_ARG1, R4_ARG2, R5_ARG3);
1723   }
1724 #ifdef ASSERT
1725   else {
1726     Label Lok;
1727     __ lwz(R0, in_bytes(Method::access_flags_offset()), R19_method);
1728     __ andi_(R0, R0, JVM_ACC_SYNCHRONIZED);
1729     __ asm_assert_eq(&quot;method needs synchronization&quot;);
1730     __ bind(Lok);
1731   }
1732 #endif // ASSERT
1733 
1734   __ verify_thread();
1735 
1736   // --------------------------------------------------------------------------
1737   // JVMTI support
1738   __ notify_method_entry();
1739 
1740   // --------------------------------------------------------------------------
1741   // Start executing instructions.
1742   __ dispatch_next(vtos);
1743 
1744   // --------------------------------------------------------------------------
1745   // Out of line counter overflow and MDO creation code.
1746   if (ProfileInterpreter) {
1747     // We have decided to profile this method in the interpreter.
1748     __ bind(profile_method);
1749     __ call_VM(noreg, CAST_FROM_FN_PTR(address, InterpreterRuntime::profile_method));
1750     __ set_method_data_pointer_for_bcp();
1751     __ b(profile_method_continue);
1752   }
1753 
1754   if (inc_counter) {
1755     // Handle invocation counter overflow.
1756     __ bind(invocation_counter_overflow);
1757     generate_counter_overflow(profile_method_continue);
1758   }
1759   return entry;
1760 }
1761 
1762 // CRC32 Intrinsics.
1763 //
1764 // Contract on scratch and work registers.
1765 // =======================================
1766 //
1767 // On ppc, the register set {R2..R12} is available in the interpreter as scratch/work registers.
1768 // You should, however, keep in mind that {R3_ARG1..R10_ARG8} is the C-ABI argument register set.
1769 // You can&#39;t rely on these registers across calls.
1770 //
1771 // The generators for CRC32_update and for CRC32_updateBytes use the
1772 // scratch/work register set internally, passing the work registers
1773 // as arguments to the MacroAssembler emitters as required.
1774 //
1775 // R3_ARG1..R6_ARG4 are preset to hold the incoming java arguments.
1776 // Their contents is not constant but may change according to the requirements
1777 // of the emitted code.
1778 //
1779 // All other registers from the scratch/work register set are used &quot;internally&quot;
1780 // and contain garbage (i.e. unpredictable values) once blr() is reached.
1781 // Basically, only R3_RET contains a defined value which is the function result.
1782 //
1783 /**
1784  * Method entry for static native methods:
1785  *   int java.util.zip.CRC32.update(int crc, int b)
1786  */
1787 address TemplateInterpreterGenerator::generate_CRC32_update_entry() {
1788   if (UseCRC32Intrinsics) {
1789     address start = __ pc();  // Remember stub start address (is rtn value).
1790     Label slow_path;
1791 
1792     // Safepoint check
1793     const Register sync_state = R11_scratch1;
1794     __ safepoint_poll(slow_path, sync_state);
1795 
1796     // We don&#39;t generate local frame and don&#39;t align stack because
1797     // we not even call stub code (we generate the code inline)
1798     // and there is no safepoint on this path.
1799 
1800     // Load java parameters.
1801     // R15_esp is callers operand stack pointer, i.e. it points to the parameters.
1802     const Register argP    = R15_esp;
1803     const Register crc     = R3_ARG1;  // crc value
1804     const Register data    = R4_ARG2;
1805     const Register table   = R5_ARG3;  // address of crc32 table
1806 
1807     BLOCK_COMMENT(&quot;CRC32_update {&quot;);
1808 
1809     // Arguments are reversed on java expression stack
1810 #ifdef VM_LITTLE_ENDIAN
1811     int data_offs = 0+1*wordSize;      // (stack) address of byte value. Emitter expects address, not value.
1812                                        // Being passed as an int, the single byte is at offset +0.
1813 #else
1814     int data_offs = 3+1*wordSize;      // (stack) address of byte value. Emitter expects address, not value.
1815                                        // Being passed from java as an int, the single byte is at offset +3.
1816 #endif
1817     __ lwz(crc, 2*wordSize, argP);     // Current crc state, zero extend to 64 bit to have a clean register.
1818     __ lbz(data, data_offs, argP);     // Byte from buffer, zero-extended.
1819     __ load_const_optimized(table, StubRoutines::crc_table_addr(), R0);
1820     __ kernel_crc32_singleByteReg(crc, data, table, true);
1821 
1822     // Restore caller sp for c2i case (from compiled) and for resized sender frame (from interpreted).
1823     __ resize_frame_absolute(R21_sender_SP, R11_scratch1, R0);
1824     __ blr();
1825 
1826     // Generate a vanilla native entry as the slow path.
1827     BLOCK_COMMENT(&quot;} CRC32_update&quot;);
1828     BIND(slow_path);
1829     __ jump_to_entry(Interpreter::entry_for_kind(Interpreter::native), R11_scratch1);
1830     return start;
1831   }
1832 
1833   return NULL;
1834 }
1835 
1836 /**
1837  * Method entry for static native methods:
1838  *   int java.util.zip.CRC32.updateBytes(     int crc, byte[] b,  int off, int len)
1839  *   int java.util.zip.CRC32.updateByteBuffer(int crc, long* buf, int off, int len)
1840  */
1841 address TemplateInterpreterGenerator::generate_CRC32_updateBytes_entry(AbstractInterpreter::MethodKind kind) {
1842   if (UseCRC32Intrinsics) {
1843     address start = __ pc();  // Remember stub start address (is rtn value).
1844     Label slow_path;
1845 
1846     // Safepoint check
1847     const Register sync_state = R11_scratch1;
1848     __ safepoint_poll(slow_path, sync_state);
1849 
1850     // We don&#39;t generate local frame and don&#39;t align stack because
1851     // we not even call stub code (we generate the code inline)
1852     // and there is no safepoint on this path.
1853 
1854     // Load parameters.
1855     // Z_esp is callers operand stack pointer, i.e. it points to the parameters.
1856     const Register argP    = R15_esp;
1857     const Register crc     = R3_ARG1;  // crc value
1858     const Register data    = R4_ARG2;  // address of java byte array
1859     const Register dataLen = R5_ARG3;  // source data len
1860     const Register tmp     = R11_scratch1;
1861 
1862     // Arguments are reversed on java expression stack.
1863     // Calculate address of start element.
1864     if (kind == Interpreter::java_util_zip_CRC32_updateByteBuffer) { // Used for &quot;updateByteBuffer direct&quot;.
1865       BLOCK_COMMENT(&quot;CRC32_updateByteBuffer {&quot;);
1866       // crc     @ (SP + 5W) (32bit)
1867       // buf     @ (SP + 3W) (64bit ptr to long array)
1868       // off     @ (SP + 2W) (32bit)
1869       // dataLen @ (SP + 1W) (32bit)
1870       // data = buf + off
1871       __ ld(  data,    3*wordSize, argP);  // start of byte buffer
1872       __ lwa( tmp,     2*wordSize, argP);  // byte buffer offset
1873       __ lwa( dataLen, 1*wordSize, argP);  // #bytes to process
1874       __ lwz( crc,     5*wordSize, argP);  // current crc state
1875       __ add( data, data, tmp);            // Add byte buffer offset.
1876     } else {                                                         // Used for &quot;updateBytes update&quot;.
1877       BLOCK_COMMENT(&quot;CRC32_updateBytes {&quot;);
1878       // crc     @ (SP + 4W) (32bit)
1879       // buf     @ (SP + 3W) (64bit ptr to byte array)
1880       // off     @ (SP + 2W) (32bit)
1881       // dataLen @ (SP + 1W) (32bit)
1882       // data = buf + off + base_offset
1883       __ ld(  data,    3*wordSize, argP);  // start of byte buffer
1884       __ lwa( tmp,     2*wordSize, argP);  // byte buffer offset
1885       __ lwa( dataLen, 1*wordSize, argP);  // #bytes to process
1886       __ add( data, data, tmp);            // add byte buffer offset
1887       __ lwz( crc,     4*wordSize, argP);  // current crc state
1888       __ addi(data, data, arrayOopDesc::base_offset_in_bytes(T_BYTE));
1889     }
1890 
1891     __ crc32(crc, data, dataLen, R2, R6, R7, R8, R9, R10, R11, R12, false);
1892 
1893     // Restore caller sp for c2i case (from compiled) and for resized sender frame (from interpreted).
1894     __ resize_frame_absolute(R21_sender_SP, R11_scratch1, R0);
1895     __ blr();
1896 
1897     // Generate a vanilla native entry as the slow path.
1898     BLOCK_COMMENT(&quot;} CRC32_updateBytes(Buffer)&quot;);
1899     BIND(slow_path);
1900     __ jump_to_entry(Interpreter::entry_for_kind(Interpreter::native), R11_scratch1);
1901     return start;
1902   }
1903 
1904   return NULL;
1905 }
1906 
1907 
1908 /**
1909  * Method entry for intrinsic-candidate (non-native) methods:
1910  *   int java.util.zip.CRC32C.updateBytes(           int crc, byte[] b,  int off, int end)
1911  *   int java.util.zip.CRC32C.updateDirectByteBuffer(int crc, long* buf, int off, int end)
1912  * Unlike CRC32, CRC32C does not have any methods marked as native
1913  * CRC32C also uses an &quot;end&quot; variable instead of the length variable CRC32 uses
1914  **/
1915 address TemplateInterpreterGenerator::generate_CRC32C_updateBytes_entry(AbstractInterpreter::MethodKind kind) {
1916   if (UseCRC32CIntrinsics) {
1917     address start = __ pc();  // Remember stub start address (is rtn value).
1918 
1919     // We don&#39;t generate local frame and don&#39;t align stack because
1920     // we not even call stub code (we generate the code inline)
1921     // and there is no safepoint on this path.
1922 
1923     // Load parameters.
1924     // Z_esp is callers operand stack pointer, i.e. it points to the parameters.
1925     const Register argP    = R15_esp;
1926     const Register crc     = R3_ARG1;  // crc value
1927     const Register data    = R4_ARG2;  // address of java byte array
1928     const Register dataLen = R5_ARG3;  // source data len
1929     const Register tmp     = R11_scratch1;
1930 
1931     // Arguments are reversed on java expression stack.
1932     // Calculate address of start element.
1933     if (kind == Interpreter::java_util_zip_CRC32C_updateDirectByteBuffer) { // Used for &quot;updateDirectByteBuffer&quot;.
1934       BLOCK_COMMENT(&quot;CRC32C_updateDirectByteBuffer {&quot;);
1935       // crc     @ (SP + 5W) (32bit)
1936       // buf     @ (SP + 3W) (64bit ptr to long array)
1937       // off     @ (SP + 2W) (32bit)
1938       // dataLen @ (SP + 1W) (32bit)
1939       // data = buf + off
1940       __ ld(  data,    3*wordSize, argP);  // start of byte buffer
1941       __ lwa( tmp,     2*wordSize, argP);  // byte buffer offset
1942       __ lwa( dataLen, 1*wordSize, argP);  // #bytes to process
1943       __ lwz( crc,     5*wordSize, argP);  // current crc state
1944       __ add( data, data, tmp);            // Add byte buffer offset.
1945       __ sub( dataLen, dataLen, tmp);      // (end_index - offset)
1946     } else {                                                         // Used for &quot;updateBytes update&quot;.
1947       BLOCK_COMMENT(&quot;CRC32C_updateBytes {&quot;);
1948       // crc     @ (SP + 4W) (32bit)
1949       // buf     @ (SP + 3W) (64bit ptr to byte array)
1950       // off     @ (SP + 2W) (32bit)
1951       // dataLen @ (SP + 1W) (32bit)
1952       // data = buf + off + base_offset
1953       __ ld(  data,    3*wordSize, argP);  // start of byte buffer
1954       __ lwa( tmp,     2*wordSize, argP);  // byte buffer offset
1955       __ lwa( dataLen, 1*wordSize, argP);  // #bytes to process
1956       __ add( data, data, tmp);            // add byte buffer offset
1957       __ sub( dataLen, dataLen, tmp);      // (end_index - offset)
1958       __ lwz( crc,     4*wordSize, argP);  // current crc state
1959       __ addi(data, data, arrayOopDesc::base_offset_in_bytes(T_BYTE));
1960     }
1961 
1962     __ crc32(crc, data, dataLen, R2, R6, R7, R8, R9, R10, R11, R12, true);
1963 
1964     // Restore caller sp for c2i case (from compiled) and for resized sender frame (from interpreted).
1965     __ resize_frame_absolute(R21_sender_SP, R11_scratch1, R0);
1966     __ blr();
1967 
1968     BLOCK_COMMENT(&quot;} CRC32C_update{Bytes|DirectByteBuffer}&quot;);
1969     return start;
1970   }
1971 
1972   return NULL;
1973 }
1974 
1975 // =============================================================================
1976 // Exceptions
1977 
1978 void TemplateInterpreterGenerator::generate_throw_exception() {
1979   Register Rexception    = R17_tos,
1980            Rcontinuation = R3_RET;
1981 
1982   // --------------------------------------------------------------------------
1983   // Entry point if an method returns with a pending exception (rethrow).
1984   Interpreter::_rethrow_exception_entry = __ pc();
1985   {
1986     __ restore_interpreter_state(R11_scratch1); // Sets R11_scratch1 = fp.
1987     __ ld(R12_scratch2, _ijava_state_neg(top_frame_sp), R11_scratch1);
1988     __ resize_frame_absolute(R12_scratch2, R11_scratch1, R0);
1989 
1990     // Compiled code destroys templateTableBase, reload.
1991     __ load_const_optimized(R25_templateTableBase, (address)Interpreter::dispatch_table((TosState)0), R11_scratch1);
1992   }
1993 
1994   // Entry point if a interpreted method throws an exception (throw).
1995   Interpreter::_throw_exception_entry = __ pc();
1996   {
1997     __ mr(Rexception, R3_RET);
1998 
1999     __ verify_thread();
2000     __ verify_oop(Rexception);
2001 
2002     // Expression stack must be empty before entering the VM in case of an exception.
2003     __ empty_expression_stack();
2004     // Find exception handler address and preserve exception oop.
2005     // Call C routine to find handler and jump to it.
2006     __ call_VM(Rexception, CAST_FROM_FN_PTR(address, InterpreterRuntime::exception_handler_for_exception), Rexception);
2007     __ mtctr(Rcontinuation);
2008     // Push exception for exception handler bytecodes.
2009     __ push_ptr(Rexception);
2010 
2011     // Jump to exception handler (may be remove activation entry!).
2012     __ bctr();
2013   }
2014 
2015   // If the exception is not handled in the current frame the frame is
2016   // removed and the exception is rethrown (i.e. exception
2017   // continuation is _rethrow_exception).
2018   //
2019   // Note: At this point the bci is still the bxi for the instruction
2020   // which caused the exception and the expression stack is
2021   // empty. Thus, for any VM calls at this point, GC will find a legal
2022   // oop map (with empty expression stack).
2023 
2024   // In current activation
2025   // tos: exception
2026   // bcp: exception bcp
2027 
2028   // --------------------------------------------------------------------------
2029   // JVMTI PopFrame support
2030 
2031   Interpreter::_remove_activation_preserving_args_entry = __ pc();
2032   {
2033     // Set the popframe_processing bit in popframe_condition indicating that we are
2034     // currently handling popframe, so that call_VMs that may happen later do not
2035     // trigger new popframe handling cycles.
2036     __ lwz(R11_scratch1, in_bytes(JavaThread::popframe_condition_offset()), R16_thread);
2037     __ ori(R11_scratch1, R11_scratch1, JavaThread::popframe_processing_bit);
2038     __ stw(R11_scratch1, in_bytes(JavaThread::popframe_condition_offset()), R16_thread);
2039 
2040     // Empty the expression stack, as in normal exception handling.
2041     __ empty_expression_stack();
2042     __ unlock_if_synchronized_method(vtos, /* throw_monitor_exception */ false, /* install_monitor_exception */ false);
2043 
2044     // Check to see whether we are returning to a deoptimized frame.
2045     // (The PopFrame call ensures that the caller of the popped frame is
2046     // either interpreted or compiled and deoptimizes it if compiled.)
2047     // Note that we don&#39;t compare the return PC against the
2048     // deoptimization blob&#39;s unpack entry because of the presence of
2049     // adapter frames in C2.
2050     Label Lcaller_not_deoptimized;
2051     Register return_pc = R3_ARG1;
2052     __ ld(return_pc, 0, R1_SP);
2053     __ ld(return_pc, _abi(lr), return_pc);
2054     __ call_VM_leaf(CAST_FROM_FN_PTR(address, InterpreterRuntime::interpreter_contains), return_pc);
2055     __ cmpdi(CCR0, R3_RET, 0);
2056     __ bne(CCR0, Lcaller_not_deoptimized);
2057 
2058     // The deoptimized case.
2059     // In this case, we can&#39;t call dispatch_next() after the frame is
2060     // popped, but instead must save the incoming arguments and restore
2061     // them after deoptimization has occurred.
2062     __ ld(R4_ARG2, in_bytes(Method::const_offset()), R19_method);
2063     __ lhz(R4_ARG2 /* number of params */, in_bytes(ConstMethod::size_of_parameters_offset()), R4_ARG2);
2064     __ slwi(R4_ARG2, R4_ARG2, Interpreter::logStackElementSize);
2065     __ addi(R5_ARG3, R18_locals, Interpreter::stackElementSize);
2066     __ subf(R5_ARG3, R4_ARG2, R5_ARG3);
2067     // Save these arguments.
2068     __ call_VM_leaf(CAST_FROM_FN_PTR(address, Deoptimization::popframe_preserve_args), R16_thread, R4_ARG2, R5_ARG3);
2069 
2070     // Inform deoptimization that it is responsible for restoring these arguments.
2071     __ load_const_optimized(R11_scratch1, JavaThread::popframe_force_deopt_reexecution_bit);
2072     __ stw(R11_scratch1, in_bytes(JavaThread::popframe_condition_offset()), R16_thread);
2073 
2074     // Return from the current method into the deoptimization blob. Will eventually
2075     // end up in the deopt interpeter entry, deoptimization prepared everything that
2076     // we will reexecute the call that called us.
2077     __ merge_frames(/*top_frame_sp*/ R21_sender_SP, /*reload return_pc*/ return_pc, R11_scratch1, R12_scratch2);
2078     __ mtlr(return_pc);
2079     __ blr();
2080 
2081     // The non-deoptimized case.
2082     __ bind(Lcaller_not_deoptimized);
2083 
2084     // Clear the popframe condition flag.
2085     __ li(R0, 0);
2086     __ stw(R0, in_bytes(JavaThread::popframe_condition_offset()), R16_thread);
2087 
2088     // Get out of the current method and re-execute the call that called us.
2089     __ merge_frames(/*top_frame_sp*/ R21_sender_SP, /*return_pc*/ noreg, R11_scratch1, R12_scratch2);
2090     __ restore_interpreter_state(R11_scratch1);
2091     __ ld(R12_scratch2, _ijava_state_neg(top_frame_sp), R11_scratch1);
2092     __ resize_frame_absolute(R12_scratch2, R11_scratch1, R0);
2093     if (ProfileInterpreter) {
2094       __ set_method_data_pointer_for_bcp();
2095       __ ld(R11_scratch1, 0, R1_SP);
2096       __ std(R28_mdx, _ijava_state_neg(mdx), R11_scratch1);
2097     }
2098 #if INCLUDE_JVMTI
2099     Label L_done;
2100 
2101     __ lbz(R11_scratch1, 0, R14_bcp);
2102     __ cmpwi(CCR0, R11_scratch1, Bytecodes::_invokestatic);
2103     __ bne(CCR0, L_done);
2104 
2105     // The member name argument must be restored if _invokestatic is re-executed after a PopFrame call.
2106     // Detect such a case in the InterpreterRuntime function and return the member name argument, or NULL.
2107     __ ld(R4_ARG2, 0, R18_locals);
2108     __ call_VM(R4_ARG2, CAST_FROM_FN_PTR(address, InterpreterRuntime::member_name_arg_or_null), R4_ARG2, R19_method, R14_bcp);
2109     __ restore_interpreter_state(R11_scratch1, /*bcp_and_mdx_only*/ true);
2110     __ cmpdi(CCR0, R4_ARG2, 0);
2111     __ beq(CCR0, L_done);
2112     __ std(R4_ARG2, wordSize, R15_esp);
2113     __ bind(L_done);
2114 #endif // INCLUDE_JVMTI
2115     __ dispatch_next(vtos);
2116   }
2117   // end of JVMTI PopFrame support
2118 
2119   // --------------------------------------------------------------------------
2120   // Remove activation exception entry.
2121   // This is jumped to if an interpreted method can&#39;t handle an exception itself
2122   // (we come from the throw/rethrow exception entry above). We&#39;re going to call
2123   // into the VM to find the exception handler in the caller, pop the current
2124   // frame and return the handler we calculated.
2125   Interpreter::_remove_activation_entry = __ pc();
2126   {
2127     __ pop_ptr(Rexception);
2128     __ verify_thread();
2129     __ verify_oop(Rexception);
2130     __ std(Rexception, in_bytes(JavaThread::vm_result_offset()), R16_thread);
2131 
2132     __ unlock_if_synchronized_method(vtos, /* throw_monitor_exception */ false, true);
2133     __ notify_method_exit(false, vtos, InterpreterMacroAssembler::SkipNotifyJVMTI, false);
2134 
2135     __ get_vm_result(Rexception);
2136 
2137     // We are done with this activation frame; find out where to go next.
2138     // The continuation point will be an exception handler, which expects
2139     // the following registers set up:
2140     //
2141     // RET:  exception oop
2142     // ARG2: Issuing PC (see generate_exception_blob()), only used if the caller is compiled.
2143 
2144     Register return_pc = R31; // Needs to survive the runtime call.
2145     __ ld(return_pc, 0, R1_SP);
2146     __ ld(return_pc, _abi(lr), return_pc);
2147     __ call_VM_leaf(CAST_FROM_FN_PTR(address, SharedRuntime::exception_handler_for_return_address), R16_thread, return_pc);
2148 
2149     // Remove the current activation.
2150     __ merge_frames(/*top_frame_sp*/ R21_sender_SP, /*return_pc*/ noreg, R11_scratch1, R12_scratch2);
2151 
2152     __ mr(R4_ARG2, return_pc);
2153     __ mtlr(R3_RET);
2154     __ mr(R3_RET, Rexception);
2155     __ blr();
2156   }
2157 }
2158 
2159 // JVMTI ForceEarlyReturn support.
2160 // Returns &quot;in the middle&quot; of a method with a &quot;fake&quot; return value.
2161 address TemplateInterpreterGenerator::generate_earlyret_entry_for(TosState state) {
2162 
2163   Register Rscratch1 = R11_scratch1,
2164            Rscratch2 = R12_scratch2;
2165 
2166   address entry = __ pc();
2167   __ empty_expression_stack();
2168 
2169   __ load_earlyret_value(state, Rscratch1);
2170 
2171   __ ld(Rscratch1, in_bytes(JavaThread::jvmti_thread_state_offset()), R16_thread);
2172   // Clear the earlyret state.
2173   __ li(R0, 0);
2174   __ stw(R0, in_bytes(JvmtiThreadState::earlyret_state_offset()), Rscratch1);
2175 
2176   __ remove_activation(state, false, false);
2177   // Copied from TemplateTable::_return.
2178   // Restoration of lr done by remove_activation.
2179   switch (state) {
2180     // Narrow result if state is itos but result type is smaller.
2181     case btos:
2182     case ztos:
2183     case ctos:
2184     case stos:
2185     case itos: __ narrow(R17_tos); /* fall through */
2186     case ltos:
2187     case atos: __ mr(R3_RET, R17_tos); break;
2188     case ftos:
2189     case dtos: __ fmr(F1_RET, F15_ftos); break;
2190     case vtos: // This might be a constructor. Final fields (and volatile fields on PPC64) need
2191                // to get visible before the reference to the object gets stored anywhere.
2192                __ membar(Assembler::StoreStore); break;
2193     default  : ShouldNotReachHere();
2194   }
2195   __ blr();
2196 
2197   return entry;
2198 } // end of ForceEarlyReturn support
2199 
2200 //-----------------------------------------------------------------------------
2201 // Helper for vtos entry point generation
2202 
2203 void TemplateInterpreterGenerator::set_vtos_entry_points(Template* t,
2204                                                          address&amp; bep,
2205                                                          address&amp; cep,
2206                                                          address&amp; sep,
2207                                                          address&amp; aep,
2208                                                          address&amp; iep,
2209                                                          address&amp; lep,
2210                                                          address&amp; fep,
2211                                                          address&amp; dep,
2212                                                          address&amp; vep) {
2213   assert(t-&gt;is_valid() &amp;&amp; t-&gt;tos_in() == vtos, &quot;illegal template&quot;);
2214   Label L;
2215 
2216   aep = __ pc();  __ push_ptr();  __ b(L);
2217   fep = __ pc();  __ push_f();    __ b(L);
2218   dep = __ pc();  __ push_d();    __ b(L);
2219   lep = __ pc();  __ push_l();    __ b(L);
2220   __ align(32, 12, 24); // align L
2221   bep = cep = sep =
2222   iep = __ pc();  __ push_i();
2223   vep = __ pc();
2224   __ bind(L);
2225   generate_and_dispatch(t);
2226 }
2227 
2228 //-----------------------------------------------------------------------------
2229 
2230 // Non-product code
2231 #ifndef PRODUCT
2232 address TemplateInterpreterGenerator::generate_trace_code(TosState state) {
2233   //__ flush_bundle();
2234   address entry = __ pc();
2235 
2236   const char *bname = NULL;
2237   uint tsize = 0;
2238   switch(state) {
2239   case ftos:
2240     bname = &quot;trace_code_ftos {&quot;;
2241     tsize = 2;
2242     break;
2243   case btos:
2244     bname = &quot;trace_code_btos {&quot;;
2245     tsize = 2;
2246     break;
2247   case ztos:
2248     bname = &quot;trace_code_ztos {&quot;;
2249     tsize = 2;
2250     break;
2251   case ctos:
2252     bname = &quot;trace_code_ctos {&quot;;
2253     tsize = 2;
2254     break;
2255   case stos:
2256     bname = &quot;trace_code_stos {&quot;;
2257     tsize = 2;
2258     break;
2259   case itos:
2260     bname = &quot;trace_code_itos {&quot;;
2261     tsize = 2;
2262     break;
2263   case ltos:
2264     bname = &quot;trace_code_ltos {&quot;;
2265     tsize = 3;
2266     break;
2267   case atos:
2268     bname = &quot;trace_code_atos {&quot;;
2269     tsize = 2;
2270     break;
2271   case vtos:
2272     // Note: In case of vtos, the topmost of stack value could be a int or doubl
2273     // In case of a double (2 slots) we won&#39;t see the 2nd stack value.
2274     // Maybe we simply should print the topmost 3 stack slots to cope with the problem.
2275     bname = &quot;trace_code_vtos {&quot;;
2276     tsize = 2;
2277 
2278     break;
2279   case dtos:
2280     bname = &quot;trace_code_dtos {&quot;;
2281     tsize = 3;
2282     break;
2283   default:
2284     ShouldNotReachHere();
2285   }
2286   BLOCK_COMMENT(bname);
2287 
2288   // Support short-cut for TraceBytecodesAt.
2289   // Don&#39;t call into the VM if we don&#39;t want to trace to speed up things.
2290   Label Lskip_vm_call;
2291   if (TraceBytecodesAt &gt; 0 &amp;&amp; TraceBytecodesAt &lt; max_intx) {
2292     int offs1 = __ load_const_optimized(R11_scratch1, (address) &amp;TraceBytecodesAt, R0, true);
2293     int offs2 = __ load_const_optimized(R12_scratch2, (address) &amp;BytecodeCounter::_counter_value, R0, true);
2294     __ ld(R11_scratch1, offs1, R11_scratch1);
2295     __ lwa(R12_scratch2, offs2, R12_scratch2);
2296     __ cmpd(CCR0, R12_scratch2, R11_scratch1);
2297     __ blt(CCR0, Lskip_vm_call);
2298   }
2299 
2300   __ push(state);
2301   // Load 2 topmost expression stack values.
2302   __ ld(R6_ARG4, tsize*Interpreter::stackElementSize, R15_esp);
2303   __ ld(R5_ARG3, Interpreter::stackElementSize, R15_esp);
2304   __ mflr(R31);
2305   __ call_VM(noreg, CAST_FROM_FN_PTR(address, InterpreterRuntime::trace_bytecode), /* unused */ R4_ARG2, R5_ARG3, R6_ARG4, false);
2306   __ mtlr(R31);
2307   __ pop(state);
2308 
2309   if (TraceBytecodesAt &gt; 0 &amp;&amp; TraceBytecodesAt &lt; max_intx) {
2310     __ bind(Lskip_vm_call);
2311   }
2312   __ blr();
2313   BLOCK_COMMENT(&quot;} trace_code&quot;);
2314   return entry;
2315 }
2316 
2317 void TemplateInterpreterGenerator::count_bytecode() {
2318   int offs = __ load_const_optimized(R11_scratch1, (address) &amp;BytecodeCounter::_counter_value, R12_scratch2, true);
2319   __ lwz(R12_scratch2, offs, R11_scratch1);
2320   __ addi(R12_scratch2, R12_scratch2, 1);
2321   __ stw(R12_scratch2, offs, R11_scratch1);
2322 }
2323 
2324 void TemplateInterpreterGenerator::histogram_bytecode(Template* t) {
2325   int offs = __ load_const_optimized(R11_scratch1, (address) &amp;BytecodeHistogram::_counters[t-&gt;bytecode()], R12_scratch2, true);
2326   __ lwz(R12_scratch2, offs, R11_scratch1);
2327   __ addi(R12_scratch2, R12_scratch2, 1);
2328   __ stw(R12_scratch2, offs, R11_scratch1);
2329 }
2330 
2331 void TemplateInterpreterGenerator::histogram_bytecode_pair(Template* t) {
2332   const Register addr = R11_scratch1,
2333                  tmp  = R12_scratch2;
2334   // Get index, shift out old bytecode, bring in new bytecode, and store it.
2335   // _index = (_index &gt;&gt; log2_number_of_codes) |
2336   //          (bytecode &lt;&lt; log2_number_of_codes);
2337   int offs1 = __ load_const_optimized(addr, (address)&amp;BytecodePairHistogram::_index, tmp, true);
2338   __ lwz(tmp, offs1, addr);
2339   __ srwi(tmp, tmp, BytecodePairHistogram::log2_number_of_codes);
2340   __ ori(tmp, tmp, ((int) t-&gt;bytecode()) &lt;&lt; BytecodePairHistogram::log2_number_of_codes);
2341   __ stw(tmp, offs1, addr);
2342 
2343   // Bump bucket contents.
2344   // _counters[_index] ++;
2345   int offs2 = __ load_const_optimized(addr, (address)&amp;BytecodePairHistogram::_counters, R0, true);
2346   __ sldi(tmp, tmp, LogBytesPerInt);
2347   __ add(addr, tmp, addr);
2348   __ lwz(tmp, offs2, addr);
2349   __ addi(tmp, tmp, 1);
2350   __ stw(tmp, offs2, addr);
2351 }
2352 
2353 void TemplateInterpreterGenerator::trace_bytecode(Template* t) {
2354   // Call a little run-time stub to avoid blow-up for each bytecode.
2355   // The run-time runtime saves the right registers, depending on
2356   // the tosca in-state for the given template.
2357 
2358   assert(Interpreter::trace_code(t-&gt;tos_in()) != NULL,
2359          &quot;entry must have been generated&quot;);
2360 
2361   // Note: we destroy LR here.
2362   __ bl(Interpreter::trace_code(t-&gt;tos_in()));
2363 }
2364 
2365 void TemplateInterpreterGenerator::stop_interpreter_at() {
2366   Label L;
2367   int offs1 = __ load_const_optimized(R11_scratch1, (address) &amp;StopInterpreterAt, R0, true);
2368   int offs2 = __ load_const_optimized(R12_scratch2, (address) &amp;BytecodeCounter::_counter_value, R0, true);
2369   __ ld(R11_scratch1, offs1, R11_scratch1);
2370   __ lwa(R12_scratch2, offs2, R12_scratch2);
2371   __ cmpd(CCR0, R12_scratch2, R11_scratch1);
2372   __ bne(CCR0, L);
2373   __ illtrap();
2374   __ bind(L);
2375 }
2376 
2377 #endif // !PRODUCT
<a name="3" id="anc3"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="3" type="hidden" />
</body>
</html>