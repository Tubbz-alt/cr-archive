<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/hotspot/share/prims/jvm.cpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
  </head>
<body>
<center><a href="../opto/type.cpp.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="jvmti.xml.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/hotspot/share/prims/jvm.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  57 #include &quot;oops/oop.inline.hpp&quot;
  58 #include &quot;prims/jvm_misc.hpp&quot;
  59 #include &quot;prims/jvmtiExport.hpp&quot;
  60 #include &quot;prims/jvmtiThreadState.hpp&quot;
  61 #include &quot;prims/nativeLookup.hpp&quot;
  62 #include &quot;prims/stackwalk.hpp&quot;
  63 #include &quot;runtime/arguments.hpp&quot;
  64 #include &quot;runtime/atomic.hpp&quot;
  65 #include &quot;runtime/handles.inline.hpp&quot;
  66 #include &quot;runtime/init.hpp&quot;
  67 #include &quot;runtime/interfaceSupport.inline.hpp&quot;
  68 #include &quot;runtime/deoptimization.hpp&quot;
  69 #include &quot;runtime/handshake.hpp&quot;
  70 #include &quot;runtime/java.hpp&quot;
  71 #include &quot;runtime/javaCalls.hpp&quot;
  72 #include &quot;runtime/jfieldIDWorkaround.hpp&quot;
  73 #include &quot;runtime/jniHandles.inline.hpp&quot;
  74 #include &quot;runtime/os.inline.hpp&quot;
  75 #include &quot;runtime/perfData.hpp&quot;
  76 #include &quot;runtime/reflection.hpp&quot;

  77 #include &quot;runtime/thread.inline.hpp&quot;
  78 #include &quot;runtime/threadSMR.hpp&quot;
  79 #include &quot;runtime/vframe.inline.hpp&quot;
  80 #include &quot;runtime/vmOperations.hpp&quot;
  81 #include &quot;runtime/vm_version.hpp&quot;
  82 #include &quot;services/attachListener.hpp&quot;
  83 #include &quot;services/management.hpp&quot;
  84 #include &quot;services/threadService.hpp&quot;
  85 #include &quot;utilities/copy.hpp&quot;
  86 #include &quot;utilities/defaultStream.hpp&quot;
  87 #include &quot;utilities/dtrace.hpp&quot;
  88 #include &quot;utilities/events.hpp&quot;
  89 #include &quot;utilities/histogram.hpp&quot;
  90 #include &quot;utilities/macros.hpp&quot;
  91 #include &quot;utilities/utf8.hpp&quot;
  92 #if INCLUDE_CDS
  93 #include &quot;classfile/systemDictionaryShared.hpp&quot;
  94 #endif
  95 
  96 #include &lt;errno.h&gt;
</pre>
<hr />
<pre>
 473   if (DynamicDumpSharedSpaces) {
 474     MetaspaceShared::link_and_cleanup_shared_classes(THREAD);
 475   }
 476   EventShutdown event;
 477   if (event.should_commit()) {
 478     event.set_reason(&quot;Shutdown requested from Java&quot;);
 479     event.commit();
 480   }
 481 JVM_END
 482 
 483 
 484 JVM_ENTRY_NO_ENV(void, JVM_Halt(jint code))
 485   before_exit(thread);
 486   vm_exit(code);
 487 JVM_END
 488 
 489 
 490 JVM_ENTRY_NO_ENV(void, JVM_GC(void))
 491   JVMWrapper(&quot;JVM_GC&quot;);
 492   if (!DisableExplicitGC) {





 493     Universe::heap()-&gt;collect(GCCause::_java_lang_system_gc);
 494   }
 495 JVM_END
 496 
 497 
 498 JVM_LEAF(jlong, JVM_MaxObjectInspectionAge(void))
 499   JVMWrapper(&quot;JVM_MaxObjectInspectionAge&quot;);
 500   return Universe::heap()-&gt;millis_since_last_gc();
 501 JVM_END
 502 
 503 
 504 static inline jlong convert_size_t_to_jlong(size_t val) {
 505   // In the 64-bit vm, a size_t can overflow a jlong (which is signed).
 506   NOT_LP64 (return (jlong)val;)
 507   LP64_ONLY(return (jlong)MIN2(val, (size_t)max_jlong);)
 508 }
 509 
 510 JVM_ENTRY_NO_ENV(jlong, JVM_TotalMemory(void))
 511   JVMWrapper(&quot;JVM_TotalMemory&quot;);
 512   size_t n = Universe::heap()-&gt;capacity();
</pre>
<hr />
<pre>
2084         log_trace(class, nestmates)(&quot; - compacting array from length %d to %d&quot;,
2085                                     length + 1, count + 1);
2086 
2087         objArrayOop r2 = oopFactory::new_objArray(SystemDictionary::Class_klass(),
2088                                                   count + 1, CHECK_NULL);
2089         objArrayHandle result2(THREAD, r2);
2090         for (int i = 0; i &lt; count + 1; i++) {
2091           result2-&gt;obj_at_put(i, result-&gt;obj_at(i));
2092         }
2093         return (jobjectArray)JNIHandles::make_local(THREAD, result2());
2094       }
2095     }
2096     else {
2097       assert(host == ck || ck-&gt;is_hidden(), &quot;must be singleton nest or dynamic nestmate&quot;);
2098     }
2099     return (jobjectArray)JNIHandles::make_local(THREAD, result());
2100   }
2101 }
2102 JVM_END
2103 



























2104 // Constant pool access //////////////////////////////////////////////////////////
2105 
2106 JVM_ENTRY(jobject, JVM_GetClassConstantPool(JNIEnv *env, jclass cls))
2107 {
2108   JVMWrapper(&quot;JVM_GetClassConstantPool&quot;);
2109   JvmtiVMObjectAllocEventCollector oam;
2110 
2111   // Return null for primitives and arrays
2112   if (!java_lang_Class::is_primitive(JNIHandles::resolve_non_null(cls))) {
2113     Klass* k = java_lang_Class::as_Klass(JNIHandles::resolve_non_null(cls));
2114     if (k-&gt;is_instance_klass()) {
2115       InstanceKlass* k_h = InstanceKlass::cast(k);
2116       Handle jcp = reflect_ConstantPool::create(CHECK_NULL);
2117       reflect_ConstantPool::set_cp(jcp(), k_h-&gt;constants());
2118       return JNIHandles::make_local(jcp());
2119     }
2120   }
2121   return NULL;
2122 }
2123 JVM_END
</pre>
</td>
<td>
<hr />
<pre>
  57 #include &quot;oops/oop.inline.hpp&quot;
  58 #include &quot;prims/jvm_misc.hpp&quot;
  59 #include &quot;prims/jvmtiExport.hpp&quot;
  60 #include &quot;prims/jvmtiThreadState.hpp&quot;
  61 #include &quot;prims/nativeLookup.hpp&quot;
  62 #include &quot;prims/stackwalk.hpp&quot;
  63 #include &quot;runtime/arguments.hpp&quot;
  64 #include &quot;runtime/atomic.hpp&quot;
  65 #include &quot;runtime/handles.inline.hpp&quot;
  66 #include &quot;runtime/init.hpp&quot;
  67 #include &quot;runtime/interfaceSupport.inline.hpp&quot;
  68 #include &quot;runtime/deoptimization.hpp&quot;
  69 #include &quot;runtime/handshake.hpp&quot;
  70 #include &quot;runtime/java.hpp&quot;
  71 #include &quot;runtime/javaCalls.hpp&quot;
  72 #include &quot;runtime/jfieldIDWorkaround.hpp&quot;
  73 #include &quot;runtime/jniHandles.inline.hpp&quot;
  74 #include &quot;runtime/os.inline.hpp&quot;
  75 #include &quot;runtime/perfData.hpp&quot;
  76 #include &quot;runtime/reflection.hpp&quot;
<span class="line-added">  77 #include &quot;runtime/synchronizer.hpp&quot;</span>
  78 #include &quot;runtime/thread.inline.hpp&quot;
  79 #include &quot;runtime/threadSMR.hpp&quot;
  80 #include &quot;runtime/vframe.inline.hpp&quot;
  81 #include &quot;runtime/vmOperations.hpp&quot;
  82 #include &quot;runtime/vm_version.hpp&quot;
  83 #include &quot;services/attachListener.hpp&quot;
  84 #include &quot;services/management.hpp&quot;
  85 #include &quot;services/threadService.hpp&quot;
  86 #include &quot;utilities/copy.hpp&quot;
  87 #include &quot;utilities/defaultStream.hpp&quot;
  88 #include &quot;utilities/dtrace.hpp&quot;
  89 #include &quot;utilities/events.hpp&quot;
  90 #include &quot;utilities/histogram.hpp&quot;
  91 #include &quot;utilities/macros.hpp&quot;
  92 #include &quot;utilities/utf8.hpp&quot;
  93 #if INCLUDE_CDS
  94 #include &quot;classfile/systemDictionaryShared.hpp&quot;
  95 #endif
  96 
  97 #include &lt;errno.h&gt;
</pre>
<hr />
<pre>
 474   if (DynamicDumpSharedSpaces) {
 475     MetaspaceShared::link_and_cleanup_shared_classes(THREAD);
 476   }
 477   EventShutdown event;
 478   if (event.should_commit()) {
 479     event.set_reason(&quot;Shutdown requested from Java&quot;);
 480     event.commit();
 481   }
 482 JVM_END
 483 
 484 
 485 JVM_ENTRY_NO_ENV(void, JVM_Halt(jint code))
 486   before_exit(thread);
 487   vm_exit(code);
 488 JVM_END
 489 
 490 
 491 JVM_ENTRY_NO_ENV(void, JVM_GC(void))
 492   JVMWrapper(&quot;JVM_GC&quot;);
 493   if (!DisableExplicitGC) {
<span class="line-added"> 494     if (AsyncDeflateIdleMonitors) {</span>
<span class="line-added"> 495       // AsyncDeflateIdleMonitors needs to know when System.gc() is</span>
<span class="line-added"> 496       // called so any special deflation can be done at a safepoint.</span>
<span class="line-added"> 497       ObjectSynchronizer::set_is_special_deflation_requested(true);</span>
<span class="line-added"> 498     }</span>
 499     Universe::heap()-&gt;collect(GCCause::_java_lang_system_gc);
 500   }
 501 JVM_END
 502 
 503 
 504 JVM_LEAF(jlong, JVM_MaxObjectInspectionAge(void))
 505   JVMWrapper(&quot;JVM_MaxObjectInspectionAge&quot;);
 506   return Universe::heap()-&gt;millis_since_last_gc();
 507 JVM_END
 508 
 509 
 510 static inline jlong convert_size_t_to_jlong(size_t val) {
 511   // In the 64-bit vm, a size_t can overflow a jlong (which is signed).
 512   NOT_LP64 (return (jlong)val;)
 513   LP64_ONLY(return (jlong)MIN2(val, (size_t)max_jlong);)
 514 }
 515 
 516 JVM_ENTRY_NO_ENV(jlong, JVM_TotalMemory(void))
 517   JVMWrapper(&quot;JVM_TotalMemory&quot;);
 518   size_t n = Universe::heap()-&gt;capacity();
</pre>
<hr />
<pre>
2090         log_trace(class, nestmates)(&quot; - compacting array from length %d to %d&quot;,
2091                                     length + 1, count + 1);
2092 
2093         objArrayOop r2 = oopFactory::new_objArray(SystemDictionary::Class_klass(),
2094                                                   count + 1, CHECK_NULL);
2095         objArrayHandle result2(THREAD, r2);
2096         for (int i = 0; i &lt; count + 1; i++) {
2097           result2-&gt;obj_at_put(i, result-&gt;obj_at(i));
2098         }
2099         return (jobjectArray)JNIHandles::make_local(THREAD, result2());
2100       }
2101     }
2102     else {
2103       assert(host == ck || ck-&gt;is_hidden(), &quot;must be singleton nest or dynamic nestmate&quot;);
2104     }
2105     return (jobjectArray)JNIHandles::make_local(THREAD, result());
2106   }
2107 }
2108 JVM_END
2109 
<span class="line-added">2110 JVM_ENTRY(jobjectArray, JVM_GetPermittedSubclasses(JNIEnv* env, jclass current))</span>
<span class="line-added">2111 {</span>
<span class="line-added">2112   JVMWrapper(&quot;JVM_GetPermittedSubclasses&quot;);</span>
<span class="line-added">2113   assert(!java_lang_Class::is_primitive(JNIHandles::resolve_non_null(current)), &quot;should not be&quot;);</span>
<span class="line-added">2114   Klass* c = java_lang_Class::as_Klass(JNIHandles::resolve_non_null(current));</span>
<span class="line-added">2115   assert(c-&gt;is_instance_klass(), &quot;must be&quot;);</span>
<span class="line-added">2116   InstanceKlass* ik = InstanceKlass::cast(c);</span>
<span class="line-added">2117   {</span>
<span class="line-added">2118     JvmtiVMObjectAllocEventCollector oam;</span>
<span class="line-added">2119     Array&lt;u2&gt;* subclasses = ik-&gt;permitted_subclasses();</span>
<span class="line-added">2120     int length = subclasses == NULL ? 0 : subclasses-&gt;length();</span>
<span class="line-added">2121     objArrayOop r = oopFactory::new_objArray(SystemDictionary::String_klass(),</span>
<span class="line-added">2122                                              length, CHECK_NULL);</span>
<span class="line-added">2123     objArrayHandle result(THREAD, r);</span>
<span class="line-added">2124     for (int i = 0; i &lt; length; i++) {</span>
<span class="line-added">2125       int cp_index = subclasses-&gt;at(i);</span>
<span class="line-added">2126       // This returns &lt;package-name&gt;/&lt;class-name&gt;.</span>
<span class="line-added">2127       Symbol* klass_name = ik-&gt;constants()-&gt;klass_name_at(cp_index);</span>
<span class="line-added">2128       assert(klass_name != NULL, &quot;Unexpected null klass_name&quot;);</span>
<span class="line-added">2129       Handle perm_subtype_h = java_lang_String::create_from_symbol(klass_name, CHECK_NULL);</span>
<span class="line-added">2130       result-&gt;obj_at_put(i, perm_subtype_h());</span>
<span class="line-added">2131     }</span>
<span class="line-added">2132     return (jobjectArray)JNIHandles::make_local(THREAD, result());</span>
<span class="line-added">2133   }</span>
<span class="line-added">2134 }</span>
<span class="line-added">2135 JVM_END</span>
<span class="line-added">2136 </span>
2137 // Constant pool access //////////////////////////////////////////////////////////
2138 
2139 JVM_ENTRY(jobject, JVM_GetClassConstantPool(JNIEnv *env, jclass cls))
2140 {
2141   JVMWrapper(&quot;JVM_GetClassConstantPool&quot;);
2142   JvmtiVMObjectAllocEventCollector oam;
2143 
2144   // Return null for primitives and arrays
2145   if (!java_lang_Class::is_primitive(JNIHandles::resolve_non_null(cls))) {
2146     Klass* k = java_lang_Class::as_Klass(JNIHandles::resolve_non_null(cls));
2147     if (k-&gt;is_instance_klass()) {
2148       InstanceKlass* k_h = InstanceKlass::cast(k);
2149       Handle jcp = reflect_ConstantPool::create(CHECK_NULL);
2150       reflect_ConstantPool::set_cp(jcp(), k_h-&gt;constants());
2151       return JNIHandles::make_local(jcp());
2152     }
2153   }
2154   return NULL;
2155 }
2156 JVM_END
</pre>
</td>
</tr>
</table>
<center><a href="../opto/type.cpp.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="jvmti.xml.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>