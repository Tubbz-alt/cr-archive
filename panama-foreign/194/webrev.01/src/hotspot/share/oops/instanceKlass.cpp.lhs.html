<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames src/hotspot/share/oops/instanceKlass.cpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
    <script type="text/javascript" src="../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>   1 /*
   2  * Copyright (c) 1997, 2020, Oracle and/or its affiliates. All rights reserved.
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.
   8  *
   9  * This code is distributed in the hope that it will be useful, but WITHOUT
  10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  *
  23  */
  24 
  25 #include &quot;precompiled.hpp&quot;
  26 #include &quot;jvm.h&quot;
  27 #include &quot;aot/aotLoader.hpp&quot;
  28 #include &quot;classfile/classFileParser.hpp&quot;
  29 #include &quot;classfile/classFileStream.hpp&quot;
  30 #include &quot;classfile/classLoader.hpp&quot;
  31 #include &quot;classfile/classLoaderData.inline.hpp&quot;
  32 #include &quot;classfile/javaClasses.hpp&quot;
  33 #include &quot;classfile/moduleEntry.hpp&quot;
  34 #include &quot;classfile/resolutionErrors.hpp&quot;
  35 #include &quot;classfile/symbolTable.hpp&quot;
  36 #include &quot;classfile/systemDictionary.hpp&quot;
  37 #include &quot;classfile/systemDictionaryShared.hpp&quot;
  38 #include &quot;classfile/verifier.hpp&quot;
  39 #include &quot;classfile/vmSymbols.hpp&quot;
  40 #include &quot;code/dependencyContext.hpp&quot;
  41 #include &quot;compiler/compileBroker.hpp&quot;
  42 #include &quot;gc/shared/collectedHeap.inline.hpp&quot;
  43 #include &quot;interpreter/oopMapCache.hpp&quot;
  44 #include &quot;interpreter/rewriter.hpp&quot;
  45 #include &quot;jvmtifiles/jvmti.h&quot;
  46 #include &quot;logging/log.hpp&quot;
  47 #include &quot;logging/logMessage.hpp&quot;
  48 #include &quot;logging/logStream.hpp&quot;
  49 #include &quot;memory/allocation.inline.hpp&quot;
  50 #include &quot;memory/iterator.inline.hpp&quot;
  51 #include &quot;memory/metadataFactory.hpp&quot;
  52 #include &quot;memory/metaspaceClosure.hpp&quot;
  53 #include &quot;memory/metaspaceShared.hpp&quot;
  54 #include &quot;memory/oopFactory.hpp&quot;
  55 #include &quot;memory/resourceArea.hpp&quot;
  56 #include &quot;memory/universe.hpp&quot;
  57 #include &quot;oops/fieldStreams.inline.hpp&quot;
  58 #include &quot;oops/constantPool.hpp&quot;
  59 #include &quot;oops/instanceClassLoaderKlass.hpp&quot;
  60 #include &quot;oops/instanceKlass.inline.hpp&quot;
  61 #include &quot;oops/instanceMirrorKlass.hpp&quot;
  62 #include &quot;oops/instanceOop.hpp&quot;
  63 #include &quot;oops/klass.inline.hpp&quot;
  64 #include &quot;oops/method.hpp&quot;
  65 #include &quot;oops/oop.inline.hpp&quot;
  66 #include &quot;oops/recordComponent.hpp&quot;
  67 #include &quot;oops/symbol.hpp&quot;
  68 #include &quot;prims/jvmtiExport.hpp&quot;
  69 #include &quot;prims/jvmtiRedefineClasses.hpp&quot;
  70 #include &quot;prims/jvmtiThreadState.hpp&quot;
  71 #include &quot;prims/methodComparator.hpp&quot;
  72 #include &quot;runtime/atomic.hpp&quot;
  73 #include &quot;runtime/biasedLocking.hpp&quot;
  74 #include &quot;runtime/fieldDescriptor.inline.hpp&quot;
  75 #include &quot;runtime/handles.inline.hpp&quot;
  76 #include &quot;runtime/javaCalls.hpp&quot;
  77 #include &quot;runtime/mutexLocker.hpp&quot;
  78 #include &quot;runtime/orderAccess.hpp&quot;
  79 #include &quot;runtime/thread.inline.hpp&quot;
  80 #include &quot;services/classLoadingService.hpp&quot;
  81 #include &quot;services/threadService.hpp&quot;
  82 #include &quot;utilities/dtrace.hpp&quot;
  83 #include &quot;utilities/events.hpp&quot;
  84 #include &quot;utilities/macros.hpp&quot;
  85 #include &quot;utilities/stringUtils.hpp&quot;
  86 #ifdef COMPILER1
  87 #include &quot;c1/c1_Compiler.hpp&quot;
  88 #endif
  89 #if INCLUDE_JFR
  90 #include &quot;jfr/jfrEvents.hpp&quot;
  91 #endif
  92 
  93 
  94 #ifdef DTRACE_ENABLED
  95 
  96 
  97 #define HOTSPOT_CLASS_INITIALIZATION_required HOTSPOT_CLASS_INITIALIZATION_REQUIRED
  98 #define HOTSPOT_CLASS_INITIALIZATION_recursive HOTSPOT_CLASS_INITIALIZATION_RECURSIVE
  99 #define HOTSPOT_CLASS_INITIALIZATION_concurrent HOTSPOT_CLASS_INITIALIZATION_CONCURRENT
 100 #define HOTSPOT_CLASS_INITIALIZATION_erroneous HOTSPOT_CLASS_INITIALIZATION_ERRONEOUS
 101 #define HOTSPOT_CLASS_INITIALIZATION_super__failed HOTSPOT_CLASS_INITIALIZATION_SUPER_FAILED
 102 #define HOTSPOT_CLASS_INITIALIZATION_clinit HOTSPOT_CLASS_INITIALIZATION_CLINIT
 103 #define HOTSPOT_CLASS_INITIALIZATION_error HOTSPOT_CLASS_INITIALIZATION_ERROR
 104 #define HOTSPOT_CLASS_INITIALIZATION_end HOTSPOT_CLASS_INITIALIZATION_END
 105 #define DTRACE_CLASSINIT_PROBE(type, thread_type)                \
 106   {                                                              \
 107     char* data = NULL;                                           \
 108     int len = 0;                                                 \
 109     Symbol* clss_name = name();                                  \
 110     if (clss_name != NULL) {                                     \
 111       data = (char*)clss_name-&gt;bytes();                          \
 112       len = clss_name-&gt;utf8_length();                            \
 113     }                                                            \
 114     HOTSPOT_CLASS_INITIALIZATION_##type(                         \
 115       data, len, (void*)class_loader(), thread_type);            \
 116   }
 117 
 118 #define DTRACE_CLASSINIT_PROBE_WAIT(type, thread_type, wait)     \
 119   {                                                              \
 120     char* data = NULL;                                           \
 121     int len = 0;                                                 \
 122     Symbol* clss_name = name();                                  \
 123     if (clss_name != NULL) {                                     \
 124       data = (char*)clss_name-&gt;bytes();                          \
 125       len = clss_name-&gt;utf8_length();                            \
 126     }                                                            \
 127     HOTSPOT_CLASS_INITIALIZATION_##type(                         \
 128       data, len, (void*)class_loader(), thread_type, wait);      \
 129   }
 130 
 131 #else //  ndef DTRACE_ENABLED
 132 
 133 #define DTRACE_CLASSINIT_PROBE(type, thread_type)
 134 #define DTRACE_CLASSINIT_PROBE_WAIT(type, thread_type, wait)
 135 
 136 #endif //  ndef DTRACE_ENABLED
 137 
 138 
 139 static inline bool is_class_loader(const Symbol* class_name,
 140                                    const ClassFileParser&amp; parser) {
 141   assert(class_name != NULL, &quot;invariant&quot;);
 142 
 143   if (class_name == vmSymbols::java_lang_ClassLoader()) {
 144     return true;
 145   }
 146 
 147   if (SystemDictionary::ClassLoader_klass_loaded()) {
 148     const Klass* const super_klass = parser.super_klass();
 149     if (super_klass != NULL) {
 150       if (super_klass-&gt;is_subtype_of(SystemDictionary::ClassLoader_klass())) {
 151         return true;
 152       }
 153     }
 154   }
 155   return false;
 156 }
 157 
 158 // private: called to verify that k is a static member of this nest.
 159 // We know that k is an instance class in the same package and hence the
 160 // same classloader.
 161 bool InstanceKlass::has_nest_member(InstanceKlass* k, TRAPS) const {
 162   assert(!is_hidden(), &quot;unexpected hidden class&quot;);
 163   if (_nest_members == NULL || _nest_members == Universe::the_empty_short_array()) {
 164     if (log_is_enabled(Trace, class, nestmates)) {
 165       ResourceMark rm(THREAD);
 166       log_trace(class, nestmates)(&quot;Checked nest membership of %s in non-nest-host class %s&quot;,
 167                                   k-&gt;external_name(), this-&gt;external_name());
 168     }
 169     return false;
 170   }
 171 
 172   if (log_is_enabled(Trace, class, nestmates)) {
 173     ResourceMark rm(THREAD);
 174     log_trace(class, nestmates)(&quot;Checking nest membership of %s in %s&quot;,
 175                                 k-&gt;external_name(), this-&gt;external_name());
 176   }
 177 
 178   // Check for a resolved cp entry , else fall back to a name check.
 179   // We don&#39;t want to resolve any class other than the one being checked.
 180   for (int i = 0; i &lt; _nest_members-&gt;length(); i++) {
 181     int cp_index = _nest_members-&gt;at(i);
 182     if (_constants-&gt;tag_at(cp_index).is_klass()) {
 183       Klass* k2 = _constants-&gt;klass_at(cp_index, THREAD);
 184       assert(!HAS_PENDING_EXCEPTION || PENDING_EXCEPTION-&gt;is_a(SystemDictionary::VirtualMachineError_klass()),
 185              &quot;Exceptions should not be possible here&quot;);
 186       if (k2 == k) {
 187         log_trace(class, nestmates)(&quot;- class is listed at nest_members[%d] =&gt; cp[%d]&quot;, i, cp_index);
 188         return true;
 189       }
 190     }
 191     else {
 192       Symbol* name = _constants-&gt;klass_name_at(cp_index);
 193       if (name == k-&gt;name()) {
 194         log_trace(class, nestmates)(&quot;- Found it at nest_members[%d] =&gt; cp[%d]&quot;, i, cp_index);
 195 
 196         // Names match so check actual klass. This may trigger class loading if
 197         // it doesn&#39;t match though that should be impossible as it means one classloader
 198         // has defined two different classes with the same name! A compiler thread won&#39;t be
 199         // able to perform that loading but we can&#39;t exclude the compiler threads from
 200         // executing this logic. But it should actually be impossible to trigger loading here.
 201         Klass* k2 = _constants-&gt;klass_at(cp_index, THREAD);
 202         assert(!HAS_PENDING_EXCEPTION || PENDING_EXCEPTION-&gt;is_a(SystemDictionary::VirtualMachineError_klass()),
 203                &quot;Exceptions should not be possible here&quot;);
 204         if (k2 == k) {
 205           log_trace(class, nestmates)(&quot;- class is listed as a nest member&quot;);
 206           return true;
 207         }
 208         else {
 209           // same name but different klass!
 210           log_trace(class, nestmates)(&quot; - klass comparison failed!&quot;);
 211           // can&#39;t have two names the same, so we&#39;re done
 212           return false;
 213         }
 214       }
 215     }
 216   }
 217   log_trace(class, nestmates)(&quot;- class is NOT a nest member!&quot;);
 218   return false;
 219 }
 220 
<a name="1" id="anc1"></a>


















































 221 // Return nest-host class, resolving, validating and saving it if needed.
 222 // In cases where this is called from a thread that cannot do classloading
 223 // (such as a native JIT thread) then we simply return NULL, which in turn
 224 // causes the access check to return false. Such code will retry the access
 225 // from a more suitable environment later. Otherwise the _nest_host is always
 226 // set once this method returns.
 227 // Any errors from nest-host resolution must be preserved so they can be queried
 228 // from higher-level access checking code, and reported as part of access checking
 229 // exceptions.
 230 // VirtualMachineErrors are propagated with a NULL return.
 231 // Under any conditions where the _nest_host can be set to non-NULL the resulting
 232 // value of it and, if applicable, the nest host resolution/validation error,
 233 // are idempotent.
 234 InstanceKlass* InstanceKlass::nest_host(TRAPS) {
 235   InstanceKlass* nest_host_k = _nest_host;
 236   if (nest_host_k != NULL) {
 237     return nest_host_k;
 238   }
 239 
 240   ResourceMark rm(THREAD);
 241 
 242   // need to resolve and save our nest-host class.
 243   if (_nest_host_index != 0) { // we have a real nest_host
 244     // Before trying to resolve check if we&#39;re in a suitable context
 245     if (!THREAD-&gt;can_call_java() &amp;&amp; !_constants-&gt;tag_at(_nest_host_index).is_klass()) {
 246       log_trace(class, nestmates)(&quot;Rejected resolution of nest-host of %s in unsuitable thread&quot;,
 247                                   this-&gt;external_name());
 248       return NULL; // sentinel to say &quot;try again from a different context&quot;
 249     }
 250 
 251     log_trace(class, nestmates)(&quot;Resolving nest-host of %s using cp entry for %s&quot;,
 252                                 this-&gt;external_name(),
 253                                 _constants-&gt;klass_name_at(_nest_host_index)-&gt;as_C_string());
 254 
 255     Klass* k = _constants-&gt;klass_at(_nest_host_index, THREAD);
 256     if (HAS_PENDING_EXCEPTION) {
 257       if (PENDING_EXCEPTION-&gt;is_a(SystemDictionary::VirtualMachineError_klass())) {
 258         return NULL; // propagate VMEs
 259       }
 260       stringStream ss;
 261       char* target_host_class = _constants-&gt;klass_name_at(_nest_host_index)-&gt;as_C_string();
 262       ss.print(&quot;Nest host resolution of %s with host %s failed: &quot;,
 263                this-&gt;external_name(), target_host_class);
 264       java_lang_Throwable::print(PENDING_EXCEPTION, &amp;ss);
 265       const char* msg = ss.as_string(true /* on C-heap */);
 266       constantPoolHandle cph(THREAD, constants());
 267       SystemDictionary::add_nest_host_error(cph, _nest_host_index, msg);
 268       CLEAR_PENDING_EXCEPTION;
 269 
 270       log_trace(class, nestmates)(&quot;%s&quot;, msg);
 271     } else {
 272       // A valid nest-host is an instance class in the current package that lists this
 273       // class as a nest member. If any of these conditions are not met the class is
 274       // its own nest-host.
 275       const char* error = NULL;
 276 
 277       // JVMS 5.4.4 indicates package check comes first
 278       if (is_same_class_package(k)) {
 279         // Now check actual membership. We can&#39;t be a member if our &quot;host&quot; is
 280         // not an instance class.
 281         if (k-&gt;is_instance_klass()) {
 282           nest_host_k = InstanceKlass::cast(k);
 283           bool is_member = nest_host_k-&gt;has_nest_member(this, THREAD);
 284           // exception is rare, perhaps impossible
 285           if (!HAS_PENDING_EXCEPTION) {
 286             if (is_member) {
 287               _nest_host = nest_host_k; // save resolved nest-host value
 288 
 289               log_trace(class, nestmates)(&quot;Resolved nest-host of %s to %s&quot;,
 290                                           this-&gt;external_name(), k-&gt;external_name());
 291               return nest_host_k;
 292             } else {
 293               error = &quot;current type is not listed as a nest member&quot;;
 294             }
 295           } else {
 296             if (PENDING_EXCEPTION-&gt;is_a(SystemDictionary::VirtualMachineError_klass())) {
 297               return NULL; // propagate VMEs
 298             }
 299             stringStream ss;
 300             ss.print(&quot;exception on member check: &quot;);
 301             java_lang_Throwable::print(PENDING_EXCEPTION, &amp;ss);
 302             error = ss.as_string();
 303           }
 304         } else {
 305           error = &quot;host is not an instance class&quot;;
 306         }
 307       } else {
 308         error = &quot;types are in different packages&quot;;
 309       }
 310 
 311       // something went wrong, so record what and log it
 312       {
 313         stringStream ss;
 314         ss.print(&quot;Type %s (loader: %s) is not a nest member of type %s (loader: %s): %s&quot;,
 315                  this-&gt;external_name(),
 316                  this-&gt;class_loader_data()-&gt;loader_name_and_id(),
 317                  k-&gt;external_name(),
 318                  k-&gt;class_loader_data()-&gt;loader_name_and_id(),
 319                  error);
 320         const char* msg = ss.as_string(true /* on C-heap */);
 321         constantPoolHandle cph(THREAD, constants());
 322         SystemDictionary::add_nest_host_error(cph, _nest_host_index, msg);
 323         log_trace(class, nestmates)(&quot;%s&quot;, msg);
 324       }
 325     }
 326   } else {
 327     log_trace(class, nestmates)(&quot;Type %s is not part of a nest: setting nest-host to self&quot;,
 328                                 this-&gt;external_name());
 329   }
 330 
 331   // Either not in an explicit nest, or else an error occurred, so
 332   // the nest-host is set to `this`. Any thread that sees this assignment
 333   // will also see any setting of nest_host_error(), if applicable.
 334   return (_nest_host = this);
 335 }
 336 
 337 // Dynamic nest member support: set this class&#39;s nest host to the given class.
 338 // This occurs as part of the class definition, as soon as the instanceKlass
 339 // has been created and doesn&#39;t require further resolution. The code:
 340 //    lookup().defineHiddenClass(bytes_for_X, NESTMATE);
 341 // results in:
 342 //    class_of_X.set_nest_host(lookup().lookupClass().getNestHost())
 343 // If it has an explicit _nest_host_index or _nest_members, these will be ignored.
 344 // We also know the &quot;host&quot; is a valid nest-host in the same package so we can
 345 // assert some of those facts.
 346 void InstanceKlass::set_nest_host(InstanceKlass* host, TRAPS) {
 347   assert(is_hidden(), &quot;must be a hidden class&quot;);
 348   assert(host != NULL, &quot;NULL nest host specified&quot;);
 349   assert(_nest_host == NULL, &quot;current class has resolved nest-host&quot;);
 350   assert(nest_host_error(THREAD) == NULL, &quot;unexpected nest host resolution error exists: %s&quot;,
 351          nest_host_error(THREAD));
 352   assert((host-&gt;_nest_host == NULL &amp;&amp; host-&gt;_nest_host_index == 0) ||
 353          (host-&gt;_nest_host == host), &quot;proposed host is not a valid nest-host&quot;);
 354   // Can&#39;t assert this as package is not set yet:
 355   // assert(is_same_class_package(host), &quot;proposed host is in wrong package&quot;);
 356 
 357   if (log_is_enabled(Trace, class, nestmates)) {
 358     ResourceMark rm(THREAD);
 359     const char* msg = &quot;&quot;;
 360     // a hidden class does not expect a statically defined nest-host
 361     if (_nest_host_index &gt; 0) {
 362       msg = &quot;(the NestHost attribute in the current class is ignored)&quot;;
 363     } else if (_nest_members != NULL &amp;&amp; _nest_members != Universe::the_empty_short_array()) {
 364       msg = &quot;(the NestMembers attribute in the current class is ignored)&quot;;
 365     }
 366     log_trace(class, nestmates)(&quot;Injected type %s into the nest of %s %s&quot;,
 367                                 this-&gt;external_name(),
 368                                 host-&gt;external_name(),
 369                                 msg);
 370   }
 371   // set dynamic nest host
 372   _nest_host = host;
 373   // Record dependency to keep nest host from being unloaded before this class.
 374   ClassLoaderData* this_key = class_loader_data();
 375   this_key-&gt;record_dependency(host);
 376 }
 377 
 378 // check if &#39;this&#39; and k are nestmates (same nest_host), or k is our nest_host,
 379 // or we are k&#39;s nest_host - all of which is covered by comparing the two
 380 // resolved_nest_hosts.
 381 // Any exceptions (i.e. VMEs) are propagated.
 382 bool InstanceKlass::has_nestmate_access_to(InstanceKlass* k, TRAPS) {
 383 
 384   assert(this != k, &quot;this should be handled by higher-level code&quot;);
 385 
 386   // Per JVMS 5.4.4 we first resolve and validate the current class, then
 387   // the target class k.
 388 
 389   InstanceKlass* cur_host = nest_host(CHECK_false);
 390   if (cur_host == NULL) {
 391     return false;
 392   }
 393 
 394   Klass* k_nest_host = k-&gt;nest_host(CHECK_false);
 395   if (k_nest_host == NULL) {
 396     return false;
 397   }
 398 
 399   bool access = (cur_host == k_nest_host);
 400 
 401   ResourceMark rm(THREAD);
 402   log_trace(class, nestmates)(&quot;Class %s does %shave nestmate access to %s&quot;,
 403                               this-&gt;external_name(),
 404                               access ? &quot;&quot; : &quot;NOT &quot;,
 405                               k-&gt;external_name());
 406   return access;
 407 }
 408 
 409 const char* InstanceKlass::nest_host_error(TRAPS) {
 410   if (_nest_host_index == 0) {
 411     return NULL;
 412   } else {
 413     constantPoolHandle cph(THREAD, constants());
 414     return SystemDictionary::find_nest_host_error(cph, (int)_nest_host_index);
 415   }
 416 }
 417 
 418 InstanceKlass* InstanceKlass::allocate_instance_klass(const ClassFileParser&amp; parser, TRAPS) {
 419   bool is_hidden_or_anonymous = parser.is_hidden() || parser.is_unsafe_anonymous();
 420   const int size = InstanceKlass::size(parser.vtable_size(),
 421                                        parser.itable_size(),
 422                                        nonstatic_oop_map_size(parser.total_oop_map_count()),
 423                                        parser.is_interface(),
 424                                        parser.is_unsafe_anonymous(),
 425                                        should_store_fingerprint(is_hidden_or_anonymous));
 426 
 427   const Symbol* const class_name = parser.class_name();
 428   assert(class_name != NULL, &quot;invariant&quot;);
 429   ClassLoaderData* loader_data = parser.loader_data();
 430   assert(loader_data != NULL, &quot;invariant&quot;);
 431 
 432   InstanceKlass* ik;
 433 
 434   // Allocation
 435   if (REF_NONE == parser.reference_type()) {
 436     if (class_name == vmSymbols::java_lang_Class()) {
 437       // mirror
 438       ik = new (loader_data, size, THREAD) InstanceMirrorKlass(parser);
 439     }
 440     else if (is_class_loader(class_name, parser)) {
 441       // class loader
 442       ik = new (loader_data, size, THREAD) InstanceClassLoaderKlass(parser);
 443     } else {
 444       // normal
 445       ik = new (loader_data, size, THREAD) InstanceKlass(parser, InstanceKlass::_kind_other);
 446     }
 447   } else {
 448     // reference
 449     ik = new (loader_data, size, THREAD) InstanceRefKlass(parser);
 450   }
 451 
 452   // Check for pending exception before adding to the loader data and incrementing
 453   // class count.  Can get OOM here.
 454   if (HAS_PENDING_EXCEPTION) {
 455     return NULL;
 456   }
 457 
 458   return ik;
 459 }
 460 
 461 
 462 // copy method ordering from resource area to Metaspace
 463 void InstanceKlass::copy_method_ordering(const intArray* m, TRAPS) {
 464   if (m != NULL) {
 465     // allocate a new array and copy contents (memcpy?)
 466     _method_ordering = MetadataFactory::new_array&lt;int&gt;(class_loader_data(), m-&gt;length(), CHECK);
 467     for (int i = 0; i &lt; m-&gt;length(); i++) {
 468       _method_ordering-&gt;at_put(i, m-&gt;at(i));
 469     }
 470   } else {
 471     _method_ordering = Universe::the_empty_int_array();
 472   }
 473 }
 474 
 475 // create a new array of vtable_indices for default methods
 476 Array&lt;int&gt;* InstanceKlass::create_new_default_vtable_indices(int len, TRAPS) {
 477   Array&lt;int&gt;* vtable_indices = MetadataFactory::new_array&lt;int&gt;(class_loader_data(), len, CHECK_NULL);
 478   assert(default_vtable_indices() == NULL, &quot;only create once&quot;);
 479   set_default_vtable_indices(vtable_indices);
 480   return vtable_indices;
 481 }
 482 
 483 InstanceKlass::InstanceKlass(const ClassFileParser&amp; parser, unsigned kind, KlassID id) :
 484   Klass(id),
 485   _nest_members(NULL),
 486   _nest_host(NULL),
<a name="2" id="anc2"></a>
 487   _record_components(NULL),
 488   _static_field_size(parser.static_field_size()),
 489   _nonstatic_oop_map_size(nonstatic_oop_map_size(parser.total_oop_map_count())),
 490   _itable_len(parser.itable_size()),
 491   _nest_host_index(0),
 492   _init_state(allocated),
 493   _reference_type(parser.reference_type()),
 494   _init_thread(NULL)
 495 {
 496   set_vtable_length(parser.vtable_size());
 497   set_kind(kind);
 498   set_access_flags(parser.access_flags());
 499   if (parser.is_hidden()) set_is_hidden();
 500   set_is_unsafe_anonymous(parser.is_unsafe_anonymous());
 501   set_layout_helper(Klass::instance_layout_helper(parser.layout_size(),
 502                                                     false));
 503 
 504   assert(NULL == _methods, &quot;underlying memory not zeroed?&quot;);
 505   assert(is_instance_klass(), &quot;is layout incorrect?&quot;);
 506   assert(size_helper() == parser.layout_size(), &quot;incorrect size_helper?&quot;);
 507 
 508   // Set biased locking bit for all instances of this class; it will be
 509   // cleared if revocation occurs too often for this type
 510   if (UseBiasedLocking &amp;&amp; BiasedLocking::enabled()) {
 511     set_prototype_header(markWord::biased_locking_prototype());
 512   }
 513 }
 514 
 515 void InstanceKlass::deallocate_methods(ClassLoaderData* loader_data,
 516                                        Array&lt;Method*&gt;* methods) {
 517   if (methods != NULL &amp;&amp; methods != Universe::the_empty_method_array() &amp;&amp;
 518       !methods-&gt;is_shared()) {
 519     for (int i = 0; i &lt; methods-&gt;length(); i++) {
 520       Method* method = methods-&gt;at(i);
 521       if (method == NULL) continue;  // maybe null if error processing
 522       // Only want to delete methods that are not executing for RedefineClasses.
 523       // The previous version will point to them so they&#39;re not totally dangling
 524       assert (!method-&gt;on_stack(), &quot;shouldn&#39;t be called with methods on stack&quot;);
 525       MetadataFactory::free_metadata(loader_data, method);
 526     }
 527     MetadataFactory::free_array&lt;Method*&gt;(loader_data, methods);
 528   }
 529 }
 530 
 531 void InstanceKlass::deallocate_interfaces(ClassLoaderData* loader_data,
 532                                           const Klass* super_klass,
 533                                           Array&lt;InstanceKlass*&gt;* local_interfaces,
 534                                           Array&lt;InstanceKlass*&gt;* transitive_interfaces) {
 535   // Only deallocate transitive interfaces if not empty, same as super class
 536   // or same as local interfaces.  See code in parseClassFile.
 537   Array&lt;InstanceKlass*&gt;* ti = transitive_interfaces;
 538   if (ti != Universe::the_empty_instance_klass_array() &amp;&amp; ti != local_interfaces) {
 539     // check that the interfaces don&#39;t come from super class
 540     Array&lt;InstanceKlass*&gt;* sti = (super_klass == NULL) ? NULL :
 541                     InstanceKlass::cast(super_klass)-&gt;transitive_interfaces();
 542     if (ti != sti &amp;&amp; ti != NULL &amp;&amp; !ti-&gt;is_shared()) {
 543       MetadataFactory::free_array&lt;InstanceKlass*&gt;(loader_data, ti);
 544     }
 545   }
 546 
 547   // local interfaces can be empty
 548   if (local_interfaces != Universe::the_empty_instance_klass_array() &amp;&amp;
 549       local_interfaces != NULL &amp;&amp; !local_interfaces-&gt;is_shared()) {
 550     MetadataFactory::free_array&lt;InstanceKlass*&gt;(loader_data, local_interfaces);
 551   }
 552 }
 553 
 554 void InstanceKlass::deallocate_record_components(ClassLoaderData* loader_data,
 555                                                  Array&lt;RecordComponent*&gt;* record_components) {
 556   if (record_components != NULL &amp;&amp; !record_components-&gt;is_shared()) {
 557     for (int i = 0; i &lt; record_components-&gt;length(); i++) {
 558       RecordComponent* record_component = record_components-&gt;at(i);
 559       MetadataFactory::free_metadata(loader_data, record_component);
 560     }
 561     MetadataFactory::free_array&lt;RecordComponent*&gt;(loader_data, record_components);
 562   }
 563 }
 564 
 565 // This function deallocates the metadata and C heap pointers that the
 566 // InstanceKlass points to.
 567 void InstanceKlass::deallocate_contents(ClassLoaderData* loader_data) {
 568 
 569   // Orphan the mirror first, CMS thinks it&#39;s still live.
 570   if (java_mirror() != NULL) {
 571     java_lang_Class::set_klass(java_mirror(), NULL);
 572   }
 573 
 574   // Also remove mirror from handles
 575   loader_data-&gt;remove_handle(_java_mirror);
 576 
 577   // Need to take this class off the class loader data list.
 578   loader_data-&gt;remove_class(this);
 579 
 580   // The array_klass for this class is created later, after error handling.
 581   // For class redefinition, we keep the original class so this scratch class
 582   // doesn&#39;t have an array class.  Either way, assert that there is nothing
 583   // to deallocate.
 584   assert(array_klasses() == NULL, &quot;array classes shouldn&#39;t be created for this class yet&quot;);
 585 
 586   // Release C heap allocated data that this points to, which includes
 587   // reference counting symbol names.
 588   release_C_heap_structures_internal();
 589 
 590   deallocate_methods(loader_data, methods());
 591   set_methods(NULL);
 592 
 593   deallocate_record_components(loader_data, record_components());
 594   set_record_components(NULL);
 595 
 596   if (method_ordering() != NULL &amp;&amp;
 597       method_ordering() != Universe::the_empty_int_array() &amp;&amp;
 598       !method_ordering()-&gt;is_shared()) {
 599     MetadataFactory::free_array&lt;int&gt;(loader_data, method_ordering());
 600   }
 601   set_method_ordering(NULL);
 602 
 603   // default methods can be empty
 604   if (default_methods() != NULL &amp;&amp;
 605       default_methods() != Universe::the_empty_method_array() &amp;&amp;
 606       !default_methods()-&gt;is_shared()) {
 607     MetadataFactory::free_array&lt;Method*&gt;(loader_data, default_methods());
 608   }
 609   // Do NOT deallocate the default methods, they are owned by superinterfaces.
 610   set_default_methods(NULL);
 611 
 612   // default methods vtable indices can be empty
 613   if (default_vtable_indices() != NULL &amp;&amp;
 614       !default_vtable_indices()-&gt;is_shared()) {
 615     MetadataFactory::free_array&lt;int&gt;(loader_data, default_vtable_indices());
 616   }
 617   set_default_vtable_indices(NULL);
 618 
 619 
 620   // This array is in Klass, but remove it with the InstanceKlass since
 621   // this place would be the only caller and it can share memory with transitive
 622   // interfaces.
 623   if (secondary_supers() != NULL &amp;&amp;
 624       secondary_supers() != Universe::the_empty_klass_array() &amp;&amp;
 625       // see comments in compute_secondary_supers about the following cast
 626       (address)(secondary_supers()) != (address)(transitive_interfaces()) &amp;&amp;
 627       !secondary_supers()-&gt;is_shared()) {
 628     MetadataFactory::free_array&lt;Klass*&gt;(loader_data, secondary_supers());
 629   }
 630   set_secondary_supers(NULL);
 631 
 632   deallocate_interfaces(loader_data, super(), local_interfaces(), transitive_interfaces());
 633   set_transitive_interfaces(NULL);
 634   set_local_interfaces(NULL);
 635 
 636   if (fields() != NULL &amp;&amp; !fields()-&gt;is_shared()) {
 637     MetadataFactory::free_array&lt;jushort&gt;(loader_data, fields());
 638   }
 639   set_fields(NULL, 0);
 640 
 641   // If a method from a redefined class is using this constant pool, don&#39;t
 642   // delete it, yet.  The new class&#39;s previous version will point to this.
 643   if (constants() != NULL) {
 644     assert (!constants()-&gt;on_stack(), &quot;shouldn&#39;t be called if anything is onstack&quot;);
 645     if (!constants()-&gt;is_shared()) {
 646       MetadataFactory::free_metadata(loader_data, constants());
 647     }
 648     // Delete any cached resolution errors for the constant pool
 649     SystemDictionary::delete_resolution_error(constants());
 650 
 651     set_constants(NULL);
 652   }
 653 
 654   if (inner_classes() != NULL &amp;&amp;
 655       inner_classes() != Universe::the_empty_short_array() &amp;&amp;
 656       !inner_classes()-&gt;is_shared()) {
 657     MetadataFactory::free_array&lt;jushort&gt;(loader_data, inner_classes());
 658   }
 659   set_inner_classes(NULL);
 660 
 661   if (nest_members() != NULL &amp;&amp;
 662       nest_members() != Universe::the_empty_short_array() &amp;&amp;
 663       !nest_members()-&gt;is_shared()) {
 664     MetadataFactory::free_array&lt;jushort&gt;(loader_data, nest_members());
 665   }
 666   set_nest_members(NULL);
 667 
<a name="3" id="anc3"></a>






 668   // We should deallocate the Annotations instance if it&#39;s not in shared spaces.
 669   if (annotations() != NULL &amp;&amp; !annotations()-&gt;is_shared()) {
 670     MetadataFactory::free_metadata(loader_data, annotations());
 671   }
 672   set_annotations(NULL);
 673 
 674   if (Arguments::is_dumping_archive()) {
 675     SystemDictionaryShared::remove_dumptime_info(this);
 676   }
 677 }
 678 
<a name="4" id="anc4"></a>





 679 bool InstanceKlass::should_be_initialized() const {
 680   return !is_initialized();
 681 }
 682 
 683 klassItable InstanceKlass::itable() const {
 684   return klassItable(const_cast&lt;InstanceKlass*&gt;(this));
 685 }
 686 
 687 void InstanceKlass::eager_initialize(Thread *thread) {
 688   if (!EagerInitialization) return;
 689 
 690   if (this-&gt;is_not_initialized()) {
 691     // abort if the the class has a class initializer
 692     if (this-&gt;class_initializer() != NULL) return;
 693 
 694     // abort if it is java.lang.Object (initialization is handled in genesis)
 695     Klass* super_klass = super();
 696     if (super_klass == NULL) return;
 697 
 698     // abort if the super class should be initialized
 699     if (!InstanceKlass::cast(super_klass)-&gt;is_initialized()) return;
 700 
 701     // call body to expose the this pointer
 702     eager_initialize_impl();
 703   }
 704 }
 705 
 706 // JVMTI spec thinks there are signers and protection domain in the
 707 // instanceKlass.  These accessors pretend these fields are there.
 708 // The hprof specification also thinks these fields are in InstanceKlass.
 709 oop InstanceKlass::protection_domain() const {
 710   // return the protection_domain from the mirror
 711   return java_lang_Class::protection_domain(java_mirror());
 712 }
 713 
 714 // To remove these from requires an incompatible change and CCC request.
 715 objArrayOop InstanceKlass::signers() const {
 716   // return the signers from the mirror
 717   return java_lang_Class::signers(java_mirror());
 718 }
 719 
 720 oop InstanceKlass::init_lock() const {
 721   // return the init lock from the mirror
 722   oop lock = java_lang_Class::init_lock(java_mirror());
 723   // Prevent reordering with any access of initialization state
 724   OrderAccess::loadload();
 725   assert((oop)lock != NULL || !is_not_initialized(), // initialized or in_error state
 726          &quot;only fully initialized state can have a null lock&quot;);
 727   return lock;
 728 }
 729 
 730 // Set the initialization lock to null so the object can be GC&#39;ed.  Any racing
 731 // threads to get this lock will see a null lock and will not lock.
 732 // That&#39;s okay because they all check for initialized state after getting
 733 // the lock and return.
 734 void InstanceKlass::fence_and_clear_init_lock() {
 735   // make sure previous stores are all done, notably the init_state.
 736   OrderAccess::storestore();
<a name="5" id="anc5"></a><span class="line-modified"> 737   java_lang_Class::set_init_lock(java_mirror(), NULL);</span>
 738   assert(!is_not_initialized(), &quot;class must be initialized now&quot;);
 739 }
 740 
 741 void InstanceKlass::eager_initialize_impl() {
 742   EXCEPTION_MARK;
 743   HandleMark hm(THREAD);
 744   Handle h_init_lock(THREAD, init_lock());
 745   ObjectLocker ol(h_init_lock, THREAD, h_init_lock() != NULL);
 746 
 747   // abort if someone beat us to the initialization
 748   if (!is_not_initialized()) return;  // note: not equivalent to is_initialized()
 749 
 750   ClassState old_state = init_state();
 751   link_class_impl(THREAD);
 752   if (HAS_PENDING_EXCEPTION) {
 753     CLEAR_PENDING_EXCEPTION;
 754     // Abort if linking the class throws an exception.
 755 
 756     // Use a test to avoid redundantly resetting the state if there&#39;s
 757     // no change.  Set_init_state() asserts that state changes make
 758     // progress, whereas here we might just be spinning in place.
 759     if (old_state != _init_state)
 760       set_init_state(old_state);
 761   } else {
 762     // linking successfull, mark class as initialized
 763     set_init_state(fully_initialized);
 764     fence_and_clear_init_lock();
 765     // trace
 766     if (log_is_enabled(Info, class, init)) {
 767       ResourceMark rm(THREAD);
 768       log_info(class, init)(&quot;[Initialized %s without side effects]&quot;, external_name());
 769     }
 770   }
 771 }
 772 
 773 
 774 // See &quot;The Virtual Machine Specification&quot; section 2.16.5 for a detailed explanation of the class initialization
 775 // process. The step comments refers to the procedure described in that section.
 776 // Note: implementation moved to static method to expose the this pointer.
 777 void InstanceKlass::initialize(TRAPS) {
 778   if (this-&gt;should_be_initialized()) {
 779     initialize_impl(CHECK);
 780     // Note: at this point the class may be initialized
 781     //       OR it may be in the state of being initialized
 782     //       in case of recursive initialization!
 783   } else {
 784     assert(is_initialized(), &quot;sanity check&quot;);
 785   }
 786 }
 787 
 788 
 789 bool InstanceKlass::verify_code(TRAPS) {
 790   // 1) Verify the bytecodes
 791   return Verifier::verify(this, should_verify_class(), THREAD);
 792 }
 793 
 794 void InstanceKlass::link_class(TRAPS) {
 795   assert(is_loaded(), &quot;must be loaded&quot;);
 796   if (!is_linked()) {
 797     link_class_impl(CHECK);
 798   }
 799 }
 800 
 801 // Called to verify that a class can link during initialization, without
 802 // throwing a VerifyError.
 803 bool InstanceKlass::link_class_or_fail(TRAPS) {
 804   assert(is_loaded(), &quot;must be loaded&quot;);
 805   if (!is_linked()) {
 806     link_class_impl(CHECK_false);
 807   }
 808   return is_linked();
 809 }
 810 
 811 bool InstanceKlass::link_class_impl(TRAPS) {
 812   if (DumpSharedSpaces &amp;&amp; SystemDictionaryShared::has_class_failed_verification(this)) {
 813     // This is for CDS dumping phase only -- we use the in_error_state to indicate that
 814     // the class has failed verification. Throwing the NoClassDefFoundError here is just
 815     // a convenient way to stop repeat attempts to verify the same (bad) class.
 816     //
 817     // Note that the NoClassDefFoundError is not part of the JLS, and should not be thrown
 818     // if we are executing Java code. This is not a problem for CDS dumping phase since
 819     // it doesn&#39;t execute any Java code.
 820     ResourceMark rm(THREAD);
 821     Exceptions::fthrow(THREAD_AND_LOCATION,
 822                        vmSymbols::java_lang_NoClassDefFoundError(),
 823                        &quot;Class %s, or one of its supertypes, failed class initialization&quot;,
 824                        external_name());
 825     return false;
 826   }
 827   // return if already verified
 828   if (is_linked()) {
 829     return true;
 830   }
 831 
 832   // Timing
 833   // timer handles recursion
 834   assert(THREAD-&gt;is_Java_thread(), &quot;non-JavaThread in link_class_impl&quot;);
 835   JavaThread* jt = (JavaThread*)THREAD;
 836 
 837   // link super class before linking this class
 838   Klass* super_klass = super();
 839   if (super_klass != NULL) {
 840     if (super_klass-&gt;is_interface()) {  // check if super class is an interface
 841       ResourceMark rm(THREAD);
 842       Exceptions::fthrow(
 843         THREAD_AND_LOCATION,
 844         vmSymbols::java_lang_IncompatibleClassChangeError(),
 845         &quot;class %s has interface %s as super class&quot;,
 846         external_name(),
 847         super_klass-&gt;external_name()
 848       );
 849       return false;
 850     }
 851 
 852     InstanceKlass* ik_super = InstanceKlass::cast(super_klass);
 853     ik_super-&gt;link_class_impl(CHECK_false);
 854   }
 855 
 856   // link all interfaces implemented by this class before linking this class
 857   Array&lt;InstanceKlass*&gt;* interfaces = local_interfaces();
 858   int num_interfaces = interfaces-&gt;length();
 859   for (int index = 0; index &lt; num_interfaces; index++) {
 860     InstanceKlass* interk = interfaces-&gt;at(index);
 861     interk-&gt;link_class_impl(CHECK_false);
 862   }
 863 
 864   // in case the class is linked in the process of linking its superclasses
 865   if (is_linked()) {
 866     return true;
 867   }
 868 
 869   // trace only the link time for this klass that includes
 870   // the verification time
 871   PerfClassTraceTime vmtimer(ClassLoader::perf_class_link_time(),
 872                              ClassLoader::perf_class_link_selftime(),
 873                              ClassLoader::perf_classes_linked(),
 874                              jt-&gt;get_thread_stat()-&gt;perf_recursion_counts_addr(),
 875                              jt-&gt;get_thread_stat()-&gt;perf_timers_addr(),
 876                              PerfClassTraceTime::CLASS_LINK);
 877 
 878   // verification &amp; rewriting
 879   {
 880     HandleMark hm(THREAD);
 881     Handle h_init_lock(THREAD, init_lock());
 882     ObjectLocker ol(h_init_lock, THREAD, h_init_lock() != NULL);
 883     // rewritten will have been set if loader constraint error found
 884     // on an earlier link attempt
 885     // don&#39;t verify or rewrite if already rewritten
 886     //
 887 
 888     if (!is_linked()) {
 889       if (!is_rewritten()) {
 890         {
 891           bool verify_ok = verify_code(THREAD);
 892           if (!verify_ok) {
 893             return false;
 894           }
 895         }
 896 
 897         // Just in case a side-effect of verify linked this class already
 898         // (which can sometimes happen since the verifier loads classes
 899         // using custom class loaders, which are free to initialize things)
 900         if (is_linked()) {
 901           return true;
 902         }
 903 
 904         // also sets rewritten
 905         rewrite_class(CHECK_false);
 906       } else if (is_shared()) {
 907         SystemDictionaryShared::check_verification_constraints(this, CHECK_false);
 908       }
 909 
 910       // relocate jsrs and link methods after they are all rewritten
 911       link_methods(CHECK_false);
 912 
 913       // Initialize the vtable and interface table after
 914       // methods have been rewritten since rewrite may
 915       // fabricate new Method*s.
 916       // also does loader constraint checking
 917       //
 918       // initialize_vtable and initialize_itable need to be rerun
 919       // for a shared class if
 920       // 1) the class is loaded by custom class loader or
 921       // 2) the class is loaded by built-in class loader but failed to add archived loader constraints
 922       bool need_init_table = true;
 923       if (is_shared() &amp;&amp; SystemDictionaryShared::check_linking_constraints(this, THREAD)) {
 924         need_init_table = false;
 925       }
 926       if (need_init_table) {
 927         vtable().initialize_vtable(true, CHECK_false);
 928         itable().initialize_itable(true, CHECK_false);
 929       }
 930 #ifdef ASSERT
 931       vtable().verify(tty, true);
 932       // In case itable verification is ever added.
 933       // itable().verify(tty, true);
 934 #endif
 935       set_init_state(linked);
 936       if (JvmtiExport::should_post_class_prepare()) {
 937         Thread *thread = THREAD;
 938         assert(thread-&gt;is_Java_thread(), &quot;thread-&gt;is_Java_thread()&quot;);
 939         JvmtiExport::post_class_prepare((JavaThread *) thread, this);
 940       }
 941     }
 942   }
 943   return true;
 944 }
 945 
 946 // Rewrite the byte codes of all of the methods of a class.
 947 // The rewriter must be called exactly once. Rewriting must happen after
 948 // verification but before the first method of the class is executed.
 949 void InstanceKlass::rewrite_class(TRAPS) {
 950   assert(is_loaded(), &quot;must be loaded&quot;);
 951   if (is_rewritten()) {
 952     assert(is_shared(), &quot;rewriting an unshared class?&quot;);
 953     return;
 954   }
 955   Rewriter::rewrite(this, CHECK);
 956   set_rewritten();
 957 }
 958 
 959 // Now relocate and link method entry points after class is rewritten.
 960 // This is outside is_rewritten flag. In case of an exception, it can be
 961 // executed more than once.
 962 void InstanceKlass::link_methods(TRAPS) {
 963   int len = methods()-&gt;length();
 964   for (int i = len-1; i &gt;= 0; i--) {
 965     methodHandle m(THREAD, methods()-&gt;at(i));
 966 
 967     // Set up method entry points for compiler and interpreter    .
 968     m-&gt;link_method(m, CHECK);
 969   }
 970 }
 971 
 972 // Eagerly initialize superinterfaces that declare default methods (concrete instance: any access)
 973 void InstanceKlass::initialize_super_interfaces(TRAPS) {
 974   assert (has_nonstatic_concrete_methods(), &quot;caller should have checked this&quot;);
 975   for (int i = 0; i &lt; local_interfaces()-&gt;length(); ++i) {
 976     InstanceKlass* ik = local_interfaces()-&gt;at(i);
 977 
 978     // Initialization is depth first search ie. we start with top of the inheritance tree
 979     // has_nonstatic_concrete_methods drives searching superinterfaces since it
 980     // means has_nonstatic_concrete_methods in its superinterface hierarchy
 981     if (ik-&gt;has_nonstatic_concrete_methods()) {
 982       ik-&gt;initialize_super_interfaces(CHECK);
 983     }
 984 
 985     // Only initialize() interfaces that &quot;declare&quot; concrete methods.
 986     if (ik-&gt;should_be_initialized() &amp;&amp; ik-&gt;declares_nonstatic_concrete_methods()) {
 987       ik-&gt;initialize(CHECK);
 988     }
 989   }
 990 }
 991 
 992 void InstanceKlass::initialize_impl(TRAPS) {
 993   HandleMark hm(THREAD);
 994 
 995   // Make sure klass is linked (verified) before initialization
 996   // A class could already be verified, since it has been reflected upon.
 997   link_class(CHECK);
 998 
 999   DTRACE_CLASSINIT_PROBE(required, -1);
1000 
1001   bool wait = false;
1002 
1003   assert(THREAD-&gt;is_Java_thread(), &quot;non-JavaThread in initialize_impl&quot;);
1004   JavaThread* jt = (JavaThread*)THREAD;
1005 
1006   // refer to the JVM book page 47 for description of steps
1007   // Step 1
1008   {
1009     Handle h_init_lock(THREAD, init_lock());
1010     ObjectLocker ol(h_init_lock, THREAD, h_init_lock() != NULL);
1011 
1012     // Step 2
1013     // If we were to use wait() instead of waitInterruptibly() then
1014     // we might end up throwing IE from link/symbol resolution sites
1015     // that aren&#39;t expected to throw.  This would wreak havoc.  See 6320309.
1016     while (is_being_initialized() &amp;&amp; !is_reentrant_initialization(jt)) {
1017       wait = true;
1018       jt-&gt;set_class_to_be_initialized(this);
1019       ol.wait_uninterruptibly(jt);
1020       jt-&gt;set_class_to_be_initialized(NULL);
1021     }
1022 
1023     // Step 3
1024     if (is_being_initialized() &amp;&amp; is_reentrant_initialization(jt)) {
1025       DTRACE_CLASSINIT_PROBE_WAIT(recursive, -1, wait);
1026       return;
1027     }
1028 
1029     // Step 4
1030     if (is_initialized()) {
1031       DTRACE_CLASSINIT_PROBE_WAIT(concurrent, -1, wait);
1032       return;
1033     }
1034 
1035     // Step 5
1036     if (is_in_error_state()) {
1037       DTRACE_CLASSINIT_PROBE_WAIT(erroneous, -1, wait);
1038       ResourceMark rm(THREAD);
1039       const char* desc = &quot;Could not initialize class &quot;;
1040       const char* className = external_name();
1041       size_t msglen = strlen(desc) + strlen(className) + 1;
1042       char* message = NEW_RESOURCE_ARRAY(char, msglen);
1043       if (NULL == message) {
1044         // Out of memory: can&#39;t create detailed error message
1045           THROW_MSG(vmSymbols::java_lang_NoClassDefFoundError(), className);
1046       } else {
1047         jio_snprintf(message, msglen, &quot;%s%s&quot;, desc, className);
1048           THROW_MSG(vmSymbols::java_lang_NoClassDefFoundError(), message);
1049       }
1050     }
1051 
1052     // Step 6
1053     set_init_state(being_initialized);
1054     set_init_thread(jt);
1055   }
1056 
1057   // Step 7
1058   // Next, if C is a class rather than an interface, initialize it&#39;s super class and super
1059   // interfaces.
1060   if (!is_interface()) {
1061     Klass* super_klass = super();
1062     if (super_klass != NULL &amp;&amp; super_klass-&gt;should_be_initialized()) {
1063       super_klass-&gt;initialize(THREAD);
1064     }
1065     // If C implements any interface that declares a non-static, concrete method,
1066     // the initialization of C triggers initialization of its super interfaces.
1067     // Only need to recurse if has_nonstatic_concrete_methods which includes declaring and
1068     // having a superinterface that declares, non-static, concrete methods
1069     if (!HAS_PENDING_EXCEPTION &amp;&amp; has_nonstatic_concrete_methods()) {
1070       initialize_super_interfaces(THREAD);
1071     }
1072 
1073     // If any exceptions, complete abruptly, throwing the same exception as above.
1074     if (HAS_PENDING_EXCEPTION) {
1075       Handle e(THREAD, PENDING_EXCEPTION);
1076       CLEAR_PENDING_EXCEPTION;
1077       {
1078         EXCEPTION_MARK;
1079         // Locks object, set state, and notify all waiting threads
1080         set_initialization_state_and_notify(initialization_error, THREAD);
1081         CLEAR_PENDING_EXCEPTION;
1082       }
1083       DTRACE_CLASSINIT_PROBE_WAIT(super__failed, -1, wait);
1084       THROW_OOP(e());
1085     }
1086   }
1087 
1088 
1089   // Look for aot compiled methods for this klass, including class initializer.
1090   AOTLoader::load_for_klass(this, THREAD);
1091 
1092   // Step 8
1093   {
1094     DTRACE_CLASSINIT_PROBE_WAIT(clinit, -1, wait);
1095     // Timer includes any side effects of class initialization (resolution,
1096     // etc), but not recursive entry into call_class_initializer().
1097     PerfClassTraceTime timer(ClassLoader::perf_class_init_time(),
1098                              ClassLoader::perf_class_init_selftime(),
1099                              ClassLoader::perf_classes_inited(),
1100                              jt-&gt;get_thread_stat()-&gt;perf_recursion_counts_addr(),
1101                              jt-&gt;get_thread_stat()-&gt;perf_timers_addr(),
1102                              PerfClassTraceTime::CLASS_CLINIT);
1103     call_class_initializer(THREAD);
1104   }
1105 
1106   // Step 9
1107   if (!HAS_PENDING_EXCEPTION) {
1108     set_initialization_state_and_notify(fully_initialized, CHECK);
1109     {
1110       debug_only(vtable().verify(tty, true);)
1111     }
1112   }
1113   else {
1114     // Step 10 and 11
1115     Handle e(THREAD, PENDING_EXCEPTION);
1116     CLEAR_PENDING_EXCEPTION;
1117     // JVMTI has already reported the pending exception
1118     // JVMTI internal flag reset is needed in order to report ExceptionInInitializerError
1119     JvmtiExport::clear_detected_exception(jt);
1120     {
1121       EXCEPTION_MARK;
1122       set_initialization_state_and_notify(initialization_error, THREAD);
1123       CLEAR_PENDING_EXCEPTION;   // ignore any exception thrown, class initialization error is thrown below
1124       // JVMTI has already reported the pending exception
1125       // JVMTI internal flag reset is needed in order to report ExceptionInInitializerError
1126       JvmtiExport::clear_detected_exception(jt);
1127     }
1128     DTRACE_CLASSINIT_PROBE_WAIT(error, -1, wait);
1129     if (e-&gt;is_a(SystemDictionary::Error_klass())) {
1130       THROW_OOP(e());
1131     } else {
1132       JavaCallArguments args(e);
1133       THROW_ARG(vmSymbols::java_lang_ExceptionInInitializerError(),
1134                 vmSymbols::throwable_void_signature(),
1135                 &amp;args);
1136     }
1137   }
1138   DTRACE_CLASSINIT_PROBE_WAIT(end, -1, wait);
1139 }
1140 
1141 
1142 void InstanceKlass::set_initialization_state_and_notify(ClassState state, TRAPS) {
1143   Handle h_init_lock(THREAD, init_lock());
1144   if (h_init_lock() != NULL) {
1145     ObjectLocker ol(h_init_lock, THREAD);
1146     set_init_thread(NULL); // reset _init_thread before changing _init_state
1147     set_init_state(state);
1148     fence_and_clear_init_lock();
1149     ol.notify_all(CHECK);
1150   } else {
1151     assert(h_init_lock() != NULL, &quot;The initialization state should never be set twice&quot;);
1152     set_init_thread(NULL); // reset _init_thread before changing _init_state
1153     set_init_state(state);
1154   }
1155 }
1156 
1157 Klass* InstanceKlass::implementor() const {
1158   Klass* volatile* k = adr_implementor();
1159   if (k == NULL) {
1160     return NULL;
1161   } else {
1162     // This load races with inserts, and therefore needs acquire.
1163     Klass* kls = Atomic::load_acquire(k);
1164     if (kls != NULL &amp;&amp; !kls-&gt;is_loader_alive()) {
1165       return NULL;  // don&#39;t return unloaded class
1166     } else {
1167       return kls;
1168     }
1169   }
1170 }
1171 
1172 
1173 void InstanceKlass::set_implementor(Klass* k) {
1174   assert_locked_or_safepoint(Compile_lock);
1175   assert(is_interface(), &quot;not interface&quot;);
1176   Klass* volatile* addr = adr_implementor();
1177   assert(addr != NULL, &quot;null addr&quot;);
1178   if (addr != NULL) {
1179     Atomic::release_store(addr, k);
1180   }
1181 }
1182 
1183 int  InstanceKlass::nof_implementors() const {
1184   Klass* k = implementor();
1185   if (k == NULL) {
1186     return 0;
1187   } else if (k != this) {
1188     return 1;
1189   } else {
1190     return 2;
1191   }
1192 }
1193 
1194 // The embedded _implementor field can only record one implementor.
1195 // When there are more than one implementors, the _implementor field
1196 // is set to the interface Klass* itself. Following are the possible
1197 // values for the _implementor field:
1198 //   NULL                  - no implementor
1199 //   implementor Klass*    - one implementor
1200 //   self                  - more than one implementor
1201 //
1202 // The _implementor field only exists for interfaces.
1203 void InstanceKlass::add_implementor(Klass* k) {
1204   if (Universe::is_fully_initialized()) {
1205     assert_lock_strong(Compile_lock);
1206   }
1207   assert(is_interface(), &quot;not interface&quot;);
1208   // Filter out my subinterfaces.
1209   // (Note: Interfaces are never on the subklass list.)
1210   if (InstanceKlass::cast(k)-&gt;is_interface()) return;
1211 
1212   // Filter out subclasses whose supers already implement me.
1213   // (Note: CHA must walk subclasses of direct implementors
1214   // in order to locate indirect implementors.)
1215   Klass* sk = k-&gt;super();
1216   if (sk != NULL &amp;&amp; InstanceKlass::cast(sk)-&gt;implements_interface(this))
1217     // We only need to check one immediate superclass, since the
1218     // implements_interface query looks at transitive_interfaces.
1219     // Any supers of the super have the same (or fewer) transitive_interfaces.
1220     return;
1221 
1222   Klass* ik = implementor();
1223   if (ik == NULL) {
1224     set_implementor(k);
1225   } else if (ik != this &amp;&amp; ik != k) {
1226     // There is already an implementor. Use itself as an indicator of
1227     // more than one implementors.
1228     set_implementor(this);
1229   }
1230 
1231   // The implementor also implements the transitive_interfaces
1232   for (int index = 0; index &lt; local_interfaces()-&gt;length(); index++) {
1233     InstanceKlass::cast(local_interfaces()-&gt;at(index))-&gt;add_implementor(k);
1234   }
1235 }
1236 
1237 void InstanceKlass::init_implementor() {
1238   if (is_interface()) {
1239     set_implementor(NULL);
1240   }
1241 }
1242 
1243 
1244 void InstanceKlass::process_interfaces(Thread *thread) {
1245   // link this class into the implementors list of every interface it implements
1246   for (int i = local_interfaces()-&gt;length() - 1; i &gt;= 0; i--) {
1247     assert(local_interfaces()-&gt;at(i)-&gt;is_klass(), &quot;must be a klass&quot;);
1248     InstanceKlass* interf = InstanceKlass::cast(local_interfaces()-&gt;at(i));
1249     assert(interf-&gt;is_interface(), &quot;expected interface&quot;);
1250     interf-&gt;add_implementor(this);
1251   }
1252 }
1253 
1254 bool InstanceKlass::can_be_primary_super_slow() const {
1255   if (is_interface())
1256     return false;
1257   else
1258     return Klass::can_be_primary_super_slow();
1259 }
1260 
1261 GrowableArray&lt;Klass*&gt;* InstanceKlass::compute_secondary_supers(int num_extra_slots,
1262                                                                Array&lt;InstanceKlass*&gt;* transitive_interfaces) {
1263   // The secondaries are the implemented interfaces.
1264   Array&lt;InstanceKlass*&gt;* interfaces = transitive_interfaces;
1265   int num_secondaries = num_extra_slots + interfaces-&gt;length();
1266   if (num_secondaries == 0) {
1267     // Must share this for correct bootstrapping!
1268     set_secondary_supers(Universe::the_empty_klass_array());
1269     return NULL;
1270   } else if (num_extra_slots == 0) {
1271     // The secondary super list is exactly the same as the transitive interfaces, so
1272     // let&#39;s use it instead of making a copy.
1273     // Redefine classes has to be careful not to delete this!
1274     // We need the cast because Array&lt;Klass*&gt; is NOT a supertype of Array&lt;InstanceKlass*&gt;,
1275     // (but it&#39;s safe to do here because we won&#39;t write into _secondary_supers from this point on).
1276     set_secondary_supers((Array&lt;Klass*&gt;*)(address)interfaces);
1277     return NULL;
1278   } else {
1279     // Copy transitive interfaces to a temporary growable array to be constructed
1280     // into the secondary super list with extra slots.
1281     GrowableArray&lt;Klass*&gt;* secondaries = new GrowableArray&lt;Klass*&gt;(interfaces-&gt;length());
1282     for (int i = 0; i &lt; interfaces-&gt;length(); i++) {
1283       secondaries-&gt;push(interfaces-&gt;at(i));
1284     }
1285     return secondaries;
1286   }
1287 }
1288 
1289 bool InstanceKlass::implements_interface(Klass* k) const {
1290   if (this == k) return true;
1291   assert(k-&gt;is_interface(), &quot;should be an interface class&quot;);
1292   for (int i = 0; i &lt; transitive_interfaces()-&gt;length(); i++) {
1293     if (transitive_interfaces()-&gt;at(i) == k) {
1294       return true;
1295     }
1296   }
1297   return false;
1298 }
1299 
1300 bool InstanceKlass::is_same_or_direct_interface(Klass *k) const {
1301   // Verify direct super interface
1302   if (this == k) return true;
1303   assert(k-&gt;is_interface(), &quot;should be an interface class&quot;);
1304   for (int i = 0; i &lt; local_interfaces()-&gt;length(); i++) {
1305     if (local_interfaces()-&gt;at(i) == k) {
1306       return true;
1307     }
1308   }
1309   return false;
1310 }
1311 
1312 objArrayOop InstanceKlass::allocate_objArray(int n, int length, TRAPS) {
1313   check_array_allocation_length(length, arrayOopDesc::max_array_length(T_OBJECT), CHECK_NULL);
1314   int size = objArrayOopDesc::object_size(length);
1315   Klass* ak = array_klass(n, CHECK_NULL);
1316   objArrayOop o = (objArrayOop)Universe::heap()-&gt;array_allocate(ak, size, length,
1317                                                                 /* do_zero */ true, CHECK_NULL);
1318   return o;
1319 }
1320 
1321 instanceOop InstanceKlass::register_finalizer(instanceOop i, TRAPS) {
1322   if (TraceFinalizerRegistration) {
1323     tty-&gt;print(&quot;Registered &quot;);
1324     i-&gt;print_value_on(tty);
1325     tty-&gt;print_cr(&quot; (&quot; INTPTR_FORMAT &quot;) as finalizable&quot;, p2i(i));
1326   }
1327   instanceHandle h_i(THREAD, i);
1328   // Pass the handle as argument, JavaCalls::call expects oop as jobjects
1329   JavaValue result(T_VOID);
1330   JavaCallArguments args(h_i);
1331   methodHandle mh (THREAD, Universe::finalizer_register_method());
1332   JavaCalls::call(&amp;result, mh, &amp;args, CHECK_NULL);
1333   return h_i();
1334 }
1335 
1336 instanceOop InstanceKlass::allocate_instance(TRAPS) {
1337   bool has_finalizer_flag = has_finalizer(); // Query before possible GC
1338   int size = size_helper();  // Query before forming handle.
1339 
1340   instanceOop i;
1341 
1342   i = (instanceOop)Universe::heap()-&gt;obj_allocate(this, size, CHECK_NULL);
1343   if (has_finalizer_flag &amp;&amp; !RegisterFinalizersAtInit) {
1344     i = register_finalizer(i, CHECK_NULL);
1345   }
1346   return i;
1347 }
1348 
1349 instanceHandle InstanceKlass::allocate_instance_handle(TRAPS) {
1350   return instanceHandle(THREAD, allocate_instance(THREAD));
1351 }
1352 
1353 void InstanceKlass::check_valid_for_instantiation(bool throwError, TRAPS) {
1354   if (is_interface() || is_abstract()) {
1355     ResourceMark rm(THREAD);
1356     THROW_MSG(throwError ? vmSymbols::java_lang_InstantiationError()
1357               : vmSymbols::java_lang_InstantiationException(), external_name());
1358   }
1359   if (this == SystemDictionary::Class_klass()) {
1360     ResourceMark rm(THREAD);
1361     THROW_MSG(throwError ? vmSymbols::java_lang_IllegalAccessError()
1362               : vmSymbols::java_lang_IllegalAccessException(), external_name());
1363   }
1364 }
1365 
1366 Klass* InstanceKlass::array_klass_impl(bool or_null, int n, TRAPS) {
1367   // Need load-acquire for lock-free read
1368   if (array_klasses_acquire() == NULL) {
1369     if (or_null) return NULL;
1370 
1371     ResourceMark rm(THREAD);
1372     JavaThread *jt = (JavaThread *)THREAD;
1373     {
1374       // Atomic creation of array_klasses
1375       MutexLocker ma(THREAD, MultiArray_lock);
1376 
1377       // Check if update has already taken place
1378       if (array_klasses() == NULL) {
1379         ObjArrayKlass* k = ObjArrayKlass::allocate_objArray_klass(class_loader_data(), 1, this, CHECK_NULL);
1380         // use &#39;release&#39; to pair with lock-free load
1381         release_set_array_klasses(k);
1382       }
1383     }
1384   }
1385   // _this will always be set at this point
1386   ObjArrayKlass* oak = array_klasses();
1387   if (or_null) {
1388     return oak-&gt;array_klass_or_null(n);
1389   }
1390   return oak-&gt;array_klass(n, THREAD);
1391 }
1392 
1393 Klass* InstanceKlass::array_klass_impl(bool or_null, TRAPS) {
1394   return array_klass_impl(or_null, 1, THREAD);
1395 }
1396 
1397 static int call_class_initializer_counter = 0;   // for debugging
1398 
1399 Method* InstanceKlass::class_initializer() const {
1400   Method* clinit = find_method(
1401       vmSymbols::class_initializer_name(), vmSymbols::void_method_signature());
1402   if (clinit != NULL &amp;&amp; clinit-&gt;has_valid_initializer_flags()) {
1403     return clinit;
1404   }
1405   return NULL;
1406 }
1407 
1408 void InstanceKlass::call_class_initializer(TRAPS) {
1409   if (ReplayCompiles &amp;&amp;
1410       (ReplaySuppressInitializers == 1 ||
1411        (ReplaySuppressInitializers &gt;= 2 &amp;&amp; class_loader() != NULL))) {
1412     // Hide the existence of the initializer for the purpose of replaying the compile
1413     return;
1414   }
1415 
1416   methodHandle h_method(THREAD, class_initializer());
1417   assert(!is_initialized(), &quot;we cannot initialize twice&quot;);
1418   LogTarget(Info, class, init) lt;
1419   if (lt.is_enabled()) {
1420     ResourceMark rm(THREAD);
1421     LogStream ls(lt);
1422     ls.print(&quot;%d Initializing &quot;, call_class_initializer_counter++);
1423     name()-&gt;print_value_on(&amp;ls);
1424     ls.print_cr(&quot;%s (&quot; INTPTR_FORMAT &quot;)&quot;, h_method() == NULL ? &quot;(no method)&quot; : &quot;&quot;, p2i(this));
1425   }
1426   if (h_method() != NULL) {
1427     JavaCallArguments args; // No arguments
1428     JavaValue result(T_VOID);
1429     JavaCalls::call(&amp;result, h_method, &amp;args, CHECK); // Static call (no args)
1430   }
1431 }
1432 
1433 
1434 void InstanceKlass::mask_for(const methodHandle&amp; method, int bci,
1435   InterpreterOopMap* entry_for) {
1436   // Lazily create the _oop_map_cache at first request
1437   // Lock-free access requires load_acquire.
1438   OopMapCache* oop_map_cache = Atomic::load_acquire(&amp;_oop_map_cache);
1439   if (oop_map_cache == NULL) {
1440     MutexLocker x(OopMapCacheAlloc_lock);
1441     // Check if _oop_map_cache was allocated while we were waiting for this lock
1442     if ((oop_map_cache = _oop_map_cache) == NULL) {
1443       oop_map_cache = new OopMapCache();
1444       // Ensure _oop_map_cache is stable, since it is examined without a lock
1445       Atomic::release_store(&amp;_oop_map_cache, oop_map_cache);
1446     }
1447   }
1448   // _oop_map_cache is constant after init; lookup below does its own locking.
1449   oop_map_cache-&gt;lookup(method, bci, entry_for);
1450 }
1451 
1452 bool InstanceKlass::contains_field_offset(int offset) {
1453   fieldDescriptor fd;
1454   return find_field_from_offset(offset, false, &amp;fd);
1455 }
1456 
1457 bool InstanceKlass::find_local_field(Symbol* name, Symbol* sig, fieldDescriptor* fd) const {
1458   for (JavaFieldStream fs(this); !fs.done(); fs.next()) {
1459     Symbol* f_name = fs.name();
1460     Symbol* f_sig  = fs.signature();
1461     if (f_name == name &amp;&amp; f_sig == sig) {
1462       fd-&gt;reinitialize(const_cast&lt;InstanceKlass*&gt;(this), fs.index());
1463       return true;
1464     }
1465   }
1466   return false;
1467 }
1468 
1469 
1470 Klass* InstanceKlass::find_interface_field(Symbol* name, Symbol* sig, fieldDescriptor* fd) const {
1471   const int n = local_interfaces()-&gt;length();
1472   for (int i = 0; i &lt; n; i++) {
1473     Klass* intf1 = local_interfaces()-&gt;at(i);
1474     assert(intf1-&gt;is_interface(), &quot;just checking type&quot;);
1475     // search for field in current interface
1476     if (InstanceKlass::cast(intf1)-&gt;find_local_field(name, sig, fd)) {
1477       assert(fd-&gt;is_static(), &quot;interface field must be static&quot;);
1478       return intf1;
1479     }
1480     // search for field in direct superinterfaces
1481     Klass* intf2 = InstanceKlass::cast(intf1)-&gt;find_interface_field(name, sig, fd);
1482     if (intf2 != NULL) return intf2;
1483   }
1484   // otherwise field lookup fails
1485   return NULL;
1486 }
1487 
1488 
1489 Klass* InstanceKlass::find_field(Symbol* name, Symbol* sig, fieldDescriptor* fd) const {
1490   // search order according to newest JVM spec (5.4.3.2, p.167).
1491   // 1) search for field in current klass
1492   if (find_local_field(name, sig, fd)) {
1493     return const_cast&lt;InstanceKlass*&gt;(this);
1494   }
1495   // 2) search for field recursively in direct superinterfaces
1496   { Klass* intf = find_interface_field(name, sig, fd);
1497     if (intf != NULL) return intf;
1498   }
1499   // 3) apply field lookup recursively if superclass exists
1500   { Klass* supr = super();
1501     if (supr != NULL) return InstanceKlass::cast(supr)-&gt;find_field(name, sig, fd);
1502   }
1503   // 4) otherwise field lookup fails
1504   return NULL;
1505 }
1506 
1507 
1508 Klass* InstanceKlass::find_field(Symbol* name, Symbol* sig, bool is_static, fieldDescriptor* fd) const {
1509   // search order according to newest JVM spec (5.4.3.2, p.167).
1510   // 1) search for field in current klass
1511   if (find_local_field(name, sig, fd)) {
1512     if (fd-&gt;is_static() == is_static) return const_cast&lt;InstanceKlass*&gt;(this);
1513   }
1514   // 2) search for field recursively in direct superinterfaces
1515   if (is_static) {
1516     Klass* intf = find_interface_field(name, sig, fd);
1517     if (intf != NULL) return intf;
1518   }
1519   // 3) apply field lookup recursively if superclass exists
1520   { Klass* supr = super();
1521     if (supr != NULL) return InstanceKlass::cast(supr)-&gt;find_field(name, sig, is_static, fd);
1522   }
1523   // 4) otherwise field lookup fails
1524   return NULL;
1525 }
1526 
1527 
1528 bool InstanceKlass::find_local_field_from_offset(int offset, bool is_static, fieldDescriptor* fd) const {
1529   for (JavaFieldStream fs(this); !fs.done(); fs.next()) {
1530     if (fs.offset() == offset) {
1531       fd-&gt;reinitialize(const_cast&lt;InstanceKlass*&gt;(this), fs.index());
1532       if (fd-&gt;is_static() == is_static) return true;
1533     }
1534   }
1535   return false;
1536 }
1537 
1538 
1539 bool InstanceKlass::find_field_from_offset(int offset, bool is_static, fieldDescriptor* fd) const {
1540   Klass* klass = const_cast&lt;InstanceKlass*&gt;(this);
1541   while (klass != NULL) {
1542     if (InstanceKlass::cast(klass)-&gt;find_local_field_from_offset(offset, is_static, fd)) {
1543       return true;
1544     }
1545     klass = klass-&gt;super();
1546   }
1547   return false;
1548 }
1549 
1550 
1551 void InstanceKlass::methods_do(void f(Method* method)) {
1552   // Methods aren&#39;t stable until they are loaded.  This can be read outside
1553   // a lock through the ClassLoaderData for profiling
1554   if (!is_loaded()) {
1555     return;
1556   }
1557 
1558   int len = methods()-&gt;length();
1559   for (int index = 0; index &lt; len; index++) {
1560     Method* m = methods()-&gt;at(index);
1561     assert(m-&gt;is_method(), &quot;must be method&quot;);
1562     f(m);
1563   }
1564 }
1565 
1566 
1567 void InstanceKlass::do_local_static_fields(FieldClosure* cl) {
1568   for (JavaFieldStream fs(this); !fs.done(); fs.next()) {
1569     if (fs.access_flags().is_static()) {
1570       fieldDescriptor&amp; fd = fs.field_descriptor();
1571       cl-&gt;do_field(&amp;fd);
1572     }
1573   }
1574 }
1575 
1576 
1577 void InstanceKlass::do_local_static_fields(void f(fieldDescriptor*, Handle, TRAPS), Handle mirror, TRAPS) {
1578   for (JavaFieldStream fs(this); !fs.done(); fs.next()) {
1579     if (fs.access_flags().is_static()) {
1580       fieldDescriptor&amp; fd = fs.field_descriptor();
1581       f(&amp;fd, mirror, CHECK);
1582     }
1583   }
1584 }
1585 
1586 
1587 static int compare_fields_by_offset(int* a, int* b) {
1588   return a[0] - b[0];
1589 }
1590 
1591 void InstanceKlass::do_nonstatic_fields(FieldClosure* cl) {
1592   InstanceKlass* super = superklass();
1593   if (super != NULL) {
1594     super-&gt;do_nonstatic_fields(cl);
1595   }
1596   fieldDescriptor fd;
1597   int length = java_fields_count();
1598   // In DebugInfo nonstatic fields are sorted by offset.
1599   int* fields_sorted = NEW_C_HEAP_ARRAY(int, 2*(length+1), mtClass);
1600   int j = 0;
1601   for (int i = 0; i &lt; length; i += 1) {
1602     fd.reinitialize(this, i);
1603     if (!fd.is_static()) {
1604       fields_sorted[j + 0] = fd.offset();
1605       fields_sorted[j + 1] = i;
1606       j += 2;
1607     }
1608   }
1609   if (j &gt; 0) {
1610     length = j;
1611     // _sort_Fn is defined in growableArray.hpp.
1612     qsort(fields_sorted, length/2, 2*sizeof(int), (_sort_Fn)compare_fields_by_offset);
1613     for (int i = 0; i &lt; length; i += 2) {
1614       fd.reinitialize(this, fields_sorted[i + 1]);
1615       assert(!fd.is_static() &amp;&amp; fd.offset() == fields_sorted[i], &quot;only nonstatic fields&quot;);
1616       cl-&gt;do_field(&amp;fd);
1617     }
1618   }
1619   FREE_C_HEAP_ARRAY(int, fields_sorted);
1620 }
1621 
1622 
1623 void InstanceKlass::array_klasses_do(void f(Klass* k, TRAPS), TRAPS) {
1624   if (array_klasses() != NULL)
1625     array_klasses()-&gt;array_klasses_do(f, THREAD);
1626 }
1627 
1628 void InstanceKlass::array_klasses_do(void f(Klass* k)) {
1629   if (array_klasses() != NULL)
1630     array_klasses()-&gt;array_klasses_do(f);
1631 }
1632 
1633 #ifdef ASSERT
1634 static int linear_search(const Array&lt;Method*&gt;* methods,
1635                          const Symbol* name,
1636                          const Symbol* signature) {
1637   const int len = methods-&gt;length();
1638   for (int index = 0; index &lt; len; index++) {
1639     const Method* const m = methods-&gt;at(index);
1640     assert(m-&gt;is_method(), &quot;must be method&quot;);
1641     if (m-&gt;signature() == signature &amp;&amp; m-&gt;name() == name) {
1642        return index;
1643     }
1644   }
1645   return -1;
1646 }
1647 #endif
1648 
1649 bool InstanceKlass::_disable_method_binary_search = false;
1650 
1651 NOINLINE int linear_search(const Array&lt;Method*&gt;* methods, const Symbol* name) {
1652   int len = methods-&gt;length();
1653   int l = 0;
1654   int h = len - 1;
1655   while (l &lt;= h) {
1656     Method* m = methods-&gt;at(l);
1657     if (m-&gt;name() == name) {
1658       return l;
1659     }
1660     l++;
1661   }
1662   return -1;
1663 }
1664 
1665 inline int InstanceKlass::quick_search(const Array&lt;Method*&gt;* methods, const Symbol* name) {
1666   if (_disable_method_binary_search) {
1667     assert(DynamicDumpSharedSpaces, &quot;must be&quot;);
1668     // At the final stage of dynamic dumping, the methods array may not be sorted
1669     // by ascending addresses of their names, so we can&#39;t use binary search anymore.
1670     // However, methods with the same name are still laid out consecutively inside the
1671     // methods array, so let&#39;s look for the first one that matches.
1672     return linear_search(methods, name);
1673   }
1674 
1675   int len = methods-&gt;length();
1676   int l = 0;
1677   int h = len - 1;
1678 
1679   // methods are sorted by ascending addresses of their names, so do binary search
1680   while (l &lt;= h) {
1681     int mid = (l + h) &gt;&gt; 1;
1682     Method* m = methods-&gt;at(mid);
1683     assert(m-&gt;is_method(), &quot;must be method&quot;);
1684     int res = m-&gt;name()-&gt;fast_compare(name);
1685     if (res == 0) {
1686       return mid;
1687     } else if (res &lt; 0) {
1688       l = mid + 1;
1689     } else {
1690       h = mid - 1;
1691     }
1692   }
1693   return -1;
1694 }
1695 
1696 // find_method looks up the name/signature in the local methods array
1697 Method* InstanceKlass::find_method(const Symbol* name,
1698                                    const Symbol* signature) const {
1699   return find_method_impl(name, signature, find_overpass, find_static, find_private);
1700 }
1701 
1702 Method* InstanceKlass::find_method_impl(const Symbol* name,
1703                                         const Symbol* signature,
1704                                         OverpassLookupMode overpass_mode,
1705                                         StaticLookupMode static_mode,
1706                                         PrivateLookupMode private_mode) const {
1707   return InstanceKlass::find_method_impl(methods(),
1708                                          name,
1709                                          signature,
1710                                          overpass_mode,
1711                                          static_mode,
1712                                          private_mode);
1713 }
1714 
1715 // find_instance_method looks up the name/signature in the local methods array
1716 // and skips over static methods
1717 Method* InstanceKlass::find_instance_method(const Array&lt;Method*&gt;* methods,
1718                                             const Symbol* name,
1719                                             const Symbol* signature,
1720                                             PrivateLookupMode private_mode) {
1721   Method* const meth = InstanceKlass::find_method_impl(methods,
1722                                                  name,
1723                                                  signature,
1724                                                  find_overpass,
1725                                                  skip_static,
1726                                                  private_mode);
1727   assert(((meth == NULL) || !meth-&gt;is_static()),
1728     &quot;find_instance_method should have skipped statics&quot;);
1729   return meth;
1730 }
1731 
1732 // find_instance_method looks up the name/signature in the local methods array
1733 // and skips over static methods
1734 Method* InstanceKlass::find_instance_method(const Symbol* name,
1735                                             const Symbol* signature,
1736                                             PrivateLookupMode private_mode) const {
1737   return InstanceKlass::find_instance_method(methods(), name, signature, private_mode);
1738 }
1739 
1740 // Find looks up the name/signature in the local methods array
1741 // and filters on the overpass, static and private flags
1742 // This returns the first one found
1743 // note that the local methods array can have up to one overpass, one static
1744 // and one instance (private or not) with the same name/signature
1745 Method* InstanceKlass::find_local_method(const Symbol* name,
1746                                          const Symbol* signature,
1747                                          OverpassLookupMode overpass_mode,
1748                                          StaticLookupMode static_mode,
1749                                          PrivateLookupMode private_mode) const {
1750   return InstanceKlass::find_method_impl(methods(),
1751                                          name,
1752                                          signature,
1753                                          overpass_mode,
1754                                          static_mode,
1755                                          private_mode);
1756 }
1757 
1758 // Find looks up the name/signature in the local methods array
1759 // and filters on the overpass, static and private flags
1760 // This returns the first one found
1761 // note that the local methods array can have up to one overpass, one static
1762 // and one instance (private or not) with the same name/signature
1763 Method* InstanceKlass::find_local_method(const Array&lt;Method*&gt;* methods,
1764                                          const Symbol* name,
1765                                          const Symbol* signature,
1766                                          OverpassLookupMode overpass_mode,
1767                                          StaticLookupMode static_mode,
1768                                          PrivateLookupMode private_mode) {
1769   return InstanceKlass::find_method_impl(methods,
1770                                          name,
1771                                          signature,
1772                                          overpass_mode,
1773                                          static_mode,
1774                                          private_mode);
1775 }
1776 
1777 Method* InstanceKlass::find_method(const Array&lt;Method*&gt;* methods,
1778                                    const Symbol* name,
1779                                    const Symbol* signature) {
1780   return InstanceKlass::find_method_impl(methods,
1781                                          name,
1782                                          signature,
1783                                          find_overpass,
1784                                          find_static,
1785                                          find_private);
1786 }
1787 
1788 Method* InstanceKlass::find_method_impl(const Array&lt;Method*&gt;* methods,
1789                                         const Symbol* name,
1790                                         const Symbol* signature,
1791                                         OverpassLookupMode overpass_mode,
1792                                         StaticLookupMode static_mode,
1793                                         PrivateLookupMode private_mode) {
1794   int hit = find_method_index(methods, name, signature, overpass_mode, static_mode, private_mode);
1795   return hit &gt;= 0 ? methods-&gt;at(hit): NULL;
1796 }
1797 
1798 // true if method matches signature and conforms to skipping_X conditions.
1799 static bool method_matches(const Method* m,
1800                            const Symbol* signature,
1801                            bool skipping_overpass,
1802                            bool skipping_static,
1803                            bool skipping_private) {
1804   return ((m-&gt;signature() == signature) &amp;&amp;
1805     (!skipping_overpass || !m-&gt;is_overpass()) &amp;&amp;
1806     (!skipping_static || !m-&gt;is_static()) &amp;&amp;
1807     (!skipping_private || !m-&gt;is_private()));
1808 }
1809 
1810 // Used directly for default_methods to find the index into the
1811 // default_vtable_indices, and indirectly by find_method
1812 // find_method_index looks in the local methods array to return the index
1813 // of the matching name/signature. If, overpass methods are being ignored,
1814 // the search continues to find a potential non-overpass match.  This capability
1815 // is important during method resolution to prefer a static method, for example,
1816 // over an overpass method.
1817 // There is the possibility in any _method&#39;s array to have the same name/signature
1818 // for a static method, an overpass method and a local instance method
1819 // To correctly catch a given method, the search criteria may need
1820 // to explicitly skip the other two. For local instance methods, it
1821 // is often necessary to skip private methods
1822 int InstanceKlass::find_method_index(const Array&lt;Method*&gt;* methods,
1823                                      const Symbol* name,
1824                                      const Symbol* signature,
1825                                      OverpassLookupMode overpass_mode,
1826                                      StaticLookupMode static_mode,
1827                                      PrivateLookupMode private_mode) {
1828   const bool skipping_overpass = (overpass_mode == skip_overpass);
1829   const bool skipping_static = (static_mode == skip_static);
1830   const bool skipping_private = (private_mode == skip_private);
1831   const int hit = quick_search(methods, name);
1832   if (hit != -1) {
1833     const Method* const m = methods-&gt;at(hit);
1834 
1835     // Do linear search to find matching signature.  First, quick check
1836     // for common case, ignoring overpasses if requested.
1837     if (method_matches(m, signature, skipping_overpass, skipping_static, skipping_private)) {
1838       return hit;
1839     }
1840 
1841     // search downwards through overloaded methods
1842     int i;
1843     for (i = hit - 1; i &gt;= 0; --i) {
1844         const Method* const m = methods-&gt;at(i);
1845         assert(m-&gt;is_method(), &quot;must be method&quot;);
1846         if (m-&gt;name() != name) {
1847           break;
1848         }
1849         if (method_matches(m, signature, skipping_overpass, skipping_static, skipping_private)) {
1850           return i;
1851         }
1852     }
1853     // search upwards
1854     for (i = hit + 1; i &lt; methods-&gt;length(); ++i) {
1855         const Method* const m = methods-&gt;at(i);
1856         assert(m-&gt;is_method(), &quot;must be method&quot;);
1857         if (m-&gt;name() != name) {
1858           break;
1859         }
1860         if (method_matches(m, signature, skipping_overpass, skipping_static, skipping_private)) {
1861           return i;
1862         }
1863     }
1864     // not found
1865 #ifdef ASSERT
1866     const int index = (skipping_overpass || skipping_static || skipping_private) ? -1 :
1867       linear_search(methods, name, signature);
1868     assert(-1 == index, &quot;binary search should have found entry %d&quot;, index);
1869 #endif
1870   }
1871   return -1;
1872 }
1873 
1874 int InstanceKlass::find_method_by_name(const Symbol* name, int* end) const {
1875   return find_method_by_name(methods(), name, end);
1876 }
1877 
1878 int InstanceKlass::find_method_by_name(const Array&lt;Method*&gt;* methods,
1879                                        const Symbol* name,
1880                                        int* end_ptr) {
1881   assert(end_ptr != NULL, &quot;just checking&quot;);
1882   int start = quick_search(methods, name);
1883   int end = start + 1;
1884   if (start != -1) {
1885     while (start - 1 &gt;= 0 &amp;&amp; (methods-&gt;at(start - 1))-&gt;name() == name) --start;
1886     while (end &lt; methods-&gt;length() &amp;&amp; (methods-&gt;at(end))-&gt;name() == name) ++end;
1887     *end_ptr = end;
1888     return start;
1889   }
1890   return -1;
1891 }
1892 
1893 // uncached_lookup_method searches both the local class methods array and all
1894 // superclasses methods arrays, skipping any overpass methods in superclasses,
1895 // and possibly skipping private methods.
1896 Method* InstanceKlass::uncached_lookup_method(const Symbol* name,
1897                                               const Symbol* signature,
1898                                               OverpassLookupMode overpass_mode,
1899                                               PrivateLookupMode private_mode) const {
1900   OverpassLookupMode overpass_local_mode = overpass_mode;
1901   const Klass* klass = this;
1902   while (klass != NULL) {
1903     Method* const method = InstanceKlass::cast(klass)-&gt;find_method_impl(name,
1904                                                                         signature,
1905                                                                         overpass_local_mode,
1906                                                                         find_static,
1907                                                                         private_mode);
1908     if (method != NULL) {
1909       return method;
1910     }
1911     klass = klass-&gt;super();
1912     overpass_local_mode = skip_overpass;   // Always ignore overpass methods in superclasses
1913   }
1914   return NULL;
1915 }
1916 
1917 #ifdef ASSERT
1918 // search through class hierarchy and return true if this class or
1919 // one of the superclasses was redefined
1920 bool InstanceKlass::has_redefined_this_or_super() const {
1921   const Klass* klass = this;
1922   while (klass != NULL) {
1923     if (InstanceKlass::cast(klass)-&gt;has_been_redefined()) {
1924       return true;
1925     }
1926     klass = klass-&gt;super();
1927   }
1928   return false;
1929 }
1930 #endif
1931 
1932 // lookup a method in the default methods list then in all transitive interfaces
1933 // Do NOT return private or static methods
1934 Method* InstanceKlass::lookup_method_in_ordered_interfaces(Symbol* name,
1935                                                          Symbol* signature) const {
1936   Method* m = NULL;
1937   if (default_methods() != NULL) {
1938     m = find_method(default_methods(), name, signature);
1939   }
1940   // Look up interfaces
1941   if (m == NULL) {
1942     m = lookup_method_in_all_interfaces(name, signature, find_defaults);
1943   }
1944   return m;
1945 }
1946 
1947 // lookup a method in all the interfaces that this class implements
1948 // Do NOT return private or static methods, new in JDK8 which are not externally visible
1949 // They should only be found in the initial InterfaceMethodRef
1950 Method* InstanceKlass::lookup_method_in_all_interfaces(Symbol* name,
1951                                                        Symbol* signature,
1952                                                        DefaultsLookupMode defaults_mode) const {
1953   Array&lt;InstanceKlass*&gt;* all_ifs = transitive_interfaces();
1954   int num_ifs = all_ifs-&gt;length();
1955   InstanceKlass *ik = NULL;
1956   for (int i = 0; i &lt; num_ifs; i++) {
1957     ik = all_ifs-&gt;at(i);
1958     Method* m = ik-&gt;lookup_method(name, signature);
1959     if (m != NULL &amp;&amp; m-&gt;is_public() &amp;&amp; !m-&gt;is_static() &amp;&amp;
1960         ((defaults_mode != skip_defaults) || !m-&gt;is_default_method())) {
1961       return m;
1962     }
1963   }
1964   return NULL;
1965 }
1966 
1967 /* jni_id_for_impl for jfieldIds only */
1968 JNIid* InstanceKlass::jni_id_for_impl(int offset) {
1969   MutexLocker ml(JfieldIdCreation_lock);
1970   // Retry lookup after we got the lock
1971   JNIid* probe = jni_ids() == NULL ? NULL : jni_ids()-&gt;find(offset);
1972   if (probe == NULL) {
1973     // Slow case, allocate new static field identifier
1974     probe = new JNIid(this, offset, jni_ids());
1975     set_jni_ids(probe);
1976   }
1977   return probe;
1978 }
1979 
1980 
1981 /* jni_id_for for jfieldIds only */
1982 JNIid* InstanceKlass::jni_id_for(int offset) {
1983   JNIid* probe = jni_ids() == NULL ? NULL : jni_ids()-&gt;find(offset);
1984   if (probe == NULL) {
1985     probe = jni_id_for_impl(offset);
1986   }
1987   return probe;
1988 }
1989 
1990 u2 InstanceKlass::enclosing_method_data(int offset) const {
1991   const Array&lt;jushort&gt;* const inner_class_list = inner_classes();
1992   if (inner_class_list == NULL) {
1993     return 0;
1994   }
1995   const int length = inner_class_list-&gt;length();
1996   if (length % inner_class_next_offset == 0) {
1997     return 0;
1998   }
1999   const int index = length - enclosing_method_attribute_size;
2000   assert(offset &lt; enclosing_method_attribute_size, &quot;invalid offset&quot;);
2001   return inner_class_list-&gt;at(index + offset);
2002 }
2003 
2004 void InstanceKlass::set_enclosing_method_indices(u2 class_index,
2005                                                  u2 method_index) {
2006   Array&lt;jushort&gt;* inner_class_list = inner_classes();
2007   assert (inner_class_list != NULL, &quot;_inner_classes list is not set up&quot;);
2008   int length = inner_class_list-&gt;length();
2009   if (length % inner_class_next_offset == enclosing_method_attribute_size) {
2010     int index = length - enclosing_method_attribute_size;
2011     inner_class_list-&gt;at_put(
2012       index + enclosing_method_class_index_offset, class_index);
2013     inner_class_list-&gt;at_put(
2014       index + enclosing_method_method_index_offset, method_index);
2015   }
2016 }
2017 
2018 // Lookup or create a jmethodID.
2019 // This code is called by the VMThread and JavaThreads so the
2020 // locking has to be done very carefully to avoid deadlocks
2021 // and/or other cache consistency problems.
2022 //
2023 jmethodID InstanceKlass::get_jmethod_id(const methodHandle&amp; method_h) {
2024   size_t idnum = (size_t)method_h-&gt;method_idnum();
2025   jmethodID* jmeths = methods_jmethod_ids_acquire();
2026   size_t length = 0;
2027   jmethodID id = NULL;
2028 
2029   // We use a double-check locking idiom here because this cache is
2030   // performance sensitive. In the normal system, this cache only
2031   // transitions from NULL to non-NULL which is safe because we use
2032   // release_set_methods_jmethod_ids() to advertise the new cache.
2033   // A partially constructed cache should never be seen by a racing
2034   // thread. We also use release_store() to save a new jmethodID
2035   // in the cache so a partially constructed jmethodID should never be
2036   // seen either. Cache reads of existing jmethodIDs proceed without a
2037   // lock, but cache writes of a new jmethodID requires uniqueness and
2038   // creation of the cache itself requires no leaks so a lock is
2039   // generally acquired in those two cases.
2040   //
2041   // If the RedefineClasses() API has been used, then this cache can
2042   // grow and we&#39;ll have transitions from non-NULL to bigger non-NULL.
2043   // Cache creation requires no leaks and we require safety between all
2044   // cache accesses and freeing of the old cache so a lock is generally
2045   // acquired when the RedefineClasses() API has been used.
2046 
2047   if (jmeths != NULL) {
2048     // the cache already exists
2049     if (!idnum_can_increment()) {
2050       // the cache can&#39;t grow so we can just get the current values
2051       get_jmethod_id_length_value(jmeths, idnum, &amp;length, &amp;id);
2052     } else {
2053       // cache can grow so we have to be more careful
2054       if (Threads::number_of_threads() == 0 ||
2055           SafepointSynchronize::is_at_safepoint()) {
2056         // we&#39;re single threaded or at a safepoint - no locking needed
2057         get_jmethod_id_length_value(jmeths, idnum, &amp;length, &amp;id);
2058       } else {
2059         MutexLocker ml(JmethodIdCreation_lock, Mutex::_no_safepoint_check_flag);
2060         get_jmethod_id_length_value(jmeths, idnum, &amp;length, &amp;id);
2061       }
2062     }
2063   }
2064   // implied else:
2065   // we need to allocate a cache so default length and id values are good
2066 
2067   if (jmeths == NULL ||   // no cache yet
2068       length &lt;= idnum ||  // cache is too short
2069       id == NULL) {       // cache doesn&#39;t contain entry
2070 
2071     // This function can be called by the VMThread so we have to do all
2072     // things that might block on a safepoint before grabbing the lock.
2073     // Otherwise, we can deadlock with the VMThread or have a cache
2074     // consistency issue. These vars keep track of what we might have
2075     // to free after the lock is dropped.
2076     jmethodID  to_dealloc_id     = NULL;
2077     jmethodID* to_dealloc_jmeths = NULL;
2078 
2079     // may not allocate new_jmeths or use it if we allocate it
2080     jmethodID* new_jmeths = NULL;
2081     if (length &lt;= idnum) {
2082       // allocate a new cache that might be used
2083       size_t size = MAX2(idnum+1, (size_t)idnum_allocated_count());
2084       new_jmeths = NEW_C_HEAP_ARRAY(jmethodID, size+1, mtClass);
2085       memset(new_jmeths, 0, (size+1)*sizeof(jmethodID));
2086       // cache size is stored in element[0], other elements offset by one
2087       new_jmeths[0] = (jmethodID)size;
2088     }
2089 
2090     // allocate a new jmethodID that might be used
2091     jmethodID new_id = NULL;
2092     if (method_h-&gt;is_old() &amp;&amp; !method_h-&gt;is_obsolete()) {
2093       // The method passed in is old (but not obsolete), we need to use the current version
2094       Method* current_method = method_with_idnum((int)idnum);
2095       assert(current_method != NULL, &quot;old and but not obsolete, so should exist&quot;);
2096       new_id = Method::make_jmethod_id(class_loader_data(), current_method);
2097     } else {
2098       // It is the current version of the method or an obsolete method,
2099       // use the version passed in
2100       new_id = Method::make_jmethod_id(class_loader_data(), method_h());
2101     }
2102 
2103     if (Threads::number_of_threads() == 0 ||
2104         SafepointSynchronize::is_at_safepoint()) {
2105       // we&#39;re single threaded or at a safepoint - no locking needed
2106       id = get_jmethod_id_fetch_or_update(idnum, new_id, new_jmeths,
2107                                           &amp;to_dealloc_id, &amp;to_dealloc_jmeths);
2108     } else {
2109       MutexLocker ml(JmethodIdCreation_lock, Mutex::_no_safepoint_check_flag);
2110       id = get_jmethod_id_fetch_or_update(idnum, new_id, new_jmeths,
2111                                           &amp;to_dealloc_id, &amp;to_dealloc_jmeths);
2112     }
2113 
2114     // The lock has been dropped so we can free resources.
2115     // Free up either the old cache or the new cache if we allocated one.
2116     if (to_dealloc_jmeths != NULL) {
2117       FreeHeap(to_dealloc_jmeths);
2118     }
2119     // free up the new ID since it wasn&#39;t needed
2120     if (to_dealloc_id != NULL) {
2121       Method::destroy_jmethod_id(class_loader_data(), to_dealloc_id);
2122     }
2123   }
2124   return id;
2125 }
2126 
2127 // Figure out how many jmethodIDs haven&#39;t been allocated, and make
2128 // sure space for them is pre-allocated.  This makes getting all
2129 // method ids much, much faster with classes with more than 8
2130 // methods, and has a *substantial* effect on performance with jvmti
2131 // code that loads all jmethodIDs for all classes.
2132 void InstanceKlass::ensure_space_for_methodids(int start_offset) {
2133   int new_jmeths = 0;
2134   int length = methods()-&gt;length();
2135   for (int index = start_offset; index &lt; length; index++) {
2136     Method* m = methods()-&gt;at(index);
2137     jmethodID id = m-&gt;find_jmethod_id_or_null();
2138     if (id == NULL) {
2139       new_jmeths++;
2140     }
2141   }
2142   if (new_jmeths != 0) {
2143     Method::ensure_jmethod_ids(class_loader_data(), new_jmeths);
2144   }
2145 }
2146 
2147 // Common code to fetch the jmethodID from the cache or update the
2148 // cache with the new jmethodID. This function should never do anything
2149 // that causes the caller to go to a safepoint or we can deadlock with
2150 // the VMThread or have cache consistency issues.
2151 //
2152 jmethodID InstanceKlass::get_jmethod_id_fetch_or_update(
2153             size_t idnum, jmethodID new_id,
2154             jmethodID* new_jmeths, jmethodID* to_dealloc_id_p,
2155             jmethodID** to_dealloc_jmeths_p) {
2156   assert(new_id != NULL, &quot;sanity check&quot;);
2157   assert(to_dealloc_id_p != NULL, &quot;sanity check&quot;);
2158   assert(to_dealloc_jmeths_p != NULL, &quot;sanity check&quot;);
2159   assert(Threads::number_of_threads() == 0 ||
2160          SafepointSynchronize::is_at_safepoint() ||
2161          JmethodIdCreation_lock-&gt;owned_by_self(), &quot;sanity check&quot;);
2162 
2163   // reacquire the cache - we are locked, single threaded or at a safepoint
2164   jmethodID* jmeths = methods_jmethod_ids_acquire();
2165   jmethodID  id     = NULL;
2166   size_t     length = 0;
2167 
2168   if (jmeths == NULL ||                         // no cache yet
2169       (length = (size_t)jmeths[0]) &lt;= idnum) {  // cache is too short
2170     if (jmeths != NULL) {
2171       // copy any existing entries from the old cache
2172       for (size_t index = 0; index &lt; length; index++) {
2173         new_jmeths[index+1] = jmeths[index+1];
2174       }
2175       *to_dealloc_jmeths_p = jmeths;  // save old cache for later delete
2176     }
2177     release_set_methods_jmethod_ids(jmeths = new_jmeths);
2178   } else {
2179     // fetch jmethodID (if any) from the existing cache
2180     id = jmeths[idnum+1];
2181     *to_dealloc_jmeths_p = new_jmeths;  // save new cache for later delete
2182   }
2183   if (id == NULL) {
2184     // No matching jmethodID in the existing cache or we have a new
2185     // cache or we just grew the cache. This cache write is done here
2186     // by the first thread to win the foot race because a jmethodID
2187     // needs to be unique once it is generally available.
2188     id = new_id;
2189 
2190     // The jmethodID cache can be read while unlocked so we have to
2191     // make sure the new jmethodID is complete before installing it
2192     // in the cache.
2193     Atomic::release_store(&amp;jmeths[idnum+1], id);
2194   } else {
2195     *to_dealloc_id_p = new_id; // save new id for later delete
2196   }
2197   return id;
2198 }
2199 
2200 
2201 // Common code to get the jmethodID cache length and the jmethodID
2202 // value at index idnum if there is one.
2203 //
2204 void InstanceKlass::get_jmethod_id_length_value(jmethodID* cache,
2205        size_t idnum, size_t *length_p, jmethodID* id_p) {
2206   assert(cache != NULL, &quot;sanity check&quot;);
2207   assert(length_p != NULL, &quot;sanity check&quot;);
2208   assert(id_p != NULL, &quot;sanity check&quot;);
2209 
2210   // cache size is stored in element[0], other elements offset by one
2211   *length_p = (size_t)cache[0];
2212   if (*length_p &lt;= idnum) {  // cache is too short
2213     *id_p = NULL;
2214   } else {
2215     *id_p = cache[idnum+1];  // fetch jmethodID (if any)
2216   }
2217 }
2218 
2219 
2220 // Lookup a jmethodID, NULL if not found.  Do no blocking, no allocations, no handles
2221 jmethodID InstanceKlass::jmethod_id_or_null(Method* method) {
2222   size_t idnum = (size_t)method-&gt;method_idnum();
2223   jmethodID* jmeths = methods_jmethod_ids_acquire();
2224   size_t length;                                // length assigned as debugging crumb
2225   jmethodID id = NULL;
2226   if (jmeths != NULL &amp;&amp;                         // If there is a cache
2227       (length = (size_t)jmeths[0]) &gt; idnum) {   // and if it is long enough,
2228     id = jmeths[idnum+1];                       // Look up the id (may be NULL)
2229   }
2230   return id;
2231 }
2232 
2233 inline DependencyContext InstanceKlass::dependencies() {
2234   DependencyContext dep_context(&amp;_dep_context, &amp;_dep_context_last_cleaned);
2235   return dep_context;
2236 }
2237 
2238 int InstanceKlass::mark_dependent_nmethods(KlassDepChange&amp; changes) {
2239   return dependencies().mark_dependent_nmethods(changes);
2240 }
2241 
2242 void InstanceKlass::add_dependent_nmethod(nmethod* nm) {
2243   dependencies().add_dependent_nmethod(nm);
2244 }
2245 
2246 void InstanceKlass::remove_dependent_nmethod(nmethod* nm) {
2247   dependencies().remove_dependent_nmethod(nm);
2248 }
2249 
2250 void InstanceKlass::clean_dependency_context() {
2251   dependencies().clean_unloading_dependents();
2252 }
2253 
2254 #ifndef PRODUCT
2255 void InstanceKlass::print_dependent_nmethods(bool verbose) {
2256   dependencies().print_dependent_nmethods(verbose);
2257 }
2258 
2259 bool InstanceKlass::is_dependent_nmethod(nmethod* nm) {
2260   return dependencies().is_dependent_nmethod(nm);
2261 }
2262 #endif //PRODUCT
2263 
2264 void InstanceKlass::clean_weak_instanceklass_links() {
2265   clean_implementors_list();
2266   clean_method_data();
2267 }
2268 
2269 void InstanceKlass::clean_implementors_list() {
2270   assert(is_loader_alive(), &quot;this klass should be live&quot;);
2271   if (is_interface()) {
2272     assert (ClassUnloading, &quot;only called for ClassUnloading&quot;);
2273     for (;;) {
2274       // Use load_acquire due to competing with inserts
2275       Klass* impl = Atomic::load_acquire(adr_implementor());
2276       if (impl != NULL &amp;&amp; !impl-&gt;is_loader_alive()) {
2277         // NULL this field, might be an unloaded klass or NULL
2278         Klass* volatile* klass = adr_implementor();
2279         if (Atomic::cmpxchg(klass, impl, (Klass*)NULL) == impl) {
2280           // Successfully unlinking implementor.
2281           if (log_is_enabled(Trace, class, unload)) {
2282             ResourceMark rm;
2283             log_trace(class, unload)(&quot;unlinking class (implementor): %s&quot;, impl-&gt;external_name());
2284           }
2285           return;
2286         }
2287       } else {
2288         return;
2289       }
2290     }
2291   }
2292 }
2293 
2294 void InstanceKlass::clean_method_data() {
2295   for (int m = 0; m &lt; methods()-&gt;length(); m++) {
2296     MethodData* mdo = methods()-&gt;at(m)-&gt;method_data();
2297     if (mdo != NULL) {
2298       MutexLocker ml(SafepointSynchronize::is_at_safepoint() ? NULL : mdo-&gt;extra_data_lock());
2299       mdo-&gt;clean_method_data(/*always_clean*/false);
2300     }
2301   }
2302 }
2303 
2304 bool InstanceKlass::supers_have_passed_fingerprint_checks() {
2305   if (java_super() != NULL &amp;&amp; !java_super()-&gt;has_passed_fingerprint_check()) {
2306     ResourceMark rm;
2307     log_trace(class, fingerprint)(&quot;%s : super %s not fingerprinted&quot;, external_name(), java_super()-&gt;external_name());
2308     return false;
2309   }
2310 
2311   Array&lt;InstanceKlass*&gt;* local_interfaces = this-&gt;local_interfaces();
2312   if (local_interfaces != NULL) {
2313     int length = local_interfaces-&gt;length();
2314     for (int i = 0; i &lt; length; i++) {
2315       InstanceKlass* intf = local_interfaces-&gt;at(i);
2316       if (!intf-&gt;has_passed_fingerprint_check()) {
2317         ResourceMark rm;
2318         log_trace(class, fingerprint)(&quot;%s : interface %s not fingerprinted&quot;, external_name(), intf-&gt;external_name());
2319         return false;
2320       }
2321     }
2322   }
2323 
2324   return true;
2325 }
2326 
2327 bool InstanceKlass::should_store_fingerprint(bool is_hidden_or_anonymous) {
2328 #if INCLUDE_AOT
2329   // We store the fingerprint into the InstanceKlass only in the following 2 cases:
2330   if (CalculateClassFingerprint) {
2331     // (1) We are running AOT to generate a shared library.
2332     return true;
2333   }
2334   if (Arguments::is_dumping_archive()) {
2335     // (2) We are running -Xshare:dump or -XX:ArchiveClassesAtExit to create a shared archive
2336     return true;
2337   }
2338   if (UseAOT &amp;&amp; is_hidden_or_anonymous) {
2339     // (3) We are using AOT code from a shared library and see a hidden or unsafe anonymous class
2340     return true;
2341   }
2342 #endif
2343 
2344   // In all other cases we might set the _misc_has_passed_fingerprint_check bit,
2345   // but do not store the 64-bit fingerprint to save space.
2346   return false;
2347 }
2348 
2349 bool InstanceKlass::has_stored_fingerprint() const {
2350 #if INCLUDE_AOT
2351   return should_store_fingerprint() || is_shared();
2352 #else
2353   return false;
2354 #endif
2355 }
2356 
2357 uint64_t InstanceKlass::get_stored_fingerprint() const {
2358   address adr = adr_fingerprint();
2359   if (adr != NULL) {
2360     return (uint64_t)Bytes::get_native_u8(adr); // adr may not be 64-bit aligned
2361   }
2362   return 0;
2363 }
2364 
2365 void InstanceKlass::store_fingerprint(uint64_t fingerprint) {
2366   address adr = adr_fingerprint();
2367   if (adr != NULL) {
2368     Bytes::put_native_u8(adr, (u8)fingerprint); // adr may not be 64-bit aligned
2369 
2370     ResourceMark rm;
2371     log_trace(class, fingerprint)(&quot;stored as &quot; PTR64_FORMAT &quot; for class %s&quot;, fingerprint, external_name());
2372   }
2373 }
2374 
2375 void InstanceKlass::metaspace_pointers_do(MetaspaceClosure* it) {
2376   Klass::metaspace_pointers_do(it);
2377 
2378   if (log_is_enabled(Trace, cds)) {
2379     ResourceMark rm;
2380     log_trace(cds)(&quot;Iter(InstanceKlass): %p (%s)&quot;, this, external_name());
2381   }
2382 
2383   it-&gt;push(&amp;_annotations);
2384   it-&gt;push((Klass**)&amp;_array_klasses);
2385   it-&gt;push(&amp;_constants);
2386   it-&gt;push(&amp;_inner_classes);
2387 #if INCLUDE_JVMTI
2388   it-&gt;push(&amp;_previous_versions);
2389 #endif
2390   it-&gt;push(&amp;_methods);
2391   it-&gt;push(&amp;_default_methods);
2392   it-&gt;push(&amp;_local_interfaces);
2393   it-&gt;push(&amp;_transitive_interfaces);
2394   it-&gt;push(&amp;_method_ordering);
2395   it-&gt;push(&amp;_default_vtable_indices);
2396   it-&gt;push(&amp;_fields);
2397 
2398   if (itable_length() &gt; 0) {
2399     itableOffsetEntry* ioe = (itableOffsetEntry*)start_of_itable();
2400     int method_table_offset_in_words = ioe-&gt;offset()/wordSize;
2401     int nof_interfaces = (method_table_offset_in_words - itable_offset_in_words())
2402                          / itableOffsetEntry::size();
2403 
2404     for (int i = 0; i &lt; nof_interfaces; i ++, ioe ++) {
2405       if (ioe-&gt;interface_klass() != NULL) {
2406         it-&gt;push(ioe-&gt;interface_klass_addr());
2407         itableMethodEntry* ime = ioe-&gt;first_method_entry(this);
2408         int n = klassItable::method_count_for_interface(ioe-&gt;interface_klass());
2409         for (int index = 0; index &lt; n; index ++) {
2410           it-&gt;push(ime[index].method_addr());
2411         }
2412       }
2413     }
2414   }
2415 
2416   it-&gt;push(&amp;_nest_members);
<a name="6" id="anc6"></a>
2417   it-&gt;push(&amp;_record_components);
2418 }
2419 
2420 void InstanceKlass::remove_unshareable_info() {
2421   Klass::remove_unshareable_info();
2422 
2423   if (SystemDictionaryShared::has_class_failed_verification(this)) {
2424     // Classes are attempted to link during dumping and may fail,
2425     // but these classes are still in the dictionary and class list in CLD.
2426     // If the class has failed verification, there is nothing else to remove.
2427     return;
2428   }
2429 
2430   // Reset to the &#39;allocated&#39; state to prevent any premature accessing to
2431   // a shared class at runtime while the class is still being loaded and
2432   // restored. A class&#39; init_state is set to &#39;loaded&#39; at runtime when it&#39;s
2433   // being added to class hierarchy (see SystemDictionary:::add_to_hierarchy()).
2434   _init_state = allocated;
2435 
2436   { // Otherwise this needs to take out the Compile_lock.
2437     assert(SafepointSynchronize::is_at_safepoint(), &quot;only called at safepoint&quot;);
2438     init_implementor();
2439   }
2440 
2441   constants()-&gt;remove_unshareable_info();
2442 
2443   for (int i = 0; i &lt; methods()-&gt;length(); i++) {
2444     Method* m = methods()-&gt;at(i);
2445     m-&gt;remove_unshareable_info();
2446   }
2447 
2448   // do array classes also.
2449   if (array_klasses() != NULL) {
2450     array_klasses()-&gt;remove_unshareable_info();
2451   }
2452 
2453   // These are not allocated from metaspace. They are safe to set to NULL.
2454   _source_debug_extension = NULL;
2455   _dep_context = NULL;
2456   _osr_nmethods_head = NULL;
2457 #if INCLUDE_JVMTI
2458   _breakpoints = NULL;
2459   _previous_versions = NULL;
2460   _cached_class_file = NULL;
2461   _jvmti_cached_class_field_map = NULL;
2462 #endif
2463 
2464   _init_thread = NULL;
2465   _methods_jmethod_ids = NULL;
2466   _jni_ids = NULL;
2467   _oop_map_cache = NULL;
2468   // clear _nest_host to ensure re-load at runtime
2469   _nest_host = NULL;
2470   _package_entry = NULL;
2471   _dep_context_last_cleaned = 0;
2472 }
2473 
2474 void InstanceKlass::remove_java_mirror() {
2475   Klass::remove_java_mirror();
2476 
2477   // do array classes also.
2478   if (array_klasses() != NULL) {
2479     array_klasses()-&gt;remove_java_mirror();
2480   }
2481 }
2482 
2483 void InstanceKlass::restore_unshareable_info(ClassLoaderData* loader_data, Handle protection_domain,
2484                                              PackageEntry* pkg_entry, TRAPS) {
2485   // SystemDictionary::add_to_hierarchy() sets the init_state to loaded
2486   // before the InstanceKlass is added to the SystemDictionary. Make
2487   // sure the current state is &lt;loaded.
2488   assert(!is_loaded(), &quot;invalid init state&quot;);
2489   set_package(loader_data, pkg_entry, CHECK);
2490   Klass::restore_unshareable_info(loader_data, protection_domain, CHECK);
2491 
2492   Array&lt;Method*&gt;* methods = this-&gt;methods();
2493   int num_methods = methods-&gt;length();
2494   for (int index = 0; index &lt; num_methods; ++index) {
2495     methods-&gt;at(index)-&gt;restore_unshareable_info(CHECK);
2496   }
2497   if (JvmtiExport::has_redefined_a_class()) {
2498     // Reinitialize vtable because RedefineClasses may have changed some
2499     // entries in this vtable for super classes so the CDS vtable might
2500     // point to old or obsolete entries.  RedefineClasses doesn&#39;t fix up
2501     // vtables in the shared system dictionary, only the main one.
2502     // It also redefines the itable too so fix that too.
2503     vtable().initialize_vtable(false, CHECK);
2504     itable().initialize_itable(false, CHECK);
2505   }
2506 
2507   // restore constant pool resolved references
2508   constants()-&gt;restore_unshareable_info(CHECK);
2509 
2510   if (array_klasses() != NULL) {
2511     // Array classes have null protection domain.
2512     // --&gt; see ArrayKlass::complete_create_array_klass()
2513     array_klasses()-&gt;restore_unshareable_info(ClassLoaderData::the_null_class_loader_data(), Handle(), CHECK);
2514   }
2515 
2516   // Initialize current biased locking state.
2517   if (UseBiasedLocking &amp;&amp; BiasedLocking::enabled()) {
2518     set_prototype_header(markWord::biased_locking_prototype());
2519   }
2520 }
2521 
2522 void InstanceKlass::set_shared_class_loader_type(s2 loader_type) {
2523   switch (loader_type) {
2524   case ClassLoader::BOOT_LOADER:
2525     _misc_flags |= _misc_is_shared_boot_class;
2526     break;
2527   case ClassLoader::PLATFORM_LOADER:
2528     _misc_flags |= _misc_is_shared_platform_class;
2529     break;
2530   case ClassLoader::APP_LOADER:
2531     _misc_flags |= _misc_is_shared_app_class;
2532     break;
2533   default:
2534     ShouldNotReachHere();
2535     break;
2536   }
2537 }
2538 
2539 #if INCLUDE_JVMTI
2540 static void clear_all_breakpoints(Method* m) {
2541   m-&gt;clear_all_breakpoints();
2542 }
2543 #endif
2544 
2545 void InstanceKlass::unload_class(InstanceKlass* ik) {
2546   // Release dependencies.
2547   ik-&gt;dependencies().remove_all_dependents();
2548 
2549   // notify the debugger
2550   if (JvmtiExport::should_post_class_unload()) {
2551     JvmtiExport::post_class_unload(ik);
2552   }
2553 
2554   // notify ClassLoadingService of class unload
2555   ClassLoadingService::notify_class_unloaded(ik);
2556 
2557   if (Arguments::is_dumping_archive()) {
2558     SystemDictionaryShared::remove_dumptime_info(ik);
2559   }
2560 
2561   if (log_is_enabled(Info, class, unload)) {
2562     ResourceMark rm;
2563     log_info(class, unload)(&quot;unloading class %s &quot; INTPTR_FORMAT, ik-&gt;external_name(), p2i(ik));
2564   }
2565 
2566   Events::log_class_unloading(Thread::current(), ik);
2567 
2568 #if INCLUDE_JFR
2569   assert(ik != NULL, &quot;invariant&quot;);
2570   EventClassUnload event;
2571   event.set_unloadedClass(ik);
2572   event.set_definingClassLoader(ik-&gt;class_loader_data());
2573   event.commit();
2574 #endif
2575 }
2576 
2577 static void method_release_C_heap_structures(Method* m) {
2578   m-&gt;release_C_heap_structures();
2579 }
2580 
2581 void InstanceKlass::release_C_heap_structures() {
2582 
2583   // Clean up C heap
2584   release_C_heap_structures_internal();
2585   constants()-&gt;release_C_heap_structures();
2586 
2587   // Deallocate and call destructors for MDO mutexes
2588   methods_do(method_release_C_heap_structures);
2589 }
2590 
2591 void InstanceKlass::release_C_heap_structures_internal() {
2592   Klass::release_C_heap_structures();
2593 
2594   // Can&#39;t release the constant pool here because the constant pool can be
2595   // deallocated separately from the InstanceKlass for default methods and
2596   // redefine classes.
2597 
2598   // Deallocate oop map cache
2599   if (_oop_map_cache != NULL) {
2600     delete _oop_map_cache;
2601     _oop_map_cache = NULL;
2602   }
2603 
2604   // Deallocate JNI identifiers for jfieldIDs
2605   JNIid::deallocate(jni_ids());
2606   set_jni_ids(NULL);
2607 
2608   jmethodID* jmeths = methods_jmethod_ids_acquire();
2609   if (jmeths != (jmethodID*)NULL) {
2610     release_set_methods_jmethod_ids(NULL);
2611     FreeHeap(jmeths);
2612   }
2613 
2614   assert(_dep_context == NULL,
2615          &quot;dependencies should already be cleaned&quot;);
2616 
2617 #if INCLUDE_JVMTI
2618   // Deallocate breakpoint records
2619   if (breakpoints() != 0x0) {
2620     methods_do(clear_all_breakpoints);
2621     assert(breakpoints() == 0x0, &quot;should have cleared breakpoints&quot;);
2622   }
2623 
2624   // deallocate the cached class file
2625   if (_cached_class_file != NULL) {
2626     os::free(_cached_class_file);
2627     _cached_class_file = NULL;
2628   }
2629 #endif
2630 
2631   FREE_C_HEAP_ARRAY(char, _source_debug_extension);
2632 }
2633 
2634 void InstanceKlass::set_source_debug_extension(const char* array, int length) {
2635   if (array == NULL) {
2636     _source_debug_extension = NULL;
2637   } else {
2638     // Adding one to the attribute length in order to store a null terminator
2639     // character could cause an overflow because the attribute length is
2640     // already coded with an u4 in the classfile, but in practice, it&#39;s
2641     // unlikely to happen.
2642     assert((length+1) &gt; length, &quot;Overflow checking&quot;);
2643     char* sde = NEW_C_HEAP_ARRAY(char, (length + 1), mtClass);
2644     for (int i = 0; i &lt; length; i++) {
2645       sde[i] = array[i];
2646     }
2647     sde[length] = &#39;\0&#39;;
2648     _source_debug_extension = sde;
2649   }
2650 }
2651 
2652 const char* InstanceKlass::signature_name() const {
2653   int hash_len = 0;
2654   char hash_buf[40];
2655 
2656   // If this is an unsafe anonymous class, append a hash to make the name unique
2657   if (is_unsafe_anonymous()) {
2658     intptr_t hash = (java_mirror() != NULL) ? java_mirror()-&gt;identity_hash() : 0;
2659     jio_snprintf(hash_buf, sizeof(hash_buf), &quot;/&quot; UINTX_FORMAT, (uintx)hash);
2660     hash_len = (int)strlen(hash_buf);
2661   }
2662 
2663   // Get the internal name as a c string
2664   const char* src = (const char*) (name()-&gt;as_C_string());
2665   const int src_length = (int)strlen(src);
2666 
2667   char* dest = NEW_RESOURCE_ARRAY(char, src_length + hash_len + 3);
2668 
2669   // Add L as type indicator
2670   int dest_index = 0;
2671   dest[dest_index++] = JVM_SIGNATURE_CLASS;
2672 
2673   // Add the actual class name
2674   for (int src_index = 0; src_index &lt; src_length; ) {
2675     dest[dest_index++] = src[src_index++];
2676   }
2677 
2678   if (is_hidden()) { // Replace the last &#39;+&#39; with a &#39;.&#39;.
2679     for (int index = (int)src_length; index &gt; 0; index--) {
2680       if (dest[index] == &#39;+&#39;) {
2681         dest[index] = JVM_SIGNATURE_DOT;
2682         break;
2683       }
2684     }
2685   }
2686 
2687   // If we have a hash, append it
2688   for (int hash_index = 0; hash_index &lt; hash_len; ) {
2689     dest[dest_index++] = hash_buf[hash_index++];
2690   }
2691 
2692   // Add the semicolon and the NULL
2693   dest[dest_index++] = JVM_SIGNATURE_ENDCLASS;
2694   dest[dest_index] = &#39;\0&#39;;
2695   return dest;
2696 }
2697 
2698 ModuleEntry* InstanceKlass::module() const {
2699   // For an unsafe anonymous class return the host class&#39; module
2700   if (is_unsafe_anonymous()) {
2701     assert(unsafe_anonymous_host() != NULL, &quot;unsafe anonymous class must have a host class&quot;);
2702     return unsafe_anonymous_host()-&gt;module();
2703   }
2704 
2705   if (is_hidden() &amp;&amp;
2706       in_unnamed_package() &amp;&amp;
2707       class_loader_data()-&gt;has_class_mirror_holder()) {
2708     // For a non-strong hidden class defined to an unnamed package,
2709     // its (class held) CLD will not have an unnamed module created for it.
2710     // Two choices to find the correct ModuleEntry:
2711     // 1. If hidden class is within a nest, use nest host&#39;s module
2712     // 2. Find the unnamed module off from the class loader
2713     // For now option #2 is used since a nest host is not set until
2714     // after the instance class is created in jvm_lookup_define_class().
2715     if (class_loader_data()-&gt;is_boot_class_loader_data()) {
2716       return ClassLoaderData::the_null_class_loader_data()-&gt;unnamed_module();
2717     } else {
2718       oop module = java_lang_ClassLoader::unnamedModule(class_loader_data()-&gt;class_loader());
2719       assert(java_lang_Module::is_instance(module), &quot;Not an instance of java.lang.Module&quot;);
2720       return java_lang_Module::module_entry(module);
2721     }
2722   }
2723 
2724   // Class is in a named package
2725   if (!in_unnamed_package()) {
2726     return _package_entry-&gt;module();
2727   }
2728 
2729   // Class is in an unnamed package, return its loader&#39;s unnamed module
2730   return class_loader_data()-&gt;unnamed_module();
2731 }
2732 
2733 void InstanceKlass::set_package(ClassLoaderData* loader_data, PackageEntry* pkg_entry, TRAPS) {
2734 
2735   // ensure java/ packages only loaded by boot or platform builtin loaders
2736   // not needed for shared class since CDS does not archive prohibited classes.
2737   if (!is_shared()) {
2738     check_prohibited_package(name(), loader_data, CHECK);
2739   }
2740 
2741   TempNewSymbol pkg_name = pkg_entry != NULL ? pkg_entry-&gt;name() : ClassLoader::package_from_class_name(name());
2742 
2743   if (pkg_name != NULL &amp;&amp; loader_data != NULL) {
2744 
2745     // Find in class loader&#39;s package entry table.
2746     _package_entry = pkg_entry != NULL ? pkg_entry : loader_data-&gt;packages()-&gt;lookup_only(pkg_name);
2747 
2748     // If the package name is not found in the loader&#39;s package
2749     // entry table, it is an indication that the package has not
2750     // been defined. Consider it defined within the unnamed module.
2751     if (_package_entry == NULL) {
2752 
2753       if (!ModuleEntryTable::javabase_defined()) {
2754         // Before java.base is defined during bootstrapping, define all packages in
2755         // the java.base module.  If a non-java.base package is erroneously placed
2756         // in the java.base module it will be caught later when java.base
2757         // is defined by ModuleEntryTable::verify_javabase_packages check.
2758         assert(ModuleEntryTable::javabase_moduleEntry() != NULL, JAVA_BASE_NAME &quot; module is NULL&quot;);
2759         _package_entry = loader_data-&gt;packages()-&gt;lookup(pkg_name, ModuleEntryTable::javabase_moduleEntry());
2760       } else {
2761         assert(loader_data-&gt;unnamed_module() != NULL, &quot;unnamed module is NULL&quot;);
2762         _package_entry = loader_data-&gt;packages()-&gt;lookup(pkg_name,
2763                                                          loader_data-&gt;unnamed_module());
2764       }
2765 
2766       // A package should have been successfully created
2767       DEBUG_ONLY(ResourceMark rm(THREAD));
2768       assert(_package_entry != NULL, &quot;Package entry for class %s not found, loader %s&quot;,
2769              name()-&gt;as_C_string(), loader_data-&gt;loader_name_and_id());
2770     }
2771 
2772     if (log_is_enabled(Debug, module)) {
2773       ResourceMark rm(THREAD);
2774       ModuleEntry* m = _package_entry-&gt;module();
2775       log_trace(module)(&quot;Setting package: class: %s, package: %s, loader: %s, module: %s&quot;,
2776                         external_name(),
2777                         pkg_name-&gt;as_C_string(),
2778                         loader_data-&gt;loader_name_and_id(),
2779                         (m-&gt;is_named() ? m-&gt;name()-&gt;as_C_string() : UNNAMED_MODULE));
2780     }
2781   } else {
2782     ResourceMark rm(THREAD);
2783     log_trace(module)(&quot;Setting package: class: %s, package: unnamed, loader: %s, module: %s&quot;,
2784                       external_name(),
2785                       (loader_data != NULL) ? loader_data-&gt;loader_name_and_id() : &quot;NULL&quot;,
2786                       UNNAMED_MODULE);
2787   }
2788 }
2789 
2790 // Function set_classpath_index checks if the package of the InstanceKlass is in the
2791 // boot loader&#39;s package entry table.  If so, then it sets the classpath_index
2792 // in the package entry record.
2793 //
2794 // The classpath_index field is used to find the entry on the boot loader class
2795 // path for packages with classes loaded by the boot loader from -Xbootclasspath/a
2796 // in an unnamed module.  It is also used to indicate (for all packages whose
2797 // classes are loaded by the boot loader) that at least one of the package&#39;s
2798 // classes has been loaded.
2799 void InstanceKlass::set_classpath_index(s2 path_index, TRAPS) {
2800   if (_package_entry != NULL) {
2801     DEBUG_ONLY(PackageEntryTable* pkg_entry_tbl = ClassLoaderData::the_null_class_loader_data()-&gt;packages();)
2802     assert(pkg_entry_tbl-&gt;lookup_only(_package_entry-&gt;name()) == _package_entry, &quot;Should be same&quot;);
2803     assert(path_index != -1, &quot;Unexpected classpath_index&quot;);
2804     _package_entry-&gt;set_classpath_index(path_index);
2805   }
2806 }
2807 
2808 // different versions of is_same_class_package
2809 
2810 bool InstanceKlass::is_same_class_package(const Klass* class2) const {
2811   oop classloader1 = this-&gt;class_loader();
2812   PackageEntry* classpkg1 = this-&gt;package();
2813   if (class2-&gt;is_objArray_klass()) {
2814     class2 = ObjArrayKlass::cast(class2)-&gt;bottom_klass();
2815   }
2816 
2817   oop classloader2;
2818   PackageEntry* classpkg2;
2819   if (class2-&gt;is_instance_klass()) {
2820     classloader2 = class2-&gt;class_loader();
2821     classpkg2 = class2-&gt;package();
2822   } else {
2823     assert(class2-&gt;is_typeArray_klass(), &quot;should be type array&quot;);
2824     classloader2 = NULL;
2825     classpkg2 = NULL;
2826   }
2827 
2828   // Same package is determined by comparing class loader
2829   // and package entries. Both must be the same. This rule
2830   // applies even to classes that are defined in the unnamed
2831   // package, they still must have the same class loader.
2832   if ((classloader1 == classloader2) &amp;&amp; (classpkg1 == classpkg2)) {
2833     return true;
2834   }
2835 
2836   return false;
2837 }
2838 
2839 // return true if this class and other_class are in the same package. Classloader
2840 // and classname information is enough to determine a class&#39;s package
2841 bool InstanceKlass::is_same_class_package(oop other_class_loader,
2842                                           const Symbol* other_class_name) const {
2843   if (class_loader() != other_class_loader) {
2844     return false;
2845   }
2846   if (name()-&gt;fast_compare(other_class_name) == 0) {
2847      return true;
2848   }
2849 
2850   {
2851     ResourceMark rm;
2852 
2853     bool bad_class_name = false;
2854     TempNewSymbol other_pkg = ClassLoader::package_from_class_name(other_class_name, &amp;bad_class_name);
2855     if (bad_class_name) {
2856       return false;
2857     }
2858     // Check that package_from_class_name() returns NULL, not &quot;&quot;, if there is no package.
2859     assert(other_pkg == NULL || other_pkg-&gt;utf8_length() &gt; 0, &quot;package name is empty string&quot;);
2860 
2861     const Symbol* const this_package_name =
2862       this-&gt;package() != NULL ? this-&gt;package()-&gt;name() : NULL;
2863 
2864     if (this_package_name == NULL || other_pkg == NULL) {
2865       // One of the two doesn&#39;t have a package.  Only return true if the other
2866       // one also doesn&#39;t have a package.
2867       return this_package_name == other_pkg;
2868     }
2869 
2870     // Check if package is identical
2871     return this_package_name-&gt;fast_compare(other_pkg) == 0;
2872   }
2873 }
2874 
2875 // Returns true iff super_method can be overridden by a method in targetclassname
2876 // See JLS 3rd edition 8.4.6.1
2877 // Assumes name-signature match
2878 // &quot;this&quot; is InstanceKlass of super_method which must exist
2879 // note that the InstanceKlass of the method in the targetclassname has not always been created yet
2880 bool InstanceKlass::is_override(const methodHandle&amp; super_method, Handle targetclassloader, Symbol* targetclassname, TRAPS) {
2881    // Private methods can not be overridden
2882    if (super_method-&gt;is_private()) {
2883      return false;
2884    }
2885    // If super method is accessible, then override
2886    if ((super_method-&gt;is_protected()) ||
2887        (super_method-&gt;is_public())) {
2888      return true;
2889    }
2890    // Package-private methods are not inherited outside of package
2891    assert(super_method-&gt;is_package_private(), &quot;must be package private&quot;);
2892    return(is_same_class_package(targetclassloader(), targetclassname));
2893 }
2894 
2895 // Only boot and platform class loaders can define classes in &quot;java/&quot; packages.
2896 void InstanceKlass::check_prohibited_package(Symbol* class_name,
2897                                              ClassLoaderData* loader_data,
2898                                              TRAPS) {
2899   if (!loader_data-&gt;is_boot_class_loader_data() &amp;&amp;
2900       !loader_data-&gt;is_platform_class_loader_data() &amp;&amp;
2901       class_name != NULL) {
2902     ResourceMark rm(THREAD);
2903     char* name = class_name-&gt;as_C_string();
2904     if (strncmp(name, JAVAPKG, JAVAPKG_LEN) == 0 &amp;&amp; name[JAVAPKG_LEN] == &#39;/&#39;) {
2905       TempNewSymbol pkg_name = ClassLoader::package_from_class_name(class_name);
2906       assert(pkg_name != NULL, &quot;Error in parsing package name starting with &#39;java/&#39;&quot;);
2907       name = pkg_name-&gt;as_C_string();
2908       const char* class_loader_name = loader_data-&gt;loader_name_and_id();
2909       StringUtils::replace_no_expand(name, &quot;/&quot;, &quot;.&quot;);
2910       const char* msg_text1 = &quot;Class loader (instance of): &quot;;
2911       const char* msg_text2 = &quot; tried to load prohibited package name: &quot;;
2912       size_t len = strlen(msg_text1) + strlen(class_loader_name) + strlen(msg_text2) + strlen(name) + 1;
2913       char* message = NEW_RESOURCE_ARRAY_IN_THREAD(THREAD, char, len);
2914       jio_snprintf(message, len, &quot;%s%s%s%s&quot;, msg_text1, class_loader_name, msg_text2, name);
2915       THROW_MSG(vmSymbols::java_lang_SecurityException(), message);
2916     }
2917   }
2918   return;
2919 }
2920 
2921 bool InstanceKlass::find_inner_classes_attr(int* ooff, int* noff, TRAPS) const {
2922   constantPoolHandle i_cp(THREAD, constants());
2923   for (InnerClassesIterator iter(this); !iter.done(); iter.next()) {
2924     int ioff = iter.inner_class_info_index();
2925     if (ioff != 0) {
2926       // Check to see if the name matches the class we&#39;re looking for
2927       // before attempting to find the class.
2928       if (i_cp-&gt;klass_name_at_matches(this, ioff)) {
2929         Klass* inner_klass = i_cp-&gt;klass_at(ioff, CHECK_false);
2930         if (this == inner_klass) {
2931           *ooff = iter.outer_class_info_index();
2932           *noff = iter.inner_name_index();
2933           return true;
2934         }
2935       }
2936     }
2937   }
2938   return false;
2939 }
2940 
2941 InstanceKlass* InstanceKlass::compute_enclosing_class(bool* inner_is_member, TRAPS) const {
2942   InstanceKlass* outer_klass = NULL;
2943   *inner_is_member = false;
2944   int ooff = 0, noff = 0;
2945   bool has_inner_classes_attr = find_inner_classes_attr(&amp;ooff, &amp;noff, THREAD);
2946   if (has_inner_classes_attr) {
2947     constantPoolHandle i_cp(THREAD, constants());
2948     if (ooff != 0) {
2949       Klass* ok = i_cp-&gt;klass_at(ooff, CHECK_NULL);
2950       outer_klass = InstanceKlass::cast(ok);
2951       *inner_is_member = true;
2952     }
2953     if (NULL == outer_klass) {
2954       // It may be a local or anonymous class; try for that.
2955       int encl_method_class_idx = enclosing_method_class_index();
2956       if (encl_method_class_idx != 0) {
2957         Klass* ok = i_cp-&gt;klass_at(encl_method_class_idx, CHECK_NULL);
2958         outer_klass = InstanceKlass::cast(ok);
2959         *inner_is_member = false;
2960       }
2961     }
2962   }
2963 
2964   // If no inner class attribute found for this class.
2965   if (NULL == outer_klass) return NULL;
2966 
2967   // Throws an exception if outer klass has not declared k as an inner klass
2968   // We need evidence that each klass knows about the other, or else
2969   // the system could allow a spoof of an inner class to gain access rights.
2970   Reflection::check_for_inner_class(outer_klass, this, *inner_is_member, CHECK_NULL);
2971   return outer_klass;
2972 }
2973 
2974 jint InstanceKlass::compute_modifier_flags(TRAPS) const {
2975   jint access = access_flags().as_int();
2976 
2977   // But check if it happens to be member class.
2978   InnerClassesIterator iter(this);
2979   for (; !iter.done(); iter.next()) {
2980     int ioff = iter.inner_class_info_index();
2981     // Inner class attribute can be zero, skip it.
2982     // Strange but true:  JVM spec. allows null inner class refs.
2983     if (ioff == 0) continue;
2984 
2985     // only look at classes that are already loaded
2986     // since we are looking for the flags for our self.
2987     Symbol* inner_name = constants()-&gt;klass_name_at(ioff);
2988     if (name() == inner_name) {
2989       // This is really a member class.
2990       access = iter.inner_access_flags();
2991       break;
2992     }
2993   }
2994   // Remember to strip ACC_SUPER bit
2995   return (access &amp; (~JVM_ACC_SUPER)) &amp; JVM_ACC_WRITTEN_FLAGS;
2996 }
2997 
2998 jint InstanceKlass::jvmti_class_status() const {
2999   jint result = 0;
3000 
3001   if (is_linked()) {
3002     result |= JVMTI_CLASS_STATUS_VERIFIED | JVMTI_CLASS_STATUS_PREPARED;
3003   }
3004 
3005   if (is_initialized()) {
3006     assert(is_linked(), &quot;Class status is not consistent&quot;);
3007     result |= JVMTI_CLASS_STATUS_INITIALIZED;
3008   }
3009   if (is_in_error_state()) {
3010     result |= JVMTI_CLASS_STATUS_ERROR;
3011   }
3012   return result;
3013 }
3014 
3015 Method* InstanceKlass::method_at_itable(Klass* holder, int index, TRAPS) {
3016   itableOffsetEntry* ioe = (itableOffsetEntry*)start_of_itable();
3017   int method_table_offset_in_words = ioe-&gt;offset()/wordSize;
3018   int nof_interfaces = (method_table_offset_in_words - itable_offset_in_words())
3019                        / itableOffsetEntry::size();
3020 
3021   for (int cnt = 0 ; ; cnt ++, ioe ++) {
3022     // If the interface isn&#39;t implemented by the receiver class,
3023     // the VM should throw IncompatibleClassChangeError.
3024     if (cnt &gt;= nof_interfaces) {
3025       ResourceMark rm(THREAD);
3026       stringStream ss;
3027       bool same_module = (module() == holder-&gt;module());
3028       ss.print(&quot;Receiver class %s does not implement &quot;
3029                &quot;the interface %s defining the method to be called &quot;
3030                &quot;(%s%s%s)&quot;,
3031                external_name(), holder-&gt;external_name(),
3032                (same_module) ? joint_in_module_of_loader(holder) : class_in_module_of_loader(),
3033                (same_module) ? &quot;&quot; : &quot;; &quot;,
3034                (same_module) ? &quot;&quot; : holder-&gt;class_in_module_of_loader());
3035       THROW_MSG_NULL(vmSymbols::java_lang_IncompatibleClassChangeError(), ss.as_string());
3036     }
3037 
3038     Klass* ik = ioe-&gt;interface_klass();
3039     if (ik == holder) break;
3040   }
3041 
3042   itableMethodEntry* ime = ioe-&gt;first_method_entry(this);
3043   Method* m = ime[index].method();
3044   if (m == NULL) {
3045     THROW_NULL(vmSymbols::java_lang_AbstractMethodError());
3046   }
3047   return m;
3048 }
3049 
3050 
3051 #if INCLUDE_JVMTI
3052 // update default_methods for redefineclasses for methods that are
3053 // not yet in the vtable due to concurrent subclass define and superinterface
3054 // redefinition
3055 // Note: those in the vtable, should have been updated via adjust_method_entries
3056 void InstanceKlass::adjust_default_methods(bool* trace_name_printed) {
3057   // search the default_methods for uses of either obsolete or EMCP methods
3058   if (default_methods() != NULL) {
3059     for (int index = 0; index &lt; default_methods()-&gt;length(); index ++) {
3060       Method* old_method = default_methods()-&gt;at(index);
3061       if (old_method == NULL || !old_method-&gt;is_old()) {
3062         continue; // skip uninteresting entries
3063       }
3064       assert(!old_method-&gt;is_deleted(), &quot;default methods may not be deleted&quot;);
3065       Method* new_method = old_method-&gt;get_new_method();
3066       default_methods()-&gt;at_put(index, new_method);
3067 
3068       if (log_is_enabled(Info, redefine, class, update)) {
3069         ResourceMark rm;
3070         if (!(*trace_name_printed)) {
3071           log_info(redefine, class, update)
3072             (&quot;adjust: klassname=%s default methods from name=%s&quot;,
3073              external_name(), old_method-&gt;method_holder()-&gt;external_name());
3074           *trace_name_printed = true;
3075         }
3076         log_debug(redefine, class, update, vtables)
3077           (&quot;default method update: %s(%s) &quot;,
3078            new_method-&gt;name()-&gt;as_C_string(), new_method-&gt;signature()-&gt;as_C_string());
3079       }
3080     }
3081   }
3082 }
3083 #endif // INCLUDE_JVMTI
3084 
3085 // On-stack replacement stuff
3086 void InstanceKlass::add_osr_nmethod(nmethod* n) {
3087   assert_lock_strong(CompiledMethod_lock);
3088 #ifndef PRODUCT
3089   if (TieredCompilation) {
3090     nmethod* prev = lookup_osr_nmethod(n-&gt;method(), n-&gt;osr_entry_bci(), n-&gt;comp_level(), true);
3091     assert(prev == NULL || !prev-&gt;is_in_use() COMPILER2_PRESENT(|| StressRecompilation),
3092            &quot;redundant OSR recompilation detected. memory leak in CodeCache!&quot;);
3093   }
3094 #endif
3095   // only one compilation can be active
3096   {
3097     assert(n-&gt;is_osr_method(), &quot;wrong kind of nmethod&quot;);
3098     n-&gt;set_osr_link(osr_nmethods_head());
3099     set_osr_nmethods_head(n);
3100     // Raise the highest osr level if necessary
3101     if (TieredCompilation) {
3102       Method* m = n-&gt;method();
3103       m-&gt;set_highest_osr_comp_level(MAX2(m-&gt;highest_osr_comp_level(), n-&gt;comp_level()));
3104     }
3105   }
3106 
3107   // Get rid of the osr methods for the same bci that have lower levels.
3108   if (TieredCompilation) {
3109     for (int l = CompLevel_limited_profile; l &lt; n-&gt;comp_level(); l++) {
3110       nmethod *inv = lookup_osr_nmethod(n-&gt;method(), n-&gt;osr_entry_bci(), l, true);
3111       if (inv != NULL &amp;&amp; inv-&gt;is_in_use()) {
3112         inv-&gt;make_not_entrant();
3113       }
3114     }
3115   }
3116 }
3117 
3118 // Remove osr nmethod from the list. Return true if found and removed.
3119 bool InstanceKlass::remove_osr_nmethod(nmethod* n) {
3120   // This is a short non-blocking critical region, so the no safepoint check is ok.
3121   MutexLocker ml(CompiledMethod_lock-&gt;owned_by_self() ? NULL : CompiledMethod_lock
3122                  , Mutex::_no_safepoint_check_flag);
3123   assert(n-&gt;is_osr_method(), &quot;wrong kind of nmethod&quot;);
3124   nmethod* last = NULL;
3125   nmethod* cur  = osr_nmethods_head();
3126   int max_level = CompLevel_none;  // Find the max comp level excluding n
3127   Method* m = n-&gt;method();
3128   // Search for match
3129   bool found = false;
3130   while(cur != NULL &amp;&amp; cur != n) {
3131     if (TieredCompilation &amp;&amp; m == cur-&gt;method()) {
3132       // Find max level before n
3133       max_level = MAX2(max_level, cur-&gt;comp_level());
3134     }
3135     last = cur;
3136     cur = cur-&gt;osr_link();
3137   }
3138   nmethod* next = NULL;
3139   if (cur == n) {
3140     found = true;
3141     next = cur-&gt;osr_link();
3142     if (last == NULL) {
3143       // Remove first element
3144       set_osr_nmethods_head(next);
3145     } else {
3146       last-&gt;set_osr_link(next);
3147     }
3148   }
3149   n-&gt;set_osr_link(NULL);
3150   if (TieredCompilation) {
3151     cur = next;
3152     while (cur != NULL) {
3153       // Find max level after n
3154       if (m == cur-&gt;method()) {
3155         max_level = MAX2(max_level, cur-&gt;comp_level());
3156       }
3157       cur = cur-&gt;osr_link();
3158     }
3159     m-&gt;set_highest_osr_comp_level(max_level);
3160   }
3161   return found;
3162 }
3163 
3164 int InstanceKlass::mark_osr_nmethods(const Method* m) {
3165   MutexLocker ml(CompiledMethod_lock-&gt;owned_by_self() ? NULL : CompiledMethod_lock,
3166                  Mutex::_no_safepoint_check_flag);
3167   nmethod* osr = osr_nmethods_head();
3168   int found = 0;
3169   while (osr != NULL) {
3170     assert(osr-&gt;is_osr_method(), &quot;wrong kind of nmethod found in chain&quot;);
3171     if (osr-&gt;method() == m) {
3172       osr-&gt;mark_for_deoptimization();
3173       found++;
3174     }
3175     osr = osr-&gt;osr_link();
3176   }
3177   return found;
3178 }
3179 
3180 nmethod* InstanceKlass::lookup_osr_nmethod(const Method* m, int bci, int comp_level, bool match_level) const {
3181   MutexLocker ml(CompiledMethod_lock-&gt;owned_by_self() ? NULL : CompiledMethod_lock,
3182                  Mutex::_no_safepoint_check_flag);
3183   nmethod* osr = osr_nmethods_head();
3184   nmethod* best = NULL;
3185   while (osr != NULL) {
3186     assert(osr-&gt;is_osr_method(), &quot;wrong kind of nmethod found in chain&quot;);
3187     // There can be a time when a c1 osr method exists but we are waiting
3188     // for a c2 version. When c2 completes its osr nmethod we will trash
3189     // the c1 version and only be able to find the c2 version. However
3190     // while we overflow in the c1 code at back branches we don&#39;t want to
3191     // try and switch to the same code as we are already running
3192 
3193     if (osr-&gt;method() == m &amp;&amp;
3194         (bci == InvocationEntryBci || osr-&gt;osr_entry_bci() == bci)) {
3195       if (match_level) {
3196         if (osr-&gt;comp_level() == comp_level) {
3197           // Found a match - return it.
3198           return osr;
3199         }
3200       } else {
3201         if (best == NULL || (osr-&gt;comp_level() &gt; best-&gt;comp_level())) {
3202           if (osr-&gt;comp_level() == CompLevel_highest_tier) {
3203             // Found the best possible - return it.
3204             return osr;
3205           }
3206           best = osr;
3207         }
3208       }
3209     }
3210     osr = osr-&gt;osr_link();
3211   }
3212 
3213   assert(match_level == false || best == NULL, &quot;shouldn&#39;t pick up anything if match_level is set&quot;);
3214   if (best != NULL &amp;&amp; best-&gt;comp_level() &gt;= comp_level) {
3215     return best;
3216   }
3217   return NULL;
3218 }
3219 
3220 // -----------------------------------------------------------------------------------------------------
3221 // Printing
3222 
3223 #ifndef PRODUCT
3224 
3225 #define BULLET  &quot; - &quot;
3226 
3227 static const char* state_names[] = {
3228   &quot;allocated&quot;, &quot;loaded&quot;, &quot;linked&quot;, &quot;being_initialized&quot;, &quot;fully_initialized&quot;, &quot;initialization_error&quot;
3229 };
3230 
3231 static void print_vtable(intptr_t* start, int len, outputStream* st) {
3232   for (int i = 0; i &lt; len; i++) {
3233     intptr_t e = start[i];
3234     st-&gt;print(&quot;%d : &quot; INTPTR_FORMAT, i, e);
3235     if (MetaspaceObj::is_valid((Metadata*)e)) {
3236       st-&gt;print(&quot; &quot;);
3237       ((Metadata*)e)-&gt;print_value_on(st);
3238     }
3239     st-&gt;cr();
3240   }
3241 }
3242 
3243 static void print_vtable(vtableEntry* start, int len, outputStream* st) {
3244   return print_vtable(reinterpret_cast&lt;intptr_t*&gt;(start), len, st);
3245 }
3246 
3247 void InstanceKlass::print_on(outputStream* st) const {
3248   assert(is_klass(), &quot;must be klass&quot;);
3249   Klass::print_on(st);
3250 
3251   st-&gt;print(BULLET&quot;instance size:     %d&quot;, size_helper());                        st-&gt;cr();
3252   st-&gt;print(BULLET&quot;klass size:        %d&quot;, size());                               st-&gt;cr();
3253   st-&gt;print(BULLET&quot;access:            &quot;); access_flags().print_on(st);            st-&gt;cr();
3254   st-&gt;print(BULLET&quot;state:             &quot;); st-&gt;print_cr(&quot;%s&quot;, state_names[_init_state]);
3255   st-&gt;print(BULLET&quot;name:              &quot;); name()-&gt;print_value_on(st);             st-&gt;cr();
3256   st-&gt;print(BULLET&quot;super:             &quot;); Metadata::print_value_on_maybe_null(st, super()); st-&gt;cr();
3257   st-&gt;print(BULLET&quot;sub:               &quot;);
3258   Klass* sub = subklass();
3259   int n;
3260   for (n = 0; sub != NULL; n++, sub = sub-&gt;next_sibling()) {
3261     if (n &lt; MaxSubklassPrintSize) {
3262       sub-&gt;print_value_on(st);
3263       st-&gt;print(&quot;   &quot;);
3264     }
3265   }
3266   if (n &gt;= MaxSubklassPrintSize) st-&gt;print(&quot;(&quot; INTX_FORMAT &quot; more klasses...)&quot;, n - MaxSubklassPrintSize);
3267   st-&gt;cr();
3268 
3269   if (is_interface()) {
3270     st-&gt;print_cr(BULLET&quot;nof implementors:  %d&quot;, nof_implementors());
3271     if (nof_implementors() == 1) {
3272       st-&gt;print_cr(BULLET&quot;implementor:    &quot;);
3273       st-&gt;print(&quot;   &quot;);
3274       implementor()-&gt;print_value_on(st);
3275       st-&gt;cr();
3276     }
3277   }
3278 
3279   st-&gt;print(BULLET&quot;arrays:            &quot;); Metadata::print_value_on_maybe_null(st, array_klasses()); st-&gt;cr();
3280   st-&gt;print(BULLET&quot;methods:           &quot;); methods()-&gt;print_value_on(st);                  st-&gt;cr();
3281   if (Verbose || WizardMode) {
3282     Array&lt;Method*&gt;* method_array = methods();
3283     for (int i = 0; i &lt; method_array-&gt;length(); i++) {
3284       st-&gt;print(&quot;%d : &quot;, i); method_array-&gt;at(i)-&gt;print_value(); st-&gt;cr();
3285     }
3286   }
3287   st-&gt;print(BULLET&quot;method ordering:   &quot;); method_ordering()-&gt;print_value_on(st);      st-&gt;cr();
3288   st-&gt;print(BULLET&quot;default_methods:   &quot;); default_methods()-&gt;print_value_on(st);      st-&gt;cr();
3289   if (Verbose &amp;&amp; default_methods() != NULL) {
3290     Array&lt;Method*&gt;* method_array = default_methods();
3291     for (int i = 0; i &lt; method_array-&gt;length(); i++) {
3292       st-&gt;print(&quot;%d : &quot;, i); method_array-&gt;at(i)-&gt;print_value(); st-&gt;cr();
3293     }
3294   }
3295   if (default_vtable_indices() != NULL) {
3296     st-&gt;print(BULLET&quot;default vtable indices:   &quot;); default_vtable_indices()-&gt;print_value_on(st);       st-&gt;cr();
3297   }
3298   st-&gt;print(BULLET&quot;local interfaces:  &quot;); local_interfaces()-&gt;print_value_on(st);      st-&gt;cr();
3299   st-&gt;print(BULLET&quot;trans. interfaces: &quot;); transitive_interfaces()-&gt;print_value_on(st); st-&gt;cr();
3300   st-&gt;print(BULLET&quot;constants:         &quot;); constants()-&gt;print_value_on(st);         st-&gt;cr();
3301   if (class_loader_data() != NULL) {
3302     st-&gt;print(BULLET&quot;class loader data:  &quot;);
3303     class_loader_data()-&gt;print_value_on(st);
3304     st-&gt;cr();
3305   }
3306   st-&gt;print(BULLET&quot;unsafe anonymous host class:        &quot;); Metadata::print_value_on_maybe_null(st, unsafe_anonymous_host()); st-&gt;cr();
3307   if (source_file_name() != NULL) {
3308     st-&gt;print(BULLET&quot;source file:       &quot;);
3309     source_file_name()-&gt;print_value_on(st);
3310     st-&gt;cr();
3311   }
3312   if (source_debug_extension() != NULL) {
3313     st-&gt;print(BULLET&quot;source debug extension:       &quot;);
3314     st-&gt;print(&quot;%s&quot;, source_debug_extension());
3315     st-&gt;cr();
3316   }
3317   st-&gt;print(BULLET&quot;class annotations:       &quot;); class_annotations()-&gt;print_value_on(st); st-&gt;cr();
3318   st-&gt;print(BULLET&quot;class type annotations:  &quot;); class_type_annotations()-&gt;print_value_on(st); st-&gt;cr();
3319   st-&gt;print(BULLET&quot;field annotations:       &quot;); fields_annotations()-&gt;print_value_on(st); st-&gt;cr();
3320   st-&gt;print(BULLET&quot;field type annotations:  &quot;); fields_type_annotations()-&gt;print_value_on(st); st-&gt;cr();
3321   {
3322     bool have_pv = false;
3323     // previous versions are linked together through the InstanceKlass
3324     for (InstanceKlass* pv_node = previous_versions();
3325          pv_node != NULL;
3326          pv_node = pv_node-&gt;previous_versions()) {
3327       if (!have_pv)
3328         st-&gt;print(BULLET&quot;previous version:  &quot;);
3329       have_pv = true;
3330       pv_node-&gt;constants()-&gt;print_value_on(st);
3331     }
3332     if (have_pv) st-&gt;cr();
3333   }
3334 
3335   if (generic_signature() != NULL) {
3336     st-&gt;print(BULLET&quot;generic signature: &quot;);
3337     generic_signature()-&gt;print_value_on(st);
3338     st-&gt;cr();
3339   }
3340   st-&gt;print(BULLET&quot;inner classes:     &quot;); inner_classes()-&gt;print_value_on(st);     st-&gt;cr();
3341   st-&gt;print(BULLET&quot;nest members:     &quot;); nest_members()-&gt;print_value_on(st);     st-&gt;cr();
3342   if (record_components() != NULL) {
3343     st-&gt;print(BULLET&quot;record components:     &quot;); record_components()-&gt;print_value_on(st);     st-&gt;cr();
3344   }
<a name="7" id="anc7"></a>
3345   if (java_mirror() != NULL) {
3346     st-&gt;print(BULLET&quot;java mirror:       &quot;);
3347     java_mirror()-&gt;print_value_on(st);
3348     st-&gt;cr();
3349   } else {
3350     st-&gt;print_cr(BULLET&quot;java mirror:       NULL&quot;);
3351   }
3352   st-&gt;print(BULLET&quot;vtable length      %d  (start addr: &quot; INTPTR_FORMAT &quot;)&quot;, vtable_length(), p2i(start_of_vtable())); st-&gt;cr();
3353   if (vtable_length() &gt; 0 &amp;&amp; (Verbose || WizardMode))  print_vtable(start_of_vtable(), vtable_length(), st);
3354   st-&gt;print(BULLET&quot;itable length      %d (start addr: &quot; INTPTR_FORMAT &quot;)&quot;, itable_length(), p2i(start_of_itable())); st-&gt;cr();
3355   if (itable_length() &gt; 0 &amp;&amp; (Verbose || WizardMode))  print_vtable(start_of_itable(), itable_length(), st);
3356   st-&gt;print_cr(BULLET&quot;---- static fields (%d words):&quot;, static_field_size());
3357   FieldPrinter print_static_field(st);
3358   ((InstanceKlass*)this)-&gt;do_local_static_fields(&amp;print_static_field);
3359   st-&gt;print_cr(BULLET&quot;---- non-static fields (%d words):&quot;, nonstatic_field_size());
3360   FieldPrinter print_nonstatic_field(st);
3361   InstanceKlass* ik = const_cast&lt;InstanceKlass*&gt;(this);
3362   ik-&gt;do_nonstatic_fields(&amp;print_nonstatic_field);
3363 
3364   st-&gt;print(BULLET&quot;non-static oop maps: &quot;);
3365   OopMapBlock* map     = start_of_nonstatic_oop_maps();
3366   OopMapBlock* end_map = map + nonstatic_oop_map_count();
3367   while (map &lt; end_map) {
3368     st-&gt;print(&quot;%d-%d &quot;, map-&gt;offset(), map-&gt;offset() + heapOopSize*(map-&gt;count() - 1));
3369     map++;
3370   }
3371   st-&gt;cr();
3372 }
3373 
3374 #endif //PRODUCT
3375 
3376 void InstanceKlass::print_value_on(outputStream* st) const {
3377   assert(is_klass(), &quot;must be klass&quot;);
3378   if (Verbose || WizardMode)  access_flags().print_on(st);
3379   name()-&gt;print_value_on(st);
3380 }
3381 
3382 #ifndef PRODUCT
3383 
3384 void FieldPrinter::do_field(fieldDescriptor* fd) {
3385   _st-&gt;print(BULLET);
3386    if (_obj == NULL) {
3387      fd-&gt;print_on(_st);
3388      _st-&gt;cr();
3389    } else {
3390      fd-&gt;print_on_for(_st, _obj);
3391      _st-&gt;cr();
3392    }
3393 }
3394 
3395 
3396 void InstanceKlass::oop_print_on(oop obj, outputStream* st) {
3397   Klass::oop_print_on(obj, st);
3398 
3399   if (this == SystemDictionary::String_klass()) {
3400     typeArrayOop value  = java_lang_String::value(obj);
3401     juint        length = java_lang_String::length(obj);
3402     if (value != NULL &amp;&amp;
3403         value-&gt;is_typeArray() &amp;&amp;
3404         length &lt;= (juint) value-&gt;length()) {
3405       st-&gt;print(BULLET&quot;string: &quot;);
3406       java_lang_String::print(obj, st);
3407       st-&gt;cr();
3408       if (!WizardMode)  return;  // that is enough
3409     }
3410   }
3411 
3412   st-&gt;print_cr(BULLET&quot;---- fields (total size %d words):&quot;, oop_size(obj));
3413   FieldPrinter print_field(st, obj);
3414   do_nonstatic_fields(&amp;print_field);
3415 
3416   if (this == SystemDictionary::Class_klass()) {
3417     st-&gt;print(BULLET&quot;signature: &quot;);
3418     java_lang_Class::print_signature(obj, st);
3419     st-&gt;cr();
3420     Klass* mirrored_klass = java_lang_Class::as_Klass(obj);
3421     st-&gt;print(BULLET&quot;fake entry for mirror: &quot;);
3422     Metadata::print_value_on_maybe_null(st, mirrored_klass);
3423     st-&gt;cr();
3424     Klass* array_klass = java_lang_Class::array_klass_acquire(obj);
3425     st-&gt;print(BULLET&quot;fake entry for array: &quot;);
3426     Metadata::print_value_on_maybe_null(st, array_klass);
3427     st-&gt;cr();
3428     st-&gt;print_cr(BULLET&quot;fake entry for oop_size: %d&quot;, java_lang_Class::oop_size(obj));
3429     st-&gt;print_cr(BULLET&quot;fake entry for static_oop_field_count: %d&quot;, java_lang_Class::static_oop_field_count(obj));
3430     Klass* real_klass = java_lang_Class::as_Klass(obj);
3431     if (real_klass != NULL &amp;&amp; real_klass-&gt;is_instance_klass()) {
3432       InstanceKlass::cast(real_klass)-&gt;do_local_static_fields(&amp;print_field);
3433     }
3434   } else if (this == SystemDictionary::MethodType_klass()) {
3435     st-&gt;print(BULLET&quot;signature: &quot;);
3436     java_lang_invoke_MethodType::print_signature(obj, st);
3437     st-&gt;cr();
3438   }
3439 }
3440 
3441 bool InstanceKlass::verify_itable_index(int i) {
3442   int method_count = klassItable::method_count_for_interface(this);
3443   assert(i &gt;= 0 &amp;&amp; i &lt; method_count, &quot;index out of bounds&quot;);
3444   return true;
3445 }
3446 
3447 #endif //PRODUCT
3448 
3449 void InstanceKlass::oop_print_value_on(oop obj, outputStream* st) {
3450   st-&gt;print(&quot;a &quot;);
3451   name()-&gt;print_value_on(st);
3452   obj-&gt;print_address_on(st);
3453   if (this == SystemDictionary::String_klass()
3454       &amp;&amp; java_lang_String::value(obj) != NULL) {
3455     ResourceMark rm;
3456     int len = java_lang_String::length(obj);
3457     int plen = (len &lt; 24 ? len : 12);
3458     char* str = java_lang_String::as_utf8_string(obj, 0, plen);
3459     st-&gt;print(&quot; = \&quot;%s\&quot;&quot;, str);
3460     if (len &gt; plen)
3461       st-&gt;print(&quot;...[%d]&quot;, len);
3462   } else if (this == SystemDictionary::Class_klass()) {
3463     Klass* k = java_lang_Class::as_Klass(obj);
3464     st-&gt;print(&quot; = &quot;);
3465     if (k != NULL) {
3466       k-&gt;print_value_on(st);
3467     } else {
3468       const char* tname = type2name(java_lang_Class::primitive_type(obj));
3469       st-&gt;print(&quot;%s&quot;, tname ? tname : &quot;type?&quot;);
3470     }
3471   } else if (this == SystemDictionary::MethodType_klass()) {
3472     st-&gt;print(&quot; = &quot;);
3473     java_lang_invoke_MethodType::print_signature(obj, st);
3474   } else if (java_lang_boxing_object::is_instance(obj)) {
3475     st-&gt;print(&quot; = &quot;);
3476     java_lang_boxing_object::print(obj, st);
3477   } else if (this == SystemDictionary::LambdaForm_klass()) {
3478     oop vmentry = java_lang_invoke_LambdaForm::vmentry(obj);
3479     if (vmentry != NULL) {
3480       st-&gt;print(&quot; =&gt; &quot;);
3481       vmentry-&gt;print_value_on(st);
3482     }
3483   } else if (this == SystemDictionary::MemberName_klass()) {
3484     Metadata* vmtarget = java_lang_invoke_MemberName::vmtarget(obj);
3485     if (vmtarget != NULL) {
3486       st-&gt;print(&quot; = &quot;);
3487       vmtarget-&gt;print_value_on(st);
3488     } else {
3489       java_lang_invoke_MemberName::clazz(obj)-&gt;print_value_on(st);
3490       st-&gt;print(&quot;.&quot;);
3491       java_lang_invoke_MemberName::name(obj)-&gt;print_value_on(st);
3492     }
3493   }
3494 }
3495 
3496 const char* InstanceKlass::internal_name() const {
3497   return external_name();
3498 }
3499 
3500 void InstanceKlass::print_class_load_logging(ClassLoaderData* loader_data,
3501                                              const char* module_name,
3502                                              const ClassFileStream* cfs) const {
3503   if (!log_is_enabled(Info, class, load)) {
3504     return;
3505   }
3506 
3507   ResourceMark rm;
3508   LogMessage(class, load) msg;
3509   stringStream info_stream;
3510 
3511   // Name and class hierarchy info
3512   info_stream.print(&quot;%s&quot;, external_name());
3513 
3514   // Source
3515   if (cfs != NULL) {
3516     if (cfs-&gt;source() != NULL) {
3517       if (module_name != NULL) {
3518         // When the boot loader created the stream, it didn&#39;t know the module name
3519         // yet. Let&#39;s format it now.
3520         if (cfs-&gt;from_boot_loader_modules_image()) {
3521           info_stream.print(&quot; source: jrt:/%s&quot;, module_name);
3522         } else {
3523           info_stream.print(&quot; source: %s&quot;, cfs-&gt;source());
3524         }
3525       } else {
3526         info_stream.print(&quot; source: %s&quot;, cfs-&gt;source());
3527       }
3528     } else if (loader_data == ClassLoaderData::the_null_class_loader_data()) {
3529       Thread* THREAD = Thread::current();
3530       Klass* caller =
3531             THREAD-&gt;is_Java_thread()
3532                 ? ((JavaThread*)THREAD)-&gt;security_get_caller_class(1)
3533                 : NULL;
3534       // caller can be NULL, for example, during a JVMTI VM_Init hook
3535       if (caller != NULL) {
3536         info_stream.print(&quot; source: instance of %s&quot;, caller-&gt;external_name());
3537       } else {
3538         // source is unknown
3539       }
3540     } else {
3541       oop class_loader = loader_data-&gt;class_loader();
3542       info_stream.print(&quot; source: %s&quot;, class_loader-&gt;klass()-&gt;external_name());
3543     }
3544   } else {
3545     assert(this-&gt;is_shared(), &quot;must be&quot;);
3546     if (MetaspaceShared::is_shared_dynamic((void*)this)) {
3547       info_stream.print(&quot; source: shared objects file (top)&quot;);
3548     } else {
3549       info_stream.print(&quot; source: shared objects file&quot;);
3550     }
3551   }
3552 
3553   msg.info(&quot;%s&quot;, info_stream.as_string());
3554 
3555   if (log_is_enabled(Debug, class, load)) {
3556     stringStream debug_stream;
3557 
3558     // Class hierarchy info
3559     debug_stream.print(&quot; klass: &quot; INTPTR_FORMAT &quot; super: &quot; INTPTR_FORMAT,
3560                        p2i(this),  p2i(superklass()));
3561 
3562     // Interfaces
3563     if (local_interfaces() != NULL &amp;&amp; local_interfaces()-&gt;length() &gt; 0) {
3564       debug_stream.print(&quot; interfaces:&quot;);
3565       int length = local_interfaces()-&gt;length();
3566       for (int i = 0; i &lt; length; i++) {
3567         debug_stream.print(&quot; &quot; INTPTR_FORMAT,
3568                            p2i(InstanceKlass::cast(local_interfaces()-&gt;at(i))));
3569       }
3570     }
3571 
3572     // Class loader
3573     debug_stream.print(&quot; loader: [&quot;);
3574     loader_data-&gt;print_value_on(&amp;debug_stream);
3575     debug_stream.print(&quot;]&quot;);
3576 
3577     // Classfile checksum
3578     if (cfs) {
3579       debug_stream.print(&quot; bytes: %d checksum: %08x&quot;,
3580                          cfs-&gt;length(),
3581                          ClassLoader::crc32(0, (const char*)cfs-&gt;buffer(),
3582                          cfs-&gt;length()));
3583     }
3584 
3585     msg.debug(&quot;%s&quot;, debug_stream.as_string());
3586   }
3587 }
3588 
3589 // Verification
3590 
3591 class VerifyFieldClosure: public BasicOopIterateClosure {
3592  protected:
3593   template &lt;class T&gt; void do_oop_work(T* p) {
3594     oop obj = RawAccess&lt;&gt;::oop_load(p);
3595     if (!oopDesc::is_oop_or_null(obj)) {
3596       tty-&gt;print_cr(&quot;Failed: &quot; PTR_FORMAT &quot; -&gt; &quot; PTR_FORMAT, p2i(p), p2i(obj));
3597       Universe::print_on(tty);
3598       guarantee(false, &quot;boom&quot;);
3599     }
3600   }
3601  public:
3602   virtual void do_oop(oop* p)       { VerifyFieldClosure::do_oop_work(p); }
3603   virtual void do_oop(narrowOop* p) { VerifyFieldClosure::do_oop_work(p); }
3604 };
3605 
3606 void InstanceKlass::verify_on(outputStream* st) {
3607 #ifndef PRODUCT
3608   // Avoid redundant verifies, this really should be in product.
3609   if (_verify_count == Universe::verify_count()) return;
3610   _verify_count = Universe::verify_count();
3611 #endif
3612 
3613   // Verify Klass
3614   Klass::verify_on(st);
3615 
3616   // Verify that klass is present in ClassLoaderData
3617   guarantee(class_loader_data()-&gt;contains_klass(this),
3618             &quot;this class isn&#39;t found in class loader data&quot;);
3619 
3620   // Verify vtables
3621   if (is_linked()) {
3622     // $$$ This used to be done only for m/s collections.  Doing it
3623     // always seemed a valid generalization.  (DLD -- 6/00)
3624     vtable().verify(st);
3625   }
3626 
3627   // Verify first subklass
3628   if (subklass() != NULL) {
3629     guarantee(subklass()-&gt;is_klass(), &quot;should be klass&quot;);
3630   }
3631 
3632   // Verify siblings
3633   Klass* super = this-&gt;super();
3634   Klass* sib = next_sibling();
3635   if (sib != NULL) {
3636     if (sib == this) {
3637       fatal(&quot;subclass points to itself &quot; PTR_FORMAT, p2i(sib));
3638     }
3639 
3640     guarantee(sib-&gt;is_klass(), &quot;should be klass&quot;);
3641     guarantee(sib-&gt;super() == super, &quot;siblings should have same superklass&quot;);
3642   }
3643 
3644   // Verify local interfaces
3645   if (local_interfaces()) {
3646     Array&lt;InstanceKlass*&gt;* local_interfaces = this-&gt;local_interfaces();
3647     for (int j = 0; j &lt; local_interfaces-&gt;length(); j++) {
3648       InstanceKlass* e = local_interfaces-&gt;at(j);
3649       guarantee(e-&gt;is_klass() &amp;&amp; e-&gt;is_interface(), &quot;invalid local interface&quot;);
3650     }
3651   }
3652 
3653   // Verify transitive interfaces
3654   if (transitive_interfaces() != NULL) {
3655     Array&lt;InstanceKlass*&gt;* transitive_interfaces = this-&gt;transitive_interfaces();
3656     for (int j = 0; j &lt; transitive_interfaces-&gt;length(); j++) {
3657       InstanceKlass* e = transitive_interfaces-&gt;at(j);
3658       guarantee(e-&gt;is_klass() &amp;&amp; e-&gt;is_interface(), &quot;invalid transitive interface&quot;);
3659     }
3660   }
3661 
3662   // Verify methods
3663   if (methods() != NULL) {
3664     Array&lt;Method*&gt;* methods = this-&gt;methods();
3665     for (int j = 0; j &lt; methods-&gt;length(); j++) {
3666       guarantee(methods-&gt;at(j)-&gt;is_method(), &quot;non-method in methods array&quot;);
3667     }
3668     for (int j = 0; j &lt; methods-&gt;length() - 1; j++) {
3669       Method* m1 = methods-&gt;at(j);
3670       Method* m2 = methods-&gt;at(j + 1);
3671       guarantee(m1-&gt;name()-&gt;fast_compare(m2-&gt;name()) &lt;= 0, &quot;methods not sorted correctly&quot;);
3672     }
3673   }
3674 
3675   // Verify method ordering
3676   if (method_ordering() != NULL) {
3677     Array&lt;int&gt;* method_ordering = this-&gt;method_ordering();
3678     int length = method_ordering-&gt;length();
3679     if (JvmtiExport::can_maintain_original_method_order() ||
3680         ((UseSharedSpaces || Arguments::is_dumping_archive()) &amp;&amp; length != 0)) {
3681       guarantee(length == methods()-&gt;length(), &quot;invalid method ordering length&quot;);
3682       jlong sum = 0;
3683       for (int j = 0; j &lt; length; j++) {
3684         int original_index = method_ordering-&gt;at(j);
3685         guarantee(original_index &gt;= 0, &quot;invalid method ordering index&quot;);
3686         guarantee(original_index &lt; length, &quot;invalid method ordering index&quot;);
3687         sum += original_index;
3688       }
3689       // Verify sum of indices 0,1,...,length-1
3690       guarantee(sum == ((jlong)length*(length-1))/2, &quot;invalid method ordering sum&quot;);
3691     } else {
3692       guarantee(length == 0, &quot;invalid method ordering length&quot;);
3693     }
3694   }
3695 
3696   // Verify default methods
3697   if (default_methods() != NULL) {
3698     Array&lt;Method*&gt;* methods = this-&gt;default_methods();
3699     for (int j = 0; j &lt; methods-&gt;length(); j++) {
3700       guarantee(methods-&gt;at(j)-&gt;is_method(), &quot;non-method in methods array&quot;);
3701     }
3702     for (int j = 0; j &lt; methods-&gt;length() - 1; j++) {
3703       Method* m1 = methods-&gt;at(j);
3704       Method* m2 = methods-&gt;at(j + 1);
3705       guarantee(m1-&gt;name()-&gt;fast_compare(m2-&gt;name()) &lt;= 0, &quot;methods not sorted correctly&quot;);
3706     }
3707   }
3708 
3709   // Verify JNI static field identifiers
3710   if (jni_ids() != NULL) {
3711     jni_ids()-&gt;verify(this);
3712   }
3713 
3714   // Verify other fields
3715   if (constants() != NULL) {
3716     guarantee(constants()-&gt;is_constantPool(), &quot;should be constant pool&quot;);
3717   }
3718   const Klass* anonymous_host = unsafe_anonymous_host();
3719   if (anonymous_host != NULL) {
3720     guarantee(anonymous_host-&gt;is_klass(), &quot;should be klass&quot;);
3721   }
3722 }
3723 
3724 void InstanceKlass::oop_verify_on(oop obj, outputStream* st) {
3725   Klass::oop_verify_on(obj, st);
3726   VerifyFieldClosure blk;
3727   obj-&gt;oop_iterate(&amp;blk);
3728 }
3729 
3730 
3731 // JNIid class for jfieldIDs only
3732 // Note to reviewers:
3733 // These JNI functions are just moved over to column 1 and not changed
3734 // in the compressed oops workspace.
3735 JNIid::JNIid(Klass* holder, int offset, JNIid* next) {
3736   _holder = holder;
3737   _offset = offset;
3738   _next = next;
3739   debug_only(_is_static_field_id = false;)
3740 }
3741 
3742 
3743 JNIid* JNIid::find(int offset) {
3744   JNIid* current = this;
3745   while (current != NULL) {
3746     if (current-&gt;offset() == offset) return current;
3747     current = current-&gt;next();
3748   }
3749   return NULL;
3750 }
3751 
3752 void JNIid::deallocate(JNIid* current) {
3753   while (current != NULL) {
3754     JNIid* next = current-&gt;next();
3755     delete current;
3756     current = next;
3757   }
3758 }
3759 
3760 
3761 void JNIid::verify(Klass* holder) {
3762   int first_field_offset  = InstanceMirrorKlass::offset_of_static_fields();
3763   int end_field_offset;
3764   end_field_offset = first_field_offset + (InstanceKlass::cast(holder)-&gt;static_field_size() * wordSize);
3765 
3766   JNIid* current = this;
3767   while (current != NULL) {
3768     guarantee(current-&gt;holder() == holder, &quot;Invalid klass in JNIid&quot;);
3769 #ifdef ASSERT
3770     int o = current-&gt;offset();
3771     if (current-&gt;is_static_field_id()) {
3772       guarantee(o &gt;= first_field_offset  &amp;&amp; o &lt; end_field_offset,  &quot;Invalid static field offset in JNIid&quot;);
3773     }
3774 #endif
3775     current = current-&gt;next();
3776   }
3777 }
3778 
3779 void InstanceKlass::set_init_state(ClassState state) {
3780 #ifdef ASSERT
3781   bool good_state = is_shared() ? (_init_state &lt;= state)
3782                                                : (_init_state &lt; state);
3783   assert(good_state || state == allocated, &quot;illegal state transition&quot;);
3784 #endif
3785   assert(_init_thread == NULL, &quot;should be cleared before state change&quot;);
3786   _init_state = (u1)state;
3787 }
3788 
3789 #if INCLUDE_JVMTI
3790 
3791 // RedefineClasses() support for previous versions
3792 
3793 // Globally, there is at least one previous version of a class to walk
3794 // during class unloading, which is saved because old methods in the class
3795 // are still running.   Otherwise the previous version list is cleaned up.
3796 bool InstanceKlass::_has_previous_versions = false;
3797 
3798 // Returns true if there are previous versions of a class for class
3799 // unloading only. Also resets the flag to false. purge_previous_version
3800 // will set the flag to true if there are any left, i.e., if there&#39;s any
3801 // work to do for next time. This is to avoid the expensive code cache
3802 // walk in CLDG::clean_deallocate_lists().
3803 bool InstanceKlass::has_previous_versions_and_reset() {
3804   bool ret = _has_previous_versions;
3805   log_trace(redefine, class, iklass, purge)(&quot;Class unloading: has_previous_versions = %s&quot;,
3806      ret ? &quot;true&quot; : &quot;false&quot;);
3807   _has_previous_versions = false;
3808   return ret;
3809 }
3810 
3811 // Purge previous versions before adding new previous versions of the class and
3812 // during class unloading.
3813 void InstanceKlass::purge_previous_version_list() {
3814   assert(SafepointSynchronize::is_at_safepoint(), &quot;only called at safepoint&quot;);
3815   assert(has_been_redefined(), &quot;Should only be called for main class&quot;);
3816 
3817   // Quick exit.
3818   if (previous_versions() == NULL) {
3819     return;
3820   }
3821 
3822   // This klass has previous versions so see what we can cleanup
3823   // while it is safe to do so.
3824 
3825   int deleted_count = 0;    // leave debugging breadcrumbs
3826   int live_count = 0;
3827   ClassLoaderData* loader_data = class_loader_data();
3828   assert(loader_data != NULL, &quot;should never be null&quot;);
3829 
3830   ResourceMark rm;
3831   log_trace(redefine, class, iklass, purge)(&quot;%s: previous versions&quot;, external_name());
3832 
3833   // previous versions are linked together through the InstanceKlass
3834   InstanceKlass* pv_node = previous_versions();
3835   InstanceKlass* last = this;
3836   int version = 0;
3837 
3838   // check the previous versions list
3839   for (; pv_node != NULL; ) {
3840 
3841     ConstantPool* pvcp = pv_node-&gt;constants();
3842     assert(pvcp != NULL, &quot;cp ref was unexpectedly cleared&quot;);
3843 
3844     if (!pvcp-&gt;on_stack()) {
3845       // If the constant pool isn&#39;t on stack, none of the methods
3846       // are executing.  Unlink this previous_version.
3847       // The previous version InstanceKlass is on the ClassLoaderData deallocate list
3848       // so will be deallocated during the next phase of class unloading.
3849       log_trace(redefine, class, iklass, purge)
3850         (&quot;previous version &quot; INTPTR_FORMAT &quot; is dead.&quot;, p2i(pv_node));
3851       // For debugging purposes.
3852       pv_node-&gt;set_is_scratch_class();
3853       // Unlink from previous version list.
3854       assert(pv_node-&gt;class_loader_data() == loader_data, &quot;wrong loader_data&quot;);
3855       InstanceKlass* next = pv_node-&gt;previous_versions();
3856       pv_node-&gt;link_previous_versions(NULL);   // point next to NULL
3857       last-&gt;link_previous_versions(next);
3858       // Add to the deallocate list after unlinking
3859       loader_data-&gt;add_to_deallocate_list(pv_node);
3860       pv_node = next;
3861       deleted_count++;
3862       version++;
3863       continue;
3864     } else {
3865       log_trace(redefine, class, iklass, purge)(&quot;previous version &quot; INTPTR_FORMAT &quot; is alive&quot;, p2i(pv_node));
3866       assert(pvcp-&gt;pool_holder() != NULL, &quot;Constant pool with no holder&quot;);
3867       guarantee (!loader_data-&gt;is_unloading(), &quot;unloaded classes can&#39;t be on the stack&quot;);
3868       live_count++;
3869       // found a previous version for next time we do class unloading
3870       _has_previous_versions = true;
3871     }
3872 
3873     // At least one method is live in this previous version.
3874     // Reset dead EMCP methods not to get breakpoints.
3875     // All methods are deallocated when all of the methods for this class are no
3876     // longer running.
3877     Array&lt;Method*&gt;* method_refs = pv_node-&gt;methods();
3878     if (method_refs != NULL) {
3879       log_trace(redefine, class, iklass, purge)(&quot;previous methods length=%d&quot;, method_refs-&gt;length());
3880       for (int j = 0; j &lt; method_refs-&gt;length(); j++) {
3881         Method* method = method_refs-&gt;at(j);
3882 
3883         if (!method-&gt;on_stack()) {
3884           // no breakpoints for non-running methods
3885           if (method-&gt;is_running_emcp()) {
3886             method-&gt;set_running_emcp(false);
3887           }
3888         } else {
3889           assert (method-&gt;is_obsolete() || method-&gt;is_running_emcp(),
3890                   &quot;emcp method cannot run after emcp bit is cleared&quot;);
3891           log_trace(redefine, class, iklass, purge)
3892             (&quot;purge: %s(%s): prev method @%d in version @%d is alive&quot;,
3893              method-&gt;name()-&gt;as_C_string(), method-&gt;signature()-&gt;as_C_string(), j, version);
3894         }
3895       }
3896     }
3897     // next previous version
3898     last = pv_node;
3899     pv_node = pv_node-&gt;previous_versions();
3900     version++;
3901   }
3902   log_trace(redefine, class, iklass, purge)
3903     (&quot;previous version stats: live=%d, deleted=%d&quot;, live_count, deleted_count);
3904 }
3905 
3906 void InstanceKlass::mark_newly_obsolete_methods(Array&lt;Method*&gt;* old_methods,
3907                                                 int emcp_method_count) {
3908   int obsolete_method_count = old_methods-&gt;length() - emcp_method_count;
3909 
3910   if (emcp_method_count != 0 &amp;&amp; obsolete_method_count != 0 &amp;&amp;
3911       _previous_versions != NULL) {
3912     // We have a mix of obsolete and EMCP methods so we have to
3913     // clear out any matching EMCP method entries the hard way.
3914     int local_count = 0;
3915     for (int i = 0; i &lt; old_methods-&gt;length(); i++) {
3916       Method* old_method = old_methods-&gt;at(i);
3917       if (old_method-&gt;is_obsolete()) {
3918         // only obsolete methods are interesting
3919         Symbol* m_name = old_method-&gt;name();
3920         Symbol* m_signature = old_method-&gt;signature();
3921 
3922         // previous versions are linked together through the InstanceKlass
3923         int j = 0;
3924         for (InstanceKlass* prev_version = _previous_versions;
3925              prev_version != NULL;
3926              prev_version = prev_version-&gt;previous_versions(), j++) {
3927 
3928           Array&lt;Method*&gt;* method_refs = prev_version-&gt;methods();
3929           for (int k = 0; k &lt; method_refs-&gt;length(); k++) {
3930             Method* method = method_refs-&gt;at(k);
3931 
3932             if (!method-&gt;is_obsolete() &amp;&amp;
3933                 method-&gt;name() == m_name &amp;&amp;
3934                 method-&gt;signature() == m_signature) {
3935               // The current RedefineClasses() call has made all EMCP
3936               // versions of this method obsolete so mark it as obsolete
3937               log_trace(redefine, class, iklass, add)
3938                 (&quot;%s(%s): flush obsolete method @%d in version @%d&quot;,
3939                  m_name-&gt;as_C_string(), m_signature-&gt;as_C_string(), k, j);
3940 
3941               method-&gt;set_is_obsolete();
3942               break;
3943             }
3944           }
3945 
3946           // The previous loop may not find a matching EMCP method, but
3947           // that doesn&#39;t mean that we can optimize and not go any
3948           // further back in the PreviousVersion generations. The EMCP
3949           // method for this generation could have already been made obsolete,
3950           // but there still may be an older EMCP method that has not
3951           // been made obsolete.
3952         }
3953 
3954         if (++local_count &gt;= obsolete_method_count) {
3955           // no more obsolete methods so bail out now
3956           break;
3957         }
3958       }
3959     }
3960   }
3961 }
3962 
3963 // Save the scratch_class as the previous version if any of the methods are running.
3964 // The previous_versions are used to set breakpoints in EMCP methods and they are
3965 // also used to clean MethodData links to redefined methods that are no longer running.
3966 void InstanceKlass::add_previous_version(InstanceKlass* scratch_class,
3967                                          int emcp_method_count) {
3968   assert(Thread::current()-&gt;is_VM_thread(),
3969          &quot;only VMThread can add previous versions&quot;);
3970 
3971   ResourceMark rm;
3972   log_trace(redefine, class, iklass, add)
3973     (&quot;adding previous version ref for %s, EMCP_cnt=%d&quot;, scratch_class-&gt;external_name(), emcp_method_count);
3974 
3975   // Clean out old previous versions for this class
3976   purge_previous_version_list();
3977 
3978   // Mark newly obsolete methods in remaining previous versions.  An EMCP method from
3979   // a previous redefinition may be made obsolete by this redefinition.
3980   Array&lt;Method*&gt;* old_methods = scratch_class-&gt;methods();
3981   mark_newly_obsolete_methods(old_methods, emcp_method_count);
3982 
3983   // If the constant pool for this previous version of the class
3984   // is not marked as being on the stack, then none of the methods
3985   // in this previous version of the class are on the stack so
3986   // we don&#39;t need to add this as a previous version.
3987   ConstantPool* cp_ref = scratch_class-&gt;constants();
3988   if (!cp_ref-&gt;on_stack()) {
3989     log_trace(redefine, class, iklass, add)(&quot;scratch class not added; no methods are running&quot;);
3990     // For debugging purposes.
3991     scratch_class-&gt;set_is_scratch_class();
3992     scratch_class-&gt;class_loader_data()-&gt;add_to_deallocate_list(scratch_class);
3993     return;
3994   }
3995 
3996   if (emcp_method_count != 0) {
3997     // At least one method is still running, check for EMCP methods
3998     for (int i = 0; i &lt; old_methods-&gt;length(); i++) {
3999       Method* old_method = old_methods-&gt;at(i);
4000       if (!old_method-&gt;is_obsolete() &amp;&amp; old_method-&gt;on_stack()) {
4001         // if EMCP method (not obsolete) is on the stack, mark as EMCP so that
4002         // we can add breakpoints for it.
4003 
4004         // We set the method-&gt;on_stack bit during safepoints for class redefinition
4005         // and use this bit to set the is_running_emcp bit.
4006         // After the safepoint, the on_stack bit is cleared and the running emcp
4007         // method may exit.   If so, we would set a breakpoint in a method that
4008         // is never reached, but this won&#39;t be noticeable to the programmer.
4009         old_method-&gt;set_running_emcp(true);
4010         log_trace(redefine, class, iklass, add)
4011           (&quot;EMCP method %s is on_stack &quot; INTPTR_FORMAT, old_method-&gt;name_and_sig_as_C_string(), p2i(old_method));
4012       } else if (!old_method-&gt;is_obsolete()) {
4013         log_trace(redefine, class, iklass, add)
4014           (&quot;EMCP method %s is NOT on_stack &quot; INTPTR_FORMAT, old_method-&gt;name_and_sig_as_C_string(), p2i(old_method));
4015       }
4016     }
4017   }
4018 
4019   // Add previous version if any methods are still running.
4020   // Set has_previous_version flag for processing during class unloading.
4021   _has_previous_versions = true;
4022   log_trace(redefine, class, iklass, add) (&quot;scratch class added; one of its methods is on_stack.&quot;);
4023   assert(scratch_class-&gt;previous_versions() == NULL, &quot;shouldn&#39;t have a previous version&quot;);
4024   scratch_class-&gt;link_previous_versions(previous_versions());
4025   link_previous_versions(scratch_class);
4026 } // end add_previous_version()
4027 
4028 #endif // INCLUDE_JVMTI
4029 
4030 Method* InstanceKlass::method_with_idnum(int idnum) {
4031   Method* m = NULL;
4032   if (idnum &lt; methods()-&gt;length()) {
4033     m = methods()-&gt;at(idnum);
4034   }
4035   if (m == NULL || m-&gt;method_idnum() != idnum) {
4036     for (int index = 0; index &lt; methods()-&gt;length(); ++index) {
4037       m = methods()-&gt;at(index);
4038       if (m-&gt;method_idnum() == idnum) {
4039         return m;
4040       }
4041     }
4042     // None found, return null for the caller to handle.
4043     return NULL;
4044   }
4045   return m;
4046 }
4047 
4048 
4049 Method* InstanceKlass::method_with_orig_idnum(int idnum) {
4050   if (idnum &gt;= methods()-&gt;length()) {
4051     return NULL;
4052   }
4053   Method* m = methods()-&gt;at(idnum);
4054   if (m != NULL &amp;&amp; m-&gt;orig_method_idnum() == idnum) {
4055     return m;
4056   }
4057   // Obsolete method idnum does not match the original idnum
4058   for (int index = 0; index &lt; methods()-&gt;length(); ++index) {
4059     m = methods()-&gt;at(index);
4060     if (m-&gt;orig_method_idnum() == idnum) {
4061       return m;
4062     }
4063   }
4064   // None found, return null for the caller to handle.
4065   return NULL;
4066 }
4067 
4068 
4069 Method* InstanceKlass::method_with_orig_idnum(int idnum, int version) {
4070   InstanceKlass* holder = get_klass_version(version);
4071   if (holder == NULL) {
4072     return NULL; // The version of klass is gone, no method is found
4073   }
4074   Method* method = holder-&gt;method_with_orig_idnum(idnum);
4075   return method;
4076 }
4077 
4078 #if INCLUDE_JVMTI
4079 JvmtiCachedClassFileData* InstanceKlass::get_cached_class_file() {
4080   return _cached_class_file;
4081 }
4082 
4083 jint InstanceKlass::get_cached_class_file_len() {
4084   return VM_RedefineClasses::get_cached_class_file_len(_cached_class_file);
4085 }
4086 
4087 unsigned char * InstanceKlass::get_cached_class_file_bytes() {
4088   return VM_RedefineClasses::get_cached_class_file_bytes(_cached_class_file);
4089 }
4090 #endif
<a name="8" id="anc8"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="8" type="hidden" />
</body>
</html>