<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames src/hotspot/share/utilities/vmError.cpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
    <script type="text/javascript" src="../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>   1 /*
   2  * Copyright (c) 2003, 2020, Oracle and/or its affiliates. All rights reserved.
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.
   8  *
   9  * This code is distributed in the hope that it will be useful, but WITHOUT
  10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  *
  23  */
  24 
  25 #include &quot;precompiled.hpp&quot;
  26 #include &quot;jvm.h&quot;
  27 #include &quot;code/codeCache.hpp&quot;
  28 #include &quot;compiler/compileBroker.hpp&quot;
  29 #include &quot;compiler/disassembler.hpp&quot;
  30 #include &quot;gc/shared/gcConfig.hpp&quot;
<a name="1" id="anc1"></a><span class="line-added">  31 #include &quot;gc/shared/gcLogPrecious.hpp&quot;</span>
  32 #include &quot;logging/logConfiguration.hpp&quot;
  33 #include &quot;memory/metaspace.hpp&quot;
  34 #include &quot;memory/metaspaceShared.hpp&quot;
  35 #include &quot;memory/resourceArea.hpp&quot;
  36 #include &quot;memory/universe.hpp&quot;
  37 #include &quot;oops/compressedOops.hpp&quot;
  38 #include &quot;prims/whitebox.hpp&quot;
  39 #include &quot;runtime/arguments.hpp&quot;
  40 #include &quot;runtime/atomic.hpp&quot;
  41 #include &quot;runtime/frame.inline.hpp&quot;
  42 #include &quot;runtime/init.hpp&quot;
  43 #include &quot;runtime/os.hpp&quot;
  44 #include &quot;runtime/safepointMechanism.hpp&quot;
  45 #include &quot;runtime/thread.inline.hpp&quot;
  46 #include &quot;runtime/threadSMR.hpp&quot;
  47 #include &quot;runtime/vmThread.hpp&quot;
  48 #include &quot;runtime/vmOperations.hpp&quot;
  49 #include &quot;runtime/vm_version.hpp&quot;
  50 #include &quot;runtime/flags/jvmFlag.hpp&quot;
  51 #include &quot;services/memTracker.hpp&quot;
  52 #include &quot;utilities/debug.hpp&quot;
  53 #include &quot;utilities/decoder.hpp&quot;
  54 #include &quot;utilities/defaultStream.hpp&quot;
  55 #include &quot;utilities/events.hpp&quot;
  56 #include &quot;utilities/vmError.hpp&quot;
  57 #include &quot;utilities/macros.hpp&quot;
  58 #if INCLUDE_JFR
  59 #include &quot;jfr/jfr.hpp&quot;
  60 #endif
  61 
  62 #ifndef PRODUCT
  63 #include &lt;signal.h&gt;
  64 #endif // PRODUCT
  65 
  66 bool VMError::_error_reported = false;
  67 
  68 // call this when the VM is dying--it might loosen some asserts
  69 bool VMError::is_error_reported() { return _error_reported; }
  70 
  71 // returns an address which is guaranteed to generate a SIGSEGV on read,
  72 // for test purposes, which is not NULL and contains bits in every word
  73 void* VMError::get_segfault_address() {
  74   return (void*)
  75 #ifdef _LP64
  76     0xABC0000000000ABCULL;
  77 #else
  78     0x00000ABC;
  79 #endif
  80 }
  81 
  82 // List of environment variables that should be reported in error log file.
  83 const char *env_list[] = {
  84   // All platforms
  85   &quot;JAVA_HOME&quot;, &quot;JAVA_TOOL_OPTIONS&quot;, &quot;_JAVA_OPTIONS&quot;, &quot;CLASSPATH&quot;,
  86   &quot;PATH&quot;, &quot;USERNAME&quot;,
  87 
  88   // Env variables that are defined on Linux/BSD
  89   &quot;LD_LIBRARY_PATH&quot;, &quot;LD_PRELOAD&quot;, &quot;SHELL&quot;, &quot;DISPLAY&quot;,
  90   &quot;HOSTTYPE&quot;, &quot;OSTYPE&quot;, &quot;ARCH&quot;, &quot;MACHTYPE&quot;,
  91   &quot;LANG&quot;, &quot;LC_ALL&quot;, &quot;LC_CTYPE&quot;, &quot;TZ&quot;,
  92 
  93   // defined on AIX
  94   &quot;LIBPATH&quot;, &quot;LDR_PRELOAD&quot;, &quot;LDR_PRELOAD64&quot;,
  95 
  96   // defined on Linux/AIX/BSD
  97   &quot;_JAVA_SR_SIGNUM&quot;,
  98 
  99   // defined on Darwin
 100   &quot;DYLD_LIBRARY_PATH&quot;, &quot;DYLD_FALLBACK_LIBRARY_PATH&quot;,
 101   &quot;DYLD_FRAMEWORK_PATH&quot;, &quot;DYLD_FALLBACK_FRAMEWORK_PATH&quot;,
 102   &quot;DYLD_INSERT_LIBRARIES&quot;,
 103 
 104   // defined on Windows
 105   &quot;OS&quot;, &quot;PROCESSOR_IDENTIFIER&quot;, &quot;_ALT_JAVA_HOME_DIR&quot;,
 106 
 107   (const char *)0
 108 };
 109 
 110 // A simple parser for -XX:OnError, usage:
 111 //  ptr = OnError;
 112 //  while ((cmd = next_OnError_command(buffer, sizeof(buffer), &amp;ptr) != NULL)
 113 //     ... ...
 114 static char* next_OnError_command(char* buf, int buflen, const char** ptr) {
 115   if (ptr == NULL || *ptr == NULL) return NULL;
 116 
 117   const char* cmd = *ptr;
 118 
 119   // skip leading blanks or &#39;;&#39;
 120   while (*cmd == &#39; &#39; || *cmd == &#39;;&#39;) cmd++;
 121 
 122   if (*cmd == &#39;\0&#39;) return NULL;
 123 
 124   const char * cmdend = cmd;
 125   while (*cmdend != &#39;\0&#39; &amp;&amp; *cmdend != &#39;;&#39;) cmdend++;
 126 
 127   Arguments::copy_expand_pid(cmd, cmdend - cmd, buf, buflen);
 128 
 129   *ptr = (*cmdend == &#39;\0&#39; ? cmdend : cmdend + 1);
 130   return buf;
 131 }
 132 
 133 static void print_bug_submit_message(outputStream *out, Thread *thread) {
 134   if (out == NULL) return;
 135   const char *url = Arguments::java_vendor_url_bug();
 136   if (url == NULL || *url == &#39;\0&#39;)
 137     url = JDK_Version::runtime_vendor_vm_bug_url();
 138   if (url != NULL &amp;&amp; *url != &#39;\0&#39;) {
 139     out-&gt;print_raw_cr(&quot;# If you would like to submit a bug report, please visit:&quot;);
 140     out-&gt;print_raw   (&quot;#   &quot;);
 141     out-&gt;print_raw_cr(url);
 142   }
 143   // If the crash is in native code, encourage user to submit a bug to the
 144   // provider of that code.
 145   if (thread &amp;&amp; thread-&gt;is_Java_thread() &amp;&amp;
 146       !thread-&gt;is_hidden_from_external_view()) {
 147     JavaThread* jt = (JavaThread*)thread;
 148     if (jt-&gt;thread_state() == _thread_in_native) {
 149       out-&gt;print_cr(&quot;# The crash happened outside the Java Virtual Machine in native code.\n# See problematic frame for where to report the bug.&quot;);
 150     }
 151   }
 152   out-&gt;print_raw_cr(&quot;#&quot;);
 153 }
 154 
 155 bool VMError::coredump_status;
 156 char VMError::coredump_message[O_BUFLEN];
 157 
 158 void VMError::record_coredump_status(const char* message, bool status) {
 159   coredump_status = status;
 160   strncpy(coredump_message, message, sizeof(coredump_message));
 161   coredump_message[sizeof(coredump_message)-1] = 0;
 162 }
 163 
 164 // Return a string to describe the error
 165 char* VMError::error_string(char* buf, int buflen) {
 166   char signame_buf[64];
 167   const char *signame = os::exception_name(_id, signame_buf, sizeof(signame_buf));
 168 
 169   if (signame) {
 170     jio_snprintf(buf, buflen,
 171                  &quot;%s (0x%x) at pc=&quot; PTR_FORMAT &quot;, pid=%d, tid=&quot; UINTX_FORMAT,
 172                  signame, _id, _pc,
 173                  os::current_process_id(), os::current_thread_id());
 174   } else if (_filename != NULL &amp;&amp; _lineno &gt; 0) {
 175     // skip directory names
 176     char separator = os::file_separator()[0];
 177     const char *p = strrchr(_filename, separator);
 178     int n = jio_snprintf(buf, buflen,
 179                          &quot;Internal Error at %s:%d, pid=%d, tid=&quot; UINTX_FORMAT,
 180                          p ? p + 1 : _filename, _lineno,
 181                          os::current_process_id(), os::current_thread_id());
 182     if (n &gt;= 0 &amp;&amp; n &lt; buflen &amp;&amp; _message) {
 183       if (strlen(_detail_msg) &gt; 0) {
 184         jio_snprintf(buf + n, buflen - n, &quot;%s%s: %s&quot;,
 185         os::line_separator(), _message, _detail_msg);
 186       } else {
 187         jio_snprintf(buf + n, buflen - n, &quot;%sError: %s&quot;,
 188                      os::line_separator(), _message);
 189       }
 190     }
 191   } else {
 192     jio_snprintf(buf, buflen,
 193                  &quot;Internal Error (0x%x), pid=%d, tid=&quot; UINTX_FORMAT,
 194                  _id, os::current_process_id(), os::current_thread_id());
 195   }
 196 
 197   return buf;
 198 }
 199 
 200 void VMError::print_stack_trace(outputStream* st, JavaThread* jt,
 201                                 char* buf, int buflen, bool verbose) {
 202 #ifdef ZERO
 203   if (jt-&gt;zero_stack()-&gt;sp() &amp;&amp; jt-&gt;top_zero_frame()) {
 204     // StackFrameStream uses the frame anchor, which may not have
 205     // been set up.  This can be done at any time in Zero, however,
 206     // so if it hasn&#39;t been set up then we just set it up now and
 207     // clear it again when we&#39;re done.
 208     bool has_last_Java_frame = jt-&gt;has_last_Java_frame();
 209     if (!has_last_Java_frame)
 210       jt-&gt;set_last_Java_frame();
 211     st-&gt;print(&quot;Java frames:&quot;);
 212     st-&gt;cr();
 213 
 214     // Print the frames
 215     StackFrameStream sfs(jt);
 216     for(int i = 0; !sfs.is_done(); sfs.next(), i++) {
 217       sfs.current()-&gt;zero_print_on_error(i, st, buf, buflen);
 218       st-&gt;cr();
 219     }
 220 
 221     // Reset the frame anchor if necessary
 222     if (!has_last_Java_frame)
 223       jt-&gt;reset_last_Java_frame();
 224   }
 225 #else
 226   if (jt-&gt;has_last_Java_frame()) {
 227     st-&gt;print_cr(&quot;Java frames: (J=compiled Java code, j=interpreted, Vv=VM code)&quot;);
 228     for(StackFrameStream sfs(jt); !sfs.is_done(); sfs.next()) {
 229       sfs.current()-&gt;print_on_error(st, buf, buflen, verbose);
 230       st-&gt;cr();
 231     }
 232   }
 233 #endif // ZERO
 234 }
 235 
 236 void VMError::print_native_stack(outputStream* st, frame fr, Thread* t, char* buf, int buf_size) {
 237 
 238   // see if it&#39;s a valid frame
 239   if (fr.pc()) {
 240     st-&gt;print_cr(&quot;Native frames: (J=compiled Java code, A=aot compiled Java code, j=interpreted, Vv=VM code, C=native code)&quot;);
 241 
 242     int count = 0;
 243     while (count++ &lt; StackPrintLimit) {
 244       fr.print_on_error(st, buf, buf_size);
 245       if (fr.pc()) { // print source file and line, if available
 246         char buf[128];
 247         int line_no;
 248         if (Decoder::get_source_info(fr.pc(), buf, sizeof(buf), &amp;line_no)) {
 249           st-&gt;print(&quot;  (%s:%d)&quot;, buf, line_no);
 250         }
 251       }
 252       st-&gt;cr();
 253       // Compiled code may use EBP register on x86 so it looks like
 254       // non-walkable C frame. Use frame.sender() for java frames.
 255       if (t &amp;&amp; t-&gt;is_Java_thread()) {
 256         // Catch very first native frame by using stack address.
 257         // For JavaThread stack_base and stack_size should be set.
 258         if (!t-&gt;is_in_full_stack((address)(fr.real_fp() + 1))) {
 259           break;
 260         }
 261         if (fr.is_java_frame() || fr.is_native_frame() || fr.is_runtime_frame()) {
 262           RegisterMap map((JavaThread*)t, false); // No update
 263           fr = fr.sender(&amp;map);
 264         } else {
 265           // is_first_C_frame() does only simple checks for frame pointer,
 266           // it will pass if java compiled code has a pointer in EBP.
 267           if (os::is_first_C_frame(&amp;fr)) break;
 268           fr = os::get_sender_for_C_frame(&amp;fr);
 269         }
 270       } else {
 271         if (os::is_first_C_frame(&amp;fr)) break;
 272         fr = os::get_sender_for_C_frame(&amp;fr);
 273       }
 274     }
 275 
 276     if (count &gt; StackPrintLimit) {
 277       st-&gt;print_cr(&quot;...&lt;more frames&gt;...&quot;);
 278     }
 279 
 280     st-&gt;cr();
 281   }
 282 }
 283 
 284 static void print_oom_reasons(outputStream* st) {
 285   st-&gt;print_cr(&quot;# Possible reasons:&quot;);
 286   st-&gt;print_cr(&quot;#   The system is out of physical RAM or swap space&quot;);
 287   if (UseCompressedOops) {
 288     st-&gt;print_cr(&quot;#   The process is running with CompressedOops enabled, and the Java Heap may be blocking the growth of the native heap&quot;);
 289   }
 290   if (LogBytesPerWord == 2) {
 291     st-&gt;print_cr(&quot;#   In 32 bit mode, the process size limit was hit&quot;);
 292   }
 293   st-&gt;print_cr(&quot;# Possible solutions:&quot;);
 294   st-&gt;print_cr(&quot;#   Reduce memory load on the system&quot;);
 295   st-&gt;print_cr(&quot;#   Increase physical memory or swap space&quot;);
 296   st-&gt;print_cr(&quot;#   Check if swap backing store is full&quot;);
 297   if (LogBytesPerWord == 2) {
 298     st-&gt;print_cr(&quot;#   Use 64 bit Java on a 64 bit OS&quot;);
 299   }
 300   st-&gt;print_cr(&quot;#   Decrease Java heap size (-Xmx/-Xms)&quot;);
 301   st-&gt;print_cr(&quot;#   Decrease number of Java threads&quot;);
 302   st-&gt;print_cr(&quot;#   Decrease Java thread stack sizes (-Xss)&quot;);
 303   st-&gt;print_cr(&quot;#   Set larger code cache with -XX:ReservedCodeCacheSize=&quot;);
 304   if (UseCompressedOops) {
 305     switch (CompressedOops::mode()) {
 306       case CompressedOops::UnscaledNarrowOop:
 307         st-&gt;print_cr(&quot;#   JVM is running with Unscaled Compressed Oops mode in which the Java heap is&quot;);
 308         st-&gt;print_cr(&quot;#     placed in the first 4GB address space. The Java Heap base address is the&quot;);
 309         st-&gt;print_cr(&quot;#     maximum limit for the native heap growth. Please use -XX:HeapBaseMinAddress&quot;);
 310         st-&gt;print_cr(&quot;#     to set the Java Heap base and to place the Java Heap above 4GB virtual address.&quot;);
 311         break;
 312       case CompressedOops::ZeroBasedNarrowOop:
 313         st-&gt;print_cr(&quot;#   JVM is running with Zero Based Compressed Oops mode in which the Java heap is&quot;);
 314         st-&gt;print_cr(&quot;#     placed in the first 32GB address space. The Java Heap base address is the&quot;);
 315         st-&gt;print_cr(&quot;#     maximum limit for the native heap growth. Please use -XX:HeapBaseMinAddress&quot;);
 316         st-&gt;print_cr(&quot;#     to set the Java Heap base and to place the Java Heap above 32GB virtual address.&quot;);
 317         break;
 318       default:
 319         break;
 320     }
 321   }
 322   st-&gt;print_cr(&quot;# This output file may be truncated or incomplete.&quot;);
 323 }
 324 
 325 static void report_vm_version(outputStream* st, char* buf, int buflen) {
 326    // VM version
 327    st-&gt;print_cr(&quot;#&quot;);
 328    JDK_Version::current().to_string(buf, buflen);
 329    const char* runtime_name = JDK_Version::runtime_name() != NULL ?
 330                                 JDK_Version::runtime_name() : &quot;&quot;;
 331    const char* runtime_version = JDK_Version::runtime_version() != NULL ?
 332                                    JDK_Version::runtime_version() : &quot;&quot;;
 333    const char* vendor_version = JDK_Version::runtime_vendor_version() != NULL ?
 334                                   JDK_Version::runtime_vendor_version() : &quot;&quot;;
 335    const char* jdk_debug_level = VM_Version::printable_jdk_debug_level() != NULL ?
 336                                    VM_Version::printable_jdk_debug_level() : &quot;&quot;;
 337 
 338    st-&gt;print_cr(&quot;# JRE version: %s%s%s (%s) (%sbuild %s)&quot;, runtime_name,
 339                 (*vendor_version != &#39;\0&#39;) ? &quot; &quot; : &quot;&quot;, vendor_version,
 340                 buf, jdk_debug_level, runtime_version);
 341 
 342    // This is the long version with some default settings added
 343    st-&gt;print_cr(&quot;# Java VM: %s%s%s (%s%s, %s%s%s%s%s, %s, %s)&quot;,
 344                  VM_Version::vm_name(),
 345                 (*vendor_version != &#39;\0&#39;) ? &quot; &quot; : &quot;&quot;, vendor_version,
 346                  jdk_debug_level,
 347                  VM_Version::vm_release(),
 348                  VM_Version::vm_info_string(),
 349                  TieredCompilation ? &quot;, tiered&quot; : &quot;&quot;,
 350 #if INCLUDE_JVMCI
 351                  EnableJVMCI ? &quot;, jvmci&quot; : &quot;&quot;,
 352                  UseJVMCICompiler ? &quot;, jvmci compiler&quot; : &quot;&quot;,
 353 #else
 354                  &quot;&quot;, &quot;&quot;,
 355 #endif
 356                  UseCompressedOops ? &quot;, compressed oops&quot; : &quot;&quot;,
 357                  GCConfig::hs_err_name(),
 358                  VM_Version::vm_platform_string()
 359                );
 360 }
 361 
 362 // This is the main function to report a fatal error. Only one thread can
 363 // call this function, so we don&#39;t need to worry about MT-safety. But it&#39;s
 364 // possible that the error handler itself may crash or die on an internal
 365 // error, for example, when the stack/heap is badly damaged. We must be
 366 // able to handle recursive errors that happen inside error handler.
 367 //
 368 // Error reporting is done in several steps. If a crash or internal error
 369 // occurred when reporting an error, the nested signal/exception handler
 370 // can skip steps that are already (or partially) done. Error reporting will
 371 // continue from the next step. This allows us to retrieve and print
 372 // information that may be unsafe to get after a fatal error. If it happens,
 373 // you may find nested report_and_die() frames when you look at the stack
 374 // in a debugger.
 375 //
 376 // In general, a hang in error handler is much worse than a crash or internal
 377 // error, as it&#39;s harder to recover from a hang. Deadlock can happen if we
 378 // try to grab a lock that is already owned by current thread, or if the
 379 // owner is blocked forever (e.g. in os::infinite_sleep()). If possible, the
 380 // error handler and all the functions it called should avoid grabbing any
 381 // lock. An important thing to notice is that memory allocation needs a lock.
 382 //
 383 // We should avoid using large stack allocated buffers. Many errors happen
 384 // when stack space is already low. Making things even worse is that there
 385 // could be nested report_and_die() calls on stack (see above). Only one
 386 // thread can report error, so large buffers are statically allocated in data
 387 // segment.
 388 
 389 int          VMError::_current_step;
 390 const char*  VMError::_current_step_info;
 391 
 392 volatile jlong VMError::_reporting_start_time = -1;
 393 volatile bool VMError::_reporting_did_timeout = false;
 394 volatile jlong VMError::_step_start_time = -1;
 395 volatile bool VMError::_step_did_timeout = false;
 396 
 397 // Helper, return current timestamp for timeout handling.
 398 jlong VMError::get_current_timestamp() {
 399   return os::javaTimeNanos();
 400 }
 401 // Factor to translate the timestamp to seconds.
 402 #define TIMESTAMP_TO_SECONDS_FACTOR (1000 * 1000 * 1000)
 403 
 404 void VMError::record_reporting_start_time() {
 405   const jlong now = get_current_timestamp();
 406   Atomic::store(&amp;_reporting_start_time, now);
 407 }
 408 
 409 jlong VMError::get_reporting_start_time() {
 410   return Atomic::load(&amp;_reporting_start_time);
 411 }
 412 
 413 void VMError::record_step_start_time() {
 414   const jlong now = get_current_timestamp();
 415   Atomic::store(&amp;_step_start_time, now);
 416 }
 417 
 418 jlong VMError::get_step_start_time() {
 419   return Atomic::load(&amp;_step_start_time);
 420 }
 421 
 422 void VMError::clear_step_start_time() {
 423   return Atomic::store(&amp;_step_start_time, (jlong)0);
 424 }
 425 
 426 void VMError::report(outputStream* st, bool _verbose) {
 427 
 428 # define BEGIN if (_current_step == 0) { _current_step = __LINE__;
 429 # define STEP(s) } if (_current_step &lt; __LINE__) { _current_step = __LINE__; _current_step_info = s; \
 430   record_step_start_time(); _step_did_timeout = false;
 431 # define END clear_step_start_time(); }
 432 
 433   // don&#39;t allocate large buffer on stack
 434   static char buf[O_BUFLEN];
 435 
 436   BEGIN
 437 
 438   STEP(&quot;printing fatal error message&quot;)
 439 
 440     st-&gt;print_cr(&quot;#&quot;);
 441     if (should_report_bug(_id)) {
 442       st-&gt;print_cr(&quot;# A fatal error has been detected by the Java Runtime Environment:&quot;);
 443     } else {
 444       st-&gt;print_cr(&quot;# There is insufficient memory for the Java &quot;
 445                    &quot;Runtime Environment to continue.&quot;);
 446     }
 447 
 448 #ifndef PRODUCT
 449   // Error handler self tests
 450 
 451   // test secondary error handling. Test it twice, to test that resetting
 452   // error handler after a secondary crash works.
 453   STEP(&quot;test secondary crash 1&quot;)
 454     if (_verbose &amp;&amp; TestCrashInErrorHandler != 0) {
 455       st-&gt;print_cr(&quot;Will crash now (TestCrashInErrorHandler=&quot; UINTX_FORMAT &quot;)...&quot;,
 456         TestCrashInErrorHandler);
 457       controlled_crash(TestCrashInErrorHandler);
 458     }
 459 
 460   STEP(&quot;test secondary crash 2&quot;)
 461     if (_verbose &amp;&amp; TestCrashInErrorHandler != 0) {
 462       st-&gt;print_cr(&quot;Will crash now (TestCrashInErrorHandler=&quot; UINTX_FORMAT &quot;)...&quot;,
 463         TestCrashInErrorHandler);
 464       controlled_crash(TestCrashInErrorHandler);
 465     }
 466 
 467   // TestUnresponsiveErrorHandler: We want to test both step timeouts and global timeout.
 468   // Step to global timeout ratio is 4:1, so in order to be absolutely sure we hit the
 469   // global timeout, let&#39;s execute the timeout step five times.
 470   // See corresponding test in test/runtime/ErrorHandling/TimeoutInErrorHandlingTest.java
 471   STEP(&quot;setup for test unresponsive error reporting step&quot;)
 472     if (_verbose &amp;&amp; TestUnresponsiveErrorHandler) {
 473       // We record reporting_start_time for this test here because we
 474       // care about the time spent executing TIMEOUT_TEST_STEP and not
 475       // about the time it took us to get here.
 476       tty-&gt;print_cr(&quot;Recording reporting_start_time for TestUnresponsiveErrorHandler.&quot;);
 477       record_reporting_start_time();
 478     }
 479 
 480   #define TIMEOUT_TEST_STEP STEP(&quot;test unresponsive error reporting step&quot;) \
 481     if (_verbose &amp;&amp; TestUnresponsiveErrorHandler) { os::infinite_sleep(); }
 482   TIMEOUT_TEST_STEP
 483   TIMEOUT_TEST_STEP
 484   TIMEOUT_TEST_STEP
 485   TIMEOUT_TEST_STEP
 486   TIMEOUT_TEST_STEP
 487 
 488   STEP(&quot;test safefetch in error handler&quot;)
 489     // test whether it is safe to use SafeFetch32 in Crash Handler. Test twice
 490     // to test that resetting the signal handler works correctly.
 491     if (_verbose &amp;&amp; TestSafeFetchInErrorHandler) {
 492       st-&gt;print_cr(&quot;Will test SafeFetch...&quot;);
 493       if (CanUseSafeFetch32()) {
 494         int* const invalid_pointer = (int*) get_segfault_address();
 495         const int x = 0x76543210;
 496         int i1 = SafeFetch32(invalid_pointer, x);
 497         int i2 = SafeFetch32(invalid_pointer, x);
 498         if (i1 == x &amp;&amp; i2 == x) {
 499           st-&gt;print_cr(&quot;SafeFetch OK.&quot;); // Correctly deflected and returned default pattern
 500         } else {
 501           st-&gt;print_cr(&quot;??&quot;);
 502         }
 503       } else {
 504         st-&gt;print_cr(&quot;not possible; skipped.&quot;);
 505       }
 506     }
 507 #endif // PRODUCT
 508 
 509   STEP(&quot;printing type of error&quot;)
 510 
 511      switch(static_cast&lt;unsigned int&gt;(_id)) {
 512        case OOM_MALLOC_ERROR:
 513        case OOM_MMAP_ERROR:
 514          if (_size) {
 515            st-&gt;print(&quot;# Native memory allocation &quot;);
 516            st-&gt;print((_id == (int)OOM_MALLOC_ERROR) ? &quot;(malloc) failed to allocate &quot; :
 517                                                  &quot;(mmap) failed to map &quot;);
 518            jio_snprintf(buf, sizeof(buf), SIZE_FORMAT, _size);
 519            st-&gt;print(&quot;%s&quot;, buf);
 520            st-&gt;print(&quot; bytes&quot;);
 521            if (strlen(_detail_msg) &gt; 0) {
 522              st-&gt;print(&quot; for &quot;);
 523              st-&gt;print(&quot;%s&quot;, _detail_msg);
 524            }
 525            st-&gt;cr();
 526          } else {
 527            if (strlen(_detail_msg) &gt; 0) {
 528              st-&gt;print(&quot;# &quot;);
 529              st-&gt;print_cr(&quot;%s&quot;, _detail_msg);
 530            }
 531          }
 532          // In error file give some solutions
 533          if (_verbose) {
 534            print_oom_reasons(st);
 535          } else {
 536            return;  // that&#39;s enough for the screen
 537          }
 538          break;
 539        case INTERNAL_ERROR:
 540        default:
 541          break;
 542      }
 543 
 544   STEP(&quot;printing exception/signal name&quot;)
 545 
 546      st-&gt;print_cr(&quot;#&quot;);
 547      st-&gt;print(&quot;#  &quot;);
 548      // Is it an OS exception/signal?
 549      if (os::exception_name(_id, buf, sizeof(buf))) {
 550        st-&gt;print(&quot;%s&quot;, buf);
 551        st-&gt;print(&quot; (0x%x)&quot;, _id);                // signal number
 552        st-&gt;print(&quot; at pc=&quot; PTR_FORMAT, p2i(_pc));
 553        if (_siginfo != NULL &amp;&amp; os::signal_sent_by_kill(_siginfo)) {
 554          st-&gt;print(&quot; (sent by kill)&quot;);
 555        }
 556      } else {
 557        if (should_report_bug(_id)) {
 558          st-&gt;print(&quot;Internal Error&quot;);
 559        } else {
 560          st-&gt;print(&quot;Out of Memory Error&quot;);
 561        }
 562        if (_filename != NULL &amp;&amp; _lineno &gt; 0) {
 563 #ifdef PRODUCT
 564          // In product mode chop off pathname?
 565          char separator = os::file_separator()[0];
 566          const char *p = strrchr(_filename, separator);
 567          const char *file = p ? p+1 : _filename;
 568 #else
 569          const char *file = _filename;
 570 #endif
 571          st-&gt;print(&quot; (%s:%d)&quot;, file, _lineno);
 572        } else {
 573          st-&gt;print(&quot; (0x%x)&quot;, _id);
 574        }
 575      }
 576 
 577   STEP(&quot;printing current thread and pid&quot;)
 578 
 579      // process id, thread id
 580      st-&gt;print(&quot;, pid=%d&quot;, os::current_process_id());
 581      st-&gt;print(&quot;, tid=&quot; UINTX_FORMAT, os::current_thread_id());
 582      st-&gt;cr();
 583 
 584   STEP(&quot;printing error message&quot;)
 585 
 586      if (should_report_bug(_id)) {  // already printed the message.
 587        // error message
 588        if (strlen(_detail_msg) &gt; 0) {
 589          st-&gt;print_cr(&quot;#  %s: %s&quot;, _message ? _message : &quot;Error&quot;, _detail_msg);
 590        } else if (_message) {
 591          st-&gt;print_cr(&quot;#  Error: %s&quot;, _message);
 592        }
 593      }
 594 
 595   STEP(&quot;printing Java version string&quot;)
 596 
 597      report_vm_version(st, buf, sizeof(buf));
 598 
 599   STEP(&quot;printing problematic frame&quot;)
 600 
 601      // Print current frame if we have a context (i.e. it&#39;s a crash)
 602      if (_context) {
 603        st-&gt;print_cr(&quot;# Problematic frame:&quot;);
 604        st-&gt;print(&quot;# &quot;);
 605        frame fr = os::fetch_frame_from_context(_context);
 606        fr.print_on_error(st, buf, sizeof(buf));
 607        st-&gt;cr();
 608        st-&gt;print_cr(&quot;#&quot;);
 609      }
 610 
 611   STEP(&quot;printing core file information&quot;)
 612     st-&gt;print(&quot;# &quot;);
 613     if (CreateCoredumpOnCrash) {
 614       if (coredump_status) {
 615         st-&gt;print(&quot;Core dump will be written. Default location: %s&quot;, coredump_message);
 616       } else {
 617         st-&gt;print(&quot;No core dump will be written. %s&quot;, coredump_message);
 618       }
 619     } else {
 620       st-&gt;print(&quot;CreateCoredumpOnCrash turned off, no core file dumped&quot;);
 621     }
 622     st-&gt;cr();
 623     st-&gt;print_cr(&quot;#&quot;);
 624 
 625   JFR_ONLY(STEP(&quot;printing jfr information&quot;))
 626   JFR_ONLY(Jfr::on_vm_error_report(st);)
 627 
 628   STEP(&quot;printing bug submit message&quot;)
 629 
 630      if (should_report_bug(_id) &amp;&amp; _verbose) {
 631        print_bug_submit_message(st, _thread);
 632      }
 633 
 634   STEP(&quot;printing summary&quot;)
 635 
 636      if (_verbose) {
 637        st-&gt;cr();
 638        st-&gt;print_cr(&quot;---------------  S U M M A R Y ------------&quot;);
 639        st-&gt;cr();
 640      }
 641 
 642   STEP(&quot;printing VM option summary&quot;)
 643 
 644      if (_verbose) {
 645        // VM options
 646        Arguments::print_summary_on(st);
 647        st-&gt;cr();
 648      }
 649 
 650   STEP(&quot;printing summary machine and OS info&quot;)
 651 
 652      if (_verbose) {
 653        os::print_summary_info(st, buf, sizeof(buf));
 654      }
 655 
 656 
 657   STEP(&quot;printing date and time&quot;)
 658 
 659      if (_verbose) {
 660        os::print_date_and_time(st, buf, sizeof(buf));
 661      }
 662 
 663   STEP(&quot;printing thread&quot;)
 664 
 665      if (_verbose) {
 666        st-&gt;cr();
 667        st-&gt;print_cr(&quot;---------------  T H R E A D  ---------------&quot;);
 668        st-&gt;cr();
 669      }
 670 
 671   STEP(&quot;printing current thread&quot;)
 672 
 673      // current thread
 674      if (_verbose) {
 675        if (_thread) {
 676          st-&gt;print(&quot;Current thread (&quot; PTR_FORMAT &quot;):  &quot;, p2i(_thread));
 677          _thread-&gt;print_on_error(st, buf, sizeof(buf));
 678          st-&gt;cr();
 679        } else {
 680          st-&gt;print_cr(&quot;Current thread is native thread&quot;);
 681        }
 682        st-&gt;cr();
 683      }
 684 
 685   STEP(&quot;printing current compile task&quot;)
 686 
 687      if (_verbose &amp;&amp; _thread &amp;&amp; _thread-&gt;is_Compiler_thread()) {
 688         CompilerThread* t = (CompilerThread*)_thread;
 689         if (t-&gt;task()) {
 690            st-&gt;cr();
 691            st-&gt;print_cr(&quot;Current CompileTask:&quot;);
 692            t-&gt;task()-&gt;print_line_on_error(st, buf, sizeof(buf));
 693            st-&gt;cr();
 694         }
 695      }
 696 
 697 
 698   STEP(&quot;printing stack bounds&quot;)
 699 
 700      if (_verbose) {
 701        st-&gt;print(&quot;Stack: &quot;);
 702 
 703        address stack_top;
 704        size_t stack_size;
 705 
 706        if (_thread) {
 707           stack_top = _thread-&gt;stack_base();
 708           stack_size = _thread-&gt;stack_size();
 709        } else {
 710           stack_top = os::current_stack_base();
 711           stack_size = os::current_stack_size();
 712        }
 713 
 714        address stack_bottom = stack_top - stack_size;
 715        st-&gt;print(&quot;[&quot; PTR_FORMAT &quot;,&quot; PTR_FORMAT &quot;]&quot;, p2i(stack_bottom), p2i(stack_top));
 716 
 717        frame fr = _context ? os::fetch_frame_from_context(_context)
 718                            : os::current_frame();
 719 
 720        if (fr.sp()) {
 721          st-&gt;print(&quot;,  sp=&quot; PTR_FORMAT, p2i(fr.sp()));
 722          size_t free_stack_size = pointer_delta(fr.sp(), stack_bottom, 1024);
 723          st-&gt;print(&quot;,  free space=&quot; SIZE_FORMAT &quot;k&quot;, free_stack_size);
 724        }
 725 
 726        st-&gt;cr();
 727      }
 728 
 729   STEP(&quot;printing native stack&quot;)
 730 
 731    if (_verbose) {
 732      if (os::platform_print_native_stack(st, _context, buf, sizeof(buf))) {
 733        // We have printed the native stack in platform-specific code
 734        // Windows/x64 needs special handling.
 735      } else {
 736        frame fr = _context ? os::fetch_frame_from_context(_context)
 737                            : os::current_frame();
 738 
 739        print_native_stack(st, fr, _thread, buf, sizeof(buf));
 740      }
 741    }
 742 
 743   STEP(&quot;printing Java stack&quot;)
 744 
 745      if (_verbose &amp;&amp; _thread &amp;&amp; _thread-&gt;is_Java_thread()) {
 746        print_stack_trace(st, (JavaThread*)_thread, buf, sizeof(buf));
 747      }
 748 
 749   STEP(&quot;printing target Java thread stack&quot;)
 750 
 751      // printing Java thread stack trace if it is involved in GC crash
 752      if (_verbose &amp;&amp; _thread &amp;&amp; (_thread-&gt;is_Named_thread())) {
 753        JavaThread*  jt = ((NamedThread *)_thread)-&gt;processed_thread();
 754        if (jt != NULL) {
 755          st-&gt;print_cr(&quot;JavaThread &quot; PTR_FORMAT &quot; (nid = %d) was being processed&quot;, p2i(jt), jt-&gt;osthread()-&gt;thread_id());
 756          print_stack_trace(st, jt, buf, sizeof(buf), true);
 757        }
 758      }
 759 
 760   STEP(&quot;printing siginfo&quot;)
 761 
 762      // signal no, signal code, address that caused the fault
 763      if (_verbose &amp;&amp; _siginfo) {
 764        st-&gt;cr();
 765        os::print_siginfo(st, _siginfo);
 766        st-&gt;cr();
 767      }
 768 
 769   STEP(&quot;CDS archive access warning&quot;)
 770 
 771      // Print an explicit hint if we crashed on access to the CDS archive.
 772      if (_verbose &amp;&amp; _siginfo) {
 773        check_failing_cds_access(st, _siginfo);
 774        st-&gt;cr();
 775      }
 776 
 777   STEP(&quot;printing register info&quot;)
 778 
 779      // decode register contents if possible
<a name="2" id="anc2"></a><span class="line-modified"> 780      if (_verbose &amp;&amp; _context &amp;&amp; _thread &amp;&amp; Universe::is_fully_initialized()) {</span>
<span class="line-added"> 781        ResourceMark rm(_thread);</span>
 782        os::print_register_info(st, _context);
 783        st-&gt;cr();
 784      }
 785 
 786   STEP(&quot;printing registers, top of stack, instructions near pc&quot;)
 787 
 788      // registers, top of stack, instructions near pc
 789      if (_verbose &amp;&amp; _context) {
 790        os::print_context(st, _context);
 791        st-&gt;cr();
 792      }
 793 
 794   STEP(&quot;inspecting top of stack&quot;)
 795 
 796      // decode stack contents if possible
<a name="3" id="anc3"></a><span class="line-modified"> 797      if (_verbose &amp;&amp; _context &amp;&amp; _thread &amp;&amp; Universe::is_fully_initialized()) {</span>
 798        frame fr = os::fetch_frame_from_context(_context);
 799        const int slots = 8;
 800        const intptr_t *start = fr.sp();
 801        const intptr_t *end = start + slots;
 802        if (is_aligned(start, sizeof(intptr_t)) &amp;&amp; os::is_readable_range(start, end)) {
 803          st-&gt;print_cr(&quot;Stack slot to memory mapping:&quot;);
 804          for (int i = 0; i &lt; slots; ++i) {
 805            st-&gt;print(&quot;stack at sp + %d slots: &quot;, i);
<a name="4" id="anc4"></a><span class="line-added"> 806            ResourceMark rm(_thread);</span>
 807            os::print_location(st, *(start + i));
 808          }
 809        }
 810        st-&gt;cr();
 811      }
 812 
 813   STEP(&quot;printing code blob if possible&quot;)
 814 
 815      if (_verbose &amp;&amp; _context) {
 816        CodeBlob* cb = CodeCache::find_blob(_pc);
 817        if (cb != NULL) {
 818          if (Interpreter::contains(_pc)) {
 819            // The interpreter CodeBlob is very large so try to print the codelet instead.
 820            InterpreterCodelet* codelet = Interpreter::codelet_containing(_pc);
 821            if (codelet != NULL) {
 822              codelet-&gt;print_on(st);
 823              Disassembler::decode(codelet-&gt;code_begin(), codelet-&gt;code_end(), st);
 824            }
 825          } else {
 826            StubCodeDesc* desc = StubCodeDesc::desc_for(_pc);
 827            if (desc != NULL) {
 828              desc-&gt;print_on(st);
 829              Disassembler::decode(desc-&gt;begin(), desc-&gt;end(), st);
 830            } else if (_thread != NULL) {
 831              // Disassembling nmethod will incur resource memory allocation,
 832              // only do so when thread is valid.
 833              ResourceMark rm(_thread);
 834              Disassembler::decode(cb, st);
 835              st-&gt;cr();
 836            }
 837          }
 838        }
 839      }
 840 
 841   STEP(&quot;printing VM operation&quot;)
 842 
 843      if (_verbose &amp;&amp; _thread &amp;&amp; _thread-&gt;is_VM_thread()) {
 844         VMThread* t = (VMThread*)_thread;
 845         VM_Operation* op = t-&gt;vm_operation();
 846         if (op) {
 847           op-&gt;print_on_error(st);
 848           st-&gt;cr();
 849           st-&gt;cr();
 850         }
 851      }
 852 
 853   STEP(&quot;printing process&quot;)
 854 
 855      if (_verbose) {
 856        st-&gt;cr();
 857        st-&gt;print_cr(&quot;---------------  P R O C E S S  ---------------&quot;);
 858        st-&gt;cr();
 859      }
 860 
 861 #ifndef _WIN32
 862   STEP(&quot;printing user info&quot;)
 863 
 864      if (ExtensiveErrorReports &amp;&amp; _verbose) {
 865        os::Posix::print_user_info(st);
 866      }
 867 #endif
 868 
 869   STEP(&quot;printing all threads&quot;)
 870 
 871      // all threads
 872      if (_verbose &amp;&amp; _thread) {
 873        Threads::print_on_error(st, _thread, buf, sizeof(buf));
 874        st-&gt;cr();
 875      }
 876 
 877   STEP(&quot;printing VM state&quot;)
 878 
 879      if (_verbose) {
 880        // Safepoint state
 881        st-&gt;print(&quot;VM state:&quot;);
 882 
 883        if (SafepointSynchronize::is_synchronizing()) st-&gt;print(&quot;synchronizing&quot;);
 884        else if (SafepointSynchronize::is_at_safepoint()) st-&gt;print(&quot;at safepoint&quot;);
 885        else st-&gt;print(&quot;not at safepoint&quot;);
 886 
 887        // Also see if error occurred during initialization or shutdown
 888        if (!Universe::is_fully_initialized()) {
 889          st-&gt;print(&quot; (not fully initialized)&quot;);
 890        } else if (VM_Exit::vm_exited()) {
 891          st-&gt;print(&quot; (shutting down)&quot;);
 892        } else {
 893          st-&gt;print(&quot; (normal execution)&quot;);
 894        }
 895        st-&gt;cr();
 896        st-&gt;cr();
 897      }
 898 
 899   STEP(&quot;printing owned locks on error&quot;)
 900 
 901      // mutexes/monitors that currently have an owner
 902      if (_verbose) {
 903        print_owned_locks_on_error(st);
 904        st-&gt;cr();
 905      }
 906 
 907   STEP(&quot;printing number of OutOfMemoryError and StackOverflow exceptions&quot;)
 908 
 909      if (_verbose &amp;&amp; Exceptions::has_exception_counts()) {
 910        st-&gt;print_cr(&quot;OutOfMemory and StackOverflow Exception counts:&quot;);
 911        Exceptions::print_exception_counts_on_error(st);
 912        st-&gt;cr();
 913      }
 914 
 915 #ifdef _LP64
 916   STEP(&quot;printing compressed oops mode&quot;)
 917 
 918      if (_verbose &amp;&amp; UseCompressedOops) {
 919        CompressedOops::print_mode(st);
 920        if (UseCompressedClassPointers) {
 921          CDS_ONLY(MetaspaceShared::print_on(st);)
 922          Metaspace::print_compressed_class_space(st);
 923          CompressedKlassPointers::print_mode(st);
 924        }
 925        st-&gt;cr();
 926      }
 927 #endif
 928 
 929   STEP(&quot;printing heap information&quot;)
 930 
<a name="5" id="anc5"></a><span class="line-modified"> 931      if (_verbose) {</span>
<span class="line-modified"> 932        GCLogPrecious::print_on_error(st);</span>
<span class="line-modified"> 933 </span>
<span class="line-modified"> 934        if (Universe::heap() != NULL) {</span>
<span class="line-modified"> 935          Universe::heap()-&gt;print_on_error(st);</span>
<span class="line-added"> 936          st-&gt;cr();</span>
<span class="line-added"> 937        }</span>
<span class="line-added"> 938 </span>
<span class="line-added"> 939        if (Universe::is_fully_initialized()) {</span>
<span class="line-added"> 940          st-&gt;print_cr(&quot;Polling page: &quot; INTPTR_FORMAT, p2i(SafepointMechanism::get_polling_page()));</span>
<span class="line-added"> 941          st-&gt;cr();</span>
<span class="line-added"> 942        }</span>
 943      }
 944 
 945   STEP(&quot;printing metaspace information&quot;)
 946 
 947      if (_verbose &amp;&amp; Universe::is_fully_initialized()) {
 948        st-&gt;print_cr(&quot;Metaspace:&quot;);
 949        MetaspaceUtils::print_basic_report(st, 0);
 950      }
 951 
 952   STEP(&quot;printing code cache information&quot;)
 953 
 954      if (_verbose &amp;&amp; Universe::is_fully_initialized()) {
 955        // print code cache information before vm abort
 956        CodeCache::print_summary(st);
 957        st-&gt;cr();
 958      }
 959 
 960   STEP(&quot;printing ring buffers&quot;)
 961 
 962      if (_verbose) {
 963        Events::print_all(st);
 964        st-&gt;cr();
 965      }
 966 
 967   STEP(&quot;printing dynamic libraries&quot;)
 968 
 969      if (_verbose) {
 970        // dynamic libraries, or memory map
 971        os::print_dll_info(st);
 972        st-&gt;cr();
 973      }
 974 
 975   STEP(&quot;printing native decoder state&quot;)
 976 
 977      if (_verbose) {
 978        Decoder::print_state_on(st);
 979        st-&gt;cr();
 980      }
 981 
 982   STEP(&quot;printing VM options&quot;)
 983 
 984      if (_verbose) {
 985        // VM options
 986        Arguments::print_on(st);
 987        st-&gt;cr();
 988      }
 989 
 990   STEP(&quot;printing flags&quot;)
 991 
 992     if (_verbose) {
 993       JVMFlag::printFlags(
 994         st,
 995         true, // with comments
 996         false, // no ranges
 997         true); // skip defaults
 998       st-&gt;cr();
 999     }
1000 
1001   STEP(&quot;printing warning if internal testing API used&quot;)
1002 
1003      if (WhiteBox::used()) {
1004        st-&gt;print_cr(&quot;Unsupported internal testing APIs have been used.&quot;);
1005        st-&gt;cr();
1006      }
1007 
1008   STEP(&quot;printing log configuration&quot;)
1009     if (_verbose){
1010       st-&gt;print_cr(&quot;Logging:&quot;);
1011       LogConfiguration::describe_current_configuration(st);
1012       st-&gt;cr();
1013     }
1014 
1015   STEP(&quot;printing all environment variables&quot;)
1016 
1017      if (_verbose) {
1018        os::print_environment_variables(st, env_list);
1019        st-&gt;cr();
1020      }
1021 
1022   STEP(&quot;printing signal handlers&quot;)
1023 
1024      if (_verbose) {
1025        os::print_signal_handlers(st, buf, sizeof(buf));
1026        st-&gt;cr();
1027      }
1028 
1029   STEP(&quot;Native Memory Tracking&quot;)
1030      if (_verbose) {
1031        MemTracker::error_report(st);
1032      }
1033 
1034   STEP(&quot;printing system&quot;)
1035 
1036      if (_verbose) {
1037        st-&gt;cr();
1038        st-&gt;print_cr(&quot;---------------  S Y S T E M  ---------------&quot;);
1039        st-&gt;cr();
1040      }
1041 
1042   STEP(&quot;printing OS information&quot;)
1043 
1044      if (_verbose) {
1045        os::print_os_info(st);
1046        st-&gt;cr();
1047      }
1048 
1049   STEP(&quot;printing CPU info&quot;)
1050      if (_verbose) {
1051        os::print_cpu_info(st, buf, sizeof(buf));
1052        st-&gt;cr();
1053      }
1054 
1055   STEP(&quot;printing memory info&quot;)
1056 
1057      if (_verbose) {
1058        os::print_memory_info(st);
1059        st-&gt;cr();
1060      }
1061 
1062   STEP(&quot;printing internal vm info&quot;)
1063 
1064      if (_verbose) {
1065        st-&gt;print_cr(&quot;vm_info: %s&quot;, VM_Version::internal_vm_info_string());
1066        st-&gt;cr();
1067      }
1068 
1069   // print a defined marker to show that error handling finished correctly.
1070   STEP(&quot;printing end marker&quot;)
1071 
1072      if (_verbose) {
1073        st-&gt;print_cr(&quot;END.&quot;);
1074      }
1075 
1076   END
1077 
1078 # undef BEGIN
1079 # undef STEP
1080 # undef END
1081 }
1082 
1083 // Report for the vm_info_cmd. This prints out the information above omitting
1084 // crash and thread specific information.  If output is added above, it should be added
1085 // here also, if it is safe to call during a running process.
1086 void VMError::print_vm_info(outputStream* st) {
1087 
1088   char buf[O_BUFLEN];
1089   report_vm_version(st, buf, sizeof(buf));
1090 
1091   // STEP(&quot;printing summary&quot;)
1092 
1093   st-&gt;cr();
1094   st-&gt;print_cr(&quot;---------------  S U M M A R Y ------------&quot;);
1095   st-&gt;cr();
1096 
1097   // STEP(&quot;printing VM option summary&quot;)
1098 
1099   // VM options
1100   Arguments::print_summary_on(st);
1101   st-&gt;cr();
1102 
1103   // STEP(&quot;printing summary machine and OS info&quot;)
1104 
1105   os::print_summary_info(st, buf, sizeof(buf));
1106 
1107   // STEP(&quot;printing date and time&quot;)
1108 
1109   os::print_date_and_time(st, buf, sizeof(buf));
1110 
1111   // Skip: STEP(&quot;printing thread&quot;)
1112 
1113   // STEP(&quot;printing process&quot;)
1114 
1115   st-&gt;cr();
1116   st-&gt;print_cr(&quot;---------------  P R O C E S S  ---------------&quot;);
1117   st-&gt;cr();
1118 
1119   // STEP(&quot;printing number of OutOfMemoryError and StackOverflow exceptions&quot;)
1120 
1121   if (Exceptions::has_exception_counts()) {
1122     st-&gt;print_cr(&quot;OutOfMemory and StackOverflow Exception counts:&quot;);
1123     Exceptions::print_exception_counts_on_error(st);
1124     st-&gt;cr();
1125   }
1126 
1127 #ifdef _LP64
1128   // STEP(&quot;printing compressed oops mode&quot;)
1129   if (UseCompressedOops) {
1130     CompressedOops::print_mode(st);
1131     if (UseCompressedClassPointers) {
1132       CDS_ONLY(MetaspaceShared::print_on(st);)
1133       Metaspace::print_compressed_class_space(st);
1134       CompressedKlassPointers::print_mode(st);
1135     }
1136     st-&gt;cr();
1137   }
1138 #endif
1139 
1140   // STEP(&quot;printing heap information&quot;)
1141 
1142   if (Universe::is_fully_initialized()) {
1143     MutexLocker hl(Heap_lock);
<a name="6" id="anc6"></a><span class="line-added">1144     GCLogPrecious::print_on_error(st);</span>
1145     Universe::heap()-&gt;print_on_error(st);
1146     st-&gt;cr();
1147     st-&gt;print_cr(&quot;Polling page: &quot; INTPTR_FORMAT, p2i(SafepointMechanism::get_polling_page()));
1148     st-&gt;cr();
1149   }
1150 
1151   // STEP(&quot;printing metaspace information&quot;)
1152 
1153   if (Universe::is_fully_initialized()) {
1154     st-&gt;print_cr(&quot;Metaspace:&quot;);
1155     MetaspaceUtils::print_basic_report(st, 0);
1156   }
1157 
1158   // STEP(&quot;printing code cache information&quot;)
1159 
1160   if (Universe::is_fully_initialized()) {
1161     // print code cache information before vm abort
1162     CodeCache::print_summary(st);
1163     st-&gt;cr();
1164   }
1165 
1166   // STEP(&quot;printing ring buffers&quot;)
1167 
1168   Events::print_all(st);
1169   st-&gt;cr();
1170 
1171   // STEP(&quot;printing dynamic libraries&quot;)
1172 
1173   // dynamic libraries, or memory map
1174   os::print_dll_info(st);
1175   st-&gt;cr();
1176 
1177   // STEP(&quot;printing VM options&quot;)
1178 
1179   // VM options
1180   Arguments::print_on(st);
1181   st-&gt;cr();
1182 
1183   // STEP(&quot;printing warning if internal testing API used&quot;)
1184 
1185   if (WhiteBox::used()) {
1186     st-&gt;print_cr(&quot;Unsupported internal testing APIs have been used.&quot;);
1187     st-&gt;cr();
1188   }
1189 
1190   // STEP(&quot;printing log configuration&quot;)
1191   st-&gt;print_cr(&quot;Logging:&quot;);
1192   LogConfiguration::describe(st);
1193   st-&gt;cr();
1194 
1195   // STEP(&quot;printing all environment variables&quot;)
1196 
1197   os::print_environment_variables(st, env_list);
1198   st-&gt;cr();
1199 
1200   // STEP(&quot;printing signal handlers&quot;)
1201 
1202   os::print_signal_handlers(st, buf, sizeof(buf));
1203   st-&gt;cr();
1204 
1205   // STEP(&quot;Native Memory Tracking&quot;)
1206 
1207   MemTracker::error_report(st);
1208 
1209   // STEP(&quot;printing system&quot;)
1210 
1211   st-&gt;cr();
1212   st-&gt;print_cr(&quot;---------------  S Y S T E M  ---------------&quot;);
1213   st-&gt;cr();
1214 
1215   // STEP(&quot;printing OS information&quot;)
1216 
1217   os::print_os_info(st);
1218   st-&gt;cr();
1219 
1220   // STEP(&quot;printing CPU info&quot;)
1221 
1222   os::print_cpu_info(st, buf, sizeof(buf));
1223   st-&gt;cr();
1224 
1225   // STEP(&quot;printing memory info&quot;)
1226 
1227   os::print_memory_info(st);
1228   st-&gt;cr();
1229 
1230   // STEP(&quot;printing internal vm info&quot;)
1231 
1232   st-&gt;print_cr(&quot;vm_info: %s&quot;, VM_Version::internal_vm_info_string());
1233   st-&gt;cr();
1234 
1235   // print a defined marker to show that error handling finished correctly.
1236   // STEP(&quot;printing end marker&quot;)
1237 
1238   st-&gt;print_cr(&quot;END.&quot;);
1239 }
1240 
1241 volatile intptr_t VMError::_first_error_tid = -1;
1242 
1243 /** Expand a pattern into a buffer starting at pos and open a file using constructed path */
1244 static int expand_and_open(const char* pattern, bool overwrite_existing, char* buf, size_t buflen, size_t pos) {
1245   int fd = -1;
1246   int mode = O_RDWR | O_CREAT;
1247   if (overwrite_existing) {
1248     mode |= O_TRUNC;
1249   } else {
1250     mode |= O_EXCL;
1251   }
1252   if (Arguments::copy_expand_pid(pattern, strlen(pattern), &amp;buf[pos], buflen - pos)) {
1253     fd = open(buf, mode, 0666);
1254   }
1255   return fd;
1256 }
1257 
1258 /**
1259  * Construct file name for a log file and return it&#39;s file descriptor.
1260  * Name and location depends on pattern, default_pattern params and access
1261  * permissions.
1262  */
1263 static int prepare_log_file(const char* pattern, const char* default_pattern, bool overwrite_existing, char* buf, size_t buflen) {
1264   int fd = -1;
1265 
1266   // If possible, use specified pattern to construct log file name
1267   if (pattern != NULL) {
1268     fd = expand_and_open(pattern, overwrite_existing, buf, buflen, 0);
1269   }
1270 
1271   // Either user didn&#39;t specify, or the user&#39;s location failed,
1272   // so use the default name in the current directory
1273   if (fd == -1) {
1274     const char* cwd = os::get_current_directory(buf, buflen);
1275     if (cwd != NULL) {
1276       size_t pos = strlen(cwd);
1277       int fsep_len = jio_snprintf(&amp;buf[pos], buflen-pos, &quot;%s&quot;, os::file_separator());
1278       pos += fsep_len;
1279       if (fsep_len &gt; 0) {
1280         fd = expand_and_open(default_pattern, overwrite_existing, buf, buflen, pos);
1281       }
1282     }
1283   }
1284 
1285    // try temp directory if it exists.
1286    if (fd == -1) {
1287      const char* tmpdir = os::get_temp_directory();
1288      if (tmpdir != NULL &amp;&amp; strlen(tmpdir) &gt; 0) {
1289        int pos = jio_snprintf(buf, buflen, &quot;%s%s&quot;, tmpdir, os::file_separator());
1290        if (pos &gt; 0) {
1291          fd = expand_and_open(default_pattern, overwrite_existing, buf, buflen, pos);
1292        }
1293      }
1294    }
1295 
1296   return fd;
1297 }
1298 
1299 int         VMError::_id;
1300 const char* VMError::_message;
1301 char        VMError::_detail_msg[1024];
1302 Thread*     VMError::_thread;
1303 address     VMError::_pc;
1304 void*       VMError::_siginfo;
1305 void*       VMError::_context;
1306 const char* VMError::_filename;
1307 int         VMError::_lineno;
1308 size_t      VMError::_size;
1309 
1310 void VMError::report_and_die(Thread* thread, unsigned int sig, address pc, void* siginfo,
1311                              void* context, const char* detail_fmt, ...)
1312 {
1313   va_list detail_args;
1314   va_start(detail_args, detail_fmt);
1315   report_and_die(sig, NULL, detail_fmt, detail_args, thread, pc, siginfo, context, NULL, 0, 0);
1316   va_end(detail_args);
1317 }
1318 
1319 void VMError::report_and_die(Thread* thread, unsigned int sig, address pc, void* siginfo, void* context)
1320 {
1321   report_and_die(thread, sig, pc, siginfo, context, &quot;%s&quot;, &quot;&quot;);
1322 }
1323 
1324 void VMError::report_and_die(const char* message, const char* detail_fmt, ...)
1325 {
1326   va_list detail_args;
1327   va_start(detail_args, detail_fmt);
1328   report_and_die(INTERNAL_ERROR, message, detail_fmt, detail_args, NULL, NULL, NULL, NULL, NULL, 0, 0);
1329   va_end(detail_args);
1330 }
1331 
1332 void VMError::report_and_die(const char* message)
1333 {
1334   report_and_die(message, &quot;%s&quot;, &quot;&quot;);
1335 }
1336 
1337 void VMError::report_and_die(Thread* thread, void* context, const char* filename, int lineno, const char* message,
1338                              const char* detail_fmt, va_list detail_args)
1339 {
1340   report_and_die(INTERNAL_ERROR, message, detail_fmt, detail_args, thread, NULL, NULL, context, filename, lineno, 0);
1341 }
1342 
1343 void VMError::report_and_die(Thread* thread, const char* filename, int lineno, size_t size,
1344                              VMErrorType vm_err_type, const char* detail_fmt, va_list detail_args) {
1345   report_and_die(vm_err_type, NULL, detail_fmt, detail_args, thread, NULL, NULL, NULL, filename, lineno, size);
1346 }
1347 
1348 void VMError::report_and_die(int id, const char* message, const char* detail_fmt, va_list detail_args,
1349                              Thread* thread, address pc, void* siginfo, void* context, const char* filename,
1350                              int lineno, size_t size)
1351 {
1352   // A single scratch buffer to be used from here on.
1353   // Do not rely on it being preserved across function calls.
1354   static char buffer[O_BUFLEN];
1355 
1356   // File descriptor to tty to print an error summary to.
1357   // Hard wired to stdout; see JDK-8215004 (compatibility concerns).
1358   static const int fd_out = 1; // stdout
1359 
1360   // File descriptor to the error log file.
1361   static int fd_log = -1;
1362 
1363 #ifdef CAN_SHOW_REGISTERS_ON_ASSERT
1364   // Disarm assertion poison page, since from this point on we do not need this mechanism anymore and it may
1365   // cause problems in error handling during native OOM, see JDK-8227275.
1366   disarm_assert_poison();
1367 #endif
1368 
1369   // Use local fdStream objects only. Do not use global instances whose initialization
1370   // relies on dynamic initialization (see JDK-8214975). Do not rely on these instances
1371   // to carry over into recursions or invocations from other threads.
1372   fdStream out(fd_out);
1373   out.set_scratch_buffer(buffer, sizeof(buffer));
1374 
1375   // Depending on the re-entrance depth at this point, fd_log may be -1 or point to an open hs-err file.
1376   fdStream log(fd_log);
1377   log.set_scratch_buffer(buffer, sizeof(buffer));
1378 
1379   // How many errors occurred in error handler when reporting first_error.
1380   static int recursive_error_count;
1381 
1382   // We will first print a brief message to standard out (verbose = false),
1383   // then save detailed information in log file (verbose = true).
1384   static bool out_done = false;         // done printing to standard out
1385   static bool log_done = false;         // done saving error log
1386 
1387   if (SuppressFatalErrorMessage) {
1388       os::abort(CreateCoredumpOnCrash);
1389   }
1390   intptr_t mytid = os::current_thread_id();
1391   if (_first_error_tid == -1 &amp;&amp;
1392       Atomic::cmpxchg(&amp;_first_error_tid, (intptr_t)-1, mytid) == -1) {
1393 
1394     // Initialize time stamps to use the same base.
1395     out.time_stamp().update_to(1);
1396     log.time_stamp().update_to(1);
1397 
1398     _id = id;
1399     _message = message;
1400     _thread = thread;
1401     _pc = pc;
1402     _siginfo = siginfo;
1403     _context = context;
1404     _filename = filename;
1405     _lineno = lineno;
1406     _size = size;
1407     jio_vsnprintf(_detail_msg, sizeof(_detail_msg), detail_fmt, detail_args);
1408 
1409     // first time
1410     _error_reported = true;
1411 
1412     reporting_started();
1413     if (!TestUnresponsiveErrorHandler) {
1414       // Record reporting_start_time unless we&#39;re running the
1415       // TestUnresponsiveErrorHandler test. For that test we record
1416       // reporting_start_time at the beginning of the test.
1417       record_reporting_start_time();
1418     } else {
1419       out.print_raw_cr(&quot;Delaying recording reporting_start_time for TestUnresponsiveErrorHandler.&quot;);
1420     }
1421 
1422     if (ShowMessageBoxOnError || PauseAtExit) {
1423       show_message_box(buffer, sizeof(buffer));
1424 
1425       // User has asked JVM to abort. Reset ShowMessageBoxOnError so the
1426       // WatcherThread can kill JVM if the error handler hangs.
1427       ShowMessageBoxOnError = false;
1428     }
1429 
1430     os::check_dump_limit(buffer, sizeof(buffer));
1431 
1432     // reset signal handlers or exception filter; make sure recursive crashes
1433     // are handled properly.
1434     reset_signal_handlers();
1435   } else {
1436     // If UseOsErrorReporting we call this for each level of the call stack
1437     // while searching for the exception handler.  Only the first level needs
1438     // to be reported.
1439     if (UseOSErrorReporting &amp;&amp; log_done) return;
1440 
1441     // This is not the first error, see if it happened in a different thread
1442     // or in the same thread during error reporting.
1443     if (_first_error_tid != mytid) {
1444       char msgbuf[64];
1445       jio_snprintf(msgbuf, sizeof(msgbuf),
1446                    &quot;[thread &quot; INTX_FORMAT &quot; also had an error]&quot;,
1447                    mytid);
1448       out.print_raw_cr(msgbuf);
1449 
1450       // error reporting is not MT-safe, block current thread
1451       os::infinite_sleep();
1452 
1453     } else {
1454       if (recursive_error_count++ &gt; 30) {
1455         out.print_raw_cr(&quot;[Too many errors, abort]&quot;);
1456         os::die();
1457       }
1458 
1459       outputStream* const st = log.is_open() ? &amp;log : &amp;out;
1460       st-&gt;cr();
1461 
1462       // Timeout handling.
1463       if (_step_did_timeout) {
1464         // The current step had a timeout. Lets continue reporting with the next step.
1465         st-&gt;print_raw(&quot;[timeout occurred during error reporting in step \&quot;&quot;);
1466         st-&gt;print_raw(_current_step_info);
1467         st-&gt;print_cr(&quot;\&quot;] after &quot; INT64_FORMAT &quot; s.&quot;,
1468                      (int64_t)
1469                      ((get_current_timestamp() - _step_start_time) / TIMESTAMP_TO_SECONDS_FACTOR));
1470       } else if (_reporting_did_timeout) {
1471         // We hit ErrorLogTimeout. Reporting will stop altogether. Let&#39;s wrap things
1472         // up, the process is about to be stopped by the WatcherThread.
1473         st-&gt;print_cr(&quot;------ Timeout during error reporting after &quot; INT64_FORMAT &quot; s. ------&quot;,
1474                      (int64_t)
1475                      ((get_current_timestamp() - _reporting_start_time) / TIMESTAMP_TO_SECONDS_FACTOR));
1476         st-&gt;flush();
1477         // Watcherthread is about to call os::die. Lets just wait.
1478         os::infinite_sleep();
1479       } else {
1480         // Crash or assert during error reporting. Lets continue reporting with the next step.
1481         stringStream ss(buffer, sizeof(buffer));
1482         // Note: this string does get parsed by a number of jtreg tests,
1483         // see hotspot/jtreg/runtime/ErrorHandling.
1484         ss.print(&quot;[error occurred during error reporting (%s), id 0x%x&quot;,
1485                    _current_step_info, id);
1486         char signal_name[64];
1487         if (os::exception_name(id, signal_name, sizeof(signal_name))) {
1488           ss.print(&quot;, %s (0x%x) at pc=&quot; PTR_FORMAT, signal_name, id, p2i(pc));
1489         } else {
1490           if (should_report_bug(id)) {
1491             ss.print(&quot;, Internal Error (%s:%d)&quot;,
1492               filename == NULL ? &quot;??&quot; : filename, lineno);
1493           } else {
1494             ss.print(&quot;, Out of Memory Error (%s:%d)&quot;,
1495               filename == NULL ? &quot;??&quot; : filename, lineno);
1496           }
1497         }
1498         ss.print(&quot;]&quot;);
1499         st-&gt;print_raw_cr(buffer);
1500         st-&gt;cr();
1501       }
1502     }
1503   }
1504 
1505   // Part 1: print an abbreviated version (the &#39;#&#39; section) to stdout.
1506   if (!out_done) {
1507     // Suppress this output if we plan to print Part 2 to stdout too.
1508     // No need to have the &quot;#&quot; section twice.
1509     if (!(ErrorFileToStdout &amp;&amp; out.fd() == 1)) {
1510       report(&amp;out, false);
1511     }
1512 
1513     out_done = true;
1514 
1515     _current_step = 0;
1516     _current_step_info = &quot;&quot;;
1517   }
1518 
1519   // Part 2: print a full error log file (optionally to stdout or stderr).
1520   // print to error log file
1521   if (!log_done) {
1522     // see if log file is already open
1523     if (!log.is_open()) {
1524       // open log file
1525       if (ErrorFileToStdout) {
1526         fd_log = 1;
1527       } else if (ErrorFileToStderr) {
1528         fd_log = 2;
1529       } else {
1530         fd_log = prepare_log_file(ErrorFile, &quot;hs_err_pid%p.log&quot;, true,
1531                  buffer, sizeof(buffer));
1532         if (fd_log != -1) {
1533           out.print_raw(&quot;# An error report file with more information is saved as:\n# &quot;);
1534           out.print_raw_cr(buffer);
1535         } else {
1536           out.print_raw_cr(&quot;# Can not save log file, dump to screen..&quot;);
1537           fd_log = 1;
1538         }
1539       }
1540       log.set_fd(fd_log);
1541     }
1542 
1543     report(&amp;log, true);
1544     log_done = true;
1545     _current_step = 0;
1546     _current_step_info = &quot;&quot;;
1547 
1548     if (fd_log &gt; 3) {
1549       close(fd_log);
1550       fd_log = -1;
1551     }
1552 
1553     log.set_fd(-1);
1554   }
1555 
1556   JFR_ONLY(Jfr::on_vm_shutdown(true);)
1557 
1558   if (PrintNMTStatistics) {
1559     fdStream fds(fd_out);
1560     MemTracker::final_report(&amp;fds);
1561   }
1562 
1563   static bool skip_replay = ReplayCompiles; // Do not overwrite file during replay
1564   if (DumpReplayDataOnError &amp;&amp; _thread &amp;&amp; _thread-&gt;is_Compiler_thread() &amp;&amp; !skip_replay) {
1565     skip_replay = true;
1566     ciEnv* env = ciEnv::current();
1567     if (env != NULL) {
1568       const bool overwrite = false; // We do not overwrite an existing replay file.
1569       int fd = prepare_log_file(ReplayDataFile, &quot;replay_pid%p.log&quot;, overwrite, buffer, sizeof(buffer));
1570       if (fd != -1) {
1571         FILE* replay_data_file = os::open(fd, &quot;w&quot;);
1572         if (replay_data_file != NULL) {
1573           fileStream replay_data_stream(replay_data_file, /*need_close=*/true);
1574           env-&gt;dump_replay_data_unsafe(&amp;replay_data_stream);
1575           out.print_raw(&quot;#\n# Compiler replay data is saved as:\n# &quot;);
1576           out.print_raw_cr(buffer);
1577         } else {
1578           int e = errno;
1579           out.print_raw(&quot;#\n# Can&#39;t open file to dump replay data. Error: &quot;);
1580           out.print_raw_cr(os::strerror(e));
1581         }
1582       }
1583     }
1584   }
1585 
1586   static bool skip_bug_url = !should_report_bug(_id);
1587   if (!skip_bug_url) {
1588     skip_bug_url = true;
1589 
1590     out.print_raw_cr(&quot;#&quot;);
1591     print_bug_submit_message(&amp;out, _thread);
1592   }
1593 
1594   static bool skip_OnError = false;
1595   if (!skip_OnError &amp;&amp; OnError &amp;&amp; OnError[0]) {
1596     skip_OnError = true;
1597 
1598     // Flush output and finish logs before running OnError commands.
1599     ostream_abort();
1600 
1601     out.print_raw_cr(&quot;#&quot;);
1602     out.print_raw   (&quot;# -XX:OnError=\&quot;&quot;);
1603     out.print_raw   (OnError);
1604     out.print_raw_cr(&quot;\&quot;&quot;);
1605 
1606     char* cmd;
1607     const char* ptr = OnError;
1608     while ((cmd = next_OnError_command(buffer, sizeof(buffer), &amp;ptr)) != NULL){
1609       out.print_raw   (&quot;#   Executing &quot;);
1610 #if defined(LINUX) || defined(_ALLBSD_SOURCE)
1611       out.print_raw   (&quot;/bin/sh -c &quot;);
1612 #elif defined(_WINDOWS)
1613       out.print_raw   (&quot;cmd /C &quot;);
1614 #endif
1615       out.print_raw   (&quot;\&quot;&quot;);
1616       out.print_raw   (cmd);
1617       out.print_raw_cr(&quot;\&quot; ...&quot;);
1618 
1619       if (os::fork_and_exec(cmd) &lt; 0) {
1620         out.print_cr(&quot;os::fork_and_exec failed: %s (%s=%d)&quot;,
1621                      os::strerror(errno), os::errno_name(errno), errno);
1622       }
1623     }
1624 
1625     // done with OnError
1626     OnError = NULL;
1627   }
1628 
1629   if (!UseOSErrorReporting) {
1630     // os::abort() will call abort hooks, try it first.
1631     static bool skip_os_abort = false;
1632     if (!skip_os_abort) {
1633       skip_os_abort = true;
1634       bool dump_core = should_report_bug(_id);
1635       os::abort(dump_core &amp;&amp; CreateCoredumpOnCrash, _siginfo, _context);
1636     }
1637 
1638     // if os::abort() doesn&#39;t abort, try os::die();
1639     os::die();
1640   }
1641 }
1642 
1643 /*
1644  * OnOutOfMemoryError scripts/commands executed while VM is a safepoint - this
1645  * ensures utilities such as jmap can observe the process is a consistent state.
1646  */
1647 class VM_ReportJavaOutOfMemory : public VM_Operation {
1648  private:
1649   const char* _message;
1650  public:
1651   VM_ReportJavaOutOfMemory(const char* message) { _message = message; }
1652   VMOp_Type type() const                        { return VMOp_ReportJavaOutOfMemory; }
1653   void doit();
1654 };
1655 
1656 void VM_ReportJavaOutOfMemory::doit() {
1657   // Don&#39;t allocate large buffer on stack
1658   static char buffer[O_BUFLEN];
1659 
1660   tty-&gt;print_cr(&quot;#&quot;);
1661   tty-&gt;print_cr(&quot;# java.lang.OutOfMemoryError: %s&quot;, _message);
1662   tty-&gt;print_cr(&quot;# -XX:OnOutOfMemoryError=\&quot;%s\&quot;&quot;, OnOutOfMemoryError);
1663 
1664   // make heap parsability
1665   Universe::heap()-&gt;ensure_parsability(false);  // no need to retire TLABs
1666 
1667   char* cmd;
1668   const char* ptr = OnOutOfMemoryError;
1669   while ((cmd = next_OnError_command(buffer, sizeof(buffer), &amp;ptr)) != NULL){
1670     tty-&gt;print(&quot;#   Executing &quot;);
1671 #if defined(LINUX)
1672     tty-&gt;print  (&quot;/bin/sh -c &quot;);
1673 #endif
1674     tty-&gt;print_cr(&quot;\&quot;%s\&quot;...&quot;, cmd);
1675 
1676     if (os::fork_and_exec(cmd, true) &lt; 0) {
1677       tty-&gt;print_cr(&quot;os::fork_and_exec failed: %s (%s=%d)&quot;,
1678                      os::strerror(errno), os::errno_name(errno), errno);
1679     }
1680   }
1681 }
1682 
1683 void VMError::report_java_out_of_memory(const char* message) {
1684   if (OnOutOfMemoryError &amp;&amp; OnOutOfMemoryError[0]) {
1685     MutexLocker ml(Heap_lock);
1686     VM_ReportJavaOutOfMemory op(message);
1687     VMThread::execute(&amp;op);
1688   }
1689 }
1690 
1691 void VMError::show_message_box(char *buf, int buflen) {
1692   bool yes;
1693   do {
1694     error_string(buf, buflen);
1695     yes = os::start_debugging(buf,buflen);
1696   } while (yes);
1697 }
1698 
1699 // Timeout handling: check if a timeout happened (either a single step did
1700 // timeout or the whole of error reporting hit ErrorLogTimeout). Interrupt
1701 // the reporting thread if that is the case.
1702 bool VMError::check_timeout() {
1703 
1704   if (ErrorLogTimeout == 0) {
1705     return false;
1706   }
1707 
1708   // Do not check for timeouts if we still have a message box to show to the
1709   // user or if there are OnError handlers to be run.
1710   if (ShowMessageBoxOnError
1711       || (OnError != NULL &amp;&amp; OnError[0] != &#39;\0&#39;)
1712       || Arguments::abort_hook() != NULL) {
1713     return false;
1714   }
1715 
1716   const jlong reporting_start_time_l = get_reporting_start_time();
1717   const jlong now = get_current_timestamp();
1718   // Timestamp is stored in nanos.
1719   if (reporting_start_time_l &gt; 0) {
1720     const jlong end = reporting_start_time_l + (jlong)ErrorLogTimeout * TIMESTAMP_TO_SECONDS_FACTOR;
1721     if (end &lt;= now &amp;&amp; !_reporting_did_timeout) {
1722       // We hit ErrorLogTimeout and we haven&#39;t interrupted the reporting
1723       // thread yet.
1724       _reporting_did_timeout = true;
1725       interrupt_reporting_thread();
1726       return true; // global timeout
1727     }
1728   }
1729 
1730   const jlong step_start_time_l = get_step_start_time();
1731   if (step_start_time_l &gt; 0) {
1732     // A step times out after a quarter of the total timeout. Steps are mostly fast unless they
1733     // hang for some reason, so this simple rule allows for three hanging step and still
1734     // hopefully leaves time enough for the rest of the steps to finish.
1735     const jlong end = step_start_time_l + (jlong)ErrorLogTimeout * TIMESTAMP_TO_SECONDS_FACTOR / 4;
1736     if (end &lt;= now &amp;&amp; !_step_did_timeout) {
1737       // The step timed out and we haven&#39;t interrupted the reporting
1738       // thread yet.
1739       _step_did_timeout = true;
1740       interrupt_reporting_thread();
1741       return false; // (Not a global timeout)
1742     }
1743   }
1744 
1745   return false;
1746 
1747 }
1748 
1749 #ifndef PRODUCT
1750 typedef void (*voidfun_t)();
<a name="7" id="anc7"></a><span class="line-added">1751 </span>
1752 // Crash with an authentic sigfpe
<a name="8" id="anc8"></a><span class="line-added">1753 volatile int sigfpe_int = 0;</span>
1754 static void crash_with_sigfpe() {
<a name="9" id="anc9"></a><span class="line-added">1755 </span>
1756   // generate a native synchronous SIGFPE where possible;
<a name="10" id="anc10"></a><span class="line-added">1757   sigfpe_int = sigfpe_int/sigfpe_int;</span>
<span class="line-added">1758 </span>
1759   // if that did not cause a signal (e.g. on ppc), just
1760   // raise the signal.
<a name="11" id="anc11"></a>

1761 #ifndef _WIN32
1762   // OSX implements raise(sig) incorrectly so we need to
1763   // explicitly target the current thread
1764   pthread_kill(pthread_self(), SIGFPE);
1765 #endif
<a name="12" id="anc12"></a><span class="line-added">1766 </span>
1767 } // end: crash_with_sigfpe
1768 
1769 // crash with sigsegv at non-null address.
1770 static void crash_with_segfault() {
1771 
1772   char* const crash_addr = (char*) VMError::get_segfault_address();
1773   *crash_addr = &#39;X&#39;;
1774 
1775 } // end: crash_with_segfault
1776 
1777 void VMError::test_error_handler() {
1778   controlled_crash(ErrorHandlerTest);
1779 }
1780 
1781 // crash in a controlled way:
1782 // how can be one of:
1783 // 1,2 - asserts
1784 // 3,4 - guarantee
1785 // 5-7 - fatal
1786 // 8 - vm_exit_out_of_memory
1787 // 9 - ShouldNotCallThis
1788 // 10 - ShouldNotReachHere
1789 // 11 - Unimplemented
1790 // 12,13 - (not guaranteed) crashes
1791 // 14 - SIGSEGV
1792 // 15 - SIGFPE
1793 void VMError::controlled_crash(int how) {
1794   if (how == 0) return;
1795 
1796   // If asserts are disabled, use the corresponding guarantee instead.
1797   NOT_DEBUG(if (how &lt;= 2) how += 2);
1798 
1799   const char* const str = &quot;hello&quot;;
1800   const size_t      num = (size_t)os::vm_page_size();
1801 
1802   const char* const eol = os::line_separator();
1803   const char* const msg = &quot;this message should be truncated during formatting&quot;;
1804   char * const dataPtr = NULL;  // bad data pointer
1805   const void (*funcPtr)(void);  // bad function pointer
1806 
1807 #if defined(PPC64) &amp;&amp; !defined(ABI_ELFv2)
1808   struct FunctionDescriptor functionDescriptor;
1809 
1810   functionDescriptor.set_entry((address) 0xF);
1811   funcPtr = (const void(*)()) &amp;functionDescriptor;
1812 #else
1813   funcPtr = (const void(*)()) 0xF;
1814 #endif
1815 
1816   // Keep this in sync with test/hotspot/jtreg/runtime/ErrorHandling/ErrorHandler.java
1817   // which tests cases 1 thru 13.
1818   // Case 14 is tested by test/hotspot/jtreg/runtime/ErrorHandling/SafeFetchInErrorHandlingTest.java.
1819   // Case 15 is tested by test/hotspot/jtreg/runtime/ErrorHandling/SecondaryErrorTest.java.
1820   // Case 16 is tested by test/hotspot/jtreg/runtime/ErrorHandling/ThreadsListHandleInErrorHandlingTest.java.
1821   // Case 17 is tested by test/hotspot/jtreg/runtime/ErrorHandling/NestedThreadsListHandleInErrorHandlingTest.java.
1822 
1823   // We try to grab Threads_lock to keep ThreadsSMRSupport::print_info_on()
1824   // from racing with Threads::add() or Threads::remove() as we
1825   // generate the hs_err_pid file. This makes our ErrorHandling tests
1826   // more stable.
1827   if (!Threads_lock-&gt;owned_by_self()) {
1828     Threads_lock-&gt;try_lock();
1829     // The VM is going to die so no need to unlock Thread_lock.
1830   }
1831 
1832   switch (how) {
1833     case  1: vmassert(str == NULL, &quot;expected null&quot;); break;
1834     case  2: vmassert(num == 1023 &amp;&amp; *str == &#39;X&#39;,
1835                       &quot;num=&quot; SIZE_FORMAT &quot; str=\&quot;%s\&quot;&quot;, num, str); break;
1836     case  3: guarantee(str == NULL, &quot;expected null&quot;); break;
1837     case  4: guarantee(num == 1023 &amp;&amp; *str == &#39;X&#39;,
1838                        &quot;num=&quot; SIZE_FORMAT &quot; str=\&quot;%s\&quot;&quot;, num, str); break;
1839     case  5: fatal(&quot;expected null&quot;); break;
1840     case  6: fatal(&quot;num=&quot; SIZE_FORMAT &quot; str=\&quot;%s\&quot;&quot;, num, str); break;
1841     case  7: fatal(&quot;%s%s#    %s%s#    %s%s#    %s%s#    %s%s#    &quot;
1842                    &quot;%s%s#    %s%s#    %s%s#    %s%s#    %s%s#    &quot;
1843                    &quot;%s%s#    %s%s#    %s%s#    %s%s#    %s&quot;,
1844                    msg, eol, msg, eol, msg, eol, msg, eol, msg, eol,
1845                    msg, eol, msg, eol, msg, eol, msg, eol, msg, eol,
1846                    msg, eol, msg, eol, msg, eol, msg, eol, msg); break;
1847     case  8: vm_exit_out_of_memory(num, OOM_MALLOC_ERROR, &quot;ChunkPool::allocate&quot;); break;
1848     case  9: ShouldNotCallThis(); break;
1849     case 10: ShouldNotReachHere(); break;
1850     case 11: Unimplemented(); break;
1851     // There&#39;s no guarantee the bad data pointer will crash us
1852     // so &quot;break&quot; out to the ShouldNotReachHere().
1853     case 12: *dataPtr = &#39;\0&#39;; break;
1854     // There&#39;s no guarantee the bad function pointer will crash us
1855     // so &quot;break&quot; out to the ShouldNotReachHere().
1856     case 13: (*funcPtr)(); break;
1857     case 14: crash_with_segfault(); break;
1858     case 15: crash_with_sigfpe(); break;
1859     case 16: {
1860       ThreadsListHandle tlh;
1861       fatal(&quot;Force crash with an active ThreadsListHandle.&quot;);
1862     }
1863     case 17: {
1864       ThreadsListHandle tlh;
1865       {
1866         ThreadsListHandle tlh2;
1867         fatal(&quot;Force crash with a nested ThreadsListHandle.&quot;);
1868       }
1869     }
1870 
1871     default: tty-&gt;print_cr(&quot;ERROR: %d: unexpected test_num value.&quot;, how);
1872   }
1873   tty-&gt;print_cr(&quot;VMError::controlled_crash: survived intentional crash. Did you suppress the assert?&quot;);
1874   ShouldNotReachHere();
1875 }
1876 #endif // !PRODUCT
<a name="13" id="anc13"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="13" type="hidden" />
</body>
</html>