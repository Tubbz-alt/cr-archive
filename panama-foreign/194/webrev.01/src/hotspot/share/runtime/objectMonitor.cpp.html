<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>New src/hotspot/share/runtime/objectMonitor.cpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
  </head>
  <body>
    <pre>
   1 /*
   2  * Copyright (c) 1998, 2020, Oracle and/or its affiliates. All rights reserved.
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.
   8  *
   9  * This code is distributed in the hope that it will be useful, but WITHOUT
  10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  *
  23  */
  24 
  25 #include &quot;precompiled.hpp&quot;
  26 #include &quot;classfile/vmSymbols.hpp&quot;
  27 #include &quot;jfr/jfrEvents.hpp&quot;
  28 #include &quot;jfr/support/jfrThreadId.hpp&quot;
  29 #include &quot;logging/log.hpp&quot;
  30 #include &quot;logging/logStream.hpp&quot;
  31 #include &quot;memory/allocation.inline.hpp&quot;
  32 #include &quot;memory/resourceArea.hpp&quot;
  33 #include &quot;oops/markWord.hpp&quot;
  34 #include &quot;oops/oop.inline.hpp&quot;
  35 #include &quot;runtime/atomic.hpp&quot;
  36 #include &quot;runtime/handles.inline.hpp&quot;
  37 #include &quot;runtime/interfaceSupport.inline.hpp&quot;
  38 #include &quot;runtime/mutexLocker.hpp&quot;
  39 #include &quot;runtime/objectMonitor.hpp&quot;
  40 #include &quot;runtime/objectMonitor.inline.hpp&quot;
  41 #include &quot;runtime/orderAccess.hpp&quot;
  42 #include &quot;runtime/osThread.hpp&quot;
  43 #include &quot;runtime/safepointMechanism.inline.hpp&quot;
  44 #include &quot;runtime/sharedRuntime.hpp&quot;
  45 #include &quot;runtime/stubRoutines.hpp&quot;
  46 #include &quot;runtime/thread.inline.hpp&quot;
  47 #include &quot;services/threadService.hpp&quot;
  48 #include &quot;utilities/dtrace.hpp&quot;
  49 #include &quot;utilities/macros.hpp&quot;
  50 #include &quot;utilities/preserveException.hpp&quot;
  51 #if INCLUDE_JFR
  52 #include &quot;jfr/support/jfrFlush.hpp&quot;
  53 #endif
  54 
  55 #ifdef DTRACE_ENABLED
  56 
  57 // Only bother with this argument setup if dtrace is available
  58 // TODO-FIXME: probes should not fire when caller is _blocked.  assert() accordingly.
  59 
  60 
  61 #define DTRACE_MONITOR_PROBE_COMMON(obj, thread)                           \
  62   char* bytes = NULL;                                                      \
  63   int len = 0;                                                             \
  64   jlong jtid = SharedRuntime::get_java_tid(thread);                        \
  65   Symbol* klassname = ((oop)obj)-&gt;klass()-&gt;name();                         \
  66   if (klassname != NULL) {                                                 \
  67     bytes = (char*)klassname-&gt;bytes();                                     \
  68     len = klassname-&gt;utf8_length();                                        \
  69   }
  70 
  71 #define DTRACE_MONITOR_WAIT_PROBE(monitor, obj, thread, millis)            \
  72   {                                                                        \
  73     if (DTraceMonitorProbes) {                                             \
  74       DTRACE_MONITOR_PROBE_COMMON(obj, thread);                            \
  75       HOTSPOT_MONITOR_WAIT(jtid,                                           \
  76                            (monitor), bytes, len, (millis));               \
  77     }                                                                      \
  78   }
  79 
  80 #define HOTSPOT_MONITOR_contended__enter HOTSPOT_MONITOR_CONTENDED_ENTER
  81 #define HOTSPOT_MONITOR_contended__entered HOTSPOT_MONITOR_CONTENDED_ENTERED
  82 #define HOTSPOT_MONITOR_contended__exit HOTSPOT_MONITOR_CONTENDED_EXIT
  83 #define HOTSPOT_MONITOR_notify HOTSPOT_MONITOR_NOTIFY
  84 #define HOTSPOT_MONITOR_notifyAll HOTSPOT_MONITOR_NOTIFYALL
  85 
  86 #define DTRACE_MONITOR_PROBE(probe, monitor, obj, thread)                  \
  87   {                                                                        \
  88     if (DTraceMonitorProbes) {                                             \
  89       DTRACE_MONITOR_PROBE_COMMON(obj, thread);                            \
  90       HOTSPOT_MONITOR_##probe(jtid,                                        \
  91                               (uintptr_t)(monitor), bytes, len);           \
  92     }                                                                      \
  93   }
  94 
  95 #else //  ndef DTRACE_ENABLED
  96 
  97 #define DTRACE_MONITOR_WAIT_PROBE(obj, thread, millis, mon)    {;}
  98 #define DTRACE_MONITOR_PROBE(probe, obj, thread, mon)          {;}
  99 
 100 #endif // ndef DTRACE_ENABLED
 101 
 102 // Tunables ...
 103 // The knob* variables are effectively final.  Once set they should
 104 // never be modified hence.  Consider using __read_mostly with GCC.
 105 
 106 int ObjectMonitor::Knob_SpinLimit    = 5000;    // derived by an external tool -
 107 
 108 static int Knob_Bonus               = 100;     // spin success bonus
 109 static int Knob_BonusB              = 100;     // spin success bonus
 110 static int Knob_Penalty             = 200;     // spin failure penalty
 111 static int Knob_Poverty             = 1000;
 112 static int Knob_FixedSpin           = 0;
 113 static int Knob_PreSpin             = 10;      // 20-100 likely better
 114 
 115 DEBUG_ONLY(static volatile bool InitDone = false;)
 116 
 117 // -----------------------------------------------------------------------------
 118 // Theory of operations -- Monitors lists, thread residency, etc:
 119 //
 120 // * A thread acquires ownership of a monitor by successfully
 121 //   CAS()ing the _owner field from null to non-null.
 122 //
 123 // * Invariant: A thread appears on at most one monitor list --
 124 //   cxq, EntryList or WaitSet -- at any one time.
 125 //
 126 // * Contending threads &quot;push&quot; themselves onto the cxq with CAS
 127 //   and then spin/park.
 128 //
 129 // * After a contending thread eventually acquires the lock it must
 130 //   dequeue itself from either the EntryList or the cxq.
 131 //
 132 // * The exiting thread identifies and unparks an &quot;heir presumptive&quot;
 133 //   tentative successor thread on the EntryList.  Critically, the
 134 //   exiting thread doesn&#39;t unlink the successor thread from the EntryList.
 135 //   After having been unparked, the wakee will recontend for ownership of
 136 //   the monitor.   The successor (wakee) will either acquire the lock or
 137 //   re-park itself.
 138 //
 139 //   Succession is provided for by a policy of competitive handoff.
 140 //   The exiting thread does _not_ grant or pass ownership to the
 141 //   successor thread.  (This is also referred to as &quot;handoff&quot; succession&quot;).
 142 //   Instead the exiting thread releases ownership and possibly wakes
 143 //   a successor, so the successor can (re)compete for ownership of the lock.
 144 //   If the EntryList is empty but the cxq is populated the exiting
 145 //   thread will drain the cxq into the EntryList.  It does so by
 146 //   by detaching the cxq (installing null with CAS) and folding
 147 //   the threads from the cxq into the EntryList.  The EntryList is
 148 //   doubly linked, while the cxq is singly linked because of the
 149 //   CAS-based &quot;push&quot; used to enqueue recently arrived threads (RATs).
 150 //
 151 // * Concurrency invariants:
 152 //
 153 //   -- only the monitor owner may access or mutate the EntryList.
 154 //      The mutex property of the monitor itself protects the EntryList
 155 //      from concurrent interference.
 156 //   -- Only the monitor owner may detach the cxq.
 157 //
 158 // * The monitor entry list operations avoid locks, but strictly speaking
 159 //   they&#39;re not lock-free.  Enter is lock-free, exit is not.
 160 //   For a description of &#39;Methods and apparatus providing non-blocking access
 161 //   to a resource,&#39; see U.S. Pat. No. 7844973.
 162 //
 163 // * The cxq can have multiple concurrent &quot;pushers&quot; but only one concurrent
 164 //   detaching thread.  This mechanism is immune from the ABA corruption.
 165 //   More precisely, the CAS-based &quot;push&quot; onto cxq is ABA-oblivious.
 166 //
 167 // * Taken together, the cxq and the EntryList constitute or form a
 168 //   single logical queue of threads stalled trying to acquire the lock.
 169 //   We use two distinct lists to improve the odds of a constant-time
 170 //   dequeue operation after acquisition (in the ::enter() epilogue) and
 171 //   to reduce heat on the list ends.  (c.f. Michael Scott&#39;s &quot;2Q&quot; algorithm).
 172 //   A key desideratum is to minimize queue &amp; monitor metadata manipulation
 173 //   that occurs while holding the monitor lock -- that is, we want to
 174 //   minimize monitor lock holds times.  Note that even a small amount of
 175 //   fixed spinning will greatly reduce the # of enqueue-dequeue operations
 176 //   on EntryList|cxq.  That is, spinning relieves contention on the &quot;inner&quot;
 177 //   locks and monitor metadata.
 178 //
 179 //   Cxq points to the set of Recently Arrived Threads attempting entry.
 180 //   Because we push threads onto _cxq with CAS, the RATs must take the form of
 181 //   a singly-linked LIFO.  We drain _cxq into EntryList  at unlock-time when
 182 //   the unlocking thread notices that EntryList is null but _cxq is != null.
 183 //
 184 //   The EntryList is ordered by the prevailing queue discipline and
 185 //   can be organized in any convenient fashion, such as a doubly-linked list or
 186 //   a circular doubly-linked list.  Critically, we want insert and delete operations
 187 //   to operate in constant-time.  If we need a priority queue then something akin
 188 //   to Solaris&#39; sleepq would work nicely.  Viz.,
 189 //   http://agg.eng/ws/on10_nightly/source/usr/src/uts/common/os/sleepq.c.
 190 //   Queue discipline is enforced at ::exit() time, when the unlocking thread
 191 //   drains the cxq into the EntryList, and orders or reorders the threads on the
 192 //   EntryList accordingly.
 193 //
 194 //   Barring &quot;lock barging&quot;, this mechanism provides fair cyclic ordering,
 195 //   somewhat similar to an elevator-scan.
 196 //
 197 // * The monitor synchronization subsystem avoids the use of native
 198 //   synchronization primitives except for the narrow platform-specific
 199 //   park-unpark abstraction.  See the comments in os_solaris.cpp regarding
 200 //   the semantics of park-unpark.  Put another way, this monitor implementation
 201 //   depends only on atomic operations and park-unpark.  The monitor subsystem
 202 //   manages all RUNNING-&gt;BLOCKED and BLOCKED-&gt;READY transitions while the
 203 //   underlying OS manages the READY&lt;-&gt;RUN transitions.
 204 //
 205 // * Waiting threads reside on the WaitSet list -- wait() puts
 206 //   the caller onto the WaitSet.
 207 //
 208 // * notify() or notifyAll() simply transfers threads from the WaitSet to
 209 //   either the EntryList or cxq.  Subsequent exit() operations will
 210 //   unpark the notifyee.  Unparking a notifee in notify() is inefficient -
 211 //   it&#39;s likely the notifyee would simply impale itself on the lock held
 212 //   by the notifier.
 213 //
 214 // * An interesting alternative is to encode cxq as (List,LockByte) where
 215 //   the LockByte is 0 iff the monitor is owned.  _owner is simply an auxiliary
 216 //   variable, like _recursions, in the scheme.  The threads or Events that form
 217 //   the list would have to be aligned in 256-byte addresses.  A thread would
 218 //   try to acquire the lock or enqueue itself with CAS, but exiting threads
 219 //   could use a 1-0 protocol and simply STB to set the LockByte to 0.
 220 //   Note that is is *not* word-tearing, but it does presume that full-word
 221 //   CAS operations are coherent with intermix with STB operations.  That&#39;s true
 222 //   on most common processors.
 223 //
 224 // * See also http://blogs.sun.com/dave
 225 
 226 
 227 void* ObjectMonitor::operator new (size_t size) throw() {
 228   return AllocateHeap(size, mtInternal);
 229 }
 230 void* ObjectMonitor::operator new[] (size_t size) throw() {
 231   return operator new (size);
 232 }
 233 void ObjectMonitor::operator delete(void* p) {
 234   FreeHeap(p);
 235 }
 236 void ObjectMonitor::operator delete[] (void *p) {
 237   operator delete(p);
 238 }
 239 
 240 // -----------------------------------------------------------------------------
 241 // Enter support
 242 
 243 bool ObjectMonitor::enter(TRAPS) {
 244   // The following code is ordered to check the most common cases first
 245   // and to reduce RTS-&gt;RTO cache line upgrades on SPARC and IA32 processors.
 246   Thread * const Self = THREAD;
 247 
 248   void* cur = try_set_owner_from(NULL, Self);
 249   if (cur == NULL) {
 250     assert(_recursions == 0, &quot;invariant&quot;);
 251     return true;
 252   }
 253 
 254   if (cur == Self) {
 255     // TODO-FIXME: check for integer overflow!  BUGID 6557169.
 256     _recursions++;
 257     return true;
 258   }
 259 
 260   if (Self-&gt;is_lock_owned((address)cur)) {
 261     assert(_recursions == 0, &quot;internal state error&quot;);
 262     _recursions = 1;
 263     set_owner_from_BasicLock(cur, Self);  // Convert from BasicLock* to Thread*.
 264     return true;
 265   }
 266 
 267   // We&#39;ve encountered genuine contention.
 268   assert(Self-&gt;_Stalled == 0, &quot;invariant&quot;);
 269   Self-&gt;_Stalled = intptr_t(this);
 270 
 271   // Try one round of spinning *before* enqueueing Self
 272   // and before going through the awkward and expensive state
 273   // transitions.  The following spin is strictly optional ...
 274   // Note that if we acquire the monitor from an initial spin
 275   // we forgo posting JVMTI events and firing DTRACE probes.
 276   if (TrySpin(Self) &gt; 0) {
 277     assert(_owner == Self, &quot;must be Self: owner=&quot; INTPTR_FORMAT, p2i(_owner));
 278     assert(_recursions == 0, &quot;must be 0: recursions=&quot; INTX_FORMAT, _recursions);
 279     assert(((oop)object())-&gt;mark() == markWord::encode(this),
 280            &quot;object mark must match encoded this: mark=&quot; INTPTR_FORMAT
 281            &quot;, encoded this=&quot; INTPTR_FORMAT, ((oop)object())-&gt;mark().value(),
 282            markWord::encode(this).value());
 283     Self-&gt;_Stalled = 0;
 284     return true;
 285   }
 286 
 287   assert(_owner != Self, &quot;invariant&quot;);
 288   assert(_succ != Self, &quot;invariant&quot;);
 289   assert(Self-&gt;is_Java_thread(), &quot;invariant&quot;);
 290   JavaThread * jt = (JavaThread *) Self;
 291   assert(!SafepointSynchronize::is_at_safepoint(), &quot;invariant&quot;);
 292   assert(jt-&gt;thread_state() != _thread_blocked, &quot;invariant&quot;);
 293   assert(AsyncDeflateIdleMonitors || this-&gt;object() != NULL, &quot;invariant&quot;);
 294   assert(AsyncDeflateIdleMonitors || contentions() &gt;= 0, &quot;must not be negative: contentions=%d&quot;, contentions());
 295 
 296   // Keep track of contention for JVM/TI and M&amp;M queries.
 297   add_to_contentions(1);
 298   if (is_being_async_deflated()) {
 299     // Async deflation is in progress and our contentions increment
 300     // above lost the race to async deflation. Undo the work and
 301     // force the caller to retry.
 302     const oop l_object = (oop)object();
 303     if (l_object != NULL) {
 304       // Attempt to restore the header/dmw to the object&#39;s header so that
 305       // we only retry once if the deflater thread happens to be slow.
 306       install_displaced_markword_in_object(l_object);
 307     }
 308     Self-&gt;_Stalled = 0;
 309     add_to_contentions(-1);
 310     return false;
 311   }
 312 
 313   JFR_ONLY(JfrConditionalFlushWithStacktrace&lt;EventJavaMonitorEnter&gt; flush(jt);)
 314   EventJavaMonitorEnter event;
 315   if (event.should_commit()) {
 316     event.set_monitorClass(((oop)this-&gt;object())-&gt;klass());
 317     event.set_address((uintptr_t)(this-&gt;object_addr()));
 318   }
 319 
 320   { // Change java thread status to indicate blocked on monitor enter.
 321     JavaThreadBlockedOnMonitorEnterState jtbmes(jt, this);
 322 
 323     Self-&gt;set_current_pending_monitor(this);
 324 
 325     DTRACE_MONITOR_PROBE(contended__enter, this, object(), jt);
 326     if (JvmtiExport::should_post_monitor_contended_enter()) {
 327       JvmtiExport::post_monitor_contended_enter(jt, this);
 328 
 329       // The current thread does not yet own the monitor and does not
 330       // yet appear on any queues that would get it made the successor.
 331       // This means that the JVMTI_EVENT_MONITOR_CONTENDED_ENTER event
 332       // handler cannot accidentally consume an unpark() meant for the
 333       // ParkEvent associated with this ObjectMonitor.
 334     }
 335 
 336     OSThreadContendState osts(Self-&gt;osthread());
 337     ThreadBlockInVM tbivm(jt);
 338 
 339     // TODO-FIXME: change the following for(;;) loop to straight-line code.
 340     for (;;) {
 341       jt-&gt;set_suspend_equivalent();
 342       // cleared by handle_special_suspend_equivalent_condition()
 343       // or java_suspend_self()
 344 
 345       EnterI(THREAD);
 346 
 347       if (!ExitSuspendEquivalent(jt)) break;
 348 
 349       // We have acquired the contended monitor, but while we were
 350       // waiting another thread suspended us. We don&#39;t want to enter
 351       // the monitor while suspended because that would surprise the
 352       // thread that suspended us.
 353       //
 354       _recursions = 0;
 355       _succ = NULL;
 356       exit(false, Self);
 357 
 358       jt-&gt;java_suspend_self();
 359     }
 360     Self-&gt;set_current_pending_monitor(NULL);
 361 
 362     // We cleared the pending monitor info since we&#39;ve just gotten past
 363     // the enter-check-for-suspend dance and we now own the monitor free
 364     // and clear, i.e., it is no longer pending. The ThreadBlockInVM
 365     // destructor can go to a safepoint at the end of this block. If we
 366     // do a thread dump during that safepoint, then this thread will show
 367     // as having &quot;-locked&quot; the monitor, but the OS and java.lang.Thread
 368     // states will still report that the thread is blocked trying to
 369     // acquire it.
 370   }
 371 
 372   add_to_contentions(-1);
 373   assert(contentions() &gt;= 0, &quot;must not be negative: contentions=%d&quot;, contentions());
 374   Self-&gt;_Stalled = 0;
 375 
 376   // Must either set _recursions = 0 or ASSERT _recursions == 0.
 377   assert(_recursions == 0, &quot;invariant&quot;);
 378   assert(_owner == Self, &quot;invariant&quot;);
 379   assert(_succ != Self, &quot;invariant&quot;);
 380   assert(((oop)(object()))-&gt;mark() == markWord::encode(this), &quot;invariant&quot;);
 381 
 382   // The thread -- now the owner -- is back in vm mode.
 383   // Report the glorious news via TI,DTrace and jvmstat.
 384   // The probe effect is non-trivial.  All the reportage occurs
 385   // while we hold the monitor, increasing the length of the critical
 386   // section.  Amdahl&#39;s parallel speedup law comes vividly into play.
 387   //
 388   // Another option might be to aggregate the events (thread local or
 389   // per-monitor aggregation) and defer reporting until a more opportune
 390   // time -- such as next time some thread encounters contention but has
 391   // yet to acquire the lock.  While spinning that thread could
 392   // spinning we could increment JVMStat counters, etc.
 393 
 394   DTRACE_MONITOR_PROBE(contended__entered, this, object(), jt);
 395   if (JvmtiExport::should_post_monitor_contended_entered()) {
 396     JvmtiExport::post_monitor_contended_entered(jt, this);
 397 
 398     // The current thread already owns the monitor and is not going to
 399     // call park() for the remainder of the monitor enter protocol. So
 400     // it doesn&#39;t matter if the JVMTI_EVENT_MONITOR_CONTENDED_ENTERED
 401     // event handler consumed an unpark() issued by the thread that
 402     // just exited the monitor.
 403   }
 404   if (event.should_commit()) {
 405     event.set_previousOwner((uintptr_t)_previous_owner_tid);
 406     event.commit();
 407   }
 408   OM_PERFDATA_OP(ContendedLockAttempts, inc());
 409   return true;
 410 }
 411 
 412 // Caveat: TryLock() is not necessarily serializing if it returns failure.
 413 // Callers must compensate as needed.
 414 
 415 int ObjectMonitor::TryLock(Thread * Self) {
 416   void * own = _owner;
 417   if (own != NULL) return 0;
 418   if (try_set_owner_from(NULL, Self) == NULL) {
 419     assert(_recursions == 0, &quot;invariant&quot;);
 420     return 1;
 421   }
 422   // The lock had been free momentarily, but we lost the race to the lock.
 423   // Interference -- the CAS failed.
 424   // We can either return -1 or retry.
 425   // Retry doesn&#39;t make as much sense because the lock was just acquired.
 426   return -1;
 427 }
 428 
 429 // Install the displaced mark word (dmw) of a deflating ObjectMonitor
 430 // into the header of the object associated with the monitor. This
 431 // idempotent method is called by a thread that is deflating a
 432 // monitor and by other threads that have detected a race with the
 433 // deflation process.
 434 void ObjectMonitor::install_displaced_markword_in_object(const oop obj) {
 435   // This function must only be called when (owner == DEFLATER_MARKER
 436   // &amp;&amp; contentions &lt;= 0), but we can&#39;t guarantee that here because
 437   // those values could change when the ObjectMonitor gets moved from
 438   // the global free list to a per-thread free list.
 439 
 440   guarantee(obj != NULL, &quot;must be non-NULL&quot;);
 441 
 442   // Separate loads in is_being_async_deflated(), which is almost always
 443   // called before this function, from the load of dmw/header below.
 444   if (support_IRIW_for_not_multiple_copy_atomic_cpu) {
 445     // A non-multiple copy atomic (nMCA) machine needs a bigger
 446     // hammer to separate the loads before and the load below.
 447     OrderAccess::fence();
 448   } else {
 449     OrderAccess::loadload();
 450   }
 451 
 452   const oop l_object = (oop)object();
 453   if (l_object == NULL) {
 454     // ObjectMonitor&#39;s object ref has already been cleared by async
 455     // deflation so we&#39;re done here.
 456     return;
 457   }
 458   ADIM_guarantee(l_object == obj, &quot;object=&quot; INTPTR_FORMAT &quot; must equal obj=&quot;
 459                  INTPTR_FORMAT, p2i(l_object), p2i(obj));
 460 
 461   markWord dmw = header();
 462   // The dmw has to be neutral (not NULL, not locked and not marked).
 463   ADIM_guarantee(dmw.is_neutral(), &quot;must be neutral: dmw=&quot; INTPTR_FORMAT, dmw.value());
 464 
 465   // Install displaced mark word if the object&#39;s header still points
 466   // to this ObjectMonitor. More than one racing caller to this function
 467   // can rarely reach this point, but only one can win.
 468   markWord res = obj-&gt;cas_set_mark(dmw, markWord::encode(this));
 469   if (res != markWord::encode(this)) {
 470     // This should be rare so log at the Info level when it happens.
 471     log_info(monitorinflation)(&quot;install_displaced_markword_in_object: &quot;
 472                                &quot;failed cas_set_mark: new_mark=&quot; INTPTR_FORMAT
 473                                &quot;, old_mark=&quot; INTPTR_FORMAT &quot;, res=&quot; INTPTR_FORMAT,
 474                                dmw.value(), markWord::encode(this).value(),
 475                                res.value());
 476   }
 477 
 478   // Note: It does not matter which thread restored the header/dmw
 479   // into the object&#39;s header. The thread deflating the monitor just
 480   // wanted the object&#39;s header restored and it is. The threads that
 481   // detected a race with the deflation process also wanted the
 482   // object&#39;s header restored before they retry their operation and
 483   // because it is restored they will only retry once.
 484 }
 485 
 486 // Convert the fields used by is_busy() to a string that can be
 487 // used for diagnostic output.
 488 const char* ObjectMonitor::is_busy_to_string(stringStream* ss) {
 489   ss-&gt;print(&quot;is_busy: waiters=%d, &quot;, _waiters);
 490   if (!AsyncDeflateIdleMonitors) {
 491     ss-&gt;print(&quot;contentions=%d, &quot;, contentions());
 492     ss-&gt;print(&quot;owner=&quot; INTPTR_FORMAT, p2i(_owner));
 493   } else {
 494     if (contentions() &gt; 0) {
 495       ss-&gt;print(&quot;contentions=%d, &quot;, contentions());
 496     } else {
 497       ss-&gt;print(&quot;contentions=0&quot;);
 498     }
 499     if (_owner != DEFLATER_MARKER) {
 500       ss-&gt;print(&quot;owner=&quot; INTPTR_FORMAT, p2i(_owner));
 501     } else {
 502       // We report NULL instead of DEFLATER_MARKER here because is_busy()
 503       // ignores DEFLATER_MARKER values.
 504       ss-&gt;print(&quot;owner=&quot; INTPTR_FORMAT, NULL);
 505     }
 506   }
 507   ss-&gt;print(&quot;, cxq=&quot; INTPTR_FORMAT &quot;, EntryList=&quot; INTPTR_FORMAT, p2i(_cxq),
 508             p2i(_EntryList));
 509   return ss-&gt;base();
 510 }
 511 
 512 #define MAX_RECHECK_INTERVAL 1000
 513 
 514 void ObjectMonitor::EnterI(TRAPS) {
 515   Thread * const Self = THREAD;
 516   assert(Self-&gt;is_Java_thread(), &quot;invariant&quot;);
 517   assert(((JavaThread *) Self)-&gt;thread_state() == _thread_blocked, &quot;invariant&quot;);
 518 
 519   // Try the lock - TATAS
 520   if (TryLock (Self) &gt; 0) {
 521     assert(_succ != Self, &quot;invariant&quot;);
 522     assert(_owner == Self, &quot;invariant&quot;);
 523     assert(_Responsible != Self, &quot;invariant&quot;);
 524     return;
 525   }
 526 
 527   if (AsyncDeflateIdleMonitors &amp;&amp;
 528       try_set_owner_from(DEFLATER_MARKER, Self) == DEFLATER_MARKER) {
 529     // Cancelled the in-progress async deflation by changing owner from
 530     // DEFLATER_MARKER to Self. As part of the contended enter protocol,
 531     // contentions was incremented to a positive value before EnterI()
 532     // was called and that prevents the deflater thread from winning the
 533     // last part of the 2-part async deflation protocol. After EnterI()
 534     // returns to enter(), contentions is decremented because the caller
 535     // now owns the monitor. We bump contentions an extra time here to
 536     // prevent the deflater thread from winning the last part of the
 537     // 2-part async deflation protocol after the regular decrement
 538     // occurs in enter(). The deflater thread will decrement contentions
 539     // after it recognizes that the async deflation was cancelled.
 540     add_to_contentions(1);
 541     assert(_succ != Self, &quot;invariant&quot;);
 542     assert(_Responsible != Self, &quot;invariant&quot;);
 543     return;
 544   }
 545 
 546   assert(InitDone, &quot;Unexpectedly not initialized&quot;);
 547 
 548   // We try one round of spinning *before* enqueueing Self.
 549   //
 550   // If the _owner is ready but OFFPROC we could use a YieldTo()
 551   // operation to donate the remainder of this thread&#39;s quantum
 552   // to the owner.  This has subtle but beneficial affinity
 553   // effects.
 554 
 555   if (TrySpin(Self) &gt; 0) {
 556     assert(_owner == Self, &quot;invariant&quot;);
 557     assert(_succ != Self, &quot;invariant&quot;);
 558     assert(_Responsible != Self, &quot;invariant&quot;);
 559     return;
 560   }
 561 
 562   // The Spin failed -- Enqueue and park the thread ...
 563   assert(_succ != Self, &quot;invariant&quot;);
 564   assert(_owner != Self, &quot;invariant&quot;);
 565   assert(_Responsible != Self, &quot;invariant&quot;);
 566 
 567   // Enqueue &quot;Self&quot; on ObjectMonitor&#39;s _cxq.
 568   //
 569   // Node acts as a proxy for Self.
 570   // As an aside, if were to ever rewrite the synchronization code mostly
 571   // in Java, WaitNodes, ObjectMonitors, and Events would become 1st-class
 572   // Java objects.  This would avoid awkward lifecycle and liveness issues,
 573   // as well as eliminate a subset of ABA issues.
 574   // TODO: eliminate ObjectWaiter and enqueue either Threads or Events.
 575 
 576   ObjectWaiter node(Self);
 577   Self-&gt;_ParkEvent-&gt;reset();
 578   node._prev   = (ObjectWaiter *) 0xBAD;
 579   node.TState  = ObjectWaiter::TS_CXQ;
 580 
 581   // Push &quot;Self&quot; onto the front of the _cxq.
 582   // Once on cxq/EntryList, Self stays on-queue until it acquires the lock.
 583   // Note that spinning tends to reduce the rate at which threads
 584   // enqueue and dequeue on EntryList|cxq.
 585   ObjectWaiter * nxt;
 586   for (;;) {
 587     node._next = nxt = _cxq;
 588     if (Atomic::cmpxchg(&amp;_cxq, nxt, &amp;node) == nxt) break;
 589 
 590     // Interference - the CAS failed because _cxq changed.  Just retry.
 591     // As an optional optimization we retry the lock.
 592     if (TryLock (Self) &gt; 0) {
 593       assert(_succ != Self, &quot;invariant&quot;);
 594       assert(_owner == Self, &quot;invariant&quot;);
 595       assert(_Responsible != Self, &quot;invariant&quot;);
 596       return;
 597     }
 598   }
 599 
 600   // Check for cxq|EntryList edge transition to non-null.  This indicates
 601   // the onset of contention.  While contention persists exiting threads
 602   // will use a ST:MEMBAR:LD 1-1 exit protocol.  When contention abates exit
 603   // operations revert to the faster 1-0 mode.  This enter operation may interleave
 604   // (race) a concurrent 1-0 exit operation, resulting in stranding, so we
 605   // arrange for one of the contending thread to use a timed park() operations
 606   // to detect and recover from the race.  (Stranding is form of progress failure
 607   // where the monitor is unlocked but all the contending threads remain parked).
 608   // That is, at least one of the contended threads will periodically poll _owner.
 609   // One of the contending threads will become the designated &quot;Responsible&quot; thread.
 610   // The Responsible thread uses a timed park instead of a normal indefinite park
 611   // operation -- it periodically wakes and checks for and recovers from potential
 612   // strandings admitted by 1-0 exit operations.   We need at most one Responsible
 613   // thread per-monitor at any given moment.  Only threads on cxq|EntryList may
 614   // be responsible for a monitor.
 615   //
 616   // Currently, one of the contended threads takes on the added role of &quot;Responsible&quot;.
 617   // A viable alternative would be to use a dedicated &quot;stranding checker&quot; thread
 618   // that periodically iterated over all the threads (or active monitors) and unparked
 619   // successors where there was risk of stranding.  This would help eliminate the
 620   // timer scalability issues we see on some platforms as we&#39;d only have one thread
 621   // -- the checker -- parked on a timer.
 622 
 623   if (nxt == NULL &amp;&amp; _EntryList == NULL) {
 624     // Try to assume the role of responsible thread for the monitor.
 625     // CONSIDER:  ST vs CAS vs { if (Responsible==null) Responsible=Self }
 626     Atomic::replace_if_null(&amp;_Responsible, Self);
 627   }
 628 
 629   // The lock might have been released while this thread was occupied queueing
 630   // itself onto _cxq.  To close the race and avoid &quot;stranding&quot; and
 631   // progress-liveness failure we must resample-retry _owner before parking.
 632   // Note the Dekker/Lamport duality: ST cxq; MEMBAR; LD Owner.
 633   // In this case the ST-MEMBAR is accomplished with CAS().
 634   //
 635   // TODO: Defer all thread state transitions until park-time.
 636   // Since state transitions are heavy and inefficient we&#39;d like
 637   // to defer the state transitions until absolutely necessary,
 638   // and in doing so avoid some transitions ...
 639 
 640   int nWakeups = 0;
 641   int recheckInterval = 1;
 642 
 643   for (;;) {
 644 
 645     if (TryLock(Self) &gt; 0) break;
 646     assert(_owner != Self, &quot;invariant&quot;);
 647 
 648     // park self
 649     if (_Responsible == Self) {
 650       Self-&gt;_ParkEvent-&gt;park((jlong) recheckInterval);
 651       // Increase the recheckInterval, but clamp the value.
 652       recheckInterval *= 8;
 653       if (recheckInterval &gt; MAX_RECHECK_INTERVAL) {
 654         recheckInterval = MAX_RECHECK_INTERVAL;
 655       }
 656     } else {
 657       Self-&gt;_ParkEvent-&gt;park();
 658     }
 659 
 660     if (TryLock(Self) &gt; 0) break;
 661 
 662     if (AsyncDeflateIdleMonitors &amp;&amp;
 663         try_set_owner_from(DEFLATER_MARKER, Self) == DEFLATER_MARKER) {
 664       // Cancelled the in-progress async deflation by changing owner from
 665       // DEFLATER_MARKER to Self. As part of the contended enter protocol,
 666       // contentions was incremented to a positive value before EnterI()
 667       // was called and that prevents the deflater thread from winning the
 668       // last part of the 2-part async deflation protocol. After EnterI()
 669       // returns to enter(), contentions is decremented because the caller
 670       // now owns the monitor. We bump contentions an extra time here to
 671       // prevent the deflater thread from winning the last part of the
 672       // 2-part async deflation protocol after the regular decrement
 673       // occurs in enter(). The deflater thread will decrement contentions
 674       // after it recognizes that the async deflation was cancelled.
 675       add_to_contentions(1);
 676       break;
 677     }
 678 
 679     // The lock is still contested.
 680     // Keep a tally of the # of futile wakeups.
 681     // Note that the counter is not protected by a lock or updated by atomics.
 682     // That is by design - we trade &quot;lossy&quot; counters which are exposed to
 683     // races during updates for a lower probe effect.
 684 
 685     // This PerfData object can be used in parallel with a safepoint.
 686     // See the work around in PerfDataManager::destroy().
 687     OM_PERFDATA_OP(FutileWakeups, inc());
 688     ++nWakeups;
 689 
 690     // Assuming this is not a spurious wakeup we&#39;ll normally find _succ == Self.
 691     // We can defer clearing _succ until after the spin completes
 692     // TrySpin() must tolerate being called with _succ == Self.
 693     // Try yet another round of adaptive spinning.
 694     if (TrySpin(Self) &gt; 0) break;
 695 
 696     // We can find that we were unpark()ed and redesignated _succ while
 697     // we were spinning.  That&#39;s harmless.  If we iterate and call park(),
 698     // park() will consume the event and return immediately and we&#39;ll
 699     // just spin again.  This pattern can repeat, leaving _succ to simply
 700     // spin on a CPU.
 701 
 702     if (_succ == Self) _succ = NULL;
 703 
 704     // Invariant: after clearing _succ a thread *must* retry _owner before parking.
 705     OrderAccess::fence();
 706   }
 707 
 708   // Egress :
 709   // Self has acquired the lock -- Unlink Self from the cxq or EntryList.
 710   // Normally we&#39;ll find Self on the EntryList .
 711   // From the perspective of the lock owner (this thread), the
 712   // EntryList is stable and cxq is prepend-only.
 713   // The head of cxq is volatile but the interior is stable.
 714   // In addition, Self.TState is stable.
 715 
 716   assert(_owner == Self, &quot;invariant&quot;);
 717   assert(object() != NULL, &quot;invariant&quot;);
 718   // I&#39;d like to write:
 719   //   guarantee (((oop)(object()))-&gt;mark() == markWord::encode(this), &quot;invariant&quot;) ;
 720   // but as we&#39;re at a safepoint that&#39;s not safe.
 721 
 722   UnlinkAfterAcquire(Self, &amp;node);
 723   if (_succ == Self) _succ = NULL;
 724 
 725   assert(_succ != Self, &quot;invariant&quot;);
 726   if (_Responsible == Self) {
 727     _Responsible = NULL;
 728     OrderAccess::fence(); // Dekker pivot-point
 729 
 730     // We may leave threads on cxq|EntryList without a designated
 731     // &quot;Responsible&quot; thread.  This is benign.  When this thread subsequently
 732     // exits the monitor it can &quot;see&quot; such preexisting &quot;old&quot; threads --
 733     // threads that arrived on the cxq|EntryList before the fence, above --
 734     // by LDing cxq|EntryList.  Newly arrived threads -- that is, threads
 735     // that arrive on cxq after the ST:MEMBAR, above -- will set Responsible
 736     // non-null and elect a new &quot;Responsible&quot; timer thread.
 737     //
 738     // This thread executes:
 739     //    ST Responsible=null; MEMBAR    (in enter epilogue - here)
 740     //    LD cxq|EntryList               (in subsequent exit)
 741     //
 742     // Entering threads in the slow/contended path execute:
 743     //    ST cxq=nonnull; MEMBAR; LD Responsible (in enter prolog)
 744     //    The (ST cxq; MEMBAR) is accomplished with CAS().
 745     //
 746     // The MEMBAR, above, prevents the LD of cxq|EntryList in the subsequent
 747     // exit operation from floating above the ST Responsible=null.
 748   }
 749 
 750   // We&#39;ve acquired ownership with CAS().
 751   // CAS is serializing -- it has MEMBAR/FENCE-equivalent semantics.
 752   // But since the CAS() this thread may have also stored into _succ,
 753   // EntryList, cxq or Responsible.  These meta-data updates must be
 754   // visible __before this thread subsequently drops the lock.
 755   // Consider what could occur if we didn&#39;t enforce this constraint --
 756   // STs to monitor meta-data and user-data could reorder with (become
 757   // visible after) the ST in exit that drops ownership of the lock.
 758   // Some other thread could then acquire the lock, but observe inconsistent
 759   // or old monitor meta-data and heap data.  That violates the JMM.
 760   // To that end, the 1-0 exit() operation must have at least STST|LDST
 761   // &quot;release&quot; barrier semantics.  Specifically, there must be at least a
 762   // STST|LDST barrier in exit() before the ST of null into _owner that drops
 763   // the lock.   The barrier ensures that changes to monitor meta-data and data
 764   // protected by the lock will be visible before we release the lock, and
 765   // therefore before some other thread (CPU) has a chance to acquire the lock.
 766   // See also: http://gee.cs.oswego.edu/dl/jmm/cookbook.html.
 767   //
 768   // Critically, any prior STs to _succ or EntryList must be visible before
 769   // the ST of null into _owner in the *subsequent* (following) corresponding
 770   // monitorexit.  Recall too, that in 1-0 mode monitorexit does not necessarily
 771   // execute a serializing instruction.
 772 
 773   return;
 774 }
 775 
 776 // ReenterI() is a specialized inline form of the latter half of the
 777 // contended slow-path from EnterI().  We use ReenterI() only for
 778 // monitor reentry in wait().
 779 //
 780 // In the future we should reconcile EnterI() and ReenterI().
 781 
 782 void ObjectMonitor::ReenterI(Thread * Self, ObjectWaiter * SelfNode) {
 783   assert(Self != NULL, &quot;invariant&quot;);
 784   assert(SelfNode != NULL, &quot;invariant&quot;);
 785   assert(SelfNode-&gt;_thread == Self, &quot;invariant&quot;);
 786   assert(_waiters &gt; 0, &quot;invariant&quot;);
 787   assert(((oop)(object()))-&gt;mark() == markWord::encode(this), &quot;invariant&quot;);
 788   assert(((JavaThread *)Self)-&gt;thread_state() != _thread_blocked, &quot;invariant&quot;);
 789   JavaThread * jt = (JavaThread *) Self;
 790 
 791   int nWakeups = 0;
 792   for (;;) {
 793     ObjectWaiter::TStates v = SelfNode-&gt;TState;
 794     guarantee(v == ObjectWaiter::TS_ENTER || v == ObjectWaiter::TS_CXQ, &quot;invariant&quot;);
 795     assert(_owner != Self, &quot;invariant&quot;);
 796 
 797     if (TryLock(Self) &gt; 0) break;
 798     if (TrySpin(Self) &gt; 0) break;
 799 
 800     // State transition wrappers around park() ...
 801     // ReenterI() wisely defers state transitions until
 802     // it&#39;s clear we must park the thread.
 803     {
 804       OSThreadContendState osts(Self-&gt;osthread());
 805       ThreadBlockInVM tbivm(jt);
 806 
 807       // cleared by handle_special_suspend_equivalent_condition()
 808       // or java_suspend_self()
 809       jt-&gt;set_suspend_equivalent();
 810       Self-&gt;_ParkEvent-&gt;park();
 811 
 812       // were we externally suspended while we were waiting?
 813       for (;;) {
 814         if (!ExitSuspendEquivalent(jt)) break;
 815         if (_succ == Self) { _succ = NULL; OrderAccess::fence(); }
 816         jt-&gt;java_suspend_self();
 817         jt-&gt;set_suspend_equivalent();
 818       }
 819     }
 820 
 821     // Try again, but just so we distinguish between futile wakeups and
 822     // successful wakeups.  The following test isn&#39;t algorithmically
 823     // necessary, but it helps us maintain sensible statistics.
 824     if (TryLock(Self) &gt; 0) break;
 825 
 826     // The lock is still contested.
 827     // Keep a tally of the # of futile wakeups.
 828     // Note that the counter is not protected by a lock or updated by atomics.
 829     // That is by design - we trade &quot;lossy&quot; counters which are exposed to
 830     // races during updates for a lower probe effect.
 831     ++nWakeups;
 832 
 833     // Assuming this is not a spurious wakeup we&#39;ll normally
 834     // find that _succ == Self.
 835     if (_succ == Self) _succ = NULL;
 836 
 837     // Invariant: after clearing _succ a contending thread
 838     // *must* retry  _owner before parking.
 839     OrderAccess::fence();
 840 
 841     // This PerfData object can be used in parallel with a safepoint.
 842     // See the work around in PerfDataManager::destroy().
 843     OM_PERFDATA_OP(FutileWakeups, inc());
 844   }
 845 
 846   // Self has acquired the lock -- Unlink Self from the cxq or EntryList .
 847   // Normally we&#39;ll find Self on the EntryList.
 848   // Unlinking from the EntryList is constant-time and atomic-free.
 849   // From the perspective of the lock owner (this thread), the
 850   // EntryList is stable and cxq is prepend-only.
 851   // The head of cxq is volatile but the interior is stable.
 852   // In addition, Self.TState is stable.
 853 
 854   assert(_owner == Self, &quot;invariant&quot;);
 855   assert(((oop)(object()))-&gt;mark() == markWord::encode(this), &quot;invariant&quot;);
 856   UnlinkAfterAcquire(Self, SelfNode);
 857   if (_succ == Self) _succ = NULL;
 858   assert(_succ != Self, &quot;invariant&quot;);
 859   SelfNode-&gt;TState = ObjectWaiter::TS_RUN;
 860   OrderAccess::fence();      // see comments at the end of EnterI()
 861 }
 862 
 863 // By convention we unlink a contending thread from EntryList|cxq immediately
 864 // after the thread acquires the lock in ::enter().  Equally, we could defer
 865 // unlinking the thread until ::exit()-time.
 866 
 867 void ObjectMonitor::UnlinkAfterAcquire(Thread *Self, ObjectWaiter *SelfNode) {
 868   assert(_owner == Self, &quot;invariant&quot;);
 869   assert(SelfNode-&gt;_thread == Self, &quot;invariant&quot;);
 870 
 871   if (SelfNode-&gt;TState == ObjectWaiter::TS_ENTER) {
 872     // Normal case: remove Self from the DLL EntryList .
 873     // This is a constant-time operation.
 874     ObjectWaiter * nxt = SelfNode-&gt;_next;
 875     ObjectWaiter * prv = SelfNode-&gt;_prev;
 876     if (nxt != NULL) nxt-&gt;_prev = prv;
 877     if (prv != NULL) prv-&gt;_next = nxt;
 878     if (SelfNode == _EntryList) _EntryList = nxt;
 879     assert(nxt == NULL || nxt-&gt;TState == ObjectWaiter::TS_ENTER, &quot;invariant&quot;);
 880     assert(prv == NULL || prv-&gt;TState == ObjectWaiter::TS_ENTER, &quot;invariant&quot;);
 881   } else {
 882     assert(SelfNode-&gt;TState == ObjectWaiter::TS_CXQ, &quot;invariant&quot;);
 883     // Inopportune interleaving -- Self is still on the cxq.
 884     // This usually means the enqueue of self raced an exiting thread.
 885     // Normally we&#39;ll find Self near the front of the cxq, so
 886     // dequeueing is typically fast.  If needbe we can accelerate
 887     // this with some MCS/CHL-like bidirectional list hints and advisory
 888     // back-links so dequeueing from the interior will normally operate
 889     // in constant-time.
 890     // Dequeue Self from either the head (with CAS) or from the interior
 891     // with a linear-time scan and normal non-atomic memory operations.
 892     // CONSIDER: if Self is on the cxq then simply drain cxq into EntryList
 893     // and then unlink Self from EntryList.  We have to drain eventually,
 894     // so it might as well be now.
 895 
 896     ObjectWaiter * v = _cxq;
 897     assert(v != NULL, &quot;invariant&quot;);
 898     if (v != SelfNode || Atomic::cmpxchg(&amp;_cxq, v, SelfNode-&gt;_next) != v) {
 899       // The CAS above can fail from interference IFF a &quot;RAT&quot; arrived.
 900       // In that case Self must be in the interior and can no longer be
 901       // at the head of cxq.
 902       if (v == SelfNode) {
 903         assert(_cxq != v, &quot;invariant&quot;);
 904         v = _cxq;          // CAS above failed - start scan at head of list
 905       }
 906       ObjectWaiter * p;
 907       ObjectWaiter * q = NULL;
 908       for (p = v; p != NULL &amp;&amp; p != SelfNode; p = p-&gt;_next) {
 909         q = p;
 910         assert(p-&gt;TState == ObjectWaiter::TS_CXQ, &quot;invariant&quot;);
 911       }
 912       assert(v != SelfNode, &quot;invariant&quot;);
 913       assert(p == SelfNode, &quot;Node not found on cxq&quot;);
 914       assert(p != _cxq, &quot;invariant&quot;);
 915       assert(q != NULL, &quot;invariant&quot;);
 916       assert(q-&gt;_next == p, &quot;invariant&quot;);
 917       q-&gt;_next = p-&gt;_next;
 918     }
 919   }
 920 
 921 #ifdef ASSERT
 922   // Diagnostic hygiene ...
 923   SelfNode-&gt;_prev  = (ObjectWaiter *) 0xBAD;
 924   SelfNode-&gt;_next  = (ObjectWaiter *) 0xBAD;
 925   SelfNode-&gt;TState = ObjectWaiter::TS_RUN;
 926 #endif
 927 }
 928 
 929 // -----------------------------------------------------------------------------
 930 // Exit support
 931 //
 932 // exit()
 933 // ~~~~~~
 934 // Note that the collector can&#39;t reclaim the objectMonitor or deflate
 935 // the object out from underneath the thread calling ::exit() as the
 936 // thread calling ::exit() never transitions to a stable state.
 937 // This inhibits GC, which in turn inhibits asynchronous (and
 938 // inopportune) reclamation of &quot;this&quot;.
 939 //
 940 // We&#39;d like to assert that: (THREAD-&gt;thread_state() != _thread_blocked) ;
 941 // There&#39;s one exception to the claim above, however.  EnterI() can call
 942 // exit() to drop a lock if the acquirer has been externally suspended.
 943 // In that case exit() is called with _thread_state == _thread_blocked,
 944 // but the monitor&#39;s _contentions field is &gt; 0, which inhibits reclamation.
 945 //
 946 // 1-0 exit
 947 // ~~~~~~~~
 948 // ::exit() uses a canonical 1-1 idiom with a MEMBAR although some of
 949 // the fast-path operators have been optimized so the common ::exit()
 950 // operation is 1-0, e.g., see macroAssembler_x86.cpp: fast_unlock().
 951 // The code emitted by fast_unlock() elides the usual MEMBAR.  This
 952 // greatly improves latency -- MEMBAR and CAS having considerable local
 953 // latency on modern processors -- but at the cost of &quot;stranding&quot;.  Absent the
 954 // MEMBAR, a thread in fast_unlock() can race a thread in the slow
 955 // ::enter() path, resulting in the entering thread being stranding
 956 // and a progress-liveness failure.   Stranding is extremely rare.
 957 // We use timers (timed park operations) &amp; periodic polling to detect
 958 // and recover from stranding.  Potentially stranded threads periodically
 959 // wake up and poll the lock.  See the usage of the _Responsible variable.
 960 //
 961 // The CAS() in enter provides for safety and exclusion, while the CAS or
 962 // MEMBAR in exit provides for progress and avoids stranding.  1-0 locking
 963 // eliminates the CAS/MEMBAR from the exit path, but it admits stranding.
 964 // We detect and recover from stranding with timers.
 965 //
 966 // If a thread transiently strands it&#39;ll park until (a) another
 967 // thread acquires the lock and then drops the lock, at which time the
 968 // exiting thread will notice and unpark the stranded thread, or, (b)
 969 // the timer expires.  If the lock is high traffic then the stranding latency
 970 // will be low due to (a).  If the lock is low traffic then the odds of
 971 // stranding are lower, although the worst-case stranding latency
 972 // is longer.  Critically, we don&#39;t want to put excessive load in the
 973 // platform&#39;s timer subsystem.  We want to minimize both the timer injection
 974 // rate (timers created/sec) as well as the number of timers active at
 975 // any one time.  (more precisely, we want to minimize timer-seconds, which is
 976 // the integral of the # of active timers at any instant over time).
 977 // Both impinge on OS scalability.  Given that, at most one thread parked on
 978 // a monitor will use a timer.
 979 //
 980 // There is also the risk of a futile wake-up. If we drop the lock
 981 // another thread can reacquire the lock immediately, and we can
 982 // then wake a thread unnecessarily. This is benign, and we&#39;ve
 983 // structured the code so the windows are short and the frequency
 984 // of such futile wakups is low.
 985 
 986 void ObjectMonitor::exit(bool not_suspended, TRAPS) {
 987   Thread* const Self = THREAD;
 988   void* cur = Atomic::load(&amp;_owner);
 989   if (THREAD != cur) {
 990     if (THREAD-&gt;is_lock_owned((address)cur)) {
 991       assert(_recursions == 0, &quot;invariant&quot;);
 992       set_owner_from_BasicLock(cur, Self);  // Convert from BasicLock* to Thread*.
 993       _recursions = 0;
 994     } else {
 995       // Apparent unbalanced locking ...
 996       // Naively we&#39;d like to throw IllegalMonitorStateException.
 997       // As a practical matter we can neither allocate nor throw an
 998       // exception as ::exit() can be called from leaf routines.
 999       // see x86_32.ad Fast_Unlock() and the I1 and I2 properties.
1000       // Upon deeper reflection, however, in a properly run JVM the only
1001       // way we should encounter this situation is in the presence of
1002       // unbalanced JNI locking. TODO: CheckJNICalls.
1003       // See also: CR4414101
1004 #ifdef ASSERT
1005       LogStreamHandle(Error, monitorinflation) lsh;
1006       lsh.print_cr(&quot;ERROR: ObjectMonitor::exit(): thread=&quot; INTPTR_FORMAT
1007                     &quot; is exiting an ObjectMonitor it does not own.&quot;, p2i(THREAD));
1008       lsh.print_cr(&quot;The imbalance is possibly caused by JNI locking.&quot;);
1009       print_debug_style_on(&amp;lsh);
1010 #endif
1011       assert(false, &quot;Non-balanced monitor enter/exit!&quot;);
1012       return;
1013     }
1014   }
1015 
1016   if (_recursions != 0) {
1017     _recursions--;        // this is simple recursive enter
1018     return;
1019   }
1020 
1021   // Invariant: after setting Responsible=null an thread must execute
1022   // a MEMBAR or other serializing instruction before fetching EntryList|cxq.
1023   _Responsible = NULL;
1024 
1025 #if INCLUDE_JFR
1026   // get the owner&#39;s thread id for the MonitorEnter event
1027   // if it is enabled and the thread isn&#39;t suspended
1028   if (not_suspended &amp;&amp; EventJavaMonitorEnter::is_enabled()) {
1029     _previous_owner_tid = JFR_THREAD_ID(Self);
1030   }
1031 #endif
1032 
1033   for (;;) {
1034     assert(THREAD == _owner, &quot;invariant&quot;);
1035 
1036     // Drop the lock.
1037     // release semantics: prior loads and stores from within the critical section
1038     // must not float (reorder) past the following store that drops the lock.
1039     // Uses a storeload to separate release_store(owner) from the
1040     // successor check. The try_set_owner() below uses cmpxchg() so
1041     // we get the fence down there.
1042     release_clear_owner(Self);
1043     OrderAccess::storeload();
1044 
1045     if ((intptr_t(_EntryList)|intptr_t(_cxq)) == 0 || _succ != NULL) {
1046       return;
1047     }
1048     // Other threads are blocked trying to acquire the lock.
1049 
1050     // Normally the exiting thread is responsible for ensuring succession,
1051     // but if other successors are ready or other entering threads are spinning
1052     // then this thread can simply store NULL into _owner and exit without
1053     // waking a successor.  The existence of spinners or ready successors
1054     // guarantees proper succession (liveness).  Responsibility passes to the
1055     // ready or running successors.  The exiting thread delegates the duty.
1056     // More precisely, if a successor already exists this thread is absolved
1057     // of the responsibility of waking (unparking) one.
1058     //
1059     // The _succ variable is critical to reducing futile wakeup frequency.
1060     // _succ identifies the &quot;heir presumptive&quot; thread that has been made
1061     // ready (unparked) but that has not yet run.  We need only one such
1062     // successor thread to guarantee progress.
1063     // See http://www.usenix.org/events/jvm01/full_papers/dice/dice.pdf
1064     // section 3.3 &quot;Futile Wakeup Throttling&quot; for details.
1065     //
1066     // Note that spinners in Enter() also set _succ non-null.
1067     // In the current implementation spinners opportunistically set
1068     // _succ so that exiting threads might avoid waking a successor.
1069     // Another less appealing alternative would be for the exiting thread
1070     // to drop the lock and then spin briefly to see if a spinner managed
1071     // to acquire the lock.  If so, the exiting thread could exit
1072     // immediately without waking a successor, otherwise the exiting
1073     // thread would need to dequeue and wake a successor.
1074     // (Note that we&#39;d need to make the post-drop spin short, but no
1075     // shorter than the worst-case round-trip cache-line migration time.
1076     // The dropped lock needs to become visible to the spinner, and then
1077     // the acquisition of the lock by the spinner must become visible to
1078     // the exiting thread).
1079 
1080     // It appears that an heir-presumptive (successor) must be made ready.
1081     // Only the current lock owner can manipulate the EntryList or
1082     // drain _cxq, so we need to reacquire the lock.  If we fail
1083     // to reacquire the lock the responsibility for ensuring succession
1084     // falls to the new owner.
1085     //
1086     if (try_set_owner_from(NULL, Self) != NULL) {
1087       return;
1088     }
1089 
1090     guarantee(_owner == THREAD, &quot;invariant&quot;);
1091 
1092     ObjectWaiter * w = NULL;
1093 
1094     w = _EntryList;
1095     if (w != NULL) {
1096       // I&#39;d like to write: guarantee (w-&gt;_thread != Self).
1097       // But in practice an exiting thread may find itself on the EntryList.
1098       // Let&#39;s say thread T1 calls O.wait().  Wait() enqueues T1 on O&#39;s waitset and
1099       // then calls exit().  Exit release the lock by setting O._owner to NULL.
1100       // Let&#39;s say T1 then stalls.  T2 acquires O and calls O.notify().  The
1101       // notify() operation moves T1 from O&#39;s waitset to O&#39;s EntryList. T2 then
1102       // release the lock &quot;O&quot;.  T2 resumes immediately after the ST of null into
1103       // _owner, above.  T2 notices that the EntryList is populated, so it
1104       // reacquires the lock and then finds itself on the EntryList.
1105       // Given all that, we have to tolerate the circumstance where &quot;w&quot; is
1106       // associated with Self.
1107       assert(w-&gt;TState == ObjectWaiter::TS_ENTER, &quot;invariant&quot;);
1108       ExitEpilog(Self, w);
1109       return;
1110     }
1111 
1112     // If we find that both _cxq and EntryList are null then just
1113     // re-run the exit protocol from the top.
1114     w = _cxq;
1115     if (w == NULL) continue;
1116 
1117     // Drain _cxq into EntryList - bulk transfer.
1118     // First, detach _cxq.
1119     // The following loop is tantamount to: w = swap(&amp;cxq, NULL)
1120     for (;;) {
1121       assert(w != NULL, &quot;Invariant&quot;);
1122       ObjectWaiter * u = Atomic::cmpxchg(&amp;_cxq, w, (ObjectWaiter*)NULL);
1123       if (u == w) break;
1124       w = u;
1125     }
1126 
1127     assert(w != NULL, &quot;invariant&quot;);
1128     assert(_EntryList == NULL, &quot;invariant&quot;);
1129 
1130     // Convert the LIFO SLL anchored by _cxq into a DLL.
1131     // The list reorganization step operates in O(LENGTH(w)) time.
1132     // It&#39;s critical that this step operate quickly as
1133     // &quot;Self&quot; still holds the outer-lock, restricting parallelism
1134     // and effectively lengthening the critical section.
1135     // Invariant: s chases t chases u.
1136     // TODO-FIXME: consider changing EntryList from a DLL to a CDLL so
1137     // we have faster access to the tail.
1138 
1139     _EntryList = w;
1140     ObjectWaiter * q = NULL;
1141     ObjectWaiter * p;
1142     for (p = w; p != NULL; p = p-&gt;_next) {
1143       guarantee(p-&gt;TState == ObjectWaiter::TS_CXQ, &quot;Invariant&quot;);
1144       p-&gt;TState = ObjectWaiter::TS_ENTER;
1145       p-&gt;_prev = q;
1146       q = p;
1147     }
1148 
1149     // In 1-0 mode we need: ST EntryList; MEMBAR #storestore; ST _owner = NULL
1150     // The MEMBAR is satisfied by the release_store() operation in ExitEpilog().
1151 
1152     // See if we can abdicate to a spinner instead of waking a thread.
1153     // A primary goal of the implementation is to reduce the
1154     // context-switch rate.
1155     if (_succ != NULL) continue;
1156 
1157     w = _EntryList;
1158     if (w != NULL) {
1159       guarantee(w-&gt;TState == ObjectWaiter::TS_ENTER, &quot;invariant&quot;);
1160       ExitEpilog(Self, w);
1161       return;
1162     }
1163   }
1164 }
1165 
1166 // ExitSuspendEquivalent:
1167 // A faster alternate to handle_special_suspend_equivalent_condition()
1168 //
1169 // handle_special_suspend_equivalent_condition() unconditionally
1170 // acquires the SR_lock.  On some platforms uncontended MutexLocker()
1171 // operations have high latency.  Note that in ::enter() we call HSSEC
1172 // while holding the monitor, so we effectively lengthen the critical sections.
1173 //
1174 // There are a number of possible solutions:
1175 //
1176 // A.  To ameliorate the problem we might also defer state transitions
1177 //     to as late as possible -- just prior to parking.
1178 //     Given that, we&#39;d call HSSEC after having returned from park(),
1179 //     but before attempting to acquire the monitor.  This is only a
1180 //     partial solution.  It avoids calling HSSEC while holding the
1181 //     monitor (good), but it still increases successor reacquisition latency --
1182 //     the interval between unparking a successor and the time the successor
1183 //     resumes and retries the lock.  See ReenterI(), which defers state transitions.
1184 //     If we use this technique we can also avoid EnterI()-exit() loop
1185 //     in ::enter() where we iteratively drop the lock and then attempt
1186 //     to reacquire it after suspending.
1187 //
1188 // B.  In the future we might fold all the suspend bits into a
1189 //     composite per-thread suspend flag and then update it with CAS().
1190 //     Alternately, a Dekker-like mechanism with multiple variables
1191 //     would suffice:
1192 //       ST Self-&gt;_suspend_equivalent = false
1193 //       MEMBAR
1194 //       LD Self_&gt;_suspend_flags
1195 
1196 bool ObjectMonitor::ExitSuspendEquivalent(JavaThread * jSelf) {
1197   return jSelf-&gt;handle_special_suspend_equivalent_condition();
1198 }
1199 
1200 
1201 void ObjectMonitor::ExitEpilog(Thread * Self, ObjectWaiter * Wakee) {
1202   assert(_owner == Self, &quot;invariant&quot;);
1203 
1204   // Exit protocol:
1205   // 1. ST _succ = wakee
1206   // 2. membar #loadstore|#storestore;
1207   // 2. ST _owner = NULL
1208   // 3. unpark(wakee)
1209 
1210   _succ = Wakee-&gt;_thread;
1211   ParkEvent * Trigger = Wakee-&gt;_event;
1212 
1213   // Hygiene -- once we&#39;ve set _owner = NULL we can&#39;t safely dereference Wakee again.
1214   // The thread associated with Wakee may have grabbed the lock and &quot;Wakee&quot; may be
1215   // out-of-scope (non-extant).
1216   Wakee  = NULL;
1217 
1218   // Drop the lock.
1219   // Uses a fence to separate release_store(owner) from the LD in unpark().
1220   release_clear_owner(Self);
1221   OrderAccess::fence();
1222 
1223   DTRACE_MONITOR_PROBE(contended__exit, this, object(), Self);
1224   Trigger-&gt;unpark();
1225 
1226   // Maintain stats and report events to JVMTI
1227   OM_PERFDATA_OP(Parks, inc());
1228 }
1229 
1230 
1231 // -----------------------------------------------------------------------------
1232 // Class Loader deadlock handling.
1233 //
1234 // complete_exit exits a lock returning recursion count
1235 // complete_exit/reenter operate as a wait without waiting
1236 // complete_exit requires an inflated monitor
1237 // The _owner field is not always the Thread addr even with an
1238 // inflated monitor, e.g. the monitor can be inflated by a non-owning
1239 // thread due to contention.
1240 intx ObjectMonitor::complete_exit(TRAPS) {
1241   Thread * const Self = THREAD;
1242   assert(Self-&gt;is_Java_thread(), &quot;Must be Java thread!&quot;);
1243   JavaThread *jt = (JavaThread *)THREAD;
1244 
1245   assert(InitDone, &quot;Unexpectedly not initialized&quot;);
1246 
1247   void* cur = Atomic::load(&amp;_owner);
1248   if (THREAD != cur) {
1249     if (THREAD-&gt;is_lock_owned((address)cur)) {
1250       assert(_recursions == 0, &quot;internal state error&quot;);
1251       set_owner_from_BasicLock(cur, Self);  // Convert from BasicLock* to Thread*.
1252       _recursions = 0;
1253     }
1254   }
1255 
1256   guarantee(Self == _owner, &quot;complete_exit not owner&quot;);
1257   intx save = _recursions; // record the old recursion count
1258   _recursions = 0;        // set the recursion level to be 0
1259   exit(true, Self);           // exit the monitor
1260   guarantee(_owner != Self, &quot;invariant&quot;);
1261   return save;
1262 }
1263 
1264 // reenter() enters a lock and sets recursion count
1265 // complete_exit/reenter operate as a wait without waiting
1266 bool ObjectMonitor::reenter(intx recursions, TRAPS) {
1267   Thread * const Self = THREAD;
1268   assert(Self-&gt;is_Java_thread(), &quot;Must be Java thread!&quot;);
1269   JavaThread *jt = (JavaThread *)THREAD;
1270 
1271   guarantee(_owner != Self, &quot;reenter already owner&quot;);
1272   if (!enter(THREAD)) {
1273     return false;
1274   }
1275   // Entered the monitor.
1276   guarantee(_recursions == 0, &quot;reenter recursion&quot;);
1277   _recursions = recursions;
1278   return true;
1279 }
1280 
1281 // Checks that the current THREAD owns this monitor and causes an
1282 // immediate return if it doesn&#39;t. We don&#39;t use the CHECK macro
1283 // because we want the IMSE to be the only exception that is thrown
1284 // from the call site when false is returned. Any other pending
1285 // exception is ignored.
1286 #define CHECK_OWNER()                                                  \
1287   do {                                                                 \
1288     if (!check_owner(THREAD)) {                                        \
1289        assert(HAS_PENDING_EXCEPTION, &quot;expected a pending IMSE here.&quot;); \
1290        return;                                                         \
1291      }                                                                 \
1292   } while (false)
1293 
1294 // Returns true if the specified thread owns the ObjectMonitor.
1295 // Otherwise returns false and throws IllegalMonitorStateException
1296 // (IMSE). If there is a pending exception and the specified thread
1297 // is not the owner, that exception will be replaced by the IMSE.
1298 bool ObjectMonitor::check_owner(Thread* THREAD) {
1299   void* cur = Atomic::load(&amp;_owner);
1300   if (cur == THREAD) {
1301     return true;
1302   }
1303   if (THREAD-&gt;is_lock_owned((address)cur)) {
1304     set_owner_from_BasicLock(cur, THREAD);  // Convert from BasicLock* to Thread*.
1305     _recursions = 0;
1306     return true;
1307   }
1308   THROW_MSG_(vmSymbols::java_lang_IllegalMonitorStateException(),
1309              &quot;current thread is not owner&quot;, false);
1310 }
1311 
1312 static void post_monitor_wait_event(EventJavaMonitorWait* event,
1313                                     ObjectMonitor* monitor,
1314                                     jlong notifier_tid,
1315                                     jlong timeout,
1316                                     bool timedout) {
1317   assert(event != NULL, &quot;invariant&quot;);
1318   assert(monitor != NULL, &quot;invariant&quot;);
1319   event-&gt;set_monitorClass(((oop)monitor-&gt;object())-&gt;klass());
1320   event-&gt;set_timeout(timeout);
1321   event-&gt;set_address((uintptr_t)monitor-&gt;object_addr());
1322   event-&gt;set_notifier(notifier_tid);
1323   event-&gt;set_timedOut(timedout);
1324   event-&gt;commit();
1325 }
1326 
1327 // -----------------------------------------------------------------------------
1328 // Wait/Notify/NotifyAll
1329 //
1330 // Note: a subset of changes to ObjectMonitor::wait()
1331 // will need to be replicated in complete_exit
1332 void ObjectMonitor::wait(jlong millis, bool interruptible, TRAPS) {
1333   Thread * const Self = THREAD;
1334   assert(Self-&gt;is_Java_thread(), &quot;Must be Java thread!&quot;);
1335   JavaThread *jt = (JavaThread *)THREAD;
1336 
1337   assert(InitDone, &quot;Unexpectedly not initialized&quot;);
1338 
1339   CHECK_OWNER();  // Throws IMSE if not owner.
1340 
1341   EventJavaMonitorWait event;
1342 
1343   // check for a pending interrupt
1344   if (interruptible &amp;&amp; jt-&gt;is_interrupted(true) &amp;&amp; !HAS_PENDING_EXCEPTION) {
1345     // post monitor waited event.  Note that this is past-tense, we are done waiting.
1346     if (JvmtiExport::should_post_monitor_waited()) {
1347       // Note: &#39;false&#39; parameter is passed here because the
1348       // wait was not timed out due to thread interrupt.
1349       JvmtiExport::post_monitor_waited(jt, this, false);
1350 
1351       // In this short circuit of the monitor wait protocol, the
1352       // current thread never drops ownership of the monitor and
1353       // never gets added to the wait queue so the current thread
1354       // cannot be made the successor. This means that the
1355       // JVMTI_EVENT_MONITOR_WAITED event handler cannot accidentally
1356       // consume an unpark() meant for the ParkEvent associated with
1357       // this ObjectMonitor.
1358     }
1359     if (event.should_commit()) {
1360       post_monitor_wait_event(&amp;event, this, 0, millis, false);
1361     }
1362     THROW(vmSymbols::java_lang_InterruptedException());
1363     return;
1364   }
1365 
1366   assert(Self-&gt;_Stalled == 0, &quot;invariant&quot;);
1367   Self-&gt;_Stalled = intptr_t(this);
1368   jt-&gt;set_current_waiting_monitor(this);
1369 
1370   // create a node to be put into the queue
1371   // Critically, after we reset() the event but prior to park(), we must check
1372   // for a pending interrupt.
1373   ObjectWaiter node(Self);
1374   node.TState = ObjectWaiter::TS_WAIT;
1375   Self-&gt;_ParkEvent-&gt;reset();
1376   OrderAccess::fence();          // ST into Event; membar ; LD interrupted-flag
1377 
1378   // Enter the waiting queue, which is a circular doubly linked list in this case
1379   // but it could be a priority queue or any data structure.
1380   // _WaitSetLock protects the wait queue.  Normally the wait queue is accessed only
1381   // by the the owner of the monitor *except* in the case where park()
1382   // returns because of a timeout of interrupt.  Contention is exceptionally rare
1383   // so we use a simple spin-lock instead of a heavier-weight blocking lock.
1384 
1385   Thread::SpinAcquire(&amp;_WaitSetLock, &quot;WaitSet - add&quot;);
1386   AddWaiter(&amp;node);
1387   Thread::SpinRelease(&amp;_WaitSetLock);
1388 
1389   _Responsible = NULL;
1390 
1391   intx save = _recursions;     // record the old recursion count
1392   _waiters++;                  // increment the number of waiters
1393   _recursions = 0;             // set the recursion level to be 1
1394   exit(true, Self);                    // exit the monitor
1395   guarantee(_owner != Self, &quot;invariant&quot;);
1396 
1397   // The thread is on the WaitSet list - now park() it.
1398   // On MP systems it&#39;s conceivable that a brief spin before we park
1399   // could be profitable.
1400   //
1401   // TODO-FIXME: change the following logic to a loop of the form
1402   //   while (!timeout &amp;&amp; !interrupted &amp;&amp; _notified == 0) park()
1403 
1404   int ret = OS_OK;
1405   int WasNotified = 0;
1406 
1407   // Need to check interrupt state whilst still _thread_in_vm
1408   bool interrupted = interruptible &amp;&amp; jt-&gt;is_interrupted(false);
1409 
1410   { // State transition wrappers
1411     OSThread* osthread = Self-&gt;osthread();
1412     OSThreadWaitState osts(osthread, true);
1413     {
1414       ThreadBlockInVM tbivm(jt);
1415       // Thread is in thread_blocked state and oop access is unsafe.
1416       jt-&gt;set_suspend_equivalent();
1417 
1418       if (interrupted || HAS_PENDING_EXCEPTION) {
1419         // Intentionally empty
1420       } else if (node._notified == 0) {
1421         if (millis &lt;= 0) {
1422           Self-&gt;_ParkEvent-&gt;park();
1423         } else {
1424           ret = Self-&gt;_ParkEvent-&gt;park(millis);
1425         }
1426       }
1427 
1428       // were we externally suspended while we were waiting?
1429       if (ExitSuspendEquivalent (jt)) {
1430         // TODO-FIXME: add -- if succ == Self then succ = null.
1431         jt-&gt;java_suspend_self();
1432       }
1433 
1434     } // Exit thread safepoint: transition _thread_blocked -&gt; _thread_in_vm
1435 
1436     // Node may be on the WaitSet, the EntryList (or cxq), or in transition
1437     // from the WaitSet to the EntryList.
1438     // See if we need to remove Node from the WaitSet.
1439     // We use double-checked locking to avoid grabbing _WaitSetLock
1440     // if the thread is not on the wait queue.
1441     //
1442     // Note that we don&#39;t need a fence before the fetch of TState.
1443     // In the worst case we&#39;ll fetch a old-stale value of TS_WAIT previously
1444     // written by the is thread. (perhaps the fetch might even be satisfied
1445     // by a look-aside into the processor&#39;s own store buffer, although given
1446     // the length of the code path between the prior ST and this load that&#39;s
1447     // highly unlikely).  If the following LD fetches a stale TS_WAIT value
1448     // then we&#39;ll acquire the lock and then re-fetch a fresh TState value.
1449     // That is, we fail toward safety.
1450 
1451     if (node.TState == ObjectWaiter::TS_WAIT) {
1452       Thread::SpinAcquire(&amp;_WaitSetLock, &quot;WaitSet - unlink&quot;);
1453       if (node.TState == ObjectWaiter::TS_WAIT) {
1454         DequeueSpecificWaiter(&amp;node);       // unlink from WaitSet
1455         assert(node._notified == 0, &quot;invariant&quot;);
1456         node.TState = ObjectWaiter::TS_RUN;
1457       }
1458       Thread::SpinRelease(&amp;_WaitSetLock);
1459     }
1460 
1461     // The thread is now either on off-list (TS_RUN),
1462     // on the EntryList (TS_ENTER), or on the cxq (TS_CXQ).
1463     // The Node&#39;s TState variable is stable from the perspective of this thread.
1464     // No other threads will asynchronously modify TState.
1465     guarantee(node.TState != ObjectWaiter::TS_WAIT, &quot;invariant&quot;);
1466     OrderAccess::loadload();
1467     if (_succ == Self) _succ = NULL;
1468     WasNotified = node._notified;
1469 
1470     // Reentry phase -- reacquire the monitor.
1471     // re-enter contended monitor after object.wait().
1472     // retain OBJECT_WAIT state until re-enter successfully completes
1473     // Thread state is thread_in_vm and oop access is again safe,
1474     // although the raw address of the object may have changed.
1475     // (Don&#39;t cache naked oops over safepoints, of course).
1476 
1477     // post monitor waited event. Note that this is past-tense, we are done waiting.
1478     if (JvmtiExport::should_post_monitor_waited()) {
1479       JvmtiExport::post_monitor_waited(jt, this, ret == OS_TIMEOUT);
1480 
1481       if (node._notified != 0 &amp;&amp; _succ == Self) {
1482         // In this part of the monitor wait-notify-reenter protocol it
1483         // is possible (and normal) for another thread to do a fastpath
1484         // monitor enter-exit while this thread is still trying to get
1485         // to the reenter portion of the protocol.
1486         //
1487         // The ObjectMonitor was notified and the current thread is
1488         // the successor which also means that an unpark() has already
1489         // been done. The JVMTI_EVENT_MONITOR_WAITED event handler can
1490         // consume the unpark() that was done when the successor was
1491         // set because the same ParkEvent is shared between Java
1492         // monitors and JVM/TI RawMonitors (for now).
1493         //
1494         // We redo the unpark() to ensure forward progress, i.e., we
1495         // don&#39;t want all pending threads hanging (parked) with none
1496         // entering the unlocked monitor.
1497         node._event-&gt;unpark();
1498       }
1499     }
1500 
1501     if (event.should_commit()) {
1502       post_monitor_wait_event(&amp;event, this, node._notifier_tid, millis, ret == OS_TIMEOUT);
1503     }
1504 
1505     OrderAccess::fence();
1506 
1507     assert(Self-&gt;_Stalled != 0, &quot;invariant&quot;);
1508     Self-&gt;_Stalled = 0;
1509 
1510     assert(_owner != Self, &quot;invariant&quot;);
1511     ObjectWaiter::TStates v = node.TState;
1512     if (v == ObjectWaiter::TS_RUN) {
1513       enter(Self);
1514     } else {
1515       guarantee(v == ObjectWaiter::TS_ENTER || v == ObjectWaiter::TS_CXQ, &quot;invariant&quot;);
1516       ReenterI(Self, &amp;node);
1517       node.wait_reenter_end(this);
1518     }
1519 
1520     // Self has reacquired the lock.
1521     // Lifecycle - the node representing Self must not appear on any queues.
1522     // Node is about to go out-of-scope, but even if it were immortal we wouldn&#39;t
1523     // want residual elements associated with this thread left on any lists.
1524     guarantee(node.TState == ObjectWaiter::TS_RUN, &quot;invariant&quot;);
1525     assert(_owner == Self, &quot;invariant&quot;);
1526     assert(_succ != Self, &quot;invariant&quot;);
1527   } // OSThreadWaitState()
1528 
1529   jt-&gt;set_current_waiting_monitor(NULL);
1530 
1531   guarantee(_recursions == 0, &quot;invariant&quot;);
1532   _recursions = save;     // restore the old recursion count
1533   _waiters--;             // decrement the number of waiters
1534 
1535   // Verify a few postconditions
1536   assert(_owner == Self, &quot;invariant&quot;);
1537   assert(_succ != Self, &quot;invariant&quot;);
1538   assert(((oop)(object()))-&gt;mark() == markWord::encode(this), &quot;invariant&quot;);
1539 
1540   // check if the notification happened
1541   if (!WasNotified) {
1542     // no, it could be timeout or Thread.interrupt() or both
1543     // check for interrupt event, otherwise it is timeout
1544     if (interruptible &amp;&amp; jt-&gt;is_interrupted(true) &amp;&amp; !HAS_PENDING_EXCEPTION) {
1545       THROW(vmSymbols::java_lang_InterruptedException());
1546     }
1547   }
1548 
1549   // NOTE: Spurious wake up will be consider as timeout.
1550   // Monitor notify has precedence over thread interrupt.
1551 }
1552 
1553 
1554 // Consider:
1555 // If the lock is cool (cxq == null &amp;&amp; succ == null) and we&#39;re on an MP system
1556 // then instead of transferring a thread from the WaitSet to the EntryList
1557 // we might just dequeue a thread from the WaitSet and directly unpark() it.
1558 
1559 void ObjectMonitor::INotify(Thread * Self) {
1560   Thread::SpinAcquire(&amp;_WaitSetLock, &quot;WaitSet - notify&quot;);
1561   ObjectWaiter * iterator = DequeueWaiter();
1562   if (iterator != NULL) {
1563     guarantee(iterator-&gt;TState == ObjectWaiter::TS_WAIT, &quot;invariant&quot;);
1564     guarantee(iterator-&gt;_notified == 0, &quot;invariant&quot;);
1565     // Disposition - what might we do with iterator ?
1566     // a.  add it directly to the EntryList - either tail (policy == 1)
1567     //     or head (policy == 0).
1568     // b.  push it onto the front of the _cxq (policy == 2).
1569     // For now we use (b).
1570 
1571     iterator-&gt;TState = ObjectWaiter::TS_ENTER;
1572 
1573     iterator-&gt;_notified = 1;
1574     iterator-&gt;_notifier_tid = JFR_THREAD_ID(Self);
1575 
1576     ObjectWaiter * list = _EntryList;
1577     if (list != NULL) {
1578       assert(list-&gt;_prev == NULL, &quot;invariant&quot;);
1579       assert(list-&gt;TState == ObjectWaiter::TS_ENTER, &quot;invariant&quot;);
1580       assert(list != iterator, &quot;invariant&quot;);
1581     }
1582 
1583     // prepend to cxq
1584     if (list == NULL) {
1585       iterator-&gt;_next = iterator-&gt;_prev = NULL;
1586       _EntryList = iterator;
1587     } else {
1588       iterator-&gt;TState = ObjectWaiter::TS_CXQ;
1589       for (;;) {
1590         ObjectWaiter * front = _cxq;
1591         iterator-&gt;_next = front;
1592         if (Atomic::cmpxchg(&amp;_cxq, front, iterator) == front) {
1593           break;
1594         }
1595       }
1596     }
1597 
1598     // _WaitSetLock protects the wait queue, not the EntryList.  We could
1599     // move the add-to-EntryList operation, above, outside the critical section
1600     // protected by _WaitSetLock.  In practice that&#39;s not useful.  With the
1601     // exception of  wait() timeouts and interrupts the monitor owner
1602     // is the only thread that grabs _WaitSetLock.  There&#39;s almost no contention
1603     // on _WaitSetLock so it&#39;s not profitable to reduce the length of the
1604     // critical section.
1605 
1606     iterator-&gt;wait_reenter_begin(this);
1607   }
1608   Thread::SpinRelease(&amp;_WaitSetLock);
1609 }
1610 
1611 // Consider: a not-uncommon synchronization bug is to use notify() when
1612 // notifyAll() is more appropriate, potentially resulting in stranded
1613 // threads; this is one example of a lost wakeup. A useful diagnostic
1614 // option is to force all notify() operations to behave as notifyAll().
1615 //
1616 // Note: We can also detect many such problems with a &quot;minimum wait&quot;.
1617 // When the &quot;minimum wait&quot; is set to a small non-zero timeout value
1618 // and the program does not hang whereas it did absent &quot;minimum wait&quot;,
1619 // that suggests a lost wakeup bug.
1620 
1621 void ObjectMonitor::notify(TRAPS) {
1622   CHECK_OWNER();  // Throws IMSE if not owner.
1623   if (_WaitSet == NULL) {
1624     return;
1625   }
1626   DTRACE_MONITOR_PROBE(notify, this, object(), THREAD);
1627   INotify(THREAD);
1628   OM_PERFDATA_OP(Notifications, inc(1));
1629 }
1630 
1631 
1632 // The current implementation of notifyAll() transfers the waiters one-at-a-time
1633 // from the waitset to the EntryList. This could be done more efficiently with a
1634 // single bulk transfer but in practice it&#39;s not time-critical. Beware too,
1635 // that in prepend-mode we invert the order of the waiters. Let&#39;s say that the
1636 // waitset is &quot;ABCD&quot; and the EntryList is &quot;XYZ&quot;. After a notifyAll() in prepend
1637 // mode the waitset will be empty and the EntryList will be &quot;DCBAXYZ&quot;.
1638 
1639 void ObjectMonitor::notifyAll(TRAPS) {
1640   CHECK_OWNER();  // Throws IMSE if not owner.
1641   if (_WaitSet == NULL) {
1642     return;
1643   }
1644 
1645   DTRACE_MONITOR_PROBE(notifyAll, this, object(), THREAD);
1646   int tally = 0;
1647   while (_WaitSet != NULL) {
1648     tally++;
1649     INotify(THREAD);
1650   }
1651 
1652   OM_PERFDATA_OP(Notifications, inc(tally));
1653 }
1654 
1655 // -----------------------------------------------------------------------------
1656 // Adaptive Spinning Support
1657 //
1658 // Adaptive spin-then-block - rational spinning
1659 //
1660 // Note that we spin &quot;globally&quot; on _owner with a classic SMP-polite TATAS
1661 // algorithm.  On high order SMP systems it would be better to start with
1662 // a brief global spin and then revert to spinning locally.  In the spirit of MCS/CLH,
1663 // a contending thread could enqueue itself on the cxq and then spin locally
1664 // on a thread-specific variable such as its ParkEvent._Event flag.
1665 // That&#39;s left as an exercise for the reader.  Note that global spinning is
1666 // not problematic on Niagara, as the L2 cache serves the interconnect and
1667 // has both low latency and massive bandwidth.
1668 //
1669 // Broadly, we can fix the spin frequency -- that is, the % of contended lock
1670 // acquisition attempts where we opt to spin --  at 100% and vary the spin count
1671 // (duration) or we can fix the count at approximately the duration of
1672 // a context switch and vary the frequency.   Of course we could also
1673 // vary both satisfying K == Frequency * Duration, where K is adaptive by monitor.
1674 // For a description of &#39;Adaptive spin-then-block mutual exclusion in
1675 // multi-threaded processing,&#39; see U.S. Pat. No. 8046758.
1676 //
1677 // This implementation varies the duration &quot;D&quot;, where D varies with
1678 // the success rate of recent spin attempts. (D is capped at approximately
1679 // length of a round-trip context switch).  The success rate for recent
1680 // spin attempts is a good predictor of the success rate of future spin
1681 // attempts.  The mechanism adapts automatically to varying critical
1682 // section length (lock modality), system load and degree of parallelism.
1683 // D is maintained per-monitor in _SpinDuration and is initialized
1684 // optimistically.  Spin frequency is fixed at 100%.
1685 //
1686 // Note that _SpinDuration is volatile, but we update it without locks
1687 // or atomics.  The code is designed so that _SpinDuration stays within
1688 // a reasonable range even in the presence of races.  The arithmetic
1689 // operations on _SpinDuration are closed over the domain of legal values,
1690 // so at worst a race will install and older but still legal value.
1691 // At the very worst this introduces some apparent non-determinism.
1692 // We might spin when we shouldn&#39;t or vice-versa, but since the spin
1693 // count are relatively short, even in the worst case, the effect is harmless.
1694 //
1695 // Care must be taken that a low &quot;D&quot; value does not become an
1696 // an absorbing state.  Transient spinning failures -- when spinning
1697 // is overall profitable -- should not cause the system to converge
1698 // on low &quot;D&quot; values.  We want spinning to be stable and predictable
1699 // and fairly responsive to change and at the same time we don&#39;t want
1700 // it to oscillate, become metastable, be &quot;too&quot; non-deterministic,
1701 // or converge on or enter undesirable stable absorbing states.
1702 //
1703 // We implement a feedback-based control system -- using past behavior
1704 // to predict future behavior.  We face two issues: (a) if the
1705 // input signal is random then the spin predictor won&#39;t provide optimal
1706 // results, and (b) if the signal frequency is too high then the control
1707 // system, which has some natural response lag, will &quot;chase&quot; the signal.
1708 // (b) can arise from multimodal lock hold times.  Transient preemption
1709 // can also result in apparent bimodal lock hold times.
1710 // Although sub-optimal, neither condition is particularly harmful, as
1711 // in the worst-case we&#39;ll spin when we shouldn&#39;t or vice-versa.
1712 // The maximum spin duration is rather short so the failure modes aren&#39;t bad.
1713 // To be conservative, I&#39;ve tuned the gain in system to bias toward
1714 // _not spinning.  Relatedly, the system can sometimes enter a mode where it
1715 // &quot;rings&quot; or oscillates between spinning and not spinning.  This happens
1716 // when spinning is just on the cusp of profitability, however, so the
1717 // situation is not dire.  The state is benign -- there&#39;s no need to add
1718 // hysteresis control to damp the transition rate between spinning and
1719 // not spinning.
1720 
1721 // Spinning: Fixed frequency (100%), vary duration
1722 int ObjectMonitor::TrySpin(Thread * Self) {
1723   // Dumb, brutal spin.  Good for comparative measurements against adaptive spinning.
1724   int ctr = Knob_FixedSpin;
1725   if (ctr != 0) {
1726     while (--ctr &gt;= 0) {
1727       if (TryLock(Self) &gt; 0) return 1;
1728       SpinPause();
1729     }
1730     return 0;
1731   }
1732 
1733   for (ctr = Knob_PreSpin + 1; --ctr &gt;= 0;) {
1734     if (TryLock(Self) &gt; 0) {
1735       // Increase _SpinDuration ...
1736       // Note that we don&#39;t clamp SpinDuration precisely at SpinLimit.
1737       // Raising _SpurDuration to the poverty line is key.
1738       int x = _SpinDuration;
1739       if (x &lt; Knob_SpinLimit) {
1740         if (x &lt; Knob_Poverty) x = Knob_Poverty;
1741         _SpinDuration = x + Knob_BonusB;
1742       }
1743       return 1;
1744     }
1745     SpinPause();
1746   }
1747 
1748   // Admission control - verify preconditions for spinning
1749   //
1750   // We always spin a little bit, just to prevent _SpinDuration == 0 from
1751   // becoming an absorbing state.  Put another way, we spin briefly to
1752   // sample, just in case the system load, parallelism, contention, or lock
1753   // modality changed.
1754   //
1755   // Consider the following alternative:
1756   // Periodically set _SpinDuration = _SpinLimit and try a long/full
1757   // spin attempt.  &quot;Periodically&quot; might mean after a tally of
1758   // the # of failed spin attempts (or iterations) reaches some threshold.
1759   // This takes us into the realm of 1-out-of-N spinning, where we
1760   // hold the duration constant but vary the frequency.
1761 
1762   ctr = _SpinDuration;
1763   if (ctr &lt;= 0) return 0;
1764 
1765   if (NotRunnable(Self, (Thread *) _owner)) {
1766     return 0;
1767   }
1768 
1769   // We&#39;re good to spin ... spin ingress.
1770   // CONSIDER: use Prefetch::write() to avoid RTS-&gt;RTO upgrades
1771   // when preparing to LD...CAS _owner, etc and the CAS is likely
1772   // to succeed.
1773   if (_succ == NULL) {
1774     _succ = Self;
1775   }
1776   Thread * prv = NULL;
1777 
1778   // There are three ways to exit the following loop:
1779   // 1.  A successful spin where this thread has acquired the lock.
1780   // 2.  Spin failure with prejudice
1781   // 3.  Spin failure without prejudice
1782 
1783   while (--ctr &gt;= 0) {
1784 
1785     // Periodic polling -- Check for pending GC
1786     // Threads may spin while they&#39;re unsafe.
1787     // We don&#39;t want spinning threads to delay the JVM from reaching
1788     // a stop-the-world safepoint or to steal cycles from GC.
1789     // If we detect a pending safepoint we abort in order that
1790     // (a) this thread, if unsafe, doesn&#39;t delay the safepoint, and (b)
1791     // this thread, if safe, doesn&#39;t steal cycles from GC.
1792     // This is in keeping with the &quot;no loitering in runtime&quot; rule.
1793     // We periodically check to see if there&#39;s a safepoint pending.
1794     if ((ctr &amp; 0xFF) == 0) {
1795       if (SafepointMechanism::should_block(Self)) {
1796         goto Abort;           // abrupt spin egress
1797       }
1798       SpinPause();
1799     }
1800 
1801     // Probe _owner with TATAS
1802     // If this thread observes the monitor transition or flicker
1803     // from locked to unlocked to locked, then the odds that this
1804     // thread will acquire the lock in this spin attempt go down
1805     // considerably.  The same argument applies if the CAS fails
1806     // or if we observe _owner change from one non-null value to
1807     // another non-null value.   In such cases we might abort
1808     // the spin without prejudice or apply a &quot;penalty&quot; to the
1809     // spin count-down variable &quot;ctr&quot;, reducing it by 100, say.
1810 
1811     Thread * ox = (Thread *) _owner;
1812     if (ox == NULL) {
1813       ox = (Thread*)try_set_owner_from(NULL, Self);
1814       if (ox == NULL) {
1815         // The CAS succeeded -- this thread acquired ownership
1816         // Take care of some bookkeeping to exit spin state.
1817         if (_succ == Self) {
1818           _succ = NULL;
1819         }
1820 
1821         // Increase _SpinDuration :
1822         // The spin was successful (profitable) so we tend toward
1823         // longer spin attempts in the future.
1824         // CONSIDER: factor &quot;ctr&quot; into the _SpinDuration adjustment.
1825         // If we acquired the lock early in the spin cycle it
1826         // makes sense to increase _SpinDuration proportionally.
1827         // Note that we don&#39;t clamp SpinDuration precisely at SpinLimit.
1828         int x = _SpinDuration;
1829         if (x &lt; Knob_SpinLimit) {
1830           if (x &lt; Knob_Poverty) x = Knob_Poverty;
1831           _SpinDuration = x + Knob_Bonus;
1832         }
1833         return 1;
1834       }
1835 
1836       // The CAS failed ... we can take any of the following actions:
1837       // * penalize: ctr -= CASPenalty
1838       // * exit spin with prejudice -- goto Abort;
1839       // * exit spin without prejudice.
1840       // * Since CAS is high-latency, retry again immediately.
1841       prv = ox;
1842       goto Abort;
1843     }
1844 
1845     // Did lock ownership change hands ?
1846     if (ox != prv &amp;&amp; prv != NULL) {
1847       goto Abort;
1848     }
1849     prv = ox;
1850 
1851     // Abort the spin if the owner is not executing.
1852     // The owner must be executing in order to drop the lock.
1853     // Spinning while the owner is OFFPROC is idiocy.
1854     // Consider: ctr -= RunnablePenalty ;
1855     if (NotRunnable(Self, ox)) {
1856       goto Abort;
1857     }
1858     if (_succ == NULL) {
1859       _succ = Self;
1860     }
1861   }
1862 
1863   // Spin failed with prejudice -- reduce _SpinDuration.
1864   // TODO: Use an AIMD-like policy to adjust _SpinDuration.
1865   // AIMD is globally stable.
1866   {
1867     int x = _SpinDuration;
1868     if (x &gt; 0) {
1869       // Consider an AIMD scheme like: x -= (x &gt;&gt; 3) + 100
1870       // This is globally sample and tends to damp the response.
1871       x -= Knob_Penalty;
1872       if (x &lt; 0) x = 0;
1873       _SpinDuration = x;
1874     }
1875   }
1876 
1877  Abort:
1878   if (_succ == Self) {
1879     _succ = NULL;
1880     // Invariant: after setting succ=null a contending thread
1881     // must recheck-retry _owner before parking.  This usually happens
1882     // in the normal usage of TrySpin(), but it&#39;s safest
1883     // to make TrySpin() as foolproof as possible.
1884     OrderAccess::fence();
1885     if (TryLock(Self) &gt; 0) return 1;
1886   }
1887   return 0;
1888 }
1889 
1890 // NotRunnable() -- informed spinning
1891 //
1892 // Don&#39;t bother spinning if the owner is not eligible to drop the lock.
1893 // Spin only if the owner thread is _thread_in_Java or _thread_in_vm.
1894 // The thread must be runnable in order to drop the lock in timely fashion.
1895 // If the _owner is not runnable then spinning will not likely be
1896 // successful (profitable).
1897 //
1898 // Beware -- the thread referenced by _owner could have died
1899 // so a simply fetch from _owner-&gt;_thread_state might trap.
1900 // Instead, we use SafeFetchXX() to safely LD _owner-&gt;_thread_state.
1901 // Because of the lifecycle issues, the _thread_state values
1902 // observed by NotRunnable() might be garbage.  NotRunnable must
1903 // tolerate this and consider the observed _thread_state value
1904 // as advisory.
1905 //
1906 // Beware too, that _owner is sometimes a BasicLock address and sometimes
1907 // a thread pointer.
1908 // Alternately, we might tag the type (thread pointer vs basiclock pointer)
1909 // with the LSB of _owner.  Another option would be to probabilistically probe
1910 // the putative _owner-&gt;TypeTag value.
1911 //
1912 // Checking _thread_state isn&#39;t perfect.  Even if the thread is
1913 // in_java it might be blocked on a page-fault or have been preempted
1914 // and sitting on a ready/dispatch queue.
1915 //
1916 // The return value from NotRunnable() is *advisory* -- the
1917 // result is based on sampling and is not necessarily coherent.
1918 // The caller must tolerate false-negative and false-positive errors.
1919 // Spinning, in general, is probabilistic anyway.
1920 
1921 
1922 int ObjectMonitor::NotRunnable(Thread * Self, Thread * ox) {
1923   // Check ox-&gt;TypeTag == 2BAD.
1924   if (ox == NULL) return 0;
1925 
1926   // Avoid transitive spinning ...
1927   // Say T1 spins or blocks trying to acquire L.  T1._Stalled is set to L.
1928   // Immediately after T1 acquires L it&#39;s possible that T2, also
1929   // spinning on L, will see L.Owner=T1 and T1._Stalled=L.
1930   // This occurs transiently after T1 acquired L but before
1931   // T1 managed to clear T1.Stalled.  T2 does not need to abort
1932   // its spin in this circumstance.
1933   intptr_t BlockedOn = SafeFetchN((intptr_t *) &amp;ox-&gt;_Stalled, intptr_t(1));
1934 
1935   if (BlockedOn == 1) return 1;
1936   if (BlockedOn != 0) {
1937     return BlockedOn != intptr_t(this) &amp;&amp; _owner == ox;
1938   }
1939 
1940   assert(sizeof(((JavaThread *)ox)-&gt;_thread_state == sizeof(int)), &quot;invariant&quot;);
1941   int jst = SafeFetch32((int *) &amp;((JavaThread *) ox)-&gt;_thread_state, -1);;
1942   // consider also: jst != _thread_in_Java -- but that&#39;s overspecific.
1943   return jst == _thread_blocked || jst == _thread_in_native;
1944 }
1945 
1946 
1947 // -----------------------------------------------------------------------------
1948 // WaitSet management ...
1949 
1950 ObjectWaiter::ObjectWaiter(Thread* thread) {
1951   _next     = NULL;
1952   _prev     = NULL;
1953   _notified = 0;
1954   _notifier_tid = 0;
1955   TState    = TS_RUN;
1956   _thread   = thread;
1957   _event    = thread-&gt;_ParkEvent;
1958   _active   = false;
1959   assert(_event != NULL, &quot;invariant&quot;);
1960 }
1961 
1962 void ObjectWaiter::wait_reenter_begin(ObjectMonitor * const mon) {
1963   JavaThread *jt = (JavaThread *)this-&gt;_thread;
1964   _active = JavaThreadBlockedOnMonitorEnterState::wait_reenter_begin(jt, mon);
1965 }
1966 
1967 void ObjectWaiter::wait_reenter_end(ObjectMonitor * const mon) {
1968   JavaThread *jt = (JavaThread *)this-&gt;_thread;
1969   JavaThreadBlockedOnMonitorEnterState::wait_reenter_end(jt, _active);
1970 }
1971 
1972 inline void ObjectMonitor::AddWaiter(ObjectWaiter* node) {
1973   assert(node != NULL, &quot;should not add NULL node&quot;);
1974   assert(node-&gt;_prev == NULL, &quot;node already in list&quot;);
1975   assert(node-&gt;_next == NULL, &quot;node already in list&quot;);
1976   // put node at end of queue (circular doubly linked list)
1977   if (_WaitSet == NULL) {
1978     _WaitSet = node;
1979     node-&gt;_prev = node;
1980     node-&gt;_next = node;
1981   } else {
1982     ObjectWaiter* head = _WaitSet;
1983     ObjectWaiter* tail = head-&gt;_prev;
1984     assert(tail-&gt;_next == head, &quot;invariant check&quot;);
1985     tail-&gt;_next = node;
1986     head-&gt;_prev = node;
1987     node-&gt;_next = head;
1988     node-&gt;_prev = tail;
1989   }
1990 }
1991 
1992 inline ObjectWaiter* ObjectMonitor::DequeueWaiter() {
1993   // dequeue the very first waiter
1994   ObjectWaiter* waiter = _WaitSet;
1995   if (waiter) {
1996     DequeueSpecificWaiter(waiter);
1997   }
1998   return waiter;
1999 }
2000 
2001 inline void ObjectMonitor::DequeueSpecificWaiter(ObjectWaiter* node) {
2002   assert(node != NULL, &quot;should not dequeue NULL node&quot;);
2003   assert(node-&gt;_prev != NULL, &quot;node already removed from list&quot;);
2004   assert(node-&gt;_next != NULL, &quot;node already removed from list&quot;);
2005   // when the waiter has woken up because of interrupt,
2006   // timeout or other spurious wake-up, dequeue the
2007   // waiter from waiting list
2008   ObjectWaiter* next = node-&gt;_next;
2009   if (next == node) {
2010     assert(node-&gt;_prev == node, &quot;invariant check&quot;);
2011     _WaitSet = NULL;
2012   } else {
2013     ObjectWaiter* prev = node-&gt;_prev;
2014     assert(prev-&gt;_next == node, &quot;invariant check&quot;);
2015     assert(next-&gt;_prev == node, &quot;invariant check&quot;);
2016     next-&gt;_prev = prev;
2017     prev-&gt;_next = next;
2018     if (_WaitSet == node) {
2019       _WaitSet = next;
2020     }
2021   }
2022   node-&gt;_next = NULL;
2023   node-&gt;_prev = NULL;
2024 }
2025 
2026 // -----------------------------------------------------------------------------
2027 // PerfData support
2028 PerfCounter * ObjectMonitor::_sync_ContendedLockAttempts       = NULL;
2029 PerfCounter * ObjectMonitor::_sync_FutileWakeups               = NULL;
2030 PerfCounter * ObjectMonitor::_sync_Parks                       = NULL;
2031 PerfCounter * ObjectMonitor::_sync_Notifications               = NULL;
2032 PerfCounter * ObjectMonitor::_sync_Inflations                  = NULL;
2033 PerfCounter * ObjectMonitor::_sync_Deflations                  = NULL;
2034 PerfLongVariable * ObjectMonitor::_sync_MonExtant              = NULL;
2035 
2036 // One-shot global initialization for the sync subsystem.
2037 // We could also defer initialization and initialize on-demand
2038 // the first time we call ObjectSynchronizer::inflate().
2039 // Initialization would be protected - like so many things - by
2040 // the MonitorCache_lock.
2041 
2042 void ObjectMonitor::Initialize() {
2043   assert(!InitDone, &quot;invariant&quot;);
2044 
2045   if (!os::is_MP()) {
2046     Knob_SpinLimit = 0;
2047     Knob_PreSpin   = 0;
2048     Knob_FixedSpin = -1;
2049   }
2050 
2051   if (UsePerfData) {
2052     EXCEPTION_MARK;
2053 #define NEWPERFCOUNTER(n)                                                \
2054   {                                                                      \
2055     n = PerfDataManager::create_counter(SUN_RT, #n, PerfData::U_Events,  \
2056                                         CHECK);                          \
2057   }
2058 #define NEWPERFVARIABLE(n)                                                \
2059   {                                                                       \
2060     n = PerfDataManager::create_variable(SUN_RT, #n, PerfData::U_Events,  \
2061                                          CHECK);                          \
2062   }
2063     NEWPERFCOUNTER(_sync_Inflations);
2064     NEWPERFCOUNTER(_sync_Deflations);
2065     NEWPERFCOUNTER(_sync_ContendedLockAttempts);
2066     NEWPERFCOUNTER(_sync_FutileWakeups);
2067     NEWPERFCOUNTER(_sync_Parks);
2068     NEWPERFCOUNTER(_sync_Notifications);
2069     NEWPERFVARIABLE(_sync_MonExtant);
2070 #undef NEWPERFCOUNTER
2071 #undef NEWPERFVARIABLE
2072   }
2073 
2074   DEBUG_ONLY(InitDone = true;)
2075 }
2076 
2077 void ObjectMonitor::print_on(outputStream* st) const {
2078   // The minimal things to print for markWord printing, more can be added for debugging and logging.
2079   st-&gt;print(&quot;{contentions=0x%08x,waiters=0x%08x&quot;
2080             &quot;,recursions=&quot; INTX_FORMAT &quot;,owner=&quot; INTPTR_FORMAT &quot;}&quot;,
2081             contentions(), waiters(), recursions(),
2082             p2i(owner()));
2083 }
2084 void ObjectMonitor::print() const { print_on(tty); }
2085 
2086 #ifdef ASSERT
2087 // Print the ObjectMonitor like a debugger would:
2088 //
2089 // (ObjectMonitor) 0x00007fdfb6012e40 = {
2090 //   _header = 0x0000000000000001
2091 //   _object = 0x000000070ff45fd0
2092 //   _allocation_state = Old
2093 //   _pad_buf0 = {
2094 //     [0] = &#39;\0&#39;
2095 //     ...
2096 //     [43] = &#39;\0&#39;
2097 //   }
2098 //   _owner = 0x0000000000000000
2099 //   _previous_owner_tid = 0
2100 //   _pad_buf1 = {
2101 //     [0] = &#39;\0&#39;
2102 //     ...
2103 //     [47] = &#39;\0&#39;
2104 //   }
2105 //   _next_om = 0x0000000000000000
2106 //   _recursions = 0
2107 //   _EntryList = 0x0000000000000000
2108 //   _cxq = 0x0000000000000000
2109 //   _succ = 0x0000000000000000
2110 //   _Responsible = 0x0000000000000000
2111 //   _Spinner = 0
2112 //   _SpinDuration = 5000
2113 //   _contentions = 0
2114 //   _WaitSet = 0x0000700009756248
2115 //   _waiters = 1
2116 //   _WaitSetLock = 0
2117 // }
2118 //
2119 void ObjectMonitor::print_debug_style_on(outputStream* st) const {
2120   st-&gt;print_cr(&quot;(ObjectMonitor*) &quot; INTPTR_FORMAT &quot; = {&quot;, p2i(this));
2121   st-&gt;print_cr(&quot;  _header = &quot; INTPTR_FORMAT, header().value());
2122   st-&gt;print_cr(&quot;  _object = &quot; INTPTR_FORMAT, p2i(_object));
2123   st-&gt;print(&quot;  _allocation_state = &quot;);
2124   if (is_free()) {
2125     st-&gt;print(&quot;Free&quot;);
2126   } else if (is_old()) {
2127     st-&gt;print(&quot;Old&quot;);
2128   } else if (is_new()) {
2129     st-&gt;print(&quot;New&quot;);
2130   } else {
2131     st-&gt;print(&quot;unknown=%d&quot;, _allocation_state);
2132   }
2133   st-&gt;cr();
2134   st-&gt;print_cr(&quot;  _pad_buf0 = {&quot;);
2135   st-&gt;print_cr(&quot;    [0] = &#39;\\0&#39;&quot;);
2136   st-&gt;print_cr(&quot;    ...&quot;);
2137   st-&gt;print_cr(&quot;    [%d] = &#39;\\0&#39;&quot;, (int)sizeof(_pad_buf0) - 1);
2138   st-&gt;print_cr(&quot;  }&quot;);
2139   st-&gt;print_cr(&quot;  _owner = &quot; INTPTR_FORMAT, p2i(_owner));
2140   st-&gt;print_cr(&quot;  _previous_owner_tid = &quot; JLONG_FORMAT, _previous_owner_tid);
2141   st-&gt;print_cr(&quot;  _pad_buf1 = {&quot;);
2142   st-&gt;print_cr(&quot;    [0] = &#39;\\0&#39;&quot;);
2143   st-&gt;print_cr(&quot;    ...&quot;);
2144   st-&gt;print_cr(&quot;    [%d] = &#39;\\0&#39;&quot;, (int)sizeof(_pad_buf1) - 1);
2145   st-&gt;print_cr(&quot;  }&quot;);
2146   st-&gt;print_cr(&quot;  _next_om = &quot; INTPTR_FORMAT, p2i(next_om()));
2147   st-&gt;print_cr(&quot;  _recursions = &quot; INTX_FORMAT, _recursions);
2148   st-&gt;print_cr(&quot;  _EntryList = &quot; INTPTR_FORMAT, p2i(_EntryList));
2149   st-&gt;print_cr(&quot;  _cxq = &quot; INTPTR_FORMAT, p2i(_cxq));
2150   st-&gt;print_cr(&quot;  _succ = &quot; INTPTR_FORMAT, p2i(_succ));
2151   st-&gt;print_cr(&quot;  _Responsible = &quot; INTPTR_FORMAT, p2i(_Responsible));
2152   st-&gt;print_cr(&quot;  _Spinner = %d&quot;, _Spinner);
2153   st-&gt;print_cr(&quot;  _SpinDuration = %d&quot;, _SpinDuration);
2154   st-&gt;print_cr(&quot;  _contentions = %d&quot;, contentions());
2155   st-&gt;print_cr(&quot;  _WaitSet = &quot; INTPTR_FORMAT, p2i(_WaitSet));
2156   st-&gt;print_cr(&quot;  _waiters = %d&quot;, _waiters);
2157   st-&gt;print_cr(&quot;  _WaitSetLock = %d&quot;, _WaitSetLock);
2158   st-&gt;print_cr(&quot;}&quot;);
2159 }
2160 #endif
    </pre>
  </body>
</html>