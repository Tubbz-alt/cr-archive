<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff src/hotspot/share/services/virtualMemoryTracker.cpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
  </head>
<body>
<center><a href="threadService.cpp.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="../utilities/hashtable.cpp.cdiff.html" target="_top">next &gt;</a></center>    <h2>src/hotspot/share/services/virtualMemoryTracker.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 537,19 ***</span>
      if (rgn-&gt;flag() == mtThreadStack) {
        address stack_bottom = rgn-&gt;thread_stack_uncommitted_bottom();
        address committed_start;
        size_t  committed_size;
        size_t stack_size = rgn-&gt;base() + rgn-&gt;size() - stack_bottom;
  
        ReservedMemoryRegion* region = const_cast&lt;ReservedMemoryRegion*&gt;(rgn);
        NativeCallStack ncs; // empty stack
  
<span class="line-modified">!       RegionIterator itr(stack_bottom, stack_size);</span>
        DEBUG_ONLY(bool found_stack = false;)
        while (itr.next_committed(committed_start, committed_size)) {
          assert(committed_start != NULL, &quot;Should not be null&quot;);
          assert(committed_size &gt; 0, &quot;Should not be 0&quot;);
          region-&gt;add_committed_region(committed_start, committed_size, ncs);
          DEBUG_ONLY(found_stack = true;)
        }
  #ifdef ASSERT
        if (!found_stack) {
<span class="line-new-header">--- 537,25 ---</span>
      if (rgn-&gt;flag() == mtThreadStack) {
        address stack_bottom = rgn-&gt;thread_stack_uncommitted_bottom();
        address committed_start;
        size_t  committed_size;
        size_t stack_size = rgn-&gt;base() + rgn-&gt;size() - stack_bottom;
<span class="line-added">+       // Align the size to work with full pages (Alpine and AIX stack top is not page aligned)</span>
<span class="line-added">+       size_t aligned_stack_size = align_up(stack_size, os::vm_page_size());</span>
  
        ReservedMemoryRegion* region = const_cast&lt;ReservedMemoryRegion*&gt;(rgn);
        NativeCallStack ncs; // empty stack
  
<span class="line-modified">!       RegionIterator itr(stack_bottom, aligned_stack_size);</span>
        DEBUG_ONLY(bool found_stack = false;)
        while (itr.next_committed(committed_start, committed_size)) {
          assert(committed_start != NULL, &quot;Should not be null&quot;);
          assert(committed_size &gt; 0, &quot;Should not be 0&quot;);
<span class="line-added">+         // unaligned stack_size case: correct the region to fit the actual stack_size</span>
<span class="line-added">+         if (stack_bottom + stack_size &lt; committed_start + committed_size) {</span>
<span class="line-added">+           committed_size = stack_bottom + stack_size - committed_start;</span>
<span class="line-added">+         }</span>
          region-&gt;add_committed_region(committed_start, committed_size, ncs);
          DEBUG_ONLY(found_stack = true;)
        }
  #ifdef ASSERT
        if (!found_stack) {
</pre>
<center><a href="threadService.cpp.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="../utilities/hashtable.cpp.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>