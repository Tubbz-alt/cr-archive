<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff src/java.net.http/share/classes/jdk/internal/net/http/ResponseBodyHandlers.java</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="../../../../java/net/http/HttpResponse.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="ResponseSubscribers.java.cdiff.html" target="_top">next &gt;</a></center>    <h2>src/java.net.http/share/classes/jdk/internal/net/http/ResponseBodyHandlers.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 1,7 ***</span>
  /*
<span class="line-modified">!  * Copyright (c) 2018, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.  Oracle designates this
<span class="line-new-header">--- 1,7 ---</span>
  /*
<span class="line-modified">!  * Copyright (c) 2018, 2020, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.  Oracle designates this
</pre>
<hr />
<pre>
<span class="line-old-header">*** 32,15 ***</span>
  import java.net.URI;
  import java.nio.file.Files;
  import java.nio.file.OpenOption;
  import java.nio.file.Path;
  import java.nio.file.Paths;
  import java.util.List;
  import java.util.concurrent.CompletableFuture;
  import java.util.concurrent.ConcurrentMap;
  import java.util.function.Function;
<span class="line-removed">- import java.net.http.HttpHeaders;</span>
  import java.net.http.HttpRequest;
  import java.net.http.HttpResponse;
  import java.net.http.HttpResponse.BodyHandler;
  import java.net.http.HttpResponse.ResponseInfo;
  import java.net.http.HttpResponse.BodySubscriber;
<span class="line-new-header">--- 32,16 ---</span>
  import java.net.URI;
  import java.nio.file.Files;
  import java.nio.file.OpenOption;
  import java.nio.file.Path;
  import java.nio.file.Paths;
<span class="line-added">+ import java.security.AccessControlContext;</span>
<span class="line-added">+ import java.security.AccessController;</span>
  import java.util.List;
  import java.util.concurrent.CompletableFuture;
  import java.util.concurrent.ConcurrentMap;
  import java.util.function.Function;
  import java.net.http.HttpRequest;
  import java.net.http.HttpResponse;
  import java.net.http.HttpResponse.BodyHandler;
  import java.net.http.HttpResponse.ResponseInfo;
  import java.net.http.HttpResponse.BodySubscriber;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 61,10 ***</span>
<span class="line-new-header">--- 62,11 ---</span>
       * A Path body handler.
       */
      public static class PathBodyHandler implements BodyHandler&lt;Path&gt;{
          private final Path file;
          private final List&lt;OpenOption&gt; openOptions;  // immutable list
<span class="line-added">+         private final AccessControlContext acc;</span>
          private final FilePermission filePermission;
  
          /**
           * Factory for creating PathBodyHandler.
           *
</pre>
<hr />
<pre>
<span class="line-old-header">*** 75,29 ***</span>
          public static PathBodyHandler create(Path file,
                                               List&lt;OpenOption&gt; openOptions) {
              FilePermission filePermission = null;
              SecurityManager sm = System.getSecurityManager();
              if (sm != null) {
<span class="line-modified">!                 String fn = pathForSecurityCheck(file);</span>
<span class="line-modified">!                 FilePermission writePermission = new FilePermission(fn, &quot;write&quot;);</span>
<span class="line-modified">!                 sm.checkPermission(writePermission);</span>
<span class="line-modified">!                 filePermission = writePermission;</span>
              }
<span class="line-modified">!             return new PathBodyHandler(file, openOptions, filePermission);</span>
          }
  
          private PathBodyHandler(Path file,
                                  List&lt;OpenOption&gt; openOptions,
                                  FilePermission filePermission) {
              this.file = file;
              this.openOptions = openOptions;
              this.filePermission = filePermission;
          }
  
          @Override
          public BodySubscriber&lt;Path&gt; apply(ResponseInfo responseInfo) {
<span class="line-modified">!             return new PathSubscriber(file, openOptions, filePermission);</span>
          }
      }
  
      /** With push promise Map implementation */
      public static class PushPromisesHandlerWithMap&lt;T&gt;
<span class="line-new-header">--- 77,38 ---</span>
          public static PathBodyHandler create(Path file,
                                               List&lt;OpenOption&gt; openOptions) {
              FilePermission filePermission = null;
              SecurityManager sm = System.getSecurityManager();
              if (sm != null) {
<span class="line-modified">!                 try {</span>
<span class="line-modified">!                     String fn = pathForSecurityCheck(file);</span>
<span class="line-modified">!                     FilePermission writePermission = new FilePermission(fn, &quot;write&quot;);</span>
<span class="line-modified">!                     sm.checkPermission(writePermission);</span>
<span class="line-added">+                     filePermission = writePermission;</span>
<span class="line-added">+                 } catch (UnsupportedOperationException ignored) {</span>
<span class="line-added">+                     // path not associated with the default file system provider</span>
<span class="line-added">+                 }</span>
              }
<span class="line-modified">! </span>
<span class="line-added">+             assert filePermission == null || filePermission.getActions().equals(&quot;write&quot;);</span>
<span class="line-added">+             var acc = sm != null ? AccessController.getContext() : null;</span>
<span class="line-added">+             return new PathBodyHandler(file, openOptions, acc, filePermission);</span>
          }
  
          private PathBodyHandler(Path file,
                                  List&lt;OpenOption&gt; openOptions,
<span class="line-added">+                                 AccessControlContext acc,</span>
                                  FilePermission filePermission) {
              this.file = file;
              this.openOptions = openOptions;
<span class="line-added">+             this.acc = acc;</span>
              this.filePermission = filePermission;
          }
  
          @Override
          public BodySubscriber&lt;Path&gt; apply(ResponseInfo responseInfo) {
<span class="line-modified">!             return new PathSubscriber(file, openOptions, acc, filePermission);</span>
          }
      }
  
      /** With push promise Map implementation */
      public static class PushPromisesHandlerWithMap&lt;T&gt;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 147,10 ***</span>
<span class="line-new-header">--- 158,11 ---</span>
  
      // Similar to Path body handler, but for file download.
      public static class FileDownloadBodyHandler implements BodyHandler&lt;Path&gt; {
          private final Path directory;
          private final List&lt;OpenOption&gt; openOptions;
<span class="line-added">+         private final AccessControlContext acc;</span>
          private final FilePermission[] filePermissions;  // may be null
  
          /**
           * Factory for creating FileDownloadBodyHandler.
           *
</pre>
<hr />
<pre>
<span class="line-old-header">*** 158,14 ***</span>
           * FileDownloadBodyHandler. Permission checking and construction are
           * deliberately and tightly co-located.
           */
          public static FileDownloadBodyHandler create(Path directory,
                                                       List&lt;OpenOption&gt; openOptions) {
              FilePermission filePermissions[] = null;
              SecurityManager sm = System.getSecurityManager();
              if (sm != null) {
<span class="line-removed">-                 String fn = pathForSecurityCheck(directory);</span>
                  FilePermission writePermission = new FilePermission(fn, &quot;write&quot;);
                  String writePathPerm = fn + File.separatorChar + &quot;*&quot;;
                  FilePermission writeInDirPermission = new FilePermission(writePathPerm, &quot;write&quot;);
                  sm.checkPermission(writeInDirPermission);
                  FilePermission readPermission = new FilePermission(fn, &quot;read&quot;);
<span class="line-new-header">--- 170,21 ---</span>
           * FileDownloadBodyHandler. Permission checking and construction are
           * deliberately and tightly co-located.
           */
          public static FileDownloadBodyHandler create(Path directory,
                                                       List&lt;OpenOption&gt; openOptions) {
<span class="line-added">+             String fn;</span>
<span class="line-added">+             try {</span>
<span class="line-added">+                 fn = pathForSecurityCheck(directory);</span>
<span class="line-added">+             } catch (UnsupportedOperationException uoe) {</span>
<span class="line-added">+                 // directory not associated with the default file system provider</span>
<span class="line-added">+                 throw new IllegalArgumentException(&quot;invalid path: &quot; + directory, uoe);</span>
<span class="line-added">+             }</span>
<span class="line-added">+ </span>
              FilePermission filePermissions[] = null;
              SecurityManager sm = System.getSecurityManager();
              if (sm != null) {
                  FilePermission writePermission = new FilePermission(fn, &quot;write&quot;);
                  String writePathPerm = fn + File.separatorChar + &quot;*&quot;;
                  FilePermission writeInDirPermission = new FilePermission(writePathPerm, &quot;write&quot;);
                  sm.checkPermission(writeInDirPermission);
                  FilePermission readPermission = new FilePermission(fn, &quot;read&quot;);
</pre>
<hr />
<pre>
<span class="line-old-header">*** 182,19 ***</span>
              if (!Files.isDirectory(directory))
                  throw new IllegalArgumentException(&quot;not a directory: &quot; + directory);
              if (!Files.isWritable(directory))
                  throw new IllegalArgumentException(&quot;non-writable directory: &quot; + directory);
  
<span class="line-modified">!             return new FileDownloadBodyHandler(directory, openOptions, filePermissions);</span>
<span class="line-modified">! </span>
          }
  
          private FileDownloadBodyHandler(Path directory,
                                         List&lt;OpenOption&gt; openOptions,
                                         FilePermission... filePermissions) {
              this.directory = directory;
              this.openOptions = openOptions;
              this.filePermissions = filePermissions;
          }
  
          /** The &quot;attachment&quot; disposition-type and separator. */
          static final String DISPOSITION_TYPE = &quot;attachment;&quot;;
<span class="line-new-header">--- 201,23 ---</span>
              if (!Files.isDirectory(directory))
                  throw new IllegalArgumentException(&quot;not a directory: &quot; + directory);
              if (!Files.isWritable(directory))
                  throw new IllegalArgumentException(&quot;non-writable directory: &quot; + directory);
  
<span class="line-modified">!             assert filePermissions == null || (filePermissions[0].getActions().equals(&quot;write&quot;)</span>
<span class="line-modified">!                     &amp;&amp; filePermissions[1].getActions().equals(&quot;write&quot;));</span>
<span class="line-added">+             var acc = sm != null ? AccessController.getContext() : null;</span>
<span class="line-added">+             return new FileDownloadBodyHandler(directory, openOptions, acc, filePermissions);</span>
          }
  
          private FileDownloadBodyHandler(Path directory,
                                         List&lt;OpenOption&gt; openOptions,
<span class="line-added">+                                        AccessControlContext acc,</span>
                                         FilePermission... filePermissions) {
              this.directory = directory;
              this.openOptions = openOptions;
<span class="line-added">+             this.acc = acc;</span>
              this.filePermissions = filePermissions;
          }
  
          /** The &quot;attachment&quot; disposition-type and separator. */
          static final String DISPOSITION_TYPE = &quot;attachment;&quot;;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 271,9 ***</span>
              if (!file.startsWith(directory)) {
                  throw unchecked(responseInfo,
                          &quot;Resulting file, &quot; + file.toString() + &quot;, outside of given directory&quot;);
              }
  
<span class="line-modified">!             return new PathSubscriber(file, openOptions, filePermissions);</span>
          }
      }
  }
<span class="line-new-header">--- 294,9 ---</span>
              if (!file.startsWith(directory)) {
                  throw unchecked(responseInfo,
                          &quot;Resulting file, &quot; + file.toString() + &quot;, outside of given directory&quot;);
              }
  
<span class="line-modified">!             return new PathSubscriber(file, openOptions, acc, filePermissions);</span>
          }
      }
  }
</pre>
<center><a href="../../../../java/net/http/HttpResponse.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="ResponseSubscribers.java.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>