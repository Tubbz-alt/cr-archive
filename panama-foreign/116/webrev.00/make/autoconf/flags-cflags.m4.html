<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>New make/autoconf/flags-cflags.m4</title>
    <link rel="stylesheet" href="../../style.css" />
  </head>
  <body>
    <pre>
  1 #
  2 # Copyright (c) 2011, 2020, Oracle and/or its affiliates. All rights reserved.
  3 # DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4 #
  5 # This code is free software; you can redistribute it and/or modify it
  6 # under the terms of the GNU General Public License version 2 only, as
  7 # published by the Free Software Foundation.  Oracle designates this
  8 # particular file as subject to the &quot;Classpath&quot; exception as provided
  9 # by Oracle in the LICENSE file that accompanied this code.
 10 #
 11 # This code is distributed in the hope that it will be useful, but WITHOUT
 12 # ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 13 # FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 14 # version 2 for more details (a copy is included in the LICENSE file that
 15 # accompanied this code).
 16 #
 17 # You should have received a copy of the GNU General Public License version
 18 # 2 along with this work; if not, write to the Free Software Foundation,
 19 # Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 20 #
 21 # Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 22 # or visit www.oracle.com if you need additional information or have any
 23 # questions.
 24 #
 25 
 26 ################################################################################
 27 #
 28 # Setup flags for C/C++ compiler
 29 #
 30 
 31 ###############################################################################
 32 #
 33 # How to compile shared libraries.
 34 #
 35 AC_DEFUN([FLAGS_SETUP_SHARED_LIBS],
 36 [
 37   if test &quot;x$TOOLCHAIN_TYPE&quot; = xgcc; then
 38     C_FLAG_REORDER=&#39;&#39;
 39 
 40     # Default works for linux, might work on other platforms as well.
 41     SHARED_LIBRARY_FLAGS=&#39;-shared&#39;
 42     SET_EXECUTABLE_ORIGIN=&#39;-Wl,-rpath,\$$ORIGIN[$]1&#39;
 43     SET_SHARED_LIBRARY_ORIGIN=&quot;-Wl,-z,origin $SET_EXECUTABLE_ORIGIN&quot;
 44     SET_SHARED_LIBRARY_NAME=&#39;-Wl,-soname=[$]1&#39;
 45     SET_SHARED_LIBRARY_MAPFILE=&#39;-Wl,-version-script=[$]1&#39;
 46 
 47   elif test &quot;x$TOOLCHAIN_TYPE&quot; = xclang; then
 48     C_FLAG_REORDER=&#39;&#39;
 49 
 50     if test &quot;x$OPENJDK_TARGET_OS&quot; = xmacosx; then
 51       # Linking is different on MacOSX
 52       SHARED_LIBRARY_FLAGS=&quot;-dynamiclib -compatibility_version 1.0.0 -current_version 1.0.0&quot;
 53       SET_EXECUTABLE_ORIGIN=&#39;-Wl,-rpath,@loader_path$(or [$]1,/.)&#39;
 54       SET_SHARED_LIBRARY_ORIGIN=&quot;$SET_EXECUTABLE_ORIGIN&quot;
 55       SET_SHARED_LIBRARY_NAME=&#39;-Wl,-install_name,@rpath/[$]1&#39;
 56       SET_SHARED_LIBRARY_MAPFILE=&#39;-Wl,-exported_symbols_list,[$]1&#39;
 57 
 58     else
 59       # Default works for linux, might work on other platforms as well.
 60       SHARED_LIBRARY_FLAGS=&#39;-shared&#39;
 61       SET_EXECUTABLE_ORIGIN=&#39;-Wl,-rpath,\$$ORIGIN[$]1&#39;
 62       SET_SHARED_LIBRARY_NAME=&#39;-Wl,-soname=[$]1&#39;
 63       SET_SHARED_LIBRARY_MAPFILE=&#39;-Wl,-version-script=[$]1&#39;
 64 
 65       # arm specific settings
 66       if test &quot;x$OPENJDK_TARGET_CPU&quot; = &quot;xarm&quot;; then
 67         # &#39;-Wl,-z,origin&#39; isn&#39;t used on arm.
 68         SET_SHARED_LIBRARY_ORIGIN=&#39;-Wl,-rpath,\$$$$ORIGIN[$]1&#39;
 69       else
 70         SET_SHARED_LIBRARY_ORIGIN=&quot;-Wl,-z,origin $SET_EXECUTABLE_ORIGIN&quot;
 71       fi
 72     fi
 73 
 74   elif test &quot;x$TOOLCHAIN_TYPE&quot; = xsolstudio; then
 75     C_FLAG_REORDER=&#39;-xF&#39;
 76     SHARED_LIBRARY_FLAGS=&quot;-G&quot;
 77     SET_EXECUTABLE_ORIGIN=&#39;-R\$$ORIGIN[$]1&#39;
 78     SET_SHARED_LIBRARY_ORIGIN=&quot;$SET_EXECUTABLE_ORIGIN&quot;
 79     SET_SHARED_LIBRARY_NAME=&#39;-h [$]1&#39;
 80     SET_SHARED_LIBRARY_MAPFILE=&#39;-M[$]1&#39;
 81 
 82   elif test &quot;x$TOOLCHAIN_TYPE&quot; = xxlc; then
 83     C_FLAG_REORDER=&#39;&#39;
 84     SHARED_LIBRARY_FLAGS=&quot;-qmkshrobj -bM:SRE -bnoentry&quot;
 85     SET_EXECUTABLE_ORIGIN=&quot;&quot;
 86     SET_SHARED_LIBRARY_ORIGIN=&#39;&#39;
 87     SET_SHARED_LIBRARY_NAME=&#39;&#39;
 88     SET_SHARED_LIBRARY_MAPFILE=&#39;&#39;
 89 
 90   elif test &quot;x$TOOLCHAIN_TYPE&quot; = xmicrosoft; then
 91     C_FLAG_REORDER=&#39;&#39;
 92     SHARED_LIBRARY_FLAGS=&quot;-dll&quot;
 93     SET_EXECUTABLE_ORIGIN=&#39;&#39;
 94     SET_SHARED_LIBRARY_ORIGIN=&#39;&#39;
 95     SET_SHARED_LIBRARY_NAME=&#39;&#39;
 96     SET_SHARED_LIBRARY_MAPFILE=&#39;-def:[$]1&#39;
 97   fi
 98 
 99   AC_SUBST(C_FLAG_REORDER)
100   AC_SUBST(SET_EXECUTABLE_ORIGIN)
101   AC_SUBST(SET_SHARED_LIBRARY_ORIGIN)
102   AC_SUBST(SET_SHARED_LIBRARY_NAME)
103   AC_SUBST(SET_SHARED_LIBRARY_MAPFILE)
104   AC_SUBST(SHARED_LIBRARY_FLAGS)
105 ])
106 
107 AC_DEFUN([FLAGS_SETUP_DEBUG_SYMBOLS],
108 [
109   # By default don&#39;t set any specific assembler debug
110   # info flags for toolchains unless we know they work.
111   # See JDK-8207057.
112   ASFLAGS_DEBUG_SYMBOLS=&quot;&quot;
113   # Debug symbols
114   if test &quot;x$TOOLCHAIN_TYPE&quot; = xgcc; then
115     CFLAGS_DEBUG_SYMBOLS=&quot;-g&quot;
116     ASFLAGS_DEBUG_SYMBOLS=&quot;-g&quot;
117   elif test &quot;x$TOOLCHAIN_TYPE&quot; = xclang; then
118     CFLAGS_DEBUG_SYMBOLS=&quot;-g&quot;
119     ASFLAGS_DEBUG_SYMBOLS=&quot;-g&quot;
120   elif test &quot;x$TOOLCHAIN_TYPE&quot; = xsolstudio; then
121     # -g0 enables debug symbols without disabling inlining.
122     CFLAGS_DEBUG_SYMBOLS=&quot;-g0 -xs&quot;
123   elif test &quot;x$TOOLCHAIN_TYPE&quot; = xxlc; then
124     CFLAGS_DEBUG_SYMBOLS=&quot;-g1&quot;
125   elif test &quot;x$TOOLCHAIN_TYPE&quot; = xmicrosoft; then
126     CFLAGS_DEBUG_SYMBOLS=&quot;-Z7&quot;
127   fi
128 
129   AC_SUBST(CFLAGS_DEBUG_SYMBOLS)
130   AC_SUBST(ASFLAGS_DEBUG_SYMBOLS)
131 ])
132 
133 AC_DEFUN([FLAGS_SETUP_WARNINGS],
134 [
135   # Set default value.
136   if test &quot;x$TOOLCHAIN_TYPE&quot; != xxlc; then
137     WARNINGS_AS_ERRORS_DEFAULT=true
138   else
139     WARNINGS_AS_ERRORS_DEFAULT=false
140   fi
141 
142   UTIL_ARG_ENABLE(NAME: warnings-as-errors, DEFAULT: $WARNINGS_AS_ERRORS_DEFAULT,
143       RESULT: WARNINGS_AS_ERRORS,
144       DEFAULT_DESC: [auto],
145       DESC: [consider native warnings to be an error])
146   AC_SUBST(WARNINGS_AS_ERRORS)
147 
148   case &quot;${TOOLCHAIN_TYPE}&quot; in
149     microsoft)
150       DISABLE_WARNING_PREFIX=&quot;-wd&quot;
151       CFLAGS_WARNINGS_ARE_ERRORS=&quot;-WX&quot;
152 
153       WARNINGS_ENABLE_ALL=&quot;-W3&quot;
154       DISABLED_WARNINGS=&quot;4800&quot;
155       ;;
156 
157     solstudio)
158       DISABLE_WARNING_PREFIX=&quot;-erroff=&quot;
159       CFLAGS_WARNINGS_ARE_ERRORS=&quot;-errwarn=%all&quot;
160 
161       WARNINGS_ENABLE_ALL_CFLAGS=&quot;-v -fd -xtransition&quot;
162       WARNINGS_ENABLE_ALL_CXXFLAGS=&quot;+w +w2&quot;
163 
164       DISABLED_WARNINGS_C=&quot;E_OLD_STYLE_FUNC_DECL E_OLD_STYLE_FUNC_DEF E_SEMANTICS_OF_OP_CHG_IN_ANSI_C E_NO_REPLACEMENT_IN_STRING E_DECLARATION_IN_CODE&quot;
165       DISABLED_WARNINGS_CXX=&quot;inllargeuse inllargeint notused wemptydecl notemsource&quot;
166       ;;
167 
168     gcc)
169       DISABLE_WARNING_PREFIX=&quot;-Wno-&quot;
170       CFLAGS_WARNINGS_ARE_ERRORS=&quot;-Werror&quot;
171 
172       # Additional warnings that are not activated by -Wall and -Wextra
173       WARNINGS_ENABLE_ADDITIONAL=&quot;-Wpointer-arith -Wsign-compare \
174           -Wunused-function -Wundef -Wunused-value -Wreturn-type \
175           -Wtrampolines&quot;
176       WARNINGS_ENABLE_ADDITIONAL_CXX=&quot;-Woverloaded-virtual -Wreorder&quot;
177       WARNINGS_ENABLE_ALL_CFLAGS=&quot;-Wall -Wextra -Wformat=2 $WARNINGS_ENABLE_ADDITIONAL&quot;
178       WARNINGS_ENABLE_ALL_CXXFLAGS=&quot;$WARNINGS_ENABLE_ALL_CFLAGS $WARNINGS_ENABLE_ADDITIONAL_CXX&quot;
179 
180       DISABLED_WARNINGS=&quot;unused-parameter unused&quot;
181       BUILD_CC_DISABLE_WARNING_PREFIX=&quot;-Wno-&quot;
182       ;;
183 
184     clang)
185       DISABLE_WARNING_PREFIX=&quot;-Wno-&quot;
186       CFLAGS_WARNINGS_ARE_ERRORS=&quot;-Werror&quot;
187 
188       # Additional warnings that are not activated by -Wall and -Wextra
189       WARNINGS_ENABLE_ADDITIONAL=&quot;-Wpointer-arith -Wsign-compare -Wreorder \
190           -Wunused-function -Wundef -Wunused-value -Woverloaded-virtual&quot;
191       WARNINGS_ENABLE_ALL=&quot;-Wall -Wextra -Wformat=2 $WARNINGS_ENABLE_ADDITIONAL&quot;
192 
193       DISABLED_WARNINGS=&quot;unknown-warning-option unused-parameter unused&quot;
194 
195       if test &quot;x$OPENJDK_TARGET_OS&quot; = xmacosx; then
196         # missing-method-return-type triggers in JavaNativeFoundation framework
197         DISABLED_WARNINGS=&quot;$DISABLED_WARNINGS missing-method-return-type&quot;
198       fi
199 
200       ;;
201 
202     xlc)
203       DISABLE_WARNING_PREFIX=&quot;-Wno-&quot;
204       CFLAGS_WARNINGS_ARE_ERRORS=&quot;-qhalt=w&quot;
205 
206       # Possibly a better subset than &quot;all&quot; is &quot;lan:trx:ret:zea:cmp:ret&quot;
207       WARNINGS_ENABLE_ALL=&quot;-qinfo=all -qformat=all&quot;
208       DISABLED_WARNINGS=&quot;&quot;
209       ;;
210   esac
211   AC_SUBST(DISABLE_WARNING_PREFIX)
212   AC_SUBST(BUILD_CC_DISABLE_WARNING_PREFIX)
213   AC_SUBST(CFLAGS_WARNINGS_ARE_ERRORS)
214   AC_SUBST(DISABLED_WARNINGS)
215   AC_SUBST(DISABLED_WARNINGS_C)
216   AC_SUBST(DISABLED_WARNINGS_CXX)
217 ])
218 
219 AC_DEFUN([FLAGS_SETUP_QUALITY_CHECKS],
220 [
221   # bounds, memory and behavior checking options
222   if test &quot;x$TOOLCHAIN_TYPE&quot; = xgcc; then
223     case $DEBUG_LEVEL in
224     release )
225       # no adjustment
226       ;;
227     fastdebug )
228       # no adjustment
229       ;;
230     slowdebug )
231       # FIXME: By adding this to C(XX)FLAGS_DEBUG_OPTIONS/JVM_CFLAGS_SYMBOLS it
232       # get&#39;s added conditionally on whether we produce debug symbols or not.
233       # This is most likely not really correct.
234 
235       # Add runtime stack smashing and undefined behavior checks.
236       CFLAGS_DEBUG_OPTIONS=&quot;-fstack-protector-all --param ssp-buffer-size=1&quot;
237       CXXFLAGS_DEBUG_OPTIONS=&quot;-fstack-protector-all --param ssp-buffer-size=1&quot;
238 
239       JVM_CFLAGS_SYMBOLS=&quot;$JVM_CFLAGS_SYMBOLS -fstack-protector-all --param ssp-buffer-size=1&quot;
240       ;;
241     esac
242   fi
243 ])
244 
245 AC_DEFUN([FLAGS_SETUP_OPTIMIZATION],
246 [
247   if test &quot;x$TOOLCHAIN_TYPE&quot; = xsolstudio; then
248     CC_HIGHEST=&quot;-fns -fsimple -fsingle -xbuiltin=%all -xdepend -xrestrict -xlibmil&quot;
249 
250     C_O_FLAG_HIGHEST_JVM=&quot;-xO4&quot;
251     C_O_FLAG_DEBUG_JVM=&quot;&quot;
252     C_O_FLAG_SIZE=&quot;&quot;
253     C_O_FLAG_DEBUG=&quot;&quot;
254     C_O_FLAG_NONE=&quot;&quot;
255     if test &quot;x$OPENJDK_TARGET_CPU_ARCH&quot; = &quot;xx86&quot;; then
256       C_O_FLAG_HIGHEST=&quot;-xO4 -Wu,-O4~yz $CC_HIGHEST&quot;
257       C_O_FLAG_HI=&quot;-xO4 -Wu,-O4~yz&quot;
258       C_O_FLAG_NORM=&quot;-xO2 -Wu,-O2~yz&quot;
259     elif test &quot;x$OPENJDK_TARGET_CPU_ARCH&quot; = &quot;xsparc&quot;; then
260       C_O_FLAG_HIGHEST=&quot;-xO4 -Wc,-Qrm-s -Wc,-Qiselect-T0 \
261           -xprefetch=auto,explicit $CC_HIGHEST&quot;
262       C_O_FLAG_HI=&quot;-xO4 -Wc,-Qrm-s -Wc,-Qiselect-T0&quot;
263       C_O_FLAG_NORM=&quot;-xO2 -Wc,-Qrm-s -Wc,-Qiselect-T0&quot;
264     fi
265   elif test &quot;x$TOOLCHAIN_TYPE&quot; = xgcc; then
266     C_O_FLAG_HIGHEST_JVM=&quot;-O3&quot;
267     C_O_FLAG_HIGHEST=&quot;-O3&quot;
268     C_O_FLAG_HI=&quot;-O3&quot;
269     C_O_FLAG_NORM=&quot;-O2&quot;
270     C_O_FLAG_SIZE=&quot;-Os&quot;
271     C_O_FLAG_DEBUG=&quot;-O0&quot;
272     C_O_FLAG_DEBUG_JVM=&quot;-O0&quot;
273     C_O_FLAG_NONE=&quot;-O0&quot;
274     # -D_FORTIFY_SOURCE=2 hardening option needs optimization (at least -O1) enabled
275     # set for lower O-levels -U_FORTIFY_SOURCE to overwrite previous settings
276     if test &quot;x$OPENJDK_TARGET_OS&quot; = xlinux -a &quot;x$DEBUG_LEVEL&quot; = &quot;xfastdebug&quot;; then
277       ENABLE_FORTIFY_CFLAGS=&quot;-D_FORTIFY_SOURCE=2&quot;
278       DISABLE_FORTIFY_CFLAGS=&quot;-U_FORTIFY_SOURCE&quot;
279       C_O_FLAG_HIGHEST_JVM=&quot;${C_O_FLAG_HIGHEST_JVM} ${ENABLE_FORTIFY_CFLAGS}&quot;
280       C_O_FLAG_HIGHEST=&quot;${C_O_FLAG_HIGHEST} ${ENABLE_FORTIFY_CFLAGS}&quot;
281       C_O_FLAG_HI=&quot;${C_O_FLAG_HI} ${ENABLE_FORTIFY_CFLAGS}&quot;
282       C_O_FLAG_NORM=&quot;${C_O_FLAG_NORM} ${ENABLE_FORTIFY_CFLAGS}&quot;
283       C_O_FLAG_SIZE=&quot;${C_O_FLAG_SIZE} ${DISABLE_FORTIFY_CFLAGS}&quot;
284       C_O_FLAG_DEBUG=&quot;${C_O_FLAG_DEBUG} ${DISABLE_FORTIFY_CFLAGS}&quot;
285       C_O_FLAG_DEBUG_JVM=&quot;${C_O_FLAG_DEBUG_JVM} ${DISABLE_FORTIFY_CFLAGS}&quot;
286       C_O_FLAG_NONE=&quot;${C_O_FLAG_NONE} ${DISABLE_FORTIFY_CFLAGS}&quot;
287     fi
288   elif test &quot;x$TOOLCHAIN_TYPE&quot; = xclang; then
289     if test &quot;x$OPENJDK_TARGET_OS&quot; = xmacosx; then
290       # On MacOSX we optimize for size, something
291       # we should do for all platforms?
292       C_O_FLAG_HIGHEST_JVM=&quot;-Os&quot;
293       C_O_FLAG_HIGHEST=&quot;-Os&quot;
294       C_O_FLAG_HI=&quot;-Os&quot;
295       C_O_FLAG_NORM=&quot;-Os&quot;
296       C_O_FLAG_DEBUG_JVM=&quot;&quot;
297     else
298       C_O_FLAG_HIGHEST_JVM=&quot;-O3&quot;
299       C_O_FLAG_HIGHEST=&quot;-O3&quot;
300       C_O_FLAG_HI=&quot;-O3&quot;
301       C_O_FLAG_NORM=&quot;-O2&quot;
302       C_O_FLAG_DEBUG_JVM=&quot;-O0&quot;
303     fi
304     C_O_FLAG_SIZE=&quot;-Os&quot;
305     C_O_FLAG_DEBUG=&quot;-O0&quot;
306     C_O_FLAG_NONE=&quot;-O0&quot;
307   elif test &quot;x$TOOLCHAIN_TYPE&quot; = xxlc; then
308     C_O_FLAG_HIGHEST_JVM=&quot;-O3 -qhot=level=1 -qinline -qinlglue&quot;
309     C_O_FLAG_HIGHEST=&quot;-O3 -qhot=level=1 -qinline -qinlglue&quot;
310     C_O_FLAG_HI=&quot;-O3 -qinline -qinlglue&quot;
311     C_O_FLAG_NORM=&quot;-O2&quot;
312     C_O_FLAG_DEBUG=&quot;-qnoopt&quot;
313     # FIXME: Value below not verified.
314     C_O_FLAG_DEBUG_JVM=&quot;&quot;
315     C_O_FLAG_NONE=&quot;-qnoopt&quot;
316   elif test &quot;x$TOOLCHAIN_TYPE&quot; = xmicrosoft; then
317     C_O_FLAG_HIGHEST_JVM=&quot;-O2 -Oy-&quot;
318     C_O_FLAG_HIGHEST=&quot;-O2&quot;
319     C_O_FLAG_HI=&quot;-O1&quot;
320     C_O_FLAG_NORM=&quot;-O1&quot;
321     C_O_FLAG_DEBUG=&quot;-Od&quot;
322     C_O_FLAG_DEBUG_JVM=&quot;&quot;
323     C_O_FLAG_NONE=&quot;-Od&quot;
324     C_O_FLAG_SIZE=&quot;-Os&quot;
325   fi
326 
327   # Now copy to C++ flags
328   CXX_O_FLAG_HIGHEST_JVM=&quot;$C_O_FLAG_HIGHEST_JVM&quot;
329   CXX_O_FLAG_HIGHEST=&quot;$C_O_FLAG_HIGHEST&quot;
330   CXX_O_FLAG_HI=&quot;$C_O_FLAG_HI&quot;
331   CXX_O_FLAG_NORM=&quot;$C_O_FLAG_NORM&quot;
332   CXX_O_FLAG_DEBUG=&quot;$C_O_FLAG_DEBUG&quot;
333   CXX_O_FLAG_DEBUG_JVM=&quot;$C_O_FLAG_DEBUG_JVM&quot;
334   CXX_O_FLAG_NONE=&quot;$C_O_FLAG_NONE&quot;
335   CXX_O_FLAG_SIZE=&quot;$C_O_FLAG_SIZE&quot;
336 
337   if test &quot;x$TOOLCHAIN_TYPE&quot; = xsolstudio; then
338     # In solstudio, also add this to C (but not C++) flags...
339     C_O_FLAG_HIGHEST=&quot;$C_O_FLAG_HIGHEST -xalias_level=basic&quot;
340   fi
341 
342   # Adjust optimization flags according to debug level.
343   case $DEBUG_LEVEL in
344     release )
345       # no adjustment
346       ;;
347     fastdebug )
348       # Not quite so much optimization
349       C_O_FLAG_HI=&quot;$C_O_FLAG_NORM&quot;
350       CXX_O_FLAG_HI=&quot;$CXX_O_FLAG_NORM&quot;
351       ;;
352     slowdebug )
353       # Disable optimization
354       C_O_FLAG_HIGHEST_JVM=&quot;$C_O_FLAG_DEBUG_JVM&quot;
355       C_O_FLAG_HIGHEST=&quot;$C_O_FLAG_DEBUG&quot;
356       C_O_FLAG_HI=&quot;$C_O_FLAG_DEBUG&quot;
357       C_O_FLAG_NORM=&quot;$C_O_FLAG_DEBUG&quot;
358       C_O_FLAG_SIZE=&quot;$C_O_FLAG_DEBUG&quot;
359       CXX_O_FLAG_HIGHEST_JVM=&quot;$CXX_O_FLAG_DEBUG_JVM&quot;
360       CXX_O_FLAG_HIGHEST=&quot;$CXX_O_FLAG_DEBUG&quot;
361       CXX_O_FLAG_HI=&quot;$CXX_O_FLAG_DEBUG&quot;
362       CXX_O_FLAG_NORM=&quot;$CXX_O_FLAG_DEBUG&quot;
363       CXX_O_FLAG_SIZE=&quot;$CXX_O_FLAG_DEBUG&quot;
364       ;;
365   esac
366 
367   AC_SUBST(C_O_FLAG_HIGHEST_JVM)
368   AC_SUBST(C_O_FLAG_HIGHEST)
369   AC_SUBST(C_O_FLAG_HI)
370   AC_SUBST(C_O_FLAG_NORM)
371   AC_SUBST(C_O_FLAG_NONE)
372   AC_SUBST(C_O_FLAG_SIZE)
373   AC_SUBST(CXX_O_FLAG_HIGHEST_JVM)
374   AC_SUBST(CXX_O_FLAG_HIGHEST)
375   AC_SUBST(CXX_O_FLAG_HI)
376   AC_SUBST(CXX_O_FLAG_NORM)
377   AC_SUBST(CXX_O_FLAG_NONE)
378   AC_SUBST(CXX_O_FLAG_SIZE)
379 ])
380 
381 AC_DEFUN([FLAGS_SETUP_CFLAGS],
382 [
383   ### CFLAGS
384 
385   FLAGS_SETUP_CFLAGS_HELPER
386 
387   FLAGS_OS=$OPENJDK_TARGET_OS
388   FLAGS_OS_TYPE=$OPENJDK_TARGET_OS_TYPE
389   FLAGS_CPU=$OPENJDK_TARGET_CPU
390   FLAGS_CPU_ARCH=$OPENJDK_TARGET_CPU_ARCH
391   FLAGS_CPU_BITS=$OPENJDK_TARGET_CPU_BITS
392   FLAGS_CPU_ENDIAN=$OPENJDK_TARGET_CPU_ENDIAN
393   FLAGS_CPU_LEGACY=$OPENJDK_TARGET_CPU_LEGACY
394   FLAGS_CPU_LEGACY_LIB=$OPENJDK_TARGET_CPU_LEGACY_LIB
395 
396   FLAGS_SETUP_CFLAGS_CPU_DEP([TARGET])
397 
398   # Repeat the check for the BUILD_CC and BUILD_CXX. Need to also reset CFLAGS
399   # since any target specific flags will likely not work with the build compiler.
400   CC_OLD=&quot;$CC&quot;
401   CXX_OLD=&quot;$CXX&quot;
402   CFLAGS_OLD=&quot;$CFLAGS&quot;
403   CXXFLAGS_OLD=&quot;$CXXFLAGS&quot;
404   CC=&quot;$BUILD_CC&quot;
405   CXX=&quot;$BUILD_CXX&quot;
406   CFLAGS=&quot;&quot;
407   CXXFLAGS=&quot;&quot;
408 
409   FLAGS_OS=$OPENJDK_BUILD_OS
410   FLAGS_OS_TYPE=$OPENJDK_BUILD_OS_TYPE
411   FLAGS_CPU=$OPENJDK_BUILD_CPU
412   FLAGS_CPU_ARCH=$OPENJDK_BUILD_CPU_ARCH
413   FLAGS_CPU_BITS=$OPENJDK_BUILD_CPU_BITS
414   FLAGS_CPU_ENDIAN=$OPENJDK_BUILD_CPU_ENDIAN
415   FLAGS_CPU_LEGACY=$OPENJDK_BUILD_CPU_LEGACY
416   FLAGS_CPU_LEGACY_LIB=$OPENJDK_BUILD_CPU_LEGACY_LIB
417 
418   FLAGS_SETUP_CFLAGS_CPU_DEP([BUILD], [OPENJDK_BUILD_], [BUILD_])
419 
420   CC=&quot;$CC_OLD&quot;
421   CXX=&quot;$CXX_OLD&quot;
422   CFLAGS=&quot;$CFLAGS_OLD&quot;
423   CXXFLAGS=&quot;$CXXFLAGS_OLD&quot;
424 ])
425 
426 ################################################################################
427 # platform independent
428 AC_DEFUN([FLAGS_SETUP_CFLAGS_HELPER],
429 [
430   #### OS DEFINES, these should be independent on toolchain
431   if test &quot;x$OPENJDK_TARGET_OS&quot; = xlinux; then
432     CFLAGS_OS_DEF_JVM=&quot;-DLINUX&quot;
433     CFLAGS_OS_DEF_JDK=&quot;-D_GNU_SOURCE -D_REENTRANT -D_LARGEFILE64_SOURCE&quot;
434   elif test &quot;x$OPENJDK_TARGET_OS&quot; = xsolaris; then
435     CFLAGS_OS_DEF_JVM=&quot;-DSOLARIS&quot;
436     CFLAGS_OS_DEF_JDK=&quot;-D__solaris__&quot;
437   elif test &quot;x$OPENJDK_TARGET_OS&quot; = xmacosx; then
438     CFLAGS_OS_DEF_JVM=&quot;-D_ALLBSD_SOURCE -D_DARWIN_C_SOURCE -D_XOPEN_SOURCE&quot;
439     CFLAGS_OS_DEF_JDK=&quot;-D_ALLBSD_SOURCE -D_DARWIN_UNLIMITED_SELECT&quot;
440   elif test &quot;x$OPENJDK_TARGET_OS&quot; = xaix; then
441     CFLAGS_OS_DEF_JVM=&quot;-DAIX&quot;
442   elif test &quot;x$OPENJDK_TARGET_OS&quot; = xbsd; then
443     CFLAGS_OS_DEF_JDK=&quot;-D_ALLBSD_SOURCE&quot;
444   elif test &quot;x$OPENJDK_TARGET_OS&quot; = xwindows; then
445     CFLAGS_OS_DEF_JVM=&quot;-D_WINDOWS -DWIN32 -D_JNI_IMPLEMENTATION_&quot;
446   fi
447 
448   CFLAGS_OS_DEF_JDK=&quot;$CFLAGS_OS_DEF_JDK -D$OPENJDK_TARGET_OS_UPPERCASE&quot;
449 
450   #### GLOBAL DEFINES
451   # Set some common defines. These works for all compilers, but assume
452   # -D is universally accepted.
453 
454   # Always enable optional macros for VM.
455   ALWAYS_CFLAGS_JVM=&quot;-D__STDC_FORMAT_MACROS -D__STDC_LIMIT_MACROS -D__STDC_CONSTANT_MACROS&quot;
456 
457   # Setup some hard coded includes
458   ALWAYS_CFLAGS_JDK=&quot; \
459       -I\$(SUPPORT_OUTPUTDIR)/modules_include/java.base \
460       -I\$(SUPPORT_OUTPUTDIR)/modules_include/java.base/\$(OPENJDK_TARGET_OS_INCLUDE_SUBDIR) \
461       -I${TOPDIR}/src/java.base/share/native/libjava \
462       -I${TOPDIR}/src/java.base/$OPENJDK_TARGET_OS_TYPE/native/libjava \
463       -I${TOPDIR}/src/hotspot/share/include \
464       -I${TOPDIR}/src/hotspot/os/${HOTSPOT_TARGET_OS_TYPE}/include&quot;
465 
466   ###############################################################################
467 
468   # Adjust flags according to debug level.
469   # Setup debug/release defines
470   if test &quot;x$DEBUG_LEVEL&quot; = xrelease; then
471     DEBUG_CFLAGS_JDK=&quot;-DNDEBUG&quot;
472     if test &quot;x$OPENJDK_TARGET_OS&quot; = xsolaris; then
473       DEBUG_CFLAGS_JDK=&quot;$DEBUG_CFLAGS_JDK -DTRIMMED&quot;
474     fi
475   else
476     DEBUG_CFLAGS_JDK=&quot;-DDEBUG&quot;
477 
478     if test &quot;x$TOOLCHAIN_TYPE&quot; = xxlc; then
479       # We need &#39;-qminimaltoc&#39; or &#39;-qpic=large -bbigtoc&#39; if the TOC overflows.
480       # Hotspot now overflows its 64K TOC (currently only for debug),
481       # so for debug we build with &#39;-qpic=large -bbigtoc&#39;.
482       DEBUG_CFLAGS_JVM=&quot;-qpic=large&quot;
483     fi
484   fi
485 
486   if test &quot;x$DEBUG_LEVEL&quot; != xrelease; then
487     DEBUG_OPTIONS_FLAGS_JDK=&quot;$CFLAGS_DEBUG_OPTIONS&quot;
488     DEBUG_SYMBOLS_CFLAGS_JDK=&quot;$CFLAGS_DEBUG_SYMBOLS&quot;
489   fi
490 
491   #### TOOLCHAIN DEFINES
492 
493   if test &quot;x$TOOLCHAIN_TYPE&quot; = xgcc; then
494     ALWAYS_DEFINES_JVM=&quot;-D_GNU_SOURCE -D_REENTRANT&quot;
495   elif test &quot;x$TOOLCHAIN_TYPE&quot; = xclang; then
496     ALWAYS_DEFINES_JVM=&quot;-D_GNU_SOURCE&quot;
497   elif test &quot;x$TOOLCHAIN_TYPE&quot; = xsolstudio; then
498     ALWAYS_DEFINES_JVM=&quot;-DSPARC_WORKS -D_Crun_inline_placement&quot;
499     ALWAYS_DEFINES_JDK=&quot;-DTRACING -DMACRO_MEMSYS_OPS -DBREAKPTS&quot;
500     ALWAYS_DEFINES_JDK_CXXONLY=&quot;-DCC_NOEX&quot;
501   elif test &quot;x$TOOLCHAIN_TYPE&quot; = xxlc; then
502     ALWAYS_DEFINES_JVM=&quot;-D_REENTRANT&quot;
503     ALWAYS_DEFINES_JDK=&quot;-D_GNU_SOURCE -D_REENTRANT -D_LARGEFILE64_SOURCE -DSTDC&quot;
504   elif test &quot;x$TOOLCHAIN_TYPE&quot; = xmicrosoft; then
505     ALWAYS_DEFINES_JDK=&quot;-DWIN32_LEAN_AND_MEAN -D_CRT_SECURE_NO_DEPRECATE \
506         -D_CRT_NONSTDC_NO_DEPRECATE -DWIN32 -DIAL&quot;
507     ALWAYS_DEFINES_JVM=&quot;-DNOMINMAX -DWIN32_LEAN_AND_MEAN&quot;
508   fi
509 
510   ###############################################################################
511   #
512   #
513   # CFLAGS BASIC
514   if test &quot;x$TOOLCHAIN_TYPE&quot; = xgcc || test &quot;x$TOOLCHAIN_TYPE&quot; = xclang; then
515     # COMMON to gcc and clang
516     TOOLCHAIN_CFLAGS_JVM=&quot;-pipe -fno-rtti -fno-exceptions \
517         -fvisibility=hidden -fno-strict-aliasing -fno-omit-frame-pointer&quot;
518   fi
519 
520   if test &quot;x$TOOLCHAIN_TYPE&quot; = xgcc; then
521     TOOLCHAIN_CFLAGS_JVM=&quot;$TOOLCHAIN_CFLAGS_JVM -fcheck-new -fstack-protector&quot;
522     TOOLCHAIN_CFLAGS_JDK=&quot;-pipe -fstack-protector&quot;
523     # reduce lib size on linux in link step, this needs also special compile flags
524     # do this on s390x also for libjvm (where serviceability agent is not supported)
525     if test &quot;x$ENABLE_LINKTIME_GC&quot; = xtrue; then
526       TOOLCHAIN_CFLAGS_JDK=&quot;$TOOLCHAIN_CFLAGS_JDK -ffunction-sections -fdata-sections&quot;
527       if test &quot;x$OPENJDK_TARGET_CPU&quot; = xs390x; then
528         TOOLCHAIN_CFLAGS_JVM=&quot;$TOOLCHAIN_CFLAGS_JVM -ffunction-sections -fdata-sections&quot;
529       fi
530     fi
531     # technically NOT for CXX (but since this gives *worse* performance, use
532     # no-strict-aliasing everywhere!)
533     TOOLCHAIN_CFLAGS_JDK_CONLY=&quot;-fno-strict-aliasing&quot;
534 
535   elif test &quot;x$TOOLCHAIN_TYPE&quot; = xclang; then
536     # Restrict the debug information created by Clang to avoid
537     # too big object files and speed the build up a little bit
538     # (see http://llvm.org/bugs/show_bug.cgi?id=7554)
539     TOOLCHAIN_CFLAGS_JVM=&quot;$TOOLCHAIN_CFLAGS_JVM -flimit-debug-info&quot;
540 
541     # In principle the stack alignment below is cpu- and ABI-dependent and
542     # should agree with values of StackAlignmentInBytes in various
543     # src/hotspot/cpu/*/globalDefinitions_*.hpp files, but this value currently
544     # works for all platforms.
545     TOOLCHAIN_CFLAGS_JVM=&quot;$TOOLCHAIN_CFLAGS_JVM -mno-omit-leaf-frame-pointer -mstack-alignment=16&quot;
546 
547     if test &quot;x$OPENJDK_TARGET_OS&quot; = xlinux; then
548       if test &quot;x$DEBUG_LEVEL&quot; = xrelease; then
549         # Clang does not inline as much as GCC does for functions with &quot;inline&quot; keyword by default.
550         # This causes noticeable slowdown in pause time for G1, and possibly in other areas.
551         # Increasing the inline hint threshold avoids the slowdown for Clang-built JVM.
552         TOOLCHAIN_CFLAGS_JVM=&quot;$TOOLCHAIN_CFLAGS_JVM -mllvm -inlinehint-threshold=100000&quot;
553       fi
554       TOOLCHAIN_CFLAGS_JDK=&quot;-pipe&quot;
555       TOOLCHAIN_CFLAGS_JDK_CONLY=&quot;-fno-strict-aliasing&quot; # technically NOT for CXX
556     fi
557   elif test &quot;x$TOOLCHAIN_TYPE&quot; = xsolstudio; then
558     TOOLCHAIN_FLAGS=&quot;-errtags -errfmt&quot;
559     TOOLCHAIN_CFLAGS=&quot;-errshort=tags&quot;
560 
561     TOOLCHAIN_CFLAGS_JDK=&quot;-mt $TOOLCHAIN_FLAGS&quot;
562     TOOLCHAIN_CFLAGS_JDK_CONLY=&quot;-W0,-noglobal $TOOLCHAIN_CFLAGS&quot; # C only
563     TOOLCHAIN_CFLAGS_JDK_CXXONLY=&quot;-features=no%except -norunpath -xnolib&quot; # CXX only
564     TOOLCHAIN_CFLAGS_JVM=&quot;-template=no%extdef -features=no%split_init \
565         -library=stlport4 -mt -features=no%except $TOOLCHAIN_FLAGS&quot;
566     if test &quot;x$DEBUG_LEVEL&quot; = xslowdebug; then
567       # Previously -g was used instead of -g0 for slowdebug; this is equivalent
568       # to setting +d.
569       TOOLCHAIN_CFLAGS_JVM=&quot;$TOOLCHAIN_CFLAGS_JVM +d&quot;
570     fi
571 
572   elif test &quot;x$TOOLCHAIN_TYPE&quot; = xxlc; then
573     # Suggested additions: -qsrcmsg to get improved error reporting
574     # set -qtbtable=full for a better traceback table/better stacks in hs_err when xlc16 is used
575     TOOLCHAIN_CFLAGS_JDK=&quot;-qtbtable=full -qchars=signed -qfullpath -qsaveopt -qstackprotect&quot;  # add on both CFLAGS
576     TOOLCHAIN_CFLAGS_JVM=&quot;-qtbtable=full -qtune=balanced \
577         -qalias=noansi -qstrict -qtls=default -qnortti -qnoeh -qignerrno -qstackprotect&quot;
578   elif test &quot;x$TOOLCHAIN_TYPE&quot; = xmicrosoft; then
579     TOOLCHAIN_CFLAGS_JVM=&quot;-nologo -MD -MP&quot;
580     TOOLCHAIN_CFLAGS_JDK=&quot;-nologo -MD -Zc:wchar_t-&quot;
581   fi
582 
583   # CFLAGS C language level for JDK sources (hotspot only uses C++)
584   # Ideally we would have a common level across all toolchains so that all sources
585   # are sure to conform to the same standard. Unfortunately neither our sources nor
586   # our toolchains are in a condition to support that. But what we loosely aim for is
587   # C99 level.
588   if test &quot;x$TOOLCHAIN_TYPE&quot; = xgcc || test &quot;x$TOOLCHAIN_TYPE&quot; = xclang || test &quot;x$TOOLCHAIN_TYPE&quot; = xxlc; then
589     # Explicitly set C99. clang and xlclang support the same flag.
590     LANGSTD_CFLAGS=&quot;-std=c99&quot;
591   elif test &quot;x$TOOLCHAIN_TYPE&quot; = xsolstudio; then
592     # We can&#39;t turn on -std=c99 without breaking compilation of the splashscreen/png
593     # utilities. But we can enable c99 as below (previously achieved by using -Xa).
594     # It is the no_lib that makes the difference.
595     LANGSTD_CFLAGS=&quot;-xc99=all,no_lib&quot;
596   elif test &quot;x$TOOLCHAIN_TYPE&quot; = xmicrosoft; then
597     # MSVC doesn&#39;t support C99/C11 explicitly, unless you compile as C++:
598     # LANGSTD_CFLAGS=&quot;-TP&quot;
599     # but that requires numerous changes to the sources files. So we are limited
600     # to C89/C90 plus whatever extensions Visual Studio has decided to implement.
601     # This is the lowest bar for shared code.
602     LANGSTD_CFLAGS=&quot;&quot;
603   fi
604   TOOLCHAIN_CFLAGS_JDK_CONLY=&quot;$LANGSTD_CFLAGS $TOOLCHAIN_CFLAGS_JDK_CONLY&quot;
605 
606   # CFLAGS WARNINGS STUFF
607   # Set JVM_CFLAGS warning handling
608   if test &quot;x$TOOLCHAIN_TYPE&quot; = xgcc; then
609     WARNING_CFLAGS_JDK_CONLY=&quot;$WARNINGS_ENABLE_ALL_CFLAGS&quot;
610     WARNING_CFLAGS_JDK_CXXONLY=&quot;$WARNINGS_ENABLE_ALL_CXXFLAGS&quot;
611     WARNING_CFLAGS_JVM=&quot;$WARNINGS_ENABLE_ALL_CXXFLAGS&quot;
612 
613   elif test &quot;x$TOOLCHAIN_TYPE&quot; = xclang; then
614     WARNING_CFLAGS=&quot;$WARNINGS_ENABLE_ALL&quot;
615 
616   elif test &quot;x$TOOLCHAIN_TYPE&quot; = xsolstudio; then
617     WARNING_CFLAGS_JDK_CONLY=&quot;$WARNINGS_ENABLE_ALL_CFLAGS&quot;
618     WARNING_CFLAGS_JDK_CXXONLY=&quot;$WARNINGS_ENABLE_ALL_CXXFLAGS&quot;
619     WARNING_CFLAGS_JVM=&quot;$WARNINGS_ENABLE_ALL_CXXFLAGS&quot;
620 
621   elif test &quot;x$TOOLCHAIN_TYPE&quot; = xmicrosoft; then
622     WARNING_CFLAGS=&quot;$WARNINGS_ENABLE_ALL&quot;
623 
624   elif test &quot;x$TOOLCHAIN_TYPE&quot; = xxlc; then
625     WARNING_CFLAGS=&quot;&quot;  # currently left empty
626   fi
627 
628   # Set some additional per-OS defines.
629 
630   # Additional macosx handling
631   if test &quot;x$OPENJDK_TARGET_OS&quot; = xmacosx; then
632     OS_CFLAGS=&quot;-DMAC_OS_X_VERSION_MIN_REQUIRED=$MACOSX_VERSION_MIN_NODOTS \
633         -mmacosx-version-min=$MACOSX_VERSION_MIN&quot;
634 
635     if test -n &quot;$MACOSX_VERSION_MAX&quot;; then
636         OS_CFLAGS=&quot;$OS_CFLAGS \
637             -DMAC_OS_X_VERSION_MAX_ALLOWED=$MACOSX_VERSION_MAX_NODOTS&quot;
638     fi
639   fi
640 
641   # Where does this really belong??
642   if test &quot;x$TOOLCHAIN_TYPE&quot; = xgcc || test &quot;x$TOOLCHAIN_TYPE&quot; = xclang; then
643     PICFLAG=&quot;-fPIC&quot;
644     PIEFLAG=&quot;-fPIE&quot;
645   elif test &quot;x$TOOLCHAIN_TYPE&quot; = xsolstudio; then
646     PICFLAG=&quot;-KPIC&quot;
647   elif test &quot;x$TOOLCHAIN_TYPE&quot; = xxlc; then
648     # &#39;-qpic&#39; defaults to &#39;qpic=small&#39;. This means that the compiler generates only
649     # one instruction for accessing the TOC. If the TOC grows larger than 64K, the linker
650     # will have to patch this single instruction with a call to some out-of-order code which
651     # does the load from the TOC. This is of course slower, and we also would have
652     # to use &#39;-bbigtoc&#39; for linking anyway so we could also change the PICFLAG to &#39;qpic=large&#39;.
653     # With &#39;qpic=large&#39; the compiler will by default generate a two-instruction sequence which
654     # can be patched directly by the linker and does not require a jump to out-of-order code.
655     #
656     # Since large TOC causes perf. overhead, only pay it where we must. Currently this is
657     # for all libjvm variants (both gtest and normal) but no other binaries. So, build
658     # libjvm with -qpic=large and link with -bbigtoc.
659     JVM_PICFLAG=&quot;-qpic=large&quot;
660     JDK_PICFLAG=&quot;-qpic&quot;
661   elif test &quot;x$TOOLCHAIN_TYPE&quot; = xmicrosoft; then
662     PICFLAG=&quot;&quot;
663   fi
664 
665   if test &quot;x$TOOLCHAIN_TYPE&quot; != xxlc; then
666     JVM_PICFLAG=&quot;$PICFLAG&quot;
667     JDK_PICFLAG=&quot;$PICFLAG&quot;
668   fi
669 
670   if test &quot;x$OPENJDK_TARGET_OS&quot; = xmacosx; then
671     # Linking is different on MacOSX
672     JDK_PICFLAG=&#39;&#39;
673     if test &quot;x$STATIC_BUILD&quot; = xtrue; then
674       JVM_PICFLAG=&quot;&quot;
675     fi
676   fi
677 
678   # Optional POSIX functionality needed by the JVM
679   #
680   # Check if clock_gettime is available and in which library. This indicates
681   # availability of CLOCK_MONOTONIC for hotspot. But we don&#39;t need to link, so
682   # don&#39;t let it update LIBS.
683   save_LIBS=&quot;$LIBS&quot;
684   AC_SEARCH_LIBS(clock_gettime, rt, [HAS_CLOCK_GETTIME=true], [])
685   if test &quot;x$LIBS&quot; = &quot;x-lrt &quot;; then
686     CLOCK_GETTIME_IN_LIBRT=true
687   fi
688   LIBS=&quot;$save_LIBS&quot;
689 
690   if test &quot;x$HAS_CLOCK_GETTIME&quot; = &quot;xtrue&quot;; then
691     OS_CFLAGS_JVM=&quot;$OS_CFLAGS_JVM -DSUPPORTS_CLOCK_MONOTONIC&quot;
692     if test &quot;x$CLOCK_GETTIME_IN_LIBRT&quot; = &quot;xtrue&quot;; then
693       OS_CFLAGS_JVM=&quot;$OS_CFLAGS_JVM -DNEEDS_LIBRT&quot;
694     fi
695   fi
696 
697   # Extra flags needed when building optional static versions of certain
698   # JDK libraries.
699   STATIC_LIBS_CFLAGS=&quot;-DSTATIC_BUILD=1&quot;
700   if test &quot;x$TOOLCHAIN_TYPE&quot; = xgcc || test &quot;x$TOOLCHAIN_TYPE&quot; = xclang; then
701     STATIC_LIBS_CFLAGS=&quot;$STATIC_LIBS_CFLAGS -ffunction-sections -fdata-sections \
702       -DJNIEXPORT=&#39;__attribute__((visibility(\&quot;hidden\&quot;)))&#39;&quot;
703   else
704     STATIC_LIBS_CFLAGS=&quot;$STATIC_LIBS_CFLAGS -DJNIEXPORT=&quot;
705   fi
706   if test &quot;x$TOOLCHAIN_TYPE&quot; = xgcc; then
707     # Disable relax-relocation to enable compatibility with older linkers
708     RELAX_RELOCATIONS_FLAG=&quot;-Xassembler -mrelax-relocations=no&quot;
709     FLAGS_COMPILER_CHECK_ARGUMENTS(ARGUMENT: [${RELAX_RELOCATIONS_FLAG}],
710         IF_TRUE: [STATIC_LIBS_CFLAGS=&quot;$STATIC_LIBS_CFLAGS ${RELAX_RELOCATIONS_FLAG}&quot;])
711   fi
712   AC_SUBST(STATIC_LIBS_CFLAGS)
713 ])
714 
715 ################################################################################
716 # $1 - Either BUILD or TARGET to pick the correct OS/CPU variables to check
717 #      conditionals against.
718 # $2 - Optional prefix for each variable defined.
719 # $3 - Optional prefix for compiler variables (either BUILD_ or nothing).
720 AC_DEFUN([FLAGS_SETUP_CFLAGS_CPU_DEP],
721 [
722   #### CPU DEFINES, these should (in theory) be independent on toolchain
723 
724   # Setup target CPU
725   # Setup endianness
726   if test &quot;x$FLAGS_CPU_ENDIAN&quot; = xlittle; then
727     $1_DEFINES_CPU_JVM=&quot;-DVM_LITTLE_ENDIAN&quot;
728   fi
729   if test &quot;x$TOOLCHAIN_TYPE&quot; = xsolstudio; then
730     # The macro _LITTLE_ENDIAN needs to be defined the same to avoid the
731     #   Sun C compiler warning message: warning: macro redefined: _LITTLE_ENDIAN
732     if test &quot;x$FLAGS_CPU_ENDIAN&quot; = xlittle; then
733       $1_DEFINES_CPU_JDK=&quot;-D_LITTLE_ENDIAN=&quot;
734     else
735       $1_DEFINES_CPU_JDK=&quot;-D_BIG_ENDIAN=&quot;
736     fi
737   else
738     if test &quot;x$FLAGS_CPU_ENDIAN&quot; = xlittle; then
739       $1_DEFINES_CPU_JDK=&quot;-D_LITTLE_ENDIAN&quot;
740     else
741       $1_DEFINES_CPU_JDK=&quot;-D_BIG_ENDIAN&quot;
742     fi
743   fi
744 
745   # setup CPU bit size
746   $1_DEFINES_CPU_JDK=&quot;${$1_DEFINES_CPU_JDK} -DARCH=&#39;\&quot;$FLAGS_CPU_LEGACY\&quot;&#39; \
747       -D$FLAGS_CPU_LEGACY&quot;
748 
749   if test &quot;x$FLAGS_CPU_BITS&quot; = x64; then
750     # -D_LP64=1 is only set on linux and mac. Setting on windows causes diff in
751     # unpack200.exe.
752     if test &quot;x$FLAGS_OS&quot; = xlinux || test &quot;x$FLAGS_OS&quot; = xmacosx; then
753       $1_DEFINES_CPU_JDK=&quot;${$1_DEFINES_CPU_JDK} -D_LP64=1&quot;
754     fi
755     if test &quot;x$FLAGS_OS&quot; != xsolaris &amp;&amp; test &quot;x$FLAGS_OS&quot; != xaix; then
756       # Solaris does not have _LP64=1 in the old build.
757       # xlc on AIX defines _LP64=1 by default and issues a warning if we redefine it.
758       $1_DEFINES_CPU_JVM=&quot;${$1_DEFINES_CPU_JVM} -D_LP64=1&quot;
759     fi
760   fi
761 
762   # toolchain dependend, per-cpu
763   if test &quot;x$TOOLCHAIN_TYPE&quot; = xsolstudio; then
764     if test &quot;x$FLAGS_CPU_ARCH&quot; = xx86; then
765       $1_DEFINES_CPU_JDK=&quot;${$1_DEFINES_CPU_JDK} -DcpuIntel -Di586 -D$FLAGS_CPU_LEGACY_LIB&quot;
766     fi
767   elif test &quot;x$TOOLCHAIN_TYPE&quot; = xmicrosoft; then
768     if test &quot;x$FLAGS_CPU&quot; = xx86_64; then
769       $1_DEFINES_CPU_JDK=&quot;${$1_DEFINES_CPU_JDK} -D_AMD64_ -Damd64&quot;
770     else
771       $1_DEFINES_CPU_JDK=&quot;${$1_DEFINES_CPU_JDK} -D_X86_ -Dx86&quot;
772     fi
773   fi
774 
775   # CFLAGS PER CPU
776   if test &quot;x$TOOLCHAIN_TYPE&quot; = xgcc || test &quot;x$TOOLCHAIN_TYPE&quot; = xclang; then
777     # COMMON to gcc and clang
778     if test &quot;x$FLAGS_CPU&quot; = xx86; then
779       # Force compatibility with i586 on 32 bit intel platforms.
780       $1_CFLAGS_CPU=&quot;-march=i586&quot;
781     fi
782   fi
783 
784   if test &quot;x$TOOLCHAIN_TYPE&quot; = xgcc; then
785     if test &quot;x$FLAGS_CPU&quot; = xarm; then
786       # -Wno-psabi to get rid of annoying &quot;note: the mangling of &#39;va_list&#39; has changed in GCC 4.4&quot;
787       $1_CFLAGS_CPU=&quot;-fsigned-char -Wno-psabi $ARM_ARCH_TYPE_FLAGS $ARM_FLOAT_TYPE_FLAGS -DJDK_ARCH_ABI_PROP_NAME=&#39;\&quot;\$(JDK_ARCH_ABI_PROP_NAME)\&quot;&#39;&quot;
788       $1_CFLAGS_CPU_JVM=&quot;-DARM&quot;
789     elif test &quot;x$FLAGS_CPU_ARCH&quot; = xppc; then
790       $1_CFLAGS_CPU_JVM=&quot;-minsert-sched-nops=regroup_exact -mno-multiple -mno-string&quot;
791       if test &quot;x$FLAGS_CPU&quot; = xppc64; then
792         # -mminimal-toc fixes `relocation truncated to fit&#39; error for gcc 4.1.
793         # Use ppc64 instructions, but schedule for power5
794         $1_CFLAGS_CPU_JVM=&quot;${$1_CFLAGS_CPU_JVM} -mminimal-toc -mcpu=powerpc64 -mtune=power5&quot;
795       elif test &quot;x$FLAGS_CPU&quot; = xppc64le; then
796         # Little endian machine uses ELFv2 ABI.
797         # Use Power8, this is the first CPU to support PPC64 LE with ELFv2 ABI.
798         $1_CFLAGS_CPU_JVM=&quot;${$1_CFLAGS_CPU_JVM} -DABI_ELFv2 -mcpu=power8 -mtune=power8&quot;
799       fi
800     elif test &quot;x$FLAGS_CPU&quot; = xs390x; then
801       $1_CFLAGS_CPU=&quot;-mbackchain -march=z10&quot;
802     fi
803 
804     if test &quot;x$FLAGS_CPU_ARCH&quot; != xarm &amp;&amp;  test &quot;x$FLAGS_CPU_ARCH&quot; != xppc; then
805       # for all archs except arm and ppc, prevent gcc to omit frame pointer
806       $1_CFLAGS_CPU_JDK=&quot;${$1_CFLAGS_CPU_JDK} -fno-omit-frame-pointer&quot;
807     fi
808 
809     $1_CXXSTD_CXXFLAG=&quot;-std=gnu++98&quot;
810     FLAGS_CXX_COMPILER_CHECK_ARGUMENTS(ARGUMENT: [${$1_CXXSTD_CXXFLAG}],
811         PREFIX: $3, IF_FALSE: [$1_CXXSTD_CXXFLAG=&quot;&quot;])
812     $1_TOOLCHAIN_CFLAGS_JDK_CXXONLY=&quot;${$1_CXXSTD_CXXFLAG}&quot;
813     $1_TOOLCHAIN_CFLAGS_JVM=&quot;${$1_TOOLCHAIN_CFLAGS_JVM} ${$1_CXXSTD_CXXFLAG}&quot;
814     $2ADLC_CXXFLAG=&quot;${$1_CXXSTD_CXXFLAG}&quot;
815 
816   elif test &quot;x$TOOLCHAIN_TYPE&quot; = xclang; then
817     if test &quot;x$FLAGS_OS&quot; = xlinux; then
818       # ppc test not really needed for clang
819       if test &quot;x$FLAGS_CPU_ARCH&quot; != xarm &amp;&amp;  test &quot;x$FLAGS_CPU_ARCH&quot; != xppc; then
820         # for all archs except arm and ppc, prevent gcc to omit frame pointer
821         $1_CFLAGS_CPU_JDK=&quot;${$1_CFLAGS_CPU_JDK} -fno-omit-frame-pointer&quot;
822       fi
823     fi
824 
825   elif test &quot;x$TOOLCHAIN_TYPE&quot; = xsolstudio; then
826     if test &quot;x$FLAGS_CPU&quot; = xx86_64; then
827       # NOTE: -xregs=no%frameptr is supposed to be default on x64
828       $1_CFLAGS_CPU_JDK=&quot;-xregs=no%frameptr&quot;
829     elif test &quot;x$FLAGS_CPU&quot; = xsparcv9; then
830       $1_CFLAGS_CPU_JVM=&quot;-xarch=sparc&quot;
831       $1_CFLAGS_CPU_JDK_LIBONLY=&quot;-xregs=no%appl&quot;
832     fi
833 
834   elif test &quot;x$TOOLCHAIN_TYPE&quot; = xxlc; then
835     if test &quot;x$FLAGS_CPU&quot; = xppc64; then
836       $1_CFLAGS_CPU_JVM=&quot;-qarch=ppc64&quot;
837     fi
838 
839   elif test &quot;x$TOOLCHAIN_TYPE&quot; = xmicrosoft; then
840     if test &quot;x$FLAGS_CPU&quot; = xx86; then
841       $1_CFLAGS_CPU_JVM=&quot;-arch:IA32&quot;
842     elif test &quot;x$OPENJDK_TARGET_CPU&quot; = xx86_64; then
843       if test &quot;x$DEBUG_LEVEL&quot; != xrelease; then
844         # NOTE: This is probably redundant; -homeparams is default on
845         # non-release builds.
846         $1_CFLAGS_CPU_JVM=&quot;-homeparams&quot;
847       fi
848     fi
849   fi
850 
851   if test &quot;x$TOOLCHAIN_TYPE&quot; = xgcc; then
852     FLAGS_SETUP_GCC6_COMPILER_FLAGS($1, $3)
853     $1_TOOLCHAIN_CFLAGS=&quot;${$1_GCC6_CFLAGS}&quot;
854 
855     $1_WARNING_CFLAGS_JVM=&quot;-Wno-format-zero-length -Wtype-limits -Wuninitialized&quot;
856   fi
857 
858   # Prevent the __FILE__ macro from generating absolute paths into the built
859   # binaries. Depending on toolchain, different mitigations are possible.
860   # * GCC and Clang of new enough versions have -fmacro-prefix-map.
861   # * For most other toolchains, supplying all source files and -I flags as
862   #   relative paths fixes the issue.
863   FILE_MACRO_CFLAGS=
864   if test &quot;x$ALLOW_ABSOLUTE_PATHS_IN_OUTPUT&quot; = &quot;xfalse&quot;; then
865     if test &quot;x$TOOLCHAIN_TYPE&quot; = xgcc || test &quot;x$TOOLCHAIN_TYPE&quot; = xclang; then
866       # Check if compiler supports -fmacro-prefix-map. If so, use that to make
867       # the __FILE__ macro resolve to paths relative to the workspace root.
868       workspace_root_trailing_slash=&quot;${WORKSPACE_ROOT%/}/&quot;
869       FILE_MACRO_CFLAGS=&quot;-fmacro-prefix-map=${workspace_root_trailing_slash}=&quot;
870       FLAGS_COMPILER_CHECK_ARGUMENTS(ARGUMENT: [${FILE_MACRO_CFLAGS}],
871           PREFIX: $3,
872           IF_FALSE: [
873               FILE_MACRO_CFLAGS=
874           ]
875       )
876     fi
877   fi
878   AC_SUBST(FILE_MACRO_CFLAGS)
879 
880   # EXPORT to API
881   CFLAGS_JVM_COMMON=&quot;$ALWAYS_CFLAGS_JVM $ALWAYS_DEFINES_JVM \
882       $TOOLCHAIN_CFLAGS_JVM ${$1_TOOLCHAIN_CFLAGS_JVM} \
883       $OS_CFLAGS $OS_CFLAGS_JVM $CFLAGS_OS_DEF_JVM $DEBUG_CFLAGS_JVM \
884       $WARNING_CFLAGS $WARNING_CFLAGS_JVM $JVM_PICFLAG $FILE_MACRO_CFLAGS&quot;
885 
886   CFLAGS_JDK_COMMON=&quot;$ALWAYS_CFLAGS_JDK $ALWAYS_DEFINES_JDK $TOOLCHAIN_CFLAGS_JDK \
887       $OS_CFLAGS $CFLAGS_OS_DEF_JDK $DEBUG_CFLAGS_JDK $DEBUG_OPTIONS_FLAGS_JDK \
888       $WARNING_CFLAGS $WARNING_CFLAGS_JDK $DEBUG_SYMBOLS_CFLAGS_JDK \
889       $FILE_MACRO_CFLAGS&quot;
890 
891   # Use ${$2EXTRA_CFLAGS} to block EXTRA_CFLAGS to be added to build flags.
892   # (Currently we don&#39;t have any OPENJDK_BUILD_EXTRA_CFLAGS, but that might
893   # change in the future.)
894 
895   CFLAGS_JDK_COMMON_CONLY=&quot;$TOOLCHAIN_CFLAGS_JDK_CONLY  \
896       $WARNING_CFLAGS_JDK_CONLY ${$2EXTRA_CFLAGS}&quot;
897   CFLAGS_JDK_COMMON_CXXONLY=&quot;$ALWAYS_DEFINES_JDK_CXXONLY \
898       $TOOLCHAIN_CFLAGS_JDK_CXXONLY \
899       ${$1_TOOLCHAIN_CFLAGS_JDK_CXXONLY} \
900       $WARNING_CFLAGS_JDK_CXXONLY ${$2EXTRA_CXXFLAGS}&quot;
901 
902   $1_CFLAGS_JVM=&quot;${$1_DEFINES_CPU_JVM} ${$1_CFLAGS_CPU} ${$1_CFLAGS_CPU_JVM} ${$1_TOOLCHAIN_CFLAGS} ${$1_WARNING_CFLAGS_JVM}&quot;
903   $1_CFLAGS_JDK=&quot;${$1_DEFINES_CPU_JDK} ${$1_CFLAGS_CPU} ${$1_CFLAGS_CPU_JDK} ${$1_TOOLCHAIN_CFLAGS}&quot;
904 
905   $2JVM_CFLAGS=&quot;$CFLAGS_JVM_COMMON ${$1_CFLAGS_JVM} ${$2EXTRA_CXXFLAGS}&quot;
906 
907   $2CFLAGS_JDKEXE=&quot;$CFLAGS_JDK_COMMON $CFLAGS_JDK_COMMON_CONLY ${$1_CFLAGS_JDK} $PIEFLAG&quot;
908   $2CXXFLAGS_JDKEXE=&quot;$CFLAGS_JDK_COMMON $CFLAGS_JDK_COMMON_CXXONLY ${$1_CFLAGS_JDK} $PIEFLAG&quot;
909   $2CFLAGS_JDKLIB=&quot;$CFLAGS_JDK_COMMON $CFLAGS_JDK_COMMON_CONLY ${$1_CFLAGS_JDK} \
910       $JDK_PICFLAG ${$1_CFLAGS_CPU_JDK_LIBONLY}&quot;
911   $2CXXFLAGS_JDKLIB=&quot;$CFLAGS_JDK_COMMON $CFLAGS_JDK_COMMON_CXXONLY ${$1_CFLAGS_JDK} \
912       $JDK_PICFLAG ${$1_CFLAGS_CPU_JDK_LIBONLY}&quot;
913 
914   AC_SUBST($2JVM_CFLAGS)
915   AC_SUBST($2CFLAGS_JDKLIB)
916   AC_SUBST($2CFLAGS_JDKEXE)
917   AC_SUBST($2CXXFLAGS_JDKLIB)
918   AC_SUBST($2CXXFLAGS_JDKEXE)
919   AC_SUBST($2ADLC_CXXFLAG)
920 
921   COMPILER_FP_CONTRACT_OFF_FLAG=&quot;-ffp-contract=off&quot;
922   # Check that the compiler supports -ffp-contract=off flag
923   # Set FDLIBM_CFLAGS to -ffp-contract=off if it does. Empty
924   # otherwise.
925   # These flags are required for GCC-based builds of
926   # fdlibm with optimization without losing precision.
927   # Notably, -ffp-contract=off needs to be added for GCC &gt;= 4.6.
928   if test &quot;x$TOOLCHAIN_TYPE&quot; = xgcc || test &quot;x$TOOLCHAIN_TYPE&quot; = xclang; then
929     FLAGS_COMPILER_CHECK_ARGUMENTS(ARGUMENT: [${COMPILER_FP_CONTRACT_OFF_FLAG}],
930         PREFIX: $3,
931         IF_TRUE: [$2FDLIBM_CFLAGS=${COMPILER_FP_CONTRACT_OFF_FLAG}],
932         IF_FALSE: [$2FDLIBM_CFLAGS=&quot;&quot;])
933   fi
934   AC_SUBST($2FDLIBM_CFLAGS)
935 ])
936 
937 # FLAGS_SETUP_GCC6_COMPILER_FLAGS([PREFIX])
938 # Arguments:
939 # $1 - Prefix for each variable defined.
940 # $2 - Prefix for compiler variables (either BUILD_ or nothing).
941 AC_DEFUN([FLAGS_SETUP_GCC6_COMPILER_FLAGS],
942 [
943   # These flags are required for GCC 6 builds as undefined behaviour in OpenJDK code
944   # runs afoul of the more aggressive versions of these optimisations.
945   # Notably, value range propagation now assumes that the this pointer of C++
946   # member functions is non-null.
947   NO_DELETE_NULL_POINTER_CHECKS_CFLAG=&quot;-fno-delete-null-pointer-checks&quot;
948   FLAGS_COMPILER_CHECK_ARGUMENTS(ARGUMENT: [$NO_DELETE_NULL_POINTER_CHECKS_CFLAG],
949       PREFIX: $2, IF_FALSE: [NO_DELETE_NULL_POINTER_CHECKS_CFLAG=&quot;&quot;])
950   NO_LIFETIME_DSE_CFLAG=&quot;-fno-lifetime-dse&quot;
951   FLAGS_COMPILER_CHECK_ARGUMENTS(ARGUMENT: [$NO_LIFETIME_DSE_CFLAG],
952       PREFIX: $2, IF_FALSE: [NO_LIFETIME_DSE_CFLAG=&quot;&quot;])
953   $1_GCC6_CFLAGS=&quot;${NO_DELETE_NULL_POINTER_CHECKS_CFLAG} ${NO_LIFETIME_DSE_CFLAG}&quot;
954 ])
955 
956 # Documentation on common flags used for solstudio in HIGHEST.
957 #
958 # WARNING: Use of OPTIMIZATION_LEVEL=HIGHEST in your Makefile needs to be
959 #          done with care, there are some assumptions below that need to
960 #          be understood about the use of pointers, and IEEE behavior.
961 #
962 # -fns: Use non-standard floating point mode (not IEEE 754)
963 # -fsimple: Do some simplification of floating point arithmetic (not IEEE 754)
964 # -fsingle: Use single precision floating point with &#39;float&#39;
965 # -xalias_level=basic: Assume memory references via basic pointer types do not alias
966 #   (Source with excessing pointer casting and data access with mixed
967 #    pointer types are not recommended)
968 # -xbuiltin=%all: Use intrinsic or inline versions for math/std functions
969 #   (If you expect perfect errno behavior, do not use this)
970 # -xdepend: Loop data dependency optimizations (need -xO3 or higher)
971 # -xrestrict: Pointer parameters to functions do not overlap
972 #   (Similar to -xalias_level=basic usage, but less obvious sometimes.
973 #    If you pass in multiple pointers to the same data, do not use this)
974 # -xlibmil: Inline some library routines
975 #   (If you expect perfect errno behavior, do not use this)
976 # -xlibmopt: Use optimized math routines (CURRENTLY DISABLED)
977 #   (If you expect perfect errno behavior, do not use this)
978 #  Can cause undefined external on Solaris 8 X86 on __sincos, removing for now
    </pre>
  </body>
</html>