<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Old make/hotspot/gensrc/GensrcAdlc.gmk</title>
    <link rel="stylesheet" href="../../../style.css" />
  </head>
  <body>
    <pre>
  1 #
  2 # Copyright (c) 2013, 2019, Oracle and/or its affiliates. All rights reserved.
  3 # DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4 #
  5 # This code is free software; you can redistribute it and/or modify it
  6 # under the terms of the GNU General Public License version 2 only, as
  7 # published by the Free Software Foundation.  Oracle designates this
  8 # particular file as subject to the &quot;Classpath&quot; exception as provided
  9 # by Oracle in the LICENSE file that accompanied this code.
 10 #
 11 # This code is distributed in the hope that it will be useful, but WITHOUT
 12 # ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 13 # FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 14 # version 2 for more details (a copy is included in the LICENSE file that
 15 # accompanied this code).
 16 #
 17 # You should have received a copy of the GNU General Public License version
 18 # 2 along with this work; if not, write to the Free Software Foundation,
 19 # Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 20 #
 21 # Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 22 # or visit www.oracle.com if you need additional information or have any
 23 # questions.
 24 #
 25 
 26 $(eval $(call IncludeCustomExtension, hotspot/gensrc/GensrcAdlc.gmk))
 27 
 28 ifeq ($(call check-jvm-feature, compiler2), true)
 29 
 30   ADLC_SUPPORT_DIR := $(JVM_SUPPORT_DIR)/adlc
 31 
 32   ##############################################################################
 33   # Build the ad compiler (the adlc build tool)
 34 
 35   # Flags depending on the build platform/tool chain
 36   # NOTE: No optimization or debug flags set here
 37   ifeq ($(call isBuildOs, linux), true)
 38     ADLC_CFLAGS := -fno-exceptions -DLINUX
 39   else ifeq ($(call isBuildOs, solaris), true)
 40     ADLC_LDFLAGS := -m64
 41     ADLC_CFLAGS := -m64
 42     ADLC_CFLAGS_WARNINGS := +w
 43   else ifeq ($(call isBuildOs, aix), true)
 44     ADLC_LDFLAGS := -q64
 45     ADLC_CFLAGS := -qnortti -qeh -q64 -DAIX
 46   else ifeq ($(call isBuildOs, windows), true)
 47     ADLC_LDFLAGS := -nologo
 48     ADLC_CFLAGS := -nologo -EHsc
 49     # NOTE: The old build also have -D_CRT_SECURE_NO_DEPRECATE but it doesn&#39;t
 50     # seem needed any more.
 51     ADLC_CFLAGS_WARNINGS := -W3 -D_CRT_SECURE_NO_WARNINGS
 52   endif
 53 
 54   # Set the C++ standard if supported
 55   ADLC_CFLAGS += $(ADLC_CXXFLAG)
 56 
 57   # NOTE: The old build didn&#39;t set -DASSERT for windows but it doesn&#39;t seem to
 58   # hurt.
 59   ADLC_CFLAGS += -DASSERT
 60 
 61   ADLC_CFLAGS += -D$(HOTSPOT_TARGET_CPU_DEFINE)
 62 
 63   ADLC_CFLAGS += -I$(TOPDIR)/src/hotspot/share
 64 
 65   $(eval $(call SetupNativeCompilation, BUILD_ADLC, \
 66       NAME := adlc, \
 67       TYPE := EXECUTABLE, \
 68       TOOLCHAIN := TOOLCHAIN_BUILD_LINK_CXX, \
 69       SRC := $(TOPDIR)/src/hotspot/share/adlc, \
 70       EXTRA_FILES := $(TOPDIR)/src/hotspot/share/opto/opcodes.cpp, \
 71       CFLAGS := $(ADLC_CFLAGS) $(ADLC_CFLAGS_WARNINGS), \
 72       LDFLAGS := $(ADLC_LDFLAGS), \
 73       LIBS := $(ADLC_LIBS), \
 74       OBJECT_DIR := $(JVM_VARIANT_OUTPUTDIR)/tools/adlc/objs, \
 75       OUTPUT_DIR := $(JVM_VARIANT_OUTPUTDIR)/tools/adlc, \
 76       DEBUG_SYMBOLS := false, \
 77       DISABLED_WARNINGS_clang := tautological-compare, \
 78       DEFINE_THIS_FILE := false, \
 79   ))
 80 
 81   ADLC_TOOL := $(BUILD_ADLC_TARGET)
 82 
 83   ##############################################################################
 84   # Transform the ad source files into C++ source files using adlc
 85 
 86   # Setup flags for the adlc build tool (ADLCFLAGS).
 87   ADLCFLAGS += -q -T
 88 
 89   # ADLC flags depending on target OS
 90   ifeq ($(call isTargetOs, linux), true)
 91     ADLCFLAGS += -DLINUX=1 -D_GNU_SOURCE=1
 92   else ifeq ($(call isTargetOs, solaris), true)
 93     ADLCFLAGS += -DSOLARIS=1 -DSPARC_WORKS=1
 94   else ifeq ($(call isTargetOs, aix), true)
 95     ADLCFLAGS += -DAIX=1
 96   else ifeq ($(call isTargetOs, macosx), true)
 97     ADLCFLAGS += -D_ALLBSD_SOURCE=1 -D_GNU_SOURCE=1
 98   endif
 99 
100   ifeq ($(call isTargetOs, windows), false)
101     # NOTE: Windows adlc flags was different in the old build. Is this really
102     # correct?
103 
104     # -g makes #line directives in the generated C++ files.
105     ADLCFLAGS += -g
106 
107     ADLCFLAGS += -D$(HOTSPOT_TARGET_CPU_DEFINE)=1
108   endif
109 
110   # This generates checks in the generated C++ files that _LP64 is correctly
111   # (un)defined when compiling them.
112   ifeq ($(call isTargetCpuBits, 64), true)
113     ADLCFLAGS += -D_LP64=1
114   else
115     ADLCFLAGS += -U_LP64
116   endif
117 
118   ifeq ($(HOTSPOT_TARGET_CPU_ARCH), arm)
119     ADLCFLAGS += -DARM=1
120   endif
121 
122   ##############################################################################
123   # Concatenate all ad source files into a single file, which will be fed to
124   # adlc. Also include a #line directive at the start of every included file
125   # (after the initial header block), stating the original source file name.
126   #
127   # Normally, debugging is done directly on the ad_&lt;arch&gt;*.cpp files, but the
128   # #line directives in those files will be pointing back to &lt;arch&gt;.ad.
129 
130   # AD_SRC_ROOTS might have been added to by a custom extension
131   AD_SRC_ROOTS += $(TOPDIR)/src/hotspot
132 
133   AD_SRC_FILES := $(call uniq, $(wildcard $(foreach d, $(AD_SRC_ROOTS), \
134       $d/cpu/$(HOTSPOT_TARGET_CPU_ARCH)/$(HOTSPOT_TARGET_CPU).ad \
135       $d/cpu/$(HOTSPOT_TARGET_CPU_ARCH)/$(HOTSPOT_TARGET_CPU_ARCH).ad \
136       $d/os_cpu/$(HOTSPOT_TARGET_OS)_$(HOTSPOT_TARGET_CPU_ARCH)/$(HOTSPOT_TARGET_OS)_$(HOTSPOT_TARGET_CPU_ARCH).ad \
137     )))
138 
139   ifeq ($(call check-jvm-feature, shenandoahgc), true)
140     AD_SRC_FILES += $(call uniq, $(wildcard $(foreach d, $(AD_SRC_ROOTS), \
141         $d/cpu/$(HOTSPOT_TARGET_CPU_ARCH)/gc/shenandoah/shenandoah_$(HOTSPOT_TARGET_CPU).ad \
142       )))
143   endif
144 
145   ifeq ($(call check-jvm-feature, zgc), true)
146     AD_SRC_FILES += $(call uniq, $(wildcard $(foreach d, $(AD_SRC_ROOTS), \
147         $d/cpu/$(HOTSPOT_TARGET_CPU_ARCH)/gc/z/z_$(HOTSPOT_TARGET_CPU).ad \
148       )))
149   endif
150 
151   SINGLE_AD_SRCFILE := $(ADLC_SUPPORT_DIR)/all-ad-src.ad
152 
153   INSERT_FILENAME_AWK_SCRIPT := \
154       &#39;{ \
155          if (CUR_FN != FILENAME) { CUR_FN=FILENAME; NR_BASE=NR-1; need_lineno=1 } \
156          if (need_lineno &amp;&amp; $$0 !~ /\/\//) \
157            { print &quot;\n\n\#line &quot; (NR-NR_BASE) &quot; \&quot;&quot; FILENAME &quot;\&quot;&quot;; need_lineno=0 }; \
158          print \
159        }&#39;
160 
161   $(SINGLE_AD_SRCFILE): $(AD_SRC_FILES)
162 	$(call LogInfo, Preprocessing adlc files $(^F))
163 	$(call MakeDir, $(@D))
164 	$(NAWK) $(INSERT_FILENAME_AWK_SCRIPT) $^ &gt; $@
165 
166   ##############################################################################
167   # Run the adlc tool on the single concatenated ad source file, and store the
168   # output in support/adlc for further processing.
169   $(eval $(call SetupExecute, adlc_run, \
170       INFO := Generating adlc files, \
171       DEPS := $(BUILD_ADLC) $(SINGLE_AD_SRCFILE), \
172       OUTPUT_DIR := $(ADLC_SUPPORT_DIR), \
173       COMMAND := $(FIXPATH) $(ADLC_TOOL) $(ADLCFLAGS) $(SINGLE_AD_SRCFILE) \
174           -c$(ADLC_SUPPORT_DIR)/ad_$(HOTSPOT_TARGET_CPU_ARCH).cpp \
175           -h$(ADLC_SUPPORT_DIR)/ad_$(HOTSPOT_TARGET_CPU_ARCH).hpp \
176           -a$(ADLC_SUPPORT_DIR)/dfa_$(HOTSPOT_TARGET_CPU_ARCH).cpp \
177           -v$(ADLC_SUPPORT_DIR)/adGlobals_$(HOTSPOT_TARGET_CPU_ARCH).hpp, \
178   ))
179 
180   ##############################################################################
181   # Finally copy the generated files from support/adlc into gensrc/adfiles,
182   # and postprocess them by fixing dummy #line directives.
183 
184   ADLC_GENERATED_FILES := $(addprefix $(JVM_VARIANT_OUTPUTDIR)/gensrc/adfiles/, \
185       ad_$(HOTSPOT_TARGET_CPU_ARCH).cpp \
186       ad_$(HOTSPOT_TARGET_CPU_ARCH).hpp \
187       ad_$(HOTSPOT_TARGET_CPU_ARCH)_clone.cpp \
188       ad_$(HOTSPOT_TARGET_CPU_ARCH)_expand.cpp \
189       ad_$(HOTSPOT_TARGET_CPU_ARCH)_format.cpp \
190       ad_$(HOTSPOT_TARGET_CPU_ARCH)_gen.cpp \
191       ad_$(HOTSPOT_TARGET_CPU_ARCH)_misc.cpp \
192       ad_$(HOTSPOT_TARGET_CPU_ARCH)_peephole.cpp \
193       ad_$(HOTSPOT_TARGET_CPU_ARCH)_pipeline.cpp \
194       adGlobals_$(HOTSPOT_TARGET_CPU_ARCH).hpp \
195       dfa_$(HOTSPOT_TARGET_CPU_ARCH).cpp \
196   )
197 
198   $(JVM_VARIANT_OUTPUTDIR)/gensrc/adfiles/%: $(adlc_run_TARGET)
199 	$(call LogInfo, Postprocessing adlc file $*)
200 	$(call MakeDir, $(@D))
201 	$(NAWK) \
202 	    &#39;BEGIN { print &quot;#line 1 \&quot;$*\&quot;&quot;; } \
203 	     /^#line 999999$$/ {print &quot;#line &quot; (NR+1) &quot; \&quot;$*\&quot;&quot;; next} \
204 	     {print}&#39; \
205 	    &lt; $(ADLC_SUPPORT_DIR)/$* &gt; $@
206 
207   TARGETS += $(ADLC_GENERATED_FILES)
208 
209 endif
    </pre>
  </body>
</html>