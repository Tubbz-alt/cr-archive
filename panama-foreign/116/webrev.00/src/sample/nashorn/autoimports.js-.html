<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Old src/sample/nashorn/autoimports.js</title>
    <link rel="stylesheet" href="../../../style.css" />
  </head>
  <body>
    <pre>
  1 # autoimports script requires -scripting mode
  2 
  3 /*
  4  * Copyright (c) 2017, Oracle and/or its affiliates. All rights reserved.
  5  *
  6  * Redistribution and use in source and binary forms, with or without
  7  * modification, are permitted provided that the following conditions
  8  * are met:
  9  *
 10  *   - Redistributions of source code must retain the above copyright
 11  *     notice, this list of conditions and the following disclaimer.
 12  *
 13  *   - Redistributions in binary form must reproduce the above copyright
 14  *     notice, this list of conditions and the following disclaimer in the
 15  *     documentation and/or other materials provided with the distribution.
 16  *
 17  *   - Neither the name of Oracle nor the names of its
 18  *     contributors may be used to endorse or promote products derived
 19  *     from this software without specific prior written permission.
 20  *
 21  * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS &quot;AS
 22  * IS&quot; AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO,
 23  * THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
 24  * PURPOSE ARE DISCLAIMED.  IN NO EVENT SHALL THE COPYRIGHT OWNER OR
 25  * CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL,
 26  * EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO,
 27  * PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR
 28  * PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF
 29  * LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING
 30  * NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS
 31  * SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 32  */
 33 
 34 /*
 35  * It is tedious to import Java classes used in a script. Sometimes it is easier
 36  * use simple names of java classes and have a script auto import Java classes. 
 37  * You can load this script at the start of an interactive jjs session or at the
 38  * start of your script. This script defines a __noSuchProperty__ hook to auto 
 39  * import Java classes as needed and when they are referred to for the first time
 40  * in your script. You can also call the &quot;autoimports&quot; function to print script 
 41  * statements that you need to use in your script, i.e., have the function generate
 42  * a script to import Java classes used by your script so far. After running your
 43  * script, you can call autoimports to get the exact Java imports you need and replace
 44  * the autoimports load with the generated import statements (to avoid costly init of
 45  * the autoimports script).
 46  *
 47  * Example usage of autoimports.js in interactive mode:
 48  *
 49  *     jjs -scripting autoimports.js -
 50  *     jjs&gt; Vector
 51  *     jjs&gt; [JavaClass java.util.Vector]
 52  */
 53 
 54 (function() {
 55     var ArrayList = Java.type(&quot;java.util.ArrayList&quot;);
 56     var HashMap = Java.type(&quot;java.util.HashMap&quot;);
 57     var Files = Java.type(&quot;java.nio.file.Files&quot;);
 58     var FileSystems = Java.type(&quot;java.nio.file.FileSystems&quot;);
 59     var URI = Java.type(&quot;java.net.URI&quot;);
 60 
 61     // initialize a class to package map by iterating all
 62     // classes available in the system by walking through &quot;jrt fs&quot;
 63     var fs = FileSystems.getFileSystem(URI.create(&quot;jrt:/&quot;));
 64     var root = fs.getPath(&#39;/&#39;);
 65 
 66     var clsToPkg = new HashMap();
 67 
 68     function addToClsToPkg(c, p) {
 69         if (clsToPkg.containsKey(c)) {
 70             var val = clsToPkg.get(c);
 71             if (val instanceof ArrayList) {
 72                 val.add(p);
 73             } else {
 74                 var al = new ArrayList();
 75                 al.add(val);
 76                 al.add(p);
 77                 clsToPkg.put(c, al);
 78             }
 79         } else {
 80             clsToPkg.put(c, p);
 81         }
 82     }
 83 
 84     // handle collision and allow user to choose package
 85     function getPkgOfCls(c) {
 86         var val = clsToPkg.get(c);
 87         if (val instanceof ArrayList) {
 88             var count = 1;
 89             print(&quot;Multiple matches for &quot; + c + &quot;, choose package:&quot;);
 90             for each (var v in val) {
 91                 print(count + &quot;. &quot; + v);
 92                 count++;
 93             }
 94             var choice = parseInt(readLine());
 95             if (isNaN(choice) || choice &lt; 1 || choice &gt; val.size()) {
 96                 print(&quot;invalid choice: &quot; + choice);
 97                 return undefined;
 98             }
 99             return val.get(choice - 1);
100         } else {
101             return val;
102         }
103     }
104 
105     Files.walk(root).forEach(function(p) {
106         if (Files.isRegularFile(p)) {
107             var str = p.toString();
108             if (str.endsWith(&quot;.class&quot;) &amp;&amp; !str.endsWith(&quot;module-info.class&quot;)) {
109                 str = str.substring(&quot;/modules/&quot;.length);
110                 var idx = str.indexOf(&#39;/&#39;);
111                 if (idx != -1) {
112                     str = str.substring(idx + 1);
113                     if (str.startsWith(&quot;java&quot;) ||
114                         str.startsWith(&quot;javax&quot;) ||
115                         str.startsWith(&quot;org&quot;)) {
116                         var lastIdx = str.lastIndexOf(&#39;/&#39;);
117                         if (lastIdx != -1) {
118                             var pkg = str.substring(0, lastIdx).replaceAll(&#39;/&#39;, &#39;.&#39;);
119                             var cls = str.substring(lastIdx + 1, str.lastIndexOf(&quot;.class&quot;));
120                             addToClsToPkg(cls, pkg);
121                         }
122                     }
123                 }
124             }
125         } 
126     });
127 
128     var imports = new ArrayList();
129     var global = this;
130     var oldNoSuchProp = global.__noSuchProperty__;
131     this.__noSuchProperty__ = function(name) {
132         &#39;use strict&#39;;
133 
134         if (clsToPkg.containsKey(name)) {
135             var pkg = getPkgOfCls(name);
136             if (pkg) {
137                 var clsName = pkg + &quot;.&quot; + name;
138                 imports.add(&quot;var &quot; + name + &quot; = Java.type(&#39;&quot; + clsName + &quot;&#39;);&quot;);
139                 return global[name] = Java.type(clsName);
140             }
141         } else if (typeof oldNoSuchProp == &#39;function&#39;) {
142             return oldNoSuchProp.call(this, name);
143         }
144 
145         if (typeof this == &#39;undefined&#39;) {
146             throw new ReferenceError(name);
147         } else {
148             return undefined;
149         }
150     }
151 
152     this.autoimports = function() {
153         for each (var im in imports) {
154             print(im);
155         }
156     }
157 })();
    </pre>
  </body>
</html>