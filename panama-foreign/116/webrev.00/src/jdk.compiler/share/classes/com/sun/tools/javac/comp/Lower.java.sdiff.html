<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/jdk.compiler/share/classes/com/sun/tools/javac/comp/Lower.java</title>
    <link rel="stylesheet" href="../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="../../../../../../../../java.xml/share/legal/xerces.md.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="../../../../../module-info.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/jdk.compiler/share/classes/com/sun/tools/javac/comp/Lower.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
2284             setType(types.erasure(syms.classType));
2285 
2286         // process each enumeration constant, adding implicit constructor parameters
2287         int nextOrdinal = 0;
2288         ListBuffer&lt;JCExpression&gt; values = new ListBuffer&lt;&gt;();
2289         ListBuffer&lt;JCTree&gt; enumDefs = new ListBuffer&lt;&gt;();
2290         ListBuffer&lt;JCTree&gt; otherDefs = new ListBuffer&lt;&gt;();
2291         for (List&lt;JCTree&gt; defs = tree.defs;
2292              defs.nonEmpty();
2293              defs=defs.tail) {
2294             if (defs.head.hasTag(VARDEF) &amp;&amp; (((JCVariableDecl) defs.head).mods.flags &amp; ENUM) != 0) {
2295                 JCVariableDecl var = (JCVariableDecl)defs.head;
2296                 visitEnumConstantDef(var, nextOrdinal++);
2297                 values.append(make.QualIdent(var.sym));
2298                 enumDefs.append(var);
2299             } else {
2300                 otherDefs.append(defs.head);
2301             }
2302         }
2303 
<span class="line-modified">2304         // private static final T[] #VALUES = { a, b, c };</span>
<span class="line-modified">2305         Name valuesName = names.fromString(target.syntheticNameChar() + &quot;VALUES&quot;);</span>
<span class="line-modified">2306         while (tree.sym.members().findFirst(valuesName) != null) // avoid name clash</span>
<span class="line-removed">2307             valuesName = names.fromString(valuesName + &quot;&quot; + target.syntheticNameChar());</span>
2308         Type arrayType = new ArrayType(types.erasure(tree.type), syms.arrayClass);
2309         VarSymbol valuesVar = new VarSymbol(PRIVATE|FINAL|STATIC|SYNTHETIC,
2310                                             valuesName,
2311                                             arrayType,
2312                                             tree.type.tsym);
2313         JCNewArray newArray = make.NewArray(make.Type(types.erasure(tree.type)),
2314                                           List.nil(),
2315                                           values.toList());
2316         newArray.type = arrayType;
<span class="line-modified">2317         enumDefs.append(make.VarDef(valuesVar, newArray));</span>








2318         tree.sym.members().enter(valuesVar);
2319 
2320         Symbol valuesSym = lookupMethod(tree.pos(), names.values,
2321                                         tree.type, List.nil());
2322         List&lt;JCStatement&gt; valuesBody;
2323         if (useClone()) {
2324             // return (T[]) $VALUES.clone();
2325             JCTypeCast valuesResult =
2326                 make.TypeCast(valuesSym.type.getReturnType(),
2327                               make.App(make.Select(make.Ident(valuesVar),
2328                                                    syms.arrayCloneMethod)));
2329             valuesBody = List.of(make.Return(valuesResult));
2330         } else {
2331             // template: T[] $result = new T[$values.length];
<span class="line-modified">2332             Name resultName = names.fromString(target.syntheticNameChar() + &quot;result&quot;);</span>
<span class="line-removed">2333             while (tree.sym.members().findFirst(resultName) != null) // avoid name clash</span>
<span class="line-removed">2334                 resultName = names.fromString(resultName + &quot;&quot; + target.syntheticNameChar());</span>
2335             VarSymbol resultVar = new VarSymbol(FINAL|SYNTHETIC,
2336                                                 resultName,
2337                                                 arrayType,
2338                                                 valuesSym);
2339             JCNewArray resultArray = make.NewArray(make.Type(types.erasure(tree.type)),
2340                                   List.of(make.Select(make.Ident(valuesVar), syms.lengthVar)),
2341                                   null);
2342             resultArray.type = arrayType;
2343             JCVariableDecl decl = make.VarDef(resultVar, resultArray);
2344 
2345             // template: System.arraycopy($VALUES, 0, $result, 0, $VALUES.length);
2346             if (systemArraycopyMethod == null) {
2347                 systemArraycopyMethod =
2348                     new MethodSymbol(PUBLIC | STATIC,
2349                                      names.fromString(&quot;arraycopy&quot;),
2350                                      new MethodType(List.of(syms.objectType,
2351                                                             syms.intType,
2352                                                             syms.objectType,
2353                                                             syms.intType,
2354                                                             syms.intType),
</pre>
<hr />
<pre>
2401                                            make.Block(0, List.of(enum_ValueOf)));
2402         nameVal.sym = valueOf.params.head.sym;
2403         if (debugLower)
2404             System.err.println(tree.sym + &quot;.valueOf = &quot; + valueOf);
2405         enumDefs.append(valueOf);
2406 
2407         enumDefs.appendList(otherDefs.toList());
2408         tree.defs = enumDefs.toList();
2409     }
2410         // where
2411         private MethodSymbol systemArraycopyMethod;
2412         private boolean useClone() {
2413             try {
2414                 return syms.objectType.tsym.members().findFirst(names.clone) != null;
2415             }
2416             catch (CompletionFailure e) {
2417                 return false;
2418             }
2419         }
2420 







2421     /** Translate an enumeration constant and its initializer. */
2422     private void visitEnumConstantDef(JCVariableDecl var, int ordinal) {
2423         JCNewClass varDef = (JCNewClass)var.init;
2424         varDef.args = varDef.args.
2425             prepend(makeLit(syms.intType, ordinal)).
2426             prepend(makeLit(syms.stringType, var.name.toString()));
2427     }
2428 
2429     private List&lt;VarSymbol&gt; recordVars(Type t) {
2430         List&lt;VarSymbol&gt; vars = List.nil();
2431         while (!t.hasTag(NONE)) {
2432             if (t.hasTag(CLASS)) {
2433                 for (Symbol s : t.tsym.members().getSymbols(s -&gt; s.kind == VAR &amp;&amp; (s.flags() &amp; RECORD) != 0)) {
2434                     vars = vars.prepend((VarSymbol)s);
2435                 }
2436             }
2437             t = types.supertype(t);
2438         }
2439         return vars;
2440     }
</pre>
</td>
<td>
<hr />
<pre>
2284             setType(types.erasure(syms.classType));
2285 
2286         // process each enumeration constant, adding implicit constructor parameters
2287         int nextOrdinal = 0;
2288         ListBuffer&lt;JCExpression&gt; values = new ListBuffer&lt;&gt;();
2289         ListBuffer&lt;JCTree&gt; enumDefs = new ListBuffer&lt;&gt;();
2290         ListBuffer&lt;JCTree&gt; otherDefs = new ListBuffer&lt;&gt;();
2291         for (List&lt;JCTree&gt; defs = tree.defs;
2292              defs.nonEmpty();
2293              defs=defs.tail) {
2294             if (defs.head.hasTag(VARDEF) &amp;&amp; (((JCVariableDecl) defs.head).mods.flags &amp; ENUM) != 0) {
2295                 JCVariableDecl var = (JCVariableDecl)defs.head;
2296                 visitEnumConstantDef(var, nextOrdinal++);
2297                 values.append(make.QualIdent(var.sym));
2298                 enumDefs.append(var);
2299             } else {
2300                 otherDefs.append(defs.head);
2301             }
2302         }
2303 
<span class="line-modified">2304         // synthetic private static T[] $values() { return new T[] { a, b, c }; }</span>
<span class="line-modified">2305         // synthetic private static final T[] $VALUES = $values();</span>
<span class="line-modified">2306         Name valuesName = syntheticName(tree, &quot;VALUES&quot;);</span>

2307         Type arrayType = new ArrayType(types.erasure(tree.type), syms.arrayClass);
2308         VarSymbol valuesVar = new VarSymbol(PRIVATE|FINAL|STATIC|SYNTHETIC,
2309                                             valuesName,
2310                                             arrayType,
2311                                             tree.type.tsym);
2312         JCNewArray newArray = make.NewArray(make.Type(types.erasure(tree.type)),
2313                                           List.nil(),
2314                                           values.toList());
2315         newArray.type = arrayType;
<span class="line-modified">2316 </span>
<span class="line-added">2317         MethodSymbol valuesMethod = new MethodSymbol(PRIVATE|STATIC|SYNTHETIC,</span>
<span class="line-added">2318                 syntheticName(tree, &quot;values&quot;),</span>
<span class="line-added">2319                 new MethodType(List.nil(), arrayType, List.nil(), tree.type.tsym),</span>
<span class="line-added">2320                 tree.type.tsym);</span>
<span class="line-added">2321         enumDefs.append(make.MethodDef(valuesMethod, make.Block(0, List.of(make.Return(newArray)))));</span>
<span class="line-added">2322         tree.sym.members().enter(valuesMethod);</span>
<span class="line-added">2323 </span>
<span class="line-added">2324         enumDefs.append(make.VarDef(valuesVar, make.App(make.QualIdent(valuesMethod))));</span>
2325         tree.sym.members().enter(valuesVar);
2326 
2327         Symbol valuesSym = lookupMethod(tree.pos(), names.values,
2328                                         tree.type, List.nil());
2329         List&lt;JCStatement&gt; valuesBody;
2330         if (useClone()) {
2331             // return (T[]) $VALUES.clone();
2332             JCTypeCast valuesResult =
2333                 make.TypeCast(valuesSym.type.getReturnType(),
2334                               make.App(make.Select(make.Ident(valuesVar),
2335                                                    syms.arrayCloneMethod)));
2336             valuesBody = List.of(make.Return(valuesResult));
2337         } else {
2338             // template: T[] $result = new T[$values.length];
<span class="line-modified">2339             Name resultName = syntheticName(tree, &quot;result&quot;);</span>


2340             VarSymbol resultVar = new VarSymbol(FINAL|SYNTHETIC,
2341                                                 resultName,
2342                                                 arrayType,
2343                                                 valuesSym);
2344             JCNewArray resultArray = make.NewArray(make.Type(types.erasure(tree.type)),
2345                                   List.of(make.Select(make.Ident(valuesVar), syms.lengthVar)),
2346                                   null);
2347             resultArray.type = arrayType;
2348             JCVariableDecl decl = make.VarDef(resultVar, resultArray);
2349 
2350             // template: System.arraycopy($VALUES, 0, $result, 0, $VALUES.length);
2351             if (systemArraycopyMethod == null) {
2352                 systemArraycopyMethod =
2353                     new MethodSymbol(PUBLIC | STATIC,
2354                                      names.fromString(&quot;arraycopy&quot;),
2355                                      new MethodType(List.of(syms.objectType,
2356                                                             syms.intType,
2357                                                             syms.objectType,
2358                                                             syms.intType,
2359                                                             syms.intType),
</pre>
<hr />
<pre>
2406                                            make.Block(0, List.of(enum_ValueOf)));
2407         nameVal.sym = valueOf.params.head.sym;
2408         if (debugLower)
2409             System.err.println(tree.sym + &quot;.valueOf = &quot; + valueOf);
2410         enumDefs.append(valueOf);
2411 
2412         enumDefs.appendList(otherDefs.toList());
2413         tree.defs = enumDefs.toList();
2414     }
2415         // where
2416         private MethodSymbol systemArraycopyMethod;
2417         private boolean useClone() {
2418             try {
2419                 return syms.objectType.tsym.members().findFirst(names.clone) != null;
2420             }
2421             catch (CompletionFailure e) {
2422                 return false;
2423             }
2424         }
2425 
<span class="line-added">2426         private Name syntheticName(JCClassDecl tree, String baseName) {</span>
<span class="line-added">2427             Name valuesName = names.fromString(target.syntheticNameChar() + baseName);</span>
<span class="line-added">2428             while (tree.sym.members().findFirst(valuesName) != null) // avoid name clash</span>
<span class="line-added">2429                 valuesName = names.fromString(valuesName + &quot;&quot; + target.syntheticNameChar());</span>
<span class="line-added">2430             return valuesName;</span>
<span class="line-added">2431         }</span>
<span class="line-added">2432 </span>
2433     /** Translate an enumeration constant and its initializer. */
2434     private void visitEnumConstantDef(JCVariableDecl var, int ordinal) {
2435         JCNewClass varDef = (JCNewClass)var.init;
2436         varDef.args = varDef.args.
2437             prepend(makeLit(syms.intType, ordinal)).
2438             prepend(makeLit(syms.stringType, var.name.toString()));
2439     }
2440 
2441     private List&lt;VarSymbol&gt; recordVars(Type t) {
2442         List&lt;VarSymbol&gt; vars = List.nil();
2443         while (!t.hasTag(NONE)) {
2444             if (t.hasTag(CLASS)) {
2445                 for (Symbol s : t.tsym.members().getSymbols(s -&gt; s.kind == VAR &amp;&amp; (s.flags() &amp; RECORD) != 0)) {
2446                     vars = vars.prepend((VarSymbol)s);
2447                 }
2448             }
2449             t = types.supertype(t);
2450         }
2451         return vars;
2452     }
</pre>
</td>
</tr>
</table>
<center><a href="../../../../../../../../java.xml/share/legal/xerces.md.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="../../../../../module-info.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>