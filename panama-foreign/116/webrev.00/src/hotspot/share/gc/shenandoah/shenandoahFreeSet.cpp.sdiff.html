<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/hotspot/share/gc/shenandoah/shenandoahFreeSet.cpp</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
<body>
<center><a href="shenandoahControlThread.cpp.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="shenandoahHeap.cpp.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/hotspot/share/gc/shenandoah/shenandoahFreeSet.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
132           if (is_mutator_free(idx)) {
133             HeapWord* result = try_allocate_in(_heap-&gt;get_region(idx), req, in_new_region);
134             if (result != NULL) {
135               return result;
136             }
137           }
138         }
139       }
140       break;
141     }
142     default:
143       ShouldNotReachHere();
144   }
145 
146   return NULL;
147 }
148 
149 HeapWord* ShenandoahFreeSet::try_allocate_in(ShenandoahHeapRegion* r, ShenandoahAllocRequest&amp; req, bool&amp; in_new_region) {
150   assert (!has_no_alloc_capacity(r), &quot;Performance: should avoid full regions on this path: &quot; SIZE_FORMAT, r-&gt;index());
151 
<span class="line-modified">152   if (_heap-&gt;is_concurrent_root_in_progress() &amp;&amp;</span>
153       r-&gt;is_trash()) {
154     return NULL;
155   }
156 
157   try_recycle_trashed(r);
158 
159   in_new_region = r-&gt;is_empty();
160 
161   HeapWord* result = NULL;
162   size_t size = req.size();
163 
164   if (ShenandoahElasticTLAB &amp;&amp; req.is_lab_alloc()) {
165     size_t free = align_down(r-&gt;free() &gt;&gt; LogHeapWordSize, MinObjAlignment);
166     if (size &gt; free) {
167       size = free;
168     }
169     if (size &gt;= req.min_size()) {
170       result = r-&gt;allocate(size, req.type());
171       assert (result != NULL, &quot;Allocation must succeed: free &quot; SIZE_FORMAT &quot;, actual &quot; SIZE_FORMAT, free, size);
172     }
</pre>
<hr />
<pre>
320   // While individual regions report their true use, all humongous regions are
321   // marked used in the free set.
322   increase_used(ShenandoahHeapRegion::region_size_bytes() * num);
323 
324   if (remainder != 0) {
325     // Record this remainder as allocation waste
326     _heap-&gt;notify_mutator_alloc_words(ShenandoahHeapRegion::region_size_words() - remainder, true);
327   }
328 
329   // Allocated at left/rightmost? Move the bounds appropriately.
330   if (beg == _mutator_leftmost || end == _mutator_rightmost) {
331     adjust_bounds();
332   }
333   assert_bounds();
334 
335   req.set_actual_size(words_size);
336   return _heap-&gt;get_region(beg)-&gt;bottom();
337 }
338 
339 bool ShenandoahFreeSet::can_allocate_from(ShenandoahHeapRegion *r) {
<span class="line-modified">340   return r-&gt;is_empty() || (r-&gt;is_trash() &amp;&amp; !_heap-&gt;is_concurrent_root_in_progress());</span>
341 }
342 
343 size_t ShenandoahFreeSet::alloc_capacity(ShenandoahHeapRegion *r) {
344   if (r-&gt;is_trash()) {
345     // This would be recycled on allocation path
346     return ShenandoahHeapRegion::region_size_bytes();
347   } else {
348     return r-&gt;free();
349   }
350 }
351 
352 bool ShenandoahFreeSet::has_no_alloc_capacity(ShenandoahHeapRegion *r) {
353   return alloc_capacity(r) == 0;
354 }
355 
356 void ShenandoahFreeSet::try_recycle_trashed(ShenandoahHeapRegion *r) {
357   if (r-&gt;is_trash()) {
358     _heap-&gt;decrease_used(r-&gt;used());
359     r-&gt;recycle();
360   }
</pre>
</td>
<td>
<hr />
<pre>
132           if (is_mutator_free(idx)) {
133             HeapWord* result = try_allocate_in(_heap-&gt;get_region(idx), req, in_new_region);
134             if (result != NULL) {
135               return result;
136             }
137           }
138         }
139       }
140       break;
141     }
142     default:
143       ShouldNotReachHere();
144   }
145 
146   return NULL;
147 }
148 
149 HeapWord* ShenandoahFreeSet::try_allocate_in(ShenandoahHeapRegion* r, ShenandoahAllocRequest&amp; req, bool&amp; in_new_region) {
150   assert (!has_no_alloc_capacity(r), &quot;Performance: should avoid full regions on this path: &quot; SIZE_FORMAT, r-&gt;index());
151 
<span class="line-modified">152   if (_heap-&gt;is_concurrent_weak_root_in_progress() &amp;&amp;</span>
153       r-&gt;is_trash()) {
154     return NULL;
155   }
156 
157   try_recycle_trashed(r);
158 
159   in_new_region = r-&gt;is_empty();
160 
161   HeapWord* result = NULL;
162   size_t size = req.size();
163 
164   if (ShenandoahElasticTLAB &amp;&amp; req.is_lab_alloc()) {
165     size_t free = align_down(r-&gt;free() &gt;&gt; LogHeapWordSize, MinObjAlignment);
166     if (size &gt; free) {
167       size = free;
168     }
169     if (size &gt;= req.min_size()) {
170       result = r-&gt;allocate(size, req.type());
171       assert (result != NULL, &quot;Allocation must succeed: free &quot; SIZE_FORMAT &quot;, actual &quot; SIZE_FORMAT, free, size);
172     }
</pre>
<hr />
<pre>
320   // While individual regions report their true use, all humongous regions are
321   // marked used in the free set.
322   increase_used(ShenandoahHeapRegion::region_size_bytes() * num);
323 
324   if (remainder != 0) {
325     // Record this remainder as allocation waste
326     _heap-&gt;notify_mutator_alloc_words(ShenandoahHeapRegion::region_size_words() - remainder, true);
327   }
328 
329   // Allocated at left/rightmost? Move the bounds appropriately.
330   if (beg == _mutator_leftmost || end == _mutator_rightmost) {
331     adjust_bounds();
332   }
333   assert_bounds();
334 
335   req.set_actual_size(words_size);
336   return _heap-&gt;get_region(beg)-&gt;bottom();
337 }
338 
339 bool ShenandoahFreeSet::can_allocate_from(ShenandoahHeapRegion *r) {
<span class="line-modified">340   return r-&gt;is_empty() || (r-&gt;is_trash() &amp;&amp; !_heap-&gt;is_concurrent_weak_root_in_progress());</span>
341 }
342 
343 size_t ShenandoahFreeSet::alloc_capacity(ShenandoahHeapRegion *r) {
344   if (r-&gt;is_trash()) {
345     // This would be recycled on allocation path
346     return ShenandoahHeapRegion::region_size_bytes();
347   } else {
348     return r-&gt;free();
349   }
350 }
351 
352 bool ShenandoahFreeSet::has_no_alloc_capacity(ShenandoahHeapRegion *r) {
353   return alloc_capacity(r) == 0;
354 }
355 
356 void ShenandoahFreeSet::try_recycle_trashed(ShenandoahHeapRegion *r) {
357   if (r-&gt;is_trash()) {
358     _heap-&gt;decrease_used(r-&gt;used());
359     r-&gt;recycle();
360   }
</pre>
</td>
</tr>
</table>
<center><a href="shenandoahControlThread.cpp.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="shenandoahHeap.cpp.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>