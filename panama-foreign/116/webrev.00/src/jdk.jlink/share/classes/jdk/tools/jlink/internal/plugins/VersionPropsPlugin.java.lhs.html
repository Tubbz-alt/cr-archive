<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames src/jdk.jlink/share/classes/jdk/tools/jlink/internal/plugins/VersionPropsPlugin.java</title>
    <link rel="stylesheet" href="../../../../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
<a name="1" id="anc1"></a><span class="line-modified">  2  * Copyright (c) 2019, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.  Oracle designates this
  8  * particular file as subject to the &quot;Classpath&quot; exception as provided
  9  * by Oracle in the LICENSE file that accompanied this code.
 10  *
 11  * This code is distributed in the hope that it will be useful, but WITHOUT
 12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 14  * version 2 for more details (a copy is included in the LICENSE file that
 15  * accompanied this code).
 16  *
 17  * You should have received a copy of the GNU General Public License version
 18  * 2 along with this work; if not, write to the Free Software Foundation,
 19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 20  *
 21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 22  * or visit www.oracle.com if you need additional information or have any
 23  * questions.
 24  */
 25 
 26 package jdk.tools.jlink.internal.plugins;
 27 
<a name="2" id="anc2"></a><span class="line-modified"> 28 import java.io.*;</span>
<span class="line-removed"> 29 import java.nio.charset.*;</span>
<span class="line-removed"> 30 import java.util.*;</span>
<span class="line-removed"> 31 import java.util.function.*;</span>
<span class="line-removed"> 32 import java.util.stream.*;</span>
<span class="line-removed"> 33 import jdk.tools.jlink.plugin.*;</span>
<span class="line-removed"> 34 import jdk.internal.org.objectweb.asm.*;</span>
 35 
<a name="3" id="anc3"></a><span class="line-modified"> 36 import static java.lang.System.out;</span>








 37 
 38 /**
 39  * Base plugin to update a static field in java.lang.VersionProps
<a name="4" id="anc4"></a>




 40  */
 41 abstract class VersionPropsPlugin implements Plugin {
 42 
 43     private static final String VERSION_PROPS_CLASS
 44         = &quot;/java.base/java/lang/VersionProps.class&quot;;
 45 
 46     private final String name;
 47     private final String field;
 48     private String value;
 49 
 50     /**
 51      * @param field The name of the java.lang.VersionProps field to be redefined
 52      * @param option The option name
 53      */
 54     protected VersionPropsPlugin(String field, String option) {
 55         this.field = field;
 56         this.name = option;
 57     }
 58 
 59     /**
 60      * Shorthand constructor for when the option name can be derived from the
 61      * name of the field.
 62      *
 63      * @param field The name of the java.lang.VersionProps field to be redefined
 64      */
 65     protected VersionPropsPlugin(String field) {
 66         this(field, field.toLowerCase().replace(&#39;_&#39;, &#39;-&#39;));
 67     }
 68 
 69     @Override
 70     public String getName() {
 71         return name;
 72     }
 73 
 74     @Override
 75     public String getDescription() {
 76         return PluginsResourceBundle.getDescription(name);
 77     }
 78 
 79     @Override
 80     public Category getType() {
 81         return Category.TRANSFORMER;
 82     }
 83 
 84     @Override
 85     public boolean hasArguments() {
 86         return true;
 87     }
 88 
 89     @Override
 90     public boolean hasRawArgument() {
 91         return true;
 92     }
 93 
 94     @Override
 95     public String getArgumentsDescription() {
 96        return PluginsResourceBundle.getArgument(name);
 97     }
 98 
 99     @Override
100     public void configure(Map&lt;String, String&gt; config) {
101         var v = config.get(name);
102         if (v == null)
103             throw new AssertionError();
104         value = v;
105     }
106 
107     private boolean redefined = false;
108 
109     private byte[] redefine(byte[] classFile) {
110 
111         var cr = new ClassReader(classFile);
112         var cw = new ClassWriter(0);
113 
114         cr.accept(new ClassVisitor(Opcodes.ASM7, cw) {
115 
<a name="5" id="anc5"></a>
116                 public MethodVisitor visitMethod(int access,
117                                                  String name,
118                                                  String desc,
119                                                  String sig,
120                                                  String[] xs)
121                 {
122                     if (name.equals(&quot;&lt;clinit&gt;&quot;))
123                         return new MethodVisitor(Opcodes.ASM7,
124                                                  super.visitMethod(access,
125                                                                    name,
126                                                                    desc,
127                                                                    sig,
128                                                                    xs))
129                             {
<a name="6" id="anc6"></a>
























130 
<a name="7" id="anc7"></a>
131                                 public void visitFieldInsn(int opcode,
132                                                            String owner,
133                                                            String name,
134                                                            String desc)
135                                 {
136                                     if (opcode == Opcodes.PUTSTATIC
137                                         &amp;&amp; name.equals(field))
138                                     {
<a name="8" id="anc8"></a><span class="line-modified">139                                         // Discard the original value</span>
<span class="line-modified">140                                         super.visitInsn(Opcodes.POP);</span>
<span class="line-modified">141                                         // Load the value that we want</span>








142                                         super.visitLdcInsn(value);
143                                         redefined = true;
<a name="9" id="anc9"></a>

144                                     }
145                                     super.visitFieldInsn(opcode, owner,
146                                                          name, desc);
147                                 }
148 
149                         };
150                     else
151                         return super.visitMethod(access, name, desc, sig, xs);
152                 }
153 
154             }, 0);
155 
156         return cw.toByteArray();
157 
158     }
159 
160     @Override
161     public ResourcePool transform(ResourcePool in, ResourcePoolBuilder out) {
162         in.transformAndCopy(res -&gt; {
163                 if (res.type().equals(ResourcePoolEntry.Type.CLASS_OR_RESOURCE)) {
164                     if (res.path().equals(VERSION_PROPS_CLASS)) {
165                         return res.copyWithContent(redefine(res.contentBytes()));
166                     }
167                 }
168                 return res;
169             }, out);
170         if (!redefined)
171             throw new AssertionError(field);
172         return out.build();
173     }
174 
175 }
<a name="10" id="anc10"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="10" type="hidden" />
</body>
</html>