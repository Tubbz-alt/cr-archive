<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff src/jdk.jlink/share/classes/jdk/tools/jlink/internal/plugins/VersionPropsPlugin.java</title>
    <link rel="stylesheet" href="../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="../../../../../../../../jdk.jfr/share/conf/jfr/profile.jfc.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="../../../../../../../../jdk.management/share/classes/com/sun/management/OperatingSystemMXBean.java.udiff.html" target="_top">next &gt;</a></center>    <h2>src/jdk.jlink/share/classes/jdk/tools/jlink/internal/plugins/VersionPropsPlugin.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -1,7 +1,7 @@</span>
  /*
<span class="udiff-line-modified-removed">-  * Copyright (c) 2019, Oracle and/or its affiliates. All rights reserved.</span>
<span class="udiff-line-modified-added">+  * Copyright (c) 2019, 2020, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.  Oracle designates this
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -23,22 +23,29 @@</span>
   * questions.
   */
  
  package jdk.tools.jlink.internal.plugins;
  
<span class="udiff-line-modified-removed">- import java.io.*;</span>
<span class="udiff-line-removed">- import java.nio.charset.*;</span>
<span class="udiff-line-removed">- import java.util.*;</span>
<span class="udiff-line-removed">- import java.util.function.*;</span>
<span class="udiff-line-removed">- import java.util.stream.*;</span>
<span class="udiff-line-removed">- import jdk.tools.jlink.plugin.*;</span>
<span class="udiff-line-removed">- import jdk.internal.org.objectweb.asm.*;</span>
<span class="udiff-line-modified-added">+ import java.util.Map;</span>
  
<span class="udiff-line-modified-removed">- import static java.lang.System.out;</span>
<span class="udiff-line-modified-added">+ import jdk.internal.org.objectweb.asm.ClassReader;</span>
<span class="udiff-line-added">+ import jdk.internal.org.objectweb.asm.ClassVisitor;</span>
<span class="udiff-line-added">+ import jdk.internal.org.objectweb.asm.ClassWriter;</span>
<span class="udiff-line-added">+ import jdk.internal.org.objectweb.asm.MethodVisitor;</span>
<span class="udiff-line-added">+ import jdk.internal.org.objectweb.asm.Opcodes;</span>
<span class="udiff-line-added">+ import jdk.tools.jlink.plugin.Plugin;</span>
<span class="udiff-line-added">+ import jdk.tools.jlink.plugin.ResourcePool;</span>
<span class="udiff-line-added">+ import jdk.tools.jlink.plugin.ResourcePoolBuilder;</span>
<span class="udiff-line-added">+ import jdk.tools.jlink.plugin.ResourcePoolEntry;</span>
  
  /**
   * Base plugin to update a static field in java.lang.VersionProps
<span class="udiff-line-added">+  *</span>
<span class="udiff-line-added">+  * Fields to be updated must not be final such that values are not constant</span>
<span class="udiff-line-added">+  * replaced at compile time and initialization code is generated.</span>
<span class="udiff-line-added">+  * We assume that the initialization code only has ldcs, method calls and</span>
<span class="udiff-line-added">+  * field instructions.</span>
   */
  abstract class VersionPropsPlugin implements Plugin {
  
      private static final String VERSION_PROPS_CLASS
          = &quot;/java.base/java/lang/VersionProps.class&quot;;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -111,10 +118,11 @@</span>
          var cr = new ClassReader(classFile);
          var cw = new ClassWriter(0);
  
          cr.accept(new ClassVisitor(Opcodes.ASM7, cw) {
  
<span class="udiff-line-added">+                 @Override</span>
                  public MethodVisitor visitMethod(int access,
                                                   String name,
                                                   String desc,
                                                   String sig,
                                                   String[] xs)
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -125,24 +133,60 @@</span>
                                                                     name,
                                                                     desc,
                                                                     sig,
                                                                     xs))
                              {
<span class="udiff-line-added">+                                 private Object pendingLDC = null;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+                                 private void flushPendingLDC() {</span>
<span class="udiff-line-added">+                                     if (pendingLDC != null) {</span>
<span class="udiff-line-added">+                                         super.visitLdcInsn(pendingLDC);</span>
<span class="udiff-line-added">+                                         pendingLDC = null;</span>
<span class="udiff-line-added">+                                     }</span>
<span class="udiff-line-added">+                                 }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+                                 @Override</span>
<span class="udiff-line-added">+                                 public void visitLdcInsn(Object value) {</span>
<span class="udiff-line-added">+                                     flushPendingLDC();</span>
<span class="udiff-line-added">+                                     pendingLDC = value;</span>
<span class="udiff-line-added">+                                 }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+                                 @Override</span>
<span class="udiff-line-added">+                                 public void visitMethodInsn(int opcode,</span>
<span class="udiff-line-added">+                                                             String owner,</span>
<span class="udiff-line-added">+                                                             String name,</span>
<span class="udiff-line-added">+                                                             String descriptor,</span>
<span class="udiff-line-added">+                                                             boolean isInterface) {</span>
<span class="udiff-line-added">+                                     flushPendingLDC();</span>
<span class="udiff-line-added">+                                     super.visitMethodInsn(opcode, owner, name,</span>
<span class="udiff-line-added">+                                                           descriptor, isInterface);</span>
<span class="udiff-line-added">+                                 }</span>
  
<span class="udiff-line-added">+                                 @Override</span>
                                  public void visitFieldInsn(int opcode,
                                                             String owner,
                                                             String name,
                                                             String desc)
                                  {
                                      if (opcode == Opcodes.PUTSTATIC
                                          &amp;&amp; name.equals(field))
                                      {
<span class="udiff-line-modified-removed">-                                         // Discard the original value</span>
<span class="udiff-line-modified-removed">-                                         super.visitInsn(Opcodes.POP);</span>
<span class="udiff-line-modified-removed">-                                         // Load the value that we want</span>
<span class="udiff-line-modified-added">+                                         // assert that there is a pending ldc</span>
<span class="udiff-line-modified-added">+                                         // for the old value</span>
<span class="udiff-line-modified-added">+                                         if (pendingLDC == null) {</span>
<span class="udiff-line-added">+                                             throw new AssertionError(&quot;No load &quot; +</span>
<span class="udiff-line-added">+                                                 &quot;instruction found for field &quot; + field +</span>
<span class="udiff-line-added">+                                                 &quot; in static initializer of &quot; +</span>
<span class="udiff-line-added">+                                                 VERSION_PROPS_CLASS);</span>
<span class="udiff-line-added">+                                         }</span>
<span class="udiff-line-added">+                                         // forget about it</span>
<span class="udiff-line-added">+                                         pendingLDC = null;</span>
<span class="udiff-line-added">+                                         // and add an ldc for the new value</span>
                                          super.visitLdcInsn(value);
                                          redefined = true;
<span class="udiff-line-added">+                                     } else {</span>
<span class="udiff-line-added">+                                         flushPendingLDC();</span>
                                      }
                                      super.visitFieldInsn(opcode, owner,
                                                           name, desc);
                                  }
  
</pre>
<center><a href="../../../../../../../../jdk.jfr/share/conf/jfr/profile.jfc.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="../../../../../../../../jdk.management/share/classes/com/sun/management/OperatingSystemMXBean.java.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>