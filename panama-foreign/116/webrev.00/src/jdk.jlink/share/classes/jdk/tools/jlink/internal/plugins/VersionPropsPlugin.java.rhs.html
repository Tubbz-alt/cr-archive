<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames src/jdk.jlink/share/classes/jdk/tools/jlink/internal/plugins/VersionPropsPlugin.java</title>
    <link rel="stylesheet" href="../../../../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
<a name="1" id="anc1"></a><span class="line-modified">  2  * Copyright (c) 2019, 2020, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.  Oracle designates this
  8  * particular file as subject to the &quot;Classpath&quot; exception as provided
  9  * by Oracle in the LICENSE file that accompanied this code.
 10  *
 11  * This code is distributed in the hope that it will be useful, but WITHOUT
 12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 14  * version 2 for more details (a copy is included in the LICENSE file that
 15  * accompanied this code).
 16  *
 17  * You should have received a copy of the GNU General Public License version
 18  * 2 along with this work; if not, write to the Free Software Foundation,
 19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 20  *
 21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 22  * or visit www.oracle.com if you need additional information or have any
 23  * questions.
 24  */
 25 
 26 package jdk.tools.jlink.internal.plugins;
 27 
<a name="2" id="anc2"></a><span class="line-modified"> 28 import java.util.Map;</span>






 29 
<a name="3" id="anc3"></a><span class="line-modified"> 30 import jdk.internal.org.objectweb.asm.ClassReader;</span>
<span class="line-added"> 31 import jdk.internal.org.objectweb.asm.ClassVisitor;</span>
<span class="line-added"> 32 import jdk.internal.org.objectweb.asm.ClassWriter;</span>
<span class="line-added"> 33 import jdk.internal.org.objectweb.asm.MethodVisitor;</span>
<span class="line-added"> 34 import jdk.internal.org.objectweb.asm.Opcodes;</span>
<span class="line-added"> 35 import jdk.tools.jlink.plugin.Plugin;</span>
<span class="line-added"> 36 import jdk.tools.jlink.plugin.ResourcePool;</span>
<span class="line-added"> 37 import jdk.tools.jlink.plugin.ResourcePoolBuilder;</span>
<span class="line-added"> 38 import jdk.tools.jlink.plugin.ResourcePoolEntry;</span>
 39 
 40 /**
 41  * Base plugin to update a static field in java.lang.VersionProps
<a name="4" id="anc4"></a><span class="line-added"> 42  *</span>
<span class="line-added"> 43  * Fields to be updated must not be final such that values are not constant</span>
<span class="line-added"> 44  * replaced at compile time and initialization code is generated.</span>
<span class="line-added"> 45  * We assume that the initialization code only has ldcs, method calls and</span>
<span class="line-added"> 46  * field instructions.</span>
 47  */
 48 abstract class VersionPropsPlugin implements Plugin {
 49 
 50     private static final String VERSION_PROPS_CLASS
 51         = &quot;/java.base/java/lang/VersionProps.class&quot;;
 52 
 53     private final String name;
 54     private final String field;
 55     private String value;
 56 
 57     /**
 58      * @param field The name of the java.lang.VersionProps field to be redefined
 59      * @param option The option name
 60      */
 61     protected VersionPropsPlugin(String field, String option) {
 62         this.field = field;
 63         this.name = option;
 64     }
 65 
 66     /**
 67      * Shorthand constructor for when the option name can be derived from the
 68      * name of the field.
 69      *
 70      * @param field The name of the java.lang.VersionProps field to be redefined
 71      */
 72     protected VersionPropsPlugin(String field) {
 73         this(field, field.toLowerCase().replace(&#39;_&#39;, &#39;-&#39;));
 74     }
 75 
 76     @Override
 77     public String getName() {
 78         return name;
 79     }
 80 
 81     @Override
 82     public String getDescription() {
 83         return PluginsResourceBundle.getDescription(name);
 84     }
 85 
 86     @Override
 87     public Category getType() {
 88         return Category.TRANSFORMER;
 89     }
 90 
 91     @Override
 92     public boolean hasArguments() {
 93         return true;
 94     }
 95 
 96     @Override
 97     public boolean hasRawArgument() {
 98         return true;
 99     }
100 
101     @Override
102     public String getArgumentsDescription() {
103        return PluginsResourceBundle.getArgument(name);
104     }
105 
106     @Override
107     public void configure(Map&lt;String, String&gt; config) {
108         var v = config.get(name);
109         if (v == null)
110             throw new AssertionError();
111         value = v;
112     }
113 
114     private boolean redefined = false;
115 
116     private byte[] redefine(byte[] classFile) {
117 
118         var cr = new ClassReader(classFile);
119         var cw = new ClassWriter(0);
120 
121         cr.accept(new ClassVisitor(Opcodes.ASM7, cw) {
122 
<a name="5" id="anc5"></a><span class="line-added">123                 @Override</span>
124                 public MethodVisitor visitMethod(int access,
125                                                  String name,
126                                                  String desc,
127                                                  String sig,
128                                                  String[] xs)
129                 {
130                     if (name.equals(&quot;&lt;clinit&gt;&quot;))
131                         return new MethodVisitor(Opcodes.ASM7,
132                                                  super.visitMethod(access,
133                                                                    name,
134                                                                    desc,
135                                                                    sig,
136                                                                    xs))
137                             {
<a name="6" id="anc6"></a><span class="line-added">138                                 private Object pendingLDC = null;</span>
<span class="line-added">139 </span>
<span class="line-added">140                                 private void flushPendingLDC() {</span>
<span class="line-added">141                                     if (pendingLDC != null) {</span>
<span class="line-added">142                                         super.visitLdcInsn(pendingLDC);</span>
<span class="line-added">143                                         pendingLDC = null;</span>
<span class="line-added">144                                     }</span>
<span class="line-added">145                                 }</span>
<span class="line-added">146 </span>
<span class="line-added">147                                 @Override</span>
<span class="line-added">148                                 public void visitLdcInsn(Object value) {</span>
<span class="line-added">149                                     flushPendingLDC();</span>
<span class="line-added">150                                     pendingLDC = value;</span>
<span class="line-added">151                                 }</span>
<span class="line-added">152 </span>
<span class="line-added">153                                 @Override</span>
<span class="line-added">154                                 public void visitMethodInsn(int opcode,</span>
<span class="line-added">155                                                             String owner,</span>
<span class="line-added">156                                                             String name,</span>
<span class="line-added">157                                                             String descriptor,</span>
<span class="line-added">158                                                             boolean isInterface) {</span>
<span class="line-added">159                                     flushPendingLDC();</span>
<span class="line-added">160                                     super.visitMethodInsn(opcode, owner, name,</span>
<span class="line-added">161                                                           descriptor, isInterface);</span>
<span class="line-added">162                                 }</span>
163 
<a name="7" id="anc7"></a><span class="line-added">164                                 @Override</span>
165                                 public void visitFieldInsn(int opcode,
166                                                            String owner,
167                                                            String name,
168                                                            String desc)
169                                 {
170                                     if (opcode == Opcodes.PUTSTATIC
171                                         &amp;&amp; name.equals(field))
172                                     {
<a name="8" id="anc8"></a><span class="line-modified">173                                         // assert that there is a pending ldc</span>
<span class="line-modified">174                                         // for the old value</span>
<span class="line-modified">175                                         if (pendingLDC == null) {</span>
<span class="line-added">176                                             throw new AssertionError(&quot;No load &quot; +</span>
<span class="line-added">177                                                 &quot;instruction found for field &quot; + field +</span>
<span class="line-added">178                                                 &quot; in static initializer of &quot; +</span>
<span class="line-added">179                                                 VERSION_PROPS_CLASS);</span>
<span class="line-added">180                                         }</span>
<span class="line-added">181                                         // forget about it</span>
<span class="line-added">182                                         pendingLDC = null;</span>
<span class="line-added">183                                         // and add an ldc for the new value</span>
184                                         super.visitLdcInsn(value);
185                                         redefined = true;
<a name="9" id="anc9"></a><span class="line-added">186                                     } else {</span>
<span class="line-added">187                                         flushPendingLDC();</span>
188                                     }
189                                     super.visitFieldInsn(opcode, owner,
190                                                          name, desc);
191                                 }
192 
193                         };
194                     else
195                         return super.visitMethod(access, name, desc, sig, xs);
196                 }
197 
198             }, 0);
199 
200         return cw.toByteArray();
201 
202     }
203 
204     @Override
205     public ResourcePool transform(ResourcePool in, ResourcePoolBuilder out) {
206         in.transformAndCopy(res -&gt; {
207                 if (res.type().equals(ResourcePoolEntry.Type.CLASS_OR_RESOURCE)) {
208                     if (res.path().equals(VERSION_PROPS_CLASS)) {
209                         return res.copyWithContent(redefine(res.contentBytes()));
210                     }
211                 }
212                 return res;
213             }, out);
214         if (!redefined)
215             throw new AssertionError(field);
216         return out.build();
217     }
218 
219 }
<a name="10" id="anc10"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="10" type="hidden" />
</body>
</html>