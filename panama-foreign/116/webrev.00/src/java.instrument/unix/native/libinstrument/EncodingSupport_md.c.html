<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>New src/java.instrument/unix/native/libinstrument/EncodingSupport_md.c</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
  <body>
    <pre>
  1 /*
  2  * Copyright (c) 2004, 2018, Oracle and/or its affiliates. All rights reserved.
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.  Oracle designates this
  8  * particular file as subject to the &quot;Classpath&quot; exception as provided
  9  * by Oracle in the LICENSE file that accompanied this code.
 10  *
 11  * This code is distributed in the hope that it will be useful, but WITHOUT
 12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 14  * version 2 for more details (a copy is included in the LICENSE file that
 15  * accompanied this code).
 16  *
 17  * You should have received a copy of the GNU General Public License version
 18  * 2 along with this work; if not, write to the Free Software Foundation,
 19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 20  *
 21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 22  * or visit www.oracle.com if you need additional information or have any
 23  * questions.
 24  */
 25 #include &lt;stdio.h&gt;
 26 #include &lt;stddef.h&gt;
 27 #include &lt;stdlib.h&gt;
 28 #include &lt;string.h&gt;
 29 #include &lt;ctype.h&gt;
 30 #include &lt;locale.h&gt;
 31 #include &lt;langinfo.h&gt;
 32 #include &lt;iconv.h&gt;
 33 
 34 /* Routines to convert back and forth between Platform Encoding and UTF-8 */
 35 
 36 /* Error and assert macros */
 37 #define UTF_ERROR(m) utfError(__FILE__, __LINE__,  m)
 38 #define UTF_ASSERT(x) ( (x)==0 ? UTF_ERROR(&quot;ASSERT ERROR &quot; #x) : (void)0 )
 39 #define UTF_DEBUG(x)
 40 
 41 /* Global variables */
 42 static iconv_t iconvToPlatform          = (iconv_t)-1;
 43 static iconv_t iconvFromPlatform        = (iconv_t)-1;
 44 
 45 /*
 46  * Error handler
 47  */
 48 static void
 49 utfError(char *file, int line, char *message)
 50 {
 51     (void)fprintf(stderr, &quot;UTF ERROR [\&quot;%s\&quot;:%d]: %s\n&quot;, file, line, message);
 52     abort();
 53 }
 54 
 55 /*
 56  * Initialize all utf processing.
 57  */
 58 static void
 59 utfInitialize(void)
 60 {
 61     const char* codeset;
 62 
 63     /* Set the locale from the environment */
 64     (void)setlocale(LC_ALL, &quot;&quot;);
 65 
 66     /* Get the codeset name */
 67     codeset = (char*)nl_langinfo(CODESET);
 68     if ( codeset == NULL || codeset[0] == 0 ) {
 69         UTF_DEBUG((&quot;NO codeset returned by nl_langinfo(CODESET)\n&quot;));
 70         return;
 71     }
 72 
 73     UTF_DEBUG((&quot;Codeset = %s\n&quot;, codeset));
 74 
 75 #ifdef MACOSX
 76     /* On Mac, if US-ASCII, but with no env hints, use UTF-8 */
 77     const char* env_lang = getenv(&quot;LANG&quot;);
 78     const char* env_lc_all = getenv(&quot;LC_ALL&quot;);
 79     const char* env_lc_ctype = getenv(&quot;LC_CTYPE&quot;);
 80 
 81     if (strcmp(codeset,&quot;US-ASCII&quot;) == 0 &amp;&amp;
 82         (env_lang == NULL || strlen(env_lang) == 0) &amp;&amp;
 83         (env_lc_all == NULL || strlen(env_lc_all) == 0) &amp;&amp;
 84         (env_lc_ctype == NULL || strlen(env_lc_ctype) == 0)) {
 85         codeset = &quot;UTF-8&quot;;
 86     }
 87 #endif
 88 
 89     /* If we don&#39;t need this, skip it */
 90     if (strcmp(codeset, &quot;UTF-8&quot;) == 0 || strcmp(codeset, &quot;utf8&quot;) == 0 ) {
 91         UTF_DEBUG((&quot;NO iconv() being used because it is not needed\n&quot;));
 92         return;
 93     }
 94 
 95     /* Open conversion descriptors */
 96     iconvToPlatform   = iconv_open(codeset, &quot;UTF-8&quot;);
 97     if ( iconvToPlatform == (iconv_t)-1 ) {
 98         UTF_ERROR(&quot;Failed to complete iconv_open() setup&quot;);
 99     }
100     iconvFromPlatform = iconv_open(&quot;UTF-8&quot;, codeset);
101     if ( iconvFromPlatform == (iconv_t)-1 ) {
102         UTF_ERROR(&quot;Failed to complete iconv_open() setup&quot;);
103     }
104 }
105 
106 /*
107  * Terminate all utf processing
108  */
109 static void
110 utfTerminate(void)
111 {
112     if ( iconvFromPlatform!=(iconv_t)-1 ) {
113         (void)iconv_close(iconvFromPlatform);
114     }
115     if ( iconvToPlatform!=(iconv_t)-1 ) {
116         (void)iconv_close(iconvToPlatform);
117     }
118     iconvToPlatform   = (iconv_t)-1;
119     iconvFromPlatform = (iconv_t)-1;
120 }
121 
122 /*
123  * Do iconv() conversion.
124  *    Returns length or -1 if output overflows.
125  */
126 static int
127 iconvConvert(iconv_t ic, char *bytes, int len, char *output, int outputMaxLen)
128 {
129     int outputLen = 0;
130 
131     UTF_ASSERT(bytes);
132     UTF_ASSERT(len&gt;=0);
133     UTF_ASSERT(output);
134     UTF_ASSERT(outputMaxLen&gt;len);
135 
136     output[0] = 0;
137     outputLen = 0;
138 
139     if ( ic != (iconv_t)-1 ) {
140         int          returnValue;
141         size_t       inLeft;
142         size_t       outLeft;
143         char        *inbuf;
144         char        *outbuf;
145 
146         inbuf        = bytes;
147         outbuf       = output;
148         inLeft       = len;
149         outLeft      = outputMaxLen;
150         returnValue  = iconv(ic, (void*)&amp;inbuf, &amp;inLeft, &amp;outbuf, &amp;outLeft);
151         if ( returnValue &gt;= 0 &amp;&amp; inLeft==0 ) {
152             outputLen = outputMaxLen-outLeft;
153             output[outputLen] = 0;
154             return outputLen;
155         }
156 
157         /* Failed to do the conversion */
158         UTF_DEBUG((&quot;iconv() failed to do the conversion\n&quot;));
159         return -1;
160     }
161 
162     /* Just copy bytes */
163     outputLen = len;
164     (void)memcpy(output, bytes, len);
165     output[len] = 0;
166     return outputLen;
167 }
168 
169 /*
170  * Convert UTF-8 to Platform Encoding.
171  *    Returns length or -1 if output overflows.
172  */
173 static int
174 utf8ToPlatform(char *utf8, int len, char *output, int outputMaxLen)
175 {
176     return iconvConvert(iconvToPlatform, utf8, len, output, outputMaxLen);
177 }
178 
179 /*
180  * Convert Platform Encoding to UTF-8.
181  *    Returns length or -1 if output overflows.
182  */
183 static int
184 platformToUtf8(char *str, int len, char *output, int outputMaxLen)
185 {
186     return iconvConvert(iconvFromPlatform, str, len, output, outputMaxLen);
187 }
188 
189 int
190 convertUft8ToPlatformString(char* utf8_str, int utf8_len, char* platform_str, int platform_len) {
191     if (iconvToPlatform ==  (iconv_t)-1) {
192         utfInitialize();
193     }
194     return utf8ToPlatform(utf8_str, utf8_len, platform_str, platform_len);
195 }
    </pre>
  </body>
</html>