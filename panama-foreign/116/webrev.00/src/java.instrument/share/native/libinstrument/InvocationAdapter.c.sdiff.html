<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/java.instrument/share/native/libinstrument/InvocationAdapter.c</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
<body>
<center><a href="../../classes/java/lang/instrument/package-info.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="JPLISAssert.h.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/java.instrument/share/native/libinstrument/InvocationAdapter.c</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
185         premainClass = getAttribute(attributes, &quot;Premain-Class&quot;);
186         if (premainClass == NULL) {
187             fprintf(stderr, &quot;Failed to find Premain-Class manifest attribute in %s\n&quot;,
188                 jarfile);
189             free(jarfile);
190             if (options != NULL) free(options);
191             freeAttributes(attributes);
192             return JNI_ERR;
193         }
194 
195         /* Save the jarfile name */
196         agent-&gt;mJarfile = jarfile;
197 
198         /*
199          * The value of the Premain-Class attribute becomes the agent
200          * class name. The manifest is in UTF8 so need to convert to
201          * modified UTF8 (see JNI spec).
202          */
203         oldLen = (int)strlen(premainClass);
204         newLen = modifiedUtf8LengthOfUtf8(premainClass, oldLen);











205         if (newLen == oldLen) {
206             premainClass = strdup(premainClass);
207         } else {
208             char* str = (char*)malloc( newLen+1 );
209             if (str != NULL) {
210                 convertUtf8ToModifiedUtf8(premainClass, oldLen, str, newLen);
211             }
212             premainClass = str;
213         }
214         if (premainClass == NULL) {
215             fprintf(stderr, &quot;-javaagent: memory allocation failed\n&quot;);
216             free(jarfile);
217             if (options != NULL) free(options);
218             freeAttributes(attributes);
219             return JNI_ERR;
220         }
221 
222         /*
223          * If the Boot-Class-Path attribute is specified then we process
224          * each relative URL and add it to the bootclasspath.
</pre>
<hr />
<pre>
343         /*
344          * Add the jarfile to the system class path
345          */
346         if (appendClassPath(agent, jarfile)) {
347             fprintf(stderr, &quot;Unable to add %s to system class path &quot;
348                 &quot;- not supported by system class loader or configuration error!\n&quot;,
349                 jarfile);
350             free(jarfile);
351             if (options != NULL) free(options);
352             freeAttributes(attributes);
353             return AGENT_ERROR_NOTONCP;
354         }
355 
356         /*
357          * The value of the Agent-Class attribute becomes the agent
358          * class name. The manifest is in UTF8 so need to convert to
359          * modified UTF8 (see JNI spec).
360          */
361         oldLen = (int)strlen(agentClass);
362         newLen = modifiedUtf8LengthOfUtf8(agentClass, oldLen);











363         if (newLen == oldLen) {
364             agentClass = strdup(agentClass);
365         } else {
366             char* str = (char*)malloc( newLen+1 );
367             if (str != NULL) {
368                 convertUtf8ToModifiedUtf8(agentClass, oldLen, str, newLen);
369             }
370             agentClass = str;
371         }
372         if (agentClass == NULL) {
373             free(jarfile);
374             if (options != NULL) free(options);
375             freeAttributes(attributes);
376             return JNI_ENOMEM;
377         }
378 
379         /*
380          * If the Boot-Class-Path attribute is specified then we process
381          * each URL - in the live phase only JAR files will be added.
382          */
</pre>
<hr />
<pre>
468     jarfile = (*env)-&gt;GetStringUTFChars(env, path, NULL);
469     if (jarfile == NULL) {
470         return JNI_ERR;
471     }
472 
473     // read the attributes in the main section of JAR manifest
474     attributes = readAttributes(jarfile);
475     if (attributes == NULL) {
476         goto releaseAndReturn;
477     }
478 
479     // Launcher-Agent-Class is required
480     agentClass = getAttribute(attributes, &quot;Launcher-Agent-Class&quot;);
481     if (agentClass == NULL) {
482         goto releaseAndReturn;
483     }
484 
485     // The value of Launcher-Agent-Class is in UTF-8, convert it to modified UTF-8
486     oldLen = (int) strlen(agentClass);
487     newLen = modifiedUtf8LengthOfUtf8(agentClass, oldLen);







488     if (newLen == oldLen) {
489         agentClass = strdup(agentClass);
490     } else {
491         char* str = (char*) malloc(newLen + 1);
492         if (str != NULL) {
493             convertUtf8ToModifiedUtf8(agentClass, oldLen, str, newLen);
494         }
495         agentClass = str;
496     }
497     if (agentClass == NULL) {
498          jthrowable oome = createThrowable(env, &quot;java/lang/OutOfMemoryError&quot;, NULL);
499          if (oome != NULL) (*env)-&gt;Throw(env, oome);
500          goto releaseAndReturn;
501     }
502 
503     // Boot-Class-Path
504     bootClassPath = getAttribute(attributes, &quot;Boot-Class-Path&quot;);
505     if (bootClassPath != NULL) {
506         appendBootClassPath(agent, jarfile, bootClassPath);
507     }
</pre>
</td>
<td>
<hr />
<pre>
185         premainClass = getAttribute(attributes, &quot;Premain-Class&quot;);
186         if (premainClass == NULL) {
187             fprintf(stderr, &quot;Failed to find Premain-Class manifest attribute in %s\n&quot;,
188                 jarfile);
189             free(jarfile);
190             if (options != NULL) free(options);
191             freeAttributes(attributes);
192             return JNI_ERR;
193         }
194 
195         /* Save the jarfile name */
196         agent-&gt;mJarfile = jarfile;
197 
198         /*
199          * The value of the Premain-Class attribute becomes the agent
200          * class name. The manifest is in UTF8 so need to convert to
201          * modified UTF8 (see JNI spec).
202          */
203         oldLen = (int)strlen(premainClass);
204         newLen = modifiedUtf8LengthOfUtf8(premainClass, oldLen);
<span class="line-added">205         /*</span>
<span class="line-added">206          * According to JVMS class name is represented as CONSTANT_Utf8_info,</span>
<span class="line-added">207          * so its length is u2 (i.e. must be &lt;= 0xFFFF).</span>
<span class="line-added">208          */</span>
<span class="line-added">209         if (newLen &gt; 0xFFFF) {</span>
<span class="line-added">210             fprintf(stderr, &quot;-javaagent: Premain-Class value is too big\n&quot;);</span>
<span class="line-added">211             free(jarfile);</span>
<span class="line-added">212             if (options != NULL) free(options);</span>
<span class="line-added">213             freeAttributes(attributes);</span>
<span class="line-added">214             return JNI_ERR;</span>
<span class="line-added">215         }</span>
216         if (newLen == oldLen) {
217             premainClass = strdup(premainClass);
218         } else {
219             char* str = (char*)malloc( newLen+1 );
220             if (str != NULL) {
221                 convertUtf8ToModifiedUtf8(premainClass, oldLen, str, newLen);
222             }
223             premainClass = str;
224         }
225         if (premainClass == NULL) {
226             fprintf(stderr, &quot;-javaagent: memory allocation failed\n&quot;);
227             free(jarfile);
228             if (options != NULL) free(options);
229             freeAttributes(attributes);
230             return JNI_ERR;
231         }
232 
233         /*
234          * If the Boot-Class-Path attribute is specified then we process
235          * each relative URL and add it to the bootclasspath.
</pre>
<hr />
<pre>
354         /*
355          * Add the jarfile to the system class path
356          */
357         if (appendClassPath(agent, jarfile)) {
358             fprintf(stderr, &quot;Unable to add %s to system class path &quot;
359                 &quot;- not supported by system class loader or configuration error!\n&quot;,
360                 jarfile);
361             free(jarfile);
362             if (options != NULL) free(options);
363             freeAttributes(attributes);
364             return AGENT_ERROR_NOTONCP;
365         }
366 
367         /*
368          * The value of the Agent-Class attribute becomes the agent
369          * class name. The manifest is in UTF8 so need to convert to
370          * modified UTF8 (see JNI spec).
371          */
372         oldLen = (int)strlen(agentClass);
373         newLen = modifiedUtf8LengthOfUtf8(agentClass, oldLen);
<span class="line-added">374         /*</span>
<span class="line-added">375          * According to JVMS class name is represented as CONSTANT_Utf8_info,</span>
<span class="line-added">376          * so its length is u2 (i.e. must be &lt;= 0xFFFF).</span>
<span class="line-added">377          */</span>
<span class="line-added">378         if (newLen &gt; 0xFFFF) {</span>
<span class="line-added">379             fprintf(stderr, &quot;Agent-Class value is too big\n&quot;);</span>
<span class="line-added">380             free(jarfile);</span>
<span class="line-added">381             if (options != NULL) free(options);</span>
<span class="line-added">382             freeAttributes(attributes);</span>
<span class="line-added">383             return AGENT_ERROR_BADJAR;</span>
<span class="line-added">384         }</span>
385         if (newLen == oldLen) {
386             agentClass = strdup(agentClass);
387         } else {
388             char* str = (char*)malloc( newLen+1 );
389             if (str != NULL) {
390                 convertUtf8ToModifiedUtf8(agentClass, oldLen, str, newLen);
391             }
392             agentClass = str;
393         }
394         if (agentClass == NULL) {
395             free(jarfile);
396             if (options != NULL) free(options);
397             freeAttributes(attributes);
398             return JNI_ENOMEM;
399         }
400 
401         /*
402          * If the Boot-Class-Path attribute is specified then we process
403          * each URL - in the live phase only JAR files will be added.
404          */
</pre>
<hr />
<pre>
490     jarfile = (*env)-&gt;GetStringUTFChars(env, path, NULL);
491     if (jarfile == NULL) {
492         return JNI_ERR;
493     }
494 
495     // read the attributes in the main section of JAR manifest
496     attributes = readAttributes(jarfile);
497     if (attributes == NULL) {
498         goto releaseAndReturn;
499     }
500 
501     // Launcher-Agent-Class is required
502     agentClass = getAttribute(attributes, &quot;Launcher-Agent-Class&quot;);
503     if (agentClass == NULL) {
504         goto releaseAndReturn;
505     }
506 
507     // The value of Launcher-Agent-Class is in UTF-8, convert it to modified UTF-8
508     oldLen = (int) strlen(agentClass);
509     newLen = modifiedUtf8LengthOfUtf8(agentClass, oldLen);
<span class="line-added">510     /*</span>
<span class="line-added">511      * According to JVMS class name is represented as CONSTANT_Utf8_info,</span>
<span class="line-added">512      * so its length is u2 (i.e. must be &lt;= 0xFFFF).</span>
<span class="line-added">513      */</span>
<span class="line-added">514     if (newLen &gt; 0xFFFF) {</span>
<span class="line-added">515         goto releaseAndReturn;</span>
<span class="line-added">516     }</span>
517     if (newLen == oldLen) {
518         agentClass = strdup(agentClass);
519     } else {
520         char* str = (char*) malloc(newLen + 1);
521         if (str != NULL) {
522             convertUtf8ToModifiedUtf8(agentClass, oldLen, str, newLen);
523         }
524         agentClass = str;
525     }
526     if (agentClass == NULL) {
527          jthrowable oome = createThrowable(env, &quot;java/lang/OutOfMemoryError&quot;, NULL);
528          if (oome != NULL) (*env)-&gt;Throw(env, oome);
529          goto releaseAndReturn;
530     }
531 
532     // Boot-Class-Path
533     bootClassPath = getAttribute(attributes, &quot;Boot-Class-Path&quot;);
534     if (bootClassPath != NULL) {
535         appendBootClassPath(agent, jarfile, bootClassPath);
536     }
</pre>
</td>
</tr>
</table>
<center><a href="../../classes/java/lang/instrument/package-info.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="JPLISAssert.h.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>