<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff src/java.base/share/classes/java/net/SocketPermission.java</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
  </head>
<body>
<center><a href="../math/MutableBigInteger.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="../nio/Bits.java.cdiff.html" target="_top">next &gt;</a></center>    <h2>src/java.base/share/classes/java/net/SocketPermission.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 35,16 ***</span>
  import java.security.Permission;
  import java.security.PermissionCollection;
  import java.security.PrivilegedAction;
  import java.security.Security;
  import java.util.Collections;
<span class="line-removed">- import java.util.Comparator;</span>
  import java.util.Enumeration;
<span class="line-modified">! import java.util.Vector;</span>
  import java.util.StringJoiner;
  import java.util.StringTokenizer;
<span class="line-modified">! import java.util.concurrent.ConcurrentSkipListMap;</span>
  import sun.net.util.IPAddressUtil;
  import sun.net.PortConfig;
  import sun.security.util.RegisteredDomain;
  import sun.security.util.SecurityConstants;
  import sun.security.util.Debug;
<span class="line-new-header">--- 35,16 ---</span>
  import java.security.Permission;
  import java.security.PermissionCollection;
  import java.security.PrivilegedAction;
  import java.security.Security;
  import java.util.Collections;
  import java.util.Enumeration;
<span class="line-modified">! import java.util.Map;</span>
  import java.util.StringJoiner;
  import java.util.StringTokenizer;
<span class="line-modified">! import java.util.Vector;</span>
<span class="line-added">+ import java.util.concurrent.ConcurrentHashMap;</span>
  import sun.net.util.IPAddressUtil;
  import sun.net.PortConfig;
  import sun.security.util.RegisteredDomain;
  import sun.security.util.SecurityConstants;
  import sun.security.util.Debug;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1347,20 ***</span>
  
  final class SocketPermissionCollection extends PermissionCollection
      implements Serializable
  {
      // Not serialized; see serialization section at end of class
<span class="line-modified">!     // A ConcurrentSkipListMap is used to preserve order, so that most</span>
<span class="line-removed">-     // recently added permissions are checked first (see JDK-4301064).</span>
<span class="line-removed">-     private transient ConcurrentSkipListMap&lt;String, SocketPermission&gt; perms;</span>
  
      /**
<span class="line-modified">!      * Create an empty SocketPermissions object.</span>
<span class="line-removed">-      *</span>
       */
      public SocketPermissionCollection() {
<span class="line-modified">!         perms = new ConcurrentSkipListMap&lt;&gt;(new SPCComparator());</span>
      }
  
      /**
       * Adds a permission to the SocketPermissions. The key for the hash is
       * the name in the case of wildcards, or all the IP addresses.
<span class="line-new-header">--- 1347,17 ---</span>
  
  final class SocketPermissionCollection extends PermissionCollection
      implements Serializable
  {
      // Not serialized; see serialization section at end of class
<span class="line-modified">!     private transient Map&lt;String, SocketPermission&gt; perms;</span>
  
      /**
<span class="line-modified">!      * Create an empty SocketPermissionCollection object.</span>
       */
      public SocketPermissionCollection() {
<span class="line-modified">!         perms = new ConcurrentHashMap&lt;&gt;();</span>
      }
  
      /**
       * Adds a permission to the SocketPermissions. The key for the hash is
       * the name in the case of wildcards, or all the IP addresses.
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1429,10 ***</span>
<span class="line-new-header">--- 1426,22 ---</span>
  
          int desired = np.getMask();
          int effective = 0;
          int needed = desired;
  
<span class="line-added">+         var hit = perms.get(np.getName());</span>
<span class="line-added">+         if (hit != null) {</span>
<span class="line-added">+             // fastpath, if the host was explicitly listed</span>
<span class="line-added">+             if (((needed &amp; hit.getMask()) != 0) &amp;&amp; hit.impliesIgnoreMask(np)) {</span>
<span class="line-added">+                 effective |= hit.getMask();</span>
<span class="line-added">+                 if ((effective &amp; desired) == desired) {</span>
<span class="line-added">+                     return true;</span>
<span class="line-added">+                 }</span>
<span class="line-added">+                 needed = (desired &amp; ~effective);</span>
<span class="line-added">+             }</span>
<span class="line-added">+         }</span>
<span class="line-added">+ </span>
          //System.out.println(&quot;implies &quot;+np);
          for (SocketPermission x : perms.values()) {
              //System.out.println(&quot;  trying &quot;+x);
              if (((needed &amp; x.getMask()) != 0) &amp;&amp; x.impliesIgnoreMask(np)) {
                  effective |=  x.getMask();
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1510,24 ***</span>
          ObjectInputStream.GetField gfields = in.readFields();
  
          // Get the one we want
          @SuppressWarnings(&quot;unchecked&quot;)
          Vector&lt;SocketPermission&gt; permissions = (Vector&lt;SocketPermission&gt;)gfields.get(&quot;permissions&quot;, null);
<span class="line-modified">!         perms = new ConcurrentSkipListMap&lt;&gt;(new SPCComparator());</span>
          for (SocketPermission sp : permissions) {
              perms.put(sp.getName(), sp);
          }
      }
<span class="line-removed">- </span>
<span class="line-removed">-     /**</span>
<span class="line-removed">-      * A simple comparator that orders new non-equal entries at the beginning.</span>
<span class="line-removed">-      */</span>
<span class="line-removed">-     private static class SPCComparator implements Comparator&lt;String&gt; {</span>
<span class="line-removed">-         @Override</span>
<span class="line-removed">-         public int compare(String s1, String s2) {</span>
<span class="line-removed">-             if (s1.equals(s2)) {</span>
<span class="line-removed">-                 return 0;</span>
<span class="line-removed">-             }</span>
<span class="line-removed">-             return -1;</span>
<span class="line-removed">-         }</span>
<span class="line-removed">-     }</span>
  }
<span class="line-new-header">--- 1519,11 ---</span>
          ObjectInputStream.GetField gfields = in.readFields();
  
          // Get the one we want
          @SuppressWarnings(&quot;unchecked&quot;)
          Vector&lt;SocketPermission&gt; permissions = (Vector&lt;SocketPermission&gt;)gfields.get(&quot;permissions&quot;, null);
<span class="line-modified">!         perms = new ConcurrentHashMap&lt;&gt;(permissions.size());</span>
          for (SocketPermission sp : permissions) {
              perms.put(sp.getName(), sp);
          }
      }
  }
</pre>
<center><a href="../math/MutableBigInteger.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="../nio/Bits.java.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>