<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/java.base/share/classes/sun/security/ssl/KeyShareExtension.java</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
  </head>
<body>
<center><a href="HandshakeContext.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="PostHandshakeContext.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/java.base/share/classes/sun/security/ssl/KeyShareExtension.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
319                             &quot;The key_share extension has been loaded&quot;);
320                 }
321                 return;
322             }
323 
324             // Is it a supported and enabled extension?
325             if (!shc.sslConfig.isAvailable(SSLExtension.CH_KEY_SHARE)) {
326                 if (SSLLogger.isOn &amp;&amp; SSLLogger.isOn(&quot;ssl,handshake&quot;)) {
327                     SSLLogger.fine(
328                             &quot;Ignore unavailable key_share extension&quot;);
329                 }
330                 return;     // ignore the extension
331             }
332 
333             // Parse the extension
334             CHKeyShareSpec spec = new CHKeyShareSpec(shc, buffer);
335             List&lt;SSLCredentials&gt; credentials = new LinkedList&lt;&gt;();
336             for (KeyShareEntry entry : spec.clientShares) {
337                 NamedGroup ng = NamedGroup.valueOf(entry.namedGroupId);
338                 if (ng == null || !SupportedGroups.isActivatable(
<span class="line-modified">339                         shc.sslConfig.algorithmConstraints, ng)) {</span>
340                     if (SSLLogger.isOn &amp;&amp; SSLLogger.isOn(&quot;ssl,handshake&quot;)) {
341                         SSLLogger.fine(
342                                 &quot;Ignore unsupported named group: &quot; +
343                                 NamedGroup.nameOf(entry.namedGroupId));
344                     }
345                     continue;
346                 }
347 
348                 try {
349                     SSLCredentials kaCred =
350                         ng.decodeCredentials(entry.keyExchange,
351                         shc.algorithmConstraints,
352                         s -&gt; SSLLogger.warning(s));
353                     if (kaCred != null) {
354                         credentials.add(kaCred);
355                     }
356                 } catch (GeneralSecurityException ex) {
357                     SSLLogger.warning(
358                         &quot;Cannot decode named group: &quot; +
359                         NamedGroup.nameOf(entry.namedGroupId));
</pre>
<hr />
<pre>
603             // Happens in client side only.
604             ClientHandshakeContext chc = (ClientHandshakeContext)context;
605             if (chc.clientRequestedNamedGroups == null ||
606                     chc.clientRequestedNamedGroups.isEmpty()) {
607                 // No supported groups.
608                 throw chc.conContext.fatal(Alert.UNEXPECTED_MESSAGE,
609                         &quot;Unexpected key_share extension in ServerHello&quot;);
610             }
611 
612             // Is it a supported and enabled extension?
613             if (!chc.sslConfig.isAvailable(SSLExtension.SH_KEY_SHARE)) {
614                 throw chc.conContext.fatal(Alert.UNEXPECTED_MESSAGE,
615                         &quot;Unsupported key_share extension in ServerHello&quot;);
616             }
617 
618             // Parse the extension
619             SHKeyShareSpec spec = new SHKeyShareSpec(chc, buffer);
620             KeyShareEntry keyShare = spec.serverShare;
621             NamedGroup ng = NamedGroup.valueOf(keyShare.namedGroupId);
622             if (ng == null || !SupportedGroups.isActivatable(
<span class="line-modified">623                     chc.sslConfig.algorithmConstraints, ng)) {</span>
624                 throw chc.conContext.fatal(Alert.UNEXPECTED_MESSAGE,
625                         &quot;Unsupported named group: &quot; +
626                         NamedGroup.nameOf(keyShare.namedGroupId));
627             }
628 
629             SSLKeyExchange ke = SSLKeyExchange.valueOf(ng);
630             if (ke == null) {
631                 throw chc.conContext.fatal(Alert.UNEXPECTED_MESSAGE,
632                         &quot;No key exchange for named group &quot; + ng.name);
633             }
634 
635             SSLCredentials credentials = null;
636             try {
637                 SSLCredentials kaCred = ng.decodeCredentials(
638                     keyShare.keyExchange, chc.algorithmConstraints,
639                     s -&gt; chc.conContext.fatal(Alert.UNEXPECTED_MESSAGE, s));
640                 if (kaCred != null) {
641                     credentials = kaCred;
642                 }
643             } catch (GeneralSecurityException ex) {
</pre>
<hr />
<pre>
745                 HandshakeMessage message) throws IOException {
746             // The producing happens in server side only.
747             ServerHandshakeContext shc = (ServerHandshakeContext) context;
748 
749             // Is it a supported and enabled extension?
750             if (!shc.sslConfig.isAvailable(SSLExtension.HRR_KEY_SHARE)) {
751                 throw shc.conContext.fatal(Alert.UNEXPECTED_MESSAGE,
752                         &quot;Unsupported key_share extension in HelloRetryRequest&quot;);
753             }
754 
755             if (shc.clientRequestedNamedGroups == null ||
756                     shc.clientRequestedNamedGroups.isEmpty()) {
757                 // No supported groups.
758                 throw shc.conContext.fatal(Alert.UNEXPECTED_MESSAGE,
759                         &quot;Unexpected key_share extension in HelloRetryRequest&quot;);
760             }
761 
762             NamedGroup selectedGroup = null;
763             for (NamedGroup ng : shc.clientRequestedNamedGroups) {
764                 if (SupportedGroups.isActivatable(
<span class="line-modified">765                         shc.sslConfig.algorithmConstraints, ng)) {</span>
766                     if (SSLLogger.isOn &amp;&amp; SSLLogger.isOn(&quot;ssl,handshake&quot;)) {
767                         SSLLogger.fine(
768                                 &quot;HelloRetryRequest selected named group: &quot; +
769                                 ng.name);
770                     }
771 
772                     selectedGroup = ng;
773                     break;
774                 }
775             }
776 
777             if (selectedGroup == null) {
778                 throw shc.conContext.fatal(
779                         Alert.UNEXPECTED_MESSAGE, &quot;No common named group&quot;);
780             }
781 
782             byte[] extdata = new byte[] {
783                     (byte)((selectedGroup.id &gt;&gt; 8) &amp; 0xFF),
784                     (byte)(selectedGroup.id &amp; 0xFF)
785                 };
</pre>
</td>
<td>
<hr />
<pre>
319                             &quot;The key_share extension has been loaded&quot;);
320                 }
321                 return;
322             }
323 
324             // Is it a supported and enabled extension?
325             if (!shc.sslConfig.isAvailable(SSLExtension.CH_KEY_SHARE)) {
326                 if (SSLLogger.isOn &amp;&amp; SSLLogger.isOn(&quot;ssl,handshake&quot;)) {
327                     SSLLogger.fine(
328                             &quot;Ignore unavailable key_share extension&quot;);
329                 }
330                 return;     // ignore the extension
331             }
332 
333             // Parse the extension
334             CHKeyShareSpec spec = new CHKeyShareSpec(shc, buffer);
335             List&lt;SSLCredentials&gt; credentials = new LinkedList&lt;&gt;();
336             for (KeyShareEntry entry : spec.clientShares) {
337                 NamedGroup ng = NamedGroup.valueOf(entry.namedGroupId);
338                 if (ng == null || !SupportedGroups.isActivatable(
<span class="line-modified">339                         shc.algorithmConstraints, ng)) {</span>
340                     if (SSLLogger.isOn &amp;&amp; SSLLogger.isOn(&quot;ssl,handshake&quot;)) {
341                         SSLLogger.fine(
342                                 &quot;Ignore unsupported named group: &quot; +
343                                 NamedGroup.nameOf(entry.namedGroupId));
344                     }
345                     continue;
346                 }
347 
348                 try {
349                     SSLCredentials kaCred =
350                         ng.decodeCredentials(entry.keyExchange,
351                         shc.algorithmConstraints,
352                         s -&gt; SSLLogger.warning(s));
353                     if (kaCred != null) {
354                         credentials.add(kaCred);
355                     }
356                 } catch (GeneralSecurityException ex) {
357                     SSLLogger.warning(
358                         &quot;Cannot decode named group: &quot; +
359                         NamedGroup.nameOf(entry.namedGroupId));
</pre>
<hr />
<pre>
603             // Happens in client side only.
604             ClientHandshakeContext chc = (ClientHandshakeContext)context;
605             if (chc.clientRequestedNamedGroups == null ||
606                     chc.clientRequestedNamedGroups.isEmpty()) {
607                 // No supported groups.
608                 throw chc.conContext.fatal(Alert.UNEXPECTED_MESSAGE,
609                         &quot;Unexpected key_share extension in ServerHello&quot;);
610             }
611 
612             // Is it a supported and enabled extension?
613             if (!chc.sslConfig.isAvailable(SSLExtension.SH_KEY_SHARE)) {
614                 throw chc.conContext.fatal(Alert.UNEXPECTED_MESSAGE,
615                         &quot;Unsupported key_share extension in ServerHello&quot;);
616             }
617 
618             // Parse the extension
619             SHKeyShareSpec spec = new SHKeyShareSpec(chc, buffer);
620             KeyShareEntry keyShare = spec.serverShare;
621             NamedGroup ng = NamedGroup.valueOf(keyShare.namedGroupId);
622             if (ng == null || !SupportedGroups.isActivatable(
<span class="line-modified">623                     chc.algorithmConstraints, ng)) {</span>
624                 throw chc.conContext.fatal(Alert.UNEXPECTED_MESSAGE,
625                         &quot;Unsupported named group: &quot; +
626                         NamedGroup.nameOf(keyShare.namedGroupId));
627             }
628 
629             SSLKeyExchange ke = SSLKeyExchange.valueOf(ng);
630             if (ke == null) {
631                 throw chc.conContext.fatal(Alert.UNEXPECTED_MESSAGE,
632                         &quot;No key exchange for named group &quot; + ng.name);
633             }
634 
635             SSLCredentials credentials = null;
636             try {
637                 SSLCredentials kaCred = ng.decodeCredentials(
638                     keyShare.keyExchange, chc.algorithmConstraints,
639                     s -&gt; chc.conContext.fatal(Alert.UNEXPECTED_MESSAGE, s));
640                 if (kaCred != null) {
641                     credentials = kaCred;
642                 }
643             } catch (GeneralSecurityException ex) {
</pre>
<hr />
<pre>
745                 HandshakeMessage message) throws IOException {
746             // The producing happens in server side only.
747             ServerHandshakeContext shc = (ServerHandshakeContext) context;
748 
749             // Is it a supported and enabled extension?
750             if (!shc.sslConfig.isAvailable(SSLExtension.HRR_KEY_SHARE)) {
751                 throw shc.conContext.fatal(Alert.UNEXPECTED_MESSAGE,
752                         &quot;Unsupported key_share extension in HelloRetryRequest&quot;);
753             }
754 
755             if (shc.clientRequestedNamedGroups == null ||
756                     shc.clientRequestedNamedGroups.isEmpty()) {
757                 // No supported groups.
758                 throw shc.conContext.fatal(Alert.UNEXPECTED_MESSAGE,
759                         &quot;Unexpected key_share extension in HelloRetryRequest&quot;);
760             }
761 
762             NamedGroup selectedGroup = null;
763             for (NamedGroup ng : shc.clientRequestedNamedGroups) {
764                 if (SupportedGroups.isActivatable(
<span class="line-modified">765                         shc.algorithmConstraints, ng)) {</span>
766                     if (SSLLogger.isOn &amp;&amp; SSLLogger.isOn(&quot;ssl,handshake&quot;)) {
767                         SSLLogger.fine(
768                                 &quot;HelloRetryRequest selected named group: &quot; +
769                                 ng.name);
770                     }
771 
772                     selectedGroup = ng;
773                     break;
774                 }
775             }
776 
777             if (selectedGroup == null) {
778                 throw shc.conContext.fatal(
779                         Alert.UNEXPECTED_MESSAGE, &quot;No common named group&quot;);
780             }
781 
782             byte[] extdata = new byte[] {
783                     (byte)((selectedGroup.id &gt;&gt; 8) &amp; 0xFF),
784                     (byte)(selectedGroup.id &amp; 0xFF)
785                 };
</pre>
</td>
</tr>
</table>
<center><a href="HandshakeContext.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="PostHandshakeContext.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>