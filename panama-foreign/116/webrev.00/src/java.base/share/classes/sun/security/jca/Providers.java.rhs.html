<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames src/java.base/share/classes/sun/security/jca/Providers.java</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
<a name="1" id="anc1"></a><span class="line-modified">  2  * Copyright (c) 2003, 2020, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.  Oracle designates this
  8  * particular file as subject to the &quot;Classpath&quot; exception as provided
  9  * by Oracle in the LICENSE file that accompanied this code.
 10  *
 11  * This code is distributed in the hope that it will be useful, but WITHOUT
 12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 14  * version 2 for more details (a copy is included in the LICENSE file that
 15  * accompanied this code).
 16  *
 17  * You should have received a copy of the GNU General Public License version
 18  * 2 along with this work; if not, write to the Free Software Foundation,
 19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 20  *
 21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 22  * or visit www.oracle.com if you need additional information or have any
 23  * questions.
 24  */
 25 
 26 package sun.security.jca;
 27 
 28 import java.security.Provider;
 29 
 30 /**
 31  * Collection of methods to get and set provider list. Also includes
 32  * special code for the provider list during JAR verification.
 33  *
 34  * @author  Andreas Sterbenz
 35  * @since   1.5
 36  */
 37 public class Providers {
 38 
 39     private static final ThreadLocal&lt;ProviderList&gt; threadLists =
 40         new InheritableThreadLocal&lt;&gt;();
 41 
 42     // number of threads currently using thread-local provider lists
 43     // tracked to allow an optimization if == 0
 44     private static volatile int threadListsUsed;
 45 
 46     // current system-wide provider list
 47     // Note volatile immutable object, so no synchronization needed.
 48     private static volatile ProviderList providerList;
 49 
 50     static {
 51         // set providerList to empty list first in case initialization somehow
 52         // triggers a getInstance() call (although that should not happen)
 53         providerList = ProviderList.EMPTY;
 54         providerList = ProviderList.fromSecurityProperties();
 55     }
 56 
 57     private Providers() {
 58         // empty
 59     }
 60 
 61     // After the switch to modules, JDK providers are all in modules and JDK
 62     // no longer needs to load signed jars during start up.
 63     //
 64     // However, for earlier releases, it need special handling to resolve
 65     // circularities when loading signed JAR files during startup. The code
 66     // below is part of that.
 67     //
 68     // Basically, before we load data from a signed JAR file, we parse
 69     // the PKCS#7 file and verify the signature. We need a
 70     // CertificateFactory, Signatures, etc. to do that. We have to make
 71     // sure that we do not try to load the implementation from the JAR
 72     // file we are just verifying.
 73     //
 74     // To avoid that, we use different provider settings during JAR
 75     // verification.  However, we do not want those provider settings to
 76     // interfere with other parts of the system. Therefore, we make them local
 77     // to the Thread executing the JAR verification code.
 78     //
 79     // The code here is used by sun.security.util.SignatureFileVerifier.
 80     // See there for details.
 81 
 82     // Hardcoded names of providers to use for JAR verification.
 83     // MUST NOT be on the bootclasspath and not in signed JAR files.
 84     private static final String[] jarVerificationProviders = {
 85         &quot;SUN&quot;,
 86         &quot;SunRsaSign&quot;,
 87         // Note: when SunEC is in a signed JAR file, it&#39;s not signed
 88         // by EC algorithms. So it&#39;s still safe to be listed here.
 89         &quot;SunEC&quot;,
<a name="2" id="anc2"></a><span class="line-added"> 90         &quot;SunJCE&quot;,</span>
 91     };
 92 
 93     // Return Sun provider.
 94     // This method should only be called by
 95     // sun.security.util.ManifestEntryVerifier and java.security.SecureRandom.
 96     public static Provider getSunProvider() {
 97         return new sun.security.provider.Sun();
 98     }
 99 
100     /**
101      * Start JAR verification. This sets a special provider list for
102      * the current thread. You MUST save the return value from this
103      * method and you MUST call stopJarVerification() with that object
104      * once you are done.
105      */
106     public static Object startJarVerification() {
107         ProviderList currentList = getProviderList();
108         ProviderList jarList = currentList.getJarList(jarVerificationProviders);
109         if (jarList.getProvider(&quot;SUN&quot;) == null) {
110             // add backup provider
111             Provider p;
112             try {
113                 p = new sun.security.provider.VerificationProvider();
114             } catch (Exception e) {
115                 throw new RuntimeException(&quot;Missing provider for jar verification&quot;, e);
116             }
117             ProviderList.add(jarList, p);
118         }
119         // return the old thread-local provider list, usually null
120         return beginThreadProviderList(jarList);
121     }
122 
123     /**
124      * Stop JAR verification. Call once you have completed JAR verification.
125      */
126     public static void stopJarVerification(Object obj) {
127         // restore old thread-local provider list
128         endThreadProviderList((ProviderList)obj);
129     }
130 
131     /**
132      * Return the current ProviderList. If the thread-local list is set,
133      * it is returned. Otherwise, the system wide list is returned.
134      */
135     public static ProviderList getProviderList() {
136         ProviderList list = getThreadProviderList();
137         if (list == null) {
138             list = getSystemProviderList();
139         }
140         return list;
141     }
142 
143     /**
144      * Set the current ProviderList. Affects the thread-local list if set,
145      * otherwise the system wide list.
146      */
147     public static void setProviderList(ProviderList newList) {
148         if (getThreadProviderList() == null) {
149             setSystemProviderList(newList);
150         } else {
151             changeThreadProviderList(newList);
152         }
153     }
154 
155     /**
156      * Get the full provider list with invalid providers (those that
157      * could not be loaded) removed. This is the list we need to
158      * present to applications.
159      */
160     public static ProviderList getFullProviderList() {
161         ProviderList list;
162         synchronized (Providers.class) {
163             list = getThreadProviderList();
164             if (list != null) {
165                 ProviderList newList = list.removeInvalid();
166                 if (newList != list) {
167                     changeThreadProviderList(newList);
168                     list = newList;
169                 }
170                 return list;
171             }
172         }
173         list = getSystemProviderList();
174         ProviderList newList = list.removeInvalid();
175         if (newList != list) {
176             setSystemProviderList(newList);
177             list = newList;
178         }
179         return list;
180     }
181 
182     private static ProviderList getSystemProviderList() {
183         return providerList;
184     }
185 
186     private static void setSystemProviderList(ProviderList list) {
187         providerList = list;
188     }
189 
190     public static ProviderList getThreadProviderList() {
191         // avoid accessing the threadlocal if none are currently in use
192         // (first use of ThreadLocal.get() for a Thread allocates a Map)
193         if (threadListsUsed == 0) {
194             return null;
195         }
196         return threadLists.get();
197     }
198 
199     // Change the thread local provider list. Use only if the current thread
200     // is already using a thread local list and you want to change it in place.
201     // In other cases, use the begin/endThreadProviderList() methods.
202     private static void changeThreadProviderList(ProviderList list) {
203         threadLists.set(list);
204     }
205 
206     /**
207      * Methods to manipulate the thread local provider list. It is for use by
208      * JAR verification (see above) and the SunJSSE FIPS mode only.
209      *
210      * It should be used as follows:
211      *
212      *   ProviderList list = ...;
213      *   ProviderList oldList = Providers.beginThreadProviderList(list);
214      *   try {
215      *     // code that needs thread local provider list
216      *   } finally {
217      *     Providers.endThreadProviderList(oldList);
218      *   }
219      *
220      */
221 
222     public static synchronized ProviderList beginThreadProviderList(ProviderList list) {
223         if (ProviderList.debug != null) {
224             ProviderList.debug.println(&quot;ThreadLocal providers: &quot; + list);
225         }
226         ProviderList oldList = threadLists.get();
227         threadListsUsed++;
228         threadLists.set(list);
229         return oldList;
230     }
231 
232     public static synchronized void endThreadProviderList(ProviderList list) {
233         if (list == null) {
234             if (ProviderList.debug != null) {
235                 ProviderList.debug.println(&quot;Disabling ThreadLocal providers&quot;);
236             }
237             threadLists.remove();
238         } else {
239             if (ProviderList.debug != null) {
240                 ProviderList.debug.println
241                     (&quot;Restoring previous ThreadLocal providers: &quot; + list);
242             }
243             threadLists.set(list);
244         }
245         threadListsUsed--;
246     }
247 
248 }
<a name="3" id="anc3"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="3" type="hidden" />
</body>
</html>