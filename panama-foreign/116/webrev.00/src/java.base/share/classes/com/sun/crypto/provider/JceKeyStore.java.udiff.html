<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff src/java.base/share/classes/com/sun/crypto/provider/JceKeyStore.java</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="HmacCore.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="KeyGeneratorCore.java.udiff.html" target="_top">next &gt;</a></center>    <h2>src/java.base/share/classes/com/sun/crypto/provider/JceKeyStore.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -79,10 +79,16 @@</span>
  
      // Secret key
      private static final class SecretKeyEntry {
          Date date; // the creation date of this entry
          SealedObject sealedKey;
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         // Maximum possible length of sealedKey. Used to detect malicious</span>
<span class="udiff-line-added">+         // input data. This field is set to the file length of the keystore</span>
<span class="udiff-line-added">+         // at loading. It is useless when creating a new SecretKeyEntry</span>
<span class="udiff-line-added">+         // to be store in a keystore.</span>
<span class="udiff-line-added">+         int maxLength;</span>
      }
  
      // Trusted certificate
      private static final class TrustedCertEntry {
          Date date; // the creation date of this entry
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -134,12 +140,12 @@</span>
                                                      + &quot;as PKCS #8 &quot; +
                                                      &quot;EncryptedPrivateKeyInfo&quot;);
              }
              key = keyProtector.recover(encrInfo);
          } else {
<span class="udiff-line-modified-removed">-             key =</span>
<span class="udiff-line-modified-removed">-                 keyProtector.unseal(((SecretKeyEntry)entry).sealedKey);</span>
<span class="udiff-line-modified-added">+             SecretKeyEntry ske = ((SecretKeyEntry)entry);</span>
<span class="udiff-line-modified-added">+             key = keyProtector.unseal(ske.sealedKey, ske.maxLength);</span>
          }
  
          return key;
      }
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -280,10 +286,11 @@</span>
                      SecretKeyEntry entry = new SecretKeyEntry();
                      entry.date = new Date();
  
                      // seal and store the key
                      entry.sealedKey = keyProtector.seal(key);
<span class="udiff-line-added">+                     entry.maxLength = Integer.MAX_VALUE;</span>
                      entries.put(alias.toLowerCase(Locale.ENGLISH), entry);
                  }
  
              } catch (Exception e) {
                  throw new KeyStoreException(e.getMessage());
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -689,10 +696,14 @@</span>
              int trustedKeyCount = 0, privateKeyCount = 0, secretKeyCount = 0;
  
              if (stream == null)
                  return;
  
<span class="udiff-line-added">+             byte[] allData = stream.readAllBytes();</span>
<span class="udiff-line-added">+             int fullLength = allData.length;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             stream = new ByteArrayInputStream(allData);</span>
              if (password != null) {
                  md = getPreKeyedHash(password);
                  dis = new DataInputStream(new DigestInputStream(stream, md));
              } else {
                  dis = new DataInputStream(stream);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -827,14 +838,15 @@</span>
                              final ObjectInputStream ois2 = ois;
                              // Set a deserialization checker
                              AccessController.doPrivileged(
                                  (PrivilegedAction&lt;Void&gt;)() -&gt; {
                                      ois2.setObjectInputFilter(
<span class="udiff-line-modified-removed">-                                         new DeserializationChecker());</span>
<span class="udiff-line-modified-added">+                                         new DeserializationChecker(fullLength));</span>
                                      return null;
                              });
                              entry.sealedKey = (SealedObject)ois.readObject();
<span class="udiff-line-added">+                             entry.maxLength = fullLength;</span>
                              // NOTE: don&#39;t close ois here since we are still
                              // using dis!!!
                          } catch (ClassNotFoundException cnfe) {
                              throw new IOException(cnfe.getMessage());
                          } catch (InvalidClassException ice) {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -924,20 +936,30 @@</span>
      /*
       * An ObjectInputFilter that checks the format of the secret key being
       * deserialized.
       */
      private static class DeserializationChecker implements ObjectInputFilter {
<span class="udiff-line-added">+ </span>
          private static final int MAX_NESTED_DEPTH = 2;
  
<span class="udiff-line-added">+         // Full length of keystore, anything inside a SecretKeyEntry should not</span>
<span class="udiff-line-added">+         // be bigger. Otherwise, must be illegal.</span>
<span class="udiff-line-added">+         private final int fullLength;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         public DeserializationChecker(int fullLength) {</span>
<span class="udiff-line-added">+             this.fullLength = fullLength;</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+ </span>
          @Override
          public ObjectInputFilter.Status
              checkInput(ObjectInputFilter.FilterInfo info) {
  
              // First run a custom filter
              long nestedDepth = info.depth();
              if ((nestedDepth == 1 &amp;&amp;
                          info.serialClass() != SealedObjectForKeyProtector.class) ||
<span class="udiff-line-added">+                     info.arrayLength() &gt; fullLength ||</span>
                      (nestedDepth &gt; MAX_NESTED_DEPTH &amp;&amp;
                          info.serialClass() != null &amp;&amp;
                          info.serialClass() != Object.class)) {
                  return Status.REJECTED;
              }
</pre>
<center><a href="HmacCore.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="KeyGeneratorCore.java.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>