<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames src/java.desktop/unix/native/libawt/awt/awt_Mlib.c</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
  2  * Copyright (c) 1998, 2013, Oracle and/or its affiliates. All rights reserved.
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.  Oracle designates this
  8  * particular file as subject to the &quot;Classpath&quot; exception as provided
  9  * by Oracle in the LICENSE file that accompanied this code.
 10  *
 11  * This code is distributed in the hope that it will be useful, but WITHOUT
 12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 14  * version 2 for more details (a copy is included in the LICENSE file that
 15  * accompanied this code).
 16  *
 17  * You should have received a copy of the GNU General Public License version
 18  * 2 along with this work; if not, write to the Free Software Foundation,
 19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 20  *
 21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 22  * or visit www.oracle.com if you need additional information or have any
 23  * questions.
 24  */
 25 
 26 #include &lt;stdlib.h&gt;
 27 #include &lt;string.h&gt;
 28 #include &lt;sys/time.h&gt;
 29 #include &lt;sys/utsname.h&gt;
 30 #include &lt;sys/types.h&gt;
 31 #include &lt;errno.h&gt;
 32 #include &lt;dlfcn.h&gt;
 33 #include &quot;jni.h&quot;
 34 #include &lt;jni_util.h&gt;
 35 #include &quot;jvm_md.h&quot;
 36 #include &quot;awt_Mlib.h&quot;
 37 #include &quot;java_awt_image_BufferedImage.h&quot;
 38 
 39 static void start_timer(int numsec);
 40 static void stop_timer(int numsec, int ntimes);
 41 
 42 /*
<a name="1" id="anc1"></a><span class="line-modified"> 43  * This is called by awt_ImagingLib.initLib()</span>

 44  */
 45 mlib_status awt_getImagingLib(JNIEnv *env, mlibFnS_t *sMlibFns,
 46                               mlibSysFnS_t *sMlibSysFns) {
 47     int status;
 48     jstring jstr = NULL;
 49     mlibFnS_t *mptr;
 50     void *(*vPtr)();
 51     int (*intPtr)();
 52     mlib_status (*fPtr)();
 53     int i;
 54     void *handle = NULL;
 55     mlibSysFnS_t tempSysFns;
 56     static int s_timeIt = 0;
 57     static int s_verbose = 1;
 58     mlib_status ret = MLIB_SUCCESS;
 59     struct utsname name;
 60 
<a name="2" id="anc2"></a><span class="line-modified"> 61     handle = dlopen(JNI_LIB_NAME(&quot;mlib_image&quot;), RTLD_LAZY);</span>














 62 
 63     if (handle == NULL) {
 64         if (s_timeIt || s_verbose) {
 65             printf (&quot;error in dlopen: %s&quot;, dlerror());
 66         }
 67         return MLIB_FAILURE;
 68     }
 69 
 70     /* So, if we are here, then either vis or generic version of
 71      * medialib library was sucessfuly loaded.
 72      * Let&#39;s try to initialize handlers...
 73      */
 74     if ((tempSysFns.createFP = (MlibCreateFP_t)dlsym(handle,
 75                                        &quot;j2d_mlib_ImageCreate&quot;)) == NULL) {
 76         if (s_timeIt) {
 77             printf (&quot;error in dlsym: %s&quot;, dlerror());
 78         }
 79         ret = MLIB_FAILURE;
 80     }
 81 
 82     if (ret == MLIB_SUCCESS) {
 83         if ((tempSysFns.createStructFP = (MlibCreateStructFP_t)dlsym(handle,
 84                                           &quot;j2d_mlib_ImageCreateStruct&quot;)) == NULL) {
 85             if (s_timeIt) {
 86                 printf (&quot;error in dlsym: %s&quot;, dlerror());
 87             }
 88             ret = MLIB_FAILURE;
 89         }
 90     }
 91 
 92     if (ret == MLIB_SUCCESS) {
 93         if ((tempSysFns.deleteImageFP = (MlibDeleteFP_t)dlsym(handle,
 94                                                  &quot;j2d_mlib_ImageDelete&quot;)) == NULL) {
 95             if (s_timeIt) {
 96                 printf (&quot;error in dlsym: %s&quot;, dlerror());
 97             }
 98             ret = MLIB_FAILURE;
 99         }
100     }
101 
102     /* Set the system functions */
103     if (ret == MLIB_SUCCESS) {
104         *sMlibSysFns = tempSysFns;
105     }
106 
107     /* Loop through all of the fns and load them from the next library */
108     mptr = sMlibFns;
109     i = 0;
110     while ((ret == MLIB_SUCCESS) &amp;&amp; (mptr[i].fname != NULL)) {
111         fPtr = (mlib_status (*)())dlsym(handle, mptr[i].fname);
112         if (fPtr != NULL) {
113             mptr[i].fptr = fPtr;
114         } else {
115             ret = MLIB_FAILURE;
116         }
117         i++;
118     }
119     if (ret != MLIB_SUCCESS) {
120         dlclose(handle);
121     }
122     return ret;
123 }
124 
125 mlib_start_timer awt_setMlibStartTimer() {
126     return start_timer;
127 }
128 
129 mlib_stop_timer awt_setMlibStopTimer() {
130     return stop_timer;
131 }
132 
133 /***************************************************************************
134  *                          Static Functions                               *
135  ***************************************************************************/
136 
137 static void start_timer(int numsec)
138 {
139     struct itimerval interval;
140 
141     interval.it_interval.tv_sec = numsec;
142     interval.it_interval.tv_usec = 0;
143     interval.it_value.tv_sec = numsec;
144     interval.it_value.tv_usec = 0;
145     setitimer(ITIMER_REAL, &amp;interval, 0);
146 }
147 
148 
149 static void stop_timer(int numsec, int ntimes)
150 {
151     struct itimerval interval;
152     double sec;
153 
154     getitimer(ITIMER_REAL, &amp;interval);
155     sec = (((double) (numsec - 1)) - (double) interval.it_value.tv_sec) +
156             (1000000.0 - interval.it_value.tv_usec)/1000000.0;
157     sec = sec/((double) ntimes);
158     printf(&quot;%f msec per update\n&quot;, sec * 1000.0);
159     interval.it_interval.tv_sec = 0;
160     interval.it_interval.tv_usec = 0;
161     interval.it_value.tv_sec = 0;
162     interval.it_value.tv_usec = 0;
163     setitimer(ITIMER_PROF, &amp;interval, 0);
164 }
<a name="3" id="anc3"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="3" type="hidden" />
</body>
</html>