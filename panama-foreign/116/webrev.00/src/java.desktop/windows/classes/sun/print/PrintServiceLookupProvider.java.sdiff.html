<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/java.desktop/windows/classes/sun/print/PrintServiceLookupProvider.java</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
  </head>
<body>
<center><a href="../awt/windows/WPathGraphics.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="../../../native/libawt/java2d/d3d/D3DPipeline.h.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/java.desktop/windows/classes/sun/print/PrintServiceLookupProvider.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2000, 2019, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.  Oracle designates this
  8  * particular file as subject to the &quot;Classpath&quot; exception as provided
  9  * by Oracle in the LICENSE file that accompanied this code.
 10  *
 11  * This code is distributed in the hope that it will be useful, but WITHOUT
 12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 14  * version 2 for more details (a copy is included in the LICENSE file that
 15  * accompanied this code).
 16  *
 17  * You should have received a copy of the GNU General Public License version
 18  * 2 along with this work; if not, write to the Free Software Foundation,
 19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 20  *
 21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 22  * or visit www.oracle.com if you need additional information or have any
 23  * questions.
 24  */
 25 
 26 package sun.print;
 27 
<span class="line-removed"> 28 import java.security.AccessController;</span>
 29 import java.util.ArrayList;
 30 import java.util.Arrays;
 31 import java.util.Comparator;

 32 import javax.print.DocFlavor;
 33 import javax.print.MultiDocPrintService;
 34 import javax.print.PrintService;
 35 import javax.print.PrintServiceLookup;
 36 import javax.print.attribute.Attribute;
 37 import javax.print.attribute.AttributeSet;
 38 import javax.print.attribute.HashPrintRequestAttributeSet;
 39 import javax.print.attribute.HashPrintServiceAttributeSet;
 40 import javax.print.attribute.PrintRequestAttribute;
 41 import javax.print.attribute.PrintRequestAttributeSet;
 42 import javax.print.attribute.PrintServiceAttribute;
 43 import javax.print.attribute.PrintServiceAttributeSet;
 44 import javax.print.attribute.standard.PrinterName;
 45 
 46 public class PrintServiceLookupProvider extends PrintServiceLookup {
 47 
 48     private String defaultPrinter;
 49     private PrintService defaultPrintService;
 50     private String[] printers; /* excludes the default printer */
 51     private PrintService[] printServices; /* includes the default printer */
</pre>
<hr />
<pre>
103      */
104     private static PrintServiceLookupProvider win32PrintLUS;
105 
106     /* Think carefully before calling this. Preferably don&#39;t call it. */
107     public static PrintServiceLookupProvider getWin32PrintLUS() {
108         if (win32PrintLUS == null) {
109             /* This call is internally synchronized.
110              * When it returns an instance of this class will have
111              * been instantiated - else there&#39;s a JDK internal error.
112              */
113             PrintServiceLookup.lookupDefaultPrintService();
114         }
115         return win32PrintLUS;
116     }
117 
118     public PrintServiceLookupProvider() {
119 
120         if (win32PrintLUS == null) {
121             win32PrintLUS = this;
122 
<span class="line-removed">123             String osName = AccessController.doPrivileged(</span>
<span class="line-removed">124                 new sun.security.action.GetPropertyAction(&quot;os.name&quot;));</span>
<span class="line-removed">125             // There&#39;s no capability for Win98 to refresh printers.</span>
<span class="line-removed">126             // See &quot;OpenPrinter&quot; for more info.</span>
<span class="line-removed">127             if (osName != null &amp;&amp; osName.startsWith(&quot;Windows 98&quot;)) {</span>
<span class="line-removed">128                 return;</span>
<span class="line-removed">129             }</span>
130             // start the local printer listener thread
131             Thread thr = new Thread(null, new PrinterChangeListener(),
132                                     &quot;PrinterListener&quot;, 0, false);
133             thr.setDaemon(true);
134             thr.start();
135 
136             if (pollServices) {
137                 // start the remote printer listener thread
138                 Thread remThr = new Thread(null, new RemotePrinterChangeListener(),
139                                            &quot;RemotePrinterListener&quot;, 0, false);
140                 remThr.setDaemon(true);
141                 remThr.start();
142             }
143         } /* else condition ought to never happen! */
144     }
145 
146     /* Want the PrintService which is default print service to have
147      * equality of reference with the equivalent in list of print services
148      * This isn&#39;t required by the API and there&#39;s a risk doing this will
149      * lead people to assume its guaranteed.
</pre>
<hr />
<pre>
339          // Not the same as default so proceed to get new PrintService.
340 
341         // clear defaultPrintService
342         defaultPrintService = null;
343 
344         if (printServices != null) {
345             for (int j=0; j&lt;printServices.length; j++) {
346                 if (defaultPrinter.equals(printServices[j].getName())) {
347                     defaultPrintService = printServices[j];
348                     break;
349                 }
350             }
351         }
352 
353         if (defaultPrintService == null) {
354             defaultPrintService = new Win32PrintService(defaultPrinter);
355         }
356         return defaultPrintService;
357     }
358 
<span class="line-modified">359     class PrinterChangeListener implements Runnable {</span>
<span class="line-removed">360         long chgObj;</span>
<span class="line-removed">361         PrinterChangeListener() {</span>
<span class="line-removed">362             chgObj = notifyFirstPrinterChange(null);</span>
<span class="line-removed">363         }</span>
<span class="line-removed">364 </span>
365         @Override
366         public void run() {
<span class="line-modified">367             if (chgObj != -1) {</span>
<span class="line-removed">368                 while (true) {</span>
<span class="line-removed">369                     // wait for configuration to change</span>
<span class="line-removed">370                     if (notifyPrinterChange(chgObj) != 0) {</span>
<span class="line-removed">371                         try {</span>
<span class="line-removed">372                             refreshServices();</span>
<span class="line-removed">373                         } catch (SecurityException se) {</span>
<span class="line-removed">374                             break;</span>
<span class="line-removed">375                         }</span>
<span class="line-removed">376                     } else {</span>
<span class="line-removed">377                         notifyClosePrinterChange(chgObj);</span>
<span class="line-removed">378                         break;</span>
<span class="line-removed">379                     }</span>
<span class="line-removed">380                 }</span>
<span class="line-removed">381             }</span>
382         }
383     }
384 
385     /* Windows provides *PrinterChangeNotification* functions that provides
386        information about printer status changes of the local printers but not
387        network printers.
388        Alternatively, Windows provides a way through which one can get the
389        network printer status changes by using WMI, RegistryKeyChange combination,
390        which is a slightly complex mechanism.
391        The Windows WMI offers an async and sync method to read through registry
392        via the WQL query. The async method is considered dangerous as it leaves
393        open a channel until we close it. But the async method has the advantage of
394        being notified of a change in registry by calling callback without polling for it.
395        The sync method uses the polling mechanism to notify.
396        RegistryValueChange cannot be used in combination with WMI to get registry
397        value change notification because of an error that may be generated because the
398        scope of the query would be too big to handle(at times).
399        Hence an alternative mechanism is chosen via the EnumPrinters by polling for the
400        count of printer status changes(add\remove) and based on it update the printers
401        list.
</pre>
<hr />
<pre>
429 
430                 String[] currentRemotePrinters = getRemotePrintersNames();
431                 if (currentRemotePrinters != null) {
432                     Arrays.sort(currentRemotePrinters, this);
433                 }
434                 if (!Arrays.equals(prevRemotePrinters, currentRemotePrinters)) {
435                     // The list of remote printers got updated,
436                     // so update the cached list printers which
437                     // includes both local and network printers
438                     refreshServices();
439 
440                     // store the current data for next comparison
441                     prevRemotePrinters = currentRemotePrinters;
442                 }
443             }
444         }
445     }
446 
447     private native String getDefaultPrinterName();
448     private native String[] getAllPrinterNames();
<span class="line-modified">449     private native long notifyFirstPrinterChange(String printer);</span>
<span class="line-removed">450     private native void notifyClosePrinterChange(long chgObj);</span>
<span class="line-removed">451     private native int notifyPrinterChange(long chgObj);</span>
452     private native String[] getRemotePrintersNames();
453 }
</pre>
</td>
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2000, 2020, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.  Oracle designates this
  8  * particular file as subject to the &quot;Classpath&quot; exception as provided
  9  * by Oracle in the LICENSE file that accompanied this code.
 10  *
 11  * This code is distributed in the hope that it will be useful, but WITHOUT
 12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 14  * version 2 for more details (a copy is included in the LICENSE file that
 15  * accompanied this code).
 16  *
 17  * You should have received a copy of the GNU General Public License version
 18  * 2 along with this work; if not, write to the Free Software Foundation,
 19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 20  *
 21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 22  * or visit www.oracle.com if you need additional information or have any
 23  * questions.
 24  */
 25 
 26 package sun.print;
 27 

 28 import java.util.ArrayList;
 29 import java.util.Arrays;
 30 import java.util.Comparator;
<span class="line-added"> 31 </span>
 32 import javax.print.DocFlavor;
 33 import javax.print.MultiDocPrintService;
 34 import javax.print.PrintService;
 35 import javax.print.PrintServiceLookup;
 36 import javax.print.attribute.Attribute;
 37 import javax.print.attribute.AttributeSet;
 38 import javax.print.attribute.HashPrintRequestAttributeSet;
 39 import javax.print.attribute.HashPrintServiceAttributeSet;
 40 import javax.print.attribute.PrintRequestAttribute;
 41 import javax.print.attribute.PrintRequestAttributeSet;
 42 import javax.print.attribute.PrintServiceAttribute;
 43 import javax.print.attribute.PrintServiceAttributeSet;
 44 import javax.print.attribute.standard.PrinterName;
 45 
 46 public class PrintServiceLookupProvider extends PrintServiceLookup {
 47 
 48     private String defaultPrinter;
 49     private PrintService defaultPrintService;
 50     private String[] printers; /* excludes the default printer */
 51     private PrintService[] printServices; /* includes the default printer */
</pre>
<hr />
<pre>
103      */
104     private static PrintServiceLookupProvider win32PrintLUS;
105 
106     /* Think carefully before calling this. Preferably don&#39;t call it. */
107     public static PrintServiceLookupProvider getWin32PrintLUS() {
108         if (win32PrintLUS == null) {
109             /* This call is internally synchronized.
110              * When it returns an instance of this class will have
111              * been instantiated - else there&#39;s a JDK internal error.
112              */
113             PrintServiceLookup.lookupDefaultPrintService();
114         }
115         return win32PrintLUS;
116     }
117 
118     public PrintServiceLookupProvider() {
119 
120         if (win32PrintLUS == null) {
121             win32PrintLUS = this;
122 







123             // start the local printer listener thread
124             Thread thr = new Thread(null, new PrinterChangeListener(),
125                                     &quot;PrinterListener&quot;, 0, false);
126             thr.setDaemon(true);
127             thr.start();
128 
129             if (pollServices) {
130                 // start the remote printer listener thread
131                 Thread remThr = new Thread(null, new RemotePrinterChangeListener(),
132                                            &quot;RemotePrinterListener&quot;, 0, false);
133                 remThr.setDaemon(true);
134                 remThr.start();
135             }
136         } /* else condition ought to never happen! */
137     }
138 
139     /* Want the PrintService which is default print service to have
140      * equality of reference with the equivalent in list of print services
141      * This isn&#39;t required by the API and there&#39;s a risk doing this will
142      * lead people to assume its guaranteed.
</pre>
<hr />
<pre>
332          // Not the same as default so proceed to get new PrintService.
333 
334         // clear defaultPrintService
335         defaultPrintService = null;
336 
337         if (printServices != null) {
338             for (int j=0; j&lt;printServices.length; j++) {
339                 if (defaultPrinter.equals(printServices[j].getName())) {
340                     defaultPrintService = printServices[j];
341                     break;
342                 }
343             }
344         }
345 
346         if (defaultPrintService == null) {
347             defaultPrintService = new Win32PrintService(defaultPrinter);
348         }
349         return defaultPrintService;
350     }
351 
<span class="line-modified">352     private final class PrinterChangeListener implements Runnable {</span>





353         @Override
354         public void run() {
<span class="line-modified">355             notifyLocalPrinterChange(); // busy loop in the native code</span>














356         }
357     }
358 
359     /* Windows provides *PrinterChangeNotification* functions that provides
360        information about printer status changes of the local printers but not
361        network printers.
362        Alternatively, Windows provides a way through which one can get the
363        network printer status changes by using WMI, RegistryKeyChange combination,
364        which is a slightly complex mechanism.
365        The Windows WMI offers an async and sync method to read through registry
366        via the WQL query. The async method is considered dangerous as it leaves
367        open a channel until we close it. But the async method has the advantage of
368        being notified of a change in registry by calling callback without polling for it.
369        The sync method uses the polling mechanism to notify.
370        RegistryValueChange cannot be used in combination with WMI to get registry
371        value change notification because of an error that may be generated because the
372        scope of the query would be too big to handle(at times).
373        Hence an alternative mechanism is chosen via the EnumPrinters by polling for the
374        count of printer status changes(add\remove) and based on it update the printers
375        list.
</pre>
<hr />
<pre>
403 
404                 String[] currentRemotePrinters = getRemotePrintersNames();
405                 if (currentRemotePrinters != null) {
406                     Arrays.sort(currentRemotePrinters, this);
407                 }
408                 if (!Arrays.equals(prevRemotePrinters, currentRemotePrinters)) {
409                     // The list of remote printers got updated,
410                     // so update the cached list printers which
411                     // includes both local and network printers
412                     refreshServices();
413 
414                     // store the current data for next comparison
415                     prevRemotePrinters = currentRemotePrinters;
416                 }
417             }
418         }
419     }
420 
421     private native String getDefaultPrinterName();
422     private native String[] getAllPrinterNames();
<span class="line-modified">423     private native void notifyLocalPrinterChange();</span>


424     private native String[] getRemotePrintersNames();
425 }
</pre>
</td>
</tr>
</table>
<center><a href="../awt/windows/WPathGraphics.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="../../../native/libawt/java2d/d3d/D3DPipeline.h.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>