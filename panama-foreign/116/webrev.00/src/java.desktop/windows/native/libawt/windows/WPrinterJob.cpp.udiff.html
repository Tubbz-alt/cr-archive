<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff src/java.desktop/windows/native/libawt/windows/WPrinterJob.cpp</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
  </head>
<body>
<center><a href="../java2d/d3d/D3DPipeline.h.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="alloc.h.udiff.html" target="_top">next &gt;</a></center>    <h2>src/java.desktop/windows/native/libawt/windows/WPrinterJob.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -183,66 +183,49 @@</span>
                                                                   jobject peer)
  {
      return getPrinterNames(env, PRINTER_ENUM_CONNECTIONS);
  }
  
<span class="udiff-line-added">+ JNIEXPORT void JNICALL</span>
<span class="udiff-line-added">+ Java_sun_print_PrintServiceLookupProvider_notifyLocalPrinterChange(JNIEnv *env,</span>
<span class="udiff-line-added">+                                                                    jobject peer)</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+     jclass cls = env-&gt;GetObjectClass(peer);</span>
<span class="udiff-line-added">+     CHECK_NULL(cls);</span>
<span class="udiff-line-added">+     jmethodID refresh = env-&gt;GetMethodID(cls, &quot;refreshServices&quot;, &quot;()V&quot;);</span>
<span class="udiff-line-added">+     CHECK_NULL(refresh);</span>
  
<span class="udiff-line-removed">- JNIEXPORT jlong JNICALL</span>
<span class="udiff-line-removed">- Java_sun_print_PrintServiceLookupProvider_notifyFirstPrinterChange(JNIEnv *env,</span>
<span class="udiff-line-removed">-                                                                 jobject peer,</span>
<span class="udiff-line-removed">-                                                                 jstring printer) {</span>
      HANDLE hPrinter;
<span class="udiff-line-modified-removed">- </span>
<span class="udiff-line-modified-removed">-     LPTSTR printerName = NULL;</span>
<span class="udiff-line-modified-removed">-     if (printer != NULL) {</span>
<span class="udiff-line-removed">-         printerName = (LPTSTR)JNU_GetStringPlatformChars(env,</span>
<span class="udiff-line-removed">-                                                          printer,</span>
<span class="udiff-line-removed">-                                                          NULL);</span>
<span class="udiff-line-removed">-         JNU_ReleaseStringPlatformChars(env, printer, printerName);</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     // printerName - &quot;Win NT/2K/XP: If NULL, it indicates the local printer</span>
<span class="udiff-line-removed">-     // server&quot; - MSDN.   Win9x : OpenPrinter returns 0.</span>
<span class="udiff-line-removed">-     BOOL ret = OpenPrinter(printerName, &amp;hPrinter, NULL);</span>
<span class="udiff-line-removed">-     if (!ret) {</span>
<span class="udiff-line-removed">-       return (jlong)-1;</span>
<span class="udiff-line-modified-added">+     LPTSTR printerName = NULL; // NULL indicates the local printer server</span>
<span class="udiff-line-modified-added">+     if (!::OpenPrinter(printerName, &amp;hPrinter, NULL)) {</span>
<span class="udiff-line-modified-added">+         return;</span>
      }
<span class="udiff-line-removed">- </span>
      // PRINTER_CHANGE_PRINTER = PRINTER_CHANGE_ADD_PRINTER |
      //                          PRINTER_CHANGE_SET_PRINTER |
      //                          PRINTER_CHANGE_DELETE_PRINTER |
      //                          PRINTER_CHANGE_FAILED_CONNECTION_PRINTER
      HANDLE chgObj = FindFirstPrinterChangeNotification(hPrinter,
                                                         PRINTER_CHANGE_PRINTER,
                                                         0,
                                                         NULL);
<span class="udiff-line-modified-removed">-     return (chgObj == INVALID_HANDLE_VALUE) ? (jlong)-1 : (jlong)chgObj;</span>
<span class="udiff-line-modified-removed">- }</span>
<span class="udiff-line-modified-removed">- </span>
<span class="udiff-line-modified-removed">- </span>
<span class="udiff-line-modified-removed">- </span>
<span class="udiff-line-modified-removed">- JNIEXPORT void JNICALL</span>
<span class="udiff-line-modified-removed">- Java_sun_print_PrintServiceLookupProvider_notifyClosePrinterChange(JNIEnv *env,</span>
<span class="udiff-line-modified-removed">-                                                                 jobject peer,</span>
<span class="udiff-line-modified-removed">-                                                                 jlong chgObject) {</span>
<span class="udiff-line-modified-removed">-     FindClosePrinterChangeNotification((HANDLE)chgObject);</span>
<span class="udiff-line-modified-removed">- }</span>
<span class="udiff-line-modified-removed">- </span>
<span class="udiff-line-modified-removed">- </span>
<span class="udiff-line-removed">- JNIEXPORT jint JNICALL</span>
<span class="udiff-line-removed">- Java_sun_print_PrintServiceLookupProvider_notifyPrinterChange(JNIEnv *env,</span>
<span class="udiff-line-removed">-                                                            jobject peer,</span>
<span class="udiff-line-removed">-                                                            jlong chgObject) {</span>
<span class="udiff-line-removed">-     DWORD dwChange;</span>
<span class="udiff-line-modified-added">+     if (chgObj != INVALID_HANDLE_VALUE) {</span>
<span class="udiff-line-modified-added">+         BOOL keepMonitoring;</span>
<span class="udiff-line-modified-added">+         do {</span>
<span class="udiff-line-modified-added">+             keepMonitoring = FALSE;</span>
<span class="udiff-line-modified-added">+             if (WaitForSingleObject(chgObj, INFINITE) == WAIT_OBJECT_0) {</span>
<span class="udiff-line-modified-added">+                 DWORD dwChange;</span>
<span class="udiff-line-modified-added">+                 keepMonitoring = FindNextPrinterChangeNotification(</span>
<span class="udiff-line-modified-added">+                                                  chgObj, &amp;dwChange, NULL, NULL);</span>
<span class="udiff-line-modified-added">+             }</span>
<span class="udiff-line-modified-added">+             if (keepMonitoring) {</span>
<span class="udiff-line-modified-added">+                 env-&gt;CallVoidMethod(peer, refresh);</span>
<span class="udiff-line-modified-added">+             }</span>
<span class="udiff-line-modified-added">+         } while (keepMonitoring &amp;&amp; !env-&gt;ExceptionCheck());</span>
  
<span class="udiff-line-modified-removed">-     DWORD ret = WaitForSingleObject((HANDLE)chgObject, INFINITE);</span>
<span class="udiff-line-removed">-     if (ret == WAIT_OBJECT_0) {</span>
<span class="udiff-line-removed">-         return(FindNextPrinterChangeNotification((HANDLE)chgObject,</span>
<span class="udiff-line-removed">-                                                   &amp;dwChange, NULL, NULL));</span>
<span class="udiff-line-removed">-     } else {</span>
<span class="udiff-line-removed">-         return 0;</span>
<span class="udiff-line-modified-added">+         FindClosePrinterChangeNotification(chgObj);</span>
      }
<span class="udiff-line-added">+     ::ClosePrinter(hPrinter);</span>
  }
  
  
  JNIEXPORT jfloatArray JNICALL
  Java_sun_print_Win32PrintService_getMediaPrintableArea(JNIEnv *env,
</pre>
<center><a href="../java2d/d3d/D3DPipeline.h.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="alloc.h.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>