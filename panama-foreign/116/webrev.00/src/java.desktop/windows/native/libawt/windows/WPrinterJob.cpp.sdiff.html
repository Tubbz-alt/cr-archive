<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/java.desktop/windows/native/libawt/windows/WPrinterJob.cpp</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
  </head>
<body>
<center><a href="../java2d/d3d/D3DPipeline.h.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="alloc.h.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/java.desktop/windows/native/libawt/windows/WPrinterJob.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 168     delete [] pPrinterEnum;
 169     return nameArray;
 170 
 171     CATCH_BAD_ALLOC_RET(NULL);
 172 }
 173 
 174 JNIEXPORT jobjectArray JNICALL
 175 Java_sun_print_PrintServiceLookupProvider_getAllPrinterNames(JNIEnv *env,
 176                                                              jobject peer)
 177 {
 178     return getPrinterNames(env, PRINTER_ENUM_LOCAL | PRINTER_ENUM_CONNECTIONS);
 179 }
 180 
 181 JNIEXPORT jobjectArray JNICALL
 182 Java_sun_print_PrintServiceLookupProvider_getRemotePrintersNames(JNIEnv *env,
 183                                                                  jobject peer)
 184 {
 185     return getPrinterNames(env, PRINTER_ENUM_CONNECTIONS);
 186 }
 187 








 188 
<span class="line-removed"> 189 JNIEXPORT jlong JNICALL</span>
<span class="line-removed"> 190 Java_sun_print_PrintServiceLookupProvider_notifyFirstPrinterChange(JNIEnv *env,</span>
<span class="line-removed"> 191                                                                 jobject peer,</span>
<span class="line-removed"> 192                                                                 jstring printer) {</span>
 193     HANDLE hPrinter;
<span class="line-modified"> 194 </span>
<span class="line-modified"> 195     LPTSTR printerName = NULL;</span>
<span class="line-modified"> 196     if (printer != NULL) {</span>
<span class="line-removed"> 197         printerName = (LPTSTR)JNU_GetStringPlatformChars(env,</span>
<span class="line-removed"> 198                                                          printer,</span>
<span class="line-removed"> 199                                                          NULL);</span>
<span class="line-removed"> 200         JNU_ReleaseStringPlatformChars(env, printer, printerName);</span>
<span class="line-removed"> 201     }</span>
<span class="line-removed"> 202 </span>
<span class="line-removed"> 203     // printerName - &quot;Win NT/2K/XP: If NULL, it indicates the local printer</span>
<span class="line-removed"> 204     // server&quot; - MSDN.   Win9x : OpenPrinter returns 0.</span>
<span class="line-removed"> 205     BOOL ret = OpenPrinter(printerName, &amp;hPrinter, NULL);</span>
<span class="line-removed"> 206     if (!ret) {</span>
<span class="line-removed"> 207       return (jlong)-1;</span>
 208     }
<span class="line-removed"> 209 </span>
 210     // PRINTER_CHANGE_PRINTER = PRINTER_CHANGE_ADD_PRINTER |
 211     //                          PRINTER_CHANGE_SET_PRINTER |
 212     //                          PRINTER_CHANGE_DELETE_PRINTER |
 213     //                          PRINTER_CHANGE_FAILED_CONNECTION_PRINTER
 214     HANDLE chgObj = FindFirstPrinterChangeNotification(hPrinter,
 215                                                        PRINTER_CHANGE_PRINTER,
 216                                                        0,
 217                                                        NULL);
<span class="line-modified"> 218     return (chgObj == INVALID_HANDLE_VALUE) ? (jlong)-1 : (jlong)chgObj;</span>
<span class="line-modified"> 219 }</span>
<span class="line-modified"> 220 </span>
<span class="line-modified"> 221 </span>
<span class="line-modified"> 222 </span>
<span class="line-modified"> 223 JNIEXPORT void JNICALL</span>
<span class="line-modified"> 224 Java_sun_print_PrintServiceLookupProvider_notifyClosePrinterChange(JNIEnv *env,</span>
<span class="line-modified"> 225                                                                 jobject peer,</span>
<span class="line-modified"> 226                                                                 jlong chgObject) {</span>
<span class="line-modified"> 227     FindClosePrinterChangeNotification((HANDLE)chgObject);</span>
<span class="line-modified"> 228 }</span>
<span class="line-modified"> 229 </span>
<span class="line-modified"> 230 </span>
<span class="line-removed"> 231 JNIEXPORT jint JNICALL</span>
<span class="line-removed"> 232 Java_sun_print_PrintServiceLookupProvider_notifyPrinterChange(JNIEnv *env,</span>
<span class="line-removed"> 233                                                            jobject peer,</span>
<span class="line-removed"> 234                                                            jlong chgObject) {</span>
<span class="line-removed"> 235     DWORD dwChange;</span>
 236 
<span class="line-modified"> 237     DWORD ret = WaitForSingleObject((HANDLE)chgObject, INFINITE);</span>
<span class="line-removed"> 238     if (ret == WAIT_OBJECT_0) {</span>
<span class="line-removed"> 239         return(FindNextPrinterChangeNotification((HANDLE)chgObject,</span>
<span class="line-removed"> 240                                                   &amp;dwChange, NULL, NULL));</span>
<span class="line-removed"> 241     } else {</span>
<span class="line-removed"> 242         return 0;</span>
 243     }

 244 }
 245 
 246 
 247 JNIEXPORT jfloatArray JNICALL
 248 Java_sun_print_Win32PrintService_getMediaPrintableArea(JNIEnv *env,
 249                                                   jobject peer,
 250                                                   jstring printer,
 251                                                   jint  papersize)
 252 {
 253     TRY;
 254 
 255     LPTSTR printerName = (LPTSTR)JNU_GetStringPlatformChars(env,
 256                                                             printer, NULL);
 257     if (printerName == NULL) {
 258         return NULL;
 259     }
 260 
 261     jfloatArray printableArray = NULL;
 262 
 263     SAVE_CONTROLWORD
</pre>
</td>
<td>
<hr />
<pre>
 168     delete [] pPrinterEnum;
 169     return nameArray;
 170 
 171     CATCH_BAD_ALLOC_RET(NULL);
 172 }
 173 
 174 JNIEXPORT jobjectArray JNICALL
 175 Java_sun_print_PrintServiceLookupProvider_getAllPrinterNames(JNIEnv *env,
 176                                                              jobject peer)
 177 {
 178     return getPrinterNames(env, PRINTER_ENUM_LOCAL | PRINTER_ENUM_CONNECTIONS);
 179 }
 180 
 181 JNIEXPORT jobjectArray JNICALL
 182 Java_sun_print_PrintServiceLookupProvider_getRemotePrintersNames(JNIEnv *env,
 183                                                                  jobject peer)
 184 {
 185     return getPrinterNames(env, PRINTER_ENUM_CONNECTIONS);
 186 }
 187 
<span class="line-added"> 188 JNIEXPORT void JNICALL</span>
<span class="line-added"> 189 Java_sun_print_PrintServiceLookupProvider_notifyLocalPrinterChange(JNIEnv *env,</span>
<span class="line-added"> 190                                                                    jobject peer)</span>
<span class="line-added"> 191 {</span>
<span class="line-added"> 192     jclass cls = env-&gt;GetObjectClass(peer);</span>
<span class="line-added"> 193     CHECK_NULL(cls);</span>
<span class="line-added"> 194     jmethodID refresh = env-&gt;GetMethodID(cls, &quot;refreshServices&quot;, &quot;()V&quot;);</span>
<span class="line-added"> 195     CHECK_NULL(refresh);</span>
 196 




 197     HANDLE hPrinter;
<span class="line-modified"> 198     LPTSTR printerName = NULL; // NULL indicates the local printer server</span>
<span class="line-modified"> 199     if (!::OpenPrinter(printerName, &amp;hPrinter, NULL)) {</span>
<span class="line-modified"> 200         return;</span>











 201     }

 202     // PRINTER_CHANGE_PRINTER = PRINTER_CHANGE_ADD_PRINTER |
 203     //                          PRINTER_CHANGE_SET_PRINTER |
 204     //                          PRINTER_CHANGE_DELETE_PRINTER |
 205     //                          PRINTER_CHANGE_FAILED_CONNECTION_PRINTER
 206     HANDLE chgObj = FindFirstPrinterChangeNotification(hPrinter,
 207                                                        PRINTER_CHANGE_PRINTER,
 208                                                        0,
 209                                                        NULL);
<span class="line-modified"> 210     if (chgObj != INVALID_HANDLE_VALUE) {</span>
<span class="line-modified"> 211         BOOL keepMonitoring;</span>
<span class="line-modified"> 212         do {</span>
<span class="line-modified"> 213             keepMonitoring = FALSE;</span>
<span class="line-modified"> 214             if (WaitForSingleObject(chgObj, INFINITE) == WAIT_OBJECT_0) {</span>
<span class="line-modified"> 215                 DWORD dwChange;</span>
<span class="line-modified"> 216                 keepMonitoring = FindNextPrinterChangeNotification(</span>
<span class="line-modified"> 217                                                  chgObj, &amp;dwChange, NULL, NULL);</span>
<span class="line-modified"> 218             }</span>
<span class="line-modified"> 219             if (keepMonitoring) {</span>
<span class="line-modified"> 220                 env-&gt;CallVoidMethod(peer, refresh);</span>
<span class="line-modified"> 221             }</span>
<span class="line-modified"> 222         } while (keepMonitoring &amp;&amp; !env-&gt;ExceptionCheck());</span>





 223 
<span class="line-modified"> 224         FindClosePrinterChangeNotification(chgObj);</span>





 225     }
<span class="line-added"> 226     ::ClosePrinter(hPrinter);</span>
 227 }
 228 
 229 
 230 JNIEXPORT jfloatArray JNICALL
 231 Java_sun_print_Win32PrintService_getMediaPrintableArea(JNIEnv *env,
 232                                                   jobject peer,
 233                                                   jstring printer,
 234                                                   jint  papersize)
 235 {
 236     TRY;
 237 
 238     LPTSTR printerName = (LPTSTR)JNU_GetStringPlatformChars(env,
 239                                                             printer, NULL);
 240     if (printerName == NULL) {
 241         return NULL;
 242     }
 243 
 244     jfloatArray printableArray = NULL;
 245 
 246     SAVE_CONTROLWORD
</pre>
</td>
</tr>
</table>
<center><a href="../java2d/d3d/D3DPipeline.h.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="alloc.h.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>