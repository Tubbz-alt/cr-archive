<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames test/jdk/com/sun/crypto/provider/Mac/MacKAT.java</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
<a name="1" id="anc1"></a><span class="line-modified">  2  * Copyright (c) 2003, 2012, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 /**
 25  * @test
<a name="2" id="anc2"></a><span class="line-modified"> 26  * @bug 4846410 6313661 4963723</span>
 27  * @summary Basic known-answer-test for Hmac and SslMac algorithms
 28  * @author Andreas Sterbenz
 29  */
 30 
 31 import java.io.*;
 32 import java.util.*;
 33 
 34 import java.security.*;
 35 
 36 import javax.crypto.*;
 37 import javax.crypto.spec.*;
 38 
 39 public class MacKAT {
 40 
 41     private final static char[] hexDigits = &quot;0123456789abcdef&quot;.toCharArray();
 42 
<a name="3" id="anc3"></a>



 43     public static String toString(byte[] b) {
 44         if (b == null) {
 45             return &quot;(null)&quot;;
 46         }
 47         StringBuffer sb = new StringBuffer(b.length * 3);
 48         for (int i = 0; i &lt; b.length; i++) {
 49             int k = b[i] &amp; 0xff;
 50             if (i != 0) {
<a name="4" id="anc4"></a><span class="line-modified"> 51                 sb.append(&#39;:&#39;);</span>
 52             }
 53             sb.append(hexDigits[k &gt;&gt;&gt; 4]);
 54             sb.append(hexDigits[k &amp; 0xf]);
 55         }
 56         return sb.toString();
 57     }
 58 
 59     public static byte[] parse(String s) {
 60         try {
 61             int n = s.length();
<a name="5" id="anc5"></a><span class="line-modified"> 62             ByteArrayOutputStream out = new ByteArrayOutputStream(n / 3);</span>






 63             StringReader r = new StringReader(s);
 64             while (true) {
 65                 int b1 = nextNibble(r);
 66                 if (b1 &lt; 0) {
 67                     break;
 68                 }
 69                 int b2 = nextNibble(r);
 70                 if (b2 &lt; 0) {
 71                     throw new RuntimeException(&quot;Invalid string &quot; + s);
 72                 }
 73                 int b = (b1 &lt;&lt; 4) | b2;
 74                 out.write(b);
 75             }
 76             return out.toByteArray();
 77         } catch (IOException e) {
 78             throw new RuntimeException(e);
 79         }
 80     }
 81 
 82     public static byte[] b(String s) {
 83         return parse(s);
 84     }
 85 
 86     private static int nextNibble(StringReader r) throws IOException {
 87         while (true) {
 88             int ch = r.read();
 89             if (ch == -1) {
 90                 return -1;
 91             } else if ((ch &gt;= &#39;0&#39;) &amp;&amp; (ch &lt;= &#39;9&#39;)) {
 92                 return ch - &#39;0&#39;;
 93             } else if ((ch &gt;= &#39;a&#39;) &amp;&amp; (ch &lt;= &#39;f&#39;)) {
 94                 return ch - &#39;a&#39; + 10;
 95             } else if ((ch &gt;= &#39;A&#39;) &amp;&amp; (ch &lt;= &#39;F&#39;)) {
 96                 return ch - &#39;A&#39; + 10;
 97             }
 98         }
 99     }
100 
101     static abstract class Test {
102         abstract void run(Provider p) throws Exception;
103     }
104 
105     static class MacTest extends Test {
106         private final String alg;
107         private final byte[] input;
108         private final byte[] macvalue;
109         private final byte[] key;
110         MacTest(String alg, byte[] input, byte[] macvalue, byte[] key) {
111             this.alg = alg;
112             this.input = input;
113             this.macvalue = macvalue;
114             this.key = key;
115         }
<a name="6" id="anc6"></a><span class="line-modified">116         void run(Provider p) throws Exception {</span>
<span class="line-modified">117             Mac mac = Mac.getInstance(alg, p);</span>
<span class="line-modified">118             SecretKey keySpec = new SecretKeySpec(key, alg);</span>
<span class="line-modified">119             mac.init(keySpec);</span>
<span class="line-modified">120             mac.update(input);</span>
<span class="line-modified">121             byte[] macv = mac.doFinal();</span>


























122             if (Arrays.equals(macvalue, macv) == false) {
123                 System.out.println(&quot;Mac test for &quot; + alg + &quot; failed:&quot;);
124                 if (input.length &lt; 256) {
125                     System.out.println(&quot;input:       &quot; + toString(input));
126                 }
127                 System.out.println(&quot;key:        &quot; + toString(key));
128                 System.out.println(&quot;macvalue:   &quot; + toString(macvalue));
129                 System.out.println(&quot;calculated: &quot; + toString(macv));
<a name="7" id="anc7"></a><span class="line-modified">130                 throw new Exception(&quot;Mac test for &quot; + alg + &quot; failed&quot;);</span>


131             }
<a name="8" id="anc8"></a><span class="line-removed">132             System.out.println(&quot;passed: &quot; + alg);</span>
133         }
134         private static String toString(byte[] b) {
135             return MacKAT.toString(b);
136         }
137     }
138 
139     private static byte[] s(String s) {
140         try {
141             return s.getBytes(&quot;UTF8&quot;);
142         } catch (Exception e) {
143             throw new RuntimeException(e);
144         }
145     }
146 
147     private static Test t(String alg, String input, String macvalue, String key) {
148         return new MacTest(alg, b(input), b(macvalue), b(key));
149     }
150     private static Test t(String alg, String input, String macvalue, byte[] key) {
151         return new MacTest(alg, b(input), b(macvalue), key);
152     }
153     private static Test t(String alg, byte[] input, String macvalue, String key) {
154         return new MacTest(alg, input, b(macvalue), b(key));
155     }
156 
157     private static Test t(String alg, byte[] input, String macvalue, byte[] key) {
158         return new MacTest(alg, input, b(macvalue), key);
159     }
<a name="9" id="anc9"></a><span class="line-modified">160     private final static byte[] ALONG, BLONG, BKEY;</span>
<span class="line-modified">161     private final static byte[] BKEY_20, DDDATA_50, AAKEY_20, CDDATA_50, AAKEY_131;</span>





162 
163     static {
164         ALONG = new byte[1024 * 128];
165         Arrays.fill(ALONG, (byte)&#39;a&#39;);
166         BLONG = new byte[1024 * 128];
167         Random random = new Random(12345678);
168         random.nextBytes(BLONG);
<a name="10" id="anc10"></a>













169         BKEY = new byte[128];
170         random.nextBytes(BKEY);
171         BKEY_20 = new byte[20];
172         Arrays.fill(BKEY_20, (byte) 0x0b);
<a name="11" id="anc11"></a><span class="line-modified">173         DDDATA_50 = new byte[50];</span>
<span class="line-modified">174         Arrays.fill(DDDATA_50, (byte) 0xdd);</span>
175         AAKEY_20 = new byte[20];
176         Arrays.fill(AAKEY_20, (byte) 0xaa);
<a name="12" id="anc12"></a><span class="line-removed">177         CDDATA_50 = new byte[50];</span>
<span class="line-removed">178         Arrays.fill(CDDATA_50, (byte) 0xcd);</span>
179         AAKEY_131 = new byte[131];
180         Arrays.fill(AAKEY_131, (byte) 0xaa);
<a name="13" id="anc13"></a>










181     }
182 
183     private final static Test[] tests = {
184         t(&quot;SslMacMD5&quot;, ALONG, &quot;f4:ad:01:71:51:f6:89:56:72:a3:32:bf:d9:2a:f2:a5&quot;,
185                 &quot;1b:34:61:29:05:0d:73:db:25:d0:dd:64:06:29:f6:8a&quot;),
186         t(&quot;SslMacMD5&quot;, BLONG, &quot;34:1c:ad:a0:95:57:32:f8:8e:80:8f:ee:b2:d8:23:e5&quot;,
187                 &quot;76:00:4a:72:98:9b:65:ec:2e:f1:43:c4:65:4a:13:71&quot;),
188         t(&quot;SslMacSHA1&quot;, ALONG, &quot;11:c1:71:2e:61:be:4b:cf:bc:6d:e2:4c:58:ae:27:30:0b:24:a4:87&quot;,
189                 &quot;23:ae:dd:61:87:6c:7a:45:47:2f:2c:8f:ea:64:99:3e:27:5f:97:a5&quot;),
190         t(&quot;SslMacSHA1&quot;, BLONG, &quot;84:af:57:0a:af:ef:16:93:90:50:da:88:f8:ad:1a:c5:66:6c:94:d0&quot;,
191                 &quot;9b:bb:e2:aa:9b:28:1c:95:0e:ea:30:21:98:a5:7e:31:9e:bf:5f:51&quot;),
192 
193         t(&quot;HmacMD5&quot;, ALONG, &quot;76:00:4a:72:98:9b:65:ec:2e:f1:43:c4:65:4a:13:71&quot;,
194                 &quot;1b:34:61:29:05:0d:73:db:25:d0:dd:64:06:29:f6:8a&quot;),
195         t(&quot;HmacMD5&quot;, BLONG, &quot;6c:22:79:bb:34:9e:da:f4:f5:cf:df:0c:62:3d:59:e0&quot;,
196                 &quot;76:00:4a:72:98:9b:65:ec:2e:f1:43:c4:65:4a:13:71&quot;),
197         t(&quot;HmacMD5&quot;, BLONG, &quot;e6:ad:00:c9:49:6b:98:fe:53:a2:b9:2d:7d:41:a2:03&quot;,
198                 BKEY),
199         t(&quot;HmacSHA1&quot;, ALONG, &quot;9e:b3:6e:35:fa:fb:17:2e:2b:f3:b0:4a:9d:38:83:c4:5f:6d:d9:00&quot;,
200                 &quot;1b:34:61:29:05:0d:73:db:25:d0:dd:64:06:29:f6:8a&quot;),
201         t(&quot;HmacSHA1&quot;, BLONG, &quot;80:2d:5b:ea:08:df:a4:1f:e5:3e:1c:fa:fc:ad:dd:31:da:15:60:2c&quot;,
202                 &quot;76:00:4a:72:98:9b:65:ec:2e:f1:43:c4:65:4a:13:71&quot;),
203         t(&quot;HmacSHA1&quot;, BLONG, &quot;a2:fa:2a:85:18:0e:94:b2:a5:e2:17:8b:2a:29:7a:95:cd:e8:aa:82&quot;,
204                 BKEY),
205 
206         t(&quot;HmacSHA256&quot;, ALONG, &quot;3f:6d:08:df:0c:90:b0:e9:ed:13:4a:2e:c3:48:1d:3d:3e:61:2e:f1:30:c2:63:c4:58:57:03:c2:cb:87:15:07&quot;,
207                 &quot;1b:34:61:29:05:0d:73:db:25:d0:dd:64:06:29:f6:8a&quot;),
208         t(&quot;HmacSHA256&quot;, BLONG, &quot;e2:4e:a3:b9:0b:b8:99:e4:71:cf:ca:9f:f8:4e:f0:34:8b:19:9f:33:4b:1a:b7:13:f7:c8:57:92:e3:03:74:78&quot;,
209                 BKEY),
210         t(&quot;HmacSHA384&quot;, ALONG, &quot;d0:f0:d4:54:1c:0a:6d:81:ed:15:20:d7:0c:96:06:61:a0:ff:c9:ff:91:e9:a0:cd:e2:45:64:9d:93:4c:a9:fa:89:ae:c0:90:e6:0b:a1:a0:56:80:57:3b:ed:4b:b0:71&quot;,
211                 &quot;1b:34:61:29:05:0d:73:db:25:d0:dd:64:06:29:f6:8a&quot;),
212         t(&quot;HmacSHA384&quot;, BLONG, &quot;75:c4:ca:c7:f7:58:9d:d3:23:b1:1b:5c:93:2d:ec:7a:03:dc:8c:eb:8d:fe:79:46:4f:30:e7:99:62:de:44:e2:38:95:0e:79:91:78:2f:a4:05:0a:f0:17:10:38:a1:8e&quot;,
213                 BKEY),
214         t(&quot;HmacSHA512&quot;, ALONG, &quot;41:ea:4c:e5:31:3f:7c:18:0e:5e:95:a9:25:0a:10:58:e6:40:53:88:82:4f:5a:da:6f:29:de:04:7b:8e:d7:ed:7c:4d:b8:2a:48:2d:17:2a:2d:59:bb:81:9c:bf:33:40:04:77:44:fb:45:25:1f:fd:b9:29:f4:a6:69:a3:43:6f&quot;,
215                 &quot;1b:34:61:29:05:0d:73:db:25:d0:dd:64:06:29:f6:8a&quot;),
216         t(&quot;HmacSHA512&quot;, BLONG, &quot;fb:cf:4b:c6:d5:49:5a:5b:0b:d9:2a:32:f5:fa:68:d2:68:a4:0f:ae:53:fc:49:12:e6:1d:53:cf:b2:cb:c5:c5:f2:2d:86:bd:14:61:30:c3:a6:6f:44:1f:77:9b:aa:a1:22:48:a9:dd:d0:45:86:d1:a1:82:53:13:c4:03:06:a3&quot;,
217                 BKEY),
218         // Test vectors From RFC4231
<a name="14" id="anc14"></a><span class="line-modified">219         t(&quot;HmacSHA224&quot;, s(&quot;Hi There&quot;), &quot;89:6f:b1:12:8a:bb:df:19:68:32:10:7c:d4:9d:f3:3f:47:b4:b1:16:99:12:ba:4f:53:68:4b:22&quot;, BKEY_20),</span>
<span class="line-modified">220         t(&quot;HmacSHA224&quot;, s(&quot;what do ya want for nothing?&quot;), &quot;a3:0e:01:09:8b:c6:db:bf:45:69:0f:3a:7e:9e:6d:0f:8b:be:a2:a3:9e:61:48:00:8f:d0:5e:44&quot;, s(&quot;Jefe&quot;)),</span>
<span class="line-modified">221         t(&quot;HmacSHA224&quot;, DDDATA_50, &quot;7f:b3:cb:35:88:c6:c1:f6:ff:a9:69:4d:7d:6a:d2:64:93:65:b0:c1:f6:5d:69:d1:ec:83:33:ea&quot;, AAKEY_20),</span>
<span class="line-modified">222         t(&quot;HmacSHA224&quot;, CDDATA_50, &quot;6c:11:50:68:74:01:3c:ac:6a:2a:bc:1b:b3:82:62:7c:ec:6a:90:d8:6e:fc:01:2d:e7:af:ec:5a&quot;, &quot;01:02:03:04:05:06:07:08:09:0a:0b:0c:0d:0e:0f:10:11:12:13:14:15:16:17:18:19&quot;),</span>
<span class="line-modified">223         t(&quot;HmacSHA224&quot;, s(&quot;Test Using Larger Than Block-Size Key - Hash Key First&quot;), &quot;95:e9:a0:db:96:20:95:ad:ae:be:9b:2d:6f:0d:bc:e2:d4:99:f1:12:f2:d2:b7:27:3f:a6:87:0e&quot;, AAKEY_131),</span>
<span class="line-modified">224         t(&quot;HmacSHA224&quot;, s(&quot;This is a test using a larger than block-size key and a larger than block-size data. The key needs to be hashed before being used by the HMAC algorithm.&quot;), &quot;3a:85:41:66:ac:5d:9f:02:3f:54:d5:17:d0:b3:9d:bd:94:67:70:db:9c:2b:95:c9:f6:f5:65:d1&quot;, AAKEY_131),</span>










































225     };
226 
227     static void runTests(Test[] tests) throws Exception {
228         long start = System.currentTimeMillis();
229         Provider p = Security.getProvider(&quot;SunJCE&quot;);
230         System.out.println(&quot;Testing provider &quot; + p.getName() + &quot;...&quot;);
<a name="15" id="anc15"></a><span class="line-removed">231         Mac.getInstance(&quot;HmacSHA224&quot;, p);</span>
<span class="line-removed">232         Mac.getInstance(&quot;HmacSHA256&quot;, p);</span>
<span class="line-removed">233         Mac.getInstance(&quot;HmacSHA384&quot;, p);</span>
<span class="line-removed">234         Mac.getInstance(&quot;HmacSHA512&quot;, p);</span>
<span class="line-removed">235         KeyGenerator.getInstance(&quot;HmacSHA224&quot;, p);</span>
<span class="line-removed">236         KeyGenerator.getInstance(&quot;HmacSHA256&quot;, p);</span>
<span class="line-removed">237         KeyGenerator.getInstance(&quot;HmacSHA384&quot;, p);</span>
<span class="line-removed">238         KeyGenerator.getInstance(&quot;HmacSHA512&quot;, p);</span>
239         for (int i = 0; i &lt; tests.length; i++) {
240             Test test = tests[i];
241             test.run(p);
242         }
<a name="16" id="anc16"></a><span class="line-removed">243         System.out.println(&quot;All tests passed&quot;);</span>
244         long stop = System.currentTimeMillis();
245         System.out.println(&quot;Done (&quot; + (stop - start) + &quot; ms).&quot;);
<a name="17" id="anc17"></a>





246     }
247 
248     public static void main(String[] args) throws Exception {
249         runTests(tests);
250     }
<a name="18" id="anc18"></a><span class="line-removed">251 </span>
252 }
<a name="19" id="anc19"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="19" type="hidden" />
</body>
</html>