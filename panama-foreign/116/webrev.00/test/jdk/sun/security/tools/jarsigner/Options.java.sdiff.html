<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff test/jdk/sun/security/tools/jarsigner/Options.java</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
  </head>
<body>
<center><a href="../../ssl/SSLEngineImpl/EngineEnforceUseClientMode.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="../../../tools/jps/LingeredAppForJps.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>test/jdk/sun/security/tools/jarsigner/Options.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2015, 2017, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 /**
 25  * @test
<span class="line-modified"> 26  * @bug 8056174</span>
 27  * @summary Make sure the jarsigner tool still works after it&#39;s modified to
 28  *          be based on JarSigner API
 29  * @library /test/lib
<span class="line-modified"> 30  * @modules java.base/sun.security.tools.keytool</span>
<span class="line-removed"> 31  *          jdk.jartool/sun.security.tools.jarsigner</span>
<span class="line-removed"> 32  *          java.base/sun.security.pkcs</span>
 33  *          java.base/sun.security.x509
<span class="line-removed"> 34  * @build jdk.test.lib.util.JarUtils</span>
<span class="line-removed"> 35  * @run main Options</span>
 36  */
 37 
 38 import com.sun.jarsigner.ContentSigner;
 39 import com.sun.jarsigner.ContentSignerParameters;


 40 import jdk.test.lib.util.JarUtils;
 41 import sun.security.pkcs.PKCS7;
 42 
 43 import java.io.ByteArrayInputStream;
<span class="line-removed"> 44 import java.io.IOException;</span>
 45 import java.io.InputStream;
 46 import java.nio.file.Files;
<span class="line-modified"> 47 import java.nio.file.Paths;</span>
<span class="line-removed"> 48 import java.security.NoSuchAlgorithmException;</span>
<span class="line-removed"> 49 import java.security.cert.CertificateException;</span>
 50 import java.util.*;
 51 import java.util.jar.Attributes;
 52 import java.util.jar.JarEntry;
 53 import java.util.jar.JarFile;
 54 import java.util.jar.Manifest;
 55 
 56 public class Options {
 57 
 58     public static void main(String[] args) throws Exception {
 59 













 60         // Prepares raw file
<span class="line-modified"> 61         Files.write(Paths.get(&quot;a&quot;), List.of(&quot;a&quot;));</span>
 62 
 63         // Pack
<span class="line-modified"> 64         JarUtils.createJar(&quot;a.jar&quot;, &quot;a&quot;);</span>
 65 
 66         // Prepare a keystore
<span class="line-modified"> 67         sun.security.tools.keytool.Main.main(</span>
<span class="line-modified"> 68                 (&quot;-keystore jks -storepass changeit -keypass changeit -dname&quot; +</span>
<span class="line-modified"> 69                         &quot; CN=A -alias a -genkeypair -keyalg rsa&quot;).split(&quot; &quot;));</span>

 70 
 71         // -altsign
<span class="line-modified"> 72         sun.security.tools.jarsigner.Main.main(</span>
<span class="line-modified"> 73                 (&quot;-debug -signedjar altsign.jar -keystore jks -storepass changeit&quot; +</span>
<span class="line-modified"> 74                         &quot; -altsigner Options$X a.jar a&quot;).split(&quot; &quot;));</span>






 75 
 76         try (JarFile jf = new JarFile(&quot;altsign.jar&quot;)) {
 77             JarEntry je = jf.getJarEntry(&quot;META-INF/A.RSA&quot;);
 78             try (InputStream is = jf.getInputStream(je)) {
 79                 if (!Arrays.equals(is.readAllBytes(), &quot;1234&quot;.getBytes())) {
 80                     throw new Exception(&quot;altsign go wrong&quot;);
 81                 }
 82             }
 83         }
 84 












 85         // -sigfile, -digestalg, -sigalg, -internalsf, -sectionsonly
<span class="line-modified"> 86         sun.security.tools.jarsigner.Main.main(</span>
<span class="line-modified"> 87                 (&quot;-debug -signedjar new.jar -keystore jks -storepass changeit&quot; +</span>
 88                 &quot; -sigfile olala -digestalg SHA1 -sigalg SHA224withRSA&quot; +
<span class="line-modified"> 89                 &quot; -internalsf -sectionsonly a.jar a&quot;).split(&quot; &quot;));</span>


 90 
 91         try (JarFile jf = new JarFile(&quot;new.jar&quot;)) {
 92             JarEntry je = jf.getJarEntry(&quot;META-INF/OLALA.SF&quot;);
 93             Objects.requireNonNull(je);     // check -sigfile
 94             byte[] sf = null;               // content of .SF
 95             try (InputStream is = jf.getInputStream(je)) {
 96                 sf = is.readAllBytes();     // save for later comparison
 97                 Attributes attrs = new Manifest(new ByteArrayInputStream(sf))
 98                         .getMainAttributes();
 99                 // check -digestalg
100                 if (!attrs.containsKey(new Attributes.Name(
101                         &quot;SHA1-Digest-Manifest-Main-Attributes&quot;))) {
102                     throw new Exception(&quot;digestalg incorrect&quot;);
103                 }
104                 // check -sectionsonly
105                 if (attrs.containsKey(new Attributes.Name(
106                         &quot;SHA1-Digest-Manifest&quot;))) {
107                     throw new Exception(&quot;SF should not have file digest&quot;);
108                 }
109             }
</pre>
<hr />
<pre>
113                 PKCS7 p7 = new PKCS7(is.readAllBytes());
114                 String alg = p7.getSignerInfos()[0]
115                         .getDigestAlgorithmId().getName();
116                 if (!alg.equals(&quot;SHA-224&quot;)) {   // check -sigalg
117                     throw new Exception(&quot;PKCS7 signing is using &quot; + alg);
118                 }
119                 // check -internalsf
120                 if (!Arrays.equals(sf, p7.getContentInfo().getData())) {
121                     throw new Exception(&quot;SF not in RSA&quot;);
122                 }
123             }
124 
125         }
126 
127         // TSA-related ones are checked in ts.sh
128     }
129 
130     public static class X extends ContentSigner {
131         @Override
132         public byte[] generateSignedData(ContentSignerParameters parameters,
<span class="line-modified">133                 boolean omitContent, boolean applyTimestamp)</span>
<span class="line-removed">134                 throws NoSuchAlgorithmException, CertificateException,</span>
<span class="line-removed">135                         IOException {</span>
136             return &quot;1234&quot;.getBytes();
137         }
138     }
139 }
</pre>
</td>
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2015, 2020, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 /**
 25  * @test
<span class="line-modified"> 26  * @bug 8056174 8242260</span>
 27  * @summary Make sure the jarsigner tool still works after it&#39;s modified to
 28  *          be based on JarSigner API
 29  * @library /test/lib
<span class="line-modified"> 30  * @modules java.base/sun.security.pkcs</span>


 31  *          java.base/sun.security.x509


 32  */
 33 
 34 import com.sun.jarsigner.ContentSigner;
 35 import com.sun.jarsigner.ContentSignerParameters;
<span class="line-added"> 36 import jdk.test.lib.Asserts;</span>
<span class="line-added"> 37 import jdk.test.lib.SecurityTools;</span>
 38 import jdk.test.lib.util.JarUtils;
 39 import sun.security.pkcs.PKCS7;
 40 
 41 import java.io.ByteArrayInputStream;

 42 import java.io.InputStream;
 43 import java.nio.file.Files;
<span class="line-modified"> 44 import java.nio.file.Path;</span>


 45 import java.util.*;
 46 import java.util.jar.Attributes;
 47 import java.util.jar.JarEntry;
 48 import java.util.jar.JarFile;
 49 import java.util.jar.Manifest;
 50 
 51 public class Options {
 52 
 53     public static void main(String[] args) throws Exception {
 54 
<span class="line-added"> 55         // Help</span>
<span class="line-added"> 56         boolean lastLineHasAltSigner = false;</span>
<span class="line-added"> 57         for (String line : SecurityTools.jarsigner(&quot;--help&quot;).asLines()) {</span>
<span class="line-added"> 58             if (line.contains(&quot;-altsigner&quot;)) {</span>
<span class="line-added"> 59                 lastLineHasAltSigner = true;</span>
<span class="line-added"> 60             } else {</span>
<span class="line-added"> 61                 if (lastLineHasAltSigner) {</span>
<span class="line-added"> 62                     Asserts.assertTrue(line.contains(&quot;deprecated and will be removed&quot;));</span>
<span class="line-added"> 63                 }</span>
<span class="line-added"> 64                 lastLineHasAltSigner = false;</span>
<span class="line-added"> 65             }</span>
<span class="line-added"> 66         }</span>
<span class="line-added"> 67 </span>
 68         // Prepares raw file
<span class="line-modified"> 69         Files.write(Path.of(&quot;a&quot;), List.of(&quot;a&quot;));</span>
 70 
 71         // Pack
<span class="line-modified"> 72         JarUtils.createJarFile(Path.of(&quot;a.jar&quot;), Path.of(&quot;.&quot;), Path.of(&quot;a&quot;));</span>
 73 
 74         // Prepare a keystore
<span class="line-modified"> 75         SecurityTools.keytool(</span>
<span class="line-modified"> 76                 &quot;-keystore jks -storepass changeit -keypass changeit -dname&quot; +</span>
<span class="line-modified"> 77                         &quot; CN=A -alias a -genkeypair -keyalg rsa&quot;)</span>
<span class="line-added"> 78                 .shouldHaveExitValue(0);</span>
 79 
 80         // -altsign
<span class="line-modified"> 81         SecurityTools.jarsigner(</span>
<span class="line-modified"> 82                 &quot;-debug -signedjar altsign.jar -keystore jks -storepass changeit&quot; +</span>
<span class="line-modified"> 83                         &quot; -altsigner Options$X&quot; +</span>
<span class="line-added"> 84                         &quot; -altsignerpath &quot; + System.getProperty(&quot;test.classes&quot;) +</span>
<span class="line-added"> 85                         &quot; a.jar a&quot;)</span>
<span class="line-added"> 86                 .shouldContain(&quot;removed in a future release: -altsigner&quot;)</span>
<span class="line-added"> 87                 .shouldContain(&quot;removed in a future release: -altsignerpath&quot;)</span>
<span class="line-added"> 88                 .shouldContain(&quot;PKCS7.parse&quot;);  // signature not parseable</span>
<span class="line-added"> 89                                                 // but signing succeeds</span>
 90 
 91         try (JarFile jf = new JarFile(&quot;altsign.jar&quot;)) {
 92             JarEntry je = jf.getJarEntry(&quot;META-INF/A.RSA&quot;);
 93             try (InputStream is = jf.getInputStream(je)) {
 94                 if (!Arrays.equals(is.readAllBytes(), &quot;1234&quot;.getBytes())) {
 95                     throw new Exception(&quot;altsign go wrong&quot;);
 96                 }
 97             }
 98         }
 99 
<span class="line-added">100         // -altsign with no -altsignerpath</span>
<span class="line-added">101         Files.copy(Path.of(System.getProperty(&quot;test.classes&quot;), &quot;Options$X.class&quot;),</span>
<span class="line-added">102                 Path.of(&quot;Options$X.class&quot;));</span>
<span class="line-added">103         SecurityTools.jarsigner(</span>
<span class="line-added">104                 &quot;-debug -signedjar altsign.jar -keystore jks -storepass changeit&quot; +</span>
<span class="line-added">105                         &quot; -altsigner Options$X&quot; +</span>
<span class="line-added">106                         &quot; a.jar a&quot;)</span>
<span class="line-added">107                 .shouldContain(&quot;removed in a future release: -altsigner&quot;)</span>
<span class="line-added">108                 .shouldNotContain(&quot;removed in a future release: -altsignerpath&quot;)</span>
<span class="line-added">109                 .shouldContain(&quot;PKCS7.parse&quot;);  // signature not parseable</span>
<span class="line-added">110                                                 // but signing succeeds</span>
<span class="line-added">111 </span>
112         // -sigfile, -digestalg, -sigalg, -internalsf, -sectionsonly
<span class="line-modified">113         SecurityTools.jarsigner(</span>
<span class="line-modified">114                 &quot;-debug -signedjar new.jar -keystore jks -storepass changeit&quot; +</span>
115                 &quot; -sigfile olala -digestalg SHA1 -sigalg SHA224withRSA&quot; +
<span class="line-modified">116                 &quot; -internalsf -sectionsonly a.jar a&quot;)</span>
<span class="line-added">117                 .shouldHaveExitValue(0)</span>
<span class="line-added">118                 .shouldNotContain(&quot;Exception&quot;);     // a real success</span>
119 
120         try (JarFile jf = new JarFile(&quot;new.jar&quot;)) {
121             JarEntry je = jf.getJarEntry(&quot;META-INF/OLALA.SF&quot;);
122             Objects.requireNonNull(je);     // check -sigfile
123             byte[] sf = null;               // content of .SF
124             try (InputStream is = jf.getInputStream(je)) {
125                 sf = is.readAllBytes();     // save for later comparison
126                 Attributes attrs = new Manifest(new ByteArrayInputStream(sf))
127                         .getMainAttributes();
128                 // check -digestalg
129                 if (!attrs.containsKey(new Attributes.Name(
130                         &quot;SHA1-Digest-Manifest-Main-Attributes&quot;))) {
131                     throw new Exception(&quot;digestalg incorrect&quot;);
132                 }
133                 // check -sectionsonly
134                 if (attrs.containsKey(new Attributes.Name(
135                         &quot;SHA1-Digest-Manifest&quot;))) {
136                     throw new Exception(&quot;SF should not have file digest&quot;);
137                 }
138             }
</pre>
<hr />
<pre>
142                 PKCS7 p7 = new PKCS7(is.readAllBytes());
143                 String alg = p7.getSignerInfos()[0]
144                         .getDigestAlgorithmId().getName();
145                 if (!alg.equals(&quot;SHA-224&quot;)) {   // check -sigalg
146                     throw new Exception(&quot;PKCS7 signing is using &quot; + alg);
147                 }
148                 // check -internalsf
149                 if (!Arrays.equals(sf, p7.getContentInfo().getData())) {
150                     throw new Exception(&quot;SF not in RSA&quot;);
151                 }
152             }
153 
154         }
155 
156         // TSA-related ones are checked in ts.sh
157     }
158 
159     public static class X extends ContentSigner {
160         @Override
161         public byte[] generateSignedData(ContentSignerParameters parameters,
<span class="line-modified">162                 boolean omitContent, boolean applyTimestamp) {</span>


163             return &quot;1234&quot;.getBytes();
164         }
165     }
166 }
</pre>
</td>
</tr>
</table>
<center><a href="../../ssl/SSLEngineImpl/EngineEnforceUseClientMode.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="../../../tools/jps/LingeredAppForJps.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>