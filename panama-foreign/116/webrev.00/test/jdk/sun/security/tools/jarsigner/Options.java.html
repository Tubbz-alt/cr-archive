<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>New test/jdk/sun/security/tools/jarsigner/Options.java</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
  </head>
  <body>
    <pre>
  1 /*
  2  * Copyright (c) 2015, 2020, Oracle and/or its affiliates. All rights reserved.
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 /**
 25  * @test
 26  * @bug 8056174 8242260
 27  * @summary Make sure the jarsigner tool still works after it&#39;s modified to
 28  *          be based on JarSigner API
 29  * @library /test/lib
 30  * @modules java.base/sun.security.pkcs
 31  *          java.base/sun.security.x509
 32  */
 33 
 34 import com.sun.jarsigner.ContentSigner;
 35 import com.sun.jarsigner.ContentSignerParameters;
 36 import jdk.test.lib.Asserts;
 37 import jdk.test.lib.SecurityTools;
 38 import jdk.test.lib.util.JarUtils;
 39 import sun.security.pkcs.PKCS7;
 40 
 41 import java.io.ByteArrayInputStream;
 42 import java.io.InputStream;
 43 import java.nio.file.Files;
 44 import java.nio.file.Path;
 45 import java.util.*;
 46 import java.util.jar.Attributes;
 47 import java.util.jar.JarEntry;
 48 import java.util.jar.JarFile;
 49 import java.util.jar.Manifest;
 50 
 51 public class Options {
 52 
 53     public static void main(String[] args) throws Exception {
 54 
 55         // Help
 56         boolean lastLineHasAltSigner = false;
 57         for (String line : SecurityTools.jarsigner(&quot;--help&quot;).asLines()) {
 58             if (line.contains(&quot;-altsigner&quot;)) {
 59                 lastLineHasAltSigner = true;
 60             } else {
 61                 if (lastLineHasAltSigner) {
 62                     Asserts.assertTrue(line.contains(&quot;deprecated and will be removed&quot;));
 63                 }
 64                 lastLineHasAltSigner = false;
 65             }
 66         }
 67 
 68         // Prepares raw file
 69         Files.write(Path.of(&quot;a&quot;), List.of(&quot;a&quot;));
 70 
 71         // Pack
 72         JarUtils.createJarFile(Path.of(&quot;a.jar&quot;), Path.of(&quot;.&quot;), Path.of(&quot;a&quot;));
 73 
 74         // Prepare a keystore
 75         SecurityTools.keytool(
 76                 &quot;-keystore jks -storepass changeit -keypass changeit -dname&quot; +
 77                         &quot; CN=A -alias a -genkeypair -keyalg rsa&quot;)
 78                 .shouldHaveExitValue(0);
 79 
 80         // -altsign
 81         SecurityTools.jarsigner(
 82                 &quot;-debug -signedjar altsign.jar -keystore jks -storepass changeit&quot; +
 83                         &quot; -altsigner Options$X&quot; +
 84                         &quot; -altsignerpath &quot; + System.getProperty(&quot;test.classes&quot;) +
 85                         &quot; a.jar a&quot;)
 86                 .shouldContain(&quot;removed in a future release: -altsigner&quot;)
 87                 .shouldContain(&quot;removed in a future release: -altsignerpath&quot;)
 88                 .shouldContain(&quot;PKCS7.parse&quot;);  // signature not parseable
 89                                                 // but signing succeeds
 90 
 91         try (JarFile jf = new JarFile(&quot;altsign.jar&quot;)) {
 92             JarEntry je = jf.getJarEntry(&quot;META-INF/A.RSA&quot;);
 93             try (InputStream is = jf.getInputStream(je)) {
 94                 if (!Arrays.equals(is.readAllBytes(), &quot;1234&quot;.getBytes())) {
 95                     throw new Exception(&quot;altsign go wrong&quot;);
 96                 }
 97             }
 98         }
 99 
100         // -altsign with no -altsignerpath
101         Files.copy(Path.of(System.getProperty(&quot;test.classes&quot;), &quot;Options$X.class&quot;),
102                 Path.of(&quot;Options$X.class&quot;));
103         SecurityTools.jarsigner(
104                 &quot;-debug -signedjar altsign.jar -keystore jks -storepass changeit&quot; +
105                         &quot; -altsigner Options$X&quot; +
106                         &quot; a.jar a&quot;)
107                 .shouldContain(&quot;removed in a future release: -altsigner&quot;)
108                 .shouldNotContain(&quot;removed in a future release: -altsignerpath&quot;)
109                 .shouldContain(&quot;PKCS7.parse&quot;);  // signature not parseable
110                                                 // but signing succeeds
111 
112         // -sigfile, -digestalg, -sigalg, -internalsf, -sectionsonly
113         SecurityTools.jarsigner(
114                 &quot;-debug -signedjar new.jar -keystore jks -storepass changeit&quot; +
115                 &quot; -sigfile olala -digestalg SHA1 -sigalg SHA224withRSA&quot; +
116                 &quot; -internalsf -sectionsonly a.jar a&quot;)
117                 .shouldHaveExitValue(0)
118                 .shouldNotContain(&quot;Exception&quot;);     // a real success
119 
120         try (JarFile jf = new JarFile(&quot;new.jar&quot;)) {
121             JarEntry je = jf.getJarEntry(&quot;META-INF/OLALA.SF&quot;);
122             Objects.requireNonNull(je);     // check -sigfile
123             byte[] sf = null;               // content of .SF
124             try (InputStream is = jf.getInputStream(je)) {
125                 sf = is.readAllBytes();     // save for later comparison
126                 Attributes attrs = new Manifest(new ByteArrayInputStream(sf))
127                         .getMainAttributes();
128                 // check -digestalg
129                 if (!attrs.containsKey(new Attributes.Name(
130                         &quot;SHA1-Digest-Manifest-Main-Attributes&quot;))) {
131                     throw new Exception(&quot;digestalg incorrect&quot;);
132                 }
133                 // check -sectionsonly
134                 if (attrs.containsKey(new Attributes.Name(
135                         &quot;SHA1-Digest-Manifest&quot;))) {
136                     throw new Exception(&quot;SF should not have file digest&quot;);
137                 }
138             }
139 
140             je = jf.getJarEntry(&quot;META-INF/OLALA.RSA&quot;);
141             try (InputStream is = jf.getInputStream(je)) {
142                 PKCS7 p7 = new PKCS7(is.readAllBytes());
143                 String alg = p7.getSignerInfos()[0]
144                         .getDigestAlgorithmId().getName();
145                 if (!alg.equals(&quot;SHA-224&quot;)) {   // check -sigalg
146                     throw new Exception(&quot;PKCS7 signing is using &quot; + alg);
147                 }
148                 // check -internalsf
149                 if (!Arrays.equals(sf, p7.getContentInfo().getData())) {
150                     throw new Exception(&quot;SF not in RSA&quot;);
151                 }
152             }
153 
154         }
155 
156         // TSA-related ones are checked in ts.sh
157     }
158 
159     public static class X extends ContentSigner {
160         @Override
161         public byte[] generateSignedData(ContentSignerParameters parameters,
162                 boolean omitContent, boolean applyTimestamp) {
163             return &quot;1234&quot;.getBytes();
164         }
165     }
166 }
    </pre>
  </body>
</html>