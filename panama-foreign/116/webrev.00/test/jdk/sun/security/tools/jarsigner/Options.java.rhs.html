<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames test/jdk/sun/security/tools/jarsigner/Options.java</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
<a name="1" id="anc1"></a><span class="line-modified">  2  * Copyright (c) 2015, 2020, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 /**
 25  * @test
<a name="2" id="anc2"></a><span class="line-modified"> 26  * @bug 8056174 8242260</span>
 27  * @summary Make sure the jarsigner tool still works after it&#39;s modified to
 28  *          be based on JarSigner API
 29  * @library /test/lib
<a name="3" id="anc3"></a><span class="line-modified"> 30  * @modules java.base/sun.security.pkcs</span>


 31  *          java.base/sun.security.x509
<a name="4" id="anc4"></a>

 32  */
 33 
 34 import com.sun.jarsigner.ContentSigner;
 35 import com.sun.jarsigner.ContentSignerParameters;
<a name="5" id="anc5"></a><span class="line-added"> 36 import jdk.test.lib.Asserts;</span>
<span class="line-added"> 37 import jdk.test.lib.SecurityTools;</span>
 38 import jdk.test.lib.util.JarUtils;
 39 import sun.security.pkcs.PKCS7;
 40 
 41 import java.io.ByteArrayInputStream;
<a name="6" id="anc6"></a>
 42 import java.io.InputStream;
 43 import java.nio.file.Files;
<a name="7" id="anc7"></a><span class="line-modified"> 44 import java.nio.file.Path;</span>


 45 import java.util.*;
 46 import java.util.jar.Attributes;
 47 import java.util.jar.JarEntry;
 48 import java.util.jar.JarFile;
 49 import java.util.jar.Manifest;
 50 
 51 public class Options {
 52 
 53     public static void main(String[] args) throws Exception {
 54 
<a name="8" id="anc8"></a><span class="line-added"> 55         // Help</span>
<span class="line-added"> 56         boolean lastLineHasAltSigner = false;</span>
<span class="line-added"> 57         for (String line : SecurityTools.jarsigner(&quot;--help&quot;).asLines()) {</span>
<span class="line-added"> 58             if (line.contains(&quot;-altsigner&quot;)) {</span>
<span class="line-added"> 59                 lastLineHasAltSigner = true;</span>
<span class="line-added"> 60             } else {</span>
<span class="line-added"> 61                 if (lastLineHasAltSigner) {</span>
<span class="line-added"> 62                     Asserts.assertTrue(line.contains(&quot;deprecated and will be removed&quot;));</span>
<span class="line-added"> 63                 }</span>
<span class="line-added"> 64                 lastLineHasAltSigner = false;</span>
<span class="line-added"> 65             }</span>
<span class="line-added"> 66         }</span>
<span class="line-added"> 67 </span>
 68         // Prepares raw file
<a name="9" id="anc9"></a><span class="line-modified"> 69         Files.write(Path.of(&quot;a&quot;), List.of(&quot;a&quot;));</span>
 70 
 71         // Pack
<a name="10" id="anc10"></a><span class="line-modified"> 72         JarUtils.createJarFile(Path.of(&quot;a.jar&quot;), Path.of(&quot;.&quot;), Path.of(&quot;a&quot;));</span>
 73 
 74         // Prepare a keystore
<a name="11" id="anc11"></a><span class="line-modified"> 75         SecurityTools.keytool(</span>
<span class="line-modified"> 76                 &quot;-keystore jks -storepass changeit -keypass changeit -dname&quot; +</span>
<span class="line-modified"> 77                         &quot; CN=A -alias a -genkeypair -keyalg rsa&quot;)</span>
<span class="line-added"> 78                 .shouldHaveExitValue(0);</span>
 79 
 80         // -altsign
<a name="12" id="anc12"></a><span class="line-modified"> 81         SecurityTools.jarsigner(</span>
<span class="line-modified"> 82                 &quot;-debug -signedjar altsign.jar -keystore jks -storepass changeit&quot; +</span>
<span class="line-modified"> 83                         &quot; -altsigner Options$X&quot; +</span>
<span class="line-added"> 84                         &quot; -altsignerpath &quot; + System.getProperty(&quot;test.classes&quot;) +</span>
<span class="line-added"> 85                         &quot; a.jar a&quot;)</span>
<span class="line-added"> 86                 .shouldContain(&quot;removed in a future release: -altsigner&quot;)</span>
<span class="line-added"> 87                 .shouldContain(&quot;removed in a future release: -altsignerpath&quot;)</span>
<span class="line-added"> 88                 .shouldContain(&quot;PKCS7.parse&quot;);  // signature not parseable</span>
<span class="line-added"> 89                                                 // but signing succeeds</span>
 90 
 91         try (JarFile jf = new JarFile(&quot;altsign.jar&quot;)) {
 92             JarEntry je = jf.getJarEntry(&quot;META-INF/A.RSA&quot;);
 93             try (InputStream is = jf.getInputStream(je)) {
 94                 if (!Arrays.equals(is.readAllBytes(), &quot;1234&quot;.getBytes())) {
 95                     throw new Exception(&quot;altsign go wrong&quot;);
 96                 }
 97             }
 98         }
 99 
<a name="13" id="anc13"></a><span class="line-added">100         // -altsign with no -altsignerpath</span>
<span class="line-added">101         Files.copy(Path.of(System.getProperty(&quot;test.classes&quot;), &quot;Options$X.class&quot;),</span>
<span class="line-added">102                 Path.of(&quot;Options$X.class&quot;));</span>
<span class="line-added">103         SecurityTools.jarsigner(</span>
<span class="line-added">104                 &quot;-debug -signedjar altsign.jar -keystore jks -storepass changeit&quot; +</span>
<span class="line-added">105                         &quot; -altsigner Options$X&quot; +</span>
<span class="line-added">106                         &quot; a.jar a&quot;)</span>
<span class="line-added">107                 .shouldContain(&quot;removed in a future release: -altsigner&quot;)</span>
<span class="line-added">108                 .shouldNotContain(&quot;removed in a future release: -altsignerpath&quot;)</span>
<span class="line-added">109                 .shouldContain(&quot;PKCS7.parse&quot;);  // signature not parseable</span>
<span class="line-added">110                                                 // but signing succeeds</span>
<span class="line-added">111 </span>
112         // -sigfile, -digestalg, -sigalg, -internalsf, -sectionsonly
<a name="14" id="anc14"></a><span class="line-modified">113         SecurityTools.jarsigner(</span>
<span class="line-modified">114                 &quot;-debug -signedjar new.jar -keystore jks -storepass changeit&quot; +</span>
115                 &quot; -sigfile olala -digestalg SHA1 -sigalg SHA224withRSA&quot; +
<a name="15" id="anc15"></a><span class="line-modified">116                 &quot; -internalsf -sectionsonly a.jar a&quot;)</span>
<span class="line-added">117                 .shouldHaveExitValue(0)</span>
<span class="line-added">118                 .shouldNotContain(&quot;Exception&quot;);     // a real success</span>
119 
120         try (JarFile jf = new JarFile(&quot;new.jar&quot;)) {
121             JarEntry je = jf.getJarEntry(&quot;META-INF/OLALA.SF&quot;);
122             Objects.requireNonNull(je);     // check -sigfile
123             byte[] sf = null;               // content of .SF
124             try (InputStream is = jf.getInputStream(je)) {
125                 sf = is.readAllBytes();     // save for later comparison
126                 Attributes attrs = new Manifest(new ByteArrayInputStream(sf))
127                         .getMainAttributes();
128                 // check -digestalg
129                 if (!attrs.containsKey(new Attributes.Name(
130                         &quot;SHA1-Digest-Manifest-Main-Attributes&quot;))) {
131                     throw new Exception(&quot;digestalg incorrect&quot;);
132                 }
133                 // check -sectionsonly
134                 if (attrs.containsKey(new Attributes.Name(
135                         &quot;SHA1-Digest-Manifest&quot;))) {
136                     throw new Exception(&quot;SF should not have file digest&quot;);
137                 }
138             }
139 
140             je = jf.getJarEntry(&quot;META-INF/OLALA.RSA&quot;);
141             try (InputStream is = jf.getInputStream(je)) {
142                 PKCS7 p7 = new PKCS7(is.readAllBytes());
143                 String alg = p7.getSignerInfos()[0]
144                         .getDigestAlgorithmId().getName();
145                 if (!alg.equals(&quot;SHA-224&quot;)) {   // check -sigalg
146                     throw new Exception(&quot;PKCS7 signing is using &quot; + alg);
147                 }
148                 // check -internalsf
149                 if (!Arrays.equals(sf, p7.getContentInfo().getData())) {
150                     throw new Exception(&quot;SF not in RSA&quot;);
151                 }
152             }
153 
154         }
155 
156         // TSA-related ones are checked in ts.sh
157     }
158 
159     public static class X extends ContentSigner {
160         @Override
161         public byte[] generateSignedData(ContentSignerParameters parameters,
<a name="16" id="anc16"></a><span class="line-modified">162                 boolean omitContent, boolean applyTimestamp) {</span>


163             return &quot;1234&quot;.getBytes();
164         }
165     }
166 }
<a name="17" id="anc17"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="17" type="hidden" />
</body>
</html>