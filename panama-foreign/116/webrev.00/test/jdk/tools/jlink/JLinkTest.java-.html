<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Old test/jdk/tools/jlink/JLinkTest.java</title>
    <link rel="stylesheet" href="../../../../style.css" />
  </head>
  <body>
    <pre>
  1 /*
  2  * Copyright (c) 2015, 2018, Oracle and/or its affiliates. All rights reserved.
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 import java.io.IOException;
 25 import java.io.PrintWriter;
 26 import java.io.StringWriter;
 27 import java.lang.module.ModuleDescriptor;
 28 import java.nio.file.Files;
 29 import java.nio.file.Path;
 30 import java.nio.file.Paths;
 31 import java.util.ArrayList;
 32 import java.util.Collections;
 33 import java.util.List;
 34 import java.util.spi.ToolProvider;
 35 import java.util.stream.Stream;
 36 
 37 import jdk.tools.jlink.plugin.Plugin;
 38 import jdk.tools.jlink.internal.PluginRepository;
 39 import tests.Helper;
 40 import tests.JImageGenerator;
 41 
 42 /*
 43  * @test
 44  * @summary Test image creation
 45  * @bug 8189777
 46  * @bug 8194922
 47  * @bug 8206962
 48  * @author Jean-Francois Denise
 49  * @requires (vm.compMode != &quot;Xcomp&quot; &amp; os.maxMemory &gt;= 2g)
 50  * @library ../lib
 51  * @modules java.base/jdk.internal.jimage
 52  *          jdk.jdeps/com.sun.tools.classfile
 53  *          jdk.jlink/jdk.tools.jlink.internal
 54  *          jdk.jlink/jdk.tools.jlink.plugin
 55  *          jdk.jlink/jdk.tools.jimage
 56  *          jdk.compiler
 57  * @build tests.*
 58  * @run main/othervm -Xmx1g JLinkTest
 59  */
 60 public class JLinkTest {
 61     static final ToolProvider JLINK_TOOL = ToolProvider.findFirst(&quot;jlink&quot;)
 62         .orElseThrow(() -&gt;
 63             new RuntimeException(&quot;jlink tool not found&quot;)
 64         );
 65 
 66     // number of built-in plugins from jdk.jlink module
 67     private static int getNumJlinkPlugins() {
 68         ModuleDescriptor desc = Plugin.class.getModule().getDescriptor();
 69         return desc.provides().stream()
 70                 .filter(p -&gt; p.service().equals(Plugin.class.getName()))
 71                 .map(p -&gt; p.providers().size())
 72                 .findAny()
 73                 .orElse(0);
 74     }
 75 
 76     private static boolean isOfJLinkModule(Plugin p) {
 77         return p.getClass().getModule() == Plugin.class.getModule();
 78     }
 79 
 80     public static void main(String[] args) throws Exception {
 81 
 82         Helper helper = Helper.newHelper();
 83         if (helper == null) {
 84             System.err.println(&quot;Test not run&quot;);
 85             return;
 86         }
 87         helper.generateDefaultModules();
 88         // expected num. of plugins from jdk.jlink module
 89         int expectedJLinkPlugins = getNumJlinkPlugins();
 90         int totalPlugins = 0;
 91         {
 92             // number of built-in plugins
 93             List&lt;Plugin&gt; builtInPlugins = new ArrayList&lt;&gt;();
 94             builtInPlugins.addAll(PluginRepository.getPlugins(ModuleLayer.boot()));
 95             totalPlugins = builtInPlugins.size();
 96             // actual num. of plugins loaded from jdk.jlink module
 97             int actualJLinkPlugins = 0;
 98             for (Plugin p : builtInPlugins) {
 99                 p.getState();
100                 p.getType();
101                 if (isOfJLinkModule(p)) {
102                     actualJLinkPlugins++;
103                 }
104             }
105             if (expectedJLinkPlugins != actualJLinkPlugins) {
106                 throw new AssertionError(&quot;Actual plugins loaded from jdk.jlink: &quot; +
107                         actualJLinkPlugins + &quot; which doesn&#39;t match expected number : &quot; +
108                         expectedJLinkPlugins);
109             }
110         }
111 
112         {
113             // No --module-path specified. $JAVA_HOME/jmods should be assumed.
114             // The following should succeed as it uses only system modules.
115             String imageDir = &quot;bug818977-no-modulepath&quot;;
116             JImageGenerator.getJLinkTask()
117                     .output(helper.createNewImageDir(imageDir))
118                     .addMods(&quot;jdk.scripting.nashorn&quot;)
119                     .call().assertSuccess();
120         }
121 
122         {
123             // invalid --module-path specified. java.base not found it it.
124             // $JAVA_HOME/jmods should be added automatically.
125             // The following should succeed as it uses only system modules.
126             String imageDir = &quot;bug8189777-invalid-modulepath&quot;;
127             JImageGenerator.getJLinkTask()
128                     .modulePath(&quot;does_not_exist_path&quot;)
129                     .output(helper.createNewImageDir(imageDir))
130                     .addMods(&quot;jdk.scripting.nashorn&quot;)
131                     .call().assertSuccess();
132         }
133 
134         {
135             // No --module-path specified. --add-modules ALL-MODULE-PATH specified.
136             String imageDir = &quot;bug8189777-all-module-path&quot;;
137             JImageGenerator.getJLinkTask()
138                     .output(helper.createNewImageDir(imageDir))
139                     .addMods(&quot;ALL-MODULE-PATH&quot;)
140                     .call().assertSuccess();
141         }
142 
143         {
144             String moduleName = &quot;bug8134651&quot;;
145             JImageGenerator.getJLinkTask()
146                     .modulePath(helper.defaultModulePath())
147                     .output(helper.createNewImageDir(moduleName))
148                     .addMods(&quot;leaf1&quot;)
149                     .call().assertSuccess();
150             JImageGenerator.getJLinkTask()
151                     .modulePath(helper.defaultModulePath())
152                     .addMods(&quot;leaf1&quot;)
153                     .option(&quot;--output&quot;)
154                     .call().assertFailure(&quot;Error: no value given for --output&quot;);
155             JImageGenerator.getJLinkTask()
156                     .modulePath(&quot;&quot;)
157                     .output(helper.createNewImageDir(moduleName))
158                     .addMods(&quot;leaf1&quot;)
159                     .call().assertFailure(&quot;Error: no value given for --module-path&quot;);
160             // do not include standard module path - should be added automatically
161             JImageGenerator.getJLinkTask()
162                     .modulePath(helper.defaultModulePath(false))
163                     .output(helper.createNewImageDir(moduleName))
164                     .addMods(&quot;leaf1&quot;)
165                     .call().assertSuccess();
166             // no --module-path. default sys mod path is assumed - but that won&#39;t contain &#39;leaf1&#39; module
167             JImageGenerator.getJLinkTask()
168                     .output(helper.createNewImageDir(moduleName))
169                     .addMods(&quot;leaf1&quot;)
170                     .call().assertFailure(&quot;Error: Module leaf1 not found&quot;);
171         }
172 
173         {
174             String moduleName = &quot;m&quot;; // 8163382
175             Path jmod = helper.generateDefaultJModule(moduleName).assertSuccess();
176             JImageGenerator.getJLinkTask()
177                     .modulePath(helper.defaultModulePath())
178                     .output(helper.createNewImageDir(moduleName))
179                     .addMods(&quot;m&quot;)
180                     .call().assertSuccess();
181             moduleName = &quot;mod&quot;;
182             jmod = helper.generateDefaultJModule(moduleName).assertSuccess();
183             JImageGenerator.getJLinkTask()
184                     .modulePath(helper.defaultModulePath())
185                     .output(helper.createNewImageDir(moduleName))
186                     .addMods(&quot;m&quot;)
187                     .call().assertSuccess();
188         }
189 
190         {
191             String moduleName = &quot;m_8165735&quot;; // JDK-8165735
192             helper.generateDefaultJModule(moduleName+&quot;dependency&quot;).assertSuccess();
193             Path jmod = helper.generateDefaultJModule(moduleName, moduleName+&quot;dependency&quot;).assertSuccess();
194             JImageGenerator.getJLinkTask()
195                     .modulePath(helper.defaultModulePath())
196                     .repeatedModulePath(&quot;.&quot;) // second --module-path overrides the first one
197                     .output(helper.createNewImageDir(moduleName))
198                     .addMods(moduleName)
199                     // second --module-path does not have that module
200                     .call().assertFailure(&quot;Error: Module m_8165735 not found&quot;);
201 
202             JImageGenerator.getJLinkTask()
203                     .modulePath(&quot;.&quot;) // first --module-path overridden later
204                     .repeatedModulePath(helper.defaultModulePath())
205                     .output(helper.createNewImageDir(moduleName))
206                     .addMods(moduleName)
207                     // second --module-path has that module
208                     .call().assertSuccess();
209 
210             JImageGenerator.getJLinkTask()
211                     .modulePath(helper.defaultModulePath())
212                     .output(helper.createNewImageDir(moduleName))
213                     .limitMods(moduleName)
214                     .repeatedLimitMods(&quot;java.base&quot;) // second --limit-modules overrides first
215                     .addMods(moduleName)
216                     .call().assertFailure(&quot;Error: Module m_8165735dependency not found, required by m_8165735&quot;);
217 
218             JImageGenerator.getJLinkTask()
219                     .modulePath(helper.defaultModulePath())
220                     .output(helper.createNewImageDir(moduleName))
221                     .limitMods(&quot;java.base&quot;)
222                     .repeatedLimitMods(moduleName) // second --limit-modules overrides first
223                     .addMods(moduleName)
224                     .call().assertSuccess();
225         }
226 
227         {
228             // Help
229             StringWriter writer = new StringWriter();
230             PrintWriter pw = new PrintWriter(writer);
231             JLINK_TOOL.run(pw, pw, &quot;--help&quot;);
232             String output = writer.toString();
233             if (output.split(&quot;\n&quot;).length &lt; 10) {
234                 System.err.println(output);
235                 throw new AssertionError(&quot;Help&quot;);
236             }
237         }
238 
239         {
240             // List plugins
241             StringWriter writer = new StringWriter();
242             PrintWriter pw = new PrintWriter(writer);
243 
244             JLINK_TOOL.run(pw, pw, &quot;--list-plugins&quot;);
245             String output = writer.toString();
246             long number = Stream.of(output.split(&quot;\\R&quot;))
247                     .filter((s) -&gt; s.matches(&quot;Plugin Name:.*&quot;))
248                     .count();
249             if (number != totalPlugins) {
250                 System.err.println(output);
251                 throw new AssertionError(&quot;Found: &quot; + number + &quot; expected &quot; + totalPlugins);
252             }
253         }
254 
255         // filter out files and resources + Skip debug + compress
256         {
257             String[] userOptions = {&quot;--compress&quot;, &quot;2&quot;, &quot;--strip-debug&quot;,
258                 &quot;--exclude-resources&quot;, &quot;*.jcov, */META-INF/*&quot;, &quot;--exclude-files&quot;,
259                 &quot;*&quot; + Helper.getDebugSymbolsExtension()};
260             String moduleName = &quot;excludezipskipdebugcomposite2&quot;;
261             helper.generateDefaultJModule(moduleName, &quot;composite2&quot;);
262             String[] res = {&quot;.jcov&quot;, &quot;/META-INF/&quot;};
263             String[] files = {Helper.getDebugSymbolsExtension()};
264             Path imageDir = helper.generateDefaultImage(userOptions, moduleName).assertSuccess();
265             helper.checkImage(imageDir, moduleName, res, files);
266         }
267 
268         // filter out + Skip debug + compress with filter + sort resources
269         {
270             String[] userOptions2 = {&quot;--compress=2:compress-filter=^/java.base/*&quot;,
271                 &quot;--strip-debug&quot;, &quot;--exclude-resources&quot;,
272                 &quot;*.jcov, */META-INF/*&quot;, &quot;--order-resources&quot;,
273                 &quot;*/module-info.class,/sortcomposite2/*,*/javax/management/*&quot;};
274             String moduleName = &quot;excludezipfilterskipdebugcomposite2&quot;;
275             helper.generateDefaultJModule(moduleName, &quot;composite2&quot;);
276             String[] res = {&quot;.jcov&quot;, &quot;/META-INF/&quot;};
277             Path imageDir = helper.generateDefaultImage(userOptions2, moduleName).assertSuccess();
278             helper.checkImage(imageDir, moduleName, res, null);
279         }
280 
281         // module-info.class should not be excluded
282         {
283             String[] userOptions = { &quot;--exclude-resources&quot;, &quot;/jdk_8194922/module-info.class&quot; };
284             String moduleName = &quot;jdk_8194922&quot;;
285             helper.generateDefaultJModule(moduleName);
286             helper.generateDefaultImage(userOptions, moduleName).
287                 assertFailure(&quot;Cannot exclude /jdk_8194922/module-info.class&quot;);
288         }
289 
290         // default compress
291         {
292             testCompress(helper, &quot;compresscmdcomposite2&quot;, &quot;--compress&quot;, &quot;2&quot;);
293         }
294 
295         {
296             testCompress(helper, &quot;compressfiltercmdcomposite2&quot;,
297                     &quot;--compress=2:filter=^/java.base/java/lang/*&quot;);
298         }
299 
300         // compress 0
301         {
302             testCompress(helper, &quot;compress0filtercmdcomposite2&quot;,
303                     &quot;--compress=0:filter=^/java.base/java/lang/*&quot;);
304         }
305 
306         // compress 1
307         {
308             testCompress(helper, &quot;compress1filtercmdcomposite2&quot;,
309                     &quot;--compress=1:filter=^/java.base/java/lang/*&quot;);
310         }
311 
312         // compress 2
313         {
314             testCompress(helper, &quot;compress2filtercmdcomposite2&quot;,
315                     &quot;--compress=2:filter=^/java.base/java/lang/*&quot;);
316         }
317 
318         // invalid compress level
319         {
320             String[] userOptions = {&quot;--compress&quot;, &quot;invalid&quot;};
321             String moduleName = &quot;invalidCompressLevel&quot;;
322             helper.generateDefaultJModule(moduleName, &quot;composite2&quot;);
323             helper.generateDefaultImage(userOptions, moduleName).assertFailure(&quot;Error: Invalid compression level invalid&quot;);
324         }
325 
326         // orphan argument - JDK-8166810
327         {
328             String[] userOptions = {&quot;--compress&quot;, &quot;2&quot;, &quot;foo&quot; };
329             String moduleName = &quot;orphanarg1&quot;;
330             helper.generateDefaultJModule(moduleName, &quot;composite2&quot;);
331             helper.generateDefaultImage(userOptions, moduleName).assertFailure(&quot;Error: invalid argument: foo&quot;);
332         }
333 
334         // orphan argument - JDK-8166810
335         {
336             String[] userOptions = {&quot;--output&quot;, &quot;foo&quot;, &quot;bar&quot; };
337             String moduleName = &quot;orphanarg2&quot;;
338             helper.generateDefaultJModule(moduleName, &quot;composite2&quot;);
339             helper.generateDefaultImage(userOptions, moduleName).assertFailure(&quot;Error: invalid argument: bar&quot;);
340         }
341 
342         // basic check for --help - JDK-8173717
343         {
344             JImageGenerator.getJLinkTask()
345                     .option(&quot;--help&quot;)
346                     .call().assertSuccess();
347         }
348 
349         {
350             String imageDir = &quot;bug8206962&quot;;
351             JImageGenerator.getJLinkTask()
352                     .modulePath(helper.defaultModulePath())
353                     .output(helper.createNewImageDir(imageDir))
354                     .addMods(&quot;java.base&quot;)
355                     .option(&quot;--release-info=del&quot;)
356                     .call().assertFailure(&quot;Error: No key specified for delete&quot;);
357         }
358     }
359 
360     private static void testCompress(Helper helper, String moduleName, String... userOptions) throws IOException {
361         helper.generateDefaultJModule(moduleName, &quot;composite2&quot;);
362         Path imageDir = helper.generateDefaultImage(userOptions, moduleName).assertSuccess();
363         helper.checkImage(imageDir, moduleName, null, null);
364     }
365 }
    </pre>
  </body>
</html>