<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff test/jdk/tools/jpackage/macosx/base/SigningBase.java</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
  </head>
<body>
<center><a href="../../helpers/jdk/jpackage/test/Executor.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="../../share/FileAssociationsTest.java.udiff.html" target="_top">next &gt;</a></center>    <h2>test/jdk/tools/jpackage/macosx/base/SigningBase.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -24,10 +24,11 @@</span>
  import java.nio.file.Path;
  import java.util.List;
  
  import jdk.jpackage.test.TKit;
  import jdk.jpackage.test.Executor;
<span class="udiff-line-added">+ import jdk.jpackage.test.Executor.Result;</span>
  
  public class SigningBase {
  
      public static String DEV_NAME = &quot;jpackage.openjdk.java.net&quot;;
      public static String APP_CERT
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -66,41 +67,47 @@</span>
                      + &quot;: code object is not signed at all&quot;;
              checkString(result, lookupString);
          }
      }
  
<span class="udiff-line-modified-removed">-     private static List&lt;String&gt; spctlResult(Path target, String type) {</span>
<span class="udiff-line-modified-removed">-         List&lt;String&gt; result = new Executor()</span>
<span class="udiff-line-modified-added">+     private static Result spctlResult(Path target, String type) {</span>
<span class="udiff-line-modified-added">+         Result result = new Executor()</span>
                  .setExecutable(&quot;/usr/sbin/spctl&quot;)
                  .addArguments(&quot;-vvv&quot;, &quot;--assess&quot;, &quot;--type&quot;, type,
                          target.toString())
<span class="udiff-line-removed">-                 // on Catalina, the exit code can be 3, meaning not notarized</span>
                  .saveOutput()
<span class="udiff-line-modified-removed">-                 .executeWithoutExitCodeCheck()</span>
<span class="udiff-line-removed">-                 .getOutput();</span>
<span class="udiff-line-modified-added">+                 .executeWithoutExitCodeCheck();</span>
  
<span class="udiff-line-added">+         // allow exit code 3 for not being notarized</span>
<span class="udiff-line-added">+         if (result.getExitCode() != 3) {</span>
<span class="udiff-line-added">+             result.assertExitCodeIsZero();</span>
<span class="udiff-line-added">+         }</span>
          return result;
      }
  
<span class="udiff-line-modified-removed">-     private static void verifySpctlResult(List&lt;String&gt; result, Path target, String type) {</span>
<span class="udiff-line-modified-removed">-         result.stream().forEachOrdered(TKit::trace);</span>
<span class="udiff-line-modified-added">+     private static void verifySpctlResult(List&lt;String&gt; output, Path target,</span>
<span class="udiff-line-modified-added">+             String type, int exitCode) {</span>
<span class="udiff-line-added">+         output.stream().forEachOrdered(TKit::trace);</span>
          String lookupString;
<span class="udiff-line-modified-removed">- /* on Catalina, spctl may return 3 and say:</span>
<span class="udiff-line-modified-removed">-  *   target: rejected</span>
<span class="udiff-line-modified-removed">-  *   source=Unnotarized DEV_NAME</span>
<span class="udiff-line-modified-removed">-  * so we must skip these two checks</span>
<span class="udiff-line-modified-removed">-         lookupString = target.toString() + &quot;: accepted&quot;;</span>
<span class="udiff-line-modified-removed">-         checkString(result, lookupString);</span>
<span class="udiff-line-modified-removed">-         lookupString = &quot;source=&quot; + DEV_NAME;</span>
<span class="udiff-line-modified-removed">-         checkString(result, lookupString);</span>
<span class="udiff-line-modified-removed">-  */</span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-modified-added">+         if (exitCode == 0) {</span>
<span class="udiff-line-modified-added">+             lookupString = target.toString() + &quot;: accepted&quot;;</span>
<span class="udiff-line-modified-added">+             checkString(output, lookupString);</span>
<span class="udiff-line-modified-added">+             lookupString = &quot;source=&quot; + DEV_NAME;</span>
<span class="udiff-line-modified-added">+             checkString(output, lookupString);</span>
<span class="udiff-line-modified-added">+         } else if (exitCode == 3) {</span>
<span class="udiff-line-modified-added">+             // allow failure purely for not being notarized</span>
<span class="udiff-line-modified-added">+             lookupString = target.toString() + &quot;: rejected&quot;;</span>
<span class="udiff-line-added">+             checkString(output, lookupString);</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+ </span>
          if (type.equals(&quot;install&quot;)) {
              lookupString = &quot;origin=&quot; + INSTALLER_CERT;
          } else {
              lookupString = &quot;origin=&quot; + APP_CERT;
          }
<span class="udiff-line-modified-removed">-         checkString(result, lookupString);</span>
<span class="udiff-line-modified-added">+         checkString(output, lookupString);</span>
      }
  
      private static List&lt;String&gt; pkgutilResult(Path target) {
          List&lt;String&gt; result = new Executor()
                  .setExecutable(&quot;/usr/sbin/pkgutil&quot;)
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -123,12 +130,14 @@</span>
          List&lt;String&gt; result = codesignResult(target, signed);
          verifyCodesignResult(result, target, signed);
      }
  
      public static void verifySpctl(Path target, String type) {
<span class="udiff-line-modified-removed">-         List&lt;String&gt; result = spctlResult(target, type);</span>
<span class="udiff-line-modified-removed">-         verifySpctlResult(result, target, type);</span>
<span class="udiff-line-modified-added">+         Result result = spctlResult(target, type);</span>
<span class="udiff-line-modified-added">+         List&lt;String&gt; output = result.getOutput();</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         verifySpctlResult(output, target, type, result.getExitCode());</span>
      }
  
      public static void verifyPkgutil(Path target) {
          List&lt;String&gt; result = pkgutilResult(target);
          verifyPkgutilResult(result);
</pre>
<center><a href="../../helpers/jdk/jpackage/test/Executor.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="../../share/FileAssociationsTest.java.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>