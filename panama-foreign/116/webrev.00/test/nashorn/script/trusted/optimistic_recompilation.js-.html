<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Old test/nashorn/script/trusted/optimistic_recompilation.js</title>
    <link rel="stylesheet" href="../../../../style.css" />
  </head>
  <body>
    <pre>
 1 /*
 2  * Copyright (c) 2014, Oracle and/or its affiliates. All rights reserved.
 3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 4  *
 5  * This code is free software; you can redistribute it and/or modify it
 6  * under the terms of the GNU General Public License version 2 only, as
 7  * published by the Free Software Foundation.
 8  *
 9  * This code is distributed in the hope that it will be useful, but WITHOUT
10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
12  * version 2 for more details (a copy is included in the LICENSE file that
13  * accompanied this code).
14  *
15  * You should have received a copy of the GNU General Public License version
16  * 2 along with this work; if not, write to the Free Software Foundation,
17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
18  *
19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
20  * or visit www.oracle.com if you need additional information or have any
21  * questions.
22  */
23 
24 /**
25  * Ask Debug for an event log of favourable events instead of using --log flags printing to screen
26  * @test
27  * @bug 8037086,8038398
28  * @fork
29  * @option -Dnashorn.debug=true
30  * @option --log=recompile:quiet
31  * @option --optimistic-types=true
32  * @run
33  */
34 
35 var Reflector     = Java.type(&quot;jdk.nashorn.test.models.Reflector&quot;);
36 var forName       = java.lang.Class[&quot;forName(String)&quot;];
37 var RuntimeEvent  = forName(&quot;jdk.nashorn.internal.runtime.events.RuntimeEvent&quot;).static;
38 var getValue      = RuntimeEvent.class.getMethod(&quot;getValue&quot;);
39 var RewriteException = forName(&quot;jdk.nashorn.internal.runtime.RewriteException&quot;).static;
40 var getReturnType    = RewriteException.class.getMethod(&quot;getReturnType&quot;);
41 var RecompilationEvent = forName(&quot;jdk.nashorn.internal.runtime.events.RecompilationEvent&quot;).static;
42 var getReturnValue     = RecompilationEvent.class.getMethod(&quot;getReturnValue&quot;);
43 var setReturnTypeAndValue = [];
44 var expectedValues = [];
45 
46 function invoke(m, obj) {
47     return Reflector.invoke(m, obj);
48 }
49 
50 function checkExpectedRecompilation(f, expectedValues, testCase) {
51     Debug.clearRuntimeEvents();
52     print(f());
53     events = Debug.getRuntimeEvents();
54     //make sure we got runtime events
55     print(&quot;events = &quot; + (events.toString().indexOf(&quot;RuntimeEvent&quot;) != -1));
56     if (events.length ==  expectedValues.length) {
57         for (var i in events) {
58             var e = events[i];
59             var returnValue = invoke(getReturnValue, e);
60             if (typeof returnValue != &#39;undefined&#39;) {
61                 setReturnTypeAndValue[i] = [invoke(getReturnType, invoke(getValue, e)), returnValue];
62             } else {
63                 returnValue = &quot;undefined&quot;;
64                 setReturnTypeAndValue[i] = [invoke(getReturnType, invoke(getValue, e)), returnValue];
65             }
66             if (!setReturnTypeAndValue[i].toString().equals(expectedValues[i].toString())) {
67                 fail(&quot;The return values are not as expected. Expected value: &quot; + expectedValues[i] + &quot; and got: &quot; + setReturnTypeAndValue[i] + &quot; in test case: &quot; + f);
68             }
69         }
70     } else {
71         fail(&quot;Number of Deoptimizing recompilation is not correct, expected: &quot; + expectedValues.length + &quot; and found: &quot; + events.length + &quot; in test case: &quot; + f);
72     }
73 }
74 
75 checkExpectedRecompilation(function divisionByZeroTest() {var x = { a: 2, b:1 }; x.a = Number.POSITIVE_INFINITY; x.b = 0; print(x.a/x.b); return 1;},
76                            expectedValues =[[&#39;double&#39;, &#39;Infinity&#39;]]);
77 checkExpectedRecompilation(function divisionWithRemainderTest() {var x = { a: 7, b:2 }; print(x.a/x.b); return 1;}, expectedValues =[[&#39;double&#39;, &#39;3.5&#39;]]);
78 checkExpectedRecompilation(function infinityMultiplicationTest() {var x = { a: Number.POSITIVE_INFINITY, b: Number.POSITIVE_INFINITY}; print(x.a*x.b); return 1;},
79                            expectedValues =[[&#39;double&#39;, &#39;Infinity&#39;]]);
80 checkExpectedRecompilation(function maxValueMultiplicationTest() {var x = { a: Number.MAX_VALUE, b: Number.MAX_VALUE}; print(x.a*x.b); return 1;},
81                            expectedValues =[[&#39;double&#39;, &#39;1.7976931348623157e+308&#39;]]);
82 checkExpectedRecompilation(function divisionByInfinityTest() {var x = { a: -1, b: Number.POSITIVE_INFINITY}; print(x.a/x.b); return 1;},
83                            expectedValues =[[&#39;double&#39;, &#39;Infinity&#39;]]);
84 checkExpectedRecompilation(function divisionByStringTest() {var x = { a: Number.POSITIVE_INFINITY, b: &#39;Hello&#39;}; print(x.a/x.b); return 1;},
85                            expectedValues =[[&#39;double&#39;, &#39;Infinity&#39;]]);
86 checkExpectedRecompilation(function nestedFunctionTest() {var a=3,b,c; function f() {var x = 2, y =1; function g(){var y = x; var z = a; z = x*y; print(a*b)} g()}f(); return 1;},
87                            expectedValues =[[&#39;object&#39;, &#39;undefined&#39;]]);
88 checkExpectedRecompilation(function functionTest(a,b,c) { d = (a + b) * c; print(d); return 1;}, expectedValues =[[&#39;double&#39;, &#39;NaN&#39;]]);
89 checkExpectedRecompilation(function andTest(a,b) { d = a &amp;&amp; b; print(d); return 1;}, expectedValues =[[&#39;object&#39;, &#39;undefined&#39;]]);
    </pre>
  </body>
</html>