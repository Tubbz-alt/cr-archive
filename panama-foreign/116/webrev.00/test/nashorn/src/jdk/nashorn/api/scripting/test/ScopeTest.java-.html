<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Old test/nashorn/src/jdk/nashorn/api/scripting/test/ScopeTest.java</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
  <body>
    <pre>
  1 /*
  2  * Copyright (c) 2010, 2013, Oracle and/or its affiliates. All rights reserved.
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.  Oracle designates this
  8  * particular file as subject to the &quot;Classpath&quot; exception as provided
  9  * by Oracle in the LICENSE file that accompanied this code.
 10  *
 11  * This code is distributed in the hope that it will be useful, but WITHOUT
 12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 14  * version 2 for more details (a copy is included in the LICENSE file that
 15  * accompanied this code).
 16  *
 17  * You should have received a copy of the GNU General Public License version
 18  * 2 along with this work; if not, write to the Free Software Foundation,
 19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 20  *
 21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 22  * or visit www.oracle.com if you need additional information or have any
 23  * questions.
 24  */
 25 package jdk.nashorn.api.scripting.test;
 26 
 27 import static org.testng.Assert.assertEquals;
 28 import static org.testng.Assert.assertNotNull;
 29 import static org.testng.Assert.assertFalse;
 30 import static org.testng.Assert.assertTrue;
 31 import static org.testng.Assert.fail;
 32 import javax.script.Bindings;
 33 import javax.script.Compilable;
 34 import javax.script.CompiledScript;
 35 import javax.script.Invocable;
 36 import javax.script.ScriptContext;
 37 import javax.script.ScriptEngine;
 38 import javax.script.ScriptEngineFactory;
 39 import javax.script.ScriptEngineManager;
 40 import javax.script.ScriptException;
 41 import javax.script.SimpleBindings;
 42 import javax.script.SimpleScriptContext;
 43 import jdk.nashorn.api.scripting.NashornScriptEngineFactory;
 44 import jdk.nashorn.api.scripting.ScriptObjectMirror;
 45 import jdk.nashorn.api.scripting.URLReader;
 46 import org.testng.Assert;
 47 import org.testng.annotations.Test;
 48 
 49 /**
 50  * Tests for jsr223 Bindings &quot;scope&quot; (engine, global scopes)
 51  */
 52 @SuppressWarnings(&quot;javadoc&quot;)
 53 public class ScopeTest {
 54 
 55     @Test
 56     public void createBindingsTest() {
 57         final ScriptEngineManager m = new ScriptEngineManager();
 58         final ScriptEngine e = m.getEngineByName(&quot;nashorn&quot;);
 59         final Bindings b = e.createBindings();
 60         b.put(&quot;foo&quot;, 42.0);
 61         Object res = null;
 62         try {
 63             res = e.eval(&quot;foo == 42.0&quot;, b);
 64         } catch (final ScriptException | NullPointerException se) {
 65             se.printStackTrace();
 66             fail(se.getMessage());
 67         }
 68 
 69         assertEquals(res, Boolean.TRUE);
 70     }
 71 
 72     @Test
 73     public void engineScopeTest() {
 74         final ScriptEngineManager m = new ScriptEngineManager();
 75         final ScriptEngine e = m.getEngineByName(&quot;nashorn&quot;);
 76         final Bindings engineScope = e.getBindings(ScriptContext.ENGINE_SCOPE);
 77 
 78         // check few ECMA standard built-in global properties
 79         assertNotNull(engineScope.get(&quot;Object&quot;));
 80         assertNotNull(engineScope.get(&quot;TypeError&quot;));
 81         assertNotNull(engineScope.get(&quot;eval&quot;));
 82 
 83         // can access via ScriptEngine.get as well
 84         assertNotNull(e.get(&quot;Object&quot;));
 85         assertNotNull(e.get(&quot;TypeError&quot;));
 86         assertNotNull(e.get(&quot;eval&quot;));
 87 
 88         // Access by either way should return same object
 89         assertEquals(engineScope.get(&quot;Array&quot;), e.get(&quot;Array&quot;));
 90         assertEquals(engineScope.get(&quot;EvalError&quot;), e.get(&quot;EvalError&quot;));
 91         assertEquals(engineScope.get(&quot;undefined&quot;), e.get(&quot;undefined&quot;));
 92 
 93         // try exposing a new variable from scope
 94         engineScope.put(&quot;myVar&quot;, &quot;foo&quot;);
 95         try {
 96             assertEquals(e.eval(&quot;myVar&quot;), &quot;foo&quot;);
 97         } catch (final ScriptException se) {
 98             se.printStackTrace();
 99             fail(se.getMessage());
100         }
101 
102         // update &quot;myVar&quot; in script an check the value from scope
103         try {
104             e.eval(&quot;myVar = &#39;nashorn&#39;;&quot;);
105         } catch (final ScriptException se) {
106             se.printStackTrace();
107             fail(se.getMessage());
108         }
109 
110         // now check modified value from scope and engine
111         assertEquals(engineScope.get(&quot;myVar&quot;), &quot;nashorn&quot;);
112         assertEquals(e.get(&quot;myVar&quot;), &quot;nashorn&quot;);
113     }
114 
115     @Test
116     public void multiGlobalTest() {
117         final ScriptEngineManager m = new ScriptEngineManager();
118         final ScriptEngine e = m.getEngineByName(&quot;nashorn&quot;);
119         final Bindings b = e.createBindings();
120         final ScriptContext newCtxt = new SimpleScriptContext();
121         newCtxt.setBindings(b, ScriptContext.ENGINE_SCOPE);
122 
123         try {
124             final Object obj1 = e.eval(&quot;Object&quot;);
125             final Object obj2 = e.eval(&quot;Object&quot;, newCtxt);
126             Assert.assertNotEquals(obj1, obj2);
127             Assert.assertNotNull(obj1);
128             Assert.assertNotNull(obj2);
129             Assert.assertEquals(obj1.toString(), obj2.toString());
130 
131             e.eval(&quot;x = &#39;hello&#39;&quot;);
132             e.eval(&quot;x = &#39;world&#39;&quot;, newCtxt);
133             Object x1 = e.getContext().getAttribute(&quot;x&quot;);
134             Object x2 = newCtxt.getAttribute(&quot;x&quot;);
135             Assert.assertNotEquals(x1, x2);
136             Assert.assertEquals(x1, &quot;hello&quot;);
137             Assert.assertEquals(x2, &quot;world&quot;);
138 
139             x1 = e.eval(&quot;x&quot;);
140             x2 = e.eval(&quot;x&quot;, newCtxt);
141             Assert.assertNotEquals(x1, x2);
142             Assert.assertEquals(x1, &quot;hello&quot;);
143             Assert.assertEquals(x2, &quot;world&quot;);
144 
145             final ScriptContext origCtxt = e.getContext();
146             e.setContext(newCtxt);
147             e.eval(&quot;y = new Object()&quot;);
148             e.eval(&quot;y = new Object()&quot;, origCtxt);
149 
150             final Object y1 = origCtxt.getAttribute(&quot;y&quot;);
151             final Object y2 = newCtxt.getAttribute(&quot;y&quot;);
152             Assert.assertNotEquals(y1, y2);
153             final Object yeval1 = e.eval(&quot;y&quot;);
154             final Object yeval2 = e.eval(&quot;y&quot;, origCtxt);
155             Assert.assertNotEquals(yeval1, yeval2);
156             Assert.assertEquals(&quot;[object Object]&quot;, y1.toString());
157             Assert.assertEquals(&quot;[object Object]&quot;, y2.toString());
158         } catch (final ScriptException se) {
159             se.printStackTrace();
160             fail(se.getMessage());
161         }
162     }
163 
164     @Test
165     public void userEngineScopeBindingsTest() throws ScriptException {
166         final ScriptEngineManager m = new ScriptEngineManager();
167         final ScriptEngine e = m.getEngineByName(&quot;nashorn&quot;);
168         e.eval(&quot;function func() {}&quot;);
169 
170         final ScriptContext newContext = new SimpleScriptContext();
171         newContext.setBindings(new SimpleBindings(), ScriptContext.ENGINE_SCOPE);
172         // we are using a new bindings - so it should have &#39;func&#39; defined
173         final Object value = e.eval(&quot;typeof func&quot;, newContext);
174         assertTrue(value.equals(&quot;undefined&quot;));
175     }
176 
177     @Test
178     public void userEngineScopeBindingsNoLeakTest() throws ScriptException {
179         final ScriptEngineManager m = new ScriptEngineManager();
180         final ScriptEngine e = m.getEngineByName(&quot;nashorn&quot;);
181         final ScriptContext newContext = new SimpleScriptContext();
182         newContext.setBindings(new SimpleBindings(), ScriptContext.ENGINE_SCOPE);
183         e.eval(&quot;function foo() {}&quot;, newContext);
184 
185         // in the default context&#39;s ENGINE_SCOPE, &#39;foo&#39; shouldn&#39;t exist
186         assertTrue(e.eval(&quot;typeof foo&quot;).equals(&quot;undefined&quot;));
187     }
188 
189     @Test
190     public void userEngineScopeBindingsRetentionTest() throws ScriptException {
191         final ScriptEngineManager m = new ScriptEngineManager();
192         final ScriptEngine e = m.getEngineByName(&quot;nashorn&quot;);
193         final ScriptContext newContext = new SimpleScriptContext();
194         newContext.setBindings(new SimpleBindings(), ScriptContext.ENGINE_SCOPE);
195         e.eval(&quot;function foo() {}&quot;, newContext);
196 
197         // definition retained with user&#39;s ENGINE_SCOPE Binding
198         assertTrue(e.eval(&quot;typeof foo&quot;, newContext).equals(&quot;function&quot;));
199 
200         final Bindings oldBindings = newContext.getBindings(ScriptContext.ENGINE_SCOPE);
201         // but not in another ENGINE_SCOPE binding
202         newContext.setBindings(new SimpleBindings(), ScriptContext.ENGINE_SCOPE);
203         assertTrue(e.eval(&quot;typeof foo&quot;, newContext).equals(&quot;undefined&quot;));
204 
205         // restore ENGINE_SCOPE and check again
206         newContext.setBindings(oldBindings, ScriptContext.ENGINE_SCOPE);
207         assertTrue(e.eval(&quot;typeof foo&quot;, newContext).equals(&quot;function&quot;));
208     }
209 
210     @Test
211     // check that engine.js definitions are visible in all new global instances
212     public void checkBuiltinsInNewBindingsTest() throws ScriptException {
213         final ScriptEngineManager m = new ScriptEngineManager();
214         final ScriptEngine e = m.getEngineByName(&quot;nashorn&quot;);
215 
216         // check default global instance has engine.js definitions
217         final Bindings g = (Bindings) e.eval(&quot;this&quot;);
218         Object value = g.get(&quot;__noSuchProperty__&quot;);
219         assertTrue(value instanceof ScriptObjectMirror &amp;&amp; ((ScriptObjectMirror)value).isFunction());
220         value = g.get(&quot;print&quot;);
221         assertTrue(value instanceof ScriptObjectMirror &amp;&amp; ((ScriptObjectMirror)value).isFunction());
222 
223         // check new global instance created has engine.js definitions
224         final Bindings b = e.createBindings();
225         value = b.get(&quot;__noSuchProperty__&quot;);
226         assertTrue(value instanceof ScriptObjectMirror &amp;&amp; ((ScriptObjectMirror)value).isFunction());
227         value = b.get(&quot;print&quot;);
228         assertTrue(value instanceof ScriptObjectMirror &amp;&amp; ((ScriptObjectMirror)value).isFunction());
229 
230         // put a mapping into GLOBAL_SCOPE
231         final Bindings globalScope = e.getContext().getBindings(ScriptContext.GLOBAL_SCOPE);
232         globalScope.put(&quot;x&quot;, &quot;hello&quot;);
233 
234         // GLOBAL_SCOPE mapping should be visible from default ScriptContext eval
235         assertTrue(e.eval(&quot;x&quot;).equals(&quot;hello&quot;));
236 
237         final ScriptContext ctx = new SimpleScriptContext();
238         ctx.setBindings(globalScope, ScriptContext.GLOBAL_SCOPE);
239         ctx.setBindings(b, ScriptContext.ENGINE_SCOPE);
240 
241         // GLOBAL_SCOPE mapping should be visible from non-default ScriptContext eval
242         assertTrue(e.eval(&quot;x&quot;, ctx).equals(&quot;hello&quot;));
243 
244         // try some arbitray Bindings for ENGINE_SCOPE
245         final Bindings sb = new SimpleBindings();
246         ctx.setBindings(sb, ScriptContext.ENGINE_SCOPE);
247 
248         // GLOBAL_SCOPE mapping should be visible from non-default ScriptContext eval
249         assertTrue(e.eval(&quot;x&quot;, ctx).equals(&quot;hello&quot;));
250 
251         // engine.js builtins are still defined even with arbitrary Bindings
252         assertTrue(e.eval(&quot;typeof print&quot;, ctx).equals(&quot;function&quot;));
253         assertTrue(e.eval(&quot;typeof __noSuchProperty__&quot;, ctx).equals(&quot;function&quot;));
254 
255         // ENGINE_SCOPE definition should &#39;hide&#39; GLOBAL_SCOPE definition
256         sb.put(&quot;x&quot;, &quot;newX&quot;);
257         assertTrue(e.eval(&quot;x&quot;, ctx).equals(&quot;newX&quot;));
258     }
259 
260     /**
261      * Test multi-threaded access to defined global variables for shared script classes with multiple globals.
262      */
263     @Test
264     public static void multiThreadedVarTest() throws ScriptException, InterruptedException {
265         final ScriptEngineManager m = new ScriptEngineManager();
266         final ScriptEngine e = m.getEngineByName(&quot;nashorn&quot;);
267         final Bindings b = e.createBindings();
268         final ScriptContext origContext = e.getContext();
269         final ScriptContext newCtxt = new SimpleScriptContext();
270         newCtxt.setBindings(b, ScriptContext.ENGINE_SCOPE);
271         final String sharedScript = &quot;foo&quot;;
272 
273         assertEquals(e.eval(&quot;var foo = &#39;original context&#39;;&quot;, origContext), null);
274         assertEquals(e.eval(&quot;var foo = &#39;new context&#39;;&quot;, newCtxt), null);
275 
276         final Thread t1 = new Thread(new ScriptRunner(e, origContext, sharedScript, &quot;original context&quot;, 1000));
277         final Thread t2 = new Thread(new ScriptRunner(e, newCtxt, sharedScript, &quot;new context&quot;, 1000));
278         t1.start();
279         t2.start();
280         t1.join();
281         t2.join();
282 
283         assertEquals(e.eval(&quot;var foo = &#39;newer context&#39;;&quot;, newCtxt), null);
284         final Thread t3 = new Thread(new ScriptRunner(e, origContext, sharedScript, &quot;original context&quot;, 1000));
285         final Thread t4 = new Thread(new ScriptRunner(e, newCtxt, sharedScript, &quot;newer context&quot;, 1000));
286 
287         t3.start();
288         t4.start();
289         t3.join();
290         t4.join();
291 
292         assertEquals(e.eval(sharedScript), &quot;original context&quot;);
293         assertEquals(e.eval(sharedScript, newCtxt), &quot;newer context&quot;);
294     }
295 
296     /**
297      * Test multi-threaded access to undefined global variables for shared script classes with multiple globals.
298      */
299     @Test
300     public static void multiThreadedGlobalTest() throws ScriptException, InterruptedException {
301         final ScriptEngineManager m = new ScriptEngineManager();
302         final ScriptEngine e = m.getEngineByName(&quot;nashorn&quot;);
303         final Bindings b = e.createBindings();
304         final ScriptContext origContext = e.getContext();
305         final ScriptContext newCtxt = new SimpleScriptContext();
306         newCtxt.setBindings(b, ScriptContext.ENGINE_SCOPE);
307 
308         assertEquals(e.eval(&quot;foo = &#39;original context&#39;;&quot;, origContext), &quot;original context&quot;);
309         assertEquals(e.eval(&quot;foo = &#39;new context&#39;;&quot;, newCtxt), &quot;new context&quot;);
310         final String sharedScript = &quot;foo&quot;;
311 
312         final Thread t1 = new Thread(new ScriptRunner(e, origContext, sharedScript, &quot;original context&quot;, 1000));
313         final Thread t2 = new Thread(new ScriptRunner(e, newCtxt, sharedScript, &quot;new context&quot;, 1000));
314         t1.start();
315         t2.start();
316         t1.join();
317         t2.join();
318 
319         final Object obj3 = e.eval(&quot;delete foo; foo = &#39;newer context&#39;;&quot;, newCtxt);
320         assertEquals(obj3, &quot;newer context&quot;);
321         final Thread t3 = new Thread(new ScriptRunner(e, origContext, sharedScript, &quot;original context&quot;, 1000));
322         final Thread t4 = new Thread(new ScriptRunner(e, newCtxt, sharedScript, &quot;newer context&quot;, 1000));
323 
324         t3.start();
325         t4.start();
326         t3.join();
327         t4.join();
328 
329         Assert.assertEquals(e.eval(sharedScript), &quot;original context&quot;);
330         Assert.assertEquals(e.eval(sharedScript, newCtxt), &quot;newer context&quot;);
331     }
332 
333     /**
334      * Test multi-threaded access using the postfix ++ operator for shared script classes with multiple globals.
335      */
336     @Test
337     public static void multiThreadedIncTest() throws ScriptException, InterruptedException {
338         final ScriptEngineManager m = new ScriptEngineManager();
339         final ScriptEngine e = m.getEngineByName(&quot;nashorn&quot;);
340         final Bindings b = e.createBindings();
341         final ScriptContext origContext = e.getContext();
342         final ScriptContext newCtxt = new SimpleScriptContext();
343         newCtxt.setBindings(b, ScriptContext.ENGINE_SCOPE);
344 
345         assertEquals(e.eval(&quot;var x = 0;&quot;, origContext), null);
346         assertEquals(e.eval(&quot;var x = 2;&quot;, newCtxt), null);
347         final String sharedScript = &quot;x++;&quot;;
348 
349         final Thread t1 = new Thread(new Runnable() {
350             @Override
351             public void run() {
352                 try {
353                     for (int i = 0; i &lt; 1000; i++) {
354                         assertEquals(e.eval(sharedScript, origContext), (double)i);
355                     }
356                 } catch (final ScriptException se) {
357                     fail(se.toString());
358                 }
359             }
360         });
361         final Thread t2 = new Thread(new Runnable() {
362             @Override
363             public void run() {
364                 try {
365                     for (int i = 2; i &lt; 1000; i++) {
366                         assertEquals(e.eval(sharedScript, newCtxt), (double)i);
367                     }
368                 } catch (final ScriptException se) {
369                     fail(se.toString());
370                 }
371             }
372         });
373         t1.start();
374         t2.start();
375         t1.join();
376         t2.join();
377     }
378 
379     /**
380      * Test multi-threaded access to primitive prototype properties for shared script classes with multiple globals.
381      */
382     @Test
383     public static void multiThreadedPrimitiveTest() throws ScriptException, InterruptedException {
384         final ScriptEngineManager m = new ScriptEngineManager();
385         final ScriptEngine e = m.getEngineByName(&quot;nashorn&quot;);
386         final Bindings b = e.createBindings();
387         final ScriptContext origContext = e.getContext();
388         final ScriptContext newCtxt = new SimpleScriptContext();
389         newCtxt.setBindings(b, ScriptContext.ENGINE_SCOPE);
390 
391         final Object obj1 = e.eval(&quot;String.prototype.foo = &#39;original context&#39;;&quot;, origContext);
392         final Object obj2 = e.eval(&quot;String.prototype.foo = &#39;new context&#39;;&quot;, newCtxt);
393         assertEquals(obj1, &quot;original context&quot;);
394         assertEquals(obj2, &quot;new context&quot;);
395         final String sharedScript = &quot;&#39;&#39;.foo&quot;;
396 
397         final Thread t1 = new Thread(new ScriptRunner(e, origContext, sharedScript, &quot;original context&quot;, 1000));
398         final Thread t2 = new Thread(new ScriptRunner(e, newCtxt, sharedScript, &quot;new context&quot;, 1000));
399         t1.start();
400         t2.start();
401         t1.join();
402         t2.join();
403 
404         final Object obj3 = e.eval(&quot;delete String.prototype.foo; Object.prototype.foo = &#39;newer context&#39;;&quot;, newCtxt);
405         assertEquals(obj3, &quot;newer context&quot;);
406         final Thread t3 = new Thread(new ScriptRunner(e, origContext, sharedScript, &quot;original context&quot;, 1000));
407         final Thread t4 = new Thread(new ScriptRunner(e, newCtxt, sharedScript, &quot;newer context&quot;, 1000));
408 
409         t3.start();
410         t4.start();
411         t3.join();
412         t4.join();
413 
414         Assert.assertEquals(e.eval(sharedScript), &quot;original context&quot;);
415         Assert.assertEquals(e.eval(sharedScript, newCtxt), &quot;newer context&quot;);
416     }
417 
418 
419     /**
420      * Test multi-threaded access to prototype user accessor properties for shared script classes with multiple globals.
421      */
422     @Test
423     public static void multiThreadedAccessorTest() throws ScriptException, InterruptedException {
424         final ScriptEngineManager m = new ScriptEngineManager();
425         final ScriptEngine e = m.getEngineByName(&quot;nashorn&quot;);
426         final Bindings b = e.createBindings();
427         final ScriptContext origContext = e.getContext();
428         final ScriptContext newCtxt = new SimpleScriptContext();
429         newCtxt.setBindings(b, ScriptContext.ENGINE_SCOPE);
430 
431         e.eval(&quot;Object.defineProperty(Object.prototype, &#39;foo&#39;, { get: function() &#39;original context&#39; })&quot;, origContext);
432         e.eval(&quot;Object.defineProperty(Object.prototype, &#39;foo&#39;, { get: function() &#39;new context&#39;, configurable: true })&quot;, newCtxt);
433         final String sharedScript = &quot;({}).foo&quot;;
434 
435         final Thread t1 = new Thread(new ScriptRunner(e, origContext, sharedScript, &quot;original context&quot;, 1000));
436         final Thread t2 = new Thread(new ScriptRunner(e, newCtxt, sharedScript, &quot;new context&quot;, 1000));
437         t1.start();
438         t2.start();
439         t1.join();
440         t2.join();
441 
442         final Object obj3 = e.eval(&quot;delete Object.prototype.foo; Object.prototype.foo = &#39;newer context&#39;;&quot;, newCtxt);
443         assertEquals(obj3, &quot;newer context&quot;);
444         final Thread t3 = new Thread(new ScriptRunner(e, origContext, sharedScript, &quot;original context&quot;, 1000));
445         final Thread t4 = new Thread(new ScriptRunner(e, newCtxt, sharedScript, &quot;newer context&quot;, 1000));
446 
447         t3.start();
448         t4.start();
449         t3.join();
450         t4.join();
451     }
452 
453     /**
454      * Test multi-threaded access to primitive prototype user accessor properties for shared script classes with multiple globals.
455      */
456     @Test
457     public static void multiThreadedPrimitiveAccessorTest() throws ScriptException, InterruptedException {
458         final ScriptEngineManager m = new ScriptEngineManager();
459         final ScriptEngine e = m.getEngineByName(&quot;nashorn&quot;);
460         final Bindings b = e.createBindings();
461         final ScriptContext origContext = e.getContext();
462         final ScriptContext newCtxt = new SimpleScriptContext();
463         newCtxt.setBindings(b, ScriptContext.ENGINE_SCOPE);
464 
465         e.eval(&quot;Object.defineProperty(String.prototype, &#39;foo&#39;, { get: function() &#39;original context&#39; })&quot;, origContext);
466         e.eval(&quot;Object.defineProperty(String.prototype, &#39;foo&#39;, { get: function() &#39;new context&#39; })&quot;, newCtxt);
467         final String sharedScript = &quot;&#39;&#39;.foo&quot;;
468 
469         final Thread t1 = new Thread(new ScriptRunner(e, origContext, sharedScript, &quot;original context&quot;, 1000));
470         final Thread t2 = new Thread(new ScriptRunner(e, newCtxt, sharedScript, &quot;new context&quot;, 1000));
471         t1.start();
472         t2.start();
473         t1.join();
474         t2.join();
475 
476         final Object obj3 = e.eval(&quot;delete String.prototype.foo; Object.prototype.foo = &#39;newer context&#39;;&quot;, newCtxt);
477         assertEquals(obj3, &quot;newer context&quot;);
478         final Thread t3 = new Thread(new ScriptRunner(e, origContext, sharedScript, &quot;original context&quot;, 1000));
479         final Thread t4 = new Thread(new ScriptRunner(e, newCtxt, sharedScript, &quot;newer context&quot;, 1000));
480 
481         t3.start();
482         t4.start();
483         t3.join();
484         t4.join();
485     }
486 
487     /**
488      * Test multi-threaded scope function invocation for shared script classes with multiple globals.
489      */
490     @Test
491     public static void multiThreadedFunctionTest() throws ScriptException, InterruptedException {
492         final ScriptEngineManager m = new ScriptEngineManager();
493         final ScriptEngine e = m.getEngineByName(&quot;nashorn&quot;);
494         final Bindings b = e.createBindings();
495         final ScriptContext origContext = e.getContext();
496         final ScriptContext newCtxt = new SimpleScriptContext();
497         newCtxt.setBindings(b, ScriptContext.ENGINE_SCOPE);
498 
499         e.eval(new URLReader(ScopeTest.class.getResource(&quot;resources/func.js&quot;)), origContext);
500         assertEquals(origContext.getAttribute(&quot;scopeVar&quot;), 1);
501         assertEquals(e.eval(&quot;scopeTest()&quot;), 1);
502 
503         e.eval(new URLReader(ScopeTest.class.getResource(&quot;resources/func.js&quot;)), newCtxt);
504         assertEquals(newCtxt.getAttribute(&quot;scopeVar&quot;), 1);
505         assertEquals(e.eval(&quot;scopeTest();&quot;, newCtxt), 1);
506 
507         assertEquals(e.eval(&quot;scopeVar = 3;&quot;, newCtxt), 3);
508         assertEquals(newCtxt.getAttribute(&quot;scopeVar&quot;), 3);
509 
510 
511         final Thread t1 = new Thread(new ScriptRunner(e, origContext, &quot;scopeTest()&quot;, 1, 1000));
512         final Thread t2 = new Thread(new ScriptRunner(e, newCtxt, &quot;scopeTest()&quot;, 3, 1000));
513 
514         t1.start();
515         t2.start();
516         t1.join();
517         t2.join();
518 
519     }
520 
521     /**
522      * Test multi-threaded access to global getters and setters for shared script classes with multiple globals.
523      */
524     @Test
525     public static void getterSetterTest() throws ScriptException, InterruptedException {
526         final ScriptEngineManager m = new ScriptEngineManager();
527         final ScriptEngine e = m.getEngineByName(&quot;nashorn&quot;);
528         final Bindings b = e.createBindings();
529         final ScriptContext origContext = e.getContext();
530         final ScriptContext newCtxt = new SimpleScriptContext();
531         newCtxt.setBindings(b, ScriptContext.ENGINE_SCOPE);
532         final String sharedScript = &quot;accessor1&quot;;
533 
534         e.eval(new URLReader(ScopeTest.class.getResource(&quot;resources/gettersetter.js&quot;)), origContext);
535         assertEquals(e.eval(&quot;accessor1 = 1;&quot;), 1);
536         assertEquals(e.eval(sharedScript), 1);
537 
538         e.eval(new URLReader(ScopeTest.class.getResource(&quot;resources/gettersetter.js&quot;)), newCtxt);
539         assertEquals(e.eval(&quot;accessor1 = 2;&quot;, newCtxt), 2);
540         assertEquals(e.eval(sharedScript, newCtxt), 2);
541 
542 
543         final Thread t1 = new Thread(new ScriptRunner(e, origContext, sharedScript, 1, 1000));
544         final Thread t2 = new Thread(new ScriptRunner(e, newCtxt, sharedScript, 2, 1000));
545 
546         t1.start();
547         t2.start();
548         t1.join();
549         t2.join();
550 
551         assertEquals(e.eval(sharedScript), 1);
552         assertEquals(e.eval(sharedScript, newCtxt), 2);
553         assertEquals(e.eval(&quot;v&quot;), 1);
554         assertEquals(e.eval(&quot;v&quot;, newCtxt), 2);
555     }
556 
557     /**
558      * Test multi-threaded access to global getters and setters for shared script classes with multiple globals.
559      */
560     @Test
561     public static void getterSetter2Test() throws ScriptException, InterruptedException {
562         final ScriptEngineManager m = new ScriptEngineManager();
563         final ScriptEngine e = m.getEngineByName(&quot;nashorn&quot;);
564         final Bindings b = e.createBindings();
565         final ScriptContext origContext = e.getContext();
566         final ScriptContext newCtxt = new SimpleScriptContext();
567         newCtxt.setBindings(b, ScriptContext.ENGINE_SCOPE);
568         final String sharedScript = &quot;accessor2&quot;;
569 
570         e.eval(new URLReader(ScopeTest.class.getResource(&quot;resources/gettersetter.js&quot;)), origContext);
571         assertEquals(e.eval(&quot;accessor2 = 1;&quot;), 1);
572         assertEquals(e.eval(sharedScript), 1);
573 
574         e.eval(new URLReader(ScopeTest.class.getResource(&quot;resources/gettersetter.js&quot;)), newCtxt);
575         assertEquals(e.eval(&quot;accessor2 = 2;&quot;, newCtxt), 2);
576         assertEquals(e.eval(sharedScript, newCtxt), 2);
577 
578 
579         final Thread t1 = new Thread(new ScriptRunner(e, origContext, sharedScript, 1, 1000));
580         final Thread t2 = new Thread(new ScriptRunner(e, newCtxt, sharedScript, 2, 1000));
581 
582         t1.start();
583         t2.start();
584         t1.join();
585         t2.join();
586 
587         assertEquals(e.eval(sharedScript), 1);
588         assertEquals(e.eval(sharedScript, newCtxt), 2);
589         assertEquals(e.eval(&quot;x&quot;), 1);
590         assertEquals(e.eval(&quot;x&quot;, newCtxt), 2);
591     }
592 
593     // @bug 8058422: Users should be able to overwrite &quot;context&quot; and &quot;engine&quot; variables
594     @Test
595     public static void contextOverwriteTest() throws ScriptException {
596         final ScriptEngineManager m = new ScriptEngineManager();
597         final ScriptEngine e = m.getEngineByName(&quot;nashorn&quot;);
598         final Bindings b = new SimpleBindings();
599         b.put(&quot;context&quot;, &quot;hello&quot;);
600         b.put(&quot;foo&quot;, 32);
601         final ScriptContext newCtxt = new SimpleScriptContext();
602         newCtxt.setBindings(b, ScriptContext.ENGINE_SCOPE);
603         e.setContext(newCtxt);
604         assertEquals(e.eval(&quot;context&quot;), &quot;hello&quot;);
605         assertEquals(((Number)e.eval(&quot;foo&quot;)).intValue(), 32);
606     }
607 
608     // @bug 8058422: Users should be able to overwrite &quot;context&quot; and &quot;engine&quot; variables
609     @Test
610     public static void contextOverwriteInScriptTest() throws ScriptException {
611         final ScriptEngineManager m = new ScriptEngineManager();
612         final ScriptEngine e = m.getEngineByName(&quot;nashorn&quot;);
613         e.put(&quot;foo&quot;, 32);
614 
615         assertEquals(((Number)e.eval(&quot;foo&quot;)).intValue(), 32);
616         assertEquals(e.eval(&quot;context = &#39;bar&#39;&quot;), &quot;bar&quot;);
617         assertEquals(((Number)e.eval(&quot;foo&quot;)).intValue(), 32);
618     }
619 
620     // @bug 8058422: Users should be able to overwrite &quot;context&quot; and &quot;engine&quot; variables
621     @Test
622     public static void engineOverwriteTest() throws ScriptException {
623         final ScriptEngineManager m = new ScriptEngineManager();
624         final ScriptEngine e = m.getEngineByName(&quot;nashorn&quot;);
625         final Bindings b = new SimpleBindings();
626         b.put(&quot;engine&quot;, &quot;hello&quot;);
627         b.put(&quot;foo&quot;, 32);
628         final ScriptContext newCtxt = new SimpleScriptContext();
629         newCtxt.setBindings(b, ScriptContext.ENGINE_SCOPE);
630         e.setContext(newCtxt);
631         assertEquals(e.eval(&quot;engine&quot;), &quot;hello&quot;);
632         assertEquals(((Number)e.eval(&quot;foo&quot;)).intValue(), 32);
633     }
634 
635     // @bug 8058422: Users should be able to overwrite &quot;context&quot; and &quot;engine&quot; variables
636     @Test
637     public static void engineOverwriteInScriptTest() throws ScriptException {
638         final ScriptEngineManager m = new ScriptEngineManager();
639         final ScriptEngine e = m.getEngineByName(&quot;nashorn&quot;);
640         e.put(&quot;foo&quot;, 32);
641 
642         assertEquals(((Number)e.eval(&quot;foo&quot;)).intValue(), 32);
643         assertEquals(e.eval(&quot;engine = &#39;bar&#39;&quot;), &quot;bar&quot;);
644         assertEquals(((Number)e.eval(&quot;foo&quot;)).intValue(), 32);
645     }
646 
647     // @bug 8044750: megamorphic getter for scope objects does not call __noSuchProperty__ hook
648     @Test
649     public static void testMegamorphicGetInGlobal() throws Exception {
650         final ScriptEngineManager m = new ScriptEngineManager();
651         final ScriptEngine engine = m.getEngineByName(&quot;nashorn&quot;);
652         final String script = &quot;foo&quot;;
653         // &quot;foo&quot; is megamorphic because of different global scopes.
654         // Make sure ScriptContext variable search works even after
655         // it becomes megamorphic.
656         for (int index = 0; index &lt; 25; index++) {
657             final Bindings bindings = new SimpleBindings();
658             bindings.put(&quot;foo&quot;, index);
659             final Number value = (Number)engine.eval(script, bindings);
660             assertEquals(index, value.intValue());
661         }
662     }
663 
664     /**
665      * Test &quot;slow&quot; scopes involving {@code with} and {@code eval} statements for shared script classes with multiple globals.
666      * @throws ScriptException
667      * @throws InterruptedException
668      */
669     @Test
670     public static void testSlowScope() throws ScriptException, InterruptedException {
671         final ScriptEngineManager m = new ScriptEngineManager();
672         final ScriptEngine e = m.getEngineByName(&quot;nashorn&quot;);
673 
674         for (int i = 0; i &lt; 100; i++) {
675             final Bindings b = e.createBindings();
676             final ScriptContext ctxt = new SimpleScriptContext();
677             ctxt.setBindings(b, ScriptContext.ENGINE_SCOPE);
678 
679             e.eval(new URLReader(ScopeTest.class.getResource(&quot;resources/witheval.js&quot;)), ctxt);
680             assertEquals(e.eval(&quot;a&quot;, ctxt), 1);
681             assertEquals(b.get(&quot;a&quot;), 1);
682             assertEquals(e.eval(&quot;b&quot;, ctxt), 3);
683             assertEquals(b.get(&quot;b&quot;), 3);
684             assertEquals(e.eval(&quot;c&quot;, ctxt), 10);
685             assertEquals(b.get(&quot;c&quot;), 10);
686         }
687     }
688 
689     private static class ScriptRunner implements Runnable {
690 
691         final ScriptEngine engine;
692         final ScriptContext context;
693         final String source;
694         final Object expected;
695         final int iterations;
696 
697         ScriptRunner(final ScriptEngine engine, final ScriptContext context, final String source, final Object expected, final int iterations) {
698             this.engine = engine;
699             this.context = context;
700             this.source = source;
701             this.expected = expected;
702             this.iterations = iterations;
703         }
704 
705         @Override
706         public void run() {
707             try {
708                 for (int i = 0; i &lt; iterations; i++) {
709                     assertEquals(engine.eval(source, context), expected);
710                 }
711             } catch (final ScriptException se) {
712                 throw new RuntimeException(se);
713             }
714         }
715     }
716 
717     // @bug 8071678: NashornScriptEngine returns javax.script.ScriptContext instance
718     // with get/setAttribute methods insonsistent for GLOBAL_SCOPE
719     @Test
720     public void testGlobalScopeSearch() throws Exception {
721         final ScriptEngineManager m = new ScriptEngineManager();
722         final ScriptEngine e = m.getEngineByName(&quot;nashorn&quot;);
723         final ScriptContext c = e.getContext();
724         c.setAttribute(&quot;name1234&quot;, &quot;value&quot;, ScriptContext.GLOBAL_SCOPE);
725         assertEquals(c.getAttribute(&quot;name1234&quot;), &quot;value&quot;);
726         assertEquals(c.getAttributesScope(&quot;name1234&quot;),
727             ScriptContext.GLOBAL_SCOPE);
728     }
729 
730     // @bug 8071594: NashornScriptEngine returns javax.script.ScriptContext instance
731     // which doesn&#39;t completely conform to the spec regarding exceptions throwing
732     @Test
733     public void testScriptContext_NPE_IAE() throws Exception {
734         final ScriptEngineManager m = new ScriptEngineManager();
735         final ScriptEngine e = m.getEngineByName(&quot;nashorn&quot;);
736         final ScriptContext c = e.getContext();
737         try {
738             c.getAttribute(&quot;&quot;);
739             throw new AssertionError(&quot;should have thrown IAE&quot;);
740         } catch (final IllegalArgumentException iae1) {}
741 
742         try {
743             c.getAttribute(null);
744             throw new AssertionError(&quot;should have thrown NPE&quot;);
745         } catch (final NullPointerException npe1) {}
746 
747         try {
748             c.getAttribute(&quot;&quot;, ScriptContext.ENGINE_SCOPE);
749             throw new AssertionError(&quot;should have thrown IAE&quot;);
750         } catch (final IllegalArgumentException iae2) {}
751 
752         try {
753             c.getAttribute(null, ScriptContext.ENGINE_SCOPE);
754             throw new AssertionError(&quot;should have thrown NPE&quot;);
755         } catch (final NullPointerException npe2) {}
756 
757         try {
758             c.removeAttribute(&quot;&quot;, ScriptContext.ENGINE_SCOPE);
759             throw new AssertionError(&quot;should have thrown IAE&quot;);
760         } catch (final IllegalArgumentException iae3) {}
761 
762         try {
763             c.removeAttribute(null, ScriptContext.ENGINE_SCOPE);
764             throw new AssertionError(&quot;should have thrown NPE&quot;);
765         } catch (final NullPointerException npe3) {}
766 
767         try {
768             c.setAttribute(&quot;&quot;, &quot;value&quot;, ScriptContext.ENGINE_SCOPE);
769             throw new AssertionError(&quot;should have thrown IAE&quot;);
770         } catch (final IllegalArgumentException iae4) {}
771 
772         try {
773             c.setAttribute(null, &quot;value&quot;, ScriptContext.ENGINE_SCOPE);
774             throw new AssertionError(&quot;should have thrown NPE&quot;);
775         } catch (final NullPointerException npe4) {}
776 
777         try {
778             c.getAttributesScope(&quot;&quot;);
779             throw new AssertionError(&quot;should have thrown IAE&quot;);
780         } catch (final IllegalArgumentException iae5) {}
781 
782         try {
783             c.getAttributesScope(null);
784             throw new AssertionError(&quot;should have thrown NPE&quot;);
785         } catch (final NullPointerException npe5) {}
786     }
787 
788     public static class RecursiveEval {
789         private final ScriptEngineFactory factory = new NashornScriptEngineFactory();
790         private final ScriptEngine engine = factory.getScriptEngine();
791         private final Bindings engineBindings = engine.getBindings(ScriptContext.ENGINE_SCOPE);
792 
793         public void program() throws ScriptException {
794             final ScriptContext sc = new SimpleScriptContext();
795             final Bindings global = new SimpleBindings();
796             sc.setBindings(global, ScriptContext.GLOBAL_SCOPE);
797             sc.setBindings(engineBindings, ScriptContext.ENGINE_SCOPE);
798             global.put(&quot;text&quot;, &quot;programText&quot;);
799             String value = engine.eval(&quot;text&quot;, sc).toString();
800             Assert.assertEquals(value, &quot;programText&quot;);
801             engine.put(&quot;program&quot;, this);
802             engine.eval(&quot;program.method()&quot;);
803             // eval again from here!
804             value = engine.eval(&quot;text&quot;, sc).toString();
805             Assert.assertEquals(value, &quot;programText&quot;);
806         }
807 
808         public void method() throws ScriptException {
809             // a context with a new global bindings, same engine bindings
810             final ScriptContext sc = new SimpleScriptContext();
811             final Bindings global = new SimpleBindings();
812             sc.setBindings(global, ScriptContext.GLOBAL_SCOPE);
813             sc.setBindings(engineBindings, ScriptContext.ENGINE_SCOPE);
814             global.put(&quot;text&quot;, &quot;methodText&quot;);
815             final String value = engine.eval(&quot;text&quot;, sc).toString();
816             Assert.assertEquals(value, &quot;methodText&quot;);
817         }
818     }
819 
820     // @bug 8081609: engine.eval call from a java method which
821     // was called from a previous engine.eval results in wrong
822     // ScriptContext being used.
823     @Test
824     public void recursiveEvalCallScriptContextTest() throws ScriptException {
825         new RecursiveEval().program();
826     }
827 
828     private static final String VAR_NAME = &quot;myvar&quot;;
829 
830     private static boolean lookupVar(final ScriptEngine engine, final String varName) {
831         try {
832             engine.eval(varName);
833             return true;
834         } catch (final ScriptException se) {
835             return false;
836         }
837     }
838 
839     // @bug 8136544: Call site switching to megamorphic causes incorrect property read
840     @Test
841     public void megamorphicPropertyReadTest() throws ScriptException {
842         final NashornScriptEngineFactory factory = new NashornScriptEngineFactory();
843         final ScriptEngine engine = factory.getScriptEngine();
844         final Bindings scope = engine.getBindings(ScriptContext.ENGINE_SCOPE);
845         boolean ret;
846 
847         // Why 16 is the upper limit of this loop? The default nashorn dynalink megamorphic threshold is 16.
848         // See jdk.nashorn.internal.runtime.linker.Bootstrap.NASHORN_DEFAULT_UNSTABLE_RELINK_THRESHOLD
849         // We do, &#39;eval&#39; of the same in this loop twice. So, 16*2 = 32 times that callsite in the script
850         // is exercised - much beyond the default megamorphic threshold.
851 
852         for (int i = 0; i &lt; 16; i++) {
853             scope.remove(VAR_NAME);
854             ret = lookupVar(engine, VAR_NAME);
855             assertFalse(ret, &quot;Expected false in iteration &quot; + i);
856             scope.put(VAR_NAME, &quot;foo&quot;);
857             ret = lookupVar(engine, VAR_NAME);
858             assertTrue(ret, &quot;Expected true in iteration &quot; + i);
859         }
860     }
861 
862     // @bug 8138616: invokeFunction fails if function calls a function defined in GLOBAL_SCOPE
863     @Test
864     public void invokeFunctionInGlobalScopeTest() throws Exception {
865          final ScriptEngine engine = new ScriptEngineManager().getEngineByName(&quot;nashorn&quot;);
866          final ScriptContext ctxt = engine.getContext();
867 
868          // define a function called &quot;func&quot;
869          engine.eval(&quot;func = function() { return 42 }&quot;);
870 
871          // move ENGINE_SCOPE Bindings to GLOBAL_SCOPE
872          ctxt.setBindings(ctxt.getBindings(ScriptContext.ENGINE_SCOPE), ScriptContext.GLOBAL_SCOPE);
873 
874          // create a new Bindings and set as ENGINE_SCOPE
875          ctxt.setBindings(engine.createBindings(), ScriptContext.ENGINE_SCOPE);
876 
877          // define new function that calls &quot;func&quot; now in GLOBAL_SCOPE
878          engine.eval(&quot;newfunc = function() { return func() }&quot;);
879 
880          // call &quot;newfunc&quot; and check the return value
881          final Object value = ((Invocable)engine).invokeFunction(&quot;newfunc&quot;);
882          assertTrue(((Number)value).intValue() == 42);
883     }
884 
885 
886     // @bug 8138616: invokeFunction fails if function calls a function defined in GLOBAL_SCOPE
887     // variant of above that replaces default ScriptContext of the engine with a fresh instance!
888     @Test
889     public void invokeFunctionInGlobalScopeTest2() throws Exception {
890          final ScriptEngine engine = new ScriptEngineManager().getEngineByName(&quot;nashorn&quot;);
891 
892          // create a new ScriptContext instance
893          final ScriptContext ctxt = new SimpleScriptContext();
894          // set it as &#39;default&#39; ScriptContext
895          engine.setContext(ctxt);
896 
897          // create a new Bindings and set as ENGINE_SCOPE
898          ctxt.setBindings(engine.createBindings(), ScriptContext.ENGINE_SCOPE);
899 
900          // define a function called &quot;func&quot;
901          engine.eval(&quot;func = function() { return 42 }&quot;);
902 
903          // move ENGINE_SCOPE Bindings to GLOBAL_SCOPE
904          ctxt.setBindings(ctxt.getBindings(ScriptContext.ENGINE_SCOPE), ScriptContext.GLOBAL_SCOPE);
905 
906          // create a new Bindings and set as ENGINE_SCOPE
907          ctxt.setBindings(engine.createBindings(), ScriptContext.ENGINE_SCOPE);
908 
909          // define new function that calls &quot;func&quot; now in GLOBAL_SCOPE
910          engine.eval(&quot;newfunc = function() { return func() }&quot;);
911 
912          // call &quot;newfunc&quot; and check the return value
913          final Object value = ((Invocable)engine).invokeFunction(&quot;newfunc&quot;);
914          assertTrue(((Number)value).intValue() == 42);
915     }
916 
917     // @bug 8150219 ReferenceError in 1.8.0_72
918     // When we create a Global for a non-default ScriptContext that needs one keep the
919     // ScriptContext associated with the Global so that invoke methods work as expected.
920     @Test
921     public void invokeFunctionWithCustomScriptContextTest() throws Exception {
922         final ScriptEngine engine = new ScriptEngineManager().getEngineByName(&quot;nashorn&quot;);
923 
924         // create an engine and a ScriptContext, but don&#39;t set it as default
925         final ScriptContext scriptContext = new SimpleScriptContext();
926 
927         // Set some value in the context
928         scriptContext.setAttribute(&quot;myString&quot;, &quot;foo&quot;, ScriptContext.ENGINE_SCOPE);
929 
930         // Evaluate script with custom context and get back a function
931         final String script = &quot;function (c) { return myString.indexOf(c); }&quot;;
932         final CompiledScript compiledScript = ((Compilable)engine).compile(script);
933         final Object func = compiledScript.eval(scriptContext);
934 
935         // Invoked function should be able to see context it was evaluated with
936         final Object result = ((Invocable) engine).invokeMethod(func, &quot;call&quot;, func, &quot;o&quot;, null);
937         assertTrue(((Number)result).intValue() == 1);
938     }
939 }
    </pre>
  </body>
</html>