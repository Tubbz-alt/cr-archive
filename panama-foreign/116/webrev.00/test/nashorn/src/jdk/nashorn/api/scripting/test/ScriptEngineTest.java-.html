<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Old test/nashorn/src/jdk/nashorn/api/scripting/test/ScriptEngineTest.java</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
  <body>
    <pre>
  1 /*
  2  * Copyright (c) 2010, 2013, Oracle and/or its affiliates. All rights reserved.
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.  Oracle designates this
  8  * particular file as subject to the &quot;Classpath&quot; exception as provided
  9  * by Oracle in the LICENSE file that accompanied this code.
 10  *
 11  * This code is distributed in the hope that it will be useful, but WITHOUT
 12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 14  * version 2 for more details (a copy is included in the LICENSE file that
 15  * accompanied this code).
 16  *
 17  * You should have received a copy of the GNU General Public License version
 18  * 2 along with this work; if not, write to the Free Software Foundation,
 19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 20  *
 21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 22  * or visit www.oracle.com if you need additional information or have any
 23  * questions.
 24  */
 25 
 26 package jdk.nashorn.api.scripting.test;
 27 
 28 import static org.testng.Assert.assertEquals;
 29 import static org.testng.Assert.assertNotNull;
 30 import static org.testng.Assert.assertNull;
 31 import static org.testng.Assert.assertTrue;
 32 import static org.testng.Assert.fail;
 33 
 34 import java.io.StringReader;
 35 import java.io.StringWriter;
 36 import java.lang.reflect.InvocationHandler;
 37 import java.lang.reflect.Method;
 38 import java.lang.reflect.Proxy;
 39 import java.util.Collections;
 40 import java.util.concurrent.Callable;
 41 import java.util.concurrent.atomic.AtomicBoolean;
 42 import java.util.function.Consumer;
 43 import java.util.function.Function;
 44 import javax.script.Bindings;
 45 import javax.script.Compilable;
 46 import javax.script.CompiledScript;
 47 import javax.script.Invocable;
 48 import javax.script.ScriptContext;
 49 import javax.script.ScriptEngine;
 50 import javax.script.ScriptEngineFactory;
 51 import javax.script.ScriptEngineManager;
 52 import javax.script.ScriptException;
 53 import javax.script.SimpleScriptContext;
 54 import jdk.nashorn.api.scripting.ScriptObjectMirror;
 55 import org.testng.annotations.Test;
 56 
 57 /**
 58  * Tests for JSR-223 script engine for Nashorn.
 59  *
 60  * @test
 61  * @build jdk.nashorn.api.scripting.test.Window jdk.nashorn.api.scripting.test.WindowEventHandler jdk.nashorn.api.scripting.test.VariableArityTestInterface jdk.nashorn.api.scripting.test.ScriptEngineTest
 62  * @run testng/othervm jdk.nashorn.api.scripting.test.ScriptEngineTest
 63  */
 64 @SuppressWarnings(&quot;javadoc&quot;)
 65 public class ScriptEngineTest {
 66 
 67     private static void log(final String msg) {
 68         org.testng.Reporter.log(msg, true);
 69     }
 70 
 71     @Test
 72     public void argumentsTest() {
 73         final ScriptEngineManager m = new ScriptEngineManager();
 74         final ScriptEngine e = m.getEngineByName(&quot;nashorn&quot;);
 75 
 76         final String[] args = new String[] { &quot;hello&quot;, &quot;world&quot; };
 77         try {
 78             e.put(&quot;arguments&quot;, args);
 79             final Object arg0 = e.eval(&quot;arguments[0]&quot;);
 80             final Object arg1 = e.eval(&quot;arguments[1]&quot;);
 81             assertEquals(args[0], arg0);
 82             assertEquals(args[1], arg1);
 83         } catch (final Exception exp) {
 84             exp.printStackTrace();
 85             fail(exp.getMessage());
 86         }
 87     }
 88 
 89     @Test
 90     public void argumentsWithTest() {
 91         final ScriptEngineManager m = new ScriptEngineManager();
 92         final ScriptEngine e = m.getEngineByName(&quot;nashorn&quot;);
 93 
 94         final String[] args = new String[] { &quot;hello&quot;, &quot;world&quot; };
 95         try {
 96             e.put(&quot;arguments&quot;, args);
 97             final Object arg0 = e.eval(&quot;var imports = new JavaImporter(java.io); &quot; +
 98                     &quot; with(imports) { arguments[0] }&quot;);
 99             final Object arg1 = e.eval(&quot;var imports = new JavaImporter(java.util, java.io); &quot; +
100                     &quot; with(imports) { arguments[1] }&quot;);
101             assertEquals(args[0], arg0);
102             assertEquals(args[1], arg1);
103         } catch (final Exception exp) {
104             exp.printStackTrace();
105             fail(exp.getMessage());
106         }
107     }
108 
109     @Test
110     public void argumentsEmptyTest() {
111         final ScriptEngineManager m = new ScriptEngineManager();
112         final ScriptEngine e = m.getEngineByName(&quot;nashorn&quot;);
113 
114         try {
115             assertEquals(e.eval(&quot;arguments instanceof Array&quot;), true);
116             assertEquals(e.eval(&quot;arguments.length == 0&quot;), true);
117         } catch (final Exception exp) {
118             exp.printStackTrace();
119             fail(exp.getMessage());
120         }
121     }
122 
123     @Test
124     public void factoryTests() {
125         final ScriptEngineManager m = new ScriptEngineManager();
126         final ScriptEngine e = m.getEngineByName(&quot;nashorn&quot;);
127         assertNotNull(e);
128 
129         final ScriptEngineFactory fac = e.getFactory();
130 
131         assertEquals(fac.getLanguageName(), &quot;ECMAScript&quot;);
132         assertEquals(fac.getParameter(ScriptEngine.NAME), &quot;javascript&quot;);
133         assertEquals(fac.getLanguageVersion(), &quot;ECMA - 262 Edition 5.1&quot;);
134         assertEquals(fac.getEngineName(), &quot;Oracle Nashorn&quot;);
135         assertEquals(fac.getOutputStatement(&quot;context&quot;), &quot;print(context)&quot;);
136         assertEquals(fac.getProgram(&quot;print(&#39;hello&#39;)&quot;, &quot;print(&#39;world&#39;)&quot;), &quot;print(&#39;hello&#39;);print(&#39;world&#39;);&quot;);
137         assertEquals(fac.getParameter(ScriptEngine.NAME), &quot;javascript&quot;);
138 
139         boolean seenJS = false;
140         for (final String ext : fac.getExtensions()) {
141             if (ext.equals(&quot;js&quot;)) {
142                 seenJS = true;
143             }
144         }
145 
146         assertEquals(seenJS, true);
147         final String str = fac.getMethodCallSyntax(&quot;obj&quot;, &quot;foo&quot;, &quot;x&quot;);
148         assertEquals(str, &quot;obj.foo(x)&quot;);
149 
150         boolean seenNashorn = false, seenJavaScript = false, seenECMAScript = false;
151         for (final String name : fac.getNames()) {
152             switch (name) {
153                 case &quot;nashorn&quot;: seenNashorn = true; break;
154                 case &quot;javascript&quot;: seenJavaScript = true; break;
155                 case &quot;ECMAScript&quot;: seenECMAScript = true; break;
156             default:
157                 break;
158             }
159         }
160 
161         assertTrue(seenNashorn);
162         assertTrue(seenJavaScript);
163         assertTrue(seenECMAScript);
164 
165         boolean seenAppJS = false, seenAppECMA = false, seenTextJS = false, seenTextECMA = false;
166         for (final String mime : fac.getMimeTypes()) {
167             switch (mime) {
168                 case &quot;application/javascript&quot;: seenAppJS = true; break;
169                 case &quot;application/ecmascript&quot;: seenAppECMA = true; break;
170                 case &quot;text/javascript&quot;: seenTextJS = true; break;
171                 case &quot;text/ecmascript&quot;: seenTextECMA = true; break;
172             default:
173                 break;
174             }
175         }
176 
177         assertTrue(seenAppJS);
178         assertTrue(seenAppECMA);
179         assertTrue(seenTextJS);
180         assertTrue(seenTextECMA);
181     }
182 
183     @Test
184     public void evalTests() {
185         final ScriptEngineManager m = new ScriptEngineManager();
186         final ScriptEngine e = m.getEngineByName(&quot;nashorn&quot;);
187         e.put(ScriptEngine.FILENAME, &quot;myfile.js&quot;);
188 
189         try {
190             e.eval(&quot;print(&#39;hello&#39;)&quot;);
191         } catch (final ScriptException se) {
192             fail(se.getMessage());
193         }
194         try {
195             e.eval(&quot;print(&#39;hello)&quot;);
196             fail(&quot;script exception expected&quot;);
197         } catch (final ScriptException se) {
198             assertEquals(se.getLineNumber(), 1);
199             assertEquals(se.getColumnNumber(), 13);
200             assertEquals(se.getFileName(), &quot;myfile.js&quot;);
201             // se.printStackTrace();
202         }
203 
204         try {
205             Object obj = e.eval(&quot;34 + 41&quot;);
206             assertTrue(34.0 + 41.0 == ((Number)obj).doubleValue());
207             obj = e.eval(&quot;x = 5&quot;);
208             assertTrue(5.0 == ((Number)obj).doubleValue());
209         } catch (final ScriptException se) {
210             se.printStackTrace();
211             fail(se.getMessage());
212         }
213     }
214 
215     @Test
216     public void compileTests() {
217         final ScriptEngineManager m = new ScriptEngineManager();
218         final ScriptEngine e = m.getEngineByName(&quot;nashorn&quot;);
219         CompiledScript script = null;
220 
221         try {
222             script = ((Compilable)e).compile(&quot;print(&#39;hello&#39;)&quot;);
223         } catch (final ScriptException se) {
224             fail(se.getMessage());
225         }
226 
227         try {
228             script.eval();
229         } catch (final ScriptException | NullPointerException se) {
230             se.printStackTrace();
231             fail(se.getMessage());
232         }
233 
234         // try to compile from a Reader
235         try {
236             script = ((Compilable)e).compile(new StringReader(&quot;print(&#39;world&#39;)&quot;));
237         } catch (final ScriptException se) {
238             fail(se.getMessage());
239         }
240 
241         try {
242             script.eval();
243         } catch (final ScriptException | NullPointerException se) {
244             se.printStackTrace();
245             fail(se.getMessage());
246         }
247     }
248 
249     @Test
250     public void compileAndEvalInDiffContextTest() throws ScriptException {
251         final ScriptEngineManager m = new ScriptEngineManager();
252         final ScriptEngine engine = m.getEngineByName(&quot;js&quot;);
253         final Compilable compilable = (Compilable) engine;
254         final CompiledScript compiledScript = compilable.compile(&quot;foo&quot;);
255         final ScriptContext ctxt = new SimpleScriptContext();
256         ctxt.setAttribute(&quot;foo&quot;, &quot;hello&quot;, ScriptContext.ENGINE_SCOPE);
257         assertEquals(compiledScript.eval(ctxt), &quot;hello&quot;);
258     }
259 
260     @Test
261     public void accessGlobalTest() {
262         final ScriptEngineManager m = new ScriptEngineManager();
263         final ScriptEngine e = m.getEngineByName(&quot;nashorn&quot;);
264 
265         try {
266             e.eval(&quot;var x = &#39;hello&#39;&quot;);
267             assertEquals(e.get(&quot;x&quot;), &quot;hello&quot;);
268         } catch (final ScriptException exp) {
269             exp.printStackTrace();
270             fail(exp.getMessage());
271         }
272     }
273 
274     @Test
275     public void exposeGlobalTest() {
276         final ScriptEngineManager m = new ScriptEngineManager();
277         final ScriptEngine e = m.getEngineByName(&quot;nashorn&quot;);
278 
279         try {
280             e.put(&quot;y&quot;, &quot;foo&quot;);
281             e.eval(&quot;print(y)&quot;);
282         } catch (final ScriptException exp) {
283             exp.printStackTrace();
284             fail(exp.getMessage());
285         }
286     }
287 
288     @Test
289     public void putGlobalFunctionTest() {
290         final ScriptEngineManager m = new ScriptEngineManager();
291         final ScriptEngine e = m.getEngineByName(&quot;nashorn&quot;);
292 
293         e.put(&quot;callable&quot;, new Callable&lt;String&gt;() {
294             @Override
295             public String call() throws Exception {
296                 return &quot;callable was called&quot;;
297             }
298         });
299 
300         try {
301             e.eval(&quot;print(callable.call())&quot;);
302         } catch (final ScriptException exp) {
303             exp.printStackTrace();
304             fail(exp.getMessage());
305         }
306     }
307 
308     @Test
309     public void windowAlertTest() {
310         final ScriptEngineManager m = new ScriptEngineManager();
311         final ScriptEngine e = m.getEngineByName(&quot;nashorn&quot;);
312         final Window window = new Window();
313 
314         try {
315             e.put(&quot;window&quot;, window);
316             e.eval(&quot;print(window.alert)&quot;);
317             e.eval(&quot;window.alert(&#39;calling window.alert...&#39;)&quot;);
318         } catch (final Exception exp) {
319             exp.printStackTrace();
320             fail(exp.getMessage());
321         }
322     }
323 
324     @Test
325     public void windowLocationTest() {
326         final ScriptEngineManager m = new ScriptEngineManager();
327         final ScriptEngine e = m.getEngineByName(&quot;nashorn&quot;);
328         final Window window = new Window();
329 
330         try {
331             e.put(&quot;window&quot;, window);
332             e.eval(&quot;print(window.location)&quot;);
333             final Object locationValue = e.eval(&quot;window.getLocation()&quot;);
334             assertEquals(locationValue, &quot;http://localhost:8080/window&quot;);
335         } catch (final Exception exp) {
336             exp.printStackTrace();
337             fail(exp.getMessage());
338         }
339     }
340 
341     @Test
342     public void windowItemTest() {
343         final ScriptEngineManager m = new ScriptEngineManager();
344         final ScriptEngine e = m.getEngineByName(&quot;nashorn&quot;);
345         final Window window = new Window();
346 
347         try {
348             e.put(&quot;window&quot;, window);
349             final String item1 = (String)e.eval(&quot;window.item(65535)&quot;);
350             assertEquals(item1, &quot;ffff&quot;);
351             final String item2 = (String)e.eval(&quot;window.item(255)&quot;);
352             assertEquals(item2, &quot;ff&quot;);
353         } catch (final Exception exp) {
354             exp.printStackTrace();
355             fail(exp.getMessage());
356         }
357     }
358 
359     @Test
360     public void windowEventTest() {
361         final ScriptEngineManager m = new ScriptEngineManager();
362         final ScriptEngine e = m.getEngineByName(&quot;nashorn&quot;);
363         final Window window = new Window();
364 
365         try {
366             e.put(&quot;window&quot;, window);
367             e.eval(&quot;window.onload = function() { print(&#39;window load event fired&#39;); return true }&quot;);
368             assertTrue((Boolean)e.eval(&quot;window.onload.loaded()&quot;));
369             final WindowEventHandler handler = window.getOnload();
370             assertNotNull(handler);
371             assertTrue(handler.loaded());
372         } catch (final Exception exp) {
373             exp.printStackTrace();
374             fail(exp.getMessage());
375         }
376     }
377 
378     @Test
379     public void throwTest() {
380         final ScriptEngineManager m = new ScriptEngineManager();
381         final ScriptEngine e = m.getEngineByName(&quot;nashorn&quot;);
382         e.put(ScriptEngine.FILENAME, &quot;throwtest.js&quot;);
383 
384         try {
385             e.eval(&quot;throw &#39;foo&#39;&quot;);
386         } catch (final ScriptException exp) {
387             log(exp.getMessage());
388             assertEquals(exp.getMessage(), &quot;foo in throwtest.js at line number 1 at column number 0&quot;);
389             assertEquals(exp.getFileName(), &quot;throwtest.js&quot;);
390             assertEquals(exp.getLineNumber(), 1);
391         }
392     }
393 
394     @Test
395     public void setTimeoutTest() {
396         final ScriptEngineManager m = new ScriptEngineManager();
397         final ScriptEngine e = m.getEngineByName(&quot;nashorn&quot;);
398         final Window window = new Window();
399 
400         try {
401             final Class&lt;?&gt; setTimeoutParamTypes[] = { Window.class, String.class, int.class };
402             final Method setTimeout = Window.class.getDeclaredMethod(&quot;setTimeout&quot;, setTimeoutParamTypes);
403             assertNotNull(setTimeout);
404             e.put(&quot;window&quot;, window);
405             e.eval(&quot;window.setTimeout(&#39;foo()&#39;, 100)&quot;);
406 
407             // try to make setTimeout global
408             e.put(&quot;setTimeout&quot;, setTimeout);
409             // TODO: java.lang.ClassCastException: required class
410             // java.lang.Integer but encountered class java.lang.Double
411             // e.eval(&quot;setTimeout(&#39;foo2()&#39;, 200)&quot;);
412         } catch (final Exception exp) {
413             exp.printStackTrace();
414             fail(exp.getMessage());
415         }
416     }
417 
418     @Test
419     public void setWriterTest() {
420         final ScriptEngineManager m = new ScriptEngineManager();
421         final ScriptEngine e = m.getEngineByName(&quot;nashorn&quot;);
422         final StringWriter sw = new StringWriter();
423         e.getContext().setWriter(sw);
424 
425         try {
426             e.eval(&quot;print(&#39;hello world&#39;)&quot;);
427         } catch (final Exception exp) {
428             exp.printStackTrace();
429             fail(exp.getMessage());
430         }
431         assertEquals(sw.toString(), println(&quot;hello world&quot;));
432     }
433 
434     @Test
435     public void redefineEchoTest() {
436         final ScriptEngineManager m = new ScriptEngineManager();
437         final ScriptEngine e = m.getEngineByName(&quot;nashorn&quot;);
438 
439         try {
440             e.eval(&quot;var echo = {}; if (typeof echo !== &#39;object&#39;) { throw &#39;echo is a &#39;+typeof echo; }&quot;);
441         } catch (final Exception exp) {
442             exp.printStackTrace();
443             fail(exp.getMessage());
444         }
445     }
446     @Test
447     public void noEnumerablePropertiesTest() {
448         final ScriptEngineManager m = new ScriptEngineManager();
449         final ScriptEngine e = m.getEngineByName(&quot;nashorn&quot;);
450         try {
451             e.eval(&quot;for (i in this) { throw &#39;found property: &#39; + i }&quot;);
452         } catch (final Exception exp) {
453             exp.printStackTrace();
454             fail(exp.getMessage());
455         }
456     }
457 
458     @Test
459     public void noRefErrorForGlobalThisAccessTest() {
460         final ScriptEngineManager m = new ScriptEngineManager();
461         final ScriptEngine e = m.getEngineByName(&quot;nashorn&quot;);
462         try {
463             e.eval(&quot;this.foo&quot;);
464         } catch (final Exception exp) {
465             exp.printStackTrace();
466             fail(exp.getMessage());
467         }
468     }
469 
470     @Test
471     public void refErrorForUndeclaredAccessTest() {
472         final ScriptEngineManager m = new ScriptEngineManager();
473         final ScriptEngine e = m.getEngineByName(&quot;nashorn&quot;);
474         try {
475             e.eval(&quot;try { print(foo); throw &#39;no ref error&#39; } catch (e) { if (!(e instanceof ReferenceError)) throw e; }&quot;);
476         } catch (final Exception exp) {
477             exp.printStackTrace();
478             fail(exp.getMessage());
479         }
480     }
481 
482     @Test
483     public void typeErrorForGlobalThisCallTest() {
484         final ScriptEngineManager m = new ScriptEngineManager();
485         final ScriptEngine e = m.getEngineByName(&quot;nashorn&quot;);
486         try {
487             e.eval(&quot;try { this.foo() } catch(e) { if (! (e instanceof TypeError)) throw &#39;no type error&#39; }&quot;);
488         } catch (final Exception exp) {
489             exp.printStackTrace();
490             fail(exp.getMessage());
491         }
492     }
493 
494     @Test
495     public void refErrorForUndeclaredCallTest() {
496         final ScriptEngineManager m = new ScriptEngineManager();
497         final ScriptEngine e = m.getEngineByName(&quot;nashorn&quot;);
498         try {
499             e.eval(&quot;try { foo() } catch(e) { if (! (e instanceof ReferenceError)) throw &#39;no ref error&#39; }&quot;);
500         } catch (final Exception exp) {
501             exp.printStackTrace();
502             fail(exp.getMessage());
503         }
504     }
505 
506     @Test
507     // check that print function prints arg followed by newline char
508     public void printTest() {
509         final ScriptEngineManager m = new ScriptEngineManager();
510         final ScriptEngine e = m.getEngineByName(&quot;nashorn&quot;);
511         final StringWriter sw = new StringWriter();
512         e.getContext().setWriter(sw);
513         try {
514             e.eval(&quot;print(&#39;hello&#39;)&quot;);
515         } catch (final Throwable t) {
516             t.printStackTrace();
517             fail(t.getMessage());
518         }
519 
520         assertEquals(sw.toString(), println(&quot;hello&quot;));
521     }
522 
523     @Test
524     // check that print prints all arguments (more than one)
525     public void printManyTest() {
526         final ScriptEngineManager m = new ScriptEngineManager();
527         final ScriptEngine e = m.getEngineByName(&quot;nashorn&quot;);
528         final StringWriter sw = new StringWriter();
529         e.getContext().setWriter(sw);
530         try {
531             e.eval(&quot;print(34, true, &#39;hello&#39;)&quot;);
532         } catch (final Throwable t) {
533             t.printStackTrace();
534             fail(t.getMessage());
535         }
536 
537         assertEquals(sw.toString(), println(&quot;34 true hello&quot;));
538     }
539 
540     @Test
541     public void scriptObjectAutoConversionTest() throws ScriptException {
542         final ScriptEngineManager m = new ScriptEngineManager();
543         final ScriptEngine e = m.getEngineByName(&quot;nashorn&quot;);
544         e.eval(&quot;obj = { foo: &#39;hello&#39; }&quot;);
545         e.put(&quot;Window&quot;, e.eval(&quot;Packages.jdk.nashorn.api.scripting.test.Window&quot;));
546         assertEquals(e.eval(&quot;Window.funcJSObject(obj)&quot;), &quot;hello&quot;);
547         assertEquals(e.eval(&quot;Window.funcScriptObjectMirror(obj)&quot;), &quot;hello&quot;);
548         assertEquals(e.eval(&quot;Window.funcMap(obj)&quot;), &quot;hello&quot;);
549         assertEquals(e.eval(&quot;Window.funcJSObject(obj)&quot;), &quot;hello&quot;);
550     }
551 
552     // @bug 8032948: Nashorn linkages awry
553     @Test
554     public void checkProxyAccess() throws ScriptException {
555         final ScriptEngineManager m = new ScriptEngineManager();
556         final ScriptEngine e = m.getEngineByName(&quot;nashorn&quot;);
557         final boolean[] reached = new boolean[1];
558         final Runnable r = (Runnable)Proxy.newProxyInstance(
559             ScriptEngineTest.class.getClassLoader(),
560             new Class[] { Runnable.class },
561             new InvocationHandler() {
562                 @Override
563                 public Object invoke(final Object p, final Method mtd, final Object[] a) {
564                     reached[0] = true;
565                     return null;
566                 }
567             });
568 
569         e.put(&quot;r&quot;, r);
570         e.eval(&quot;r.run()&quot;);
571 
572         assertTrue(reached[0]);
573     }
574 
575     // properties that can be read by any code
576     private static final String[] PROP_NAMES = {
577         &quot;java.version&quot;,
578         &quot;java.vendor&quot;,
579         &quot;java.vendor.url&quot;,
580         &quot;java.class.version&quot;,
581         &quot;os.name&quot;,
582         &quot;os.version&quot;,
583         &quot;os.arch&quot;,
584         &quot;file.separator&quot;,
585         &quot;path.separator&quot;,
586         &quot;line.separator&quot;,
587         &quot;java.specification.version&quot;,
588         &quot;java.specification.vendor&quot;,
589         &quot;java.specification.name&quot;,
590         &quot;java.vm.specification.version&quot;,
591         &quot;java.vm.specification.vendor&quot;,
592         &quot;java.vm.specification.name&quot;,
593         &quot;java.vm.version&quot;,
594         &quot;java.vm.vendor&quot;,
595         &quot;java.vm.name&quot;
596     };
597 
598     // @bug 8033924: Default permissions are not given for eval code
599     @Test
600     public void checkPropertyReadPermissions() throws ScriptException {
601         final ScriptEngineManager m = new ScriptEngineManager();
602         final ScriptEngine e = m.getEngineByName(&quot;nashorn&quot;);
603 
604         for (final String name : PROP_NAMES) {
605             checkProperty(e, name);
606         }
607     }
608 
609     // @bug 8046013: TypeError: Cannot apply &quot;with&quot; to non script object
610     @Test
611     public void withOnMirrorTest() throws ScriptException {
612         final ScriptEngineManager m = new ScriptEngineManager();
613         final ScriptEngine e = m.getEngineByName(&quot;nashorn&quot;);
614 
615         final Object obj = e.eval(&quot;({ foo: &#39;hello&#39;})&quot;);
616         final Object[] arr = new Object[1];
617         arr[0] = obj;
618         e.put(&quot;arr&quot;, arr);
619         final Object res = e.eval(&quot;var res; with(arr[0]) { res = foo; }; res&quot;);
620         assertEquals(res, &quot;hello&quot;);
621     }
622 
623     // @bug 8054223: Nashorn: AssertionError when use __DIR__ and ScriptEngine.eval()
624     @Test
625     public void check__DIR__Test() throws ScriptException {
626         final ScriptEngineManager m = new ScriptEngineManager();
627         final ScriptEngine e = m.getEngineByName(&quot;nashorn&quot;);
628         e.eval(&quot;__DIR__&quot;);
629     }
630 
631     // @bug 8050432:javax.script.filename variable should not be enumerable
632     // with nashorn engine&#39;s ENGINE_SCOPE bindings
633     @Test
634     public void enumerableGlobalsTest() throws ScriptException {
635         final ScriptEngineManager m = new ScriptEngineManager();
636         final ScriptEngine e = m.getEngineByName(&quot;nashorn&quot;);
637 
638         e.put(ScriptEngine.FILENAME, &quot;test&quot;);
639         final Object enumerable = e.eval(
640             &quot;Object.getOwnPropertyDescriptor(this, &quot; +
641             &quot; &#39;javax.script.filename&#39;).enumerable&quot;);
642         assertEquals(enumerable, Boolean.FALSE);
643     }
644 
645     public static class Context {
646         private Object myobj;
647 
648         public void set(final Object o) {
649             myobj = o;
650         }
651 
652         public Object get() {
653             return myobj;
654         }
655     }
656 
657     // @bug 8050977: Java8 Javascript Nashorn exception:
658     // no current Global instance for nashorn
659     @Test
660     public void currentGlobalMissingTest() throws Exception {
661         final ScriptEngineManager manager = new ScriptEngineManager();
662         final ScriptEngine e = manager.getEngineByName(&quot;nashorn&quot;);
663 
664         final Context ctx = new Context();
665         e.put(&quot;ctx&quot;, ctx);
666         e.eval(&quot;var obj = { foo: function(str) { return str.toUpperCase() } }&quot;);
667         e.eval(&quot;ctx.set(obj)&quot;);
668         final Invocable inv = (Invocable)e;
669         assertEquals(&quot;HELLO&quot;, inv.invokeMethod(ctx.get(), &quot;foo&quot;, &quot;hello&quot;));
670         // try object literal
671         e.eval(&quot;ctx.set({ bar: function(str) { return str.toLowerCase() } })&quot;);
672         assertEquals(&quot;hello&quot;, inv.invokeMethod(ctx.get(), &quot;bar&quot;, &quot;HELLO&quot;));
673         // try array literal
674         e.eval(&quot;var arr = [ &#39;hello&#39;, &#39;world&#39; ]&quot;);
675         e.eval(&quot;ctx.set(arr)&quot;);
676         assertEquals(&quot;helloworld&quot;, inv.invokeMethod(ctx.get(), &quot;join&quot;, &quot;&quot;));
677     }
678 
679     // @bug 8068524: NashornScriptEngineFactory.getParameter() throws IAE
680     // for an unknown key, doesn&#39;t conform to the general spec
681     @Test
682     public void getParameterInvalidKeyTest() throws Exception {
683         final ScriptEngineManager manager = new ScriptEngineManager();
684         final ScriptEngine e = manager.getEngineByName(&quot;nashorn&quot;);
685         // no exception expected here!
686         final Object value = e.getFactory().getParameter(&quot;no value assigned to this key&quot;);
687         assertNull(value);
688     }
689 
690     // @bug JDK-8068889: ConsString arguments to a functional interface wasn&#39;t converted to string.
691     @Test
692     public void functionalInterfaceStringTest() throws Exception {
693         final ScriptEngineManager manager = new ScriptEngineManager();
694         final ScriptEngine e = manager.getEngineByName(&quot;nashorn&quot;);
695         final AtomicBoolean invoked = new AtomicBoolean(false);
696         e.put(&quot;f&quot;, new Function&lt;String, String&gt;() {
697             @Override
698             public String apply(final String t) {
699                 invoked.set(true);
700                 return t;
701             }
702         });
703         assertEquals(e.eval(&quot;var x = &#39;a&#39;; x += &#39;b&#39;; f(x)&quot;), &quot;ab&quot;);
704         assertTrue(invoked.get());
705     }
706 
707     // @bug JDK-8068889: ScriptObject arguments to a functional interface wasn&#39;t converted to a mirror.
708     @Test
709     public void functionalInterfaceObjectTest() throws Exception {
710         final ScriptEngineManager manager = new ScriptEngineManager();
711         final ScriptEngine e = manager.getEngineByName(&quot;nashorn&quot;);
712         final AtomicBoolean invoked = new AtomicBoolean(false);
713         e.put(&quot;c&quot;, new Consumer&lt;Object&gt;() {
714             @Override
715             public void accept(final Object t) {
716                 assertTrue(t instanceof ScriptObjectMirror);
717                 assertEquals(((ScriptObjectMirror)t).get(&quot;a&quot;), &quot;xyz&quot;);
718                 invoked.set(true);
719             }
720         });
721         e.eval(&quot;var x = &#39;xy&#39;; x += &#39;z&#39;;c({a:x})&quot;);
722         assertTrue(invoked.get());
723     }
724 
725     @Test
726     public void testLengthOnArrayLikeObjects() throws Exception {
727         final ScriptEngine e = new ScriptEngineManager().getEngineByName(&quot;nashorn&quot;);
728         final Object val = e.eval(&quot;var arr = { length: 1, 0: 1}; arr.length&quot;);
729 
730         assertTrue(Number.class.isAssignableFrom(val.getClass()));
731         assertTrue(((Number)val).intValue() == 1);
732     }
733 
734     // @bug JDK-8068603: NashornScriptEngine.put/get() impls don&#39;t conform to NPE, IAE spec assertions
735     @Test
736     public void illegalBindingsValuesTest() throws Exception {
737         final ScriptEngineManager manager = new ScriptEngineManager();
738         final ScriptEngine e = manager.getEngineByName(&quot;nashorn&quot;);
739 
740         try {
741             e.put(null, &quot;null-value&quot;);
742             fail();
743         } catch (final NullPointerException x) {
744             // expected
745         }
746 
747         try {
748             e.put(&quot;&quot;, &quot;empty-value&quot;);
749             fail();
750         } catch (final IllegalArgumentException x) {
751             // expected
752         }
753 
754         final Bindings b = e.getBindings(ScriptContext.ENGINE_SCOPE);
755         assertTrue(b instanceof ScriptObjectMirror);
756 
757         try {
758             b.put(null, &quot;null-value&quot;);
759             fail();
760         } catch (final NullPointerException x) {
761             // expected
762         }
763 
764         try {
765             b.put(&quot;&quot;, &quot;empty-value&quot;);
766             fail();
767         } catch (final IllegalArgumentException x) {
768             // expected
769         }
770 
771         try {
772             b.get(null);
773             fail();
774         } catch (final NullPointerException x) {
775             // expected
776         }
777 
778         try {
779             b.get(&quot;&quot;);
780             fail();
781         } catch (final IllegalArgumentException x) {
782             // expected
783         }
784 
785         try {
786             b.get(1);
787             fail();
788         } catch (final ClassCastException x) {
789             // expected
790         }
791 
792         try {
793             b.remove(null);
794             fail();
795         } catch (final NullPointerException x) {
796             // expected
797         }
798 
799         try {
800             b.remove(&quot;&quot;);
801             fail();
802         } catch (final IllegalArgumentException x) {
803             // expected
804         }
805 
806         try {
807             b.remove(1);
808             fail();
809         } catch (final ClassCastException x) {
810             // expected
811         }
812 
813         try {
814             b.containsKey(null);
815             fail();
816         } catch (final NullPointerException x) {
817             // expected
818         }
819 
820         try {
821             b.containsKey(&quot;&quot;);
822             fail();
823         } catch (final IllegalArgumentException x) {
824             // expected
825         }
826 
827         try {
828             b.containsKey(1);
829             fail();
830         } catch (final ClassCastException x) {
831             // expected
832         }
833 
834         try {
835             b.putAll(null);
836             fail();
837         } catch (final NullPointerException x) {
838             // expected
839         }
840 
841         try {
842             b.putAll(Collections.singletonMap((String)null, &quot;null-value&quot;));
843             fail();
844         } catch (final NullPointerException x) {
845             // expected
846         }
847 
848         try {
849             b.putAll(Collections.singletonMap(&quot;&quot;, &quot;empty-value&quot;));
850             fail();
851         } catch (final IllegalArgumentException x) {
852             // expected
853         }
854     }
855 
856     // @bug 8071989: NashornScriptEngine returns javax.script.ScriptContext instance
857     // with insonsistent get/remove methods behavior for undefined attributes
858     @Test
859     public void testScriptContextGetRemoveUndefined() throws Exception {
860         final ScriptEngineManager manager = new ScriptEngineManager();
861         final ScriptEngine e = manager.getEngineByName(&quot;nashorn&quot;);
862         final ScriptContext ctx = e.getContext();
863         assertNull(ctx.getAttribute(&quot;undefinedname&quot;, ScriptContext.ENGINE_SCOPE));
864         assertNull(ctx.removeAttribute(&quot;undefinedname&quot;, ScriptContext.ENGINE_SCOPE));
865     }
866 
867     private static void checkProperty(final ScriptEngine e, final String name)
868         throws ScriptException {
869         final String value = System.getProperty(name);
870         e.put(&quot;name&quot;, name);
871         assertEquals(value, e.eval(&quot;java.lang.System.getProperty(name)&quot;));
872     }
873 
874     private static final String LINE_SEPARATOR = System.getProperty(&quot;line.separator&quot;);
875 
876     // Returns String that would be the result of calling PrintWriter.println
877     // of the given String. (This is to handle platform specific newline).
878     private static String println(final String str) {
879         return str + LINE_SEPARATOR;
880     }
881 }
    </pre>
  </body>
</html>