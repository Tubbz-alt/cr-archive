<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff test/jdk/tools/jlink/ModuleNamesOrderTest.java</title>
    <link rel="stylesheet" href="../../../../style.css" />
  </head>
<body>
<center><a href="JLinkTest.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="../jpackage/helpers/jdk/jpackage/test/Executor.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>test/jdk/tools/jlink/ModuleNamesOrderTest.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 30 import java.util.Properties;
 31 import java.util.spi.ToolProvider;
 32 import java.util.stream.Collectors;
 33 import java.util.stream.Stream;
 34 
 35 import tests.Helper;
 36 import tests.JImageGenerator;
 37 import tests.JImageGenerator.JLinkTask;
 38 
 39 /*
 40  * @test
 41  * @bug 8168925
 42  * @summary MODULES property should be topologically ordered and space-separated list
 43  * @library ../lib
 44  * @modules java.base/jdk.internal.jimage
 45  *          jdk.jdeps/com.sun.tools.classfile
 46  *          jdk.jlink/jdk.tools.jlink.internal
 47  *          jdk.jlink/jdk.tools.jmod
 48  *          jdk.jlink/jdk.tools.jimage
 49  *          jdk.compiler
<span class="line-modified"> 50  *          jdk.scripting.nashorn</span>
<span class="line-removed"> 51  *          jdk.scripting.nashorn.shell</span>
 52  *
 53  * @build tests.*
 54  * @run main ModuleNamesOrderTest
 55  */
 56 public class ModuleNamesOrderTest {
 57     static final ToolProvider JLINK_TOOL = ToolProvider.findFirst(&quot;jlink&quot;)
 58         .orElseThrow(() -&gt;
 59             new RuntimeException(&quot;jlink tool not found&quot;)
 60         );
 61 
 62     public static void main(String[] args) throws Exception {
 63         Helper helper = Helper.newHelper();
 64         if (helper == null) {
 65             System.err.println(&quot;Test not run&quot;);
 66             return;
 67         }
 68 
 69         testDependences(helper);
 70         testModulesOrder(helper);
 71     }
</pre>
<hr />
<pre>
 87         Properties props = new Properties();
 88         try (FileReader reader = new FileReader(release)) {
 89             props.load(reader);
 90         }
 91 
 92         String modules = props.getProperty(&quot;MODULES&quot;);
 93         if (!modules.startsWith(&quot;\&quot;java.base &quot;)) {
 94             throw new AssertionError(&quot;MODULES should start with &#39;java.base&#39;&quot;);
 95         }
 96         if (modules.charAt(0) != &#39;&quot;&#39; || modules.charAt(modules.length()-1) != &#39;&quot;&#39;) {
 97             throw new AssertionError(&quot;MODULES value should be double quoted&quot;);
 98         }
 99 
100         return Stream.of(modules.substring(1, modules.length()-1).split(&quot;\\s+&quot;))
101                      .collect(Collectors.toList());
102     }
103 
104     private static void testDependences(Helper helper) throws IOException {
105         Path outputDir = helper.createNewImageDir(&quot;test&quot;);
106         List&lt;String&gt; modules = modulesProperty(outputDir, helper.defaultModulePath(),
<span class="line-modified">107             &quot;jdk.scripting.nashorn&quot;);</span>
108         String last = modules.get(modules.size()-1);
<span class="line-modified">109         if (!last.equals(&quot;jdk.scripting.nashorn&quot;)) {</span>
110             throw new AssertionError(&quot;Unexpected MODULES value: &quot; + modules);
111         }
112 
113         checkDependency(modules, &quot;java.logging&quot;, &quot;java.base&quot;);
<span class="line-modified">114         checkDependency(modules, &quot;jdk.dynalink&quot;, &quot;java.logging&quot;);</span>
<span class="line-modified">115         checkDependency(modules, &quot;java.scripting&quot;, &quot;java.base&quot;);</span>
<span class="line-modified">116         checkDependency(modules, &quot;jdk.scripting.nashorn&quot;, &quot;java.logging&quot;);</span>
<span class="line-removed">117         checkDependency(modules, &quot;jdk.scripting.nashorn&quot;, &quot;jdk.dynalink&quot;);</span>
<span class="line-removed">118         checkDependency(modules, &quot;jdk.scripting.nashorn&quot;, &quot;java.scripting&quot;);</span>
119     }
120 
121     /*
122      * Verify the MODULES list must be the same for the same module graph
123      */
124     private static void testModulesOrder(Helper helper) throws IOException {
125         Path image1 = helper.createNewImageDir(&quot;test1&quot;);
126         List&lt;String&gt; modules1 = modulesProperty(image1, helper.defaultModulePath(),
<span class="line-modified">127             &quot;jdk.scripting.nashorn&quot;, &quot;jdk.scripting.nashorn.shell&quot;);</span>
128         Path image2 = helper.createNewImageDir(&quot;test2&quot;);
129         List&lt;String&gt; modules2 = modulesProperty(image2, helper.defaultModulePath(),
<span class="line-modified">130             &quot;jdk.scripting.nashorn.shell&quot;, &quot;jdk.scripting.nashorn&quot;);</span>
131         if (!modules1.equals(modules2)) {
132             throw new AssertionError(&quot;MODULES should be a stable order: &quot; +
133                 modules1 + &quot; vs &quot; + modules2);
134         }
135     }
136 
137     private static void checkDependency(List&lt;String&gt; modules, String fromMod, String toMod) {
138         int fromModIdx = modules.indexOf(fromMod);
139         if (fromModIdx == -1) {
140             throw new AssertionError(fromMod + &quot; is missing in MODULES&quot;);
141         }
142         int toModIdx = modules.indexOf(toMod);
143         if (toModIdx == -1) {
144             throw new AssertionError(toMod + &quot; is missing in MODULES&quot;);
145         }
146 
147         if (toModIdx &gt; fromModIdx) {
148             throw new AssertionError(&quot;in MODULES, &quot; + fromMod + &quot; should appear after &quot; + toMod);
149         }
150     }
</pre>
</td>
<td>
<hr />
<pre>
 30 import java.util.Properties;
 31 import java.util.spi.ToolProvider;
 32 import java.util.stream.Collectors;
 33 import java.util.stream.Stream;
 34 
 35 import tests.Helper;
 36 import tests.JImageGenerator;
 37 import tests.JImageGenerator.JLinkTask;
 38 
 39 /*
 40  * @test
 41  * @bug 8168925
 42  * @summary MODULES property should be topologically ordered and space-separated list
 43  * @library ../lib
 44  * @modules java.base/jdk.internal.jimage
 45  *          jdk.jdeps/com.sun.tools.classfile
 46  *          jdk.jlink/jdk.tools.jlink.internal
 47  *          jdk.jlink/jdk.tools.jmod
 48  *          jdk.jlink/jdk.tools.jimage
 49  *          jdk.compiler
<span class="line-modified"> 50  *          jdk.jshell</span>

 51  *
 52  * @build tests.*
 53  * @run main ModuleNamesOrderTest
 54  */
 55 public class ModuleNamesOrderTest {
 56     static final ToolProvider JLINK_TOOL = ToolProvider.findFirst(&quot;jlink&quot;)
 57         .orElseThrow(() -&gt;
 58             new RuntimeException(&quot;jlink tool not found&quot;)
 59         );
 60 
 61     public static void main(String[] args) throws Exception {
 62         Helper helper = Helper.newHelper();
 63         if (helper == null) {
 64             System.err.println(&quot;Test not run&quot;);
 65             return;
 66         }
 67 
 68         testDependences(helper);
 69         testModulesOrder(helper);
 70     }
</pre>
<hr />
<pre>
 86         Properties props = new Properties();
 87         try (FileReader reader = new FileReader(release)) {
 88             props.load(reader);
 89         }
 90 
 91         String modules = props.getProperty(&quot;MODULES&quot;);
 92         if (!modules.startsWith(&quot;\&quot;java.base &quot;)) {
 93             throw new AssertionError(&quot;MODULES should start with &#39;java.base&#39;&quot;);
 94         }
 95         if (modules.charAt(0) != &#39;&quot;&#39; || modules.charAt(modules.length()-1) != &#39;&quot;&#39;) {
 96             throw new AssertionError(&quot;MODULES value should be double quoted&quot;);
 97         }
 98 
 99         return Stream.of(modules.substring(1, modules.length()-1).split(&quot;\\s+&quot;))
100                      .collect(Collectors.toList());
101     }
102 
103     private static void testDependences(Helper helper) throws IOException {
104         Path outputDir = helper.createNewImageDir(&quot;test&quot;);
105         List&lt;String&gt; modules = modulesProperty(outputDir, helper.defaultModulePath(),
<span class="line-modified">106             &quot;jdk.jshell&quot;);</span>
107         String last = modules.get(modules.size()-1);
<span class="line-modified">108         if (!last.equals(&quot;jdk.jshell&quot;)) {</span>
109             throw new AssertionError(&quot;Unexpected MODULES value: &quot; + modules);
110         }
111 
112         checkDependency(modules, &quot;java.logging&quot;, &quot;java.base&quot;);
<span class="line-modified">113         checkDependency(modules, &quot;jdk.compiler&quot;, &quot;java.compiler&quot;);</span>
<span class="line-modified">114         checkDependency(modules, &quot;jdk.jshell&quot;, &quot;java.logging&quot;);</span>
<span class="line-modified">115         checkDependency(modules, &quot;jdk.jshell&quot;, &quot;jdk.compiler&quot;);</span>


116     }
117 
118     /*
119      * Verify the MODULES list must be the same for the same module graph
120      */
121     private static void testModulesOrder(Helper helper) throws IOException {
122         Path image1 = helper.createNewImageDir(&quot;test1&quot;);
123         List&lt;String&gt; modules1 = modulesProperty(image1, helper.defaultModulePath(),
<span class="line-modified">124             &quot;jdk.jshell&quot;);</span>
125         Path image2 = helper.createNewImageDir(&quot;test2&quot;);
126         List&lt;String&gt; modules2 = modulesProperty(image2, helper.defaultModulePath(),
<span class="line-modified">127             &quot;jdk.jshell&quot;);</span>
128         if (!modules1.equals(modules2)) {
129             throw new AssertionError(&quot;MODULES should be a stable order: &quot; +
130                 modules1 + &quot; vs &quot; + modules2);
131         }
132     }
133 
134     private static void checkDependency(List&lt;String&gt; modules, String fromMod, String toMod) {
135         int fromModIdx = modules.indexOf(fromMod);
136         if (fromModIdx == -1) {
137             throw new AssertionError(fromMod + &quot; is missing in MODULES&quot;);
138         }
139         int toModIdx = modules.indexOf(toMod);
140         if (toModIdx == -1) {
141             throw new AssertionError(toMod + &quot; is missing in MODULES&quot;);
142         }
143 
144         if (toModIdx &gt; fromModIdx) {
145             throw new AssertionError(&quot;in MODULES, &quot; + fromMod + &quot; should appear after &quot; + toMod);
146         }
147     }
</pre>
</td>
</tr>
</table>
<center><a href="JLinkTest.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="../jpackage/helpers/jdk/jpackage/test/Executor.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>