<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff test/jdk/java/util/regex/RegExTest.java</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
<body>
<center><a href="../../security/Policy/SignedJar/SignedJarTest.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="../../../javax/script/Helper.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>test/jdk/java/util/regex/RegExTest.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  */
  23 
  24 /**
  25  * @test
  26  * @summary tests RegExp framework (use -Dseed=X to set PRNG seed)
  27  * @author Mike McCloskey
  28  * @bug 4481568 4482696 4495089 4504687 4527731 4599621 4631553 4619345
  29  * 4630911 4672616 4711773 4727935 4750573 4792284 4803197 4757029 4808962
  30  * 4872664 4803179 4892980 4900747 4945394 4938995 4979006 4994840 4997476
  31  * 5013885 5003322 4988891 5098443 5110268 6173522 4829857 5027748 6376940
  32  * 6358731 6178785 6284152 6231989 6497148 6486934 6233084 6504326 6635133
  33  * 6350801 6676425 6878475 6919132 6931676 6948903 6990617 7014645 7039066
  34  * 7067045 7014640 7189363 8007395 8013252 8013254 8012646 8023647 6559590
  35  * 8027645 8035076 8039124 8035975 8074678 6854417 8143854 8147531 7071819
  36  * 8151481 4867170 7080302 6728861 6995635 6736245 4916384 6328855 6192895
  37  * 6345469 6988218 6693451 7006761 8140212 8143282 8158482 8176029 8184706
  38  * 8194667 8197462 8184692 8221431 8224789 8228352 8230829 8236034 8235812
<span class="line-modified">  39  * 8216332 8214245 8237599</span>
  40  *
  41  * @library /test/lib
  42  * @library /lib/testlibrary/java/lang
  43  * @build jdk.test.lib.RandomFactory
  44  * @run main RegExTest
  45  * @key randomness
  46  */
  47 
  48 import java.io.BufferedReader;
  49 import java.io.ByteArrayInputStream;
  50 import java.io.ByteArrayOutputStream;
  51 import java.io.File;
  52 import java.io.FileInputStream;
  53 import java.io.InputStreamReader;
  54 import java.io.ObjectInputStream;
  55 import java.io.ObjectOutputStream;
  56 import java.math.BigInteger;
  57 import java.nio.CharBuffer;
  58 import java.nio.file.Files;
  59 import java.nio.file.Path;
</pre>
<hr />
<pre>
4780 
4781     // This test is for 8158482
4782     private static void embeddedFlags() throws Exception {
4783         try {
4784             Pattern.compile(&quot;(?i).(?-i).&quot;);
4785             Pattern.compile(&quot;(?m).(?-m).&quot;);
4786             Pattern.compile(&quot;(?s).(?-s).&quot;);
4787             Pattern.compile(&quot;(?d).(?-d).&quot;);
4788             Pattern.compile(&quot;(?u).(?-u).&quot;);
4789             Pattern.compile(&quot;(?c).(?-c).&quot;);
4790             Pattern.compile(&quot;(?x).(?-x).&quot;);
4791             Pattern.compile(&quot;(?U).(?-U).&quot;);
4792             Pattern.compile(&quot;(?imsducxU).(?-imsducxU).&quot;);
4793         } catch (PatternSyntaxException x) {
4794             failCount++;
4795         }
4796         report(&quot;Embedded flags&quot;);
4797     }
4798 
4799     private static void grapheme() throws Exception {

4800         Stream.concat(Files.lines(UCDFiles.GRAPHEME_BREAK_TEST),
4801                 Files.lines(Paths.get(System.getProperty(&quot;test.src&quot;, &quot;.&quot;), &quot;GraphemeTestCases.txt&quot;)))
<span class="line-removed">4802             .filter( ln -&gt; ln.length() != 0 &amp;&amp; !ln.startsWith(&quot;#&quot;) )</span>
4803             .forEach( ln -&gt; {
<span class="line-modified">4804                 ln = ln.replaceAll(&quot;\\s+|\\([a-zA-Z]+\\)|\\[[a-zA-Z]]+\\]|#.*&quot;, &quot;&quot;);</span>
<span class="line-modified">4805                 // System.out.println(str);</span>
<span class="line-modified">4806                 String[] strs = ln.split(&quot;\u00f7|\u00d7&quot;);</span>
<span class="line-removed">4807                 StringBuilder src = new StringBuilder();</span>
<span class="line-removed">4808                 ArrayList&lt;String&gt; graphemes = new ArrayList&lt;&gt;();</span>
<span class="line-removed">4809                 StringBuilder buf = new StringBuilder();</span>
<span class="line-removed">4810                 int offBk = 0;</span>
<span class="line-removed">4811                 for (String str : strs) {</span>
<span class="line-removed">4812                     if (str.length() == 0)  // first empty str</span>
<span class="line-removed">4813                         continue;</span>
<span class="line-removed">4814                     int cp = Integer.parseInt(str, 16);</span>
<span class="line-removed">4815                     src.appendCodePoint(cp);</span>
<span class="line-removed">4816                     buf.appendCodePoint(cp);</span>
<span class="line-removed">4817                     offBk += (str.length() + 1);</span>
<span class="line-removed">4818                     if (ln.charAt(offBk) == &#39;\u00f7&#39;) {    // DIV</span>
<span class="line-removed">4819                         graphemes.add(buf.toString());</span>
<span class="line-removed">4820                         buf = new StringBuilder();</span>
4821                     }
<span class="line-modified">4822                 }</span>
<span class="line-modified">4823                 Pattern p = Pattern.compile(&quot;\\X&quot;);</span>
<span class="line-modified">4824                 Matcher m = p.matcher(src.toString());</span>
<span class="line-modified">4825                 Scanner s = new Scanner(src.toString()).useDelimiter(&quot;\\b{g}&quot;);</span>
<span class="line-modified">4826                 for (String g : graphemes) {</span>
<span class="line-modified">4827                     // System.out.printf(&quot;     grapheme:=[%s]%n&quot;, g);</span>
<span class="line-modified">4828                     // (1) test \\X directly</span>
<span class="line-modified">4829                     if (!m.find() || !m.group().equals(g)) {</span>
<span class="line-modified">4830                         System.out.println(&quot;Failed \\X [&quot; + ln + &quot;] : &quot; + g);</span>













































4831                         failCount++;
4832                     }
<span class="line-modified">4833                     // (2) test \\b{g} + \\X  via Scanner</span>
<span class="line-modified">4834                     boolean hasNext = s.hasNext(p);</span>
<span class="line-modified">4835                     // if (!s.hasNext() || !s.next().equals(next)) {</span>
<span class="line-modified">4836                     if (!s.hasNext(p) || !s.next(p).equals(g)) {</span>
<span class="line-modified">4837                         System.out.println(&quot;Failed b{g} [&quot; + ln + &quot;] : &quot; + g);</span>







4838                         failCount++;
4839                     }
<span class="line-modified">4840                 }</span>
<span class="line-modified">4841             });</span>













4842         // some sanity checks
4843         if (!Pattern.compile(&quot;\\X{10}&quot;).matcher(&quot;abcdefghij&quot;).matches() ||
4844             !Pattern.compile(&quot;\\b{g}(?:\\X\\b{g}){5}\\b{g}&quot;).matcher(&quot;abcde&quot;).matches() ||
4845             !Pattern.compile(&quot;(?:\\X\\b{g}){2}&quot;).matcher(&quot;\ud800\udc00\ud801\udc02&quot;).matches())
4846             failCount++;
4847         // make sure &quot;\b{n}&quot; still works
4848         if (!Pattern.compile(&quot;\\b{1}hello\\b{1} \\b{1}world\\b{1}&quot;).matcher(&quot;hello world&quot;).matches())
4849             failCount++;
4850         report(&quot;Unicode extended grapheme cluster&quot;);
4851     }
4852 
4853     // hangup/timeout if go into exponential backtracking
4854     private static void expoBacktracking() throws Exception {
4855 
4856         Object[][] patternMatchers = {
4857             // 6328855
4858             { &quot;(.*\n*)*&quot;,
4859               &quot;this little fine string lets\r\njava.lang.String.matches\r\ncrash\r\n(We don&#39;t know why but adding \r* to the regex makes it work again)&quot;,
4860               false },
4861             // 6192895
</pre>
</td>
<td>
<hr />
<pre>
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  */
  23 
  24 /**
  25  * @test
  26  * @summary tests RegExp framework (use -Dseed=X to set PRNG seed)
  27  * @author Mike McCloskey
  28  * @bug 4481568 4482696 4495089 4504687 4527731 4599621 4631553 4619345
  29  * 4630911 4672616 4711773 4727935 4750573 4792284 4803197 4757029 4808962
  30  * 4872664 4803179 4892980 4900747 4945394 4938995 4979006 4994840 4997476
  31  * 5013885 5003322 4988891 5098443 5110268 6173522 4829857 5027748 6376940
  32  * 6358731 6178785 6284152 6231989 6497148 6486934 6233084 6504326 6635133
  33  * 6350801 6676425 6878475 6919132 6931676 6948903 6990617 7014645 7039066
  34  * 7067045 7014640 7189363 8007395 8013252 8013254 8012646 8023647 6559590
  35  * 8027645 8035076 8039124 8035975 8074678 6854417 8143854 8147531 7071819
  36  * 8151481 4867170 7080302 6728861 6995635 6736245 4916384 6328855 6192895
  37  * 6345469 6988218 6693451 7006761 8140212 8143282 8158482 8176029 8184706
  38  * 8194667 8197462 8184692 8221431 8224789 8228352 8230829 8236034 8235812
<span class="line-modified">  39  * 8216332 8214245 8237599 8241055</span>
  40  *
  41  * @library /test/lib
  42  * @library /lib/testlibrary/java/lang
  43  * @build jdk.test.lib.RandomFactory
  44  * @run main RegExTest
  45  * @key randomness
  46  */
  47 
  48 import java.io.BufferedReader;
  49 import java.io.ByteArrayInputStream;
  50 import java.io.ByteArrayOutputStream;
  51 import java.io.File;
  52 import java.io.FileInputStream;
  53 import java.io.InputStreamReader;
  54 import java.io.ObjectInputStream;
  55 import java.io.ObjectOutputStream;
  56 import java.math.BigInteger;
  57 import java.nio.CharBuffer;
  58 import java.nio.file.Files;
  59 import java.nio.file.Path;
</pre>
<hr />
<pre>
4780 
4781     // This test is for 8158482
4782     private static void embeddedFlags() throws Exception {
4783         try {
4784             Pattern.compile(&quot;(?i).(?-i).&quot;);
4785             Pattern.compile(&quot;(?m).(?-m).&quot;);
4786             Pattern.compile(&quot;(?s).(?-s).&quot;);
4787             Pattern.compile(&quot;(?d).(?-d).&quot;);
4788             Pattern.compile(&quot;(?u).(?-u).&quot;);
4789             Pattern.compile(&quot;(?c).(?-c).&quot;);
4790             Pattern.compile(&quot;(?x).(?-x).&quot;);
4791             Pattern.compile(&quot;(?U).(?-U).&quot;);
4792             Pattern.compile(&quot;(?imsducxU).(?-imsducxU).&quot;);
4793         } catch (PatternSyntaxException x) {
4794             failCount++;
4795         }
4796         report(&quot;Embedded flags&quot;);
4797     }
4798 
4799     private static void grapheme() throws Exception {
<span class="line-added">4800         final int[] lineNumber = new int[1];</span>
4801         Stream.concat(Files.lines(UCDFiles.GRAPHEME_BREAK_TEST),
4802                 Files.lines(Paths.get(System.getProperty(&quot;test.src&quot;, &quot;.&quot;), &quot;GraphemeTestCases.txt&quot;)))

4803             .forEach( ln -&gt; {
<span class="line-modified">4804                     lineNumber[0]++;</span>
<span class="line-modified">4805                     if (ln.length() == 0 || ln.startsWith(&quot;#&quot;)) {</span>
<span class="line-modified">4806                         return;</span>














4807                     }
<span class="line-modified">4808                     ln = ln.replaceAll(&quot;\\s+|\\([a-zA-Z]+\\)|\\[[a-zA-Z]]+\\]|#.*&quot;, &quot;&quot;);</span>
<span class="line-modified">4809                     // System.out.println(str);</span>
<span class="line-modified">4810                     String[] strs = ln.split(&quot;\u00f7|\u00d7&quot;);</span>
<span class="line-modified">4811                     StringBuilder src = new StringBuilder();</span>
<span class="line-modified">4812                     ArrayList&lt;String&gt; graphemes = new ArrayList&lt;&gt;();</span>
<span class="line-modified">4813                     StringBuilder buf = new StringBuilder();</span>
<span class="line-modified">4814                     int offBk = 0;</span>
<span class="line-modified">4815                     for (String str : strs) {</span>
<span class="line-modified">4816                         if (str.length() == 0)  // first empty str</span>
<span class="line-added">4817                             continue;</span>
<span class="line-added">4818                         int cp = Integer.parseInt(str, 16);</span>
<span class="line-added">4819                         src.appendCodePoint(cp);</span>
<span class="line-added">4820                         buf.appendCodePoint(cp);</span>
<span class="line-added">4821                         offBk += (str.length() + 1);</span>
<span class="line-added">4822                         if (ln.charAt(offBk) == &#39;\u00f7&#39;) {    // DIV</span>
<span class="line-added">4823                             graphemes.add(buf.toString());</span>
<span class="line-added">4824                             buf = new StringBuilder();</span>
<span class="line-added">4825                         }</span>
<span class="line-added">4826                     }</span>
<span class="line-added">4827                     Pattern p = Pattern.compile(&quot;\\X&quot;);</span>
<span class="line-added">4828                     // (1) test \X directly</span>
<span class="line-added">4829                     Matcher m = p.matcher(src.toString());</span>
<span class="line-added">4830                     for (String g : graphemes) {</span>
<span class="line-added">4831                         // System.out.printf(&quot;     grapheme:=[%s]%n&quot;, g);</span>
<span class="line-added">4832                         String group = null;</span>
<span class="line-added">4833                         if (!m.find() || !(group = m.group()).equals(g)) {</span>
<span class="line-added">4834                             System.out.println(&quot;Failed pattern \\X [&quot; + ln + &quot;] : &quot;</span>
<span class="line-added">4835                                     + &quot;expected: &quot; + g + &quot; - actual: &quot; + group</span>
<span class="line-added">4836                                     + &quot;(line &quot; + lineNumber[0] + &quot;)&quot;);</span>
<span class="line-added">4837                             failCount++;</span>
<span class="line-added">4838                         }</span>
<span class="line-added">4839                     }</span>
<span class="line-added">4840                     if (m.find()) {</span>
<span class="line-added">4841                         failCount++;</span>
<span class="line-added">4842                     }</span>
<span class="line-added">4843                     // test \b{g} without \X via Pattern</span>
<span class="line-added">4844                     Pattern pbg = Pattern.compile(&quot;\\b{g}&quot;);</span>
<span class="line-added">4845                     m = pbg.matcher(src.toString());</span>
<span class="line-added">4846                     m.find();</span>
<span class="line-added">4847                     int prev = m.end();</span>
<span class="line-added">4848                     for (String g : graphemes) {</span>
<span class="line-added">4849                         String group = null;</span>
<span class="line-added">4850                         if (!m.find() || !(group = src.substring(prev, m.end())).equals(g)) {</span>
<span class="line-added">4851                             System.out.println(&quot;Failed pattern \\b{g} [&quot; + ln + &quot;] : &quot;</span>
<span class="line-added">4852                                     + &quot;expected: &quot; + g + &quot; - actual: &quot; + group</span>
<span class="line-added">4853                                     + &quot;(line &quot; + lineNumber[0] + &quot;)&quot;);</span>
<span class="line-added">4854                             failCount++;</span>
<span class="line-added">4855                         }</span>
<span class="line-added">4856                         if (!&quot;&quot;.equals(m.group())) {</span>
<span class="line-added">4857                             failCount++;</span>
<span class="line-added">4858                         }</span>
<span class="line-added">4859                         prev = m.end();</span>
<span class="line-added">4860                     }</span>
<span class="line-added">4861                     if (m.find()) {</span>
4862                         failCount++;
4863                     }
<span class="line-modified">4864                     // (2) test \b{g} + \X  via Scanner</span>
<span class="line-modified">4865                     Scanner s = new Scanner(src.toString()).useDelimiter(&quot;\\b{g}&quot;);</span>
<span class="line-modified">4866                     for (String g : graphemes) {</span>
<span class="line-modified">4867                         String next = null;</span>
<span class="line-modified">4868                         if (!s.hasNext(p) || !(next = s.next(p)).equals(g)) {</span>
<span class="line-added">4869                             System.out.println(&quot;Failed \\b{g} [&quot; + ln + &quot;] : &quot;</span>
<span class="line-added">4870                                     + &quot;expected: &quot; + g + &quot; - actual: &quot; + next</span>
<span class="line-added">4871                                     + &quot; (line &quot; + lineNumber[0] + &quot;)&quot;);</span>
<span class="line-added">4872                             failCount++;</span>
<span class="line-added">4873                         }</span>
<span class="line-added">4874                     }</span>
<span class="line-added">4875                     if (s.hasNext(p)) {</span>
4876                         failCount++;
4877                     }
<span class="line-modified">4878                     // test \b{g} without \X via Scanner</span>
<span class="line-modified">4879                     s = new Scanner(src.toString()).useDelimiter(&quot;\\b{g}&quot;);</span>
<span class="line-added">4880                     for (String g : graphemes) {</span>
<span class="line-added">4881                         String next = null;</span>
<span class="line-added">4882                         if (!s.hasNext() || !(next = s.next()).equals(g)) {</span>
<span class="line-added">4883                             System.out.println(&quot;Failed \\b{g} [&quot; + ln + &quot;] : &quot;</span>
<span class="line-added">4884                                     + &quot;expected: &quot; + g + &quot; - actual: &quot; + next</span>
<span class="line-added">4885                                     + &quot; (line &quot; + lineNumber[0] + &quot;)&quot;);</span>
<span class="line-added">4886                             failCount++;</span>
<span class="line-added">4887                         }</span>
<span class="line-added">4888                     }</span>
<span class="line-added">4889                     if (s.hasNext()) {</span>
<span class="line-added">4890                         failCount++;</span>
<span class="line-added">4891                     }</span>
<span class="line-added">4892                 });</span>
4893         // some sanity checks
4894         if (!Pattern.compile(&quot;\\X{10}&quot;).matcher(&quot;abcdefghij&quot;).matches() ||
4895             !Pattern.compile(&quot;\\b{g}(?:\\X\\b{g}){5}\\b{g}&quot;).matcher(&quot;abcde&quot;).matches() ||
4896             !Pattern.compile(&quot;(?:\\X\\b{g}){2}&quot;).matcher(&quot;\ud800\udc00\ud801\udc02&quot;).matches())
4897             failCount++;
4898         // make sure &quot;\b{n}&quot; still works
4899         if (!Pattern.compile(&quot;\\b{1}hello\\b{1} \\b{1}world\\b{1}&quot;).matcher(&quot;hello world&quot;).matches())
4900             failCount++;
4901         report(&quot;Unicode extended grapheme cluster&quot;);
4902     }
4903 
4904     // hangup/timeout if go into exponential backtracking
4905     private static void expoBacktracking() throws Exception {
4906 
4907         Object[][] patternMatchers = {
4908             // 6328855
4909             { &quot;(.*\n*)*&quot;,
4910               &quot;this little fine string lets\r\njava.lang.String.matches\r\ncrash\r\n(We don&#39;t know why but adding \r* to the regex makes it work again)&quot;,
4911               false },
4912             // 6192895
</pre>
</td>
</tr>
</table>
<center><a href="../../security/Policy/SignedJar/SignedJarTest.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="../../../javax/script/Helper.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>