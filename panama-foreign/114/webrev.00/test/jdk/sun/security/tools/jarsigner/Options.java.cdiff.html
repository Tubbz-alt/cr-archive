<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff test/jdk/sun/security/tools/jarsigner/Options.java</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
  </head>
<body>
<center><a href="../../ssl/SSLEngineImpl/EngineEnforceUseClientMode.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="../../../tools/jps/LingeredAppForJps.java.cdiff.html" target="_top">next &gt;</a></center>    <h2>test/jdk/sun/security/tools/jarsigner/Options.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 1,7 ***</span>
  /*
<span class="line-modified">!  * Copyright (c) 2015, 2017, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
<span class="line-new-header">--- 1,7 ---</span>
  /*
<span class="line-modified">!  * Copyright (c) 2015, 2020, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
</pre>
<hr />
<pre>
<span class="line-old-header">*** 21,74 ***</span>
   * questions.
   */
  
  /**
   * @test
<span class="line-modified">!  * @bug 8056174</span>
   * @summary Make sure the jarsigner tool still works after it&#39;s modified to
   *          be based on JarSigner API
   * @library /test/lib
<span class="line-modified">!  * @modules java.base/sun.security.tools.keytool</span>
<span class="line-removed">-  *          jdk.jartool/sun.security.tools.jarsigner</span>
<span class="line-removed">-  *          java.base/sun.security.pkcs</span>
   *          java.base/sun.security.x509
<span class="line-removed">-  * @build jdk.test.lib.util.JarUtils</span>
<span class="line-removed">-  * @run main Options</span>
   */
  
  import com.sun.jarsigner.ContentSigner;
  import com.sun.jarsigner.ContentSignerParameters;
  import jdk.test.lib.util.JarUtils;
  import sun.security.pkcs.PKCS7;
  
  import java.io.ByteArrayInputStream;
<span class="line-removed">- import java.io.IOException;</span>
  import java.io.InputStream;
  import java.nio.file.Files;
<span class="line-modified">! import java.nio.file.Paths;</span>
<span class="line-removed">- import java.security.NoSuchAlgorithmException;</span>
<span class="line-removed">- import java.security.cert.CertificateException;</span>
  import java.util.*;
  import java.util.jar.Attributes;
  import java.util.jar.JarEntry;
  import java.util.jar.JarFile;
  import java.util.jar.Manifest;
  
  public class Options {
  
      public static void main(String[] args) throws Exception {
  
          // Prepares raw file
<span class="line-modified">!         Files.write(Paths.get(&quot;a&quot;), List.of(&quot;a&quot;));</span>
  
          // Pack
<span class="line-modified">!         JarUtils.createJar(&quot;a.jar&quot;, &quot;a&quot;);</span>
  
          // Prepare a keystore
<span class="line-modified">!         sun.security.tools.keytool.Main.main(</span>
<span class="line-modified">!                 (&quot;-keystore jks -storepass changeit -keypass changeit -dname&quot; +</span>
<span class="line-modified">!                         &quot; CN=A -alias a -genkeypair -keyalg rsa&quot;).split(&quot; &quot;));</span>
  
          // -altsign
<span class="line-modified">!         sun.security.tools.jarsigner.Main.main(</span>
<span class="line-modified">!                 (&quot;-debug -signedjar altsign.jar -keystore jks -storepass changeit&quot; +</span>
<span class="line-modified">!                         &quot; -altsigner Options$X a.jar a&quot;).split(&quot; &quot;));</span>
  
          try (JarFile jf = new JarFile(&quot;altsign.jar&quot;)) {
              JarEntry je = jf.getJarEntry(&quot;META-INF/A.RSA&quot;);
              try (InputStream is = jf.getInputStream(je)) {
                  if (!Arrays.equals(is.readAllBytes(), &quot;1234&quot;.getBytes())) {
                      throw new Exception(&quot;altsign go wrong&quot;);
                  }
              }
          }
  
          // -sigfile, -digestalg, -sigalg, -internalsf, -sectionsonly
<span class="line-modified">!         sun.security.tools.jarsigner.Main.main(</span>
<span class="line-modified">!                 (&quot;-debug -signedjar new.jar -keystore jks -storepass changeit&quot; +</span>
                  &quot; -sigfile olala -digestalg SHA1 -sigalg SHA224withRSA&quot; +
<span class="line-modified">!                 &quot; -internalsf -sectionsonly a.jar a&quot;).split(&quot; &quot;));</span>
  
          try (JarFile jf = new JarFile(&quot;new.jar&quot;)) {
              JarEntry je = jf.getJarEntry(&quot;META-INF/OLALA.SF&quot;);
              Objects.requireNonNull(je);     // check -sigfile
              byte[] sf = null;               // content of .SF
<span class="line-new-header">--- 21,103 ---</span>
   * questions.
   */
  
  /**
   * @test
<span class="line-modified">!  * @bug 8056174 8242260</span>
   * @summary Make sure the jarsigner tool still works after it&#39;s modified to
   *          be based on JarSigner API
   * @library /test/lib
<span class="line-modified">!  * @modules java.base/sun.security.pkcs</span>
   *          java.base/sun.security.x509
   */
  
  import com.sun.jarsigner.ContentSigner;
  import com.sun.jarsigner.ContentSignerParameters;
<span class="line-added">+ import jdk.test.lib.Asserts;</span>
<span class="line-added">+ import jdk.test.lib.SecurityTools;</span>
  import jdk.test.lib.util.JarUtils;
  import sun.security.pkcs.PKCS7;
  
  import java.io.ByteArrayInputStream;
  import java.io.InputStream;
  import java.nio.file.Files;
<span class="line-modified">! import java.nio.file.Path;</span>
  import java.util.*;
  import java.util.jar.Attributes;
  import java.util.jar.JarEntry;
  import java.util.jar.JarFile;
  import java.util.jar.Manifest;
  
  public class Options {
  
      public static void main(String[] args) throws Exception {
  
<span class="line-added">+         // Help</span>
<span class="line-added">+         boolean lastLineHasAltSigner = false;</span>
<span class="line-added">+         for (String line : SecurityTools.jarsigner(&quot;--help&quot;).asLines()) {</span>
<span class="line-added">+             if (line.contains(&quot;-altsigner&quot;)) {</span>
<span class="line-added">+                 lastLineHasAltSigner = true;</span>
<span class="line-added">+             } else {</span>
<span class="line-added">+                 if (lastLineHasAltSigner) {</span>
<span class="line-added">+                     Asserts.assertTrue(line.contains(&quot;deprecated and will be removed&quot;));</span>
<span class="line-added">+                 }</span>
<span class="line-added">+                 lastLineHasAltSigner = false;</span>
<span class="line-added">+             }</span>
<span class="line-added">+         }</span>
<span class="line-added">+ </span>
          // Prepares raw file
<span class="line-modified">!         Files.write(Path.of(&quot;a&quot;), List.of(&quot;a&quot;));</span>
  
          // Pack
<span class="line-modified">!         JarUtils.createJarFile(Path.of(&quot;a.jar&quot;), Path.of(&quot;.&quot;), Path.of(&quot;a&quot;));</span>
  
          // Prepare a keystore
<span class="line-modified">!         SecurityTools.keytool(</span>
<span class="line-modified">!                 &quot;-keystore jks -storepass changeit -keypass changeit -dname&quot; +</span>
<span class="line-modified">!                         &quot; CN=A -alias a -genkeypair -keyalg rsa&quot;)</span>
<span class="line-added">+                 .shouldHaveExitValue(0);</span>
  
          // -altsign
<span class="line-modified">!         SecurityTools.jarsigner(</span>
<span class="line-modified">!                 &quot;-debug -signedjar altsign.jar -keystore jks -storepass changeit&quot; +</span>
<span class="line-modified">!                         &quot; -altsigner Options$X&quot; +</span>
<span class="line-added">+                         &quot; -altsignerpath &quot; + System.getProperty(&quot;test.classes&quot;) +</span>
<span class="line-added">+                         &quot; a.jar a&quot;)</span>
<span class="line-added">+                 .shouldContain(&quot;removed in a future release: -altsigner&quot;)</span>
<span class="line-added">+                 .shouldContain(&quot;removed in a future release: -altsignerpath&quot;)</span>
<span class="line-added">+                 .shouldContain(&quot;PKCS7.parse&quot;);  // signature not parseable</span>
<span class="line-added">+                                                 // but signing succeeds</span>
  
          try (JarFile jf = new JarFile(&quot;altsign.jar&quot;)) {
              JarEntry je = jf.getJarEntry(&quot;META-INF/A.RSA&quot;);
              try (InputStream is = jf.getInputStream(je)) {
                  if (!Arrays.equals(is.readAllBytes(), &quot;1234&quot;.getBytes())) {
                      throw new Exception(&quot;altsign go wrong&quot;);
                  }
              }
          }
  
<span class="line-added">+         // -altsign with no -altsignerpath</span>
<span class="line-added">+         Files.copy(Path.of(System.getProperty(&quot;test.classes&quot;), &quot;Options$X.class&quot;),</span>
<span class="line-added">+                 Path.of(&quot;Options$X.class&quot;));</span>
<span class="line-added">+         SecurityTools.jarsigner(</span>
<span class="line-added">+                 &quot;-debug -signedjar altsign.jar -keystore jks -storepass changeit&quot; +</span>
<span class="line-added">+                         &quot; -altsigner Options$X&quot; +</span>
<span class="line-added">+                         &quot; a.jar a&quot;)</span>
<span class="line-added">+                 .shouldContain(&quot;removed in a future release: -altsigner&quot;)</span>
<span class="line-added">+                 .shouldNotContain(&quot;removed in a future release: -altsignerpath&quot;)</span>
<span class="line-added">+                 .shouldContain(&quot;PKCS7.parse&quot;);  // signature not parseable</span>
<span class="line-added">+                                                 // but signing succeeds</span>
<span class="line-added">+ </span>
          // -sigfile, -digestalg, -sigalg, -internalsf, -sectionsonly
<span class="line-modified">!         SecurityTools.jarsigner(</span>
<span class="line-modified">!                 &quot;-debug -signedjar new.jar -keystore jks -storepass changeit&quot; +</span>
                  &quot; -sigfile olala -digestalg SHA1 -sigalg SHA224withRSA&quot; +
<span class="line-modified">!                 &quot; -internalsf -sectionsonly a.jar a&quot;)</span>
<span class="line-added">+                 .shouldHaveExitValue(0)</span>
<span class="line-added">+                 .shouldNotContain(&quot;Exception&quot;);     // a real success</span>
  
          try (JarFile jf = new JarFile(&quot;new.jar&quot;)) {
              JarEntry je = jf.getJarEntry(&quot;META-INF/OLALA.SF&quot;);
              Objects.requireNonNull(je);     // check -sigfile
              byte[] sf = null;               // content of .SF
</pre>
<hr />
<pre>
<span class="line-old-header">*** 128,12 ***</span>
      }
  
      public static class X extends ContentSigner {
          @Override
          public byte[] generateSignedData(ContentSignerParameters parameters,
<span class="line-modified">!                 boolean omitContent, boolean applyTimestamp)</span>
<span class="line-removed">-                 throws NoSuchAlgorithmException, CertificateException,</span>
<span class="line-removed">-                         IOException {</span>
              return &quot;1234&quot;.getBytes();
          }
      }
  }
<span class="line-new-header">--- 157,10 ---</span>
      }
  
      public static class X extends ContentSigner {
          @Override
          public byte[] generateSignedData(ContentSignerParameters parameters,
<span class="line-modified">!                 boolean omitContent, boolean applyTimestamp) {</span>
              return &quot;1234&quot;.getBytes();
          }
      }
  }
</pre>
<center><a href="../../ssl/SSLEngineImpl/EngineEnforceUseClientMode.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="../../../tools/jps/LingeredAppForJps.java.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>