<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff test/hotspot/jtreg/runtime/exceptionMsgs/NullPointerException/NullPointerExceptionTest.java</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
  </head>
<body>
<center><a href="../../cds/appcds/test-classes/JimageClassProtDomain.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="../../../serviceability/sa/ClhsdbPmap.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>test/hotspot/jtreg/runtime/exceptionMsgs/NullPointerException/NullPointerExceptionTest.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
   1 /*
<span class="line-modified">   2  * Copyright (c) 2019, Oracle and/or its affiliates. All rights reserved.</span>
   3  * Copyright (c) 2019 SAP SE. All rights reserved.
   4  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   5  *
   6  * This code is free software; you can redistribute it and/or modify it
   7  * under the terms of the GNU General Public License version 2 only, as
   8  * published by the Free Software Foundation.
   9  *
  10  * This code is distributed in the hope that it will be useful, but WITHOUT
  11  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  12  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  13  * version 2 for more details (a copy is included in the LICENSE file that
  14  * accompanied this code).
  15  *
  16  * You should have received a copy of the GNU General Public License version
  17  * 2 along with this work; if not, write to the Free Software Foundation,
  18  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  19  *
  20  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  21  * or visit www.oracle.com if you need additional information or have any
  22  * questions.
  23  */
  24 
  25 /**
  26  * @test

  27  * @summary Test extended NullPointerException message for
  28  *   classfiles generated with debug information. In this case the name
  29  *   of the variable containing the array is printed.
  30  * @bug 8218628
  31  * @modules java.base/java.lang:open
  32  *          java.base/jdk.internal.org.objectweb.asm
  33  * @library /test/lib
  34  * @compile -g NullPointerExceptionTest.java
  35  * @run main/othervm -XX:MaxJavaStackTraceDepth=1 -XX:+ShowCodeDetailsInExceptionMessages NullPointerExceptionTest hasDebugInfo
  36  */
  37 /**
  38  * @test

  39  * @summary Test extended NullPointerException message for class
  40  *   files generated without debugging information. The message lists
  41  *   detailed information about the entity that is null.
  42  * @bug 8218628
  43  * @modules java.base/java.lang:open
  44  *          java.base/jdk.internal.org.objectweb.asm
  45  * @library /test/lib
  46  * @compile NullPointerExceptionTest.java
  47  * @run main/othervm -XX:MaxJavaStackTraceDepth=1 -XX:+ShowCodeDetailsInExceptionMessages NullPointerExceptionTest
  48  */
  49 
  50 import java.io.ByteArrayInputStream;
  51 import java.io.ByteArrayOutputStream;
  52 import java.io.ObjectInputStream;
  53 import java.io.ObjectOutputStream;
  54 import java.lang.invoke.MethodHandles.Lookup;
  55 import java.util.ArrayList;

  56 
  57 import jdk.internal.org.objectweb.asm.ClassWriter;
  58 import jdk.internal.org.objectweb.asm.Label;
  59 import jdk.internal.org.objectweb.asm.MethodVisitor;
  60 import jdk.test.lib.Asserts;

  61 
  62 import static java.lang.invoke.MethodHandles.lookup;
  63 import static jdk.internal.org.objectweb.asm.Opcodes.ACC_PUBLIC;
  64 import static jdk.internal.org.objectweb.asm.Opcodes.ACC_SUPER;
  65 import static jdk.internal.org.objectweb.asm.Opcodes.ACONST_NULL;
  66 import static jdk.internal.org.objectweb.asm.Opcodes.ALOAD;
  67 import static jdk.internal.org.objectweb.asm.Opcodes.ASTORE;
  68 import static jdk.internal.org.objectweb.asm.Opcodes.GETFIELD;
  69 import static jdk.internal.org.objectweb.asm.Opcodes.GETSTATIC;
  70 import static jdk.internal.org.objectweb.asm.Opcodes.ICONST_1;
  71 import static jdk.internal.org.objectweb.asm.Opcodes.ICONST_2;
  72 import static jdk.internal.org.objectweb.asm.Opcodes.INVOKESPECIAL;
  73 import static jdk.internal.org.objectweb.asm.Opcodes.INVOKEVIRTUAL;
  74 import static jdk.internal.org.objectweb.asm.Opcodes.ARETURN;
  75 import static jdk.internal.org.objectweb.asm.Opcodes.IRETURN;
  76 import static jdk.internal.org.objectweb.asm.Opcodes.RETURN;
  77 
  78 /**
  79  * Tests NullPointerExceptions
  80  */
  81 public class NullPointerExceptionTest {
  82 
  83     // Some fields used in the test.
  84     static Object nullStaticField;
  85     NullPointerExceptionTest nullInstanceField;
  86     static int[][][][] staticArray;
  87     static long[][] staticLongArray = new long[1000][];
  88     DoubleArrayGen dag;
  89     ArrayList&lt;String&gt; names = new ArrayList&lt;&gt;();
  90     ArrayList&lt;String&gt; curr;
  91     static boolean hasDebugInfo = false;

  92 
  93     static {
  94         staticArray       = new int[1][][][];
  95         staticArray[0]    = new int[1][][];
  96         staticArray[0][0] = new int[1][];
  97     }
  98 
  99     public static void checkMessage(Throwable t, String expression,
 100                                     String obtainedMsg, String expectedMsg) {
 101         System.out.println(&quot;\nSource code:\n  &quot; + expression + &quot;\n\nOutput:&quot;);
 102         t.printStackTrace(System.out);
 103         if (obtainedMsg != expectedMsg &amp;&amp; // E.g. both are null.
 104             !obtainedMsg.equals(expectedMsg)) {
 105             System.out.println(&quot;expected msg: &quot; + expectedMsg);
 106             Asserts.assertEquals(expectedMsg, obtainedMsg);
 107         }
 108         System.out.println(&quot;\n----&quot;);
 109     }
 110 
 111     public static void main(String[] args) throws Exception {
</pre>
<hr />
<pre>
1404         }
1405 
1406         try {
1407             int indexes[] = new int[1];
1408             NullPointerExceptionTest[][] objs =
1409                 new NullPointerExceptionTest[][] {new NullPointerExceptionTest[] {this}};
1410             synchronized (objs[indexes[0]][0].nullInstanceField) {
1411                 Asserts.fail();
1412             }
1413         } catch (NullPointerException e) {
1414             checkMessage(e, &quot;synchronized (objs[indexes[0]][0].nullInstanceField) { ... }&quot;, e.getMessage(),
1415                          &quot;Cannot enter synchronized block because &quot; +
1416                          (hasDebugInfo ? &quot;\&quot;objs[indexes&quot; : &quot;\&quot;&lt;local2&gt;[&lt;local1&gt;&quot; ) + &quot;[0]][0].nullInstanceField\&quot; is null&quot;);
1417         }
1418 
1419         try {
1420             // If we can get the value from more than one bci, we cannot know which one
1421             // is null. Make sure we don&#39;t print the wrong value.
1422             String s = null;
1423             @SuppressWarnings(&quot;unused&quot;)
<span class="line-modified">1424             byte[] val = (Math.random() &lt; 0.5 ? s : (new String[1])[0]).getBytes();</span>
1425         } catch (NullPointerException e) {
<span class="line-modified">1426             checkMessage(e, &quot;byte[] val = (Math.random() &lt; 0.5 ? s : (new String[1])[0]).getBytes();&quot;, e.getMessage(),</span>
1427                          &quot;Cannot invoke \&quot;String.getBytes()\&quot;&quot;);
1428         }
1429 
1430         try {
1431             // If we can get the value from more than one bci, we cannot know which one
1432             // is null. Make sure we don&#39;t print the wrong value.  Also make sure if
1433             // we don&#39;t print the failed action we don&#39;t print a string at all.
1434             int[][] a = new int[1][];
1435             int[][] b = new int[2][];
1436             long index = 0;
1437             @SuppressWarnings(&quot;unused&quot;)
<span class="line-modified">1438             int val = (Math.random() &lt; 0.5 ? a[(int)index] : b[(int)index])[13];</span>
1439         } catch (NullPointerException e) {
<span class="line-modified">1440             checkMessage(e, &quot;int val = (Math.random() &lt; 0.5 ? a[(int)index] : b[(int)index])[13]&quot;, e.getMessage(),</span>
1441                          &quot;Cannot load from int array&quot;);
1442         }
1443 
1444         try {
1445             // If we can get the value from more than one bci, we cannot know which one
1446             // is null. Make sure we don&#39;t print the wrong value.  Also make sure if
1447             // we don&#39;t print the failed action we don&#39;t print a string at all.
1448             int[][] a = new int[1][];
1449             int[][] b = new int[2][];
1450             long index = 0;
<span class="line-modified">1451             int val = (Math.random() &lt; 0.5 ? a : b)[(int)index][13];</span>
1452         } catch (NullPointerException e) {
<span class="line-modified">1453             checkMessage(e, &quot;int val = (Math.random() &lt; 0.5 ? a : b)[(int)index][13]&quot;, e.getMessage(),</span>
1454                          &quot;Cannot load from int array because \&quot;&lt;array&gt;[...]\&quot; is null&quot;);
1455         }
1456 
1457         try {
1458             C c1 = new C();
1459             C c2 = new C();
<span class="line-modified">1460             (Math.random() &lt; 0.5 ? c1 : c2).to_d.num = 77;</span>
1461         } catch (NullPointerException e) {
<span class="line-modified">1462             checkMessage(e, &quot;(Math.random() &lt; 0.5 ? c1 : c2).to_d.num = 77;&quot;, e.getMessage(),</span>
1463                          &quot;Cannot assign field \&quot;num\&quot; because \&quot;to_d\&quot; is null&quot;);
1464         }
1465 
1466         // Static variable as array index.
1467         try {
1468             staticLongArray[index17][0] = 2L;
1469         }  catch (NullPointerException e) {
1470             checkMessage(e, &quot;staticLongArray[index17][0] = 2L;&quot;,  e.getMessage(),
1471                          &quot;Cannot store to long array because &quot; +
1472                          &quot;\&quot;NullPointerExceptionTest.staticLongArray[NullPointerExceptionTest.index17]\&quot; is null&quot;);
1473         }
1474 
1475         // Method call as array index.
1476         try {
1477             staticLongArray[getIndex17()][0] = 2L;
1478         }  catch (NullPointerException e) {
1479             checkMessage(e, &quot;staticLongArray[getIndex17()][0] = 2L;&quot;,  e.getMessage(),
1480                          &quot;Cannot store to long array because &quot; +
1481                          &quot;\&quot;NullPointerExceptionTest.staticLongArray[NullPointerExceptionTest.getIndex17()]\&quot; is null&quot;);
1482         }
</pre>
</td>
<td>
<hr />
<pre>
   1 /*
<span class="line-modified">   2  * Copyright (c) 2019, 2020, Oracle and/or its affiliates. All rights reserved.</span>
   3  * Copyright (c) 2019 SAP SE. All rights reserved.
   4  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   5  *
   6  * This code is free software; you can redistribute it and/or modify it
   7  * under the terms of the GNU General Public License version 2 only, as
   8  * published by the Free Software Foundation.
   9  *
  10  * This code is distributed in the hope that it will be useful, but WITHOUT
  11  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  12  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  13  * version 2 for more details (a copy is included in the LICENSE file that
  14  * accompanied this code).
  15  *
  16  * You should have received a copy of the GNU General Public License version
  17  * 2 along with this work; if not, write to the Free Software Foundation,
  18  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  19  *
  20  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  21  * or visit www.oracle.com if you need additional information or have any
  22  * questions.
  23  */
  24 
  25 /**
  26  * @test
<span class="line-added">  27  * @key randomness</span>
  28  * @summary Test extended NullPointerException message for
  29  *   classfiles generated with debug information. In this case the name
  30  *   of the variable containing the array is printed.
  31  * @bug 8218628
  32  * @modules java.base/java.lang:open
  33  *          java.base/jdk.internal.org.objectweb.asm
  34  * @library /test/lib
  35  * @compile -g NullPointerExceptionTest.java
  36  * @run main/othervm -XX:MaxJavaStackTraceDepth=1 -XX:+ShowCodeDetailsInExceptionMessages NullPointerExceptionTest hasDebugInfo
  37  */
  38 /**
  39  * @test
<span class="line-added">  40  * @key randomness</span>
  41  * @summary Test extended NullPointerException message for class
  42  *   files generated without debugging information. The message lists
  43  *   detailed information about the entity that is null.
  44  * @bug 8218628
  45  * @modules java.base/java.lang:open
  46  *          java.base/jdk.internal.org.objectweb.asm
  47  * @library /test/lib
  48  * @compile NullPointerExceptionTest.java
  49  * @run main/othervm -XX:MaxJavaStackTraceDepth=1 -XX:+ShowCodeDetailsInExceptionMessages NullPointerExceptionTest
  50  */
  51 
  52 import java.io.ByteArrayInputStream;
  53 import java.io.ByteArrayOutputStream;
  54 import java.io.ObjectInputStream;
  55 import java.io.ObjectOutputStream;
  56 import java.lang.invoke.MethodHandles.Lookup;
  57 import java.util.ArrayList;
<span class="line-added">  58 import java.util.Random;</span>
  59 
  60 import jdk.internal.org.objectweb.asm.ClassWriter;
  61 import jdk.internal.org.objectweb.asm.Label;
  62 import jdk.internal.org.objectweb.asm.MethodVisitor;
  63 import jdk.test.lib.Asserts;
<span class="line-added">  64 import jdk.test.lib.Utils;</span>
  65 
  66 import static java.lang.invoke.MethodHandles.lookup;
  67 import static jdk.internal.org.objectweb.asm.Opcodes.ACC_PUBLIC;
  68 import static jdk.internal.org.objectweb.asm.Opcodes.ACC_SUPER;
  69 import static jdk.internal.org.objectweb.asm.Opcodes.ACONST_NULL;
  70 import static jdk.internal.org.objectweb.asm.Opcodes.ALOAD;
  71 import static jdk.internal.org.objectweb.asm.Opcodes.ASTORE;
  72 import static jdk.internal.org.objectweb.asm.Opcodes.GETFIELD;
  73 import static jdk.internal.org.objectweb.asm.Opcodes.GETSTATIC;
  74 import static jdk.internal.org.objectweb.asm.Opcodes.ICONST_1;
  75 import static jdk.internal.org.objectweb.asm.Opcodes.ICONST_2;
  76 import static jdk.internal.org.objectweb.asm.Opcodes.INVOKESPECIAL;
  77 import static jdk.internal.org.objectweb.asm.Opcodes.INVOKEVIRTUAL;
  78 import static jdk.internal.org.objectweb.asm.Opcodes.ARETURN;
  79 import static jdk.internal.org.objectweb.asm.Opcodes.IRETURN;
  80 import static jdk.internal.org.objectweb.asm.Opcodes.RETURN;
  81 
  82 /**
  83  * Tests NullPointerExceptions
  84  */
  85 public class NullPointerExceptionTest {
  86 
  87     // Some fields used in the test.
  88     static Object nullStaticField;
  89     NullPointerExceptionTest nullInstanceField;
  90     static int[][][][] staticArray;
  91     static long[][] staticLongArray = new long[1000][];
  92     DoubleArrayGen dag;
  93     ArrayList&lt;String&gt; names = new ArrayList&lt;&gt;();
  94     ArrayList&lt;String&gt; curr;
  95     static boolean hasDebugInfo = false;
<span class="line-added">  96     static final Random rng = Utils.getRandomInstance();</span>
  97 
  98     static {
  99         staticArray       = new int[1][][][];
 100         staticArray[0]    = new int[1][][];
 101         staticArray[0][0] = new int[1][];
 102     }
 103 
 104     public static void checkMessage(Throwable t, String expression,
 105                                     String obtainedMsg, String expectedMsg) {
 106         System.out.println(&quot;\nSource code:\n  &quot; + expression + &quot;\n\nOutput:&quot;);
 107         t.printStackTrace(System.out);
 108         if (obtainedMsg != expectedMsg &amp;&amp; // E.g. both are null.
 109             !obtainedMsg.equals(expectedMsg)) {
 110             System.out.println(&quot;expected msg: &quot; + expectedMsg);
 111             Asserts.assertEquals(expectedMsg, obtainedMsg);
 112         }
 113         System.out.println(&quot;\n----&quot;);
 114     }
 115 
 116     public static void main(String[] args) throws Exception {
</pre>
<hr />
<pre>
1409         }
1410 
1411         try {
1412             int indexes[] = new int[1];
1413             NullPointerExceptionTest[][] objs =
1414                 new NullPointerExceptionTest[][] {new NullPointerExceptionTest[] {this}};
1415             synchronized (objs[indexes[0]][0].nullInstanceField) {
1416                 Asserts.fail();
1417             }
1418         } catch (NullPointerException e) {
1419             checkMessage(e, &quot;synchronized (objs[indexes[0]][0].nullInstanceField) { ... }&quot;, e.getMessage(),
1420                          &quot;Cannot enter synchronized block because &quot; +
1421                          (hasDebugInfo ? &quot;\&quot;objs[indexes&quot; : &quot;\&quot;&lt;local2&gt;[&lt;local1&gt;&quot; ) + &quot;[0]][0].nullInstanceField\&quot; is null&quot;);
1422         }
1423 
1424         try {
1425             // If we can get the value from more than one bci, we cannot know which one
1426             // is null. Make sure we don&#39;t print the wrong value.
1427             String s = null;
1428             @SuppressWarnings(&quot;unused&quot;)
<span class="line-modified">1429             byte[] val = (rng.nextDouble() &lt; 0.5 ? s : (new String[1])[0]).getBytes();</span>
1430         } catch (NullPointerException e) {
<span class="line-modified">1431             checkMessage(e, &quot;byte[] val = (rng.nextDouble() &lt; 0.5 ? s : (new String[1])[0]).getBytes();&quot;, e.getMessage(),</span>
1432                          &quot;Cannot invoke \&quot;String.getBytes()\&quot;&quot;);
1433         }
1434 
1435         try {
1436             // If we can get the value from more than one bci, we cannot know which one
1437             // is null. Make sure we don&#39;t print the wrong value.  Also make sure if
1438             // we don&#39;t print the failed action we don&#39;t print a string at all.
1439             int[][] a = new int[1][];
1440             int[][] b = new int[2][];
1441             long index = 0;
1442             @SuppressWarnings(&quot;unused&quot;)
<span class="line-modified">1443             int val = (rng.nextDouble() &lt; 0.5 ? a[(int)index] : b[(int)index])[13];</span>
1444         } catch (NullPointerException e) {
<span class="line-modified">1445             checkMessage(e, &quot;int val = (rng.nextDouble() &lt; 0.5 ? a[(int)index] : b[(int)index])[13]&quot;, e.getMessage(),</span>
1446                          &quot;Cannot load from int array&quot;);
1447         }
1448 
1449         try {
1450             // If we can get the value from more than one bci, we cannot know which one
1451             // is null. Make sure we don&#39;t print the wrong value.  Also make sure if
1452             // we don&#39;t print the failed action we don&#39;t print a string at all.
1453             int[][] a = new int[1][];
1454             int[][] b = new int[2][];
1455             long index = 0;
<span class="line-modified">1456             int val = (rng.nextDouble() &lt; 0.5 ? a : b)[(int)index][13];</span>
1457         } catch (NullPointerException e) {
<span class="line-modified">1458             checkMessage(e, &quot;int val = (rng.nextDouble() &lt; 0.5 ? a : b)[(int)index][13]&quot;, e.getMessage(),</span>
1459                          &quot;Cannot load from int array because \&quot;&lt;array&gt;[...]\&quot; is null&quot;);
1460         }
1461 
1462         try {
1463             C c1 = new C();
1464             C c2 = new C();
<span class="line-modified">1465             (rng.nextDouble() &lt; 0.5 ? c1 : c2).to_d.num = 77;</span>
1466         } catch (NullPointerException e) {
<span class="line-modified">1467             checkMessage(e, &quot;(rng.nextDouble() &lt; 0.5 ? c1 : c2).to_d.num = 77;&quot;, e.getMessage(),</span>
1468                          &quot;Cannot assign field \&quot;num\&quot; because \&quot;to_d\&quot; is null&quot;);
1469         }
1470 
1471         // Static variable as array index.
1472         try {
1473             staticLongArray[index17][0] = 2L;
1474         }  catch (NullPointerException e) {
1475             checkMessage(e, &quot;staticLongArray[index17][0] = 2L;&quot;,  e.getMessage(),
1476                          &quot;Cannot store to long array because &quot; +
1477                          &quot;\&quot;NullPointerExceptionTest.staticLongArray[NullPointerExceptionTest.index17]\&quot; is null&quot;);
1478         }
1479 
1480         // Method call as array index.
1481         try {
1482             staticLongArray[getIndex17()][0] = 2L;
1483         }  catch (NullPointerException e) {
1484             checkMessage(e, &quot;staticLongArray[getIndex17()][0] = 2L;&quot;,  e.getMessage(),
1485                          &quot;Cannot store to long array because &quot; +
1486                          &quot;\&quot;NullPointerExceptionTest.staticLongArray[NullPointerExceptionTest.getIndex17()]\&quot; is null&quot;);
1487         }
</pre>
</td>
</tr>
</table>
<center><a href="../../cds/appcds/test-classes/JimageClassProtDomain.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="../../../serviceability/sa/ClhsdbPmap.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>