<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Old test/nashorn/src/jdk/nashorn/internal/runtime/test/CodeStoreAndPathTest.java</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
  <body>
    <pre>
  1 /*
  2  * Copyright (c) 2014, Oracle and/or its affiliates. All rights reserved.
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.  Oracle designates this
  8  * particular file as subject to the &quot;Classpath&quot; exception as provided
  9  * by Oracle in the LICENSE file that accompanied this code.
 10  *
 11  * This code is distributed in the hope that it will be useful, but WITHOUT
 12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 14  * version 2 for more details (a copy is included in the LICENSE file that
 15  * accompanied this code).
 16  *
 17  * You should have received a copy of the GNU General Public License version
 18  * 2 along with this work; if not, write to the Free Software Foundation,
 19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 20  *
 21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 22  * or visit www.oracle.com if you need additional information or have any
 23  * questions.
 24  */
 25 package jdk.nashorn.internal.runtime.test;
 26 
 27 import static org.testng.Assert.assertEquals;
 28 import static org.testng.Assert.assertFalse;
 29 import static org.testng.Assert.assertTrue;
 30 import java.io.File;
 31 import java.io.IOException;
 32 import java.nio.file.DirectoryStream;
 33 import java.nio.file.FileSystems;
 34 import java.nio.file.Files;
 35 import java.nio.file.Path;
 36 import javax.script.ScriptEngine;
 37 import javax.script.ScriptException;
 38 import jdk.nashorn.api.scripting.NashornScriptEngineFactory;
 39 import org.testng.annotations.Test;
 40 
 41 /**
 42  * @test
 43  * @bug 8039185 8039403
 44  * @summary  Test for persistent code cache and path handling
 45  * @run testng jdk.nashorn.internal.runtime.test.CodeStoreAndPathTest
 46  */
 47 @SuppressWarnings(&quot;javadoc&quot;)
 48 public class CodeStoreAndPathTest {
 49 
 50     final static String code1 = &quot;var code1; var x = &#39;Hello Script&#39;; var x1 = &#39;Hello Script&#39;; &quot;
 51                 + &quot;var x2 = &#39;Hello Script&#39;; var x3 = &#39;Hello Script&#39;; &quot;
 52                 + &quot;var x4 = &#39;Hello Script&#39;; var x5 = &#39;Hello Script&#39;;&quot;
 53                 + &quot;var x6 = &#39;Hello Script&#39;; var x7 = &#39;Hello Script&#39;; &quot;
 54                 + &quot;var x8 = &#39;Hello Script&#39;; var x9 = &#39;Hello Script&#39;; &quot;
 55                 + &quot;var x10 = &#39;Hello Script&#39;;&quot;
 56                 + &quot;function f() {x =&#39;Bye Script&#39;; x1 =&#39;Bye Script&#39;; x2=&#39;Bye Script&#39;;&quot;
 57                 + &quot;x3=&#39;Bye Script&#39;; x4=&#39;Bye Script&#39;; x5=&#39;Bye Script&#39;; x6=&#39;Bye Script&#39;;&quot;
 58                 + &quot;x7=&#39;Bye Script&#39;; x8=&#39;Bye Script&#39;; var x9 = &#39;Hello Script&#39;; &quot;
 59                 + &quot;var x10 = &#39;Hello Script&#39;;}&quot;
 60                 + &quot;function g() {x =&#39;Bye Script&#39;; x1 =&#39;Bye Script&#39;; x2=&#39;Bye Script&#39;;&quot;
 61                 + &quot;x3=&#39;Bye Script&#39;; x4=&#39;Bye Script&#39;; x5=&#39;Bye Script&#39;; x6=&#39;Bye Script&#39;;&quot;
 62                 + &quot;x7=&#39;Bye Script&#39;; x8=&#39;Bye Script&#39;; var x9 = &#39;Hello Script&#39;; &quot;
 63                 + &quot;var x10 = &#39;Hello Script&#39;;}&quot;
 64                 + &quot;function h() {x =&#39;Bye Script&#39;; x1 =&#39;Bye Script&#39;; x2=&#39;Bye Script&#39;;&quot;
 65                 + &quot;x3=&#39;Bye Script&#39;; x4=&#39;Bye Script&#39;; x5=&#39;Bye Script&#39;; x6=&#39;Bye Script&#39;;&quot;
 66                 + &quot;x7=&#39;Bye Script&#39;; x8=&#39;Bye Script&#39;; var x9 = &#39;Hello Script&#39;; &quot;
 67                 + &quot;var x10 = &#39;Hello Script&#39;;}&quot;
 68                 + &quot;function i() {x =&#39;Bye Script&#39;; x1 =&#39;Bye Script&#39;; x2=&#39;Bye Script&#39;;&quot;
 69                 + &quot;x3=&#39;Bye Script&#39;; x4=&#39;Bye Script&#39;; x5=&#39;Bye Script&#39;; x6=&#39;Bye Script&#39;;&quot;
 70                 + &quot;x7=&#39;Bye Script&#39;; x8=&#39;Bye Script&#39;; var x9 = &#39;Hello Script&#39;; &quot;
 71                 + &quot;var x10 = &#39;Hello Script&#39;;}&quot;;
 72     final static String code2 = &quot;var code2; var x = &#39;Hello Script&#39;; var x1 = &#39;Hello Script&#39;; &quot;
 73                 + &quot;var x2 = &#39;Hello Script&#39;; var x3 = &#39;Hello Script&#39;; &quot;
 74                 + &quot;var x4 = &#39;Hello Script&#39;; var x5 = &#39;Hello Script&#39;;&quot;
 75                 + &quot;var x6 = &#39;Hello Script&#39;; var x7 = &#39;Hello Script&#39;; &quot;
 76                 + &quot;var x8 = &#39;Hello Script&#39;; var x9 = &#39;Hello Script&#39;; &quot;
 77                 + &quot;var x10 = &#39;Hello Script&#39;;&quot;
 78                 + &quot;function f() {x =&#39;Bye Script&#39;; x1 =&#39;Bye Script&#39;; x2=&#39;Bye Script&#39;;&quot;
 79                 + &quot;x3=&#39;Bye Script&#39;; x4=&#39;Bye Script&#39;; x5=&#39;Bye Script&#39;; x6=&#39;Bye Script&#39;;&quot;
 80                 + &quot;x7=&#39;Bye Script&#39;; x8=&#39;Bye Script&#39;; var x9 = &#39;Hello Script&#39;; &quot;
 81                 + &quot;var x10 = &#39;Hello Script&#39;;}&quot;
 82                 + &quot;function g() {x =&#39;Bye Script&#39;; x1 =&#39;Bye Script&#39;; x2=&#39;Bye Script&#39;;&quot;
 83                 + &quot;x3=&#39;Bye Script&#39;; x4=&#39;Bye Script&#39;; x5=&#39;Bye Script&#39;; x6=&#39;Bye Script&#39;;&quot;
 84                 + &quot;x7=&#39;Bye Script&#39;; x8=&#39;Bye Script&#39;; var x9 = &#39;Hello Script&#39;; &quot;
 85                 + &quot;var x10 = &#39;Hello Script&#39;;}&quot;
 86                 + &quot;function h() {x =&#39;Bye Script&#39;; x1 =&#39;Bye Script&#39;; x2=&#39;Bye Script&#39;;&quot;
 87                 + &quot;x3=&#39;Bye Script&#39;; x4=&#39;Bye Script&#39;; x5=&#39;Bye Script&#39;; x6=&#39;Bye Script&#39;;&quot;
 88                 + &quot;x7=&#39;Bye Script&#39;; x8=&#39;Bye Script&#39;; var x9 = &#39;Hello Script&#39;; &quot;
 89                 + &quot;var x10 = &#39;Hello Script&#39;;}&quot;
 90                 + &quot;function i() {x =&#39;Bye Script&#39;; x1 =&#39;Bye Script&#39;; x2=&#39;Bye Script&#39;;&quot;
 91                 + &quot;x3=&#39;Bye Script&#39;; x4=&#39;Bye Script&#39;; x5=&#39;Bye Script&#39;; x6=&#39;Bye Script&#39;;&quot;
 92                 + &quot;x7=&#39;Bye Script&#39;; x8=&#39;Bye Script&#39;; var x9 = &#39;Hello Script&#39;; &quot;
 93                 + &quot;var x10 = &#39;Hello Script&#39;;}&quot;;
 94     // Script size &lt; Default minimum size for storing a compiled script class
 95     final static String code3 = &quot;var code3; var x = &#39;Hello Script&#39;; var x1 = &#39;Hello Script&#39;; &quot;;
 96     final static String nestedFunctions = &quot;\n&quot; +
 97             &quot;(function outer() { \n&quot; +
 98             &quot;    var map = null; \n&quot; +
 99             &quot;    (function inner() { \n&quot; +
100             &quot;        var object; \n&quot; +
101             &quot;        if (map === null) { \n&quot; +
102             &quot;            map = (function() { \n&quot; +
103             &quot;                var HashMap = Java.type(&#39;java.util.HashMap&#39;); \n&quot; +
104             &quot;                map = new HashMap(); \n&quot; +
105             &quot;                map.name          = &#39;name&#39;; \n&quot; +
106             &quot;                map.id            = 1234;\n&quot; +
107             &quot;                map.basePath      = &#39;basePath&#39;; \n&quot; +
108             &quot;                map.extensionPath = &#39;extension&#39;;\n&quot; +
109             &quot;                map.address       = &#39;address&#39;; \n&quot; +
110             &quot;                map.name          = &#39;name&#39;; \n&quot; +
111             &quot;                map.id            = 1234;\n&quot; +
112             &quot;                map.basePath      = &#39;basePath&#39;; \n&quot; +
113             &quot;                map.extensionPath = &#39;extension&#39;;\n&quot; +
114             &quot;                map.address       = &#39;address&#39;;\n&quot; +
115             &quot;                map.name          = &#39;name&#39;; \n&quot; +
116             &quot;                map.id            = 1234;\n&quot; +
117             &quot;                map.basePath      = &#39;basePath&#39;; \n&quot; +
118             &quot;                map.extensionPath = &#39;extension&#39;;\n&quot; +
119             &quot;                map.address       = &#39;address&#39;; \n&quot; +
120             &quot;                return map; \n&quot; +
121             &quot;            }()); \n&quot; +
122             &quot;        } \n&quot; +
123             &quot;        object = {}; \n&quot; +
124             &quot;        return object; \n&quot; +
125             &quot;    })(); \n&quot; +
126             &quot;}()); &quot;;
127     final static String longNestedFunctions = &quot;\n&quot; +
128             &quot;(function outer() { \n&quot; +
129             &quot;    var map = null; \n&quot; +
130             &quot;    (function inner() { \n&quot; +
131             &quot;        var object; \n&quot; +
132             &quot;        var HashMap = Java.type(&#39;java.util.HashMap&#39;); \n&quot; +
133             &quot;        map = new HashMap(); \n&quot; +
134             &quot;        map.name          = &#39;name&#39;; \n&quot; +
135             &quot;        map.id            = 1234;\n&quot; +
136             &quot;        map.basePath      = &#39;basePath&#39;; \n&quot; +
137             &quot;        map.extensionPath = &#39;extension&#39;;\n&quot; +
138             &quot;        map.address       = &#39;address&#39;; \n&quot; +
139             &quot;        map.name          = &#39;name&#39;; \n&quot; +
140             &quot;        map.id            = 1234;\n&quot; +
141             &quot;        map.basePath      = &#39;basePath&#39;; \n&quot; +
142             &quot;        map.extensionPath = &#39;extension&#39;;\n&quot; +
143             &quot;        map.address       = &#39;address&#39;;\n&quot; +
144             &quot;        map.name          = &#39;name&#39;; \n&quot; +
145             &quot;        map.id            = 1234;\n&quot; +
146             &quot;        map.basePath      = &#39;basePath&#39;; \n&quot; +
147             &quot;        map.extensionPath = &#39;extension&#39;;\n&quot; +
148             &quot;        map.address       = &#39;address&#39;; \n&quot; +
149             &quot;        map.name          = &#39;name&#39;; \n&quot; +
150             &quot;        map.id            = 1234;\n&quot; +
151             &quot;        map.basePath      = &#39;basePath&#39;; \n&quot; +
152             &quot;        map.extensionPath = &#39;extension&#39;;\n&quot; +
153             &quot;        map.address       = &#39;address&#39;; \n&quot; +
154             &quot;        map.name          = &#39;name&#39;; \n&quot; +
155             &quot;        map.id            = 1234;\n&quot; +
156             &quot;        map.basePath      = &#39;basePath&#39;; \n&quot; +
157             &quot;        map.extensionPath = &#39;extension&#39;;\n&quot; +
158             &quot;        map.address       = &#39;address&#39;;\n&quot; +
159             &quot;        map.name          = &#39;name&#39;; \n&quot; +
160             &quot;        map.id            = 1234;\n&quot; +
161             &quot;        map.basePath      = &#39;basePath&#39;; \n&quot; +
162             &quot;        map.extensionPath = &#39;extension&#39;;\n&quot; +
163             &quot;        map.address       = &#39;address&#39;; \n&quot; +
164             &quot;        map.name          = &#39;name&#39;; \n&quot; +
165             &quot;        map.id            = 1234;\n&quot; +
166             &quot;        map.basePath      = &#39;basePath&#39;; \n&quot; +
167             &quot;        map.extensionPath = &#39;extension&#39;;\n&quot; +
168             &quot;        map.address       = &#39;address&#39;; \n&quot; +
169             &quot;        map.name          = &#39;name&#39;; \n&quot; +
170             &quot;        map.id            = 1234;\n&quot; +
171             &quot;        map.basePath      = &#39;basePath&#39;; \n&quot; +
172             &quot;        map.extensionPath = &#39;extension&#39;;\n&quot; +
173             &quot;        map.address       = &#39;address&#39;;\n&quot; +
174             &quot;        map.name          = &#39;name&#39;; \n&quot; +
175             &quot;        map.id            = 1234;\n&quot; +
176             &quot;        map.basePath      = &#39;basePath&#39;; \n&quot; +
177             &quot;        map.extensionPath = &#39;extension&#39;;\n&quot; +
178             &quot;        map.address       = &#39;address&#39;; \n&quot; +
179             &quot;        map.name          = &#39;name&#39;; \n&quot; +
180             &quot;        map.id            = 1234;\n&quot; +
181             &quot;        map.basePath      = &#39;basePath&#39;; \n&quot; +
182             &quot;        map.extensionPath = &#39;extension&#39;;\n&quot; +
183             &quot;        map.address       = &#39;address&#39;; \n&quot; +
184             &quot;        map.name          = &#39;name&#39;; \n&quot; +
185             &quot;        map.id            = 1234;\n&quot; +
186             &quot;        map.basePath      = &#39;basePath&#39;; \n&quot; +
187             &quot;        map.extensionPath = &#39;extension&#39;;\n&quot; +
188             &quot;        map.address       = &#39;address&#39;;\n&quot; +
189             &quot;        map.name          = &#39;name&#39;; \n&quot; +
190             &quot;        map.id            = 1234;\n&quot; +
191             &quot;        map.basePath      = &#39;basePath&#39;; \n&quot; +
192             &quot;        map.extensionPath = &#39;extension&#39;;\n&quot; +
193             &quot;        map.address       = &#39;address&#39;; \n&quot; +
194             &quot;        map.name          = &#39;name&#39;; \n&quot; +
195             &quot;        map.id            = 1234;\n&quot; +
196             &quot;        map.basePath      = &#39;basePath&#39;; \n&quot; +
197             &quot;        map.extensionPath = &#39;extension&#39;;\n&quot; +
198             &quot;        map.address       = &#39;address&#39;; \n&quot; +
199             &quot;        map.name          = &#39;name&#39;; \n&quot; +
200             &quot;        map.id            = 1234;\n&quot; +
201             &quot;        map.basePath      = &#39;basePath&#39;; \n&quot; +
202             &quot;        map.extensionPath = &#39;extension&#39;;\n&quot; +
203             &quot;        map.address       = &#39;address&#39;;\n&quot; +
204             &quot;        map.name          = &#39;name&#39;; \n&quot; +
205             &quot;        map.id            = 1234;\n&quot; +
206             &quot;        map.basePath      = &#39;basePath&#39;; \n&quot; +
207             &quot;        map.extensionPath = &#39;extension&#39;;\n&quot; +
208             &quot;        map.address       = &#39;address&#39;; \n&quot; +
209             &quot;        map.name          = &#39;name&#39;; \n&quot; +
210             &quot;        map.id            = 1234;\n&quot; +
211             &quot;        map.basePath      = &#39;basePath&#39;; \n&quot; +
212             &quot;        map.extensionPath = &#39;extension&#39;;\n&quot; +
213             &quot;        map.address       = &#39;address&#39;; \n&quot; +
214             &quot;        map.name          = &#39;name&#39;; \n&quot; +
215             &quot;        map.id            = 1234;\n&quot; +
216             &quot;        map.basePath      = &#39;basePath&#39;; \n&quot; +
217             &quot;        map.extensionPath = &#39;extension&#39;;\n&quot; +
218             &quot;        map.address       = &#39;address&#39;;\n&quot; +
219             &quot;        map.name          = &#39;name&#39;; \n&quot; +
220             &quot;        map.id            = 1234;\n&quot; +
221             &quot;        map.basePath      = &#39;basePath&#39;; \n&quot; +
222             &quot;        map.extensionPath = &#39;extension&#39;;\n&quot; +
223             &quot;        map.address       = &#39;address&#39;; \n&quot; +
224             &quot;        map.name          = &#39;name&#39;; \n&quot; +
225             &quot;        map.id            = 1234;\n&quot; +
226             &quot;        map.basePath      = &#39;basePath&#39;; \n&quot; +
227             &quot;        map.extensionPath = &#39;extension&#39;;\n&quot; +
228             &quot;        map.address       = &#39;address&#39;; \n&quot; +
229             &quot;        map.name          = &#39;name&#39;; \n&quot; +
230             &quot;        map.id            = 1234;\n&quot; +
231             &quot;        map.basePath      = &#39;basePath&#39;; \n&quot; +
232             &quot;        map.extensionPath = &#39;extension&#39;;\n&quot; +
233             &quot;        map.address       = &#39;address&#39;;\n&quot; +
234             &quot;        map.name          = &#39;name&#39;; \n&quot; +
235             &quot;        map.id            = 1234;\n&quot; +
236             &quot;        map.basePath      = &#39;basePath&#39;; \n&quot; +
237             &quot;        map.extensionPath = &#39;extension&#39;;\n&quot; +
238             &quot;        map.address       = &#39;address&#39;; \n&quot; +
239             &quot;        map.name          = &#39;name&#39;; \n&quot; +
240             &quot;        map.id            = 1234;\n&quot; +
241             &quot;        map.basePath      = &#39;basePath&#39;; \n&quot; +
242             &quot;        map.extensionPath = &#39;extension&#39;;\n&quot; +
243             &quot;        map.address       = &#39;address&#39;; \n&quot; +
244             &quot;        map.name          = &#39;name&#39;; \n&quot; +
245             &quot;        map.id            = 1234;\n&quot; +
246             &quot;        map.basePath      = &#39;basePath&#39;; \n&quot; +
247             &quot;        map.extensionPath = &#39;extension&#39;;\n&quot; +
248             &quot;        map.address       = &#39;address&#39;;\n&quot; +
249             &quot;        map.name          = &#39;name&#39;; \n&quot; +
250             &quot;        map.id            = 1234;\n&quot; +
251             &quot;        map.basePath      = &#39;basePath&#39;; \n&quot; +
252             &quot;        map.extensionPath = &#39;extension&#39;;\n&quot; +
253             &quot;        map.address       = &#39;address&#39;; \n&quot; +
254             &quot;        map.name          = &#39;name&#39;; \n&quot; +
255             &quot;        map.id            = 1234;\n&quot; +
256             &quot;        map.basePath      = &#39;basePath&#39;; \n&quot; +
257             &quot;        map.extensionPath = &#39;extension&#39;;\n&quot; +
258             &quot;        map.address       = &#39;address&#39;; \n&quot; +
259             &quot;        map.name          = &#39;name&#39;; \n&quot; +
260             &quot;        map.id            = 1234;\n&quot; +
261             &quot;        map.basePath      = &#39;basePath&#39;; \n&quot; +
262             &quot;        map.extensionPath = &#39;extension&#39;;\n&quot; +
263             &quot;        map.address       = &#39;address&#39;;\n&quot; +
264             &quot;        map.name          = &#39;name&#39;; \n&quot; +
265             &quot;        map.id            = 1234;\n&quot; +
266             &quot;        map.basePath      = &#39;basePath&#39;; \n&quot; +
267             &quot;        map.extensionPath = &#39;extension&#39;;\n&quot; +
268             &quot;        map.address       = &#39;address&#39;; \n&quot; +
269             &quot;        map.name          = &#39;name&#39;; \n&quot; +
270             &quot;        map.id            = 1234;\n&quot; +
271             &quot;        map.basePath      = &#39;basePath&#39;; \n&quot; +
272             &quot;        map.extensionPath = &#39;extension&#39;;\n&quot; +
273             &quot;        map.address       = &#39;address&#39;; \n&quot; +
274             &quot;        map.name          = &#39;name&#39;; \n&quot; +
275             &quot;        map.id            = 1234;\n&quot; +
276             &quot;        map.basePath      = &#39;basePath&#39;; \n&quot; +
277             &quot;        map.extensionPath = &#39;extension&#39;;\n&quot; +
278             &quot;        map.address       = &#39;address&#39;;\n&quot; +
279             &quot;        map.name          = &#39;name&#39;; \n&quot; +
280             &quot;        map.id            = 1234;\n&quot; +
281             &quot;        map.basePath      = &#39;basePath&#39;; \n&quot; +
282             &quot;        map.extensionPath = &#39;extension&#39;;\n&quot; +
283             &quot;        map.address       = &#39;address&#39;; \n&quot; +
284             &quot;        map.name          = &#39;name&#39;; \n&quot; +
285             &quot;        map.id            = 1234;\n&quot; +
286             &quot;        map.basePath      = &#39;basePath&#39;; \n&quot; +
287             &quot;        map.extensionPath = &#39;extension&#39;;\n&quot; +
288             &quot;        map.address       = &#39;address&#39;; \n&quot; +
289             &quot;        map.name          = &#39;name&#39;; \n&quot; +
290             &quot;        map.id            = 1234;\n&quot; +
291             &quot;        map.basePath      = &#39;basePath&#39;; \n&quot; +
292             &quot;        map.extensionPath = &#39;extension&#39;;\n&quot; +
293             &quot;        map.address       = &#39;address&#39;;\n&quot; +
294             &quot;        map.name          = &#39;name&#39;; \n&quot; +
295             &quot;        map.id            = 1234;\n&quot; +
296             &quot;        map.basePath      = &#39;basePath&#39;; \n&quot; +
297             &quot;        map.extensionPath = &#39;extension&#39;;\n&quot; +
298             &quot;        map.address       = &#39;address&#39;; \n&quot; +
299             &quot;        map.name          = &#39;name&#39;; \n&quot; +
300             &quot;        map.id            = 1234;\n&quot; +
301             &quot;        map.basePath      = &#39;basePath&#39;; \n&quot; +
302             &quot;        map.extensionPath = &#39;extension&#39;;\n&quot; +
303             &quot;        map.address       = &#39;address&#39;; \n&quot; +
304             &quot;        map.name          = &#39;name&#39;; \n&quot; +
305             &quot;        map.id            = 1234;\n&quot; +
306             &quot;        map.basePath      = &#39;basePath&#39;; \n&quot; +
307             &quot;        map.extensionPath = &#39;extension&#39;;\n&quot; +
308             &quot;        map.address       = &#39;address&#39;;\n&quot; +
309             &quot;        map.name          = &#39;name&#39;; \n&quot; +
310             &quot;        map.id            = 1234;\n&quot; +
311             &quot;        map.basePath      = &#39;basePath&#39;; \n&quot; +
312             &quot;        map.extensionPath = &#39;extension&#39;;\n&quot; +
313             &quot;        map.address       = &#39;address&#39;; \n&quot; +
314             &quot;        map.name          = &#39;name&#39;; \n&quot; +
315             &quot;        map.id            = 1234;\n&quot; +
316             &quot;        map.basePath      = &#39;basePath&#39;; \n&quot; +
317             &quot;        map.extensionPath = &#39;extension&#39;;\n&quot; +
318             &quot;        map.address       = &#39;address&#39;; \n&quot; +
319             &quot;        map.name          = &#39;name&#39;; \n&quot; +
320             &quot;        map.id            = 1234;\n&quot; +
321             &quot;        map.basePath      = &#39;basePath&#39;; \n&quot; +
322             &quot;        map.extensionPath = &#39;extension&#39;;\n&quot; +
323             &quot;        map.address       = &#39;address&#39;;\n&quot; +
324             &quot;        map.name          = &#39;name&#39;; \n&quot; +
325             &quot;        map.id            = 1234;\n&quot; +
326             &quot;        map.basePath      = &#39;basePath&#39;; \n&quot; +
327             &quot;        map.extensionPath = &#39;extension&#39;;\n&quot; +
328             &quot;        map.address       = &#39;address&#39;; \n&quot; +
329             &quot;        map.name          = &#39;name&#39;; \n&quot; +
330             &quot;        map.id            = 1234;\n&quot; +
331             &quot;        map.basePath      = &#39;basePath&#39;; \n&quot; +
332             &quot;        map.extensionPath = &#39;extension&#39;;\n&quot; +
333             &quot;        map.address       = &#39;address&#39;; \n&quot; +
334             &quot;        map.name          = &#39;name&#39;; \n&quot; +
335             &quot;        map.id            = 1234;\n&quot; +
336             &quot;        map.basePath      = &#39;basePath&#39;; \n&quot; +
337             &quot;        map.extensionPath = &#39;extension&#39;;\n&quot; +
338             &quot;        map.address       = &#39;address&#39;;\n&quot; +
339             &quot;        map.name          = &#39;name&#39;; \n&quot; +
340             &quot;        map.id            = 1234;\n&quot; +
341             &quot;        map.basePath      = &#39;basePath&#39;; \n&quot; +
342             &quot;        map.extensionPath = &#39;extension&#39;;\n&quot; +
343             &quot;        map.address       = &#39;address&#39;; \n&quot; +
344             &quot;        map.name          = &#39;name&#39;; \n&quot; +
345             &quot;        map.id            = 1234;\n&quot; +
346             &quot;        map.basePath      = &#39;basePath&#39;; \n&quot; +
347             &quot;        map.extensionPath = &#39;extension&#39;;\n&quot; +
348             &quot;        map.address       = &#39;address&#39;; \n&quot; +
349             &quot;        map.name          = &#39;name&#39;; \n&quot; +
350             &quot;        map.id            = 1234;\n&quot; +
351             &quot;        map.basePath      = &#39;basePath&#39;; \n&quot; +
352             &quot;        map.extensionPath = &#39;extension&#39;;\n&quot; +
353             &quot;        map.address       = &#39;address&#39;;\n&quot; +
354             &quot;        map.name          = &#39;name&#39;; \n&quot; +
355             &quot;        map.id            = 1234;\n&quot; +
356             &quot;        map.basePath      = &#39;basePath&#39;; \n&quot; +
357             &quot;        map.extensionPath = &#39;extension&#39;;\n&quot; +
358             &quot;        map.address       = &#39;address&#39;; \n&quot; +
359             &quot;        map.name          = &#39;name&#39;; \n&quot; +
360             &quot;        map.id            = 1234;\n&quot; +
361             &quot;        map.basePath      = &#39;basePath&#39;; \n&quot; +
362             &quot;        map.extensionPath = &#39;extension&#39;;\n&quot; +
363             &quot;        map.address       = &#39;address&#39;; \n&quot; +
364             &quot;        map.name          = &#39;name&#39;; \n&quot; +
365             &quot;        map.id            = 1234;\n&quot; +
366             &quot;        map.basePath      = &#39;basePath&#39;; \n&quot; +
367             &quot;        map.extensionPath = &#39;extension&#39;;\n&quot; +
368             &quot;        map.address       = &#39;address&#39;;\n&quot; +
369             &quot;        map.name          = &#39;name&#39;; \n&quot; +
370             &quot;        map.id            = 1234;\n&quot; +
371             &quot;        map.basePath      = &#39;basePath&#39;; \n&quot; +
372             &quot;        map.extensionPath = &#39;extension&#39;;\n&quot; +
373             &quot;        map.address       = &#39;address&#39;; \n&quot; +
374             &quot;        map.name          = &#39;name&#39;; \n&quot; +
375             &quot;        map.id            = 1234;\n&quot; +
376             &quot;        map.basePath      = &#39;basePath&#39;; \n&quot; +
377             &quot;        map.extensionPath = &#39;extension&#39;;\n&quot; +
378             &quot;        map.address       = &#39;address&#39;; \n&quot; +
379             &quot;        map.name          = &#39;name&#39;; \n&quot; +
380             &quot;        map.id            = 1234;\n&quot; +
381             &quot;        map.basePath      = &#39;basePath&#39;; \n&quot; +
382             &quot;        map.extensionPath = &#39;extension&#39;;\n&quot; +
383             &quot;        map.address       = &#39;address&#39;;\n&quot; +
384             &quot;        map.name          = &#39;name&#39;; \n&quot; +
385             &quot;        map.id            = 1234;\n&quot; +
386             &quot;        map.basePath      = &#39;basePath&#39;; \n&quot; +
387             &quot;        map.extensionPath = &#39;extension&#39;;\n&quot; +
388             &quot;        map.address       = &#39;address&#39;; \n&quot; +
389             &quot;        object = {}; \n&quot; +
390             &quot;        return object; \n&quot; +
391             &quot;    })(); \n&quot; +
392             &quot;}()); &quot;;
393     final static String codeCache = System.getProperty(&quot;build.dir&quot;, &quot;build&quot;) + &quot;/nashorn_code_cache&quot;;
394     final static String oldUserDir = System.getProperty(&quot;user.dir&quot;);
395 
396     private static final String[] ENGINE_OPTIONS_OPT   = new String[]{&quot;--persistent-code-cache&quot;, &quot;--optimistic-types=true&quot;};
397     private static final String[] ENGINE_OPTIONS_NOOPT = new String[]{&quot;--persistent-code-cache&quot;, &quot;--optimistic-types=false&quot;};
398 
399     @Test
400     public void pathHandlingTest() {
401         System.setProperty(&quot;nashorn.persistent.code.cache&quot;, codeCache);
402         final NashornScriptEngineFactory fac = new NashornScriptEngineFactory();
403 
404         fac.getScriptEngine(ENGINE_OPTIONS_NOOPT);
405 
406         final Path expectedCodeCachePath = FileSystems.getDefault().getPath(oldUserDir + File.separator + codeCache);
407         final Path actualCodeCachePath = FileSystems.getDefault().getPath(System.getProperty(
408                             &quot;nashorn.persistent.code.cache&quot;)).toAbsolutePath();
409         // Check that nashorn code cache is created in current working directory
410         assertEquals(actualCodeCachePath, expectedCodeCachePath);
411         // Check that code cache dir exists and it&#39;s not empty
412         final File file = new File(actualCodeCachePath.toUri());
413         assertTrue(file.exists(), &quot;No code cache directory was created!&quot;);
414         assertTrue(file.isDirectory(), &quot;Code cache location is not a directory!&quot;);
415         assertFalse(file.list().length == 0, &quot;Code cache directory is empty!&quot;);
416     }
417 
418     @Test
419     public void changeUserDirTest() throws ScriptException, IOException {
420         System.setProperty(&quot;nashorn.persistent.code.cache&quot;, codeCache);
421         final NashornScriptEngineFactory fac = new NashornScriptEngineFactory();
422         final ScriptEngine e = fac.getScriptEngine(ENGINE_OPTIONS_NOOPT);
423         final Path codeCachePath = getCodeCachePath(false);
424         final String newUserDir = &quot;build/newUserDir&quot;;
425         // Now changing current working directory
426         System.setProperty(&quot;user.dir&quot;, System.getProperty(&quot;user.dir&quot;) + File.separator + newUserDir);
427         try {
428             // Check that a new compiled script is stored in existing code cache
429             e.eval(code1);
430             final DirectoryStream&lt;Path&gt; stream = Files.newDirectoryStream(codeCachePath);
431             checkCompiledScripts(stream, 1);
432             // Setting to default current working dir
433         } finally {
434             System.setProperty(&quot;user.dir&quot;, oldUserDir);
435         }
436     }
437 
438     @Test
439     public void codeCacheTest() throws ScriptException, IOException {
440         System.setProperty(&quot;nashorn.persistent.code.cache&quot;, codeCache);
441         final NashornScriptEngineFactory fac = new NashornScriptEngineFactory();
442         final ScriptEngine e = fac.getScriptEngine(ENGINE_OPTIONS_NOOPT);
443         final Path codeCachePath = getCodeCachePath(false);
444         e.eval(code1);
445         e.eval(code2);
446         e.eval(code3);// less than minimum size for storing
447         // adding code1 and code2.
448         final DirectoryStream&lt;Path&gt; stream = Files.newDirectoryStream(codeCachePath);
449         checkCompiledScripts(stream, 2);
450     }
451 
452     @Test
453     public void codeCacheTestOpt() throws ScriptException, IOException {
454         System.setProperty(&quot;nashorn.persistent.code.cache&quot;, codeCache);
455         final NashornScriptEngineFactory fac = new NashornScriptEngineFactory();
456         final ScriptEngine e = fac.getScriptEngine(ENGINE_OPTIONS_OPT);
457         final Path codeCachePath = getCodeCachePath(true);
458         e.eval(code1);
459         e.eval(code2);
460         e.eval(code3);// less than minimum size for storing
461         // adding code1 and code2.
462         final DirectoryStream&lt;Path&gt; stream = Files.newDirectoryStream(codeCachePath);
463         checkCompiledScripts(stream, 4);
464     }
465 
466     @Test
467     public void testNestedFunctionStore() throws ScriptException, IOException {
468         System.setProperty(&quot;nashorn.persistent.code.cache&quot;, codeCache);
469         final NashornScriptEngineFactory factory = new NashornScriptEngineFactory();
470         factory.getScriptEngine(ENGINE_OPTIONS_OPT).eval(nestedFunctions);
471         factory.getScriptEngine(ENGINE_OPTIONS_OPT).eval(nestedFunctions);
472         factory.getScriptEngine(ENGINE_OPTIONS_OPT).eval(nestedFunctions);
473         factory.getScriptEngine(ENGINE_OPTIONS_OPT).eval(nestedFunctions);
474     }
475 
476     @Test
477     public void testSplitFunctionStore() throws ScriptException, IOException {
478         System.setProperty(&quot;nashorn.persistent.code.cache&quot;, codeCache);
479         System.setProperty(&quot;nashorn.compiler.splitter.threshold&quot;, &quot;500&quot;);
480         final NashornScriptEngineFactory factory = new NashornScriptEngineFactory();
481         factory.getScriptEngine(ENGINE_OPTIONS_OPT).eval(longNestedFunctions);
482         factory.getScriptEngine(ENGINE_OPTIONS_OPT).eval(longNestedFunctions);
483         factory.getScriptEngine(ENGINE_OPTIONS_OPT).eval(longNestedFunctions);
484         factory.getScriptEngine(ENGINE_OPTIONS_OPT).eval(longNestedFunctions);
485         System.getProperties().remove(&quot;nashorn.compiler.splitter.threshold&quot;);
486     }
487 
488     private static Path getCodeCachePath(final boolean optimistic) {
489         final String codeCache = System.getProperty(&quot;nashorn.persistent.code.cache&quot;);
490         final Path codeCachePath = FileSystems.getDefault().getPath(codeCache).toAbsolutePath();
491         final String[] files = codeCachePath.toFile().list();
492         for (final String file : files) {
493             if (file.endsWith(&quot;_opt&quot;) == optimistic) {
494                 return codeCachePath.resolve(file);
495             }
496         }
497         throw new AssertionError(&quot;Code cache path not found: &quot; + codeCachePath.toString());
498     }
499 
500     private static void checkCompiledScripts(final DirectoryStream&lt;Path&gt; stream, final int numberOfScripts) throws IOException {
501         int n = numberOfScripts;
502         for (@SuppressWarnings(&quot;unused&quot;) final Path file : stream) {
503             n--;
504         }
505         stream.close();
506         assertEquals(n, 0);
507     }
508 
509 }
    </pre>
  </body>
</html>