<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Old test/nashorn/script/basic/JDK-8016618.js</title>
    <link rel="stylesheet" href="../../../../style.css" />
  </head>
  <body>
    <pre>
  1 /*
  2  * Copyright (c) 2010, 2013, Oracle and/or its affiliates. All rights reserved.
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 /**
 25  * JDK-8016618: script mirror object access should be improved
 26  *
 27  * @test
 28  * @option -scripting
 29  * @option -strict
 30  * @run
 31  */
 32 
 33 var global = loadWithNewGlobal({
 34     name: &quot;code&quot;,
 35     script: &lt;&lt;EOF
 36 var x = 33;
 37 
 38 function func(x, y) {
 39     print(&#39;func.x = &#39; + x);
 40     print(&#39;func.x = &#39; + y)
 41 };
 42 
 43 var obj = {
 44     foo: &#39;hello&#39;,
 45     bar: 42
 46 };
 47 
 48 Object.defineProperty(obj, &quot;bar&quot;,
 49     { enumerable: false, writable: false });
 50 
 51 // return global
 52 this;
 53 EOF
 54 });
 55 
 56 // load on mirror with local object as argument
 57 global.load({
 58     name: &quot;code&quot;,
 59     script: &quot;print(&#39;x = &#39; + x)&quot;
 60 });
 61 
 62 function f() {
 63     // mirror function called with local arguments
 64     //    global.func.apply(obj, arguments);
 65     global.func.apply(obj, arguments);
 66 }
 67 
 68 f(23, &quot;hello&quot;);
 69 
 70 f(24, &quot;hello2&quot;);
 71 
 72 var oldCall = Function.prototype.call;
 73 Function.prototype.call = function() {
 74     throw &quot;this should never happen! go back to apply!&quot;;
 75 };
 76 
 77 f(25, &quot;hello3&quot;);
 78 
 79 Function.prototype.call = oldCall;
 80 
 81 var fObject = global.eval(&quot;Object&quot;);
 82 
 83 // instanceof on mirrors
 84 print(&quot;global instanceof fObject? &quot; + (global instanceof fObject));
 85 
 86 // Object API on mirrors
 87 
 88 var desc = Object.getOwnPropertyDescriptor(global, &quot;x&quot;);
 89 print(&quot;x is wriable ? &quot; + desc.writable);
 90 print(&quot;x value = &quot; + desc.value);
 91 
 92 var proto = Object.getPrototypeOf(global);
 93 print(&quot;global&#39;s __proto__ &quot; + proto);
 94 
 95 var obj = global.obj;
 96 var keys = Object.keys(obj);
 97 print(&quot;Object.keys on obj&quot;);
 98 for (var i in keys) {
 99     print(keys[i]);
100 }
101 
102 print(&quot;Object.getOwnProperties on obj&quot;);
103 var keys = Object.getOwnPropertyNames(obj);
104 for (var i in keys) {
105   print(keys[i]);
106 }
107 
108 // mirror array access
109 var array = global.eval(&quot;[334, 55, 65]&quot;);
110 Array.prototype.forEach.call(array, function(elem) {
111     print(&quot;forEach &quot; + elem)
112 });
113 
114 print(&quot;reduceRight &quot; + Array.prototype.reduceRight.call(array,
115     function(previousValue, currentValue, index, array) {
116         print(&quot;reduceRight cur value &quot; + currentValue);
117         return previousValue + currentValue;
118 }, 0));
119 
120 print(&quot;reduce &quot; + Array.prototype.reduce.call(array,
121     function(previousValue, currentValue, index, array) {
122         print(&quot;reduce cur value &quot; + currentValue);
123         return previousValue + currentValue;
124 }, 0));
125 
126 print(&quot;forEach&quot;);
127 Array.prototype.forEach.call(array, function(o) {
128    print(o);
129 });
130 
131 print(&quot;Array.isArray(array)? &quot; + Array.isArray(array));
132 
133 // try to write to a non-writable property of mirror
134 try {
135    obj.bar = 33;
136 } catch (e) {
137    print(e);
138 }
139 
140 // mirror function called with local callback
141 print(&quot;forEach on mirror&quot;);
142 array.forEach(function(toto) {
143     print(toto);
144 });
    </pre>
  </body>
</html>