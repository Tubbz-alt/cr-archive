<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Old test/nashorn/script/currently-failing/JDK-8144221.js</title>
    <link rel="stylesheet" href="../../../../style.css" />
  </head>
  <body>
    <pre>
  1 /*
  2  * Copyright (c) 2015, 2016, Oracle and/or its affiliates. All rights reserved.
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 /**
 25  * Test that shebang handling works properly.
 26  *
 27  * @test
 28  * @option -scripting
 29  * @runif os.not.windows.cmd
 30  */
 31 
 32 // The test generates three different JavaScript source files. The first two
 33 // are generated at the beginning of the test and do not change.
 34 // * a.js
 35 //   print(&quot;A: &quot; + arguments)
 36 // * b.js
 37 //   #!&lt;path_to_jjs&gt; -lalelu -- ignore
 38 //   print(&quot;B: &quot; + arguments)
 39 //
 40 // The third file, shebang.js, is generated differently for each particular
 41 // test case, containing different shebang lines and one statement:
 42 // * shebang.js
 43 //   #!&lt;path_to_jjs&gt; &lt;shebang_line&gt;
 44 //   print(&quot;S: &quot; + arguments)
 45 //
 46 // The path_to_jjs is extracted from the environment based on JAVA_HOME, so the
 47 // latter must be set properly.
 48 //
 49 // Each shebang.js is run four times, in all possible combinations of values
 50 // from the following two axes:
 51 // * without passing any arguments, and passing the arguments &#39;a.js&#39; and
 52 //   &#39;&quot;hello world&quot;&#39; (the latter being a quoted string);
 53 // * run via jjs, and via direct shell execution (using shebang).
 54 
 55 var pseudosheb  = &quot;#!${jjs} -lalelu -- ignore&quot;,
 56     System      = Java.type(&#39;java.lang.System&#39;),
 57     Paths       = Java.type(&#39;java.nio.file.Paths&#39;),
 58     Files       = Java.type(&#39;java.nio.file.Files&#39;),
 59     Opt         = Java.type(&#39;java.nio.file.StandardOpenOption&#39;),
 60     Arrays      = Java.type(&#39;java.util.Arrays&#39;)
 61 
 62 var sep      = Java.type(&#39;java.io.File&#39;).separator,
 63     win      = System.getProperty(&quot;os.name&quot;).startsWith(&quot;Windows&quot;),
 64     jjsName  = &quot;jjs&quot; + (win ? &quot;.exe&quot; : &quot;&quot;),
 65     javaHome = System.getProperty(&quot;java.home&quot;)
 66 
 67 var jjs = javaHome + &quot;/../bin/&quot;.replace(/\//g, sep) + jjsName
 68 if (!Files.exists(Paths.get(jjs))) {
 69     jjs = javaHome + &quot;/bin/&quot;.replace(/\//g, sep) + jjsName
 70 }
 71 
 72 // Create and cwd to a temporary directory.
 73 
 74 var tmpdir = Files.createTempDirectory(null),
 75     tmp    = tmpdir.toAbsolutePath().toString(),
 76     curpwd = $ENV.PWD
 77 
 78 $ENV.PWD = tmp
 79 
 80 // Test cases. Each case is documented with the expected output for the four
 81 // different executions.
 82 
 83 var shebs = [
 84         // No arguments on the shebang line.
 85         // noargs jjs/shebang -&gt; no output but &quot;S&quot; prefix
 86         // args jjs/shebang   -&gt; output the arguments with &quot;S&quot; prefix
 87         &quot;&quot;,
 88         // One interpreter argument.
 89         // noargs jjs/shebang -&gt; no output but &quot;S&quot; prefix
 90         // args jjs/shebang   -&gt; output the arguments with &quot;S&quot; prefix
 91         &quot;--language=es6&quot;,
 92         // Two interpreter arguments.
 93         // noargs jjs/shebang -&gt; no output but &quot;S&quot; prefix
 94         // args jjs/shebang   -&gt; output the arguments with &quot;S&quot; prefix
 95         &quot;--language=es6 -scripting&quot;,
 96         // One interpreter argument and a JavaScript file without shebang.
 97         // (For shebang execution, this is a pathological example, as the
 98         // JavaScript file passed as a shebang argument will be analyzed and
 99         // shebang mode will not be entered.)
100         // noargs jjs     -&gt; no output but &quot;S&quot; prefix
101         // args jjs       -&gt; output the arguments with &quot;S&quot; prefix
102         // noargs shebang -&gt; no output but &quot;A&quot; and &quot;S&quot; prefixes
103         // args shebang   -&gt; output &quot;A&quot;, &quot;S&quot;, and &quot;A&quot; prefixes, then the error
104         //                   message:
105         //                   &quot;java.io.IOException: hello world is not a file&quot;
106         &quot;-scripting a.js&quot;,
107         // One interpreter argument and a JavaScript file with shebang. (This
108         // is another pathological example, as it will force shebang mode,
109         // leading to all subsequent arguments, including shebang.js, being
110         // treated as arguments to the script b.js.)
111         // noargs jjs     -&gt; no output but the &quot;S&quot; prefix
112         // args jjs       -&gt; output the arguments with &quot;S&quot; prefix
113         // noargs shebang -&gt; output shebang.js with &quot;B&quot; prefix
114         // args shebang   -&gt; output shebang.js and the arguments with &quot;B&quot;
115         //                   prefix
116         &quot;-scripting b.js&quot;
117     ]
118 
119 function write(file, lines) {
120     Files.write(Paths.get(tmp, file), Arrays.asList(lines), Opt.CREATE, Opt.WRITE)
121 }
122 
123 function insn(name) {
124     return &quot;print(&#39;${name}:&#39; + arguments)&quot;
125 }
126 
127 function run(viajjs, name, arg1, arg2) {
128     var prefix = viajjs ? &quot;${jjs} -scripting &quot; : win ? &#39;sh -c &quot;&#39; : &#39;&#39;,
129         suffix = viajjs ? &#39;&#39; : win ? &#39;&quot;&#39; : &#39;&#39;
130     $EXEC(&quot;${prefix}./shebang.js ${arg1} ${arg2}${suffix}&quot;)
131     print(&quot;* ${name} via ${viajjs ? &#39;jjs&#39; : &#39;shebang&#39;}&quot;)
132     print($OUT.trim())
133     print($ERR.trim())
134 }
135 
136 write(&#39;a.js&#39;, insn(&#39;A&#39;))
137 write(&#39;b.js&#39;, [pseudosheb, insn(&#39;B&#39;)])
138 
139 shebs.forEach(function(sheb) {
140     var shebang = &quot;#!${jjs} ${sheb}&quot;
141     print(&quot;&lt;&lt;&lt; ${sheb} &gt;&gt;&gt;&quot;)
142     write(&#39;shebang.js&#39;, [shebang, insn(&#39;S&#39;)])
143     $EXEC(&#39;chmod +x shebang.js&#39;)
144     run(false, &#39;noargs&#39;, &#39;&#39;, &#39;&#39;)
145     run(true, &#39;noargs&#39;, &#39;&#39;, &#39;&#39;)
146     run(false, &#39;withargs&#39;, &#39;a.js&#39;, &quot;&#39;hello world&#39;&quot;)
147     run(true, &#39;withargs&#39;, &#39;a.js&#39;, &quot;&#39;hello world&#39;&quot;)
148     $EXEC(&#39;rm shebang.js&#39;)
149 })
150 
151 // Cleanup.
152 
153 $EXEC(&#39;rm a.js b.js&#39;)
154 $ENV.PWD = curpwd
155 Files.delete(tmpdir)
    </pre>
  </body>
</html>