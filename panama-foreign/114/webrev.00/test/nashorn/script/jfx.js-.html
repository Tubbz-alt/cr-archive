<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Old test/nashorn/script/jfx.js</title>
    <link rel="stylesheet" href="../../../style.css" />
  </head>
  <body>
    <pre>
  1 /*
  2  * Copyright (c) 2013, Oracle and/or its affiliates. All rights reserved.
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  * 
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  * 
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  * 
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  * 
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 /**
 25  * Base library for JavaFX canvas run by Nashorn testing.
 26  * @subtest
 27  * 
 28  * 
 29  */
 30 
 31 var System               = Java.type(&quot;java.lang.System&quot;);
 32 var AWTImage             = Java.type(&quot;org.jemmy.image.AWTImage&quot;);
 33 var PNGDecoder           = Java.type(&quot;org.jemmy.image.PNGDecoder&quot;);
 34 var JemmyFxRoot          = Java.type(&quot;org.jemmy.fx.Root&quot;);
 35 var AWTRobotCapturer     = Java.type(&quot;org.jemmy.image.AWTRobotCapturer&quot;);
 36 var ByWindowType         = Java.type(&quot;org.jemmy.fx.ByWindowType&quot;);
 37 var Scene                = Java.type(&quot;javafx.scene.Scene&quot;);
 38 var Stage                = Java.type(&quot;javafx.stage.Stage&quot;);
 39 var File                 = Java.type(&quot;java.io.File&quot;);
 40 var OSInfo               = Java.type(&quot;sun.awt.OSInfo&quot;);
 41 var OSType               = Java.type(&quot;sun.awt.OSInfo.OSType&quot;);
 42 var StringBuffer         = Java.type(&quot;java.lang.StringBuffer&quot;);
 43 var Paint                = Java.type(&quot;javafx.scene.paint.Paint&quot;);
 44 var Color                = Java.type(&quot;javafx.scene.paint.Color&quot;);
 45 var Image                = Java.type(&quot;javafx.scene.image.Image&quot;);
 46 var Canvas               = Java.type(&quot;javafx.scene.canvas.Canvas&quot;);
 47 var BorderPane           = Java.type(&quot;javafx.scene.layout.BorderPane&quot;);
 48 var StackPane            = Java.type(&quot;javafx.scene.layout.StackPane&quot;);
 49 var StrokeLineCap        = Java.type(&quot;javafx.scene.shape.StrokeLineCap&quot;);
 50 var Platform             = Java.type(&quot;javafx.application.Platform&quot;);
 51 var Runnable             = Java.type(&quot;java.lang.Runnable&quot;);
 52 var RunnableExtend       = Java.extend(Runnable);
 53 var AnimationTimer       = Java.type(&quot;javafx.animation.AnimationTimer&quot;);
 54 var AnimationTimerExtend = Java.extend(AnimationTimer);
 55 var Timer                = Java.type(&quot;java.util.Timer&quot;);
 56 var TimerTask            = Java.type(&quot;java.util.TimerTask&quot;);
 57 
 58 var TESTNAME = &quot;test&quot;;
 59 var fsep = System.getProperty(&quot;file.separator&quot;);
 60 
 61 function checkImageAndExit() {
 62     var raceTimer = new Timer(true);
 63     var timerTask = new TimerTask() {
 64         run: function run() {
 65             var tmpdir = System.getProperty(&quot;java.io.tmpdir&quot;);
 66             var timenow = (new Date()).getTime();
 67             var scrShotTmp = tmpdir + fsep + &quot;screenshot&quot; + timenow +&quot;.png&quot;;
 68             var goldenImageDir = __DIR__ + &quot;jfx&quot; + fsep + TESTNAME + fsep + &quot;golden&quot;;
 69             makeScreenShot(scrShotTmp);
 70             var dupImg = isDuplicateImages(scrShotTmp, goldenImageDir);
 71             (new File(scrShotTmp)).delete();
 72             if (!dupImg) System.err.println(&quot;ERROR: screenshot does not match the golden image&quot;);
 73             exit(0);
 74         }
 75     };
 76     raceTimer.schedule(timerTask, 100);
 77 }
 78 
 79 function makeScreenShot(shootToImg) {
 80    JemmyFxRoot.ROOT.getEnvironment().setImageCapturer(new AWTRobotCapturer());
 81    var wrap = JemmyFxRoot.ROOT.lookup(new ByWindowType($STAGE.class)).lookup(Scene.class).wrap(0);
 82    var imageJemmy = wrap.getScreenImage();
 83    imageJemmy.save(shootToImg);
 84 }
 85 
 86 function isDuplicateImages(screenShot, goldenDir) {
 87     var f1 = new File(screenShot);
 88     var f2;
 89     var sb = new StringBuffer(goldenDir);
 90     if (OSInfo.getOSType() == OSType.WINDOWS) {
 91         f2 = new File(sb.append(fsep + &quot;windows.png&quot;).toString());
 92     } else if (OSInfo.getOSType() == OSType.LINUX) {
 93         f2 = new File(sb.append(fsep + &quot;linux.png&quot;).toString());
 94     } else if (OSInfo.getOSType() == OSType.MACOSX) {
 95         f2 = new File(sb.append(fsep + &quot;macosx.png&quot;).toString());
 96     }
 97     if (f1.exists() &amp;&amp; f2.exists()) {
 98         var image1 = new AWTImage(PNGDecoder.decode(f1.getAbsolutePath()));
 99         var image2 = new AWTImage(PNGDecoder.decode(f2.getAbsolutePath()));
100         return image1.compareTo(image2) == null ? true : false;
101     }
102     return false;
103 }
    </pre>
  </body>
</html>