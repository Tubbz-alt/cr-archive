<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/java.desktop/macosx/native/libawt_lwawt/awt/CTextPipe.m</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
  </head>
<body>
<center><a href="CSystemColors.m.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="../font/AWTStrike.m.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/java.desktop/macosx/native/libawt_lwawt/awt/CTextPipe.m</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 20  *
 21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 22  * or visit www.oracle.com if you need additional information or have any
 23  * questions.
 24  */
 25 
 26 //  Native side of the Quartz text pipe, paints on Quartz Surface Datas.
 27 //  Interesting Docs : /Developer/Documentation/Cocoa/TasksAndConcepts/ProgrammingTopics/FontHandling/FontHandling.html
 28 
 29 #import &quot;sun_awt_SunHints.h&quot;
 30 #import &quot;sun_lwawt_macosx_CTextPipe.h&quot;
 31 #import &quot;sun_java2d_OSXSurfaceData.h&quot;
 32 
 33 #import &lt;JavaNativeFoundation/JavaNativeFoundation.h&gt;
 34 
 35 #import &quot;CoreTextSupport.h&quot;
 36 #import &quot;QuartzSurfaceData.h&quot;
 37 #include &quot;AWTStrike.h&quot;
 38 
<span class="line-removed"> 39 /* Use THIS_FILE when it is available. */</span>
<span class="line-removed"> 40 #ifndef THIS_FILE</span>
<span class="line-removed"> 41     #define THIS_FILE __FILE__</span>
<span class="line-removed"> 42 #endif</span>
<span class="line-removed"> 43 </span>
 44 static const CGAffineTransform sInverseTX = { 1, 0, 0, -1, 0, 0 };
 45 
 46 
 47 #pragma mark --- CoreText Support ---
 48 
 49 
 50 // Translates a Unicode into a CGGlyph/CTFontRef pair
 51 // Returns the substituted font, and places the appropriate glyph into &quot;glyphRef&quot;
 52 CTFontRef JavaCT_CopyCTFallbackFontAndGlyphForUnicode
 53 (const AWTFont *font, const UTF16Char *charRef, CGGlyph *glyphRef, int count) {
 54     CTFontRef fallback = JRSFontCreateFallbackFontForCharacters((CTFontRef)font-&gt;fFont, charRef, count);
 55     if (fallback == NULL)
 56     {
 57         // use the original font if we somehow got duped into trying to fallback something we can&#39;t
 58         fallback = (CTFontRef)font-&gt;fFont;
 59         CFRetain(fallback);
 60     }
 61 
 62     CTFontGetGlyphsForCharacters(fallback, charRef, glyphRef, count);
 63     return fallback;
</pre>
<hr />
<pre>
514     }
515 
516     if (length &lt; MAX_STACK_ALLOC_GLYPH_BUFFER_SIZE)
517     {
518         // if we are small enough, fit everything onto the stack
519         CGGlyph glyphs[length];
520         int uniChars[length];
521         CGSize advances[length];
522         doDrawGlyphsPipe_fillGlyphAndAdvanceBuffers(env, qsdo, strike, gVector, glyphs, uniChars, advances, length, glyphsArray);
523     }
524     else
525     {
526         // otherwise, we should malloc and free buffers for this large run
527         CGGlyph *glyphs = (CGGlyph *)malloc(sizeof(CGGlyph) * length);
528         int *uniChars = (int *)malloc(sizeof(int) * length);
529         CGSize *advances = (CGSize *)malloc(sizeof(CGSize) * length);
530 
531         if (glyphs == NULL || uniChars == NULL || advances == NULL)
532         {
533             (*env)-&gt;DeleteLocalRef(env, glyphsArray);
<span class="line-modified">534             [NSException raise:NSMallocException format:@&quot;%s-%s:%d&quot;, THIS_FILE, __FUNCTION__, __LINE__];</span>
535             if (glyphs)
536             {
537                 free(glyphs);
538             }
539             if (uniChars)
540             {
541                 free(uniChars);
542             }
543             if (advances)
544             {
545                 free(advances);
546             }
547             return;
548         }
549 
550         doDrawGlyphsPipe_fillGlyphAndAdvanceBuffers(env, qsdo, strike, gVector, glyphs, uniChars, advances, length, glyphsArray);
551 
552         free(glyphs);
553         free(uniChars);
554         free(advances);
</pre>
</td>
<td>
<hr />
<pre>
 19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 20  *
 21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 22  * or visit www.oracle.com if you need additional information or have any
 23  * questions.
 24  */
 25 
 26 //  Native side of the Quartz text pipe, paints on Quartz Surface Datas.
 27 //  Interesting Docs : /Developer/Documentation/Cocoa/TasksAndConcepts/ProgrammingTopics/FontHandling/FontHandling.html
 28 
 29 #import &quot;sun_awt_SunHints.h&quot;
 30 #import &quot;sun_lwawt_macosx_CTextPipe.h&quot;
 31 #import &quot;sun_java2d_OSXSurfaceData.h&quot;
 32 
 33 #import &lt;JavaNativeFoundation/JavaNativeFoundation.h&gt;
 34 
 35 #import &quot;CoreTextSupport.h&quot;
 36 #import &quot;QuartzSurfaceData.h&quot;
 37 #include &quot;AWTStrike.h&quot;
 38 





 39 static const CGAffineTransform sInverseTX = { 1, 0, 0, -1, 0, 0 };
 40 
 41 
 42 #pragma mark --- CoreText Support ---
 43 
 44 
 45 // Translates a Unicode into a CGGlyph/CTFontRef pair
 46 // Returns the substituted font, and places the appropriate glyph into &quot;glyphRef&quot;
 47 CTFontRef JavaCT_CopyCTFallbackFontAndGlyphForUnicode
 48 (const AWTFont *font, const UTF16Char *charRef, CGGlyph *glyphRef, int count) {
 49     CTFontRef fallback = JRSFontCreateFallbackFontForCharacters((CTFontRef)font-&gt;fFont, charRef, count);
 50     if (fallback == NULL)
 51     {
 52         // use the original font if we somehow got duped into trying to fallback something we can&#39;t
 53         fallback = (CTFontRef)font-&gt;fFont;
 54         CFRetain(fallback);
 55     }
 56 
 57     CTFontGetGlyphsForCharacters(fallback, charRef, glyphRef, count);
 58     return fallback;
</pre>
<hr />
<pre>
509     }
510 
511     if (length &lt; MAX_STACK_ALLOC_GLYPH_BUFFER_SIZE)
512     {
513         // if we are small enough, fit everything onto the stack
514         CGGlyph glyphs[length];
515         int uniChars[length];
516         CGSize advances[length];
517         doDrawGlyphsPipe_fillGlyphAndAdvanceBuffers(env, qsdo, strike, gVector, glyphs, uniChars, advances, length, glyphsArray);
518     }
519     else
520     {
521         // otherwise, we should malloc and free buffers for this large run
522         CGGlyph *glyphs = (CGGlyph *)malloc(sizeof(CGGlyph) * length);
523         int *uniChars = (int *)malloc(sizeof(int) * length);
524         CGSize *advances = (CGSize *)malloc(sizeof(CGSize) * length);
525 
526         if (glyphs == NULL || uniChars == NULL || advances == NULL)
527         {
528             (*env)-&gt;DeleteLocalRef(env, glyphsArray);
<span class="line-modified">529             [NSException raise:NSMallocException format:@&quot;%s-%s:%d&quot;, __FILE__, __FUNCTION__, __LINE__];</span>
530             if (glyphs)
531             {
532                 free(glyphs);
533             }
534             if (uniChars)
535             {
536                 free(uniChars);
537             }
538             if (advances)
539             {
540                 free(advances);
541             }
542             return;
543         }
544 
545         doDrawGlyphsPipe_fillGlyphAndAdvanceBuffers(env, qsdo, strike, gVector, glyphs, uniChars, advances, length, glyphsArray);
546 
547         free(glyphs);
548         free(uniChars);
549         free(advances);
</pre>
</td>
</tr>
</table>
<center><a href="CSystemColors.m.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="../font/AWTStrike.m.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>