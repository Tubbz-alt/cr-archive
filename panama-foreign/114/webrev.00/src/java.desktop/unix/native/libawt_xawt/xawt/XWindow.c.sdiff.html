<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/java.desktop/unix/native/libawt_xawt/xawt/XWindow.c</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
  </head>
<body>
<center><a href="XToolkit.c.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="../../../../windows/classes/sun/awt/windows/WPathGraphics.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/java.desktop/unix/native/libawt_xawt/xawt/XWindow.c</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
   1 /*
<span class="line-modified">   2  * Copyright (c) 2002, 2019, Oracle and/or its affiliates. All rights reserved.</span>
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.  Oracle designates this
   8  * particular file as subject to the &quot;Classpath&quot; exception as provided
   9  * by Oracle in the LICENSE file that accompanied this code.
  10  *
  11  * This code is distributed in the hope that it will be useful, but WITHOUT
  12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  14  * version 2 for more details (a copy is included in the LICENSE file that
  15  * accompanied this code).
  16  *
  17  * You should have received a copy of the GNU General Public License version
  18  * 2 along with this work; if not, write to the Free Software Foundation,
  19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  20  *
  21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  22  * or visit www.oracle.com if you need additional information or have any
</pre>
<hr />
<pre>
1107     * perhaps different values of keysyms.
1108     * XXX: not anymore at the moment, but I&#39;ll still keep them as arrays
1109     * for a while.  If in the course of testing we will be satisfied with
1110     * a current single result from awt_x11inputmethod_lookupString, we&#39;ll
1111     * change this.
1112     */
1113    jlong testbuf[2];
1114 
1115    testbuf[1]=0;
1116 
1117    boo = awt_x11inputmethod_lookupString((XKeyPressedEvent*)jlong_to_ptr(event), &amp;keysym);
1118    testbuf[0] = keysym;
1119 
1120    (*env)-&gt;SetLongArrayRegion(env, keysymArray, 0, 2, (jlong *)(testbuf));
1121    return boo ? JNI_TRUE : JNI_FALSE;
1122 }
1123 
1124 
1125 extern struct X11GraphicsConfigIDs x11GraphicsConfigIDs;
1126 
<span class="line-removed">1127 /*</span>
<span class="line-removed">1128  * Class:     Java_sun_awt_X11_XWindow_getNativeColor</span>
<span class="line-removed">1129  * Method:    getNativeColor</span>
<span class="line-removed">1130  * Signature  (Ljava/awt/Color;Ljava/awt/GraphicsConfiguration;)I</span>
<span class="line-removed">1131  */</span>
<span class="line-removed">1132 JNIEXPORT jint JNICALL Java_sun_awt_X11_XWindow_getNativeColor</span>
<span class="line-removed">1133 (JNIEnv *env, jobject this, jobject color, jobject gc_object) {</span>
<span class="line-removed">1134     AwtGraphicsConfigDataPtr adata;</span>
<span class="line-removed">1135     /* fire warning because JNU_GetLongFieldAsPtr casts jlong to (void *) */</span>
<span class="line-removed">1136     adata = (AwtGraphicsConfigDataPtr) JNU_GetLongFieldAsPtr(env, gc_object, x11GraphicsConfigIDs.aData);</span>
<span class="line-removed">1137     return awtJNI_GetColorForVis(env, color, adata);</span>
<span class="line-removed">1138 }</span>
<span class="line-removed">1139 </span>
1140 /* syncTopLevelPos() is necessary to insure that the window manager has in
1141  * fact moved us to our final position relative to the reParented WM window.
1142  * We have noted a timing window which our shell has not been moved so we
1143  * screw up the insets thinking they are 0,0.  Wait (for a limited period of
1144  * time to let the WM hava a chance to move us
1145  */
1146 void syncTopLevelPos( Display *d, Window w, XWindowAttributes *winAttr ) {
1147     int32_t i = 0;
1148     do {
1149          XGetWindowAttributes( d, w, winAttr );
1150          /* Sometimes we get here before the WM has updated the
1151          ** window data struct with the correct position.  Loop
1152          ** until we get a non-zero position.
1153          */
1154          if ((winAttr-&gt;x != 0) || (winAttr-&gt;y != 0)) {
1155              break;
1156          }
1157          else {
1158              /* What we really want here is to sync with the WM,
1159              ** but there&#39;s no explicit way to do this, so we
1160              ** call XSync for a delay.
1161              */
1162              XSync(d, False);
1163          }
1164     } while (i++ &lt; 50);
1165 }
1166 
<span class="line-removed">1167 static Window getTopWindow(Window win, Window *rootWin)</span>
<span class="line-removed">1168 {</span>
<span class="line-removed">1169     Window root=None, current_window=win, parent=None, *ignore_children=NULL;</span>
<span class="line-removed">1170     Window prev_window=None;</span>
<span class="line-removed">1171     unsigned int ignore_uint=0;</span>
<span class="line-removed">1172     Status status = 0;</span>
<span class="line-removed">1173 </span>
<span class="line-removed">1174     if (win == None) return None;</span>
<span class="line-removed">1175     do {</span>
<span class="line-removed">1176         status = XQueryTree(awt_display,</span>
<span class="line-removed">1177                             current_window,</span>
<span class="line-removed">1178                             &amp;root,</span>
<span class="line-removed">1179                             &amp;parent,</span>
<span class="line-removed">1180                             &amp;ignore_children,</span>
<span class="line-removed">1181                             &amp;ignore_uint);</span>
<span class="line-removed">1182         XFree(ignore_children);</span>
<span class="line-removed">1183         if (status == 0) return None;</span>
<span class="line-removed">1184         prev_window = current_window;</span>
<span class="line-removed">1185         current_window = parent;</span>
<span class="line-removed">1186     } while (parent != root);</span>
<span class="line-removed">1187     *rootWin = root;</span>
<span class="line-removed">1188     return prev_window;</span>
<span class="line-removed">1189 }</span>
<span class="line-removed">1190 </span>
<span class="line-removed">1191 JNIEXPORT jlong JNICALL Java_sun_awt_X11_XWindow_getTopWindow</span>
<span class="line-removed">1192 (JNIEnv *env, jclass clazz, jlong win, jlong rootWin) {</span>
<span class="line-removed">1193     return getTopWindow((Window) win, (Window*) jlong_to_ptr(rootWin));</span>
<span class="line-removed">1194 }</span>
<span class="line-removed">1195 </span>
<span class="line-removed">1196 static void</span>
<span class="line-removed">1197 getWMInsets</span>
<span class="line-removed">1198 (Window window, int *left, int *top, int *right, int *bottom, int *border) {</span>
<span class="line-removed">1199     // window is event-&gt;xreparent.window</span>
<span class="line-removed">1200     Window topWin = None, rootWin = None, containerWindow = None;</span>
<span class="line-removed">1201     XWindowAttributes winAttr, topAttr;</span>
<span class="line-removed">1202     int screenX, screenY;</span>
<span class="line-removed">1203     topWin = getTopWindow(window, &amp;rootWin);</span>
<span class="line-removed">1204     syncTopLevelPos(awt_display, topWin, &amp;topAttr);</span>
<span class="line-removed">1205     // (screenX, screenY) is (0,0) of the reparented window</span>
<span class="line-removed">1206     // converted to screen coordinates.</span>
<span class="line-removed">1207     XTranslateCoordinates(awt_display, window, rootWin,</span>
<span class="line-removed">1208         0,0, &amp;screenX, &amp;screenY, &amp;containerWindow);</span>
<span class="line-removed">1209     *left = screenX - topAttr.x - topAttr.border_width;</span>
<span class="line-removed">1210     *top  = screenY - topAttr.y - topAttr.border_width;</span>
<span class="line-removed">1211     XGetWindowAttributes(awt_display, window, &amp;winAttr);</span>
<span class="line-removed">1212     *right  = topAttr.width  - ((winAttr.width)  + *left);</span>
<span class="line-removed">1213     *bottom = topAttr.height - ((winAttr.height) + *top);</span>
<span class="line-removed">1214     *border = topAttr.border_width;</span>
<span class="line-removed">1215 }</span>
<span class="line-removed">1216 </span>
<span class="line-removed">1217 JNIEXPORT void JNICALL Java_sun_awt_X11_XWindow_getWMInsets</span>
<span class="line-removed">1218 (JNIEnv *env, jclass clazz, jlong window, jlong left, jlong top, jlong right, jlong bottom, jlong border) {</span>
<span class="line-removed">1219     getWMInsets((Window) window,</span>
<span class="line-removed">1220                 (int*) jlong_to_ptr(left),</span>
<span class="line-removed">1221                 (int*) jlong_to_ptr(top),</span>
<span class="line-removed">1222                 (int*) jlong_to_ptr(right),</span>
<span class="line-removed">1223                 (int*) jlong_to_ptr(bottom),</span>
<span class="line-removed">1224                 (int*) jlong_to_ptr(border));</span>
<span class="line-removed">1225 }</span>
<span class="line-removed">1226 </span>
<span class="line-removed">1227 static void</span>
<span class="line-removed">1228 getWindowBounds</span>
<span class="line-removed">1229 (Window window, int *x, int *y, int *width, int *height) {</span>
<span class="line-removed">1230     XWindowAttributes winAttr;</span>
<span class="line-removed">1231     XSync(awt_display, False);</span>
<span class="line-removed">1232     XGetWindowAttributes(awt_display, window, &amp;winAttr);</span>
<span class="line-removed">1233     *x = winAttr.x;</span>
<span class="line-removed">1234     *y = winAttr.y;</span>
<span class="line-removed">1235     *width = winAttr.width;</span>
<span class="line-removed">1236     *height = winAttr.height;</span>
<span class="line-removed">1237 }</span>
<span class="line-removed">1238 </span>
<span class="line-removed">1239 JNIEXPORT void JNICALL Java_sun_awt_X11_XWindow_getWindowBounds</span>
<span class="line-removed">1240 (JNIEnv *env, jclass clazz, jlong window, jlong x, jlong y, jlong width, jlong height) {</span>
<span class="line-removed">1241     getWindowBounds((Window) window, (int*) jlong_to_ptr(x), (int*) jlong_to_ptr(y),</span>
<span class="line-removed">1242                     (int*) jlong_to_ptr(width), (int*) jlong_to_ptr(height));</span>
<span class="line-removed">1243 }</span>
<span class="line-removed">1244 </span>
1245 JNIEXPORT void JNICALL Java_sun_awt_X11_XWindow_setSizeHints
1246 (JNIEnv *env, jclass clazz, jlong window, jlong x, jlong y, jlong width, jlong height) {
1247     XSizeHints *size_hints = XAllocSizeHints();
1248     size_hints-&gt;flags = USPosition | PPosition | PSize;
1249     size_hints-&gt;x = (int)x;
1250     size_hints-&gt;y = (int)y;
1251     size_hints-&gt;width = (int)width;
1252     size_hints-&gt;height = (int)height;
1253     XSetWMNormalHints(awt_display, (Window)window, size_hints);
1254     XFree((char*)size_hints);
1255 }
1256 
1257 
1258 JNIEXPORT void JNICALL
1259 Java_sun_awt_X11_XWindow_initIDs
1260   (JNIEnv *env, jclass clazz)
1261 {
1262    char *ptr = NULL;
1263    windowID = (*env)-&gt;GetFieldID(env, clazz, &quot;window&quot;, &quot;J&quot;);
1264    CHECK_NULL(windowID);
</pre>
</td>
<td>
<hr />
<pre>
   1 /*
<span class="line-modified">   2  * Copyright (c) 2002, 2020, Oracle and/or its affiliates. All rights reserved.</span>
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.  Oracle designates this
   8  * particular file as subject to the &quot;Classpath&quot; exception as provided
   9  * by Oracle in the LICENSE file that accompanied this code.
  10  *
  11  * This code is distributed in the hope that it will be useful, but WITHOUT
  12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  14  * version 2 for more details (a copy is included in the LICENSE file that
  15  * accompanied this code).
  16  *
  17  * You should have received a copy of the GNU General Public License version
  18  * 2 along with this work; if not, write to the Free Software Foundation,
  19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  20  *
  21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  22  * or visit www.oracle.com if you need additional information or have any
</pre>
<hr />
<pre>
1107     * perhaps different values of keysyms.
1108     * XXX: not anymore at the moment, but I&#39;ll still keep them as arrays
1109     * for a while.  If in the course of testing we will be satisfied with
1110     * a current single result from awt_x11inputmethod_lookupString, we&#39;ll
1111     * change this.
1112     */
1113    jlong testbuf[2];
1114 
1115    testbuf[1]=0;
1116 
1117    boo = awt_x11inputmethod_lookupString((XKeyPressedEvent*)jlong_to_ptr(event), &amp;keysym);
1118    testbuf[0] = keysym;
1119 
1120    (*env)-&gt;SetLongArrayRegion(env, keysymArray, 0, 2, (jlong *)(testbuf));
1121    return boo ? JNI_TRUE : JNI_FALSE;
1122 }
1123 
1124 
1125 extern struct X11GraphicsConfigIDs x11GraphicsConfigIDs;
1126 













1127 /* syncTopLevelPos() is necessary to insure that the window manager has in
1128  * fact moved us to our final position relative to the reParented WM window.
1129  * We have noted a timing window which our shell has not been moved so we
1130  * screw up the insets thinking they are 0,0.  Wait (for a limited period of
1131  * time to let the WM hava a chance to move us
1132  */
1133 void syncTopLevelPos( Display *d, Window w, XWindowAttributes *winAttr ) {
1134     int32_t i = 0;
1135     do {
1136          XGetWindowAttributes( d, w, winAttr );
1137          /* Sometimes we get here before the WM has updated the
1138          ** window data struct with the correct position.  Loop
1139          ** until we get a non-zero position.
1140          */
1141          if ((winAttr-&gt;x != 0) || (winAttr-&gt;y != 0)) {
1142              break;
1143          }
1144          else {
1145              /* What we really want here is to sync with the WM,
1146              ** but there&#39;s no explicit way to do this, so we
1147              ** call XSync for a delay.
1148              */
1149              XSync(d, False);
1150          }
1151     } while (i++ &lt; 50);
1152 }
1153 














































































1154 JNIEXPORT void JNICALL Java_sun_awt_X11_XWindow_setSizeHints
1155 (JNIEnv *env, jclass clazz, jlong window, jlong x, jlong y, jlong width, jlong height) {
1156     XSizeHints *size_hints = XAllocSizeHints();
1157     size_hints-&gt;flags = USPosition | PPosition | PSize;
1158     size_hints-&gt;x = (int)x;
1159     size_hints-&gt;y = (int)y;
1160     size_hints-&gt;width = (int)width;
1161     size_hints-&gt;height = (int)height;
1162     XSetWMNormalHints(awt_display, (Window)window, size_hints);
1163     XFree((char*)size_hints);
1164 }
1165 
1166 
1167 JNIEXPORT void JNICALL
1168 Java_sun_awt_X11_XWindow_initIDs
1169   (JNIEnv *env, jclass clazz)
1170 {
1171    char *ptr = NULL;
1172    windowID = (*env)-&gt;GetFieldID(env, clazz, &quot;window&quot;, &quot;J&quot;);
1173    CHECK_NULL(windowID);
</pre>
</td>
</tr>
</table>
<center><a href="XToolkit.c.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="../../../../windows/classes/sun/awt/windows/WPathGraphics.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>