<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>New src/java.xml.crypto/share/classes/org/jcp/xml/dsig/internal/dom/DOMXMLSignatureFactory.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
  <body>
    <pre>
  1 /*
  2  * reserved comment block
  3  * DO NOT REMOVE OR ALTER!
  4  */
  5 /**
  6  * Licensed to the Apache Software Foundation (ASF) under one
  7  * or more contributor license agreements. See the NOTICE file
  8  * distributed with this work for additional information
  9  * regarding copyright ownership. The ASF licenses this file
 10  * to you under the Apache License, Version 2.0 (the
 11  * &quot;License&quot;); you may not use this file except in compliance
 12  * with the License. You may obtain a copy of the License at
 13  *
 14  * http://www.apache.org/licenses/LICENSE-2.0
 15  *
 16  * Unless required by applicable law or agreed to in writing,
 17  * software distributed under the License is distributed on an
 18  * &quot;AS IS&quot; BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
 19  * KIND, either express or implied. See the License for the
 20  * specific language governing permissions and limitations
 21  * under the License.
 22  */
 23 /*
 24  * Copyright (c) 2005, 2019, Oracle and/or its affiliates. All rights reserved.
 25  */
 26 /*
 27  * $Id: DOMXMLSignatureFactory.java 1854026 2019-02-21 09:30:01Z coheigea $
 28  */
 29 package org.jcp.xml.dsig.internal.dom;
 30 
 31 import javax.xml.crypto.*;
 32 import javax.xml.crypto.dom.DOMCryptoContext;
 33 import javax.xml.crypto.dsig.*;
 34 import javax.xml.crypto.dsig.dom.DOMValidateContext;
 35 import javax.xml.crypto.dsig.keyinfo.*;
 36 import javax.xml.crypto.dsig.spec.*;
 37 
 38 import java.security.InvalidAlgorithmParameterException;
 39 import java.security.NoSuchAlgorithmException;
 40 import java.util.List;
 41 
 42 import org.w3c.dom.Document;
 43 import org.w3c.dom.Element;
 44 import org.w3c.dom.Node;
 45 
 46 /**
 47  * DOM-based implementation of XMLSignatureFactory.
 48  *
 49  */
 50 public final class DOMXMLSignatureFactory extends XMLSignatureFactory {
 51 
 52     /**
 53      * Initializes a new instance of this class.
 54      */
 55     public DOMXMLSignatureFactory() {}
 56 
 57     public XMLSignature newXMLSignature(SignedInfo si, KeyInfo ki) {
 58         return new DOMXMLSignature(si, ki, null, null, null);
 59     }
 60 
 61     @SuppressWarnings({ &quot;unchecked&quot;, &quot;rawtypes&quot; })
 62     public XMLSignature newXMLSignature(SignedInfo si, KeyInfo ki,
 63         List objects, String id, String signatureValueId) {
 64         return new DOMXMLSignature(si, ki, objects, id, signatureValueId);
 65     }
 66 
 67     public Reference newReference(String uri, DigestMethod dm) {
 68         return newReference(uri, dm, null, null, null);
 69     }
 70 
 71     @SuppressWarnings({ &quot;unchecked&quot;, &quot;rawtypes&quot; })
 72     public Reference newReference(String uri, DigestMethod dm, List transforms,
 73         String type, String id) {
 74         return new DOMReference(uri, type, dm, transforms, id, getProvider());
 75     }
 76 
 77     @Override
 78     @SuppressWarnings({ &quot;unchecked&quot;, &quot;rawtypes&quot; })
 79     public Reference newReference(String uri, DigestMethod dm,
 80         List appliedTransforms, Data result, List transforms, String type,
 81         String id) {
 82         if (appliedTransforms == null) {
 83             throw new NullPointerException(&quot;appliedTransforms cannot be null&quot;);
 84         }
 85         if (appliedTransforms.isEmpty()) {
 86             throw new NullPointerException(&quot;appliedTransforms cannot be empty&quot;);
 87         }
 88         if (result == null) {
 89             throw new NullPointerException(&quot;result cannot be null&quot;);
 90         }
 91         return new DOMReference
 92             (uri, type, dm, appliedTransforms, result, transforms, id, getProvider());
 93     }
 94 
 95     @SuppressWarnings({ &quot;unchecked&quot;, &quot;rawtypes&quot; })
 96     public Reference newReference(String uri, DigestMethod dm, List transforms,
 97         String type, String id, byte[] digestValue) {
 98         if (digestValue == null) {
 99             throw new NullPointerException(&quot;digestValue cannot be null&quot;);
100         }
101         return new DOMReference
102             (uri, type, dm, null, null, transforms, id, digestValue, getProvider());
103     }
104 
105     @SuppressWarnings({ &quot;rawtypes&quot; })
106     public SignedInfo newSignedInfo(CanonicalizationMethod cm,
107         SignatureMethod sm, List references) {
108         return newSignedInfo(cm, sm, references, null);
109     }
110 
111     @SuppressWarnings({ &quot;unchecked&quot;, &quot;rawtypes&quot; })
112     public SignedInfo newSignedInfo(CanonicalizationMethod cm,
113         SignatureMethod sm, List references, String id) {
114         return new DOMSignedInfo(cm, sm, references, id);
115     }
116 
117     // Object factory methods
118     @SuppressWarnings({ &quot;unchecked&quot;, &quot;rawtypes&quot; })
119     public XMLObject newXMLObject(List content, String id, String mimeType,
120         String encoding) {
121         return new DOMXMLObject(content, id, mimeType, encoding);
122     }
123 
124     @SuppressWarnings({ &quot;rawtypes&quot; })
125     public Manifest newManifest(List references) {
126         return newManifest(references, null);
127     }
128 
129     @SuppressWarnings({ &quot;unchecked&quot;, &quot;rawtypes&quot; })
130     public Manifest newManifest(List references, String id) {
131         return new DOMManifest(references, id);
132     }
133 
134     @SuppressWarnings({ &quot;unchecked&quot;, &quot;rawtypes&quot; })
135     public SignatureProperties newSignatureProperties(List props, String id) {
136         return new DOMSignatureProperties(props, id);
137     }
138 
139     @SuppressWarnings({ &quot;unchecked&quot;, &quot;rawtypes&quot; })
140     public SignatureProperty newSignatureProperty
141         (List info, String target, String id) {
142         return new DOMSignatureProperty(info, target, id);
143     }
144 
145     public XMLSignature unmarshalXMLSignature(XMLValidateContext context)
146         throws MarshalException {
147 
148         if (context == null) {
149             throw new NullPointerException(&quot;context cannot be null&quot;);
150         }
151         return unmarshal(((DOMValidateContext) context).getNode(), context);
152     }
153 
154     public XMLSignature unmarshalXMLSignature(XMLStructure xmlStructure)
155         throws MarshalException {
156 
157         if (xmlStructure == null) {
158             throw new NullPointerException(&quot;xmlStructure cannot be null&quot;);
159         }
160         if (!(xmlStructure instanceof javax.xml.crypto.dom.DOMStructure)) {
161             throw new ClassCastException(&quot;xmlStructure must be of type DOMStructure&quot;);
162         }
163         return unmarshal
164             (((javax.xml.crypto.dom.DOMStructure) xmlStructure).getNode(),
165              new UnmarshalContext());
166     }
167 
168     private static class UnmarshalContext extends DOMCryptoContext {
169         UnmarshalContext() {}
170     }
171 
172     private XMLSignature unmarshal(Node node, XMLCryptoContext context)
173         throws MarshalException {
174 
175         node.normalize();
176 
177         Element element = null;
178         if (node.getNodeType() == Node.DOCUMENT_NODE) {
179             element = ((Document) node).getDocumentElement();
180         } else if (node.getNodeType() == Node.ELEMENT_NODE) {
181             element = (Element) node;
182         } else {
183             throw new MarshalException
184                 (&quot;Signature element is not a proper Node&quot;);
185         }
186 
187         // check tag
188         String tag = element.getLocalName();
189         String namespace = element.getNamespaceURI();
190         if (tag == null || namespace == null) {
191             throw new MarshalException(&quot;Document implementation must &quot; +
192                 &quot;support DOM Level 2 and be namespace aware&quot;);
193         }
194         if (&quot;Signature&quot;.equals(tag) &amp;&amp; XMLSignature.XMLNS.equals(namespace)) {
195             try {
196                 return new DOMXMLSignature(element, context, getProvider());
197             } catch (MarshalException me) {
198                 throw me;
199             } catch (Exception e) {
200                 throw new MarshalException(e);
201             }
202         } else {
203             throw new MarshalException(&quot;Invalid Signature tag: &quot; + namespace + &quot;:&quot; + tag);
204         }
205     }
206 
207     public boolean isFeatureSupported(String feature) {
208         if (feature == null) {
209             throw new NullPointerException();
210         } else {
211             return false;
212         }
213     }
214 
215     public DigestMethod newDigestMethod(String algorithm,
216         DigestMethodParameterSpec params) throws NoSuchAlgorithmException,
217         InvalidAlgorithmParameterException {
218         if (algorithm == null) {
219             throw new NullPointerException();
220         }
221         if (algorithm.equals(DigestMethod.SHA1)) {
222             return new DOMDigestMethod.SHA1(params);
223         } else if (algorithm.equals(DOMDigestMethod.SHA224)) {
224             return new DOMDigestMethod.SHA224(params);
225         } else if (algorithm.equals(DigestMethod.SHA256)) {
226             return new DOMDigestMethod.SHA256(params);
227         } else if (algorithm.equals(DOMDigestMethod.SHA384)) {
228             return new DOMDigestMethod.SHA384(params);
229         } else if (algorithm.equals(DigestMethod.SHA512)) {
230             return new DOMDigestMethod.SHA512(params);
231         } else if (algorithm.equals(DigestMethod.RIPEMD160)) {
232             return new DOMDigestMethod.RIPEMD160(params);
233         } else if (algorithm.equals(DOMDigestMethod.WHIRLPOOL)) {
234             return new DOMDigestMethod.WHIRLPOOL(params);
235         } else if (algorithm.equals(DOMDigestMethod.SHA3_224)) {
236             return new DOMDigestMethod.SHA3_224(params);
237         } else if (algorithm.equals(DOMDigestMethod.SHA3_256)) {
238             return new DOMDigestMethod.SHA3_256(params);
239         } else if (algorithm.equals(DOMDigestMethod.SHA3_384)) {
240             return new DOMDigestMethod.SHA3_384(params);
241         } else if (algorithm.equals(DOMDigestMethod.SHA3_512)) {
242             return new DOMDigestMethod.SHA3_512(params);
243         } else {
244             throw new NoSuchAlgorithmException(&quot;unsupported algorithm&quot;);
245         }
246     }
247 
248     public SignatureMethod newSignatureMethod(String algorithm,
249         SignatureMethodParameterSpec params) throws NoSuchAlgorithmException,
250         InvalidAlgorithmParameterException {
251         if (algorithm == null) {
252             throw new NullPointerException();
253         }
254         if (algorithm.equals(SignatureMethod.RSA_SHA1)) {
255             return new DOMSignatureMethod.SHA1withRSA(params);
256         } else if (algorithm.equals(DOMSignatureMethod.RSA_SHA224)) {
257             return new DOMSignatureMethod.SHA224withRSA(params);
258         } else if (algorithm.equals(DOMSignatureMethod.RSA_SHA256)) {
259             return new DOMSignatureMethod.SHA256withRSA(params);
260         } else if (algorithm.equals(DOMSignatureMethod.RSA_SHA384)) {
261             return new DOMSignatureMethod.SHA384withRSA(params);
262         } else if (algorithm.equals(DOMSignatureMethod.RSA_SHA512)) {
263             return new DOMSignatureMethod.SHA512withRSA(params);
264         } else if (algorithm.equals(DOMSignatureMethod.RSA_RIPEMD160)) {
265             return new DOMSignatureMethod.RIPEMD160withRSA(params);
266         } else if (algorithm.equals(DOMSignatureMethod.RSA_SHA1_MGF1)) {
267             return new DOMSignatureMethod.SHA1withRSAandMGF1(params);
268         } else if (algorithm.equals(DOMSignatureMethod.RSA_SHA224_MGF1)) {
269             return new DOMSignatureMethod.SHA224withRSAandMGF1(params);
270         } else if (algorithm.equals(DOMSignatureMethod.RSA_SHA256_MGF1)) {
271             return new DOMSignatureMethod.SHA256withRSAandMGF1(params);
272         } else if (algorithm.equals(DOMSignatureMethod.RSA_SHA384_MGF1)) {
273             return new DOMSignatureMethod.SHA384withRSAandMGF1(params);
274         } else if (algorithm.equals(DOMSignatureMethod.RSA_SHA512_MGF1)) {
275             return new DOMSignatureMethod.SHA512withRSAandMGF1(params);
276         } else if (algorithm.equals(DOMSignatureMethod.RSA_RIPEMD160_MGF1)) {
277             return new DOMSignatureMethod.RIPEMD160withRSAandMGF1(params);
278         } else if (algorithm.equals(SignatureMethod.DSA_SHA1)) {
279             return new DOMSignatureMethod.SHA1withDSA(params);
280         } else if (algorithm.equals(DOMSignatureMethod.DSA_SHA256)) {
281             return new DOMSignatureMethod.SHA256withDSA(params);
282         } else if (algorithm.equals(SignatureMethod.HMAC_SHA1)) {
283             return new DOMHMACSignatureMethod.SHA1(params);
284         } else if (algorithm.equals(DOMHMACSignatureMethod.HMAC_SHA224)) {
285             return new DOMHMACSignatureMethod.SHA224(params);
286         } else if (algorithm.equals(DOMHMACSignatureMethod.HMAC_SHA256)) {
287             return new DOMHMACSignatureMethod.SHA256(params);
288         } else if (algorithm.equals(DOMHMACSignatureMethod.HMAC_SHA384)) {
289             return new DOMHMACSignatureMethod.SHA384(params);
290         } else if (algorithm.equals(DOMHMACSignatureMethod.HMAC_SHA512)) {
291             return new DOMHMACSignatureMethod.SHA512(params);
292         } else if (algorithm.equals(DOMHMACSignatureMethod.HMAC_RIPEMD160)) {
293             return new DOMHMACSignatureMethod.RIPEMD160(params);
294         } else if (algorithm.equals(DOMSignatureMethod.ECDSA_SHA1)) {
295             return new DOMSignatureMethod.SHA1withECDSA(params);
296         } else if (algorithm.equals(DOMSignatureMethod.ECDSA_SHA224)) {
297             return new DOMSignatureMethod.SHA224withECDSA(params);
298         } else if (algorithm.equals(DOMSignatureMethod.ECDSA_SHA256)) {
299             return new DOMSignatureMethod.SHA256withECDSA(params);
300         } else if (algorithm.equals(DOMSignatureMethod.ECDSA_SHA384)) {
301             return new DOMSignatureMethod.SHA384withECDSA(params);
302         } else if (algorithm.equals(DOMSignatureMethod.ECDSA_SHA512)) {
303             return new DOMSignatureMethod.SHA512withECDSA(params);
304         } else if (algorithm.equals(DOMSignatureMethod.ECDSA_RIPEMD160)) {
305             return new DOMSignatureMethod.RIPEMD160withECDSA(params);
306         }else {
307             throw new NoSuchAlgorithmException(&quot;unsupported algorithm&quot;);
308         }
309     }
310 
311     public Transform newTransform(String algorithm,
312         TransformParameterSpec params) throws NoSuchAlgorithmException,
313         InvalidAlgorithmParameterException {
314 
315         TransformService spi;
316         if (getProvider() == null) {
317             spi = TransformService.getInstance(algorithm, &quot;DOM&quot;);
318         } else {
319             try {
320                 spi = TransformService.getInstance(algorithm, &quot;DOM&quot;, getProvider());
321             } catch (NoSuchAlgorithmException nsae) {
322                 spi = TransformService.getInstance(algorithm, &quot;DOM&quot;);
323             }
324         }
325 
326         spi.init(params);
327         return new DOMTransform(spi);
328     }
329 
330     public Transform newTransform(String algorithm,
331         XMLStructure params) throws NoSuchAlgorithmException,
332         InvalidAlgorithmParameterException {
333         TransformService spi;
334         if (getProvider() == null) {
335             spi = TransformService.getInstance(algorithm, &quot;DOM&quot;);
336         } else {
337             try {
338                 spi = TransformService.getInstance(algorithm, &quot;DOM&quot;, getProvider());
339             } catch (NoSuchAlgorithmException nsae) {
340                 spi = TransformService.getInstance(algorithm, &quot;DOM&quot;);
341             }
342         }
343 
344         if (params == null) {
345             spi.init(null);
346         } else {
347             spi.init(params, null);
348         }
349         return new DOMTransform(spi);
350     }
351 
352     public CanonicalizationMethod newCanonicalizationMethod(String algorithm,
353         C14NMethodParameterSpec params) throws NoSuchAlgorithmException,
354         InvalidAlgorithmParameterException {
355         TransformService spi;
356         if (getProvider() == null) {
357             spi = TransformService.getInstance(algorithm, &quot;DOM&quot;);
358         } else {
359             try {
360                 spi = TransformService.getInstance(algorithm, &quot;DOM&quot;, getProvider());
361             } catch (NoSuchAlgorithmException nsae) {
362                 spi = TransformService.getInstance(algorithm, &quot;DOM&quot;);
363             }
364         }
365 
366         spi.init(params);
367         return new DOMCanonicalizationMethod(spi);
368     }
369 
370     public CanonicalizationMethod newCanonicalizationMethod(String algorithm,
371         XMLStructure params) throws NoSuchAlgorithmException,
372         InvalidAlgorithmParameterException {
373         TransformService spi;
374         if (getProvider() == null) {
375             spi = TransformService.getInstance(algorithm, &quot;DOM&quot;);
376         } else {
377             try {
378                 spi = TransformService.getInstance(algorithm, &quot;DOM&quot;, getProvider());
379             } catch (NoSuchAlgorithmException nsae) {
380                 spi = TransformService.getInstance(algorithm, &quot;DOM&quot;);
381             }
382         }
383         if (params == null) {
384             spi.init(null);
385         } else {
386             spi.init(params, null);
387         }
388 
389         return new DOMCanonicalizationMethod(spi);
390     }
391 
392     public URIDereferencer getURIDereferencer() {
393         return DOMURIDereferencer.INSTANCE;
394     }
395 }
    </pre>
  </body>
</html>