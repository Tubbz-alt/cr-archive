<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Old src/sample/nashorn/find_nonfinals.js</title>
    <link rel="stylesheet" href="../../../style.css" />
  </head>
  <body>
    <pre>
  1 /*
  2  * Copyright (c) 2014, Oracle and/or its affiliates. All rights reserved.
  3  *
  4  * Redistribution and use in source and binary forms, with or without
  5  * modification, are permitted provided that the following conditions
  6  * are met:
  7  *
  8  *   - Redistributions of source code must retain the above copyright
  9  *     notice, this list of conditions and the following disclaimer.
 10  *
 11  *   - Redistributions in binary form must reproduce the above copyright
 12  *     notice, this list of conditions and the following disclaimer in the
 13  *     documentation and/or other materials provided with the distribution.
 14  *
 15  *   - Neither the name of Oracle nor the names of its
 16  *     contributors may be used to endorse or promote products derived
 17  *     from this software without specific prior written permission.
 18  *
 19  * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS &quot;AS
 20  * IS&quot; AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO,
 21  * THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
 22  * PURPOSE ARE DISCLAIMED.  IN NO EVENT SHALL THE COPYRIGHT OWNER OR
 23  * CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL,
 24  * EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO,
 25  * PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR
 26  * PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF
 27  * LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING
 28  * NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS
 29  * SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 30  */
 31 
 32 /**
 33  * Nashorn project uses &quot;final&quot; modifier for method parameters
 34  * (like &#39;val&#39; of Scala). This tool finds method parameters that
 35  * miss final modifier.
 36  */
 37 
 38 // Usage: jjs -J-Djava.ext.dirs=&lt;your_nashorn_jar_dir&gt; find_nonfinals.js
 39 
 40 var Class = Java.type(&quot;java.lang.Class&quot;);
 41 var System = Java.type(&quot;java.lang.System&quot;);
 42 var Thread = Java.type(&quot;java.lang.Thread&quot;);
 43 var File = Java.type(&quot;java.io.File&quot;);
 44 var JarFile = Java.type(&quot;java.util.jar.JarFile&quot;);
 45 var Modifier = Java.type(&quot;java.lang.reflect.Modifier&quot;);
 46 
 47 // locate nashorn.jar from java.ext.dirs
 48 function findNashorn() {
 49     var paths = System.getProperty(&quot;java.ext.dirs&quot;).split(File.pathSeparator);
 50     for each (var p in paths) {
 51         var nashorn = p + File.separator + &quot;nashorn.jar&quot;;
 52         if (new File(nashorn).exists()) {
 53             return nashorn;
 54         }
 55     }
 56 }
 57 
 58 // analyze a single Class and print info on non-final parameters
 59 function analyzeClass(cls) {
 60     var methods = cls.getDeclaredMethods();
 61     for each (var method in methods) {
 62         var methodModifiers = method.modifiers;
 63         if (Modifier.isAbstract(methodModifiers) || Modifier.isNative(methodModifiers)) {
 64             continue;
 65         }
 66         // this requires -parameters option when compiling java sources
 67         var params = method.parameters;
 68         for each (var p in params) {
 69            var modifiers = p.modifiers;
 70            if (!Modifier.isFinal(modifiers)) {
 71                if (! method.name.startsWith(&quot;access$&quot;)) {
 72                    print(method);
 73                    print(&quot; -&gt;&quot;, p);
 74                }
 75            }
 76         }
 77     }
 78 }
 79 
 80 var jarFile = findNashorn();
 81 var ctxtLoader = Thread.currentThread().contextClassLoader;
 82 
 83 // load each class and use reflection to analyze each Class
 84 new JarFile(jarFile).stream().forEach(
 85     function(entry) {
 86         var name = entry.name;
 87         if (name.endsWith(&quot;.class&quot;)) {
 88             var clsName = name.substring(0, name.lastIndexOf(&#39;.class&#39;));
 89             clsName = clsName.replace(/\//g, &#39;.&#39;);
 90             try {
 91                 // don&#39;t initialize to avoid for possible initialization errors 
 92                 var cls = Class.forName(clsName, false, ctxtLoader);
 93                 analyzeClass(cls);
 94             } catch (e) {
 95                 // print exception and continue analysis for other classes
 96                 print(&quot;Failed to analyze &quot; + clsName);
 97                 e.printStackTrace();
 98             }
 99         }
100     }
101 )
    </pre>
  </body>
</html>