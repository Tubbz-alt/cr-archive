<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/jdk.jartool/share/classes/jdk/security/jarsigner/JarSigner.java</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
  </head>
<body>
<center><a href="../../../com/sun/jarsigner/package-info.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="../../../sun/security/tools/jarsigner/Main.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/jdk.jartool/share/classes/jdk/security/jarsigner/JarSigner.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  17  * You should have received a copy of the GNU General Public License version
  18  * 2 along with this work; if not, write to the Free Software Foundation,
  19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  20  *
  21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  22  * or visit www.oracle.com if you need additional information or have any
  23  * questions.
  24  */
  25 
  26 package jdk.security.jarsigner;
  27 
  28 import com.sun.jarsigner.ContentSigner;
  29 import com.sun.jarsigner.ContentSignerParameters;
  30 import sun.security.tools.PathList;
  31 import sun.security.tools.jarsigner.TimestampedSigner;
  32 import sun.security.util.ManifestDigester;
  33 import sun.security.util.SignatureFileVerifier;
  34 import sun.security.x509.AlgorithmId;
  35 
  36 import java.io.*;

  37 import java.net.SocketTimeoutException;
  38 import java.net.URI;
  39 import java.net.URL;
  40 import java.net.URLClassLoader;
  41 import java.security.*;
  42 import java.security.cert.CertPath;
  43 import java.security.cert.Certificate;
  44 import java.security.cert.CertificateException;
  45 import java.security.cert.X509Certificate;
  46 import java.util.*;
  47 import java.util.function.BiConsumer;
  48 import java.util.jar.Attributes;
  49 import java.util.jar.JarEntry;
  50 import java.util.jar.JarFile;
  51 import java.util.jar.Manifest;
  52 import java.util.zip.ZipEntry;
  53 import java.util.zip.ZipFile;
  54 import java.util.zip.ZipOutputStream;
  55 
  56 /**
</pre>
<hr />
<pre>
 824         SignatureFile sf = new SignatureFile(digests, manifest, manDig,
 825                 signerName, signManifest);
 826 
 827         byte[] block;
 828 
 829         Signature signer;
 830         if (sigProvider == null ) {
 831             signer = Signature.getInstance(sigalg);
 832         } else {
 833             signer = Signature.getInstance(sigalg, sigProvider);
 834         }
 835         signer.initSign(privateKey);
 836 
 837         baos.reset();
 838         sf.write(baos);
 839         byte[] content = baos.toByteArray();
 840 
 841         signer.update(content);
 842         byte[] signature = signer.sign();
 843 
<span class="line-modified"> 844         @SuppressWarnings(&quot;deprecation&quot;)</span>
 845         ContentSigner signingMechanism = null;
 846         if (altSigner != null) {
 847             signingMechanism = loadSigningMechanism(altSigner,
 848                     altSignerPath);
 849         }
 850 
<span class="line-modified"> 851         @SuppressWarnings(&quot;deprecation&quot;)</span>
 852         ContentSignerParameters params =
 853                 new JarSignerParameters(null, tsaUrl, tSAPolicyID,
 854                         tSADigestAlg, signature,
 855                         signer.getAlgorithm(), certChain, content, zipFile);
 856         block = sf.generateBlock(params, externalSF, signingMechanism);
 857 
 858         String sfFilename = sf.getMetaName();
 859         String bkFilename = sf.getBlockName(privateKey);
 860 
 861         ZipEntry sfFile = new ZipEntry(sfFilename);
 862         ZipEntry bkFile = new ZipEntry(bkFilename);
 863 
 864         long time = System.currentTimeMillis();
 865         sfFile.setTime(time);
 866         bkFile.setTime(time);
 867 
 868         // signature file
 869         zos.putNextEntry(sfFile);
 870         sf.write(zos);
 871 
</pre>
<hr />
<pre>
1041                 for (i = 0; i &lt; digests.length; i++) {
1042                     digests[i].update(buffer, 0, n);
1043                 }
1044                 left -= n;
1045             }
1046         }
1047 
1048         // complete the digests
1049         String[] base64Digests = new String[digests.length];
1050         for (i = 0; i &lt; digests.length; i++) {
1051             base64Digests[i] = Base64.getEncoder()
1052                     .encodeToString(digests[i].digest());
1053         }
1054         return base64Digests;
1055     }
1056 
1057     /*
1058      * Try to load the specified signing mechanism.
1059      * The URL class loader is used.
1060      */
<span class="line-modified">1061     @SuppressWarnings(&quot;deprecation&quot;)</span>
1062     private ContentSigner loadSigningMechanism(String signerClassName,
1063                                                String signerClassPath) {
1064 





1065         // construct class loader
1066         String cpString;   // make sure env.class.path defaults to dot
1067 
1068         // do prepends to get correct ordering
1069         cpString = PathList.appendPath(
1070                 System.getProperty(&quot;env.class.path&quot;), null);
1071         cpString = PathList.appendPath(
1072                 System.getProperty(&quot;java.class.path&quot;), cpString);
1073         cpString = PathList.appendPath(signerClassPath, cpString);
1074         URL[] urls = PathList.pathToURLs(cpString);
1075         ClassLoader appClassLoader = new URLClassLoader(urls);
1076 
1077         try {
1078             // attempt to find signer
1079             Class&lt;?&gt; signerClass = appClassLoader.loadClass(signerClassName);
<span class="line-modified">1080             Object signer = signerClass.newInstance();</span>
1081             return (ContentSigner) signer;
1082         } catch (ClassNotFoundException|InstantiationException|
<span class="line-modified">1083                 IllegalAccessException|ClassCastException e) {</span>

1084             throw new IllegalArgumentException(
1085                     &quot;Invalid altSigner or altSignerPath&quot;, e);
1086         }
1087     }
1088 
1089     static class SignatureFile {
1090 
1091         /**
1092          * SignatureFile
1093          */
1094         Manifest sf;
1095 
1096         /**
1097          * .SF base name
1098          */
1099         String baseName;
1100 
1101         public SignatureFile(MessageDigest digests[],
1102                              Manifest mf,
1103                              ManifestDigester md,
</pre>
<hr />
<pre>
1157         public void write(OutputStream out) throws IOException {
1158             sf.write(out);
1159         }
1160 
1161         private static String getBaseSignatureFilesName(String baseName) {
1162             return &quot;META-INF/&quot; + baseName + &quot;.&quot;;
1163         }
1164 
1165         // get .SF file name
1166         public String getMetaName() {
1167             return getBaseSignatureFilesName(baseName) + &quot;SF&quot;;
1168         }
1169 
1170         // get .DSA (or .DSA, .EC) file name
1171         public String getBlockName(PrivateKey privateKey) {
1172             String keyAlgorithm = privateKey.getAlgorithm();
1173             return getBaseSignatureFilesName(baseName) + keyAlgorithm;
1174         }
1175 
1176         // Generates the PKCS#7 content of block file
<span class="line-modified">1177         @SuppressWarnings(&quot;deprecation&quot;)</span>
1178         public byte[] generateBlock(ContentSignerParameters params,
1179                                     boolean externalSF,
1180                                     ContentSigner signingMechanism)
1181                 throws NoSuchAlgorithmException,
1182                        IOException, CertificateException {
1183 
1184             if (signingMechanism == null) {
1185                 signingMechanism = new TimestampedSigner();
1186             }
1187             return signingMechanism.generateSignedData(
1188                     params,
1189                     externalSF,
1190                     params.getTimestampingAuthority() != null
1191                         || params.getTimestampingAuthorityCertificate() != null);
1192         }
1193     }
1194 
<span class="line-modified">1195     @SuppressWarnings(&quot;deprecation&quot;)</span>
1196     class JarSignerParameters implements ContentSignerParameters {
1197 
1198         private String[] args;
1199         private URI tsa;
1200         private byte[] signature;
1201         private String signatureAlgorithm;
1202         private X509Certificate[] signerCertificateChain;
1203         private byte[] content;
1204         private ZipFile source;
1205         private String tSAPolicyID;
1206         private String tSADigestAlg;
1207 
1208         JarSignerParameters(String[] args, URI tsa,
1209                             String tSAPolicyID, String tSADigestAlg,
1210                             byte[] signature, String signatureAlgorithm,
1211                             X509Certificate[] signerCertificateChain,
1212                             byte[] content, ZipFile source) {
1213 
1214             Objects.requireNonNull(signature);
1215             Objects.requireNonNull(signatureAlgorithm);
</pre>
</td>
<td>
<hr />
<pre>
  17  * You should have received a copy of the GNU General Public License version
  18  * 2 along with this work; if not, write to the Free Software Foundation,
  19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  20  *
  21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  22  * or visit www.oracle.com if you need additional information or have any
  23  * questions.
  24  */
  25 
  26 package jdk.security.jarsigner;
  27 
  28 import com.sun.jarsigner.ContentSigner;
  29 import com.sun.jarsigner.ContentSignerParameters;
  30 import sun.security.tools.PathList;
  31 import sun.security.tools.jarsigner.TimestampedSigner;
  32 import sun.security.util.ManifestDigester;
  33 import sun.security.util.SignatureFileVerifier;
  34 import sun.security.x509.AlgorithmId;
  35 
  36 import java.io.*;
<span class="line-added">  37 import java.lang.reflect.InvocationTargetException;</span>
  38 import java.net.SocketTimeoutException;
  39 import java.net.URI;
  40 import java.net.URL;
  41 import java.net.URLClassLoader;
  42 import java.security.*;
  43 import java.security.cert.CertPath;
  44 import java.security.cert.Certificate;
  45 import java.security.cert.CertificateException;
  46 import java.security.cert.X509Certificate;
  47 import java.util.*;
  48 import java.util.function.BiConsumer;
  49 import java.util.jar.Attributes;
  50 import java.util.jar.JarEntry;
  51 import java.util.jar.JarFile;
  52 import java.util.jar.Manifest;
  53 import java.util.zip.ZipEntry;
  54 import java.util.zip.ZipFile;
  55 import java.util.zip.ZipOutputStream;
  56 
  57 /**
</pre>
<hr />
<pre>
 825         SignatureFile sf = new SignatureFile(digests, manifest, manDig,
 826                 signerName, signManifest);
 827 
 828         byte[] block;
 829 
 830         Signature signer;
 831         if (sigProvider == null ) {
 832             signer = Signature.getInstance(sigalg);
 833         } else {
 834             signer = Signature.getInstance(sigalg, sigProvider);
 835         }
 836         signer.initSign(privateKey);
 837 
 838         baos.reset();
 839         sf.write(baos);
 840         byte[] content = baos.toByteArray();
 841 
 842         signer.update(content);
 843         byte[] signature = signer.sign();
 844 
<span class="line-modified"> 845         @SuppressWarnings(&quot;removal&quot;)</span>
 846         ContentSigner signingMechanism = null;
 847         if (altSigner != null) {
 848             signingMechanism = loadSigningMechanism(altSigner,
 849                     altSignerPath);
 850         }
 851 
<span class="line-modified"> 852         @SuppressWarnings(&quot;removal&quot;)</span>
 853         ContentSignerParameters params =
 854                 new JarSignerParameters(null, tsaUrl, tSAPolicyID,
 855                         tSADigestAlg, signature,
 856                         signer.getAlgorithm(), certChain, content, zipFile);
 857         block = sf.generateBlock(params, externalSF, signingMechanism);
 858 
 859         String sfFilename = sf.getMetaName();
 860         String bkFilename = sf.getBlockName(privateKey);
 861 
 862         ZipEntry sfFile = new ZipEntry(sfFilename);
 863         ZipEntry bkFile = new ZipEntry(bkFilename);
 864 
 865         long time = System.currentTimeMillis();
 866         sfFile.setTime(time);
 867         bkFile.setTime(time);
 868 
 869         // signature file
 870         zos.putNextEntry(sfFile);
 871         sf.write(zos);
 872 
</pre>
<hr />
<pre>
1042                 for (i = 0; i &lt; digests.length; i++) {
1043                     digests[i].update(buffer, 0, n);
1044                 }
1045                 left -= n;
1046             }
1047         }
1048 
1049         // complete the digests
1050         String[] base64Digests = new String[digests.length];
1051         for (i = 0; i &lt; digests.length; i++) {
1052             base64Digests[i] = Base64.getEncoder()
1053                     .encodeToString(digests[i].digest());
1054         }
1055         return base64Digests;
1056     }
1057 
1058     /*
1059      * Try to load the specified signing mechanism.
1060      * The URL class loader is used.
1061      */
<span class="line-modified">1062     @SuppressWarnings(&quot;removal&quot;)</span>
1063     private ContentSigner loadSigningMechanism(String signerClassName,
1064                                                String signerClassPath) {
1065 
<span class="line-added">1066         // If there is no signerClassPath provided, search from here</span>
<span class="line-added">1067         if (signerClassPath == null) {</span>
<span class="line-added">1068             signerClassPath = &quot;.&quot;;</span>
<span class="line-added">1069         }</span>
<span class="line-added">1070 </span>
1071         // construct class loader
1072         String cpString;   // make sure env.class.path defaults to dot
1073 
1074         // do prepends to get correct ordering
1075         cpString = PathList.appendPath(
1076                 System.getProperty(&quot;env.class.path&quot;), null);
1077         cpString = PathList.appendPath(
1078                 System.getProperty(&quot;java.class.path&quot;), cpString);
1079         cpString = PathList.appendPath(signerClassPath, cpString);
1080         URL[] urls = PathList.pathToURLs(cpString);
1081         ClassLoader appClassLoader = new URLClassLoader(urls);
1082 
1083         try {
1084             // attempt to find signer
1085             Class&lt;?&gt; signerClass = appClassLoader.loadClass(signerClassName);
<span class="line-modified">1086             Object signer = signerClass.getDeclaredConstructor().newInstance();</span>
1087             return (ContentSigner) signer;
1088         } catch (ClassNotFoundException|InstantiationException|
<span class="line-modified">1089                 IllegalAccessException|ClassCastException|</span>
<span class="line-added">1090                 NoSuchMethodException| InvocationTargetException e) {</span>
1091             throw new IllegalArgumentException(
1092                     &quot;Invalid altSigner or altSignerPath&quot;, e);
1093         }
1094     }
1095 
1096     static class SignatureFile {
1097 
1098         /**
1099          * SignatureFile
1100          */
1101         Manifest sf;
1102 
1103         /**
1104          * .SF base name
1105          */
1106         String baseName;
1107 
1108         public SignatureFile(MessageDigest digests[],
1109                              Manifest mf,
1110                              ManifestDigester md,
</pre>
<hr />
<pre>
1164         public void write(OutputStream out) throws IOException {
1165             sf.write(out);
1166         }
1167 
1168         private static String getBaseSignatureFilesName(String baseName) {
1169             return &quot;META-INF/&quot; + baseName + &quot;.&quot;;
1170         }
1171 
1172         // get .SF file name
1173         public String getMetaName() {
1174             return getBaseSignatureFilesName(baseName) + &quot;SF&quot;;
1175         }
1176 
1177         // get .DSA (or .DSA, .EC) file name
1178         public String getBlockName(PrivateKey privateKey) {
1179             String keyAlgorithm = privateKey.getAlgorithm();
1180             return getBaseSignatureFilesName(baseName) + keyAlgorithm;
1181         }
1182 
1183         // Generates the PKCS#7 content of block file
<span class="line-modified">1184         @SuppressWarnings(&quot;removal&quot;)</span>
1185         public byte[] generateBlock(ContentSignerParameters params,
1186                                     boolean externalSF,
1187                                     ContentSigner signingMechanism)
1188                 throws NoSuchAlgorithmException,
1189                        IOException, CertificateException {
1190 
1191             if (signingMechanism == null) {
1192                 signingMechanism = new TimestampedSigner();
1193             }
1194             return signingMechanism.generateSignedData(
1195                     params,
1196                     externalSF,
1197                     params.getTimestampingAuthority() != null
1198                         || params.getTimestampingAuthorityCertificate() != null);
1199         }
1200     }
1201 
<span class="line-modified">1202     @SuppressWarnings(&quot;removal&quot;)</span>
1203     class JarSignerParameters implements ContentSignerParameters {
1204 
1205         private String[] args;
1206         private URI tsa;
1207         private byte[] signature;
1208         private String signatureAlgorithm;
1209         private X509Certificate[] signerCertificateChain;
1210         private byte[] content;
1211         private ZipFile source;
1212         private String tSAPolicyID;
1213         private String tSADigestAlg;
1214 
1215         JarSignerParameters(String[] args, URI tsa,
1216                             String tSAPolicyID, String tSADigestAlg,
1217                             byte[] signature, String signatureAlgorithm,
1218                             X509Certificate[] signerCertificateChain,
1219                             byte[] content, ZipFile source) {
1220 
1221             Objects.requireNonNull(signature);
1222             Objects.requireNonNull(signatureAlgorithm);
</pre>
</td>
</tr>
</table>
<center><a href="../../../com/sun/jarsigner/package-info.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="../../../sun/security/tools/jarsigner/Main.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>