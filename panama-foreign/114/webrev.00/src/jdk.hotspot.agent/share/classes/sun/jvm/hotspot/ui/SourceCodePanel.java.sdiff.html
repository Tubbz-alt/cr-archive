<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/jdk.hotspot.agent/share/classes/sun/jvm/hotspot/ui/SourceCodePanel.java</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="SAPanel.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="action/FindAction.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/jdk.hotspot.agent/share/classes/sun/jvm/hotspot/ui/SourceCodePanel.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2001, 2002, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  *
 23  */
 24 
 25 package sun.jvm.hotspot.ui;
 26 
 27 import java.awt.*;
 28 import java.awt.event.*;

 29 import java.io.*;
 30 import java.net.*;
 31 import java.util.*;
 32 import javax.swing.*;
 33 import javax.swing.text.BadLocationException;
 34 
 35 /** Panel supporting loading of and scrolling through source code.
 36     Contains convenience routines for implementing the Editor
 37     interface. */
 38 
 39 public class SourceCodePanel extends JPanel {
 40   private JTextArea source;
 41   private RowHeader header;
 42   private String filename;
 43   // Amount of white space between edges, line numbers and icons
 44   private static final int LINE_NO_SPACE = 4;
 45   // Size of icons in resources directory
 46   private static final int ICON_SIZE = 12;
 47   // Icons used in panel drawing
 48   private static Icon topFrameCurLine;
 49   private static Icon lowerFrameCurLine;
 50   private static Icon breakpoint;
 51   // State
 52   private int highlightedLine = -1;
<span class="line-modified"> 53   private Set/*&lt;Integer&gt;*/ breakpoints = new HashSet(); // Zero-based lines internally</span>
 54   // Parent Editor container and EditorCommands object for setting breakpoints
 55   private EditorCommands comm;
 56   private Editor parent;
 57 
 58   /** Support for displaying icons and line numbers in row header of
 59       scroll pane */
 60   class RowHeader extends JPanel {
 61     private JViewport view;
 62     private boolean   showLineNumbers;
 63     private int       width;
 64     private int       rowHeight;
 65     private boolean   initted;
 66 
 67     public RowHeader() {
 68       super();
 69       initted = true;
 70       addHierarchyBoundsListener(new HierarchyBoundsAdapter() {
 71           public void ancestorResized(HierarchyEvent e) {
 72             recomputeSize();
 73           }
</pre>
<hr />
<pre>
 78       super.paint(g);
 79       if (getShowLineNumbers()) {
 80         // Visible region of header panel, in coordinate system of the
 81         // panel, is provided by clip bounds of Graphics object. This
 82         // is used to figure out which line numbers to draw.
 83         Rectangle clip = g.getClipBounds();
 84         // To avoid missing lines, round down starting line number and
 85         // round up ending line number
 86         int start = clip.y / rowHeight;
 87         int end   = start + (clip.height + (rowHeight - 1)) / rowHeight;
 88         // Draw these line numbers, right justified to look better
 89         FontMetrics fm = getFontMetrics(getFont());
 90         int ascent = fm.getMaxAscent(); // Causes proper alignment -- trial-and-error
 91         for (int i = start; i &lt;= end; i++) {
 92           // Line numbers are 1-based
 93           String str = Integer.toString(i + 1);
 94           int strWidth = GraphicsUtilities.getStringWidth(str, fm);
 95           g.drawString(str, width - strWidth - LINE_NO_SPACE, ascent + rowHeight * i);
 96 
 97           // Draw breakpoint if necessary
<span class="line-modified"> 98           if (breakpoints.contains(new Integer(i))) {</span>
 99             breakpoint.paintIcon(this, g, LINE_NO_SPACE, rowHeight * i);
100           }
101 
102           // Draw current line icon if necessary
103           if (i == highlightedLine) {
104             // FIXME: use correct icon (not always topmost frame)
105             topFrameCurLine.paintIcon(this, g, LINE_NO_SPACE, rowHeight * i);
106           }
107         }
108       }
109     }
110 
111     public boolean getShowLineNumbers() {
112       return showLineNumbers;
113     }
114 
115     public void setShowLineNumbers(boolean val) {
116       if (val != showLineNumbers) {
117         showLineNumbers = val;
118         recomputeSize();
</pre>
<hr />
<pre>
238     }
239   }
240 
241   public String getSourceFileName() {
242     return filename;
243   }
244 
245   /** Line number is one-based */
246   public int getCurrentLineNumber() {
247     try {
248       return 1 + source.getLineOfOffset(source.getCaretPosition());
249     } catch (BadLocationException e) {
250       return 0;
251     }
252   }
253 
254   /** Line number is one-based */
255   public void showLineNumber(int lineNo) {
256     try {
257       int offset = source.getLineStartOffset(lineNo - 1);
<span class="line-modified">258       Rectangle rect = source.modelToView(offset);</span>
<span class="line-modified">259       if (rect == null) {</span>
260         return;
261       }


262       source.scrollRectToVisible(rect);
263     } catch (BadLocationException e) {
264       e.printStackTrace();
265     }
266   }
267 
268   /** Line number is one-based */
269   public void highlightLineNumber(int lineNo) {
270     highlightedLine = lineNo - 1;
271   }
272 
<span class="line-modified">273   public void showBreakpointAtLine(int lineNo)  { breakpoints.add(new Integer(lineNo - 1));    repaint(); }</span>
<span class="line-modified">274   public boolean hasBreakpointAtLine(int lineNo){ return breakpoints.contains(new Integer(lineNo - 1));   }</span>
<span class="line-modified">275   public void clearBreakpointAtLine(int lineNo) { breakpoints.remove(new Integer(lineNo - 1)); repaint(); }</span>
276   public void clearBreakpoints()                { breakpoints.clear();                         repaint(); }
277 
278   public void setEditorCommands(EditorCommands comm, Editor parent) {
279     this.comm = comm;
280     this.parent = parent;
281   }
282 
283   public void requestFocus() {
284     source.requestFocus();
285   }
286 
287   //----------------------------------------------------------------------
288   // Internals only below this point
289   //
290 
291   private void maybeLoadIcons() {
292     if (topFrameCurLine == null) {
293       topFrameCurLine   = loadIcon(&quot;resources/arrow.png&quot;);
294       lowerFrameCurLine = loadIcon(&quot;resources/triangle.png&quot;);
295       breakpoint        = loadIcon(&quot;resources/breakpoint.png&quot;);
</pre>
</td>
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2001, 2020, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  *
 23  */
 24 
 25 package sun.jvm.hotspot.ui;
 26 
 27 import java.awt.*;
 28 import java.awt.event.*;
<span class="line-added"> 29 import java.awt.geom.Rectangle2D;</span>
 30 import java.io.*;
 31 import java.net.*;
 32 import java.util.*;
 33 import javax.swing.*;
 34 import javax.swing.text.BadLocationException;
 35 
 36 /** Panel supporting loading of and scrolling through source code.
 37     Contains convenience routines for implementing the Editor
 38     interface. */
 39 
 40 public class SourceCodePanel extends JPanel {
 41   private JTextArea source;
 42   private RowHeader header;
 43   private String filename;
 44   // Amount of white space between edges, line numbers and icons
 45   private static final int LINE_NO_SPACE = 4;
 46   // Size of icons in resources directory
 47   private static final int ICON_SIZE = 12;
 48   // Icons used in panel drawing
 49   private static Icon topFrameCurLine;
 50   private static Icon lowerFrameCurLine;
 51   private static Icon breakpoint;
 52   // State
 53   private int highlightedLine = -1;
<span class="line-modified"> 54   private Set&lt;Integer&gt; breakpoints = new HashSet&lt;&gt;(); // Zero-based lines internally</span>
 55   // Parent Editor container and EditorCommands object for setting breakpoints
 56   private EditorCommands comm;
 57   private Editor parent;
 58 
 59   /** Support for displaying icons and line numbers in row header of
 60       scroll pane */
 61   class RowHeader extends JPanel {
 62     private JViewport view;
 63     private boolean   showLineNumbers;
 64     private int       width;
 65     private int       rowHeight;
 66     private boolean   initted;
 67 
 68     public RowHeader() {
 69       super();
 70       initted = true;
 71       addHierarchyBoundsListener(new HierarchyBoundsAdapter() {
 72           public void ancestorResized(HierarchyEvent e) {
 73             recomputeSize();
 74           }
</pre>
<hr />
<pre>
 79       super.paint(g);
 80       if (getShowLineNumbers()) {
 81         // Visible region of header panel, in coordinate system of the
 82         // panel, is provided by clip bounds of Graphics object. This
 83         // is used to figure out which line numbers to draw.
 84         Rectangle clip = g.getClipBounds();
 85         // To avoid missing lines, round down starting line number and
 86         // round up ending line number
 87         int start = clip.y / rowHeight;
 88         int end   = start + (clip.height + (rowHeight - 1)) / rowHeight;
 89         // Draw these line numbers, right justified to look better
 90         FontMetrics fm = getFontMetrics(getFont());
 91         int ascent = fm.getMaxAscent(); // Causes proper alignment -- trial-and-error
 92         for (int i = start; i &lt;= end; i++) {
 93           // Line numbers are 1-based
 94           String str = Integer.toString(i + 1);
 95           int strWidth = GraphicsUtilities.getStringWidth(str, fm);
 96           g.drawString(str, width - strWidth - LINE_NO_SPACE, ascent + rowHeight * i);
 97 
 98           // Draw breakpoint if necessary
<span class="line-modified"> 99           if (breakpoints.contains(i)) {</span>
100             breakpoint.paintIcon(this, g, LINE_NO_SPACE, rowHeight * i);
101           }
102 
103           // Draw current line icon if necessary
104           if (i == highlightedLine) {
105             // FIXME: use correct icon (not always topmost frame)
106             topFrameCurLine.paintIcon(this, g, LINE_NO_SPACE, rowHeight * i);
107           }
108         }
109       }
110     }
111 
112     public boolean getShowLineNumbers() {
113       return showLineNumbers;
114     }
115 
116     public void setShowLineNumbers(boolean val) {
117       if (val != showLineNumbers) {
118         showLineNumbers = val;
119         recomputeSize();
</pre>
<hr />
<pre>
239     }
240   }
241 
242   public String getSourceFileName() {
243     return filename;
244   }
245 
246   /** Line number is one-based */
247   public int getCurrentLineNumber() {
248     try {
249       return 1 + source.getLineOfOffset(source.getCaretPosition());
250     } catch (BadLocationException e) {
251       return 0;
252     }
253   }
254 
255   /** Line number is one-based */
256   public void showLineNumber(int lineNo) {
257     try {
258       int offset = source.getLineStartOffset(lineNo - 1);
<span class="line-modified">259       Rectangle2D rect2d = source.modelToView2D(offset);</span>
<span class="line-modified">260       if (rect2d == null) {</span>
261         return;
262       }
<span class="line-added">263       Rectangle rect = new Rectangle((int) rect2d.getX(), (int) rect2d.getY(),</span>
<span class="line-added">264               (int) rect2d.getWidth(), (int) rect2d.getHeight());</span>
265       source.scrollRectToVisible(rect);
266     } catch (BadLocationException e) {
267       e.printStackTrace();
268     }
269   }
270 
271   /** Line number is one-based */
272   public void highlightLineNumber(int lineNo) {
273     highlightedLine = lineNo - 1;
274   }
275 
<span class="line-modified">276   public void showBreakpointAtLine(int lineNo)  { breakpoints.add(lineNo - 1);    repaint(); }</span>
<span class="line-modified">277   public boolean hasBreakpointAtLine(int lineNo){ return breakpoints.contains(lineNo - 1);   }</span>
<span class="line-modified">278   public void clearBreakpointAtLine(int lineNo) { breakpoints.remove(lineNo - 1); repaint(); }</span>
279   public void clearBreakpoints()                { breakpoints.clear();                         repaint(); }
280 
281   public void setEditorCommands(EditorCommands comm, Editor parent) {
282     this.comm = comm;
283     this.parent = parent;
284   }
285 
286   public void requestFocus() {
287     source.requestFocus();
288   }
289 
290   //----------------------------------------------------------------------
291   // Internals only below this point
292   //
293 
294   private void maybeLoadIcons() {
295     if (topFrameCurLine == null) {
296       topFrameCurLine   = loadIcon(&quot;resources/arrow.png&quot;);
297       lowerFrameCurLine = loadIcon(&quot;resources/triangle.png&quot;);
298       breakpoint        = loadIcon(&quot;resources/breakpoint.png&quot;);
</pre>
</td>
</tr>
</table>
<center><a href="SAPanel.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="action/FindAction.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>