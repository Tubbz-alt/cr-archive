<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/jdk.hotspot.agent/share/classes/sun/jvm/hotspot/oops/ConstantPool.java</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="ConstMethod.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="ConstantPoolCache.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/jdk.hotspot.agent/share/classes/sun/jvm/hotspot/oops/ConstantPool.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2000, 2018, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  *
 23  */
 24 
 25 package sun.jvm.hotspot.oops;
 26 
 27 import java.io.*;
 28 import java.util.*;
 29 import sun.jvm.hotspot.debugger.*;
 30 import sun.jvm.hotspot.runtime.*;
 31 import sun.jvm.hotspot.types.*;
 32 import sun.jvm.hotspot.utilities.*;


 33 
 34 // A ConstantPool is an oop containing class constants
 35 // as described in the class file
 36 
 37 public class ConstantPool extends Metadata implements ClassConstants {
 38   private class CPSlot {
 39     private Address ptr;
 40 
 41     CPSlot(Address ptr) {
 42       this.ptr = ptr;
 43     }
 44 
 45     public Symbol getSymbol() {
 46       // (Lowest bit == 1) -&gt; this is an pseudo string.
 47       return Symbol.create(ptr.andWithMask(~1));
 48     }
 49   }
 50   private class CPKlassSlot {
 51     private int name_index;
 52     private int resolved_klass_index;
</pre>
<hr />
<pre>
522         case JVM_CONSTANT_Utf8:
523           visitor.doOop(new OopField(new NamedFieldIdentifier(nameForTag(ctag)), indexOffset(index), true), true);
524           break;
525 
526         case JVM_CONSTANT_Fieldref:
527         case JVM_CONSTANT_Methodref:
528         case JVM_CONSTANT_InterfaceMethodref:
529         case JVM_CONSTANT_NameAndType:
530         case JVM_CONSTANT_MethodHandle:
531         case JVM_CONSTANT_MethodType:
532         case JVM_CONSTANT_Dynamic:
533         case JVM_CONSTANT_InvokeDynamic:
534           visitor.doInt(new IntField(new NamedFieldIdentifier(nameForTag(ctag)), indexOffset(index), true), true);
535           break;
536         }
537       }
538     }
539 
540   public void writeBytes(OutputStream os) throws IOException {
541           // Map between any modified UTF-8 and it&#39;s constant pool index.
<span class="line-modified">542           Map utf8ToIndex = new HashMap();</span>
543       DataOutputStream dos = new DataOutputStream(os);
544       U1Array tags = getTags();
545       int len = (int)getLength();
546       int ci = 0; // constant pool index
547 
548       // collect all modified UTF-8 Strings from Constant Pool
549 
550       for (ci = 1; ci &lt; len; ci++) {
551           int cpConstType = tags.at(ci);
552           if(cpConstType == JVM_CONSTANT_Utf8) {
553               Symbol sym = getSymbolAt(ci);
<span class="line-modified">554               utf8ToIndex.put(sym.asString(), new Short((short) ci));</span>
555           }
556           else if(cpConstType == JVM_CONSTANT_Long ||
557                   cpConstType == JVM_CONSTANT_Double) {
558               ci++;
559           }
560       }
561 
562 
563       for(ci = 1; ci &lt; len; ci++) {
564           int cpConstType = tags.at(ci);
565           // write cp_info
566           // write constant type
567           switch(cpConstType) {
568               case JVM_CONSTANT_Utf8: {
569                   dos.writeByte(cpConstType);
570                   Symbol sym = getSymbolAt(ci);
571                   dos.writeShort((short)sym.getLength());
572                   dos.write(sym.asByteArray());
573                   if (DEBUG) debugMessage(&quot;CP[&quot; + ci + &quot;] = modified UTF-8 &quot; + sym.asString());
574                   break;
</pre>
</td>
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2000, 2020, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  *
 23  */
 24 
 25 package sun.jvm.hotspot.oops;
 26 
 27 import java.io.*;
 28 import java.util.*;
 29 import sun.jvm.hotspot.debugger.*;
 30 import sun.jvm.hotspot.runtime.*;
 31 import sun.jvm.hotspot.types.*;
 32 import sun.jvm.hotspot.utilities.*;
<span class="line-added"> 33 import sun.jvm.hotspot.utilities.Observable;</span>
<span class="line-added"> 34 import sun.jvm.hotspot.utilities.Observer;</span>
 35 
 36 // A ConstantPool is an oop containing class constants
 37 // as described in the class file
 38 
 39 public class ConstantPool extends Metadata implements ClassConstants {
 40   private class CPSlot {
 41     private Address ptr;
 42 
 43     CPSlot(Address ptr) {
 44       this.ptr = ptr;
 45     }
 46 
 47     public Symbol getSymbol() {
 48       // (Lowest bit == 1) -&gt; this is an pseudo string.
 49       return Symbol.create(ptr.andWithMask(~1));
 50     }
 51   }
 52   private class CPKlassSlot {
 53     private int name_index;
 54     private int resolved_klass_index;
</pre>
<hr />
<pre>
524         case JVM_CONSTANT_Utf8:
525           visitor.doOop(new OopField(new NamedFieldIdentifier(nameForTag(ctag)), indexOffset(index), true), true);
526           break;
527 
528         case JVM_CONSTANT_Fieldref:
529         case JVM_CONSTANT_Methodref:
530         case JVM_CONSTANT_InterfaceMethodref:
531         case JVM_CONSTANT_NameAndType:
532         case JVM_CONSTANT_MethodHandle:
533         case JVM_CONSTANT_MethodType:
534         case JVM_CONSTANT_Dynamic:
535         case JVM_CONSTANT_InvokeDynamic:
536           visitor.doInt(new IntField(new NamedFieldIdentifier(nameForTag(ctag)), indexOffset(index), true), true);
537           break;
538         }
539       }
540     }
541 
542   public void writeBytes(OutputStream os) throws IOException {
543           // Map between any modified UTF-8 and it&#39;s constant pool index.
<span class="line-modified">544           Map&lt;String, Short&gt; utf8ToIndex = new HashMap&lt;&gt;();</span>
545       DataOutputStream dos = new DataOutputStream(os);
546       U1Array tags = getTags();
547       int len = (int)getLength();
548       int ci = 0; // constant pool index
549 
550       // collect all modified UTF-8 Strings from Constant Pool
551 
552       for (ci = 1; ci &lt; len; ci++) {
553           int cpConstType = tags.at(ci);
554           if(cpConstType == JVM_CONSTANT_Utf8) {
555               Symbol sym = getSymbolAt(ci);
<span class="line-modified">556               utf8ToIndex.put(sym.asString(), (short) ci);</span>
557           }
558           else if(cpConstType == JVM_CONSTANT_Long ||
559                   cpConstType == JVM_CONSTANT_Double) {
560               ci++;
561           }
562       }
563 
564 
565       for(ci = 1; ci &lt; len; ci++) {
566           int cpConstType = tags.at(ci);
567           // write cp_info
568           // write constant type
569           switch(cpConstType) {
570               case JVM_CONSTANT_Utf8: {
571                   dos.writeByte(cpConstType);
572                   Symbol sym = getSymbolAt(ci);
573                   dos.writeShort((short)sym.getLength());
574                   dos.write(sym.asByteArray());
575                   if (DEBUG) debugMessage(&quot;CP[&quot; + ci + &quot;] = modified UTF-8 &quot; + sym.asString());
576                   break;
</pre>
</td>
</tr>
</table>
<center><a href="ConstMethod.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="ConstantPoolCache.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>