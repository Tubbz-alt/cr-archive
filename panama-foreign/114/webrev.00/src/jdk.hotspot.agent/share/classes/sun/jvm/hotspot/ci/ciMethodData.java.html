<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>New src/jdk.hotspot.agent/share/classes/sun/jvm/hotspot/ci/ciMethodData.java</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
  <body>
    <pre>
  1 /*
  2  * Copyright (c) 2011, 2020, Oracle and/or its affiliates. All rights reserved.
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  *
 23  */
 24 
 25 package sun.jvm.hotspot.ci;
 26 
 27 import java.io.*;
 28 import java.util.*;
 29 import sun.jvm.hotspot.debugger.*;
 30 import sun.jvm.hotspot.runtime.*;
 31 import sun.jvm.hotspot.oops.*;
 32 import sun.jvm.hotspot.types.*;
 33 import sun.jvm.hotspot.utilities.Observable;
 34 import sun.jvm.hotspot.utilities.Observer;
 35 
 36 public class ciMethodData extends ciMetadata implements MethodDataInterface&lt;ciKlass,ciMethod&gt; {
 37   static {
 38     VM.registerVMInitializedObserver(new Observer() {
 39         public void update(Observable o, Object data) {
 40           initialize(VM.getVM().getTypeDataBase());
 41         }
 42       });
 43   }
 44 
 45   private static synchronized void initialize(TypeDataBase db) throws WrongTypeException {
 46     Type type      = db.lookupType(&quot;ciMethodData&quot;);
 47     origField = type.getAddressField(&quot;_orig&quot;);
 48     currentMileageField = new CIntField(type.getCIntegerField(&quot;_current_mileage&quot;), 0);
 49     argReturnedField = new CIntField(type.getCIntegerField(&quot;_arg_returned&quot;), 0);
 50     argStackField = new CIntField(type.getCIntegerField(&quot;_arg_stack&quot;), 0);
 51     argLocalField = new CIntField(type.getCIntegerField(&quot;_arg_local&quot;), 0);
 52     eflagsField = new CIntField(type.getCIntegerField(&quot;_eflags&quot;), 0);
 53     hintDiField = new CIntField(type.getCIntegerField(&quot;_hint_di&quot;), 0);
 54     currentMileageField = new CIntField(type.getCIntegerField(&quot;_current_mileage&quot;), 0);
 55     dataField = type.getAddressField(&quot;_data&quot;);
 56     extraDataSizeField = new CIntField(type.getCIntegerField(&quot;_extra_data_size&quot;), 0);
 57     dataSizeField = new CIntField(type.getCIntegerField(&quot;_data_size&quot;), 0);
 58     stateField = new CIntField(type.getCIntegerField(&quot;_state&quot;), 0);
 59     Type typeMethodData = db.lookupType(&quot;MethodData&quot;);
 60     sizeofMethodDataOopDesc = (int)typeMethodData.getSize();
 61     parametersTypeDataDi = new CIntField(typeMethodData.getCIntegerField(&quot;_parameters_type_data_di&quot;), 0);
 62   }
 63 
 64   private static AddressField origField;
 65   private static CIntField currentMileageField;
 66   private static CIntField argReturnedField;
 67   private static CIntField argStackField;
 68   private static CIntField argLocalField;
 69   private static CIntField eflagsField;
 70   private static CIntField hintDiField;
 71   private static AddressField dataField;
 72   private static CIntField extraDataSizeField;
 73   private static CIntField dataSizeField;
 74   private static CIntField stateField;
 75   private static int sizeofMethodDataOopDesc;
 76   private static CIntField parametersTypeDataDi;
 77 
 78   public ciMethodData(Address addr) {
 79     super(addr);
 80   }
 81 
 82   public ciKlass getKlassAtAddress(Address addr) {
 83     return (ciKlass)ciObjectFactory.getMetadata(addr);
 84   }
 85 
 86   public ciMethod getMethodAtAddress(Address addr) {
 87     return (ciMethod)ciObjectFactory.getMetadata(addr);
 88   }
 89 
 90   public void printKlassValueOn(ciKlass klass, PrintStream st) {
 91     klass.printValueOn(st);
 92   }
 93 
 94   public void printMethodValueOn(ciMethod method, PrintStream st) {
 95     method.printValueOn(st);
 96   }
 97 
 98   private byte[] fetchDataAt(Address base, long size) {
 99     byte[] result = new byte[(int)size];
100     for (int i = 0; i &lt; size; i++) {
101       result[i] = base.getJByteAt(i);
102     }
103     return result;
104   }
105 
106   public byte[] orig() {
107     // fetch the orig MethodData data between header and dataSize
108     Address base = getAddress().addOffsetTo(origField.getOffset());
109     byte[] result = new byte[MethodData.sizeofMethodDataOopDesc];
110     for (int i = 0; i &lt; MethodData.sizeofMethodDataOopDesc; i++) {
111       result[i] = base.getJByteAt(i);
112     }
113     return result;
114   }
115 
116   public  long[] data() {
117     // Read the data as an array of intptr_t elements
118     Address base = dataField.getValue(getAddress());
119     int elements = dataSize() / MethodData.cellSize;
120     long[] result = new long[elements];
121     for (int i = 0; i &lt; elements; i++) {
122       Address value = base.getAddressAt(i * MethodData.cellSize);
123       if (value != null) {
124         result[i] = value.minus(null);
125       }
126     }
127     return result;
128   }
129 
130   int dataSize() {
131     return (int)dataSizeField.getValue(getAddress());
132   }
133 
134   int extraDataSize() {
135     return (int)extraDataSizeField.getValue(getAddress());
136   }
137 
138   int state() {
139     return (int)stateField.getValue(getAddress());
140   }
141 
142   int currentMileage() {
143     return (int)currentMileageField.getValue(getAddress());
144   }
145 
146   boolean outOfBounds(int dataIndex) {
147     return dataIndex &gt;= dataSize();
148   }
149 
150   ParametersTypeData&lt;ciKlass,ciMethod&gt; parametersTypeData() {
151     Address base = getAddress().addOffsetTo(origField.getOffset());
152     int di = (int)parametersTypeDataDi.getValue(base);
153     if (di == -1 || di == -2) {
154       return null;
155     }
156     DataLayout dataLayout = new DataLayout(dataField.getValue(getAddress()), di);
157     return new ParametersTypeData&lt;ciKlass,ciMethod&gt;(this, dataLayout);
158   }
159 
160   ProfileData dataAt(int dataIndex) {
161     if (outOfBounds(dataIndex)) {
162       return null;
163     }
164     DataLayout dataLayout = new DataLayout(dataField.getValue(getAddress()), dataIndex);
165 
166     switch (dataLayout.tag()) {
167     case DataLayout.noTag:
168     default:
169       throw new InternalError();
170     case DataLayout.bitDataTag:
171       return new BitData(dataLayout);
172     case DataLayout.counterDataTag:
173       return new CounterData(dataLayout);
174     case DataLayout.jumpDataTag:
175       return new JumpData(dataLayout);
176     case DataLayout.receiverTypeDataTag:
177       return new ReceiverTypeData&lt;ciKlass,ciMethod&gt;(this, dataLayout);
178     case DataLayout.virtualCallDataTag:
179       return new VirtualCallData&lt;ciKlass,ciMethod&gt;(this, dataLayout);
180     case DataLayout.retDataTag:
181       return new RetData(dataLayout);
182     case DataLayout.branchDataTag:
183       return new BranchData(dataLayout);
184     case DataLayout.multiBranchDataTag:
185       return new MultiBranchData(dataLayout);
186     case DataLayout.callTypeDataTag:
187       return new CallTypeData&lt;ciKlass,ciMethod&gt;(this, dataLayout);
188     case DataLayout.virtualCallTypeDataTag:
189       return new VirtualCallTypeData&lt;ciKlass,ciMethod&gt;(this, dataLayout);
190     case DataLayout.parametersTypeDataTag:
191       return new ParametersTypeData&lt;ciKlass,ciMethod&gt;(this, dataLayout);
192     }
193   }
194 
195   int dpToDi(int dp) {
196     return dp;
197   }
198 
199   int firstDi() { return 0; }
200   ProfileData firstData() { return dataAt(firstDi()); }
201   ProfileData nextData(ProfileData current) {
202     int currentIndex = dpToDi(current.dp());
203     int nextIndex = currentIndex + current.sizeInBytes();
204     return dataAt(nextIndex);
205   }
206   boolean isValid(ProfileData current) { return current != null; }
207 
208   DataLayout limitDataPosition() {
209     return new DataLayout(dataField.getValue(getAddress()), dataSize());
210   }
211   DataLayout extraDataBase() {
212     return limitDataPosition();
213   }
214   DataLayout extraDataLimit() {
215     return new DataLayout(dataField.getValue(getAddress()), dataSize() + extraDataSize());
216   }
217   DataLayout nextExtra(DataLayout dataLayout) {
218     return new DataLayout(dataField.getValue(getAddress()), dataLayout.dp() + DataLayout.computeSizeInBytes(MethodData.extraNbCells(dataLayout)));
219   }
220 
221   public void printDataOn(PrintStream st) {
222     if (parametersTypeData() != null) {
223       parametersTypeData().printDataOn(st);
224     }
225     ProfileData data = firstData();
226     for ( ; isValid(data); data = nextData(data)) {
227       st.print(dpToDi(data.dp()));
228       st.print(&quot; &quot;);
229       // st-&gt;fillTo(6);
230       data.printDataOn(st);
231     }
232     st.println(&quot;--- Extra data:&quot;);
233     DataLayout dp    = extraDataBase();
234     DataLayout end   = extraDataLimit();
235     for (;; dp = nextExtra(dp)) {
236       switch(dp.tag()) {
237       case DataLayout.noTag:
238         continue;
239       case DataLayout.bitDataTag:
240         data = new BitData(dp);
241         break;
242       case DataLayout.speculativeTrapDataTag:
243         data = new SpeculativeTrapData&lt;ciKlass,ciMethod&gt;(this, dp);
244         break;
245       case DataLayout.argInfoDataTag:
246         data = new ArgInfoData(dp);
247         dp = end; // ArgInfoData is at the end of extra data section.
248         break;
249       default:
250         throw new InternalError(&quot;unexpected tag &quot; +  dp.tag());
251       }
252       st.print(dpToDi(data.dp()));
253       st.print(&quot; &quot;);
254       data.printDataOn(st);
255       if (dp == end) return;
256     }
257   }
258 
259   int dumpReplayDataTypeHelper(PrintStream out, int round, int count, int index, ProfileData pdata, ciKlass k) {
260     if (k != null) {
261       if (round == 0) count++;
262       else out.print(&quot; &quot; + ((pdata.dp() + pdata.cellOffset(index)) / MethodData.cellSize) + &quot; &quot; + k.name());
263     }
264     return count;
265   }
266 
267   int dumpReplayDataReceiverTypeHelper(PrintStream out, int round, int count, ReceiverTypeData&lt;ciKlass,ciMethod&gt; vdata) {
268     for (int i = 0; i &lt; vdata.rowLimit(); i++) {
269       ciKlass k = vdata.receiver(i);
270       count = dumpReplayDataTypeHelper(out, round, count, vdata.receiverCellIndex(i), vdata, k);
271     }
272     return count;
273   }
274 
275   int dumpReplayDataCallTypeHelper(PrintStream out, int round, int count, CallTypeDataInterface&lt;ciKlass&gt; callTypeData) {
276     if (callTypeData.hasArguments()) {
277       for (int i = 0; i &lt; callTypeData.numberOfArguments(); i++) {
278         count = dumpReplayDataTypeHelper(out, round, count, callTypeData.argumentTypeIndex(i), (ProfileData)callTypeData, callTypeData.argumentType(i));
279       }
280     }
281     if (callTypeData.hasReturn()) {
282       count = dumpReplayDataTypeHelper(out, round, count, callTypeData.returnTypeIndex(), (ProfileData)callTypeData, callTypeData.returnType());
283     }
284     return count;
285   }
286 
287   int dumpReplayDataExtraDataHelper(PrintStream out, int round, int count) {
288     DataLayout dp    = extraDataBase();
289     DataLayout end   = extraDataLimit();
290 
291     for (;dp != end; dp = nextExtra(dp)) {
292       switch(dp.tag()) {
293       case DataLayout.noTag:
294       case DataLayout.argInfoDataTag:
295         return count;
296       case DataLayout.bitDataTag:
297         break;
298       case DataLayout.speculativeTrapDataTag: {
299         SpeculativeTrapData&lt;ciKlass,ciMethod&gt; data = new SpeculativeTrapData&lt;ciKlass,ciMethod&gt;(this, dp);
300         ciMethod m = data.method();
301         if (m != null) {
302           if (round == 0) {
303             count++;
304           } else {
305             out.print(&quot; &quot; +  (dpToDi(data.dp() + data.cellOffset(SpeculativeTrapData.methodIndex())) / MethodData.cellSize) + &quot; &quot; +  m.nameAsAscii());
306           }
307         }
308         break;
309       }
310       default:
311         throw new InternalError(&quot;bad tag &quot;  + dp.tag());
312       }
313     }
314     return count;
315   }
316 
317   public void dumpReplayData(PrintStream out) {
318     MethodData mdo = (MethodData)getMetadata();
319     Method method = mdo.getMethod();
320     out.print(&quot;ciMethodData &quot; +
321               method.nameAsAscii() + &quot; &quot; +
322               state() + &quot; &quot; + currentMileage());
323     byte[] orig = orig();
324     out.print(&quot; orig &quot; + orig.length);
325     for (int i = 0; i &lt; orig.length; i++) {
326       out.print(&quot; &quot; + (orig[i] &amp; 0xff));
327     }
328 
329     long[] data = data();
330     out.print(&quot; data &quot; +  data.length);
331     for (int i = 0; i &lt; data.length; i++) {
332       out.print(&quot; 0x&quot; + Long.toHexString(data[i]));
333     }
334     int count = 0;
335     ParametersTypeData&lt;ciKlass,ciMethod&gt; parameters = parametersTypeData();
336     for (int round = 0; round &lt; 2; round++) {
337       if (round == 1) out.print(&quot; oops &quot; + count);
338       ProfileData pdata = firstData();
339       for ( ; isValid(pdata); pdata = nextData(pdata)) {
340         if (pdata instanceof ReceiverTypeData) {
341           count = dumpReplayDataReceiverTypeHelper(out, round, count, (ReceiverTypeData&lt;ciKlass,ciMethod&gt;)pdata);
342         }
343         if (pdata instanceof CallTypeDataInterface) {
344           count = dumpReplayDataCallTypeHelper(out, round, count, (CallTypeDataInterface&lt;ciKlass&gt;)pdata);
345         }
346       }
347       if (parameters != null) {
348         for (int i = 0; i &lt; parameters.numberOfParameters(); i++) {
349           count = dumpReplayDataTypeHelper(out, round, count, ParametersTypeData.typeIndex(i), parameters, parameters.type(i));
350         }
351       }
352     }
353     count = 0;
354     for (int round = 0; round &lt; 2; round++) {
355       if (round == 1) out.print(&quot; methods &quot; + count);
356       count = dumpReplayDataExtraDataHelper(out, round, count);
357     }
358     out.println();
359   }
360 }
    </pre>
  </body>
</html>