<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff src/jdk.hotspot.agent/share/classes/sun/jvm/hotspot/utilities/soql/JSJavaInstanceKlass.java</title>
    <link rel="stylesheet" href="../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="JSJavaHeap.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="JSJavaKlass.java.cdiff.html" target="_top">next &gt;</a></center>    <h2>src/jdk.hotspot.agent/share/classes/sun/jvm/hotspot/utilities/soql/JSJavaInstanceKlass.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 1,7 ***</span>
  /*
<span class="line-modified">!  * Copyright (c) 2003, 2013, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
<span class="line-new-header">--- 1,7 ---</span>
  /*
<span class="line-modified">!  * Copyright (c) 2003, 2020, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
</pre>
<hr />
<pre>
<span class="line-old-header">*** 50,12 ***</span>
     private static final int FIELD_STATICS            = 18;
     private static final int FIELD_UNDEFINED          = -1;
  
     public JSJavaInstanceKlass(InstanceKlass kls, JSJavaFactory fac) {
        super(kls, fac);
<span class="line-modified">!       this.instanceFields = new HashMap();</span>
<span class="line-modified">!       this.staticFields = new HashMap();</span>
     }
  
     public final InstanceKlass getInstanceKlass() {
        return (InstanceKlass) getKlass();
     }
<span class="line-new-header">--- 50,12 ---</span>
     private static final int FIELD_STATICS            = 18;
     private static final int FIELD_UNDEFINED          = -1;
  
     public JSJavaInstanceKlass(InstanceKlass kls, JSJavaFactory fac) {
        super(kls, fac);
<span class="line-modified">!       this.instanceFields = new HashMap&lt;&gt;();</span>
<span class="line-modified">!       this.staticFields = new HashMap&lt;&gt;();</span>
     }
  
     public final InstanceKlass getInstanceKlass() {
        return (InstanceKlass) getKlass();
     }
</pre>
<hr />
<pre>
<span class="line-old-header">*** 157,13 ***</span>
  
     public String[] getInstanceFieldNames() {
        if (instanceFieldNames == null) {
           InstanceKlass current = getInstanceKlass();
           while (current != null) {
<span class="line-modified">!             List tmp = current.getImmediateFields();</span>
<span class="line-modified">!             for (Iterator itr = tmp.iterator(); itr.hasNext();) {</span>
<span class="line-modified">!                Field fld = (Field) itr.next();</span>
                 if (!fld.isStatic()) {
                    String name = fld.getID().getName();
                    if (instanceFields.get(name) == null) {
                       instanceFields.put(name, fld);
                    }
<span class="line-new-header">--- 157,13 ---</span>
  
     public String[] getInstanceFieldNames() {
        if (instanceFieldNames == null) {
           InstanceKlass current = getInstanceKlass();
           while (current != null) {
<span class="line-modified">!             List&lt;Field&gt; tmp = current.getImmediateFields();</span>
<span class="line-modified">!             for (Iterator&lt;Field&gt; itr = tmp.iterator(); itr.hasNext();) {</span>
<span class="line-modified">!                Field fld = itr.next();</span>
                 if (!fld.isStatic()) {
                    String name = fld.getID().getName();
                    if (instanceFields.get(name) == null) {
                       instanceFields.put(name, fld);
                    }
</pre>
<hr />
<pre>
<span class="line-old-header">*** 188,13 ***</span>
     }
  
     public String[] getStaticFieldNames() {
        if (staticFieldNames == null) {
           InstanceKlass current = getInstanceKlass();
<span class="line-modified">!          List tmp = current.getImmediateFields();</span>
<span class="line-modified">!          for (Iterator itr = tmp.iterator(); itr.hasNext();) {</span>
<span class="line-modified">!             Field fld = (Field) itr.next();</span>
              if (fld.isStatic()) {
                 staticFields.put(fld.getID().getName(), fld);
              }
           }
  
<span class="line-new-header">--- 188,13 ---</span>
     }
  
     public String[] getStaticFieldNames() {
        if (staticFieldNames == null) {
           InstanceKlass current = getInstanceKlass();
<span class="line-modified">!          List&lt;Field&gt; tmp = current.getImmediateFields();</span>
<span class="line-modified">!          for (Iterator&lt;Field&gt; itr = tmp.iterator(); itr.hasNext();) {</span>
<span class="line-modified">!             Field fld = itr.next();</span>
              if (fld.isStatic()) {
                 staticFields.put(fld.getID().getName(), fld);
              }
           }
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 212,13 ***</span>
        Field fld = findStaticField(name);
        return (fld != null)? true: false;
     }
  
     //-- Intenals only below this point
<span class="line-modified">!    private static Map fields = new HashMap();</span>
     private static void addField(String name, int fieldId) {
<span class="line-modified">!       fields.put(name, new Integer(fieldId));</span>
     }
  
     private static int getFieldID(String name) {
        Integer res = (Integer) fields.get(name);
        return (res != null)? res.intValue() : FIELD_UNDEFINED;
<span class="line-new-header">--- 212,13 ---</span>
        Field fld = findStaticField(name);
        return (fld != null)? true: false;
     }
  
     //-- Intenals only below this point
<span class="line-modified">!    private static Map&lt;String, Integer&gt; fields = new HashMap&lt;&gt;();</span>
     private static void addField(String name, int fieldId) {
<span class="line-modified">!       fields.put(name, fieldId);</span>
     }
  
     private static int getFieldID(String name) {
        Integer res = (Integer) fields.get(name);
        return (res != null)? res.intValue() : FIELD_UNDEFINED;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 253,25 ***</span>
     private Object getFieldValue(Field fld, String name, Oop oop) {
         FieldType fd = fld.getFieldType();
         if (fd.isObject() || fd.isArray()) {
           return factory.newJSJavaObject(((OopField)fld).getValue(oop));
         } else if (fd.isByte()) {
<span class="line-modified">!           return new Byte(((ByteField)fld).getValue(oop));</span>
         } else if (fd.isChar()) {
            return new String(new char[] { ((CharField)fld).getValue(oop) });
         } else if (fd.isDouble()) {
<span class="line-modified">!           return new Double(((DoubleField)fld).getValue(oop));</span>
         } else if (fd.isFloat()) {
<span class="line-modified">!           return new Float(((FloatField)fld).getValue(oop));</span>
         } else if (fd.isInt()) {
<span class="line-modified">!           return new Integer(((IntField)fld).getValue(oop));</span>
         } else if (fd.isLong()) {
<span class="line-modified">!           return new Long(((LongField)fld).getValue(oop));</span>
         } else if (fd.isShort()) {
<span class="line-modified">!           return new Short(((ShortField)fld).getValue(oop));</span>
         } else if (fd.isBoolean()) {
<span class="line-modified">!           return Boolean.valueOf(((BooleanField)fld).getValue(oop));</span>
         } else {
            if (Assert.ASSERTS_ENABLED) {
               Assert.that(false, &quot;invalid field type for &quot; + name);
            }
            return null;
<span class="line-new-header">--- 253,25 ---</span>
     private Object getFieldValue(Field fld, String name, Oop oop) {
         FieldType fd = fld.getFieldType();
         if (fd.isObject() || fd.isArray()) {
           return factory.newJSJavaObject(((OopField)fld).getValue(oop));
         } else if (fd.isByte()) {
<span class="line-modified">!           return ((ByteField) fld).getValue(oop);</span>
         } else if (fd.isChar()) {
            return new String(new char[] { ((CharField)fld).getValue(oop) });
         } else if (fd.isDouble()) {
<span class="line-modified">!           return ((DoubleField) fld).getValue(oop);</span>
         } else if (fd.isFloat()) {
<span class="line-modified">!           return ((FloatField) fld).getValue(oop);</span>
         } else if (fd.isInt()) {
<span class="line-modified">!           return ((IntField) fld).getValue(oop);</span>
         } else if (fd.isLong()) {
<span class="line-modified">!           return ((LongField) fld).getValue(oop);</span>
         } else if (fd.isShort()) {
<span class="line-modified">!           return ((ShortField) fld).getValue(oop);</span>
         } else if (fd.isBoolean()) {
<span class="line-modified">!           return ((BooleanField) fld).getValue(oop);</span>
         } else {
            if (Assert.ASSERTS_ENABLED) {
               Assert.that(false, &quot;invalid field type for &quot; + name);
            }
            return null;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 281,25 ***</span>
     private Object getFieldValue(Field fld, String name, InstanceKlass oop) {
         FieldType fd = fld.getFieldType();
         if (fd.isObject() || fd.isArray()) {
           return factory.newJSJavaObject(((OopField)fld).getValue(oop));
         } else if (fd.isByte()) {
<span class="line-modified">!           return new Byte(((ByteField)fld).getValue(oop));</span>
         } else if (fd.isChar()) {
            return new String(new char[] { ((CharField)fld).getValue(oop) });
         } else if (fd.isDouble()) {
<span class="line-modified">!           return new Double(((DoubleField)fld).getValue(oop));</span>
         } else if (fd.isFloat()) {
<span class="line-modified">!           return new Float(((FloatField)fld).getValue(oop));</span>
         } else if (fd.isInt()) {
<span class="line-modified">!           return new Integer(((IntField)fld).getValue(oop));</span>
         } else if (fd.isLong()) {
<span class="line-modified">!           return new Long(((LongField)fld).getValue(oop));</span>
         } else if (fd.isShort()) {
<span class="line-modified">!           return new Short(((ShortField)fld).getValue(oop));</span>
         } else if (fd.isBoolean()) {
<span class="line-modified">!           return Boolean.valueOf(((BooleanField)fld).getValue(oop));</span>
         } else {
            if (Assert.ASSERTS_ENABLED) {
               Assert.that(false, &quot;invalid field type for &quot; + name);
            }
            return null;
<span class="line-new-header">--- 281,25 ---</span>
     private Object getFieldValue(Field fld, String name, InstanceKlass oop) {
         FieldType fd = fld.getFieldType();
         if (fd.isObject() || fd.isArray()) {
           return factory.newJSJavaObject(((OopField)fld).getValue(oop));
         } else if (fd.isByte()) {
<span class="line-modified">!           return ((ByteField) fld).getValue(oop);</span>
         } else if (fd.isChar()) {
            return new String(new char[] { ((CharField)fld).getValue(oop) });
         } else if (fd.isDouble()) {
<span class="line-modified">!           return ((DoubleField) fld).getValue(oop);</span>
         } else if (fd.isFloat()) {
<span class="line-modified">!           return ((FloatField) fld).getValue(oop);</span>
         } else if (fd.isInt()) {
<span class="line-modified">!           return ((IntField) fld).getValue(oop);</span>
         } else if (fd.isLong()) {
<span class="line-modified">!           return ((LongField) fld).getValue(oop);</span>
         } else if (fd.isShort()) {
<span class="line-modified">!           return ((ShortField) fld).getValue(oop);</span>
         } else if (fd.isBoolean()) {
<span class="line-modified">!           return ((BooleanField) fld).getValue(oop);</span>
         } else {
            if (Assert.ASSERTS_ENABLED) {
               Assert.that(false, &quot;invalid field type for &quot; + name);
            }
            return null;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 311,13 ***</span>
        if (fld != null) {
           return fld;
        } else {
           InstanceKlass current = getInstanceKlass();
           while (current != null) {
<span class="line-modified">!             List tmp = current.getImmediateFields();</span>
<span class="line-modified">!             for (Iterator itr = tmp.iterator(); itr.hasNext();) {</span>
<span class="line-modified">!                fld = (Field) itr.next();</span>
                 if (fld.getID().getName().equals(name) &amp;&amp; !fld.isStatic()) {
                     instanceFields.put(name, fld);
                     return fld;
                 }
              }
<span class="line-new-header">--- 311,13 ---</span>
        if (fld != null) {
           return fld;
        } else {
           InstanceKlass current = getInstanceKlass();
           while (current != null) {
<span class="line-modified">!             List&lt;Field&gt; tmp = current.getImmediateFields();</span>
<span class="line-modified">!             for (Iterator&lt;Field&gt; itr = tmp.iterator(); itr.hasNext();) {</span>
<span class="line-modified">!                fld = itr.next();</span>
                 if (fld.getID().getName().equals(name) &amp;&amp; !fld.isStatic()) {
                     instanceFields.put(name, fld);
                     return fld;
                 }
              }
</pre>
<hr />
<pre>
<span class="line-old-header">*** 336,13 ***</span>
        } else {
           // static fields are searched only in current.
           // Direct/indirect super classes and interfaces
           // are not included in search.
           InstanceKlass current = getInstanceKlass();
<span class="line-modified">!          List tmp = current.getImmediateFields();</span>
<span class="line-modified">!          for (Iterator itr = tmp.iterator(); itr.hasNext();) {</span>
<span class="line-modified">!             fld = (Field) itr.next();</span>
              if (fld.getID().getName().equals(name) &amp;&amp; fld.isStatic()) {
                 staticFields.put(name, fld);
                 return fld;
              }
           }
<span class="line-new-header">--- 336,13 ---</span>
        } else {
           // static fields are searched only in current.
           // Direct/indirect super classes and interfaces
           // are not included in search.
           InstanceKlass current = getInstanceKlass();
<span class="line-modified">!          List&lt;Field&gt; tmp = current.getImmediateFields();</span>
<span class="line-modified">!          for (Iterator&lt;Field&gt; itr = tmp.iterator(); itr.hasNext();) {</span>
<span class="line-modified">!             fld = itr.next();</span>
              if (fld.getID().getName().equals(name) &amp;&amp; fld.isStatic()) {
                 staticFields.put(name, fld);
                 return fld;
              }
           }
</pre>
<hr />
<pre>
<span class="line-old-header">*** 351,31 ***</span>
        }
     }
  
     private JSList getInterfaces() {
        InstanceKlass ik = getInstanceKlass();
<span class="line-modified">!       List intfs = ik.getDirectImplementedInterfaces();</span>
<span class="line-modified">!       List res = new ArrayList(0);</span>
<span class="line-modified">!       for (Iterator itr = intfs.iterator(); itr.hasNext();) {</span>
<span class="line-modified">!           Klass k = (Klass) itr.next();</span>
            res.add(k.getJavaMirror());
        }
        return factory.newJSList(res);
     }
  
     private JSMap getStatics() {
        String[] names = getStaticFieldNames();
<span class="line-modified">!       Map map = new HashMap();</span>
        for (int i=0; i &lt; names.length; i++) {
           try {
              map.put(names[i], getStaticFieldValue(names[i]));
           } catch (NoSuchFieldException exp) {}
        }
        return factory.newJSMap(map);
    }
  
<span class="line-modified">!    private Map           instanceFields;</span>
<span class="line-modified">!    private Map           staticFields;</span>
     private String[]      instanceFieldNames;
     private String[]      staticFieldNames;
     private AccessFlags   accFlags;
  }
<span class="line-new-header">--- 351,31 ---</span>
        }
     }
  
     private JSList getInterfaces() {
        InstanceKlass ik = getInstanceKlass();
<span class="line-modified">!       List&lt;Klass&gt; intfs = ik.getDirectImplementedInterfaces();</span>
<span class="line-modified">!       List&lt;Instance&gt; res = new ArrayList&lt;&gt;(0);</span>
<span class="line-modified">!       for (Iterator&lt;Klass&gt; itr = intfs.iterator(); itr.hasNext();) {</span>
<span class="line-modified">!           Klass k = itr.next();</span>
            res.add(k.getJavaMirror());
        }
        return factory.newJSList(res);
     }
  
     private JSMap getStatics() {
        String[] names = getStaticFieldNames();
<span class="line-modified">!       Map&lt;String, Object&gt; map = new HashMap&lt;&gt;();</span>
        for (int i=0; i &lt; names.length; i++) {
           try {
              map.put(names[i], getStaticFieldValue(names[i]));
           } catch (NoSuchFieldException exp) {}
        }
        return factory.newJSMap(map);
    }
  
<span class="line-modified">!    private Map&lt;String, Field&gt; instanceFields;</span>
<span class="line-modified">!    private Map&lt;String, Field&gt; staticFields;</span>
     private String[]      instanceFieldNames;
     private String[]      staticFieldNames;
     private AccessFlags   accFlags;
  }
</pre>
<center><a href="JSJavaHeap.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="JSJavaKlass.java.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>