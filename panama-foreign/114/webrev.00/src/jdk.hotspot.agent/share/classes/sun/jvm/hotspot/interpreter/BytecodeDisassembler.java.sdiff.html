<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/jdk.hotspot.agent/share/classes/sun/jvm/hotspot/interpreter/BytecodeDisassembler.java</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="../gc/shenandoah/ShenandoahHeapRegion.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="Bytecodes.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/jdk.hotspot.agent/share/classes/sun/jvm/hotspot/interpreter/BytecodeDisassembler.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2002, 2012, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  *
 23  */
 24 
 25 package sun.jvm.hotspot.interpreter;
 26 
 27 import java.util.*;
 28 import java.lang.reflect.Constructor;
 29 import sun.jvm.hotspot.oops.*;
 30 import sun.jvm.hotspot.utilities.*;
 31 
 32 public class BytecodeDisassembler {
 33    private Method method;
 34 
<span class="line-modified"> 35    private static Map bytecode2Class = new HashMap(); // Map&lt;int, Class&gt;</span>
 36 
 37    private static void addBytecodeClass(int bytecode, Class clazz) {
<span class="line-modified"> 38       bytecode2Class.put(new Integer(bytecode), clazz);</span>
 39    }
 40 
 41    private static Class getBytecodeClass(int bytecode) {
<span class="line-modified"> 42       return (Class) bytecode2Class.get(new Integer(bytecode));</span>
 43    }
 44 
 45    static {
 46       addBytecodeClass(Bytecodes._anewarray, BytecodeANewArray.class);
 47       addBytecodeClass(Bytecodes._bipush, BytecodeBipush.class);
 48       addBytecodeClass(Bytecodes._checkcast, BytecodeCheckCast.class);
 49       addBytecodeClass(Bytecodes._getfield, BytecodeGetField.class);
 50       addBytecodeClass(Bytecodes._getstatic, BytecodeGetStatic.class);
 51       addBytecodeClass(Bytecodes._goto, BytecodeGoto.class);
 52       addBytecodeClass(Bytecodes._goto_w, BytecodeGotoW.class);
 53       addBytecodeClass(Bytecodes._ifeq, BytecodeIf.class);
 54       addBytecodeClass(Bytecodes._ifne, BytecodeIf.class);
 55       addBytecodeClass(Bytecodes._iflt, BytecodeIf.class);
 56       addBytecodeClass(Bytecodes._ifge, BytecodeIf.class);
 57       addBytecodeClass(Bytecodes._ifgt, BytecodeIf.class);
 58       addBytecodeClass(Bytecodes._ifle, BytecodeIf.class);
 59       addBytecodeClass(Bytecodes._if_icmpeq, BytecodeIf.class);
 60       addBytecodeClass(Bytecodes._if_icmpne, BytecodeIf.class);
 61       addBytecodeClass(Bytecodes._if_icmplt, BytecodeIf.class);
 62       addBytecodeClass(Bytecodes._if_icmpge, BytecodeIf.class);
</pre>
<hr />
<pre>
 99       addBytecodeClass(Bytecodes._tableswitch, BytecodeTableswitch.class);
100    }
101 
102    public BytecodeDisassembler(Method method) {
103       this.method = method;
104    }
105 
106    public Method getMethod() {
107       return method;
108    }
109 
110    public void decode(BytecodeVisitor visitor) {
111       visitor.prologue(method);
112 
113       BytecodeStream stream = new BytecodeStream(method);
114       int javacode = Bytecodes._illegal;
115       while ( (javacode = stream.next()) != Bytecodes._illegal) {
116          // look for special Bytecode class
117          int bci = stream.bci();
118          int hotspotcode = method.getBytecodeOrBPAt(bci);
<span class="line-modified">119          Class clazz = getBytecodeClass(javacode);</span>
120          if (clazz == null) {
121             // check for fast_(i|a)_access_0
122             clazz = getBytecodeClass(hotspotcode);
123             if (clazz == null) {
124                // use generic bytecode class
125                clazz = Bytecode.class;
126             }
127          }
128 
129          // All bytecode classes must have a constructor with signature
130          // (Lsun/jvm/hotspot/oops/Method;I)V
131 
132          Constructor cstr = null;
133          try {
134             cstr = clazz.getDeclaredConstructor(new Class[] { Method.class, Integer.TYPE });
135          } catch(NoSuchMethodException nomethod) {
136             if (Assert.ASSERTS_ENABLED) {
137                Assert.that(false, &quot;Bytecode class without proper constructor!&quot;);
138             }
139          }
140 
141          Bytecode bytecodeObj = null;
142          try {
<span class="line-modified">143             bytecodeObj = (Bytecode)cstr.newInstance(new Object[] { method, new Integer(bci) });</span>
144          } catch (Exception exp) {
145             if (Assert.ASSERTS_ENABLED) {
146                Assert.that(false, &quot;Bytecode instance of class &quot;
147                            + clazz.getName() + &quot; can not be created!&quot;);
148             }
149          }
150 
151          if (stream.isWide()) {
152             visitor.visit(new Bytecode(method, bci - 1));
153          }
154 
155          try {
156             visitor.visit(bytecodeObj);
157          } catch(ClassCastException castfail) {
158              castfail.printStackTrace();
159              System.err.println(method.getAddress() + &quot; &quot; + bci);
160          }
161       }
162 
163       visitor.epilogue();
</pre>
</td>
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2002, 2020, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  *
 23  */
 24 
 25 package sun.jvm.hotspot.interpreter;
 26 
 27 import java.util.*;
 28 import java.lang.reflect.Constructor;
 29 import sun.jvm.hotspot.oops.*;
 30 import sun.jvm.hotspot.utilities.*;
 31 
 32 public class BytecodeDisassembler {
 33    private Method method;
 34 
<span class="line-modified"> 35    private static Map&lt;Integer, Class&gt; bytecode2Class = new HashMap&lt;&gt;();</span>
 36 
 37    private static void addBytecodeClass(int bytecode, Class clazz) {
<span class="line-modified"> 38       bytecode2Class.put(bytecode, clazz);</span>
 39    }
 40 
 41    private static Class getBytecodeClass(int bytecode) {
<span class="line-modified"> 42       return (Class) bytecode2Class.get(bytecode);</span>
 43    }
 44 
 45    static {
 46       addBytecodeClass(Bytecodes._anewarray, BytecodeANewArray.class);
 47       addBytecodeClass(Bytecodes._bipush, BytecodeBipush.class);
 48       addBytecodeClass(Bytecodes._checkcast, BytecodeCheckCast.class);
 49       addBytecodeClass(Bytecodes._getfield, BytecodeGetField.class);
 50       addBytecodeClass(Bytecodes._getstatic, BytecodeGetStatic.class);
 51       addBytecodeClass(Bytecodes._goto, BytecodeGoto.class);
 52       addBytecodeClass(Bytecodes._goto_w, BytecodeGotoW.class);
 53       addBytecodeClass(Bytecodes._ifeq, BytecodeIf.class);
 54       addBytecodeClass(Bytecodes._ifne, BytecodeIf.class);
 55       addBytecodeClass(Bytecodes._iflt, BytecodeIf.class);
 56       addBytecodeClass(Bytecodes._ifge, BytecodeIf.class);
 57       addBytecodeClass(Bytecodes._ifgt, BytecodeIf.class);
 58       addBytecodeClass(Bytecodes._ifle, BytecodeIf.class);
 59       addBytecodeClass(Bytecodes._if_icmpeq, BytecodeIf.class);
 60       addBytecodeClass(Bytecodes._if_icmpne, BytecodeIf.class);
 61       addBytecodeClass(Bytecodes._if_icmplt, BytecodeIf.class);
 62       addBytecodeClass(Bytecodes._if_icmpge, BytecodeIf.class);
</pre>
<hr />
<pre>
 99       addBytecodeClass(Bytecodes._tableswitch, BytecodeTableswitch.class);
100    }
101 
102    public BytecodeDisassembler(Method method) {
103       this.method = method;
104    }
105 
106    public Method getMethod() {
107       return method;
108    }
109 
110    public void decode(BytecodeVisitor visitor) {
111       visitor.prologue(method);
112 
113       BytecodeStream stream = new BytecodeStream(method);
114       int javacode = Bytecodes._illegal;
115       while ( (javacode = stream.next()) != Bytecodes._illegal) {
116          // look for special Bytecode class
117          int bci = stream.bci();
118          int hotspotcode = method.getBytecodeOrBPAt(bci);
<span class="line-modified">119          Class&lt;?&gt; clazz = getBytecodeClass(javacode);</span>
120          if (clazz == null) {
121             // check for fast_(i|a)_access_0
122             clazz = getBytecodeClass(hotspotcode);
123             if (clazz == null) {
124                // use generic bytecode class
125                clazz = Bytecode.class;
126             }
127          }
128 
129          // All bytecode classes must have a constructor with signature
130          // (Lsun/jvm/hotspot/oops/Method;I)V
131 
132          Constructor cstr = null;
133          try {
134             cstr = clazz.getDeclaredConstructor(new Class[] { Method.class, Integer.TYPE });
135          } catch(NoSuchMethodException nomethod) {
136             if (Assert.ASSERTS_ENABLED) {
137                Assert.that(false, &quot;Bytecode class without proper constructor!&quot;);
138             }
139          }
140 
141          Bytecode bytecodeObj = null;
142          try {
<span class="line-modified">143             bytecodeObj = (Bytecode)cstr.newInstance(new Object[] { method, bci});</span>
144          } catch (Exception exp) {
145             if (Assert.ASSERTS_ENABLED) {
146                Assert.that(false, &quot;Bytecode instance of class &quot;
147                            + clazz.getName() + &quot; can not be created!&quot;);
148             }
149          }
150 
151          if (stream.isWide()) {
152             visitor.visit(new Bytecode(method, bci - 1));
153          }
154 
155          try {
156             visitor.visit(bytecodeObj);
157          } catch(ClassCastException castfail) {
158              castfail.printStackTrace();
159              System.err.println(method.getAddress() + &quot; &quot; + bci);
160          }
161       }
162 
163       visitor.epilogue();
</pre>
</td>
</tr>
</table>
<center><a href="../gc/shenandoah/ShenandoahHeapRegion.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="Bytecodes.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>