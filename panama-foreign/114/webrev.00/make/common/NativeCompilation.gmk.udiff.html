<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff make/common/NativeCompilation.gmk</title>
    <link rel="stylesheet" href="../../style.css" />
  </head>
<body>
<center><a href="Modules.gmk.udiff.html" target="_top">&lt; prev</a> <a href="../../index.html" target="_top">index</a> <a href="../copy/Copy-java.base.gmk.udiff.html" target="_top">next &gt;</a></center>    <h2>make/common/NativeCompilation.gmk</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -202,21 +202,82 @@</span>
      -e &#39;s/^[	 ]*//&#39; \
      -e &#39;/^$$$$/ d&#39; \
      -e &#39;s/$$$$/ :/&#39; \
      #
  
<span class="udiff-line-added">+ ################################################################################</span>
<span class="udiff-line-added">+ # When absolute paths are not allowed in the output, and the compiler does not</span>
<span class="udiff-line-added">+ # support any options to avoid it, we need to rewrite compile commands to use</span>
<span class="udiff-line-added">+ # relative paths. By doing this, the __FILE__ macro will resolve to relative</span>
<span class="udiff-line-added">+ # paths. The relevant input paths on the command line are the -I flags and the</span>
<span class="udiff-line-added">+ # path to the source file itself.</span>
<span class="udiff-line-added">+ #</span>
<span class="udiff-line-added">+ # The macro MakeCommandRelative is used to rewrite the command line like this:</span>
<span class="udiff-line-added">+ # &#39;CD $(WORKSPACE_ROOT) &amp;&amp; &lt;cmd&gt;&#39;</span>
<span class="udiff-line-added">+ # and changes all paths in cmd to be relative to the workspace root. This only</span>
<span class="udiff-line-added">+ # works properly if the build dir is inside the workspace root. If it&#39;s not,</span>
<span class="udiff-line-added">+ # relative paths are still calculated, but depending on the distance between the</span>
<span class="udiff-line-added">+ # dirs, paths in the build dir may end up as essentially absolute anyway.</span>
<span class="udiff-line-added">+ #</span>
<span class="udiff-line-added">+ # The fix-deps-file macro is used to adjust the contents of the generated make</span>
<span class="udiff-line-added">+ # dependency files to contain paths compatible with make.</span>
<span class="udiff-line-added">+ #</span>
<span class="udiff-line-added">+ ifeq ($(ALLOW_ABSOLUTE_PATHS_IN_OUTPUT)-$(FILE_MACRO_CFLAGS), false-)</span>
<span class="udiff-line-added">+   # Need to handle -I flags as both &#39;-Ifoo&#39; and &#39;-I foo&#39;.</span>
<span class="udiff-line-added">+   MakeCommandRelative = \</span>
<span class="udiff-line-added">+       $(CD) $(WORKSPACE_ROOT) &amp;&amp; \</span>
<span class="udiff-line-added">+       $(foreach o, $1, \</span>
<span class="udiff-line-added">+         $(if $(filter $(WORKSPACE_ROOT)/% $(OUTPUTDIR)/%, $o), \</span>
<span class="udiff-line-added">+           $(call RelativePath, $o, $(WORKSPACE_ROOT)) \</span>
<span class="udiff-line-added">+         , \</span>
<span class="udiff-line-added">+           $(if $(filter -I$(WORKSPACE_ROOT)/%, $o), \</span>
<span class="udiff-line-added">+             -I$(call RelativePath, $(patsubst -I%, %, $o), $(WORKSPACE_ROOT)) \</span>
<span class="udiff-line-added">+           , \</span>
<span class="udiff-line-added">+             $o \</span>
<span class="udiff-line-added">+           ) \</span>
<span class="udiff-line-added">+         ) \</span>
<span class="udiff-line-added">+       )</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+   # When compiling with relative paths, the deps file comes out with relative</span>
<span class="udiff-line-added">+   # paths.</span>
<span class="udiff-line-added">+   ifeq ($(TOOLCHAIN_TYPE), solstudio)</span>
<span class="udiff-line-added">+     define fix-deps-file</span>
<span class="udiff-line-added">+ 	$(SED) -e &#39;s|\./|$(WORKSPACE_ROOT)/|g&#39; $1.tmp &gt; $1</span>
<span class="udiff-line-added">+     endef</span>
<span class="udiff-line-added">+   else</span>
<span class="udiff-line-added">+     define fix-deps-file</span>
<span class="udiff-line-added">+ 	$(SED) -e &#39;s|^\([ ]*\)|\1$(WORKSPACE_ROOT)|&#39; $1.tmp &gt; $1</span>
<span class="udiff-line-added">+     endef</span>
<span class="udiff-line-added">+   endif</span>
<span class="udiff-line-added">+ else</span>
<span class="udiff-line-added">+   # By default the MakeCommandRelative macro does nothing.</span>
<span class="udiff-line-added">+   MakeCommandRelative = $1</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+   # Even with absolute paths on the command line, the Solaris studio compiler</span>
<span class="udiff-line-added">+   # doesn&#39;t output the full path to the object file in the generated deps files.</span>
<span class="udiff-line-added">+   # For other toolchains, no adjustment is needed.</span>
<span class="udiff-line-added">+   ifeq ($(TOOLCHAIN_TYPE), solstudio)</span>
<span class="udiff-line-added">+     define fix-deps-file</span>
<span class="udiff-line-added">+ 	$(SED) &#39;s|^$$(@F):|$$@:|&#39; $1.tmp &gt; $1</span>
<span class="udiff-line-added">+     endef</span>
<span class="udiff-line-added">+   else</span>
<span class="udiff-line-added">+     define fix-deps-file</span>
<span class="udiff-line-added">+ 	$(MV) $1.tmp $1</span>
<span class="udiff-line-added">+     endef</span>
<span class="udiff-line-added">+   endif</span>
<span class="udiff-line-added">+ endif</span>
<span class="udiff-line-added">+ </span>
  ################################################################################
  # Create the recipe needed to compile a single native source file.
  #
  # Parameter 1 is the name of the rule, based on the name of the library/
  # program being build and the name of the source code file, e.g.
  # BUILD_LIBFOO_fooMain.cpp.
  #
  # Remaining parameters are named arguments:
  #   FILE - The full path of the source file to compiler
  #   BASE - The name of the rule for the entire binary to build ($1)
<span class="udiff-line-removed">- #   DISABLE_THIS_FILE_DEFINE - Set to true to disable the THIS_FILE define.</span>
  #
  SetupCompileNativeFile = $(NamedParamsMacroTemplate)
  define SetupCompileNativeFileBody
    $1_FILENAME := $$(notdir $$($1_FILE))
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -234,16 +295,10 @@</span>
    ifeq ($$($1_OBJ_PROCESSED), )
      $1_OBJ_PROCESSED := true
      # This is the definite source file to use for $1_FILENAME.
      $1_SRC_FILE := $$($1_FILE)
  
<span class="udiff-line-removed">-     ifneq ($$($1_DEFINE_THIS_FILE), false)</span>
<span class="udiff-line-removed">-       ifneq ($$($$($1_BASE)_DEFINE_THIS_FILE), false)</span>
<span class="udiff-line-removed">-         $1_THIS_FILE = -DTHIS_FILE=&#39;&quot;$$($1_FILENAME)&quot;&#39;</span>
<span class="udiff-line-removed">-       endif</span>
<span class="udiff-line-removed">-     endif</span>
<span class="udiff-line-removed">- </span>
      ifeq ($$($1_OPTIMIZATION), )
        $1_OPT_CFLAGS := $$($$($1_BASE)_OPT_CFLAGS)
        $1_OPT_CXXFLAGS := $$($$($1_BASE)_OPT_CXXFLAGS)
      else
        ifeq ($$($1_OPTIMIZATION), NONE)
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -282,28 +337,28 @@</span>
      $1_BASE_ASFLAGS := $$($$($1_BASE)_ASFLAGS) $$($$($1_BASE)_EXTRA_ASFLAGS)
  
      ifneq ($$(filter %.c, $$($1_FILENAME)), )
        # Compile as a C file
        $1_FLAGS := $(CFLAGS_CCACHE) $$($1_USE_PCH_FLAGS) $$($1_BASE_CFLAGS) \
<span class="udiff-line-modified-removed">-           $$($1_OPT_CFLAGS) $$($1_CFLAGS) $$($1_THIS_FILE) -c</span>
<span class="udiff-line-modified-added">+           $$($1_OPT_CFLAGS) $$($1_CFLAGS) -c</span>
        $1_COMPILER := $$($$($1_BASE)_CC)
        $1_DEP_FLAG := $(C_FLAG_DEPS)
      else ifneq ($$(filter %.m, $$($1_FILENAME)), )
        # Compile as an Objective-C file
        $1_FLAGS := -x objective-c $(CFLAGS_CCACHE) $$($1_USE_PCH_FLAGS) \
<span class="udiff-line-modified-removed">-           $$($1_BASE_CFLAGS) $$($1_OPT_CFLAGS) $$($1_CFLAGS) $$($1_THIS_FILE) -c</span>
<span class="udiff-line-modified-added">+           $$($1_BASE_CFLAGS) $$($1_OPT_CFLAGS) $$($1_CFLAGS) -c</span>
        $1_COMPILER := $$($$($1_BASE)_CC)
        $1_DEP_FLAG := $(C_FLAG_DEPS)
      else ifneq ($$(filter %.s %.S, $$($1_FILENAME)), )
        # Compile as assembler file
        $1_FLAGS := $$($1_BASE_ASFLAGS)
        $1_COMPILER := $(AS)
        $1_DEP_FLAG :=
      else ifneq ($$(filter %.cpp %.cc %.mm, $$($1_FILENAME)), )
        # Compile as a C++ or Objective-C++ file
        $1_FLAGS := $(CFLAGS_CCACHE) $$($1_USE_PCH_FLAGS) $$($1_BASE_CXXFLAGS) \
<span class="udiff-line-modified-removed">-           $$($1_OPT_CXXFLAGS) $$($1_CXXFLAGS) $$($1_THIS_FILE) -c</span>
<span class="udiff-line-modified-added">+           $$($1_OPT_CXXFLAGS) $$($1_CXXFLAGS) -c</span>
        $1_COMPILER := $$($$($1_BASE)_CXX)
        $1_DEP_FLAG := $(CXX_FLAG_DEPS)
      else
        $$(error Internal error in NativeCompilation.gmk: no compiler for file $$($1_FILENAME))
      endif
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -339,36 +394,32 @@</span>
  
      $$($1_OBJ): $$($1_OBJ_DEPS) | $$($$($1_BASE)_BUILD_INFO)
  	$$(call LogInfo, Compiling $$($1_FILENAME) (for $$($$($1_BASE)_BASENAME)))
  	$$(call MakeDir, $$(@D))
          ifneq ($(TOOLCHAIN_TYPE), microsoft)
<span class="udiff-line-modified-removed">-           ifeq ($(TOOLCHAIN_TYPE)$$(filter %.s, $$($1_FILENAME)), solstudio)</span>
<span class="udiff-line-modified-removed">-             # The Solaris studio compiler doesn&#39;t output the full path to the</span>
<span class="udiff-line-modified-removed">-             # object file in the generated deps files. Fixing it with sed. If</span>
<span class="udiff-line-modified-removed">-             # compiling assembly, don&#39;t try this.</span>
<span class="udiff-line-removed">- 	    $$(call ExecuteWithLog, $$@, \</span>
<span class="udiff-line-removed">- 	        $$($1_COMPILER) $$($1_DEP_FLAG) $$($1_DEPS_FILE).tmp $$($1_COMPILE_OPTIONS))</span>
<span class="udiff-line-removed">- 	    $(SED) &#39;s|^$$(@F):|$$@:|&#39; $$($1_DEPS_FILE).tmp &gt; $$($1_DEPS_FILE)</span>
<span class="udiff-line-removed">-           else</span>
<span class="udiff-line-removed">- 	    $$(call ExecuteWithLog, $$@, \</span>
<span class="udiff-line-removed">- 	        $$($1_COMPILER) $$($1_DEP_FLAG) $$($1_DEPS_FILE) $$($1_COMPILE_OPTIONS))</span>
<span class="udiff-line-removed">-           endif</span>
<span class="udiff-line-removed">-           # Create a dependency target file from the dependency file.</span>
<span class="udiff-line-removed">-           # Solution suggested by http://make.mad-scientist.net/papers/advanced-auto-dependency-generation/</span>
<span class="udiff-line-modified-added">+ 	  $$(call ExecuteWithLog, $$@, $$(call MakeCommandRelative, \</span>
<span class="udiff-line-modified-added">+ 	      $$($1_COMPILER) $$($1_DEP_FLAG) \</span>
<span class="udiff-line-modified-added">+ 	      $$(addsuffix .tmp, $$($1_DEPS_FILE)) \</span>
<span class="udiff-line-modified-added">+ 	      $$($1_COMPILE_OPTIONS)))</span>
            ifneq ($$($1_DEPS_FILE), )
<span class="udiff-line-modified-removed">- 	    $(SED) $(DEPENDENCY_TARGET_SED_PATTERN) $$($1_DEPS_FILE) &gt; $$($1_DEPS_TARGETS_FILE)</span>
<span class="udiff-line-modified-added">+ 	    $$(call fix-deps-file, $$($1_DEPS_FILE))</span>
<span class="udiff-line-added">+             # Create a dependency target file from the dependency file.</span>
<span class="udiff-line-added">+             # Solution suggested by:</span>
<span class="udiff-line-added">+             # http://make.mad-scientist.net/papers/advanced-auto-dependency-generation/</span>
<span class="udiff-line-added">+ 	    $(SED) $(DEPENDENCY_TARGET_SED_PATTERN) $$($1_DEPS_FILE) \</span>
<span class="udiff-line-added">+ 	        &gt; $$($1_DEPS_TARGETS_FILE)</span>
            endif
          else
            # The Visual Studio compiler lacks a feature for generating make
            # dependencies, but by setting -showIncludes, all included files are
            # printed. These are filtered out and parsed into make dependences.
            #
            # Keep as much as possible on one execution line for best performance
            # on Windows. No need to save exit code from compilation since
            # pipefail is always active on Windows.
<span class="udiff-line-modified-removed">- 	  $$(call ExecuteWithLog, $$@, \</span>
<span class="udiff-line-modified-removed">- 	      $$($1_COMPILER) -showIncludes $$($1_COMPILE_OPTIONS)) \</span>
<span class="udiff-line-modified-added">+ 	  $$(call ExecuteWithLog, $$@, $$(call MakeCommandRelative, \</span>
<span class="udiff-line-modified-added">+ 	      $$($1_COMPILER) -showIncludes $$($1_COMPILE_OPTIONS))) \</span>
  	      | $(TR) -d &#39;\r&#39; | $(GREP) -v -e &quot;^Note: including file:&quot; \
  	          -e &quot;^$$($1_FILENAME)$$$$&quot; || test &quot;$$$$?&quot; = &quot;1&quot; ; \
  	  $(ECHO) $$@: \\ &gt; $$($1_DEPS_FILE) ; \
  	  $(SED) $(WINDOWS_SHOWINCLUDE_SED_PATTERN) $$($1_OBJ).log \
  	      | $(SORT) -u &gt;&gt; $$($1_DEPS_FILE) ; \
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -428,11 +479,10 @@</span>
  #   ZIP_EXTERNAL_DEBUG_SYMBOLS Set to false to override global setting of debug symbol
  #       zipping
  #   STRIPFLAGS Optionally change the flags given to the strip command
  #   PRECOMPILED_HEADER Header file to use as precompiled header
  #   PRECOMPILED_HEADER_EXCLUDE List of source files that should not use PCH
<span class="udiff-line-removed">- #   DEFINE_THIS_FILE Set to false to not set the THIS_FILE preprocessor macro</span>
  #
  # After being called, some variables are exported from this macro, all prefixed
  # with parameter 1 followed by a &#39;_&#39;:
  #   TARGET The library or executable created by the macro
  #   TARGET_DEPS All prerequisites for the target calculated by the macro
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -732,11 +782,10 @@</span>
  
          $$(eval $$(call SetupCompileNativeFile, $1_$$(notdir $$($1_GENERATED_PCH_SRC)), \
              FILE := $$($1_GENERATED_PCH_SRC), \
              BASE := $1, \
              EXTRA_CXXFLAGS := -Fp$$($1_PCH_FILE) -Yc$$(notdir $$($1_PRECOMPILED_HEADER)), \
<span class="udiff-line-removed">-             DEFINE_THIS_FILE := false, \</span>
          ))
  
          $1_USE_PCH_FLAGS := \
              -Fp$$($1_PCH_FILE) -Yu$$(notdir $$($1_PRECOMPILED_HEADER))
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -767,11 +816,12 @@</span>
              $$($1_OPT_CFLAGS) -x c++-header -c $(C_FLAG_DEPS) $$($1_PCH_DEPS_FILE)
  
          $$($1_PCH_FILE): $$($1_PRECOMPILED_HEADER) $$($1_COMPILE_VARDEPS_FILE)
  		$$(call LogInfo, Generating precompiled header)
  		$$(call MakeDir, $$(@D))
<span class="udiff-line-modified-removed">- 		$$(call ExecuteWithLog, $$@, $$($1_PCH_COMMAND) $$&lt; -o $$@)</span>
<span class="udiff-line-modified-added">+ 		$$(call ExecuteWithLog, $$@, $$(call MakeCommandRelative, \</span>
<span class="udiff-line-added">+ 		    $$($1_PCH_COMMAND) $$&lt; -o $$@))</span>
  		$(SED) $(DEPENDENCY_TARGET_SED_PATTERN) $$($1_PCH_DEPS_FILE) \
  		    &gt; $$($1_PCH_DEPS_TARGETS_FILE)
  
          $$($1_ALL_OBJS): $$($1_PCH_FILE)
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -823,13 +873,13 @@</span>
            $$($1_RES).vardeps)
  
        $$($1_RES): $$($1_VERSIONINFO_RESOURCE) $$($1_RES_VARDEPS_FILE)
  		$$(call LogInfo, Compiling resource $$(notdir $$($1_VERSIONINFO_RESOURCE)) (for $$($1_BASENAME)))
  		$$(call MakeDir, $$(@D) $$($1_OBJECT_DIR))
<span class="udiff-line-modified-removed">- 		$$(call ExecuteWithLog, $$@, \</span>
<span class="udiff-line-modified-added">+ 		$$(call ExecuteWithLog, $$@, $$(call MakeCommandRelative, \</span>
  		    $$($1_RC) $$($1_RC_FLAGS) $$($1_SYSROOT_CFLAGS) $(CC_OUT_OPTION)$$@ \
<span class="udiff-line-modified-removed">- 		    $$($1_VERSIONINFO_RESOURCE) 2&gt;&amp;1 )</span>
<span class="udiff-line-modified-added">+ 		    $$($1_VERSIONINFO_RESOURCE) 2&gt;&amp;1 ))</span>
                  # Windows RC compiler does not support -showIncludes, so we mis-use CL
                  # for this. Filter out RC specific arguments that are unknown to CL.
                  # For some unknown reason, in this case CL actually outputs the show
                  # includes to stderr so need to redirect it to hide the output from the
                  # main log.
</pre>
<center><a href="Modules.gmk.udiff.html" target="_top">&lt; prev</a> <a href="../../index.html" target="_top">index</a> <a href="../copy/Copy-java.base.gmk.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>