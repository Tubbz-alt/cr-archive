<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff make/common/NativeCompilation.gmk</title>
    <link rel="stylesheet" href="../../style.css" />
  </head>
<body>
<center><a href="Modules.gmk.sdiff.html" target="_top">&lt; prev</a> <a href="../../index.html" target="_top">index</a> <a href="../copy/Copy-java.base.gmk.sdiff.html" target="_top">next &gt;</a></center>    <h2>make/common/NativeCompilation.gmk</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 187     -e &#39;/^Note: including file:/!d&#39; \
 188     -e &#39;s|Note: including file: *||&#39; \
 189     -e &#39;s|\r||g&#39; \
 190     -e &#39;s|\\|/|g&#39; \
 191     -e &#39;s|^\([a-zA-Z]\):|$(UNIX_PATH_PREFIX)/\1|g&#39; \
 192     -e &#39;\|$(TOPDIR)|I !d&#39; \
 193     -e &#39;s|$$$$| \\|g&#39; \
 194     #
 195 
 196 # This pattern is used to transform a dependency file (.d) to a list
 197 # of make targets for dependent files (.d.targets)
 198 DEPENDENCY_TARGET_SED_PATTERN := \
 199     -e &#39;s/\#.*//&#39; \
 200     -e &#39;s/^[^:]*: *//&#39; \
 201     -e &#39;s/ *\\$$$$//&#39; \
 202     -e &#39;s/^[	 ]*//&#39; \
 203     -e &#39;/^$$$$/ d&#39; \
 204     -e &#39;s/$$$$/ :/&#39; \
 205     #
 206 






























































 207 ################################################################################
 208 # Create the recipe needed to compile a single native source file.
 209 #
 210 # Parameter 1 is the name of the rule, based on the name of the library/
 211 # program being build and the name of the source code file, e.g.
 212 # BUILD_LIBFOO_fooMain.cpp.
 213 #
 214 # Remaining parameters are named arguments:
 215 #   FILE - The full path of the source file to compiler
 216 #   BASE - The name of the rule for the entire binary to build ($1)
<span class="line-removed"> 217 #   DISABLE_THIS_FILE_DEFINE - Set to true to disable the THIS_FILE define.</span>
 218 #
 219 SetupCompileNativeFile = $(NamedParamsMacroTemplate)
 220 define SetupCompileNativeFileBody
 221   $1_FILENAME := $$(notdir $$($1_FILE))
 222 
 223   # The target file to be generated.
 224   $1_OBJ := $$($$($1_BASE)_OBJECT_DIR)/$$(call replace_with_obj_extension, \
 225       $$($1_FILENAME))
 226 
 227   # Generate the corresponding compile_commands.json fragment.
 228   $1_OBJ_JSON = $$(MAKESUPPORT_OUTPUTDIR)/compile-commands/$$(subst /,_,$$(subst \
 229       $$(OUTPUTDIR)/,,$$($1_OBJ))).json
 230   $$($1_BASE)_ALL_OBJS_JSON += $$($1_OBJ_JSON)
 231 
 232   # Only continue if this object file hasn&#39;t been processed already. This lets
 233   # the first found source file override any other with the same name.
 234   ifeq ($$($1_OBJ_PROCESSED), )
 235     $1_OBJ_PROCESSED := true
 236     # This is the definite source file to use for $1_FILENAME.
 237     $1_SRC_FILE := $$($1_FILE)
 238 
<span class="line-removed"> 239     ifneq ($$($1_DEFINE_THIS_FILE), false)</span>
<span class="line-removed"> 240       ifneq ($$($$($1_BASE)_DEFINE_THIS_FILE), false)</span>
<span class="line-removed"> 241         $1_THIS_FILE = -DTHIS_FILE=&#39;&quot;$$($1_FILENAME)&quot;&#39;</span>
<span class="line-removed"> 242       endif</span>
<span class="line-removed"> 243     endif</span>
<span class="line-removed"> 244 </span>
 245     ifeq ($$($1_OPTIMIZATION), )
 246       $1_OPT_CFLAGS := $$($$($1_BASE)_OPT_CFLAGS)
 247       $1_OPT_CXXFLAGS := $$($$($1_BASE)_OPT_CXXFLAGS)
 248     else
 249       ifeq ($$($1_OPTIMIZATION), NONE)
 250         $1_OPT_CFLAGS := $(C_O_FLAG_NONE)
 251         $1_OPT_CXXFLAGS := $(CXX_O_FLAG_NONE)
 252       else ifeq ($$($1_OPTIMIZATION), LOW)
 253         $1_OPT_CFLAGS := $(C_O_FLAG_NORM)
 254         $1_OPT_CXXFLAGS := $(CXX_O_FLAG_NORM)
 255       else ifeq ($$($1_OPTIMIZATION), HIGH)
 256         $1_OPT_CFLAGS := $(C_O_FLAG_HI)
 257         $1_OPT_CXXFLAGS := $(CXX_O_FLAG_HI)
 258       else ifeq ($$($1_OPTIMIZATION), HIGHEST)
 259         $1_OPT_CFLAGS := $(C_O_FLAG_HIGHEST)
 260         $1_OPT_CXXFLAGS := $(CXX_O_FLAG_HIGHEST)
 261       else ifeq ($$($1_OPTIMIZATION), HIGHEST_JVM)
 262         $1_OPT_CFLAGS := $(C_O_FLAG_HIGHEST_JVM)
 263         $1_OPT_CXXFLAGS := $(CXX_O_FLAG_HIGHEST_JVM)
 264       else ifeq ($$($1_OPTIMIZATION), SIZE)
</pre>
<hr />
<pre>
 267       else
 268         $$(error Unknown value for file OPTIMIZATION: $$($1_OPTIMIZATION))
 269       endif
 270     endif
 271 
 272     ifneq ($$($$($1_BASE)_PRECOMPILED_HEADER), )
 273       ifeq ($$(filter $$($1_FILENAME), $$($$($1_BASE)_PRECOMPILED_HEADER_EXCLUDE)), )
 274         $1_USE_PCH_FLAGS := $$($$($1_BASE)_USE_PCH_FLAGS)
 275       endif
 276     endif
 277 
 278     $1_BASE_CFLAGS :=  $$($$($1_BASE)_CFLAGS) $$($$($1_BASE)_EXTRA_CFLAGS) \
 279         $$($$($1_BASE)_SYSROOT_CFLAGS)
 280     $1_BASE_CXXFLAGS := $$($$($1_BASE)_CXXFLAGS) $$($$($1_BASE)_EXTRA_CXXFLAGS) \
 281         $$($$($1_BASE)_SYSROOT_CFLAGS) $$($1_EXTRA_CXXFLAGS)
 282     $1_BASE_ASFLAGS := $$($$($1_BASE)_ASFLAGS) $$($$($1_BASE)_EXTRA_ASFLAGS)
 283 
 284     ifneq ($$(filter %.c, $$($1_FILENAME)), )
 285       # Compile as a C file
 286       $1_FLAGS := $(CFLAGS_CCACHE) $$($1_USE_PCH_FLAGS) $$($1_BASE_CFLAGS) \
<span class="line-modified"> 287           $$($1_OPT_CFLAGS) $$($1_CFLAGS) $$($1_THIS_FILE) -c</span>
 288       $1_COMPILER := $$($$($1_BASE)_CC)
 289       $1_DEP_FLAG := $(C_FLAG_DEPS)
 290     else ifneq ($$(filter %.m, $$($1_FILENAME)), )
 291       # Compile as an Objective-C file
 292       $1_FLAGS := -x objective-c $(CFLAGS_CCACHE) $$($1_USE_PCH_FLAGS) \
<span class="line-modified"> 293           $$($1_BASE_CFLAGS) $$($1_OPT_CFLAGS) $$($1_CFLAGS) $$($1_THIS_FILE) -c</span>
 294       $1_COMPILER := $$($$($1_BASE)_CC)
 295       $1_DEP_FLAG := $(C_FLAG_DEPS)
 296     else ifneq ($$(filter %.s %.S, $$($1_FILENAME)), )
 297       # Compile as assembler file
 298       $1_FLAGS := $$($1_BASE_ASFLAGS)
 299       $1_COMPILER := $(AS)
 300       $1_DEP_FLAG :=
 301     else ifneq ($$(filter %.cpp %.cc %.mm, $$($1_FILENAME)), )
 302       # Compile as a C++ or Objective-C++ file
 303       $1_FLAGS := $(CFLAGS_CCACHE) $$($1_USE_PCH_FLAGS) $$($1_BASE_CXXFLAGS) \
<span class="line-modified"> 304           $$($1_OPT_CXXFLAGS) $$($1_CXXFLAGS) $$($1_THIS_FILE) -c</span>
 305       $1_COMPILER := $$($$($1_BASE)_CXX)
 306       $1_DEP_FLAG := $(CXX_FLAG_DEPS)
 307     else
 308       $$(error Internal error in NativeCompilation.gmk: no compiler for file $$($1_FILENAME))
 309     endif
 310 
 311     ifeq ($$(filter %.s %.S, $$($1_FILENAME)), )
 312       # And this is the dependency file for this obj file.
 313       $1_DEPS_FILE := $$(patsubst %$(OBJ_SUFFIX),%.d,$$($1_OBJ))
 314       # The dependency target file lists all dependencies as empty targets to
 315       # avoid make error &quot;No rule to make target&quot; for removed files
 316       $1_DEPS_TARGETS_FILE := $$(patsubst %$(OBJ_SUFFIX),%.d.targets,$$($1_OBJ))
 317 
 318       # Only try to load individual dependency information files if the global
 319       # file hasn&#39;t been loaded (could happen if make was interrupted).
 320       ifneq ($$($$($1_BASE)_DEPS_FILE_LOADED), true)
 321         # Include previously generated dependency information. (if it exists)
 322         -include $$($1_DEPS_FILE)
 323         -include $$($1_DEPS_TARGETS_FILE)
 324       endif
 325     endif
 326 
 327     ifneq ($$(strip $$($1_CFLAGS) $$($1_CXXFLAGS) $$($1_OPTIMIZATION)), )
 328       $1_VARDEPS := $$($1_CFLAGS) $$($1_CXXFLAGS) $$($1_OPTIMIZATION)
 329       $1_VARDEPS_FILE := $$(call DependOnVariable, $1_VARDEPS, $$($1_OBJ).vardeps)
 330     endif
 331 
 332     $1_OBJ_DEPS := $$($1_SRC_FILE) $$($$($1_BASE)_COMPILE_VARDEPS_FILE) \
 333         $$($$($1_BASE)_EXTRA_DEPS) $$($1_VARDEPS_FILE)
 334     $1_COMPILE_OPTIONS := $$($1_FLAGS) $(CC_OUT_OPTION)$$($1_OBJ) $$($1_SRC_FILE)
 335 
 336     $$($1_OBJ_JSON): $$($1_OBJ_DEPS)
 337 	$$(call WriteCompileCommandsFragment, $$@, $$(PWD), $$($1_SRC_FILE), \
 338 	    $$($1_COMPILER) $$($1_COMPILE_OPTIONS))
 339 
 340     $$($1_OBJ): $$($1_OBJ_DEPS) | $$($$($1_BASE)_BUILD_INFO)
 341 	$$(call LogInfo, Compiling $$($1_FILENAME) (for $$($$($1_BASE)_BASENAME)))
 342 	$$(call MakeDir, $$(@D))
 343         ifneq ($(TOOLCHAIN_TYPE), microsoft)
<span class="line-modified"> 344           ifeq ($(TOOLCHAIN_TYPE)$$(filter %.s, $$($1_FILENAME)), solstudio)</span>
<span class="line-modified"> 345             # The Solaris studio compiler doesn&#39;t output the full path to the</span>
<span class="line-modified"> 346             # object file in the generated deps files. Fixing it with sed. If</span>
<span class="line-modified"> 347             # compiling assembly, don&#39;t try this.</span>
<span class="line-removed"> 348 	    $$(call ExecuteWithLog, $$@, \</span>
<span class="line-removed"> 349 	        $$($1_COMPILER) $$($1_DEP_FLAG) $$($1_DEPS_FILE).tmp $$($1_COMPILE_OPTIONS))</span>
<span class="line-removed"> 350 	    $(SED) &#39;s|^$$(@F):|$$@:|&#39; $$($1_DEPS_FILE).tmp &gt; $$($1_DEPS_FILE)</span>
<span class="line-removed"> 351           else</span>
<span class="line-removed"> 352 	    $$(call ExecuteWithLog, $$@, \</span>
<span class="line-removed"> 353 	        $$($1_COMPILER) $$($1_DEP_FLAG) $$($1_DEPS_FILE) $$($1_COMPILE_OPTIONS))</span>
<span class="line-removed"> 354           endif</span>
<span class="line-removed"> 355           # Create a dependency target file from the dependency file.</span>
<span class="line-removed"> 356           # Solution suggested by http://make.mad-scientist.net/papers/advanced-auto-dependency-generation/</span>
 357           ifneq ($$($1_DEPS_FILE), )
<span class="line-modified"> 358 	    $(SED) $(DEPENDENCY_TARGET_SED_PATTERN) $$($1_DEPS_FILE) &gt; $$($1_DEPS_TARGETS_FILE)</span>





 359           endif
 360         else
 361           # The Visual Studio compiler lacks a feature for generating make
 362           # dependencies, but by setting -showIncludes, all included files are
 363           # printed. These are filtered out and parsed into make dependences.
 364           #
 365           # Keep as much as possible on one execution line for best performance
 366           # on Windows. No need to save exit code from compilation since
 367           # pipefail is always active on Windows.
<span class="line-modified"> 368 	  $$(call ExecuteWithLog, $$@, \</span>
<span class="line-modified"> 369 	      $$($1_COMPILER) -showIncludes $$($1_COMPILE_OPTIONS)) \</span>
 370 	      | $(TR) -d &#39;\r&#39; | $(GREP) -v -e &quot;^Note: including file:&quot; \
 371 	          -e &quot;^$$($1_FILENAME)$$$$&quot; || test &quot;$$$$?&quot; = &quot;1&quot; ; \
 372 	  $(ECHO) $$@: \\ &gt; $$($1_DEPS_FILE) ; \
 373 	  $(SED) $(WINDOWS_SHOWINCLUDE_SED_PATTERN) $$($1_OBJ).log \
 374 	      | $(SORT) -u &gt;&gt; $$($1_DEPS_FILE) ; \
 375 	  $(ECHO) &gt;&gt; $$($1_DEPS_FILE) ; \
 376 	  $(SED) $(DEPENDENCY_TARGET_SED_PATTERN) $$($1_DEPS_FILE) &gt; $$($1_DEPS_TARGETS_FILE)
 377         endif
 378   endif
 379 endef
 380 
 381 # Setup make rules for creating a native binary (a shared library or an
 382 # executable).
 383 #
 384 # Parameter 1 is the name of the rule. This name is used as variable prefix,
 385 # and the targets generated are listed in a variable by that name.
 386 #
 387 # Remaining parameters are named arguments. These include:
 388 #   NAME The base name for the resulting binary, excluding decorations (like *.exe)
 389 #   TYPE Type of binary (EXECUTABLE, LIBRARY or STATIC_LIBRARY). Default is LIBRARY.
</pre>
<hr />
<pre>
 413 #   REORDER reorder file
 414 #   USE_MAPFILE_FOR_SYMBOLS if true and this is a STATIC_BUILD, just copy the
 415 #       mapfile for the output symbols file
 416 #   CC the compiler to use, default is $(CC)
 417 #   LD the linker to use, default is $(LD)
 418 #   OPTIMIZATION sets optimization level to NONE, LOW, HIGH, HIGHEST, HIGHEST_JVM, SIZE
 419 #   DISABLED_WARNINGS_&lt;toolchain&gt; Disable the given warnings for the specified toolchain
 420 #   DISABLED_WARNINGS_C_&lt;toolchain&gt; Disable the given warnings for the specified toolchain
 421 #       when compiling C code
 422 #   DISABLED_WARNINGS_CXX_&lt;toolchain&gt; Disable the given warnings for the specified
 423 #       toolchain when compiling C++ code
 424 #   STRIP_SYMBOLS Set to false to override global strip policy and always leave
 425 #       symbols in the binary, if the toolchain allows for it
 426 #   DEBUG_SYMBOLS Set to false to disable generation of debug symbols
 427 #   COPY_DEBUG_SYMBOLS Set to false to override global setting of debug symbol copying
 428 #   ZIP_EXTERNAL_DEBUG_SYMBOLS Set to false to override global setting of debug symbol
 429 #       zipping
 430 #   STRIPFLAGS Optionally change the flags given to the strip command
 431 #   PRECOMPILED_HEADER Header file to use as precompiled header
 432 #   PRECOMPILED_HEADER_EXCLUDE List of source files that should not use PCH
<span class="line-removed"> 433 #   DEFINE_THIS_FILE Set to false to not set the THIS_FILE preprocessor macro</span>
 434 #
 435 # After being called, some variables are exported from this macro, all prefixed
 436 # with parameter 1 followed by a &#39;_&#39;:
 437 #   TARGET The library or executable created by the macro
 438 #   TARGET_DEPS All prerequisites for the target calculated by the macro
 439 #   ALL_OBJS All object files
 440 #   IMPORT_LIBRARY The import library created for a shared library on Windows
 441 SetupNativeCompilation = $(NamedParamsMacroTemplate)
 442 define SetupNativeCompilationBody
 443 
 444   # If type is unspecified, default to LIBRARY
 445   ifeq ($$($1_TYPE), )
 446     $1_TYPE := LIBRARY
 447   endif
 448 
 449   # If we&#39;re doing a static build and producing a library
 450   # force it to be a static library and remove the -l libraries
 451   ifeq ($(STATIC_BUILD), true)
 452     ifeq ($$($1_TYPE), LIBRARY)
 453       $1_TYPE := STATIC_LIBRARY
</pre>
<hr />
<pre>
 717   # Track variable changes for all variables that affect the compilation command
 718   # lines for all object files in this setup. This includes at least all the
 719   # variables used in the call to add_native_source below.
 720   $1_COMPILE_VARDEPS := $$($1_CFLAGS) $$($1_EXTRA_CFLAGS) $$($1_SYSROOT_CFLAGS) \
 721       $$($1_CXXFLAGS) $$($1_EXTRA_CXXFLAGS) $$($1_OPT_CFLAGS) $$($1_OPT_CXXFLAGS) \
 722       $$($1_CC) $$($1_CXX) $$($1_AS) $$($1_ASFLAGS)
 723   $1_COMPILE_VARDEPS_FILE := $$(call DependOnVariable, $1_COMPILE_VARDEPS, \
 724       $$($1_OBJECT_DIR)/$$($1_NOSUFFIX).comp.vardeps)
 725 
 726   ifneq ($$($1_PRECOMPILED_HEADER), )
 727     ifeq ($(USE_PRECOMPILED_HEADER), true)
 728       ifeq ($(TOOLCHAIN_TYPE), microsoft)
 729         $1_PCH_FILE := $$($1_OBJECT_DIR)/$1.pch
 730         $1_GENERATED_PCH_SRC := $$($1_OBJECT_DIR)/$1_pch.cpp
 731         $1_GENERATED_PCH_OBJ := $$($1_OBJECT_DIR)/$1_pch.obj
 732 
 733         $$(eval $$(call SetupCompileNativeFile, $1_$$(notdir $$($1_GENERATED_PCH_SRC)), \
 734             FILE := $$($1_GENERATED_PCH_SRC), \
 735             BASE := $1, \
 736             EXTRA_CXXFLAGS := -Fp$$($1_PCH_FILE) -Yc$$(notdir $$($1_PRECOMPILED_HEADER)), \
<span class="line-removed"> 737             DEFINE_THIS_FILE := false, \</span>
 738         ))
 739 
 740         $1_USE_PCH_FLAGS := \
 741             -Fp$$($1_PCH_FILE) -Yu$$(notdir $$($1_PRECOMPILED_HEADER))
 742 
 743         $$($1_ALL_OBJS): $$($1_GENERATED_PCH_OBJ)
 744 
 745         # Explicitly add the pch obj file first to ease comparing to old
 746         # hotspot build.
 747         $1_ALL_OBJS := $$($1_GENERATED_PCH_OBJ) $$($1_ALL_OBJS)
 748 
 749         $$($1_GENERATED_PCH_SRC):
 750 		$(ECHO) &quot;#include \&quot;$$(notdir $$($1_PRECOMPILED_HEADER))\&quot;&quot; &gt; $$@
 751 
 752       else ifneq ($(findstring $(TOOLCHAIN_TYPE), gcc clang), )
 753         ifeq ($(TOOLCHAIN_TYPE), gcc)
 754           $1_PCH_FILE := $$($1_OBJECT_DIR)/precompiled/$$(notdir $$($1_PRECOMPILED_HEADER)).gch
 755           $1_USE_PCH_FLAGS := -I$$($1_OBJECT_DIR)/precompiled
 756         else ifeq ($(TOOLCHAIN_TYPE), clang)
 757           $1_PCH_FILE := $$($1_OBJECT_DIR)/precompiled/$$(notdir $$($1_PRECOMPILED_HEADER)).pch
 758           $1_USE_PCH_FLAGS := -include-pch $$($1_PCH_FILE)
 759         endif
 760         $1_PCH_DEPS_FILE := $$($1_PCH_FILE).d
 761         $1_PCH_DEPS_TARGETS_FILE := $$($1_PCH_FILE).d.targets
 762 
 763         -include $$($1_PCH_DEPS_FILE)
 764         -include $$($1_PCH_DEPS_TARGETS_FILE)
 765 
 766         $1_PCH_COMMAND := $$($1_CC) $$($1_CFLAGS) $$($1_EXTRA_CFLAGS) $$($1_SYSROOT_CFLAGS) \
 767             $$($1_OPT_CFLAGS) -x c++-header -c $(C_FLAG_DEPS) $$($1_PCH_DEPS_FILE)
 768 
 769         $$($1_PCH_FILE): $$($1_PRECOMPILED_HEADER) $$($1_COMPILE_VARDEPS_FILE)
 770 		$$(call LogInfo, Generating precompiled header)
 771 		$$(call MakeDir, $$(@D))
<span class="line-modified"> 772 		$$(call ExecuteWithLog, $$@, $$($1_PCH_COMMAND) $$&lt; -o $$@)</span>

 773 		$(SED) $(DEPENDENCY_TARGET_SED_PATTERN) $$($1_PCH_DEPS_FILE) \
 774 		    &gt; $$($1_PCH_DEPS_TARGETS_FILE)
 775 
 776         $$($1_ALL_OBJS): $$($1_PCH_FILE)
 777 
 778         # Generate the corresponding compile_commands.json fragment.
 779         $1_PCH_FILE_JSON := $$(MAKESUPPORT_OUTPUTDIR)/compile-commands/$$(subst /,_,$$(subst \
 780             $$(OUTPUTDIR)/,,$$($1_PCH_FILE))).json
 781         $1_ALL_OBJS_JSON += $$($1_PCH_FILE_JSON)
 782 
 783         $$($1_PCH_FILE_JSON): $$($1_PRECOMPILED_HEADER) $$($1_COMPILE_VARDEPS_FILE)
 784 		$$(call WriteCompileCommandsFragment, $$@, $$(PWD), $$&lt;, \
 785 		    $$($1_PCH_COMMAND) $$&lt; -o $$($1_PCH_FILE))
 786       endif
 787     endif
 788   endif
 789 
 790   # Now call SetupCompileNativeFile for each source file we are going to compile.
 791   $$(foreach file, $$($1_SRCS), \
 792       $$(eval $$(call SetupCompileNativeFile, $1_$$(notdir $$(file)),\
</pre>
<hr />
<pre>
 808 	      $$(if $$(filter %.vardeps, $$?), due to makefile changes))))
 809         endif
 810 	$(TOUCH) $$@
 811 
 812   # On windows we need to create a resource file
 813   ifeq ($(call isTargetOs, windows), true)
 814     ifneq ($$($1_VERSIONINFO_RESOURCE), )
 815       $1_RES := $$($1_OBJECT_DIR)/$$($1_BASENAME).res
 816       $1_RES_DEPS_FILE := $$($1_RES).d
 817       $1_RES_DEPS_TARGETS_FILE := $$($1_RES).d.targets
 818       -include $$($1_RES_DEPS_FILE)
 819       -include $$($1_RES_DEPS_TARGETS_FILE)
 820 
 821       $1_RES_VARDEPS := $$($1_RC) $$($1_RC_FLAGS)
 822       $1_RES_VARDEPS_FILE := $$(call DependOnVariable, $1_RES_VARDEPS, \
 823           $$($1_RES).vardeps)
 824 
 825       $$($1_RES): $$($1_VERSIONINFO_RESOURCE) $$($1_RES_VARDEPS_FILE)
 826 		$$(call LogInfo, Compiling resource $$(notdir $$($1_VERSIONINFO_RESOURCE)) (for $$($1_BASENAME)))
 827 		$$(call MakeDir, $$(@D) $$($1_OBJECT_DIR))
<span class="line-modified"> 828 		$$(call ExecuteWithLog, $$@, \</span>
 829 		    $$($1_RC) $$($1_RC_FLAGS) $$($1_SYSROOT_CFLAGS) $(CC_OUT_OPTION)$$@ \
<span class="line-modified"> 830 		    $$($1_VERSIONINFO_RESOURCE) 2&gt;&amp;1 )</span>
 831                 # Windows RC compiler does not support -showIncludes, so we mis-use CL
 832                 # for this. Filter out RC specific arguments that are unknown to CL.
 833                 # For some unknown reason, in this case CL actually outputs the show
 834                 # includes to stderr so need to redirect it to hide the output from the
 835                 # main log.
 836 		$$(call ExecuteWithLog, $$($1_RES_DEPS_FILE).obj, \
 837 		    $$($1_CC) $$(filter-out -l%, $$($1_RC_FLAGS)) \
 838 		        $$($1_SYSROOT_CFLAGS) -showIncludes -nologo -TC \
 839 		        $(CC_OUT_OPTION)$$($1_RES_DEPS_FILE).obj -P -Fi$$($1_RES_DEPS_FILE).pp \
 840 		        $$($1_VERSIONINFO_RESOURCE)) 2&gt;&amp;1 \
 841 		    | $(TR) -d &#39;\r&#39; | $(GREP) -v -e &quot;^Note: including file:&quot; \
 842 		        -e &quot;^$$(notdir $$($1_VERSIONINFO_RESOURCE))$$$$&quot; || test &quot;$$$$?&quot; = &quot;1&quot; ; \
 843 		$(ECHO) $$($1_RES): \\ &gt; $$($1_RES_DEPS_FILE) ; \
 844 		$(SED) $(WINDOWS_SHOWINCLUDE_SED_PATTERN) $$($1_RES_DEPS_FILE).obj.log \
 845 		    &gt;&gt; $$($1_RES_DEPS_FILE) ; \
 846 		$(ECHO) &gt;&gt; $$($1_RES_DEPS_FILE) ;\
 847 		$(SED) $(DEPENDENCY_TARGET_SED_PATTERN) $$($1_RES_DEPS_FILE) \
 848 		    &gt; $$($1_RES_DEPS_TARGETS_FILE)
 849     endif
 850   endif
</pre>
</td>
<td>
<hr />
<pre>
 187     -e &#39;/^Note: including file:/!d&#39; \
 188     -e &#39;s|Note: including file: *||&#39; \
 189     -e &#39;s|\r||g&#39; \
 190     -e &#39;s|\\|/|g&#39; \
 191     -e &#39;s|^\([a-zA-Z]\):|$(UNIX_PATH_PREFIX)/\1|g&#39; \
 192     -e &#39;\|$(TOPDIR)|I !d&#39; \
 193     -e &#39;s|$$$$| \\|g&#39; \
 194     #
 195 
 196 # This pattern is used to transform a dependency file (.d) to a list
 197 # of make targets for dependent files (.d.targets)
 198 DEPENDENCY_TARGET_SED_PATTERN := \
 199     -e &#39;s/\#.*//&#39; \
 200     -e &#39;s/^[^:]*: *//&#39; \
 201     -e &#39;s/ *\\$$$$//&#39; \
 202     -e &#39;s/^[	 ]*//&#39; \
 203     -e &#39;/^$$$$/ d&#39; \
 204     -e &#39;s/$$$$/ :/&#39; \
 205     #
 206 
<span class="line-added"> 207 ################################################################################</span>
<span class="line-added"> 208 # When absolute paths are not allowed in the output, and the compiler does not</span>
<span class="line-added"> 209 # support any options to avoid it, we need to rewrite compile commands to use</span>
<span class="line-added"> 210 # relative paths. By doing this, the __FILE__ macro will resolve to relative</span>
<span class="line-added"> 211 # paths. The relevant input paths on the command line are the -I flags and the</span>
<span class="line-added"> 212 # path to the source file itself.</span>
<span class="line-added"> 213 #</span>
<span class="line-added"> 214 # The macro MakeCommandRelative is used to rewrite the command line like this:</span>
<span class="line-added"> 215 # &#39;CD $(WORKSPACE_ROOT) &amp;&amp; &lt;cmd&gt;&#39;</span>
<span class="line-added"> 216 # and changes all paths in cmd to be relative to the workspace root. This only</span>
<span class="line-added"> 217 # works properly if the build dir is inside the workspace root. If it&#39;s not,</span>
<span class="line-added"> 218 # relative paths are still calculated, but depending on the distance between the</span>
<span class="line-added"> 219 # dirs, paths in the build dir may end up as essentially absolute anyway.</span>
<span class="line-added"> 220 #</span>
<span class="line-added"> 221 # The fix-deps-file macro is used to adjust the contents of the generated make</span>
<span class="line-added"> 222 # dependency files to contain paths compatible with make.</span>
<span class="line-added"> 223 #</span>
<span class="line-added"> 224 ifeq ($(ALLOW_ABSOLUTE_PATHS_IN_OUTPUT)-$(FILE_MACRO_CFLAGS), false-)</span>
<span class="line-added"> 225   # Need to handle -I flags as both &#39;-Ifoo&#39; and &#39;-I foo&#39;.</span>
<span class="line-added"> 226   MakeCommandRelative = \</span>
<span class="line-added"> 227       $(CD) $(WORKSPACE_ROOT) &amp;&amp; \</span>
<span class="line-added"> 228       $(foreach o, $1, \</span>
<span class="line-added"> 229         $(if $(filter $(WORKSPACE_ROOT)/% $(OUTPUTDIR)/%, $o), \</span>
<span class="line-added"> 230           $(call RelativePath, $o, $(WORKSPACE_ROOT)) \</span>
<span class="line-added"> 231         , \</span>
<span class="line-added"> 232           $(if $(filter -I$(WORKSPACE_ROOT)/%, $o), \</span>
<span class="line-added"> 233             -I$(call RelativePath, $(patsubst -I%, %, $o), $(WORKSPACE_ROOT)) \</span>
<span class="line-added"> 234           , \</span>
<span class="line-added"> 235             $o \</span>
<span class="line-added"> 236           ) \</span>
<span class="line-added"> 237         ) \</span>
<span class="line-added"> 238       )</span>
<span class="line-added"> 239 </span>
<span class="line-added"> 240   # When compiling with relative paths, the deps file comes out with relative</span>
<span class="line-added"> 241   # paths.</span>
<span class="line-added"> 242   ifeq ($(TOOLCHAIN_TYPE), solstudio)</span>
<span class="line-added"> 243     define fix-deps-file</span>
<span class="line-added"> 244 	$(SED) -e &#39;s|\./|$(WORKSPACE_ROOT)/|g&#39; $1.tmp &gt; $1</span>
<span class="line-added"> 245     endef</span>
<span class="line-added"> 246   else</span>
<span class="line-added"> 247     define fix-deps-file</span>
<span class="line-added"> 248 	$(SED) -e &#39;s|^\([ ]*\)|\1$(WORKSPACE_ROOT)|&#39; $1.tmp &gt; $1</span>
<span class="line-added"> 249     endef</span>
<span class="line-added"> 250   endif</span>
<span class="line-added"> 251 else</span>
<span class="line-added"> 252   # By default the MakeCommandRelative macro does nothing.</span>
<span class="line-added"> 253   MakeCommandRelative = $1</span>
<span class="line-added"> 254 </span>
<span class="line-added"> 255   # Even with absolute paths on the command line, the Solaris studio compiler</span>
<span class="line-added"> 256   # doesn&#39;t output the full path to the object file in the generated deps files.</span>
<span class="line-added"> 257   # For other toolchains, no adjustment is needed.</span>
<span class="line-added"> 258   ifeq ($(TOOLCHAIN_TYPE), solstudio)</span>
<span class="line-added"> 259     define fix-deps-file</span>
<span class="line-added"> 260 	$(SED) &#39;s|^$$(@F):|$$@:|&#39; $1.tmp &gt; $1</span>
<span class="line-added"> 261     endef</span>
<span class="line-added"> 262   else</span>
<span class="line-added"> 263     define fix-deps-file</span>
<span class="line-added"> 264 	$(MV) $1.tmp $1</span>
<span class="line-added"> 265     endef</span>
<span class="line-added"> 266   endif</span>
<span class="line-added"> 267 endif</span>
<span class="line-added"> 268 </span>
 269 ################################################################################
 270 # Create the recipe needed to compile a single native source file.
 271 #
 272 # Parameter 1 is the name of the rule, based on the name of the library/
 273 # program being build and the name of the source code file, e.g.
 274 # BUILD_LIBFOO_fooMain.cpp.
 275 #
 276 # Remaining parameters are named arguments:
 277 #   FILE - The full path of the source file to compiler
 278 #   BASE - The name of the rule for the entire binary to build ($1)

 279 #
 280 SetupCompileNativeFile = $(NamedParamsMacroTemplate)
 281 define SetupCompileNativeFileBody
 282   $1_FILENAME := $$(notdir $$($1_FILE))
 283 
 284   # The target file to be generated.
 285   $1_OBJ := $$($$($1_BASE)_OBJECT_DIR)/$$(call replace_with_obj_extension, \
 286       $$($1_FILENAME))
 287 
 288   # Generate the corresponding compile_commands.json fragment.
 289   $1_OBJ_JSON = $$(MAKESUPPORT_OUTPUTDIR)/compile-commands/$$(subst /,_,$$(subst \
 290       $$(OUTPUTDIR)/,,$$($1_OBJ))).json
 291   $$($1_BASE)_ALL_OBJS_JSON += $$($1_OBJ_JSON)
 292 
 293   # Only continue if this object file hasn&#39;t been processed already. This lets
 294   # the first found source file override any other with the same name.
 295   ifeq ($$($1_OBJ_PROCESSED), )
 296     $1_OBJ_PROCESSED := true
 297     # This is the definite source file to use for $1_FILENAME.
 298     $1_SRC_FILE := $$($1_FILE)
 299 






 300     ifeq ($$($1_OPTIMIZATION), )
 301       $1_OPT_CFLAGS := $$($$($1_BASE)_OPT_CFLAGS)
 302       $1_OPT_CXXFLAGS := $$($$($1_BASE)_OPT_CXXFLAGS)
 303     else
 304       ifeq ($$($1_OPTIMIZATION), NONE)
 305         $1_OPT_CFLAGS := $(C_O_FLAG_NONE)
 306         $1_OPT_CXXFLAGS := $(CXX_O_FLAG_NONE)
 307       else ifeq ($$($1_OPTIMIZATION), LOW)
 308         $1_OPT_CFLAGS := $(C_O_FLAG_NORM)
 309         $1_OPT_CXXFLAGS := $(CXX_O_FLAG_NORM)
 310       else ifeq ($$($1_OPTIMIZATION), HIGH)
 311         $1_OPT_CFLAGS := $(C_O_FLAG_HI)
 312         $1_OPT_CXXFLAGS := $(CXX_O_FLAG_HI)
 313       else ifeq ($$($1_OPTIMIZATION), HIGHEST)
 314         $1_OPT_CFLAGS := $(C_O_FLAG_HIGHEST)
 315         $1_OPT_CXXFLAGS := $(CXX_O_FLAG_HIGHEST)
 316       else ifeq ($$($1_OPTIMIZATION), HIGHEST_JVM)
 317         $1_OPT_CFLAGS := $(C_O_FLAG_HIGHEST_JVM)
 318         $1_OPT_CXXFLAGS := $(CXX_O_FLAG_HIGHEST_JVM)
 319       else ifeq ($$($1_OPTIMIZATION), SIZE)
</pre>
<hr />
<pre>
 322       else
 323         $$(error Unknown value for file OPTIMIZATION: $$($1_OPTIMIZATION))
 324       endif
 325     endif
 326 
 327     ifneq ($$($$($1_BASE)_PRECOMPILED_HEADER), )
 328       ifeq ($$(filter $$($1_FILENAME), $$($$($1_BASE)_PRECOMPILED_HEADER_EXCLUDE)), )
 329         $1_USE_PCH_FLAGS := $$($$($1_BASE)_USE_PCH_FLAGS)
 330       endif
 331     endif
 332 
 333     $1_BASE_CFLAGS :=  $$($$($1_BASE)_CFLAGS) $$($$($1_BASE)_EXTRA_CFLAGS) \
 334         $$($$($1_BASE)_SYSROOT_CFLAGS)
 335     $1_BASE_CXXFLAGS := $$($$($1_BASE)_CXXFLAGS) $$($$($1_BASE)_EXTRA_CXXFLAGS) \
 336         $$($$($1_BASE)_SYSROOT_CFLAGS) $$($1_EXTRA_CXXFLAGS)
 337     $1_BASE_ASFLAGS := $$($$($1_BASE)_ASFLAGS) $$($$($1_BASE)_EXTRA_ASFLAGS)
 338 
 339     ifneq ($$(filter %.c, $$($1_FILENAME)), )
 340       # Compile as a C file
 341       $1_FLAGS := $(CFLAGS_CCACHE) $$($1_USE_PCH_FLAGS) $$($1_BASE_CFLAGS) \
<span class="line-modified"> 342           $$($1_OPT_CFLAGS) $$($1_CFLAGS) -c</span>
 343       $1_COMPILER := $$($$($1_BASE)_CC)
 344       $1_DEP_FLAG := $(C_FLAG_DEPS)
 345     else ifneq ($$(filter %.m, $$($1_FILENAME)), )
 346       # Compile as an Objective-C file
 347       $1_FLAGS := -x objective-c $(CFLAGS_CCACHE) $$($1_USE_PCH_FLAGS) \
<span class="line-modified"> 348           $$($1_BASE_CFLAGS) $$($1_OPT_CFLAGS) $$($1_CFLAGS) -c</span>
 349       $1_COMPILER := $$($$($1_BASE)_CC)
 350       $1_DEP_FLAG := $(C_FLAG_DEPS)
 351     else ifneq ($$(filter %.s %.S, $$($1_FILENAME)), )
 352       # Compile as assembler file
 353       $1_FLAGS := $$($1_BASE_ASFLAGS)
 354       $1_COMPILER := $(AS)
 355       $1_DEP_FLAG :=
 356     else ifneq ($$(filter %.cpp %.cc %.mm, $$($1_FILENAME)), )
 357       # Compile as a C++ or Objective-C++ file
 358       $1_FLAGS := $(CFLAGS_CCACHE) $$($1_USE_PCH_FLAGS) $$($1_BASE_CXXFLAGS) \
<span class="line-modified"> 359           $$($1_OPT_CXXFLAGS) $$($1_CXXFLAGS) -c</span>
 360       $1_COMPILER := $$($$($1_BASE)_CXX)
 361       $1_DEP_FLAG := $(CXX_FLAG_DEPS)
 362     else
 363       $$(error Internal error in NativeCompilation.gmk: no compiler for file $$($1_FILENAME))
 364     endif
 365 
 366     ifeq ($$(filter %.s %.S, $$($1_FILENAME)), )
 367       # And this is the dependency file for this obj file.
 368       $1_DEPS_FILE := $$(patsubst %$(OBJ_SUFFIX),%.d,$$($1_OBJ))
 369       # The dependency target file lists all dependencies as empty targets to
 370       # avoid make error &quot;No rule to make target&quot; for removed files
 371       $1_DEPS_TARGETS_FILE := $$(patsubst %$(OBJ_SUFFIX),%.d.targets,$$($1_OBJ))
 372 
 373       # Only try to load individual dependency information files if the global
 374       # file hasn&#39;t been loaded (could happen if make was interrupted).
 375       ifneq ($$($$($1_BASE)_DEPS_FILE_LOADED), true)
 376         # Include previously generated dependency information. (if it exists)
 377         -include $$($1_DEPS_FILE)
 378         -include $$($1_DEPS_TARGETS_FILE)
 379       endif
 380     endif
 381 
 382     ifneq ($$(strip $$($1_CFLAGS) $$($1_CXXFLAGS) $$($1_OPTIMIZATION)), )
 383       $1_VARDEPS := $$($1_CFLAGS) $$($1_CXXFLAGS) $$($1_OPTIMIZATION)
 384       $1_VARDEPS_FILE := $$(call DependOnVariable, $1_VARDEPS, $$($1_OBJ).vardeps)
 385     endif
 386 
 387     $1_OBJ_DEPS := $$($1_SRC_FILE) $$($$($1_BASE)_COMPILE_VARDEPS_FILE) \
 388         $$($$($1_BASE)_EXTRA_DEPS) $$($1_VARDEPS_FILE)
 389     $1_COMPILE_OPTIONS := $$($1_FLAGS) $(CC_OUT_OPTION)$$($1_OBJ) $$($1_SRC_FILE)
 390 
 391     $$($1_OBJ_JSON): $$($1_OBJ_DEPS)
 392 	$$(call WriteCompileCommandsFragment, $$@, $$(PWD), $$($1_SRC_FILE), \
 393 	    $$($1_COMPILER) $$($1_COMPILE_OPTIONS))
 394 
 395     $$($1_OBJ): $$($1_OBJ_DEPS) | $$($$($1_BASE)_BUILD_INFO)
 396 	$$(call LogInfo, Compiling $$($1_FILENAME) (for $$($$($1_BASE)_BASENAME)))
 397 	$$(call MakeDir, $$(@D))
 398         ifneq ($(TOOLCHAIN_TYPE), microsoft)
<span class="line-modified"> 399 	  $$(call ExecuteWithLog, $$@, $$(call MakeCommandRelative, \</span>
<span class="line-modified"> 400 	      $$($1_COMPILER) $$($1_DEP_FLAG) \</span>
<span class="line-modified"> 401 	      $$(addsuffix .tmp, $$($1_DEPS_FILE)) \</span>
<span class="line-modified"> 402 	      $$($1_COMPILE_OPTIONS)))</span>









 403           ifneq ($$($1_DEPS_FILE), )
<span class="line-modified"> 404 	    $$(call fix-deps-file, $$($1_DEPS_FILE))</span>
<span class="line-added"> 405             # Create a dependency target file from the dependency file.</span>
<span class="line-added"> 406             # Solution suggested by:</span>
<span class="line-added"> 407             # http://make.mad-scientist.net/papers/advanced-auto-dependency-generation/</span>
<span class="line-added"> 408 	    $(SED) $(DEPENDENCY_TARGET_SED_PATTERN) $$($1_DEPS_FILE) \</span>
<span class="line-added"> 409 	        &gt; $$($1_DEPS_TARGETS_FILE)</span>
 410           endif
 411         else
 412           # The Visual Studio compiler lacks a feature for generating make
 413           # dependencies, but by setting -showIncludes, all included files are
 414           # printed. These are filtered out and parsed into make dependences.
 415           #
 416           # Keep as much as possible on one execution line for best performance
 417           # on Windows. No need to save exit code from compilation since
 418           # pipefail is always active on Windows.
<span class="line-modified"> 419 	  $$(call ExecuteWithLog, $$@, $$(call MakeCommandRelative, \</span>
<span class="line-modified"> 420 	      $$($1_COMPILER) -showIncludes $$($1_COMPILE_OPTIONS))) \</span>
 421 	      | $(TR) -d &#39;\r&#39; | $(GREP) -v -e &quot;^Note: including file:&quot; \
 422 	          -e &quot;^$$($1_FILENAME)$$$$&quot; || test &quot;$$$$?&quot; = &quot;1&quot; ; \
 423 	  $(ECHO) $$@: \\ &gt; $$($1_DEPS_FILE) ; \
 424 	  $(SED) $(WINDOWS_SHOWINCLUDE_SED_PATTERN) $$($1_OBJ).log \
 425 	      | $(SORT) -u &gt;&gt; $$($1_DEPS_FILE) ; \
 426 	  $(ECHO) &gt;&gt; $$($1_DEPS_FILE) ; \
 427 	  $(SED) $(DEPENDENCY_TARGET_SED_PATTERN) $$($1_DEPS_FILE) &gt; $$($1_DEPS_TARGETS_FILE)
 428         endif
 429   endif
 430 endef
 431 
 432 # Setup make rules for creating a native binary (a shared library or an
 433 # executable).
 434 #
 435 # Parameter 1 is the name of the rule. This name is used as variable prefix,
 436 # and the targets generated are listed in a variable by that name.
 437 #
 438 # Remaining parameters are named arguments. These include:
 439 #   NAME The base name for the resulting binary, excluding decorations (like *.exe)
 440 #   TYPE Type of binary (EXECUTABLE, LIBRARY or STATIC_LIBRARY). Default is LIBRARY.
</pre>
<hr />
<pre>
 464 #   REORDER reorder file
 465 #   USE_MAPFILE_FOR_SYMBOLS if true and this is a STATIC_BUILD, just copy the
 466 #       mapfile for the output symbols file
 467 #   CC the compiler to use, default is $(CC)
 468 #   LD the linker to use, default is $(LD)
 469 #   OPTIMIZATION sets optimization level to NONE, LOW, HIGH, HIGHEST, HIGHEST_JVM, SIZE
 470 #   DISABLED_WARNINGS_&lt;toolchain&gt; Disable the given warnings for the specified toolchain
 471 #   DISABLED_WARNINGS_C_&lt;toolchain&gt; Disable the given warnings for the specified toolchain
 472 #       when compiling C code
 473 #   DISABLED_WARNINGS_CXX_&lt;toolchain&gt; Disable the given warnings for the specified
 474 #       toolchain when compiling C++ code
 475 #   STRIP_SYMBOLS Set to false to override global strip policy and always leave
 476 #       symbols in the binary, if the toolchain allows for it
 477 #   DEBUG_SYMBOLS Set to false to disable generation of debug symbols
 478 #   COPY_DEBUG_SYMBOLS Set to false to override global setting of debug symbol copying
 479 #   ZIP_EXTERNAL_DEBUG_SYMBOLS Set to false to override global setting of debug symbol
 480 #       zipping
 481 #   STRIPFLAGS Optionally change the flags given to the strip command
 482 #   PRECOMPILED_HEADER Header file to use as precompiled header
 483 #   PRECOMPILED_HEADER_EXCLUDE List of source files that should not use PCH

 484 #
 485 # After being called, some variables are exported from this macro, all prefixed
 486 # with parameter 1 followed by a &#39;_&#39;:
 487 #   TARGET The library or executable created by the macro
 488 #   TARGET_DEPS All prerequisites for the target calculated by the macro
 489 #   ALL_OBJS All object files
 490 #   IMPORT_LIBRARY The import library created for a shared library on Windows
 491 SetupNativeCompilation = $(NamedParamsMacroTemplate)
 492 define SetupNativeCompilationBody
 493 
 494   # If type is unspecified, default to LIBRARY
 495   ifeq ($$($1_TYPE), )
 496     $1_TYPE := LIBRARY
 497   endif
 498 
 499   # If we&#39;re doing a static build and producing a library
 500   # force it to be a static library and remove the -l libraries
 501   ifeq ($(STATIC_BUILD), true)
 502     ifeq ($$($1_TYPE), LIBRARY)
 503       $1_TYPE := STATIC_LIBRARY
</pre>
<hr />
<pre>
 767   # Track variable changes for all variables that affect the compilation command
 768   # lines for all object files in this setup. This includes at least all the
 769   # variables used in the call to add_native_source below.
 770   $1_COMPILE_VARDEPS := $$($1_CFLAGS) $$($1_EXTRA_CFLAGS) $$($1_SYSROOT_CFLAGS) \
 771       $$($1_CXXFLAGS) $$($1_EXTRA_CXXFLAGS) $$($1_OPT_CFLAGS) $$($1_OPT_CXXFLAGS) \
 772       $$($1_CC) $$($1_CXX) $$($1_AS) $$($1_ASFLAGS)
 773   $1_COMPILE_VARDEPS_FILE := $$(call DependOnVariable, $1_COMPILE_VARDEPS, \
 774       $$($1_OBJECT_DIR)/$$($1_NOSUFFIX).comp.vardeps)
 775 
 776   ifneq ($$($1_PRECOMPILED_HEADER), )
 777     ifeq ($(USE_PRECOMPILED_HEADER), true)
 778       ifeq ($(TOOLCHAIN_TYPE), microsoft)
 779         $1_PCH_FILE := $$($1_OBJECT_DIR)/$1.pch
 780         $1_GENERATED_PCH_SRC := $$($1_OBJECT_DIR)/$1_pch.cpp
 781         $1_GENERATED_PCH_OBJ := $$($1_OBJECT_DIR)/$1_pch.obj
 782 
 783         $$(eval $$(call SetupCompileNativeFile, $1_$$(notdir $$($1_GENERATED_PCH_SRC)), \
 784             FILE := $$($1_GENERATED_PCH_SRC), \
 785             BASE := $1, \
 786             EXTRA_CXXFLAGS := -Fp$$($1_PCH_FILE) -Yc$$(notdir $$($1_PRECOMPILED_HEADER)), \

 787         ))
 788 
 789         $1_USE_PCH_FLAGS := \
 790             -Fp$$($1_PCH_FILE) -Yu$$(notdir $$($1_PRECOMPILED_HEADER))
 791 
 792         $$($1_ALL_OBJS): $$($1_GENERATED_PCH_OBJ)
 793 
 794         # Explicitly add the pch obj file first to ease comparing to old
 795         # hotspot build.
 796         $1_ALL_OBJS := $$($1_GENERATED_PCH_OBJ) $$($1_ALL_OBJS)
 797 
 798         $$($1_GENERATED_PCH_SRC):
 799 		$(ECHO) &quot;#include \&quot;$$(notdir $$($1_PRECOMPILED_HEADER))\&quot;&quot; &gt; $$@
 800 
 801       else ifneq ($(findstring $(TOOLCHAIN_TYPE), gcc clang), )
 802         ifeq ($(TOOLCHAIN_TYPE), gcc)
 803           $1_PCH_FILE := $$($1_OBJECT_DIR)/precompiled/$$(notdir $$($1_PRECOMPILED_HEADER)).gch
 804           $1_USE_PCH_FLAGS := -I$$($1_OBJECT_DIR)/precompiled
 805         else ifeq ($(TOOLCHAIN_TYPE), clang)
 806           $1_PCH_FILE := $$($1_OBJECT_DIR)/precompiled/$$(notdir $$($1_PRECOMPILED_HEADER)).pch
 807           $1_USE_PCH_FLAGS := -include-pch $$($1_PCH_FILE)
 808         endif
 809         $1_PCH_DEPS_FILE := $$($1_PCH_FILE).d
 810         $1_PCH_DEPS_TARGETS_FILE := $$($1_PCH_FILE).d.targets
 811 
 812         -include $$($1_PCH_DEPS_FILE)
 813         -include $$($1_PCH_DEPS_TARGETS_FILE)
 814 
 815         $1_PCH_COMMAND := $$($1_CC) $$($1_CFLAGS) $$($1_EXTRA_CFLAGS) $$($1_SYSROOT_CFLAGS) \
 816             $$($1_OPT_CFLAGS) -x c++-header -c $(C_FLAG_DEPS) $$($1_PCH_DEPS_FILE)
 817 
 818         $$($1_PCH_FILE): $$($1_PRECOMPILED_HEADER) $$($1_COMPILE_VARDEPS_FILE)
 819 		$$(call LogInfo, Generating precompiled header)
 820 		$$(call MakeDir, $$(@D))
<span class="line-modified"> 821 		$$(call ExecuteWithLog, $$@, $$(call MakeCommandRelative, \</span>
<span class="line-added"> 822 		    $$($1_PCH_COMMAND) $$&lt; -o $$@))</span>
 823 		$(SED) $(DEPENDENCY_TARGET_SED_PATTERN) $$($1_PCH_DEPS_FILE) \
 824 		    &gt; $$($1_PCH_DEPS_TARGETS_FILE)
 825 
 826         $$($1_ALL_OBJS): $$($1_PCH_FILE)
 827 
 828         # Generate the corresponding compile_commands.json fragment.
 829         $1_PCH_FILE_JSON := $$(MAKESUPPORT_OUTPUTDIR)/compile-commands/$$(subst /,_,$$(subst \
 830             $$(OUTPUTDIR)/,,$$($1_PCH_FILE))).json
 831         $1_ALL_OBJS_JSON += $$($1_PCH_FILE_JSON)
 832 
 833         $$($1_PCH_FILE_JSON): $$($1_PRECOMPILED_HEADER) $$($1_COMPILE_VARDEPS_FILE)
 834 		$$(call WriteCompileCommandsFragment, $$@, $$(PWD), $$&lt;, \
 835 		    $$($1_PCH_COMMAND) $$&lt; -o $$($1_PCH_FILE))
 836       endif
 837     endif
 838   endif
 839 
 840   # Now call SetupCompileNativeFile for each source file we are going to compile.
 841   $$(foreach file, $$($1_SRCS), \
 842       $$(eval $$(call SetupCompileNativeFile, $1_$$(notdir $$(file)),\
</pre>
<hr />
<pre>
 858 	      $$(if $$(filter %.vardeps, $$?), due to makefile changes))))
 859         endif
 860 	$(TOUCH) $$@
 861 
 862   # On windows we need to create a resource file
 863   ifeq ($(call isTargetOs, windows), true)
 864     ifneq ($$($1_VERSIONINFO_RESOURCE), )
 865       $1_RES := $$($1_OBJECT_DIR)/$$($1_BASENAME).res
 866       $1_RES_DEPS_FILE := $$($1_RES).d
 867       $1_RES_DEPS_TARGETS_FILE := $$($1_RES).d.targets
 868       -include $$($1_RES_DEPS_FILE)
 869       -include $$($1_RES_DEPS_TARGETS_FILE)
 870 
 871       $1_RES_VARDEPS := $$($1_RC) $$($1_RC_FLAGS)
 872       $1_RES_VARDEPS_FILE := $$(call DependOnVariable, $1_RES_VARDEPS, \
 873           $$($1_RES).vardeps)
 874 
 875       $$($1_RES): $$($1_VERSIONINFO_RESOURCE) $$($1_RES_VARDEPS_FILE)
 876 		$$(call LogInfo, Compiling resource $$(notdir $$($1_VERSIONINFO_RESOURCE)) (for $$($1_BASENAME)))
 877 		$$(call MakeDir, $$(@D) $$($1_OBJECT_DIR))
<span class="line-modified"> 878 		$$(call ExecuteWithLog, $$@, $$(call MakeCommandRelative, \</span>
 879 		    $$($1_RC) $$($1_RC_FLAGS) $$($1_SYSROOT_CFLAGS) $(CC_OUT_OPTION)$$@ \
<span class="line-modified"> 880 		    $$($1_VERSIONINFO_RESOURCE) 2&gt;&amp;1 ))</span>
 881                 # Windows RC compiler does not support -showIncludes, so we mis-use CL
 882                 # for this. Filter out RC specific arguments that are unknown to CL.
 883                 # For some unknown reason, in this case CL actually outputs the show
 884                 # includes to stderr so need to redirect it to hide the output from the
 885                 # main log.
 886 		$$(call ExecuteWithLog, $$($1_RES_DEPS_FILE).obj, \
 887 		    $$($1_CC) $$(filter-out -l%, $$($1_RC_FLAGS)) \
 888 		        $$($1_SYSROOT_CFLAGS) -showIncludes -nologo -TC \
 889 		        $(CC_OUT_OPTION)$$($1_RES_DEPS_FILE).obj -P -Fi$$($1_RES_DEPS_FILE).pp \
 890 		        $$($1_VERSIONINFO_RESOURCE)) 2&gt;&amp;1 \
 891 		    | $(TR) -d &#39;\r&#39; | $(GREP) -v -e &quot;^Note: including file:&quot; \
 892 		        -e &quot;^$$(notdir $$($1_VERSIONINFO_RESOURCE))$$$$&quot; || test &quot;$$$$?&quot; = &quot;1&quot; ; \
 893 		$(ECHO) $$($1_RES): \\ &gt; $$($1_RES_DEPS_FILE) ; \
 894 		$(SED) $(WINDOWS_SHOWINCLUDE_SED_PATTERN) $$($1_RES_DEPS_FILE).obj.log \
 895 		    &gt;&gt; $$($1_RES_DEPS_FILE) ; \
 896 		$(ECHO) &gt;&gt; $$($1_RES_DEPS_FILE) ;\
 897 		$(SED) $(DEPENDENCY_TARGET_SED_PATTERN) $$($1_RES_DEPS_FILE) \
 898 		    &gt; $$($1_RES_DEPS_TARGETS_FILE)
 899     endif
 900   endif
</pre>
</td>
</tr>
</table>
<center><a href="Modules.gmk.sdiff.html" target="_top">&lt; prev</a> <a href="../../index.html" target="_top">index</a> <a href="../copy/Copy-java.base.gmk.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>