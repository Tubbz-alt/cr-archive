<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff application/org.openjdk.jmc.alert/src/main/java/org/openjdk/jmc/alert/AlertPlugin.java</title>
    <link rel="stylesheet" href="../../../../../../../../../style.css" />
  </head>
<body>
<center>&lt; prev <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="../../../../../../../../org.openjdk.jmc.browser/build.properties.sdiff.html" target="_top">next &gt;</a></center>    <h2>application/org.openjdk.jmc.alert/src/main/java/org/openjdk/jmc/alert/AlertPlugin.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 26  * FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR
 27  * CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL
 28  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
 29  * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY,
 30  * WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY
 31  * WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 32  */
 33 package org.openjdk.jmc.alert;
 34 
 35 import java.text.DateFormat;
 36 import java.text.MessageFormat;
 37 import java.util.ArrayList;
 38 import java.util.Date;
 39 
 40 import org.eclipse.jface.resource.ImageRegistry;
 41 import org.eclipse.osgi.util.NLS;
 42 import org.eclipse.swt.SWT;
 43 import org.eclipse.swt.graphics.Image;
 44 import org.eclipse.swt.widgets.Display;
 45 import org.eclipse.swt.widgets.Shell;

 46 import org.openjdk.jmc.rjmx.IConnectionHandle;
 47 import org.openjdk.jmc.rjmx.triggers.TriggerEvent;
 48 import org.openjdk.jmc.rjmx.triggers.TriggerRule;
 49 import org.openjdk.jmc.ui.MCAbstractUIPlugin;
 50 import org.openjdk.jmc.ui.UIPlugin;
 51 import org.openjdk.jmc.ui.misc.DisplayToolkit;
 52 import org.osgi.framework.BundleContext;
 53 
 54 /**
 55  * The main plugin class to be used in the desktop.
 56  */
 57 public class AlertPlugin extends MCAbstractUIPlugin {
 58 	public final static String PLUGIN_ID = &quot;org.openjdk.jmc.alert&quot;; //$NON-NLS-1$
 59 
 60 	public static final String IMAGE_ALERT_BANNER = &quot;AlertBanner&quot;; //$NON-NLS-1$
 61 	public static final String PREF_KEY_POPUP = &quot;POPUP&quot;; //$NON-NLS-1$
 62 
 63 	private static final int MAX_ALERT_SIZE = 1000;
 64 
 65 	// The shared instance.
</pre>
<hr />
<pre>
103 	public synchronized void addNotificationEvent(TriggerEvent e) {
104 		addAlertObject(new AlertObject(e.getCreationTime(), e.getSource().getServerDescriptor().getDisplayName(),
105 				e.getRule(), NotificationUIToolkit.prettyPrint(e), null));
106 	}
107 
108 	public synchronized void addAlertObject(AlertObject ao) {
109 		if (alerts.size() &gt;= MAX_ALERT_SIZE) {
110 			alerts.remove(0);
111 		}
112 		alerts.add(ao);
113 		showDialog(ao.getException() != null);
114 		showTrayPopup(ao);
115 	}
116 
117 	private void showTrayPopup(AlertObject ao) {
118 		if (UIPlugin.getDefault().getTrayManager() != null) {
119 			final String message = createTrayMessage(ao);
120 			final String title = Messages.AlertPlugin_TRIGGER_ALERT_TEXT;
121 			final int style = SWT.BALLOON | SWT.ICON_WARNING;
122 
<span class="line-modified">123 			DisplayToolkit.safeAsyncExec(getDefault().getWorkbench().getDisplay(), new Runnable() {</span>
124 				@Override
125 				public void run() {
126 					UIPlugin.getDefault().getTrayManager().showTooltip(title, message, style);
127 				}
128 			});
129 		}
130 	}
131 
132 	// Special formatting for tray for non-exception messages.
133 	public String createTrayMessage(AlertObject ae) {
134 		if (ae.getException() == null) {
135 			return createRuleMessage(ae);
136 		} else {
137 			return ae.getMessage();
138 		}
139 	}
140 
141 	private String createExceptionMessage(Date d, Throwable exception, TriggerRule rule) {
142 		StringBuilder builder = new StringBuilder();
143 		if (d != null) {
</pre>
<hr />
<pre>
162 		if (d != null) {
163 			DateFormat df1 = DateFormat.getDateInstance(DateFormat.SHORT);
164 			DateFormat df2 = DateFormat.getTimeInstance(DateFormat.MEDIUM);
165 			message += MessageFormat.format(Messages.AlertPlugin_TIME_X_Y_TEXT,
166 					new Object[] {df1.format(d), df2.format(d)});
167 		}
168 		message += MessageFormat.format(Messages.AlertPlugin_SOURCE_X_TEXT, new Object[] {ae.getSourceName()});
169 		return message;
170 	}
171 
172 	public void setPopup(boolean popup) {
173 		getPreferenceStore().setValue(PREF_KEY_POPUP, popup);
174 	}
175 
176 	public boolean getPopup() {
177 		return getPreferenceStore().getBoolean(PREF_KEY_POPUP);
178 	}
179 
180 	public void showDialog(boolean alwaysShow) {
181 		if (getPopup() || alwaysShow || hasDialog()) {
<span class="line-modified">182 			DisplayToolkit.safeAsyncExec(getDefault().getWorkbench().getDisplay(), new Runnable() {</span>
183 				@Override
184 				public void run() {
<span class="line-modified">185 					Display display = getDefault().getWorkbench().getDisplay();</span>
186 					Shell shell = display.getActiveShell();
187 					if (shell != null &amp;&amp; !shell.isDisposed()) {
188 						if (!hasDialog()) {
189 							dialog = createDialog(shell);
190 						}
191 						if (dialog != null) {
192 							dialog.open();
193 							dialog.refreshAlertDialog();
194 						}
195 					}
196 				}
197 			});
198 		}
199 	}
200 
201 	public boolean hasDialog() {
202 		if (dialog == null) {
203 			return false;
204 		}
205 		if (dialog.getShell() == null) {
206 			return false;
207 		}
208 		if (dialog.getShell().isDisposed()) {
209 			return false;
210 		}
211 		return true;
212 	}
213 
214 	public static AlertDialog createDialog(Shell shell) {
<span class="line-modified">215 		Display display = getDefault().getWorkbench().getDisplay();</span>
216 		if (display != null &amp;&amp; !display.isDisposed() &amp;&amp; display.getActiveShell() != null
217 				&amp;&amp; !display.getActiveShell().isDisposed()) {
218 			return new AlertDialog(display.getActiveShell());
219 		} else {
220 			return null;
221 		}
222 	}
223 
224 	public synchronized void clearNotificationEventLog() {
225 		alerts.clear();
226 	}
227 
228 	public synchronized AlertObject[] getAlerts() {
229 		return alerts.toArray(new AlertObject[alerts.size()]);
230 	}
231 
232 	@Override
233 	public Image getImage(String image) {
234 		return getImageRegistry().get(image);
235 	}
</pre>
</td>
<td>
<hr />
<pre>
 26  * FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR
 27  * CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL
 28  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
 29  * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY,
 30  * WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY
 31  * WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 32  */
 33 package org.openjdk.jmc.alert;
 34 
 35 import java.text.DateFormat;
 36 import java.text.MessageFormat;
 37 import java.util.ArrayList;
 38 import java.util.Date;
 39 
 40 import org.eclipse.jface.resource.ImageRegistry;
 41 import org.eclipse.osgi.util.NLS;
 42 import org.eclipse.swt.SWT;
 43 import org.eclipse.swt.graphics.Image;
 44 import org.eclipse.swt.widgets.Display;
 45 import org.eclipse.swt.widgets.Shell;
<span class="line-added"> 46 import org.eclipse.ui.PlatformUI;</span>
 47 import org.openjdk.jmc.rjmx.IConnectionHandle;
 48 import org.openjdk.jmc.rjmx.triggers.TriggerEvent;
 49 import org.openjdk.jmc.rjmx.triggers.TriggerRule;
 50 import org.openjdk.jmc.ui.MCAbstractUIPlugin;
 51 import org.openjdk.jmc.ui.UIPlugin;
 52 import org.openjdk.jmc.ui.misc.DisplayToolkit;
 53 import org.osgi.framework.BundleContext;
 54 
 55 /**
 56  * The main plugin class to be used in the desktop.
 57  */
 58 public class AlertPlugin extends MCAbstractUIPlugin {
 59 	public final static String PLUGIN_ID = &quot;org.openjdk.jmc.alert&quot;; //$NON-NLS-1$
 60 
 61 	public static final String IMAGE_ALERT_BANNER = &quot;AlertBanner&quot;; //$NON-NLS-1$
 62 	public static final String PREF_KEY_POPUP = &quot;POPUP&quot;; //$NON-NLS-1$
 63 
 64 	private static final int MAX_ALERT_SIZE = 1000;
 65 
 66 	// The shared instance.
</pre>
<hr />
<pre>
104 	public synchronized void addNotificationEvent(TriggerEvent e) {
105 		addAlertObject(new AlertObject(e.getCreationTime(), e.getSource().getServerDescriptor().getDisplayName(),
106 				e.getRule(), NotificationUIToolkit.prettyPrint(e), null));
107 	}
108 
109 	public synchronized void addAlertObject(AlertObject ao) {
110 		if (alerts.size() &gt;= MAX_ALERT_SIZE) {
111 			alerts.remove(0);
112 		}
113 		alerts.add(ao);
114 		showDialog(ao.getException() != null);
115 		showTrayPopup(ao);
116 	}
117 
118 	private void showTrayPopup(AlertObject ao) {
119 		if (UIPlugin.getDefault().getTrayManager() != null) {
120 			final String message = createTrayMessage(ao);
121 			final String title = Messages.AlertPlugin_TRIGGER_ALERT_TEXT;
122 			final int style = SWT.BALLOON | SWT.ICON_WARNING;
123 
<span class="line-modified">124 			DisplayToolkit.safeAsyncExec(PlatformUI.getWorkbench().getDisplay(), new Runnable() {</span>
125 				@Override
126 				public void run() {
127 					UIPlugin.getDefault().getTrayManager().showTooltip(title, message, style);
128 				}
129 			});
130 		}
131 	}
132 
133 	// Special formatting for tray for non-exception messages.
134 	public String createTrayMessage(AlertObject ae) {
135 		if (ae.getException() == null) {
136 			return createRuleMessage(ae);
137 		} else {
138 			return ae.getMessage();
139 		}
140 	}
141 
142 	private String createExceptionMessage(Date d, Throwable exception, TriggerRule rule) {
143 		StringBuilder builder = new StringBuilder();
144 		if (d != null) {
</pre>
<hr />
<pre>
163 		if (d != null) {
164 			DateFormat df1 = DateFormat.getDateInstance(DateFormat.SHORT);
165 			DateFormat df2 = DateFormat.getTimeInstance(DateFormat.MEDIUM);
166 			message += MessageFormat.format(Messages.AlertPlugin_TIME_X_Y_TEXT,
167 					new Object[] {df1.format(d), df2.format(d)});
168 		}
169 		message += MessageFormat.format(Messages.AlertPlugin_SOURCE_X_TEXT, new Object[] {ae.getSourceName()});
170 		return message;
171 	}
172 
173 	public void setPopup(boolean popup) {
174 		getPreferenceStore().setValue(PREF_KEY_POPUP, popup);
175 	}
176 
177 	public boolean getPopup() {
178 		return getPreferenceStore().getBoolean(PREF_KEY_POPUP);
179 	}
180 
181 	public void showDialog(boolean alwaysShow) {
182 		if (getPopup() || alwaysShow || hasDialog()) {
<span class="line-modified">183 			DisplayToolkit.safeAsyncExec(PlatformUI.getWorkbench().getDisplay(), new Runnable() {</span>
184 				@Override
185 				public void run() {
<span class="line-modified">186 					Display display = PlatformUI.getWorkbench().getDisplay();</span>
187 					Shell shell = display.getActiveShell();
188 					if (shell != null &amp;&amp; !shell.isDisposed()) {
189 						if (!hasDialog()) {
190 							dialog = createDialog(shell);
191 						}
192 						if (dialog != null) {
193 							dialog.open();
194 							dialog.refreshAlertDialog();
195 						}
196 					}
197 				}
198 			});
199 		}
200 	}
201 
202 	public boolean hasDialog() {
203 		if (dialog == null) {
204 			return false;
205 		}
206 		if (dialog.getShell() == null) {
207 			return false;
208 		}
209 		if (dialog.getShell().isDisposed()) {
210 			return false;
211 		}
212 		return true;
213 	}
214 
215 	public static AlertDialog createDialog(Shell shell) {
<span class="line-modified">216 		Display display = PlatformUI.getWorkbench().getDisplay();</span>
217 		if (display != null &amp;&amp; !display.isDisposed() &amp;&amp; display.getActiveShell() != null
218 				&amp;&amp; !display.getActiveShell().isDisposed()) {
219 			return new AlertDialog(display.getActiveShell());
220 		} else {
221 			return null;
222 		}
223 	}
224 
225 	public synchronized void clearNotificationEventLog() {
226 		alerts.clear();
227 	}
228 
229 	public synchronized AlertObject[] getAlerts() {
230 		return alerts.toArray(new AlertObject[alerts.size()]);
231 	}
232 
233 	@Override
234 	public Image getImage(String image) {
235 		return getImageRegistry().get(image);
236 	}
</pre>
</td>
</tr>
</table>
<center>&lt; prev <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="../../../../../../../../org.openjdk.jmc.browser/build.properties.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>