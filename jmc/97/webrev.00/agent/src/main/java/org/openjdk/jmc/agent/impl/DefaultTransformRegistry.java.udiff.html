<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff agent/src/main/java/org/openjdk/jmc/agent/impl/DefaultTransformRegistry.java</title>
    <link rel="stylesheet" href="../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="../TransformRegistry.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="../jmx/AgentController.java.udiff.html" target="_top">next &gt;</a></center>    <h2>agent/src/main/java/org/openjdk/jmc/agent/impl/DefaultTransformRegistry.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -37,10 +37,11 @@</span>
  import java.io.InputStream;
  import java.io.StringReader;
  import java.util.ArrayList;
  import java.util.Collections;
  import java.util.HashMap;
<span class="udiff-line-added">+ import java.util.HashSet;</span>
  import java.util.LinkedList;
  import java.util.List;
  import java.util.Map;
  import java.util.Map.Entry;
  import java.util.Set;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -466,50 +467,57 @@</span>
  			}
  		}
  		return builder.toString();
  	}
  
<span class="udiff-line-modified-removed">- 	public List&lt;TransformDescriptor&gt; modify(String xmlDescription) {</span>
<span class="udiff-line-modified-added">+ 	public Set&lt;String&gt; modify(String xmlDescription) {</span>
  		try  {
  			validateProbeDefinition(xmlDescription);
  
<span class="udiff-line-removed">- 			List&lt;TransformDescriptor&gt; tds = new ArrayList&lt;TransformDescriptor&gt;();</span>
  			StringReader reader = new StringReader(xmlDescription);
  			XMLInputFactory inputFactory = XMLInputFactory.newInstance();
  			XMLStreamReader streamReader = inputFactory.createXMLStreamReader(reader);
  			HashMap&lt;String, String&gt; globalDefaults = new HashMap&lt;String, String&gt;();
<span class="udiff-line-modified-removed">- 			List&lt;String&gt; removedOldClasses = new ArrayList&lt;String&gt;();</span>
<span class="udiff-line-modified-added">+ 			Set&lt;String&gt; modifiedClasses = new HashSet&lt;&gt;();</span>
  			logger.info(xmlDescription);
  			while (streamReader.hasNext()) {
  				if (streamReader.isStartElement()) {
  					QName element = streamReader.getName();
  					if (XML_ELEMENT_NAME_EVENT.equals(element.getLocalPart())) {
  						TransformDescriptor td = parseTransformData(streamReader, globalDefaults);
<span class="udiff-line-modified-removed">- 						if(!removedOldClasses.contains(td.getClassName())) {</span>
<span class="udiff-line-modified-added">+ 						if(modifiedClasses.add(td.getClassName())) {</span>
  							transformData.remove(td.getClassName());
<span class="udiff-line-removed">- 							removedOldClasses.add(td.getClassName());</span>
  						}
  						if (validate(this,td)) {
  							add(this, td);
<span class="udiff-line-removed">- 							tds.add(td);</span>
  						}
  						continue;
  					} else if (XML_ELEMENT_CONFIGURATION.equals(element.getLocalPart())) {
  						readGlobalConfig(streamReader, globalDefaults);
  					}
  				}
  				streamReader.next();
  			}
<span class="udiff-line-modified-removed">- 			return tds;</span>
<span class="udiff-line-modified-added">+ 			clearAllOtherTransformData(modifiedClasses);</span>
<span class="udiff-line-added">+ 			return modifiedClasses;</span>
  		} catch (XMLStreamException xse) {
  			logger.log(Level.SEVERE, &quot;Failed to create XML Stream Reader&quot;, xse);
  			return null;
  		}
  	}
  
<span class="udiff-line-modified-removed">- 	public List&lt;String&gt; clearAllTransformData() {</span>
<span class="udiff-line-modified-removed">- 		List&lt;String&gt; classNames = new ArrayList&lt;&gt;(transformData.keySet());</span>
<span class="udiff-line-modified-added">+ 	private void clearAllOtherTransformData(Set&lt;String&gt; classesToKeep) {</span>
<span class="udiff-line-modified-added">+ 		Set&lt;String&gt; classNames = new HashSet&lt;&gt;(getClassNames());</span>
<span class="udiff-line-added">+ 		for (String className : classNames) {</span>
<span class="udiff-line-added">+ 			if (!classesToKeep.contains(className)) {</span>
<span class="udiff-line-added">+ 				transformData.remove(className);</span>
<span class="udiff-line-added">+ 			}</span>
<span class="udiff-line-added">+ 		}</span>
<span class="udiff-line-added">+ 	}</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ 	public Set&lt;String&gt; clearAllTransformData() {</span>
<span class="udiff-line-added">+ 		Set&lt;String&gt; classNames = new HashSet&lt;&gt;(getClassNames());</span>
  		transformData.clear();
  		return classNames;
  	}
  
  	public Set&lt;String&gt; getClassNames() {
</pre>
<center><a href="../TransformRegistry.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="../jmx/AgentController.java.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>