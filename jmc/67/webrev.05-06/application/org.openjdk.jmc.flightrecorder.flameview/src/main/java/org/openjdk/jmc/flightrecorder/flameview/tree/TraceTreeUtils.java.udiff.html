<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff application/org.openjdk.jmc.flightrecorder.flameview/src/main/java/org/openjdk/jmc/flightrecorder/flameview/tree/TraceTreeUtils.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="../Messages.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../../index.html" target="_top">index</a> <a href="../../../../../../../resources/org/openjdk/jmc/flightrecorder/flameview/messages.properties.udiff.html" target="_top">next &gt;</a></center>    <h2>application/org.openjdk.jmc.flightrecorder.flameview/src/main/java/org/openjdk/jmc/flightrecorder/flameview/tree/TraceTreeUtils.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -31,46 +31,49 @@</span>
   * WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY
   * WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
   */
  package org.openjdk.jmc.flightrecorder.flameview.tree;
  
<span class="udiff-line-modified-removed">- import static org.openjdk.jmc.flightrecorder.flameview.Messages.FLAMEVIEW_SELECT_STACKTRACE_NOT_AVAILABLE;</span>
<span class="udiff-line-modified-added">+ import static org.openjdk.jmc.flightrecorder.flameview.Messages.FLAMEVIEW_SELECT_HTML_MORE;</span>
<span class="udiff-line-added">+ import static org.openjdk.jmc.flightrecorder.flameview.Messages.FLAMEVIEW_SELECT_HTML_TABLE_EVENT_PATTERN;</span>
<span class="udiff-line-added">+ import static org.openjdk.jmc.flightrecorder.flameview.Messages.FLAMEVIEW_SELECT_HTML_TABLE_EVENT_REST_PATTERN;</span>
  import static org.openjdk.jmc.flightrecorder.flameview.Messages.FLAMEVIEW_SELECT_ROOT_NODE;
<span class="udiff-line-added">+ import static org.openjdk.jmc.flightrecorder.flameview.Messages.FLAMEVIEW_SELECT_ROOT_NODE_EVENT;</span>
<span class="udiff-line-added">+ import static org.openjdk.jmc.flightrecorder.flameview.Messages.FLAMEVIEW_SELECT_ROOT_NODE_EVENTS;</span>
<span class="udiff-line-added">+ import static org.openjdk.jmc.flightrecorder.flameview.Messages.FLAMEVIEW_SELECT_ROOT_NODE_TYPE;</span>
<span class="udiff-line-added">+ import static org.openjdk.jmc.flightrecorder.flameview.Messages.FLAMEVIEW_SELECT_ROOT_NODE_TYPES;</span>
<span class="udiff-line-added">+ import static org.openjdk.jmc.flightrecorder.flameview.Messages.FLAMEVIEW_SELECT_STACKTRACE_NOT_AVAILABLE;</span>
  import static org.openjdk.jmc.flightrecorder.flameview.Messages.FLAMEVIEW_SELECT_TITLE_EVENT_MORE_DELIMITER;
  import static org.openjdk.jmc.flightrecorder.flameview.Messages.FLAMEVIEW_SELECT_TITLE_EVENT_PATTERN;
<span class="udiff-line-removed">- import static org.openjdk.jmc.flightrecorder.flameview.Messages.FLAMEVIEW_SELECT_HTML_TABLE_EVENT_PATTERN;</span>
<span class="udiff-line-removed">- import static org.openjdk.jmc.flightrecorder.flameview.Messages.FLAMEVIEW_SELECT_HTML_TABLE_EVENT_REST_PATTERN;</span>
<span class="udiff-line-removed">- import static org.openjdk.jmc.flightrecorder.flameview.Messages.FLAMEVIEW_SELECT_HTML_MORE;</span>
<span class="udiff-line-removed">- import static org.openjdk.jmc.flightrecorder.stacktrace.Messages.STACKTRACE_UNCLASSIFIABLE_FRAME;</span>
  import static org.openjdk.jmc.flightrecorder.flameview.MessagesUtils.getFlameviewMessage;
  import static org.openjdk.jmc.flightrecorder.flameview.MessagesUtils.getStacktraceMessage;
<span class="udiff-line-added">+ import static org.openjdk.jmc.flightrecorder.stacktrace.Messages.STACKTRACE_UNCLASSIFIABLE_FRAME;</span>
  
<span class="udiff-line-removed">- import java.text.MessageFormat;</span>
  import java.util.HashMap;
  import java.util.Map;
  import java.util.concurrent.atomic.AtomicInteger;
  
  import org.openjdk.jmc.common.IMCFrame;
  import org.openjdk.jmc.common.IMCMethod;
  import org.openjdk.jmc.common.item.Aggregators;
<span class="udiff-line-added">+ import org.openjdk.jmc.common.item.Aggregators.CountConsumer;</span>
  import org.openjdk.jmc.common.item.GroupingAggregator;
<span class="udiff-line-added">+ import org.openjdk.jmc.common.item.GroupingAggregator.GroupEntry;</span>
  import org.openjdk.jmc.common.item.IAggregator;
  import org.openjdk.jmc.common.item.IItemCollection;
  import org.openjdk.jmc.common.item.IType;
<span class="udiff-line-removed">- import org.openjdk.jmc.common.item.Aggregators.CountConsumer;</span>
<span class="udiff-line-removed">- import org.openjdk.jmc.common.item.GroupingAggregator.GroupEntry;</span>
  import org.openjdk.jmc.common.unit.IQuantity;
  import org.openjdk.jmc.common.unit.UnitLookup;
  import org.openjdk.jmc.common.util.FormatToolkit;
  import org.openjdk.jmc.flightrecorder.JfrAttributes;
  import org.openjdk.jmc.flightrecorder.rules.util.RulesToolkit;
  import org.openjdk.jmc.flightrecorder.stacktrace.FrameSeparator;
<span class="udiff-line-added">+ import org.openjdk.jmc.flightrecorder.stacktrace.FrameSeparator.FrameCategorization;</span>
<span class="udiff-line-added">+ import org.openjdk.jmc.flightrecorder.stacktrace.StacktraceFrame;</span>
  import org.openjdk.jmc.flightrecorder.stacktrace.StacktraceModel;
  import org.openjdk.jmc.flightrecorder.stacktrace.StacktraceModel.Branch;
  import org.openjdk.jmc.flightrecorder.stacktrace.StacktraceModel.Fork;
<span class="udiff-line-removed">- import org.openjdk.jmc.flightrecorder.stacktrace.FrameSeparator.FrameCategorization;</span>
<span class="udiff-line-removed">- import org.openjdk.jmc.flightrecorder.stacktrace.StacktraceFrame;</span>
  
  public final class TraceTreeUtils {
  
  	public final static String EMPTY_STRING = &quot;&quot;; //$NON-NLS-1$
  	public final static int DEFAULT_ROOT_TITLE_MAX_EVENTS = 2;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -80,14 +83,12 @@</span>
  	public final static FrameSeparator DEFAULT_FRAME_SEPARATOR = new FrameSeparator(FrameCategorization.METHOD, false);
  
  	/**
  	 * Traces a TraceTree from a {@link StacktraceModel}.
  	 * 
<span class="udiff-line-modified-removed">- 	 * @param root</span>
<span class="udiff-line-modified-removed">- 	 *            the root with description</span>
<span class="udiff-line-removed">- 	 * @param model</span>
<span class="udiff-line-removed">- 	 *            the model to trace the tree from</span>
<span class="udiff-line-modified-added">+ 	 * @param root  the root with description</span>
<span class="udiff-line-modified-added">+ 	 * @param model the model to trace the tree from</span>
  	 * @return the root
  	 */
  	public static TraceNode createTree(TraceNode root, StacktraceModel model) {
  		Fork rootFork = model.getRootFork();
  		for (Branch branch : rootFork.getBranches()) {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -97,14 +98,12 @@</span>
  	}
  
  	/**
  	 * Root of Traces from the selection {@link IItemCollection}
  	 * 
<span class="udiff-line-modified-removed">- 	 * @param items</span>
<span class="udiff-line-modified-removed">- 	 *            the items from the selection</span>
<span class="udiff-line-removed">- 	 * @param branchCount</span>
<span class="udiff-line-removed">- 	 *            branch count from {@link StacktraceModel} model</span>
<span class="udiff-line-modified-added">+ 	 * @param items       the items from the selection</span>
<span class="udiff-line-modified-added">+ 	 * @param branchCount branch count from {@link StacktraceModel} model</span>
  	 * @return root
  	 */
  	public static TraceNode createRootWithDescription(IItemCollection items, int branchCount) {
  
  		StringBuilder titleSb = new StringBuilder();
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -113,34 +112,41 @@</span>
  
  		if (branchCount == 0) {
  			titleSb.append(getFlameviewMessage(FLAMEVIEW_SELECT_STACKTRACE_NOT_AVAILABLE));
  		} else {
  			Map&lt;String, Integer&gt; orderedEventTypeNameWithCount = eventTypeNameWithCountSorted(items, totalItemsSum);
<span class="udiff-line-modified-removed">- 			String selectionText = getFlameviewMessage(FLAMEVIEW_SELECT_ROOT_NODE, String.valueOf(totalItemsSum.get()),</span>
<span class="udiff-line-removed">- 					String.valueOf(orderedEventTypeNameWithCount.size()));</span>
<span class="udiff-line-modified-added">+ 			String selectionText = createSelectionText(totalItemsSum.get(), orderedEventTypeNameWithCount.size());</span>
  			titleSb.append(selectionText);
  			createNodeTitleAndDescription(titleSb, descSb, orderedEventTypeNameWithCount);
  		}
  
  		return new TraceNode(titleSb.toString(), 0, descSb.toString());
  	}
  
  	/**
  	 * Print the tree by the trace node
  	 * 
<span class="udiff-line-modified-removed">- 	 * @param node</span>
<span class="udiff-line-removed">- 	 *            trace node</span>
<span class="udiff-line-modified-added">+ 	 * @param node trace node</span>
  	 * @return tree
  	 */
  	public static String printTree(TraceNode node) {
  		StringBuilder builder = new StringBuilder();
  		builder.append(&quot;=== Tree Printout ===&quot;);
  		builder.append(System.lineSeparator());
  		printTree(builder, 0, node);
  		return builder.toString();
  	}
  
<span class="udiff-line-added">+ 	private static String createSelectionText(int events, int types) {</span>
<span class="udiff-line-added">+ 		String eventText = events &gt; 1 ? getFlameviewMessage(FLAMEVIEW_SELECT_ROOT_NODE_EVENTS)</span>
<span class="udiff-line-added">+ 				: getFlameviewMessage(FLAMEVIEW_SELECT_ROOT_NODE_EVENT);</span>
<span class="udiff-line-added">+ 		String typeText = types &gt; 1 ? getFlameviewMessage(FLAMEVIEW_SELECT_ROOT_NODE_TYPES)</span>
<span class="udiff-line-added">+ 				: getFlameviewMessage(FLAMEVIEW_SELECT_ROOT_NODE_TYPE);</span>
<span class="udiff-line-added">+ 		return getFlameviewMessage(FLAMEVIEW_SELECT_ROOT_NODE, String.valueOf(events), eventText, String.valueOf(types),</span>
<span class="udiff-line-added">+ 				typeText);</span>
<span class="udiff-line-added">+ 	}</span>
<span class="udiff-line-added">+ </span>
  	private static void addBranch(TraceNode root, Branch branch) {
  		StacktraceFrame firstFrame = branch.getFirstFrame();
  		TraceNode currentNode = getTraceNodeByStacktraceFrame(firstFrame);
  		root.addChild(currentNode);
  		for (StacktraceFrame frame : branch.getTailFrames()) {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -170,12 +176,12 @@</span>
  			builder.append(&quot;   &quot;);
  		}
  		return builder.toString();
  	}
  
<span class="udiff-line-modified-removed">- 	private static Map&lt;String, Integer&gt; eventTypeNameWithCountSorted(</span>
<span class="udiff-line-modified-removed">- 		IItemCollection items, AtomicInteger totalEventTypeSum) {</span>
<span class="udiff-line-modified-added">+ 	private static Map&lt;String, Integer&gt; eventTypeNameWithCountSorted(IItemCollection items,</span>
<span class="udiff-line-modified-added">+ 			AtomicInteger totalEventTypeSum) {</span>
  		final HashMap&lt;String, Integer&gt; map = new HashMap&lt;&gt;();
  		IAggregator&lt;IQuantity, ?&gt; build = GroupingAggregator.build(EMPTY_STRING, EMPTY_STRING, JfrAttributes.EVENT_TYPE,
  				Aggregators.count(), new GroupingAggregator.IGroupsFinisher&lt;IQuantity, IType&lt;?&gt;, CountConsumer&gt;() {
  
  					@Override
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -196,18 +202,19 @@</span>
  				});
  		items.getAggregate(build);
  		return RulesToolkit.sortMap(map, false);
  	}
  
<span class="udiff-line-modified-removed">- 	private static void createNodeTitleAndDescription(</span>
<span class="udiff-line-modified-removed">- 		StringBuilder titleSb, StringBuilder descSb, Map&lt;String, Integer&gt; orderedItemCountByType) {</span>
<span class="udiff-line-modified-added">+ 	private static void createNodeTitleAndDescription(StringBuilder titleSb, StringBuilder descSb,</span>
<span class="udiff-line-modified-added">+ 			Map&lt;String, Integer&gt; orderedItemCountByType) {</span>
  
  		int i = 0;
  		long restEventCount = 0;
  		boolean writeTitle = true;
  		int maxEventsInTile = orderedItemCountByType.size() &gt; DEFAULT_ROOT_TITLE_MAX_EVENTS
<span class="udiff-line-modified-removed">- 				? DEFAULT_ROOT_TITLE_MAX_EVENTS : orderedItemCountByType.size() - 1;</span>
<span class="udiff-line-modified-added">+ 				? DEFAULT_ROOT_TITLE_MAX_EVENTS</span>
<span class="udiff-line-added">+ 				: orderedItemCountByType.size() - 1;</span>
  
  		for (Map.Entry&lt;String, Integer&gt; e : orderedItemCountByType.entrySet()) {
  			if (writeTitle) {
  				String eventType = getFlameviewMessage(FLAMEVIEW_SELECT_TITLE_EVENT_PATTERN, e.getKey(),
  						String.valueOf(e.getValue()));
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -235,11 +242,11 @@</span>
  					restEventCountText, restItemCountText);
  			descSb.append(tableEventRest);
  		}
  
  		if (maxEventsInTile &lt; orderedItemCountByType.size() - 1) {
<span class="udiff-line-modified-removed">- 			titleSb.append(getFlameviewMessage(FLAMEVIEW_SELECT_HTML_MORE)); //$NON-NLS-1$</span>
<span class="udiff-line-modified-added">+ 			titleSb.append(getFlameviewMessage(FLAMEVIEW_SELECT_HTML_MORE)); // $NON-NLS-1$</span>
  		}
  	}
  
  	private static TraceNode getTraceNodeByStacktraceFrame(StacktraceFrame sFrame) {
  		IMCFrame frame = sFrame.getFrame();
</pre>
<center><a href="../Messages.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../../index.html" target="_top">index</a> <a href="../../../../../../../resources/org/openjdk/jmc/flightrecorder/flameview/messages.properties.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>