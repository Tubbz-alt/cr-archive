<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff agent/src/main/java/org/openjdk/jmc/agent/Agent.java</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center>&lt; prev <a href="../../../../../../../../index.html" target="_top">index</a> <a href="TransformRegistry.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>agent/src/main/java/org/openjdk/jmc/agent/Agent.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 17  * 2. Redistributions in binary form must reproduce the above copyright notice, this list of
 18  * conditions and the following disclaimer in the documentation and/or other materials provided with
 19  * the distribution.
 20  * 
 21  * 3. Neither the name of the copyright holder nor the names of its contributors may be used to
 22  * endorse or promote products derived from this software without specific prior written permission.
 23  * 
 24  * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS &quot;AS IS&quot; AND ANY EXPRESS OR
 25  * IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND
 26  * FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR
 27  * CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL
 28  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
 29  * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY,
 30  * WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY
 31  * WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 32  */
 33 package org.openjdk.jmc.agent;
 34 
 35 import java.io.File;
 36 import java.io.FileInputStream;
<span class="line-removed"> 37 import java.io.FileNotFoundException;</span>
 38 import java.io.IOException;
 39 import java.io.InputStream;
 40 import java.lang.instrument.Instrumentation;


 41 import java.util.logging.Level;
 42 import java.util.logging.Logger;
 43 
 44 import javax.xml.stream.XMLStreamException;
 45 
 46 import org.openjdk.jmc.agent.impl.DefaultTransformRegistry;
 47 import org.openjdk.jmc.agent.jmx.AgentManagementFactory;
 48 
 49 /**
 50  * Small ASM based byte code instrumentation agent for declaratively adding logging and JFR events.
 51  * Note: This agent is currently work in progress, and it is not supported for production use yet.
 52  */
 53 public class Agent {
 54 	/**
 55 	 * This should be generated as part of the build later.
 56 	 */
 57 	public final static String VERSION = &quot;0.0.2&quot;; //$NON-NLS-1$
 58 	private final static String DEFAULT_CONFIG = &quot;jfrprobes.xml&quot;; //$NON-NLS-1$

 59 
 60 	/**
 61 	 * This method is run when the agent is started from the command line.
 62 	 *
 63 	 * @param agentArguments
 64 	 *            the arguments to the agent, in this case the path to the config file.
 65 	 * @param instrumentation
 66 	 *            the {@link Instrumentation} instance, provided to us by the kind JVM.
 67 	 */
 68 	public static void premain(String agentArguments, Instrumentation instrumentation) {
 69 		printVersion();
 70 		getLogger().fine(&quot;Starting from premain&quot;); //$NON-NLS-1$
 71 		initializeAgent(agentArguments, instrumentation);
 72 	}
 73 
 74 	/**
 75 	 * This method is run when the agent is loaded dynamically.
 76 	 *
 77 	 * @param agentArguments
 78 	 *            the arguments to the agent, in this case the path to the config file.
 79 	 * @param instrumentation
 80 	 *            the {@link Instrumentation} instance, provided to us by the kind JVM.
 81 	 */
 82 	public static void agentmain(String agentArguments, Instrumentation instrumentation) {
 83 		printVersion();
 84 		getLogger().fine(&quot;Starting from agentmain&quot;); //$NON-NLS-1$

 85 		initializeAgent(agentArguments, instrumentation);
 86 	}
 87 
 88 	/**
 89 	 * This method can be used to initialize the BCI agent when using it as a stand alone library.
 90 	 *
 91 	 * @param configuration
 92 	 *            the configuration options, as XML. The stream will be fully read, but not closed.
 93 	 * @param instrumentation
 94 	 *            the {@link Instrumentation} instance.
 95 	 * @throws XMLStreamException
 96 	 *             if the configuration could not be read.
 97 	 */
 98 	public static void initializeAgent(InputStream configuration, Instrumentation instrumentation)
 99 			throws XMLStreamException {
100 		TransformRegistry registry = DefaultTransformRegistry.from(configuration);
101 		instrumentation.addTransformer(new Transformer(registry), true);
102 		AgentManagementFactory.createAndRegisterAgentControllerMBean(instrumentation, registry);



103 	}
104 
105 	/**
106 	 * @return the Logger to use for agent related status information.
107 	 */
108 	public static Logger getLogger() {
109 		return Logger.getLogger(Agent.class.getName());
110 	}
111 
112 	/**
113 	 * Loads the configuration from the file specified in the agentArguments, and initializes the
114 	 * agent.
115 	 *
116 	 * @param agentArguments
117 	 *            the file to load from.
118 	 * @param instrumentation
119 	 *            the {@link Instrumentation} instance.
120 	 */
121 	private static void initializeAgent(String agentArguments, Instrumentation instrumentation) {
122 		if (agentArguments == null || agentArguments.trim().length() == 0) {
123 			agentArguments = DEFAULT_CONFIG;
124 		}
125 		File file = new File(agentArguments);
126 		try (InputStream stream = new FileInputStream(file)) {
127 			initializeAgent(stream, instrumentation);
128 		} catch (XMLStreamException | IOException e) {
129 			getLogger().log(Level.SEVERE, &quot;Failed to read jfr probe definitions from &quot; + file.getPath(), e); //$NON-NLS-1$
130 		}
131 	}
132 

























133 	private static void printVersion() {
134 		getLogger().info(String.format(&quot;JMC BCI agent v%s&quot;, VERSION)); //$NON-NLS-1$
135 	}
136 }
</pre>
</td>
<td>
<hr />
<pre>
 17  * 2. Redistributions in binary form must reproduce the above copyright notice, this list of
 18  * conditions and the following disclaimer in the documentation and/or other materials provided with
 19  * the distribution.
 20  * 
 21  * 3. Neither the name of the copyright holder nor the names of its contributors may be used to
 22  * endorse or promote products derived from this software without specific prior written permission.
 23  * 
 24  * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS &quot;AS IS&quot; AND ANY EXPRESS OR
 25  * IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND
 26  * FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR
 27  * CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL
 28  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
 29  * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY,
 30  * WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY
 31  * WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 32  */
 33 package org.openjdk.jmc.agent;
 34 
 35 import java.io.File;
 36 import java.io.FileInputStream;

 37 import java.io.IOException;
 38 import java.io.InputStream;
 39 import java.lang.instrument.Instrumentation;
<span class="line-added"> 40 import java.lang.instrument.UnmodifiableClassException;</span>
<span class="line-added"> 41 import java.util.List;</span>
 42 import java.util.logging.Level;
 43 import java.util.logging.Logger;
 44 
 45 import javax.xml.stream.XMLStreamException;
 46 
 47 import org.openjdk.jmc.agent.impl.DefaultTransformRegistry;
 48 import org.openjdk.jmc.agent.jmx.AgentManagementFactory;
 49 
 50 /**
 51  * Small ASM based byte code instrumentation agent for declaratively adding logging and JFR events.
 52  * Note: This agent is currently work in progress, and it is not supported for production use yet.
 53  */
 54 public class Agent {
 55 	/**
 56 	 * This should be generated as part of the build later.
 57 	 */
 58 	public final static String VERSION = &quot;0.0.2&quot;; //$NON-NLS-1$
 59 	private final static String DEFAULT_CONFIG = &quot;jfrprobes.xml&quot;; //$NON-NLS-1$
<span class="line-added"> 60 	private static boolean loadedDynamically = false;</span>
 61 
 62 	/**
 63 	 * This method is run when the agent is started from the command line.
 64 	 *
 65 	 * @param agentArguments
 66 	 *            the arguments to the agent, in this case the path to the config file.
 67 	 * @param instrumentation
 68 	 *            the {@link Instrumentation} instance, provided to us by the kind JVM.
 69 	 */
 70 	public static void premain(String agentArguments, Instrumentation instrumentation) {
 71 		printVersion();
 72 		getLogger().fine(&quot;Starting from premain&quot;); //$NON-NLS-1$
 73 		initializeAgent(agentArguments, instrumentation);
 74 	}
 75 
 76 	/**
 77 	 * This method is run when the agent is loaded dynamically.
 78 	 *
 79 	 * @param agentArguments
 80 	 *            the arguments to the agent, in this case the path to the config file.
 81 	 * @param instrumentation
 82 	 *            the {@link Instrumentation} instance, provided to us by the kind JVM.
 83 	 */
 84 	public static void agentmain(String agentArguments, Instrumentation instrumentation) {
 85 		printVersion();
 86 		getLogger().fine(&quot;Starting from agentmain&quot;); //$NON-NLS-1$
<span class="line-added"> 87 		loadedDynamically = true;</span>
 88 		initializeAgent(agentArguments, instrumentation);
 89 	}
 90 
 91 	/**
 92 	 * This method can be used to initialize the BCI agent when using it as a stand alone library.
 93 	 *
 94 	 * @param configuration
 95 	 *            the configuration options, as XML. The stream will be fully read, but not closed.
 96 	 * @param instrumentation
 97 	 *            the {@link Instrumentation} instance.
 98 	 * @throws XMLStreamException
 99 	 *             if the configuration could not be read.
100 	 */
101 	public static void initializeAgent(InputStream configuration, Instrumentation instrumentation)
102 			throws XMLStreamException {
103 		TransformRegistry registry = DefaultTransformRegistry.from(configuration);
104 		instrumentation.addTransformer(new Transformer(registry), true);
105 		AgentManagementFactory.createAndRegisterAgentControllerMBean(instrumentation, registry);
<span class="line-added">106 		if (loadedDynamically) {</span>
<span class="line-added">107 			retransformClasses(registry.getClassNames(), instrumentation);</span>
<span class="line-added">108 		}</span>
109 	}
110 
111 	/**
112 	 * @return the Logger to use for agent related status information.
113 	 */
114 	public static Logger getLogger() {
115 		return Logger.getLogger(Agent.class.getName());
116 	}
117 
118 	/**
119 	 * Loads the configuration from the file specified in the agentArguments, and initializes the
120 	 * agent.
121 	 *
122 	 * @param agentArguments
123 	 *            the file to load from.
124 	 * @param instrumentation
125 	 *            the {@link Instrumentation} instance.
126 	 */
127 	private static void initializeAgent(String agentArguments, Instrumentation instrumentation) {
128 		if (agentArguments == null || agentArguments.trim().length() == 0) {
129 			agentArguments = DEFAULT_CONFIG;
130 		}
131 		File file = new File(agentArguments);
132 		try (InputStream stream = new FileInputStream(file)) {
133 			initializeAgent(stream, instrumentation);
134 		} catch (XMLStreamException | IOException e) {
135 			getLogger().log(Level.SEVERE, &quot;Failed to read jfr probe definitions from &quot; + file.getPath(), e); //$NON-NLS-1$
136 		}
137 	}
138 
<span class="line-added">139 	/**</span>
<span class="line-added">140 	 * Retransforms the required classes when the agent is loaded dynamically.</span>
<span class="line-added">141 	 *</span>
<span class="line-added">142 	 * @param clazzes</span>
<span class="line-added">143 	 *            list of names of classes to retransform</span>
<span class="line-added">144 	 * @param instrumentation</span>
<span class="line-added">145 	 *            the {@link Instrumentation} instance.</span>
<span class="line-added">146 	 */</span>
<span class="line-added">147 	private static void retransformClasses(List&lt;String&gt; clazzes, Instrumentation instrumentation) {</span>
<span class="line-added">148 		Class&lt;?&gt;[] classesToRetransform = new Class&lt;?&gt;[clazzes.size()];</span>
<span class="line-added">149 		for (int i = 0; i &lt; clazzes.size(); i++) {</span>
<span class="line-added">150 			try {</span>
<span class="line-added">151 				Class&lt;?&gt; classToRetransform = Class.forName(clazzes.get(i).replace(&#39;/&#39;, &#39;.&#39;));</span>
<span class="line-added">152 				classesToRetransform[i] = classToRetransform;</span>
<span class="line-added">153 			} catch (ClassNotFoundException cnfe) {</span>
<span class="line-added">154 				getLogger().log(Level.SEVERE, &quot;Unable to find class: &quot; + clazzes.get(i), cnfe);</span>
<span class="line-added">155 			}</span>
<span class="line-added">156 		}</span>
<span class="line-added">157 		try {</span>
<span class="line-added">158 			instrumentation.retransformClasses(classesToRetransform);</span>
<span class="line-added">159 		} catch (UnmodifiableClassException e) {</span>
<span class="line-added">160 			getLogger().log(Level.SEVERE, &quot;Unable to retransform classes&quot;, e);</span>
<span class="line-added">161 		}</span>
<span class="line-added">162 	}</span>
<span class="line-added">163 </span>
164 	private static void printVersion() {
165 		getLogger().info(String.format(&quot;JMC BCI agent v%s&quot;, VERSION)); //$NON-NLS-1$
166 	}
167 }
</pre>
</td>
</tr>
</table>
<center>&lt; prev <a href="../../../../../../../../index.html" target="_top">index</a> <a href="TransformRegistry.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>